你登录到名为 Restricted 的数据库服务器并对整个数据库进行了脱库。 你很想直接在数据库服务器中直接查看，但
你知道时间有限。 你使用一些 PowerShell 脚本对数据进行加密压缩，然后在不同的内网已控主机之间慢慢传递，最
后将压缩数据利用网络转移到自己的 C2 服务器上。
你告诉你自己，你做到了！但是当你逐渐从飘了的感觉中冷静下来，你发现自己仍然有工作要做。你回过头来翻阅那
些之前导出的 Bloodhound 收集的信息，发现一台名为 Purri Gagarin 的主机，它属于 IT 技术支持部门的工作组 。
很好，我们可以使用它来远程桌面连接或者使用 Windows ACE 连接到域管理员的机器，然后我们可以将域管理员的
密码重置为我们自定义的密码。我们接着操作，重置域管理员 Elon Muskkat 的密码，然后做一些 AD 持久化的设置
来维持持久的域管权限。
90码线
我们需要做的最后一件事情是从域控制器中导出所有的哈希，并且设置其他的后门，最后擦除我们的痕迹。你可以使
用 Mimikatz 应用的的 DCsync 功能来获取所有用户的哈希，包括 krbtgt 票据。而不是使用动静很大的方法（卷影复
制服务）来获取域里所有用户的哈希。我们现在拥有了黄金票据！这意味着我们如果重新回到内网中，我们可以创建
自己的 Kerberos 票据并且让它成为域管理员。
译者注: 卷影复制服务（Volume Shadow Copy Service,简称 VSS）是微软 Windows 的一项组件服务。卷影复
制服务是一项定时为分卷作复制的服务。服务会在分卷新增一个名为“阴影复制”（Shadow Copy）的选项。此
服务可为离线用户提供离线文件服务。
为了留下更多的后门，我们在不同主机中使用了不同的技术。我们在一个主机中设置了 shift 后门；使用
backdoorfactory 技术将我们的恶意软件隐藏在另一个主机中的常用二进制可执行文件中；将系统的计划任务设置为
每周运行一次回连我们的 C2 服务器；使用一个和 lab 域分离的主机，使用 dnscat 的可执行二进制文件代替系统中
一个没啥用的运行服务；还删除了几个主机的启动文件夹中的 payload。
我们是幸运的（当然与之对应我们的幸运建立在他们的不幸之上），我们到目前为止都没有被发现。但你要记住，红
队渗透评估的目的是为了了解公司或组织发现恶意攻击活动的速度有多快（CSK 公司并没有发现），以及他们执行应
急响应、取证和缓解攻击带来的负面影响的速度有多快。所以在最后你尝试触发 CSK 的蓝队采取行动，运行了一个
powershell 脚本（ https://github.com/EmpireProject/Empire/blob/master/data/module_source/trollsploit/Get-
RickAstley.ps1 ）。你满意的笑了，然后关闭笔记本电脑。
任务完成 :)
第10章 赛后——分析报告
译者：@Snowming
在之前的 THP 书籍中，我们有介绍如何编写渗透测试报告的示例，并提供了大量报告模板。这些示例非常适合那些
按部就班的做渗透测试的活动，但是不适合红队的活动。正如本书所述，红队的焦点不是识别漏洞本身（虽然这也是
工作的一部分），而是测试人、工具、工作流程和员工的技能组合。如果你的公司被授权的渗透测试者或者未授权的
坏人攻击并成功入侵，你会给自己的业绩打几分？我一直反对使用差距评估分数、ISO 分数、成熟度模型分数、标准
风险分析、热度图和类似类型的报告来展示公司安全项目的真实状况。
就我个人而言，我喜欢看到公司从之前的红队活动中采取措施进行控制，以测试是否真的取得了进展。例如，对于一
个使用了近似域名方法的网络钓鱼活动，我们看到公司启用了以下一些功能：
使用 dnstwist 对与其公司类似的域名发出警报；
设置一个外部电子邮件域的可信列表。任何与之不匹配的外部邮件都将在最终用户可见的电子邮件中附加一个
标题，说明它是外部（非公司）的、未经批准的电子邮件源。这将帮助你的用户更容易识别网络钓鱼。
来自代理中未分类的域的电子邮件中的任何链接至少应单击一次并警告用户改链接未分类。
禁止 Oﬃce 宏附件、强制使用受保护的视图和对文档进行沙盒处理。
这只是一个公司可以实施的可以阻止攻击的一些简单方法。
请记住，红队人员只需要找到一个漏洞就可能破坏整个内网环境。但是蓝队成员只需要识别攻击者的 TTP（战术，技
术和过程）之一，就可以阻止这威胁。因此，现在的问题是，如果这些 TTP 中的一个已经引起防御系统发出警报，
你的应急响应团队发现警报并处理威胁的速度有多快？所以红队风格的报告应该包括哪些内容呢？由于红队这个概念
还很新，目前还没有标准的报告模板，我们可以根据客户的需求进行定制。在我看来，因为我们可能会在一个完整的
红队活动中多次尝试进入一个内网环境(且被抓住几次)，所以我们想要把好的方面和不好的方面都在报告中都展示出
来。
在活动期间、记笔记方面，许多工具如 Empire 和 Cobalt Strike 在红队活动期间都有很好的活动日志记录，但这些
可能还远远不够。我发现对我们团队的活动非常有用的是，建立一个简单的 Web 服务器来记录红队成员执行的每个
操作。记录过程中只收集最基本的信息，其中包括特定的事件、服务器、描述、影响、任何警报和屏幕截图。大多数
红队/渗透测试人员都不喜欢做笔记，但这类记录提供了一种简单的跟踪活动的方法。
一旦活动结束，我们将收集所有笔记并将其组合在一起，以构建一个能讲述故事的红队报告。红队报告的主要组成部
分可能包括：
简介/范围：本节需要明确说明活动的目标。例如，有些客户要求我们访问特定的数据、获得域管理权限、获取
PII（个人身份信息）、获取 IP 或在找到他们的生产环境的服务器的标志（ﬂag）。
指标：在一场交战之后获得攻击报告是对应急响应团队/取证团队非常有帮助的。我们还想确定他们的防范工具
或安全传感器可能遗漏的地方，那些使他们无法执行取证或检测恶意活动的纰漏。因此，我们希望给出C2服务
器的IP地址、使用的域名、二进制文件的 MD5/SHA1 哈希、电子邮件地址和 IP 信息、被钓鱼的受害者列表以
及任何其他可能有助于取证/应急响应团队的信息。
攻击时间轴：这是红队行动中最重要的部分之一，做好笔记是有回报的。时间轴应该充分说明所有的主要活
动，任何触发警报的 TTP，以及主要的活动。这将允许蓝队比较他们的时间轴和笔记，看看他们错过了什么。
在一次真正的攻击中，你有机会询问那些坏人关于他们做的每坏件事吗？这对防守团队来说是非常有利的。一
个时间轴示例可能是这样的:
检测时间（TTD）/解决时间（TTM）：这通常是我们可以使用蓝队报告构建 TTD/TTM 统计数据的地方。我们
都想要确定蓝队发现一次多重入侵所需的时间；扫描事件触发调查之前花费的时间（如果调查了的话）；以及
蓝队需要多长时间来识别网络钓鱼活动。 第二部分应该讨论有关采取行动之前花费的时间的统计数据。如果有
已警告的 C2 通信或已识别的网络钓鱼，那么在防火墙或 DNS 服务器上封锁这些域需要花费的时间是多久？我
们经常看到公司可能擅长屏蔽域名，但是当 C2 服务器通过 IP 进行通信时会很快失败（反之亦然）。我们希望
确保跟踪此活动并帮我们的客户来识别它。另一个很有用的 TTM 衡量标准是他们最快的情况下要花多久来隔离
一个已经确认受损的系统。随着恶意软件变得越来越自动化，我们需要开始利用智能化和自动化的流程将系统
或网络的一部分与组织的其他部分隔离开来。
来自应急响应/应急人员的反馈：我最喜欢记录的东西之一是来自蓝队的反馈：他们是如何从防守的角度看待整
个活动的。我想知道的是，他们是否觉得自己遵守了安全政策，事件负责人是否推动了调查，管理层是否过度
介入，安全部门如何与 IT 部门进行安全方面的互动，从而促进任何与 IT 相关的改变（防火墙屏蔽、DNS 修改
等等）。以及他们中间的哪些人过于慌张、哪些人过于冷静。
如前所述，红队的目的不是寻找漏洞或破坏环境（尽管这是非常有趣的部分），而是改善客户组织的整体安全程序和
规划并证明其环境中存在某些漏洞。如今，许多公司对自己的安全程序过于自信，只有当他们被攻破时才会做出改
变。现在有了红队，我们可以模拟攻击行为并鼓励客户做出改变，而不是等到真实入侵的事件，那时或许已为时太
晚。
继续教育
译者：@Snowming
一个我总是被读者问到的问题是：我现在该做什么？他们说: 我已经读了所有的The hacker playbook书籍，参加了
各种培训课程，还参加了一系列会议……接下来我应该做什么呢?基于此，我可以给你最好的建议是，你应该开始从小
项目开始做起，为安全社区做贡献。这是真正测试你的技能和提高水平的最好方法。
一些可能有用的想法：
1. 建立一个博客和你自己的 Github 帐户：你应该写一下你所有的经历和所学。虽然你向世界分享了它，但它真
的对你个人成长更有帮助。强迫自己把你正所学的写进博客将帮助你提高写作水平，更好地解释漏洞/使漏洞以
易于理解的方式被展现，并确保你充分了解所学的内容。
2. 你的简历应该是你的 Github 帐户：我总是告诉我的学生你的 Github 帐户（或博客）应该能够有自己的一席之
地。不管它是只是关于很多小型安全项目（比如让工具更高效）还是你自己做的安全项目，你应该在 Github 上
声明你所做的工作。
3. 在当地会议上发言：演讲可能极其令人畏惧，但如果你的简历上有你的演讲经历，你会远远优秀于同圈子中的
其他人。你能找到可以演讲的地方吗？我会建议你从你当地的聚会开始（meetup.com），找到团体并积极参
与。这些团体通常很小，但每个人都非常友好。如果你在南加利福尼亚地区，那正好，我创立并经营着
LETHAL（meetup.com/LETHAL），这是一个由社区驱动的免费安全组，不同成员每月出席一次。无论如何，
参与其中！
4. 漏洞赏金计划：无论你是处于进攻还是防守的一方，赏金计划可以真正帮助你提高你的游戏水平。像
HackerOne，BugCrowd, SynAck, 补天等漏洞赏金项目程序可以免费注册。通过这样，你不止可以赚到不错的
收入，也可以合法地破解他们的网站。（当然，这仍然在他们的计划范围内）。
5. 参加 CTF：我知道很难有足够的时间去做我提到的以上所有事。但我总是告诉我的学生，做安全不是工作--它是
一种生活方式。去 CTFTime.org，挑选一些CTF，在周末参与 CTF，黑掉他们的网站。相信我，你在 CTF 的周
末中能学到的比你上过任何班级的还要多。
6. 与朋友一起建立一个实验室：除非你复制一个极度类似企业环境的测试实验室，否则你很难练习真实的脚本。
没有这个测试环境，你就不会真正理解在所有攻击工具成功运行的背后发生了什么。因此，必须建立一个包含
VLAN，Active Directory，服务器，GPO，用户和计算机，Linux 环境，Puppet，Jenkins 以及所有常用工具的
完整的实验室。
7. 向坏人学习：对于红队来说，这是最重要的一点。我们的作战不应该是理论上的，而是复制另一个真正的攻
击。密切关注最新的 APT 报告，并确保 你足够了解对手和了解如何改变他们的攻击。
8. 订阅 The Hacker Playbook：了解最新的 The Hacker Playbook 新闻。请在此订阅http://thehackerplayboo
k.com/subscribe/ 。
9. 培训：如果你正在寻找一些培训，请联系我们 http://thehackerplaybook.com/training/
关于作者
译者：@Snowming
作者 Peter Kim 从事信息安全行业超过14年，在渗透测试/红队领域工作超过12年。 他曾服务于多家公用事业公司、
财富1000娱乐公司、政府机构以及大型金融机构。虽然他最为知名的是一书系列，但他却热衷于建立一个“安全”的安
全社区，指导学生并培训他人。他创立并维护着南加州最大的一家技术安全俱乐部“LETHAL”（www.meetup.com/LE
THAL ），并在他的网站 LETHAL Security（lethalsecurity.com）进行私人培训，同时他还经营一家渗透测试公司，
名为Secure Planet（www.SecurePla.net）。
Peter 在他的《The Hacker Playbook》系列的主要目标是向读者灌输激情，让他们站在盒子外思考。随着安全环境
不断变化，他希望帮助下一代人建立专业的安全知识和素养。
如有以下任何一种情况，请随时联系 Peter Kim：
关于这本书的问题：PI:EMAIL
有关私人培训或渗透测试的咨询：PI:EMAIL
Twitter：@hackerplaybook