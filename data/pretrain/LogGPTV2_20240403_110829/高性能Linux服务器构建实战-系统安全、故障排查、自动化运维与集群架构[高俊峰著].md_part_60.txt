server
option
balance
option
option
mode
use_backend
use_backend
stats admin if TRUE
mode http
bind 0.0.0.0:19088
timeout check 2s
timeout connect
retries 3
mode http
server
acl
acl
stats
stats
stats
stats
stats refresh 30s
log 127.0.0.1 1oca10 err
timeout
timeout
pidfile
nbproc
daemon
groupnobody
usernobody
maxconn 4096
1og
option
option
mode
bind*:80
www
host_img
host_www
hide-version
auth admin:xxxxxx
6realmwelcomelogin\Haproxy
uri/haproxy-status
e/usr/local/haproxy/logs/haproxy.pid
1
httplog
http
server
forwardfor
client 30s
global
30s
5s
webapp2 192.168.66.32:80 weight 6 check inter 2000 rise 2 fal1 3
webapp1 192.168.66.31:80 weight 6 check inter 2000 rise 2 fal1 3
httpchkHEAD/index.php
roundrobin
abortonclose
redispatch
http
server_img
server_www
hdr_dom (host)
hdr_dom(host)
if host_img
if
-i
host_www
img.tb.com
www.tb.com
---
## Page 416
面添加了注释，下面直接给出配置好的keepalived.conf文件内容：
haproxyl主机和 haproxy2主机上，keepalived.conf的内容基本相同，不同的部分已经在后
14.4.3
负载均衡器上依次启动HAProxy服务。
负载均衡。
两个后端节点，将img.tb.com站点转到webimg1和webimg2两个后端服务节点，分别实现
最后将 haproxy.conf文件分别复制到haproxy1和 haproxy2两台服务器上，然后在两个
vrrp_script check_haproxy (
global_defs{
依次在主、
vrrp_instance haproxy_hal
backend server_img
router_id haproxy_DEVEL
smtp_connect_timeout 30
smtp_server 192.168.200.1
notification_email_from PI:EMAIL
notification_email{
priority 100
virtual_router_id 80
interface etho
state MASTER
interval2
安装并配置双主的Keepalived高可用系统
PI:EMAIL
PI:EMAIL
PI:EMAIL
server webimg2 192.168.66.34:80 weight 6 check inter 2000 rise 2 fa11 3
server webimg1 192.168.66.33:80 weight 6 check inter 2000 rise 2 fa113
option
balance
option
option
mode
、备两个节点上安装Keepalived。关于Keepalived的安装这里略过，在
#在haproxy2主机上，priority值为80
#在一个实例下，virtual_router_id是唯一的，因此在haproxy2主
#在haproxy2主机上，此处为BACKUP
httpchk HEAD/index.html
roundrobin
abortonclose
redispatch
http
第14章高性能负载均衡集群软件 HAProxy397
---
## Page 417
398
priority值要大于BACKUP角色的 priority值。
haproxy1和haproxy2两个节点上virtual_router_id的值要互不相同，并且MASTER角色的
haproxy1主机上，而192.168.66.20 将自动加载到haproxy2主机上。这里要特别注意的是,
第四部分集群架构篇
在双主互备的配置中，有两个VIP地址，在正常情况下，192.168.66.10将自动加载到
virtual_ipaddress{
check_haproxy
track_script [
notify_fault"/etc/keepalived/mail_notify.py fault"
notify_backup"/etc/keepalived/mail_notify.py backup"
notify_master
authentication{
advert_int2
priority 80
virtual_router_id 81
interface etho
state BACKUP
virtual_ipaddress
check_haproxy
track_script{
notify_fault"/etc/keepalived/mail_notify.py fault"
notify_master "/etc/keepalived/mail_notify.py master
authentication{
advert_int2
192.168.66.20/24 dev etho
auth_pass 1111
auth_type PASS
192.168.66.10/24 dev etho
 auth_pass 1111
auth_type PASS
"/etc/keepalived/mail_notify.py master
#在haproxy2主机上，此处virtual_router_id也必须为81
#在haproxy2主机上，此处为MASTER
---
## Page 418
动进人BACKUP状态。
HAProxy服务运行正常后，HAProxy_HA1实例进入MASTER 状态，而HAProxy_HA2自
haproxy1节点Keepalived 的启动日志，信息如下：
负载均衡系统的启动和高可用切换过程。
14.4.4测试双主高可用的HAProxy负载均衡集群系统
并观察VIP 地址是否正常加载到对应的节点上。
接着在 haproxy2节点查看Keepalived 的启动日志，信息如下：
在haproxy1和haproxy2节点依次启动HAProxy服务和Keepalived服务后，首先观察
从输出可知，Keepalived 启动了HAProxy_HA1和HAProxy_HA2两个实例，在检测到
关于负载均衡功能的测试前面章节已经介绍过多次，这里仅测试双主互备的HAProxy
Apr501:16:22haproxyl
netlink reflector...
在完成所有配置修改后，依次在 haproxy1和 haproxy2两个节点启动Keepalived服务，
keepalived.conf'.
Sending gratuitous ARPs on eth0 for 192.168.66.10
ceportsIP 192.168.66.10added
Apr 5 01:16:26 haproxy1 Keepalived_healthcheckers[29104]: Netlink reflector
Apr 5 01:16:26 haproxy1 Keepalived_vrrp[29105]:VRRP_Instance(HAProxy_HA1)
Apr 5 01:16:26 haproxy1 Keepalived_vrrp[29105]:VRRP_Instance(HAProxy_HA1)
Apr 5 01:16:26haproxy1 Keepalived_vrrp[29105]:VRRP_Instance(HAProxy_HA1)
Apr5 01:16:24 haproxy1 Keepalived_vrrp[29105]:VRRP_Instance(HAProxy_HA1)
succeeded
unicast（0),fd（10,11)]
Apr501:16:22haproxy1
Apr
7818Bytes
keepalived/keepalived.conf'.
92.168.66.10#123 Enabled
ending gratuitous ARPs on eth0 for 192.168.66.10
etting protocol VIPs.
ntering MASTER STATE
ransition to MASTER STATE
ntering BACKUP
STATE
Keepalived_vrrp[29105]:VRRP sockpool:[ifindex(2),proto(112),
Keepalived_vrrp[29105]:VRRP_Script(check_haproxy)
第14章高性能负载均衡集群软件 HAProxy399
---
## Page 419
400
第四部分集群架构篇
HAProxy服务关闭，然后在haproxy1节点观察Keepalived的启动日志，信息如下：
互备高可用集群的运行原理。
而HAProxy_HA2自动进入MASTER状态。
两个实例，在检测到HAProxy服务运行正常后，HAProxy_HA1实例进入BACKUP状态，
下面测试一下双主互备的故障切换功能，这里为模拟故障，
通过查看 haproxy1和 haproxy2中Keepalived日志的运行状态，可以发现完全符合双主
从输出日志可知，HAProxy_HA1实例在检测 HAProxy服务失败后，自动进人 FAULT
removing protocol vIPs.
Entering FAULT STATE
Apr
从输出可知，haproxy2节点的Keepalived也启动了HAProxy_HA1和HAProxy_HA2
reports IP192.168.66.10removed
Apr501:19:18haproxy1
inFAULTstate
Apr 5 01:19:18 haproxy1 Keepalived_vrrp[29105]:VRRP_Instance(HAProxy_HA1) Now
Sending gratuitous ARPson eth0 for 192.168.66.20
Apr501:16:33haproxy2 Keepa1ived_vrrp[24550]:VRRP_Instance（HAProxy_HA2)
192.168.66.20 on eth0.IPv4.
reports IP 192.168.66.20 added
Apr 5 01:16:28haproxy2 Keepalived_healthcheckers[24549]:Netlink reflector
Sending gratuitous ARPson eth0 for 192.168.66.20
setting protocolViPs.
Apr 5 01:16:28 haproxy2 Keepalived_vrrp[24550]: VRRP_Instance(HAProxy_HA2)
Entering MASTER STATE
Apr 5 01:16:28 haproxy2 Keepalived_vrrp[24550]: VRRP_Instance (HAProxy_HA2)
Transition to MASTER STATE
Apr 5 01:16:24 haproxy2 Keepalived_vrrp[24550]: VRRP_Script(check_haproxy) succeeded
netlinkreflector...
Apr501:16:24 haproxy2Keepalived_healthcheckers[24549]:Using LinkWatch kernel
proto(112),unicast(0)，
Apr 5 01:16:24 haproxy2 Keepalived_vrrp[24550]:VRRP sockpool:[ifindex(2),
Entering BACKUP STATE
reflector...
Apr
5 01:19:18haproxy1 Keepalived_vrrp[29105]:VRRP_Instance(HAProxy_HA1)
5 01:19:16 haproxy1 Keepalived_vrrp[29105]:VRRP_Script(check_haproxy) failed
5 01:16:24 haproxy2 Keepalived_vrrp[24550]:Using LinkWatch kernel netlink
1 Keepalived_healthcheckers[29104]:Netlink reflector
fd（10,11)]
，将haproxy1节点上
---
## Page 420
HAProxy的双主互备高可用负载均衡集群方案讲解完毕。
闭HAProxy服务，测试过程与上面介绍过的完全相同，因此不再重复讲述。至此，基于
MASTER状态，然后绑定了VIP地址192.168.66.10。
状态，同时释放了VIP地址192.168.66.10。
从切换过程看，Keepalived运行完全正常。类似的测试还可以在haproxy2节点关
接着查看下haproxy2节点中Keepalived日志的运行状态，信息如下：
从输出日志可知，haproxy2节点接管了HAProxy_HA1实例，并将此实例切换到
Sending gratuitous ARPs on eth0 for 192.168.66.10
Apr 5 01:19:25haproxy2 Keepalived_vrrp[24550]:VRRP_Instance(HAProxy_HA1)
192.168.66.10on eth0.IPv4.
reports IP 192.168.66.10 added
Apr 5 01:19:20 haproxy2 Keepalived_healthcheckers[24549]:Netlink reflector
SendinggratuitousARPsoneth0for192.168.66.10
Apr 5 01:19:20 haproxy2 Keepalived_vrrp[24550]:VRRP_Instance(HAProxy_HA1)
setting protocol VIPs.
Apr 5 01:19:20 haproxy2 Keepalived_vrrp[24550]:VRRP_Instance(HAProxy_HA1)
Entering MASTER STATE
Apr 501:19:20 haproxy2 Keepalived_vrrp[24550]:VRRP_Instance(HAProxy_HA1)
Transition to MASTER STATE
Apr 5 01:19:18 haproxy2 Keepalived_vrrp[24550]:VRRP_Instance(HAProxy_HA1)
第14章高性能负载均衡集群软件HAProxy401
---
## Page 421
投稿热线：（010）88379604
热线
具、方法及技巧。
维、集群架构4个不同的维度讲解了构建大规模和高性能Linux服务器集群所需技术、工
控、性能调优与集群应用》一脉相承、互为补充，从系统安全、故障排查、自动化运
服务器运维领域少有的经典著作之一。本书与《高性能Linux服务器构建实战：运维监
后在运维领域引起了广泛的关注和强烈的反响，读者给予了极高的评价，被誉为Linux
用系统、数据备份恢复、网络存储、运维监控、性能优化、集群应用等角度切入，上市
务器性能的各种因素和能提高服务器性能的各种方法抽丝剥茧，深入分析。
究对象，以帮助运维工程师构建高可靠、高性能的Linux服务器为目标，逐一对影响服
化。
而且问题会随着业务需求、服务器规模、服务器运行环境和运维技术的变化而不断变
题，也是运维工程师公认最难的主题之一，因为影响服务器性能和稳定性的因素太多，
《高性能Linux服务器构建实战：运维监控、性能调优与集群应用》一书从Web应
“高性能Linux服务器构建实战”系列图书以具有一定规模的Linux服务器集群为研
性能和稳定性一直是服务器（尤其是面向大规模服务器集群）运维领域最重要的主
数字阅读：www.hzmedia.com.cn
网上购书：www.china-pub.com
华章网站：www.hzbook.com
ISBN
上架指导：计算机/操作系统
定价：79.00元
978-7-111-47249-0
---