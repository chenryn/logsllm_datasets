large scale of our backbone network makes it infeasible to perform
global search for all possible fiber installation locations. A practical
solution is to narrow down to a small number of candidate locations
based on fiber availability on the market and our operational expe-
rience. We sketch an optical topology 𝐺 (cid:2) + Δ𝐺 (cid:2)
, with the candidate
fibers in Δ𝐺 (cid:2)
, and we map these fibers to possible IP links to form
the IP topology 𝐺 + Δ𝐺, where the potential IP links are in Δ𝐺 with
zero initial capacity.
In this way, we convert the long-term planning problem to a
similar formulation as the short-term planning problem. As shown
below, the optimization objective is still minimizing the total cost,
yet with one more term for the fiber procurement and deployment
cost. On the candidate optical topology Δ𝐺 (cid:2)
, 𝜓𝑙 is the number of
fibers to deploy on the fiber segment 𝑙 and 𝑥 (𝑙) is the per-fiber
procurement and deployment cost defined in Section 5.1. The fiber
turn-up cost and capacity addition cost are similar to short-term
planning, but need to be considered on topologies 𝐺 (cid:2) + Δ𝐺 (cid:2)
and
𝐺 + Δ𝐺 respectively with candidate fibers and IP links.
min
s.t.

𝑥 (𝑙) × 𝜓𝑙 +


𝑧 (𝑒) × 𝜆𝑒
𝑦 (𝑙) × 𝜙𝑙 +
𝑙 ∈Δ𝐸(cid:2)
𝑆𝑝𝑒𝑐𝐶𝑜𝑛𝑠𝑒𝑟𝑣 (𝐺 + Δ𝐺, 𝐺 (cid:2) + Δ𝐺 (cid:2))
𝑙 ∈𝐸(cid:2)+Δ𝐸(cid:2)
𝑒 ∈𝐸+Δ𝐸

𝐹𝑙𝑜𝑤𝐶𝑜𝑛𝑠𝑒𝑟𝑣 (𝑀, 𝐺), ∀𝑞 ∈ 𝑄𝑜𝑆
𝑀 ∈𝑇𝑞,𝐺 ∈𝐺𝑞 +Δ𝐺𝑞
𝜆𝑒 ≥ Λ𝑒, ∀𝑒 ∈ 𝐸 + Δ𝐸
𝜙𝑙 ≥ Φ𝑙 , ∀𝑙 ∈ 𝐸 (cid:2) + Δ𝐸 (cid:2)
𝜓𝑙 ≥ 0, ∀𝑙 ∈ Δ𝐸 (cid:2)
(11)
Likewise, the spectral conservation constraint and flow conser-
vation constraint also apply to the potential topologies 𝐺 (cid:2) + Δ𝐺 (cid:2)
and 𝐺 + Δ𝐺. Although our approach results in a large number of
possible IP links over the new fibers, the spectral conservation con-
straint guarantees to select a subset whose capacity can be fully
accommodated by the fibers. Similar to short-term planning, the
variables 𝜆𝑒 , 𝜙𝑙 , and 𝜓𝑙 must increase relative to the base values,
namely existing capacity numbers in the current network and zero
for the candidate topologies. Since the fiber procurement and de-
ployment cost is orders of magnitude higher than the fiber turn-up
cost and capacity addition cost, our formulation naturally favors
exhausting existing fiber resources first. In case the optimization
fails to produce feasible solutions, we enlarge the pool of candidate
fibers and rerun the optimization.
(a)
(b)
(c)
Figure 9: (a) Distribution of planar Hose coverage by different numbers of sampled TMs, (b) Network cuts generated under different edge
threshold 𝛼, and (c) The number of DTMs as a function of flow slack 𝜖, for various edge threshold 𝛼 values.
Figure 10: Average Hose coverage of DTMs as a function of the flow
slack 𝜖, for various edge threshold 𝛼 values.
6 EVALUATION
Our Hose-based capacity planning system has been running in
production for several years. Its core component is an optimization
engine implemented on top of the Xpress solver [1] with a max-
flow-based route simulator. It is a production-grade software with
substantial engineering efforts put into scaling up the optimization.
In this section, we first evaluate the Hose conformance of the TM
generation process in Section 4 to give guidelines for parameter tun-
ing in our system, then we compare the end-to-end planning results
with Pipe-based planning to show the performance advantages.
All experiments are on Facebook’s latest North America produc-
tion topology, which contains hundreds of nodes and thousands
of IP links over hundreds of optical fibers. We plan for 500 fail-
ure scenarios based on historical data, including 300 single-fiber
failures and 200 multi-fiber failures. We predict future traffic with
our production traffic forecast system, and our experiments strictly
follow the two-step planning procedure in production: deciding the
hardware infrastructure with long-term planning and feeding the
result into short-term planning for the final IP network build plan.
Traffic forecast and capacity planning for the Pipe model are based
on our legacy systems before Hose was adopted.
6.1 Hose Conformance
Hose coverage of TM sampling The effectiveness of our TM
sampling algorithm is shown in Figure 9a. Here, we present the
CDF distribution of planar coverage, as defined in Section 4.4, for
different sample sizes. With 105 TM samples, among all the projec-
tion planes for the Hose polytope, even the worst plane reaches
over 97% coverage, and the mean coverage is over 99%. This result
indicates that the Hose space can be represented by 105 sample
TMs with negligible loss of accuracy.
Figure 11: Mean number of DTMs 𝜃 -similar to each other with an
increasing angle of 𝜃
Comparing different curves, intuitively, more TM samples result
in higher Hose coverage. Yet, the increase of coverage slows down
as the number of samples grows. For example, the mean coverage
of 104 samples is 10% higher than 103 samples, while the increase
from 104 to 105 samples is only 3%. This trend shows a rewarding
tradeoff: we can reduce a large number of sample TMs at minimal
degradation of Hose coverage. However, recall that our TM sam-
pling algorithm (Algorithm 1) has 𝑂 (𝑁 2) complexity with regard
to the network size 𝑁 , sampling 105 TMs takes only 200 seconds
in practice. In our production, we choose 105 samples for highly
accurate planning results.
Effect of edge threshold on cut generation Figure 9b looks into
the performance of the sweeping algorithm in Section 4.2. It plots
the number of generated network cuts with the variance of the
edge threshold parameter 𝛼. Recall from the algorithm illustration
in Figure 8 that 𝛼 determines the number of edge nodes that are
permuted to form different cuts, thus a larger 𝛼 results in more
network cuts and 𝛼 = 1 guarantees to find all cuts in the network.
In practice, however, we do not need to set 𝛼 = 1 to get all the cuts.
According to Figure 9b, the number of cuts reaches the maximum
when 𝛼 ≥ 0.095. The curve has a sharp increase for 𝛼 between 0.065
and 0.07, indicating the algorithm can be sensitive with 𝛼. Based
on these observations, we conclude a sufficiently large 𝛼 should be
chosen, otherwise a significant number of cuts may be ignored.
Effect of flow slack on DTM selection Figure 9c quantifies the
relationship between the number of DTMs and the flow slack factor
𝜖 as of the DTM selection process in Section 4.3. According to
Definition 4.2, a sample TM can be a candidate DTM if its traffic
across a network cut is at least 1 − 𝜖 of the maximum traffic across
the cut. So, a bigger 𝜖 will cause more TMs to be qualified as DTMs,
555
(a)
(b)
Figure 12: Traffic drop on Hose and Pipe network plans: (a) CDF of
daily drop, (b) drop per day.
among which a smaller subset can represent all the network cuts.
Figure 9c is consistent with this expectation: the minimum DTM
count to cover all network cuts reduces with the increase of 𝜖,
sharply in the beginning and slowing down as 𝜖 grows. A smaller
number of DTMs means less computation for planning optimization,
yet the Hose coverage may be compromised. We discuss the details
in Figure 10.
It also shows the effect of edge threshold 𝛼 on the number of
DTMs. Interestingly, comparing to Figure 9b, the effective 𝛼 value
can be further reduced with DTM selection in place. Specifically,
the top curves where 𝛼 is 8%, 9%, and 10% show little difference in
terms of the number of DTMs, although 𝛼 = 8% finds 25% fewer
network cuts than 𝛼 = 10% in Figure 9b. This result proves the
robustness of our DTM selection process: with a reasonable 𝛼, even
if some network cuts are not explicitly considered, the resulted
difference in the number of DTMs is small.
Hose coverage of DTMs Figure 10 combines the above factors
and shows their joint effect on DTM selection. The curves have
similar trends as those in Figure 9c. However, for 𝛼 values 8%, 9%,
and 10%, their Hose coverage almost overlap completely. Thus,
we claim the edge threshold 𝛼 = 8% is sufficient for our network,
as the slightly lower number of DTMs can cover the Hose space
equally well. Compared to Figure 9c, Hose coverage shows a more
smooth, near-linear reduction with the increasing flow slack 𝜖,
which confirms the design purpose of our DTM selection process:
a small set of well-chosen DTMs can reach high Hose coverage. We
set 𝛼 = 8% and 𝜖 = 0.1% in production and reach a relatively high
Hose coverage of 83%.
DTM Similarity From another angle to examine the coverage, we
also analyze the similarity of DTMs. A diverse set of DTMs implies
tolerance to traffic uncertainty. We define similarity between two
DTMs 𝑀1 and 𝑀2 as follows:
Similarity(𝑀1, 𝑀2) =
(12)
(cid:10)𝑀1 (cid:10)
(cid:10)𝑀2 (cid:10)
2
2
where (cid:10).(cid:10)
2 denotes the L2-norm of a matrix and  denotes
the dot product of the vectors obtained from unrolling the matri-
ces. The similarity can be expressed as the cosine of the angle of
alignment between the two matrices w.r.t. the origin. For exam-
ple, Similarity(𝑀1, 𝑀2) = 1 if 𝑀2 is a multiple of 𝑀1 by a strictly
positive scalar. We then define the two matrices 𝑀1 and 𝑀2 to be
𝜃 -similar iff Similarity(𝑀1, 𝑀2) ≥ cos 𝜃 .
Figure 13: Traffic drop under random fiber failures.
of DTMs (including itself) that are 𝜃 -similar to it. We then average
the numbers across all DTMs to get the mean DTM 𝜃 -similarity.
Figure 11 shows this metric with the increase of 𝜃 . When DTMs
are all isolated, the mean number of DTMs similar to each other
should be 1, i.e., a DTM is only similar to itself. As 𝜃 increases,
DTMs further away are 𝜃 -similar, and the mean DTM similarity
would increase. We see here that the mean DTM similarity remains
close to 1, even for values of 𝜃 in excess of 20
, indicating that the
DTMs are each well-isolated in the Hose space of TMs, and that
applying additional clustering would not yield many benefits.
◦
6.2 Performance Comparison with Pipe
Planning result vs. actual traffic We evaluate the planning accu-
racy by seeing whether the planned capacity can satisfy the actual
traffic. To do so, we take the June 2020 network as our baseline
topology and perform demand forecast of the next 6 months with
both Hose and Pipe models to generate the capacity plans. Note that
these plans are not the production topology in December 2020, but
rather what the network hypothetically asked for 6 months ago in
history. We evaluate how good these plans are by replaying 28 days
of actual traffic in December 2020 on them. The difference between
the actual traffic and the forecast traffic is the main reason for either
under-provisioning causing dropped demand or over-provisioning
causing wasted capacity.
Traffic drop is especially harmful to service performance. Fig-
ure 12 compares the dropped traffic volume on the Hose and Pipe
plans under the steady state, i.e., no failures in the network. In
subfigure (a), we observe from the CDF distribution that the daily
dropped demand in the Hose model is much lower than Pipe, and
for 80% of the days, the difference in dropped demand is almost
50%. In the day-to-day view of subfigure (b), for almost all days,
the dropped demand for Pipe is higher than Hose, and the differ-
ence can be as high as several Tbps on some days like 12/08 and
12/13. Both results confirm our initial hypothesis in Section 2 that
Hose-based planning is more resilient to traffic dynamics and can
provide better overall performance.
Resilience to unplanned failures We further compare the traf-
fic drop with Hose and Pipe plans under unplanned failures in
Figure 13. It uses the same setting as Figure 12 with 10 randomly
selected fiber cuts. We observe that Hose consistently drops less
traffic than Pipe in all scenarios by 50%-75%. Compared to steady
state in Figure 13, the benefit of Hose dropping less traffic is even
more profound.
We evaluate the similarity of the DTMs used in production,
where 𝛼 = 8% and 𝜖 = 0.1%. For each DTM, we compute the number
Yearly capacity growth Figure 14a shows Hose and Pipe’s yearly
capacity growth as a percentage of the baseline capacity in the next
556
Hose
cove-
rage
40%
52%
58%
67%
83%
#
Reduced
Time
DTMs
21
64
89
154
628
capa-
city %
8.62
8.28
10.52
9.31
8.45
in
mins
48
312
342
412
1063
Time
per
DTM
2.28
4.87
3.84
2.67
1.69