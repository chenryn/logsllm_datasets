Hi! I’m 
DOMAIN\Steve, 
please let me 
access VLAN2.
Tricking firewall user identity capabilities into 
applying security policies to arbitrary IPs on the 
network.
Get-ADUser "Justin Perdok"
@JustinPerdok on Twitter
Into hacking and automating stuff
Pentester at Orange Cyberdefense
Enjoys craft beers and longboarding
Outline
The Tool
The Story
The Solution
The Takeaways
The Pwn
Storytime
The Story
Storytime
Storytime
Storytime
The dangers of Client 
Probing on Palo Alto 
Firewalls
(Estaban Rodriguez @ 
Coalfire)
The risk of Authenticated 
Vulnerability
Scans
(Xavier Mertens @ 
SANS)
Palo Alto
Credential Exposure
(HD Moore @ Project 
Sonar)
2019
2014
2018
Storytime
1
2
3
Named pipes
Named pipes
Traditional segmentation
The Solution
Traditional segmentation
Traditional segmentation
Traditional segmentation
untagged
VLAN2
untagged
VLAN1
Traditional segmentation
Traditional segmentation
Tagged
VLAN 1, 2
Tagged
VLAN 1, 2
Untagged 
ports
Untagged 
Ports
Step through
Traditional segmentation
Traditional segmentation
*Overdramatic example
Exploring $Vendor1
Active Directory
authentication
logs
Syslog servers
And more!
Client Probing
Exploring $Vendor1
Exploring $Vendor1
The sysadmin in me
Exploring $Vendor1
The hacker in me
Exploring $Vendor1
Client Probing
Exploring $Vendor1
Client Probing
Exploring $Vendor1
Client Probing
I'd like access to the VIP fridge
pls. My hotel room number is 
(192.168.56.)148.
(ping vip-fridge.tld)
Exploring $Vendor1
Client Probing
Ahh, room 148. Our system 
doesn't know who's currently 
checked into this room.
What is your name sir ?
(NetWkstaUserEnum Request)
Exploring $Vendor1
Client Probing
My name is Justin.
(NetWkstaUserEnum Response)
Exploring $Vendor1
Client Probing
Hi, Mr. Perdok.
Sorry, you are not allowed to 
access the VIP fridge due our 
hotel policy. VIP clients only.
Exploring $Vendor1
Oversight of Client Probing ?
Steve
!
Exploring $Vendor1
Oversight of Client Probing ?
I'd like access to the VIP fridge 
pls. My hotel room number is 
(192.168.56.)149.
(ping vip-fridge.tld)
Exploring $Vendor1
Oversight of Client Probing ?
Aah, room 149. Our system 
doesn't know who's currently 
checked into this room.
What is your name sir ?
(NetWkstaUserEnum Request)
Exploring $Vendor1
Oversight of Client Probing ?
My name is Steve.
(Spoofed NetWkstaUserEnum
Response)
Exploring $Vendor1
Oversight of Client Probing ?
Hi, Mr. McGreeve. I see you 
bought our VIP package. 
Of course you are allowed to 
access the VIP fridge!
Exploring $Vendor1
Client probing: "I trust client side without validation."
Hackers around the world:
Exploring $Vendor1
ping vipbeer-fridge.tld
NetWkstaUserEnum Request
Spoofed NetWkstaUserEnum Response
?
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Exploring $Vendor1
Client in VLAN1
User-ID agent
Firewall
The VIP Fridge
in VLAN2
Exploring $Vendor1
Cache
AD Logs
0
Exploring $Vendor1
1. ping vip-fridge.tld
from 192.168.2.149
Cache
0
AD Logs
Exploring $Vendor1
1. ping vip-fridge.tld
from 192.168.2.149
ACL with User-ID
2
Hold up.
Need to know 
your name.
Cache
0
AD Logs
Exploring $Vendor1
1. ping vip-fridge.tld
from 192.168.2.149
Cache
0
AD Logs
ACL with User-ID
2
Exploring $Vendor1
ACL with User-ID
2
Cache
0, 4
AD Logs
1. ping vip-fridge.tld
from 192.168.2.149
Exploring $Vendor1
ACL with User-ID
2
1. ping vip-fridge.tld
from 192.168.2.149
Cache
0, 4
AD Logs
Exploring $Vendor1
Lolwut ?
Unsupported 
DCERPC.
ACL with User-ID
2
1. ping vip-fridge.tld
from 192.168.2.149
Cache
0, 4
AD Logs
Building the tool
The Tool
Building the tool
https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-WKST/%5BMS-WKST%5D.pdf
Building the tool
Building the tool
Building the tool
Building the tool
Building the tool
Building the tool
5. NetWkstaUserEnum Request
Building the tool
Building the tool
Building the tool
The Pwn
Lolwut ?
Unsupported 
DCERPC.
ACL with User-ID
2
1. ping vip-fridge.tld
from 192.168.2.149
Cache
0, 4
AD Logs
The Pwn
The Pwn
ACL with User-ID
2
1. ping vip-fridge.tld
from 192.168.2.149
Cache
0, 4
AD Logs
The Pwn
Cache
0, 4, 
7
AD Logs
ACL with User-ID
2
1. ping vip-fridge.tld
from 192.168.2.149
AD Logs
The Pwn
Cache
0, 4, 
7
AD Logs
ACL with User-ID
2
1. ping vip-fridge.tld
from 192.168.2.149
The Pwn
User matches 
=
Allow Access
User mismatch
=
Block Access
ACL with User-ID
2, 9
Cache
0, 4, 
7
AD Logs
1. ping vip-fridge.tld
from 192.168.2.149
Building the tool
Github
https://github.com/justin-p/impacket
https://github.com/SecureAuthCorp/impacket/pull/965
Other 
$Vendors
NetAPI
$Vendor2
$Vendor2
Caveats
SMB Guest Access
Caveats
SMB Guest Access
Caveats
SMB Guest Access
Disclosure
Palo Alto
22 Okt. 2020
8 Jan. 2021 > Now
6 Okt. 2020
2 Nov. 2020 > 8 Jan. 2021
04
01
03
02
Started disclosure 
with Palo Alto
"Moving forward 
NetBIOS support 
will be removed from 
User-ID."
Issue would not warrent a
CVE since it was an  
issue with
‘the protocol’, not Palo Alto. 
Was added to the Hall of 
Fame.
Status of dropping NetBIOS 
unknown.
"Customers do have a way 
to not use this feature, so in 
essence the fix is already 
present in the product."
Disclosure
SonicWALL
Started disclosure 
with SonicWALL
11 Nov. 2020
6 Okt. 2020
01
02
Informed me that vuln was 
a duplicate. 
Proposed fix that would 
prompt a warning if the 
user "Administrator" was 
configured in the agent.
Disclosure
SonicWALL
CVE-2020-5148
Shared my concerns 
regarding the 
proposed fix and 
wanted to verify which 
of the two findings 
where duplicates.
11 Nov. 2020
5 Mar. 2021
6 Okt. 2020
11 Nov. 2020 > 3 Mar. 2021
04
01
03
02
Started disclosure 
with SonicWALL
Informed me that vuln was 
a duplicate. 
Proposed fix that would 
prompt a warning if the 
user "Administrator" was 
configured in the agent.
Disclosure
SonicWALL
Disclosure
SonicWALL
Checks the name (not effective 
rights) of the service account 
when updating this in the agent.
Not checked during installation 
itself when this is initially set.
The ol’ if-statement
Default Probing 
Method
NetAPI no longer default 
probing method. 
New 
documentation
They now advice to create 
service account with local 
admin rights for "NetAPI" 
based probing. 
What's next ?
\\.\PIPE\WINREG
$OtherProducts
Abuse Cache
WMI
$Vendor3
What about 
systems other 
then firewalls ?
Some firewalls vendors 
use the WINREG 
named pipe for 
probing. Potentially also 
exploitable.
Reuse a ip 
that has a 
user-to-ip 
cached.
Lots of vendors 
support WMI.
No tooling like 
impacket
available 
(afaik).
Suspect they are 
vulnerable.
Already started 
responsible 
disclosure 
process.
The Takeaways
Conclusions & Takeaways
Sometimes security 
features can be insecure
Why client probing is 
generally a bad idea
Client Probing
Feature!=Secure
Thanks!
Contact: @JustinPerdok on Twitter.
If I got something wrong, please let me know :)
Github url
https://github.com/justin-p/impacket
CREDITS: This presentation template was created by Slidesgo, 
including icons by Flaticon, and infographics & images by 
Freepik
Impacket code