k
(88%), Microsoft Windows Server 2012 or Windows Server 2012 R2 (88%), Microsoft
Windows Server 2012 R2 (88%), Microsoft Windows Server 2012 (87%), Microsoft Windows
Server 2016 (87%), Microsoft Windows 7 (86%), Micrsosoft Windows Vista Home Premium SP1
(85%), Microsoft Windows 7 Professional (85%)
No exact OS matches for host (If you know what OS is running on it, see
o
https://nmap.org/submit/ ).
...
Listing 67 - Using nmap for OS fingerprinting
n
The response suggests that the underlying operating system of this target is either Windows
2008 R2, 2012, 2016, Vista, or Windows 7.
i
z
Note that OS Fingerprinting is not always 100% accurate, often due to network
D
devices like firewalls or proxies that rewrite packet headers in between the
communication.
Once we have recognized the underlying operating system, we can go further and identify
services running on specific ports by inspecting service banners with -A parameter which also
runs various OS and service enumeration scripts against the target. .
kali@kali:~$ nmap -sT -A 192.168.50.14
Nmap scan report for 192.168.50.14
Host is up (0.12s latency).
Not shown: 996 closed tcp ports (conn-refused)
PORT STATE SERVICE VERSION
21/tcp open ftp?
| fingerprint-strings:
| DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, NULL, RPCCheck,
SSLSessionReq, TLSSessionReq, TerminalServerCookie:
| 220-FileZilla Server 1.2.0
| Please visit https://filezilla-project.org/
| GetRequest:
| 220-FileZilla Server 1.2.0
| Please visit https://filezilla-project.org/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 149
Made in Morocco
Penetration Testing with Kali Linux
| What are you trying to do? Go away.
| HTTPOptions, RTSPRequest:
| 220-FileZilla Server 1.2.0
| Please visit https://filezilla-project.org/
| Wrong command.
| Help:
| 220-FileZilla Server 1.2.0
| Please visit https://filezilla-project.org/
| 214-The following commands are recognized.
| USER TYPE SYST SIZE RNTO RNFR RMD REST QUIT
| HELP XMKD MLST MKD EPSV XCWD NOOP AUTH OPTS DELE
| CDUP APPE STOR ALLO RETR PWD FEAT CLNT MFMT
| MODE XRMD PROT ADAT ABOR XPWD MDTM LIST MLSD PBSZ
| NLST EPRT PASS STRU PASV STAT PORT
|_ Help ok.
| ftp-syst: y
|_ SYST: UNIX emulated by FileZilla.
| ssl-cert: Subject: commonName=filezilla-server self signed certificate
| Not valid before: 2022-01-06T15:37:24 k
|_Not valid after: 2023-01-07T15:42:24
|_ssl-date: TLS randomness does not represent time
s
135/tcp open msrpc Microsoft Windows RPC
139/tcp open netbios-ssn Microsoft Windows netbios-ssn
445/tcp open microsoft-ds? o
Nmap done: 1 IP address (1 host up) scanned in 55.67 seconds
Listing 68 - Using nmap for banner grabbing and/or service enumeration
n
In the above example we used the -A parameter to run a service scan with extra options. If we
want to run a plain service nmap scan we can do it by providing only the -sV parameter.
i
Banner grabbing significantly imzpacts the amount of traffic used as well as the speed of our
scan. We should always be mindful of the options we use with nmap and how they affect our
scans.
D
Banners can be modified by system administrators and intentionally set to fake
service names to mislead potential attackers.
Now that we have covered Nmap’s major features, we’ll focus on specific Nmap scripts
encompassed by the Nmap Scripting Engine (NSE).
We can use the NSE266 to launch user-created scripts in order to automate various scanning
tasks. These scripts perform a broad range of functions including DNS enumeration, brute force
attacks, and even vulnerability identification. NSE scripts are located in the
/usr/share/nmap/scripts directory.
The http-headers script, for example, attempts to connect to the HTTP service on a target system
and determine the supported headers.
266 (Nmap, 2022), http://nmap.org/book/nse.html
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 150
Made in Morocco
Penetration Testing with Kali Linux
kali@kali:~$ nmap --script http-headers 192.168.50.6
Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-10 13:53 EST
Nmap scan report for 192.168.50.6
Host is up (0.14s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT STATE SERVICE
22/tcp open ssh
80/tcp open http
| http-headers:
| Date: Thu, 10 Mar 2022 18:53:29 GMT
| Server: Apache/2.4.41 (Ubuntu)
| Last-Modified: Thu, 10 Mar 2022 18:51:54 GMT
| ETag: "d1-5d9e1b5371420"
| Accept-Ranges: bytes
| Content-Length: 209
| Vary: Accept-Encoding y
| Connection: close
| Content-Type: text/html
k
|
|_ (Request type: HEAD)
s
Nmap done: 1 IP address (1 host up) scanned in 5.11 seconds
Listing 69 - Using nmap’s scripting engine (NSE) for OS fingerprinting
o
To view more information about a script, we can use the --script-help option, which displays a
description of the script and a URL where we can find more in-depth information, such as the
script arguments and usage examples. n
kali@kali:~$ nmap --script-help http-headers
i
Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-10 13:54 EST
z
http-headers
Categories: discovery safe
D
https://nmap.org/nsedoc/scripts/http-headers.html
Performs a HEAD request for the root folder ("/") of a web server and displays the
HTTP headers returned.
...
Listing 70 - Using the --script-help option to view more information about a script
When internet access is not available, much of this information can also be found in the NSE
script file itself.
It’s worth our time to explore the various NSE scripts, as many of them are helpful and time-
saving.
Having learned how to perform port scanning from Kali, let’s explore how can we apply the same
concepts from a Windows host.
If we are conducting initial network enumeration from a Windows laptop with no internet access,
we are prevented from installing any extra tools that might help us, like the Windows Nmap
version. In such a limited scenario, we are forced to pursue the ‘living off the land’ strategy we
discussed earlier. Luckily, there are a few helpful built-in PowerShell functions we can use.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 151
Made in Morocco
Penetration Testing with Kali Linux
The Test-NetConnection267 function checks if an IP responds to ICMP and whether a specified
TCP port on the target host is open.
For instance, from the Windows 11 client, we can verify if the SMB port 445 is open on a domain
controller as follows.
PS C:\Users\student> Test-NetConnection -Port 445 192.168.50.151
ComputerName : 192.168.50.151
RemoteAddress : 192.168.50.151
RemotePort : 445
InterfaceAlias : Ethernet0
SourceAddress : 192.168.50.152
TcpTestSucceeded : True
Listing 71 - Port scanning SMB via PowerShell
y
The returned value in the TcpTestSucceeded parameter indicates that port 445 is open.
We can further script the whole process in order to scan thke first 1024 ports on the Domain
Controller with the PowerShell one-liner shown below. To do so we need to instantiate a TcpClient
Socket object as Test-NetConnection send additional trasffic that is non needed for our purposes.
PS C:\Users\student> 1..1024 | % {echo ((New-Object
o
Net.Sockets.TcpClient).Connect("192.168.50.151", $_)) "TCP port $_ is open"} 2>$null
TCP port 88 is open
...
n
Listing 72 - Automating the PowerShell portscanning
We start by piping the first 1024 integer into a for-loop which assigns the incremental integer
i
value to the $_ variable. Then, we create a Net.Sockets.TcpClient object and perform a TCP
z
connection against the target IP on that specific port, and if the connection is successful, it
prompts a log message that includes the open TCP port.
D
We’ve covered just the starting point of PowerShell’s abilities, which can be further extended to
match the traditional Nmap features.
6.3.4 SMB Enumeration
The security track record of the Server Message Block (SMB)268 protocol has been poor for many
years due to its complex implementation and open nature. From unauthenticated SMB null
sessions in Windows 2000 and XP, to a plethora of SMB bugs and vulnerabilities over the years,
SMB has had its fair share of action.269
Keeping this in mind, the SMB protocol has also been updated and improved in parallel with
Windows releases.
The NetBIOS270 service listens on TCP port 139, as well as several UDP ports. It should be noted
that SMB (TCP port 445) and NetBIOS are two separate protocols. NetBIOS is an independent
267 (Microsoft, 2022), https://docs.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=windowsserver2022-
ps
268 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Server_Message_Block
269 (Mark A. Gamache, 2013), http://markgamache.blogspot.ca/2013/01/ntlm-challenge-response-is-100-broken.html
270 (Wikipedia, 2022), https://en.wikipedia.org/wiki/NetBIOS
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 152
Made in Morocco
Penetration Testing with Kali Linux
session layer protocol and service that allows computers on a local network to communicate with
each other. While modern implementations of SMB can work without NetBIOS, NetBIOS over TCP
(NBT)271 is required for backward compatibility and these are often enabled together. This also
means the enumeration of these two services often goes hand-in-hand. These services can be
scanned with tools like nmap, using syntax similar to the following:
kali@kali:~$ nmap -v -p 139,445 -oG smb.txt 192.168.50.1-254
kali@kali:~$ cat smb.txt
# Nmap 7.92 scan initiated Thu Mar 17 06:03:12 2022 as: nmap -v -p 139,445 -oG smb.txt
192.168.50.1-254
# Ports scanned: TCP(2;139,445) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 192.168.50.1 () Status: Down
...
Host: 192.168.50.21 () Status: Up
y
Host: 192.168.50.21 () Ports: 139/closed/tcp//netbios-ssn///,
445/closed/tcp//microsoft-ds///
... k
Host: 192.168.50.217 () Status: Up
Host: 192.168.50.217 () Ports: 139/closed/tcp//netbios-ssn///,
445/closed/tcp//microsoft-ds/// s
# Nmap done at Thu Mar 17 06:03:18 2022 -- 254 IP addresses (15 hosts up) scanned in
6.17 seconds
o
Listing 73 - Using nmap to scan for the NetBIOS service
We saved the scan output into a text file, which revealed hosts with ports 139 and 445 open.
n
There are other, more specialized tools for specifically identifying NetBIOS information, such as
nbtscan. We can use this to query the NetBIOS name service for valid NetBIOS names, specifying
i
the originating UDP port as 137 with the -r option.
z
kali@kali:~$ sudo nbtscan -r 192.168.50.0/24
Doing NBT name scan for aDddresses from 192.168.50.0/24
IP address NetBIOS Name Server User MAC address
------------------------------------------------------------------------------
192.168.50.124 SAMBA  SAMBA 00:00:00:00:00:00
192.168.50.134 SAMBAWEB  SAMBAWEB 00:00:00:00:00:00
...
Listing 74 - Using nbtscan to collect additional NetBIOS information
The scan revealed two NetBIOS names belonging to two hosts. This kind of information can be
used to further improve the context of the scanned hosts, as NetBIOS names are often very
descriptive about the role of the host within the organization. This data can feed our information-
gathering cycle by leading to further disclosures.
Nmap also offers many useful NSE scripts that we can use to discover and enumerate SMB
services. We’ll find these scripts in the /usr/share/nmap/scripts directory.
kali@kali:~$ ls -1 /usr/share/nmap/scripts/smb*
/usr/share/nmap/scripts/smb2-capabilities.nse
/usr/share/nmap/scripts/smb2-security-mode.nse
271 (Wikipedia, 2022), https://en.wikipedia.org/wiki/NetBIOS_over_TCP/IP
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 153
Made in Morocco
Penetration Testing with Kali Linux
/usr/share/nmap/scripts/smb2-time.nse
/usr/share/nmap/scripts/smb2-vuln-uptime.nse
/usr/share/nmap/scripts/smb-brute.nse
/usr/share/nmap/scripts/smb-double-pulsar-backdoor.nse
/usr/share/nmap/scripts/smb-enum-domains.nse
/usr/share/nmap/scripts/smb-enum-groups.nse
/usr/share/nmap/scripts/smb-enum-processes.nse
/usr/share/nmap/scripts/smb-enum-sessions.nse
/usr/share/nmap/scripts/smb-enum-shares.nse
/usr/share/nmap/scripts/smb-enum-users.nse
/usr/share/nmap/scripts/smb-os-discovery.nse
...
Listing 75 - Finding various nmap SMB NSE scripts
We’ve located several interesting Nmap SMB NSE scripts that perform various tasks such as OS
discovery and enumeration via SMB. y
k
The SMB discovery script works only if SMBv1 is enabled on the target, which is
not the default case on modern versions of Windows. However, plenty of legacy
s
systems are still running SMBv1, and we have enabled this specific version on
the Windows host to simulate such a scenario.
o
Let’s try the smb-os-discovery module on the Windows 11 client.
n
kali@kali:~$ nmap -v -p 139,445 --script smb-os-discovery 192.168.50.152
... i
PORT STATE SERVICE REAzSON
139/tcp open netbios-ssn syn-ack
445/tcp open microsoft-ds syn-ack
D
Host script results:
| smb-os-discovery:
| OS: Windows 10 Pro 22000 (Windows 10 Pro 6.3)
| OS CPE: cpe:/o:microsoft:windows_10::-
| Computer name: client01
| NetBIOS computer name: CLIENT01\x00
| Domain name: megacorptwo.com
| Forest name: megacorptwo.com
| FQDN: client01.megacorptwo.com
|_ System time: 2022-03-17T11:54:20-07:00
...
Listing 76 - Using the nmap scripting engine to perform OS discovery
This particular script identified a potential match for the host operating system; however, we
know it’s inaccurate as the target host is running Windows 11 instead of the reported Windows
10.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 154
Made in Morocco
Penetration Testing with Kali Linux
As mentioned earlier, any Nmap service and OS enumeration output should be
taken with grain of salt, as none of the algorithms are perfect.
Unlike Nmap’s OS fingerprinting options we explored earlier, OS enumeration via NSE scripting
provides extra information, such as the domain and other details related to Active Directory
Domain Services.272 This approach will also likely go unnoticed, as it produces less traffic that can
also blend into normal enterprise network activity.
Having discussed SMB enumeration via Kali, let’s learn how to enumerate it from a Windows
client.
y