+[Software\\Microsoft\\Windows NT\\CurrentVersion\\Fonts]
1337689369
@@ -20321 +20321 @@
省略
和 REMnux 不同的是，Zero Wine 可以将运行日志总结成报告，因此对
于静态分析所无法触及的部分十分有效。不过，由于分析非常耗时，而
且分析结果的可信度也尚有一定问题，因此这个工具还没有达到实用的
程度。
登录进去之后我们可以看到它的工作原理，因此建议大家登录进去看一
看。
专栏：尝试开发自己的工具
市面上已经有很多安全工具，要编写这些工具，必须具备一定的计
算机安全方面的知识。
然而，仅具备安全方面的知识还不够，就好像要编写财务软件需要
既懂财务又懂编程，要编写音乐软件也需要既懂音乐又懂编程。
同时具备安全和编程两方面技术的人们进行了长年累月的研究和开
发，托他们的福，现在我们终于可以比较轻松地进行二进制分析和
安全调查了。
换句话说，我们其实都是站在巨人的肩膀上。
如果有兴趣的话，希望大家能够尝试自己编写一个自己使用起来方
便的分析工具或者安全工具。
5.6 尽量减少人工分析 ：启发式技术
5.6.1 恶意软件应对极限的到来：平均每天 60000 个
下面我们来聊一聊业界最新的话题。
传统的反病毒软件都是以黑名单方式为基础的，即“按照事先列出的黑
名单，查找符合条件的对象”。然而，这种方式的极限正在逐步显现。
随着恶意软件数量的增加，通过人工分析并更新特征文件的方式，以数
据库作为武器的检测手段终将迎来其处理极限。
遗憾的是，被发现的恶意软件的数量每年都在快速增加。有报告称，现
在平均每天可以检测到 60000 个恶意软件。
McAfee Q1 Threats Report Reveals Surge in Malware and Drop in
SPAM
http://www.mcafee.com/cn/about/news/2011/q2/20110601-01.aspx
因此，我们必须尽可能地让恶意软件的分析实现自动化，以减少人工作
业的比例。但即便恶意软件的分析能够完全自动化，我们也必须面对特
征文件变得越来越大的问题。
5.6.2 启发式技术革命
出于上述原因，在恶意软件的检测方面亟需技术创新。目前，对恶意软
件的“行为检测”，即启发式技术，正在受到广泛的关注。
“频繁访问注册表的行为，疑似恶意软件”
“频繁收发小的网络数据包，疑似恶意软件”
像上面这样，启发式技术是对恶意软件的行为特征进行归类，并将符合
这些特征的软件判定为恶意软件。
基于这些研究，目前很多反病毒软件都集成了启发式引擎，作为软件功
能的一部分来使用。
Adobe Malware Classifier
http://sourceforge.net/projects/malclassifier.adobe/
由于启发式引擎都是各公司自主研发的，因此外人很难接触到其核心技
术。不过，2012 年 4 月，Adobe 公司发布了一款开源的恶意软件检测引
擎——Adobe Malware Classifier。
这个引擎可以对 Windows 可执行文件（PE 文件）进行恶意软件检测，
程序本身是用 Python 编写的。
Adobe Malware Classifier 包括四个独立的检测算法，可分别对目标程序
进行评分。
如果所有的检测算法都被判定为恶意软件，则最终结果会显示 1。
相对地，如果所有的检测算法都被判定为非恶意软件，则最终结果会显
示 0。
此外，如果各检测算法的结论不一致，则显示 UNKNOWN。
在源代码的开头，还发布了该引擎的准确率测试结果，非常有意思。
▼ AdobeMalwareClassifier.py
Results on dataset of ~130000 dirty, ~ 16000 clean files:
(False Positives, True Negatives, True Positives, rates
J48 FP TN TP FN TP Rate FP Rate Accuracy
7683 37171 130302 3451 0.97419871 0.171289071 0.937662018
J48Graft FP TN TP FN TP Rate FP Rate Accuracy
6780 38074 129087 4666 0.96511480 0.151157087 0.935915166
PART FP TN TP FN TP Rate FP Rate Accuracy
7074 36492 125060 9412 0.93000773 0.162374329 0.907401791
Ridor FP TN TP FN TP Rate FP Rate Accuracy
7390 37935 114194 20930 0.84510523 0.163044677 0.843058149
这里是对大约 13 万个恶意软件和 16000 个正常软件进行测试，并统计
每个检测算法的准确率。
其中各数值上面的 FP、TN、TP、FN 都是缩写，它们代表的含义如
下。
FP（False Positive，假阳性）：将正常文件误判为恶意软件
TN（True Negative，真阴性）：将正常文件判定为正常文件
TP（True Positive，真阳性）：将恶意软件判定为恶意软件
FN（False Negative，假阴性）：将恶意软件判定为正常文件
TP Rate 表示将恶意软件判定为恶意软件的概率，其计算公式为
TP÷(TP+FN)，即 130302÷(130302+3451)=0.97419871。
反之，FP Rate 则表示将正常文件误判为恶意软件的概率，结果为
0.171289071。
最后的 Accuracy 表示准确率。
简单总结如下。
将恶意软件判定为恶意软件的概率（真阳性）：90% 以上
将正常文件判定为正常文件的概率（真阴性）：不到 85%
85% 和 90% 代表每 10 次就会误判一次，不过也许可以通过四个算法进
行独立评分来弥补一下。
5.6.3 用两个恶意软件进行测试
下面我们用第 1 章中的两个恶意软件来测试一下。
▼ 运行示例
C:\>AdobeMalwareClassifier.py -v -f wsample01a.exe
Starting dump of wsample01a.exe
DebugSize: 28
ImageVersion: 0
IatRVA: 8868
ExportSize: 0
ResourceSize: 436
VirtualSize2: 1720
NumberOfSections:5
Stop
Processing all...
1 J48算法的检测结果
1 J48Graft算法的检测结果
1 PART算法的检测结果
0 Ridor算法的检测结果
UNKNOWN 最终结果
在运行工具时加上 -v 选项，可以显示出评分过程中所用到的值。
Adobe Malware Classifier 是通过 PE 文件头的值来判断恶意软件的，并
根据四个算法的检测结果显示最终结论。
wsample01a.exe 只是一个显示消息框的简单程序，但四个算法中有三个
都给出了恶意软件的结论。
从上面的例子可以看出，启发式恶意软件检测技术不同于传统的黑名单
方式，误判率很高，因此到现在也未能成为一种确实有效的检测手段。
如果大家对安全技术，尤其是对恶意软件方面的技术感兴趣，而且有机
会从事相关研究，那么启发式技术可以说是一个非常有趣的研究方向。
附录
A.1 安装 IDA
IDA 的 Demo 版和免费版都可以从官方网站进行下载。
https://www.hex-rays.com/products/ida/support/download.shtml
Demo 版的版本比较新，但其功能有所限制，如果没有什么特别的原
因，还是建议使用免费版。
IDA 目前（2013/05）的最新版本为 6.4，免费版为比较老的 5.0 版本。
不过，由于其反编译方面的功能已经非常成熟，因此对于初学者来说已
经完全够用了。
▲ IDA 网页（https://www.hex-
rays.com/products/ida/support/download.shtml ）
从 Demo 版的链接 IDA demo download 点进去，可以找到免费版 IDA
5.0 Freeware 的下载链接，点击进入下载页面。
▲ Setup
▲ License Agreement
选择 I accept the agreement。
▲ 选择安装目录
▲ 选择是否创建快捷方式
▲ 安装配置确认
▲ 安装开始
▲ 安装结束
如果选择创建快捷方式（Create a desktop icon），安装程序会在桌面上
放置一个图标。将其他可执行文件拖曳到这个图标上，就可以用 IDA
快速打开它。
A.2 安装 OllyDbg
OllyDbg 可以从下面的网站下载。
http://www.ollydbg.de/
最新的版本为 2.01，但这是一个 Beta 版，因此本书中使用的是 1.10 版
本。
▲ OllyDbg 网页（http://www.ollydbg.de/ ）
OllyDbg 没有安装程序，只要将下载的 ZIP 压缩包解压缩，将其中的文
件复制到任意目录就可以使用了。
A.3 安装 WinDbg
WinDbg 分为 32 位和 64 位两个版本。
WinDbg（32 位版）
https://msdn.microsoft.com/zh-cn/windows/hardware/gg463016
WinDbg（64 位版）
http://msdn.microsoft.com/zh-cn/windows/hardware/gg463012
▲ 32 位版 Debugging Tools for Windows 网页
老版本可以在网页的最下方找到下载链接。
最新版可以通过 Windows Software Development Kit（Windows SDK）的
安装程序选择所需的工具来进行安装。
▲ Windows SDK 网页
（http://www.microsoft.com/en-us/download/details.aspx?id=8279 ）
▲ Setup
▲ License Agreement
选择 I Agree，进入下一页。
▲ 选择安装目录
▲ 选择要安装的工具
在这里我们可以选择安装很多种工具。
要安装 WinDbg，请选择 Common Utilities 中的 Debugging Tools for
Windows。
▲ 安装设置完成
▲ 安装开始
▲ 安装结束
到这里我们就安装完成了。
A.4 安装 Visual Studio 2010
尽管现在微软已经发布了 Visual Studio 2012，但本书中还是使用 Visual
Studio 2010 Express 版来进行讲解（准确来说应该是 Visual C++ 2010
1
Express 版）。大家可以从下面的网站下载 。
1
目前微软官方已不提供 Visual Studio 2010 的下载，各位读者只能从第三方渠道获取，或者使
用最新的 Visual Studio 2013/2015 Community 版本。——译者注
▲ Visual Studio 2010 下载页面
2
（http://www.microsoft.com/visualstudio/eng/downloads#d-2010-express
）
2
本网址已被重定向到 Visual Studio 的门户页面。——译者注
如果要使用 Visual Studio 2012 Express 版，可以从以下网站下载 for
Windows Desktop 的版本（可用于 Windows 7 及更高版本系统）。
Visual Studio Express 2012 products
http://www.microsoft.com/visualstudio/eng/products/visual-studio-
3
express-products
3
本网址已被重定向到 Visual Studio 的门户页面。——译者注
▲ Setup
▲ License
选择 I have read and accept the license terms，然后进入下一页。
▲ 安装选项
本书中不使用 Silverlight 和 SQL Server，因此请不要选中这两项。
▲ 选择安装目录
▲ 安装开始
▲ 重启系统
在安装过程中，可能需要重启几次系统。
▲ 安装结束
到这里就安装完成了。
不过，如果不进行在线注册，软件只能使用 30 天。请大家从菜单中选
择 Help → Register Product，从弹出的网页获取注册密钥。
▲ 注册产品
创建一个 Microsoft 账户，并在登录状态下点击 Obtain a registration key
online，画面上会显示出注册密钥。将密钥输入上面的对话框，就可以
完成注册了。
A.5 安装 Metasploit
这里我们来介绍一下 Windows 版 Metasploit 的安装方法。
基本上只要按照安装程序的提示操作即可，其中需要用户选择的部分如
下。
安装目录
服务监听端口
域名（本书中不使用）
安装和启动都比较耗时，请大家耐心等待。
▲ Metasploit 网页
（https://www.rapid7.com/products/metasploit/ ）
请根据所使用的环境进行下载。
▲ Setup
▲ License Agreement
选择 I accept the agreement，然后点击 Next。
▲ 选择安装目录
如果没有特别的理由，使用默认安装目录即可。
▲ 设置监听端口
▲ 设置域名（和有效期）
从浏览器访问 Metasploit 时需要使用域名和端口，如果没有特别的理
由，保留默认值即可。
▲ 安装设置完成
▲ 安装开始
▲ 安装结束
本书中没有使用 Web UI，因此请大家取消这里的复选框。
关于服务的启动和停止，稍后还可以自由配置。
▲ 启动控制台 1
▲ 启动控制台 2