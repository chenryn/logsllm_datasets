### Metasploit渗透测试指南

#### 使用漏洞扫描器的注意事项
使用漏洞扫描器通常会在网络上产生大量流量，因此如果你希望在渗透测试过程中保持隐蔽，建议不要使用漏洞扫描器。然而，如果隐蔽性不是你的首要考虑因素，利用漏洞扫描器来确定目标系统的补丁安装情况和存在的漏洞将比手动方法更为高效。

无论采用自动还是手动的方式，漏洞扫描都是渗透测试流程中的关键步骤之一。一次全面的漏洞扫描能为客户提供重要的安全信息。本章将探讨一些常用的漏洞扫描工具，并展示如何将它们与Metasploit结合使用，同时介绍Metasploit框架中可用于远程漏洞扫描的辅助模块。

#### 4.1 基本的漏洞扫描
首先，我们来看一个基本的漏洞扫描示例。我们将使用`netcat`工具获取目标IP地址（192.168.1.203）上的Web服务器旗标。旗标是指连接到远程服务后读取的服务标识信息。许多网络服务（如Web、FTP和邮件服务）在接收到特定指令后会返回这些标识信息。以下是在TCP端口80上连接到Web服务器并发送HTTP请求的过程：

```bash
root@bt:/opt/framework3/msf3# nc 192.168.1.203 80
GET / HTTP/1.1
```

响应如下：
```http
HTTP/1.1 400 Bad Request
Server: Microsoft-IIS/5.1
```

从响应中可以看出，目标主机运行的是基于Microsoft IIS 5.1的Web服务器。有了这些信息，我们可以使用漏洞扫描器进一步检查该版本IIS是否存在已知漏洞及其补丁状态。

需要注意的是，在实际环境中，漏洞扫描并非总是简单直接的。由于系统配置的细微差异，扫描结果可能包含误报（报告了不存在的漏洞）或漏报（未发现存在的漏洞）。开发者通常倾向于宁可误报也不愿漏报，因为用户更不能接受漏报现象。漏洞扫描器的效果很大程度上依赖于其内置的漏洞特征库，而这些特征库可能会被误导性的旗标或动态配置所欺骗。

#### 4.2 使用NeXpose进行扫描
NeXpose是由Rapid7公司开发的一款漏洞扫描工具。它通过扫描网络来识别设备、操作系统及应用程序的安全漏洞，并生成详细的报告。NeXpose提供多个版本，包括免费的社区版（Community Edition），适用于非商业用途。对于商业应用，请访问Rapid7官网（http://www.rapid7.com/vulnerability-scanner.jsp）了解更多信息。

我们的目标是一个默认安装的Windows XP SP2系统，具体配置见附录A。接下来，我们将进行白盒扫描，并将结果导入Metasploit。此外，还会介绍如何在MSF终端中调用NeXpose执行扫描，以避免使用图形界面带来的不便。

##### 4.2.1 配置
完成NeXpose社区版的安装后，打开浏览器并访问https://localhost:3780。首次登录时需接受自签名证书，并输入安装时设置的用户名和密码。成功登录后，你将看到主界面，其中包含资产管理、报告查看、漏洞详情及系统设置等功能区。

###### 创建新站点
1. **添加新站点**：点击“New Site”按钮，输入站点名称和描述。
2. **定义目标范围**：可以指定单个IP地址、地址段或排除某些设备。
3. **选择扫描类型**：从预设模板中选择合适的扫描模式。
4. **配置登录凭据**（可选）：如果拥有目标系统的登录权限，可在此处添加以提高扫描准确性。
5. **保存设置**：确认无误后保存站点配置。

###### 手动扫描
1. **启动手动扫描**：在主界面上选择“New Manual Scan”，指定要扫描的目标资产。
2. **开始扫描**：检查IP地址无误后点击“Start Now”。
3. **监控进度**：等待扫描完成，期间可以查看实时更新的状态信息。

##### 4.2.2 导入扫描报告至Metasploit
完成漏洞扫描后，需要将结果导入Metasploit数据库。在此之前，请确保已在MSF终端中通过`db_connect`命令创建了新的数据库。