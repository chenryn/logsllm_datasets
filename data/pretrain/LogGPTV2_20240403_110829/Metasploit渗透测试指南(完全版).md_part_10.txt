Metasploit渗透测试指南
使用漏洞扫描器通常会在网络上产生大量流量，因此如果你不希望被别人发现渗透测试工
作踪迹的时候，建议不要使用漏洞扫描器。但是，如果你的渗透测试工作并不需要隐秘进行，
利用漏洞扫描器去确定目标的补丁安装等级和漏洞，将比使用手工方式要省时省力。
无论你使用自动还是手工方式，漏洞扫描都是渗透测试工作流程中最为重要的步骤之一。
一-次透彻的漏洞扫描对你的客户而言是非常有价值的。在本章中，我们将针对一些漏洞扫描器
展开讨论，并展示如何将它们与Metasploit结合起来使用，同时还将重点介绍一些Metasploit
框架中能够进行远程漏洞扫描的辅助模块，
4.1基本的漏洞扫描
让我们看一下最基本的漏洞扫描是如何进行的。我们使用netcat来获取目标192.168.1.203
的旗标。旗标撰取是指连接到一个远程网络服务，并读取该服务独特的标识（旗标)。许多网
络服务，比如Web、文件传输以及邮件等，一旦连接到它们的服务端口或向它们发送特定指
令，就可以取得旗标。在这里，我们连接到一个运行在TCP端口80上的Web服务器，并发
样的信息。
root@bt:/opt/framework3/msf3#nc192.168.1.20380
GETHTTP1/1
HTTP/1.1 400 Bad Request
OServer:Microsoft-IIS/5.1
返回的信息0告诉我们，端口80上运行的是基于微软1IS5.1的Web服务器系统。有了这
些信息，我们可以使用如图4-1所示的漏洞扫描器，来确定目标是否包含任何与该版本ⅡIS相关
的漏洞，以及这台服务器是否已经安装了补丁程序。
当然，在实际环境中，发现漏洞并非简单到执行一下扫描即可。由于系统和应用程序配置
存在细微差异，漏洞扫描结果通常包含许多误报（报告了漏洞但实际上漏洞并不存在）和漏报
（未报告漏洞但实际上漏洞存在）。漏洞扫描器的开发者通常宁可误报，不可漏报，因为潜在的
买家不会购买出现漏报的扫描器。漏洞扫描器的扫描质量很大程度上取决于它自带的漏洞特征
库，而且它们很容易被具有误导性的旗标和易变的配置所愚弄。
下面让我们来了解一些真正实用的漏洞扫描器，主要包括NeXpose、Nessus和一些专项扫
描器。
36
---
## Page 64
第4章漏洞扫描
Reports
Report info
we:
192.168.1.203
80/tcp
Deta
PluginName
www（B0cp）Lo
（do）
0 / udp
43111HTTPMethods Allowed (per directory)
www（80rtcp)Low
25/tcp
11874Miroof40RespoiseSericePackSiga
www(B0op)Low
80/
11213HTTPTRACE/TRACK Methods Alowed
（）
11424WebDAV Detecdion
www（80tcp）Low
137/udp
24260HyperTextTransferProtocol(HTTP)Infomation
ww（Btcp)Low
图4-1针对目标Web服务器的漏洞扫描结果
4.2使用NeXpose进行扫描
NeXpose是Rapid7公司推出的漏洞扫描器产品。它通过对网络进行扫描，查找出网络上正
在运行的设备，最终识别出操作系统和应用程序上的安全漏洞。NeXpose随后对扫描得到的数
据进行分析和处理，并生成各种类型的报告。
Rapid7公司提供了多种NeXpose版本，在这里我们使用社区共享版（Communityedition），
因为这个版本是免费的。如果你打算在商业活动中使用NeXpose，可以参考Rapid7网站
(http://www.rapid7.com/vulnerability-scannerjsp），了解不同商业版本所具有的功能和各个版本的
定价。
我们扫描的目标是一个默认安装的WindowsXPSP2主机，其具体配置参考附录A。首先，
我们对目标进行一次公开的白盒扫描；然后，将漏洞扫描的结果导入到Metasploit中。在本节
结束前，还会为你介绍如何在MSF终端中调用NeXpose进行漏洞扫描，在MSF终端中运行
NeXpose可以让你无需打开基于Web的图形用户界面，而且省去了从外部导入扫描报告的麻烦。
4.2.1配置
在社区共享版的NeXpose安装完毕后，你可以打开一个网页浏览器，输入如下网址：
https://:3780。然后你需要接受NeXpose为自己签发的服务器证书，并使用安装
时设定的用户名和口令登录。登录成功后你会看到如图4-2所示的界面。（在Rapid7网站上有
关于安装NeXpose 的详细介绍。）
在NeXpose的主界面中，你会在页面顶端看到如下一些标签页：
●资产（Assets）页O中显示网络上已扫描过的计算机和设备；
●报告（Reports）页·中列出了扫描完成后生成的报告；
●漏洞（Vulnerabilities）页③中对在网络上发现的漏洞进行了详细描述；
●管理（Administration）页①中可以对各种系统配置进行修改。
37
---
## Page 65
Metasploit渗透测试指南
NEXPOSE
Hom
lom
Search
Asset lr
日
RESHON
Current Scan Listing for All Sites
回X
7UC,Soston,MARapid7 LLC Saies:
图 4-2NeXpose的初始首页界面
界面底部的一些按钮主要用来执行一些常用操作，例如创建一个新的目标站点或扫描任务等。
1.新站点向导
个特定的子网或多个服务器，简单情况下可以是一个单独的工作站。站点是NeXpose的扫描对
象，在执行扫描之前，必须设置一个站点。可以为不同的站点指定不同的扫描类型。
（1）创建新站点时，在NeXpose主界面中点击NewSite（新站点）按钮，输入站点名称和
简短描述，然后点击Next（下一步）进入添加设备界面。
（2）添加设备时，你可以使用多种不同的粒度来对目标进行定义，如图4-3所示。你可以
添加一个单独的IP地址、--个地址范围、一台主机名等等，也可以声明将特定设备（如打印机）
从扫描范围内排除。（打印机经常会对扫描操作有些“过敏”，我们曾见过这样的场景，一个简
成设备的添加和排除。
（3）在扫描设置步骤中，你可以从几个不同的扫描模板中选择，例如发现扫描（Discovery
Scan）和渗透测试（Penetrationtest）；可以选择你偏爱的扫描引擎；还能够设置自动进行扫描
任务调度等。由于我们只是对NeXpose功能做一个简要介绍，这里我们保持默认的设置不变，
并点击Next按钮继续。
（4）如果你拥有被扫描站点的登录凭据，可以将它们添加到扫描任务中（译者注：登录凭
据一般是指登录时所使用的用户名与口令，这种类型的扫描通常称之为“白盒扫描”或“授权
扫描”，与之相对的通常称为“黑盒扫描”或“非授权扫描”。使用登录凭据能够让扫描器获取
目标系统上安装的软件列表和系统策略，这样有助于获得更为准确和详细的扫描结果。
（5）在Credentials（登录凭据）页面上，点击NewLogin（新的登录）按钮，为待扫描的
IP地址输入一个用户名和口令。可以点击TestLogin（测试登录）对输入的登录凭据进行验证，
并将其保存。
38
---
## Page 66
第4章漏洞扫描
NEXPOSE
ouNSaC
Included Devioes
192.168.1.195
10001-
-10.0.0.255
0.0.0.0/24
CIDR
uep
me10.0.0.1-
10.0.0.254
10.0.255.254
10.0.0.1
图4-3向NeXpose站点中添加新设备
（6）最后，点击Save（保存）按钮结束新站点向导并返回到主界面。这时主界面中会列出
你刚刚添加的站点，如图4-4所示。
NEXPOSE
、
区
O区
图4-4主界面中显示了刚刚配置好的站点
2.手动扫描向导
新的站点配置好后，便可以开始创建你的第一次扫描任务了：
（1）点击图4-4中所示的NewManualScan（新的手动扫描）按钮，这时你会看见如图4-5
所示的对话框，这里可以指定你想要将哪些资产包含在扫描中，或将哪些资产排除在扫描之外。
在本例中，我们对刚才提到的WindowsXP主机进行扫描。
（2）仔细检查你的目标IP地址，确保没有因疏忽指定了错误的设备或网络。确认无误后点
击StartNow（立即开始）按钮开始扫描。
39
---
## Page 67
Metasploit渗透测试指南
nore assets within this site by entering IP addresses,IP address
ranges orhostnames
ss
Lab1
Site Detalls
Scan template:
Full audit
Included assets:
192.168.1.195
Excluded assets:
Manual ScanTargets
Scan all assetswithin this site
OSpecifyone ormoreassetswithin thissitetoscan
Assets to scan:
AONBIS
图4-5NeXpose的扫描配置对话框
（3）扫描过程中，NeXpose会动态刷新扫描状态页面。请等待ScanProgress（扫描进度）
和DiscoveredAssets（资产识别）的状态均显示为Completed（完成），如图4-6所示。在界面上
的ScanProgress区域中你可以看见在被扫描的设备上发现了268个漏洞；在DiscoveredAssets
区域中为你提供了关于目标更详细的信息，如设备名字和操作系统类型等。现在，请点击Reports
（报告）选项卡。
NEXPOSE
Assets
Jser7-000
ome : Assets : Sites : Lab1 : Scans : Full audit
Aset Fite
Scan Progress
日区
Scan Type
Started
Devices Dlscovered
Elapsed
Status
TueMar0820114:24:12
lanual
1268
3minutes
sfully
Vlon
OperatingSystem
192.168.1.195
V-MAC-XP
Micrasoft wlndows XPPrafesslonal
SP2
2683minu
2010Rapid,Boston,MARapd7LC Seles:86.7RAPID7(772.7437)
图 4-6NeXpose 扫描完成后的报告
40
---
## Page 68
第4章漏洞扫描
3.生成报告向导
如果你是第一次运行NeXpose，而且仅仅完成了一次扫描，Report选项卡中不会显示任何内容。
（1）如图4-7所示，点击NewReport（新报告）打开生成报告向导。
NEXPOSE
ome: Reports
Asset
Report Listing
@ 2010 Rapid7 11C, 8o
图4-7NeXpose的报告选项卡
（2）输入一个好记的名称，然后在Reportformat（报告格式）字段，选择NeXposeSimple
XMLExport(NeXpose简单XML输出），如图4-8所示。这种格式的报告能够导入到Metasploit
的数据库中。在这里还可以选择不同的报告模板，如果你恰巧是在远途旅行的路上做渗透测
试，还可以在这里设置你的时区。设置好这些参数后，点击Next按钮继续。
NEXPOSE
Soarch
General
Report Configuratio
PreviousNetSveCa
Reportnam
TargeL_195
Audit Repor
Te
图4-8为报告设置名称和格式
（3）如图4-9所示，在接下来的窗口中点击SelectSites（选择站点），将你需要在报告中描
述的站点添加进来，然后点击Save按钮。
Select Sites
ScanngfinsRisk Score
Slte Name
Last Scan
Devloe
1268
1249681
Tue MarD8
2011
Save
图4-9选择希望包含在报告中的站点
41
---
## Page 69
Metasploit渗透测试指南
（4）在SelectDevice（选择设备）对话框中，选择想要包含在报告中的设备然后点击Save按钮。
（5）回到报告设置向导，点击Save按钮接受其他尚未配置的选项的默认值。现在Report
选项卡中显示出了最近创建的报告，如图4-10所示。
NEXPOSE
Hoets
Reports
Sosrch
w are the generated reports for the Target_195 report
Report History
Tue Mar08201115:03:00GMT-0700(MST)
101KB
2010d7C,osMRadLCSales7APID7（7727437)
图4-10报告选项卡列出了已生成的报告
4.2.2将扫描报告导入到Metasploit中
使用NeXpose完成了一次完整的漏洞扫描之后，你需要将扫描结果导入到Metasploit中。
但在导入之前，你必须在MSF终端中使用db_connect命令创建一个新的数据库。数据库创建