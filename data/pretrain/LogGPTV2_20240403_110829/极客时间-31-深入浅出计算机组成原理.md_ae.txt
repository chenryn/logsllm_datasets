## 总结延伸好了，学完这一讲，对"性能"这个名词，你应该有了更清晰的认识。我主要对于"响应时间"这个性能指标进行抽丝剥茧，拆解成了计算机时钟周期、CPI以及指令数这三个独立的指标的乘积，并且为你指明了优化计算机性能的三条康庄大道。也就是，提升计算机主频，优化CPU设计使得在单个时钟周期内能够执行更多指令，以及通过编译器来减少需要的指令数。在后面的几讲里面，我会为你讲解，具体怎么在电路硬件、CPU设计，乃至指令设计层面，提升计算机的性能。
## 课后思考每次有新手机发布的时候，总会有一些对于手机的跑分结果的议论。乃至于有"作弊"跑分或者"针对跑分优化"的说法。我们能针对"跑分"作弊么？怎么做到呢？"作弊"出来的分数对于手机性能还有参考意义么？欢迎留言和我分享你的思考和疑惑，你也可以把今天的内容分享给你的朋友，和他一起学习和进步。![](Images/79d06107d349635530fbf82aa8dfb625.png){savepage-src="https://static001.geekbang.org/resource/image/28/29/281ca28b90c8aa0aecbb5adc08394f29.jpg"}
# 04 \| 穿越功耗墙，我们该从哪些方面提升"性能"？上一讲，在讲 CPU 的性能时，我们提到了这样一个公式：```{=html}```程序的 CPU 执行时间 = 指令数×CPI×Clock Cycle Time```{=html}```这么来看，如果要提升计算机的性能，我们可以从指令数、CPI 以及 CPU主频这三个地方入手。要搞定指令数或者 CPI，乍一看都不太容易。于是，研发CPU 的硬件工程师们，从 80 年代开始，就挑上了 CPU 这个"软柿子"。在 CPU上多放一点晶体管，不断提升 CPU 的时钟频率，这样就能让 CPU变得更快，程序的执行时间就会缩短。于是，从 1978 年 Intel 发布的 8086 CPU 开始，计算机的主频从 5MHz开始，不断提升。1980 年代中期的 80386 能够跑到 40MHz，1989 年的 486能够跑到 100MHz，直到 2000 年的奔腾 4 处理器，主频已经到达了1.4GHz。而消费者也在这 20年里养成了"看主频"买电脑的习惯。当时已经基本垄断了桌面 CPU 市场的 Intel更是夸下了海口，表示奔腾 4 所使用的 CPU 结构可以做到10GHz，颇有一点"大力出奇迹"的意思。
## 功耗：CPU 的"人体极限"然而，计算机科学界从来不相信"大力出奇迹"。奔腾 4 的 CPU主频从来没有达到过 10GHz，最终它的主频上限定格在3.8GHz。这还不是最糟的，更糟糕的事情是，大家发现，奔腾 4的主频虽然高，但是它的实际性能却配不上同样的主频。想要用在笔记本上的奔腾4 2.4GHz 处理器，其性能只和基于奔腾 3 架构的奔腾 M 1.6GHz 处理器差不多。``{=html}于是，这一次的"大力出悲剧"，不仅让 Intel 的对手 AMD获得了喘息之机，更是代表着"主频时代"的终结。后面几代 Intel CPU主频不但没有上升，反而下降了。到如今，2019 年的最高配置 Intel i9CPU，主频也只不过是 5GHz 而已。相较于 1978 年到 2000 年，这 20 年里 300倍的主频提升，从 2000 年到现在的这 19 年，CPU 的主频大概提高了 3 倍。![](Images/301c1a1c244e0e377783b87b2806893e.png){savepage-src="https://static001.geekbang.org/resource/image/18/80/1826102a89e4cdd31f7573db53dd9280.png"}\]{.reference}```{=html}```CPU 的主频变化，在奔腾 4时代进入了瓶颈期，[图片来源](https://en.wikipedia.org/wiki/File:Clock_CPU_Scaling.jpg)```{=html}```奔腾 4 的主频为什么没能超过 3.8GHz的障碍呢？答案就是功耗问题。什么是功耗问题呢？我们先看一个直观的例子。一个 3.8GHz 的奔腾 4 处理器，满载功率是 130 瓦。这个 130瓦是什么概念呢？机场允许带上飞机的充电宝的容量上限是 100瓦时。如果我们把这个 CPU 安在手机里面，不考虑屏幕内存之类的耗电，这个CPU 满载运行 45 分钟，充电宝里面就没电了。而 iPhone X 使用 ARM 架构的CPU，功率则只有 4.5 瓦左右。我们的 CPU，一般都被叫作**超大规模集成电路**（Very-Large-ScaleIntegration，VLSI）。这些电路，实际上都是一个个晶体管组合而成的。CPU在计算，其实就是让晶体管里面的"开关"不断地去"打开"和"关闭"，来组合完成各种运算和功能。想要计算得快，一方面，我们要在 CPU里，同样的面积里面，多放一些晶体管，也就是**增加密度**；另一方面，我们要让晶体管"打开"和"关闭"得更快一点，也就是**提升主频**。而这两者，都会增加功耗，带来耗电和散热的问题。这么说可能还是有点抽象，我还是给你举一个例子。你可以把一个计算机 CPU想象成一个巨大的工厂，里面有很多工人，相当于 CPU上面的晶体管，互相之间协同工作。为了工作得快一点，我们要在工厂里多塞一点人。你可能会问，为什么不把工厂造得大一点呢？这是因为，人和人之间如果离得远了，互相之间走过去需要花的时间就会变长，这也会导致性能下降。这就好像如果CPU的面积大，晶体管之间的距离变大，电信号传输的时间就会变长，运算速度自然就慢了。除了多塞一点人，我们还希望每个人的动作都快一点，这样同样的时间里就可以多干一点活儿了。这就相当于提升CPU主频，但是动作快，每个人就要出汗散热。要是太热了，对工厂里面的人来说会中暑生病，对CPU 来说就会崩溃出错。我们会在 CPU上面抹硅脂、装风扇，乃至用上水冷或者其他更好的散热设备，就好像在工厂里面装风扇、空调，发冷饮一样。但是同样的空间下，装上风扇空调能够带来的散热效果也是有极限的。因此，在 CPU里面，能够放下的晶体管数量和晶体管的"开关"频率也都是有限的。一个 CPU的功率，可以用这样一个公式来表示：```{=html}```功耗 \~= 1/2 ×负载电容×电压的平方×开关频率×晶体管数量```{=html}```那么，为了要提升性能，我们需要不断地增加晶体管数量。同样的面积下，我们想要多放一点晶体管，就要把晶体管造得小一点。这个就是平时我们所说的提升"制程"。从28nm 到 7nm，相当于晶体管本身变成了原来的 1/4大小。这个就相当于我们在工厂里，同样的活儿，我们要找瘦小一点的工人，这样一个工厂里面就可以多一些人。我们还要提升主频，让开关的频率变快，也就是要找手脚更快的工人。![](Images/4a0eb896f5c09621f9d65b6550422170.png){savepage-src="https://static001.geekbang.org/resource/image/f5/ed/f59f2f33e308000cb5d2ad017f2ff8ed.jpeg"}但是，功耗增加太多，就会导致 CPU散热跟不上，这时，我们就需要降低电压。这里有一点非常关键，在整个功耗的公式里面，功耗和电压的平方是成正比的。这意味着电压下降到原来的1/5，整个的功耗会变成原来的 1/25。事实上，从 5MHz 主频的 8086 到 5GHz 主频的 Intel i9，CPU 的电压已经从 5V左右下降到了 1V 左右。这也是为什么我们 CPU 的主频提升了 1000倍，但是功耗只增长了 40 倍。比如说，我写这篇文章用的是 SurfaceGo，在这样的轻薄笔记本上，微软就是选择了把电压下降到 0.25V 的低电压CPU，使得笔记本能有更长的续航时间。
## 并行优化，理解阿姆达尔定律虽然制程的优化和电压的下降，在过去的 20 年里，让我们的 CPU性能有所提升。但是从上世纪九十年代到本世纪初，软件工程师们所用的"面向摩尔定律编程"的套路越来越用不下去了。"写程序不考虑性能，等明年CPU 性能提升一倍，到时候性能自然就不成问题了"，这种想法已经不可行了。于是，从奔腾 4 开始，Intel意识到通过提升主频比较"难"去实现性能提升，边开始推出 Core Duo 这样的多核CPU，通过提升"吞吐率"而不是"响应时间"，来达到目的。提升响应时间，就好比提升你用的交通工具的速度，比如原本你是开汽车，现在变成了火车乃至飞机。本来开车从上海到北京要20 个小时，换成飞机就只要 2个小时了，但是，在此之上，再想要提升速度就不太容易了。我们的 CPU 在奔腾4 的年代，就好比已经到了飞机这个速度极限。那你可能要问了，接下来该怎么办呢？相比于给飞机提速，工程师们又想到了新的办法，可以一次同时开2 架、4 架乃至 8 架飞机，这就好像我们现在用的 2 核、4 核，乃至 8 核的CPU。虽然从上海到北京的时间没有变，但是一次飞 8架飞机能够运的东西自然就变多了，也就是所谓的"吞吐率"变大了。所以，不管你有没有需要，现在CPU 的性能就是提升了 2 倍乃至 8 倍、16倍。这也是一个最常见的提升性能的方式，**通过并行提高性能**。这个思想在很多地方都可以使用。举个例子，我们做机器学习程序的时候，需要计算向量的点积，比如向量]{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-3.mistyle="font-family: MathJax_Math-italic;"}[=]{#05.html#MathJax-Span-4.mostyle="font-family: MathJax_Main; padding-left: 0.285em;"}[\[]{#05.html#MathJax-Span-5.mostyle="font-family: MathJax_Main; padding-left: 0.285em;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-7.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[0]{#05.html#MathJax-Span-8.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-6.msubsup}[,]{#05.html#MathJax-Span-9 .mostyle="font-family: MathJax_Main;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-11.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[1]{#05.html#MathJax-Span-12.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-10.msubsup style="padding-left: 0.191em;"}[,]{#05.html#MathJax-Span-13 .mostyle="font-family: MathJax_Main;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-15.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[2]{#05.html#MathJax-Span-16.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-14.msubsup style="padding-left: 0.191em;"}[,]{#05.html#MathJax-Span-17 .mostyle="font-family: MathJax_Main;"}[...]{#05.html#MathJax-Span-18 .mostyle="font-family: MathJax_Main; padding-left: 0.191em;"}[,]{#05.html#MathJax-Span-19.mostyle="font-family: MathJax_Main; padding-left: 0.191em;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-21.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[15]{#05.html#MathJax-Span-24.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-23.mrow}]{#05.html#MathJax-Span-22.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.744em; height: 0px;"}]{#05.html#MathJax-Span-20.msubsup style="padding-left: 0.191em;"}[\]]{#05.html#MathJax-Span-25.mo style="font-family: MathJax_Main;"}]{#05.html#MathJax-Span-2.mrow}[]{style="display: inline-block; width: 0px; height: 2.355em;"}]{style="position: absolute; clip: rect(1.461em, 1011.86em, 2.732em, -999.998em); top: -2.351em; left: 0em;"}]{style="display: inline-block; position: relative; width: 12.002em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.35em; border-left: 0px solid; width: 0px; height: 1.356em;"}]{#05.html#MathJax-Span-1.mathstyle="width: 15.014em; display: inline-block;"}``{=html}[$W = \lbrack W_{0},W_{1},W_{2},\ldots,W_{15}\rbrack$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-1-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W=[W0,W1,W2,…,W15]"role="presentation"}$$ 和向量 []{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-28.mistyle="font-family: MathJax_Math-italic;"}[=]{#05.html#MathJax-Span-29.mostyle="font-family: MathJax_Main; padding-left: 0.285em;"}[\[]{#05.html#MathJax-Span-30.mostyle="font-family: MathJax_Main; padding-left: 0.285em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-32.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[0]{#05.html#MathJax-Span-33.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.273em; height: 0px;"}]{#05.html#MathJax-Span-31.msubsup}[,]{#05.html#MathJax-Span-34 .mostyle="font-family: MathJax_Main;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-36.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[1]{#05.html#MathJax-Span-37.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.273em; height: 0px;"}]{#05.html#MathJax-Span-35.msubsup style="padding-left: 0.191em;"}[,]{#05.html#MathJax-Span-38 .mostyle="font-family: MathJax_Main;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-40.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[2]{#05.html#MathJax-Span-41.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.273em; height: 0px;"}]{#05.html#MathJax-Span-39.msubsup style="padding-left: 0.191em;"}[,]{#05.html#MathJax-Span-42 .mostyle="font-family: MathJax_Main;"}[...]{#05.html#MathJax-Span-43 .mostyle="font-family: MathJax_Main; padding-left: 0.191em;"}[,]{#05.html#MathJax-Span-44.mostyle="font-family: MathJax_Main; padding-left: 0.191em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-46.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[15]{#05.html#MathJax-Span-49.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-48.mrow}]{#05.html#MathJax-Span-47.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.602em; height: 0px;"}]{#05.html#MathJax-Span-45.msubsup style="padding-left: 0.191em;"}[\]]{#05.html#MathJax-Span-50.mo style="font-family: MathJax_Main;"}]{#05.html#MathJax-Span-27.mrow}[]{style="display: inline-block; width: 0px; height: 2.355em;"}]{style="position: absolute; clip: rect(1.461em, 1011.3em, 2.732em, -999.998em); top: -2.351em; left: 0em;"}]{style="display: inline-block; position: relative; width: 11.438em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.35em; border-left: 0px solid; width: 0px; height: 1.356em;"}]{#05.html#MathJax-Span-26.mathstyle="width: 14.308em; display: inline-block;"}``{=html}[$X = \lbrack X_{0},X_{1},X_{2},\ldots,X_{15}\rbrack$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-2-Frame .MathJaxtabindex="0" style="position: relative;"mathml="X=[X0,X1,X2,…,X15]"role="presentation"}$$，[]{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-53.mistyle="font-family: MathJax_Math-italic;"}[⋅]{#05.html#MathJax-Span-54.mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-55.mistyle="font-family: MathJax_Math-italic; padding-left: 0.238em;"}[=]{#05.html#MathJax-Span-56.mostyle="font-family: MathJax_Main; padding-left: 0.285em;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-58.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[0]{#05.html#MathJax-Span-59.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-57.msubsup style="padding-left: 0.285em;"}[∗]{#05.html#MathJax-Span-60 .mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-62.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[0]{#05.html#MathJax-Span-63.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.273em; height: 0px;"}]{#05.html#MathJax-Span-61.msubsup style="padding-left: 0.238em;"}[+]{#05.html#MathJax-Span-64 .mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-66.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[1]{#05.html#MathJax-Span-67.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-65.msubsup style="padding-left: 0.238em;"}[∗]{#05.html#MathJax-Span-68 .mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-70.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[1]{#05.html#MathJax-Span-71.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.273em; height: 0px;"}]{#05.html#MathJax-Span-69.msubsup style="padding-left: 0.238em;"}[+]{#05.html#MathJax-Span-72 .mostyle="font-family: MathJax_Main;"}]{#05.html#MathJax-Span-52.mrow}[]{style="display: inline-block; width: 0px; height: 2.355em;"}]{style="position: absolute; clip: rect(1.508em, 1013.23em, 2.685em, -999.998em); top: -2.351em; left: 0em;"}]{style="display: inline-block; position: relative; width: 13.273em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.291em; border-left: 0px solid; width: 0px; height: 1.179em;"}]{#05.html#MathJax-Span-51.mathstyle="width: 16.614em; display: inline-block;"}``{=html}[$W \cdot X = W_{0} \ast X_{0} + W_{1} \ast X_{1} +$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-3-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W·X=W0∗X0+W1∗X1+"role="presentation"}$$\]{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[[[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-76.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[2]{#05.html#MathJax-Span-77.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-75.msubsup}[∗]{#05.html#MathJax-Span-78 .mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-80.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[2]{#05.html#MathJax-Span-81.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.273em; height: 0px;"}]{#05.html#MathJax-Span-79.msubsup style="padding-left: 0.238em;"}[+]{#05.html#MathJax-Span-82 .mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[...]{#05.html#MathJax-Span-83.mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[+]{#05.html#MathJax-Span-84.mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-86.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[15]{#05.html#MathJax-Span-89.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-88.mrow}]{#05.html#MathJax-Span-87.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.744em; height: 0px;"}]{#05.html#MathJax-Span-85.msubsup style="padding-left: 0.238em;"}[∗]{#05.html#MathJax-Span-90 .mostyle="font-family: MathJax_Main; padding-left: 0.238em;"}[X[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.049em;"}]{#05.html#MathJax-Span-92.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1000.85em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[15]{#05.html#MathJax-Span-95.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-94.mrow}]{#05.html#MathJax-Span-93.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.849em;"}]{style="display: inline-block; position: relative; width: 1.602em; height: 0px;"}]{#05.html#MathJax-Span-91.msubsup style="padding-left: 0.238em;"}]{#05.html#MathJax-Span-74.mrow}[]{style="display: inline-block; width: 0px; height: 2.355em;"}]{style="position: absolute; clip: rect(1.508em, 1011.63em, 2.685em, -999.998em); top: -2.351em; left: 0em;"}]{style="display: inline-block; position: relative; width: 11.626em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.291em; border-left: 0px solid; width: 0px; height: 1.179em;"}]{#05.html#MathJax-Span-73.mathstyle="width: 14.544em; display: inline-block;"}``{=html}[$W_{2} \ast X_{2} + \ldots + W_{15} \ast X_{15}$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-4-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W2∗X2+…+W15∗X15"role="presentation"}$$。这些式子由 16 个乘法和 1个连加组成。如果你自己一个人用笔来算的话，需要一步一步算 16 次乘法和 15次加法。如果这个时候我们把这个人物分配给 4 个人，同时去算]{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[[[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-99.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[0]{#05.html#MathJax-Span-100.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-98.msubsup}[～]{style="font-family: STIXGeneral, \"Arial Unicode MS\", serif; font-size: 80%; font-style: normal; font-weight: normal;"}]{#05.html#MathJax-Span-103.mo}]{#05.html#MathJax-Span-102 .mrow}]{#05.html#MathJax-Span-101.texatom}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-105.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[3]{#05.html#MathJax-Span-106.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-104.msubsup}]{#05.html#MathJax-Span-97.mrow}[]{style="display: inline-block; width: 0px; height: 2.308em;"}]{style="position: absolute; clip: rect(1.367em, 1003.53em, 2.638em, -999.998em); top: -2.304em; left: 0em;"}]{style="display: inline-block; position: relative; width: 3.532em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.291em; border-left: 0px solid; width: 0px; height: 1.356em;"}]{#05.html#MathJax-Span-96.mathstyle="width: 4.426em; display: inline-block;"}``{=html}[$W_{0}～W_{3}$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-5-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W0～W3"role="presentation"}$$, []{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[[[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-110.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[4]{#05.html#MathJax-Span-111.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-109.msubsup}[～]{style="font-family: STIXGeneral, \"Arial Unicode MS\", serif; font-size: 80%; font-style: normal; font-weight: normal;"}]{#05.html#MathJax-Span-114.mo}]{#05.html#MathJax-Span-113 .mrow}]{#05.html#MathJax-Span-112.texatom}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-116.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[7]{#05.html#MathJax-Span-117.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-115.msubsup}]{#05.html#MathJax-Span-108.mrow}[]{style="display: inline-block; width: 0px; height: 2.308em;"}]{style="position: absolute; clip: rect(1.367em, 1003.53em, 2.638em, -999.998em); top: -2.304em; left: 0em;"}]{style="display: inline-block; position: relative; width: 3.532em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.291em; border-left: 0px solid; width: 0px; height: 1.356em;"}]{#05.html#MathJax-Span-107.mathstyle="width: 4.426em; display: inline-block;"}``{=html}[$W_{4}～W_{7}$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-6-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W4～W7"role="presentation"}$$, []{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[[[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-121.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[[8]{#05.html#MathJax-Span-122.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.367em; height: 0px;"}]{#05.html#MathJax-Span-120.msubsup}[～]{style="font-family: STIXGeneral, \"Arial Unicode MS\", serif; font-size: 80%; font-style: normal; font-weight: normal;"}]{#05.html#MathJax-Span-125.mo}]{#05.html#MathJax-Span-124 .mrow}]{#05.html#MathJax-Span-123.texatom}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-127.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[11]{#05.html#MathJax-Span-130.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-129.mrow}]{#05.html#MathJax-Span-128.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.744em; height: 0px;"}]{#05.html#MathJax-Span-126.msubsup}]{#05.html#MathJax-Span-119.mrow}[]{style="display: inline-block; width: 0px; height: 2.308em;"}]{style="position: absolute; clip: rect(1.367em, 1003.91em, 2.638em, -999.998em); top: -2.304em; left: 0em;"}]{style="display: inline-block; position: relative; width: 3.908em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.291em; border-left: 0px solid; width: 0px; height: 1.356em;"}]{#05.html#MathJax-Span-118.mathstyle="width: 4.896em; display: inline-block;"}``{=html}[$W_{8}～W_{11}$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-7-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W8～W11"role="presentation"}$$, []{.MathJax_Previewstyle="color: inherit; display: none;"}[``{=html}[[[[[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-134.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[12]{#05.html#MathJax-Span-137.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-136.mrow}]{#05.html#MathJax-Span-135.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.744em; height: 0px;"}]{#05.html#MathJax-Span-133.msubsup}[～]{style="font-family: STIXGeneral, \"Arial Unicode MS\", serif; font-size: 80%; font-style: normal; font-weight: normal;"}]{#05.html#MathJax-Span-140.mo}]{#05.html#MathJax-Span-139 .mrow}]{#05.html#MathJax-Span-138.texatom}[W[]{style="display: inline-block; overflow: hidden; height: 1px; width: 0.096em;"}]{#05.html#MathJax-Span-142.mistyle="font-family: MathJax_Math-italic;"}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; clip: rect(3.155em, 1001.04em, 4.144em, -999.998em); top: -3.998em; left: 0em;"}[15]{#05.html#MathJax-Span-145.mnstyle="font-size: 70.7%; font-family: MathJax_Main;"}]{#05.html#MathJax-Span-144.mrow}]{#05.html#MathJax-Span-143.texatom}[]{style="display: inline-block; width: 0px; height: 4.002em;"}]{style="position: absolute; top: -3.856em; left: 0.944em;"}]{style="display: inline-block; position: relative; width: 1.744em; height: 0px;"}]{#05.html#MathJax-Span-141.msubsup}]{#05.html#MathJax-Span-132.mrow}[]{style="display: inline-block; width: 0px; height: 2.308em;"}]{style="position: absolute; clip: rect(1.367em, 1004.28em, 2.638em, -999.998em); top: -2.304em; left: 0em;"}]{style="display: inline-block; position: relative; width: 4.285em; height: 0px; font-size: 125%;"}[]{style="display: inline-block; overflow: hidden; vertical-align: -0.291em; border-left: 0px solid; width: 0px; height: 1.356em;"}]{#05.html#MathJax-Span-131.mathstyle="width: 5.367em; display: inline-block;"}``{=html}[$W_{12}～W_{15}$]{.MJX_Assistive_MathMLrole="presentation"}]{#05.html#MathJax-Element-8-Frame .MathJaxtabindex="0" style="position: relative;"mathml="W12～W15"role="presentation"}$$这样四个部分的结果，再由一个人进行汇总，需要的时间就会缩短。![](Images/c1d9dc4f8bc21c7bf277121861e9a4ad.png){savepage-src="https://static001.geekbang.org/resource/image/64/9d/64d6957ecaa696edcf79dc1d5511269d.jpeg"}但是，并不是所有问题，都可以通过并行提高性能来解决。如果想要使用这种思想，需要满足这样几个条件。第一，需要进行的计算，本身可以分解成几个可以并行的任务。好比上面的乘法和加法计算，几个人可以同时进行，不会影响最后的结果。第二，需要能够分解好问题，并确保几个人的结果能够汇总到一起。第三，在"汇总"这个阶段，是没有办法并行进行的，还是得顺序执行，一步一步来。这就引出了我们在进行性能优化中，常常用到的一个经验定律，**阿姆达尔定律**（Amdahl'sLaw）。这个定律说的就是，对于一个程序进行优化之后，处理器并行运算之后效率提升的情况。具体可以用这样一个公式来表示：```{=html}```优化后的执行时间 = 受优化影响的执行时间 / 加速倍数 + 不受影响的执行时间```{=html}```在刚刚的向量点积例子里，4个人同时计算向量的一小段点积，就是通过并行提高了这部分的计算性能。但是，这4个人的计算结果，最终还是要在一个人那里进行汇总相加。这部分汇总相加的时间，是不能通过并行来优化的，也就是上面的公式里面**不受影响的执行时间**这一部分。比如上面的各个向量的一小段的点积，需要 100ns，加法需要 20ns，总共需要120ns。这里通过并行 4 个 CPU 有了 4 倍的加速度。那么最终优化后，就有了100/4+20=45ns。即使我们增加更多的并行度来提供加速倍数，比如有 100 个CPU，整个时间也需要 100/100+20=21ns。![](Images/d60de9f39123770a8da106ffaf4555bc.png){savepage-src="https://static001.geekbang.org/resource/image/f1/e5/f1d05ec439e6377803df741bc07b09e5.jpeg"}
## 总结延伸我们可以看到，无论是简单地通过提升主频，还是增加更多的 CPU核心数量，通过并行来提升性能，都会遇到相应的瓶颈。仅仅简单地通过"堆硬件"的方式，在今天已经不能很好地满足我们对于程序性能的期望了。于是，工程师们需要从其他方面开始下功夫了。在"摩尔定律"和"并行计算"之外，在整个计算机组成层面，还有这样几个原则性的性能提升方法。1.**加速大概率事件**。最典型的就是，过去几年流行的深度学习，整个计算过程中，99%都是向量和矩阵计算，于是，工程师们通过用 GPU 替代CPU，大幅度提升了深度学习的模型训练过程。本来一个 CPU需要跑几小时甚至几天的程序，GPU 只需要几分钟就好了。Google 更是不满足于GPU 的性能，进一步地推出了 TPU。后面的文章，我也会为你讲解 GPU 和 TPU的基本构造和原理。2.**通过流水线提高性能**。现代的工厂里的生产线叫"流水线"。我们可以把装配iPhone这样的任务拆分成一个个细分的任务，让每个人都只需要处理一道工序，最大化整个工厂的生产效率。类似的，我们的CPU 其实就是一个"运算工厂"。我们把 CPU指令执行的过程进行拆分，细化运行，也是现代 CPU在主频没有办法提升那么多的情况下，性能仍然可以得到提升的重要原因之一。我们在后面也会讲到，现代CPU里是如何通过流水线来提升性能的，以及反面的，过长的流水线会带来什么新的功耗和效率上的负面影响。3.**通过预测提高性能**。通过预先猜测下一步该干什么，而不是等上一步运行的结果，提前进行运算，也是让程序跑得更快一点的办法。典型的例子就是在一个循环访问数组的时候，凭经验，你也会猜到下一步我们会访问数组的下一项。后面要讲的"分支和冒险"、"局部性原理"这些CPU和存储系统设计方法，其实都是在利用我们对于未来的"预测"，提前进行相应的操作，来提升我们的程序性能。好了，到这里，我们讲完了计算机组成原理这门课的"前情提要"。一方面，整个组成乃至体系结构，都是基于冯·诺依曼架构组成的软硬件一体的解决方案。另一方面，你需要明白的就是，这里面的方方面面的设计和考虑，除了体系结构层面的抽象和通用性之外，核心需要考虑的是"性能"问题。接下来，我们就要开始深入组成原理，从一个程序的运行讲起，开始我们的"机器指令"之旅。