   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
   !                                                               !
!                                                               !
   .                                                               .
.                                                               .
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Control Type |    Length     |            Value              |
|  Control Type |    Length     |            Value              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
   !                                                               !
!                                                               !
   .                                                               .
.                                                               .
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Control Types
Control Types
0: Reserved
0: Reserved
1: Echo Request
1: Echo Request
2: Echo Reply
2: Echo Reply
3: Resend
3: Resend
4: Start File
4: Start File
5: End File
5: End File
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Control Message: Echo Request
Control Message: Echo Request
Message:
Message:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      1        |       2       |     Seq       |    Payload    |
|      1        |       2       |     Seq       |    Payload    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Control Message: Echo Reply
Control Message: Echo Reply
Message:
Message:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      2        |       2       |     Seq       |    Payload    |
|      2        |       2       |     Seq       |    Payload    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Control Message: Resend
Control Message: Resend
Message:
Message:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      3        |       2       |     Requested Seq Number      |
|      3        |       2       |     Requested Seq Number      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Control Message: Start File
Control Message: Start File
Message:
Message:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |       4       |      Len      |     File ID     |             |
|       4       |      Len      |     File ID     |             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+             |
   |                            Filename                           |
|                            Filename                           |
   !                                                               !
!                                                               !
   .                                                               .
.                                                               .
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Control Message: End File
Control Message: End File
Message:
Message:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |       5       |       1       |     File ID     |
|       5       |       1       |     File ID     |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Message Type: Chat Data
Message Type: Chat Data
Message Body:
Message Body:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          Chat Data                            |
|                          Chat Data                            |
   !                                                               !
!                                                               !
   .                                                               .
.                                                               .
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Message Type: File Data
Message Type: File Data
Message Body:
Message Body:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     File ID     |                 File Data                   |
|     File ID     |                 File Data                   |
   +-+-+-+-+-+-+-+-+-+                                             |
+-+-+-+-+-+-+-+-+-+                                             |
   !                                                               !
!                                                               !
   .                                                               .
.                                                               .
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Message Type: Shell Data
Message Type: Shell Data
Message Body:
Message Body:
    0                   1                   2                   3
0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          Shell Data                           |
|                          Shell Data                           |
   !                                                               !
!                                                               !
   .                                                               .
.                                                               .
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Functional Subsystems
Functional Subsystems
The parts that make it go.
The parts that make it go.
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Encryption System
Encryption System
Light-weight, pseudo-encryption (XOR)
Light-weight, pseudo-encryption (XOR)
Could be replaced with real crypto if no impact on 
Could be replaced with real crypto if no impact on 
RTP stream latency
RTP stream latency
XOR pad is a SHA1 hash of a shared secret
XOR pad is a SHA1 hash of a shared secret
XOR operation is begun at an offset into the hash
XOR operation is begun at an offset into the hash
keyhash:
keyhash:
sha1(shared-secret)
sha1(shared-secret)
keyhash_offset
keyhash_offset
hashword( keyhash, RTP_Seq, RTP_TS ) % 20
hashword( keyhash, RTP_Seq, RTP_TS ) % 20
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Embedding System
Embedding System
Currently supports G.711
Currently supports G.711
Use common LSB embedding method
Use common LSB embedding method
Properties of the RTP packet determine a 
Properties of the RTP packet determine a 
total available size for embedding
total available size for embedding
Available:
Available:
RTPPayloadSize / (wordsize * 8)
RTPPayloadSize / (wordsize * 8)
PayloadSize:
PayloadSize:
Available - MessageHeaderLen
Available - MessageHeaderLen
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Extracting System
Extracting System
A reverse of the Embedding function
A reverse of the Embedding function
Then a pass through the crypto function
Then a pass through the crypto function
Verification of the ID field checksum
Verification of the ID field checksum
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Outbound Data Polling 
Outbound Data Polling 
System
System
Linked list of file descriptors that may have 
Linked list of file descriptors that may have 
data waiting to go out:
data waiting to go out:
RAW message interface
RAW message interface
Control message interface
Control message interface
Chat data
Chat data
Input for Remote Shell service
Input for Remote Shell service
Output from Local Shell service (if enabled)
Output from Local Shell service (if enabled)
Individual File transfer data
Individual File transfer data
...
...
Prioritized in the above order
Prioritized in the above order
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Message Caching System
Message Caching System
All inbound and outbound messages are 
All inbound and outbound messages are 
cached
cached
If the remote app requests a resend, it is 
If the remote app requests a resend, it is 
read from the cache and written to the 
read from the cache and written to the 
RAW message interface
RAW message interface
If the local app receives future messages, 
If the local app receives future messages, 
they are available in the cache once the 
they are available in the cache once the 
correct expected message is received
correct expected message is received
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Challenges Met
Challenges Met
How SteganRTP addresses the 
How SteganRTP addresses the 
Problems and Challenges 
Problems and Challenges 
identified earlier
identified earlier
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Unreliable Transport
Unreliable Transport
Request and identification of resent 
Request and identification of resent 
messages
messages
Re-ordering out of order messages
Re-ordering out of order messages
Identifies un-requested, replayed 
Identifies un-requested, replayed 
messages to provide replay protection 
messages to provide replay protection 
(bonus!)
(bonus!)
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Cover-Medium Size Limitations
Cover-Medium Size Limitations
Plenty of RTP packets being sent per 
Plenty of RTP packets being sent per 
second
second
User data can be spread over multiple 
User data can be spread over multiple 
messages and packets and then 
messages and packets and then 
reassembled
reassembled
An achieved throughput of 1000 bytes per 
An achieved throughput of 1000 bytes per 
second is functional for my purposes
second is functional for my purposes
(not adequate for transferring your 
(not adequate for transferring your 
massive pr0n collection)
massive pr0n collection)
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Latency
Latency
RTP packets can be “skipped” and sent 
RTP packets can be “skipped” and sent 
along unmodified
along unmodified
Fast pseudo-cryptography (XOR!) is used 
Fast pseudo-cryptography (XOR!) is used 
rather than full cryptography
rather than full cryptography
Crypto only needs to provide obfuscation 
Crypto only needs to provide obfuscation 
entropy prior to embedding the individual 
entropy prior to embedding the individual 
bits, not protect the data
bits, not protect the data
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
RTP Streams
RTP Streams
libfindrtp for identification
libfindrtp for identification
libipq for tracking and hooking packets
libipq for tracking and hooking packets
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Audio Codec Switching
Audio Codec Switching
Embedding parameters are derived from 
Embedding parameters are derived from 
RTP packet properties
RTP packet properties
Each RTP packet is processed individually
Each RTP packet is processed individually
If an audio codec isn’t supported, the 
If an audio codec isn’t supported, the 
packet is passed unmodified
packet is passed unmodified
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Live Demo!
Live Demo!
Or, I)ruid likes to tempt fate...
Or, I)ruid likes to tempt fate...
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Demo Scenario
Demo Scenario
Endpoint A
SteganRTP A
RTP
SteganRTP B
RTP
RTP
RTP
Endpoint B
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Demo Virtualized Environment
Demo Virtualized Environment
`
Slackware Linux 11
Asterisk Server
`
Win XP Host OS
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Conclusions
Conclusions
Met all of my initial design goals
Met all of my initial design goals
Met most of the identified challenges
Met most of the identified challenges
Compressed audio
Compressed audio
Media Gateway interference
Media Gateway interference
VoIP deployments should use SRTP
VoIP deployments should use SRTP
Prevents the MITM scenario
Prevents the MITM scenario
Prevents the endpoint scenario in some cases
Prevents the endpoint scenario in some cases
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Future Work
Future Work
Improve G.711 codec’s embedding algorithm
Improve G.711 codec’s embedding algorithm
Silence/Voice detection
Silence/Voice detection
Create embedding algorithms for additional audio 
Create embedding algorithms for additional audio 
Codecs
Codecs
Create embedding algorithms for video Codecs
Create embedding algorithms for video Codecs
Use real crypto instead of XOR
Use real crypto instead of XOR
Support for fragmenting larger messages across 
Support for fragmenting larger messages across 
multiple RTP packets
multiple RTP packets
Expand Shell access functionality into a services 
Expand Shell access functionality into a services 
framework
framework
White paper detailing research and implementation
White paper detailing research and implementation
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Source Code
Source Code
SteganRTP
SteganRTP
http://sourceforge.net/projects/steganrtp/
http://sourceforge.net/projects/steganrtp/
libfindrtp
libfindrtp
http://sourceforge.net/projects/libfindrtp/
http://sourceforge.net/projects/libfindrtp/
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
Q & A
Q & A
© 2007 Computer Academic Underground
© 2007 Computer Academic Underground
References
References
SteganRTP
SteganRTP
http://sourceforge.net/projects/steganrtp/
http://sourceforge.net/projects/steganrtp/
libfindrtp
libfindrtp
http://sourceforge.net/projects/libfindrtp/
http://sourceforge.net/projects/libfindrtp/
Steganography Tools List
Steganography Tools List
http://www.jjtc.com/mwiki/index.php?title=Main_Page
http://www.jjtc.com/mwiki/index.php?title=Main_Page
RTP Specification
RTP Specification
http://www.ietf.org/rfc/rfc1889.txt
http://www.ietf.org/rfc/rfc1889.txt
RTP Parameters (Type/Codec values list)
RTP Parameters (Type/Codec values list)
http://www.iana.org/assignments/rtp-parameters
http://www.iana.org/assignments/rtp-parameters