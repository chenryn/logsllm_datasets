DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
1 / 40
DNSSECTION
Hadrien Barral 
Rémi Géraud-Stewart 
Amaury Barral
David Naccache
École normale supérieure @ PSL University / QPSI @ Qualcomm Technologies Inc.
What is this about
■ An e-mail privacy breach in the largest French cloud provider
■ The ﬁrst practical attack based on DNSSEC zone walking
■ A cautionary tale about hash functions
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
2 / 40
Why this matters
■ DNS is everywhere, tons of potentially interesting data
■ Zone walking has never been demonstrated in the wild before
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
3 / 40
Who we are
■ Hadrien Barral
Ecole Normale Supérieure / PSL University
■ Rémi Géraud-Stewart, Ph.D,
ENS/PSL, QPSI @ Qualcomm
■ This is our second Defcon talk!
Done in collaboration with Amaury Barral and David Naccache.
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
4 / 40
1. Who’s behind
skytalks-vidz.com?
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
5 / 40
DNS 101
DNS: Domain Name System
■ Naming system for remote resources
■ Distributed database system (NOT a blockchain ffs)
■ Contains Resource Records (RR) and domain names
■ Resolver: ﬁgures out the translation of a domain name into an IP address
■ Zones: subtrees maintained by different people
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
6 / 40
Registrars and domain services 101
Scenario: you want to create a new website:
■ Buy a computer
■ Pay for Internet access
■ Pay someone to design a fancy website running on your server
■ Pay a registrar to get the domain name you want
■ Pay someone to run DNS servers that connect the domain name to your server’s IP
■ Pay someone to maintain all of this
All-in-one: cloud hosting!
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
7 / 40
OVHcloud 101
OVHcloud
■ Largest French cloud provider (2nd in Europe)
■ They also sell domains
■ And e-mail redirects with that
(and they host Wikileaks since 2010, just fyi)
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
8 / 40
E-mail redirects at OVHcloud
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
9 / 40
From: PI:EMAIL →
To: PI:EMAIL →
E-mail redirects at OVHcloud
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
9 / 40
E-mail redirects at OVHcloud
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
9 / 40
What harm can we do?
■ Assume we access the redirection database...
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
10 / 40
What harm can we do?
■ Assume we access the redirection database...
■ Loads of client information: names, e-mails, billing,...
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
10 / 40
What harm can we do?
■ Assume we access the redirection database...
■ Loads of client information: names, e-mails, billing,...
A few ideas pop to mind:
■ Spam?
■ Password dumps?
■ Targeted attacks?
■ Find weak hosts/email providers?
■ Ammo for social engineering?
■ Blackmail?
■ Phishing?
■ Lawsuits?
■ Business recon?
■ ...
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
10 / 40
Sudo bruteforce
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
11 / 40
Sudo bruteforce
■ Get a list of OVHcloud-handled domains
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
11 / 40
Sudo bruteforce
■ Get a list of OVHcloud-handled domains
■ Get a sublist of interesting domains and DNS query them
( ♥ commoncrawl.org)
▶ Works ﬁne for .fr, .ovh, less so for .com...
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
11 / 40
Sudo bruteforce
■ Get a list of OVHcloud-handled domains
■ Get a sublist of interesting domains and DNS query them
( ♥ commoncrawl.org)
▶ Works ﬁne for .fr, .ovh, less so for .com...
■ Get redirection records for public emails (bear with us)
▶ aka the emails we found on the webpage
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
11 / 40
Sudo bruteforce
■ Get a list of OVHcloud-handled domains
■ Get a sublist of interesting domains and DNS query them
( ♥ commoncrawl.org)
▶ Works ﬁne for .fr, .ovh, less so for .com...
■ Get redirection records for public emails (bear with us)
▶ aka the emails we found on the webpage
■ Bruteforce associated DNS queries for usual e-mail addresses
{abuse, admin, contact}@example.com
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
11 / 40
How to do this in practice
■ Do not get banned by the DNS server
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
12 / 40
How to do this in practice
■ Do not get banned by the DNS server: Rate limiting → several IPs
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
12 / 40
How to do this in practice
■ Do not get banned by the DNS server: Rate limiting → several IPs
■ Low-tech version
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
12 / 40
How to do this in practice
■ Do not get banned by the DNS server: Rate limiting → several IPs
■ Low-tech version: bash + dig + ﬁlesystem
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
12 / 40
How to do this in practice
■ Do not get banned by the DNS server: Rate limiting → several IPs
■ Low-tech version: bash + dig + ﬁlesystem
while read DOMAIN; do
dig mx "${DOMAIN}"
> "./save/mx/${DOMAIN}"
dig
"at.${DOMAIN}" > "./save/at/${DOMAIN}"
done  "./save/mx/${DOMAIN}"
dig
"at.${DOMAIN}" > "./save/at/${DOMAIN}"
done < "domain_list.txt"
while read DOMAIN; do
for NAME in "abuse" "admin" "contact" ...; do
EMAIL="${NAME}.at.${DOMAIN}"
dig TXT "${EMAIL}" +noall +answer | grep "${EMAIL}.*IN.TXT"
done
done < "interesting_domain_list.txt"
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
12 / 40
Demo
DEMO
DEMO
DEMO
DEMO
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
13 / 40
Lookie here
■ It works!
■ Considering 14.000 potentially vulnerable domains (mostly .fr TLD),
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
14 / 40
Lookie here
■ It works!
■ Considering 14.000 potentially vulnerable domains (mostly .fr TLD),
■ We found about 15.000 email redirects
■ With about 10.000 unique target emails
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
14 / 40
Lookie here
■ It works!
■ Considering 14.000 potentially vulnerable domains (mostly .fr TLD),
■ We found about 15.000 email redirects
■ With about 10.000 unique target emails
Using public emails, we found (private) redirection emails!
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
14 / 40
Lookie here
■ It works!
■ Considering 14.000 potentially vulnerable domains (mostly .fr TLD),
■ We found about 15.000 email redirects
■ With about 10.000 unique target emails
Using public emails, we found (private) redirection emails!
What are we NOT seeing?
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
14 / 40
2. Stepping up:
DNSSECTION
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
15 / 40
DNSSEC 101
■ DNSSEC could be the topic of an entire talk
■ Here’s what you should know:
▶ DNS is famously insecure, needed some ﬁx
▶ DNSSEC supported by every “good” modern device
▶ Root of trust + tree derivation scheme
▶ Meant to ensure authenticity
(not privacy)
■ Sometimes require lockpicking skills
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
16 / 40
Recent DNSSEC key rollover session
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
17 / 40
Source: @joao_damas
Demo
DNSViz
DEMO
DEMO
DEMO
DEMO
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
18 / 40
The issue with negative responses
■ Authenticating "example.com is at 1.2.3.4" is easy
■ Authenticating the absence of "bad.example.com" record is ... trickier
■ We obviously cannot put every negative possibility in the zone!
■ NSEC to the rescue
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
19 / 40
Authenticated denial of existence
■ Principle:
▶ NSEC signs "there is no domain between
apple.example.com
and
carrot.example.com"
▶ Therefore
bad.example.com
does not exist
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
20 / 40
Zonewalking with NSEC
■ But now we can enumerate all records!
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
21 / 40
Zonewalking with NSEC
■ But now we can enumerate all records!
▶ Pick a random name: "fgfrd.example.com"
▶ Query the DNS server.
Answer: nothing between "carrot.example.com" and "good.example.com"
▶ Repeat with "gooda.example.com"
▶ We do this until we loop, at which point we’re done!
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
21 / 40
NSEC is already obsolete
■ Did you think that’s what we were about to do?... guess again!
■ NSEC zone walking does not work in the real world anymore!
■ Indeed, NSEC is almost not used anymore (sad reacts only)
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
22 / 40
Zone walking with NSEC3
■ NSEC3 (RFC6781, RFC5155)
"The ﬁrst motivation to deploy NSEC3 – prevention of zone enumeration (...)"
■ NSEC3 in a nutshell: SHA1k(domain)
(almost universally)
▶ Intuition: same as NSEC but with hashed values instead of real names
▶ Should hide the contents (assuming you can’t do anything with hash values)
▶ We can still dump the SHA1 hash itself, so ZW still kinda works
■ NSEC3 is what is deployed in the real world currently!
So let’s attack that :)
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
23 / 40
Zone walking with NSEC3
Assumption: reversing even partially the hash is difﬁcult.
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
24 / 40
Zone walking with NSEC3
Assumption: reversing even partially the hash is difﬁcult.
(*Laughs in Bitcoin mining farm*)
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
24 / 40
Zone walking with NSEC3
Assumption: reversing even partially the hash is difﬁcult.
(*Laughs in Bitcoin mining farm*)
Reality: There are multiple off-the-shelf tools to crack NSEC3 hashes.
To the best of our knowledge, never been used to dig valuable data
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
24 / 40
Demo
nsec3walker
DEMO
DEMO
DEMO
DEMO
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
25 / 40
Sudo GPU bruteforce
Bringing out the GPU rig!!!
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
26 / 40
Sudo GPU bruteforce
Bringing out the GPU rig!!!
JK, we "only" have this:
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
27 / 40
Demo
hashcat
DEMO
DEMO
DEMO
DEMO
DNSSECTION @ DEF CON 28 SAFE MODE
6 Aug 2020
28 / 40
Results