  ARM-­‐based	
  shellcodes	
  too?	
q Can	
  we	
  idenDfy	
  something	
  new?	
Static  features 
• Correct	
  disassembly	
  for	
  chain	
  of	
  at	
  least	
  K	
  instruc;ons; 
• Command	
  of	
  CPU	
  mode	
  switching	
  (BX	
  Rm); 
• Exis;ng	
  of	
  Get-­‐UsePC	
  code; 
• Number	
  of	
  speciﬁc	
  paJerns	
  (	
  arguments	
  ini;aliza;ons,	
  func;on	
  calls	
  )	
  exceeds	
some	
  threshold; 
• Arguments	
  inializa;on	
  strictly	
  before	
  system	
  calls	
  ; 
• Write	
  to	
  memory	
  and	
  load	
  from	
  memory	
  cycles; 
• Return	
  address	
  in	
  some	
  range	
  of	
  values; 
• Last	
  instruc;on	
  in	
  the	
  chain	
  is	
  (BL,	
  BLX),	
  or	
  system	
  call	
  (svc); 
• Operands	
  of	
  self-­‐iden?ﬁed	
  code	
  and	
  code	
  with	
  indirect	
  jumps	
  must	
  to	
  be	
ini?alized. 
Correct  disassembly  for  a  chain  of  at  least  K 
instructions	
Non	
  a	
  shellcode	
Shellcode!	
@SadieSv	
  @_IvanPetrov_	
Non	
  a	
  shellcode	
Non	
  a	
  shellcode	
Non	
  a	
  shellcode	
Command  of  CPU  mode  switching  (	
  BX 	
  Rm )	
CPU	
  mode	
  switch	
Shellcode	
  in	
  Thumb	
mode	
Arguments	
  for	
  system	
  call	
PC	
  register	
Jump	
  with	
  exchange	
Thumb	
  mode	
  number	
@SadieSv	
  @_IvanPetrov_	
Existing  of	
  Get-­‐UsePC  code	
PC	
  register	
Encrypted	
  shellcode	
Get	
  PC	
Use	
  PC	
Get	
  PC	
  into	
  LR	
  register	
  (r14)	
Use	
  PC	
@SadieSv	
  @_IvanPetrov_	
Arguments  initializations  for  system calls  
and  library  calls	
Arguments	
System	
  call	
  number	
System	
  call	
_socket	
  #281	
_connect	
  #283	
@SadieSv	
  @_IvanPetrov_	
Write  to  memory  and  load   
from  memory  cycles	
Encrypted	
  shellcode	
Read	
  from	
  memory	
Store	
  to	
  memory	
Cycle	
  counter	
Address	
  of	
  encrypted	
payload	
Main	
  cycle	
@SadieSv	
  @_IvanPetrov_	
Return  address  in  some  range  of  values	
Return	
address	
Vulnerable	
buﬀer	
Stack	
Payload	
Shellcode	
0xbeﬀedbc	
0xbeﬀedbc	
0xbeﬀedbc	
0xbeﬀedbc	
0xbeﬀedbc	
0xbeﬀedbc	
Return	
  address	
zone	
@SadieSv	
  @_IvanPetrov_	
Dynamic  features 
•  The	
  number	
  of	
  payload	
  reads	
  exceeds	
  threshold; 
•  The	
  number	
  of	
  unique	
  writes	
  into	
  memory	
  exceeds	
threshold; 
•  Control	
  ﬂow	
  is	
  redirected	
  to	
  “just	
  wriJen”	
  address	
loca;on	
  at	
  least	
  once; 
•  Number	
  of	
  executed	
  wx-­‐instruc;ons	
  exceeds	
  threshold; 
•  Condi;onal-­‐based	
  signatures.	
@SadieSv	
  @_IvanPetrov_	
Read  and  write  to  memory	
Decryptor	
Encrypted	
  payload	
N	
  Unique	
  reads	
  and	
  writes	
@SadieSv	
  @_IvanPetrov_	
Control  flow  switch	
Decryptor	
Decrypted	
  payload	
Control	
  ﬂow	
@SadieSv	
  @_IvanPetrov_	
Conditional - based  signatures	
Z	
  =	
  0	
  &	
  C	
  =	
  0	
Z	
  =	
  1	
  &	
  C	
  =	
  0	
ADDEQS	
  r0,	
  r1	
ADDEQS	
  r0,	
  r1	
AL	
  block	
(every	
  ﬂag)	
AL	
  block	
(every	
  ﬂag)	
CS	
  block	
(	
  С	
  ==	
  1)	
Z	
  =	
  0	
С	
  =	
  1	
CS	
  block	
(	
  С	
  ==	
  1)	
NE	
  block	
(	
  Z	
  ==	
  0)	
NE	
  block	
(	
  Z	
  ==	
  0)	
ADDCCS	
  r3,	
  r4	
ADDCCS	
  r3,	
  r4	
Z	
  =	
  1	
С	
  =	
  0	
If	
  EQ	
  block	
  was	
executed,	
  then	
Z	
  =	
  1,	
  else	
  Z	
  =	
  0	
NE	
  block	
(	
  Z	
  ==	
  0)	
NE	
  block	
(	
  Z	
  ==	
  0)	
@SadieSv	
  @_IvanPetrov_	
What’s  next 
Make	
   another	
   module	
   to	
shellcode	
   detec?on	
   tool	
   -­‐	
Demorpheus	
@SadieSv	
  @_IvanPetrov_	
Demorpheus  -  idea 
@SadieSv	
  @_IvanPetrov_	
µ1: K1, K2
µ7: K3
µ3: K4
µ8: K5,
µ4: K2
µ2: K4
µ6: K3, K5
µ5: K4, K5
decision making module
data ﬂow
K4
K5
K4, K5
K1
K2
K3
K4
K5
K2
K3
level 1
level 2
level 3
complexity
Hybrid  classifier 
Disassembling 
CFG reconstruction 
IFG reconstruction 
…	
Disassembled 
Flow 
CFG	
IFG	
…	
Feature 1 
detector 
Feature К 
detector 
…	
@SadieSv	
  @_IvanPetrov_	
Experiments 
• Shellcodes; 
• Legi?mate	
  binaries; 
• Random	
  data; 
• Mul?media. 
@SadieSv	
  @_IvanPetrov_	
Experiments	
@SadieSv	
  @_IvanPetrov_	
Datasets	
FN	
FP	
Shellcodes	
0	
n/a	
LegiDmate	
  binaries	
n/a	
1.1	
MulDmedia	
n/a	
0.33	
Random	
  data	
n/a	
0.27	
@SadieSv	
  @_IvanPetrov_	
Dataset	
Throughput	
Shellcodes	
56.5	
  Mb/s	
LegiDmate	
  binaries	
64.8	
  Mb/s	
MulDmedia	
93.8	
  Mb/s	
Random	
  data	
99.5	
  Mb/s	
2	
  GHZ	
  Intel	
  Core	
  i7	
Experiments	
Your   questions? 
@SadieSv	
  @_IvanPetrov_