### 3. 服务器虚拟化

#### 3.2 服务器虚拟化的层次

根据虚拟化层实现方式的不同，服务器虚拟化可以分为寄居虚拟化和裸机虚拟化两种类型。

##### 裸机虚拟化

在裸机虚拟化架构中，不需要先在服务器上安装操作系统，而是直接将虚拟机监控器（VMM）或Hypervisor安装在服务器硬件设备中。这种架构中的Hypervisor本质上也可以看作是一个操作系统，负责管理和分配底层硬件资源给多个虚拟机。

###### 架构图
```
客户
客户
客户
虚拟机
虚拟机
虚拟机
Hypervisor
物理机（底层硬件）
```
**图7-2：裸机虚拟化架构**

河南中医药大学 / 阮晓龙 / 13938213680 / [http://cloud.xg.hactcm.edu.cn](http://cloud.xg.hactcm.edu.cn) / [http://www.51xueweb.cn](http://www.51xueweb.cn)

---

Hypervisor实现了从虚拟资源到物理资源的映射。当虚拟机中的操作系统通过特权指令访问关键系统资源时，Hypervisor会接管其请求并进行相应的模拟处理。为了使这种机制有效运行，每条特权指令的执行都需要产生“自陷”，以便Hypervisor能够捕获该指令，并由VMM模拟执行相应的指令。这样可以实现不同虚拟机之间的上下文保护与切换，确保各个客户虚拟系统的有效隔离。

由于x86体系结构的处理器并不是完全支持虚拟化的，某些x86特权指令在低特权级上下文中执行时不能产生自陷，导致VMM无法直接捕获这些特权指令。目前针对这一问题的主要解决方案包括基于动态指令转换或硬件辅助的完全虚拟化技术和半虚拟化技术。

---

##### 完全虚拟化

完全虚拟化是对真实物理服务器的完整模拟，在上层操作系统看来，虚拟机与物理平台没有区别。操作系统察觉不到是否运行在虚拟平台之上，也无需进行任何更改。Hypervisor作为中间层软件，在虚拟服务器和底层硬件之间建立一个抽象层，捕获CPU指令并为指令访问硬件控制器和外设充当中介。尽管完全虚拟化提供了高度的兼容性和灵活性，但性能方面不如裸机，因为Hypervisor需要占用一些资源，给处理器带来额外开销。

###### 架构图
```
Apps
Apps
GuestOS
GuestOS
Mgmt
Hypervisor(VMM)
Hardware
```
**图7-3：完全虚拟化架构**

河南中医药大学 / 阮晓龙 / 13938213680 / [http://cloud.xg.hactcm.edu.cn](http://cloud.xg.hactcm.edu.cn) / [http://www.51xueweb.cn](http://www.51xueweb.cn)

---

##### 半虚拟化

半虚拟化技术有时也被称为准虚拟化，通过修改操作系统代码使特权指令产生自陷。最初由Denali和Xen项目在x86体系架构上实现。通过对客户操作系统的内核进行适当的修改，使其能够在VMM的管理下尽可能地直接访问本地硬件平台。半虚拟化技术通过改动客户操作系统，让它以为自己运行在虚拟环境下，能够与Hypervisor协同工作，降低了由于虚拟化而产生的系统性能损失。半虚拟化技术的优点是性能高，经过半虚拟化处理的服务器可与Hypervisor协同工作，响应能力几乎不亚于未经过虚拟化处理的服务器。

###### 架构图
```
Apps
Apps
Modified
Modified
GuestOS
GuestOS
Mgmt
Hypervisor(VMM)
Hardware
```
**图7-4：半虚拟化架构**

河南中医药大学 / 阮晓龙 / 13938213680 / [http://cloud.xg.hactcm.edu.cn](http://cloud.xg.hactcm.edu.cn) / [http://www.51xueweb.cn](http://www.51xueweb.cn)

---

#### 3.3 服务器虚拟化的底层实现

##### CPU虚拟化

CPU虚拟化技术将物理CPU抽象成虚拟CPU，任意时刻，一个物理CPU只能运行一个虚拟CPU指令。每个客户操作系统可以使用一个或多个虚拟CPU，在各个操作系统之间，虚拟CPU的运行相互隔离且互不影响。CPU虚拟化需要解决两个关键问题：虚拟CPU的正确运行和调度。虚拟CPU的正确运行要保证虚拟机指令正确运行，各个虚拟机之间不能相互影响。现有的实现技术包括模拟执行和监控执行。调度问题是指VMM决定当前哪个虚拟CPU在物理CPU上运行，要保证隔离性、公平性和性能。

##### 内存虚拟化

内存虚拟化技术将物理内存统一管理，包装成多个虚拟的物理内存提供给若干虚拟机使用，每个虚拟机拥有各自独立的内存空间。内存虚拟化也是虚拟机管理器的主要功能之一。其实现思路主要是分块共享，核心思想是内存页面的写时复制（CopyOnWrite）。虚拟机管理器完成并维护物理机内存和虚拟机所使用的内存的映射关系。虚拟内存的管理包括三种地址：机器地址、物理地址和虚拟地址。一般来说，虚拟机与虚拟机、虚拟机与虚拟机管理器之间的内存要相互隔离。

##### I/O设备虚拟化

I/O设备虚拟化技术将真实的设备统一管理起来，包装成多个虚拟设备给若干个虚拟机使用，响应每个虚拟机的设备访问请求和I/O请求。I/O设备虚拟化同样是由VMM进行管理的，主要有全虚拟化、半虚拟化和软件模拟三种实现思路。目前主流的设备与I/O虚拟化大多是通过软件方式来实现的。

---

#### 3.4 虚拟机迁移

虚拟机迁移的目标是在目标宿主机上能够将虚拟机运行状态恢复到其在迁移之前相同的状态，以便能够继续完成应用程序的任务。虚拟机迁移对云计算具有重要意义，可以保证云端的负载均衡，增强系统错误容忍度，当发生故障时也能有效恢复。

从是否有计划的角度来看，虚拟机迁移包括：

- 计划迁移
- 针对突发事件的迁移

从虚拟机迁移的源与目的地角度来看，虚拟机迁移包括：

- 虚拟机到虚拟机的迁移（Virtual-to-Virtual, V2V）
- 虚拟机到物理机的迁移（Virtual-to-Physical, V2P）

##### 虚拟机动态迁移

在云计算中，虚拟机到虚拟机的迁移是关注的重点。实时迁移（Live Migration）是一种保持虚拟机运行的同时，将其从一个计算机迁移到另一个计算机，并在目标计算机恢复运行的技术。动态实时迁移对云计算至关重要，原因如下：

- 云计算中心的物理服务器负载经常处于动态变化中。当一台物理服务器负载过大时，如用户请求高峰期，管理员可以将其上的虚拟机迁移到其他服务器，以达到负载平衡。
- 云计算中心的物理服务器有时候需要定期进行升级维护。当升级维护服务器时，管理员可以将其上的虚拟机迁移到其他服务器，等升级维护完成后，再迁移回来。

河南中医药大学 / 阮晓龙 / 13938213680 / [http://cloud.xg.hactcm.edu.cn](http://cloud.xg.hactcm.edu.cn) / [http://www.51xueweb.cn](http://www.51xueweb.cn)