26
3.服务器虚拟化
3.2服务器虚拟化的层次
根据虚拟化层实现方式的不同，将服务器虚拟化分为寄居虚拟化和裸
机虚拟化两种分类方法
裸机虚拟化
■裸机虚拟化架构不需要在服务器上先安装操作系统，而是直接将VMM安
装在服务器硬件设备中，本质上该架构中的VMM也可以认为是一个操作
功能）。
客户
客户
客户
虚拟机
虚拟机
虚拟机
Hypervisor
物理机（底层硬件）
图7-2裸机虚拟化架构
河南中医药大学／阮晓龙/13938213680/http://c
eb.cn
---
## Page 27
27
3.服务器虚拟化
3.2服务器虚拟化的层次
根据虚拟化层实现方式的不同，将服务器虚拟化分为寄居虚拟化和裸
机虚拟化两种分类方法。
裸机虚拟化
Hypervisor实现从虚拟资源到物理资源的映射。
当虚拟机中的操作系统通过特权指令访问关键系统资源时，Hypervisor将接管
其请求，并进行相应的模拟处理。
口为了使这种机制能够有效地运行，每条特权指令的执行都需要产生"自陷"，以
便Hypervisor能够捕获该指令，从而使VMM能够模拟执行相应的指令。
Hypervisor模拟特权指令的执行，并将处理结果返回给指定的客户虚拟系
统，实现了不同虚拟机的运行上下文保护与切换，能够虚拟出多个硬件系
统，保证了各个客户虚拟系统的有效隔离。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 28
28
3.服务器虚拟化
3.2服务器虚拟化的层次
根据虚拟化层实现方式的不同，将服务器虚拟化分为寄居虚拟化和裸
机虚拟化两种分类方法。
裸机虚拟化
■由于x86体系结构的处理器并不是完全支持虚拟化的，某些x86特权指令在
低特权级上下文执行时，不能产生自陷，导致VMM无法直接捕获特权指
令。
目前针对这一问题的解决方案主要有基于动态指令转换或硬件辅助的完全
虚拟化技术和半虚拟化技术两种
河南中医药大学 ／阮晓龙 /13938213680 /http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 29
29
3.服务器虚拟化
3.2服务器虚拟化的层次
口完全虚拟化
■完全虚拟化是对真实物理服务器的完整模拟，在上层操作系统看来，虚拟
机与物理平台没有区别，操作系统察觉不到是否运行在虚拟平台之上，也
无须进行任何更改。
用Hypervisor中间层软件，在虚拟服务器和底层硬件之间建立一个抽象层。
Hypervisor可以捕获CPU指令，为指令访问硬件控制器和外设充当中介。
器上，而它们不知道自己运行在虚拟化环境下。但是性能方面不如裸机，
毕竟Hypervisor需要占用一些资源，给处理器带来额外开销。
在完全虚拟化的环境下，Hypervisor运行在裸硬件上，充当主机操作系统
而由Hypervisor管理的虚拟服务器运行客户端操作系统(GuestOS)
河南中医药大学／阮晓龙／ 13938213680 /http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 30
30
3.服务器虚拟化
3.2服务器虚拟化的层次
完全虚拟化
Apps
Apps
GuestOs
GuestOs
Mgmt
Hypervisor(VMM)
Hardware
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn / http://www.51xueweb.cn
---
## Page 31
31
3.服务器虚拟化
3.2服务器虚拟化的层次
口半虚拟化
■半虚拟化技术有时也被称为准虚拟化，其通过修改操作系统代码使特权指
令产生自陷。半虚拟化技术最初由Denali和Xen项目在x86体系架构上实现
通过对客户操作系统的内核进行适当的修改，使其能够在√MM的管理下
尽可能地直接访问本地硬件平台。
半虚拟化技术通过改动客户操作系统，让它以为自己运行在虚拟环境下，
能够与Hypervisor协同工作，降低了由于虚拟化而产生的系统性能损失。
·半虚拟化技术的优点是性能高，经过半虚拟化处理的服务器可与
Hypervisor协同工作，其响应能力几乎不亚于未经过虚拟化处理的服务器。
它的客户操作系统(GuestOS)集成了虚拟化方面的代码。该方法无需重新
编译或引起陷阱，因为操作系统自身能够与虚拟进程进行很好的协作。
河南中医药大学／阮晓龙/ 13938213680 /http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 32
32
3.服务器虚拟化
3.2服务器虚拟化的层次
半虚拟化
Apps
Apps
Modified
Modified
GuestOS
GuestOS
Mgmt
Hypervisor(VMM)
Hardware
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn / http://www.51xueweb.cn
---
## Page 33
33
3.服务器虚拟化
3.3服务器虚拟化的底层实现
口CPU虚拟化
■CPU虚拟化技术把物理CPU抽象成虚拟CPU，任意时刻，一个物理CPU只
能运行一个虚拟CPU指令。每个客户操作系统可以使用一个或多个虚拟
CPU，在各个操作系统之间，虚拟CPU的运行相互隔离且互不影响。
1CPU虚拟化需要解决正确运行和调度两个关键问题。
口虚拟CPU的正确运行是要保证虚拟机指令正确运行，即操作系统要在虚拟化环
境中执行特权指令功能，而且各个虚拟机之间不能相互影响。现有的实现技术
包括模拟执行和监控执行。
调度问题是指VMM决定当前哪个虚拟CPU在物理CPU上运行，要保证隔离性
公平性和性能。
河南中医药大学 ／阮晓龙 ／ 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 34
34
3.服务器虚拟化
3.3服务器虚拟化的底层实现
口内存虚拟化
内存虚拟化技术把物理内存统一管理，包装成多个虚拟的物理内存提供给
若干虚拟机使用，每个虚拟机拥有各自独立的内存空间。内存虚拟化也是
虚拟机管理器的主要功能之一。
1内存虚拟化的实现思路主要是分块共享，内存共享的核心思想是内存页面
的写时复制（CopyOnWrite）。虚拟机管理器完成并维护物理机内存和
虚拟机所使用的内存的映射关系。
与真实的物理机相比，虚拟内存的管理包括3种地址：机器地址、物理地
址和虚拟地址。一般来说，虚拟机与虚拟机、虚拟机与虚拟机管理器之间
的内存要相互隔离。
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 35
35
3.服务器虚拟化
3.3服务器虚拟化的底层实现
口IO设备虚拟化
拟化要困难和复杂。I/O设备虚拟化技术把真实的设备统一管理起来，包
装成多个虚拟设备给若干个虚拟机使用，响应每个虚拟机的设备访问请求
和I/O请求。
1I/O设备虚拟化同样是由√MM进行管理的，主要有全虚拟化、半虚拟化和
软件模拟三种实现思路。目前主流的设备与I/O虚拟化大多是通过软件方
式来实现的。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 36
36
3.服务器虚拟化
3.4虚拟机迁移
标宿主机上能够将虚拟机运行状态恢复到其在迁移之前相同的状态
以便能够继续完成应用程序的任务。
Hypervisor
Hypervisor
硬件
硬件
服务器1
服务器2
图7-3虚拟机迁移示意图
河南中医药大学 ／阮晓龙 /13938213680/http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 37
37
3.服务器虚拟化
3.4虚拟机迁移
虚拟机迁移对云计算具有重大的意义，可以保证云端的负载均衡，增
强系统错误容忍度，当发生故障时，也能有效恢复。
口从是否有计划的角度看，虚拟机迁移包括有：
■计划迁移
■针对突发事件的迁移
口从虚拟机迁移的源与目的地角度来看，虚拟机迁移包括：
■虚拟机到虚拟机的迁移(Virtual-to-Virtual，V2V)
虚拟机到物理机的迁移（Virtual-to-Physical，V2P)
河南中医药大学 ／阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 38
38
3.服务器虚拟化
3.4虚拟机迁移
虚拟机动态迁移
■在云计算中，虚拟机到虚拟机的迁移是关注的重点。
■实时迁移（Live Migration），就是保持虚拟机运行的同时，把它从一个计
算机迁移到另一个计算机，并在目的计算机恢复运行的技术。
■动态实时迁移对云计算来讲至关重要，这是因为：
第一，云计算中心的物理服务器负载经常处于动态变化中，当一台物理服务器
负载过大时，比如，某时出现一个用户请求高峰期，若此刻不可能提供额外的
物理服务器，管理员可以将其上面的虚拟机迁移到其他服务器，达到负载平衡;
口第二，云计算中心的物理服务器有时候需要定期进行升级维护，当升级维护服
务器时，管理员可以将其上面的虚拟机迁移到其他服务器，等升级维护完成之