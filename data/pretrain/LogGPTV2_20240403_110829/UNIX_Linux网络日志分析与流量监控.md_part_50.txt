## Page 291
器列表。
yourfile 中。cert、key、ca这三个根证书文件与 SSL有关。Server参数可以设置连接的服务
式命名的文件中，其中mmdd表示月、日，hhmm表示时、分。
用 HEX、BASE64或者 ASCII 编码。下面是XML 输出插件的配置示例：
http://www.cert.org/kb/snortxml获得更为详细的信息。
式保存到本地文件并输出到一个中心数据库，或者发送到CERT 进行处理。读者可以从
CSV输出，建立多个输出文件。
记录数据。它的配置非常容易，只要在 snort.conf文件中加入以下的配置行：
268UNIX/Linux网络日志分析与流量监控
这一配置行使Snort把产生的日志信息输出到以/var/log/snort/snortxml-mmdd@hmm格
这一配置行使 Snort 用 HTTPS 协议把产生的输出送到远程服务器 your.server.org 的文件
XML 输出插件支持 HTTP、HTTPS 和 IAP（Intrusion Alert Protocol)。输出数据可以使
Snort有个很重要的输出插件
4）XML格式
可以使用默认配置选项default，而无需指定任何域。在配置文件中，可以使用复合
PeterCaswell为Snort编写了CSV输出插件。通过这个插件，Snort可以使用CSV格式
我们取消 snort.conf文件中以下几行的注释，可以使Snort向系统发送数据：
下面是一个输出示例：
ca=ca.crt server-srv_list.lst
然后，这个输出插件就会向/your/filenames文件输出如下格式的信息：
3）CSV文件
输出格式如下：
05/10-10:02:31.953089,INFOCQAccess,TCP,10.1.1.1,10.2.2.5
output:you/flenametmestamp,msgrot,rc,
output xml:log,file=/var/log/snort/snortxml
output alert _syslog: LOG_AUTH LOG_ALERT
RPCportmaplisting
10.1.1.1
fxpo
May 1000:03:38 xxxxxx snort:INFO-ICQAccess[Classification:
—XML插件，它可以把日志数据或者报警信息以XML 格
TV
P
---
## Page 292
串特征的方法才能发现，而字符串的传送只有在TCP三次握手后才进行。虽然放在防火墙以外
封锁这种攻击，但探针可能检测不到这种攻击，这是因为许多攻击类型只有通过匹配相应字符
域。这种安排使探针可以看见所有来自外网的攻击，然而如果攻击类型是TCP攻击，防火墙能
10.2.3Snort 探针部署
描和端口扫描。
10.2.2典型攻击日志举例
的文件中：
下面显示了几个简单的报警。其中包括三个常见的攻击：ISUnicode攻击，SYN/Fin扫
可以使用 Snort或者Tepdump工具从这个文件中读取信息。
在 snort.conf 文件中加入下面的配置行，就能把日志以 tcpdump二进制格式记录到指定
探针通常放置在防火墙界面之外的DMZ中。DMZ是ISP和最外端防火墙界面之间的区
1）放在防火墙外
一般说来，探针放在防火墙附近比较好，可以有以下3种选择。
3） [**] spp_portscan: PORTSCAN DETECTED from 192.168.150.25 (THRESHOLD 3
2）[**]IDS198/SYNFINScan[**]
5）Tcpdump格式
 05/13-01:38:45.254726 192.168.150.3:53 -> 192.168.150.1:53
across 1 hosts:TCP(0),UDP(5)[**]
[**] spp_portscan: portscan status from 192.168.150.25: 5 connections
05/15-19:36:39.561360
connections exceeded in 4 seconds) [**]
TCPTTL:23TOS:0x0ID:39426IpLen:20DgmLen:40
TCPTTL:249TOS:0x0ID:22898IpLen:20DgmLen:1022DF
05/07-11:10:40.910903192.168.150.11:3607->192.168.150.2:80
output log_tcpdump:snort_dump.log
len="64"id="32085"tl="239"csum="47239">
第10章Snort系统部署及应用案例269
11on2
元.01
P.C.0
---
## Page 293
机网络界面都监听。
2）var EXTERNAL_NETany用来设定对外网络监听界面，默认的 any代表任何一个本
络界面都监听。火星
还包括日志和通过审查功能。在snort.conf中有两个用来指定监听网络的参数：来
NET 被定义为（default=any）或SHOME_NET 被定义为（default=any），只要数据大小
下面几条规则，括号外面的部分是规则头部，里面的部分是规则选项。
口；规则选项则包含报警信息、内容选项等，其中规则选项是规则匹配的核心匹配部分。如
成。规则头包含所有匹配的行为动作、协议类型、源IP 及端口、数据包方向、目标IP 及端
10.3.1Snort规则分析
使用方法如下：
Snort 的日志文件，然后输出成 HTML 格式。Snort-sort 这个工具可以帮助 Snort 进行排序，
tcpshow 等工具可以帮助我们分析 snort 日志。另外 Snortsnarf 是一个 perl脚本，可以处理
10.2.4日志分析工具
击，可以检测到由于设置有问题而无法通过防火墙的内部系统，这对系统管理员非常有利。
的攻击，使探针不用将大部分注意力分散在这类攻击上。
设置失误。将探针放在防火墙内的最大理由就是设置良好的防火墙能够阻止大部分幼稚脚本
少误报警。如果本应该被防火墙封锁的攻击渗透进来，探针就可以检测到或能发现防火墙的
火墙内的系统会比外面的系统健壮一些；如果探针在防火墙内会少一些干扰，从而有可能减
的探针有无法检测到的攻击，但是这个位置仍然是对攻击进行检测的最佳位置。
270UNIX/Linux网络日志分析与流量监控
Snort规则是基于文本的，它通常存在于/etc/snort/rules目录中，所有触发规则的行为都
10.3Snort 规则详解
1）var HOME_NET any 用来指定本机网络监听界面，默认的 any 代表任何一个本机网
对于 Snort 而言没有自动化的分析工具，不过前面讲过的 BT 工具光盘中有 tcpreplay，
Snort规则库中的每条规则都对应一种入侵方式，每条规则由规则头和规则体选项组
如果攻击者发现探针，就可能对其进行攻击，从而降低攻击者的行动被审计的概率，防
这段代码看上去很复杂，它的含义是：如果检测到ICMP包，不论是来自SEXTERNAL
reference:arachnids,162; classtype:attempted-recon; sid:469;rev:3;)
下面是一个简单的Snort规则：
这样做有如下优点：无须猜测是否有攻击渗透过防火墙，可以检测来自内部和外部的攻
2）放在防火墙内
3）防火墙内外分别设置
alert icmp SEXTERNAL _NET any -> SHOME _NET any (msg:"ICMP PING NMAP",; dsize:O; itype:8;
正
专
---
## Page 294
到检测机制中。如果载入有语法错误的规则，那么可能导致不可预料的后果。这个规则会被
10.3.2编写Snort规则
中所有的测试选项必须为真，这样规则才能产生正确的响应并调用程序执行相应的动作。
片段均定义了一个选项和相应的选项值。规则体中的可选项为：
于指定该规则的源和目的IP 地址。Snort 规则体部分由若干个被分号隔开的片段组成，每个
与该规则匹配。
则中的所有规则选项都匹配时，才能判定该数据包为有害数据包，只要有一条不符合，就不
为有害数据包；而每条规则中的各个规则选项是“与”的关系，只有当一个数据包与一条夫
则库中，每条规则之间是“或”的关系，只要一个数据包与单条规则匹配，就判定该数据包
各个规则选项之间用分号分隔，而规则选项名和规则选项内容之间由冒号分隔。在庞大的规
杂入侵攻击时非常有用。
将像log动作一样记录数据包。
2）alert动作：alert 将按照已配置的格式记录包进行报警。这是常用的动作，需要灵活
会被记录下来。Snort有5种动作类型：
目前Snort 支持对 ICMP、TCP、IP 和UDP 这4种协议的分析。规则头的后面部分则用
如上面这条规则，每条规则包含多个规则选项，如msg、flow、content、reference 等。
3）dynamic动作：它保持为一种潜伏状态，直到activate 类型的规则将其触发，之后它
（1）pass 动作：pass 将忽略当前的包，后续被捕获的包将被继续分析。
在编写 Snort 规则之前强调一点：
1.基础
这些选项可通过任意组合来检测和分类所关注的包。规则选项使用逻辑与来处理，规则
（14）msg：设置当一个包产生事件时要发送的信息。
（13）depth：用于内容选项的修改，设置搜索开始位置的字节数值。
（12）offset：用于内容选项的修改，在包负载中设置偏移量以开始内容搜索。
（11）dsize：匹配包负载的尺寸。
（10）logto：将匹配的包记录到指定文件名字。
(2）flags：测试指定的 TCP 标识。
（1）content：寻找一个指定模式下的包负载。
5）activate 动作：当被规则触发时产生报警，并启动相关 dynamic 类型规则，在检测复
4）log动作：将按照已配置的格式记录数据包。
（9）seq：记录一个TCP头顺序的值。
（8）a
7）i
（6）
5）
（4）
(3）t
ack：查找一个已经确认的TCP头。
id：测试指定的IP头的值。
minfrag：设定IP分片大小的起始值。
icode：ICMP代码域匹配。
itype：ICMP类型域匹配
ttl:检查IP头的TTL域。
一定要注意语法。违反语法的Snort规则将不能载入
第10章Snort系统部署及应用案例271
lr
15，，和这些标记。举个例子，当你创建规则发现
特征编写规则来防御这类攻击。因为只要向Web应用程序插入XSS 脚本，就会用到
序。大多数 XSS 攻击需要向特定页面请求中插入脚本标记。我们可以使用 XSS 攻击的这个
击可以用于盗窃认证所用的cookies、访问部分受限制的Web 站点或是攻击其他Web 应用程
就可以在网页中嵌入脚本，这些脚本会使Web应用程序不能按照预期的计划执行。XSS 攻
创建的网页中时，跨站脚本（XSS）攻击就发生了。如果不能正确地检查用户输入，攻击者
该规则，并阻止别人进行洪泛攻击，则可以加入flow选项，如下：
一个现存规则的新版本。下面进一步提炼该规则，若你希望仅在已建立的 TCP 会话中应用
sigs 邮件列表中后缀为“.htr chunked”的编码规则，这条规则如下：
应用在这台服务器上，而不是用在每台Web服务器上。最初，你可能想到修改Snort-
已有的规则进行修改。假设有一台 IIS 服务器，你想修改与 IIS 相关的规则，使它们仅
大量的正常流量触发，造成一系列误报。
272UNIX/Linux网络日志分析与流量监控
现在只可以在192.168.1.1的Web服务器上使用该规则。注意，rev关键字增1表明这是
对于刚接触Snort规则编写的新手而言，编写Snort 规则最简单的一种方法就是对
当客户在请求中嵌入标记时会发生 XSS。如果服务器发送请求响应的
当你正确地标识公司所有的Web服务器和它们所运行的端口时，XSS规则仅当被发送到
“WEB-MISCXSS attempt";)
XSS攻击会触发这个规则，但其他的正常流量也会触发这个规则。例如，假设某人发送
在前面的基础上我们讨论一个比较复杂的情况。当网站允许恶意代码被插入到一个动态
2.提高
运行该规则后，误报会迅速减少。
为了使它仅应用于IS服务器上，应改为：
店
---
## Page 296
记录源端口号小于或等于1024，目的端口号大于或等于500的TCP数据包。乘
记录来自任何端口，其目的端口号小于或者等于6000的TCP数据包。
记录来自任何端口，其目的端口号在1到1024之间的UDP数据包。
有几种方式来使用范围操作符达到不同的目的。
如：111(Portmapper)、23（Telnet)、80(Http)等。使用范围操作符“：”可以指定端口号范围。
围，以及使用非操作定义。any 表示任意合法的端口号；静态端口号表示单个的端口号，例
地址，匹配所有的IP地址。否定操作符使用！表示。
或避开这个规则。这就需要应用content选项来指定不区分大小写。
是一个包含JavaScript标记的正常HTTP会话。
端发起的会话有效。一个XSS攻击只会发生在正向传输的流量上，而反向上的流量则可能
向。通过应用特定的 flow 选项“to_server”和“established”，该规则仅对从客户端向服务器
个XSS攻击特征进一步提炼该规则：是政
标记时，它可能是正确的流量（即 JavaScript 请求），而不是一个 XSS 攻击。你可以使用这
现在这条规则已经可以识别XSS攻击了，但攻击者可以通过将脚本标记修改为
在Snort规则中，可以有几种方式来指定端口号，包括：any、静态端口号定义、端口范
在规则中，还可以使用否定操作符对IP地址进行操作。它能告诉Snort，排除列出的IP
3.端口号
例如：
由于Snort不支持对主机名的解析，所以 IP地址只能使用数字或CIDR的表现形式。
注意：
为了使该规则更完美，还需给它赋予一个高优先级。
经过优化的规则使用了flow选项，该选项使用Snort的TCP重建特征来鉴别流量的方
attempt';flow:to_server,established;content:";nocase;priority:1;)
log tcp any any ->192.168.150.0/24 :600。
alert tcp !192.168.1.0/24 any -> 192.168.150.0/24 11(content:"00 01 86 a5]";'msg:"extermal mountd access")
 alert tcp $ EXTERNAL NET any ->S HTTP_ SERVERS $ HTTP PORTS (msg:"WEB-MISC XSS
alert tcp$EXTERNAL_NET any->$HTTP_SERVERS$HTTP_PORTS(msg:WEB-MISCXSS
第10章Snort系统部署及应用案例273
干基
01
业
V798
---
## Page 297
主机型（HIDS）、网络型（NIDS）和WIDS 等三类。HIDS 的检测目标主要是本地用户的系
及BT客户端之间交互的BT协议，然后发出报警信息。
包，它们之间是与的关系。
而BT客户端和种子列表开始交互数据包中包含如下特征内容：
析可以看出BT客户端向服务器请求种子列表的GET报文中一般包含如下特征内容：
在iptables防火墙中添加固定的规则，限制BT下载。我们可以尝试手工在Snort 中添加规
的应答包。下面看个简单的例子。2T2TH
过程，并且保证嗅探器能够抓到双方通信信息，然后捕获从攻击端发出的数据包和被攻击端
对网络安全不利。如果想为某种特殊的攻击编写Snort 规则，则需要在测试环境中重现攻击
对话的双向数据传输进行记录：
址/端口之间双向的数据传输进行记录/分析，例如Telnet对话。下面的规则表示对一个Telnet
地址和目的端口。此外，还有一个双向操作符“”，它使Snort 对这条规则中，两个IP 地
274UNIX/Linux 网络日志分析与流量监控
10.4基于OSSIM平台的WIDS系统
则，来阻断BT下载。
4.方向操作符
入侵检测系统（IntrusionDetectionSystem，简称IDS）根据检测手段的不同，可以分为
.BT下载比较消耗网络资源，但BT下载过程中，BT种子列表是动态变化的，很难通过
有关Snort更多文档可以参考http://www.snort.org/docs/。）
分析过程：首先通过抓包工具比如Wireshark，抓取BT下载的数据流作为样本。经过分
方向操作符“->”表示数据包的流向。它左边是数据包的源地址和源端口，右边是目的
此规则用来匹配包含"|13[BitTorrentprotocol"的客户端向服务器发送请求种子列表的报文