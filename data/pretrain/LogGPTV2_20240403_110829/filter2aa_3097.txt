#BHUSA @BlackHatEvents
AAD Joined Machines - The New 
Lateral Movement
Mor Rubin
#BHUSA @BlackHatEvents
Who am I?
• Mor Rubin (@rubin_mor)
• Senior security researcher at Microsoft
• Interested in networking, cloud and On-Prem attacks, mitigations and detections
#BHUSA @BlackHatEvents
Agenda
• Introduction to key terms 
• NegoEx protocol
• Attacks
• Demo
• Hunting
• Takeaways
#BHUSA @BlackHatEvents
Technical background
#BHUSA @BlackHatEvents
Azure AD Joined device
Ref: Dirk-Jan Mollema “I’m in your cloud… reading everyone’s email”
Troopers ’19 https://dirkjanm.io/assets/raw/TR19-Im%20in%20your%20cloud.pdf
#BHUSA @BlackHatEvents
AADJ Authenticated Connections
AADJ
AADJ
PRT
P2P Certificate
#BHUSA @BlackHatEvents
Primary Refresh Token - PRT
• A JSON Web Token (JWT) for the user and the device it was issued for
• Can be compared to Ticket Granting Ticket (TGT)
• Can be used to authenticate to any application
#BHUSA @BlackHatEvents
P2P Azure AD certificate
• Certificate that is used for peer-to-peer authentication between Azure AD joined devices
• Issued by Azure AD upon request and valid only for 1 hour
#BHUSA @BlackHatEvents
Kerberos PKINIT
Kerberos extension allows certificate authentication over Kerberos instead of hash (password)
Ref: https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-
kile/b4af186e-b2ff-43f9-b18e-eedb366abf13
#BHUSA @BlackHatEvents
PKU2U
• Based on Kerberos version 5 messages and the Kerberos GSS-API mechanism.
• Implemented as a Security Support Provider (SSP) enables peer-to-peer authentication
• Used for authentication in NegoEx when no KDC exists
#BHUSA @BlackHatEvents
GSSAPI \ SSPI
• SSPI is an API that allows application to add authenticity and privacy layer
• It is applicable to any application that allows 'Windows Authentication'
Ref: https://docs.microsoft.com/en-us/windows-server/security/windows-
authentication/security-support-provider-interface-architecture
#BHUSA @BlackHatEvents
NegoEx protocol
#BHUSA @BlackHatEvents
NegoEx
Client
Server
#BHUSA @BlackHatEvents
Initiator nego
• Contains a random identifies the session
* Similar for the server side in Acceptor nego
#BHUSA @BlackHatEvents
Initiator metadata
Generated by GSS_Query_meta_data() 
* Similar for the server side in Acceptor metadata
#BHUSA @BlackHatEvents
AP_REQUEST
PKU2U part
#BHUSA @BlackHatEvents
CHALLENGE
PKU2U part
#BHUSA @BlackHatEvents
VERIFY
• NegoEx validator
• Checksum all previous messages
#BHUSA @BlackHatEvents
Attacks
#BHUSA @BlackHatEvents
NegoEx Relay
• Data is not shared between computers to find the “real” source
• Authentication process is easily relayed when not signed
* Relaying back to victim does not work
#BHUSA @BlackHatEvents
NegoEx Relay
Init nego, Init metadata
Init nego, Init metadata
Server
Client
Acceptor nego, Acceptor metadata
Acceptor nego, Acceptor metadata
AP_REQUEST
AP_REQUEST
CHALLENGE
CHALLENGE
Verify AP_REQUEST 
(AS_REQ) and generate 
CHALLENGE (AS_REP)
AP_REQUEST, VERIFY
AP_REQUEST, VERIFY
CHALLENGE, VERIFY
CHALLENGE, VERIFY
Verify AP_REQUEST 
(AP_REQ) and generate 
CHALLENGE (AP_REP) and 
NegoEx verify message
Generate AP_REQUEST 
(KRB_AP) from CHALLENGE 
and NegoEx verify
#BHUSA @BlackHatEvents
NegoEx Relay
Init nego, Init metadata
Init nego, Init metadata
Server
Client
Acceptor nego, Acceptor metadata
Acceptor nego, Acceptor metadata
#BHUSA @BlackHatEvents
NegoEx Relay
AP_REQUEST
AP_REQUEST
Server
Client
CHALLENGE
CHALLENGE
Verify AP_REQUEST 
(AS_REQ) and generate 
CHALLENGE (AS_REP)
Attacker can modify 
client’s name
#BHUSA @BlackHatEvents
NegoEx Relay
AP_REQUEST, VERIFY
AP_REQUEST, VERIFY
Server
Client
CHALLENGE, VERIFY
CHALLENGE, VERIFY
Verify AP_REQUEST 
(AP_REQ) and generate 
CHALLENGE (AP_REP) and 
NegoEx verify message
If client name 
modified, another 
auth attempt 
should be made
#BHUSA @BlackHatEvents
NegoEx Relay – Changed client name
Init nego, Init metadata
Init nego, Init metadata
Server
Client
Acceptor nego, Acceptor metadata
Acceptor nego, Acceptor metadata
#BHUSA @BlackHatEvents
NegoEx Relay - Changed client name
AP_REQUEST, VERIFY
AP_REQUEST, VERIFY
Server
Client
CHALLENGE, VERIFY
CHALLENGE, VERIFY
Verify AP_REQUEST 
(AP_REQ) and generate 
CHALLENGE (AP_REP) and 
NegoEx verify message
PKU2U AP request 
#BHUSA @BlackHatEvents
Demo
#BHUSA @BlackHatEvents
PRT To Cert
#BHUSA @BlackHatEvents
PRT To Cert
#BHUSA @BlackHatEvents
Pass the certificate
• Possible by requesting new certificate from PRT or by stealing a 
certificate from the certificate store on computer
#BHUSA @BlackHatEvents
Hunting
#BHUSA @BlackHatEvents
Windows events
Windows event 4624 can be leveraged for hunting of NegoEx logins
#BHUSA @BlackHatEvents
Traffic analysis
Traffic analysis tools like Zeek can parse NegoEx and extract the relevant data
Serial Number
Subject
#BHUSA @BlackHatEvents
Mitigations
• SMB signing
#BHUSA @BlackHatEvents
Tools
• NegoEx relay tool
• Azure AD certificate requestor 
• Authentication tool with Azure AD certificate 
• Wireshark dissector for NegoEx
• Zeek build that dissect NegoEx Kerberos packets
#BHUSA @BlackHatEvents
Takeaways
• Patching is not enough
• Usage of SMB signing is a must
• Hunt hunt hunt
@Rubin_mor
Thank you
Questions?