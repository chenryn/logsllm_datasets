#BHUSA @BlackHatEvents
**AAD Joined Machines - The New Lateral Movement**
**Speaker: Mor Rubin**

#BHUSA @BlackHatEvents
**About the Speaker:**
- **Mor Rubin (@rubin_mor)**
- Senior Security Researcher at Microsoft
- Specializes in networking, cloud, and on-premises attacks, mitigations, and detections

#BHUSA @BlackHatEvents
**Agenda:**
1. Introduction to Key Terms
2. NegoEx Protocol
3. Attack Vectors
4. Demonstration
5. Hunting Techniques
6. Key Takeaways

#BHUSA @BlackHatEvents
**Technical Background:**
- **Azure AD Joined Device:**
  - Reference: Dirk-Jan Mollema, "I’m in your cloud… reading everyone’s email" (Troopers '19)
  - [Link to Paper](https://dirkjanm.io/assets/raw/TR19-Im%20in%20your%20cloud.pdf)

#BHUSA @BlackHatEvents
**AADJ Authenticated Connections:**
- **Primary Refresh Token (PRT):**
  - A JSON Web Token (JWT) for the user and the device it was issued for.
  - Comparable to a Ticket Granting Ticket (TGT).
  - Can be used to authenticate to any application.
- **P2P Azure AD Certificate:**
  - Used for peer-to-peer authentication between Azure AD joined devices.
  - Issued by Azure AD upon request and valid for only 1 hour.

#BHUSA @BlackHatEvents
**Kerberos PKINIT:**
- Kerberos extension that allows certificate authentication over Kerberos instead of password hashes.
- [Reference](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b4af186e-b2ff-43f9-b18e-eedb366abf13)

#BHUSA @BlackHatEvents
**PKU2U:**
- Based on Kerberos version 5 messages and the Kerberos GSS-API mechanism.
- Implemented as a Security Support Provider (SSP) to enable peer-to-peer authentication.
- Used for authentication in NegoEx when no KDC exists.

#BHUSA @BlackHatEvents
**GSSAPI \ SSPI:**
- SSPI is an API that allows applications to add authenticity and privacy layers.
- Applicable to any application that supports "Windows Authentication."
- [Reference](https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/security-support-provider-interface-architecture)

#BHUSA @BlackHatEvents
**NegoEx Protocol:**

#BHUSA @BlackHatEvents
**NegoEx Flow:**
- **Initiator Nego:**
  - Contains a random identifier for the session.
  - Similar for the server side in Acceptor Nego.
- **Initiator Metadata:**
  - Generated by `GSS_Query_meta_data()`.
  - Similar for the server side in Acceptor Metadata.
- **AP_REQUEST:**
  - PKU2U part.
- **CHALLENGE:**
  - PKU2U part.
- **VERIFY:**
  - NegoEx validator.
  - Checksums all previous messages.

#BHUSA @BlackHatEvents
**Attacks:**

#BHUSA @BlackHatEvents
**NegoEx Relay:**
- Data is not shared between computers to find the “real” source.
- Authentication process is easily relayed when not signed.
- Relaying back to the victim does not work.

#BHUSA @BlackHatEvents
**NegoEx Relay Flow:**
- **Client:**
  - Initiates Nego and metadata.
  - Sends AP_REQUEST.
  - Receives CHALLENGE.
  - Verifies AP_REQUEST and generates VERIFY.
- **Server:**
  - Receives Nego and metadata.
  - Sends CHALLENGE.
  - Verifies AP_REQUEST and generates CHALLENGE and NegoEx verify message.
- **Attacker:**
  - Can modify the client’s name.
  - If the client name is modified, another authentication attempt should be made.

#BHUSA @BlackHatEvents
**NegoEx Relay with Modified Client Name:**
- **Client:**
  - Initiates Nego and metadata.
  - Sends AP_REQUEST and VERIFY.
  - Receives CHALLENGE and VERIFY.
- **Server:**
  - Receives Nego and metadata.
  - Sends CHALLENGE and VERIFY.
  - Verifies AP_REQUEST and generates CHALLENGE and NegoEx verify message.
- **Attacker:**
  - Modifies the client’s name.
  - Generates PKU2U AP request.

#BHUSA @BlackHatEvents
**Demo:**
- **PRT to Cert:**
  - Possible by requesting a new certificate from PRT or by stealing a certificate from the certificate store on the computer.

#BHUSA @BlackHatEvents
**Hunting:**

#BHUSA @BlackHatEvents
**Windows Events:**
- Windows Event 4624 can be leveraged for hunting NegoEx logins.

#BHUSA @BlackHatEvents
**Traffic Analysis:**
- Tools like Zeek can parse NegoEx and extract relevant data, including serial numbers and subjects.

#BHUSA @BlackHatEvents
**Mitigations:**
- **SMB Signing:**
  - Essential for securing communications.

#BHUSA @BlackHatEvents
**Tools:**
- **NegoEx Relay Tool:**
- **Azure AD Certificate Requestor:**
- **Authentication Tool with Azure AD Certificate:**
- **Wireshark Dissector for NegoEx:**
- **Zeek Build for NegoEx Kerberos Packets:**

#BHUSA @BlackHatEvents
**Key Takeaways:**
- Patching alone is not sufficient.
- SMB signing is mandatory.
- Continuous hunting is crucial.

@Rubin_mor
Thank you!
Questions?