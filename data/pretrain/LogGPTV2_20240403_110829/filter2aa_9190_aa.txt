---
title: 移动恶意代码分析及威胁情报
date: 2020-01-15 23:45:58
tags: 移动安全
---
# 移动恶意应用分析
![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200115220552.png)
图：背景
## 恶意代码分析背景概述
### 背景
1.全面的移动威胁
2.移动生态环节面临的安全威胁
表面：黑灰产
里面：国家队
3.攻击手段的持续进化
4.恶意色情软件增长趋势
一般不用支付宝、微信，使用第三方
5.地下社工库
- 完成原始数据积累
- 完善的黑产分工协作体系
6.持续扩大的威胁面
7.移动威胁从个人向组织迁移
### 基本概念
1.和产业链高度依存
2.生物学悖论
破坏性越大，传播性越差
3.病毒的生命周期
一般是1～2个月不到
4.国家意志
### 相关术语
- 木马
- 蠕虫
	- 蓝牙蠕虫
- 后门
- 工具
### 命名体系
一般格式为：..
e.g. Worm.Sasser.b
### 趋势
- 恶意代码规模保持稳定增长
- 恶意代码高度产业化
	- 东南亚 
- 移动端成为APT新战场
## 1. 安卓病毒分析
### APK格式介绍
参考前两天
### 恶意行为汇总
### 静态分析
#### 工具
- Smaliviewer
- APKTool
- Dex2jar
- JEB
- IDA
- AndroidKiller
- AndroidGuard # 偏学术性质
#### 方法
可参考绿盟的[手册](http://blog.nsfocus.net/tag/%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E6%89%8B%E5%86%8C/)
- 快读定位法
	- 敏感API搜索
- 对比法
- 代码流程法
	- 从Mainfest开始一步步看 
- 遍历法
	- JEB有重命名功能，一个个功能死磕，一般针对混淆非常严重的代码 
### 动态分析
#### 工具/技术
- Andebug
- IDA
- Frida/XPosed/..
- Wireshark/tcpdump/..
#### 技术
- Smali Hook
- Xposed Hook
	- Tips：忽略系统文件
	- Tips：不要hook资源文件，可能失效
- Substrate native hook
- Frida hook    # 建议使用Frida
### 分析系统（沙盒系统）
- DroidBox
- AndroGuard
- Inspeckage    # 基于xposed
- RMS(antiy)
- cuckoo https://cuckoosandbox.org/
	- 布谷鸟
### 人工分析实践知识
#### 模拟器
#### 数据包
联网请求数据包实例（Wireshark抓包）
寻找情报来源
#### 工具am
用talent模拟短信
#### IDA动静态
一般对
#### 在线系统
- VS
- Sandroid    # 学术项目
- Koodous    # 交流、分享，[链接](https://koodous.com/)
- Janus
## 2. 反病毒引擎
### 引擎结构
1.对象获取：各种资源文件的获取
2.对象检测：各种分析模式、脱壳、解包
3.对象处理：告知与处理
4.病毒库：基于知识积累的数据保障
### 特征库
### 配置
---
### 本地检测技术
#### 基础
应用的基础特征：文件Hash、内嵌文件Hash、证书等
#### 符号
应用内所包含的各类符号特征：配置符号信息、dex符号信息、其他可执行文件符号信息
#### 动态
基于行为的模型检测：行为监控、行为建模
---
### 体系建设
尽可能基于代码、已有的基础，进行拆解，二次分析
---
### AVL引擎本地检测逻辑
#### 大数据
1.降维
基于应用指纹的分类策略
2.实际运用
- 证书随机化特征
- 应用执行文件结构
- 基于图标的色情检测
- 基于文件的组织结构特征
- 基于决策树的行为检测模型
## 3. 移动威胁情报
### 威胁情报的定义
威胁情报是基于证据的知识，包括场景、机制、指标、含义和可操作的建议。 
这些知识是关于现存的、或者是即将出现的针对资产的威胁或危险的，可为主体响应相关威胁或危险提供决策信息。 
决策 —— 情报 —— 信息 —— 数据  
### 威胁情报的体系
- 强烈的外在和内在的面向威胁的知识管理体系方法
- 情报是高度具备驱动力的数据流转和响应驱动体系
#### 面向威胁情报的大数据体系
- 数据采集 —— 数据萃取 —— 数据结构化 —— 归一化设计 —— 数据采集迭代
- 通过邮件和短信进行，在流量出口做检测
![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200115134913.png)
![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200115134943.png)
#### 自动化与人工结合的分析运行体系（情报驱动安全）
1.自动化流水线的检测和判别体系，大大减少人工作业的工作量
2.自动化动态分析
- 典型事件触发
- 行为事件监控 
3.分析组
- 引擎工作引擎
- 基于**归一化**（标签类）数据结构的文件分类器
4.智能分析系统—— 静态 ｜ 动态 ｜ 机器学习 —— 相互补充
#### 威胁情报的困难金字塔
隐晦 —— Incident （最难）
复杂 —— TTP Relation
高对抗 —— TTP/Exploit, Malware
穿透 —— Evil Device(Mobile/IOT)
不可控 —— SDK/Third Parth
方式多样性 —— C2(Network/Other)
符号多样性 —— Symbol
繁琐，低效 —— Hash （最容易）
- 有代码复用
- 对日志分析
#### 小结
1.体系化建设是根本
2.多方位合作（国\*局也要和其他厂商进一步合作）
3.找到适合自己的方式（找到自己的优势）
4.多体系合作
## 4. 恶意代码高级对抗
### 对抗分析工具（不让反编译等）
- Ptrace自身
...
### 对抗用户感知（不让用户知道）
- 隐藏图标
- 透明图标
- 静默下载/安装
- 预装（二次换装比较多）
- 植入知名应用
- 伪装系统应用
- ISP（互联网服务提供商）劫持
- 邮件
- 社工
### 反追踪（不让自己被追踪）
- 利用短链接
- 域名隐私保护
- 伪基站
- 动态DNS
- 盗用他人信息
- 使用云服务
- 入侵无关网站
### 环境对抗
- 沙箱检测
- 条件触发
- 结束杀软
- 动态加载
- ROOT提权（现在较难）
- 杀软检测
### 银弹
能力较弱，需要APT的情况下，购买第三方的情报
代码相同，需要客户侧写
### Application层
- 范围：各种APP
### Framework层
- 范围：各种API
- 案例：各种RAT（间\*谍\*软件）
### Kernel层
- 范围：系统各种驱动
- 案例：hackteam exploit
### 案例：RottlenSys
## 5. 威胁情报与溯源
### 攻击工具持续演变
萌芽期 —— 发展期（加壳）—— 中后期 —— 后移动攻防时代
中后期后面，武器化，漏洞，移动攻击开始武器化、定向化和组织化
### 移动终端已经成为APT的新战场
#### 基本规律
只与目标承载的资产资源和与更重要目标的关联度有关，基本不考虑难易
#### 三个特点
1.对移动应用
2.长期
3 应用高级攻击技术
#### 移动APT攻击
攻击者 ——> 手机终端  攻击对象  
 ![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200115212401.png)
#### 攻击植入方式
1.鱼叉攻击
- 邮件
- 网站
- 短信
2.应用市场
3.论坛
4.应用市场