# 浅论密钥重装攻击KRACK
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
KRACK即为Key Reinstallation Attacks，中文译为密钥重装攻击。是由比利时鲁汶大学信息安全研究人员Mathy
Vanhoef提出的一种针对WPA2的攻击方式。
Mathy Vanhoef
## 时间线
• 2017.5.19 论文被提交
• 2017.6.16 向攻击涉及的供应商发出通告
• 2017.8.28 CERT/CC向所有供应商发出通告
• 2017.10.15 作者在https://www.krackattacks.com公开披露细节，并演示了一个攻击实例
• 2017.11.1 论文在CCS会议报告  
---  
## 灵感的来源
“Ha. I wonder what happens if that function is called twice.”
athy在写另一篇论文时，注意到WiFi标准中一个安装密钥的函数，通常只会被调用一次，他猜想调用两次将会重置相关参数。  
---  
在正式开始介绍之前，为了便于理解，我先给出一些名词。
• 成对临时密钥(Pairwise Transient Key ,PTK)作为会话密钥。
• 成对主密钥 (Pairwise Master Key, PMK)
• 接入端 随机数Anonce
• 客户端随机数Snonce
• 临时密钥(Temporal KEY, TK)
• 预共用密钥(PSK)
同一无线路由器底下的每个用户都使用同一把密钥，区别于[802.1X](https://zh.wikipedia.org/wiki/802.1X)认证服务器来分发不同的密钥给各个终端用户
• 接收计数器(Receive Sequence Counter,RSC)
• 信息完整性校验码(MIC)  
---  
接下来正式开始介绍
## 1 背景知识
###  1.1 WPA的产生
WPA全名为Wi-Fi Protected
Access，有WPA和WPA2两个标准，是一种保护[无线网络](https://zh.wikipedia.org/wiki/%E7%84%A1%E7%B7%9A%E7%B6%B2%E8%B7%AF
"无线网络")安全的系统。它是研究者为了解决在前一代的[有线等效加密](https://zh.wikipedia.org/wiki/%E6%9C%89%E7%B7%9A%E7%AD%89%E6%95%88%E5%8A%A0%E5%AF%86
"有线等效加密")（WEP）系统中找到的几个严重的弱点：
• WEP不是强制使用的，使得许多设施根本就没有启动WEP
•
WEP并不包含[钥匙管理协定](https://zh.wikipedia.org/w/index.php?title=Key_management_protocol&action=edit&redlink=1
"Key management
protocol（页面不存在）")，却在用户间共用一个[秘密钥匙](https://zh.wikipedia.org/w/index.php?title=%E7%A7%98%E5%AF%86%E9%91%B0%E5%8C%99&action=edit&redlink=1
"秘密钥匙（页面不存在）")。
• RC4所用的24比特的IV（初始向量）并没有长到足以担保不会重复  
---  
而产生的。商业联盟 Wi-Fi
Alliance制定了WPA标准，对WPA标准的实际运用检验从[2003年4月](https://zh.wikipedia.org/wiki/2003%E5%B9%B44%E6%9C%88
"2003年4月")开始，并于[2003年11月](https://zh.wikipedia.org/wiki/2003%E5%B9%B411%E6%9C%88
"2003年11月")变成强制性。
###  1.2 WPA与802.11i的关系
由于WEP已被证明不够安全，人们需要更安全的加密标准，但制定802.11i的工作比原先预期的久了很多，在大家越来越关心无线安全的同时，该标准的制定花费了四年才完成。芯片厂商已经迫不及待的需要一种更为安全的算法，并能成功兼容之前的硬件，所以，WPA包含了与WEP兼容的802.11i子集合,实现了[IEEE](https://zh.wikipedia.org/wiki/IEEE
"IEEE") [802.11i](https://zh.wikipedia.org/wiki/802.11i
"802.11i")标准的大部分，先于完整的802.11i推出。在完整的802.11i标准于[2004年6月](https://zh.wikipedia.org/wiki/2004%E5%B9%B46%E6%9C%88
"2004年6月")通过之后，Wi-Fi
Alliance于[2004年9月](https://zh.wikipedia.org/wiki/2004%E5%B9%B46%E6%9C%88
"2004年6月")推出了实现了802.11i强制性元素的WPA2。
###  1.3 WPA2的改进
WEP所使用的CRC（[循环冗余校验](https://zh.wikipedia.org/wiki/%E5%BE%AA%E7%8E%AF%E5%86%97%E4%BD%99%E6%A0%A1%E9%AA%8C
"循环冗余校验")）先天就不安全，在不知道WEP密钥的情况下，要篡改所载数据和对应的CRC是可能的，而WPA使用了名为“Michael”的更安全的[消息认证码](https://zh.wikipedia.org/wiki/%E8%A8%8A%E6%81%AF%E8%AA%8D%E8%AD%89%E7%A2%BC
"消息认证码")（在WPA中叫做[消息完整性查核](https://zh.wikipedia.org/w/index.php?title=%E8%A8%8A%E6%81%AF%E5%AE%8C%E6%95%B4%E6%80%A7%E6%9F%A5%E6%A0%B8&action=edit&redlink=1)，MIC），WPA2采用了计数器模式密码块链消息完整码协议CCMP（Counter
CBC-MAC Protocol），其安全性已被严格地证明了。
WPA仍使用RC4，使用可以动态改变密钥的“临时密钥完整性协议”（Temporal Key Integrity
Protocol，[TKIP](https://zh.wikipedia.org/wiki/TKIP
"TKIP")），以及48位的IV。WPA2中RC4被AES取代。
## 2 攻击原理
###  2.1 四次握手
WPA和WPA2均使用802.11i中定义的四次握手，客户端（Station, STA）和接入点（Access Point,
AP）通过四次握手相互验证和协商名为成对临时密钥（Pairwise Transient Key, PTK）的会话密钥。PTK通过成对主密钥（Pairwise
Master Key,
PMK）、AP随机数ANonce、STA随机数SNonce和双方MAC地址等计算生成，其中PMK由登录密码等双方均已知的信息计算生成。而后续正常数据加密所使用的临时密钥（Temporal
KEY, TK）即派生自PTK。各密钥、参数的关系如下图所示。
图 2-1 四次握手中各密钥、参数关系
图 2-2 四次握手中所用数据报文格式
图 2-3 四次握手过程
消息1,2与攻击关系不大，略过不提，WPA2所遵循的802.11i标准中规定，AP在发起连接时就安装组密钥GTK,客户端接收到消息3将安装PTK和组密钥GTK,发送消息4作为回应，AP收到消息4安装PTK,未收到消息4将重发消息3.
为了完成密钥重装，攻击者需要嗅探、重放四次握手过程中的第3个消息报文，强制重置协议加密使用到的nonce值及重放计数，重安装加密密钥。而会话密钥与双方MAC地址有关，所以，普通的中间人攻击是无法奏效的，需要运用channel-based MitM技术，伪造同名同MAC不同信道热点。
## 3 不同场景的攻击
###  3.1 接受明文重传消息3，不安装全0密钥
攻击者作为中间人，首先放行消息1,2,3，阻塞客户端对消息3的回复消息4。此时客户端安装了PTK,将发送以此PTK加密的数据，nonce为1，攻击者将此数据阻塞。
AP未接收到消息4，将重发消息3，攻击者将其转发给客户端。客户端重装PTK,此时，攻击者将先前拦下的消息4发送给AP，此后发送的加密数据将重用PTK,且nonce被重置为1
nonce重用引发的后果与所采用的数据保密协议密切相关。三种数据保密协议：
•  临时密钥完整性协议TKIP