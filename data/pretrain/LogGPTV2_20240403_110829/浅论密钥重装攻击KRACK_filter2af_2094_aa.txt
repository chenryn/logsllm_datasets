# 密钥重装攻击（KRACK）浅析

##### 译文声明
本文为翻译文章，具体表达及含义请以原文为准。

## 概述
密钥重装攻击（Key Reinstallation Attacks, KRACK）是由比利时鲁汶大学信息安全研究人员Mathy Vanhoef提出的一种针对WPA2协议的攻击方式。这种攻击利用了WPA2四次握手过程中的漏洞，导致密钥重装并可能使加密通信受到威胁。

## 时间线
- 2017年5月19日：论文提交
- 2017年6月16日：向相关供应商发出通告
- 2017年8月28日：CERT/CC向所有供应商发出通告
- 2017年10月15日：作者在[https://www.krackattacks.com](https://www.krackattacks.com)公开披露细节，并演示了一个攻击实例
- 2017年11月1日：论文在CCS会议报告

## 灵感来源
Mathy Vanhoef在撰写另一篇论文时注意到，WiFi标准中一个安装密钥的函数通常只会被调用一次。他猜想如果该函数被调用两次，可能会重置相关参数，从而引发安全问题。

## 名词解释
为了便于理解，以下是一些关键术语：
- 成对临时密钥 (Pairwise Transient Key, PTK)：作为会话密钥。
- 成对主密钥 (Pairwise Master Key, PMK)
- 接入端随机数 (Anonce)
- 客户端随机数 (Snonce)
- 临时密钥 (Temporal KEY, TK)
- 预共享密钥 (PSK)：同一无线路由器下的每个用户使用同一把密钥，不同于802.1X认证服务器分发给各个终端用户的密钥。
- 接收计数器 (Receive Sequence Counter, RSC)
- 信息完整性校验码 (MIC)

## 背景知识

### 1.1 WPA的产生
WPA（Wi-Fi Protected Access）是一种保护无线网络安全的系统，包括WPA和WPA2两个标准。它是为了克服前一代有线等效加密（WEP）系统的几个严重弱点而产生的：
- WEP不是强制使用的，许多设施没有启用WEP。
- WEP不包含钥匙管理协议，但在用户间共享一个秘密钥匙。
- RC4所用的24比特IV不够长，不足以保证不会重复。

商业联盟Wi-Fi Alliance制定了WPA标准，并从2003年4月开始实际应用检验，于2003年11月变为强制性标准。

### 1.2 WPA与802.11i的关系
由于WEP的安全性不足，人们需要更安全的加密标准。然而，制定802.11i标准的过程比预期要长，芯片厂商迫切需要一种更安全且兼容现有硬件的算法。因此，WPA包含了与WEP兼容的802.11i子集，实现了IEEE 802.11i标准的大部分内容。完整的802.11i标准于2004年6月通过后，Wi-Fi Alliance在2004年9月推出了实现802.11i强制性元素的WPA2。

### 1.3 WPA2的改进
WEP使用的CRC（循环冗余校验）先天不安全，在不知道WEP密钥的情况下，篡改数据和对应的CRC是可能的。WPA使用了名为“Michael”的更安全的消息认证码（MIC），而WPA2采用了计数器模式密码块链消息完整码协议（CCMP），其安全性已被严格证明。WPA仍使用RC4，但引入了可以动态改变密钥的临时密钥完整性协议（TKIP）和48位的IV。WPA2中RC4被AES取代。

## 攻击原理

### 2.1 四次握手
WPA和WPA2均使用802.11i中定义的四次握手过程，客户端（Station, STA）和接入点（Access Point, AP）通过四次握手相互验证和协商成对临时密钥（PTK）。PTK通过成对主密钥（PMK）、AP随机数（ANonce）、STA随机数（SNonce）和双方MAC地址等计算生成，其中PMK由登录密码等双方均已知的信息计算生成。后续正常数据加密所使用的临时密钥（TK）派生自PTK。

### 2.2 攻击过程
为了完成密钥重装攻击，攻击者需要嗅探并重放四次握手过程中的第3个消息报文，强制重置协议加密使用的nonce值及重放计数，重新安装加密密钥。由于会话密钥与双方MAC地址有关，普通的中间人攻击无法奏效，需要运用基于信道的中间人技术（channel-based MitM），伪造同名同MAC不同信道的热点。

## 不同场景的攻击

### 3.1 接受明文重传消息3，不安装全0密钥
攻击者作为中间人，首先放行消息1、2、3，阻塞客户端对消息3的回复消息4。此时客户端安装了PTK，并发送以此PTK加密的数据，nonce为1，攻击者将此数据阻塞。AP未接收到消息4，将重发消息3，攻击者将其转发给客户端。客户端重装PTK，攻击者将先前拦下的消息4发送给AP。此后发送的加密数据将重用PTK，且nonce被重置为1。nonce重用的后果与所采用的数据保密协议密切相关。三种数据保密协议包括：
- 临时密钥完整性协议（TKIP）

希望以上内容能帮助你更好地理解密钥重装攻击及其影响。