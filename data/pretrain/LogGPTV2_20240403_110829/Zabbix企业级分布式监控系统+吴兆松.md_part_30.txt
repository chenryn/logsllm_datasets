Function:
'Result:
True
I0:zabbix-agent
Conment:
The service zabbix-agent is already running
changes:
ID:
cripts
The direccory /etc/zabbix/scripts ls tn the correct state
changes,
图9-68
关于SaltStack更多的功能，请读者自行进行深入学习。
241
---
## Page 258
第10章使用的经验和技巧
在Zabbix的配置使用中，有很多需要注意的地方，因此，这部分内容将单独
整理为一章进行介绍，方便读者查阅。
10.1如何有效地设置监控告警
对于监控的告警信息，若处理得好，将会提高故障响应速度，反之，则会影
响我们的工作情绪，进而影响工作效率。试想，若一天收到1000封告警信息，是
否还会去逐一查看监控告警信息？是否还能分辨是重大故障，还是一般故障？
对于误报、漏报的情况，会让人对信息的警觉性放松，时间久了，还会导致
对接收的监控信息有反感。所以，对于监控告警信息的发送，是一件特别慎重的
事情。下面总结一下对监控告警信息的需求。
·基于业务类型：将告警信息发送给相应的业务用户，例如，IDC人员、Web运维人员、
CDN运维人员、网络运维人员。不同的人员管理不同的设备，因此，需要把故障发送给相
关用户进行处理。
·基于故障级别：对一个故障，将不同的故障级别发送给不同的用户，例如，5分钟内的
故障发送给运维一线人员，10分钟的故障发送给运维部门主管，30分钟的故障发送给
运维部门经理。特大故障发送给部门相关领导。
·基于时间发送：比如业务维护期，告警无须发送。
·故障的相关依赖关系：当A服务发生故障时，发送一般告警；当A、B服务发生故障时
发送业务故障告警。对出现故障的服务尝试用相关命令或者脚本进行操作处理，尝试自
动恢复，例如，重启服务、重启服务器等。
告警信息需要定制，重点关注以下内容。
·哪些业务需要告警？
·哪种故障需要告警？
·告警等级如何划分？
·故障依赖关系如何定义？
·告警信息如何汇集？
·如何做到精准有效地告警？
1．基于业务类型
将不同的用户分配到不同的用户组。Action中定义不同主机组发送信息给对
应的用户组；Action中可以为不同的服务器组创建不同的Action，因此，可以基
于对业务类型的机器分组进行告警信息的发送。
---
## Page 259
第10章
：使用的经验和技巧
如图10-1到图10-5所示，是基于组发送的一个告警配置。
Action
Conditions
Operations
Namemail_to_user_group1
Default operationstep duration
60（minimum 60 seconds)
Default subject
group1服务器发生故障{TRIGGER.STATUS}：{TF
Default message
Trigger:{TRIGGER.NAME}
Trigger status:{TRIGGER.STATUS}
Triggerseverity:{TRIGGER.SEVERITY}
TriggerURL:{TRIGGER.URL}
TriggerDATE:{EVENT.DATE}
Trigger Time:{TIME}
Itemvalues:
Recovery message
Recovery subject
group1服务器故障已经解决{TRIGGER.STATUS}：
Recovery message
Trigger:{TRIGGER.NAME}
Trigger status:{TRIGGER.STATUS}
Trigger severity:{TRIGGER.SEVERITY}
Trigger URL:{TRIGGER.URL}
TriggerDATE:{EVENT.DATE}
Trigger Time:{TIME}
Save
Clone
Delete
Cancel
图10-1
nISLUIy.
CONFIGURATION OF ACTIONS
Action
Conditions
Operations
Type of calculation
AND
(o)pue(a）pue(）
Conditions
Label-Nome
Aetion
(A)
Maintenance status not in“maintenance”
Remove
(B)
Trigger value=“pROBLEM”
Remove.
(C)
Host group ="
aroup!
Remove.
New condition
Trigger name
ike
Add
Save
Clone
Delete
Cancel
图10-2
Operations
Action operations
Steps Details
Send message to us
1
New.
图10-3
243
---
## Page 260
Zabbix企业级分布式监控系统
Operations
Action operations
Steps Details
Startin
Duration(sec） Action
1
Immediately Default
Edit Renave.
Operation details
Step
From
1
To
1(0-infinitel)
Step duration
0
（minimum 60 seconds,0-use action default)
Operation type
Send message
Send to User groups
User arnuo
Action
groupl
Remove
Send to Users
user
Action
Add
Send only to
-All-
Default message
Conditions
Label
Name
Action
New.
Update.Cance!
图10-4
Trigger value-“PROBLEM”
Host group-gl
图10-5
当然，用户组中的用户需要在用户管理中定义，此处略（有关用户管理的内
容，在此省略)。
2.基于故障级别
在定义触发器的时候，有故障级别的选择，如图10-6所示。
Trigger
Dependencies
Parent trigersIemplate ARZabix.Aaent
Name
Zabbix agent on(HOST.NAME} is unreachab
Expression
{TemplateOs
Linux:agent.ping.last（#3,10m）}=1
Expression constructor
口
Multiple PROBLEMeventsgeneration
Description
URL
Severity
Not classifiedInformation
WarningAverage
HighDisaster
Enabled
Save
CloneDelete
Cancel
图10-6
244
---
## Page 261
第10章
使用的经验和技巧
我们可以对不同的故障分级别定义。
在对用户添加告警媒体的时候，可以定义不同的故障等级发送。例如，触发
器如下。
(Template Os Linux:agent.ping.nodata(5m) }=1&(Template Os Linux:ag
ent.ping.1ast（#3,5m)}=1
{Template OS Linux:agent.ping.nodata(10m)}=1&{Template Os Linux:a
gent.ping.1ast（#3,10m)}=1
gent.ping.last（#3,15m)}=1
{Template Os Linux:agent.ping.nodata(30m)}=l&{Template Os Linux:a
gent.ping.last（#3,30m)}=1
然后将不同的触发器标记为不同的故障级别，如图10-7所示。
Nev medla
Type
Email
Send to
PI:EMAIL
when active
1-7.18:00-24:00:1-7.00:
0-09:10
Notclassified
Information
warning
High
oisaster
Status
Enabled
SaveCancel
图10-7
基于以上两个功能，完全可以做到将不同的故障级别发送给不同的人。
3.基于时间发送
如图10-8所示，时间可以为1-7,00:00-24:00、1-7,00:00-09:10等，各时间段
之间用分号隔开，可以创建任意的时间段，根据实际情况选择即可。
New media
Type
Email
Sondto
PI:EMAIL
whenactive
1-7,18:00-24:00;1-7,00:00-09:10
Not classified
Information
warning
Useifseverity
Average
High
disaster
Status
Enabled
SaveCancel
图10-8
245
---
## Page 262
Zabbix企业级分布式监控系统
4.故障依赖关系
ent.ping.1ast(#3,5m)}=1
以上触发器的设置条件语句中，表示Agent在5分钟内无数据，并且在5分
钟内的第三次取值是有的，即前2分钟设备还存活。
除此之外，在这种环境下：一个区域网络断开，按照常规的告警方式，会
发送该网段所有设备的告警，但通过只发送一个告警。也可以配置告警的故障
依赖。
5．故障的自动恢复
告警除了发送消息外，还可以执行远程命令，从而实现故障的自动恢复，具
体内容见6.3.6节。
10.2监控项的使用技巧
在 Zabbix的Web前端可以看到，一些监控模块已经带大量的监控项，但某
些监控项并没有添加到Graphs 中，故需要手动添加。如图10-9所示，Key 为
system.users.num的Items，需要添加图形（如何添加Graphs，请参考前面章节的
内容）。
HostTemplate Os Linux
Name
Number of logged in users
Type
Zabbixagent
Key
system.users.num
Select
of information
Numeric(unsigned)
Data type
Decimal
Units
tom multiplier|
1
图10-9
10.3触发器的使用技巧
默认的一些触发器由于触发值设置不合理，需要修改后才能满足自已的生产
环境。
如图10-10所示，此处的语句{TemplateOSLinux:proc.num[,run].last(0)}>30表
示大于30即告警。由于服务器应用的不同，需要将此值进行合理设置，否则会产
生大量的误报。
246
---
## Page 263
第10章使用的经验和技巧
《Tempilate list Template: Template OS LinuxApplications (11) Items (44) Triggers (19) Graphs (10) Screens (1) Discovery rules 
Name
Toomany processesrunning onHosT.NAMI
Expression
Add
xp
口
Description
URL
Severity
HighDisaster
Enabled
口
Sove
Delete
图10-10
10.4触发器配置
由于默认的模板是理想状态的值，并不能满足生产环境中各种奇特的需求，
所以需要对默认的触发器进行修改，这样才能不被误报。
一个很常见的现象是通过网络发现的主机，在该主机中添加机器的时候，会
出现告警提示机器刚刚发生过重启，这种情况就属于严重的误报，且随着主机规
模的增大，这种故障会很严重。
如图10-11所示为Linux的模板，默认有如下的触发器设置，应根据实际需求
进行修改。
SeverityName
Expression
Warning
/etc/passwd has been chanqed on (HOSTNAME)
{Temptate Os Linuxvfs.file.cksum/e
iInformationConfiquredmax number of apened fles js too low on-1
图10-11
247
---
## Page 264
Zabbix企业级分布式监控系统
首先，对主机存活状态的触发器进行修改，如图10-12所示。
(Template Os Linux:system.uptime.change(0) )300
A
图10-14
NameToo many processes running on(HOsT.NAME)
Expression
{TemplateOs
Linux:proc.num,run].avg（5m)}>30l
图10-15
注意：在16.4.3节还列举了其他不合理的触发器设置，读者可以参考。
248
---
## Page 265
第10章
使用的经验和技巧
谷歌浏览器告警插件
10.5
在Zabbix官方网址http://www.zabbix.com/third_party_tools.php中介绍了很多
有趣的插件。这里我们体验一下ZabbixNotifie，在谷歌应用商店的地址为：
https://chrome.google.com/webstore/detail/zabbix-notifier/ikeijbmpddnkaeejokgif
ioccbcijfo/related
由于谷歌应用商店调整了策略，直接在应用商店中是无法搜索到的。配置该
插件的内容如图10-16到图10-20所示。
ZabbixNotifier
正在检资
（15）
随助功验
概述
详情
评价
相关
rforZabbix.
Nserangezeig
idProbl
onfiguri
8
n der Stau
leistedes Brovsersistauf
inenBlickeinUberblickuber die
noglich
Zabbix2.0
Nutzr die Zabbx-AP
User-Name,Pas
URLPortu
pdate
vallsindkanfiguner
图10-16
ifier/ikejbmpddnkaeejokgifioccbcijfo/related
gigtecZabbixNotifier:Overview
System
Descriptior