（2）NetFlowExport，流的输出机制，主要描述了流是如何输出并被分析器接收的。
NetFlow 缓存管理机制中包含一系列高度精细化算法，能够有效地判断一个报文是属于
（1）NetFlowCache，主要描述流缓存（或者说源数据）如何存放在Cache中。
在NetFlow中有两个关键组件：
以上7个字段定义了一个基本的Flow信息。NetFlow 就是利用分析 IP 数据包的上述 7
●网络设备输入/输出的逻辑端口（ifindex）。
●TOS字段。
●源IP地址。
第三层协议的类型。
目的端口号。
源端口号。
目的IP地址
第13章网络流量监控329
一个IP数据包的
28.8
有
---
## Page 353
66.190.144.166正在对某网段进行SQL漏洞扫描。
口为1433的TCP 流。表13-2是根据此条件筛选出的 NetFlow 统计数据，可以得知 IP 地址
接。因此检测条件是：相同源 IP，大量不同目的 IP，目的端口为 445，当符合的 Flow 达到
内符合特征的 Flow 超过上限值，则可以判断为 Nimda 病毒或其他攻击行为。另外，如果
机在一段时间内（例如5min）Flow数量过大，
Nimda的Flow特征是每个Flow代表一次连接destinationport=80的行为，如果普通的客户
个时间段内符合特征的Flow大于上限值，则可以判断为CodeRed。
会在连续几段时间内发出大量的这些报文。
Intermet上，符合上述特性的正常行为是存在的（如使用ICQ），但是一般正常使用的主机不
我们可以利用NetFlow的信息筛选出这些数据包，从而快速发现问题。
而增加，所以在高负载情况下，一定要慎用NetFlow功能。
10%～15%利用率均属正常。注意，在使用中CPU的利用率会随着缓存中Flow条目的增大
由于高端Cisco设备（如6500、7600系列等）都是通过ASIC 硬件处理数据包，所以占用
将报文输出，也要消耗系统资源，因此在设备上使用NetFlow时，肯定就会影响设备性能。
13.2.4NetFlow的性能影响
330UNIX/Linux网络日志分析与流量监控
上限值时，则可以认定是震荡波病毒。
HTTP的攻击行为。
毒的能力，会
造成影响，
13.2.5
设备缓存中 Flow的生成，需要消耗系统资源，同样将 Flow格式化成特定的输出报文并
66.190.144.166
66.190.144.166
例四：几年前臭名昭著的微软SQL-Server漏洞造成了很大的影响，它的特征是目的端
66.190.144.166
66.190.144.166
66.190.144.166
66.190.144.166
因此监测Nimda可采用的策略是取几个不同时间段，每段时间5min，
例二：感染了Nimda 的主机会向外部地址（往往是 TCP 的 80 端口）发起大量连接。
因此监测CodeRed可采用的方法是：取几个不同时间段，例如每段时间5min，如果每
前些年Code Red、SQL Slammer、冲击波、振荡波等病毒的相继爆发，不但对用户主机
例三：震荡波病毒的特征是一个IP同时向随机生成的多个IP发起445端口的TCP连
源IP
NetFlow在蠕虫病毒监测中的应用
而且对网络的正常运行也构成了危害，因为这些病毒具有扫描网络、主动传播病
会大量占用网络带宽或网络设备系统资源。这些蠕虫的网络行为有些共同特征，
6000
6000
6000
6000
6000
6000
源端口
202.102.102.37
202.102.102.36
202.102.102.34
202.102.102.35
202.102.102.34
202.102.102.33
目的IP
表13-2筛选的NetFlow数据
目的端口协议
1433
1433
1433
1433
1433
1433
，那么很有可能遭受病毒感染或者有其他针对
TCP
TCP
TCP
TCP
TCP
TCP
报文数
字节数B/PKTOS
40
40
#
40
40
#
40
如果每个时间段
团
00
00
00
00
SYN
SYN
SYN
SYN
SYN
SYN
---
## Page 354
就为及时发现和防范网络上的不安全因素提供了有效的手段。
的特征，也可以在 NetFlow 的输出结果中进行相应的查找，找到符合条件的异常 Flow。这
NetFlow实例。
出flag=2的数据包数量超过1000，则可以认为主机在发起攻击。以下是SYN特征的
以设置阈值为 5000。超过这个数值就认为服务器受到 SYN flooding 攻击。如果主机发
5min，产生大量 flag=2 的数据包，正常连接不会产生这么多 flag=2 的数据包，所以可
造了条件。
且有大量的 SYN 特征数据包。NetFlow 输出格式中提供了 Flag 位，为我们判断 SYN 攻击创
者在用ICMP发起攻击。
5min，各个时间段内ICMP报文大于5000。符合这个条件的，可以认为受到ICMP攻击，或
机。DDoS攻击的共同点是来源广泛，针对一台主机，大量数据包。
服务器无法处理源源不断如潮水般涌来的请求，从而造成响应迟缓，直至系统资源耗尽而宕
不同，有些是 Ping Death，有些是 SYN Flooding。DDoS 攻击基本上都造成这样一种结果：
SYN攻击。
SYN攻击的NetFlow数据实例，该案例中多个伪造的源IP同时向一个目的IP发起TCP
用系统资源，使合法用户被排斥而不能建立正常的TCP连接。以下为一个典型的DoS
络服务不可用。例如DoS可以利用TCP协议的缺陷，通过SYN打开半开的TCP连接，占
务器的性能下降，或占用网络带宽，影响其他相关用户流量的正常通信，最终可能导致网
各种DDoS 攻击的特征都是在短时间内产生大量的数据包，因此，即使不知道攻击报文
因此检测 SYNflooding 的条件是：在连续的几个时间段，假设每个时间段为
因此检测ICMP攻击就可以根据下面的条件：在连续的几个时间段，假设每个时间段为
另外，还有一种 DDoS 攻击是 SYN Flooding，
DoS攻击使用非正常的数据流量攻击网络设备或其接入的服务器，致使网络设备或服
例六：NetFlow在网络取证方面的应用
下面是ICMP 流的 NetFlow实例。
日常工作中发现，除了遇到DoS以外还有许多攻击属于DDoS攻击，只不过攻击类别
例五：用NetFlow分析DoS攻击流量isn
177.22.13.19
217.20.133.14
218.177.30.22
Srcipaddress
112.73.199 22
125.71.109.12
117.234.230.118
Srcipaddress
105.*.93.91|202.**.80|Others|64851|3|2|5557|5928|6|1|40|1
111.*.68.35|202.**.80|Others|64851|3|2|10000|10000|6|1|40|1
78.54.22.98
67.33.22.201
68.44.34.22
67.32.46.12
67.32.45.33
67.33.22.12
Dstipaddress
Dstipaddress
Srcp
dao
Srcp
2967
5e4
800
Dstp
800
800
9
Dstp
，它的特征是TCP报头中的SYN被置位，
00100000
0010
0010
Sif
0020
0020
0020
0000
0000
Dif
第13章网络流量监控331
01
10
01
Proto
Proto
00
0
0
1950
1904
1989
Pkts
3
Pkts
100225
122883
134920
Octets
Octets
#
144
同
---
## Page 355
看），分析NetFlow过程如图13-2所示。
（路径为SituationalAwareness→Network→Traffic，
Web 前端程序Nfsen来读取，数据通过555端口接收，同时结果会显示在前台Web界面上
（为NetFlow格式），再发到系统的555端口（查看/etc/default/fprobe能得知详情），由Nfsen
首先在网络接口接收数据，然后由Fprobe程序将收集的数据按照一定规则和格式进行转换
以通过部署这样一台OSSIM服务器，将网络流量镜像至OSSIM服务器，实现网络流量分
行。它可以将 NIC 接口收到的数据转化为 NetFlow数据，并发送至 NetFlow 分析端。我们可
V5 版本。Fprobe最初是一款在BSD 环境下运行的软件，目前在UNIX/Linux平台上均可运
有相应的解决方法，那就是使用Fprobe。利用Fprobe来生成NetFlow报文，其默认格式为
得尤为重要，希望引起管理人员重视。100
信息分别存放在不同的设备上，
录信息包含用户账号、登录时间、IP、端口、发送数据包大小及日期、时间戳等。这些日志
端发送/接受、接入服务器验证、路由器转发及FTP服务器接受下载，
重要。最后在FTP服务器上还有完整的下载记录。
上记录着FTP下载/上传网络流量（NetFlow）日志（一般会保留30天左右），这个流量至关
就能将客户端的所在家庭电话号码与上网拨号信息联系到一起，与此同时，在ISP的路由器
时间内被分配给客户端PC，通过在ISP方面的ANI（AutomaticNumber Identification）日志
户端PC上留有下载日期时间戳信息，在局端的接入服务器上也可以看到特定IP地址在相应
332UNIX/Linux网络日志分析与流量监控
某些日志等）也不会影响全局，
在某些情况下，设备不支持NetFlow，此时怎么对流量进行监测呢？对于这样的环境也
假设图13-1中的ADSL拨号用户从Intermet上某FTP服务器上下载了可疑文件，在客
OSSIM服务器中的NetFlow分析器，
由上图可以看出，从客户端发起连接到从FTP服务器下载分为四个阶段，
有
C
Fprobe：从远程主机发送数据流。
关OSSIM结构大家可以先参看本书第14章，这里介绍NetFlow分析数据包的过程。
客户端PC机
Nfdump：NetFlow采集模块。
NfSen：NetFlow的分析图形前端
日期时间戳日志
接人服务器
，所以这些相关信息，在调查人员进行计算机网络取证时就显
即便是某些日志遭到了一定程度破坏（例如篡改IP，丢失了
TACACS日志
图13-1分析下载可疑文件
和ANI记录
由下列三个工具组成：
显示效果在OSSIM右侧导航栏里可以查
路由器Neflo
路由器
米
一
，每个阶段都有日志记
Ftp服务器
登录门P服务
分别是客
?
户
---
## Page 356
如图13-4所示。
nfcapd.2013053112035包含的数据是从2013年5月31日12小时35分钟开始的数据
起来，每5min采集一次数据，同时nfcapd建立新的文件，并用当前时间来命名，例如
二进制文件格式，以天为单位分别设置目录，方便查看。这些数据按照一定的时间组织