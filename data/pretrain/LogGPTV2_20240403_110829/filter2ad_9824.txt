# 【技术分享】针对勒索软件MacRansom的分析

#### 译文声明
本文为翻译文章，原文来源：安全客。译文仅供参考，具体内容及含义请以原文为准。

作者：[myswsun](http://bobao.360.cn/member/contribute?uid=2773429458)  
预估稿费：180 RMB  
投稿方式：发送邮件至linwei#360.cn，或登录网页版在线投稿

---

## 前言
许多Mac用户可能认为他们的系统相对安全，不易受到类似勒索软件的攻击。然而，这主要是因为Windows用户的数量远多于Mac用户（约90% vs. 6%），而非操作系统本身的漏洞差异。

## MacRansom 网站
近期，FortiGuard实验室发现了一种名为Ransomware-as-a-Service (RaaS) 的新型勒索软件，它通过TOR网络提供服务。值得注意的是，这是首次在Mac OS上发现此类服务。

### 获取样本
MacRansom变种并不容易从网站直接获取，需要与作者联系定制。起初我们怀疑这是一个骗局，但在邮件沟通后获得了样本。以下是具体的通信记录：

- **第一次回复**（上午11点 GMT+8）：确认了触发日期为6月1日，并提供了比特币地址。
- **第二次回复**（下午9点 GMT+8）：进一步询问了关于勒索软件的细节。
- **第三次回复**（午夜 GMT+8）：观察到作者回复的时间，推测其可能位于GMT - 4时区。

## 行为分析
运行MacRansom时，首先会弹出一个来自未知开发者的提示。如果用户不打开该文件，则不会受到威胁。

### 反分析机制
MacRansom具备一定的反分析能力：
1. 检查是否在非Mac环境中运行或被调试，若条件不满足则终止。
2. 使用`ptrace`命令检查是否被附加调试器。
3. 通过`sysctl hw.model`命令验证机器型号是否包含“Mac”字符串。
4. 检查机器是否有两个CPU。

### 启动点
通过初始检查后，MacRansom会在`~/LaunchAgent/`目录下创建一个启动项`com.apple.finder.plist`，模仿合法文件以减少可疑性。此外，还将原始可执行文件复制到`~/Library/.FS_Store`，并使用`touch -ct 201606071012 '%s'`命令更改时间戳以混淆调查。

### 加密过程
加密有特定的触发时间，由作者设定。在我们的测试中，时间为2017年6月1日零点。未达触发时间前，勒索软件将退出。一旦触发时间到达，勒索软件会枚举最多128个文件进行加密。

#### 加密算法
MacRansom使用对称加密算法，硬编码了两个密钥：
- `ReadmeKey: 0x3127DE5F0F9BA796`
- `TargetFileKey: 0x39A622DDB50B49E9`

其中，`ReadmeKey`用于解密包含勒索信息和指令的_README_文件，而`TargetFileKey`则用于加密受害者的文件。由于`TargetFileKey`在内存中生成且随后释放，因此恢复加密文件具有挑战性。尽管如此，理论上仍可通过暴力破解恢复密钥。

## 总结
虽然MacRansom的危害程度低于当前针对Windows平台的勒索软件，但它依然能够加密受害者的重要文件，造成严重损失。此变种可能是基于先前OSX勒索软件代码的模仿作品，但采用了新的反分析技术。无论操作系统如何，备份重要数据始终是防范勒索软件的有效手段之一。

## 附录
- **样本哈希值**:
  - `a729d54da58ca605411d39bf5598a60d2de0657c81df971daab5def90444bcc3` – Zip 文件
  - `617f7301fd67e8b5d8ad42d4e94e02cb313fe5ad51770ef93323c6115e52fe98` – Mach-O 文件
- **生成文件**:
  - `~/LaunchAgent/com.apple.finder.plist`
  - `~/Library/.FS_Store`
- **MacRansom网站FAQ**:

希望以上内容能帮助您更好地理解MacRansom勒索软件及其运作机制。