23 , 2021-05-11 17:47:57 , \[0. 0. 0. 0. 1.\] , \[124.36666667 1.4 31.2
\]
24 , 2021-05-11 17:51:19 , \[0. 1. 0. 0. 1.\] , \[129.04444444 1.4 31.4
\]
25 , 2021-05-11 17:54:39 , \[0. 0. 0. 0. 1.\] , \[122.94444444 1.4 31.2
\]
26 , 2021-05-11 17:58:01 , \[0. 1. 0. 0. 1.\] , \[125.03333333 1.4 31.1
\]
27 , 2021-05-11 18:01:22 , \[0. 0. 0. 0. 1.\] , \[128.91111111 1.4 31.7
\]
28 , 2021-05-11 18:04:42 , \[0. 1. 0. 0. 1.\] , \[125.67777778 1.4 31.4
\]
29 , 2021-05-11 18:08:04 , \[0. 0. 0. 0. 1.\] , \[124.78888889 1.4 31.2
\]
30 , 2021-05-11 18:11:15 , \[1. 1. 0. 0. 1.\] , \[125.37777778 1.4 32.7
\]
31 , 2021-05-11 18:14:36 , \[0. 0. 0. 0. 1.\] , \[126.62222222 1.4 31.3
\]
32 , 2021-05-11 18:17:57 , \[0. 2. 0. 0. 1.\] , \[123.52222222 1.4 31.4
\]
33 , 2021-05-11 18:21:19 , \[0. 0. 0. 0. 1.\] , \[125.54444444 1.4 31.3
\]
34 , 2021-05-11 18:24:31 , \[0. 2. 0. 0. 1.\] , \[126.58888889 1.4 32.9
\]
35 , 2021-05-11 18:27:52 , \[0. 0. 0. 0. 1.\] , \[123.44444444 1.4 31.4
\]
36 , 2021-05-11 18:31:12 , \[0. 2. 0. 0. 1.\] , \[125.65555556 1.4 31.4
\]
37 , 2021-05-11 18:34:34 , \[0. 0. 0. 0. 1.\] , \[125.83333333 1.4 31.5
\]
38 , 2021-05-11 18:37:45 , \[1. 1. 0. 0. 1.\] , \[128.74444444 1.4 32.8
\]
39 , 2021-05-11 18:41:06 , \[0. 0. 0. 0. 1.\] , \[123.74444444 1.4 31.4
\]
40 , 2021-05-11 18:44:28 , \[1. 2. 0. 0. 1.\] , \[127.13333333 1.4 31.7
\]
41 , 2021-05-11 18:47:49 , \[0. 0. 0. 0. 1.\] , \[127.9 1.4 31.4\]
42 , 2021-05-11 18:51:00 , \[0. 1. 0. 0. 1.\] , \[124.71111111 1.4 32.9
\]
43 , 2021-05-11 18:54:21 , \[0. 0. 0. 0. 1.\] , \[125.51111111 1.4 31.1
\]
44 , 2021-05-11 18:57:42 , \[0. 1. 0. 0. 1.\] , \[123.42222222 1.4 31.4
\]
45 , 2021-05-11 19:01:03 , \[0. 0. 0. 0. 1.\] , \[124.04444444 1.4 31.4
\]
46 , 2021-05-11 19:04:24 , \[0. 1. 0. 0. 1.\] , \[124.28888889 1.4 31.2
\]
47 , 2021-05-11 19:07:35 , \[0. 0. 0. 0. 1.\] , \[125.75555556 1.4 32.7
\]
48 , 2021-05-11 19:10:57 , \[0. 1. 0. 0. 1.\] , \[127.17777778 1.4 31.3
\]
49 , 2021-05-11 19:14:17 , \[0. 0. 0. 0. 1.\] , \[123.52222222 1.4 31.5
\]
50 , 2021-05-11 19:17:38 , \[0. 1. 0. 0. 1.\] , \[125.33333333 1.4 31.5
\]
51 , 2021-05-11 19:20:58 , \[0. 0. 0. 0. 1.\] , \[126.82222222 1.4 31.3
\]
52 , 2021-05-11 19:24:19 , \[0. 1. 0. 0. 1.\] , \[124.15555556 1.4 31.4
\]
53 , 2021-05-11 19:27:40 , \[0. 0. 0. 0. 1.\] , \[126.34444444 1.4 31.5
\]
54 , 2021-05-11 19:31:01 , \[0. 1. 0. 0. 1.\] , \[124.68888889 1.4 31.4
\]
55 , 2021-05-11 19:34:23 , \[0. 0. 0. 0. 0.\] , \[125.5 1.4 31.4\]
56 , 2021-05-11 19:37:44 , \[0. 1. 0. 0. 1.\] , \[125.61111111 1.4 31.4
\]
57 , 2021-05-11 19:40:55 , \[0. 0. 0. 0. 0.\] , \[125.16666667 1.4 32.8
\]
58 , 2021-05-11 19:44:16 , \[0. 1. 0. 0. 1.\] , \[125.06666667 1.4 31.5
\]
59 , 2021-05-11 19:47:37 , \[0. 0. 0. 0. 0.\] , \[125.54444444 1.4 31.2
\]
60 , 2021-05-11 19:50:58 , \[0. 1. 0. 0. 1.\] , \[125.55555556 1.4 31.4
\]
61 , 2021-05-11 19:54:20 , \[0. 0. 0. 0. 0.\] , \[128.92222222 1.4 31.5
\]
62 , 2021-05-11 19:57:31 , \[0. 1. 0. 0. 1.\] , \[125.9 1.4 32.9\]
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--new:\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--
knobs: \[\[0. 0. 0. 0. 0.\]\]
metrics: \[\[124.1 1.4 31.5\]\]
rowlabels: \[1\]
timestamp: 2021-05-11 20:00:52
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--TARGET:\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--
knob: \[\'\--enable_query_cache\'
\'\--max_concurrency_tasks_per_search\'
\'\--max_per_search_ram\' \'\--max_per_sub_search_ram\'
\'\--block_ids_per_batch\'\]
metric: search_latency
metric_lessisbetter: 1
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--
num of knobs == 5
knobs: \[\'\--enable_query_cache\'
\'\--max_concurrency_tasks_per_search\'
\'\--max_per_search_ram\' \'\--max_per_sub_search_ram\'
\'\--block_ids_per_batch\'\]
num of metrics == 3
metrics: \[\'search_latency\' \'compaction_mem\' \'compaction_cpu\'\]
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--
可以看到最佳推荐配置为\[0. 0. 0. 0. 0.\]和\[0. 1. 0. 0.
1.\]（此数字含义为list中的下标索引），具体配置参数如下
set_beaver_datanode_gflags:: \--enable_query_cache false
set_beaver_datanode_gflags:: \--max_concurrency_tasks_per_search 4
set_beaver_datanode_gflags:: \--max_per_search_ram 198m
set_beaver_datanode_gflags:: \--max_per_sub_search_ram 99m
set_beaver_datanode_gflags:: \--block_ids_per_batch 16
或者
set_beaver_datanode_gflags:: \--enable_query_cache false
set_beaver_datanode_gflags:: \--max_concurrency_tasks_per_search 6
set_beaver_datanode_gflags:: \--max_per_search_ram 198m
set_beaver_datanode_gflags:: \--max_per_sub_search_ram 99m
set_beaver_datanode_gflags:: \--block_ids_per_batch 18
结果显示，适当提高search并发数，或提高SubSearch的block数会优化search性能。
## 
## 五、存在的问题
通过修改相关代码，目前自动调参工具能正常运行，但依然存在不足。本次测试方案利用事前存储好的索引及baimi数据集，仅测试影响search性能的参数，因此可修改的配置项也相对较少，舍弃了autoTiKV的workload。但代码依然保留此功能，待后续有针对beaver的工作负载方案之后，再添加相关workload。此外beaver_datanode的重启方式也并不优雅，有待提升。
后续可优化：
1.  增加不同的workload模式，测试index性能和search性能（需要beaver支持新的index方式），同时测试index相关的配置参数。
2.  优雅的重启beaver_datanode。
3.  目前重启等待beaver_datanode可用的wait时间为200s，在实际运行的beaver中，索引恢复时间相对较长，需根据不同环境灵活变化。
4.  指标数据获取的准确性，会受到网络等因素的影响，有一定的波动。
# \[参考文献\]
1.  OtterTune. https://github.com/cmu-db/ottertune
2.  AutoTiKV. https://github.com/tikv/auto-tikv
3.  Automatic Database Management System Tuning Through Large-scale
    Machine Learning.
    https://www.cs.cmu.edu/\~ggordon/van-aken-etal-parameters.pdf
4.  https://mp.weixin.qq.com/s/y8VIieK0LO37SjRRyPhtrw
5.  https://blog.csdn.net/Leon_winter/article/details/86604553
6.  https://blog.csdn.net/a769096214/article/details/80920304
7.  Esrally. https://github.com/elastic/rally
8.  https://www.cnblogs.com/pdev/p/11318880.html
9.  https://gitee.com/opengauss/openGauss-server/tree/master/src/gausskernel/dbmind/tools