资源将被非法访问。如果在设计时，使用的访问令牌Access Token有效
期设置不合理或长期有效，当访问令牌Access Token泄露后，则受保护
的资源也将被非法访问。
除此之外，在访问令牌发放时，会指定客户端的授权范围，如果资
源服务器端没有遵循严格的授权范围的限制或访问控制机制不全，则
也会导致受保护的资源被非法访问。
8.3.2 其他类型的授权或访问控制漏洞
在其他类型的授权或访问控制漏洞中，最为典型的是API未授权访
问。和传统的Web安全类似，此类未授权访问往往是API安全保护机制
缺失导致的。比如在第3章列举的Hadoop YARN管理API漏洞，作为API
能力的提供方，在应用程序的设计上，没有显性的API授权访问的保护
措施，需要借助于基础设施层面的访问控制策略来限制访问者的来源。
比如依赖宿主主机的iptables、依赖网络层的防火墙访问控制策略、依赖
应用层添加身份认证机制等。这一点，除了Hadoop组件外，像Spark
REST API、Etcd REST API、Kubernetes API Server等都出现过此种类型
的漏洞。
在API技术中，有一点比较特殊的就是每一个API服务或API平台都
会提供API接口描述文档或接口定义文件，比如Swagger文件、WSDL文
件、API开放平台接口描述等。这些文件的存在，使得攻击者更容易发
现服务对外暴露的接口，寻找到未授权保护的API端点。另外，多端调
用的API或多版本共存的API也是存在未授权访问漏洞的高发区。
此外，还有一些是因为访问控制策略不完善导致的，比如访问控制
模型设计或数据配置不合理；数据校验逻辑存在缺陷，导致水平越权或
垂直越权问题发生，进而导致功能权限或数据权限的扩大。在第4章中
提及的API学习工具《API安全测试小贴士》中，就有专门针对此类攻
击的绕过手法。
■ 数组绕过：{“id”:111}→{“id”:[111]}。
■ JSON对象绕过：{“id”:111}→{“id”:{“id”:111}}。
■ 多次传值绕过：/api?id=正常参数值&id=恶意参数值。
■ 正则匹配绕过：{"user_id":"*"}。
要想避免此类问题，除了正确的安全设计、严格的数据格式校验
外，还要增加线上API监控、API审计的功能设计，定期的API服务扫
描，从API管理生命周期的角度去消减API安全风险。
8.4 业界最佳实践
前文花了大量的篇幅详细介绍了OAuth协议和RBAC模型的相关知
识，下面就结合OAuth在互联网应用的使用情况来分析一下头部企业是
如何实现自己的OAuth授权流程的。
8.4.1 案例之OAuth在百度开放云平台的使用
OAuth协议的使用案例在互联网头部厂商俯首皆是，从社交应用扫
描登录所覆盖的范围读者也大体能猜测出来其使用情况，在这里为读者
选择的案例是百度开放云平台，与其他的互联网应用相比，百度开放云
平台的OAuth协议的技术实现覆盖普通的Web应用、移动端、纯后端服
务以及IoT设备，可以为读者提供最佳实践指引。
1.百度OAuth背景介绍
百度基于OAuth协议的开放标准做了自己的技术实现，并在百度开
发者中心提供了详细的开发者文档支持。文档中对要使用百度OAuth进
行授权的必要前提做了约定。
■ 注册为百度用户，这一步操作与其他厂商的开发者平台中的成为
开发者的意义相同。只有成为百度的用户，才可以成为相关API的开发
者。
■ 开发者开发自己的应用程序，需要在百度开放云平台创建应用，
由平台分配应用接入所需要的两个关键属性值API Key（client_id）和
Secret Key（client_secret）。
开发者完成了上述前提约定，才能使用百度OAuth授权。百度
OAuth授权提供了53种不同的方式获取Access Token和1种通过刷新令牌
获取AccessToken的方式（其中开发者凭据方式是百度OAuth专门为百度
云API向开发者开放而定制的，目前已停用），这与OAuth协议核心文
档及其设备码拓展规范大体是一致的。其官方的详细描述信息整理后见
表8-1。
表8-1 授权模式与适用场景
考虑到用户授权确认界面在不同的操作系统平台、不同的设备上展
现方式的不同，百度OAuth授权新增一个参数display，用来标识不同形
式的客户端所对应的不同展现形式，比如display值page为默认展现方
式，表示授权页面以全屏方式展现，通常用于Web应用程序；display值
为popup表示授权页面以弹框方式展现，通常用于桌面软件应用和Web
应用；display值为mobile表示授权页面在iPhone、Android等移动终端上
的展现方式等。
而对于授权范围，百度OAuth中也做了明确的划分，主要分为以下
两类。
■ 
用户授权：包含用户基本权限basic、百度首页消息提醒
super_msg、个人云存储中的数据netdisk三个选项。
■ 
平台授权：包含公共开放API的授权public和Hao123开放API的
hao123。
2.百度OAuth授权过程
基于以上背景知识，接下来看看百度OAuth的主要授权过程。
（1）包含Server端的客户端应用程序使用百度OAuth 2.0授权
包含Server端的客户端应用程序使用百度OAuth 2.0授权，在这种场
景下，API的调用包含以下几个关键步骤。
1）引导用户到百度OAuth进行授权，此时请求的URL格式与标准
的OAuth基本一致。其官方提供的样例请求消息格式如下：
2）如果用户同意授权许可，则请求页面将跳转至应用程序注册时
录入的跳转URL地址并添加授权码，形式如
YOUR_REGISTERED_REDIRECT_URI/?code=CODE来获取访问令牌
Access Token。此时，官方提供的请求消息格式样例如下：
响应消息关键内容如下：
细心的读者可能已经发现，百度OAuth的授权码流程比标准OAuth
流程要简洁，同时，响应消息比OAuth协议多了session_key和
session_secret两个参数，这也是百度OAuth特有的参数，其含义如下。
■ session_key：基于HTTP调用Open API时所需要的Session Key，
其有效期与Access Token一致。
■ session_secret：基于HTTP调用Open API时计算参数签名用的签
名密钥。
3）通过以上交互过程，客户端获得访问令牌Access Token，最后再
通过Access Token来调用API。
（2）移动端使用百度OAuth 2.0授权
移动端使用百度OAuth 
2.0授权推荐使用简化授权方式，步骤比较
简洁，交互过程如下。
和授权码方式一样，引导用户到百度OAuth进行授权，其请求消息
中仅是response_type值换为token，其他的不变。如果用户同意了授权，
页面将跳转至应用程序注册时录入的跳转URL并在Fragment中追加供
移动端应用程序处理的参数。此时，官方给出的样例格式如下所示：
移动端应用程序截取Fragment中的Access Token值并调用API，完
成移动端授权的调用过程。
（3）设备使用百度OAuth 2.0授权
设备使用百度OAuth 
2.0授权推荐使用设备码模式，其交互流程与
OAuth协议设备码流程基本一致。和上述两种授权方式不同的是，设备
授权首先是向百度OAuth发起请求，以获取User Code和Device Code。其
官方请求消息格式样例如下：
注意，发起此请求时，response_type的值为device_code。如果服务
器端校验client_id确认客户端身份无误后，授权服务会响应设备信息，
此信息为JSON格式，其中包含一个二维码图片地址。其官方响应消息
格式样例如下：
这个响应消息中包含了授权需要的关键信息。用户可以通过以下两
种方式完成授权许可。
■ 设备获取响应消息中的验证链接，引导用户使用其他终端访问验
证链接，填写User Code并完成授权许可。
■ 设备获取二维码并展示，用户使用手持智能终端扫描响应消息中
的二维码图片（qrcode_url字段）完成授权许可。
授权确认后，设备自动通过Device Code获取Access Token，再通过
获得的Access Token来调用API的权限。
通过以上介绍，读者应该可以明白OAuth协议在百度开放云平台上
有整体的落地实践，并且，在百度OAuth的实践过程中，根据自己的业
务特点和安全考虑，增加了一些非必填参数，比如授权页面的展现形
式、HTTP调用Open 
API的必填参数，既很好地遵循了OAuth协议的规
范，保证了接口的通用性和兼容性，又满足了业务的实际需要，给读者
提供了很好的OAuth协议可落地实践的参考范本。
8.4.2 案例之微信公众平台第三方平台API授权访问
了解了百度OAuth授权，再来看看微信公众平台第三方平台的API
授权访问。与OAuth核心流程相比，百度OAuth授权流程更为规范，微
信公众平台第三方平台因授权流程而做了更多的定制化处理。下面就带
大家一起来看看其中的具体细节。
1.微信公众平台第三方平台授权背景介绍
微信公众平台第三方平台是微信开放平台开放给开发者使用的能力
平台，开发者开发第三方应用，通过获得公众号或小程序的接口能力的
授权，代替公众平台账号调用各业务接口来实现其业务功能。第三方应
用想要接入微信公众平台，其中与授权相关的有以下步骤。
1）创建微信开放平台账号，即在微信开放平台完成账号信息的注
册审核。
2）创建第三方应用或平台，即应用注册功能，将应用或平台信息
录入微信开放平台。
3）开发者自行开发和测试授权。开发者对自己开发的第三方应用
或平台进行测试和授权验证。
4）申请全网发布并上线。开发者申请自己的第三方应用或平台在
微信公众平台第三方平台发布上线。
从上述步骤可以看出，账号注册和第三方应用注册是开始测试授权
的必要条件。只有当这些必要的前提条件做完之后，开发者才开始自行
进行授权测试与验证。
在微信开放平台的授权流程技术说明中，对API的授权调用流程进
行了详细的步骤说明，如下所示。
1）第三方平台获取预授权码（pre_auth_code）。
2）引入用户进入授权页。
3）用户确认，同意登录并授权给第三方平台。
4）确认授权后回调URI，得到授权码（authorization_code）和过
期时间。
5）利用授权码调用公众号或小程序的相关API。
这53个步骤与OAuth协议的授权码流程是一致的，只不过在OAuth
中，用户确认授权许可前是获取授权码code，在此流程中，是第三方平
台获取授权码pre_auth_code。了解了这些知识，下面就来逐步分析理解
微信开放平台的授权接入机制。
2.微信公众平台第三方平台授权技术细节
微信开放平台授权的第一个步骤是第三方平台获取预授权码
pre_auth_code，此接口的请求参数说明如图8-10所示。
●图8-10 第三方平台获取微信公共平台预授权码的请求参数定义