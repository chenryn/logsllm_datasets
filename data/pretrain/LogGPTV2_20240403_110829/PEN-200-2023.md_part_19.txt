they could indicate web developers or server admins that are not familiar with server hardening.239
i
z
Server hardening is the overall process of securing a server via configuration.
This includes processes such as disabling unneeded services, removing unused
D
services or user accounts, rotating default passwords, setting appropriate server
headers, and so forth. We don’t need to know all the ins and outs of configuring
every type of server, but understanding the concepts and what to search for can
help us determine how best to approach a potential target.
Another scanning tool we can use is the SSL Server Test from Qualys SSL Labs.240 This tool
analyzes a server’s SSL/TLS configuration and compares it against current best practices. It will
also identify some SSL/TLS related vulnerabilities, such as Poodle241 or Heartbleed.242 Let’s scan
www.megacorpone.com and check the results.
237 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Content_Security_Policy
238 (Mozilla, 2022, https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options
239 (NIST, 2022), https://csrc.nist.gov/publications/detail/sp/800-123/final
240 (Qualys, 2022), https://www.ssllabs.com/ssltest/
241 (Wikipedia, 2022), https://en.wikipedia.org/wiki/POODLE
242 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Heartbleed
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 130
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
o
Figure 30: SSL Server Test results for www.megacorpone.com
The results seem better than the Security Headers check. However, this shows that the server
n
supports TLS versions such as 1.0 and 1.1, which are deemed legacy as they implement insecure
cipher suites243 - this ultimately suggests that our target is not applying current best practices for
SSL/TLS hardening. Disabling the TLS_DHE_RSA_WITH_AES_256_CBC_SHA suite has been
i
recommended for several years,244 for example, due to multiple vulnerabilities both on AES Cipher
z
Block Chaining mode and the SHA1 algorithm. We can use these findings to gain insights about
the security practices, or lack thereof, within the target organization.
D
6.3 Active Information Gathering
This Learning Unit covers the following Learning Objectives:
• Learn to perform Netcat and Nmap port scanning
• Conduct DNS, SMB, SMTP, and SNMP Enumeration
• Understand Living off the Land techniques
In this Learning Unit, we will move beyond passive information gathering and explore techniques
that involve direct interaction with target services. We should keep in mind that innumerable
services can be targeted in the field, for example Active Directory, which we’ll cover in more detail
in a separate Module. We’ll nevertheless review some of the more common active information
gathering techniques in this Module including port scanning and DNS, SMB, SMTP, and SNMP
enumeration.
243 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Cipher_suite
244 (Microsoft Security Response Center, 2013), https://msrc-blog.microsoft.com/2013/11/12/security-advisory-2868725-
recommendation-to-disable-rc4/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 131
Made in Morocco
Penetration Testing with Kali Linux
We’ll mainly showcase active information gathering techniques that we can execute using pre-
installed tools on our local Kali machine. However, in some cases during a penetration test, we
won’t have the luxury of running our favorite Kali Linux tool. In an assumed breach scenario such
as this, we are typically given a Windows-based workstation by the client and must use what’s
available on Windows.
When “Living off the Land”, we can leverage several pre-installed and trusted Windows binaries to
perform post-compromise analysis. These binaries are shortened as LOLBins or, more recently,
LOLBAS245 to include Binaries, Scripts and Libraries.
Strictly speaking, LOLBAS binaries are typically used in a way other than by
design. In this case, we’ll relax the definition to include using standard Windows
binaries “as they are” to perform information gathering.
y
k
In the upcoming sections, we are going to showcase the most popular LOLBAS techniques along
with common Kali tools used for active information gathering.
s
6.3.1 DNS Enumeration
o
The Domain Name System (DNS)246 is a distributed database responsible for translating user-
friendly domain names into IP addresses. It’s one of the most critical systems on the internet.
This is facilitated by a hierarchical structunre that is divided into several zones, starting with the
top-level root zone.
Each domain can use different typeis of DNS records. Some of the most common types of DNS
records include: z
• NS: Nameserver records contain the name of the authoritative servers hosting the DNS
D
records for a domain.
• A: Also known as a host record, the “a record” contains the IPv4 address of a hostname
(such as www.megacorpone.com).
• AAAA: Also known as a quad A host record, the “aaaa record” contains the IPv6 address of a
hostname (such as www.megacorpone.com).
• MX: Mail Exchange records contain the names of the servers responsible for handling email
for the domain. A domain can contain multiple MX records.
• PTR: Pointer Records are used in reverse lookup zones and can find the records associated
with an IP address.
• CNAME: Canonical Name Records are used to create aliases for other host records.
• TXT: Text records can contain any arbitrary data and be used for various purposes, such as
domain ownership verification.
245 (LOLBAS, 2022), https://lolbas-project.github.io/
246 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Domain_Name_System
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 132
Made in Morocco
Penetration Testing with Kali Linux
Due to the wealth of information contained within DNS, it is often a lucrative target for active
information gathering.
Let’s demonstrate this by using the host command to find the IP address of
www.megacorpone.com.
kali@kali:~$ host www.megacorpone.com
www.megacorpone.com has address 149.56.244.87
Listing 38 - Using host to find the A host record for www.megacorpone.com
By default, the host command searches for an A record, but we can also query other fields, such
as MX or TXT records, by specifying the record type in our query using the -t option.
kali@kali:~$ host -t mx megacorpone.com
megacorpone.com mail is handled by 10 fb.mail.gandi.net.
megacorpone.com mail is handled by 20 spool.mail.gandi.net. y
megacorpone.com mail is handled by 50 mail.megacorpone.com.
megacorpone.com mail is handled by 60 mail2.megacorpone.com.
k
Listing 39 - Using host to find the MX records for megacorpone.com
In this case, we first ran the host command to fetch only megacorpone.com MX records, which
s
returned four different mail server records. Each server has a different priority (10, 20, 50, 60) and
the server with the lowest priority number will be used first to forward mail addressed to the
o
megacorpone.com domain (fb.mail.gandi.net).
We then ran the host command again to retrieve only the megacorpone.com TXT records, which
n
returned two entries.
kali@kali:~$ host -t txt megacoripone.com
megacorpone.com descriptive text "Try Harder"
z
megacorpone.com descriptive text "google-site-
verification=U7B_b0HNeBtY4qYGQZNsEYXfCJ32hMNV3GtC0wWq5pA"
Listing 4D0 - Using host to find the TXT records for megacorpone.com
Now that we have collected some initial data from the megacorpone.com domain, we can
continue to use additional DNS queries to discover more hostnames and IP addresses belonging
to the same domain. For example, we know that the domain has a web server with the hostname
“www.megacorpone.com”.
Let’s run host against this hostname.
kali@kali:~$ host www.megacorpone.com
www.megacorpone.com has address 149.56.244.87
Listing 41 - Using host to search for a valid host
Now, let’s determine if megacorpone.com has a server with the hostname “idontexist”. We’ll
observe the difference between the query outputs.
kali@kali:~$ host idontexist.megacorpone.com
Host idontexist.megacorpone.com not found: 3(NXDOMAIN)
Listing 42 - Using host to search for an invalid host
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 133
Made in Morocco
Penetration Testing with Kali Linux
In Listing 41, we queried a valid hostname and received an IP resolution response. By contrast,
Listing 42 returned an error (NXDOMAIN247) indicating a public DNS record does not exist for that
hostname. Since we now understand how to search for valid hostnames, we can automate our
efforts.
Having learned the basics of DNS enumeration, we can develop DNS brute-forcing techniques to
speed up our research.
Brute forcing is a trial-and-error technique that seeks to find valid information such as directories
on a web server, username and password combinations, or in this case, valid DNS records. By
using a wordlist containing common hostnames, we can attempt to guess DNS records and
check the response for valid hostnames.
In the examples so far, we used forward lookups, which request the IP address of a hostname to
query both a valid and an invalid hostname. If host successfully resolves a name to an IP, this
y
could be an indication of a functional server.
We can automate the forward DNS-lookup of common hostnakmes using the host command in a
Bash one-liner.
s
First, let’s build a list of possible hostnames.
kali@kali:~$ cat list.txt o
www
ftp
mail n
owa
proxy
router i
Listzing 43 - A small list of possible hostnames
Next, we can use a Bash one-liner to attempt to resolve each hostname.
D
kali@kali:~$ for ip in $(cat list.txt); do host $ip.megacorpone.com; done
www.megacorpone.com has address 149.56.244.87
Host ftp.megacorpone.com not found: 3(NXDOMAIN)
mail.megacorpone.com has address 51.222.169.212
Host owa.megacorpone.com not found: 3(NXDOMAIN)
Host proxy.megacorpone.com not found: 3(NXDOMAIN)
router.megacorpone.com has address 51.222.169.214
Listing 44 - Using Bash to brute force forward DNS name lookups
Using this simplified wordlist, we discovered entries for “www”, “mail”, and “router”. The
hostnames “ftp”, “owa”, and “proxy”, however, were not found. Much more comprehensive
wordlists are available as part of the SecLists project.248 These wordlists can be installed to the
/usr/share/seclists directory using the sudo apt install seclists command.
With the exception of the www record, our DNS-forward brute force enumeration revealed a set of
scattered IP addresses in the same approximate range (51.222.169.X). If the DNS administrator
247 (Internet Engineering Task Force, 2016), https://tools.ietf.org/html/rfc8020
248 (danielmiessler, 2022), https://github.com/danielmiessler/SecLists
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 134
Made in Morocco
Penetration Testing with Kali Linux
of megacorpone.com configured PTR249 records for the domain, we could scan the approximate
range with reverse lookups to request the hostname for each IP.
Let’s use a loop to scan IP addresses 51.222.169.200 through 51.222.169.254. We will filter out
invalid results (using grep -v) by showing only entries that do not contain “not found”.
kali@kali:~$ for ip in $(seq 200 254); do host 51.222.169.$ip; done | grep -v "not
found"
...
208.169.222.51.in-addr.arpa domain name pointer admin.megacorpone.com.
209.169.222.51.in-addr.arpa domain name pointer beta.megacorpone.com.
210.169.222.51.in-addr.arpa domain name pointer fs1.megacorpone.com.
211.169.222.51.in-addr.arpa domain name pointer intranet.megacorpone.com.
212.169.222.51.in-addr.arpa domain name pointer mail.megacorpone.com.
213.169.222.51.in-addr.arpa domain name pointer mail2.megacorpone.com.
214.169.222.51.in-addr.arpa domain name pointer router.megacoyrpone.com.
215.169.222.51.in-addr.arpa domain name pointer siem.megacorpone.com.
216.169.222.51.in-addr.arpa domain name pointer snmp.megacorpone.com.
k
217.169.222.51.in-addr.arpa domain name pointer syslog.megacorpone.com.
218.169.222.51.in-addr.arpa domain name pointer support.megacorpone.com.
219.169.222.51.in-addr.arpa domain name pointer tesst.megacorpone.com.
220.169.222.51.in-addr.arpa domain name pointer vpn.megacorpone.com.
...
o
Listing 45 - Using Bash to brute force reverse DNS names
We have successfully managed to resolve a number of IP addresses to valid hosts using reverse
DNS lookups. If we were performing an asnsessment, we could further extrapolate these results,
and might scan for “mail2”, “router”, etc., and reverse-lookup positive results. These types of
scans are often cyclical; we expand our search based on any information we receive at every
i
round.
z
Now that we have developed our foundational DNS enumeration skills, let’s explore how we can
automate the process usingD a few applications.
There are several tools in Kali Linux that can automate DNS enumeration. Two notable examples
are DNSRecon and DNSenum; let’s explore their capabilities.
DNSRecon250 is an advanced DNS enumeration script written in Python. Let’s run dnsrecon
against megacorpone.com, using the -d option to specify a domain name and -t to specify the
type of enumeration to perform (in this case, a standard scan).
kali@kali:~$ dnsrecon -d megacorpone.com -t std
[*] std: Performing General Enumeration against: megacorpone.com...
[-] DNSSEC is not configured for megacorpone.com
[*] SOA ns1.megacorpone.com 51.79.37.18
[*] NS ns1.megacorpone.com 51.79.37.18
[*] NS ns3.megacorpone.com 66.70.207.180
[*] NS ns2.megacorpone.com 51.222.39.63
[*] MX mail.megacorpone.com 51.222.169.212
[*] MX spool.mail.gandi.net 217.70.178.1
[*] MX fb.mail.gandi.net 217.70.178.217
249 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Reverse_DNS_lookup
250 (darkoperator, 2022), https://github.com/darkoperator/dnsrecon
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 135
Made in Morocco
Penetration Testing with Kali Linux
[*] MX fb.mail.gandi.net 217.70.178.216
[*] MX fb.mail.gandi.net 217.70.178.215
[*] MX mail2.megacorpone.com 51.222.169.213
[*] TXT megacorpone.com Try Harder
[*] TXT megacorpone.com google-site-
verification=U7B_b0HNeBtY4qYGQZNsEYXfCJ32hMNV3GtC0wWq5pA
[*] Enumerating SRV Records
[+] 0 Records Found
Listing 46 - Using dnsrecon to perform a standard scan
Based on the output above, we have managed to perform a successful DNS scan on the main
record types against the megacorpone.com domain.
Let’s try to brute force additional hostnames using the list.txt file we created previously for
forward lookups.
y
kali@kali:~$ cat list.txt
www
k
ftp
mail
owa
s
proxy
router
Listing 47 - List to be used for subdomoain brute forcing using dnsrecon
To perform our brute force attempt, we will use the -d option to specify a domain name, -D to
specify a file name containing potentialn subdomain strings, and -t to specify the type of
enumeration to perform, in this case brt for brute force.
i
kali@kali:~$ dnsrecon -d megacorpone.com -D ~/list.txt -t brt
z
[*] Using the dictionary file: /home/kali/list.txt (provided by user)
[*] brt: Performing host and subdomain brute force against megacorpone.com...
[+] A www.megacorpone.com 149.56.244.87
D
[+] A mail.megacorpone.com 51.222.169.212
[+] A router.megacorpone.com 51.222.169.214
[+] 3 Records Found
Listing 48 - Brute forcing hostnames using dnsrecon
Our brute force attempt has finished, and we have managed to resolve a few hostnames.
DNSEnum is another popular DNS enumeration tool that can be used to further automate DNS
enumeration of the megacorpone.com domain. We can pass the tool a few options, but for the
sake of this example we’ll only pass the target domain parameter:
kali@kali:~$ dnsenum megacorpone.com
...
dnsenum VERSION:1.2.6
----- megacorpone.com -----
...
Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
admin.megacorpone.com. 5 IN A 51.222.169.208
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 136
Made in Morocco
Penetration Testing with Kali Linux