# 第28章 运行级别脚本

## 28.1 引言
在Linux系统中，运行级别脚本是系统启动和停止服务的重要组成部分。这些脚本通常位于`/etc/rcN.d/`目录下，其中`N`表示不同的运行级别。通过了解和配置这些脚本，可以更好地控制系统的启动过程和服务管理。

## 28.2 确定当前的运行级别
要确定当前的运行级别，可以使用以下命令：
```sh
$ runlevel
```
输出示例：
```
2 3
```
第一列表示系统的前一个运行级别，第二列表示系统当前的运行级别，在这里是 `3`。

## 28.3 快速熟悉inittab
`inittab` 文件位于 `/etc` 目录下，用于配置系统的初始化进程 `init`。`init` 是系统启动的第一个进程，它负责根据 `inittab` 文件中的配置启动或停止相应的服务，并进入指定的运行级别。

`inittab` 文件的条目格式如下：
```
id:runlevels:action:process
```
- `id`：进程的唯一标识。
- `runlevels`：运行该进程的级别。
- `action`：告诉 `init` 如何处理对应的进程。常见的动作有 `wait` 和 `respawn`。
  - `wait`：当进程启动后等待其结束。
  - `respawn`：如果该进程不存在，则启动相应的进程；如果存在，则在进程终止后立即重新启动。
- `process`：实际要运行的命令。

例如：
```
15:5:wait:/etc/rc.d/rc 5
```
这行表示在运行级别 `5` 中执行 `/etc/rc.d/rc 5` 脚本。

## 28.4 运行级别
### 28.4.1 各种运行级别
Linux 系统包含七种运行级别，具体如下：

| 运行级别 | 用途 |
| --- | --- |
| 0 | 关机 |
| 1 | 单用户模式（维护模式） |
| 2 | 多用户模式，不带网络服务 |
| 3 | 多用户模式，带网络服务（默认） |
| 4 | 用户自定义模式 |
| 5 | 图形界面模式（X Window） |
| 6 | 重启 |

### 28.4.2 运行级别脚本的格式
`/etc/rcN.d/` 目录中的脚本通常是符号链接，指向实际的脚本文件。这些链接的命名规则如下：
- `Snn.name`：启动相应的服务。
- `Knn.name`：停止相应的服务。

其中 `nn` 是两位数字（00-99），用于确定启动或停止的顺序。例如：
```
S45.myscript
K23.named
```

### 28.4.3 安装运行级别脚本
要安装自己的运行级别脚本，需要完成以下步骤：
1. 编写脚本并确保其符合调用标准。
2. 将脚本放置于 `/etc/init.d/` 或 `/usr/sbin/init.d/` 目录中。
3. 在相应的 `/etc/rcN.d/` 目录中创建符号链接。

例如，假设有一个名为 `rc.audit` 的脚本，运行于级别 `3`、`4`、`5`，停止于级别 `6`、`2`、`1`，可以使用以下命令创建链接：
```sh
ln -s /etc/init.d/rc.audit /etc/rc3.d/S35audit
ln -s /etc/init.d/rc.audit /etc/rc4.d/S35audit
ln -s /etc/init.d/rc.audit /etc/rc5.d/S35audit
ln -s /etc/init.d/rc.audit /etc/rc6.d/K35audit
ln -s /etc/init.d/rc.audit /etc/rc2.d/K35audit
ln -s /etc/init.d/rc.audit /etc/rc1.d/K35audit
```

## 28.5 使用 inittab 启动应用程序
除了使用运行级别脚本，还可以通过修改 `inittab` 文件来启动应用程序。例如，要在运行级别 `3` 启动一个磁盘镜像检查脚本，可以在 `inittab` 文件末尾添加以下条目：
```
rc.diskchecker:3:once:/usr/local/etc/rc.diskchecker > /dev/console
```

## 28.6 启动和停止服务的其他方法
- **rc.local**：大多数系统在 `/etc` 目录下都有一个 `rc.local` 文件，可以在该文件中添加自定义的启动命令。
- **shutdown**：有些系统在 `/usr/sbin` 目录下有一个 `shutdown` 脚本，可以用来关闭某些服务。

## 28.7 小结
本章介绍了 Linux 系统中运行级别脚本的基本概念和配置方法。通过理解和配置这些脚本，可以更好地控制系统的启动过程和服务管理。