假设在第i次迭代后θ的估计值是θ(i)，我们希望新的估计值θ能使L(θ)增加，即
并逐步达到极大值。为此，考虑两者的差:
由于ln(x)是凹函数，且
把
看作一个整体。那么可以根据Jensen不等式，得到
所以
所以
令
则
注意，这里θ(i)是已知的，我们在前面讲过，这是第i次迭代后的参数值。对于一个学习问题，我们通常会初始化参数值，作为第一次迭代的输入参数值。
由于θ(i)是已知的，所以上式不等号两边都是关于θ的函数。
函数B(θ,θ(i))是L(θ)的一个下界，假设θ(i+1)可以使得B(θ,θ(i))达到极大，即
那么
因此，任何可以使B(θ,θ(i))增大的θ，也可以使L(θ)增大，于是问题就转化为了求解能使得B(θ,θ(i))达到极大的θ(i+1)，即
省去对θ最大化而言是常数（不影响计算）的项，
令
至此，我们成功把求不完全数据Y（观测数据Y也称不完全数据）的对数似然函数L(θ)=lnP(Y∣θ)极大化问题转化为了求：完全数据（观测数据Y和隐含状态Z连在一起称为完全数据）的对数似然函数L(θ)=lnP(Y,Z∣θ)关于在给定观测数据Y和当前参数θ下对未观测数据Z的条件概率分布P(Z∣Y,θ(i))的期望，也就是Q函数。
EM算法中的E(Expectation)指的就是上述步骤。而M(Maximization)指的就是求Q函数的极大值，这个极大值是可以通过求导的方式计算得到的。
推导完EM算法，我们现在回过头再看隐马尔可夫模型，将模型的学习问题代入EM算法。
将观测数据记做
隐含状态序列记做
完全数据是
用表示隐马尔可夫模型参数当前的估计值，θ是要极大化的模型参数。
EM算法E步：求Q函数
省去常数因子，则
于是
EM算法M步：极大化Q函数，求模型参数A，B，π
对于上式，可以对相加的各项分别极大化。第一项
这里N代表隐含状态总数，由于
所以可以用拉格朗日乘子法，写出拉格朗日函数：
上式对π_i求偏导数并令结果为0，解得
代回上面等式，得
Q函数第二项
状态转移概率矩阵中每一行的元素之和为1，所以可以利用具有约束条件的拉格朗日乘子法，这里N代表隐含状态总数。
对a_ij求偏导，令结果等于0，得到
带回上面式子，得到
Q函数最后一项：
每种状态的发射概率之和为1，同样利用拉格朗日乘子法，这里M表示观测集合元素总数，v_k表示观测状态。
对b_j(y_t)求偏导，令结果等于0，得到
对b_j(v_k)求偏导，令结果等于0，只有当y_t = v_k时，b_j(y_t)对b_j(v_k)的偏导数不为0，用I(y_t =
v_k)表示该偏导数，可以得到
呼～终于把学习问题推导完了。
###  概率计算问题（评估问题）
上述学习问题中的各项结果具体的计算，以及已知模型时，计算当前观测序列由已知模型生成的概率，都要用到概率计算问题中的前向-后向算法。算法比较简单，容易理解，这里就不再展开赘述了，感兴趣的读者可以查阅文章末尾的参考资料去了解。
上面这些内容，只是证明了可以通过计算，利用输入的训练数据（观测序列）得到可用的模型，再利用得到的模型可以反过来评估输入数据是否符合模型。
从头到尾完整推导下来，我们就可以很清晰的理解隐马尔可夫模型应用于Web参数异常检测的合理性了。
## 六、其他
开篇骰子的例子参考了《白话大数据和机器学习》中的示例，这个示例是我看过的几个讲解隐马尔可夫模型的示例中相对比较好的一个，所以选择了用这个示例来类比Web安全相关的参数异常检测问题。
由于参考了很多不同的资料，每份资料的数学公式符号和推导过程都略有不同，笔者在写作过程中尽量将符号统一以增强连贯性，便于理解。
后面如果有时间，打算再接着写一篇实践相关的文章，谈谈HMM算法在大数据实时计算场景下的具体实现以及架构设计。
行文仓促，为了更直白的说明问题，帮助读者理解，一些表述也许并不严谨。且推导过程对于严谨性的要求较高，难免出错。如有错误，欢迎指正。
参考资料：  
《统计学习方法》  
《白话大数据与机器学习》  
[《数据科学在Web威胁感知中的应用》](https://www.jianshu.com/p/942d1beb7fdd)  
[《基于机器学习的web异常检测》](https://www.cnblogs.com/alisecurity/p/6378869.html)  
[《语音识别中隐马尔可夫模型状态数的选取原则及研究》](https://wenku.baidu.com/view/979c64622379168884868762caaedd3383c4b590)  
[《语音识别中隐马尔可夫模型状态数的研究》](https://www.ixueshu.com/document/205aa064fbe7cef0318947a18e7f9386.html)  
[知乎:如何用简单易懂的例子解释隐马尔可夫模型？](https://www.zhihu.com/question/20962240)  
[徐亦达机器学习：Hidden Markov Model
隐马尔可夫模型(HMM)](https://www.bilibili.com/video/BV1BW411P7gV)
**漏洞悬赏计划：涂鸦智能安全响应中心（ ）欢迎白帽子来探索。**
**招聘内推计划：涵盖安全开发、安全测试、代码审计、安全合规等所有方面的岗位，简历投递sec#tuya.com，请注明来源。**