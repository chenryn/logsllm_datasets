### 6.2.2 估计聚合资源

在TAP（Traffic Aggregation Protocol）中，智能采样的原始流在时间间隔 \(\tau\)（例如一小时）内进行聚合。用于聚合的键可以是原始流键，也可以是更粗粒度的，例如BGP路由前缀。我们的目标是估计在时间间隔 \(\tau\) 内生成的聚合流数量。因此，我们需要确定在长度为 \(\tau\) 的时间段内，由经过智能采样的流呈现的独特键的数量（在所需的聚合级别上）。

假设给定的原始流 \(i\) 平均产生 \(f(n_i, t_i; N, T)\) 个具有相同键的测量流。如果我们能够计算出这些流中至少有一个通过智能采样的概率 \(q_i\)，那么聚合流形成的平均速率可以表示为：

\[
R_{s,agg} = \tau^{-1} \sum_{\kappa} \left(1 - (1 - q_i)^{I_\kappa}\right)
\]

其中，\(\kappa\) 表示出现在原始流中的聚合流键集合，\(I_\kappa\) 是与 \(\kappa\) 匹配的原始流集合。

我们可以通过以下方式来估算 \(q_i\)：如果 \(f_i > z\)，则没有采样误差。具体来说，我们可以使用以下公式进行估算：

\[
q_i \approx \min\left\{f(n_i, t_i; N, T), \frac{b_i}{z}\right\}
\]

### 7.3 应用流量记录量

基于RFC 3232[19]中指定的知名应用端口以及其他特定应用知识，我们对流量进行了按应用分类。共识别了2,267种不同的应用。其中有六种应用各自占总字节数的1%以上；表3列出了这些应用及其所占百分比，以及无法归因于任何应用的字节百分比。请注意，一个P2P应用几乎占了一半的流量。

| 应用程序 | 字节占比 (%) | 每MByte的流数 (N=10^3) | 每MByte的流数 (N=10) | 每MByte的流数 (N=10^2) | 每MByte的流数 (N=10^4) |
| --- | --- | --- | --- | --- | --- |
| Kazaa | 46.6 | 1.03 | 12.18 | 5.67 | 0.12 |
| Gnutella | 5.9 | 2.08 | 36.20 | 11.21 | 0.23 |
| Napster | 5.4 | 1.95 | 11.24 | 8.69 | 0.22 |
| WWW | 12.65 | 6.35 | 264.33 | 49.07 | 0.70 |
| 未识别 | 2.9 | 3.00 | 60.60 | 15.00 | 0.37 |
| VRML多用途 | 1.2 | 1.46 | 29.07 | 8.45 | 0.16 |
| DirectX游戏 | 1.1 | 2.48 | 47.55 | 14.70 | 0.28 |

表3：按应用程序分类的字节占比和每MByte的预测原始流数量（根据公式(10)计算），作为采样周期的函数。

使用公式(10)，我们估计了每个MByte原始流量产生的NetFlow记录数量，作为采样周期的函数。对于考虑的应用程序，显然通过包采样可以显著减少NetFlow记录的生成速率。不同应用程序之间的流记录归一化速率存在较大差异：注意WWW流量的高比率。这是因为用户主要运行的是Web客户端而不是服务器；他们的入站流量主要由HTTP请求和传输确认包组成。流出用户的Web流量预计会有较低的每流字节数，而每流的包数大致相同。对于最大的组成部分Kazaa，我们预计入站和出站流量之间的不对称性较小：类似链路的独立研究发现，入站和出站数据量大致相等。然而，尚不清楚这是否是因为个别用户充当了真正的对等点，即同时下载和提供内容，还是因为总体行为的平衡。这些结果强调了理解应用组合在估计流记录可能数量时的重要性。

### 7.4 智能采样流记录量

我们将定理3中关于智能采样记录生成速率的上限与公式(14)的估计值进行了比较。图6显示了这种比较，作为采样阈值 \(z\) 和五种不同采样周期 \(N\)（从1到10,000）的函数。我们使用原始未采样流记录的总字节率 \(B\) 来获得这些上限，并应用公式(10)来确定每个 \(N\) 的采样原始流速率 \(R\)。请注意，在实际应用中，这个数字可以直接从采样的NetFlow记录集中获得。曲线是通过对原始未采样流统计应用公式(14)得到的。对于每条曲线，边界基本上连接了初始和最终部分的投影。当 \(z\) 较大时，曲线趋于合并，因为此时大多数流都受到相同的智能采样 \(x_i < z\)，且 \(z\) 起到了每个采样流代表的平均字节数的作用。

\[
\begin{array}{c}
100000 \\
10000 \\
1000 \\
100 \\
\end{array}
\quad
\begin{array}{c}
x_i \\
\text{ferpPGBtsed:ruoh/s} \\
\end{array}
\]