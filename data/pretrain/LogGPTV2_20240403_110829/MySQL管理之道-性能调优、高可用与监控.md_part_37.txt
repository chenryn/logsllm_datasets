servicecmanstop
servicergmanagerstop
与启动集群服务刚好相反，关闭 RHCS 集群的命令为：
servicergmanagerstart
clusvcadm-s-m
---
## Page 281
好于DRBD，因为它连接的是共享存储，性能要好于普通磁盘，且数据是一份，不需要通
7.4MySQL高可用集群HA解决方案的测试评估
以接管，两台机器不能同时在线提供业务，所以它们的可扩展性不好。在性能上，RHCS要
台机器处于active状态，另一台机器处于 standby状态，只有当一台机器岩机后，备机才可
细信息。
之释放。
细信息。在MySQL关闭后，与服务相关的集群资源（如虚拟IP、应用程序服务脚本）也随
reruice:eyso1
Service Name
281-8-88-21
uste
上面介绍了四种架构的安装部署方式，相信大家已经熟悉了，DRBD 和RHCS都是一
（4）切换某个应用服务
可以通过/var/log/messages和/var/log/cluster/rgmanager.log文件查看重启应用服务的详
（3）重启某个应用服务
可以通过/var/log/messages和/var/log/cluster/rgmanager.log文件查看关闭应用服务的详
此时，MySQL服务运行在192.168.8.101这台主机上。
4.监控RHCS集群状态（如图7-28所示）
例如，要将节点192.168.8.102的服务切换到节点192.168.8.101上，操作如下：
可以通过如下方式将一个应用服务从一个节点切换到另一个节点：
Member192.168.8.102 trying torestart service:mysql..Success
[root@node2~]# clusvcadm-Rmysql-m192.168.8.102
例如，要重启节点192.168.8.102上的MySQL服务，操作如下：
可以通过如下方式重启某个节点的应用服务：
service:mysqlisnowrunningon192.168.8.101
Trying torelocate service:mysql to192.168.8.101...Success
clusvcadm-r-m
clusvcadm-R-m
tatus
图7-28RHCS 集群状态
Owner (Last)
192.168.8.101
 nine, gas,rgager
Status
第7章
目前流行的4种高可用架构·267
---
## Page 282
268·第三部分高可用集群管理篇
和MySQL5.5的岩机恢复时间进行了对比。
换不过来，导致前端业务无法访问。针对这个问题，我做了下面的测试，针对MySQL5.1
的问题，机器岩机切换以后，另一台机器从存储里读取到数据继续提供服务，但有一个致
对于Replication+HA方案来说，在安全上可以做到最少丢失数据，
过网络复制到另一台机器上，不过如果存储故障了，那么就彻底“杯具”了。这套方案相
更久（这依赖于缓冲地、脏页面比例、TPS等因素）。这样在短时间（5分钟）内集群会切
是InnoDB，那么它需要恢复中继日志里的数据（前滚再回滚），恢复可能需要40分钟或者
命的问题就是宕机后的恢复时间，如果你是采用MyISAM引擎，那么可以忽略不计，如果
对于MySQL5.1，耗时近4小时，如图7-29所示。
以下是恢复时间：
1200秒后，强杀MySQL进程，命令如下：
Sleep1200;pkill-9mysqld
600个并发连接，最大请求数9亿个（查询、更新、插入、修改），表的记录数1000
需要说明的是，为了更能体现出岩机恢复时间，这里加大了压力测试参数：
-mysql-socket=/tmp/mysql.sockrun
-mysql-port=3306
-mysql-table-engine=innodb
sysbench--test=oltp
mysql-db=test
mysql-host=192.168.110.218
num-threads=600
oltp-table-size=10000000
mysql-user=admin
ysql-password=123456
tra
图7-29MySQL5.1的恢复时间
28
，因为它不存在主从延时
7071
72 737475767778 79 80
---
## Page 283
台数据库，这样也减缓了同步复制延时的问题，关于这部分内容将在最后一章详细介绍。
现了Cobar中间件，它解决了大量写操作，避免了一台机器不堪重负，把压力分担给了多
建多台slave去负载读，但写操作还是在一台机器上，阿里巴巴考虑到了这个问题，于是出
带的脚本切换VIP到另一台 slave上继续提供服务。读写分离，仅仅减缓了读操作，可以搭
MySQL-MMM架构是个非常不错的选择，这样的话，一台slave岩机后，会通过MMM自
台机器负责写，一台机器负责读，采用Keepalived方案即可，如果有多台slave，那么采用
分离，而对于Replication+HA方案来说，备机可以提供业务，在扩展性上更强，如果是一
DRBD集群架构方案，要将MySQL版本升级为5.5。
注意
随着数据的增长，业务量变大，一台机器提供读写会出现瓶颈，需要在程序端做读写
结论：从恢复时间上来说，MySQL5.5比MySQL5.1快了240倍，所以采用RHCS和
对于MySQL5.5，耗时1分17秒，如图7-30所示。
请仔细观察错误日志里的时间。
  18  
prise-c
图7-30MySQL5.5的恢复时间
id BC7583, 4 roes to uio
action
-5.5.20/data
第7章目前流行的4种高可用架构·269
---
## Page 284
theether.org/pssh/。下面写了一个批量部署 ssh 私钥认证的脚本。
器的功能，其原理是先建立ssh私钥认证，然后批量管理。它的官网地址是http://www.
这里就要用到pssh工具了，它是由AndrewMcNabb写的开源软件，实现了批量管理服务
8.1
给大家介绍一个通过命令行有效地管理大量Linux服务器的工具一
务器，可以一台一台地登录执行命令，可如果是上百台呢？显然这种做法不可取，现在就
的Linux服务器成为系统管理员、数据库管理员非常关心的一个问题。如果只有十几台服
batch_sshkey.sh
在日常工作中，管理服务器是个力气活，如果人工一台一台地处理，效率实在低下。
spawn sshroot@Sip"/tmp/remote_operate.sh""
目前越来越多的企业选择使用Linux服务器，正因为如此，如何方便高效地管理大量
expect-c"
spawnscp/root/.ssh/authorized_keys/root/remote_operate.shroot@Sip:/tmp/
(-noo)s=d
foriin'catip.txt'
cat/root/.ssh/id_rsa.pub>/root/.ssh/authorized_keys
expect-c"
#!/bin/bash
开源工具 pssh 的使用方法
expect{
expect{
批量管理服务器
第8章
\"*yes/no*\"(send\"yes\r\";exp_continue)
pssho
---
## Page 285
用手工输人密码。脚本内容如下：
remote_operate.sh这个脚本是用来把认证文件复制到客户端里的，最终实现远程登录不
执行完以后，会看到如下输出结果，如果是[SUCCESS]代表命令成功执行完毕。
然后批量执行hostname 命令，如下所示：
[9]16:08:36[SUCCESS]192.168.110.138 22
[4]16:08:36[SUCCESS]192.168.110.20222
#pssh-h other.txt-l root-ihostname
下面介绍PSSH工具使用方法，很简单，命令如下所示：
最后运行batch_sshkey.sh即可。
cp/tmp/authorized_keys/root/.ssh/
if [!-d /root/.ssh ];then
#!/bin/bash
ip.txt（前面是IP，后面是密码，用冒号分割）
按照下面的格式把客户端机器的IP写人ip.txt文件里：
batch_sshkey.sh脚本会调用ip.txt文件，做ssh私钥认证。
PSA-HOST-105
[8]16:08:36[SUCCESS]192.168.0.10522
PSA-Host-106
[7] 16:08:36[SUCCESS] 192.168.0.106 22
[5]16:08:36[SUCCESS]192.168.251.43 22
EnvFactoryServer202
[3] 16:08:36[SUCCESS]192.168.110.20322
hadoop-secondnamenode
[2]16:08:36[SUCCESS]192.168.110.12322
[1] 16:08:36[SUCCESS] 192.168.110.122 22
192.168.8.24:456789
192.168.8.23:123456
done
python setup.py install
cdpssh-1.4.3
tar zxvf pssh-1.4.3.tar.gz
yum install *python*
mkdir/root/.ssh
16:08:36[SUCCESS]192.168.251.42 22
adoop-namenode
HOST-42
ver203
\"*yes/no*\"{send\"yes\r\"; exp_continue}
第8章批量管理服务器·271
---
## Page 286
272·第三部分高可用集群管理篇
执行完以后，会看到如下输出结果，如果是[SUCCESS]代表命令成功执行完毕。
接着，批量复制本地文件nrpe.tgz到远端服务器，命令如下：
下面是列出的客户端IP地址：
#more other.txt
按照下面的格式把客户端机器的IP写入other.txt文件里：
#pscp-hother.txt-Iroot/home/soft/nrpe.tgz/usr/local/
SC-Host-101
[18] 16:08:37[SUCCESS] 192.168.0.101 22
[16] 16:08:36 [SUCCESS] 192.168.0.100 22
[12] 16:08:36 [SUCCESS] 192.168.110.140 22
[11] 16:08:36 [SUCCESS]192.168.110.137 22
[10] 16:08:36 [SUCCESS] 192.168.110.252 22
192.168.0.106
SC-Host-100
[15]16:08:36[SUCCESS]192.168.110.141 22
[14] 16:08:36 [SUCCESS] 192.168.110.213 22
hadoop-datanode3
192.168.0.105
192.1
192.168.0.101
192.168.0.100
18]16:11:30[SUCCESS]192.168.251.42 22
10]
[9]16:11:26[SUCCE
8
[4]16:11:23[SUCCESS]192.168.110.1402
12
[1]16:11:21[SUCCESS]192.168.110.12322
[17]16:08:36[SUCCESS]192.168.110.12422
hadoop-datanode6
nadoop-datanode4
[13]16:08:36[SUCCESS]192.168.110.13922
hadoop-datanode2
E
159
13]
9
1
16:11:26
16:11:25
16:11:23[
16:11:22[SUCCESS]192.168.251.4322
16:11:30[SUCCESS]
16:11:29[SUCCESS] 192.168.110.13722
16:11:28[SUCCESS] 192.168.110.124 22
16:11:27[SUCCESS]1
16:11:25
168.251.42
16:11:28[SUCCESS]192.168.0.100 22
16:11:28
[SUCCESS]192.168.0.10122
[SUCCESS]192.168.110.138
[SUCCESS]
CESS]192.168.110.122 22
1192.168.0.10622
192.168.110.25222
192.168.110.141
192.168.
---
## Page 287
及密码、密钥的管理，以及服务器人库管理等功能。程序界面截图如图8-1所示。
服务器管理，同时可根据服务器名称方便地进行分类筛选。有需求的话还可以加人用户名
便地将执行返回的结果（单行结果或完整结果）导出到文件中保存，使用IP列表文件进行
传文件、批量获取服务器当前状态信息等功能，无需在服务器端安装任何程序，同时可方
8.2
此工具是基于SSH协议对服务器进行批量管理的小工具，支持批量执行命令、批量上
此工具由我的前同事李才荣提供，分享给大家。
192.168.110.203
192.168.110.252
192.168.110.141
192.168.110.140
192.168.110.139
192.168.110.138
192.168.110.137
192.168.110.124
192.168.110.123
192.168.110.122
192.168.110.213
192.168.110.202
自己编写的SSH服务器批量管理工具
签注：宽成
执行令
发送文件
xgk
olst.bt
图8-1
uptime
1set,
程序界面
agoi
?
第8章批量管理服务器·273
---
## Page 288
274·第三部分高可用集群管理篇
图8-4的“关键字”下拉框）。
载IP列表”下拉框选择其他IP列表文件。
图8-4中靠左边的四个选择按钮不用多解释，其中“批量选择”用于对服务器列表中高
备注：备注栏显示命令执行的状态，可根据成功和失败的状态来进行批量选择（通过
口执行结果：执行命令后显示返回的结果的第一行，在某些情况下（比如，比较文件
口服务器IP：需要连接的服务器IP地址。
口服务器名称：ip列表文件中对服务器的注释说明，用下划线分隔便于分级检索（见
全选全反达批量选择关键字
图8-3是服务器列表框，默认加载程序目录下的iplist.txt文件，可通过图8-4中的“重
四个文本输入框分别是：端口、用户名、密码、命令输入框。
口发送文件：用于对在服务器列表中勾选的服务器发送本地的文件，方便将本地写好
口执行命令：月
在该功能中：
界面功能说明如图8-2所示。
的MD5值）会很方便，完整的结果在完整结果显示框中（如图8-6所示）显示。
图8-4关键字说明)。
的脚本等文件上传至服务器。
执行命令
发送文件
喜
用于对在服务器列表中勾选的服务器执行指定的命令。
22
168
xglc
56.12
56.12
图8-2端口、用户名、密码、命令输入框
重载P列表编指当前P列表历史命令状态：没有选择执行命令的服务器，请选择！
图8-4功能选择模块
图8-3执行结果
uptim
司
1user,
lcad
0.00
0.00
豆
8
---
## Page 289
亮的服务器进行勾选。下面说明一下后面几个按钮和下拉框中选择项的含义：
此程序为unux服务器批里管理工具：如果您在使用中发现问题或是有什么建议，请联系作者：李才荣Emal:xglkro163.com
备注：完刚
口关键字：此下拉框默认是一个“错误”项，如果选择错误项，将去掉所有勾选状态，
口状态信息：用于获取服务器当前的状态信息，结果显示在结果框中，主要包括以下
口完整结果显示框：服务器列表中只会显示返回结果的第一行，完整的结果将显示在
口状态：执行过程中相关信息会显示在“状态：”后面（如图8-6所示)。
口历史命令：在结果框中列出本次开启程序后执行过的所有历史命令及执行时间，
口编辑当前IP列表：此按钮可打开当前加载的IP列表文件进行编辑，在编辑保存后，
口重载IP列表：此下拉框列出程序所在目录下所有扩展名为txt的文件，可以将不同
结果框中，双击服务器列表中的服务器即可在结果框中显示该服务器的完整结果。
重新在下拉框中选择列表名称重载一下即可。
○网络设备及流量信息
OCPU/内存信息
信息：
用空格或tab键隔开）。
列表文件即可加载，IP列表文件的格式如图8-5所示（IP地址和服务器名称中间可
类型的服务器分别放人不同的txt文件中，需要操作的时候从下拉框中选择相应IP
拉框中选择关键字即可将包含所选关键字的服务器置为勾选状态。
会把所点行的服务器名称以“
○磁盘信息
图8-6执行结果状态信息
图8-5IP列表
66
为分隔符拆解成关键字填人关键字下拉框中，从下
安安安安
web
ache
第8章批量管理服务器·275
状态信息导出果
---
## Page 290
276·第三部分高可用集群管理篇
此工具在配书光盘里。
口导出结果：将服务器列表中的内容导出至文件，可以选择导出单选结果或完整结果，