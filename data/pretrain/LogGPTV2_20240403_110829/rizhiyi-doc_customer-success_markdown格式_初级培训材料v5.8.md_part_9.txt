e 星期 数字 星期二 e：2 ee:02
E 星期 文本 星期二 E：Tue EEEE：Tuesday
M 月份 月 七月 M:7 MM:07 MMM:Jul MMMM:July
d 一个月的第几天 数字 第9天 d:9 dd:09
84
日志学院
H 0-23小时 数字 8点 H:8 HH: 08
m 0-59分钟 数字 8分 m:8 mm:08
s 0-59秒 数字 8秒 s:8 ss:08
S 0-999毫秒 数字 888毫秒 SSS:888
z 时区 文本 zzz:PST zzzz:Pacific Standard Time;
Z: +0800; ZZ: +08:00; ZZZZ:
Z 时区 时区
America/Los_Angeles
7.3 字段提取实例
了解了正则解析及时间戳识别，就可以进行简单的字段提取了。下面我们将通过自定义解
析规则，实现Linux messages日志的解析。
新建自定义解析规则的流程大致如下：
1、 进入日志易系统à设置à资源（字段提取），新建字段提取规则；
2、 定义规则名称、Logtype，输入一条日志样例（手动从日志源复制，或使用日志易自带
的日志搜索功能添加一条日志样例）；
3、 选择解析规则为“正则解析”，来源字段为“raw_message”；
4、 输入相应的正则表达式，通过下面的“解析”按钮调试完成效果。可依照先后顺序，
逐段添加并测试正则规则，直到整个正则表达式完成为止；
5、 时间戳一般为日志解析必提字段，时间戳提取完毕后，还需要时间戳进行识别，将不
规则的时间戳转化为标准Unix格式的时间戳；
6、 使用检索验证功能（该功能在解析规则页面的最底部，使用方式见7.5小节批量验证部
分），搜索日志，验证解析规则与日志的匹配程度；
7、 验证成功后点击下一步，将新建的解析规则与appname、tag进行绑定。
85
日志学院
86
日志学院
注：
1、 日志提取规则不必提取全部的日志字段：
关于nginx错误日志，由于平时使用较少，不用将该日志的所有字段都解析出来，只
要酌情提取平常可能会用到的字段即可。需要使用时，按关键字进行全文检索即可。
因为解析的字段较多时，会对系统性能造成影响，不常使用的字段，只要使用时再做
提取即可。
87
日志学院
而像nginx访问日志，其与业务的关联较多，用到的分析场景也较多，这种情况，就
需要将各字段信息全部提取。日志分析的价值也凝聚于此。
2、 规则（logtype）与appname、tag的关系建议为1对多：
因为日志入库时，会使用日志的appname、tags和和配置的appname、tag匹配；
匹配到多个规则，只用第一条规则；
没找到对应规则，用内置的规则(json, apache, mysql等)。
3、 appname和tag的匹配原则不同：
日志的appname需要与logtype所指定的appname完全匹配；
日志的tag有多个，只要有一个能匹配到配置的tag就能匹配；
appname和tag同时匹配才执行对应的规则。
4、 时间戳为日志必须要提取的字段。
由于我们的nginx错误日志在入库时已经被系统自动识别出了时间戳，所以上面的解
析中，timestamp字段其实是不用抽取的。当日志入库时没有被系统识别出时间戳，如我
们上面的messages日志，就需要在字段解析规则中抽取出时间戳。
7.4 划选正则
为帮助用户实现正则解析，日志易提供鼠标划选自动生成正则表达式功能: 点击划选辅助
即可使用。
88
日志学院
用鼠标划选字段，然后填写对应的字段名，字段命名成功后即高亮显示。重新点击高亮部
分取消划选。 需要提醒的是，辅助划选功能并非十分精确，如果一条样例生成的正则不太
对，可以点击添加多个日志样例，使生成的正则表达式更精准。
7.5 解析验证
批量验证
完成所有解析规则配置后，可以点击“使用检索日志验证”，页面底部的事件表格左侧将
出现成功/失败标记，以及每条样例日志的解析耗时：
点击“字段”标签，下拉框选择任一字段名，可以查看在最近100条日志中，该解析规则
提取出来的字段值统计排行。
可以通过“全部日志，解析成功，解析失败”下拉框过滤被验证的事件。并在解析失败的
事件集上重新点击 “选为日志样例”，替换之前的“日志样例”文本框：
89
日志学院
如果没有“解析失败”的日志，表示验证规则全部解析成功，点击“下一步”，填写
“appname”和“tag”，保存解析规则即可。
搜索验证
此外，还可以通过搜索新入库的日志判断解析规则是否生效。可通过查看该日志的logtype
是否为other判断该日志有没有被解析，被解析的日志的logtype会更新为该日志所走的
解析规则的logtype名称，没有被解析的日志的logtype则为other。
新入库的linux访问日志会走新的解析规则。所以观测日志是否解析成功，需要查看新入库
的日志的logtype。可通过 appname:linux tag:messages | stats count() by logtype查看最新
入库的日志的解析情况，如下图。
上图other为1，说明有12条日志中有一条解析失败。
可通过appname:linux tag:messages logtype:other搜索解析失败的日志，并复制日志到解
析规则界面，研究该日志为何解析失败，并以此完善我们的解析规则。
90
日志学院
注意：日志解析规则开启后，入库的日志匹配到该解析规则才会被解析。上图中未解析的
规则明显是入库之前的未解析日志，这些日志的logtype与解析规则无关。使用搜索验证
解析规则应以日志解析规则开启后入库后的日志为准。
本章完。更多日志解析内容可以参考以下材料：
1、日志易其他字段提取规则：《日志易数据接入手册》第3章节
本章习题：
如果不使用默认解析规则，或默认的apache解析规则不能解析当前的Nginx日志，那么
该Nginx日志该如何解析？请新建解析规则，完成上一章节接入的Nginx日志的解析。
思考：
对Nginx日志做完正则解析及时间戳识别之后，Nginx日志的解析是否就算完成了？客户
常常有统计访问IP来源的需求，这个需求需要怎么实现呢？
91
日志学院
八、简单日志分析
8.1 统计菜单视图
每次搜索，日志易都会生成简单直观的时间序列趋势图，这是搜索时间范围内所有索引日
志事件的直方图，你可以利用直方图比较不同时间点的日志属性。
如果需要更多统计及可视化功能，可以使用统计视图和报表功能。
日志易统计视图分为两种：统计菜单视图和高级搜索视图。在本章中，我们将为您详细介
绍如何使用统计菜单视图，即通过搜索结果页的“统计”菜单进行简单的事件统计（即4.4
小节所使用的分析方式）。
也可以在趋势图中通过建立透视表视图，进行多个字段的统计分析（详情请参考产品文档
《日志易使用手册》3.3小节）。
92
日志学院
点击搜索页面中的“统计”，您会看到扩展后的统计视图页面。进入统计视图后，左侧展示
11种不同的统计功能。
请注意，只有在搜索后才能对搜索结果进行统计及可视化展现。
以解析后的Nginx日志为例，试一下下面的功能吧！
8.1.1 菜单视图示例
事件计数统计
事件计数可以绘制单个事件随着时间推进的事件数变化情况，也可选中多个字段，将多个
事件的变化情况进行对比。
选择“展现方式”和“字段”，图中将会展示该事件随时间变化的统计数。可依次选取多个字段
比较查看。每选取一次图形下方会展示该字段名称，点击相应字段的删除符号可以去除该
字段。勾选“独立数统计”可以进行去重统计。
93
日志学院
上图为今天Nginx访问IP事件数随时间的变化趋势图，即今天访问量趋势。
上图叠加了Nginx访问路径的独立事件数（去重后）的访问趋势。图中可以看出，10点至
11点之间访问量较高，但访问路径事件数较少，说明大量用户访问了网站的相同路径，此
处可能存在暴力破解网站的可能，需要引起管理员的关注。
可将以上图形保存为趋势图，之后添加到仪表盘中，用作直观展示。
94
日志学院
时间分段统计
时间分段可能更直观地观测到时间段的事件变化状况。可用于上下午事件数对比、昨日与
今日时间数对比、季节事件数对比、营销时间段与非营销时间段事件数对比。
时间分段统计可与事件计数统计共同使用，用作按时间趋势展示的事件计数的直观数据。
选择“时间分段统计”，选取字段，依次设定时间分段。需要提醒的是时间分段范围必须包
含在您搜索的时间范围中。系统将会按时间统计该事件的计数，同时进行环比统计。下面
的例子帮您了解这一功能：
• 用nginx.clientip进行字段过滤
• 时间范围选择今天
• 将时间分段分别设置为昨日0点至昨日中午12点和昨日中午12点至今日0点
• 点击“生成”
上图为今日上下午Nginx访问事件数对比图。页面展示两个时间分段的柱状图，将鼠标悬
停在柱状图上方时还会会显示具体的统计信息。需要提醒的是，图表展示会将您设定的时
间根据时序重新排序。
注：对比今日上下午数据会受当前时间点影响，如下午1点统计的话，下午的数据会明显
缺失，所以这里以昨日数据为参考。
本节习题：你能根据下一小节中的apache日志的演示案例，推断出后面各个视图的使用方
法并说出该视图的应用场景吗？各个试图做出一个案例，保存为趋势图后新建Nginx仪表
盘中，将这些图形都添加到仪表盘中吧。
95
日志学院
思考：你能根据下一小节中的apache日志的演示案例，推断出后面各个视图的使用方法并
说出该视图的应用场景吗？
8.1.2 其他菜单试图
数值分段统计
选择“数值分段统计”是统计数值字段在各数值段的分布情况。选择字段后自行填写数值分
段范围。您可以点击“添加数值分段”产生新的分组。最后点击“生成图形”会生成柱状图。
例如：
• 选择数值字段apache.resp_len
• 数值分段设置为1到100、100到500、500到1000、以及0到1
• 点击生成图表
页面将为您展示相应的柱状图。需要提醒的是，图表展示会将您设置的数值依据数值大小
重新排序。
时间直方图
选择时间直方图，只需要设定“时间间隔”——在方框内填入数字，再选择合适的时间单
位，完成后点击“生成图形”，即可看到相应的直方图。
• 搜索过去30分钟的事件
96
日志学院
• 将时间间隔设置为“1分组”
• 点击“生成图表”
数值直方图
跟时间直方图类似，您只需要选定字段，设定“数值间隔”，点击生成图表即可看到关于该
数值字段的。需要提醒的是数值间隔设定值过小会造成生成的图表不可用。因为统计数值
在数量上差距巨大，例如下图：
97
日志学院
字段值分类统计
点击选择“字段值分类统计”您将会看到对于某一字段的具体分类统计。选择字段后您可以
选择不同的展现方式。页面会显示搜索结果中该字段的所有值的比例，并生成相应的统计
表格，显示出现次数最多的前几个字段值名称及统计次数。
例如：
• 字段选择“apache.ua”
• 展示方式选择“饼状图”
• 选择显示top5值
• 点击确定
即可看到统计图表：
98
日志学院
字段数值统计
字段数值统计是对字段的数值属性进行统计分析的功能，统计方式目前支持“总计/平均值/
最大值/最小值/”四种选项。
例如：
• 在下拉框中选择Y轴展示的数值型字段“apache.resp_len”
• “分组字段”中选择“apache.clientip”
• “分组字段值”中选择Top5
• 统计方式选择平均值
• 图形选择“曲线图”
• 时间桶填写1分钟
如下图可以看到每个IP的resp_len平均值的分布情况：
累计百分比
“累计百分比统计”是对数值字段的数值大小分布进行的统计功能，系统默认的百分比分段
设置为25%，50%，75%，95%，99%，您也可以调整或增加新的分段
• 字段选择apache.resp_len
• 使用默认的百分比分段
• 点击“生成结果”
您也可以选择多个数值字段，作为统计对比：