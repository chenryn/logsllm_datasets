### 日期和时间格式

- **星期**
  - 数字表示：`e`（例如，星期二为2）
  - 文本表示：`E`（例如，星期二为Tue），`EEEE`（例如，星期二为Tuesday）

- **月份**
  - 数字表示：`M`（例如，七月为7），`MM`（例如，七月为07）
  - 文本表示：`MMM`（例如，七月为Jul），`MMMM`（例如，七月为July）

- **一个月的第几天**
  - 数字表示：`d`（例如，第9天为9），`dd`（例如，第9天为09）

- **小时**
  - 数字表示：`H`（24小时制，例如，8点为8），`HH`（24小时制，例如，8点为08）

- **分钟**
  - 数字表示：`m`（例如，8分为8），`mm`（例如，8分为08）

- **秒**
  - 数字表示：`s`（例如，8秒为8），`ss`（例如，8秒为08）

- **毫秒**
  - 数字表示：`S`（例如，888毫秒为888），`SSS`（例如，888毫秒为888）

- **时区**
  - 简写：`z`（例如，PST），`zzzz`（例如，Pacific Standard Time）
  - 标准格式：`Z`（例如，+0800），`ZZ`（例如，+08:00）
  - 完整时区名称：`America/Los_Angeles`

### 字段提取实例

了解了正则解析及时间戳识别后，就可以进行简单的字段提取。下面我们将通过自定义解析规则，实现Linux messages日志的解析。

**新建自定义解析规则的流程如下：**

1. 进入日志易系统 -> 设置 -> 资源（字段提取），新建字段提取规则。
2. 定义规则名称、Logtype，并输入一条日志样例（手动从日志源复制，或使用日志易自带的日志搜索功能添加一条日志样例）。
3. 选择解析规则为“正则解析”，来源字段为“raw_message”。
4. 输入相应的正则表达式，通过下方的“解析”按钮调试完成效果。可以逐段添加并测试正则规则，直到整个正则表达式完成为止。
5. 时间戳一般为日志解析必提字段，提取完毕后，还需要将不规则的时间戳转化为标准Unix格式的时间戳。
6. 使用检索验证功能（该功能在解析规则页面的最底部，使用方式见7.5小节批量验证部分），搜索日志，验证解析规则与日志的匹配程度。
7. 验证成功后点击下一步，将新建的解析规则与appname、tag进行绑定。

### 注意事项

1. **日志提取规则不必提取全部的日志字段**：
   - 对于nginx错误日志，由于平时使用较少，不需要解析所有字段，只需酌情提取常用的字段即可。需要使用时，按关键字进行全文检索即可。解析过多字段会对系统性能造成影响。
   - 对于nginx访问日志，由于其与业务关联较多，分析场景也较多，需要提取各字段信息以体现日志分析的价值。

2. **规则（logtype）与appname、tag的关系建议为1对多**：
   - 日志入库时，会使用日志的appname、tags与配置的appname、tag匹配。
   - 匹配到多个规则时，只用第一条规则。
   - 没找到对应规则时，使用内置规则（如json, apache, mysql等）。

3. **appname和tag的匹配原则不同**：
   - 日志的appname需要与logtype所指定的appname完全匹配。
   - 日志的tag有多个，只要有一个能匹配到配置的tag就能匹配。
   - appname和tag同时匹配才执行对应的规则。

4. **时间戳为日志必须要提取的字段**：
   - 如果日志入库时已被系统自动识别出时间戳（如nginx错误日志），则无需再抽取timestamp字段。
   - 如果日志入库时没有被系统识别出时间戳（如messages日志），则需要在字段解析规则中抽取出时间戳。

### 划选正则

为了帮助用户实现正则解析，日志易提供鼠标划选自动生成正则表达式功能。点击划选辅助即可使用。用鼠标划选字段，填写对应的字段名，字段命名成功后即高亮显示。重新点击高亮部分取消划选。需要注意的是，辅助划选功能并非十分精确，如果一条样例生成的正则不太对，可以点击添加多个日志样例，使生成的正则表达式更精准。

### 解析验证

**批量验证**：

完成所有解析规则配置后，可以点击“使用检索日志验证”。页面底部的事件表格左侧将出现成功/失败标记，以及每条样例日志的解析耗时。点击“字段”标签，下拉框选择任一字段名，可以查看在最近100条日志中，该解析规则提取出来的字段值统计排行。可以通过“全部日志，解析成功，解析失败”下拉框过滤被验证的事件。并在解析失败的事件集上重新点击 “选为日志样例”，替换之前的“日志样例”文本框。

如果没有“解析失败”的日志，表示验证规则全部解析成功，点击“下一步”，填写“appname”和“tag”，保存解析规则即可。

**搜索验证**：

此外，还可以通过搜索新入库的日志判断解析规则是否生效。可通过查看该日志的logtype是否为other判断该日志有没有被解析。被解析的日志的logtype会更新为该日志所走的解析规则的logtype名称，没有被解析的日志的logtype则为other。

新入库的linux访问日志会走新的解析规则。所以观测日志是否解析成功，需要查看新入库的日志的logtype。可通过 `appname:linux tag:messages | stats count() by logtype` 查看最新入库的日志的解析情况。如果有未解析的日志，可通过 `appname:linux tag:messages logtype:other` 搜索解析失败的日志，并复制日志到解析规则界面，研究该日志为何解析失败，并以此完善我们的解析规则。

注意：日志解析规则开启后，入库的日志匹配到该解析规则才会被解析。上图中未解析的规则明显是入库之前的未解析日志，这些日志的logtype与解析规则无关。使用搜索验证解析规则应以日志解析规则开启后入库后的日志为准。

### 本章习题

如果不使用默认解析规则，或默认的apache解析规则不能解析当前的Nginx日志，那么该Nginx日志该如何解析？请新建解析规则，完成上一章节接入的Nginx日志的解析。

思考：对Nginx日志做完正则解析及时间戳识别之后，Nginx日志的解析是否就算完成了？客户常常有统计访问IP来源的需求，这个需求需要怎么实现呢？

### 简单日志分析

#### 统计菜单视图

每次搜索，日志易都会生成简单直观的时间序列趋势图，这是搜索时间范围内所有索引日志事件的直方图，你可以利用直方图比较不同时间点的日志属性。如果需要更多统计及可视化功能，可以使用统计视图和报表功能。

日志易统计视图分为两种：统计菜单视图和高级搜索视图。在本章中，我们将为您详细介绍如何使用统计菜单视图，即通过搜索结果页的“统计”菜单进行简单的事件统计（即4.4小节所使用的分析方式）。也可以在趋势图中通过建立透视表视图，进行多个字段的统计分析（详情请参考产品文档《日志易使用手册》3.3小节）。

点击搜索页面中的“统计”，您会看到扩展后的统计视图页面。进入统计视图后，左侧展示11种不同的统计功能。请注意，只有在搜索后才能对搜索结果进行统计及可视化展现。

以解析后的Nginx日志为例，试一下下面的功能吧！

##### 8.1.1 菜单视图示例

- **事件计数统计**：
  - 事件计数可以绘制单个事件随着时间推进的事件数变化情况，也可选中多个字段，将多个事件的变化情况进行对比。
  - 选择“展现方式”和“字段”，图中将会展示该事件随时间变化的统计数。可依次选取多个字段比较查看。每选取一次图形下方会展示该字段名称，点击相应字段的删除符号可以去除该字段。勾选“独立数统计”可以进行去重统计。

- **时间分段统计**：
  - 时间分段可能更直观地观测到时间段的事件变化状况。可用于上下午事件数对比、昨日与今日时间数对比、季节事件数对比、营销时间段与非营销时间段事件数对比。
  - 时间分段统计可与事件计数统计共同使用，用作按时间趋势展示的事件计数的直观数据。
  - 选择“时间分段统计”，选取字段，依次设定时间分段。需要提醒的是时间分段范围必须包含在您搜索的时间范围中。系统将会按时间统计该事件的计数，同时进行环比统计。

- **数值分段统计**：
  - 选择“数值分段统计”是统计数值字段在各数值段的分布情况。选择字段后自行填写数值分段范围。您可以点击“添加数值分段”产生新的分组。最后点击“生成图形”会生成柱状图。

- **时间直方图**：
  - 选择时间直方图，只需要设定“时间间隔”——在方框内填入数字，再选择合适的时间单位，完成后点击“生成图形”，即可看到相应的直方图。

- **数值直方图**：
  - 跟时间直方图类似，您只需要选定字段，设定“数值间隔”，点击生成图表即可看到关于该数值字段的。需要提醒的是数值间隔设定值过小会造成生成的图表不可用。因为统计数值在数量上差距巨大。

- **字段值分类统计**：
  - 点击选择“字段值分类统计”您将会看到对于某一字段的具体分类统计。选择字段后您可以选择不同的展现方式。页面会显示搜索结果中该字段的所有值的比例，并生成相应的统计表格，显示出现次数最多的前几个字段值名称及统计次数。

- **字段数值统计**：
  - 字段数值统计是对字段的数值属性进行统计分析的功能，统计方式目前支持“总计/平均值/最大值/最小值”四种选项。

- **累计百分比**：
  - “累计百分比统计”是对数值字段的数值大小分布进行的统计功能，系统默认的百分比分段设置为25%，50%，75%，95%，99%，您也可以调整或增加新的分段。

### 本节习题

你能根据下一小节中的apache日志的演示案例，推断出后面各个视图的使用方法并说出该视图的应用场景吗？各个试图做出一个案例，保存为趋势图后新建Nginx仪表盘中，将这些图形都添加到仪表盘中吧。

### 思考

你能根据下一小节中的apache日志的演示案例，推断出后面各个视图的使用方法并说出该视图的应用场景吗？