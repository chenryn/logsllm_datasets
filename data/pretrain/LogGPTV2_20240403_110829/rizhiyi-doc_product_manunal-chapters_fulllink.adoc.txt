==  链路图
日志易提供链路图，支持对业务的状态进行端到端的全链路跟踪、回溯、性能统计和流程展示。同时用户可自定义指标阀值进行变色提醒。链路图还支持过滤和钻取，点击节点时跳转到自定义URL。
image::images/fulllink-example.png[]
=== 链路图管理
通过"查询分析"\->"全链路"，进入链路图列表页，可以对链路图进行新建，查看，编辑，删除，重命名，设置标签，授权操作。
image::images/fulllink-list.png[]
点击"新建"，弹出新建链路图窗口，按提示填入配置。新建成功后在列表上点击对应的链路图名称，进入新建链路图的编辑页面。
image::images/fulllink-icon.png[]
如上图所示，图标分别代表：
. 展示/编辑：点击图标，开启或关闭编辑状态。
. 展示/隐藏输入项：点击展示或隐藏图内的输入项。
. 添加输入项：把输入作为变量，在链路图和时间轴的搜索语句，以及其他输入项中输入${token}，即可引用变量。
. SPL 语句：链路图的节点、连线关系、节点状态指标的数据来源。
. 其他配置：
** 链路图配置：配置链路图 SPL 语句返回字段的设置，包括节点名称字段、时间戳字段、连线关系的起始字段和结束字段。节点名称如果分多层级(比如 skywalking 生成的数据分为 service/instance/endpoint 三层，详细解读见 https://github.com/apache/skywalking/blob/master/docs/en/protocols/Skywalking-Cross-Process-Propagation-Headers-Protocol-v3.md#values[skywalking 数据结构官方描述])，还可以设置节点名称的层级和分隔符。 如果实际层级大于设置的层级数量，都保留在最底层。比如：`a_b_c_d` 设置为 3 层，则第三层为 `c_d`。
** 指标配置：链路图上各节点通用的指标告警阈值和钻取配置。
** 时间轴 SPL 配置：回溯时间轴的数据来源。
=== 添加链路图
添加链路图首先需要进行链路图配置，然后再进行 SPL 搜索。
第一步：点击其他配置菜单中的链路图配置，填入节点名称字段、时间戳字段、边起始字段、结束字段、节点名称分隔符和节点层级。点击确定。
image::images/fulllink-nodeconf.png[]
系统默认的节点名称为 nodeName，时间戳字段为 timestamp，边起始字段为 source，边结束字段为 target。节点如果无层级，任意填入分隔符，并定义节点层级为 1 即可。
第二步：点击配置 SPL 语句，打开搜索图层，按需选择数据集，或直接输入 SPL 语句，选择时间，点击搜索按钮。查看页面返回的 SPL 统计表格，请确认返回结果包括了第一步定义的各个字段名称。确认无误后，点击"创建链路图"。
image::images/fulllink-splconf.png[]
SPL 语句中可以引用本页添加的输入项变量 token，用法和仪表盘、拓扑图等处一致，这里不再重复说明。请阅读仪表盘相关章节。您也可以先创建完链路图以后，再添加输入项并修改 SPL 语句。
为保证绘图结果的正确，同一行内的节点名称字段值，必须是起始字段值或结束字段值中的某一个。此外，SPL 统计结果中剩下所有以 `_` 开头的列，系统将自动识别为节点指标字段。
[IMPORTANT]
====
OpenTracing 标准中，单条日志内只包括本节点的名称、本节点和父节点的 ID。SPL 语句可以通过 join 指令来关联获取父节点名称，但 join 指令性能和输出结果有限，建议采用日志易数据工厂 Fornaxee 模块的 SpanEvaluator 组件，在接入过程中完成对单条日志的父节点名称关联。
image::images/fulllink-spaneval.png[]
====
第三步：前两步已经完成了一个最基础的全链路图统计展示。但是为了更好的观测服务状态，我们还可以添加更多配置，实现更完整的观测功能。点击"更多配置"中的"指标配置"。可以在浮层中看到第二步展示的所有以 `_` 开头的字段，并为这些字段配置阈值颜色、钻取地址等。
image::images/fulllink-metricconf.png[]
其中，"次要告警"开关表示该指标告警状态仅限于自身，不影响整个节点。也就是说，次要告警为红色或黄色时，节点并不会变色。只有非次要告警为红色或黄色时，节点才会变色。
钻取 URL 中，可以使用的点击变量包括：
* `${start}`: 当前展示时段的起始时间，可以在变量内使用加减法来偏移时间点。比如：`${start-60000}`表示取展示时段起始时间往前 1 分钟的时间点。
* `${end}`: 当前展示时段的结束时间，可以在变量内使用加减法来偏移时间点。
* `${timerange}`: 当前展示时段，相当于 `${start,end}`
* `${click.nodeName}`: 当前点击的节点名称
* `${click.system}`: 当前点击的节点名称里的第一层
第四步：点击"更多配置"中的" 时间轴SPL"，或在界面右下角点击时钟 icon 唤出时间轴，在时间轴上点击"SPL"。在时间轴 SPL 中输入 SPL 语句，查询并返回某天的以小时为单位的统计结果(时间字段名固定为 ts)。时间轴 SPL 内同样可以使用输入项变量 token。 除 ts 字段以外，如果 SPL 统计结果中包含 level 字段，系统会根据这个 level 字段来展示时间轴上这个小时的颜色，可选值包括：0,1,2。和链路图 SPL 一样，时间轴 SPL 中返回的以`_`开头的字段，被识别为指标字段。
image::images/fulllink-timeconf.png[]
第五步：如果对链路图上某个节点的状态需要定义和全局不一样的阈值。可以在界面上点击选中该节点，在右侧的"节点指标配置"中，修改指定指标的阈值和钻取配置。
image::images/fulllink-singleconf.png[]
第六步：如果对链路图自动生成的节点布局不满意，可以鼠标拖拽节点到合适的位置释放。在本链路图范围内，该节点位置都将固定在指定位置，即使因输入项变换、时间轴变换，导致其他节点和连线变化，已经自定义位置的节点也不会再变动。
=== 查看链路图
链路图在非编辑状态下，可以进行观测查看和处理操作。
==== 分层缩略
链路图左下角全景展示区域，可以放大和缩小屏幕范围内的链路节点。当业务调用链路较长时，可能一次业务请求要经过上百个处理节点，在一屏内难以看清细节，可以点击"+"号放大区域查看。
当节点存在多层级关系时，系统会自动统计每个层级的节点数量并展示在全景区域边缘，点击具体的数值，可以切换查看对应层级的聚合链路效果。比如下图，展示的是第二层级 10 个节点的状态：
image::images/fulllink-highlevel.png[]
聚合层级中的节点状态，取决于该节点在最底层级中对应各节点的状态。但是聚合层级下无法查看节点的性能指标，因为非计数类的指标一般都不支持二次聚合。比如：针对`avg`,`pct90` 再做 `avg` 统计等，结果是不正确的。
注意：最底层级的链路图一般是树状，而聚合的最高层级可能会有大量自己调用自己的情况，系统绘图中屏蔽了高层级中的回路绘制，以展示节点状态为主要目的。
==== 节点状态观测
在链路图查看状态下，点击最底层级上的单个节点，页面右侧会出现该节点的指标观测区域。
image::images/fulllink-node-status.png[]
指标数据会根据指标配置中的类型来展示，对于波动较大的指标，比如请求量，耗时等，建议选择曲线图；而占比率值类指标，比如成功率等，建议选择状态色块来展示。
多个指标共用同一个时刻提示条，让我们可以看到同一时刻不同指标的具体值。在刚打开时，提示条默认停留在二级时间轴上当前时刻位置。并根据该时刻在这个小时内的位置来对应展示其前后附近的最多 20 分钟的统计情况。
比如：
* 链路图当前展示的是15:54分的情况，则节点状态上展示的就是 15:40 到 15:59 的情况；
* 链路图当前展示的是15:04分的情况，则节点状态上展示的就是 15:00 到 15:19 的情况；
* 链路图当前展示的是15:34分的情况，则节点状态上展示的就是 15:25 到 15:44 的情况；
====  时间轴操作和处理
在链路图底部的时间轴上，默认展示的是当前时刻所属小时的状态。点击时间轴右下角的投影仪 icon，系统进入"直播中"状态。随着每分钟新数据的生成，链路图的内容也随之更新。
image::images/fulllink-live.png[]
直播中也可以点击链路图上单个节点，查看节点的具体指标。由于直播中没有未来数据，节点指标的提示条永远位于最右侧。
在时间轴上点击任意时刻，会自动退出直播状态，进入回溯状态。回溯状态展示指定时刻的具体链路状态。
在一级时间轴上，鼠标悬停在某时刻上，会浮层展示这个小时内的总体统计指标，并根据 level 字段值展示红色、黄色或蓝色。
image::images/fulllink-timeline-tip.png[]
点击该时刻，二级时间轴切换为这个小时下的具体 60 分钟状态。您可以根据二级时间轴的状态点选查看异常时刻的统计，也可以点击时间轴左侧的播放按钮，具体查看整个小时内链路的变化。
如果要查看更早时间的链路情况，点击一级时间轴右侧的设置按钮，切换时间范围。
image::images/fulllink-timeline-setting.png[]
如果链路图上确实有异常，并且你已经处理完毕。为了不引起后续用户查看时不必要的误解，可以点击时间轴右下角的"忽略异常"按钮，并在"异常处理"弹层中，输入具体的处理意见文本。
如果异常持续超过 1 分钟，你可以在二级时间轴上，鼠标划选特定范围，然后再点击"忽略异常"。
image::images/fulllink-timeline-select.png[]
处理完毕后，原来的异常时刻会从红色或黄色变成浅蓝色。鼠标悬停在浅蓝色时刻时，会浮层展示具体的处理人和处理意见文本，作为后续参考。
image::images/fulllink-timeline-done.png[]