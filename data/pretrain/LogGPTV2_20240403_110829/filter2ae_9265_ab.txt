 图17 主要功能代码部分截图
该程序会尝试访问“checkup[.]amazonaws.com”，以此来获取本地机器的外网IP地址。
![
](https://images.seebug.org/content/images/2019/11/1c134fb0-b1f7-4a8b-afa7-dbf0d3ca37a9.png-w331s)
图18 获取本地IP地址
从图17的内容可以看到，程序代码使用了混淆技术来增加分析难度。此外，其还会对VM、沙箱、调试器和其他监控工具等做一系列的检测。如运行环境安全，.NET程序则开始监视并收集受害者的信息，并使用SMTP协议将监控日志发送给远程服务器“smtp[.]diagnosticsystem.in”。
**Agent Tesla家族**
基于已知的相关资料，从2014年起迄今为止，Agent
Tesla已存活长达5年之久。随着时间的推移，该木马在陆续不断的迭代更新，最新版本目前可根据需求在互联网上随意购买。
Agent
Tesla可实时监控和记录用户的键盘输入、窃取剪切板数据、屏幕截图、获取主机信息，以及收集各大浏览器和邮箱的用户凭证并回传至黑客服务器。也正因为其功能非常强大，所以近几年以来常常被黑客组织所利用。
下图是从其网站上摘取下来的部分功能介绍：
![
](https://images.seebug.org/content/images/2019/11/258ff0f6-ba43-4498-b990-7e3c357eef42.png-w331s)
图19 Agent TeslaX相关功能
截止到目前，鉴于我们分析的这款新变种和旧版的木马在功能和技术上类似，并没有发现太多的变化点。所以本文在这里不再过多的详细描述其具体的技术细节，如有需要大家可查看文末的参考文献。
### 四 溯源与关联分析
#### 4.1 恶意域名分析
我们首先从恶意文档触发漏洞后执行的shellcode中提取出一个硬编码的链接地址：
“http[:]//34.87.19.73/”。经过后台大数据的样本关联分析后，从该托管的外部主机上挖掘出该黑客组织自2019年9月起使用的诸多类型的间谍木马。
![
](https://images.seebug.org/content/images/2019/11/312c4968-44b6-4f78-b98f-78237eef13c8.png-w331s)
图20 托管主机上的木马信息统计
接着，提取该批木马样本使用的C2域名进一步的关联出部分可疑的CC地址。例如，部分木马会将SMTP流量发送到smtp[.]diagnosticsystem.in，而该域名解析的IP地址为208[.]91[.]199[.]143。
DNS查询此域名，发现其注册时间为2019年9月19日，这与该批木马的传播起始时间正好吻合。域名查询信息如下图：
 图21 域名的注册时间
再次对线索做扩展和对该域名进行深入的追踪分析后，我们获得了更多的恶意样本，以及这些域名曾解析到的主机IP地址。
![
](https://images.seebug.org/content/images/2019/11/e256de40-e72a-46de-b438-04e0ef2cdb5f.png-w331s)
图22 域名解析的IP地址
我们从获取的大量恶意样本中整理出近期比较活跃的，通过手动分析确定了此次攻击活动中使用的大量C2域名。经过查询解析后发现，这些域名均是以上IP地址“208.91.199.**”和“208.91.198.143”的CNAME“us2.smtp.mailhostbox.com”的别名。
![
](https://images.seebug.org/content/images/2019/11/d7576222-2558-438e-a405-ae00da3cc933.png-w331s)
图23 域名查询信息
图中列举了部分活跃样本和其访问的域名，具体对应关系如下所示：
![
](https://images.seebug.org/content/images/2019/11/ec5d5d11-bbff-4348-b201-400b9e89bf3e.png-w331s)
图24 恶意样本与C&C服务器的关系图
#### 4.2 关联邮件
根据同源分析，我们发现了另外一封针对西班牙地区的钓鱼邮件。该邮件的发件地址是西班牙一家名为“MAJ AGROQUIMICOS”的农药行业公司。
![
](https://images.seebug.org/content/images/2019/11/5d2d2b6a-e97b-4b9e-9b20-e5e2c7602296.png-w331s)
图25 MAJ AGROQUIMICOS公司首页
邮件内容使用的是西班牙语，大致意思是付款确认书，钓鱼邮件的附件是一个伪装成.img格式的ISO文件。虽然文件名称与邮件的内容有所不同，但是从发件地址来看，其来源也有可能会是攻击目标的合作商或供应商之类，这样便可增加邮件的真实性，同样有机会诱使受害者下载附件。邮件具体内容如下图所示：
![
](https://images.seebug.org/content/images/2019/11/32e98cfa-79e5-4d6c-a74d-fcc7c5163ded.png-w331s)
图26 西班牙语的钓鱼邮件
邮件翻译后的内容如下图：
![
](https://images.seebug.org/content/images/2019/11/eb234d2e-83a9-4f81-b6f4-62793b356984.png-w331s)
图27 邮件翻译后的内容
#### 4.3 ISO文件
ISO映像是一种光盘的存档文件，其中包含将要写入光盘的所有信息。通常用于创建CD或DVD的备份。由于ISO文件的尺寸相对比较大，所以有可能导致很多电子邮件网关扫描程序无法正确识别此类型的附件。并且自Win
8及以上的更高版本后，Windows都自带ISO运行工具，用户就像打开EXE文件一样，直接双击ISO文件即可运行。因此这次攻击中黑客使用了ISO文件作为恶意附件。
#### 4.4 恶意附件
嵌入在IOS恶意附件中的可执行文件如下图所示：
![
](https://images.seebug.org/content/images/2019/11/7e4ec834-461a-448f-9dc9-f66048743a91.png-w331s)
图28 嵌入的可执行文件
**嵌入的可执行文件**
使用分析工具可以看到，这个名为“SOA300329042943243_pdf.exe”的可执行文件实际上是一个AutoIt解释器，并嵌入了AutoIt编译脚本作为资源。
![
](https://images.seebug.org/content/images/2019/11/e12fb078-bea1-42e4-a053-f282ebb6cb5b.png-w331s)
图29 可执行文件的资源信息
该可执行文件运行后，会在%User\Public%目录下释放恶意的VBS脚本文件并将该目录添加到注册表的Run启动项中，以实现其持久性。接着再将内存中解密出的的PE文件注入到系统文件“Regasm.exe”中。
![
](https://images.seebug.org/content/images/2019/11/e9e1c13a-cd2c-4107-9358-4aeb31bbad55.png-w331s)
图30 在注册表中添加自启动项
**新PE文件**
通过分析内存中解密出的新PE文件，我们确定该EXE是另一版使用.NET框架编写的Agent
Tesla木马。在木马程序成功注入到Regasm.exe进程并运行后，便开始尝试与远程服务器进行连接。
我们在恶意代码分析过程中发现了黑客C&C服务器上的相关信息，C&C文件目录如下图：
![
](https://images.seebug.org/content/images/2019/11/89b6f871-2972-425d-8b98-9e592eaae040.png-w331s)
图31 服务器上的文件目录
通过进一步的分析，我们发现C&C服务器上保存着大量的从受害者机器回传的监控日志，根据其储存的文件名称格式和内容等特征，再次确定该木马是“Agent
Tesla”家族。
此后，我们还追踪到了该黑客组织所收集的受害者信息，这些信息以html和jpeg文件的形式存储在C&C服务器上，其中html存储的是本机信息、键盘记录、账号密码等信息，jpeg存储的是截屏信息。下图是截取了部分监控日志：
![
](https://images.seebug.org/content/images/2019/11/fabf1fe2-d0a4-4bc3-a41f-736637e23c93.png-w331s)
图32 回传到服务器的监控日志
从这些文件名中的：“Keystrokes”（键盘记录）、“Screen”（屏幕截图）、“Recovered”（密码恢复）等关键字可以看出，木马是根据黑客的控制指令来窃取受害者的相关信息，且按照“功能-用户名-计算机名-时间（年-月-日-时-分-秒）”的结构命名并保存为HTML格式的文件。
我们将一个以“Recovery”开头的html文件使用IE浏览器打开，能够看到木马具体收集了哪些信息。其中包括受害者的计算机用户名、主机信息、系统名称、CPU信息、内存信息、IP地址以及Chrome浏览器凭据信息等。
![
](https://images.seebug.org/content/images/2019/11/3b474e46-02e0-42a4-acb3-6bb11ae9b6d0.png-w331s)
图33 HTML文件的内容详情