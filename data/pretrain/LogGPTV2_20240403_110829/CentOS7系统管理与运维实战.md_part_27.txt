182
行复制的文件和偏移量等。
Query OK, 0 rows affected (0.05 sec)
mysql> change master to
对从数据库服务器做相应的设置，
5rows in set (0.01 sec)
mysgl> show master logs;
Query OK, 0 rows affected (0.o0 sec)
***************************
mysql> show slave status \G
Query OK,0rows affected(0.01 sec)
mysql> start slave;
【示例6-68】
【示例6-67】
I Log_name
【示例6-66】
（4）登录主服务器得到当前binlog 的文件名和偏移量。
【示例6-65】
（6）登录从服务器上启动slave线程并检查同步状态
（5）登录从服务器设置主备关系
mysql-bin.000005
mysql-bin.0000011
mysql-bin.000004
mysql-bin.000003
mysql-bin.000002
-
V
V
slave Io State: Waiting for master to send event
master_1og_ pos=233;
master_password=r,
master port=3306,
master host='192.168.19.101',
Master_User: rep
Master_Host: 192.168.19.101
1File _size1
+---
2331
106
1061
1061
1251
，指定复制使用的用户、主服务器的IP、端口，开始执
---
## Page 195
一个为NO则需要根据Last_IO_Errno和Last_IO_Error显示的信息定位主从同步失败的原因。
#登录主服务器执行
如 Slave_IO_Running 和 Slave_SQL_Running 都为YES 说明主从已经正常工作了。如其中
【示例6-69】
（7）主从同步测试
row in set (0.o1 sec)
Replicate Wild Ignore Table:
Replicate_Wild_Do_Table:
Seconds Behind Master:
Replicate Ignore_Table
Relay_Master_Log_File:mysql-bin.000006
Exec Master_Log Pos:
Replicate Do Table
Replicate Ignore DB
Master SSL Cipher:
Master SSL CA Path
Master SSL CA File:
Slave_SQL Running:
Master SSL Key:
Master SSL Cert:
Until Condition:
Replicate Do DB:
Master Log File:
Last SQL Error:
Until Log_File:
Relay Log File:
Last_SQL Errno:
Last IO Error:
Last Io Errno:0
Until Log_ Pos:
Relay Log Pos:
Connect Retry: 60
Skip
Last Error:
Last Errno: 0
Counter:0
None
679
251
Cent0S-relay-bin.000004
No
106
Yes
0
NO
第6章搭建LAMP服务
183
---
## Page 196
CentOS7系统管理与运维实战
184
#登录从服务器执行
mysgl> show master logs;
Query
mysgl> create
test
mysql
information_schema
Database
rows
mysql-bin.000004
mysql-bin.000003
mysql-bin.000001
ysal
Log name
Replicate_Wild Do Table:
Replicate Ignore Table:
Relay Master Log File: mysql-bin.000006
in set
Replicate Ignore DB:
Replicate Do DB:
slave status \G
-000006
Relay Log File:
Slave Io State: Waiting for master to send event
Relay Log Pos:
(8s00:0)
database ms;
Master Port:
Master User:
Master Host! 192.168.19.101
185
360
1061
1061
106
25
Yes
330
centos-
185
66
rep
sql-bin.000006
-relay-bin.000004
---
## Page 197
集成后就可以通过Apache访问 PHP文件了，最后对 MySQL 的日常维护给出了操作示例。
比较广泛的一种，需重点掌握。通过PHP的安装与配置介绍了PHP如何与Apache服务集成，
读者了解了Apache服务常见的3种虚拟主机配置方法，其中基于域名的虚拟主机配置是使用
表的含义，返回码在日常程序调试中具有重要的作用。通过介绍Apache服务安装与配置，使
句，从而实现主从数据库数据一致。
数据库的IO线程读取到该日志写入到本地的中继日志，从数据库的SQL线程重新执行该语
本章首先介绍了HTTP协议，通过此协议，读者可以了解HTTP的原理及其常见返回码代
首先登录主数据库，然后创建了表，同时此语句会写入到主数据库的 binlog 日志中，从
1row inset(0.00 sec)
Master_ssL Verify_Server_Cert:No
Seconds_Behind Master:o
Lcate Wild Ignore Table:
小结
Exec Master Log_Pos:185
Master_SSL Cipher
Master SSL CA Path
Master SSL CA File:
Master SSL Allowed:
Master sSL Key:
Master_SSL Cert:
Until Log_File:
Until Condition:None
Relay_Log_Space:758
Last SQL Error:
Last SQL Errno:
Last Io Errno:0
Until Log Pos:
Last Io Error:
Skip_Counter:0
Last Error:
Last Errno:0
No
第6章搭建LAMP服务
185
---
## Page 198
为开发版。本节以Nginx的1.6.3版本为例说明Nginx的安装过程。
新版本可以从 http://nginx.org/下载，目前最新版本为1.6.3和1.7.12,其中1.6.3为稳定版,1.7.12
7.1.1
相比，Nginx的安装包更轻量级。
功能。
操作MySQL 的实战案例，使读者了解如何通过PHP实现MySQL 数据库表的增、删、改、查
介绍Nginx的负载均衡和反向代理，接着介绍Nginx和PHP 的两种集成方式。最后通过 PHP
作为Web服务器。
同时支持负载均衡和反向代理。因为Nginx并发能力很强，所以国内很多大型公司都使用Nginx
广泛的架构即为LNMP（Linux+Nginx+MySQL+PHP）。Nginx是一款轻量级的Web服务软件，
Nginx 软件的安装主要经过3个步骤：检查系统软件环境、编译源码和安装。Nginx的最
本章首先介绍LNMP（Linux+Nginx+MySQL+PHP）涉及的相关软件的安装与管理，然后
本节主要介绍常见的LNMP（Linux+Nginx+MySQL+PHP）服务的安装与管理。与Apache
安装Nginx 之前，首先需要安装 PCRE（Perl Compatible Regular Expressions），PCRE 为
1. Nginx安装
本章主要涉及的知识点有：
Web服务除了常见的LAMP（Linux+Apache+MySQL+PHP）架构外，另外一种应用比较
Nginx的安装与管理
Nginx负载均衡与反向代理
掌握如何通过PHP操作MySQL数据库
掌握Nginx与PHP集成的两种方式
LNMP服务安装与管理
LNMP服务安装与管理
搭建LNMP服务
第7章
---
## Page 199
不需要特殊设置。Nginx安装时依赖zlib 和 zlib-devel，因此需要提前安装这两个软件。
ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/]
Perl 语言兼容正则表达式，主要用C语言编写，被很多开源软件所采用。详细的安装过程如
【示例7-1】所示。
/conf/fastcgi params
#部分文件省略
Nginx安装完后位于/usr/local/nginx目录下，目录结构如【示例7-2】所示。
通过以上步骤完成了 PCRE 和 Nginx 软件的安装，两者的安装与普通软件安装类似，并
[root@Centos pcre-8.35]# make
#编译源码
配置并检查系统环境
-/conf/koi-win
#安装
#编译
[root@centos nginx-1.6.3]#./configure
#检查系统环境
[rootecentos soft]# wget
下载解压源码包
【示例7-1】
/conf/mime.types
./conf/win-utf
/conf/koi-utf
/sbin
[root@Centos nginx]# find.
conf html logs sbin
[rootecentos nginx]# is
【示例7-2】
[root@Centos nginx-l.6.3]# make
[root@centos soft]# tar xvf nginx-l.6.3.tar.gz
rooteCentos
#解压源码包
[root@Centos pcre-8.35]# make install
#安装
[root@centos pcre-8.35]#
/sbin/nginx
conf
./configure
-prefix=/usr/local/nginx
第7章搭建LNMP服务
CreE
.tar.
gz
187
---
## Page 200
188
明如何在Nginx下完成基于域名的虚拟主机配置。详细的设置过程与配置文件如【示例7-3】
IP 的虚拟主机配置和基于域名的虚拟主机配置。本节主要以基于域名的虚拟主机配置为例说
为./conf/nginx.conf，此文件类似 Apache 服务的配置文件 htpd.conf。
CentOS7系统管理与运维实战
所示。
#创建日志文件，否则无法启动Nginx
#在httP段中找到以下内容并删除每行前面的“#”
#部分内容省略
[root@Centos vhost]# tail ../nginx.conf
#将虚拟主机配置文件包含进主文件
10
O
n
#创建虚拟主机配置文件
【示例7-3】
2.Nginx虚拟主机设置
Nginx 服务的主要文件为 sbin/nginx，此程序为 Nginx主程序。Nginx 的主要配置文件
#配置文件结尾的最后一
[root@centos conf]# cd vhost/
[root@Centos sbin]# cd/usr/local/nginx/conf/
同Apache 类似，Nginx支持多种虚拟主机配置方式，如基于端口的虚拟主机配置、基于
/conf/fastcgi params.default
coot@Centos conf)# mkdir vhost
conf/fastcgi.conf.default
/conf/fastcgi.conf
log format main
server
location
error log
access
server_name
isten
root
index
.conf:
1og
一个“”加入以下语句，如下所示
""shttp
'sstatus $body bytes sent"shttp_referer".
/data/www.test.com;
index.html index.htm,
/data/logs/www.test.com.error.log:
192.168.19.101:80;
www.test.com;
-n www.test.com.conf
---
## Page 201
本节采用php-5.4.16.tar.gz作简单示例如【示例7-4】所示。
7.1.2
的虚拟主机配置。每行的主要含义如下：
-with-mysql=/usr/local/
-with-mysql=/usr/local/
mysql --enable-fpm
PHP的安装同样需要经过环境检查、编译和安装3个步骤，这在第6章中已经介绍过，
[root@Cent0s php-5.4.16]#
#另外一种集成方式编译命令
mysql
[root@Cent0s php-5.4.16]#./configure
#检查系统环境
#解压源码包
【示例7-4】
该示例中首先创建了虚拟主机配置文件www.test.com.conf，在此文件中采用了基于域名
www.test.com.index
[root@Centos sbin]# curl www.test.com
#创建虚拟主机目录并创建测试文件index.html
192.168.19.101 www.test.com
[root@Centos sbin]# tail /etc/hosts
#配置host用于测试
[root@Centos sbin]#./nginx
nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
[root@Cent0s soft]# tar xvf php-5.4.16.tar.gz
第 8~11行指定了虚拟主机的主目录和默认文件。
第 5~6 行指定了 Nginx的日志配置。
第1行为虚拟主机配置标识，此标识类似Apache服务中的VirtualHost。
测试文件
[root@centos vhost] mkdir-p /data/www.test.com
[root@Centos sbin]#
[root@centos vhost]# cd../../sbin/
#先测试配置文件然后再启动Nginx
[root@Centos soft]#
第3行为虚拟主机对应的域名，如配置多个域名，可以用空格分开。
第2行指定了该虚拟主机监听的IP和端口。
[root@centos vhost] echo "www.test.com.index">/data/www.test.com/index.html
[root@Centos vhost]# touch /data/logs/www.test.com.error.log
[root@Centos vhost]#touch/data/logs/www.test.com.log
PHP安装
--enable-fastcgi
cdphp-5.4.16
./nginx-t