作者：启明星辰ADLab
#### 1、概述
启明星辰AdLab近期追踪到一个新出现的 Android 恶意木马样本，该恶意木马主要通过钓鱼 APP 来窃取用户银行及理财 APP
登录凭证，能够通过创建本地代理来窃取 Google 账户登录凭证，且具备远程控制感染机的能力。依据样本关联分析我们发现，该同类型的样本之前被 Mcafee
披露过（其在8月28日将该银行木马命名为：Android/MoqHao），并且还发现恶意代码背后的黑客早在2013年就开始针对韩国的手机用户进行钓鱼攻击。直到2015年，该黑客组织开始利用伪造的
Chrome 更新消息来进行传播，并且开始利用QQ空间等社交网络账户来配置 C&C
服务器地址。本次启明星辰ADLab追踪到的恶意代码样本为9月中旬的最新样本，该样本利用了百度账户来设置 C&C 服务器，不过 C&C 服务器 IP
进行了加密处理。通过对该恶意代码的分析我们发现其具有如下特点：
  1. 通过短信传播。
  2. 伪装成 Chrome 浏览器更新欺骗用户下载。
  3. 通过 BASE64 编码将恶意 dex 文件隐藏于资源目录。
  4. 创建手机代理服务的方式来窃取 Google 账户凭证。
  5. 通过百度个人账户来更新 C&C 服务器地址。目前涉及到的攻击者百度账户页面有 和，解密后的 C&C 服务器地址为：111.240.228.234:8833。
  6. 利用加密的 WebSocket 协议通信。
  7. 使用了类似 RPC 的机制来实现远程控制。
  8. 替换合法金融类 APP 为钓鱼 APP，窃取登录凭证。
该样本相关信息见表1：
表1 样本相关信息
#### 2、木马行为简介
该恶意木马伪装成 Chrome
浏览器更新包来欺骗用户下载，并且该恶意木马运行后会不断提示用户激活其设备管理员权限（见图1），一旦其设备管理员权限被激活，该恶意木马就隐藏自身的图标。这样，普通用户很难卸载掉该恶意木马，从而使该恶意木马长期驻留在受害用户的设备中。
图1 提示用户激活设备管理员权限
该样本原始包充当了类似壳的角色，真实的恶意 dex 文件被加密保存在原始包的 assets目录下，原始包在运行时解密加载其恶意 dex
文件来实现恶意攻击。解密后的 dex 文件经过了严重的混淆。我们对其深入分析后发现，恶意木马在运行时，通过 Http
请求获取攻击者提前在其百度个人账户页面配置好的加密过的 C&C 服务器地址，请求成功返回后，再对 C&C 服务器进行解密。获取到 C&C
服务器地址后，该恶意木马会使用加密的 WebSocket 协议来和 C&C 服务器通信。值得注意的是，该恶意木马和 C&C 服务器均各自实现了自己的 RPC
函数，通信双方利用这些 RPC 函数来达到数据窃取和远程控制的目的 （示意图见图2）。
图2 恶意木马网络通信图
需要关注的是，该恶意木马会遍历受害用户本机安装的 APP 信息，以确定受害用户是否安装有特定的银行类 APP。如果有的话，该恶意木马就会从 C&C
服务器下载对应的伪装银行木马，待对应的伪装银行木马下载完成后，就提示用户升级。伪装银行木马运行后，会卸载掉受害用户本机原始合法的银行 APP
来偷梁换柱。不难推测，对用户真正的钓鱼活动才刚刚开始。
另外，该恶意木马除了收集受害用户的手机硬件相关信息和手机状态信息，还会窃取受害用户的 Google
账号凭证。与常见的利用远程服务钓鱼页面不同的是，该恶意木马在受感染手机本地开启了一个 Httpserver 服务，并利用该本地服务页面完成对受害用户的
Google 账号凭证钓鱼后，再将其通过 WebSocket 协议转发到 C&C 服务器。该恶意木马的主要行为见图3：
图3 恶意木马的主要行为
#### 3、原始包解密分析
如前所述，该恶意木马真实的恶意 dex 文件被加密保存在原始包的 assets 目录下，其内容是 Base64
后的可见字符（见图4），其原始包只是扮演了壳的角色，原始包在运行时解密加载真实的恶意 dex 文件来实现恶意攻击。我们将 bin 文件 Base64
解密或在该恶意木马运行后，从其安装包路径下的 files 文件下均可得到真实的恶意 dex 文件（见图5）。
图4 加密存放真实的恶意dex文件
 图5 真实的恶意dex文件运行时解密到files目录
#### 4、真实攻击逻辑分析
该恶意木马申请的权限如图6所示，其中涉及到的敏感权限包括短信的读写权限、通讯录读取权限、打电话权限、修改手机状态权限等。
图6 恶意木马申请的权限
##### 4.1 注册大量广播，主要用于窃取用户手机状态信息
该恶意木马注册了大量的广播事件，主要用来窃取受害用户手机状态信息，以达到实时监控受害用户手机的目的（见图7）。
图7 恶意木马注册大量广播事件
其中，当用户手机有新的应用安装或卸载、手机电量变化、网络连接改变、屏幕唤醒或休眠等事件发生时，恶意木马就发送受害用户手机状态相关信息到 C&C
服务器。发送的手机状态相关信息包括：运营商名字、网络类型（wifi 还是移动网络）、wifi 的 mac 地址、电量百分比、wifi
信号强度、是否管理员权限、自己是否在休眠白名单中、屏幕是否唤醒、手机情景模式（见图8）。
图8 向 C&C 服务器发送手机状态相关信息
##### 4.2 获取 C&C 服务器地址
该恶意木马利用动态页面来获取和更新 C&C 服务器地址。攻击者将加密后的 C&C 服务器地址配置在申请的百度账户个人简介中，恶意木马在运行时会通过 Http
请求获取对应的页面数据再进行解密。从图9我们可以看到，获取C&C服务器的 Http
请求串也经过了加密处理，我们对其解密后的结果为： 和
。
图9 Http 请求的解密和拼凑
另外，通过抓包也可清楚看到该 Http 请求的内容（见图10）。
 图10 Http 请求抓包结果
我们在浏览器中访问对应的 Http 请求，可以看到访问的是对应百度账户的个人页面，我们注意到攻击者的账户目前还处于在线状态，个人简介部分即为加密后的 C&C