# 逐步获取核心权限
##### 译文声明
本文为翻译文章，原文作者为酒仙桥6号部队，来源网址：[原文链接]。译文仅供参考，具体内容及含义请以原文为准。

## 背景
近期参与的渗透测试项目中，并未涉及内网渗透部分，这减少了项目的挑战性与成就感。因此，我选择了一个已授权的企业项目，目标是获取其内网的核心权限，采用任何可行手段达成目的。这种自由度较高的任务正合我意。

## 入口
首先对企业公开或半公开的资产进行了全面的信息搜集工作。通过子域名爆破、FOFA搜索引擎以及Google搜索等方式定位了多个子域，并从中反查到真实的IP地址。随后对C段IP进行端口扫描，生成了一份详细的资产列表。使用XRAY工具对这些资产进行漏洞扫描，在其中一个系统上发现了Shiro反序列化漏洞。

### 利用Shiro漏洞
利用GitHub上的相关工具尝试攻击该漏洞，成功执行了远程命令。进一步探索发现Web应用是以JAR包形式运行的，直接写入Shell不可行。转而尝试在内存中植入蚁剑WebShell并设置相应Header头后成功建立连接。

## 内网漫游
登录Linux服务器后因权限限制无法查看敏感文件如`/etc/shadow`等。尽管尝试了几种提权方法均告失败，但通过对下载下来的JAR包分析获得了MySQL数据库配置信息。接着配置FRP代理以便于后续操作。

### 进一步渗透
- **弱密码攻击**：针对内网其他主机实施弱口令爆破，成功攻陷两台Linux机器。
- **Windows渗透**：考虑到可能存在的Windows环境，尝试利用MS17-010漏洞生成ELF格式木马文件并通过Metasploit框架监听反弹Shell，但未能找到可利用的目标。
- **数据库利用**：利用先前获得的MySQL凭证查询得知存在一个PHP应用程序。经过多次尝试最终确定Web根目录位置并通过慢查询日志注入技术上传了WebShell。

## 域控突破
确认当前处于域环境中后，利用NetLogon协议中的零日漏洞（CVE-2020-1472）重置了机器账户密码，并使用DCSync导出所有域用户凭据。最后通过Pass-the-Hash技术取得了域控制器管理员权限。

## 总结
此次渗透行动主要依靠外部Shiro漏洞作为切入点，进而深入内网探索直至完全控制整个网络环境。过程中不仅展示了多种攻击技术和思路转换的重要性，也强调了对于企业而言加强安全防护措施尤其是及时修补已知漏洞的必要性。