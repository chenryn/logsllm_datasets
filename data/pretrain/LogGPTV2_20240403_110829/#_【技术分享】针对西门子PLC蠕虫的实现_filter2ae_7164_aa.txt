# 【技术分享】西门子PLC蠕虫的实现

## 译文声明
本文为翻译文章，原文来源于xianzhi.aliyun.com。译文仅供参考，具体内容和含义以原文为准。

**作者：icsmaster**

## 研究背景
随着“互联网+”、“中国智能制造2025”及“工业4.0”等概念的提出，为了提高生产效率，传统独立且隔离的工业控制系统正逐步融入互联网时代。越来越多的工业控制设备（如控制器、机器人和数控机床）将被连接到互联网或企业内网中。然而，随之而来的网络安全问题变得愈发突出。与传统的信息网络不同，工业控制系统的安全一旦遭受攻击，可能会导致严重的物理损害，甚至灾难性后果。以下是几个关键的工控病毒事件：

- **2010年伊朗核设施遭“震网”病毒攻击**：这是世界上首个被称为“网络超级武器”的事件。该病毒的复杂程度超乎想象，并直接导致了物理设备故障，进而引发了生产瘫痪乃至爆炸。
- **Black Hat 2011报告**《Exploiting Siemens Simatic S7 PLCs》展示了如何利用西门子S7Comm协议中的权限缺失漏洞来远程操控PLC，进行启停控制及内存读写。
- **Black Hat 2015报告**《Internet-facing PLCs – A New Back Orifice》演示了通过PLC作为通信代理，突破网络边界，发现更多内部PLC设备的方法。
- **Black Hat 2016报告**《PLC-Blaster: A Worm Living Solely in the PLC》提出了PLC蠕虫的概念，并指出了西门子1200 V3版本协议认证的缺陷，但未提供具体实现细节。

近期，工匠实验室的安全专家深入研究了PLC，并通过结合梯形图和结构化控制语言（SCL），利用PLC自身的通信功能，成功重现了这种病毒，实现了其在PLC之间的传播。此外，我们还开发了相应的检测工具，标志着华创网安在工控安全领域掌握了核心技术，展现了我们在该领域的研发实力。

## PLC基本结构
可编程逻辑控制器（PLC）本质上是一种专用于工业控制的计算机，其硬件结构与微型计算机类似。主要组成部分包括：

1. **中央处理单元（CPU）**：是PLC的控制中枢，负责执行系统程序赋予的功能，接收并存储用户程序和数据，同时检查电源、存储器、I/O状态以及警戒定时器的状态，并诊断语法错误。当PLC运行时，它会扫描现场各输入装置的状态和数据，逐条读取并解释用户程序，执行逻辑或算术运算，然后将结果传送到输出装置。为了提高可靠性，大型PLC常采用双CPU冗余系统或三CPU表决式系统。
2. **存储器**：分为系统程序存储器和用户程序存储器。前者存放系统软件，后者存放应用软件。根据PLC的工作原理，存储空间通常包括系统程序存储区、系统RAM存储区（包括I/O映象区和系统软设备等）以及用户程序存储区。
3. **电源**：PLC的电源在整个系统中起着至关重要的作用。制造商非常重视电源的设计和制造，确保即使在交流电压波动±10%（或±15%）范围内也能正常工作。
4. **输入/输出电路**：I/O扩展接口用于连接扩充外部输入/输出端子数的扩展单元与基本单元（即主机）。

## 蠕虫介绍
蠕虫病毒是一种常见的计算机病毒，通过网络复制和传播，传染途径包括网络和电子邮件。最初的蠕虫病毒因在DOS环境下发作时会在屏幕上显示一条类似虫子的东西而得名。蠕虫病毒是自包含的程序，能够将自身或部分代码传播到其他计算机系统中。

工控蠕虫主要针对工业控制设备，通过控制器之间传播病毒，这与传统计算机蠕虫存在显著差异。传统蠕虫寄生对象是计算机（如Windows或Linux），而工控蠕虫寄生对象是控制器逻辑代码。由于病毒可以混入正常的控制逻辑代码中，传统防御方式难以应对工控蠕虫的防护，检测和查杀难度较大。尽管如此，所有蠕虫的基本架构相似，都包括搜索目标、感染目标、在目标上执行以及添加恶意功能等阶段。鉴于PLC控制器具备网络通信能力，在PLC上的蠕虫同样支持这些功能。本文将展示每个组件的具体实现方法。

## 蠕虫实现
蠕虫的主要编程软件为西门子TIA Portal（博途）。在TIA Portal中，用户可以通过编写程序来实现工业现场的控制及工艺流程。博途中包含以下几种块类型：

- **OB（组织块）**：为程序的入口块，由系统直接调用。其他块必须包含在OB中才能执行。
- **FB（功能块）**：既可以是博途中已有的功能块，也可以是用户自定义的块。使用时需带背景数据块（实例数据块）。
- **FC（功能）**：既可以是博途中已有的功能块，也可以是用户自定义的块，但不能带背景数据块。
- **DB（数据块）**：分为背景数据块和共享数据块。背景数据块为私有块，数据掉电不丢失。用户可以定义共享数据块的数据存储结构，但背景数据块的数据存储结构必须由FB定义。

通过以上组件的组合，可以实现PLC蠕虫的编写与传播。