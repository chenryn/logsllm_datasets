## 如何用 PolarDB 证明巴菲特的投资理念 - 包括PolarDB on Docker简单部署        
### 作者                              
digoal                              
### 日期                              
2022-09-08                              
### 标签                              
PostgreSQL , PolarDB                  
----                              
## 背景    
## 巴菲特投资理念的理论支撑
巴菲特的投资理念是什么? 长线定投, 长线定投的理论支撑是什么?         
- 长期定投不是投机倒靶, 长期定投是有社会价值的, 可以帮助上市公司筹集资金, 加大研发投入和生产. 投资人则在这中间获取企业业务发展带来的红利.     
长线定投赚钱背后的逻辑(理论依据)是什么呢?      
- 1、首先是代际转移理论: 资源(生产资料、生产力)有限, 但是我们整个社区都假设并坚信通过未来的科技进步将获得更高的资源利用能力、生产效率; 例如石油、煤炭的过度开采虽然会造成环境破坏, 但是我们相信未来的科技进步会找到新的能源, 并填补过度开采造成的破坏. (这点和递弱代偿理论异曲同工)。     
    - 参考 [《德说-第96期, 代际转移与创新、集智(全球脑)》](../202205/20220514_03.md)      
- 2、第二个是经济周期, 以及宏观调控手段, 维持适度的通胀, 有利于经济的发展. 需要刺激经济的时候通常会有降低商业银行在央行的存款准备金率, 让商业银行可以贷出去更多钱, 可能引起通胀. (货币总量增加. 参考阅读:金融简史.). 但是    
有些国计民生相关商品并不是完全市场化的, 所以这些商品通胀率比较可控, 否则会引发动乱.       
    - 银行放水时也需要有法律法规和相关监管配合, 防止投机倒把贷一堆钱去炒作钱滚钱. 失去了放水的意义. 放水可能希望的是去消费、投入研发或采购生产资料、促进生产....      
- 3、第三是数学支撑: 微笑曲线     
    - 参考 [《德说-第56期, 微笑曲线 - 基金定投》](../202110/20211029_02.md)      
- 4、严格的止盈线. 可不要太贪, 过了止盈线就卖掉, 重新开始定投.   
- 5、不要过于分散, 例如就选一个投资对象(例如50, 500指数), 而且你的钱要能cover这只对象的整微笑周期.   
有了理论支撑, 本文将使用真实数据以及PolarDB来证明巴菲特的投资理念.      
## 证明过程    
1、下载数据    
巴菲特推荐的是投资指数, 单只股票可能经营不善而下市. 但是指数是由大量头部或者行业头部或者规模相似的数十或数百只股票构成, 比投资单只股票风险更低.    
- 另外需要说明的是定投没有一次必须买N股的限制; 而股票交易有这个限制.  
- 定投指固定周期、固定的投入资金、固定的买入标的; 例如每个交易日每次投入500买入中证500, 当期买入份额 = 500/当时一份该标的的价格; 
使用股票来证明, 为了让数据更有说服力, 我随意选了几只具有不一样的鲜明特征的股票: 茅台、海立、ST热电.   
其中两只比较糟糕的股票的数据, 现在已经跌破发行价了, 虽然如此, 巴菲特投资理念依旧成立.    
下载20010101年到20220901的历史收盘价数据:         
https://zhuanlan.zhihu.com/p/65662875      
```      
curl "http://quotes.money.163.com/service/chddata.html?code=0600519&start=20010101&end=20220901&fields=TOPEN;TCLOSE" -o ./0600519.SH.csv        
curl "http://quotes.money.163.com/service/chddata.html?code=0600619&start=20010101&end=20220901&fields=TOPEN;TCLOSE" -o ./0600619.SH.csv      
curl "http://quotes.money.163.com/service/chddata.html?code=0600719&start=20010101&end=20220901&fields=TOPEN;TCLOSE" -o ./0600719.SH.csv     
```      
转换处理一下编码的问题:        
```      
iconv -f GBK -t UTF-8 ./0600519.SH.csv > ./1.csv       
iconv -f GBK -t UTF-8 ./0600619.SH.csv > ./2.csv      
iconv -f GBK -t UTF-8 ./0600719.SH.csv > ./3.csv    
[postgres@d6b4778340d1 ~]$ head -n 5 1.csv 2.csv 3.csv     
==> 1.csv  2.csv  3.csv = '2021-02-10'  -- 最高位开始定投  
where c1 >= '2014-08-17'  -- 低位开始定投  
where c1 >= '2018-02-02'  -- 中位开始定投     
海立:   
where c1 >= '2015-06-15'  -- 最高位开始定投  
where c1 >= '2013-07-09'  -- 低位开始定投  
where c1 >= '2011-09-01'  -- 中位开始定投     
ST热电:   
where c1 >= '2015-11-24'  -- 最高位开始定投  
where c1 >= '2008-11-03'  -- 低位开始定投  
where c1 >= '2018-02-01'  -- 中位开始定投    
设置止盈线:   
不要太贪, 例如我们就选10%;  (银行非常好的保本理财基本上也就4%到5%;)     
SQL 如下:    
```        
select           
c1, -- 日期          
price, -- 当前价          
round(cost_avg,4), -- 成本价          
round(100 * ((price-cost_avg)/cost_avg) / ((c1-start_c1+1)/365.0), 2) as revenue_year_ratio, -- 年化收益率          
rn * 500 as invest,  -- 截止当前总投入. (假设每个交易日投入500)            
round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) as v_value,  -- 当前持有股票的价值           
round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) - rn * 500 as v_make_money,  -- 赚了多少钱           
c1-start_c1 as keep_days  -- 持有天数          
from           
(          
  select           
    c1,           
    c5 as price,           
    avg(c5) over w as cost_avg,           
    min(c1) over w as start_c1,          
    row_number() over w as rn          
  from t1   -- 茅台        
  where c1 >= '2021-02-10'  -- 最高位开始定投  
  -- where c1 >= '2014-08-17'  -- 低位开始定投  
  -- where c1 >= '2018-02-02'  -- 中位开始定投     
  -- from t2  -- 海立  
  -- where c1 >= '2015-06-15'  -- 最高位开始定投  
  -- where c1 >= '2013-07-09'  -- 低位开始定投  
  -- where c1 >= '2011-09-01'  -- 中位开始定投      
  -- from t3  -- ST热电  
  -- where c1 >= '2015-11-24'  -- 最高位开始定投  
  -- where c1 >= '2008-11-03'  -- 低位开始定投  
  -- where c1 >= '2018-02-01'  -- 中位开始定投    
  -- 经济越低迷的时候股价越低, 从那时开始投入是比较好的.           
  -- 如果你的投入周期足够长, 可以从任意时间开始投入, 总会遇到可以收割的时候.            
  window w as (order by c1 range between UNBOUNDED PRECEDING and CURRENT ROW)          
) t      
where round(100 * ((price-cost_avg)/cost_avg) / ((c1-start_c1+1)/365.0), 2) >= 10  -- 大于止盈线年化10%的有多少天? 你可以自己设置.    
order by c1;   
```        
结果如下:          
```      
茅台:      
日期, 当前价格, 成本价, 年化收益率, 总投入, 股票价值, 赚了多少, 持有天数          
     c1     |  price  |   round   | revenue_year_ratio | invest |  v_value  | v_make_money | keep_days   
------------+---------+-----------+--------------------+--------+-----------+--------------+-----------  
 2021-04-02 |  2162.0 | 2101.1988 |              20.31 |  16500 |  16977.45 |       477.45 |        51  
..............  
 2021-12-27 | 2131.82 | 1946.7208 |              10.81 | 106000 | 116078.75 |     10078.75 |       320  
 2021-12-28 | 2138.18 | 1947.6197 |              11.09 | 106500 | 116920.24 |     10420.24 |       321  
高点开始定投 (24 rows) 个交易日, 超过年化10%   
低点开始定投 (1735 rows) 个交易日, 超过年化10%   
中点开始定投 (749 rows) 个交易日, 超过年化10%   
海立:      
高点开始定投 (126 rows) 个交易日, 超过年化10%   
低点开始定投 (521 rows) 个交易日, 超过年化10%   
中点开始定投 (233 rows) 个交易日, 超过年化10%   
ST热电:  
高点开始定投 (127 rows) 个交易日, 超过年化10%   
低点开始定投 (524 rows) 个交易日, 超过年化10%   
中点开始定投 (85 rows) 个交易日, 超过年化10%   
```        
思考一下保险公司的很多投资型保险理财产品是靠什么盈利的? 例如每年投一两万, 连续投20年, 然后...年化利息大概3左右, 同时有一些大病保险赔款(基本上就是不死也残的那种).    
## 注意, 定投的止盈点计算方法  
前面例子计算年化收益的方法实际上是不准确的, 因为不是每一笔钱都和第一笔一样投入了 `(c1-start_c1+1)/365.0` 年.   
实际年化收益大约是2倍于以上算法:    
```  
-- 年化收益率     
round(100 * ((price-cost_avg)/cost_avg) / ((c1-start_c1+1)/365.0), 2) as revenue_year_ratio,   
```  