title:Picking Up My Tab: Understanding and Mitigating Synchronized Token
Lifting and Spending in Mobile Payment
author:Xiaolong Bai and
Zhe Zhou and
XiaoFeng Wang and
Zhou Li and
Xianghang Mi and
Nan Zhang and
Tongxin Li and
Shi-Min Hu and
Kehuan Zhang
Picking Up My Tab: Understanding and Mitigating 
Synchronized Token Lifting and Spending  
in Mobile Payment
Xiaolong Bai, Tsinghua University; Zhe Zhou, The Chinese University of Hong Kong;  
XiaoFeng Wang, Indiana University Bloomington; Zhou Li, IEEE Member; Xianghang Mi and 
Nan Zhang, Indiana University Bloomington; Tongxin Li, Peking University;  
Shi-Min Hu, Tsinghua University; Kehuan Zhang, The Chinese University of Hong Kong
https://www.usenix.org/conference/usenixsecurity17/technical-sessions/presentation/bai
This paper is included in the Proceedings of the 
26th USENIX Security Symposium
August 16–18, 2017 • Vancouver, BC, Canada
ISBN 978-1-931971-40-9
Open access to the Proceedings of the 26th USENIX Security Symposium is sponsored by USENIXPicking Up My Tab: Understanding and Mitigating Synchronized Token
Lifting and Spending in Mobile Payment
Xiaolong Bai1,∗, Zhe Zhou2,3,∗, XiaoFeng Wang3, Zhou Li4,
Xianghang Mi3, Nan Zhang3, Tongxin Li5, Shi-Min Hu1, Kehuan Zhang2,†
1Tsinghua University, 2The Chinese University of Hong Kong,
3Indiana University Bloomington, 4IEEE Member, 5Peking University
PI:EMAIL, {zz113, khzhang}@ie.cuhk.edu.hk, {xw7, xmi, nz3}@indiana.edu,
PI:EMAIL, PI:EMAIL, PI:EMAIL
Abstract
Mobile off-line payment enables purchase over the
counter even in the absence of reliable network connec-
tions. Popular solutions proposed by leading payment
service providers (e.g., Google, Amazon, Samsung, Ap-
ple) rely on direct communication between the payer’s
device and the POS system, through Near-Field Com-
munication (NFC), Magnetic Secure Transaction (MST),
audio and QR code. Although pre-cautions have been
taken to protect the payment transactions through these
channels, their security implications are less understood,
particularly in the presence of unique threats to this new
e-commerce service.
In the paper, we report a new type of over-the-counter
payment frauds on mobile off-line payment, which exploit
the designs of existing schemes that apparently fail to
consider the adversary capable of actively affecting the
payment process. Our attack, called Synchronized Token
Lifting and Spending (STLS), demonstrates that an active
attacker can sniff the payment token, halt the ongoing
transaction through various means and transmit the token
quickly to a colluder to spend it in a different transaction
while the token is still valid. Our research shows that
such STLS attacks pose a realistic threat to popular off-
line payment schemes, particularly those meant to be
backwardly compatible, like Samsung Pay and AliPay.
To mitigate the newly discovered threats, we propose a
new solution called POSAUTH. One fundamental cause of
the STLS risk is the nature of the communication channels
used by the vulnerable mobile off-line payment schemes,
which are easy to sniff and jam, and more importantly,
unable to support a secure mutual challenge-response
protocols since information can only be transmitted in
one-way. POSAUTH addresses this issue by incorporat-
ing one unique ID of the current POS terminal into the
generation of payment tokens by requiring a quick scan-
∗The two lead authors are ordered alphabetically.
†Corresponding author.
ning of QR code printed on the POS terminal. When
combined with a short valid period, POSAUTH can en-
sure that tokens generated for one transaction can only be
used in that transaction.
1
Introduction
The pervasiveness of mobile devices has profoundly
changed the ways commercial activities are conducted.
Particularly, mobile payment, in which a payment trans-
action is carried out between a smartphone and a point of
sale (POS) system, becomes increasingly popular, with
over 1 trillion dollars revenue projected for 2019 [49].
Leading e-commerce providers (e.g., PayPal, Amazon,
Google, Alibaba) and smartphone manufacturers (e.g.,
Samsung, Apple) all come up with their own solutions
and competing with each other for market shares. Most
of these schemes are designed for online use originally,
which requires both the payer and the payee to stay con-
nected to the Internet during a transaction, so both parties
are notiﬁed by the payment service provider once the
transaction succeeds. A problem for this approach is that
the payer (who in many cases is a grocery shopper) is
expected to have a decent network connection (or enough
mobile data) whenever she pays. To avoid the delay and
extra cost introduced during this process, recently off-
line payment schemes are gaining traction, which allow a
transaction to go through even when the payer’s network
connection is less reliable. This is achieved by establish-
ing a direct connection between the smartphone and the
POS system through Near-Field Communication (NFC),
Bluetooth, electromagnetic ﬁeld, 2D-QR code or even
audio signal, and delivering a payment token over this
channel. Already many prominent payment schemes have
offered this off-line support, including PayPal, Google
Wallet, Apple Pay, Samsung Pay and AliPay. What is less
clear, however, is the security guarantee they can provide.
Security of mobile off-line payment. Unlike the on-
line payment, in which the payer and the payee do the
USENIX Association
26th USENIX Security Symposium    593
transaction through the service provider, the off-line ap-
proach relies on the direct communication between the
smartphone and the POS system, and therefore can be
vulnerable to the eavesdropping attack from a bystander.
This is less of an issue for the NFC channel, due to its ex-
tremely short communication distance, making the sniff-
ing difﬁcult. More importantly, both NFC and Bluetooth
allow convenient bidirectional interactions between the
payer (smartphone) and the payee (POS), which helps
strengthen the protection: a typical approach is for the
POS device to challenge the phone with an “unpredictable
number”; the number is then used by the phone to gen-
erate a payment token with a short validity period. This
thwarts the attempt to use the token in a different transac-
tion.
In practice, however, the POS systems armed with NFC
or Bluetooth are expensive and less deployed, and cheaper
and more backwardly compatible alternatives are widely
adopted. For example, Samsung Pay supports Magnetic
Secure Transmission (MST), which can work on those us-
ing magnetic stripes, like credit-card readers. PayPal and
AliPay (an extremely popular Chinese payment service,
with 190 million users) both transmit the token through
QR scanning, an approach widely supported by POS ma-
chines. Also, AliPay and ToneTag [51] utilize audio sig-
nals, a low-cost solution that needs only a sound recorder
on the payee side. A problem here is that all such channels
(electromagnetic ﬁeld, QR code and audio) are one-way
in nature, making the above challenge-response approach
hard to implement. To address this issue, these schemes
employ one-time payment token, together with a short
valid time, to defend against the eavesdropping attack.
The idea is that once the token is observed, it cannot be
used again and will soon expire, and is therefore useless
to the adversary. The effectiveness of this protection, how-
ever, becomes questionable in the presence of an active
attacker, who is capable of disrupting a transaction to
prevent the token from being spent, which allows him to
use it in a different transaction within the validity period.
This was found to be completely realistic in our study.
Our attacks. In this paper, we report our security anal-
ysis of two leading mobile off-line payment schemes:
Samsung Pay and AliPay. Our study reveals surprising
security vulnerabilities within these high-proﬁle schemes,
affecting hundreds of millions of users around the world:
we found that both approaches are subject to a new type of
over-the-counter payment frauds, called Synchronized To-
ken Lifting and Spending (STLS), in which an adversary
sniffs the payment token, manages to halt the ongoing
transaction and transmits the token to a colluder to spend
it in a different transaction while the token is still valid.
Oftentimes, such an attack can also seamlessly trigger
a retry from the payer to let the original transaction go
through without arousing any suspicion. More speciﬁ-
cally, in Samsung Pay, we show that the attacker can pick
up the magnetic signals 3 meters away using a sensor,
and then automatically jam the wireless signals produced
by a mobile POS (mPOS) using a jammer (a commercial
device), causing a disruption between its communication
with the payment provider. As a result, the payment to-
ken is prevented from being delivered to the provider and
instead, recovered, demodulated and then spent in a dif-
ferent transaction (at a different location). After this is
done, the attacker stops the jamming, which enables a
retry from the shopper to complete the transaction. We
found that this attack can be realistically implemented,
as demonstrated in a video we posted online [1] (Sec-
tion 3.1). A similar attack also succeeds on Alipay, over
the audio channel: we utilized a recorder to capture the
token transferred through sound and again the jammer to
disrupt the payment transaction, before using the token
for another transaction (Section 3.2).
Alipay also supports payment through QR code scan.
In our research, we studied two payment scenarios: peer-
to-peer transfer and pay through POS. In the ﬁrst case,
the payer uses his phone to scan the payee’s QR code
displayed by her phone. Our study shows that a malicious
payer device or the one infected with an attack app can
not only steal the token from the payee’s screen, which
can later be used for over-the-counter payment (through
POS), but also stealthily force the payee device to refresh
its screen, causing it to generate a new token, therefore
preserving the original one for an unauthorized purchase
(Section 3). When it comes to POS-based payment, we
discovered that a malicious app running on the payer’s
device can stealthily halt the transaction by strategically
covering a few pixels on the screen when it is display-
ing the QR token to the POS machine. In the meantime,
we found that it is feasible to acquire the image of the
code from the reﬂection on the glass of the QR scanner’s
scan window (captured by the phone’s front camera) (Sec-
tion 3.3). Again, the demos of these attacks are available
online [1].
Mitigation. Our ﬁndings highlight the fundamental weak-
nesses of today’s mobile off-line payment schemes: one-
time token is insufﬁcient for defending against an active
adversary capable of stealthily disrupting a payment trans-
action (which is found to be completely realistic); also
given the error-prone nature of the channels (magnetic
ﬁeld, sound, QR scan) those schemes use, the validity
period of their payment tokens needs to be sufﬁciently
long to allow multiple retries, which leaves the door open
for the STLS attack. To mitigate the newly discovered
threats and enhance the security protection of the off-line
payment, we designed and implemented a new solution,
called POSAUTH, which authorizes the payer to use a
payment token only at a speciﬁc transaction. POSAUTH
is meant to be easily deployed, without changing hard-
594    26th USENIX Security Symposium
USENIX Association
ware of today’s POS systems. More speciﬁcally, each
POS terminal presents a QR code carrying its unique ID.
For each transaction, the payer is supposed to scan the
code to generate the payment token, which is bound to
the terminal. This binding, together with the valid period,
ensures that the token can only be used in the current
transaction (see Figure 1).
movie tickets, mobile payment has gained considerable
popularity in the past decades, and is expected to be used
by 90 percent of smartphone users in 2020[42]. Today,
a typical payment transaction through mobile devices in-
cludes three parties: the payer, the payee and the payment
service provider. Depending on the role played by the
provider, a payment transaction can be online or off-line.
Figure 2 illustrates the work-ﬂows of both payment meth-
ods. A prominent example of mobile online payment is
Mobile wallet, a scheme provided by PayPal, Amazon
and Google. A payment process through Mobile wallet
involves registration of a user’s phone number and acqui-
sition of a PIN for authentication. In a transaction, the
user enters the PIN to validate the payment that will be
charged to her account based upon the credit card or other
information (stored in her mobile device) given to the
service provider during the transaction.
Figure 1: The work-ﬂow of POSAUTH
Contributions. The contributions of the paper are out-
lined as follows:
• New ﬁndings and understandings. We report the ﬁrst
study on the STLS threat to mobile off-line payment. Our
research brings to light surprising security vulnerabili-
ties within high-proﬁle payment solutions, which subject
these schemes to the new type of payment frauds. Such
STLS attacks are found to be completely realistic, with
serious consequences, leading to unauthorized spending
of the payer’s token. The ﬁndings demonstrate the chal-
lenges in protecting these off-line payment schemes in
the presence of an active adversary.
• New protection. We made a ﬁrst step towards practi-
cally mitigating these STLS attacks through a new design
that binds the payer’s payment token to a speciﬁc POS
terminal, without changing the hardware of existing sys-
tems. We implemented this design, which is found to be
effective and efﬁcient in defending against the threat.
Roadmap. The rest of the paper is organized as follows:
Section 2 provides background information for our study;
Section 3 elaborates the STLS threats on Samsung pay
and Alipay; Section 4 presents our protection mechanism;
Section 5 discusses the limitations of our study and po-
tential future research; Section 6 compares our work with
related prior studies and Section 7 concludes the paper.
2 Background
In this section, we describe how mobile payment works,
the current protection in place and potential security risks.
Further we present the assumptions made in our research.
Mobile off-line payment. Since 1999, when Ericsson
and Telnor Mobil phones were ﬁrst used to purchase
Figure 2: The work-ﬂows of online and off-line mobile
payment methods
By comparison, a mobile off-line payment happens di-
rectly between the payer and the payee, with the provider
communicating with only one of these two parties in
the transaction. Oftentimes, the payer is a grocery shop-
per, with a smartphone carrying a shared secret with the
provider and the payee controls a POS device for commu-
nicating with the provider. An off-line transaction starts
when the payee creates a charge request through entering
payment information (e.g., amount, payment method) into
a POS terminal. Then, the payer is supposed to run her
payment app to establish a communication channel with
the POS for transmitting a token. Some of these channels
are described in Table 1. Such a token is generated using
a secret in the payer’s mobile digital wallet, the current
time and the challenge from the payee when it is available,
and other credential data.
Upon receiving the token, the POS terminal forwards
the token as well as other transaction information to the
payment service provider for veriﬁcation. From the token,
the provider ﬁrst recovers the owner information and then
veriﬁes its authenticity (whether it is issued by the owner)
and liveness (whether it has been used before and whether
USENIX Association
26th USENIX Security Symposium    595
(cid:1) Scan QR code on POS(cid:2) Get POS’s  unique id(cid:3) Generate payment token with POS id(cid:4) Transfer payment token(cid:5) Send  trans info, payment token, POS idtrans info***enter PINauthtrans info  & tokenpayment tokenpayment service providerpayment service providerpayeepayerpayeepayer(a) online payment(b) off-line paymentcan then be stolen and used for a different transaction.
Also this attack cannot be prevented by checking the live-
ness of the token, since the validity period often has to