    121.240.155.76
    121.240.155.77
    121.240.155.78
    223.30.98.169
    223.30.98.170
    14.140.116.172
### **SSL监听器功能**
植入体接受控制服务器返回的基于HTTP协议的命令，解析HTTP头部中的Content-Type以及Content-Length 字段。如果HTTP
Content-Type与下图中的值匹配，植入体就会执行控制服务器指定的命令：
    Content-Type: 8U7y3Ju387mVp49A
图16. 将HTTP Content-Type与某个值进行对比
**该植入体具备如下功能：**
1、将控制服务器返回的可执行文件写入某个临时文件中并加以执行。
图17. Proxysvc将某个二进制文件写入临时目录中并加以执行
2、收集系统信息并将信息发送给控制服务器。所收集的系统信息包括如下内容：
  * 端点的MAC地址
  * 计算机名
  * 从`HKLMSoftwareMicrosoftWindows NTCurrentVersion ProductName`注册表项所提取的产品名
  * 将以上信息拼接成一个字符串，字符串格式为`MAC_Address|ComputerName|ProductName`，然后将该信息发送给控制服务器
3、使用当前系统时间戳，将控制服务器返回的HTTP请求保存到植入体所在目录的prx临时文件中。
## 六、主植入体分析
2018年2月的植入体包含各种功能，包括获取数据以及在受害者系统上执行任意执行。由于该植入体可以从控制服务器那接受非常多的命令结构，因此这是一个用于数据侦察以及提取的通用型框架，可以用于更高级的场景。比如，该植入体可以擦除并删除文件、执行其他植入体、从文件中读取数据等等。
植入体首先会动态加载API，以便执行恶意操作。所导入的库列表如下所示：
    Kernel32.dll
    Apvapi32.dll
    Oleaut32.dll
    Iphlpapi.dll
    Ws2_32.dll
    Wtsapi32.dll
    Userenv.dll
    Ntdll.dll
图18. 主植入体动态加载API
在初始化阶段，植入体会收集基本的系统信息，通过443端口使用SSL协议将这些信息发送给硬编码的控制服务器（地址为`203.131.222.83`），这些信息包括：
1、系统区域设置中的国家/地区名称；
2、操作系统版本；
3、从`HKLMHARDWAREDESCRIPTIONSystemCentralProcessor
ProcessorNameString`注册表中提取的处理器描述信息；
4、计算机名以及网络适配器信息；
5、从`C:`到`Z:`的磁盘驱动器空间信息，包括磁盘空间总量（按字节计算）以及可用的空间（按字节计算）等；
6、当前内存状态，包括物理内存总量（按字节计算）以及总的可用内存等；
7、基于当前远程会话所得到的域名以及用户名。
图19. 使用Win32 WTS API获取域名以及用户名
### **数据侦察**
植入体通过SSL协议接受服务器返回的经过编码的命令。这些数据会被植入体解码然后提取正确的命令ID。正确的命令ID范围在0到0x1D之间。
图20. 根据命令ID值跳转至正确的命令执行分支
根据收到的命令ID值，植入体可以执行如下操作：
1、收集系统信息，传递给控制服务器（与前面提到的基础信息收集功能相同）。
2、获取系统中所有驱动器的磁盘卷信息（从`A:`到`Z:`），传递给控制服务器。
图21. 收集磁盘卷信息
3、列出某个目录中的文件。目录路径由控制服务器指定。
4、读取某个文件的内容，将其发送给控制服务器。
图22. 读取文件内容并将其发送给控制服务器
5、将控制服务器返回的数据写入指定的文件路径中。
图23. 以0标志（不共享）打开文件句柄以便写入文件
图24. 将控制服务器返回的数据写入文件
6、 根据控制服务器指定的文件路径创建新的进程。
图25. 根据控制服务器指定的二进制路径创建新的进程
7、擦除并删除由控制服务器指定的文件。
图26. 擦除并删除文件
使用`cmd.exe`执行系统上的某个二进制程序，将结果保存到某个临时文件中，然后读取该文件，将结果发送给控制服务器。所使用的命令行参数为：
    cmd.exe /c “ > %temp%PM*.tmp 2>&1”
图27. 执行命令并将结果保存到临时文件中
8、获取当前运行的所有进程的信息。
图28. 获取系统上所有进程的进程时间
图29. 获取某个进程所对应的用户名以及域名
9、使用批处理文件实现自删除。
图30. 创建批处理文件自删除
10、接收控制服务器返回的数据并保存为注册表项，注册表路径为：
    HKLMSoftwareMicrosoftWindowsCurrentVersionTowConfigs Description
11、设置并获取植入体的当前工作目录。
图31. 设置并获取植入体进程的当前工作目录
在植入体中，每个命令所对应的处理函数索引表如下所示：
图32. 命令处理函数索引表
## 七、总结
根据分析结果，McAfee ATR团队发现了之前未发现过的一些组件，我们认为这些组件与Hidden
Cobra密切相关，该组织一直并继续以全世界各地的组织为攻击目标。这些数据收集植入体的复杂程度越来越高，表明攻击者具备先进的攻击能力并一直在持续开发工具。我们调查后还发现与最近攻击活动有关的未知基础架构，这些攻击活动的服务器位于印度境内，使用了先进的植入体来创建隐蔽型网络，以收集数据并发起后续攻击。
随着调查的进一步深入，McAfee ATR团队会继续提供后续研究成果。
打击网络犯罪需要全世界范围内公共及私人部门的努力及合作。McAfee正与泰国政府当局合作，取缔Operation
GhostSecret控制服务器基础设施，同时保留涉事系统以供执法机构进一步分析。通过与全球执法机构建立并维护合作伙伴关系，McAfee将与各位共同进步并不断成长。
## 八、IoC
McAfee将这款植入体标识为`Trojan-Bankshot2`。
相关IP地址为：
    203.131.222.83
    14.140.116.172
    203.131.222.109
样本哈希值为：
    fe887fcab66d7d7f79f05e0266c0649f0114ba7c
    8f2918c721511536d8c72144eabaf685ddc21a35
    33ffbc8d6850794fa3b7bccb7b1aa1289e6eaa45
[原文链接：https://securingtomorrow.mcafee.com/mcafee-labs/analyzing-operation-ghostsecrt-attack-seeks-to-steal-data-worldwide](https://securingtomorrow.mcafee.com/mcafee-labs/analyzing-operation-ghostsecret-attack-seeks-to-steal-data-worldwide)