(Un) Fucking Forensics0
Ac#ve/Passive+memory+hacking/debugging+
+
K2+/+Director+@IOACTIVE+
hBps://github.com/K2+
+
About me?0
•  Hacker+for+a+while+
•  inVtero.net++
•  Memory+analysis+framework+for+Windows++
•  Super+fast/GBPS+throughput+
•  Memory+integrity+checking+of+VM’s/CrashDumps/Memory++
•  Type+aware+memory+hacking+tool++
•  EhTrace+
•  Binary+trace+tool+
•  Uses+hook/patch-less+technique+for+in-process+debugging++
•  Lots+of+other+stuﬀ+
Outline / areas0
•  How+to+forensic,+how+to+Fuck+forensics+and+how+to+un+fuck+it.+
•  Intx80+AF+technique+on+header+wipe/non-resident+code/trim()++
•  How+to+deal+with+that+
+
•  RoP+background,+how+it’s+used+in+aBacks+
•  Gargoyle+aBacks+&+how+to+protect+against+them+
+
•  CloudLeech+–+twist+on+UlfFrisk+DMA+aBacks+/+PCILeech+
•  Demo+of+open+source+memory+integrity+pla_orm+for+Windows!+
Can you even 
forensic?0
•  In+general:++Determine+what+happened.++
Make+a+!meline+of+known+events.+
•  “Ar!facts”+disk+&+memory+(ocen+incomplete/
fragmented)+used+to+build+#meline.+
•  How+good+can+we+do?++How+do+we+know+if+were+
done?++
Ar>fact 
sources 
How 
aAestable are 
they? 
0
•  Time+stamps+from+all+sources+to+derive+!meline+
(event+logs/syslog/ﬁrewall/ﬁlesystem+#me,+etc…)+
•  Wevtu!l+-+Windows+Events+Command+Line+U#lity.++
Conﬁgure+more+than+1189+event+log+sources+
•  SysMon+(from+SysInternals/Mark+Russinovich)+/+neat+
conﬁg:+
hBps://github.com/SwicOnSecurity/sysmon-conﬁg+
•  Linux+(osquery+
hBps://github.com/facebook/osquery+)++
+
Handling memory0
•  Forensics+meets+Reverse+Engineering+
•  Dump+/+disassemble+determine+what+the+extent2of2capability2the2a8acker2possesses2
•  I+want+to+at+least+clear2this2guy2out2&+ﬁnd+out+how2much2damage2he+did+
•  Vola#lity/Rekall+python+forensic+engines++
•  Stephen+Ridley’s+RE+memory+hacking+tool:++hBps://github.com/s7ephen/SandKit++
•  Paper:+Escaping+the+sandbox+
•  GAME+HACKING!+J+
•  Let’s+look+at+what+people+do+to+cheat+some#me?+
How to F’it?
0
•  Hide+really+well+
•  Wipe/Destroy+logging/leave+no+
trace/Stenography/Encrypt+
•  Misdirect+
•  Flood/Annoy/Make+analysis+so+
costly$$$/Obfuscate/Spoof/+
•  Direct+ABack++
•  DefCon+15:+Breaking+Forensics+
Socware:+Weaknesses+in+Cri#cal+
Evidence+Collec#on+Chris+Palmer,+
Alex+Stamos+
An#-forensics:+Furthering+digital+forensic+science+through+a+new+extended,+
granular+taxonomy:++
+
Foreshadowing: normalize you’re opera>ons0
•  A+great+way+to+operate+undetected+is+to+ensure+you+are+not+an+
anomaly.+++
•  Use+the+resources+of+you’re+target+to+conduct+you’re+opera#ons.+
•  “Conﬁgura#on”+aBacks++
•  Enable+IPV6+tunneling+&+VPN+access++
•  ABacker+has+trusted+CA+capability+(added+their+privkey+to+trusted+list)+
•  The+more+“normal”+the+method+will+be+very+hard+to+dig+up+
Int0x80’s AF counter
0
ABack+against+a+tool:+
Rekall+
• Prevent+dumping+for+working+
More+ways+to+get+it;+
• Use+VAD+(kernel+source)+
• Use+PageTable+(ABI)+++
• Use+inVtero.net+
• dump.py+-+VADDump+(VAD)+or++
Dump+(PageTable)+
RoP: More normal0
•  RoP+is+an+ocen+discussed+topic+used+mostly+for+exploita#on+
•  RoP+uses+the+CPU+stack+seman#cs+to+execute+as+if+it+were+a+really+large+set+of+return+
statements.+
•  This+uses+the+code+that’s+already+on+the+system+more+“normalized”+than+if+you+had+to+inject+
an+executable+payload+that+did+not+originate+from+the+target+
•  RoP+is+used+by+Gargoyle+(Josh+Lospinoso)+as+an+example+of+a+persistence+
technique+that+evades+memory+analysis+systems+
•  There+is+hope,+we+can+detect+RoP+aBacks+through+call+chain+evalua#on+
RoP is not 
perfect0
hBps://www.cs.columbia.edu/~angelos/Papers/theses/vpappas_thesis.pdf+
Gargoyle 
persistence0
•  Leverages+a+#mer+and+blocking+
wait+that+moves+it+into+the+“ac#ve+
state”+
•  Once+ac#ve,+stages+page+
protec#on++X+
•  Then+uses+this+page+to+invoke+it’s+
primary+payload+
•  It+then+mask’s+the++X+bit+back+oﬀ+
and+goes+inac#ve+
Tools too defend against RoP aAack?0
•  Analysis:+ROPEMU:+A+Framework+for+the+Analysis+of+Complex+Code-
Reuse+ABacks+
•  Dump+a+complex+RoP+execu#on+trace+into+an+ELF+!!+Wow!+
•  Detec#on:+inVtero.net+can+perform+a+stack+checking+func#on+against+
the+memory+dump.+
•  Similar+tools+for+monitoring+RoP+at+run+#me+(EhTrace,+RoPGuard,+etc…)+
•  From+the+inVtero+output,+you+really+do+NOT+want+to+see+the+Gargoyle+gadget,+
or+anything+that+looks+like+a+stack+pivot++
Injec>on techniques0
•  Many+variega#ons+to+achieve+the+same+goal;+
•  10+Process+Injec#on+Techniques+(Ashkan+Hosseini/Endgame)+
•  LoadLibrary,+Hallowing,+Thread+hijacking,+Windows+Hooks,+Registry+
keys,+APC,+SetWindowLong,+Shims+&+IAT+shims+
•  Flame+was+a+sort+of+hallowing+aBack+
•  “hid”+inside+of+ntdll,+remained+undetected+for+years+
Enter DMA with PCILeech 0
•  +Ulf+Frisk+Direct-Memory-ABack-the-Kernel:+
•  PCILeech+aBacks+and+u#lity+for+forensics+(memory)+collec#on+
•  Uses+a+variety+of+(very+cool)+techniques+to+execute+payloads+
•  One+of+the+simplest+is+the+“unlock”+func#onality+
•  It’s+an+inline+patch+however+
•  Hard+to+detect+w/o+manual+reversing+
Integrity valida>on 0
•  Full+valida#on+at+any+point+in+#me+must+be+able+to+be+conducted+
•  System+state+should/must+be+sta#c++
•  CPU+execu#on+will+allow+aBackers+to+play+games+/+evade+read’s+
•  RDMA++
•  LiveMigra#on+/+Snapshowng+
Tie it together0
Un+F’d+Memory+Forensics+–+Remove+the+guesswork+
+
•  Leverage+wide+range+of+informa#on+sources+
•  Have+a+comprehensive+global+view+of+the+data+set+
•  Appropriate+countermeasures+for+most+aBackers+(RoP)+
•  Integrity+checking+of+memory+(in+line+patch+protec#on)+
•  Symbols+and+context+for+analysis+of+pointers++
•  Pointer+tracking+becomes+more+signiﬁcant+as+we+can+qualify+their+address/vector+
Demo’s & Thank you0
•  Check+out+the+tools++
Github.com/K2+