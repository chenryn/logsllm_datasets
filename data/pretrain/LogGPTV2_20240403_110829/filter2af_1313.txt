### 优化后的文本

---

#### 概述
近期，研究人员发现了一种通过RIG Exploit套件传播的rootkit——CEIDPageLock。该rootkit最初由360安全中心在5月份发现，其主要功能是修改受害者的浏览器主页。本质上，CEIDPageLock是一种浏览器劫持器，它会将受害者的浏览器主页更改为2345.com。

最新版本的CEIDPageLock在浏览器劫持方面更加高效，并引入了一些新的功能，例如监控用户的浏览行为以及用虚假主页动态替换主流中文网站的内容。这种恶意软件通过重定向受害者到特定搜索引擎等方式来盈利。此外，攻击者还会利用各种劫持技术收集用户数据，包括访问记录和网页停留时间，这些信息随后被用于定向广告投放或出售给其他公司。

根据Check Point的数据，CEIDPageLock主要针对中国境内的用户，其他国家的受害者数量相对较少。

**图1：不同国家感染数据**

#### Dropper
Dropper的主要任务是从文件中提取驱动程序并将其保存到`\\Windows\\Temp`目录下，文件名为`houzi.sys`（早期版本中的驱动程序名为`CEID.sys`，这也是恶意软件名称的来源）。释放的驱动程序使用了浙江恒歌网络科技有限公司的数字签名证书，但该证书已被撤销。

在注册和启动驱动程序后，dropper会向域名`www[.]tj999[.]top`发送受感染主机的MAC地址和用户ID，使用的HTTP请求头为`GET /tongji.php?userid=%s&mac=%s HTTP/1.1`。

#### 驱动程序
驱动程序是一个32位的内核模式驱动，在系统启动时加载。为了避开终端安全产品的检测，驱动程序采用了多种隐蔽技术。其主要功能是连接两个硬编码的C2域名，下载所需的主页配置文件。下载加密主页的请求头如下所示：

**图2：向C2服务器请求主页的请求头**

解密后的主页为`588[.]gychina[.]org`，而劫持后的主页URL为`111[.]l2345[.]cn`。尽管页面伪装成`2345.com`，但实际上会收集受害主机的数据，使攻击者能够从每次查询中获利。

**图3：劫持后的主页**
**图4：劫持主页的源代码**

#### 版本差异
与第一个版本相比，新版本的rootkit使用了VMProtect进行打包，这使得恶意软件的分析和逆向工程变得更加困难，特别是对于内核模式的驱动程序。

**图5：每个API调用的VMProtect混淆**

新版本增加的一个重要功能是重定向机制。当用户尝试访问主流中文网站时，rootkit会发送一个虚假主页。具体来说，rootkit会在启动时打开`\\Driver\\AFD`，并使用`AfdFastIoDeviceControl`方法。通过这种方法，rootkit会检查HTTP消息中是否包含以下字符串：

**图6：在重定向到劫持主页的URL中搜索的字符串**

一旦在HTTP包中找到这些字符串，rootkit就会将其添加到重定向进程列表中。随后，rootkit会检查每个接收到的消息，如果调用`recv`方法的进程在该列表中，则将相应的内容替换为`111[.]l2345[.]cn`页面的内容。这种方法比传统的HTTP重定向更为隐蔽，因为浏览器显示的URL并未发生变化。

**图7：Sohu.com重定向劫持页面**
**图8：Sohu.com重定向改变了源页面**

360对旧版CEIDPageLock的分析表明，该恶意软件会拦截浏览器访问反病毒文件。新版CEIDPageLock在此基础上增加了更多反病毒文件的拦截。

**图9：新旧版本中“access disabled files”方法的区别**

此外，恶意软件开发者还在360安全产品safemon中加入了一个创建注册表的方法，作为rootkit安装过程的一部分。Rootkit会将注册表项`\Registry\Machine\Software\Wow6432Node\360Safe\safemon\ATHPJUMP`的值设置为0。

**图10：Safemon注册表创建方法**

#### 结论
虽然开发一个具有VMProtect保护措施的浏览器劫持rootkit看似有些过度，但这种简单的恶意技术却能带来巨大的利润。因此，攻击者愿意投入大量精力来创建一个隐蔽且持久的工具。

CEIDPageLock可能看起来并不特别危险，但由于其能够在受感染设备上执行代码并保持持久性，使其成为一个理想的后门。

**IOCs:**
- `www[.]tj999[.]top`
- `42.51.223.86`
- `118.193.211.11`

**MD5:**
- `C7A5241567B504F2DF18D085A4DDE559` - 打包的dropper
- `F7CAF6B189466895D0508EEB8FC25948` - `houzi.sys`
- `1A179E3A93BF3B59738CBE7BB25F72AB` - 解包的dropper

更多详细信息，请参见360的安全分析报告。

---