■ 用户：设置某个用户在单位时间内被调用的总数不能超过阈值，
超过阈值触发限流或熔断机制。一个用户可能会调用多个API端点，一
个用户可能会拥有多个应用程序，统计其单位时间内的流量总和。
在设置限流或熔断策略时，注意同时使用多个策略的情况下，各个
策略触发的优先级，防止出现机制混乱或机制失效。而对于具体规则的
制定，在API接口层面，至少从以下三个方面的考虑。
■ API调用频次。
■ API调用时长。
■ API调用总数。
这三个方面的数据反映出API服务当前资源的消耗情况。制定规则
时要从这三个方面考虑，并以组合的方式确定触发流量限制的具体规
则，嵌入API调用的流程中，以判断当前限流熔断规则是否触发，调用
请求是阻断还是放行。
6.3 常用场景安全设计
前文中讨论了API安全的关键技术，在实际应用中，如果不是具备
研发能力的企业或团队，很难自己去实现API安全需要的安全机制来保
护API，往往结合业务的技术架构，参考5A原则和纵深防御原则，引入
内外部安全组件，来系统性地解决API安全问题。这里，为读者选取南
北向的API安全防护与东西向的API安全防护作为范例，讲解常见场景
下的API安全设计。
6.3.1 API安全中南北向流量与东西向流量的概念
在IT信息系统中，通常把数据中心IDC内部与外部的通信流量称为
南北向流量，把IDC内部相互通信的流量称为东西向流量。在API技术
架构中，根据API所承载业务功能服务范围的不同，将API划分为公有
API、私有API和混合型API（见1.2.2节），但在实际的网络环境中，不
同类型的API服务部署在网络中的位置可能未严格地按照安全区域划分
后的部署。所以，参考IDC通信流量的划分方式，将系统外部与内部交
互的API流量称为南北向流量，将系统内部交互的API流量称为东西向
流量。如图63-12所示是某系统的API网络流量示意图，通过图6-12中的
内外部通信交互，读者可以对南北向、东西向流量有一个直观的了解。
●图6-12 API网络流量示意图
在图6-12中虚线部分表示的为南北向流量，实线部分表示的为东
西向流量。
6.3.2 API网关与南北向安全设计
互联网技术发展到今天，各大企业的应用系统架构早已从初级的单
体架构、分层架构进化成更具有拓展性、易于管理的分布式架构或微服
务架构。近些年，随着云厂商的崛起，Serverless架构也逐渐被推广开
来。无论是哪种架构，内外部通信的技术都大量地依赖API来实现。当
内部组件越来越多，对外提供的业务功能越来越模块化后，给日常的技
术管理带来更多的问题。
1.问题一：非业务功能模块的重复或冗余
为了保障信息系统的可管理性和易用性，在建设过程中通常会增加
一些额外的功能模块，比如系统监控。系统监控功能与业务是无关的，
有没有系统监控只要业务功能完善，用户都可以使用系统或平台，添加
系统监控功能是为了便于系统管理人员和系统运维人员更好地监控系统
的运作状态，及时、尽早地发现系统中可能存在的问题，并根据监控信
息做出相应的调整。而安全机制也类似，尤其是当每一个业务组件或服
务、微服务都去实现这些安全机制时，安全功能的重复建设就会凸显出
来，如图6-13所示。
●图6-13 安全模块功能重复示意图
2.问题二：多端、多协议的兼容性问题复杂
企业对外提供的业务功能面向不同的用户群体，网络环境和客户端
设备各不相同，比如移动App应用程序、H5应用程序、普通的Web应用
程序、小程序、IoT设备等，为了兼顾多端的使用，接口实现变得更加
复杂。同时，因为系统建设的时期不同，存在多种不同技术实现的应
用，在接口技术上也不尽相同，比如SOAP API、RESTful API、RPC服
务等。这些问题的解决，在系统架构上需要一个组件来进行不同协议间
的转换和接口管理。
3.问题三：业务功能合并和边界防护
当系统架构在模块化拆分之后，业务上或第三方合作厂商在使用这
些接口时，往往一次性需要调用多个接口才能完成一个业务所需要的功
能。同时，模块化拆分之后使得面向外部暴露的攻击面变大，也难以管
理。
为了解决这些问题，在架构中引入API网关成为首选的解决方案。
一个典型的API网关产品至少包含统一接入、协议适配、流量控制、安
全防护等基本功能，网关负责各种类型API的统一接入，并将不同的请
求协议转换成内部API可理解的接口协议，再通过身份鉴别、访问控
制、限流、降级、熔断等措施，对确认放行的请求经过路由策略进行转
发，共同保护网关的整体稳定性。API网关在系统架构中位置的示意
图，如图63-14所示。
●图6-14 API网关在系统架构中的位置
使用API网关后，在整个架构上，API网关对外部提供统一的API调
用入口，并在系统边界为内部的可调用API提供保护。API网关就像所
有后端服务的大门，当前端请求过来之后，首先经过API网关的身份认
证、访问控制、流量控制等安全控制措施，API网关确认通过后，再向
后端服务转发请求。API网关本身提供的数据转换、负载均衡、消息加
密等功能降低了各个后端组件或模块技术实现的复杂度，屏蔽了后端服
务在技术上的复杂性和差异性。
对于客户端接入来说，原来需要对接不同的后端服务或组件，现在
只需要对接API网关即可，在使用流程上更为方便、简洁，用户体验也
更好。
目前市场上，API网关可供选择的产品很多，既有开源产品也有商
业产品，比如Kong、Zuul、Tky、Apigee等。关于API网关的更多信
息，将在第11章为读者做详细介绍。
6.3.3 微服务与东西向安全设计
介绍了使用API网关来保护南北向API的安全，接下来再来介绍在
系统内部的各个服务或组件之间的东西向API安全是如何保护的。东西
向API更多的是系统内部的相互调用，通常不经过API网关。当不使用
API网关时，安全问题的解决也成了微服务能力构建的一部分。在微服
务架构中，常见的安全问题如下。
■ 微服务与微服务之间身份互信问题。
■ 微服务与微服务之间访问控制问题。
■ 微服务与微服务之间的通信链路安全问题。
■ 微服务的日志审计与调用链跟踪问题。
作为架构师或架构设计人员，通常将安全设计融入整体的微服务架
构中，系统化、模块化的解决上述安全问题。典型的微服务架构如图6-
15所示。
●图6-15 微服务架构示意图
在这个架构中，身份合法性验证通常依赖APP ID/API KEY或数字
证书，访问控制依托OAuth 2.0协议通过JWT令牌充当虚拟身份作为认证
和授权的凭证，在各个微服务之间共享。而通信安全依赖于mTLS或
HTTPS来保障链路的安全性，微服务架构中的安全机制如图6-16所示。
●图6-16 微服务架构中主要安全机制
这些技术细节，将在接下来的第7～9章为读者做详细的阐述。当
然，在有些架构设计中，会使用多个API网关，一个作为内部API接入
网关使用，一个作为外部API接入网关使用。
6.4 小结
本章从API安全设计的角度，概要地介绍了与API安全相关的关键
技术。本章首先介绍了安全设计的两个基本原则：5A原则和纵深防御
原则。这两个原则是安全设计的基础，分别从宽度和深度两个方面来指
导安全设计的合理性和全面性。接着从API安全技术栈的层次依次介绍
了身份认证技术、授权与访问控制技术、消息保护技术、日志审计技术
以及威胁防护技术，并通过南北向与东西向安全设计两个范例，概要性
地讲述了这两个场景下的安全设计框架，为后续各个章节的技术细节导
入做铺垫。
第7章 API身份认证
在整个安全技术体系中，对用户身份的认同和信任是构建整个计算
机网络的基础，身份认证技术作为一道重要的防线，有着不同寻常的意
义。在现实生活中，需要进行身份认证的场景有很多。比如，去超市购
物，打折结算时验证超市会员身份，需要客户提供会员卡；出门旅行乘
坐高铁，购票时需要身份证来验证身份，进站也同样需要；甚至跟朋友
去看一场电影，进场时现场服务人员通过验证电影票来确定场次、座位
等。这些都是日常生活中身份认证的例子，在API技术的世界中，需要
进行身份认证的场景也同样存在。
7.1 身份认证的基本概念
身份认证技术是随着计算机网络的发展而出现的，企业或组织使用
身份认证技术来确认用户身份，以确保它们知道正在使用自己服务的客
户是谁，以此来确保用户使用数据的合法性和安全性。近些年，随着网
络安全和数据安全的立法，对于可验证、可信任身份的需求也在增加，
这对企业或组织提出了更高的合规性要求。那么到底什么是身份认证
呢？
顾名思义身份认证，是对于身份的认证或鉴别，在业务流程中结合
技术手段，完成对某种身份的确认。这里的某种身份可能是基于真实的
自然人信息的用户身份，也可能是服务器、硬件设备、移动终端的身
份，还有可能是运行的应用程序或服务的身份。在计算机领域，身份认
证的方式有很多，比较常见的有静态密码、动态口令、短信码、数字证
书、生物特征等。
■ 静态密码：此种方式最为常见，比如各个互联网应用所使用的用
户注册后的密码登录场景，即通过用户名+密码组合的方式来确认用户
的身份。
■ 动态口令：又称为软令牌，是指通过客户端应用随机生成一个组
动态口令作为用户身份鉴别的依据。通常在后端依赖时间同步和令牌生
成算法的一致性来保障动态口令的校验。
■ 
短信码：在互联网应用中尤为常见，尤其是实施网络实名制之
后，很多互联网应用默认使用手机号和短信码的组合来验证用户身份。
■ 数字证书：主要利用密码学中公钥和私钥的密钥对，通过数字签
名和加密通信服务保障和验证用户身份。
■ 生物特征：此类身份认证目前业界正大范围使用，最常见的如人
脸识别、指纹识别、虹膜识别等。使用生物特征技术进行身份认证的场
景下，如何做好个人信息的隐私保护是一项具有挑战性的工作。
7.1.1 身份认证在API安全中的作用
身份认证技术在API安全中的使用场景也是比比皆是，但在相当长
的一段时间内，不少企业缺少正确使用API身份认证的安全意识，导致
安全事件频发。企业使用身份认证技术来确认用户身份，保障其使用数
据的合法性和安全性。在API方面，也需要使用身份认证技术，保障
API使用的合法性和安全性。正确使用API身份认证技术，能够解决很
多基础的安全问题。
从技术角度来说，通过身份认证识别身份后的用户才能访问某个
API接口、数据和资源，并且访问控制程序依赖于识别身份后的用户信
息，提供权限的校验和控制。这对API自身的保护和API接口数据的保
护尤为重要。同时，接口调用过程中记录的审计日志也依赖识别身份后
的用户信息，记录和统计用户请求与行为。身份认证技术就像是API安
全的第一道门禁，守护着API安全的大门，保护企业和信息资产被合法
地访问和使用。如果一个API服务缺失身份认证技术或身份认证机制被
攻破，那么针对用户请求所做的访问控制、审计日志也就失去了意义，
形同虚设。
从管理角度来说，当前的网络环境下，面对越来越猖獗的网络安全