# XcodeGhost截胡攻击与服务端复现及UnityGhost预警

#### 译文声明
本文为翻译文章，原文来源：drops.wooyun.org。译文仅供参考，具体内容和含义以原文为准。
作者: 没羽, 蒸米, 阿刻, 迅迪 @ 阿里移动安全

## 0x00 序言
“截胡”一词源自麻将术语，指在某位玩家打出一张牌后，如果多人同时需要这张牌来胡牌，只有逆时针方向最近的玩家算作胡牌，其他人则不算。该词现在也常被引申为抢夺他人即将到手的利益或成果。

尽管XcodeGhost恶意软件的服务器已被关闭，但受感染的应用程序仍在持续向特定域名（如init.icloud-analysis.com、init.icloud-diagnostics.com等）发送请求。此时，黑客可通过DNS劫持或污染技术冒充这些域名，从而重新控制受影响的应用程序。关于其潜在危害，请参阅下文分析部分。

此外，有证据显示Unity 4.6.4至5.1.1版本的开发工具同样受到污染，并表现出与XcodeGhost相似的行为特征。更令人担忧的是，XcodeGhost的开发者似乎仍然逍遥法外。更多细节请见第三节内容。

注：虽然涅槃团队已发布了相关攻击演示代码，但并未公开所有技术细节。因此，本文旨在提供更为详尽的分析过程供读者参考。

## 0x01 通信协议解析
受感染客户端应用程序中的`Response`方法负责接收并处理来自远程服务器的指令。根据我们对样本的研究，它大约支持四种类型的远程命令：设置休眠时间、弹出消息框、执行URL Scheme以及打开App Store页面。通过组合使用这些命令，可以实现多种攻击手段，例如下载安装带有企业签名的应用、推广特定App Store应用、展示钓鱼网站以窃取用户信息等。

此通信机制基于HTTP协议，在传输前采用DES算法加密HTTP Body部分。`Response`方法接收到数据后，调用`Decrypt`函数进行解密操作。若解密成功，则将结果转换为JSON格式以便进一步处理。例如，设置客户端请求间隔时间的操作如下图所示：

![设置客户端请求间隔时间](此处插入图片链接)

## 0x02 恶意行为分析及模拟重现
通过对该样本远程控制代码进行逆向工程，我们还原了其服务端逻辑，以深入探讨可能存在的风险。

首先，我们在服务端打印出了请求的数据结构，如下图所示：
- 协议头部由三部分组成：前4字节表示报文体长度；接下来2字节指示命令长度；最后2字节记录版本号。
- 头部之后紧跟的是经过DES加密的数据。

![请求数据结构](此处插入图片链接)

解密后的数据显示，服务端能够收集客户端上传的信息，并据此返回相应的控制指令。

### 恶意行为一：定向推送诈骗消息
当服务端下发的数据中包含`alertHeader`、`alertBody`、`appID`、`cancelTitle`、`confirmTitle`、`scheme`字段时，客户端将调用`UIAlertView`显示自定义的消息窗口。这些消息的内容完全由服务端控制。

![诈骗消息示例](此处插入图片链接)

### 恶意行为二：下载企业证书签名的应用
若服务端发送的数据中同时存在`configUrl`和`scheme`字段，则客户端会访问指定URL以下载并安装相应的企业签名应用。

![下载企业证书应用](此处插入图片链接)

### 恶意行为三：推送钓鱼网页
利用相同的方法，还可以配置服务端使客户端加载特定钓鱼页面。

![钓鱼网页示例](此处插入图片链接)

### 恶意行为四：推广App Store应用
最后，服务端亦可配置URL指向App Store中的某个应用，促使客户端自动跳转至该应用的下载界面。

![App Store推广示例](此处插入图片链接)

## 0x03 UnityGhost？
正当人们以为事件已经平息之时，百度安全实验室宣布确认发现了一个名为“Unity-4.X”的感染样本，其行为模式与XcodeGhost高度一致，只是C&C服务器地址变为了init.icloud-diagnostics.com。这意味着任何使用了受污染版本Unity引擎开发的应用都可能存在隐私泄露及广告推送的风险。

更令人震惊的是，在百度安全实验室发布报告不久后，有人注意到自称XcodeGhost作者的用户codeFun竟然在深夜时刻活跃于网络论坛，并迅速删除了自己发布的有关Unity工具中毒的相关帖子。这无疑增加了外界对于XcodeGhost幕后主使身份及其活动范围的猜测。

## 0x04 结论
即便XcodeGhost的原作者声称未曾实施过任何非法行为，但这并不排除其他不法分子利用其漏洞从事恶意活动的可能性。鉴于目前情况，建议立即卸载所有已知存在问题的应用程序！

## 0x05 参考资料
- [涅槃团队报告：Xcode幽灵病毒存在恶意下发木马行为](链接)
- [XcodeGhost源码](链接)