    if (nla_len(rt) id.proto != IPPROTO_ESP) && (p->id.proto != IPPROTO_AH))
    return -EINVAL;
    if (p->replay_window != 0)
    return -EINVAL;
    return 0;
    }
è¿™ä¸ªå‡½æ•°è¦æ±‚replay_state_esnç»“æ„çš„bmp_lenä¸å¯ä»¥è¶…è¿‡æœ€å¤§é™åˆ¶XFRMA_REPLAY_ESN_MAXã€‚
å¦å¤–ï¼Œåœ¨è¿™ä¸ªåˆ›å»ºxfrm_stateçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ£€æŸ¥åˆ°æˆå‘˜ä¸­æœ‰xfrm_replay_state_esnç»“æ„ï¼Œå¦‚ä¸‹å‡½æ•°ä¸­çš„æ£€æŸ¥ä¾¿ä¼šè¢«æ‰§è¡Œã€‚
    int xfrm_init_replay(struct xfrm_state *x)
    {
    struct xfrm_replay_state_esn *replay_esn = x->replay_esn;
    if (replay_esn) {
    if (replay_esn->replay_window >
        replay_esn->bmp_len * sizeof(__u32) * 8) props.flags & XFRM_STATE_ESN) {
    if (replay_esn->replay_window == 0)
    return -EINVAL;
    x->repl = &xfrm_replay_esn;
    } else
    x->repl = &xfrm_replay_bmp;
    } else
    x->repl = &xfrm_replay_legacy;
    return 0;
    }
è¿™ä¸ªå‡½æ•°ç¡®ä¿äº†replay_windowä¸ä¼šæ¯”bitmapçš„é•¿åº¦å¤§ï¼Œå¦åˆ™å‡½æ•°ä¼šç›´æ¥é€€å‡ºã€‚
ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹xfrm_new_aeè¿™ä¸ªå‡½æ•°,å®ƒé¦–å…ˆä¼šè§£æç”¨æˆ·æ€ä¼ å…¥çš„å‡ ä¸ªattrï¼Œç„¶åæ ¹æ®spiçš„å“ˆå¸Œå€¼ä»¥åŠipæ‰¾åˆ°æŒ‡å®šçš„xfrm_stateï¼Œä¹‹åxfrm_replay_verify_lenä¸­ä¼šå¯¹ä¼ å…¥çš„replay_state_esnç»“æ„åšä¸€ä¸ªæ£€æŸ¥ï¼Œé€šè¿‡åå³ä¼šè°ƒç”¨xfrm_update_ae_paramså‡½æ•°æ¥æ›´æ–°å¯¹åº”çš„xfrm_stateç»“æ„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹xfrm_replay_verify_lenè¿™ä¸ªå‡½æ•°ã€‚
    static inline int xfrm_replay_verify_len(struct xfrm_replay_state_esn *replay_esn,
     struct nlattr *rp)
    {
    struct xfrm_replay_state_esn *up;
    int ulen;
    if (!replay_esn || !rp)
    return 0;
    up = nla_data(rp);
    ulen = xfrm_replay_state_esn_len(up);
    if (nla_len(rp) repl->advance(x,
seq);ï¼Œå³xfrm_replay_advance_esnè¿™ä¸ªå‡½æ•°ã€‚
è¿™ä¸ªå‡½æ•°ä¼šå¯¹bitmapè¿›è¡Œå¦‚ä¸‹æ“ä½œ
**1.æ¸…é™¤[last seq, current seq)çš„bit**
**2.è®¾ç½®bmp[current seq] = 1**
æˆ‘ä»¬å¯ä»¥æŒ‡å®šå¥½spiã€seqç­‰å‚æ•°(å†…æ ¸æ˜¯æ ¹æ®spiçš„å“ˆå¸Œå€¼ä»¥åŠipåœ°å€æ¥ç¡®å®šSAçš„)ï¼Œå¹¶è®©å†…æ ¸æ¥å¤„ç†æˆ‘ä»¬å‘å‡ºçš„ESPæ•°æ®åŒ…ï¼Œå¤šæ¬¡è¿›è¡Œè¿™ä¸ªæ“ä½œå³å¯è¾¾åˆ°å¯¹è¶Šç•Œä»»æ„é•¿åº¦è¿›è¡Œå†™å…¥ä»»æ„å€¼ã€‚
**(3).è¶Šç•Œè¯»**
æˆ‘ä»¬çš„æ€è·¯æ˜¯ä½¿ç”¨è¶Šç•Œå†™ï¼Œæ”¹å¤§ä¸‹ä¸€ä¸ªreplay_state_esnçš„ç»“æ„ä¸­çš„bmp_lenã€‚ä¹‹åæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ä¸‹ä¸€ä¸ªbitmapç»“æ„è¿›è¡Œè¶Šç•Œè¯»ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªç›¸é‚»çš„replay_stateç»“æ„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨defragmentæŠ€å·§æ¥è¾¾åˆ°è¿™ä¸ªæ•ˆæœã€‚å³é¦–å…ˆåˆ†é…è¶³å¤Ÿå¤šçš„åŒæ ·å¤§å°çš„replay_stateç»“æ„æŠŠå †ä¸ŠåŸæ¥çš„å‘å¡«æ»¡ï¼Œä¹‹åä¾¿å¯å¤§æ¦‚ç‡ä¿è¯è¿ç»­åˆ†é…çš„replay_stateç»“æ„æ˜¯ç›¸é‚»çš„ã€‚
å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨è¶Šç•Œå†™çš„èƒ½åŠ›å°†ä¸‹ä¸€ä¸ªbitmapé•¿åº¦æ”¹å¤§ï¼Œå³å¯ä½¿ç”¨è¿™ä¸ªbitmapç»“æ„åšè¶Šç•Œè¯»äº†ã€‚
å›¾ä¸­æ‰€ç¤ºä¸ºè¢«æ”¹æ‰bmp_lençš„bitmapç»“æ„ã€‚
**(4).ç»•è¿‡kASLR**
æˆ‘ä»¬é€šè¿‡xfrm_del_saæ¥å£æŠŠæ²¡ç”¨çš„xfrm_stateéƒ½ç»™åˆ æ‰ã€‚è¿™æ ·å°±å¯ä»¥åœ¨å †ä¸Šç•™ä¸‹å¾ˆå¤šçš„å‘ã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥å‘å†…æ ¸å–·å°„å¾ˆå¤šstruct
fileç»“æ„ä½“å¡«åœ¨è¿™äº›å‘é‡Œã€‚
å¦‚ä¸‹ï¼Œåˆ©ç”¨ä¸Šé¢å·²ç»æ„é€ å‡ºçš„è¶Šç•Œè¯»èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥æ³„éœ²ä¸€äº›å†…æ ¸é‡Œçš„æŒ‡é’ˆæ¥ç®—å‡ºå†…æ ¸çš„åŠ è½½åœ°å€å’Œbitmapçš„ä½ç½®ã€‚
**5.å†…æ ¸ä»»æ„åœ°å€è¯»å†™åŠä»£ç æ‰§è¡Œ**
å› ä¸ºå·²ç»ç»•è¿‡äº†å†…æ ¸åœ°å€éšæœºåŒ–,è¿™æ—¶æˆ‘ä»¬å¯ä»¥è¿›è¡Œå†…æ ¸ROPæ„é€ äº†ã€‚
1.åœ¨è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨bitmapä¸­ä¼ªé€ ä¸€ä¸ªfile_operationsç»“æ„ã€‚
2.ä¹‹åé€šè¿‡è¶Šç•Œå†™å¯ä»¥æ”¹å†™æ‰æˆ‘ä»¬åˆšåˆšåœ¨å†…æ ¸ä¸­å–·å°„çš„struct fileç»“æ„ä½“çš„file_operationsæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘åˆé€‚çš„ROPgadgetã€‚
3.è°ƒç”¨llseekå‡½æ•°(å®é™…ä¸Šå·²ç»æ˜¯rop gadget)æ¥æ‰§è¡Œæˆ‘ä»¬äº‹å…ˆå·²ç»å‡†å¤‡å¥½çš„ROPé“¾ã€‚
4.é€šè¿‡å¤šæ¬¡æ”¹å†™file_operationsç»“æ„ä¸­çš„llseekå‡½æ•°æŒ‡é’ˆæ¥å®ç°å¤šæ¬¡æ‰§è¡ŒROPgadgetå®ç°ææƒã€‚
å¦‚ä¸Šæ‰€è¿°ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®éƒ½æ˜¯ä¼ªé€ åœ¨å†…æ ¸é‡Œé¢ï¼Œæ‰€ä»¥è¿™ç§åˆ©ç”¨æ–¹å¼å…¶å®æ˜¯å¯ä»¥åŒæ—¶ç»•è¿‡SMEPå’ŒSMAPçš„ã€‚
**6.æƒé™æå‡**
ä¸‹é¢æ˜¯é•¿äº­å®‰å…¨ç ”ç©¶å®éªŒå®¤åœ¨pwn2own2017ä¸Šå¼¹å‡ºxcalcçš„ç¬é—´ã€‚
**5.åè®°**
éå¸¸æ„Ÿè°¢slipperè€å¸ˆçš„æŒ‡å¯¼å’Œè®²è§£ ğŸ˜›
æ„Ÿè°¢é•¿äº­å®‰å…¨ç ”ç©¶å®éªŒå®¤çš„æ‰€æœ‰å°ä¼™ä¼´:P
**6.å‚è€ƒèµ„æ–™**
IPSECåè®®: [IPsec â€“
Wikipedia](http://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/IPsec)
linuxå‘½åç©ºé—´æœºåˆ¶: [Namespaces in operation, part 1: namespaces
overview](http://link.zhihu.com/?target=https%3A//lwn.net/Articles/531114/)
CVE-2017-7184: [CVE-2017-7184: kernel: Local privilege escalation in XFRM
framework](http://link.zhihu.com/?target=http%3A//www.openwall.com/lists/oss-security/2017/03/29/2)
@thezdi:
[https://twitter.com/thezdi/status/842132539330375684](http://link.zhihu.com/?target=https%3A//twitter.com/thezdi/status/842132539330375684)
Androidæ¼æ´å…¬å‘Š:[https://source.android.com/security/bulletin/2017-05-01](http://link.zhihu.com/?target=https%3A//source.android.com/security/bulletin/2017-05-01)
Redhat:[Red Hat Customer
Portal](http://link.zhihu.com/?target=https%3A//access.redhat.com/security/cve/cve-2017-7184)