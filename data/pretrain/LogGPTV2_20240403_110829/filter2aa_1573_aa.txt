### 大海捞针：使用沙箱捕获多个零日漏洞

**作者**
- 李琦，安全开发工程师
- 金权，漏洞挖掘和利用工程师
- 发布日期：2019-05-30

**关于我们**
- **李琦 (@leeqwind)**
  - 360 核心安全高级威胁自动化团队
  - 安全开发工程师
- **金权 (@jq0904)**
  - 360 核心安全高级威胁自动化团队
  - 漏洞挖掘和利用工程师

**研究方向**
- 高级威胁自动化与沙箱技术
- 使用沙箱发现并捕获在野的 0day 漏洞

**大纲**
1. 无处不在的网络攻击
2. 我们至今捕获的五次在野利用 0day 漏洞的攻击事件
3. 高级威胁自动化系统架构
4. 沙箱检测引擎的技术方案

### 无处不在的网络攻击
近年来，网络攻击日益频繁，攻击者不断利用新的漏洞进行攻击。我们通过持续监测和分析，成功捕获了多次在野利用的 0day 漏洞攻击。

### 成功案例
#### CVE-2018-15982
- **时间**：2018年11月
- **描述**：捕获到一次使用新的 Flash 0day (CVE-2018-15982) 针对政府机构的国际网络攻击。

#### CVE-2018-8174
- **时间**：2018年4月至6月
- **描述**：首家捕获新的浏览器 0day 漏洞 (CVE-2018-8174)，该漏洞影响当时最新版的 Internet Explorer 浏览器及所有使用 IE 内核的应用程序。

#### CVE-2018-5002
- **时间**：2017年12月
- **描述**：全球首家捕获在野利用的 Flash 0day 漏洞 (CVE-2018-5002)，影响 Adobe Flash Player 29.0.0.171 及更早版本。

#### CVE-2018-0802
- **时间**：2018年初
- **描述**：全球首家捕获“噩梦公式二代” (CVE-2018-0802) 0day 漏洞，这是 2018 年微软修复的首个在野 0day 漏洞。

#### CVE-2017-11826
- **时间**：2017年9月
- **描述**：全球独家捕获在野利用的 0day 漏洞 (CVE-2017-11826)，这是中国安全厂商捕获的第一个 Office 在野 0day 攻击。

### N-day 漏洞攻击统计
从 2018年3月至 2019年3月期间，我们监测到了以下部分 N-day 漏洞攻击文件：
- 文件类型：doc, docm, docx, eml, html, hwp, msi, nsis, pdf, ppt, pptm, pptx, rtf, swf, vbs, xls, xlsm, xlsx, exe, dll 等。
- 漏洞模块：Flash, HWP, IE, Kernel, Office, PDF 等。
- 具体漏洞编号：CVE-2012-0158, CVE-2015-1641, CVE-2015-1726, CVE-2015-2545, CVE-2016-7255, CVE-2017-11882, CVE-2017-8570, CVE-2018-0798, CVE-2018-0802, CVE-2018-4878 等。

### 高级威胁自动化系统架构
我们的系统包括以下几个主要组件：
- **大规模样本云**：分布式调度、扫描和筛选、搜索、告警、订阅等。
- **静态反病毒引擎**：AVE QEX QVM。
- **样本预筛选策略**：确保高效处理。
- **沙箱服务器集群**：虚拟机隔离环境、自动化检测引擎、规则评分系统。
- **检测结果告警和响应**：及时反馈和处理。

### 沙箱检测引擎的技术方案
#### 初始方案：动态库
- **功能**：注入目标进程执行检测功能，挂钩各系统动态库导出函数。
- **优点**：轻量级。
- **缺点**：容易被探测和绕过，远程方式启动进程的追踪链容易丢失。

#### 第二种方案：驱动程序
- **功能**：内核层监控目标系统调用，系统回调，通知，过滤。
- **优点**：更完整的监控覆盖面，更全面的污点追踪。
- **缺点**：64 位操作系统的 PATCH GUARD 机制，加载驱动的恶意程序干扰。

#### 第三种方案：基于硬件虚拟化的驱动程序
- **功能**：基于虚拟化的系统调用监控，针对敏感内存读写访问监控。
- **优点**：更高的安全性，更好的隐蔽性。

通过这些技术和方法，我们能够更有效地发现和应对各种复杂的网络攻击。