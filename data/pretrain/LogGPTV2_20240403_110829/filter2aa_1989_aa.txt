The End of the PSTN As You Know It 
DEF CON 20 
July 28, 2012 
Agenda 
“Islands of VoIP” 
Tool release 
UC Federation 
Surprise UCF Vendor Research 
Open Source Software 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Small Disclaimer 
These are our opinions based on experience 
Not necessarily the official position of our 
employer 
These issues are large and complex 
• We are here to explore an idea 
We’re not finished with this research 
• (In fact, we’re just getting started) 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
About VIPER 
VIPER Lab (Voice over IP Exploit Research) 
1. Security Assessment for VoIP/UC 
2.  R&D Lab for vulnerability research around 
UC/VoIP 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
A long time ago, in a land far away… 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
      A VoIP Pentest took place… 
7 
Islands of 
VoIP 
“Islands of VoIP” 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Company A 
Company B 
Company C 
PSTN 
SIP Trunk 
SIP Trunk 
TDM Trunk 
Carrier 
Carrier 
Carrier 
How to Connect “Islands of VoIP”? 
ENUM 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
ENUM 
How it works 
Uses DNS NAPTR records to map E.164 telephone 
numbers to a URI (SIP URI) 
When you dial a telephone number, you don’t know 
for certain if it’s connected to PSTN or a SIP network 
Solves problem of dialing between SIP networks when 
you only have a telephone number 
Adoption rate 
Hasn’t seen widespread adoption 
Political, Economic reasons 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
ENUM Experiment 
www.e164.org 
Public ENUM Directory 
They have a form and validation procedure for adding 
your telephone number and SIP URI to their directory 
We tried adding ourselves in using their procedure 
Result 
Failure 
Process didn’t appear to work & multiple emails to 
their contact address - no response. 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
No more “Islands of VoIP”! 
(There has to be a better way) 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
The Superior Solution: 
SIP Peering using DNS SRV 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
SIP Peering using DNS SRV 
We propose an idea to have everyone use DNS 
for SIP Peering 
Can interconnect all “Islands of VoIP” directly between 
organizations using DNS 
DNS built for HA and load balancing 
Calls via your SIP URI 
• Easier to remember 
• No more dial by numbers 
• Use your email address as your SIP URI / address 
Large cost saving for direct SIP peering 
PSTN will be increasingly diminished 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
DNS SRV:  RFC 2782 
A special DNS resource record for the location of 
Services (SRV) 
For fault tolerance and load balancing 
Multiple priorities and weights, just like MX 
records for MTAs 
Clients look up lower priority records first, and 
then fallback to records of equal or higher priority 
If multiple records with same priority, weight 
value is used 
RFC 3263 specifies usage of DNS SRV for SIP 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
DNS SRV:  RFC 2782 
Record Format 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Source:  Wikipedia 
DNS SRV:  RFC 2782 
Sample Record 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Source:  Wikipedia 
Automatic load 
balancing group 
created with  equal 
priority of “10” 
Weight values added up to 100. 
60% of traffic to bigbox 
20% of traffic to smallbox 
10% to each remaining 
SIP DNS SRV Deployment 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Internet 
Company A 
SIP Domain: 
example.com 
Company B 
SIP Domain: 
foo.com 
Root DNS 
SIP user: 
PI:EMAIL 
SIP user: 
PI:EMAIL 
Initiate SIP call to: 
PI:EMAIL 
DNS SRV: 
foo.com 
SIP INVITE 
SIP INVITE 
RTP 
Media 
“Hello? 
What’s up 
Bro?” 
RTP 
Media 
Research Goal 
Objective:  Wanted to measure growth of SIP 
peering on IPv4 Internet, over period of time. 
Proliferation of DNS SRV records, plotted over 
time 
Proliferation of ENUM for selected e.164 blocks, 
plotted over time 
Proliferation of listening SIP services for every IPv4 
address, plotted over time 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Introducing Enumerator Tool 
Releasing a new intelligence gathering tool 
that we developed for this research 
Tool Name:  enumerator 
Website:  http://enumerator.sourceforge.net 
Written in C 
Uses the “libresolv” library 
Can be used for R&D purposes like we did, or for 
VoIP pentesting in the Recon phase 
Optimized for VoIP and a large number of domains 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Enumerator 
Key Features 
DNS SRV lookups for single domain, or text input 
list 
• Partial support for Microsoft specific targets 
DNS MX lookups for single domain, or text input 
list 
DNS ENUM lookups for single number, or input list 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Enumerator Phase I “Scan” 
Ran an enumerator SRV lookup “Scan” 
Procured all TLD (Top-level domains) from 
Network Solutions, Org 
Goal was to find number of SRV enabled domains 
potentially enabled for SIP 
Idea was to run several of these “scans” over a 
year and plot how the data changes over time 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Data Input 
Received from Network Solutions and Org 
.com domains:  234,638,894 (4.231 GB) 
.net domains:  34,232,716 (578.313 MB) 
.org domains:  23,409,623 (430.455 MB) 
Total:  292,281,233 domains 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
4 SRV Target Queries 
Benchmarking 
140 Domain queries per second on each server (11 
servers) 
4 SRV queries per domain 
Split enumerator into 800 separate processes, 800 files 
Command:  ./enum-launcher.pl –f largefile.txt –c 800 
4 SRV queries 
_sip._udp. 
_sip._tcp. 
_sip._tls. 
_sipfederationtls._tcp. 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Results from Enumerator Scan #1 
Total domains checked:   
265,710,178 
Without SRV:   
256,947,303 
96.70% 
With SRV for SIP:   
8,762,875  Top Level Domains (.com/.net/.org) 
with SRV SIP enabled 
3.30% 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
8 Million TLD 
domains enabled 
for SIP SRV! 
3.30% 
Enumerator In Action 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Other Examples 
Example:  enumerator –s –l domains.txt 
Takes domains.txt as input and looks up all 
domains 
Example:  enumerator –m –d example.com 
MX Record lookup of single domain 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Enumerator In Action 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
ENUM Support 
Example:  enumerator –e –r 12145551212 
Looks up single e.164 telephone number 
Example:  enumerator –e –r 12145551212-
12145559999 
Looks up a range 
Example:  enumerator –e –l numbers.txt 
Takes numbers.txt as input and looks up all 
numbers in text file 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Enumerator In Action - ENUM 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Enumerator In Action - ENUM 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
srv.c 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
You can make 
changes to srv.c, 
adding support 
for new SRV 
queries. 
Enumerator can measure the usage of UC Federation 
services, or SIP enabled DNS SRV records, enabled on the 
public Internet. 
UC Federation – next “Killer App”? 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Some great insight 
from 
www.ucinsights.com 
UC Federation 
Market Definition: 
Being able to use UC between companies in the same 
way that it is used within the company (B2B Comms) 
IM / Presence 
VoIP 
HD Video 
Collaboration, Desktop sharing, white boarding 
Promises many business benefits! 
Looked at two vendors initially 
Cisco 
Microsoft 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Who is Federating?   Matt Landis’ Federation Directory  
(This is a public directory)  
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Who is Federating?   Matt Landis’ (Public) Federation Directory   
Tried adding our  test 
deployment into this 
directory.  Not 
successful. 
Data from Matt Landis’ Public directory 
9,705 domains for Microsoft UC Federation 
Top 3 countries: 
Canada 
USA 
Norway 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Another Lync Federation Public Directory 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
We were able to add our test UC Federation 
deployment into this directory. 
Lync Federation - Architecture 
Avaya Proprietary - Do not reproduce or distribute without express written consent 
Lync Edge Server
Corporation A
Lync Edge Server
Corporation B
Lync Front-End Server