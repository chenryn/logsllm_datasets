# SOC异闻录：我和SOC不得不说的故事
## 译文声明
本文为翻译文章，译文仅供参考，具体内容及含义以原文为准。

就像程序员和运维人员在深夜加班时总会遇到一些奇怪的事情一样，我也曾经历过许多“大场面”。下面我将分享一些在建设安全运营中心（SOC）过程中遇到的奇闻异事。
## 目录结构
- 0x00. 关于SOC
- 0x01. SOC的产生
- 0x02. SOC开始建设
- 0x03. SOC稳定运行
- 0x04. 那些奇怪事
- 0x05. SOC建设全过程
- 0x06. 附录（CheckList）
- 致谢

## 0x00. 关于SOC
首先，本文中提到的SOC指的是Security Operation Center（安全运营中心），而非网络上常见的SOC安全管理平台。前者是一个组织内的信息安全团队，后者则是一种工具或平台。安全运营中心的一个关键组成部分是日志安全，需要对海量日志进行监控、分析、处理和展示。实现这些功能的架构或产品通常被称为安全管理平台（也称为SOC）。本文中的SOC特指安全运营中心。

那么，什么是安全运营中心？每个公司对其职能的看法可能有所不同。在我看来，安全运营中心是一个基于基本准则建立的信息安全团队，负责监督和分析企业的安全状况，处置异常情况，并确保企业安全随着技术和业务增长而不断更新迭代。SOC团队的目标是通过技术解决方案和一套强大的流程来检测、分析并响应网络安全事件。SOC团队通常承担着安全分析师和管理者的角色，与事件响应团队紧密合作，确保发现的安全问题能够迅速得到解决。

安全运营中心监控和分析网络、服务器、终端、数据库、应用、网站及其他系统，寻找可能代表安全事件或攻击的异常活动。其职责包括确保潜在的安全事件能够被正确识别、分析、防护、调查取证和报告。

## 0x01. SOC的产生
SOC团队负责企业信息安全运营的关键组件，可能参与制定安全策略、设计安全架构或实施保护措施。SOC团队成员主要包括安全分析师、安全领导和安全专家等，他们共同探测、分析并反馈报告，防止网络安全事件发生。如果具备高级取证分析、密码分析和恶意软件逆向工程能力，则更为理想。

SOC的产生主要有以下几种情况：
1. 公司以前没有SOC，而是由运维、开发和监控等部门协同进行日常维护和处理。当遇到无法处理的安全事件时，才开始组建SOC。
2. 公司是子公司，或者公司在创建初期就将安全职能部门纳入团队之中，一开始就建设SOC团队，包括SIEM事件管理体系和ISMS信息安全管理体系。

我的团队属于第二种情况。在一个炎热的夏天，我有幸加入到SOC团队，并开始了大规模的建设工作。

## 0x02. SOC开始建设
建立一个组织的SOC的第一步是明确定义包含具体业务的战略目标，并获得全体相关人员的支持。一旦战略确定，基础设施将支持这一战略的实现。典型的SOC基础设施包括防火墙、IPS/IDS、漏洞检测解决方案、嗅探器和安全信息与事件管理（SIEM）系统。技术应通过数据流、遥测、数据包捕获、syslog等方式收集数据，以便SOC工作人员可以关联和分析数据及活动。SOC还监控网络和端点漏洞，以保护敏感数据并符合行业或政府法规。

SOC的关键优势在于通过持续的数据活动检测和分析，提高了安全事件的检测能力。通过全天候分析跨组织网络、终端、服务器和数据库的活动，SOC团队确保及时检测和响应安全事件。SOC提供的24/7监控为组织提供了对抗安全事件和入侵的先机，无论资源、时间或攻击类型如何。

许多安全领导人更关注人为因素而非技术因素，不再依赖脚本，而是直接评估和减轻威胁。SOC连续工作管理已知威胁，同时识别新的风险，在风险承受能力范围内满足公司和客户的需求。虽然防火墙、IPS等技术系统可以防止基本攻击，但在重大事件上仍需进行人为分析。

为达到最佳效果，SOC必须跟上最新的威胁情报，并利用这些信息改善内部检测和防御机制。SOC消耗的数据来自组织内部和外部的相关资源，提供对威胁和漏洞的洞察。外部网络情报包括新闻提要、签名更新、事件报告、威胁简报和脆弱性警报，有助于SOC跟上不断发展的网络威胁现状。SOC员工必须不断注入威胁情报，保持最新的威胁信息，并区分真正的威胁和非威胁。

真正成功的SOC利用安全自动化变得更加有效和高效。通过结合高度熟练的安全分析师和安全自动化，提高组织的分析能力，加强安全措施，更好地防止数据泄露和网络攻击。

### 第一阶段：梳理现有安全防御
主要任务是梳理资产，包括组织架构和人员、基础设施资产以及应用系统资产。组织架构和人员涉及账户信息、变更审核等；基础设施资产包括硬件服务器、网络设备和安全设备；应用系统资产则涵盖业务系统、环境划分与安全域、业务流向。此阶段的技术含量不高，但处理得越仔细、越详细越好。

### 第二阶段：全网安全状态分析
针对之前的安全措施进行补充，提交不足的安全项，并在监控、运维和系统管理的协助下，对全网环境进行基线扫描、漏洞扫描、数据分级保护和ISMS体系建设等。

### 第三阶段：持续监控和应急处置
在全网基线合规和漏洞基本修复的情况下，开始严格监控全网状态，包括账户信息管理、变更管理、安全设备状态监控和日志分析。这里会使用SIEM安全信息事件管理平台，通常采用OSSIM或ELK日志架构。

Elasticsearch是一个开源分布式搜索引擎，具有分布式、零配置、自动发现、索引自动分片、索引副本机制、RESTful风格接口、多数据源和自动搜索负载等特点。

Logstash是一个完全开源的工具，用于收集、过滤日志，并将其存储供以后使用（如搜索）。

Kibana也是一个开源免费工具，为Logstash和Elasticsearch提供友好的Web界面，帮助汇总、分析和搜索重要数据日志。

至此，SOC团队开始对特定的安全需求进行精细化处置，逐步实现安全自动化，并根据实际情况进行反黑产、链接监控、舆情监控、威胁模型分析等工作。如果业务量足够大，还可以建设APT防御。此外，还需建设安全知识库，这需要从建设初期就开始积累。

## 0x03. SOC稳定运行
在SOC建设完成后，整个SOC进入稳定运行状态。此时，日志可以按需查看，账户管理、权限变更和变更审计有条不紊地进行。定期巡检和维护SIEM安全事件管理系统非常重要，因为所有安全监控都基于这套系统。如果系统自身出现问题，监测的可靠性将受到影响。常规操作包括：

1. 巡检：定期检查SIEM系统的物理状态和服务情况。
2. 季度重启：确保SIEM服务器满足故障恢复的基本要求。
3. 日志存储：定期检查日志保存情况。

需要注意的是，如果前期收集的日志未分类，后期需进行分类。了解不同类型的日志，并在SIEM平台上做好相关关联和汇总，越清晰越好。通常按产品分类，产品之下再分为应用、安全和信息类日志等。

## 0x04. 那些奇怪事
### 4.1. “时间”幽灵
有一天周五，Duke准备下班回家。临走前，他分配了其他部门申请的权限，以便周末变更之用。就这样，Duke按时回去了。

周末很快过去，周一回来后，Duke迅速review了几个监控频道，主要是特权账户登录、非工作时间登录、高危事件和一般事件。他查看的时间段是从上周五9点到这周一9点。在特权账户登录和非工作时间登录中，Duke发现了几条鲜红的事件：

```
20171215 03:34 路人甲 login 192.168.1.1 root 192.168.7.1 ….
20171215 04:10 路人甲 login 192.168.1.1 root 192.168.7.1 ….
20171215 04:22 路人甲 login 192.168.1.1 root 192.168.7.1 ….
```

Duke觉得不对劲，立即咨询了周五变更的同事。他们表示周五9点左右就离开了，变更早就完成了。Duke怀疑机器被黑了，于是开始查历史登录记录，发现192.168.7.1上的三个登录事件确实存在，且都是root账号。进一步查看root的操作记录，发现了一些重启服务和打包文件的操作。Duke又查看了crontab和可疑进程：

```bash
crontab -u
for pid in $(pgrep 进程名称); do echo -n "${pid} "; ps -p ${pid} -o lstart | grep -v "START" ; done
for pid in $(pgrep async); do echo -n "${pid} "; ps -p ${pid} -o lstart | grep -v "START" ; done
netstat -anp | grep 进程ID
```

一切看起来正常，但那三条事件的颜色仍然鲜红。Duke查看了堡垒机的操作录屏，发现录屏的时间分别是19:34、20:10和20:22。咨询运维和监控同事后，确认变更时间确实是这三个时间。问题出在哪里呢？

原来是服务器的时钟没有同步，导致日志时间有问题。Duke检查了192.168.7.1的时间，发现比真实时间慢了14小时。他立即联系系统管理员，通过NTP同步了所有服务器的时间。

总结：不论是平时的业务还是办公，或者是SIEM建设，日志和攻防的基础都是时间差。时间越同步越精确，事件处理就越准确越高效。

### 4.2. 死灰复燃的亡魂
一天下午，Scott大哥来到监控室，悄悄对我们说：“等会下班有事么？”我们回答：“没啊？哥，请吃饭？”他说：“吃啥啊？服务器中勒索病毒了，快来看！”我们都很好奇，决定留下来查看。

Duke对邮箱地址进行了检索，并查找了最近关于勒索病毒的公告，发现这个病毒叫Arena（中文名艾瑞娜），可以挖矿。进一步查看安全日志和预警信息，发现C盘中还有Heur.AdvML.B病毒，路径在user账户appdata\roaming\microsoft\windows\start。我们决定先干掉这些病毒，然后建议查看任务管理器。