后，再把虚拟机迁移回来。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 39
39
3.服务器虚拟化
3.4虚拟机迁移
虚拟机动态迁移
机能够在新的计算机上恢复且继续运行，必须要向目的计算机传送足够多
的信息，如磁盘、内存、CPU状态、I/O设备等。
其中，内存的迁移最有难度和挑战性，因为内存中的信息必不可少而且数
据量比较大，CPU状态和I/O设备虽然也很重要，但是它们只占迁移总数
据量很少的一部分，而磁盘的迁移最为简单，在局域网内可以通过NFS
（NetworkFileSystem）的方式共享，而非真正迁移。
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 40
40
3.服务器虚拟化
3.4虚拟机迁移
口迁移的内容
■内存的迁移
口内存的迁移是虚拟机迁移最困难的部分。理论上，为了实现虚拟机的实时迁移
一个完整的内存迁移的过程可以分为以下三个阶段。
口 第一阶段，Push阶段。在VM运行的同时，将它的一些内存页面通过网络复制到
目的机器上。为了保证内容的一致性，被修改过的页需要重传。
第二阶段，Stop-and-Copy阶段。VM停止工作，把剩下的页面复制到目的计算
机上，然后在目的计算机上启动新的VM。
第三阶段，Pu阶段。新的虚拟机运行过程中，如果访问到未被复制的页面，就
会出现页错误并从原来的VM处把该页复制过来。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn／http://www.51xueweb.cn
---
## Page 41
41
3.服务器虚拟化
3.4虚拟机迁移
迁移的内容
网络资源的迁移
口虚拟机这种系统级别的封装方式意味着迁移时VM的所有网络设备，包括协议状
态（如TCP连接状态）以及IP地址都要随之一起迁移。
口在局域网内，可以通过发送ARP重定向包，将VM的IP地址与目的机器的MAC地
址相绑定，之后的所有包就可以发送到目的机器上。
河南中医药大学 ／阮晓龙 /13938213680 /http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 42
42
3.服务器虚拟化
3.4虚拟机迁移
口迁移的内容
■存储设备的迁移
口迁移存储设备的最大障碍在于需要占用大量时间和网络带宽，通常的解决办法
是以共享的方式共享数据和文件系统，而非真正迁移。
目前大多数集群使用NAS（NetworkAttached Storage，网络连接存储）作为
存储设备共享数据。NAS实际上是一个带有瘦服务器的存储设备，其作用类似
于一个专用的文件服务器。
口在局域网环境下，NAS已经完全可以实现异构平台之间，如NT、UNIX等的数据
级共享。基于以上的考虑，Xen并没有实现存储设备的迁移，实时迁移的对象
必须共享文件系统。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 43
43
3.服务器虚拟化
3.5虚拟机隔离技术
虚拟机隔离是指虚拟机之间在没有授权许可的情况下，互相之间不可
通信、不可联系的一种技术。
■从软件角度讲，互相隔离的虚拟机之间保持独立，如同一个完整的计算机;
■从硬件角度讲，被隔离的虚拟机相当于一台物理机，有自己的CPU、内存、
硬盘、VO等，它与宿主机之间保持互相独立的状态。
从网络角度讲，被隔离的虚拟机如同物理机一样，既可以对外提供网络服
务，也可以从外界接受网络服务。
虚拟机隔离是确保虚拟机之间安全与可靠性的一种重要手段。
·现有虚拟机隔离机制主要包括：网络隔离；构建虚拟机安全文件防护网；
基于访问控制的逻辑隔离机制；通过硬件虚拟，让每个虚拟机无法突破虚
拟机管理器给出的资源限制；硬件提供的内存保护机制；进程地址空间的
保护机制，IP地址隔离。
河南中医药大学／阮晓龙/ 13938213680 /http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 44
44
4.存储虚拟化
4.1存储虚拟化的概念
存储虚拟化是指将存储网络中的各个分散且异构的存储设备按照一定
的策略映射成一个统一的连续编址的逻辑存储空间，称为虚拟存储池。
虚拟存储池可跨多个存储子系统，并将虚拟存储池的访问接口提供给应用
系统。
1逻辑卷与物理存储设备之间的这种映射操作是由置入存储网络中的专门的
虚拟化引擎来实现和管理的。
·虚拟化引擎可以屏蔽掉所有存储设备的物理特性，使得存储网络中的所有
存储设备对应用服务器是透明的，应用服务器只与分配给它们的逻辑卷打
交道，而不需要关心数据是在哪个物理存储设备上。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 45
45
4.存储虚拟化
4.1存储虚拟化的概念
存储虚拟化将系统中分散的存储资源整合起来，利用有限的物理资源
提供大的虚拟存储空间，提高了存储资源利用率，降低了单位存储空
间的成本，降低了存储管理的负担和复杂性。
1在虚拟层通过使用数据镜像、数据校验和多路径等技术，提高了数据的可
靠性及系统的可用性。
1同时，还可以利用负载均衡、数据迁移、数据块重组等技术提升系统的潜
在性能。
不同性能和可靠性的新的虚拟设备，以满足多种存储应用的需求。
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 46
46
4.存储虚拟化
4.1存储虚拟化的概念
所谓存储虚拟化是将实际物理存储实体与存储的逻辑表示分离开来
应用服务器只与分配给它们的逻辑卷打交道，而不关心数据是存储于
哪个物理存储实体上。
■虚拟存储是介于物理存储与用户间的一个中间层，这个中间层屏蔽了实体
物理存储设备的物理特性，呈现给用户的是逻辑存储设备。
1用户所看到的和所管理的存储空间不是实体的物理存储设备，而是通过虚
拟存储层映射来实现对实体物理存储设备进行管理和使用的。
对用户来说，虚拟化的存储资源就像是一个巨大的"存储池"，用户不会看
到具体的磁盘、磁带，也不必关心自己的数据经过哪一条路径通往哪一个
具体的存储设备。
河南中医药大学 ／阮晓龙 ／ 13938213680／http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 47
47
4.存储虚拟化
4.2存储虚拟化的模型
存储虚拟化的一般模型
个存储单元抽象成一个虚拟存储池，存储单元可以是异构，可以是直接的
存储设备，也可以是基于网络的存储设备或系统。
对这些请求进行处理后将相应的请求映射到具体的存储单元。使用虚拟化
的存储系统的优势在于可以减少存储系统的管理开销、实现存储系统数据
共享、提供透明的高可靠性和可扩展性等。
目前，实现存储虚拟化的方式主要有三种：基于主机的存储虚拟化、基于
存储设备的存储虚拟化、基于网络的存储虚拟化。
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 48
48
4.存储虚拟化
4.2存储虚拟化的模型
存储虚拟化的一般模型
物理服务器或者虚拟机
虚拟化层
底层存储物理存储设备
图7-5存储虚拟化一般模型
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn / http://www.51xueweb.cn
---
## Page 49
49
4.存储虚拟化
4.2存储虚拟化的模型
口基于主机的存储虚拟化
■基于主机的存储虚拟化，也称基于服务器的存储虚拟化或者基于系统卷管
理器的存储虚拟化，其一般是通过逻辑卷管理来实现的。虚拟机为物理卷
映射到逻辑卷提供了一个虚拟层。虚拟机主要功能是在系统和应用级上完
成多台主机之间的数据存储共享、存储资源管理（存储媒介、卷及文件管
理）、数据复制及迁移、集群系统、远程备份及灾难恢复等存储管理任务。
基于主机的存储虚拟化不需要任何附加硬件。虚拟化层作为扩展的驱动模
块，以软件的形式嵌入操作系统中，为连接到各种存储设备，如磁盘、磁
盘阵列等，提供必要的控制功能。主机的操作系统就好像与一个单一的存
储设备直接通信一样。
河南中医药大学 /阮晓龙 / 13938213680 / http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 50
50
4.存储虚拟化
4.2存储虚拟化的模型
口基于主机的存储虚拟化
■目前，已经有比较成熟的基于主机的存储虚拟化的软件产品，这些软件一
般都提供了非常方便的图形化管理界面，可以很方便地进行存储虚拟化管
理。从这一点上看，基于主机的存储虚拟化是一种性价比比较高的方法
但这种虚拟化方案往往具有可扩展性差、不支持异构平台等缺点。
对于支持集群的虚拟化方案，为了确保元数据的一致性和完整性，往往需
要在各主机间进行频繁的通信和采用锁机制，这就使得性能下降，可扩展
性也比较差。同时，由于其一般都采用对称式的结构，就使得其很难支持
异构平台。
河南中医药大学 ／阮晓龙 / 13938213680/http://cloud.xg.hactcm.edu.cn ／http://www.51xueweb.cn
---
## Page 51
51
4.存储虚拟化
4.2存储虚拟化的模型
口基于存储设备的存储虚拟化
■基于存储设备的存储虚拟化，也称基于存储控制器的存储虚拟化。它主要
是在存储设备的磁盘、适配器或者控制器上实现虚拟化功能。
与主机无关，对系统性能的影响比较小，也比较容易管理，同时，它对用
户和管理人员都是透明的。
三方的虚拟软件，否则，其通常只能提供一种且不完全的存储虚拟化方案。
对于包含有多家厂商提供异构的存储设备的SAN存储系统，基于存储设备
的存储虚拟化方法的效果不是很好，而且这种设备往往规模有限并且不能
进行级连，这就使得虚拟存储设备的可扩展性比较差。
河南中医药大学／阮晓龙/ 13938213680 /http://cloud.xg.hactcm.edu.cn /http://www.51xueweb.cn
---
## Page 52
52
4.存储虚拟化
4.2存储虚拟化的模型