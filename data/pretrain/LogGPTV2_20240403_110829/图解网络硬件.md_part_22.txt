108第2章彻底理解L2交换机
（续）
设置内容
说明
SMON
管理LAN交换机的RMON扩展标准，即交换监控（SwitchingMonitoring），定义了名为
(RFC2613)
SMONProbeCapabilities的MIB组信息
名称
说明
smonVlanStats
管理IEEE802.1Q时使用
smonPrioStats
管理802.1Q中通信流量的优先级
dataSourceCaps
硬件的数据源
portCopyConfig
控制交换机的镜像端口
InterfaceParameters
定义了名为IfTopN（interfaceTopNObjects）的托管对象。If表示Interface，TopN表示前N
Monitoring
位的统计信息。当LAN交换机存在多个端口时，从中抽取负载较高的端口进行统计
(RFC3144)
DSMON
差分服务监控（DifferentiatedServicesMonitoring），能够对DSCP（differentiatedservices
(RFC3287)
codepoint，差分服务代码点）优先级控制进行分类的RMON扩展MIB
HSRMON
大流量远程网络监控（HighCapacityRMON
(RFC3273)
），用于在大流量通信环境中获取通信统计信息的功能扩展。将32bit的统计信息计数器扩展为
64bit，将最大统计字节数从2的32次方（42亿）指数翻倍扩展为2的64次方
NetFlow、sFlow
虽然很多交换机都采用RFC标准的RMON，但是在进行基于MIB的监控时，如果流量超
过100Mbit/s，就会需要占用大量CPU或内存等资源，不仅无法实现内容全部监控，而且获取大
量数据会耗时过长导致数据无法实时解析。要想实时获取所需的统计信息，就需要使用NetFlow
或sFlow技术。通过这类技术可以获得LAN的流量内容信息，并高效管理网络性能。
·NetFlow
NetFlow是由思科公司开发的通信流量管理技术，在Linux和Unix系列操作系统、Juniper
网络公司和ALAXALA网络公司的网络硬件上也可实现。该技术对通过LAN设备的分组进行
识别，将与“发送源IP地址”“发送自的地IP地址”“发送源端口”“发送自的地端口”“IP协议
号”“输人接口”“IP的ToS值”这7个参数相一致的单向传送的分组集合定义为“数据流”，并
对该数据流进行统计。随后，将统计结果发送到名为NetFlow收集器的监控装置中，就能够以地
址或协议为单位进行信息的二次统计（图2-34）。
NetFlow有很多版本，最新的版本NetFlow9是以RFC3954的形式发布的。另外，除了
NetFlow之外，其他厂商还实现了将通信流量以数据流为单位进行统计的技术?，不过这些技术均
是在NetFlow9的基础上作为IPFIX（IPFlowInformationexport）在RFC5105中完成了标准化。
①如Juniper公司的Jflow和cflowd、3Com公司/华为公司的NetStream、阿尔卡特朗讯公司的Cflowd、爱立信公司的
Rflow、Citrix公司的AppFlow等。
---
## Page 123
02.08交换机搭载的其他功能|109
图2-34
NetFlow的概念图
LAN
LAN
终端
LAN
终端
专用连线
NetFlow
NetFlow
Analyzer
Exporter
Collector
互联网
Storage
sFlow
sFlow是由InMon开发的一种在分组（packet）抽样基础上管理通信流量的技术。该技术版
本4的细节在RFC3176中发布，并在Foundry公司、日立公司、HP公司以及Force10Networks
公司（以下简称为Force10公司）?的LAN交换机产品上得到了具体的实现。
sFlow技术可以监控交换机上通过的分组，并在一定周期内对其进行抽样，获得分组首部
与监控到的分组的统计信息（如分组总数、字节总数等），然后通过交换机内置的sFlow代理向
sFlow收集器上报（图2-35）。sFLow收集器将得到的信息按接收发方地址类型、协议类型等进
行分类处理，能够统计不同类型的通信信息。在交换机中，sFlow的监控功能与RMON相比更
为简单一点，因此能够嵌人到ASIC硬件中，也能够进行高速通信。
①该公司于2010年被戴尔公司收购。
---
## Page 124
110丨第2章彻底理解L2交换机
图2-35
sFlow的概念图
使用SNMP与MIB
设置sFlow
（交换机或路由器
UDP/161
SNMP代理
功能实体
sFlow
MIB
sFlow代理
UDP/6343
功能实体
通过专用硬件对经过的分组
定期向收集器发送
或接口计数器信息进行抽样
抽样数据
从代理处获得抽样数据并进
行分析
※是否使用SNMPMIB为可选项
Syslog
Syslog是在加利福尼亚大学伯克利分校的伯克利软件套件（BSD，BerkeleySoftwareDistribution）
的TCP/IP系统?上实现的，用于获取网络日志的应用程序，一般占用UDP的514端口。
该机制虽然没有通过IETF组织进行标准化，但符合业内的事实标准（Defactostandard），所
以在很多操作系统上都进行了移植，而且在RFC3164协议中的Information一节也有对于该机制
的介绍。
Syslog的运行方式同SNMP的Trap相似，仅仅由通信设备单方面向Syslog服务器发送事件
消息（图2-36）。
图2-36
Syslog的结构
路由器等
Syslog服务器
网络
Event
①即BSDUnix操作系统。——译者注
---
## Page 125
02.08交换机搭载的其他功能|111
Syslog消息根据其重要程度分成不同的级别，最重要的级别为0，不重要的级别为7，一共
分成8级（表2-27）。
表2-27Syslog消息的级别划分
级别
重要程度（Severity）
说明
Emergency（致命）
系统无法使用
1
Alert（告警）
需要及时应对
2
Critical（危急）
出现危险状况
3
Error（异常）
出现异常状态
4
Warning（注意）
出现需要注意的事项
5
Notice（通告）
在正常范围内允许的特殊状态
6
Informational（信息）
告知某个信息的消息
7
Debug（调试）
用于调试的消息
在实际的产品中可以设置Syslog日志从哪个级别开始记录，当设置完毕后，该级别以上的
所有日志信息均会告知服务器。
例如在CiscoIOS中进行以下设定，从级别0至级别6的所有日志信息均会送到Syslog服
务器。
router(config）# logging trap 6
Syslog除了级别以外，还有一个名为设施（facility）的设置项，用来告知系统在何处生成日
志。Facility能够定义内核、邮件系统、FTP守护进程、NTP和内部使用的local0~local7等值，
详细内容可以参考RFC3164协议。
Syslog的消息格式如下所示。
mm/dd/yyy:hh/mm/ss:facility-severity-MNEMoNIC:description
（月/日/年/时/分/秒：facility-level-event类型：说明）
举个具体的例子。
12/26/2003,16:00:15:SYS-5-MOD_INSERT: Module 5 has been inserted
其中“12/26/2003，16:00:15”表示日期与时间，SYS-5-MODINSERT中通过“”分割信息，
SYS表示facility名称，5表示级别，MOD_INSERT表示事件类型（mnemoniccode，助记符），
最后的“Module5hasbeeninserted”表示事件描述。
Syslog和SNMP同属于管理类型的协议，考虑到实时性的要求，一般采用UDP来实现。但
在某些硬件中也有采用TCP来实现的例子，这时就需要在Syslog服务器以及发送事件的硬件上
---
## Page 126
112第2章彻底理解L2交换机
配置必要的Syslog端口。
在FreeBSD以及Linux中一般使用syslogd这一守护进程来实现Syslog的相关功能。
02.09交换机架构
交换机的基本架构是由带有多个RJ-45接口、PHY、MAC等模块的网络接口控制器
（NetworkInterfaceController，简称NIC）和管理由各个NIC分配的收发帧缓存、转发表的软件
（或ASIC）组成，通过参考转发表信息，在NIC之间进行数据帧交互。
图2-37展示了交换机的基本架构。
图2-37
交换机的基本架构
转发表
MAC地址
端口号
有效期限
00:11:22:aa:bb:cc
1
300秒
帧缓存
学习（Learning）
帧缓存
·学习发送方的MAC地址
·向转发表中添加信息
NIC
NIC
转发（forwarding）
·识别目的地MAC地址
MAC
·搜索转发表
MAC
·像发送源端口转发数据帧
PHY
PHY
RJ-45
RJ-45
接口
接口
---
## Page 127
02.09交换机架构|113
02.09.01网络控制器（LAN控制器）
在个人计算机和网络硬件内部，均有一种叫做网络控制器（或称为LAN控制器，缩写为
NIC）的模块。该控制器能够将数据转换成以太网数据帧，以10/100/1000BASE-T标准通过接口
进行数据传输。网络控制器的概念图如图2-38所示，控制器有多个端口（或多个端口模块单元）。
网络控制器一般由网络接口、PHY模块、MAC模块和总线接口构成。
图2-38网络控制器概念图
单一端口的LAN控制器
8/16/32bit
10/100BTX
通用总线、
100Base SX
PCI总线、
10BaseSL
SPI总线
连至网络
设备的CPU
物理端口
双端口LAN控制器
10/100BTX
100BaseSX
8/16/32bit
10Base SL
通用总线、
PCI总线
SPI总线
连至网络
物理端口
设备的CPU
物理端口
02.09.02
PHY模块
以太网物理层与数据链路层的MAC子层相关协议功能的实现一般会使用对应标准的处理芯
片（集成电路）来完成。
负责对以太网进行编码等物理层处理的模块就叫做PHY。
图2-39是PHY的逻辑图，展示了PHY中有哪些功能以及这些功能是按什么顺序进行处理
的。表2-28中则展示了100BASE-TX标准中PHY模块内部的处理流程。
---
## Page 128
114第2章彻底理解L2交换机
图2-39
10/100BASE以太网的PHYIP核心
管理接口
自适应
PHY控制
10BASE-T
10M发送
10M线路
曼彻斯特编码
器
驱动
100BASE-TX
4B至5B
NRZ向
Slope
100M线路
发送
转换扰码
MLT-3转换
控制D/A
驱动
NRZ向
100BASE-FX
DPECL
NRZI转换
100BASE-FX接收