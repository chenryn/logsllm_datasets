5个经典的BGP安全大事件
Security flaws or vulnerabilities regarding the BGP protocol.
PART 03
关于BGP的那些安全缺陷/漏洞
BGP基本三原则
2、当目的网络确定时，AS_PATH最短路径具有路由优先权。
1、当BGP路由建立邻居连接后，彼此将路由条目发送给邻居。
3、当目的网络确定时，网络通告地址越具体(掩码越长)越有路由优先权。
BGP基本三原则
BGP hijack
关于BGP的那些安全缺陷/漏洞
 闲置AS抢夺：
对外宣告不属于自己，但属于其他机构合法且未被宣告的网络。
AS1 是 网 络 1.1.1.1/18 和 1.1.2.2/18 的 所 有 者 ， 但 其 目 前 只 使 用 了
1.1.1.1/18，故对外只宣告了1.1.1.1/18，而没有宣告1.1.2.2/18。如下图：
AS5拥有网络5.5.5.5/16，他发现AS1没有对外宣告了1.1.2.2/18，而1.1.2.2/18
确实是存在且是合法的。AS5对外宣告了1.1.2.2/18导致所有前往1.1.2.2/18的所
有流量都发给了AS5。
如下图：
攻击前：
攻击后：
关于BGP的那些安全缺陷/漏洞
BGP hijack
 近邻AS通告抢夺：
利用物理位置邻近特性，就近宣告不属于自己的网络劫持近邻网络链路。
攻击前：
攻击后：
关于BGP的那些安全缺陷/漏洞
BGP hijack
 长掩码抢夺（吸虹效应）Special-Prefix hijack：利用BGP选路长掩码优先的特性劫持所有可达网段全流量。
攻击前：
攻击后：
关于BGP的那些安全缺陷/漏洞
BGP hijack
 AS_PATH hijack (沙丁鱼捕术)：利用AS_PATH prepend可任意修改的特点,通过增加AS_PATH穿越AS数量抑制其路由优先级，将数据流向赶向目标网络。达到控制网络流量的目的。
攻击前：
攻击后：
关于BGP的那些安全缺陷/漏洞
路由泄露(Route leak)
BGP路由泄露：
BGP路由条目在不同的角色都有其合理通告范围，一旦BGP路由通告传播
到其原本预期通告范围之外称之为路由泄露，而这会产生难以准确预料的结
果。
根据其发生泄漏后造成的结果大致可分为以下3种：
 造成源网络中断。
 造成源网络和被指向网络中断。
 造成AS穿越/ISP穿越/MITM等问题。
在AS1发生路由泄露前，AS1、AS2、AS3、AS4、AS5都能正常通讯。如下图：
关于BGP的那些安全缺陷/漏洞
BGP TTL modify (饭后甜点)
BGP TTL值支持自定义修改，故可在进行MITM（BGP 路由TTL值每经
过一跳值会减小1）攻击的同时制定策略，修改TTL值（增加对应跳数
消耗的TTL值）让其跳数看起来无异常。能达到一定的隐藏作用。
switch(config)# router bgp 1.1
switch(config-router)# neighbor 192.0.2.1 remote-as 1.2
switch(config-route-neighbor) ebgp-multihop 2 (1-255）
EBGP运行在AS与AS之间的边界路由器上，默认情况下需要直连或使用静态路由。如果不是直连，必须指EBGP多条。
否则无法建立邻居关系。为解决此问题定义了ebgp-multihop属性来修正跳数(hop)问题。在ebgp建立邻居的时候
默认ttl值为1，如果不修改ebgp-multihop会导致非直连的ebgp邻居无法建立邻居关系（这也是一种ebgp的防环
措施）。其实质就是通过此属性来修改出站方向路由的TTL属性值。
关于BGP的那些安全缺陷/漏洞
Use BGP Break HTTPS
有了之前的BGP hijack，现在只需拿到合法TLS证书即可解密https流量。
 通过TLS CA 为用户获得TLS证书的过程如下：
1、先在CA网页申请一个帐号 ；
2、认证登录请求CSR（certificate signing request）创建并载入，尽管
这很重要，一些CA甚至允许跳过这步直接从CA中取私钥；
3、CA提供了很多选择认证用户所有权，其中包含以下必备的3项：
查询whois记录
载入特定html在特定url通过认证
使用者在dns表中建立自定义token
4、当以上确认后，申请者付款。付款完成，CA发放TLS合法认证，然后我们
就能用这个TLS证书向你网页访问者证明身份合法性。（确实是合法的，全
球有效）
 劫持CA（certificate authority）证书：
从以上过程我们可以看出，只要保证3中的3个条件验证通过，即可申请到合法的TLS
证书。如果我们选择了正确的CA，BGP劫持打断CA间的通话也不会被发现。
实现这样的攻击你需要的只有两个
1、一个可控制的边界路由
2、你的BGP结点的信息：它的客户，提供者，结点信息，公共服务类似Qrator Radar
或者 BGP监听。花一个小时确认这些基本信息，AS_PATH 追踪路线，等等。
然后：
使用BGP劫持技术将whios、URL认证server、DNS TXT、DNS token对应的地址指向自
己搭建的3类server：
查询whois记录
（明文传送可伪造）
载入特定html在特定url通过认证
（明文传送可伪造）
使用者在dns表中建立自定义token
（明文传送可伪造）
然后接着进行第4步即可完成TLS证书申请。
通过以上方法可拿到合法的TLS签名
关于BGP的那些安全缺陷/漏洞
给我一个合适的“支点”，我能撬动地球
大约1/64512
的比例
How to detection and defense.
PART 04
检测 & 防御
检测 & 防御
BGP Routes Moniting（检测篇）
 使用traceroute命令查看TTL相关信息。
并与正常情况下进行比对。多数情况下可
通过TTL值增减和经过的AS路径来判断是
否存在劫持。
当未发生路由劫持时，如下图：
当发生路由劫持时，发现路由绕行了:
AS40->AS30->AS10->100。
如下图：
检测 & 防御
BGP Routes Moniting（检测篇）
 自建平台实时同步全球权威机构、组织的全量BGP路由表，
并与本地收集到的BGP进行比对。发现异常并实时告警。
如下图：
部分开源项目，如RouteViews：
 选取合理的采集周期，在周期内对BGP正常状态下路
由更新条目的数量进行统计。选取合理的更新条目
总数阈值范围，实时监控AS内BGP路由条目更新数目，
发现异常实时告警。
 使用商业化BGP路由监控告警平台
IAR (Internet Alert Registry)
•
PHAS
(Prefix
Hijack
Alert
System)
• RIPE NCC MyASN Service
• BGPmon
• WatchMY.NET
• Renesys Routing Intelligence
检测 & 防御
过滤和限制路由通告范围（防御篇）
 梳理清楚AS范围内BGP、IGP全局路由策略哪些路由通告是允许的、哪些是禁止的。并合理使用ACL、Route-map或BGP Prefx Filtering控制路由的宣告、传播范围。
 运营商、服务提供商应当依据以下原则，对不同商业角色路由器进行路由通告制定详细的BGP Prefx Filtering并启用。
如下图：
检测 & 防御