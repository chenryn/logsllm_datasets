### 5个经典的BGP安全事件

#### BGP协议的安全缺陷和漏洞
**PART 03**

##### BGP的基本原则
1. 当BGP路由建立邻居连接后，彼此将路由条目发送给邻居。
2. 当目的网络确定时，AS_PATH最短路径具有路由优先权。
3. 当目的网络确定时，网络通告地址越具体（掩码越长）越有路由优先权。

##### BGP劫持 (BGP Hijack)
- **闲置AS抢夺**：攻击者对外宣告不属于自己的但属于其他机构合法且未被宣告的网络。例如，AS1拥有网络1.1.1.1/18和1.1.2.2/18，但只使用了1.1.1.1/18并对外宣告。AS5发现AS1没有宣告1.1.2.2/18，于是对外宣告1.1.2.2/18，导致所有前往1.1.2.2/18的流量都发给了AS5。
- **近邻AS通告抢夺**：利用物理位置邻近特性，就近宣告不属于自己的网络，从而劫持近邻网络链路。
- **长掩码抢夺 (Special-Prefix hijack)**：利用BGP选路长掩码优先的特性劫持所有可达网段的全流量。
- **AS_PATH劫持 (沙丁鱼捕术)**：通过增加AS_PATH穿越AS数量抑制其路由优先级，将数据流向赶向目标网络，达到控制网络流量的目的。

##### BGP路由泄露 (Route Leak)
- BGP路由条目在不同的角色都有其合理通告范围，一旦BGP路由通告传播到其原本预期通告范围之外，称之为路由泄露。根据其发生泄漏后造成的结果大致可分为以下三种：
  - 造成源网络中断。
  - 造成源网络和被指向网络中断。
  - 造成AS穿越/ISP穿越/MITM等问题。

##### BGP TTL修改 (BGP TTL Modify)
- BGP TTL值支持自定义修改，可以在进行MITM攻击的同时制定策略，修改TTL值以隐藏攻击行为。例如，通过配置EBGP多跳来解决非直连邻居的问题，并通过修改TTL值来隐藏非直连关系。

##### 使用BGP破解HTTPS
- 通过BGP劫持获取合法TLS证书，进而解密HTTPS流量。步骤包括：
  1. 在CA网页申请一个账号。
  2. 认证登录请求CSR（Certificate Signing Request）创建并载入。
  3. 通过查询whois记录、载入特定HTML在特定URL通过认证、在DNS表中建立自定义token等方式验证用户所有权。
  4. 付款后获得TLS合法认证。

##### 给我一个合适的“支点”，我能撬动地球
- 大约1/64512的比例

#### 检测与防御
**PART 04**

##### 检测篇
- **BGP路由监控**：
  - 使用`traceroute`命令查看TTL相关信息，并与正常情况进行比对。
  - 自建平台实时同步全球权威机构、组织的全量BGP路由表，并与本地收集到的BGP进行比对。
  - 选取合理的采集周期，在周期内对BGP正常状态下路由更新条目的数量进行统计，并设置合理的阈值范围进行实时监控。
  - 使用商业化BGP路由监控告警平台，如IAR (Internet Alert Registry)、PHAS (Prefix Hijack Alert System)、RIPE NCC MyASN Service、BGPmon、WatchMY.NET 和 Renesys Routing Intelligence。

##### 防御篇
- **过滤和限制路由通告范围**：
  - 梳理清楚AS范围内BGP、IGP全局路由策略哪些路由通告是允许的、哪些是禁止的。
  - 合理使用ACL、Route-map或BGP Prefix Filtering控制路由的宣告、传播范围。
  - 运营商和服务提供商应依据详细的原则，对不同商业角色路由器进行路由通告制定详细的BGP Prefix Filtering并启用。

通过以上方法，可以有效检测和防御BGP相关的安全问题。