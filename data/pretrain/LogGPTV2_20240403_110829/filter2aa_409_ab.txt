domain account
(Domain User /
Domain Computer)
More than one
Exchange Server
From a Domain Account to Exchange 
Server RCE
â€¢
All group members have local administrator privileges on Exchange Servers
Exchange Trusted Subsystem
â€¢
Relaying NTLM over SMB to WinRMï¼Ÿ
â€“
Based on HTTP/HTTPS, support NTLM authentication
â€“
HTTP: Signing and sealing are enabled
â€“
HTTPS: Channel Binding is set to Relaxed
Available Services
â€¢
Relaying NTLM over SMB to SMBï¼Ÿ
â€“
SMB signing is enabled by default on Exchange Server
â€¢
Relaying NTLM over SMB to MSRPCï¼Ÿ
â€“
NCACN_NP port 445 SMB
â€“
NCACN_IP_TCP port 135 + a dynamic port assigned by EPM
Available Services
MSRPC
ncalrpc
ncacn_np
ncacn_ip_tcp
ncacn_http
â€¦
â€¢
Relaying NTLM over SMB to MSRPCï¼Ÿ
â€“
NCACN_IP_TCP port 135 + a dynamic port assigned by EPM
â€¢
MS-TSCH, MS-RPRN, MS-SCMR, MS-SAMR, â€¦
â€¢
RPC clients can set the auth type to RPC_C_AUTHN_WINNT to use NTLMSSP
Available Services
â€¢
Relaying NTLM authentication to MSRPC over NCACN_IP_TCP
â€“
CVE-2020-1113
â€¢
MS-TSCH on Task Scheduler service
â€¢
Found by @sploutchy from Compass Security
â€“
CVE-2021-1678
â€¢
MS-RPRN on Printer Spooler service
â€¢
Found by Eyal Karni and Alex Ionescu from CrowdStrike
Available Services
â€¢
DCOM allows COM objects to be used over the network
â€¢
DCOM is based on MSRPC
DCOM
NTLM authentication to 172.19.0.100:135 (ISystemActivator)
ISystemActivator::RemoteCreateInstance(CLSID, IID, â€¦)
client
server
OBJREF StringBindings NCACN_TCP_IP 172.19.0.100[8652]
NTLM authentication to 172.19.0.100:8652
Object RPC request
Object RPC response
...
Port 135
A Dynamic Port
â€¢
Signing and sealing are not force enabled on DCOM servers
â€¢
DCOM clients can set the auth level to RPC_C_AUTHN_LEVEL_CONNECT
to avoid signing and sealing
MS-RPC Authentication Levels
â€¢
WMI (Windows Management Instrumentation)
â€“
Based on DCOM, allows administrators to manage remote computers
â€¢
DCOM
â€“
ShellWindows (9BA05972-F6A8-11CF-A442-00A0C90A8F39)
â€“
ShellBrowserWindow (C08AFD90-F2A1-11D1-8455-00A0C91F3880)
â€“
MMC20.Application (49B2791A-B1AE-4C90-9B8E-E860BA07F89)
Find Exploitable COM Objects
â€¢
MMC20.Application Document.ActiveView.ExecuteShellCommand
â€“
Found by @enigma0x3 from SpecterOps
â€¢
Available on latest Windows Server 2019 by default
â€¢
Require authenticating to only two RPC interfaces
MMC20.Application
The Exploit Chain
Exchange1
XLAB\attacker
Exchange2
Printer Bug
XLAB\Exchange1$ NTLM authentication
Relay the NTLM authentication to DCOM ISystemActivator
XLAB\Exchange1$ NTLM authentication
Relay the NTLM authentication to DCOM IDispatch
iDispatch.GetIDsOfNames("Document")
iDocuement.GetIDsOfNames("ActiveView")
iActiveView.GetIDsOfNames("ExecuteShellCommand")
Invoke "cmd /c calc"
ISystemActivator::CreateRemoteInstance
Demo
â€¢
Fixed on Patch Tuesday in Jun and assigned CVE-2021-26414
â€¢
Manually set RequireIntegrityActivationAuthenticationLevel = 1 on 
DCOM servers
â€“
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Ole\AppCompat
RequireIntegrityActivationAuthenticationLevel
â€“
Force enable RPC_C_AUTHN_LEVEL_PKT_INTEGRITY
Patches
Conclusion
Exchange Server
RCE
A normal
domain account
(Domain User /
Domain Computer)
More than one
Exchange Server
Lateral Movement & Privilege Escalation
â€¢
Previous lateral movement/privilege escalation methods after Exchange RCE
â€“
WriteDACL on the Domain Object + DCSync
â€¢
Fixed in 2019
â€“
Abuse DNS Admins group
â€¢
Fixed in 2019
â€“
Abuse the ForceChangePassword right on domain users
â€¢
Force change passwords of domain users
â€¢
Unable to recover the victim user's original password
â€“
Abuse the WriteDACL right on domain users
â€¢
Set SPN on domain users and perform the Kerberoasting attack
â€¢
Sometimes it's hard to brute force passwords if there is a complex password policy
Previous Work
Exploit Primitives
Group Policy Creator Owners
Exchange Windows Permission
Exchange Trusted Subsystem
Attacker
XLAB\Exchange1$
RCE
Member Of
Member Of
Add Member
Add Member
Exploit Primitives
â‘ 
Add users to high-privileged groups
Exploit Primitives
Group Policy Creator Owners
Exchange Windows Permission
Exchange Trusted Subsystem
Attacker
XLAB\Exchange1$
RCE
Member Of
Member Of
Add Member
Add Member
Create OU
Organizational
Unit
Exploit Primitives
â‘ 
Add users to high-privileged groups
â‘¡
Create new Organizational Units
Exploit Primitives
Group Policy Creator Owners
Exchange Windows Permission
Exchange Trusted Subsystem
Attacker
XLAB\Exchange1$
RCE
Member Of
GPO
Create GPO
Create OU
Organizational
Unit
Exploit Primitives
â‘ 
Add users to high-privileged groups
â‘¡
Create new Organizational Units
â‘¢
Create new Group Policy Objects
â‘£
Move objects to other containers
Member Of
Add Member
Add Member
Exploit Primitives
Group Policy Creator Owners
Exchange Windows Permission
Exchange Trusted Subsystem
Attacker
XLAB\Exchange1$
RCE
Member Of
GPO
Write Distinguished Name
Organizational
Unit
Users / Computers Objects
Delete from containers
Exploit Primitives
â‘ 
Add users to high-privileged groups
â‘¡
Create new Organizational Units
â‘¢
Create new Group Policy Objects
â‘£
Move user/computer objects to OUs
Create User / Computer Objects
Write name
Write Name 
Create GPO
Create OU
Member Of
Add Member
Add Member
Design a new lateral movement method
Evil OU
Evil GPO
gPLink
Create OU
Create GPO
attacker
victim
Move to Evil OU
User Immediate Task
Group 
Policy
Refresh
Pop calc
Exchange Trusted Subsystem
Group Policy Creator Owners
Member of
Add to Evil GPO
â€¢
SharpGPO: A new red team tool for remotely manipulating GPOs
â€“
Get/New/Remove OU
â€“
Get/New/Remove GPO
â€“
Get/New/Remove gPLink
â€“
Get/New/Remove Security Filtering
â€¢
SharpGPOAbuse (@FSecureLabs)
â€“
Create malicious group policies
â€“
User Immediate Task
â€“
Computer Immediate Task
GPO Manipulation
https://github.com/Dliv3/SharpGPO
Demo
â€¢
Privilege Escalation -> Domain Admin? ðŸ¤”
â€¢
AdminSDHolder
â€“
Provides "template" permissions for the protected accounts and groups
â€“
All domain admins, adminCount = 1
â€¢
Domain Controller computers
â€“
adminCount is not set
Privilege Escalation
Design a new privilege escalation method
EvilComputerOU
EvilComputerGPO
gPLink
Create OU
Create GPO
attacker
Domain Controller
Move to OU
Computer Immediate Task
Group 
Policy
Refresh
SYSTEM
Pop calc
Exchange Trusted Subsystem
Group Policy Creator Owners
Member of
Add to GPO
Default Domain
Controller Policy
gPLink
Demo
â€¢
Switch to Active Directory split permissions model
â€“
Effectively limit Exchange rights in Active Directory
Mitigation
Conclusion & Takeaways
â€¢
For Red Teams
â€“
Two new Exchange Server vulnerabilities
â€“
A new lateral movement / privilege escalation method
â€¢
For Blue Teams
â€“
Patch all vulnerable Exchange Servers and the Windows Servers where they are 
running on!
â€“
Switch your Exchange Servers to Active Directory split permissions model if
possible
â€“
Restrict NTLM usage as much as possible
Conclusion & Takeaways
â€¢
The Printer Bug @tifkin_ from SpecterOps
â€¢
Impacket @agsolino
â€¢
ExchangeRelayX @quickbreach
â€¢
impacket/exchanger.py Arseniy Sharoglazov
â€¢
MMC20 @enigma0x3 from SpecterOps
â€¢
CVE-2020-1113 @sploutchy from Compass Security
â€¢
CVE-2021-1678 Eyal Karni and Alex Ionescu from CrowdStrike
â€¢
SharpGPOAbuse @FSecureLabs
â€¢
Special thanks to MSRC for their hard work in fixing these vulnerabilities
Acknowledgement
[1] https://www.zerodayinitiative.com/blog/2018/12/19/an-insincere-form-of-flattery-
impersonating-users-on-microsoft-exchange
[2] https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-
directory
[3] https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-
operations-in-exchange
[4] https://github.com/quickbreach/ExchangeRelayX
[5] https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc/
[6] https://www.crowdstrike.com/blog/cve-2021-1678-printer-spooler-relay-security-advisory/
[7] https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/425a7c53-c33a-
4868-8e5b-2a850d40dc73
[8] https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-
object/
[9] https://github.com/SecureAuthCorp/impacket
[10] https://github.com/gdedrouas/Exchange-AD-Privesc
[11] https://labs.f-secure.com/tools/sharpgpoabuse/
References
Thank you !
Tianze Ding (@D1iv3)