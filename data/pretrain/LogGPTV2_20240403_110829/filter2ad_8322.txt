# 利用机器学习检测HTTP恶意外连流量

## 译文声明
本文为翻译文章，具体内容和含义以原文为准。

## 1. 背景
攻击者为了控制远程主机，通常会在受害主机上植入后门等恶意软件，并通过受控主机主动发起连接请求。这种连接产生的流量即为恶意外连流量（如图1.1所示）。目前主要的检测方法有两种：基于黑名单过滤恶意域名和使用规则匹配恶意外连流量。这两种方法都有局限性。黑名单方法只能识别已知的恶意网站，对新出现的恶意域名无能为力；而基于规则的方法需要安全人员逐一分析样本，耗时费力且难以应对变种恶意流量。

作为现有技术的补充，可以利用机器学习来检测恶意流量。通过发现恶意流量之间的共性并据此进行检测，一个有效的算法能够显著减少安全人员的工作量。已有不少文献探讨了采用机器学习检测恶意流量的方法，包括根据流量内容或变化特征进行检测。本文主要受到[ExecScent](https://www.usenix.org/system/files/conference/usenixsecurity13/sec13-paper_nelms.pdf)这篇论文的启发。

![图1.1 恶意外连流量示意图](image_url)

## 2. 数据收集
实验室已经积累了大量的恶意样本（部分示例如图2.1所示）。通过在沙箱中运行这些恶意样本，我们收集到了外连HTTP流量。其中一部分是恶意流量，但也混杂着正常流量。经过人工分析，我们将这些流量分为恶意流量和白流量，并利用威胁情报信息为恶意流量打上所属恶意家族标签。最终用于训练的数据结构如图2.2所示。

![图2.1 恶意样本示意图](image_url)
![图2.2 用于训练的数据信息](image_url)

## 3. 数据分析
通过对采集到的恶意外连流量进行分析，我们发现来自同一恶意家族的流量具有明显的相似性。例如，图3.1展示了两个不同恶意样本产生的恶意外连流量，经分析确认均属于LokiBot恶意家族。可以看出两者之间有很高的相似度。同样地，图3.2显示了两个来自Generic Trojan家族的恶意外连流量，也表现出极高的结构相似性。

进一步分析发现，同一家族的恶意流量具备以下特点：
- URL路径结构一致，尽管具体路径不同但数据类型相同；
- URL参数相似；
- 请求头字段基本相同且内容高度重合。

由于同一家族的恶意外连流量具有上述相似性，我们可以使用聚类算法将它们归为一类，并提取共性模板，进而用于检测新的恶意外连流量。

![图3.1 LokiBot家族恶意外连流量](image_url)
![图3.2 Generic Trojan家族恶意外连流量](image_url)

## 4. 算法实现
本算法主要包括两部分：恶意HTTP外连流量模板生成和未知HTTP流量检测。下面分别介绍这两部分内容。

### 4.1 模板生成
模板生成流程包括五个步骤：请求头字段提取、泛化、相似性计算、层次聚类以及生成恶意外连流量模板（见图4.1）。

#### 4.1.1 提取请求头字段
将HTTP流量划分为URL、URL参数、User-Agent、Host、Content-Length等结构化字段，便于后续处理。

#### 4.1.2 泛化
对于同一家族的恶意流量，虽然结构一致但细节有所不同。我们将HTTP流量中的数字、字母、混合字符、十六进制数及Base64编码部分分别替换为特殊字符，消除差异。例如，在图3.2所示的流量中，将字母转换为*，十六进制部分转换为@，数字部分转换为$，从而保留结构特征同时忽略具体内容差异（见图4.2）。

![图4.2 泛化效果](image_url)

#### 4.1.3 相似度计算
为了聚类恶意流量，我们需要计算各流量间的相似度。在这一过程中，不同字段的重要性各异。例如，图3.2中的恶意流量明显URL部分更为独特，不易与白流量混淆；而Accept、User-Agent等字段则常见于各类流量。因此，在计算相似度时，URL应赋予更大权重，其他字段权重较小（见图4.3）。

![图4.3 相似度计算](image_url)

各个字段的特异性权重计算如下：
- **URL路径特异性**：根据路径复杂度定义，越复杂的路径越难与白流量重叠。
- **URL参数特异性**：根据参数数量定义，参数越多特征越明显。
- **其他常见请求字段特异性**：统计所有流量中该字段的出现频率，频率低则认为特异性高。
- **特殊字段特异性**：统计所有流量中的字段信息，标记出现频率低的字段为特殊字段。

![图4.4 URL路径和参数特异性](image_url)

#### 4.1.4 层次聚类
根据相似度矩阵，使用层次聚类算法将请求头划分为若干类。每一类中的请求头都具有相似的结构，用于生成恶意流量模板（见图4.5）。

![图4.5 恶意流量层次聚类图](image_url)

#### 4.1.5 生成恶意流量模板
对每一类聚类结果，获取其字段内容的并集作为模板中的值，相当于去除了训练集中重复的部分。

### 4.2 未知流量检测
未知流量检测流程包括待测流量请求头字段提取、泛化、模板匹配以及判别流量性质四个部分（见图4.6）。

![图4.6 未知http流量检测](image_url)

其中，字段提取和泛化过程与模板生成阶段相同。模板匹配过程则是计算待检测请求头与模板的相似度，加权平均后的相似度即为待测流量与模板的匹配程度。具体相似度计算方法与模板生成过程中的4.1.3节类似，唯一区别在于模板中同一个请求头字段可能有多个值，在计算时取其中相似度最高的值。如果未知流量与模板的相似度大于预设阈值，则判定其为恶意外连流量。

## 5. 算法效果
我们采用80%的黑样本作为训练集，20%的黑样本及全部白样本作为测试集，评估算法性能。绘制的PRC曲线如图5.1所示。可以看到，随着召回率的提升，算法始终保持较高的精度。最终选择0.8作为匹配阈值，此时算法精度为93.56%，召回率为97.14%，F-值为0.9532。

![图5.1 PRC曲线](image_url)

此外，我们分别使用10%、20%、30%... 90%的黑样本作为训练集，测试其余样本数据，统计检测的恶意流量正确率、白流量正确率以及误报率（见图5.2）。结果显示，算法对白样本的检测正确率一直维持在99%以上。对于黑样本，其检测正确率随训练集多样性的增加而提高。即使在训练集只有10%的情况下，算法仍能检测出77.65%的黑样本，表明其对恶意流量变种具有较好的泛化能力。

![图5.2 训练集占比对黑白测试样本检出率影响](image_url)

表5.1列出了不同训练集占比下检出率和误报率的具体数值。随着训练集占比的提高，检出率大幅上升，这是由于模型能够捕捉更多特征。然而，误报率略有上升，但仍处于可接受范围。

我们还实现了一个简易的测试页面，用户可以通过上传PCAP文件来检测其中是否包含恶意流量（见图5.3和5.4）。该页面将在后续开放。

| 训练集占比 | 检出率 | 误报率 |
|------------|--------|--------|
| 10%        | 77.65% | 0.5%   |
| 20%        | 85.2%  | 0.6%   |
| 30%        | 90.1%  | 0.7%   |
| ...        | ...    | ...    |
| 90%        | 98.5%  | 1.2%   |

![图5.3 检测恶意流量页面](image_url)
![图5.4 检测结果页面](image_url)

## 6. 参考文献
- [1] Nelms T, Perdisci R, Ahamad M. ExecScent: Mining for New C&C Domains in Live Networks with Adaptive Control Protocol Templates[C]//USENIX Security Symposium. 2013: 589-604.
- [2] Egele M, Scholte T, Kirda E, et al. A survey on automated dynamic malware-analysis techniques and tools[J]. ACM computing surveys (CSUR), 2012, 44(2): 6.
- [3] Gu G, Perdisci R, Zhang J, et al. BotMiner: Clustering Analysis of Network Traffic for Protocol-and Structure-Independent Botnet Detection[C]//USENIX security symposium. 2008, 5(2): 139-154.
- [4] Zhao D, Traore I, Sayed B, et al. Botnet detection based on traffic behavior analysis and flow intervals[J]. Computers & Security, 2013, 39: 2-16.
- [5] Wurzinger P, Bilge L, Holz T, et al. Automatically generating models for botnet detection[C]//European symposium on research in computer security. Springer, Berlin, Heidelberg, 2009: 232-249.