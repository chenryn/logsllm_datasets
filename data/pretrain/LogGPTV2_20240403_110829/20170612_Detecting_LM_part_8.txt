- Network Information -> Destination Port / Protocol: "8888" / "6"(TCP)
- Confirmable Information
OS: Windows - Host Used as the Proxy: Network Information -> Destination Address
user
↓
Registry Entry:
OS: Windows HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\
SavedLegacySettings
user
Access History
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\
- -
DefaultConnectionSettings
Registry
- Confirmable Information
- Last Acquired Proxy Setting *The setting cannot be distinguished if wpad is used in regular operations.
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> New Process Name: "[File Name (wpad.exe)]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution： Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
The following is recorded immediately after the tool is executed.
Event Log Event ID: 5154 (The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections)
Destination host - - Application Information -> Process ID: The Process ID recorded in event ID 4688. Required
Security - Application Information -> Application Name: "\device\harddiskvolume2\[File Name (wpad.exe)]"
- Confirmable Information
- Port Listened to: Network Information -> Source Port ("80"/"8888")
- Protocol: Network Information -> Protocol ("6" = TCP)
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Process ID: "4"
- Application Information -> Application Name: "System"
- Network Information -> Direction: "Outbound"
- Network Information -> Source Address: "[Host that Executed the Tool]"
- Network Information -> Address Port Source Port Protocol: "137" (both destination and source) / "17"
The following is recorded when the source host acquires wpad.
40
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Process ID: The Process ID recorded in event 4688.
- Application Information -> Application Name: "\device\harddiskvolume2\[File Name (wpad.exe)]"
- Network Information -> Direction: "Inbound"
Required
- Network Information -> Source Port / Protocol: "80" / "6"(TCP)
- Confirmable Information
- Connected Host: Network Information -> Destination Address
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Process Information -> Process Name: "[File Name (wpad.exe)]"
- Confirmable Information
- Target File: Object -> Object Name ("[Path to Tool]\wpad.dat")
- Handle ID: Object -> Handle ID *Used for association with other logs.
- Process Details: Access Request Information -> Access ("SYNCHRONIZE" / "ReadData (or ListDirectory)" / "WriteData (or
"AppendData (or AddSubdirectory or CreatePipeInstance)" / "ReadEA" / "WriteEA" / "ReadAttributes" /
- Success or Failure: Keywords ("Audit Success")
The following is recorded when the source host uses the host as a proxy.
The log file (proxy.log) is created on the same path as that of the executable file (a handle for the log is requested and closed each time).
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
Event Log
- Application Information -> Process ID: The Process ID recorded in event 4688.
-
- Application Information -> Application Name: "\device\harddiskvolume2\[File Name (wpad.exe)]"
Security
- Network Information -> Direction: "Inbound"
- Network Information -> Source Port / Protocol: "8888" / "6"(TCP)
OS: Windows - Confirmable Information
Required
user - Connected Host: Network Information -> Destination Address
↓
Destination host
OS: Windows
(Continued from the Event ID: 4656 (A handle to an object was requested)
user
previous entry) 4663 (An attempt was made to access an object)
(Continued from
4658 (The handle to an object was closed)
the previous
- Process Information -> Process Name: "[File Name (wpad.exe)]"
entry)
- Confirmable Information
- Target File: Object -> Object Name ("[Path to Tool]\proxy.log")
- Handle ID: Object -> Handle ID *Used for association with other logs.
- Process Details: Access Request Information -> Access ("WriteData (or AddFile)")
- Success or Failure: Keywords ("Audit Success")
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Process ID: The Process ID recorded in event 4688.
- Application Information -> Application Name: "\device\harddiskvolume2\[File Name (wpad.exe)]"
- Network Information -> Direction: "Outbound"
- Network Information -> Source Address: "[Host that Executed the Tool]"
- Network Information -> Source Port / Protocol: "[Destination Server Port] (80 if nothing is specified)" / "6"(TCP)
- Confirmable Information
- Destination Host: Network Information -> Destination Address
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image： "[File Name (wpad.exe)]"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *If iframe, etc. is used, it can be read from the argument.
- User Name: User
- Process ID: ProcessId
File name:
C:\Windows\Prefetch\WPAD.EXE-[RANDOM].pf
Execution History
-
Prefetch - Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
- Last Execution Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output -
41
3.5.1. RDP (Remote Desktop Protocol)
Basic Information
Tool Name RDP (Remote Desktop Protocol)
Legend
Category Remote Login
- Acquirable
Tool Overview A protocol to connect to a server on which Remote Desktop Service (RDS) is running
Information
Tool - Event ID/Item Name
Example of - View files on the logged in machine
- Field Name
Presumed Tool Use - Collect information (required) for connecting to other servers and clients
- "Field Value"
During an Attack - Use as a stepping stone to connect to other equipment
Authority Standard user
- Source host: Windows
Targeted OS
- Destination host: Windows with Remote Desktop enabled
Operating
Domain Not required
Condition
Communication
3389/tcp
Protocol
Service - Destination host: Remote Desktop Services
- Destination host: RDP session connection start/end time and date
Information Source host IP address
Standard Settings
Acquired from Logged in user name, and
Log Success or failure of account domain connection
Additional Settings - Source host: mstsc.exe execution history, file access history
- Destination host: If the following logs are in the event log, it is considered that the connection was successful.
Evidence That Can Be Confirmed
- Event ID: 4624 is recorded in the event log "Security".
When Execution is Successful
- Event IDs 21 and 24 are recorded in the event log
"Microsoft\Windows\TerminalServices-LocalSessionManager\Operational"
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> New Process Name: "C:\Windows\System32\mstsc.exe
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event Log
- Required
Security Event ID: 4663 (An attempt was made to access an object)
4656 (A handle to an object was requested)
4658 (The handle to an object was closed)
- Process Information -> Process Name: "C:\Windows\System32\mstsc.exe"
- Confirmable Information
- Target File: Object -> Object Name (Example: "C:\Users\[User Name]\Documents\Default.rdp")
- Handle ID (Used for Association with Other Logs): Object -> Handle ID
- Process Details: Access Request Information -> Access ("WriteData (or AddFile)"
"AppendData (or AddSubdirectory or
- Success or Failure: Keywords ("Audit Success")
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\mstsc.exe"
Execution history
Source host
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
File name:
Execution History C:\Windows\Prefetch\MSTSC.EXE-76A46E8A.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
OS: Windows
user Registry Entry: HKEY_USERS\[SID]\Software\Microsoft\Terminal Server Client\Default\
↓
OS: Windows - Confirmable Information
user - Remote Desktop Connection History: Value Name = "MRU0" to "MRU9"
*As the data of the above value, an IP address that was connected to in the past is recorded.
MRU0 is the last connected history
Access History As the last write time for a key, the update time and date (time of the first connection
to a destination host not
- -
found in the connection history) for the "MRU0" value data is recorded.
Registry
Registry Entry: l
HKEY_USERS\[SID]\Software\Microsoft\Termina Server Client\Servers\[Destination Host IP Address]\
- Confirmable Information
- The Last Accessed Account Domain and User Name: Value Name = "UsernameHint"
*As the value data, the last accessed account domain and user name are
recorded for each IP address that was connected to in the past.
Event ID: 4624 (An account was successfully logged on)
- Logon Type: "10"
- Network Information -> Source Network Address: Destination Address for event 5156
- Network Information -> Source Port: Destination Port recorded in event 5156
Access History
- Detailed Authentication Information -> Logon Process: "Kerberos"
- Required
Audit Policy
- Confirmable Information
- Connection Source Host: Network Information -> Source Network Address
- Used User: New Logon -> Account Name / Account Domain
- New Logon ID (used for association with other logs): New Logon -> Logon ID
Event ID: 21 (Remote Desktop Services: Session logon succeeded)
Destination host
- Confirmable Information
Event Log
- Session Connection Start Time and Date: Log Date
-
- Logged in Account Domain and User Name: User
Application and
- Connection Source IP Address: Source Network Address
Service Log
-
\Microsoft\Windows
\TerminalServices- Event ID: 24 (Remote Desktop Services: Session has been disconnected)
LocalSessionManage
r - Confirmable Information
\Operational - Session Connection Start Time and Date: Log Date of an Event Log with the Same Session ID in Event ID: 21
- Logged in Account Domain and User Name: User
- Connection Source IP Address: Source Network Address
Remarks
Depending on the environment, the following log may be recorded in the destination host event log "Security".
Additional Event Logs That Can Be Output Event ID: 4624 (An account was successfully logged on)
- Logon Type: "12"
42
3.6.1. WCE (Remote Login)
Basic Information
Tool Name WCE (Remote Login) Legend
Category pass-the-hash, pass-the-ticket - Acquirable
Tool Overview Executes a command with higher privileges using the hash of the acquired password Information
Tool - Event ID/Item Name
Example of Remotely executes a command on another machine by using a password hash for a user with Administrator privileges who belongs to Active Directory
- Field Name
Presumed Tool Use - Source host: WCE execution source
- "Field Value"
During an Attack - Destination host: The destination logged in by WCE
Authority Local administrator
Targeted OS Windows
Operating Domain Not required
Condition Communication
A random 5-digit port (WMIC)
Protocol
Service -
- Source host: Execution history (Prefetch)
Information Standard Settings
A record of the fact that WCESERVICE was installed and executed
Acquired from
- Both source host and destination host: WMI execution history and Windows Filtering Platform log
Log Additional Settings
- Destination host: Login has occurred remotely.
- Source host: The fact that WCESERVICE was installed and executed is recorded.
Evidence That Can Be Confirmed
- Destination host: The fact that a logon was made from a remote host is recorded.
When Execution is Successful
- Both source host and destination host: The fact that communication using WMI occurred is recorded.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Object -> Object Name: "(C:\Windows\Temp\wceaux.dll)"
- Access Request Information -> Access / Reason for Access: ("WriteData (or AddFile)")
- Confirmable Information
- Process Name: "[File Name (wce.exe)]"
- Handle ID: Object -> Handle ID
Event ID: 4656 (A handle to an object was requested)
4660 (An attempt was deleted)
4658 (The handle to an object was closed)
- Object -> Object Name: "(C:\Windows\Temp\wceaux.dll)"
- Access Request Information -> Access / Reason for Access: ("DELETE")
- Confirmable Information
- Process Name: "[File Name (wce.exe)]"
- Handle ID: Object -> Handle ID
Event Log
- Required
Processes for events 4656, 4663, and 4658 are performed for multiple files.
Security
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Object -> Object Name: "(C:\Users\[User Name]\AppData\Local\Microsoft\Windows\
Temporary Internet Files\Content.IE5)"
- Access Request Information -> Access / Reason for Access: ("SYNCHRONIZE","WriteAttributes","WriteData (or AddFile)")
- Process Information -> Process Name: "C:\Windows\System32\wbem\WMIC.exe"
- Confirmable Information
- Handle ID: Object -> Handle ID *Used for association with other logs.
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name:("C:\Windows\System32\wbem\WMIC.exe")
- Network Information -> Direction: "Outbound"
OS: Windows
- Confirmable Information
administrator
Source host - Destination Host: Destination Address
↓
(Windows) - Destination Port: Destination Port
OS: Windows
administrator
Event ID: 7045 (A service was installed in the system)
- Service Name: "WCESERVICE"
- Confirmable Information
- Process Start Time and Date: Log Date
- Service File Name: "[File Name (wce.exe)] -S"
Event Log
- -
System
Event ID: 7036
- Detailed Tab -> System\Provider\Name: "Service Control Manager"
- Details Tab -> EventData\param1: "WCESERVICE"
- Confirmable Information
- Running the Service: Details Tab -> EventData\param2 "Running" Stopped"
( ) / (" )
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "[File Name (wce.exe)]"
- Image: "C:\Windows\System32\wbem\WMIC.exe"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
Event Log
Event ID: 8 (CreateRemoteThread detected)
- Required
- SourceImage： "[File Name (wce.exe)]"
Sysmon - TargetImage： "C:\Windows\System32\lsass.exe"
( )
- Confirmable Information
- Process Start Time and Date (UTC): UtcTime
Event ID: 9 (RawAccessRead detected)
- Image： "C:\Windows\System32\cmd.exe"
- Confirmable Information
- Process Start Time and Date (UTC): UtcTime
- Access Destination: Device
43
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
File name: ）
C:\Windows\Prefetch\[File Name (WCE.EXE ]-[RANDOM].pf