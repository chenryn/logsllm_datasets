............
..........
..........
...........
.........2
319
302
30
8
88
---
## Page 15
程序员职业生涯的一些感悟.··
后记
附录Zabbix自带宏
第27章社区论坛·
第26章微信公众平台报警…
第25章
第24章
26.3微信接口请求次数限制·
26.1申请微信公众平台账号
26.2配置微信公众平台账号
25.3手机端Zabbix App..
25.2
25.1
23.5
23.4  Rule Engine
23.3
23.2
Chromix
：Zabbix第三方插件
报警系统架构
Spider
26.2.5发送第一条文字消息
26.2.2
26.2.1使用SAE进行测试开发·
26.2.4
26.2.3
25.3.2
25.3.1ZBX Mobile
ZabbixNotifier
获取用户的openid...
获取access_token
申请测试账号…
Zabbkit
-服务器添加Zabbix监控
............
.......
......
......
......
.......
........
·XV·
......
....
....
338
目录
350
349
338
3
324
---
## Page 16
★第4章监控第一台Host
★
★
第3章Zabbix安装
第2章Zabbix简介
第1章
第一部分概念篇
自动化运维和监控系统
---
## Page 17
起在通宵加班啊。
逼地加班了。
是非常“悲催”的职业。每天在几千台服务器上面敲命令，查看系统状态，发布代码，任务很
运维和研发工程师。
他们要时刻关注网站或者系统的状况，一旦出现问题，要第一时间进行排查，并且联系相关的
开发、系统开发等工作，比如监控系统、发布系统之类；监控组，就是24小时值班的人员，
Administrator），即系统管理员；而运维开发在一些公司则不属于运维部门，主要负责运维工具
第1章
2
是繁重。
是必需的一
1.1互联网公司的运维工作
自动化运维和监控系统
国内中大型的互联公司，拥有几百、几千台服务器是很正常的情况，所以运维工程师一直
（3）双11最苦逼的是谁？看着老婆抢购的汉子？No！是淘宝的运维，他和他男朋友们一
（2）atlassian 家的东西怎么和我家教务一样呢.·这一天都挂成狗了Java 运维好苦逼。
（1）双11来了，今晚支付宝都瘫痪啦，我在想今晚程序员，搞运维的，项目团队又要苦
在微博上，搜索“运维苦逼”关键字，可以看到很多不堪重负的疲惫语言，比如下面几条：
一般来说，公司中的运维，包括基础运维、应用运维、运维开发和监控组四部分。前两者
一基础运维是负责IDC的，上架服务器、网络这些；应用运维可以理解为SA（System
---
## Page 18
和服务器的关系、IDC 容量等。它是运维的心脏，所有的系统都依赖于它。
器对于运维来说都是一样的。
少人的参与。首先它要包括以下几部分：
苦”作为反例，我们能想到一个好的运维架构是怎样的：
些我全部碰到过了”。是啊，这些是苦逼运维工程师几乎每天要面对的问题。反过来想，以这些“痛
1.2何谓自动化运维
然后复制到Excel，再画图。如果想几台机器一起看，那更加痛苦。
事们的痛苦：
（4）CMDB-
（3）服务器标准化—Cobbler 装机加上Puppet，可以做到硬件、软件的标准化。每台机
（2）发布系统—代码发布，发布后的检查，代码的回滚，灰度发布。
（1）监控报警一
笔者的理解，运维自动化，就是把运维中大量日常重复性工作使用工具让其自动运行，减
（1）硬件标准化一
如果读者是运维工程师，看到前一小节结尾的时候，肯定嘴角露出邪恶的笑容，心里想“这
（5）不清楚资产情况。很多公司的运维人员，竟然不知道自己公司的IDC有多少台服务器。
（4)分析问题困难。比如想看过去1天的CPU负载的情况，必须先用sar-q获取到这些数据，
前两点都很容易理解，那运维自动化具体是干什么的呢？
（3）运维自动化一
（2）软件标准化一
（3）机器之间不统一。代码是一样的，一台机器是正常的，另一台是不正常的，见鬼了！
（2）发布代码太痛苦了。要一台一台机器去执行命令，一台一台机器去检查发布是否成功。
（1）系统出问题了不知道。要等到客户报障才知道网站服务出问题。
从这几条微博，基本能理解运维人员的痛苦了吧。下面说说我在工作过程中碰到的运维同
一配置管理数据库，存储了所有运维相关数据，包括服务器硬件信息、域名
一系统数据，应用指标的监控，和出错时及时报警。
一包括服务器、内存、系统版本等。
一包括监控、发布、CMDB。
一应用版本等。
第1章自动化运维和监控系统
3
---
## Page 19
务器和负责人的关系、域名和域名之间的关系等。
个二维平面的表格外，还维护了“关系”这个概念，比如前面提到的服务器和域名的关系、服
人离职了、两个Excel数据有冲突的问题了。
险，比如把一台正在服务的服务器给关了。这里就更不要说Excel里面记错了、记录Excel的
维护更新呢？要知道，这些数据如果不更新，就是一堆垃圾。如果数据不准确，甚至还会有危
哪些机器呢？还是同样的声音：“记在Excel里。”可是，这些记在Excel里面的数据，由谁来
另一个机房，然后重装系统，给新业务服务。基础运维的同事怎么知道可以搬几台机器，去搬
器是为www服务的呢？仍有人回答：“可以放Excel里。”标准化，要从一个机房搬一批机器到
人会回答：“记在Excel里。”当我发布代码时，我想发布到www这个域名下，那么哪几台服务
自动化的核心。为什么这么说，看我慢慢道来。
统我都明白是干什么的了，但CMDB好像跟前面几个都没什么关系。”其实，CMDB才是运维
马了，出了问题第一时间通知到负责人，告知服务器的问题和出问题现场的服务器性能数据。
会把这些人累趴下，很有可能键盘上的s和h是最早磨花的，因为要不停的“ssh”。
历过。
人参与的事情，就一定会犯错，比如rm敲错以后的懊悔，我估计所有做运维的读者都曾经经
这样做吗？答案是不能，先不说你能不能说服老板找100多人来做运维，最重要的是只要是
无非是多找一些工程师罢了。但当公司的规模扩大，服务器到了几百、几千的规模后，还能
Puppet 保证服务器上的软件都是一个版本；资产容量搞不清？CMDB 帮你理清楚一切。
PPTV已经能做到一键发布，一键回滚）；机器不统一？Cobbler保证装出来的服务器完全一样
松；代码发布困难？使用发布系统，代码首先灰度发布,发布一些机器检查正常后，继续发布（在
警邮件马上就发给你，简单的错误甚至可以自动修复，使监控数据的可视化、性能分析变得轻
Zabbix监控系统深度实践
+
对了，CMDB就是这个Excel。当然，这个是对CMDB非常粗略的解释。CMDB除了是一
监控系统要发报警给负责人，那么某一台服务器谁是负责人，这个信息由谁来维护呢？有
读到这里，有较真的读者要问了，“那CMDB是干嘛的？监控系统、发布系统、标准化系
这么多服务器，天知道哪台服务器什么时候出问题、出什么问题，这时候，监控系统要出
如果说几百台机器的代码发布工作，让人来一台一台干的话，我估计每天几十次的发布，
当公司只有几十台服务器的时候，“人肉”进行这些工作去解决不标准的问题，都是可以的
说白了，这就是运维自动化了，前面提到的痛苦全都“药到病除”了：系统出问题了？报
?
---
## Page 20
1.4监控系统的理想化模样
现场这台服务器的状况。运维工程师可以通过不同纬度的分析，找出问题的原因。
据和简单的分析，比如当时一段时间的CPU负载等，以帮助接到报警的人员快速定位问题。
示所有服务器的这些信息？
个终端，然后while true来显示CPU负载。撇开能不能看清楚的问题，得要多少显示器才能显
中一台机器上架了，那么监控系统自动加人监控。
MySQL挂了。这些操作，手动去做非常麻烦，需要跟运维的其他系统共同协作，比如CMDB
当服务器维护时，又要暂停这些报警，否则你明明在维护MySQL，监控系统还给你报警说
CPU负载、内存等；当服务器上开始跑应用时，需要加入对应的应用监控，比如Resin、MySQL等；
问题。
1.3监控系统在运维自动化中的角色
（2）数据要保存在数据库中，这样以后需要的时候可以对这些数据进行分析计算。
（1）监控系统能够自定义监控的内容，可以自己写脚本来收集需要的数据。
在出现故障以后进行问题分析时，还要靠监控系统。因为监控系统真实地记录了故障发生
当发生问题时，监控系统要第一时间发出报警，报警中除了出问题的点，还可以有一些数
监控系统是运维人员的眼睛，没有它，就没法知道系统运行状况，总不见得，我打开几十
1.监控数据收集及可视化。
根据控监控系统在运维中的角色，理想的监控系统应该具有如下特点。
（3）和其他系统协同工作。
监控系统在运维自动化里的角色，可以用下面三点来概括。
服务器的整个生命周期，都要和监控系统打交道。服务器上架，需要加入基础监控，比如
监控系统，是运维工程师和研发工程师的眼睛。它帮助工程师在第一时间发现网站的
（2）异常数据报警。
（1）监控数据收集及可视化。
第1章自动化运维和监控系统
5
---
## Page 21
比如重启服务等。
服务器敲命令来获取基本的信息。
Zabbix监控系统深度实践
（5）报警后可以自动跑一些命令。这些命令可以是获取需要的信息，也可以是自动修复
（3）监控可视化的图可以方便地引用，而不是要用一大串JavaScript。
（2）监控数据是开放的，数据库中的数据结构不要太复杂，让人无从下手。
（1）有强大的API可以使用，可以让其他系统调用完成工作。
3.和其他系统协同工作。
（4）报警内容要可以自行设置，在报警邮件中加人一些简单的分析，而不是让运维人员上
（3）报警方式要能够自定义，可以发邮件和短信，如果能够在IM上通知别人就更好了。
（2）报警需要被确认，让运维人员知道多少报警已经有人认领并开始处理了。
2.异常数据报警。
（4）数据可视化不要很花哨，但要直观好用。
（3）能够方便、快速地将监控加人到服务器上，不需要烦琐的操作。
---
## Page 22
Google Trends 对Zabbix的预测。图2-2是Zabbix在全球的区域热度。
bix Agent 进行通信，获取监控数据，这是Zabbix监控的一般模式。
用好它，把它的潜能挖掘出来，需要花很大的力气。
们“易于上手，难于精通”。而Zabbix也一样，你可以非常容易地搭建起可用的Zabbix，但要
据可供分析。为什么暴雪的游戏（星际争霸、暗黑破坏神、魔兽争霸等）都这么经典？因为它
支撑，可以设定自定义的Item，自动生成报表，有API和其他系统集成，数据库中有开放的数
可以在很短的时间内搭建起一套功能完善的报警系统。而对于中大型公司，Zabbix也能很好地
监控系统。对于想快速可用的小型公司，Zabbix自带的Item足够满足需求，通过简单的配置
来监控IT基础设施的可用性和性能。而我的看法是：它是一个能够快速搭建起来的、开源的
2.1Zabbix发展现状
Zabbix从2007年开始流行，2013年在国内开始流行起来。图2-1尾部的虚线部分是
使用Zabbix时，一般需要在被监控的服务器上安装ZabbixAgent，ZabbixServer会和 Zab-
Zabbix是一个非常强大的监控系统，其官方的说明是：Zabbix是企业级的软件，被设计用
Zabbix简介
第2章
---
## Page 23
2.2选择Zabbix的理由
旨在分享 Zabbix自定义监控脚本的项目。
共享这些脚本，在本书的最后一部分介绍开源和社区的地方，会提到笔者在Github上建立的，
怪的是，Zabbix的很多自定义监控脚本，都是通用的，但到目前为止，还没有一个平台，去
JMX的原生支持和Linux级别的自动发现。
2.0开始，界面有了很大的变化，相比以前比较丑陋的UI，变得有层次感了，并且增加了对于
热度随时间变化的始势
Zabbix监控系统深度实践
8
可以定义复杂的报警逻辑，做到Item之间的关联报警，而不是只能针对一个一
◎数据可视化不要很花哨，但要好用—Zabbix每一个Item都可以看到其历史，Web界
◎数据要保存在数据库中，这样以后需要的时候可以对这些数据进行分析计算—Zabix
Zabbix目前的BugFix也比较正常，整个项目比较成熟，适合在公司中使用。笔者比较奇
◎监控系统能够自定义监控的内容，可以自己写脚本来收集需要的数据一
现在对应前文，看看Zabbix是否能满足理想中的监控系统的要求。
Zabbix目前的最新稳定版是2.2.0，第一个版本是2004年3月发布的Zabbix1.0。Zabbix从
在数据库中的表结构虽然有些复杂，但逻辑很清晰。
面可拖动，界面友好。
何自定义的监控脚本，只要输出需要的值就可以。
强大的Trigger 定义，几乎可以满足所有规则组合。
念，可以方便地将一组Item进行统一操作。
能够方便、快速地将监控加入到服务器上，不需要烦琐的操作一
图2-1
图2-2
—Zabbix有模板这一概
-Zabbix支持任
Zabbix
---
## Page 24
东西和概念进行简单的解释。
语需要理解。
最后，我决定在本书中使用Zabbix原生的英语名词，然后在附录中会有一个中英文对照。因为
使用中文界面的读者不容易理解；如果使用中文名词，有的地方官方翻译的又不是很通顺，不
2.3Zabbix部分名词约定
从现在的所有开源产品来说，英语仍是第一语言；在论坛中的交流，文档资料都是英语。要掌
符合中国人的阅读习惯，比如“Discover”这个功能，Zabbix翻译为“探索”和其本意相差太远。
名词好，还是用中文名词好？如果使用英文名词，那么一部分英语不太好，或者因为各种原因
虽然是基于Zabbix 的中文翻译，但在开始学习 Zabbix 之前，先对一些 Zabbix 比较重要的
Zabbix有中文界面，但不是非常完善。我在写这本书的时候，一直在考虑，到底是用英文
由此可见，Zabbix 满足我们所有对于监控系统的需求。是不是有些心动了呢？
①监控可视化的图可以方便的引用，而不是要用一大串JavaScript一
◎监控数据是开放的，数据库中的数据结构不要太复杂，让人无从下手一
①报警后可以自动跑一些命令。这些命令可以是获取运维人员需要的信息，也可以是自动
◎报警内容要自己可设置，在报警邮件中加入一些简单的分析，而不是让运维人员上服务
◎报警方式要能够自定义，可以发邮件、发短信，如果能够在IM上通知别人就更好了一
①报警需要被确认，让运维人员知道多少报警已经有人认领并开始处理了—Zabbix对于
生的绘图模块，如果要引用Zabbix的图表，只需要引用图表的URL 即可，非常方便。
Zabbix数据库中，可以方便地进行分析
Zabbix支持邮件、Jabber。
乎所有的操作都可以通过API实现。
有强大的API可以使用，可以让其他系统来调用完成工作一
修复，比如重启服务等—在触发报警后，Zabbix可以远程执行命令。
报警，有ACK机制。
更复杂的功能，可以通过远程调用命令实现。
器敲命令来获取基本的信息—Zabbix自定义了一套宏可以在报警邮件中引用，如果要
—Zabbix支持RestAPI，几
一Zabbix使用PHP原
第2章Zabbix简介
一监控数据就在
6
---
## Page 25
·10
Zabbix监控系统深度实践
①Action：当Trigger符合某个值的时候，Zabbix会进行的操作，比如最常见的发邮件。
 Trigger：一些逻辑规则的组合，它有三个值：正常、异常、未知。
Item：对于某一个指标的监控，对应的是Items，英文原意是“物品”。比如某台服务器
Host：广义上的服务器，大多数情况指代的是刀片机这类，在少部分时间会指代包括交
Zabbix Agent:部署在被监控服务器上的一个进程，负责和 Zabbix Server交互，执行命令。
O Zabbix Server：Zabbix 的控制中心，收集数据、写入数据库都是它的工作。
的CPU负载就是一个Item。
换机在内的，被Zabbix监控的实体。
---