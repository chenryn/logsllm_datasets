戏和虚拟世界来说是比较自然的。
不幸的是，我们发现我们不能够向程序员隐藏所有的东西。当在
Darkstar上编写的第一个游戏表现出极少的并行度（以及意料之外
的糟糕性能）时，这一点就明确了。通过检查源代码，我们很快就
发现了原因。游戏中的数据结构设计导致了游戏中所有的状态改变
都只涉及一个对象，并由它来协调所有的工作。使用这个对象实际
上使得游戏中所有动作序列化执行，这使得基础设施不能够发现并
利用并发计算。
当我们发现这一点时，我们与游戏并发者进行了长时间的讨论，主
题是在设计对象时需要考虑到并发访问。通过对游戏中数据对象进
行审查，我们发现了一些类似的情况：数据设计方案排除了并发的
可能性（并非出自设计者本意）。当这些对象重新设计之后，系统
的整体性能增加了好几个数量级。
这告诉我们，不可能让使用Darkstar的并发者完全不知道系统底层
的并发和分布式实质。但是，他们对系统这方面特点的知识不需要
包括并发控制、锁，以及在系统的各个分布式部分之间的通信。实
际上，他们只需要在设计活动中确保他们的数据对象定义能够充分
利用并发。这种设计一般只需要确保对象定义是自包含的，它们的
操作不需要依赖其他对象的属性。这一点对于任何系统来说，都不
是不好的设计原则。
关于Darkstar架构，我们还有许多方面没有测试，或者说我们并未
完全理解。虽然我们已经得到了一个系统，使得多台机器能够利用
多线程运行一个游戏或虚拟世界，同时对服务器程序员（几乎）保
持透明，但是我们还没有通过添加核心服务之外的其他服务，来检
验该架构的能力。由于Darkstar任务的事务本质，这可能比我们开
931
---
## Page 933
始设想的要复杂得多，但我们希望这些添加的服务不需要参与到核
心服务的事务中。我们已经开始试验通过不同的方式来收集系统负
载的信息和实现负载平衡。幸运的是，因为实现这种负载平衡的机
制对于使用系统的程序员是完全不可见的，所以我们可以移除老的
方式，引入新的方式，同时又不影响Darkstar的用户。
作为一个架构，Darkstar展示了一些创新的方法，这使它变得很有
趣。它试图构造一个游戏或虚拟世界的基础设施，使其具有企业级
软件一样的可靠性，同时文满足游戏行业对延迟、通信和伸缩性的
要求。它是目前为数不多的这类尝试之一。通过利用更多机器和更
多线程来实现效率，我们希望能够抵消因使用持久存储机制而导致
的延迟增加。最后，游戏和虚拟世界环境中极为不同的情况，即客
户端的处理很多而服务器端的处理很少，与我们常见的高并发、分
布式系统环境形成了鲜明的对比。现在说这个架构是否成功还为时
尚早，但我们相信它已经很有趣了。
第4章记忆留存MichaelNygard
原则与特性
结构
功能多样性
V模块
V概念完整性
V依赖关系
V修改独立性
进程
V自动传播
数据访问
V可构建性
增长适应性
932
---
## Page 934
熵增抵抗力
从最早的锡版照相法和达盖尔银板照相法开始，我们一直都认为照
片是具有特别意义的，有时候甚至是神奇的。照片记录了一内而过
的时刻，而我们的记忆容易出错，不能做到这一点。但是最好的肖
像不仅保存了一个时刻，还阐释了这个时刻，捕捉了某个眼神或表
情，捕捉了有特点的姿势，让主角靓丽照人。
如果你的小孩在美国的学校上学，你可能已经熟悉Lifetouch这个名
字。Lifetouch每年都为美国儿乎所有的小学生、初中生和高中生照
相。但是你可能不知道，Lifetouch还经营着高品质的肖像照相馆。
Lifetouch肖像照相馆（LPS）开设在美国各大零售商店中，还在大超
市中开设了“Flash！"连锁照相馆。在这些照相馆中，LPS的摄像师
拍摄那些可以保留一生的照片。
数字摄影改变了整个摄影行业，LPS也不例外。大圈的胶片和上底
片框的照相机不见了，取而代之的是专业级的DSLR和闪存卡。自
由摄影师可以四处走动，尝试不同角度，比以往任何时候更接近所
拍摄对象。简而言之，它们更自由地拍摄这些了不起的肖像。摄影
师利用照相机将光子转变为电子，但通过某种方式，在某些地方，
某些系统必须将这些电子转变成墨水原子和纸张。
2005年，我和来自Minneapolis的ATI（AdvancedTechnologies
Integration）的同事，与LPS的开发者一起工作，开发了一个新系统
来完成这部分工作。
4.1功能和约束
这两点影响了系统的架构：它必须做什么？它必须在什么限制条件
下工作？这两点也确定了问题空间。
通过解决这些重要问题，在要求的行为和限制条件之间进行探索，
我们创造并考察解决方案空间。如果对各项限制条件的解决方案形
成了一致的整体，我们就可能创造出一个优雅的、美丽的解决方
案。我很高兴地说，CreationCenter项目做到了这一点。
在这个项目中，我们面对了一些明确的事实。有些只是业务的特
点，另一些会改变，但不在我们考虑的范围内。不管怎样，我们认
为这些事实是不会变的。这些事实构成了图4-1中的左边一列。
933
---
## Page 935
UI和UI模型
多品牌
支持产品家族
模块和加载程序
让支持成本降到最低
自助服务终端风格的GUI
合伙人是摄影师，
不是图像艺术家
让部署成本降低最低
数据库迁移
网络是不可靠的
让培训需求降到最低
可互换的工作站
照相馆是远程的
让岩机风险降到最低
客户希望得到他们自己的产品
非集中式首次展示
处处使用GUID
生产是集中式的
应用Conway法则
不可修改的数据
生产吞吐量很重要
让生产可伸缩
注染工厂
重要
同题
关注点
图4-1：事实、重要问题和CreationCenter架构的关注点
多品牌
LPS今天支持多个品牌，将来可能加入更多品牌。至少，Creation
Center会有两个视觉上截然不同的界面主题，而且添加界面主题应
该不需要大量的工作。
合伙人是摄影师，不是图像艺术家
摄影师接受过如何使用照相机的培训，但没有接受过使用Photoshop
的培训。当一个没有经验的用户使用Photoshop时，最可能的结果是
得到糟糕的图片。对于强大的用户来说，Photoshop是强大的工具，
照相馆的摄影师应该没有必要去体验Photoshop的学习曲线。
Photoshop和类似的工具会让照相馆的工作流程变慢。照相馆的合伙
人需要快速创造出漂亮的图像。
照相馆是远程的
934
---
## Page 936
照相馆在地理上是分布式的，很少或没有本地技术支持。硬件交付
或替换需要来回运送部件。
网络是不可靠的
某些照相馆没有网络连接。即便对于有网络连接的照相馆，因断网
而导致照相馆停工也是不可接受的。
客户希望得到他们自己的产品
客户收到的照片应该包括他们自己的设计和要求的文字。
生产是集中式的
高品质的照片打印机正变得越来越常见，但制作能够保存儿十年的
产品需要贵得多的设备。
生产吞吐量很重要
使用到相同的打印机也是生产过程中的约束条件。因此，过程中的
其他步骤必须服从于这个药束条件。
这些事实导致了一些重要问题，我们必须权衡考虑。人们常常将这
些重要问题视为最基本的，但它们不是的。实际上，它们源自于系
统存在的环境。如果环境改变，这些重要因素会无效，甚至走向反
面。
我们选择了一些结构来解决这些重要问题。图4-1中右边的一列展示
了架构的这些关注点。当然，这些并不是CreationCenter的全部值得
讨论的特性，但架构中的这些考虑是普遍关注的。我也认为它们同
时展示了很好的关注点分离和相互支持的结构。
在深入到具体的特性之前，我们需要补充介绍一点背景知识：系统
的工作流。
4.2工作流
典型的照相馆有2～4个摄影室，备有专业的灯光、背景幕布和支
架。摄影师在摄影室中拍照（每张照片被称为一个“姿势"）。在摄
935
---
## Page 937
影室外面，摄影室也提供客户服务、安排计划，并让客户挑选照
片。
当摄影师完成了一个阶段的拍照之后，她会坐到一台工作站前面，
从照相机的存储卡中导人照片。
导入了一批照片后，摄影师会删除那些明显不好的照片，包括闭眼
的、不高兴表情的、婴几没有看镜头等照片。删除了这些不好的照
片之后，剩下的照片就是“基本照片”。接下来她会从这些基本照片
中选择一些进行增强。增强可以是简单色调调整，如变成黑白或深
褐色，也可以是精心组合多张照片。例如，摄影师可能为3个小孩
拍摄一张合影，然后将照片嵌入设计好的3个“卡槽”中，得到他们
的个人照。
在完成了这些增强后，摄影师帮助客户订购打印的各种尺寸和组
合。包括8"×10"这样的大照片，或者5"×7"、3"×5"，以及适合放在
钱包中的小照片。还有更大的尺寸。客户最大可以订购24"x30"的照
片，配上镜框后挂在墙上。
在完成了客户订购后，摄影师就转向下一组照片的拍摄。
每天工作结束时，照相馆经理会制作一张DVD，包含当天所有的订
购照片，并将它送到打印工厂。
打印工厂每天会收到几百张DVD。（稍后我会介绍这些DVD的内
容。）这些DVD包含了订单和需要打印的照片，照片打印好后会送
回照相馆，这样客户就可以取走自己的照片。但在照片打印之前，
最终打印分辨率的照片必须渲染成图片。这些可以打印的图片是很
大的。如果把24"×30"的肖像渲染成高品质的图片，会超过1亿像
素，每个像素都由32位的颜色来表示。所有像素都是根据摄影师在