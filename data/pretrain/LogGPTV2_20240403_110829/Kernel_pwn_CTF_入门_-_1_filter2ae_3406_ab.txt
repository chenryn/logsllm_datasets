>
###  3\. è°ƒè¯•è¿‡ç¨‹
####  a. attach qemu
è°ƒè¯•æ—¶æœ€å¥½ä½¿ç”¨ root æƒé™æ‰§è¡Œ `/bin/sh`ï¼Œç›¸å…³ä¿®æ”¹æ–¹æ³•å·²ç»åœ¨ä¸Šé¢è¯´æ˜ï¼Œæ­¤å¤„æš‚ä¸”ä¸è¡¨ã€‚
åœ¨å¯åŠ¨ qemu æ—¶ï¼Œé¢å¤–æŒ‡å®šå‚æ•° `-gdb tcp::1234` ï¼ˆæˆ–è€…ç­‰ä»·çš„`-s`ï¼‰ï¼Œä¹‹å qemu å°†åšå¥½ gdb attach çš„å‡†å¤‡ã€‚å¦‚æœå¸Œæœ›
qemu å¯åŠ¨åç«‹å³æŒ‚èµ·ï¼Œåˆ™å¿…é¡»é™„å¸¦ `-S` å‚æ•°ã€‚
åŒæ—¶ï¼Œè°ƒè¯•å†…æ ¸æ—¶ï¼Œä¸ºäº†åŠ è½½ vmlinux ç¬¦å·è¡¨ï¼Œ **å¿…é¡»é¢å¤–æŒ‡å®š`-append "nokaslr"`ä»¥å…³é—­ kernel
ASLR**ã€‚è¿™æ ·ç¬¦å·è¡¨æ‰èƒ½æ­£ç¡®çš„å¯¹åº”è‡³å†…å­˜ä¸­çš„æŒ‡å®šä½ç½®ï¼Œ **å¦åˆ™å°†æ— æ³•ç»™ç›®æ ‡å‡½æ•°ä¸‹æ–­ç‚¹** ã€‚
qemuå¯åŠ¨åï¼Œ **å¿…é¡»å¦èµ·ä¸€ä¸ªç»ˆç«¯** ï¼Œé”®å…¥ `gdb -q -ex "target remote localhost:1234"`ï¼Œå³å¯
attach è‡³ qemuä¸Šã€‚
gdb attach ä¸Š qemu åï¼Œå¯ä»¥åŠ è½½ vmlinux ç¬¦å·è¡¨ã€ç»™ç‰¹å®šå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå¹¶è¾“å…¥ `continue` ä»¥æ‰§è¡Œè‡³ç›®æ ‡å‡½æ•°å¤„ã€‚
    # qemu æŒ‡å®š -S å‚æ•°åæŒ‚èµ·ï¼Œæ­¤æ—¶åœ¨gdbé”®å…¥ä»¥ä¸‹å‘½ä»¤
    gef> add-symbol-file vmlinux
    gef> b start_kernel
    gef> continue
    [Breakpoint 1, start_kernel () at init/main.c:837]
    ......
å¯¹äºå†…æ ¸ä¸­çš„å„ä¸ªç¬¦å·æ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ä¸€äº›ç¬¦å·åœ¨å†…å­˜ä¸­çš„åŠ è½½åœ°å€ï¼š
    # grep  /proc/kalsyms
    grep prepare_kernel_cred  /proc/kallsyms
    grep commit_creds  /proc/kallsyms
    grep ko_test_init  /proc/kallsyms
> å‘ç‚¹1ï¼šä¹‹å‰ç¬”è€…ç¼–å†™äº†ä»¥ä¸‹ shell è„šæœ¬ï¼š
>  
>  
>     # å…¶ä»–è®¾ç½®
>     [...]
>     # **åå°** å¯åŠ¨ qemu
>     qemu-system-x86_64 [other args] &
>     # ç›´æ¥åœ¨å½“å‰ç»ˆç«¯æ‰“å¼€ GDB
>     gdb -q -ex "target remote localhost:1234"
>  
>
> ä½†åœ¨æ‰§è¡Œè„šæœ¬æ—¶ï¼Œå½“ç¬”è€…åœ¨ GDB ä¸­é”®å…¥ Ctrl+C æ—¶ï¼Œ SIGINT ä¿¡å·å°†ç›´æ¥ç»ˆæ­¢ qemu è€Œä¸æ˜¯æŒ‚èµ·å†…éƒ¨çš„
> kernelã€‚å› æ­¤ï¼Œgdbå¿…é¡»åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨æ‰å¯ä»¥æ­£å¸¸å¤„ç† Ctrl+Cã€‚
>
> æ­£ç¡®çš„è„šæœ¬å¦‚ä¸‹ï¼š
>  
>  
>     # å…¶ä»–è®¾ç½®
>     [...]
>     # **åå°** å¯åŠ¨ qemu
>     qemu-system-x86_64 [other args] &
>     # å¼€å¯æ–°ç»ˆç«¯ï¼Œåœ¨æ–°ç»ˆç«¯ä¸­æ‰“å¼€ GDB
>     gnome-terminal -e 'gdb -q -ex "target remote localhost:1234"'
>  
>
> å‘ç‚¹2ï¼šå¯¹äº gdb gef æ’ä»¶æ¥è¯´ï¼Œæœ€å¥½ä¸è¦ä½¿ç”¨å¸¸è§„çš„`target remote
> localhost:1234`è¯­å¥ï¼ˆæ— éœ€rootæƒé™ï¼‰æ¥è¿æ¥è¿œç¨‹ï¼Œå¦åˆ™ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š
>  
>  
>     gefâ¤  target remote localhost:1234
>     Remote debugging using localhost:1234
>     warning: No executable has been specified and target does not support
>     determining executable automatically.  Try using the "file" command.
>     0x000000000000fff0 in ?? ()
>     [ Legend: Modified register | Code | Heap | Stack | String ]
>     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers
> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
>     [!] Command 'context' failed to execute properly, reason: 'NoneType'
> object has no attribute 'all_registers'
>  
>
> ä¸ä¹‹ç›¸å¯¹çš„ï¼Œä½¿ç”¨æ•ˆæœæ›´å¥½çš„ `gef-remote` å‘½ä»¤ï¼ˆéœ€è¦rootæƒé™ï¼‰è¿æ¥ qemuï¼š
>  
>  
>     # ä¸€å®šè¦æå‰æŒ‡å®šæ¶æ„
>     set architecture i386:x86-64
>     gef-remote --qemu-mode localhost:1234
>  
>
> å‘ç‚¹3ï¼šå¦‚æœ qemu æ–­åœ¨ `start_kernel`æ—¶ gef æŠ¥é”™ï¼š
>  
>  
>     [!] Command 'context' failed to execute properly, reason: max() arg is
> an empty sequence
>  
>
> ç›´æ¥å•æ­¥ `ni` ä¸€ä¸‹å³å¯ã€‚
####  b. attach drivers
#####  1) å¸¸è§„æ­¥éª¤
é¦–å…ˆï¼Œ å°†ç›®æ ‡é©±åŠ¨åŠ è½½è¿›å†…æ ¸ä¸­ï¼š
    insmod 
ä¹‹åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ qemu ä¸­å†…æ ¸é©±åŠ¨çš„ text æ®µçš„è£…è½½åŸºåœ°å€ï¼š
    # æŸ¥çœ‹è£…è½½é©±åŠ¨
    lsmod
    # è·å–é©±åŠ¨åŠ è½½çš„åŸºåœ°å€
    grep  /proc/modules
åœ¨ gdb çª—å£ä¸­ï¼Œé”®å…¥ ä»¥ä¸‹å‘½ä»¤ä»¥åŠ è½½è°ƒè¯•ç¬¦å·ï¼š
    add-symbol-file mydrivers/ko_test.ko  [-s  ] ...
> æ³¨ï¼Œä¸ vmlinux ä¸åŒï¼Œä½¿ç”¨ add-symbol-file åŠ è½½å†…æ ¸æ¨¡å—ç¬¦å·æ—¶ï¼Œ **å¿…é¡»æŒ‡å®šå†…æ ¸æ¨¡å—çš„ text æ®µåŸºåœ°å€** ã€‚
>
> å› ä¸ºå†…æ ¸ä½äºä¼—æ‰€å‘¨çŸ¥çš„è™šæ‹Ÿåœ°å€ï¼ˆè¯¥åœ°å€ä¸ vmlinux elf
> æ–‡ä»¶çš„åŠ è½½åœ°å€ç›¸åŒï¼‰ï¼Œä½†å†…æ ¸æ¨¡å—åªæ˜¯ä¸€ä¸ªå­˜æ¡£ï¼Œä¸å­˜åœ¨æœ‰æ•ˆåŠ è½½åœ°å€ï¼Œåªèƒ½ç­‰åˆ°å†…æ ¸åŠ è½½å™¨åˆ†é…å†…å­˜å¹¶å†³å®šåœ¨å“ªé‡ŒåŠ è½½æ­¤æ¨¡å—çš„æ¯ä¸ªå¯åŠ è½½éƒ¨åˆ†ã€‚å› æ­¤åœ¨åŠ è½½å†…æ ¸æ¨¡å—å‰ï¼Œæˆ‘ä»¬æ— æ³•å¾—çŸ¥å†…æ ¸æ¨¡å—å°†ä¼šåŠ è½½åˆ°å“ªå—å†…å­˜ä¸Šã€‚æ•…å°†ç¬¦å·æ–‡ä»¶åŠ è½½è¿›
> gdb æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å°½å¯èƒ½æ˜¾å¼æŒ‡å®šæ¯ä¸ª section çš„åœ°å€ã€‚
>
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ **åŠ è½½ç¬¦å·æ–‡ä»¶æ—¶ï¼Œè¶Šå¤šæŒ‡å®šæ¯ä¸ª section çš„åœ°å€è¶Šå¥½** ã€‚å¦åˆ™å¦‚æœåªå•ç‹¬æŒ‡å®šäº† .text
> æ®µçš„åŸºåœ°å€ï¼Œåˆ™æœ‰å¯èƒ½åœ¨ç»™å‡½æ•°ä¸‹æ–­ç‚¹æ—¶æ–­ä¸ä¸‹æ¥ï¼Œéå¸¸å½±å“è°ƒè¯•ã€‚
å¦‚ä½•æŸ¥çœ‹ç›®æ ‡å†…æ ¸æ¨¡å—çš„å„ä¸ª section åŠ è½½é¦–åœ°å€å‘¢ï¼Ÿè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    grep "0x" /sys/module/ko_test/sections/.*
#####  2) ä¾‹å­
ä¸€ä¸ªå°å°ä¾‹å­ï¼šè°ƒè¯• ko_test.ko çš„æ­¥éª¤å¦‚ä¸‹ï¼š
  * é¦–å…ˆåœ¨ qemu ä¸­çš„ kernel shell æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ 
        # é¦–å…ˆè£…è½½ ko_test è¿›å†…æ ¸ä¸­
    insmod /ko_test.ko
    # æŸ¥çœ‹å½“å‰ ko_test è£…è½½çš„åœ°å€
    grep ko_test /proc/modules
    grep "0x" /sys/module/ko_test/sections/.*
è¾“å‡ºå¦‚ä¸‹ï¼š
  * è®°å½•ä¸‹è¿™äº›åœ°å€ï¼Œä¹‹åè¿›å…¥ gdb ä¸­ï¼Œå…ˆæŒ‰ä¸‹ Ctrl+C æ–­ä¸‹ kernelï¼Œç„¶åé”®å…¥ä»¥ä¸‹å‘½ä»¤ï¼š 
        # å°†å¯¹åº”ç¬¦å·åŠ è½½è‡³è¯¥åœ°å€å¤„
    add-symbol-file mydrivers/ko_test.ko  0xffffffffc0002000 \
                        -s .rodata.str1.1 0xffffffffc000304c \
                        -s .symtab        0xffffffffc0007000 \
                        -s .text.unlikely 0xffffffffc0002000
    # ä¸‹æ–­ç‚¹
    b ko_test_init
    b ko_test_exit
    # ä½¿å…¶ç»§ç»­æ‰§è¡Œ
    continue
  * æœ€åå›åˆ° qemu ä¸­ï¼Œåœ¨ kernel shell ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 
        # å¸è½½ ko_test
    rmmod ko_tes
æ­¤æ—¶ gdb ä¼šæ–­åˆ° ko_test_exit ä¸­ï¼š
å¦‚æœåœ¨å¸è½½äº†ko_teståï¼Œåˆé‡æ–°åŠ è½½ ko_testï¼Œ
        insmod ko_test
åˆ™ gdb ä¼šç«‹å³æ–­åˆ° ko_test_init ä¸­ï¼š
> è¿™å¯èƒ½æ˜¯å› ä¸ºæŒ‡å®šäº† nokaslrï¼Œä½¿å¾—ç›¸åŒé©±åŠ¨å¤šæ¬¡åŠ è½½çš„åŸºåœ°å€æ˜¯ä¸€è‡´çš„ã€‚
ä¸Šé¢è°ƒè¯• kernel module çš„ init å‡½æ•°æ–¹æ³•ç®—æ˜¯ä¸€ä¸ªå° trickï¼Œå®ƒåˆ©ç”¨äº† **noaslr ç¯å¢ƒä¸‹ç›¸åŒé©±åŠ¨é‡æ–°åŠ è½½çš„åŸºåœ°å€ä¸€è‡´**
çš„åŸç†æ¥ä¸‹æ–­ã€‚ä½†æœ€ä¸ºæ­£ç¡®çš„è°ƒè¯• init å‡½æ•°çš„æ–¹å¼ï¼Œè¿˜æ˜¯å¾—è·Ÿè¸ª `do_init_module` å‡½æ•°çš„æ§åˆ¶æµæ¥è·å–åŸºåœ°å€ã€‚ä»¥ä¸‹æ˜¯ä¸€ç³»åˆ—ç›¸å…³æ“ä½œæ­¥éª¤ï¼š
> è·Ÿè¸ª `do_init_module` å‡½æ•°æ˜¯å› ä¸ºå®ƒåœ¨ `load_module`
> å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚`load_module`å‡½æ•°å°†åœ¨å®Œæˆå¤§é‡çš„å†…å­˜åŠ è½½å·¥ä½œåï¼Œæœ€åè¿›å…¥ `do_init_module` å‡½æ•°ä¸­æ‰§è¡Œå†…æ ¸æ¨¡å—çš„ init
> å‡½æ•°ï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œå–„åå·¥ä½œã€‚
>
> `load_module`å‡½æ•°å°†è¢«ä½œä¸º SYSCALL å‡½æ•°çš„ `init_module`è°ƒç”¨ã€‚
  * é¦–å…ˆè®© kernel è·‘é£ï¼Œç­‰åˆ° kernel åŠ è½½å®Œæˆï¼Œshell ç•Œé¢æ˜¾ç¤ºåï¼Œgdb æŒ‰ä¸‹ ctrl + C æ–­ä¸‹ï¼Œç»™ `do_init_module`å‡½æ•°ä¸‹æ–­ã€‚è¯¥å‡½æ•°çš„å‰åŠéƒ¨åˆ†å°†ä¼šæ‰§è¡Œ å†…æ ¸æ¨¡å—çš„ init å‡½æ•°ï¼š 
        /*
     * This is where the real work happens.
     *
     * Keep it uninlined to provide a reliable breakpoint target, e.g. for the gdb
     * helper command 'lx-symbols'.
     */
    static noinline int do_init_module(struct module *mod)
    {
      [...]
      /* Start the module */
      if (mod->init != NULL)
        ret = do_one_initcall(mod->init);   // init` æˆå‘˜å³å¯æŸ¥çœ‹åˆ° kernel module init å‡½æ•°çš„é¦–åœ°å€ã€‚
  * è¦æƒ³çœ‹åˆ°å½“å‰ kernel module çš„å…¨éƒ¨ section åœ°å€ï¼Œå¯ä»¥åœ¨ gdb ä¸­é”®å…¥ä»¥ä¸‹å‘½ä»¤ 
        # æŸ¥çœ‹å½“å‰ module çš„ sections ä¸ªæ•°
    p mod->sect_attrs->nsections
    # æŸ¥çœ‹ç¬¬ 3 ä¸ª section ä¿¡æ¯
    p mod->sect_attrs->attrs[2]
æœ‰äº†å½“å‰å†…æ ¸æ¨¡å—çš„å…¨éƒ¨ section åç§°ä¸åŸºåœ°å€åï¼Œå°±å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„æ–¹æ³•æ¥åŠ è½½ç¬¦å·æ–‡ä»¶äº†ã€‚
####  c. å¯åŠ¨è„šæœ¬
> é…ç¯å¢ƒçœŸæ˜¯ä¸€ä»¶éº»çƒ¦åˆ°æç‚¹çš„äº‹æƒ…ï¼Œä¸è¿‡ç›®å‰å°±åˆ°æ­¤ä¸ºæ­¢äº† ğŸ™‚
ç¬”è€…å°†ä¸€ç³»åˆ—å¯åŠ¨å‘½ä»¤æ•´åˆæˆäº†ä¸€ä¸ª shell è„šæœ¬ï¼Œæ–¹ä¾¿ä¸€é”®è¿è¡Œï¼š
    #! /bin/bash
    # åˆ¤æ–­å½“å‰æƒé™æ˜¯å¦ä¸º rootï¼Œéœ€è¦é«˜æƒé™ä»¥æ‰§è¡Œ gef-remote --qemu-mode
    user=$(env | grep "^USER" | cut -d "=" -f 2)
    if [ "$user" != "root"  ]
      then
        echo "è¯·ä½¿ç”¨ root æƒé™æ‰§è¡Œ"
        exit
    fi
    # å¤åˆ¶é©±åŠ¨è‡³ rootfs
    cp ./mydrivers/*.ko busybox-1.34.1/_install
    # æ„å»º rootfs
    pushd busybox-1.34.1/_install
    find . | cpio -o --format=newc > ../../rootfs.img
    popd
    # å¯åŠ¨ qemu
    qemu-system-x86_64 \
        -kernel ./arch/x86/boot/bzImage \
        -initrd ./rootfs.img \
        -append "nokaslr" \
        -s  \
        -S&
        # -s ï¼š ç­‰ä»·äº -gdb tcp::1234ï¼Œ æŒ‡å®š qemu çš„è°ƒè¯•é“¾æ¥
        # -S ï¼šæŒ‡å®š qemu å¯åŠ¨åç«‹å³æŒ‚èµ·
        # -nographic                # å…³é—­ QEMU å›¾å½¢ç•Œé¢
        # -append "console=ttyS0"   # å’Œ -nographic ä¸€èµ·ä½¿ç”¨ï¼Œå¯åŠ¨çš„ç•Œé¢å°±å˜æˆäº†å½“å‰ç»ˆç«¯
    gnome-terminal -e 'gdb -x mygdbinit'
gdbinit å†…å®¹å¦‚ä¸‹ï¼š
    set architecture i386:x86-64
    add-symbol-file vmlinux
    gef-remote --qemu-mode localhost:1234
    b start_kernel
    c