{ 项目名称 }
详细设计报告
+---------------------+----------+-------------------------------------+
| 文件状态：          | 文       | Company-Project-SD-MODULE           |
|                     | 件标识： |                                     |
| \[√\] 草稿          |          |                                     |
|                     |          |                                     |
| \[ \] 正式发布      |          |                                     |
|                     |          |                                     |
| \[ \] 正在修改      |          |                                     |
+---------------------+----------+-------------------------------------+
|                     | 当       | X.Y                                 |
|                     | 前版本： |                                     |
+---------------------+----------+-------------------------------------+
|                     | 作 者：  |                                     |
+---------------------+----------+-------------------------------------+
|                     | 完       | Year-Month-Day                      |
|                     | 成日期： |                                     |
+---------------------+----------+-------------------------------------+
版 本 历 史
  ------------- -------- ---------- ------------ --------------------------
  版本/状态     作者     参与者     起止日期     备注
  ------------- -------- ---------- ------------ --------------------------
目 录
0\. 文档介绍 [4](#文档介绍)
0.1 文档目的 [4](#文档目的)
0.2 文档范围 [4](#文档范围)
0.3 读者对象 [4](#读者对象)
0.4 参考文献 [4](#参考文献)
0.5 术语与缩写解释 [4](#术语与缩写解释)
1\. 模块命名规则 [5](#模块命名规则)
2\. 模块汇总 [5](#模块汇总)
2.1 模块汇总表 [5](#模块汇总表)
2.2 模块关系图 [5](#模块关系图)
3\. 子系统A的详细设计 [6](#分布式消息队列的详细设计)
3.n 模块A-n [6](#分布式消息队列模块a-1)
4\. 子系统B的详细设计 [6](#搜索系统的详细设计)
4.n 模块B-n [6](#搜索模块)
5\. 其他 [6](#_Toc16479054)
#  0. 文档介绍
## 0.1 文档目的
此文档对日志分析平台做了全面细致的用户需求分析，明确所要开发的软件应具有的功能、性能，使软件开发人员以及系统分析人员能清楚地了解用户的需求。
## 0.2 文档范围
建
## 0.3 读者对象
建议以下人员阅读本文档：分析人员、项目管理人员、软件测试人员、质量管理人员，以及项目负责人
## 0.4 参考文献
***提示：**列出本文档的所有参考文献（可以是非正式出版物），格式如下：*
*\[标识符\] 作者，文献名称，出版单位（或归属单位），日期*
***例如：***
> ***\[AAA\]** 作者，《立项建议书》，机构名称，日期*
***\[SPP-PROC-SD\]** SEPG，系统设计规范，机构名称，日期*
## 0.5 术语与缩写解释
  ------------------- ---------------------------------------------------
  **缩写、术语**      **解 释**
  SPP                 精简并行过程，Simplified Parallel Process
  SD                  系统设计，System Design
  ...                 
  ------------------- ---------------------------------------------------
# 1. 模块命名规则
***提示：**详细设计人员确定本软件的模块命名规则（例如类、函数、变量等），确保详细设计文档的风格与代码的风格保持一致。可以从机构的编程规范中摘取或引用（如果存在的话）。*
# 2. 模块汇总
## 2.1 模块汇总表
***提示：**这里模块是指相对独立的软件设计单元，例如对象类、函数包等等。*
  ----------------- -----------------------------------------------------
  **采集系统**      
  模块名称          功能简述
  *...*             
  **消息系统**      
  模块名称          功能简述
  ----------------- -----------------------------------------------------
## 2.2 模块关系图
***提示：**参考体系结构设计文档*
# 3. 分布式消息队列的详细设计
## 3.1 分布式消息队列模块A-1
+------------+---------------------------------------------------------+
| 模块名称   | *分布式消息队列*                                        |
+------------+---------------------------------------------------------+
| 功能描述   | *用于消息的持久化和缓存。*                              |
+------------+---------------------------------------------------------+
| 接口与属性 | 1.  **写入数据**                                        |
|            |                                                         |
|            | > **数据类型**                                          |
|            | >                                                       |
|            | > **type {**                                            |
|            | >                                                       |
|            | > **String topic;**                                     |
|            | >                                                       |
|            | > **Byte\[\] value**                                    |
|            | >                                                       |
|            | > **}**                                                 |
|            |                                                         |
|            | 2.  **读取数据**                                        |
|            |                                                         |
|            | > **数据响应：**                                        |
|            | >                                                       |
|            | > **type {**                                            |
|            | >                                                       |
|            | > **String topic**                                      |
|            | >                                                       |
|            | > **Int partition**                                     |
|            | >                                                       |
|            | > **Long offset**                                       |
|            | >                                                       |
|            | > **Byte\[\] value**                                    |
|            | >                                                       |
|            | > **}**                                                 |
+------------+---------------------------------------------------------+
| 数据结构   | 1、架构图                                               |
|            |                                                         |
| 与算法     | ![](media/image1.png){width="4.125in"                   |
|            | height="3.138888888888889in"}*。*                       |
|            |                                                         |
|            | *2、                                                    |
|            | 数据分topic进行存储，不同用途的数据存储在不同的topic下* |
|            |                                                         |
|            | *3、topic下的数据分为多个pa                             |
|            | rtition，可以分布在多个不同的机器上，可以极大提高性能， |
|            | 同一个partition也会存在多个replica，同一partition的不同 |
|            | replica会存放在不同的机器上，以达到容错性和高可用性。*  |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
# 4.数据处理系统的详细设计
## 4.1数据处理模块A-1
+------------+---------------------------------------------------------+
| 模块名称   | *数据处理模块*                                          |
+------------+---------------------------------------------------------+
| 功能描述   | 1.  根据配置的规                                        |
|            | 则抽取数据关键字段，将非结构化的数据转换成结构化数据。  |
|            |                                                         |
|            | 2.  将解析完的数据发送给搜索系统建立索引                |
+------------+---------------------------------------------------------+
| 接口与属性 |                                                         |
+------------+---------------------------------------------------------+
| 数据结构   | 1.  *采用分布式的架构，每台机器处理不同的pa             |
|            | rtition的数据，提高并发的处理能力，当单机出现故障以后， |
| 与算法     | 该机器需要处理的数据将有其他机器接管，并继续进行处理。* |
|            |                                                         |
|            | 2.  *处理以batch为单位，处理成                          |
|            | 功则进行offset的记录，重新启动或者机器失败，会从记录的o |
|            | ffset处重新读取进行处理并发送给搜索系统，因此可能重发已 |
|            | 经发送过的数据。重新发送的数据由搜索系统进行消重处理。* |
|            |                                                         |
|            | 3.  *保证数据不丢失，以及容错的透明性*                  |
|            |                                                         |
|            | > ![](media/image2.png){width="4.627777777777778in"     |
|            | > height="4.051388888888889in"}                         |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
# 4. 搜索系统的详细设计
## 4.1 搜索模块
+------------+---------------------------------------------------------+
| 模块名称   | *搜索模块*                                              |
+------------+---------------------------------------------------------+
| 功能描述   | 1.  *负责对接收到的数据建立索引*                        |
|            |                                                         |
|            | 2.  *对外提供spl形式的搜索能力*                         |
+------------+---------------------------------------------------------+
| 接口与属性 | ***1、submit spl任务***                                 |
|            |                                                         |
|            | > *GET /v1/{token}/{operator}/spl/submit*               |
|            | >                                                       |
|            | > *请求示例：*                                          |
|            | >                                                       |
|            | > *{*                                                   |
|            | >                                                       |
|            | > *\"filter_field\" :                                   |
|            | > \"apache                                              |
|            | .status:\\\"200\\\"\|-\$!\|hostname:\\\"rizhiyi\\\"\",* |
|            | >                                                       |
|            | > *\"queryfilters\" : \"clientip:192.168.\* OR          |
|            | > (logtype:apache AND apache.status:200)\",*            |
|            | >                                                       |
|            | > *\"category\" : \"search\",*                          |
|            | >                                                       |
|            | > *\"task_name\" : \"my_search_search\",*               |
|            | >                                                       |
|            | > *\"time_range\" : \"-10m,now\",*                      |
|            | >                                                       |
|            | > *\"query\" : \"\* \| eval rawlen=len(raw_message) \|  |
|            | > stats avg(rawlen) as arl by hostname \| sort by arl   |
|            | > \",*                                                  |
|            | >                                                       |
|            | > *\"source_group\" : \"all\"*                          |
|            | >                                                       |
|            | > *}*                                                   |
|            | >                                                       |
|            | > *响应示例：*                                          |
|            | >                                                       |
|            | > *{*                                                   |
|            | >                                                       |
|            | > *\"rc\" : 123,*                                       |
|            | >                                                       |
|            | > *\"sid\" :                                            |
|            | > \"xxx941b476f940ade0e22e38bdaab5dfc0a80148\",*        |
|            | >                                                       |
|            | > *\"error\" : \" \"*                                   |
|            | >                                                       |
|            | > *}*                                                   |
|            |                                                         |
|            | ***2、preview任务的结果***                              |
|            |                                                         |
|            | > *GET /v1/{token}/{operator}/spl/preview/{sid}*        |
|            | >                                                       |
|            | > *请求示例：*                                          |
|            | >                                                       |
|            | > *{*                                                   |
|            | >                                                       |
|            | > *\"page\" : 0,*                                       |
|            | >                                                       |
|            | > *\"size\" : 10*                                       |
|            | >                                                       |
|            | > *}*                                                   |
|            | >                                                       |
|            | > *响应示例：*                                          |
|            | >                                                       |
|            | > *{*                                                   |
|            | >                                                       |
|            | > *\"rc\" : 131,*                                       |
|            | >                                                       |
|            | > *\"result\" : {*                                      |
|            | >                                                       |
|            | > *\"timeline\" : {*                                    |
|            | >                                                       |
|            | > *\"interval\" : 21600000,*                            |
|            | >                                                       |
|            | > *\"start_ts\" : 1474065741554,*                       |
|            | >                                                       |
|            | > *\"end_ts\" : 1475152141554,*                         |
|            | >                                                       |
|            | > *\"rows\" : \[ {*                                     |
|            | >                                                       |
|            | > *\"start_ts\" : 1474065741554,*                       |
|            | >                                                       |
|            | > *\"end_ts\" : 1474084800000,*                         |
|            | >                                                       |
|            | > *\"count\" : 0*                                       |
|            | >                                                       |
|            | > *} \]*                                                |
|            | >                                                       |
|            | > *},*                                                  |
|            | >                                                       |
|            | > *\"fields\" : \[ {*                                   |
|            | >                                                       |
|            | > *\"name\" : \"agent_send_timestamp\",*                |
|            | >                                                       |
|            | > *\"type\" : \"string\",*                              |
|            | >                                                       |
|            | > *\"total\" : 2134233*                                 |
|            | >                                                       |
|            | > *} \],*                                               |
|            | >                                                       |
|            | > *\"sheets\" : {*                                      |
|            | >                                                       |
|            | > *\"total\" : 1000,*                                   |
|            | >                                                       |
|            | > *\"\_field_infos\_\" : \"\[\]\",*                     |
|            | >                                                       |
|            | > *\"version\" : 1,*                                    |
|            | >                                                       |
|            | > *\"rows\" : \[ {*                                     |
|            | >                                                       |
|            | > *\"hostname\" : \"192.168.1.26\",*                    |
|            | >                                                       |
|            | > *\"logtype\" : \"apache\",*                           |
|            | >                                                       |
|            | > *\"timestamp\" : 1474191233896,*                      |
|            | >                                                       |