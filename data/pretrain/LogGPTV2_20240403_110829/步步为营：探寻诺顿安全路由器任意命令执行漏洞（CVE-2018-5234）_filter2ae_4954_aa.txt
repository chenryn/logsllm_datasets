# 步步为营：探寻诺顿安全路由器任意命令执行漏洞（CVE-2018-5234）
|
##### 译文声明
本文是翻译文章，文章来源：https://embedi.com/
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
> 最近，有关黑客入侵物联网的设备不断在媒体中出现，同时关于物联网设备安全性的话题也不断被引出。近期，Trustwave发布了他们的报告（
>  Disparity-Between-IoT-Adoption-and-Cybersecurity-Readiness/>
> ），报告中指出，使用物联网设备的企业数量正在增长，因此设备所存在的安全性问题产生的潜在影响也越来越大。另外，卡巴斯基实验室也发布了一份关于新型APT的报告，他们将其称为Slingshot（
>  content/uploads/sites/43/2018/03/09133534/The-Slingshot-> APT_report_ENG_final.pdf>
> ），犯罪嫌疑人可能会以路由器作为目标，将其感染后再利用路由器连接到网络上的其他计算机，发起进一步的攻击。
## 一、基本介绍
在目前的环境之下，相当一部分公司（甚至是防病毒软件生产商）都相继开发并推广物联网设备的硬件安全解决方案。Embedi的研究人员已经对其中一部分进行了安全检查，从而向广大用户提供这些设备存在的安全缺陷和最新信息。此前，我们已经对Bitdefender
BOX进行了全面的分析（ 
）。由于这一网络安全领域是开发者的最新趋势，所以我们决定继续进行研究，希望这些“网络监护人”产品能够更有效地执行其功能，并能够保护物联网设备和其自身。  
在本篇文章中，我们详细分析了Symantec的Norton Core Secure WiFi
Router（诺顿核心安全无线路由器）。我们将挖掘该产品中的漏洞，并描述它目前存在的安全缺陷。尽管该产品存在一些漏洞，但作为一篇客观的文章，我们还会谈论赛门铁克在物联网安全领域的成功之处以及他们已经推向市场的设备的强大之处。
## 二、设备描述
该设备是一款高性能安全双频WiFi路由器，配备了双核CPU和扩展内存。根据官方说明，与普通的WiFi路由器相比，该产品能够支持高速广播Internet连接。诺顿核心安全无线路由器的主要亮点在于，它还可以保护连接到网络之中的物联网设备的安全。  
与其他设备相比，该设备具有较多的优势，它还支持各种其他功能（部分功能需要订阅）：  
1、内置防火墙；  
2、防范病毒数据挖掘、恶意软件和其他网络威胁；  
3、对身份信息和转账交易的保护；  
4、全面的家长控制（包括时间限制、内容过滤、禁止网络中特定设备访问互联网）；  
5、网络级安全（DPI、IDS、IPS、安全DNS、加密用户连接）；  
6、设备远程配置（通过智能手机APP）；  
7、安全评分；  
8、自动检测连接的设备。  
该设备在宣传中声称，只要激活订阅功能，就不再需要使用其他的防病毒软件。根据官方提供的信息，该设备仅在美国销售并运营。  
## 三、设备行为
如果启用了Internet访问和蓝牙功能（支持蓝牙低功耗），设备的初始设置就可以通过相应的智能手机应用程序（iOS、Android）进行。在此过程中，可以配置WAN接口，并进行设备的固件更新（如果需要）。随后，路由器会在云中被识别并分配给特定用户（智能手机应用程序中授权的用户）。随后，只要用户连接到互联网，设置程序就可以在应用程序中远程执行。路由器将依次同步其配置中的更改。因此，由于该设备可以远程管理，所以用户与路由器之间的交互达到了最小化。  
同时，该设备还具有流量分析系统。该系统包含各种插件，其中一些插件将发送检查信息到云上（例如Mobile
Insight）。因此，如果路由器上没有互联网接入，就无法对设备的配置进行修改（甚至是更改WiFi网络密码）。此外，一些对于防止网络中的恶意设备至关重要的安全相关子系统将被禁用。  
如果用户访问了恶意网站或禁止访问的网站，网页会被更改为与威胁类型相关的信息页面。例如“包含成人内容的网站已被阻止”或者“当前的互联网访问受到限制”。这也意味着，要有一台WEB服务器在路由器上运行。  
路由器还配备了持续固件更新系统LiveUpdate。在设备每次启动时都会进行固件更新检查，此外在设备使用期间，也会定期检查固件更新。
## 四、访问文件系统
如果要进行详细的系统分析，就需要访问存储在设备内部存储器中的文件。我们有几种方法可以实现，让我们首先从最简单的开始。
###  4.1 通过UART
我们要尝试的第一种方法是连接到UART（如下图）。理论上，我们通过连接，可以获得对文件系统的访问权限（可能是非特权的访问权限）。  
正如预期的那样，在设备的加载期间，显示了关于U-Boot和Linux内核加载状态的信息。根据日志显示的内容，3个串行接口已经初始化完成，应该是两个常规接口和一个高速BLE接口。其中一个应该通过UART授予对系统的完整I/O访问权限：
    ...
    [    0.000000] Kernel command line: console=ttyMSM0,115200n8 root=/dev/mmcblk0p10 rootwait
    ...
    [    1.242535] msm_serial_hsl_probe: detected port #0 (ttyMSM0)
    [    1.242734] 16340000.serial: ttyMSM0 at MMIO 0x16340000 (irq = 184, base_baud = 115200) is a MSM
    [    1.242872] msm_hsl_console_setup: console setup on port #0
    [    1.934480] console [ttyMSM0] enabled
    [    1.938436] msm_serial_hsl_probe: detected port #1 (ttyMSM1)
    [    1.943913] 16540000.serial: ttyMSM1 at MMIO 0x16540000 (irq = 188, base_baud = 115200) is a MSM
    [    1.952800] msm_serial_hsl_init: driver initialized
    [    1.958433] 16640000.hs_uart: ttyHS0 at MMIO 0x16640000 (irq = 190, base_baud = 460800) is a MSM HS UART
    ...
在系统初始化后，我们就无法进入了，因为Shell输出默认被禁用。因此，getty就不能完成其工作，也就无法访问文件系统。但是，我们还是通过这种方法看到了路由器的加载状态。
###  4.2 获取固件
第二种方法是通过从设备的固件中提取文件，来获取存储在内部存储器中的文件。通常，我们可以从开发者的官方网站下载固件，也可以从安装了应用程序的智能手机中获取固件。另一种选择是，还可以在设备尝试从Internet获取更新时拦截通信。  
我们最一开始尝试在Symantec
Norton网站上寻找资源，也尝试了从智能手机和应用程序中寻找，但均以失败告终。最后，我们决定在固件更新期间尝试对其进行截获。我们已经知道，LiveUpdate系统会在设备上运行，并且路由器在初始设置阶段会进行更新的检查。
    NB: Another reason to prevent the router from updating its firmware by
    restricting its access to the Internet was that it limits our chances on
    taking hold of the device and getting full access to the system, which
    is indispensable for detecting vulnerabilities. So, at this stage of
    our research, we analyzed the router with only a limited set of its
    functions initialized. The out-of-scope functions, however, might
    contain vulnerabilities of their own.
为了在更新过程中获得固件，我们通过代理服务器将设备连接到互联网。我们使用一台Linux系统的计算机作为代理服务器，NAT使用iptables设置，以便设备可以通过代理服务器的DHCP获得IP地址：
    $ iptables -t nat -A POSTROUTING -o internet0 -j MASQUERADE
    $ iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    $ iptables -A FORWARD -i net0 -o internet0 -j ACCEPT
    $ iptables -I INPUT -p udp --dport 67 -i net0 -j ACCEPT
通过使用WireShark对通信进行分析，我们发现其DNS是199.85.126.15和199.85.127.15。  
获取固件的整个过程没有采用任何形式的加密。其算法如下：  
1、通过上述DNS获取liveupdate.symantecliveupdate.com的地址；  
2、向包含0x20的minitri.flg文件发出GET请求，该文件作为是否能够进行更新的有效指示：
    $ curl -H "Host: liveupdate.symantecliveupdate.com" -X GET "152.195.132.156//minitri.flg"