• Scanrand
– High speed port scanner / route tracer
– Stateless design, embeds cookie in SYN reflected in 
SYN|ACK or RST|ACK
• Sender and receiver don‟t need to be the same host
– Able to analyze ICMP replies to determine original IP/L4 
source
• ICMP errors clone entire IP packet (including options), first eight 
bytes of TCP/UDP/ICMP/etc
– Able to use TTL to estimate how far a packet needed 
• Useful for network graph generation, DDoS tracing, etc
– Very useful for peer-to-peer / grid computing designs
• Often shows results of network level trickery
– Third parties can‟t easily know appropriate initial TTL to use, so their 
packets stand out vs. legitimate traffic
Copyright© 2003 Avaya Inc. All rights reserved
13
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Scanrand Returns #1:
Email Hijacking
root@arachnadox:~/new_talk# scanrand local.doxpara.com
UP: 64.81.64.164:80 [19] 0.092s
UP: 64.81.64.164:25 [04] 0.095s
UP: 64.81.64.164:443 [19] 0.099s
UP: 64.81.64.164:22 [19] 0.106s
UP: 64.81.64.164:993 [19] 0.121s 
root@arachnadox:~# telnet www.microsoft.com 25
Trying 207.46.134.155...
Connected to microsoft.com. Escape character is '^]'.
220 ArGoSoft Mail Server Pro for WinNT/2000/XP, Version 1.8 (1.8.2.9) 
Copyright© 2003 Avaya Inc. All rights reserved
14
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Scanrand Returns #2:
Hopcount Desync 
root@arachnadox:~# scanrand -b1k -e local.doxpara.com:80,21,443,465,139,8000,31337
UP:     64.81.64.164:80    [11]   0.477s
DOWN:     64.81.64.164:21    [12]   0.478s
UP:     64.81.64.164:443   [11]   0.478s
DOWN:     64.81.64.164:465   [12]   0.478s
DOWN:     64.81.64.164:139   [22]   0.488s
DOWN:     64.81.64.164:8000  [22]   0.570s
DOWN:     64.81.64.164:31337 [22]   0.636s
What’s going on:
The host is genuinely 11 or 12 hops away.  All of the up ports reflect that, but only a few of 
the downed ports.  The rest are showing double the remote distance.  This is due to the a 
PIX firewall interspersed between myself and the target.  It’s (too) quickly reflecting the 
SYN I sent to it right back to me as a RST|ACK, without resetting values like the TTL.  
Thus, the same source value decrements twice across the network – 22 = 11*2 – and we 
can detect the filter.
Copyright© 2003 Avaya Inc. All rights reserved
15
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Scanrand Returns #3:
Serverless NAT Identification
root@arachnadox:~# scanrand -l1-3 www.doxpara.com
001 =       172.16.0.1|80    [01]   0.024s(     172.16.1.97 -> 209.81.42.254   )
002 =     216.137.24.1|80    [01]   0.030s(  216.137.24.246 -> 209.81.42.254   )
003 =    216.137.10.45|80    [03]   0.100s(  216.137.24.246 -> 209.81.42.254   ) 
root@arachnadox:~/new_talk# scanrand -l2 -vv www.doxpara.com 
Stat|=====IP_Address==|Port=|Hops|==Time==|=============Details============| 
SENT: 209.81.42.254:80 [00] 0.000s Sent 40 on eth0:
IP: i=172.16.1.97->209.81.42.254 v=4 hl=5 s=0 id=2 o=64 ttl=2 pay=20
TCP: p=193->80, s/a=3012956787 -> 0 o=5 f=2 w=4096 u=0 optl=0
Got 70 on eth0:
IP: i=216.137.24.1->172.16.1.97 v=4 hl=5 s=0 id=35273 o=0 ttl=127 pay=36
ICMP: IP: i=216.137.24.246->209.81.42.254 v=4 hl=5 s=0 id=2 o=64 ttl=1 pay=20 ICMP: TCP: p=193->80, 
s/a=3012956787
002 = 216.137.24.1|80 [01] 0.049s( 216.137.24.246 -> 209.81.42.254 ) 
Copyright© 2003 Avaya Inc. All rights reserved
16
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Multihomed Node Detection
• Is it possible to detect clients that are directly connected 
both to the internal, firewalled LAN and the outside world?
• Yes – use scanrand in Split Mode:
Fake a scan from the outside world, then pick up replies 
that don‟t get stopped by the firewall
– Internal network is flooded with requests spoofed from 
external network
– Nodes receive request, check routing tables to see 
where to send replies
• Replies routed through firewall are dropped (we assume)
• Replies routed through unprotected link will leak out (w/ IP)
Copyright© 2003 Avaya Inc. All rights reserved
17
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Multihomed Node Detection #2:
The NAT Case
• Is it possible to detect clients that are indirectly connected, through a 
NAT, both to the internal, firewalled LAN and the outside world?
• Yes – but different requests may need to be used
– Standard TCP SYNs will elicit SYN|ACKs or RST|ACKs 
that don‟t match up with anything in the NAT State Table
• ICMP Pings (which can reflect an almost arbitrary amount of data) 
may also have state table issues
– “UDP Ping” is necessary
• UDP is symmetric in and out (request and response are 
indistinguishable on the wire)
– UDP/137 (SMB) may work – though is firewalled by certain DSL 
Providers
– UDP/161 (SNMP) would work, but doesn‟t exist on most clients
• NAT is less worrisome – no incoming access by default
– Spoofing internal packet from external IP detects DMZ
Copyright© 2003 Avaya Inc. All rights reserved
18
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
The State of State
• Scanrand is able to acquire a massive amount of data without 
keeping track of anything…or is it?
– State is maintained through stdout – logs are dumped, 
the reader integrates all the information visually
• “…it is left as an exercise to the reader”
– Stdout works because all information dumped on each 
line can be extracted from each single packet as it 
arrives
• “A response doesn‟t just contain „yes this port is up‟, but „yes, 
1.2.3.4, the IP address 4.5.6.7 is listening on port 8910, please 
inform the socket you‟ve bound to port 555 that this is the case.‟”
– But packets do not exist in isolation…
Copyright© 2003 Avaya Inc. All rights reserved
19
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
“Hidden Bits Between The Packets”
• TCP Repairs Broken Connections
– If a packet is dropped, it will retry
– “Hello?  …  Hellllo?  … … … Hello?”  
• How many Hellos?  How long inbetween them?
– It varies from person to person, and from TCP/IP stack to TCP/IP 
stack
• Discovered by Franck Veysset et al, demo‟d with RING
• Can we do this with Scanrand?
– Scanrand uses the kernel to RST incoming replies, so 
they stop coming
• Usually this is good – cut off the flood
• Well now we want the flood…but we don‟t want to interface with 
some firewall rules.
• Solution:  Use a different IP.  But have the kernel serve the MAC!
Copyright© 2003 Avaya Inc. All rights reserved
20
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Temporal Fingerprinting with Scanrand 1.x
root@bsd:~# arp -s 10.0.1.190 00:e0:18:02:91:9f pub
root@bsd:~# arp -an | grep 10.0.1.190
? (10.0.1.190) at 0:e0:18:2:91:9f permanent published [ethernet]
root@bsd:~# scanrand -i 10.0.1.190 -t0 -b100k 10.0.1.1-254:139
(OUTPUT SORTED)
UP:        10.0.1.12:139   [01]   0.235s
UP:        10.0.1.12:139   [01]   3.191s
UP:        10.0.1.12:139   [01]   9.109s
(+3+6)   # Windows
UP:        10.0.1.36:139   [01]   0.715s
UP:        10.0.1.36:139   [01]   3.624s
UP:        10.0.1.36:139   [01]   9.639s
(+3+6)   # Windows
UP:        10.0.1.38:139   [01]   0.755s
UP:        10.0.1.38:139   [01]   4.560s
UP:        10.0.1.38:139   [01]  10.560s
UP:        10.0.1.38:139   [01]  22.758s
UP:        10.0.1.38:139   [01]  46.756s
(+4+6+12+24)  # Linux
What’s significant to realize is that no individual packet is special, but the timing of each leaks the operating 
system of all.  No zero-latency scrubber can hide this fact (this impacts NAT detection, since 
each individual TCP session can be independently fingerprinted.)
Copyright© 2003 Avaya Inc. All rights reserved
21
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
State Reconstruction Theory
• Is it possible to extract deep information from hosts without losing the 
raw speed of a stateless network scan?
• Yes – by introducing a database to collate scan results
– Slow model: Scan a host, compile results, print 
out…scan another host, compile results, print out…
– Fast model:  Scan all hosts, enter all results into a 
dedicated state management engine (better known as a 
database), compile results, do a secondary and smaller
scan if necessary, recompile results
• Split Mode Redux:  Sender and receiver processes are built with 
wildly different philosophies
• Sender optimized for speed and deployability, receiver optimized 
for comprehensive reports
– Receiver technically still stateless – dumping SQL for a DB engine 
instead of fprintf-formatted rows of text
Copyright© 2003 Avaya Inc. All rights reserved
22
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
State Reconstruction HOWTO
• Why DB?  Because the world doesn‟t need another homegrown 
hash table
• Which DB?  MySQL, PostgreSQL, Oracle, SQLite, SAP, Informix…
– So many API‟s for scanrand to potentially support…or 
not?
– We‟ve been using stdout already…why not simply output 
raw SQL?