告警联系人设置和告警方式设置等。
图6-1
实时记录告警事件、形成分析图表
统一用户管理、集中监控、集中维护
定时采集数据到监控报警模块
告警策略设置、告警阀值设置
数据生成曲线图直观显示
主要收集网络数据、业务系统数据、
，又分为3个模块，
智能运维监控平台设计架构
是一个Web 展示界面，
统
主要是根据第3层获取到的数据进行告警规则设
监控告警、性能优化与实战例
，分别是数据收集模块、
多权限管理，
主要是将监控统计结果、
实现统一用户和统
数据收集模块
监控告警模块
数据库数据、操
、数据提取模
---
## Page 232
面的一款综合运维监控平台。
6.1.3企业运维监控平台选型策略
通过插件或者自定义脚本来扩展告警方式。这样一整套监控告警平台就基本实现了。
联系人等，最终实现实时告警。告警方式支持手机短信告警、邮件告警等，另外，也可以
告警模块通过数据抽取模块从数据收集服务器获取需要的数据，然后设置告警阈值、告警
群组收集各种数据指标，经过规范数据格式，最终将数据存储到数据收集服务器中；监控
收集模块可以有一台或多台数据收集服务器组成，每个数据收集服务器可以直接从服务器
警模块和数据提取模块。其中，数据提取模块用于其他两个模块之间的数据通信；而数据
个智能运维监控系统。
Zabbix学习入门较快，功能也很强大，是一个可以迅速上手的监控软件，能够满足中小
Zabbix是一款综合了数据收集、
1．中小企业监控平台选择Zabbix
从图中可以看出，运维监控平台主要有三大部分组成，分别是数据收集模块、监控告
根据上述设计思路形成的一
在了解了运维监控平台的一
具有Nagios、Centreon等。
告警联系人设置等，并将告警结果进行集中展现和历史记录。常见的监控告警工
监控告警模块：此模块主要完成监控脚本的设置、告警规则设置，告警阈值设置、
实现数据的提取。
集模块提取到监控告警模块中。可以通过数据收集模块提供的接口或自定义脚本
数据提取模块：此模板主要完成数据的筛选过滤和采集，将需要的数据从数据收
数据收集服务器
数据收集模块
服务器集群
.....
图6-2运维监控平台实现拓扑
一个运维监控平台实现拓扑图如图6-2所示。
一般设计思路之后，接下来详细介绍如何通过软件实现这样
、数据展示、数据提取、监控告警配置和用户展示等方
数据提取模块
运维监控利器Zabbix
监控告警模块
智能告警
O
监按告警
邮件
第6章
---
## Page 233
222
对监控平台做了以下工作。
告警，发现问题并避免同样的问题再次发生。根据这个阶段的特点，笔者在这个时期主要
问题也很容易解决。
Ganglia等。流行的开源产品文档很多，可快速上手，并且有大量的前人使用经验，遇到
问题、快速定位与解决问题。此阶段监控平台的特点如下所述。
平台需要的构建思路和策略。
6.1.4
进行监控推荐 Ganglia+Centreon 组合。
据展示、数据提取、监控告警配置、用户展示等方面的完美配合。因此这里对海量服务器
对于有海量服务器、多业务系统的复杂监控，没有哪个软件能独立完成企业的所有监控需
也是单点，可能还需要对Zabbix server做HA保证数据的安全和监控的高可用。
控性能急剧下降，此时需要进行分布式监控部署，并且需要提升监控服务器的性能。
时等问题。这是因为Zabbix对服务器性能要求较高，当监控的服务器数量超过500台后，监
企业（服务器数500台一下）的监控告警需求，因此是中小型企业运维监控的首选平台。
求
高性能Linux服务器运维实战：shell编程、监控告警、性能优化与实战案例
便
但是，Zabbix当监控服务器数量较多时，会产生很多问题，如监控数据不准确、告警超
，监控扩展也非常容易，结合专业的Web监控平台Centreon，可以实现在数据收集、数
，因此，多种开源监控软件组合应用+二次开发才是监控平台的最终方向。
安全性方面，Zabbix客户端的 agent 如果故障，收集到的数据将丢失，同时Zabbix server
由于要监控的机器很多，监控内容也随之增多，于是笔者将监控根据用途不同进行了分
（1）监控内容分类
这个阶段，由于机器数量变多，监控需求也开始变得复杂，不过主要还是用于通知、
2.机器数量200~1000的阶段
切换到了Zabbix上了，此阶段，Zabbix应该是最好的选择。
最初笔者选择了Nagios，因为这款软件是最早流行的，后来因为主机和服务添加不方
基于以上特点和需求，可以使用比较流行的开源监控软件 Nagios、Cacti、Zabbix 和
这个时期由于机器数量较少，对监控的需求也很简单，监控的用途可能主要用于通知
推荐Ganglia是因为Ganglia客户端软件对服务资源占用非常低，并且扩展插件非常
开源监控软件组合应用+二次开发是大型互联网企业构建监控平台的一个基本策略。
2.互联网大企业监控平台选择Ganglia+Centreon
下面结合这么多年笔者所用监控平台的演变，总结了不同阶段、不同机器数量，监控
V
。机器数量小于100台的阶段
可进行告警，以邮件、短信等形式。
部署简单，上手易用。
运维监控平台演变历程
稳定运行，不出故障。
---
## Page 234
备用监控系统上，并且监控数据自动保存同步。
单点故障。同时对监控到的数据进行远程异地备份，
等系统恢复启动起来，已经是1h以后了，这1h运维就变成了睁眼瞎了，多可怕的事情。
正常了。
数据的负载进行分担，大大减低了Zabbix的负载，数据收集的准确性、及时性又恢复
而采用Ganglia来实现，而对业务数据部分的实现仍然采用 Zabbix 完成。通过将收集
Zabbix主动模式，还对数据收集进行了扩展和优化。对基础数据的收集，抛弃了Zabbix
性是监控系统的第一要求，这个是必须要解决的问题。
然监控到了异常，但是通过监控系统发出来已经是1h之后了，那监控还有什么意义呢。及时
告警迟迟不来。特别是告警延时，这个是最恐怖的事情。线上业务7×24h不能出现故障，
况发生了变化，或者说监控出现了很多奇怪的问题，如下所述。
任何告警信息了。
作。通过对告警策略的优化，告警信息大大减少，每天最多几十封邮件，这样就不会错过
例如，对系统负载的监控，可以选择连续几次负载超过值，持续多久之后才进行告警操
非必要的告警，例如，系统负载偶尔增高一下，就发了告警邮件，这完全是不需要的。
其实就失去了告警的意义，因为笔者不可能去查看每一封邮件。众多告警邮件中，很多都是
告警信息就出现了爆发式增长，每天收到上千封告警邮件是经常的事情。过多的邮件出现，
的业务采用持续通知的方式，不处理就一直通知。
级别的方式进行通知。每个监控对应到不同的人，确保每个监控都有人处理，并且对于重要
尽可能的覆盖业务流程，通过大量自定义监控减少和去除重复的问题，保障业务稳定运行
性能和故障；软件监控除了第1步提到的各种基础监控数据外，还增加了业务逻辑监控，
类，
自从发生监控系统岩机事故后，笔者对监控服务器进行了分布式高可用部署，以避免
如何解决这个问题呢？除了对监控进行优化，例如，分布式proxy方式部署，开启
因此，这个阶段主要是对监控告警策略进行配置和优化，尽量减少不必要的告警邮件
（2）告警系统出现了单点故障
这个阶段的难点是对告警信息的处理，由于机器越来越多，需要监控的服务也越来越多
由于服务器众多，收集的数据也飞速增长，曾经有一次，监控服务器突然意外宕机了
当服务器超过1000台以后，Zabbix就经常罢工，有时候监控数据不能及时显示，有时候
由于业务持续增长，对服务器需求越来越多，当服务器超过1000台以后，监控的情
3.机器数量超过1000台的阶段
将所有监控根据重要程度、紧急程度进行分类，分别用邮件、微信、短信和电话等不同
（3）多种告警方式，确保无漏报
将所有机器均纳入监控中，主要包含软件监控和硬件监控。硬件监控主要是监控硬件
主要分为系统基础监控数据、网络监控数据和业务监控数据。
（1）告警不及时
（2）全覆盖式监控
，当监控服务器故障后，会自动切换到
运维监控利器Zabbix第6章
223
---
## Page 235
224
控管理平台。
数据可视化功能。这些功能和特性使运维人员可以非常轻松地搭建一套功能强大的运维监
过Zabbix提供的Web界面进行配置和操作，基于Web的前端页面还提供了出色的报告和
略，可以为任何事件配置基于邮件、短信、微信等告警机制。而这所有的一切，都可以通
网络的稳定性以及各种应用系统的可靠性。当监控出现异常时，Zabbix通过灵活的告警策
6.2.1Zabbix运行架构
少需求，万变不离其宗，有了机器上的各种监控数据，运维就能做很多事情。
平台，每个公司的需求不一样，每个运维面对的痛点也不尽相同，但不管有什么需求，多
Zabbix进行了多项二次开发，以满足对业务逻辑的监控。
代码，只能根据业务逻辑自行开发。通过提高业务逻辑接口、汇报数据等方式，笔者对
务运行逻辑故障时候，也需要进行告警。很显然，对业务逻辑的监控，没有现成的工具和
业务逻辑监控需求被提出来了。业务逻辑监控就是对业务系统的运行逻辑进行监控，当业
高性能Linux服务器运维实战：shell编程、监控告警、性能优化与实战案例
6.2
Zabbix是一个企业级的分布式开源监控解决方案。它能够监控各种服务器的健康性、
最后，运维监控平台是运维工作中不可或缺的一部分。如何构建适合自己的运维监控
Zabbix的运行架构如图6-3所示。
随着业务的增加，客户对业务稳定性要求变得更加苛刻，为了保证业务系统稳定运行
（3）告警需求监控系统无法满足
Zabbix agent
Zabbix运维监控平台部署过程
Zabbix agent
主机N
Zabbix_sender
Zabbixproxy
图6-3Zabbix运行架构图
主机4
Zabbix运行架构图
Zabbix_get
Zabbix server
主机1
Zabbix Database Storage
主机3
Nginx/PHP
Zabbix Web UI
主机2
---
## Page 236
Zabbix server，可以在很大程度上减轻Zabbix server的压力和负载。
时比较长的检查或者有大量主机（千台以上）需要监控的场景。此时通过主动推送数据到
proxy。这其实是 Zabbix agent 端主动推送监控数据到 Zabbix server 端的过程，通常用于耗
以使用 zabbix_get命令测试获取客户端数据来做故障排查。
工具主要用来进行用户排错。例如，在Zabbix server 端获取不到客户端的监控数据时，
CPU负载、内存、硬盘、
功能，需要另外安装。下面分别介绍它们各自的作用。
数据发往Zabbix server 端或 Zabbix proxy 端。
替 Zabbix server 收集性能和可用性数据，汇总后统一发往Zabbix server 端。
在同一台物理机器上。
被存储在数据库中。常用的存储设备有MySQL、Oracle、SQLite等。
数据均由其组织进行。
储器。它主要负责接收客户端发送的报告和信息，同时，所有配置、统计数据及配置操作
zabbix_sender也是Zabbix提供的一个工具，用于发送数据给Zabbix server或者Zabbix
(3）zabbix_sender
zabbix_get 是Zabbix 提供的一个工具，通常在 Zabbix server或者 Zabbix proxy端执行，
zabbix_agentd是Zabbix agent 监控代理端守护进程，此进程收集客户端数据，例如，
(1） zabbix_agentd
根据功能和用途，默认情况下Zabbix包含5个进程，分别是zabbix_agentd、zabbix_get、
Zabbix agent 部署在被监控主机上，
（5）Zabbix agent 监控代理
Zabbix proxy代理服务器是一个可选组件，常用于分布监控环境中，代理 server可以
（4）Zabbixproxy代理服务器
Zabbix Web 界面是Zabbix 提供的 GUI接口，通常（但不一定）与Zabbix server 运行
（3）ZabbixWeb界面
ZabbixDatabaseStorage主要用于存储数据，
(2）Zabbix Database Storage
Zabbix server是Zabbix的核心组件，是所有配置信息、统计信息和操作数据的核心存
(2）zabbix_get
(1）Zabbix server
从图中可以看，Zabbix主要有几个组件构成，
1.Zabbix组件构成
Zabbix服务进程
、网络使用情况等。
，能够主动监控本地资源和应用程序，并负责收集
所有配置信息和Zabbix收集到的数据都
分别介绍如下。
运维监控利器Zabbix
第6章
225
此
---
## Page 237
执行的频率等。
数据低于阈值时，
范围内。如果接收的数据大于阈值时，
是 Zabbix 进行数据收集的核心，相对某个监控对象，每个 item 都由 key 来标识。
何直接的关联。主机组通常在给用户或用户组指派监控权限时使用。
同
来统一进行处理。
zabbix_sender、zabbix_proxy、zabbix_java_gateway 的数据最终都是提交到 Zabbix server
226
ZabbixServer或者ZabbixProxy上。
送数据，而不能等待Zabbix Server或者ZabbixProxy来拉取数据。它的数据最终会给到
用来监控Java应用环境，
是它只是一个中转站，它需要把收集到的数据提交或者被提交到Zabbix server上。
高性能Linux服务器运维实战：shell编程、监控告警、性能优化与实战紊例
3.Zabbix监控术语
zabbix_java_gateway是Zabbix2.0之后引入的一个功能。顾名思义：Java网关，主要
(5） zabbix_java_gateway
zabbix_proxy 是 Zabbix proxy 的代理守护进程。功能类似 Zabbix server，唯一不同的
模板是一组可以被应用到一个或多个主机上的实体集合。
告警媒介类型表示发送通知的手段，告警通知的途径，如Email、Jabber或者 SMS等。
（7）告警媒介类型（media）
动作指对于监控中出现的问题事先定义的处理方法，例如，发送通知、何时执行操作、
（5）应用集（Applications）
触发器其实就是一个监控阈值表达式，用于评估某监控对象接收到的数据是否在合理
（4）触发器（trigger）
监控项表示一个监控的具体对象，例如，监控服务器的CPU负载、磁盘空间等。item
（3）监控项（item）
主机组是主机的逻辑组。它包含主机和模板，但同一个主机组内的主机和模板没有任
（2）主机组（host group）
但含义相同，这里进行简单介绍。
在 Zabbix 监控系统中，有一些常用的术语，这些术语可能和其他监控系统的叫法不
zabbix server 是整个Zabbix系统的核心进程。其他进程 zabbix_agentd、zabbix_get、
(6）zabbix_server
（4）zabbix_proxy
（8）模板（template）
（6）动作（action）
应用集是一组监控项组成的逻辑集合。
主机表示要监控的一台服务器或者网络设备，可以通过IP或主机名指定。
（1）主机（host）
又转变为OK状态。
类似 zabbix_agentd 进程。需要特别注意的是，它只能主动去推
触发器状态将从OK转变为Problem：当接收到的
一个模板通常包含了应用
---
## Page 238
源码，这里下载的是OpenSSL-1.0.2n版本，安装过程如下：
ZabbixWeb以及ZabbixDatabases安装到同一台服务器172.16.213.235主机上。
需要InnoDB引擎。
等，这里选择MySQL数据库作为后端存储。Zabbix要求MySQL5.0.3或以上版本，同时
GD要求2.0或以上版本，LibXML要求2.6.15或以上版本。
Apachel.3.12或以上版本，PHP5.4.0或以上版本，同时对PHP扩展包也有要求，例如，
这里推荐大家用源码方式安装Zabbix server，而通过RPM包方式安装Zabbix agent。