localport=3389 action=allow`
**16.查看代理配置情况**
查看IE代理配置
`reg query
"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet
Settings"` (我个人觉得没啥用)
**17.查询并开启远程连接服务**
(1)查看远程连接端口
`reg query HKLM\SYSTEM\CurrentControlSet\Control\Terminal"
"Server\WinStations\RDP-Tcp /v PortNumber`
> HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal
> Server\WinStations\RDP-Tcp  
>  PortNumber REG_DWORD 0xd3d
>
> 十六机制:0xd3d->十进制:3389
(2)在windows Server 2003 开启3389端口
`wmic /namespace:\\root\CIMV2\TerminalServices PATH
Win32_TerminalServiceSetting WHERE (__CLASS !="") CALL SetAllowTSConnections
1`
(3)在Window Server 2008 和 Windows Server2012 开启3389端口
`REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v
fDenyTSConnections /t REG_DWORD /d 0 /f`
### 0x2.2 单机自动化收集
书本介绍了wmic和Empire,我个人看了下感觉不是很好用。
`Ladon GetInfo Ladon GetInfo2`
可以考虑用下工具,自带了图形化插件,比较方便,支持的功能也很多。[Ladon](https://github.com/k8gege/Ladon)
不过我感觉这种集成化的信息收集其实作用不是很好，1.比较容易触发流量的报警 2.不可控的未知操作也有可能导致留下痕迹 3.收集时间消耗成本比较高
4.不能完全保证信息的准确性。
好处也显而易见就是方便。
综合来说,我个人建议将这个只是作为备选方案。
## 0x3 侦查域环境
### 0x3.1 判断是否存在域环境
**1.使用ipconfig命令**
`ipconfig /all`
> DNS Suffix Search List. . . . . . : poxpl.xxx
>
> Default Gateway . . . . . . . . . : 192.168.1.1
>
> DNS Servers . . . . . . . . . . . : 192.168.1.35
>
> ​ 4.2.2.2  
>  ​ 8.8.8.8
然后通过执行 `nslookup domain` 进行反向解析，确定DNS服务器的ip地址
> Server: pohxerver.poxpl.com  
>  Address: 192.168.1.35
>
> Name: poxpl.com  
>  Addresses: 192.168.1.35  
>  192.168.1.36
一般默认没有域的网关ip会和dnsip一致,同时dns的名字为localdomain之类的,不会跟域名一样。
**2.systeminfo**
> Domain: poxpl.xxx
Domain(域)如果为workgroup 则代表不存在域,否则存在`poxpl.xxx`域环境
**3.查询当前登录域及登录用户信息**
`net config workstation`
> Software version Windows Server 2012 R2 Standard
>
> Workstation domain POxPL  
>  Workstation Domain DNS Name poxpl.xxx  
>  Logon domain poxpl
其中如果Workstation domain (工作站域)如果为workgroup则代表不存在域环境，否则说明存在POxPL域
其中Logon domain(登录域) 表名当前登录的用户是域用户
**4.判断主域**
    net time /domain:指定查询指定域（POx POxPL）
因为域服务器通常会作为时间服务器来使用
> System error 5 has occurred.
>
> Access is denied.
这个点有点奇怪,按道理来说这种情况说明存在域，但当前用户不是域用户。(有可能是这个机子同时作为两个域的域控原因导致出错了,等待师傅解答原因)
但是通过查询指定域，发现会显的是PHXPL这个域的结果，反正挺奇怪的。
还有其他两种情况就是:
(1) 存在域，且当前用户是域用户
> [+] received output:  
>  Current time at \POxSERVER.poXpl.XXX is 11-12-2020 11:33:31
>
> The command completed successfully.
这里就很明显了直接返回时间服务器的结果。
(2)不存在域
> 找不到域 WORKGROUP 的域控制器。
>
> 请键入 NET HELPMSG 3913 以获得更多的帮助。
### 0x3.2 收集域内基础信息
下面的查询命令在本质上都是通过LDAP协议到域控制器上进行查询的,所以在查询时需要进行权限认证，只有域用户用户才拥有此权限，本地用户则无法进行域信息的查询。在域中，除普通用户外，所有的机器都有一个机器用户，其用户名为机器名加上"$"。system权限对应的就是域里面的机器用户,所以域内机器的system权限拥有查询的权限。
**1.查询所处的域**
`net view /domain`
> [+] received output:  
>  Domain
>
> * * *
>
> POX  
>  POXPL  
>  The command completed successfully.
这里说明当前处于双域环境下
**2.查询域内所有计算机**
`net view /domain:(可选指定域)`
> \MRD01  
>  \NAS1-VC NAS1-VC  
>  \NAS2 NAS2  
>  \NURSINGDLX01-PC  
>  \NURSTN01  
>  \NURSUPR
>
> ... Remark 有一定的作用，可以说明这个机器的用途
还有就是使用cs自带的`net view`命令
> POXXLADC 169.254.137.125 500 6.3 BDC  
>  POXSERVER 192.168.1.X 500 6.3 PDC POxSERVER
里面有个属性是Type, BDC->BackUP DOMAIN CONTROLLER PDC->PRIMARY ~
**3.查询域内所有用户组列表**
`net group /domain`
> Group Accounts for \POxPLADC
>
> * * *
>
> _1 NUR USER_ 1 NUS IC  
>  _3 NUR IC_ 3 NUR USERS  
>  *Accounts  
>  ... 比较多,这里我们需要注意和学习是系统自带的常见用户身份
>
>   * Domain Admins:域管理员
>   * Domain Computer: 域内机器
>   * Domain Controller:域控制器
>   * Domain Guest:域用户
>   * Enterprise Admins:企业系统管理员用户
>
>
> 在默认情况下Domain Admins和Enterprise Admin对域内所有域空盒子器有完全控制权限*
**4.查询所有域成员的计算机列表**
`net group "domain computers" /domain`
**5.获取域密码信息**
`net account domain`
> [+] received output:  
>  Force user logoff how long after time expires?: Never  
>  Minimum password age (days): 1  
>  Maximum password age (days): 42  
>  Minimum password length: 7  
>  Length of password history maintained: 24  
>  Lockout threshold: Never  
>  Lockout duration (minutes): 30  
>  Lockout observation window (minutes): 30  
>  Computer role: BACKUP  
>  The command completed successfully.
这里设置了密码不会过期，密码的长度信息，后面如果想爆破可以作为一个参考。
**6.获取域信任信息**
`nltest /domain_trusts`
> List of domain trusts:  
>  0: POXPL poXpl.com (NT 5) (Forest Tree Root) (Primary Domain) (Native)  
>  The command completed successfully
说明没有存在多域信任关系。
### 0x3.3 查看域控制器
1. **从域控制器查询获取域控制器的列表**
`nltest /dclist:domain`
> Get list of DCs in domain 'POXPL' from '\POXSERVER'.  
>  Cannot DsBind to POXPL (\POXSERVER).Status = 2148074274 0x80090322
> SEC_E_WRONG_PRINCIPAL
>
> [+] received output:  
>  List of DCs in Domain POHPL  
>  \POXSERVER (PDC)  
>  \POXPLADC  
>  The command completed successfully
这里说明存在两个域控制器。
**2.查看域控制器主机名**
`nslookup -type=SRV_ldap._tcp`
> Default Server: poXsXrver.poXpl.com  
>  Address: 192.168.1.X
**3.查看当前时间**
`net time /domain` 一般为域控
**4.查看域控制器**
`net group "Domain Controllers" /domain`
>
>     itadmin                  mahendran                POXADC$  
>     POXPLADC$                POXSERVER$
关于带"$"就是域控机器名,可以ping获取到ip地址。
### 0x3.4 获取域内用户和管理员信息
**1.查询所有域用户列表**
`net user /domain`
这里可以稍微关注一下一个特殊用户krbtgt,用于加密tgs。
**2.获取域内用户详细信息**
常见参数包括用户名、描述信息、SID、域名、状态
`wmic useraccount get /all`
**3.查看存在的用户**
`dsquery user`
这个命令我没执行成功。
**4.查询本地管理员用户**
`net localgroup administrators`