**图 8-2 如果有多台机器将网路流量传送到同一目的地，则其交换机伫列可能会被填满。在这里，埠 1,2 和 4 都试图传送资料包到埠 3**
而且，如果 TCP 在某个超时时间内没有被确认（这是根据观察的往返时间计算的），则认为资料包丢失，丢失的资料包将自动重新发送。尽管应用程式没有看到资料包丢失和重新传输，但它看到了延迟（等待超时到期，然后等待重新传输的资料包得到确认）。
> #### TCP与UDP
>
> 一些对延迟敏感的应用程式，比如视讯会议和 IP 语音（VoIP），使用了 UDP 而不是 TCP。这是在可靠性和和延迟变化之间的折衷：由于 UDP 不执行流量控制并且不重传丢失的分组，所以避免了网路延迟变化的一些原因（尽管它仍然易受切换伫列和排程延迟的影响）。
>
> 在延迟资料毫无价值的情况下，UDP 是一个不错的选择。例如，在 VoIP 电话呼叫中，可能没有足够的时间重新发送丢失的资料包，并在扬声器上播放资料。在这种情况下，重发资料包没有意义 —— 应用程式必须使用静音填充丢失资料包的时隙（导致声音短暂中断），然后在资料流中继续。重试发生在人类层（“你能再说一遍吗？声音刚刚断了一会儿。”）。
所有这些因素都会造成网路延迟的变化。当系统接近其最大容量时，排队延迟的变化范围特别大：拥有足够备用容量的系统可以轻松排空伫列，而在高利用率的系统中，很快就能积累很长的伫列。
在公共云和多租户资料中心中，资源被许多客户共享：网路连结和交换机，甚至每个机器的网络卡和 CPU（在虚拟机器上执行时）。批处理工作负载（如 MapReduce，请参阅 [第十章](ch10.md)）能够很容易使网路连结饱和。由于无法控制或了解其他客户对共享资源的使用情况，如果附近的某个人（嘈杂的邻居）正在使用大量资源，则网路延迟可能会发生剧烈变化【28,29】。
在这种环境下，你只能透过实验方式选择超时：在一段较长的时期内、在多台机器上测量网路往返时间的分布，以确定延迟的预期变化。然后，考虑到应用程式的特性，可以确定 **故障检测延迟** 与 **过早超时风险** 之间的适当折衷。
更好的一种做法是，系统不是使用配置的常量超时时间，而是连续测量响应时间及其变化（抖动），并根据观察到的响应时间分布自动调整超时时间。这可以透过 Phi Accrual 故障检测器【30】来完成，该检测器在例如 Akka 和 Cassandra 【31】中使用。TCP 的超时重传机制也是以类似的方式工作【27】。
### 同步网路与非同步网路
如果我们可以依靠网路来传递一些 **最大延迟固定** 的资料包，而不是丢弃资料包，那么分散式系统就会简单得多。为什么我们不能在硬体层面上解决这个问题，使网路可靠，使软体不必担心呢？
为了回答这个问题，将资料中心网路与非常可靠的传统固定电话网路（非蜂窝，非 VoIP）进行比较是很有趣的：延迟音讯帧和掉话是非常罕见的。一个电话需要一个很低的端到端延迟，以及足够的频宽来传输你声音的音讯取样资料。在计算机网路中有类似的可靠性和可预测性不是很好吗？
当你透过电话网路拨打电话时，它会建立一个电路：在两个呼叫者之间的整个路线上为呼叫分配一个固定的，有保证的频宽量。这个电路会保持至通话结束【32】。例如，ISDN 网路以每秒 4000 帧的固定速率执行。呼叫建立时，每个帧内（每个方向）分配 16 位空间。因此，在通话期间，每一方都保证能够每 250 微秒传送一个精确的 16 位音讯资料【33,34】。
这种网路是同步的：即使资料经过多个路由器，也不会受到排队的影响，因为呼叫的 16 位空间已经在网路的下一跳中保留了下来。而且由于没有排队，网路的最大端到端延迟是固定的。我们称之为 **有限延迟（bounded delay）**。
#### 我们不能简单地使网路延迟可预测吗？
请注意，电话网路中的电路与 TCP 连线有很大不同：电路是固定数量的预留频宽，在电路建立时没有其他人可以使用，而 TCP 连线的资料包 **机会性地** 使用任何可用的网路频宽。你可以给 TCP 一个可变大小的资料块（例如，一个电子邮件或一个网页），它会尽可能在最短的时间内传输它。TCP 连线空闲时，不使用任何频宽 [^ii]。
[^ii]: 除了偶尔的 keepalive 资料包，如果 TCP keepalive 被启用。
如果资料中心网路和网际网路是电路交换网路，那么在建立电路时就可以建立一个受保证的最大往返时间。但是，它们并不能这样：乙太网和 IP 是 **分组交换协议**，不得不忍受排队的折磨和因此导致的网路无限延迟，这些协议没有电路的概念。
为什么资料中心网路和网际网路使用分组交换？答案是，它们针对 **突发流量（bursty traffic）** 进行了最佳化。一个电路适用于音讯或视讯通话，在通话期间需要每秒传送相当数量的位元。另一方面，请求网页，传送电子邮件或传输档案没有任何特定的频宽要求 —— 我们只是希望它尽快完成。
如果想透过电路传输档案，你得预测一个频宽分配。如果你猜的太低，传输速度会不必要的太慢，导致网路容量闲置。如果你猜的太高，电路就无法建立（因为如果无法保证其频宽分配，网路不能建立电路）。因此，将电路用于突发资料传输会浪费网路容量，并且使传输不必要地缓慢。相比之下，TCP 动态调整资料传输速率以适应可用的网路容量。
已经有一些尝试去建立同时支援电路交换和分组交换的混合网路，比如 ATM [^iii]。InfiniBand 有一些相似之处【35】：它在链路层实现了端到端的流量控制，从而减少了在网路中排队的需要，尽管它仍然可能因链路拥塞而受到延迟【36】。透过仔细使用 **服务质量**（quality of service，即 QoS，资料包的优先顺序和排程）和 **准入控制**（admission control，限速传送器），可以在分组网路上类比电路交换，或提供统计上的 **有限延迟**【25,32】。
[^iii]: **非同步传输模式（Asynchronous Transfer Mode, ATM）** 在 20 世纪 80 年代是乙太网的竞争对手【32】，但在电话网核心交换机之外并没有得到太多的采用。它与自动柜员机（也称为自动取款机）无关，尽管共用一个缩写词。或许，在一些平行的世界里，网际网路是基于像 ATM 这样的东西，因此它们的网际网路视讯通话可能比我们的更可靠，因为它们不会遭受包的丢失和延迟。
但是，目前在多租户资料中心和公共云或透过网际网路 [^iv] 进行通讯时，此类服务质量尚未启用。当前部署的技术不允许我们对网路的延迟或可靠性作出任何保证：我们必须假设网路拥塞，排队和无限的延迟总是会发生。因此，超时时间没有 “正确” 的值 —— 它需要透过实验来确定。
[^iv]: 网际网路服务提供商之间的对等协议和透过 **BGP 闸道器协议（BGP）** 建立的路由，与 IP 协议相比，更接近于电路交换。在这个级别上，可以购买专用频宽。但是，网际网路路由在网路级别执行，而不是主机之间的单独连线，而且执行时间要长得多。
> ### 延迟和资源利用
>
> 更一般地说，可以将 **延迟变化** 视为 **动态资源分割槽** 的结果。
>
> 假设两台电话交换机之间有一条线路，可以同时进行 10,000 个呼叫。透过此线路切换的每个电路都占用其中一个呼叫插槽。因此，你可以将线路视为可由多达 10,000 个并发使用者共享的资源。资源以静态方式分配：即使你现在是线路上唯一的呼叫，并且所有其他 9,999 个插槽都未使用，你的电路仍将分配与线路充分利用时相同的固定数量的频宽。
>
> 相比之下，网际网路动态分享网路频宽。传送者互相推挤和争夺，以让他们的资料包尽可能快地透过网路，并且网路交换机决定从一个时刻到另一个时刻传送哪个分组（即，频宽分配）。这种方法有排队的缺点，但其优点是它最大限度地利用了线路。线路固定成本，所以如果你更好地利用它，你透过线路传送的每个位元组都会更便宜。
>