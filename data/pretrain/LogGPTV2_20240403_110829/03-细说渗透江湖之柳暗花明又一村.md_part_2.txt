来看看权限，是mssqlserver权限，很明显被降权了，查看了其他⼏个数据库也是⼀样
的结果，所以这个点也利⽤不了。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 18/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
继续寻找突破⼝，在跳板pc上发现⼀个护理病历系统，并且发现是登录状态，猜测这个
软件应该很多员⼯都安装了，于是想到从这个软件下⼿。
通过逆向得到代码，查看代码，看看能不能对代码进⾏修改。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 19/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
可以修改。
我的思路是，在软件中去种⻢，诱导⼯作⼈员去安装，这部分过于敏感就简单的描述⼀
下。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 20/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
通过跳板pc机浏览器历史记录，保存有邮件系统地址和⽤户名密码，登录邮件后在通讯
录⾥⾯找到⼤量员⼯邮箱地址，接下来构造⼀封邮件，诱导员⼯下载更新该带有后⻔的
软件，等到隔天晚上2点查看结果，上线了不少⽤户（由于他们的⽤户名很容易被逆向分
析出⽬标医院，所以打码有点全，⼤家⻅笑了。）。
有$的密码是我后加的，当时他们要证明能不能对电脑进⾏实际操作，所以都添加了个⽤
户名，⽤户名涉及到敏感信息所以也打码。
通 过 对 上 线 ⽤ 户 的 分 析 ， 发 现 这 些 都 是 个 ⼈ pc ， 系 统 上 ⾯ 特 别 ⼲ 净 ， ⽽ 且 都 是 以
administrator⽤户上线，电脑上只安装了⼀些和医院相关的软件，没有其他敏感信
息，显示这都是医院统⼀配的办公电脑，虽然获取了这么多pc权限但是没有我想要的东
⻄，到这⾥渗透陷⼊了僵局。
⼀个0day定乾坤
脑⼦现在没啥思路了，⼩学⽼师告诉我们，当你遇到⼀道题解到⼀半的时候，发现前⾯
都⻛调⾬顺，越到后⾯越迷茫的时候，可以忘掉之前做过的，重新开始。
于是乎我⼜回头去翻ftp，⽆聊的翻了2个⼩时左右，发现了⼀份备份源码，于是乎下载
了下来，先看下⽬录，发现是⽤的ThinkPHP框架，突然想到之前收集的信息中有⼀个
web程序就是⽤thinkphp框架写的。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 21/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
看了下框架的版本3.2.3 这个版本是有官⽅未修复的注⼊漏洞，我们先找到后台登录位
置。
直接就拼接字符串了省的我们去全局找了注⼊了 看看getValue ⽅法过滤了什么。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 22/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
满脸问号没看懂这段正则匹配的意义在那⾥，应该是想写匹配⼿机号登录的，注出数据
是不可能了但可以利⽤万能密码登录进去。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 23/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
利⽤T-sql语⾔的运算符执⾏优先级达到的注⼊效果。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 24/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
来到后台先找上传功能。
成功的找到了上传⽂件⽩名单功能，尝试增加php后缀，但实际上传的时候还是不能上
传php⽂件，还是先看⼀下代码是怎么处理的。
当遇到php后缀时直接跳过不过还好只进⾏了⼩写转换 可以利⽤上传php空格后缀⽂件
绕过，虽然上传成功了但是.htaccess 限制了访问规制所以这个点还⽆法利⽤。
继续寻找，如果可以删除.htaccess 就可以成功访问⽊⻢⽂件，成功找到⼀个删除功
能。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 25/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
Member_info 的 上 传 头 像 缩 略 图 地 址 清 除 ， 也 就 是 说 这 个 Member_info 表
head_img字段可控就可以删除任何⽂件，先去找⽤户信息修改功能，果不其然。
⾃此成功访问删除.htaccess。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 26/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
该0day整个的利⽤链
1.后台万能密码登录；
2.找到上传⽩名单功能添加php空格可上传后缀⽂件；
3.前台个⼈头像处上传⽂件；
4.利⽤前台⽤户修改功能修改⾃⼰的信息来篡改缓存头像地址；
5.在访问前台上传头像功能，会删除⽤户的缩略图。
通过0day成功拿到了webshell，终于撕开了⼀个⼝⼦
提权过程也很顺利，直接利⽤ms15-051添加⽤户得到服务器权限。
抓了⼀下系统⽤户哈希，可能会暴露⽬标名称，打码。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 27/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
利⽤该密码去跑了⼀遍开了3389的服务器，得出如下结果。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 28/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
发现域控服务器也在列表中，⽴⻢登录172.30.0.1，但是登录不上，这就奇怪了，尝试
登录其他服务器，可以成功登录，随意登录了2台，后⾯就不⼀⼀登录了。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 29/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
我 们 的 ⽬ 标 是 域 控 ， 域 控 ip 能 ping 通 但 是 远 程 桌 ⾯ 连 不 上 ， 扫 了 ⼀ 下 端 ⼝ 开 放 了
3389，为什么爆破能爆破到，但是登录的时候登录不上呢。
思考了⼀下，发现忽略了⼀个细节，我爆破时候，是在172.30.0.52这台服务器爆破
的，不是在pc跳板机上⾯爆破的，因此猜想域控服务器只能通过172.30.0.*段服务器做
跳板连接，因此我随意选了⼀台服务器172.30.0.104成功登录了域控服务器。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 30/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
结尾总结
拿下域控，项⽬基本结束，看似强⼤的外⽹都存在⼀个特别柔弱的内⽹，当你撕开外⽹
这个强⼤的⼝⼦后，进⼊到内⽹⾯对的将是⼀堆弱不禁⻛的系统，但是这弱不禁⻛的系
统看似很容易进⼊，但是你却偏偏进不去，只有当你突破这个意境后就能在内⽹⾏⾛⾃
如。
就如本⽂⼀样，想要通过外⽹访问内⽹，经过⼏番折腾，最后通过wifi这个薄弱点，成
功来到了内⽹，到了内⽹后得到了⼀些系统密码，似乎胜券在握的你却发现⼜⼀道墙挡
住了你的去路，这时你有2条路，⼀条路就是翻过这堵墙，第⼆条就是重新再找⼀条路。
本⽂就是如此，到达⽬标地点后，对⽬标周围环境进⾏侦查，经过侦查发现可以通过
WiFi作为突破⼝成功打通进⼊内⽹的通道，经过对医院员⼯的信息收集成功控制某员⼯
PC电脑。
控制PC后通过分析他们内部⽤的办公软件并且种⼊后⻔，通过钓⻥等诱导⽅式，诱导员
⼯更新带有后⻔的软件，成功上线⼀些安全意识较弱的员⼯，此时发现上线的员⼯电脑
并⽆我们想要的东⻄，因此毫不犹豫放弃，另寻它路。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 31/32
2020/7/27 细说渗透江湖之柳暗花明又⼀村
⼜在尝试了各种漏洞⽆果后，回过头来对之前发现的漏洞仔细分析，寻找是否有遗漏的
地⽅，经过耐⼼的分析和寻找，终于通过ftp泄露的⽹站源码成功挖掘出可以getshell
的漏洞，成功利⽤该漏洞获取到服务器权限。因此成功打⼊内部核⼼系统拿到域控。
https://mp.weixin.qq.com/s/pW8mGaEbdH6Aj5ypcYvbFA 32/32