# 勒索软件“假面”系列——免流软件
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
传送门：[勒索软件“假面”系列——代刷软件](https://www.anquanke.com/post/id/103608)
## 第一章 勒索中的“免流”
勒索软件是指启动后通过置顶自身窗口或重置锁机密码强制锁定用户桌面、使用户无法正常使用设备，并以支付解锁对用户进行勒索的软件。近年来，360烽火实验室始终密切关注勒索软件发展动向，并持续对勒索软件新技术新形式、勒索软件黑产、以及Android新版本系统在对抗勒索软件方面的新特性进行了深入研究。在对勒索软件的长期跟进中我们发现，勒索软件是一类非常擅长伪装自己的软件，为了诱导用户下载安装运行，勒索软件通常会伪装成各种极具诱惑力、通过不正规手段牟利的软件，例如游戏外挂、代刷、盗版应用、WIFI密码破解、抢红包等等，这些软件拥有一定的用户群与传播途径，勒索软件正是利用了其易吸引用户、传播快的特点玩起了“假面游戏”。
###  一、勒索软件擅于伪装后传播
截止到2018年2月，360烽火实验室共捕获到Android恶意勒索软件80万个，而其中几乎所有的勒索软件都对自己进行了伪装，对这些勒索软件分类统计后发现，勒索软件的伪装类别多达十多种，其中以外挂辅助类最为普遍，流氓软件与色情类软件次之。
图1 勒索软件伪装类别分布
###  二、特殊的伪装——免流软件
在这些伪装类别中，我们发现有一类与日常生活中不可或缺的手机流量相关的软件——免流软件，这类软件名称多为“XX免流”或“XX云免”，号称能够让用户免流量费上网，并以此吸引用户下载安装，实运行后却是勒索软件。
图2 冒充免流软件的勒索软件
在我们捕获到的勒索软件中，冒充免流软件的样本占比1.81%，虽然占比工具类低，但自成派别，数量不在少数，甚至超过了盗版软件。
大量勒索软件冒充免流软件进行传播的现象从侧面反映出了一个问题——免流软件本身占据着相当用户与传播市场。实际上确实如此，移动互联的发展推动了智能手机的网络访问量，特别是随着手机直播、在线视频、移动社交等产业的繁荣，智能手机流量的使用量不断攀升。根据工信部2018年2月发布的《2017年通信业统计公报》，2017年各月户月均移动互联网接入流量呈逐月增长的趋势，到12月已超过2G。
图3 2017年各月当月户均移动互联网接入流量增长情况
然而在国内，移动数据流量并不便宜，数据流量使用量的攀升使得部分人开始寻求廉价甚至免费的流量获取方法，免流软件应运而生并快速传播开来。截止到2018年2月，360烽火实验室共捕获到20万+个免流软件，其中部分软件的传播量已经达到了几百万次。巨大的软件数量与传播量进一步印证免流软件拥有着不小的市场，且我们在对免流软件与免流平台的分析过程中发现，免流软件已具备一定的产业规模。
## 第二章 免流软件
###  一、定义与分类
免流软件即安装后可以让用户在移动运营商网络下免流量或减少流量访问互联网的软件。免流软件根据其核心功能所在的位置可以分为本地免流与云免流，本地免流软件的核心功能环节通常位于本地，而云免流的核心功能环节则主要在VPN中完成。
#### (一) 本地免流
本地免流是指通过修改本地代理或者使用网络请求捕获与修改模块在本地修改用户网络请求（HTTP与HTTPs请求，本文均以HTTP请求为例）从而达到免流效果的方式。根据实现框架的不同，本地免流分为很多种，比较有名的有Tiny、Samp、Hap、Fmns等等，不同框架实现的免流软件对手机root权限与端口的要求不同，同时相应的免流模式语法也不同。但无论哪种框架是否需要root，最终目的都是通过一些手段修改本地的网络请求包，将免流混淆信息插入其中，从而把非免流流量伪装成免流流量。
本地免流软件主要由核心代理模块、免流模式、防跳工具三部分构成，这些模块通常都存放在软件的Assets目录下：
  1. 核心代理模块。核心代理模块通常使用Tiny、Samp等开源框架在本地搭建网络代理，其主要职责是根据免流模式对设备发起的网络请求进行修改；
  2. 免流模式。免流模式是免流成功的关键所在，它定义了对网络请求进行修改的规则，被核心代理模块所用；
  3. 防跳工具。防跳工具即用来预防跳点的模块。跳点指的是那些未能成功免流、被计费检测系统正常进行计费了的流量。产生跳点的主要原因是部分流量不会经过本地代理，从而造成请求头修改失败。目前比较流行的防跳方式有单纯禁网与使用防跳工具，防跳工具的防跳原理与单纯的禁网不同，其还包括了修改防火墙命令，强制部分不走本地代理的流量去走本地代理，而对于部分免流系统不支持的协议（如QQ、微信等），则可以用规则将其放行，使之能正常访问网络，这种情况叫做半免。防跳工具就是用于减少跳点带来的额外流量费的工具。目前比较流行的防跳工具有扫地僧防跳与终极防跳。
#### (二) 云免流
云免流是指通过连接特定VPN服务器实现免流上网的方式。与本地免流不同，云免流用户不用自己去进行核心模块安装、防跳设置等繁琐操作，仅需要使用VPN软件连接特定免流VPN服务器即可实现免流。云免流相当于把原来本地免流的一套系统搬到了VPN服务器上，VPN服务器作为一个代理服务器，代理并修改用户设备发出的所有网络请求，进而达到用户免流量上网的目的。在云免流中有服务端与客户端之分，服务端即VPN服务器，目前搭建Linux
VPN服务器较常用的是OpenVPN开源框架；客户端即用户设备上安装的VPN连接软件，很多免流平台（VPN服务端）都为用户提供了特定的客户端软件，用户只需要安装客户端软件与服务端下发的配置文件，并在免流平台购买VPN卡密，即可通过客户端软件连接VPN来实现免流。
以某款免流平台为例：用户首先需要在免流平台购买免流套餐，包月套餐通常为几块钱不等，免流平台支持的支付形式多样，可购买多张，通常多买会有优惠政策：
图4 某云免流平台卡密购买页面
购买成功后卡密（即激活码）会返回到订单详情中，同时，客户端软件的链接也会一并提供给用户：
图5 云免流购买卡密后订单页面
用户通过链接下载客户端软件并通过卡密激活后就可以安装线路使用了。云免软件通常给用户提供了多条线路，如下图，用户可根据自己所在的运营商与地区情况选择可用的线路，只有在可用线路下才能成功免流。
图6 云免流客户端线路选择页面
###  二、两大必备因素
免流软件的存在依赖于两个必不可少的因素：免流IP、移动运营商代理服务器与计费检测系统的分离。
#### (一)免流IP
移动运营商为了方便用户访问其提供的各种服务，通常会为用户提供特定的免流优惠政策，比如，当用户用数据网络访问移动运营商掌上营业厅时不会向用户收取流量费，由此产生了一些免流量计费的IP，即免流IP。运营商计费检测系统把所有免流IP放入了一份白名单，当用户流量进入计费检测系统以后，计费检测系统会判断该用户流量访问的IP是否在白名单中，若在就不会进行扣费；