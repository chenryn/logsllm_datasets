中的大多数数据的程序中配置进程亲和性。这样可已最大化缓存成功率，并籍此提高性能。
:::
:::
:::
::: section
::: titlepage
# [⁠]{#main-network.html#s-network-common-queue-issues}8.4. 解决常见队列/帧丢失问题 {.title}
:::
::: para
到目前为止，帧丢失最常见的原因是*队列超限运转*。该内核设定了队列长度限制，且在有些情况下队列填充的速度超过排出的速度。出现这种情况时间过长，则会开始出现掉帧的情况。
:::
::: para
如 [图 8.1
"网络接收路径图表"](#main-network.html#packet-reception-png){.xref}
所示，在接收路径中有两种主要队列：NIC
硬件缓冲和插槽队列。这两种队列都需要进行配置以放置队列超限运转。
:::
::: section
::: titlepage
## [⁠]{#main-network.html#s-network-commonque-nichwbuf}8.4.1. NIC 硬件缓冲 {.title}
:::
::: para
NIC 使用帧填充其硬件缓冲；然后该缓冲会被 `softirq`{.command}
排干，通过中断肯定 NIC。要询问这个队列的状态，请使用以下命令：
:::
``` programlisting
ethtool -S ethX
```
::: para
使用 NIC 的对应设备名称替换 `ethX`{.command}。这样会显示在
`ethX`{.command}
中已丢失的帧数。丢帧经常是因为该队列超过保存那些帧的缓冲空间所致。
:::
::: para
解决这个问题有一些不同方法，即：
:::
::: variablelist
[输入流量]{.term}
:   ::: para
    您可以通过放缓下行输入流量放置队列超限运转。方法是过滤、减少联合多播组数、降低广播流量等等。
    :::
[队列长度]{.term}
:   ::: para
    另外，您也可以增加队列长度。这包括在指定队列中将缓冲数增加到该驱动程序最多可以承担的数量。方法是编辑
    `ethX`{.command} 的 `rx`{.computeroutput}/`tx`{.computeroutput}
    环参数，命令为：
    :::
    ``` programlisting
    ethtool --set-ring ethX
    ```
    ::: para
    在前面所说的命令中附加恰当的
    `rx`{.computeroutput}/`tx`{.computeroutput} 值。详情请参考
    `man ethtool`{.command}。
    :::
[设备加权]{.term}
:   ::: para
    您还可以增加排空队列的速度。方法是相应调整 NIC
    的[*设备加权*]{.emphasis}。这个属性指的是 `softirq`{.command}
    上下文必须产生 CPU 并重新调度其本身前 NIC 可以接收的最多帧数。它由
    `/proc/sys/net/core/dev_weight`{.filename} 变量控制。
    :::
:::
::: para
大多数管理员有选择第三个选项的倾向。但请注意这样做会有一定的后果。在一个迭代中增加可以从
NIC 接收的帧数会造成额外的 CPU 周期，在此期间那个 CPU
无法调度任何应用程序。
:::
:::
::: section
::: titlepage
## [⁠]{#main-network.html#s-network-commonque-soft}8.4.2. 插槽队列 {.title}
:::
::: para
和 NIC 硬件队列一样，插槽队列是由来自 `softirq`{.command}
上下文的网络栈填充。然后程序通过调用清空其对应插槽的队列以便进行
`read`{.command}、`recvfrom`{.command} 等等。
:::
::: para
要监控这个队列的状态请使用 `netstat`{.command}
程序。`Recv-Q`{.computeroutput}
列显示队列大小。一般来说对插槽队列中的超限运转的处理与对 NIC
硬件缓冲超限运转的处理相同（例如：[第 8.4.1 节 "NIC
硬件缓冲"](#main-network.html#s-network-commonque-nichwbuf){.xref}）：
:::
::: variablelist
[输入流量]{.term}
:   ::: para
    第一个方法是延缓输入流量，方法为填充队列配置速度。具体步骤可以是过滤帧或者抢先丢掉它们。您还可以通过降低
    NIC 的设备加权
    [⁠]{#main-network.html#idm140329722621840}[^\[6\]^](#main-network.html#ftn.idm140329722621840){.footnote
    xmlns:d="http://docbook.org/ns/docbook"}延缓输入流量。
    :::
[队列深度]{.term}
:   ::: para
    您还可以通过增大队列深度避免插槽队列超限运转。方法是增大
    `rmem_default`{.command} 内核参数或者 `SO_RCVBUF`{.command}
    插槽选项值。有关详情请参考 [第 8.2 节
    "优化的网络设置"](#main-network.html#s-network-dont-adjust-defaults){.xref}。
    :::
[程序调用频率]{.term}
:   ::: para
    尽可能优化程序以便更频繁地执行调用。这包括修改或者重新配置网络程序以便执行更频繁的
    POSIX 调用（比如
    `recv`{.command}、`read`{.command}）。反过来，这也可以让程序更快地排空队列。
    :::
:::
::: para
很多管理员更喜欢使用增加队列深度的方法。这是最简单的解决方案，但并不总是能够长期使用。因为联网技术发展迅速，插槽队列将继续以更快的速度填充。随着时间的推移这意味着要相应重新调整队列深度。
:::
::: para
最好的解决方法是提高或者将程序配置为更迅速地从内核中排空数据，即使需要让数据在程序空间排队也无妨。这样数据的保存就变得更灵活，因为可以根据需要置换出数据或者缓存到页中。
:::
:::
:::
::: section
::: titlepage
# [⁠]{#main-network.html#s-network-multicast}8.5. 多播注意事项 {.title}
:::
::: para
当有多个程序侦听多播组时，要求将处理多播帧的内核代码设计为为每个独立插槽复制网络数据。这个复制很耗时且要在
`softirq`{.command} 上下文中进行。
:::
::: para
因此在单一多播组中添加多个侦听程序会直接影响 `softirq`{.command}
上下文的执行时间。在多播组中添加侦听程序意味着内核必须为那个组接收的每个帧生成额外的副本。
:::
::: para
这对低流量卷且侦听程序数小时影响最小。但当多个插槽侦听一个高流量多播组时，增加的
`softirq`{.command} 上下文执行时间导致在网卡和插槽多列中掉帧。增加
`softirq`{.command}
运行时会导致降低程序在高负载系统中运行的机会，那样的话多播帧丢失的比例会随着侦听高容量多部组程序是的增加而增大。
:::
::: para
如 [第 8.4.2 节
"插槽队列"](#main-network.html#s-network-commonque-soft){.xref} 或者
[第 8.4.1 节 "NIC
硬件缓冲"](#main-network.html#s-network-commonque-nichwbuf){.xref}
所属通过优化您的插槽队列和 NIC
硬件缓冲解决丢帧问题。另外，您还可以优化程序的插槽使用。方法是将程序配置为控制单一插槽，并将接收的网络数据迅速传播到其他用户空间进程中。
:::
:::
::: footnotes
\
------------------------------------------------------------------------
::: {#main-network.html#ftn.idm140329725720240 .footnote}
::: para
[^\[4\]^](#main-network.html#idm140329725720240){.para} 保证 CPU 和 NIC
之间的缓存亲和力意味着将其配置为共享同一 L2 缓存。有关详情请参考
[第 8.3 节
"数据包接收概述"](#main-network.html#s-network-packet-reception){.xref}。
:::
:::
::: {#main-network.html#ftn.idm140329767761664 .footnote}
::: para
[^\[5\]^](#main-network.html#idm140329767761664){.para} [第 8.3 节
"数据包接收概述"](#main-network.html#s-network-packet-reception){.xref}
中包含数据包行程概述，应该可以帮助您定位并对应网络栈中的瓶颈区域。
:::
:::
::: {#main-network.html#ftn.idm140329722621840 .footnote}
::: para
[^\[6\]^](#main-network.html#idm140329722621840){.para} 设备加权是由
`/proc/sys/net/core/dev_weight`{.filename}
控制。有关设备加权以及调整它的方法详情请参考 [第 8.4.1 节 "NIC
硬件缓冲"](#main-network.html#s-network-commonque-nichwbuf){.xref}。
:::
:::
:::
:::
[]{#appe-Performance_Tuning_Guide-Revision_History.html}
::: appendix
::: titlepage
# [⁠]{#appe-Performance_Tuning_Guide-Revision_History.html#appe-Performance_Tuning_Guide-Revision_History}附录 A. 修订记录 {.title}
:::
::: {.para xmlns:d="http://docbook.org/ns/docbook"}
::: revhistory
+-----------------------+-----------------------+-----------------------+
| **修订历史**          |                       |                       |
+:======================+:======================+:======================+
| 修订 4.0-22.2.400     | 2013-10-31            | [                     |
|                       |                       | [Rüdiger]{.firstname} |
|                       |                       | [Landmann             |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   --------            |                       |                       |
| --------------------- |                       |                       |
|   Rebuil              |                       |                       |
| d with publican 4.0.0 |                       |                       |
|   --------            |                       |                       |
| --------------------- |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-22.2         | Mon July 1 2013       | [[Wei]{.firstname}    |
|                       |                       | [Lliu                 |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   ----------------    |                       |                       |
|   完成翻译、校对      |                       |                       |
|   ----------------    |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-22.1         | Thu Apr 18 2013       | [                     |
|                       |                       | [Chester]{.firstname} |
|                       |                       | [Cheng                |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   ----------------    |                       |                       |
| --------------------- |                       |                       |
|   与 XML 源 4.0-      |                       |                       |
| 22 版本同步的翻译文件 |                       |                       |
|   ----------------    |                       |                       |
| --------------------- |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-22           | Fri Feb 15 2013       | [[Laura]{.firstname}  |
|                       |                       | [Bailey               |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   ----------          |                       |                       |
| --------------------- |                       |                       |
|   为红帽企            |                       |                       |
| 业版 Linux 6.4 发布。 |                       |                       |
|   ----------          |                       |                       |
| --------------------- |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-19           | Wed Jan 16 2013       | [[Laura]{.firstname}  |
|                       |                       | [Bailey               |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   ---------           |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
|   为保持一            |                       |                       |
| 致进行的小修改（[BZ#  |                       |                       |
| 868404](https://bugzi |                       |                       |
| lla.redhat.com/show_b |                       |                       |
| ug.cgi?id=868404)）。 |                       |                       |
|   ---------           |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-18           | Tue Nov 27 2012       | [[Laura]{.firstname}  |
|                       |                       | [Bailey               |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   ---------------     |                       |                       |
| --------------------- |                       |                       |
|   为红帽企业版        |                       |                       |
| Linux 6.4 Beta 发布。 |                       |                       |
|   ---------------     |                       |                       |
| --------------------- |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-17           | Mon Nov 19 2012       | [[Laura]{.firstname}  |
|                       |                       | [Bailey               |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   -----------------   |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
|   已添加 SME 反馈     |                       |                       |
|  re. numad 小节（[BZ# |                       |                       |
| 868404](https://bugzi |                       |                       |
| lla.redhat.com/show_b |                       |                       |
| ug.cgi?id=868404)）。 |                       |                       |
|   -----------------   |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
+-----------------------+-----------------------+-----------------------+
| 修订 4.0-16           | Thu Nov 08 2012       | [[Laura]{.firstname}  |
|                       |                       | [Bailey               |
|                       |                       | ]{.surname}]{.author} |
+-----------------------+-----------------------+-----------------------+
|   ------------        |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |
| --------------------- |                       |                       |