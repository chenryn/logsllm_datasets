- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 4673 (A privileged service was called)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Process Information -> Process ID: "[Process ID of the Tool]"
Event Log - Service Request Information -> Privileges: "SeTcbPrivilege"
- - Keyword: "Audit Failure" Required
Security
- Confirmable Information
- Account That Attempted the Above Operation: Account Name (Standard user)
- Event ID: 4663 (An attempt was made to access an object)
4656 (A handle to an object was requested)
4658 (The handle to an object was closed)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Confirmable Information
Source host
- Target File: Object -> Object Name
- Handle ID: Object -> Handle ID *Used for association with other logs
- Process Details: Access Request Information -> Access ("WriteData (or AddFile)" / "AppendData (or AddSubdirectory
or CreatePipeInstance)")
- Success or Failure: Keywords ("Audit Success")
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "[File Name (mimikatz.exe)]"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
Event Log - Process Command Line: CommandLine
OS: Windows - - User Name: User Required
Sysmon - Process ID: ProcessId
user
↓
OS: Windows
Event ID: 9 (RawAccessRead detected)
Server
- Process: The ProcessId recorded in the event 1.
administrator
- Image: "[File Name (mimikatz.exe)]"
- Device: "\Device\HarddiskVolume2"
File name:
Execution History C:\Windows\Prefetch\[Executable File(MIMIKATZ.EXE)]-[RANDOM].pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Executed Time and Date: Last Execution Time
Event ID: 4769 (A Kerberos service ticket was requested)
- Confirmable Information
- Client IP Address: Network Information -> Client Address
- Ticket Request Type (Two different pairs of ticket requests are output.)
- Service Information: "[Host Name]$", Ticket Options: "0x40810000"
- Service Information: "krbtgt", Ticket Options: "0x60810010"
Event ID: 4672 (Special privileges assigned to new logon)
- Confirmable Information
- Account for which a Golden Ticket was Obtained: Account (An existing account name)
- Domain: Account Domain (An invalid value)
- Logon ID: Logon ID *Used for association with other logs
Event Log - Available Privileges: Special Privileges
Destination host - Required
Security
Event ID: 4624 (An account was successfully logged on)
- Logon Type: "3"
- New Logon -> Account Name / Account Domain: "[Account Name / Account Domain Recorded in Event 4672]"
- New Logon -> Logon ID: "[Logon ID Recorded in Event 4672]"
- Confirmable Information
- Used Security ID: New Logon -> Security ID
- Host That Used Authentication Information: Network Information -> Source Network Address
Event ID: 4634 (An account was logged off)
- Logon Type: "3"
- New Logon -> Account Name / Account Domain: "[Account Name / Account Domain Recorded in Event 4672]"
- New Logon -> Logon ID: "[Logon ID Recorded in Event 4672]"
52
Remarks
Additional Event Logs That Can Be Output At the host for which access was granted by using a Golden Ticket, logs related to the executed command may be recorded.
53
3.9.3. Mimikatz (Silver Ticket)
Basic Information
Tool Name Mimikatz (Silver Ticket) Legend
Category Capturing the Domain Administrator Privilege and Account Credentials - Acquirable
Tool Overview Issues an unauthorized Kerberos ticket that is valid for an arbitrary period and grants access without additional authentication Information
Tool - Event ID/Item Name
Example of This tool is used to grant a host concealing a record of authentication requests access using the Silver Ticket.
- Field Name
Presumed Tool Use - Source host: Mimikatz execution source
- "Field Value"
During an Attack - Destination host: The host logon in by Mimikatz
Standard user
Authority
*The NTLM password hash for a service account on the domain must have already been acquired.
Targeted OS Windows
Operating
Domain Not required
Condition
Communication
-
Protocol
Service Active Directory Domain Services
Information Standard Settings - Source host: Execution history (Prefetch)
Acquired from - Source host: Execution history (Sysmon / audit policy)
Additional Settings
Log - Destination host: Logon by an account with an invalid domain
Evidence That Can Be Confirmed - Destination host: If the following log is in the event log, it is considered that unauthorised logon was attempted.
When Execution is Successful - In the event IDs 4672, 4624, and 4634 in the event log "Security", a logon attempt by an account with an illegal domain is recorded.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
Event Log
- Process Return Value: Process Information -> Exit Status
- Required
Security
Event ID: 4673 (A privileged service was called)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Process Information -> Process ID: "[Process ID of the Tool]"
- Service Request Information -> Privileges: "SeTcbPrivilege"
- Keyword: "Audit Failure"
- Confirmable Information
- Account That Attempted the Above Operation: Account Name (Standard user)
Source host
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "[File Name (mimikatz.exe)]"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
Event Log - Process Command Line: CommandLine
- - User Name: User Required
Sysmon - Process ID: ProcessId
OS: Windows Event ID: 9 (RawAccessRead detected)
- Process: The ProcessId recorded in the event 1
user
↓ - Image: "[File Name (mimikatz.exe)]"
- Device: "\Device\HarddiskVolume2"
OS: Windows
Server
service
File name:
Execution History C:\Windows\Prefetch\[Executable File(MIMIKATZ.EXE)]-[RANDOM].pf
account
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Executed Time and Date: Last Execution Time
- Unlike a Golden Ticket, communication with the Domain Controller does not occur when a ticket is generated.
- The following is a log recorded when an incoming connection is received using a ticket.
Event ID: 4672 (Special privileges assigned to new logon)
- Special Privileges: "SeSecurityPrivilege" / "SeBackupPrivilege" / "SeRestorePrivilege" / "SeTakeOwnershipPrivilege" /
"SeSystemEnvironmentPrivilege" / "SeLoadDriverPrivilege" / "SeImpersonatePrivilege" /
"SeEnableDelegationPrivilege"
- Confirmable Information
- Captured Account Name: Account (An existing account name)
- Domain: Account Domain (An invalid value)
- Logon ID: Logon ID *Used for association with other logs
- Available Privileges: Special Privileges
Event Log
Destination host - Required
Security Event ID: 4624 (An account was successfully logged on)
- Logon Type: "3"
- New Logon -> Account Name / Account Domain: "[Account Name / Account Domain Recorded in Event 4672]"
- New Logon -> Logon ID: "[Logon ID Recorded in Event 4672]"
- Confirmable Information
- Used Security ID: New Logon -> Security ID
- Host That Used Authentication Information: - Network Information -> Source Network Address
Event ID: 4634 (An account was logged off)
- Logon Type: "3"
- New Logon -> Account Name / Account Domain: "[Account Name / Account Domain Recorded in Event 4672]"
- New Logon -> Logon ID: "[Logon ID Recorded in Event 4672]"
Remarks
Additional Event Logs That Can Be Output At the host for which access was granted by using a Silver Ticket, logs related to the executed command may be recorded.
54
3.10.1. ntdsutil
Basic Information
Tool Name ntdsutil Legend
Category Obtaining Active Directory database -Acquirable
Tool Overview A command to maintain Active Directory databases Information
Tool -Event ID/Item Name
Example of
-Field Name
Presumed Tool Use This tool is used to extract NTDS.DIT, a database for NTDS, and other tools are used to analyze passwords (executed in Active Directory).
-"Field Value"
During an Attack
Authority Administrator
Targeted OS Windows Server
Operating Domain Required
Condition Communication
-
Protocol
Service Active Directory Domain Services
Information - The fact that the service has started and that a driver was installed on a storage device
Standard Settings
Acquired from - History of shadow copy creation
Log Additional Settings - Execution history (Sysmon / audit policy)
If the following is confirmed, it is possible that information was breached.
- If ntdsutil.exe was executed and the following log is recorded in the event log:
Evidence That Can Be Confirmed
- The Event ID 8222 is recorded in the event log "Security".
When Execution is Successful
- A request for a handle for "[System Drive]\SNAP_[Date and Time]_VOLUME[Drive Letter]$" was successful
*Additionally, if a log indicating that files under , which cannot be normally read, were copied (Event ID: 4663) is recorded, it is possible that a shadow copy was used.
C:\Windows\NTDS
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\ntdsutil.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Process ID: Process Information -> New Process ID
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 4673 (A privileged service was called)
- Process -> Process Name: "C:\Windows\explorer.exe"
- Confirmable Information
- Privileges Used: Service Request Information -> Privileges ("SeTcbPrivilege")
Event Log
- Required
Security Event ID: 8222 (Shadow copy has been created)
- Confirmable Information
- Shadow Copy Name: Shadow Device Name
*This log is recorded without a need to configure additional settings.
Event ID: 4656 (A handle to an object was requested)
- Process Information -> Process Name: "C:\Windows\System32\VSSVC.exe"
- Confirmable Information
- Mount Point: Object -> Object Name ("C\SNAP_[Date and Time]_VOLUME[C]$")
- Success or Failure: Keywords ("Audit Success")
Active Directory - Remarks
-
-If a log indicating that files under C:\Windows\NTDS, which cannot be normally read (event 4663) was successful, it is considered that access
Domain Controller
was successful. Note that outputting the event 4663 requires the audit of object access.
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\ntdsutil.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
Event ID: 7036
- Detailed Tab -> It is possible that a start of a service with EventData\param1 set to one of the following may be recorded:
- "Volume Shadow Copy"
- "Microsoft Software Shadow Copy Provider"
- "Windows Modules Installer"
*If a service has already been executed, a log will not be output.
Event Log
- -
System Event ID: 20001
- Details Tab -> System\Provider\Name is set to "Microsoft-Windows-UserPnp".
- Confirmable Information
- Process ID: System\Execution\ProcessID *Matches the process ID of drvinst.exe output in the Sysmon log.
- Snapshot Name: UserData\InstallDeviceID\DeviceInstanceID
*If a similar snapshot was mounted before, an event log may not be output.
Execution History Registry Entry:
- -
HKEY_LOCAL_MACHINE\CurrentControlSet\Enum\STORAGE\VolumeSnapshot\HarddiskVolumeSnapshot[Snapshot Number]
Registry - If drvinst.exe has been executed, a new key is created.
Remarks
It is possible that the fact that a driver was installed is left in volsnap.inf as a difference. (*If a similar snapshot was mounted before, an event log may not be
Additional Event Logs That Can Be Output
recorded.)
55
3.10.2. vssadmin
Basic Information
Tool Name vssadmin Legend
Category Obtaining Active Directory database - Acquirable
Tool Overview Creates Volume Shadow Copy and extracts NTDS.DIT Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used to extract NTDS.DIT, a database for NTDS, so that the password can be analysed using other tools.
- "Field Value"
During an Attack
Authority Administrator
Targeted OS Windows Server
Operating Domain Required
Condition Communication
-
Protocol
Service Active Directory Domain Services
Information - The fact that the service has started and that a driver was installed on a storage device
Standard Settings
Acquired from - History of shadow copy creation
Log Additional Settings - Execution history (Sysmon / audit policy)
If the following log is in the event log, it is considered that a shadow copy was created.
Evidence That Can Be Confirmed - The Event ID 8222 is recorded in the event log "Security".
When Execution is Successful *Additionally, if a log indicating that files under C:\Windows\NTDS, which cannot be normally read, were copied (Event ID: 4663) is recorded, it is possible
that a shadow copy was used.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\vssadmin.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date Required
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Process ID: Process Information -> New Process ID
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
Event Log - Process Return Value: Process Information -> Exit Status
-
Security
Event ID: 8222 (A shadow copy was created)
- Confirmable Information
- Shadow Copy Name: Shadow Device Name
-
- Remarks
- If a log indicating that files under , which cannot be normally read (event 4663) was successful, it is
C:\Windows\NTDS
considered that access was successful.
The content of an output log depends on the software used for copying. Note that outputting the event 4663 requires the audit of
object access.
Event ID: 7036
- Detailed Tab -> System\Provider\Name: "Service Control Manager"
- Details Tab -> EventData\param1: "Volume Shadow Copy"
Active Directory
- - Confirmable Information
Domain Controller
- Executing the Service: Details Tab -> EventData\param2 ("Being executed")
*If the Volume Shadow Copy service is already running, a log will not be output.
Event Log
- -
System
Event ID: 20001
- Detailed Tab -> System\Provider\Name: "Microsoft-Windows-UserPnp"
- Confirmable Information
- Process ID: System\Execution\ProcessID *Matches the process ID of drvinst.exe output in the Sysmon log.
- Snapshot Name: UserData\InstallDeviceID\DeviceInstanceID
*If a similar snapshot was mounted before, an event log may not be output.
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\vssadmin.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *Drives that are targeted for creating a shadow copy are recorded.
- User Name: User
- Process ID: ProcessId
Execution History Registry Entry:
HKEY_LOCAL_MACHINE\CurrentControlSet\Enum
- -
\STORAGE\VolumeSnapshot\HarddiskVolumeSnapshot[Snapshot Number]
Registry - If drvinst.exe has been executed, a new key is created.
Remarks
Additional Event Logs That Can Be Output The fact that a driver was installed may be left in volsnap.inf as a difference. (*If a similar snapshot was mounted before, an event log may not be recorded.)
56
3.11.1. net user
Basic Information
Tool Name net Command (net user) Legend
Category Adding or Deleting a User/Adding or Deleting a Group - Acquirable
Tool Overview Adds a user account in a client or the domain Information