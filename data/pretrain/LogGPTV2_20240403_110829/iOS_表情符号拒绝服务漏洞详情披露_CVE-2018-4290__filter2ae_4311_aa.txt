# iOS 表情符号拒绝服务漏洞详情披露(CVE-2018-4290)
##### 译文声明
本文是翻译文章，文章来源：objective-see.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
## 前言
在我们深入讨论之前，请注意：
  * 这个bug只是拒绝服务(相对于远程编码执行)。
  * 这个bug仅影响某些“无区域”配置中的iOS设备。
  * 这个bug在iOS 11.4.1已被修补为CVE-2018-4290。
话虽如此，这个bug还是可以远程触发的，而且可以导致受影响的设备上任何正在处理远程消息(iMessage、Facebook
Messenger、WhatsApp等)的iOS应用程序都会崩溃！
## 背景
“Patrick，我想中国黑了我的iPhone”
虽然我通常会对这种难以置信的情景一笑置之，但我正在研究我的情绪智力，耐心地询问为什么我的台湾朋友会这样想。
她声称，每当她输入台湾或更糟的词时，都会收到一条带有台湾旗帜(🇹🇼)的消息，这会让她的iOS设备上的应用程序崩溃。
我仍然有点怀疑，但如下所示，这正是正在发生的事情！
[](https://p2.ssl.qhimg.com/t0193232448c1a23a32.gif)
我给她发了多个台湾旗帜，导致她的iMessage、Facebook Messenger和WhatsApp持续崩溃。🤣
在这篇文章中，我们将说明如何分析和跟踪这个远程iOS缺陷的根本原因。
## 崩溃
崩溃的设备是运行iOS 11.3(当时最新版本的iOS)的iPhone 7：
    Device: iPhone 7, iPhone9,1 (US)
    iOS: 11.3 (15E216)
    Language: English, followed by Chinese
    Region: United States
    Jailbroken: No
以下是iMessenger(MobileSMS)提供的经过删减的崩溃报告。它是从设备(通过Settings -> Privacy, Analytics,
Analytics Data)获取的：
    {"app_name":"MobileSMS","timestamp":"2018-04-18 22:27:25.13 -0700","app_version":"5.0",  
    "slice_uuid":"feac9bde-20a2-37c2-86e0-119fb8b9b650","adam_id":0,"build_version":"1.0",  
    "bundleID":"com.apple.MobileSMS","share_with_app_devs":false,"is_first_party":true,  
    "bug_type":"109","os_version":"iPhone OS 11.3  
     (15E216)","incident_id":"9EE5610B-7A0C-4558-895F-CF876DEB6B07","name":"MobileSMS"}  
    Incident Identifier: 9EE5610B-7A0C-4558-895F-CF876DEB6B07
    CrashReporter Key:   69340bb1126c092b97b9af069f4f6f037466ee0c
    Hardware Model:      iPhone9,1
    Process:             MobileSMS [10417]
    Path:                /Applications/MobileSMS.app/MobileSMS
    Identifier:          com.apple.MobileSMS
    Version:             1.0 (5.0)
    Code Type:           ARM-64 (Native)
    Role:                Foreground
    Parent Process:      launchd [1]
    Coalition:           com.apple.MobileSMS [2015]
    Date/Time:           2018-04-18 22:27:24.9896 -0700
    Launch Time:         2018-04-18 22:26:16.9044 -0700
    OS Version:          iPhone OS 11.3 (15E216)
    Baseband Version:    3.66.00
    Report Version:      104
    Exception Type:  EXC_BAD_ACCESS (SIGSEGV)
    Exception Subtype: KERN_INVALID_ADDRESS at 0x0000000000000000
    Termination Signal: Segmentation fault: 11
    Termination Reason: Namespace SIGNAL, Code 0xb
    Terminating Process: exc handler [0]
    Triggered by Thread:  6
    Filtered syslog:
    None found
    Thread 0 name:  Dispatch queue: com.apple.main-thread
    Thread 0:
    0   libsystem_kernel.dylib            0x00000001824b3e08 0x1824b3000 + 3592
    1   libsystem_kernel.dylib            0x00000001824b3c80 0x1824b3000 + 3200
    2   CoreFoundation                    0x00000001829f6e40 0x182909000 + 974400
    3   CoreFoundation                    0x00000001829f4908 0x182909000 + 964872
    4   CoreFoundation                    0x0000000182914da8 0x182909000 + 48552
    5   GraphicsServices                  0x00000001848f7020 0x1848ec000 + 45088
    6   UIKit                             0x000000018c8f578c 0x18c5d8000 + 3266444
    7   MobileSMS                         0x0000000100e1867c 0x100df8000 + 132732
    8   libdyld.dylib                     0x00000001823a5fc0 0x1823a5000 + 4032
    ....
    Thread 6 name:  Dispatch queue: com.apple.ResponseKit
    Thread 6 Crashed:
    0   CoreFoundation                    0x0000000182922efc 0x182909000 + 106236
    1   CoreEmoji                         0x00000001886b2354 0x1886a6000 + 50004
    2   CoreEmoji                         0x00000001886b2354 0x1886a6000 + 50004
    3   CoreEmoji                         0x00000001886b2c80 0x1886a6000 + 52352
    4   CoreEmoji                         0x00000001886a8ebc 0x1886a6000 + 11964
    5   ResponseKit                       0x00000001968754ac 0x19683d000 + 230572
    6   ResponseKit                       0x0000000196872e9c 0x19683d000 + 220828
    7   ResponseKit                       0x00000001968739b4 0x19683d000 + 223668
    8   ResponseKit                       0x0000000196862e78 0x19683d000 + 155256
    9   ResponseKit                       0x0000000196862c00 0x19683d000 + 154624
    10  ResponseKit                       0x00000001968619f0 0x19683d000 + 150000
    11  libdispatch.dylib                 0x0000000182340b24 0x18233f000 + 6948
    12  libdispatch.dylib                 0x0000000182340ae4 0x18233f000 + 6884
    13  libdispatch.dylib                 0x000000018234aa38 0x18233f000 + 47672
    14  libdispatch.dylib                 0x000000018234b380 0x18233f000 + 50048
    15  libdispatch.dylib                 0x000000018234bd4c 0x18233f000 + 52556
    16  libdispatch.dylib                 0x000000018235411c 0x18233f000 + 86300
    17  libsystem_pthread.dylib           0x0000000182673e70 0x182673000 + 3696
    18  libsystem_pthread.dylib           0x0000000182673b08 0x182673000 + 2824
    Thread 6 crashed with ARM Thread State (64-bit):
        x0: 0x0000000000000000   x1: 0x00000001add1ad38   x2: 0x0000000000000000   x3: 0x00000001ad364438
        x4: 0x0000000000000000   x5: 0x0000000000000001   x6: 0x0000000000000000   x7: 0x0000000000000000
        x8: 0x0000000000000000   x9: 0x00000001b4e15930  x10: 0x0000000ffffffff8  x11: 0x0000000000000040
       x12: 0xffffffffffffffff  x13: 0x0000000000000001  x14: 0x0000000000000000  x15: 0x00002d0000002d00
       x16: 0x0000000000000000  x17: 0x0000000000002d00  x18: 0x0000000000000000  x19: 0x0000000000000000
       x20: 0x00000001add1ad38  x21: 0x0000000000000000  x22: 0x0000000000000000  x23: 0x00000001c4864cc0
       x24: 0x00000001000404ef  x25: 0x0000000000050000  x26: 0x0000000103d059e4  x27: 0x0000000103d059e4
       x28: 0x0000000000000000   fp: 0x000000016f1a5b20   lr: 0x00000001886b2354
        sp: 0x000000016f1a5b00   pc: 0x0000000182922efc cpsr: 0x80000000
    Binary Images:
    0x100df8000 - 0x100e43fff MobileSMS arm64   /Applications/MobileSMS.app/MobileSMS
    0x182909000 - 0x182c9ffff CoreFoundation arm64   /System/Library/Frameworks/CoreFoundation.framework/CoreFoundation
    0x1886a6000 - 0x1886b7fff CoreEmoji arm64   /System/Library/PrivateFrameworks/CoreEmoji.framework/CoreEmoji
    0x19683d000 - 0x19693ffff ResponseKit arm64   /System/Library/PrivateFrameworks/ResponseKit.framework/ResponseKit
我们将更详细地讨论这个问题，但是简单说就是在地址0x00000000000000处发生一个EXC_BAD_ACCESS (SIGSEGV)
(Exception Subtype: KERN_INVALID_ADDRESS)。
这类崩溃通常表示空指针解引用（NULL-pointer
dereference）。在这里，这个错误似乎是在iOS执行某种类型的表情处理时触发的(这与iMessenger接收到的台湾标志的触发相吻合)。
iOS系统崩溃报告中的其他相关信息包括：
  * 故障指令地址(0x0000000182922efc)
  * 崩溃前线程(#6)的调用堆栈
  * 相关的dylib(即调用堆栈中的那些)
## 崩溃分析
我们的目标是现在追查崩溃的原因。也就是说，为什么0x0000000182922efc上的指令取消引用一个空指针？
我们将从反转调用堆栈中出现的动态库(ResponseKit、CoreEmoji和CoreFoundation)开始。具体来说，我们将检查在调用堆栈中出现的这些dylib中的地址的代码。
因为我朋友的手机没有越狱，所以我们只能从设备中获取dylib二进制文件.我们必须从其他地方获取它们。事实证明，最简单的是来自于iOS
11.3的恢复映像。这类还原映像包含iOS系统二进制文件，例如我们要寻找的dylib。我们可以从[ipsw.me](https://ipsw.me/iPhone9,1)获取iOS
11.3还原映像(iPhone_4.7_P3_11.0_11.3_15E216_Restore.ipsw）
下载这个文件后，我们就可以通过hdiutil命令挂载058-97716-127.dmg磁盘映像：
    $ hdiutil attach iPhone_4.7_P3_11.0_11.3_15E216_Restore/058-97716-127.dmg expected CRC32 $BDE79F12 /dev/disk2 GUID_partition_scheme
    /dev/disk2s1 EFI
    /dev/disk2s2 Apple_APFS
    /dev/disk3 EF57347C-0000-11AA-AA11-0030654 /dev/disk3s1 41504653-0000-11AA-AA11-0030654 /Volumes/Emet15E216.D10D101D20D201OS
[](https://p3.ssl.qhimg.com/t01f8550a2e63f8e593.png)
由于我们要寻找的dylib被嵌入到dyld共享缓存(dyld_shared_cache_arm64)中，所以我们必须提取它们。
使用[jtool](http://www.newosxbook.com/tools/jtool.html)，这是最直接的，只需指定要提取的dylib的名称(例如CoreEmoji)，然后指定共享缓存的路径：
    jtool -e "CoreEmoji" /Volumes/Emet15E216.D10D101D20D201OS/System/Library/Caches/com.apple.dyld/dyld_shared_cache_arm64
    Extracting /System/Library/PrivateFrameworks/CoreEmoji.framework/CoreEmoji at 0x6b4e000 into dyld_shared_cache_arm64.CoreEmoji
提取了以下dylib(在崩溃线程的调用堆栈中分别引用了这些dylib)：
    yld_shared_cache_arm64_CoreEmoji
    version: 69.3.0
    sha1: 20F6BECF7C76A3FEAFEB8D2321F593388A3CB9B6
    dyld_shared_cache_arm64_CoreFoundation
    version: 1452.23.0
    sha1: AD3A226884BB3612694B9AB37DF18F42452D5139
    dyld_shared_cache_arm64_ResponseKit
    version 109.0.0
    sha1: BDA7F1F329321C20539499EAF1C36693823CF60E
不幸的是，我们必须符号化这些dylib，因为他们的大多数符号都被“编辑”了：
    $ nm dyld_shared_cache_arm64_ResponseKit
    0000000194ce6f9c t 