# iOS è¡¨æƒ…ç¬¦å·æ‹’ç»æœåŠ¡æ¼æ´è¯¦æƒ…æŠ«éœ²(CVE-2018-4290)
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« ï¼Œæ–‡ç« æ¥æºï¼šobjective-see.com
åŸæ–‡åœ°å€ï¼š
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
## å‰è¨€
åœ¨æˆ‘ä»¬æ·±å…¥è®¨è®ºä¹‹å‰ï¼Œè¯·æ³¨æ„ï¼š
  * è¿™ä¸ªbugåªæ˜¯æ‹’ç»æœåŠ¡(ç›¸å¯¹äºè¿œç¨‹ç¼–ç æ‰§è¡Œ)ã€‚
  * è¿™ä¸ªbugä»…å½±å“æŸäº›â€œæ— åŒºåŸŸâ€é…ç½®ä¸­çš„iOSè®¾å¤‡ã€‚
  * è¿™ä¸ªbugåœ¨iOS 11.4.1å·²è¢«ä¿®è¡¥ä¸ºCVE-2018-4290ã€‚
è¯è™½å¦‚æ­¤ï¼Œè¿™ä¸ªbugè¿˜æ˜¯å¯ä»¥è¿œç¨‹è§¦å‘çš„ï¼Œè€Œä¸”å¯ä»¥å¯¼è‡´å—å½±å“çš„è®¾å¤‡ä¸Šä»»ä½•æ­£åœ¨å¤„ç†è¿œç¨‹æ¶ˆæ¯(iMessageã€Facebook
Messengerã€WhatsAppç­‰)çš„iOSåº”ç”¨ç¨‹åºéƒ½ä¼šå´©æºƒï¼
## èƒŒæ™¯
â€œPatrickï¼Œæˆ‘æƒ³ä¸­å›½é»‘äº†æˆ‘çš„iPhoneâ€
è™½ç„¶æˆ‘é€šå¸¸ä¼šå¯¹è¿™ç§éš¾ä»¥ç½®ä¿¡çš„æƒ…æ™¯ä¸€ç¬‘ç½®ä¹‹ï¼Œä½†æˆ‘æ­£åœ¨ç ”ç©¶æˆ‘çš„æƒ…ç»ªæ™ºåŠ›ï¼Œè€å¿ƒåœ°è¯¢é—®ä¸ºä»€ä¹ˆæˆ‘çš„å°æ¹¾æœ‹å‹ä¼šè¿™æ ·æƒ³ã€‚
å¥¹å£°ç§°ï¼Œæ¯å½“å¥¹è¾“å…¥å°æ¹¾æˆ–æ›´ç³Ÿçš„è¯æ—¶ï¼Œéƒ½ä¼šæ”¶åˆ°ä¸€æ¡å¸¦æœ‰å°æ¹¾æ——å¸œ(ğŸ‡¹ğŸ‡¼)çš„æ¶ˆæ¯ï¼Œè¿™ä¼šè®©å¥¹çš„iOSè®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºå´©æºƒã€‚
æˆ‘ä»ç„¶æœ‰ç‚¹æ€€ç–‘ï¼Œä½†å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ­£æ˜¯æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ï¼
[](https://p2.ssl.qhimg.com/t0193232448c1a23a32.gif)
æˆ‘ç»™å¥¹å‘äº†å¤šä¸ªå°æ¹¾æ——å¸œï¼Œå¯¼è‡´å¥¹çš„iMessageã€Facebook Messengerå’ŒWhatsAppæŒç»­å´©æºƒã€‚ğŸ¤£
åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¯´æ˜å¦‚ä½•åˆ†æå’Œè·Ÿè¸ªè¿™ä¸ªè¿œç¨‹iOSç¼ºé™·çš„æ ¹æœ¬åŸå› ã€‚
## å´©æºƒ
å´©æºƒçš„è®¾å¤‡æ˜¯è¿è¡ŒiOS 11.3(å½“æ—¶æœ€æ–°ç‰ˆæœ¬çš„iOS)çš„iPhone 7ï¼š
    Device: iPhone 7, iPhone9,1 (US)
    iOS: 11.3 (15E216)
    Language: English, followed by Chinese
    Region: United States
    Jailbroken: No
ä»¥ä¸‹æ˜¯iMessenger(MobileSMS)æä¾›çš„ç»è¿‡åˆ å‡çš„å´©æºƒæŠ¥å‘Šã€‚å®ƒæ˜¯ä»è®¾å¤‡(é€šè¿‡Settings -> Privacy, Analytics,
Analytics Data)è·å–çš„ï¼š
    {"app_name":"MobileSMS","timestamp":"2018-04-18 22:27:25.13 -0700","app_version":"5.0",  
    "slice_uuid":"feac9bde-20a2-37c2-86e0-119fb8b9b650","adam_id":0,"build_version":"1.0",  
    "bundleID":"com.apple.MobileSMS","share_with_app_devs":false,"is_first_party":true,  
    "bug_type":"109","os_version":"iPhone OS 11.3  
     (15E216)","incident_id":"9EE5610B-7A0C-4558-895F-CF876DEB6B07","name":"MobileSMS"}  
    Incident Identifier: 9EE5610B-7A0C-4558-895F-CF876DEB6B07
    CrashReporter Key:   69340bb1126c092b97b9af069f4f6f037466ee0c
    Hardware Model:      iPhone9,1
    Process:             MobileSMS [10417]
    Path:                /Applications/MobileSMS.app/MobileSMS
    Identifier:          com.apple.MobileSMS
    Version:             1.0 (5.0)
    Code Type:           ARM-64 (Native)
    Role:                Foreground
    Parent Process:      launchd [1]
    Coalition:           com.apple.MobileSMS [2015]
    Date/Time:           2018-04-18 22:27:24.9896 -0700
    Launch Time:         2018-04-18 22:26:16.9044 -0700
    OS Version:          iPhone OS 11.3 (15E216)
    Baseband Version:    3.66.00
    Report Version:      104
    Exception Type:  EXC_BAD_ACCESS (SIGSEGV)
    Exception Subtype: KERN_INVALID_ADDRESS at 0x0000000000000000
    Termination Signal: Segmentation fault: 11
    Termination Reason: Namespace SIGNAL, Code 0xb
    Terminating Process: exc handler [0]
    Triggered by Thread:  6
    Filtered syslog:
    None found
    Thread 0 name:  Dispatch queue: com.apple.main-thread
    Thread 0:
    0   libsystem_kernel.dylib            0x00000001824b3e08 0x1824b3000 + 3592
    1   libsystem_kernel.dylib            0x00000001824b3c80 0x1824b3000 + 3200
    2   CoreFoundation                    0x00000001829f6e40 0x182909000 + 974400
    3   CoreFoundation                    0x00000001829f4908 0x182909000 + 964872
    4   CoreFoundation                    0x0000000182914da8 0x182909000 + 48552
    5   GraphicsServices                  0x00000001848f7020 0x1848ec000 + 45088
    6   UIKit                             0x000000018c8f578c 0x18c5d8000 + 3266444
    7   MobileSMS                         0x0000000100e1867c 0x100df8000 + 132732
    8   libdyld.dylib                     0x00000001823a5fc0 0x1823a5000 + 4032
    ....
    Thread 6 name:  Dispatch queue: com.apple.ResponseKit
    Thread 6 Crashed:
    0   CoreFoundation                    0x0000000182922efc 0x182909000 + 106236
    1   CoreEmoji                         0x00000001886b2354 0x1886a6000 + 50004
    2   CoreEmoji                         0x00000001886b2354 0x1886a6000 + 50004
    3   CoreEmoji                         0x00000001886b2c80 0x1886a6000 + 52352
    4   CoreEmoji                         0x00000001886a8ebc 0x1886a6000 + 11964
    5   ResponseKit                       0x00000001968754ac 0x19683d000 + 230572
    6   ResponseKit                       0x0000000196872e9c 0x19683d000 + 220828
    7   ResponseKit                       0x00000001968739b4 0x19683d000 + 223668
    8   ResponseKit                       0x0000000196862e78 0x19683d000 + 155256
    9   ResponseKit                       0x0000000196862c00 0x19683d000 + 154624
    10  ResponseKit                       0x00000001968619f0 0x19683d000 + 150000
    11  libdispatch.dylib                 0x0000000182340b24 0x18233f000 + 6948
    12  libdispatch.dylib                 0x0000000182340ae4 0x18233f000 + 6884
    13  libdispatch.dylib                 0x000000018234aa38 0x18233f000 + 47672
    14  libdispatch.dylib                 0x000000018234b380 0x18233f000 + 50048
    15  libdispatch.dylib                 0x000000018234bd4c 0x18233f000 + 52556
    16  libdispatch.dylib                 0x000000018235411c 0x18233f000 + 86300
    17  libsystem_pthread.dylib           0x0000000182673e70 0x182673000 + 3696
    18  libsystem_pthread.dylib           0x0000000182673b08 0x182673000 + 2824
    Thread 6 crashed with ARM Thread State (64-bit):
        x0: 0x0000000000000000   x1: 0x00000001add1ad38   x2: 0x0000000000000000   x3: 0x00000001ad364438
        x4: 0x0000000000000000   x5: 0x0000000000000001   x6: 0x0000000000000000   x7: 0x0000000000000000
        x8: 0x0000000000000000   x9: 0x00000001b4e15930  x10: 0x0000000ffffffff8  x11: 0x0000000000000040
       x12: 0xffffffffffffffff  x13: 0x0000000000000001  x14: 0x0000000000000000  x15: 0x00002d0000002d00
       x16: 0x0000000000000000  x17: 0x0000000000002d00  x18: 0x0000000000000000  x19: 0x0000000000000000
       x20: 0x00000001add1ad38  x21: 0x0000000000000000  x22: 0x0000000000000000  x23: 0x00000001c4864cc0
       x24: 0x00000001000404ef  x25: 0x0000000000050000  x26: 0x0000000103d059e4  x27: 0x0000000103d059e4
       x28: 0x0000000000000000   fp: 0x000000016f1a5b20   lr: 0x00000001886b2354
        sp: 0x000000016f1a5b00   pc: 0x0000000182922efc cpsr: 0x80000000
    Binary Images:
    0x100df8000 - 0x100e43fff MobileSMS arm64   /Applications/MobileSMS.app/MobileSMS
    0x182909000 - 0x182c9ffff CoreFoundation arm64   /System/Library/Frameworks/CoreFoundation.framework/CoreFoundation
    0x1886a6000 - 0x1886b7fff CoreEmoji arm64   /System/Library/PrivateFrameworks/CoreEmoji.framework/CoreEmoji
    0x19683d000 - 0x19693ffff ResponseKit arm64   /System/Library/PrivateFrameworks/ResponseKit.framework/ResponseKit
æˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ç®€å•è¯´å°±æ˜¯åœ¨åœ°å€0x00000000000000å¤„å‘ç”Ÿä¸€ä¸ªEXC_BAD_ACCESS (SIGSEGV)
(Exception Subtype: KERN_INVALID_ADDRESS)ã€‚
è¿™ç±»å´©æºƒé€šå¸¸è¡¨ç¤ºç©ºæŒ‡é’ˆè§£å¼•ç”¨ï¼ˆNULL-pointer
dereferenceï¼‰ã€‚åœ¨è¿™é‡Œï¼Œè¿™ä¸ªé”™è¯¯ä¼¼ä¹æ˜¯åœ¨iOSæ‰§è¡ŒæŸç§ç±»å‹çš„è¡¨æƒ…å¤„ç†æ—¶è§¦å‘çš„(è¿™ä¸iMessengeræ¥æ”¶åˆ°çš„å°æ¹¾æ ‡å¿—çš„è§¦å‘ç›¸å»åˆ)ã€‚
iOSç³»ç»Ÿå´©æºƒæŠ¥å‘Šä¸­çš„å…¶ä»–ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼š
  * æ•…éšœæŒ‡ä»¤åœ°å€(0x0000000182922efc)
  * å´©æºƒå‰çº¿ç¨‹(#6)çš„è°ƒç”¨å †æ ˆ
  * ç›¸å…³çš„dylib(å³è°ƒç”¨å †æ ˆä¸­çš„é‚£äº›)
## å´©æºƒåˆ†æ
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ç°åœ¨è¿½æŸ¥å´©æºƒçš„åŸå› ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºä»€ä¹ˆ0x0000000182922efcä¸Šçš„æŒ‡ä»¤å–æ¶ˆå¼•ç”¨ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Ÿ
æˆ‘ä»¬å°†ä»åè½¬è°ƒç”¨å †æ ˆä¸­å‡ºç°çš„åŠ¨æ€åº“(ResponseKitã€CoreEmojiå’ŒCoreFoundation)å¼€å§‹ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥åœ¨è°ƒç”¨å †æ ˆä¸­å‡ºç°çš„è¿™äº›dylibä¸­çš„åœ°å€çš„ä»£ç ã€‚
å› ä¸ºæˆ‘æœ‹å‹çš„æ‰‹æœºæ²¡æœ‰è¶Šç‹±ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ä»è®¾å¤‡ä¸­è·å–dylibäºŒè¿›åˆ¶æ–‡ä»¶.æˆ‘ä»¬å¿…é¡»ä»å…¶ä»–åœ°æ–¹è·å–å®ƒä»¬ã€‚äº‹å®è¯æ˜ï¼Œæœ€ç®€å•çš„æ˜¯æ¥è‡ªäºiOS
11.3çš„æ¢å¤æ˜ åƒã€‚è¿™ç±»è¿˜åŸæ˜ åƒåŒ…å«iOSç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦å¯»æ‰¾çš„dylibã€‚æˆ‘ä»¬å¯ä»¥ä»[ipsw.me](https://ipsw.me/iPhone9,1)è·å–iOS
11.3è¿˜åŸæ˜ åƒ(iPhone_4.7_P3_11.0_11.3_15E216_Restore.ipswï¼‰
ä¸‹è½½è¿™ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡hdiutilå‘½ä»¤æŒ‚è½½058-97716-127.dmgç£ç›˜æ˜ åƒï¼š
    $ hdiutil attach iPhone_4.7_P3_11.0_11.3_15E216_Restore/058-97716-127.dmg expected CRC32 $BDE79F12 /dev/disk2 GUID_partition_scheme
    /dev/disk2s1 EFI
    /dev/disk2s2 Apple_APFS
    /dev/disk3 EF57347C-0000-11AA-AA11-0030654 /dev/disk3s1 41504653-0000-11AA-AA11-0030654 /Volumes/Emet15E216.D10D101D20D201OS
[](https://p3.ssl.qhimg.com/t01f8550a2e63f8e593.png)
ç”±äºæˆ‘ä»¬è¦å¯»æ‰¾çš„dylibè¢«åµŒå…¥åˆ°dyldå…±äº«ç¼“å­˜(dyld_shared_cache_arm64)ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»æå–å®ƒä»¬ã€‚
ä½¿ç”¨[jtool](http://www.newosxbook.com/tools/jtool.html)ï¼Œè¿™æ˜¯æœ€ç›´æ¥çš„ï¼Œåªéœ€æŒ‡å®šè¦æå–çš„dylibçš„åç§°(ä¾‹å¦‚CoreEmoji)ï¼Œç„¶åæŒ‡å®šå…±äº«ç¼“å­˜çš„è·¯å¾„ï¼š
    jtool -e "CoreEmoji" /Volumes/Emet15E216.D10D101D20D201OS/System/Library/Caches/com.apple.dyld/dyld_shared_cache_arm64
    Extracting /System/Library/PrivateFrameworks/CoreEmoji.framework/CoreEmoji at 0x6b4e000 into dyld_shared_cache_arm64.CoreEmoji
æå–äº†ä»¥ä¸‹dylib(åœ¨å´©æºƒçº¿ç¨‹çš„è°ƒç”¨å †æ ˆä¸­åˆ†åˆ«å¼•ç”¨äº†è¿™äº›dylib)ï¼š
    yld_shared_cache_arm64_CoreEmoji
    version: 69.3.0
    sha1: 20F6BECF7C76A3FEAFEB8D2321F593388A3CB9B6
    dyld_shared_cache_arm64_CoreFoundation
    version: 1452.23.0
    sha1: AD3A226884BB3612694B9AB37DF18F42452D5139
    dyld_shared_cache_arm64_ResponseKit
    version 109.0.0
    sha1: BDA7F1F329321C20539499EAF1C36693823CF60E
ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»ç¬¦å·åŒ–è¿™äº›dylibï¼Œå› ä¸ºä»–ä»¬çš„å¤§å¤šæ•°ç¬¦å·éƒ½è¢«â€œç¼–è¾‘â€äº†ï¼š
    $ nm dyld_shared_cache_arm64_ResponseKit
    0000000194ce6f9c t 