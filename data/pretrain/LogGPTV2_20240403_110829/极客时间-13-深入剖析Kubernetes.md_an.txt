## 思考题1.  在 Linux 上为一个类似 kube-apiserver 的 Web Server    制作证书，你知道可以用哪些工具实现吗？2.  回忆一下我在前面文章中分享的 Kubernetes 架构，你能够说出 Kubernetes    各个功能组件之间（包含    Etcd），都有哪些建立连接或者调用的方式吗？（比如：HTTP/HTTPS，远程调用等等）感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。![](Images/e870b7df0db49509e735e6becd4a9a9a.png){savepage-src="https://static001.geekbang.org/resource/image/47/55/47a6f3bf6b92d58512d5a2ed0a556f55.jpg"}
# 11 \| 从0到1：搭建一个完整的Kubernetes集群你好，我是张磊。今天我和你分享的主题是：从 0 到 1 搭建一个完整的Kubernetes 集群。在上一篇文章中，我介绍了 kubeadm 这个 Kubernetes半官方管理工具的工作原理。既然 kubeadm 的初衷是让 Kubernetes集群的部署不再让人头疼，那么这篇文章，我们就来使用它部署一个完整的Kubernetes 集群吧。> 备注：这里所说的"完整"，指的是这个集群具备 Kubernetes 项目在 GitHub> 上已经发布的所有功能，并能够模拟生产环境的所有使用需求。但并不代表这个集群是生产级别可用的：类似于高可用、授权、多租户、灾难备份等生产级别集群的功能暂时不在本篇文章的讨论范围。\> 目前，kubeadm> 的高可用部署[已经有了第一个发布](https://kubernetes.io/docs/setup/independent/high-availability/)。但是，这个特性还没有> GA（生产可用），所以包括了大量的手动工作，跟我们所预期的一键部署还有一定距离。GA> 的日期预计是 2018 年底到 2019> 年初。届时，如果有机会我会再和你分享这部分内容。这次部署，我不会依赖于任何公有云或私有云的能力，而是完全在 Bare-metal环境中完成。这样的部署经验会更有普适性。而在后续的讲解中，如非特殊强调，我也都会以本次搭建的这个集群为基础。``{=html}
## 准备工作首先，准备机器。最直接的办法，自然是到公有云上申请几个虚拟机。当然，如果条件允许的话，拿几台本地的物理服务器来组集群是最好不过了。这些机器只要满足如下几个条件即可：1.  满足安装 Docker 项目所需的要求，比如 64 位的 Linux 操作系统、3.10    及以上的内核版本；2.  x86 或者 ARM 架构均可；3.  机器之间网络互通，这是将来容器之间网络互通的前提；4.  有外网访问权限，因为需要拉取镜像；5.  能够访问到`gcr.io、quay.io`这两个 docker    registry，因为有小部分镜像需要在这里拉取；6.  单机可用资源建议 2 核 CPU、8 GB    内存或以上，再小的话问题也不大，但是能调度的 Pod 数量就比较有限了；7.  30 GB 或以上的可用磁盘空间，这主要是留给 Docker 镜像和日志文件用的。在本次部署中，我准备的机器配置如下：1.  2 核 CPU、 7.5 GB 内存；2.  30 GB 磁盘；3.  Ubuntu 16.04；4.  内网互通；5.  外网访问权限不受限制。> 备注：在开始部署前，我推荐你先花几分钟时间，回忆一下 Kubernetes> 的架构。然后，我再和你介绍一下今天实践的目标：1.  在所有节点上安装 Docker 和 kubeadm；2.  部署 Kubernetes Master；3.  部署容器网络插件；4.  部署 Kubernetes Worker；5.  部署 Dashboard 可视化插件；6.  部署容器存储插件。好了，现在，就来开始这次集群部署之旅吧！
## 安装 kubeadm 和 Docker我在上一篇文章《 Kubernetes 一键部署利器：kubeadm》中，已经介绍过kubeadm 的基础用法，它的一键安装非常方便，我们只需要添加 kubeadm的源，然后直接使用 apt-get 安装即可，具体流程如下所示：> 备注：为了方便讲解，我后续都直接会在 root 用户下进行操作    $ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -$ cat  /etc/apt/sources.list.d/kubernetes.listdeb http://apt.kubernetes.io/ kubernetes-xenial mainEOF$ apt-get update$ apt-get install -y docker.io kubeadm在上述安装 kubeadm 的过程中，kubeadm 和 kubelet、kubectl、kubernetes-cni这几个二进制文件都会被自动安装好。另外，这里我直接使用 Ubuntu 的 docker.io 的安装源，原因是 Docker公司每次发布的最新的 Docker CE（社区版）产品往往还没有经过 Kubernetes项目的验证，可能会有兼容性方面的问题。