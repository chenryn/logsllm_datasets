    doEndTag:43, ComponentTagSupport (org.apache.struts2.views.jsp)
    _jspx_meth_s_005ftextfield_005f1:16, index_jsp (org.apache.jsp)
    _jspx_meth_s_005fform_005f0:16, index_jsp (org.apache.jsp)
    _jspService:14, index_jsp (org.apache.jsp)
    service:70, HttpJspBase (org.apache.jasper.runtime)
    service:742, HttpServlet (javax.servlet.http)
    ...
å‘é€è¯·æ±‚ï¼ŒFilterDispatcher.doFilterè¢«è§¦å‘ï¼Œè¿™å…¶ä¸­è°ƒç”¨FilterDispatcher.serviceActionï¼Œ
invokeActionè°ƒç”¨äº†actionï¼ˆLoginActionï¼‰çš„methodï¼ˆexecuteï¼‰ï¼Œ
ç»§ç»­è¿è¡Œï¼Œæ–­åœ¨LoginAction.execute()ï¼Œ
æ˜¾ç„¶ï¼Œusernameä¸ä¸ºadminï¼Œè¡¨å•éªŒè¯å¤±è´¥ï¼Œæ­¤æ—¶Strust2é»˜è®¤ä¼šè°ƒç”¨translateVariablesæ–¹æ³•å¯¹æ ‡ç­¾ä¸­è¡¨å•åè¿›è¡ŒOGNLè¡¨è¾¾å¼é€’å½’è§£æè¿”å›ValueStackå€¼æ ˆä¸­åŒåå±æ€§çš„å€¼ã€‚
ä¸­é—´æœ‰è‹¥å¹²åº•å±‚æµç¨‹ï¼Œç•¥è¿‡ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨doStartTag()ä¸‹æ–­ï¼Œ
æœ¬å‡½æ•°çš„åŠŸèƒ½æ˜¯å¼€å§‹è§£ææ ‡ç­¾ï¼Œ
ç»§ç»­å‘ä¸‹ï¼Œå¼€å§‹åŠ è½½ç¬¬ä¸€ä¸ªTextFieldï¼Œ
æ¥ä¸‹æ¥å¦‚æœé…ç½®æ­£ç¡®ï¼ˆæˆ‘åæ­£æ²¡æœ‰é…ç½®æ­£ç¡®ğŸ˜¥ï¼Œåªèƒ½çœ‹åˆ°ä¸‹å›¾ï¼‰ï¼Œåº”è¯¥ä¼šè¿›å…¥jspé¡µé¢ä¸­ï¼Œä¾¿å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°jspé¡µé¢è¢«é€æ ‡ç­¾è§£æã€‚
å½“åŠ è½½åˆ°`/>`æ—¶ï¼Œä¼šè¿›å…¥doEndTag()å‡½æ•°ï¼Œä»åå­—å¯ä»¥åˆ¤æ–­ï¼Œæ­¤å‡½æ•°çš„åŠŸèƒ½å¤§æ¦‚æ˜¯å®Œæˆå¯¹ä¸€ä¸ªæ ‡ç­¾çš„è§£æï¼Œå› ä¸ºè°ƒè¯•æ—¶payloadæ”¾åœ¨äº†passwordé‡Œé¢ï¼Œå› è€Œæ­¤å¤„å¯¹äºusernameçš„è§£æä¸è¿‡å±•ç¤ºã€‚
æ­¤æ—¶å‰é¢çš„tagå·²ç»è¢«å±•ç¤ºå‡ºæ¥ï¼Œæœªè¿›å…¥doStartTagçš„passwordå­—æ®µæ²¡æœ‰æ˜¾ç¤ºã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬å¿«è¿›åˆ°ç¬¬äºŒä¸ªTextFieldï¼ˆpasswordï¼‰çš„doEndTag()ã€‚
è·Ÿè¿›this.component.end()ï¼Œè¿›å…¥äº†`org.apache.struts2.components.UIBean#end`ï¼Œ
è·Ÿè¿›this.evaluateParams();ï¼Œ
å¿«è¿›åˆ°this.altSyntax()å¤„ï¼Œ
å‰é¢æåˆ°ï¼ŒaltSyntaxé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œæ¥ä¸‹æ¥çš„expræ˜¾è€Œæ˜“è§ä¸º%{password}ï¼Œ
è·Ÿè¿›this.findValue(expr, valueClazz)ï¼Œ
ç”±å‰é¢å¯çŸ¥ï¼ŒTextField çš„valueClassTypeä¸ºclass java.lang.Stringï¼Œä¸”altSyntaxé»˜è®¤å¼€å¯ï¼Œ
å› æ­¤å°†ä¼šè¿›å…¥TextParseUtil.translateVariables(â€˜%â€™, expr, this.stack);ï¼Œ
æ­¥å…¥ï¼Œè¿›å…¥translateVariablesï¼Œ
äºŒçº§æ­¥å…¥ï¼Œå°†è¿›å…¥è°ƒè¯•çš„ä¸»ä½“éƒ¨åˆ†`translateVariables(char open, String expression, ValueStack
stack, Class asType, TextParseUtil.ParsedValueEvaluator evaluator)`ï¼Œ
æ­¤å¤„ä¼ å…¥çš„expressionä¸º%{password}ï¼Œ
æ¥ä¸‹æ¥çš„whileå¾ªç¯çš„ç›®çš„æ˜¯ç¡®å®šstartå’Œendçš„ä½ç½®ï¼Œ
æ­¤å¤„æ˜¾ç„¶ä¸ä¼šè¿›å…¥ifï¼Œ
æ¥ä¸‹æ¥ï¼Œå–å‡º%{}è¡¨è¾¾å¼ä¸­çš„å€¼ï¼Œèµ‹å€¼ç»™varï¼Œ
ç„¶åè°ƒç”¨`stack.findValue(var,
asType)`ï¼Œç”±å‰é¢å¯çŸ¥ï¼Œæ­¤å¤„çš„stackä¸º`OgnlValueStack`ï¼Œ`OgnlValueStack`æ˜¯[ValueStack](https://blog.csdn.net/qq_44757034/article/details/106838688)çš„å®ç°ç±»ã€‚
valueStackæ˜¯struts2çš„å€¼æ ˆç©ºé—´ï¼Œæ˜¯struts2å­˜å‚¨æ•°æ®çš„ç©ºé—´ï¼Œæ˜¯ä¸€ä¸ªæ¥å£ï¼Œstruts2ä½¿ç”¨OGNLè¡¨è¾¾å¼å®é™…ä¸Šæ˜¯ä½¿ç”¨å®ç°äº†ValueStackæ¥å£çš„ç±»OgnlValueStackï¼ˆå®ƒæ˜¯ValueStackçš„é»˜è®¤å®ç°ç±»ï¼‰ã€‚
å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œstruts2ä¼šåˆ›å»ºä¸€ä¸ªActionå®ä¾‹åŒæ—¶åˆ›å»ºä¸€ä¸ªOgnlValueStackå€¼æ ˆå®ä¾‹ï¼ŒOgnlValueStackè´¯ç©¿æ•´ä¸ªActionçš„ç”Ÿå‘½å‘¨æœŸã€‚Struts2ä¸­ä½¿ç”¨OGNLå°†è¯·æ±‚Actionçš„å‚æ•°å°è£…ä¸ºå¯¹è±¡å­˜å‚¨åˆ°å€¼æ ˆä¸­ï¼Œå¹¶é€šè¿‡OGNLè¡¨è¾¾å¼è¯»å–å€¼æ ˆä¸­çš„å¯¹è±¡å±æ€§å€¼ã€‚
ValueStackä¸­æœ‰ä¸¤ä¸ªä¸»è¦åŒºåŸŸ
  * CompoundRoot åŒºåŸŸï¼šæ˜¯ä¸€ä¸ªArrayListï¼Œå­˜å‚¨äº†Actionå®ä¾‹ï¼Œå®ƒä½œä¸ºOgnlContextçš„Rootå¯¹è±¡ã€‚è·å–rootæ•°æ®ä¸éœ€è¦åŠ `#`
  * context åŒºåŸŸï¼šå³OgnlContextä¸Šä¸‹æ–‡ï¼Œæ˜¯ä¸€ä¸ªMapï¼Œæ”¾ç½®webå¼€å‘å¸¸ç”¨çš„å¯¹è±¡æ•°æ®çš„å¼•ç”¨ã€‚requestã€sessionã€parametersã€applicationç­‰ã€‚è·å–contextæ•°æ®éœ€è¦åŠ #
æ“ä½œå€¼æ ˆï¼Œé€šå¸¸æŒ‡çš„æ˜¯æ“ä½œValueStackä¸­çš„rootåŒºåŸŸã€‚
ValueStackç±»çš„setValueå’ŒfindValueæ–¹æ³•å¯ä»¥è®¾ç½®å’Œè·å¾—Actionå¯¹è±¡çš„å±æ€§å€¼ã€‚OgnlValueStackçš„findValueæ–¹æ³•å¯ä»¥åœ¨CompoundRootä¸­ä»æ ˆé¡¶å‘æ ˆåº•æ‰¾æŸ¥æ‰¾å¯¹è±¡çš„å±æ€§å€¼ã€‚
è·Ÿè¿›findValue()ï¼Œ
ç”±å‡½æ•°åå¯ä»¥æ¨æµ‹ï¼Œ è¿™ä¸€å‡½æ•°çš„åŠŸèƒ½æ˜¯æŸ¥æ‰¾exprå¯¹åº”çš„å€¼ï¼Œä¸”æ­¤å‡½æ•°æœ€ç»ˆè¦`return
value`ï¼Œæˆ‘ä»¬å¯ä»¥å¤§èƒ†è®¾æƒ³ï¼Œvalueå˜é‡æ˜¯æœ¬å‡½æ•°çš„é‡ç‚¹ï¼Œå¦‚æ­¤ï¼Œåˆ™éœ€è¦é‡ç‚¹å…³æ³¨å¯¹valueè¿›è¡Œæ“ä½œçš„å‡½æ•°OgnlUtil.getValueï¼Œ
è·Ÿè¿›ï¼Œ
compileå¯¹â€™passwordâ€™è¿›è¡Œè§£æï¼Œè¿”å›äº†é€‚ç”¨çš„ç»“æœã€‚
æ¥ä¸‹æ¥è·Ÿè¿›Ognl.getValueï¼Œçœ‹èµ·æ¥æ­¤å‡½æ•°ä¼šç»“åˆrootå’Œcontextè¿›è¡Œvalueçš„è·å–ã€‚
æ˜¾ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬è¦å…³æ³¨çš„æ˜¯resultå˜é‡ï¼Œè¿™å°±éœ€è¦è·Ÿè¿›((Node)tree).getValue(ognlContext, root)ã€‚
æ˜¾ç„¶ä¼šè¿›å…¥ä¸‹é¢çš„elseåˆ†æ”¯ï¼Œ
è·Ÿè¿›ä¹‹ï¼Œ
çœ‹èµ·æ¥ï¼Œç»å†äº†è‹¥å¹²çº§çš„è°ƒç”¨ï¼Œæœ€ç»ˆæœ‰æ•ˆçš„æ˜¯this.getValueBody(context, source)ï¼Œ
è·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°å†å‘ä¸‹è·Ÿè¿›æœ€ç»ˆæ˜¯å°†passwordå­—æ®µçš„å€¼åŠ è½½äº†è¿›æ¥ã€‚
ä¸å†æ·±å…¥è·Ÿè¿›äº†ï¼Œæ„Ÿè§‰å¥½åƒæ²¡ä»€ä¹ˆæ„ä¹‰äº†ğŸ˜¤ï¼Œæ­¤æ—¶å•å•getValueçš„è°ƒç”¨æ ˆå·²ç»æœ‰å‡ å±‚äº†ã€‚
    getProperty:1643, OgnlRuntime (ognl)getValueBody:92, ASTProperty (ognl)evaluateGetValueBody:170, SimpleNode (ognl)getValue:210, SimpleNode (ognl)getValue:333, Ognl (ognl)getValue:194, OgnlUtil (com.opensymphony.xwork2.util)findValue:238, OgnlValueStack (com.opensymphony.xwork2.util)
æ¥ä¸‹æ¥æ­¥å‡ºå‡ å±‚ï¼Œå›åˆ°translateVariables:122, TextParseUtil
(com.opensymphony.xwork2.util)ï¼Œ
æ¥ä¸‹æ¥ç»è¿‡æ‹¼æ¥æ“ä½œï¼Œexpressionè¢«èµ‹å€¼ï¼Œ
**2.é€’å½’è§£æéƒ¨åˆ†**
æˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œæ­¤whileå¾ªç¯åªæœ‰ä¸€ä¸ªå‡ºå£ï¼Œé‚£å°±æ˜¯if (start == -1 || end == -1 || count !=
0)ï¼Œå› æ­¤è¿™é‡Œè¿›è¡Œå®Œexpressionçš„èµ‹å€¼åï¼Œä¼šå¼€å¯æ–°çš„ä¸€è½®whileã€‚
è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒtranslateVariablesæ— æ„ä¹‹é—´é€’å½’è§£æäº†è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬çš„passwordå­—æ®µæ”¾ç½®äº†`%{"tomcatBinDir{"+[@java](https://github.com/java
"@java").lang.System[@getProperty](https://github.com/getProperty
"@getProperty")("user.dir")+"}"}`è¿™æ ·ä¸€ä¸ªåŒ…å«`%{expression}`çš„å­—ç¬¦ä¸²ï¼Œ%{password}çš„ç»“æœå°†å†æ¬¡è¢«å½“ä½œexpressionè§£æï¼Œå°±å¯èƒ½é€ æˆæ¶æ„ognlè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚
æ­¤æ¬¡å¾ªç¯ä¸­ï¼Œè¿›å…¥findValueçš„varæ˜¯å»æ‰å‰ä¸¤ä¸ªå­—ç¬¦çš„expressionï¼Œä¹Ÿå°±æ˜¯`tomcatBinDir{"+[@java](https://github.com/java
"@java").lang.System[@getProperty](https://github.com/getProperty
"@getProperty")("user.dir")+"}`ã€‚
æ¥ä¸‹æ¥è·Ÿè¿›findValue()ï¼Œè¿™é‡Œçš„æµç¨‹å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ï¼Œé‡ç‚¹åº”è¯¥è¿˜æ˜¯è·Ÿè¿›OgnlUtil.getValueï¼Œ
å’Œåˆšæ‰ç›¸åŒçš„æµç¨‹ï¼Œæ·±å…¥è·Ÿè¿›è‡³evaluateGetValueBody:170, SimpleNode (ognl)  
getValue:210, SimpleNode (ognl)ï¼Œ
è·Ÿè¿›ï¼Œ
åœ¨å¯¹äºç¬¬ä¸€è¡Œçš„getValue()è¿›è¡Œè·Ÿè¿›å‡ å±‚ä¹‹åï¼Œç»è¿‡äº†ä¸€äº›è¡¨è¾¾å¼æ‰§è¡Œçš„æ“ä½œï¼Œå¾—åˆ°äº†resultçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚
æ¥ä¸‹æ¥çš„forå¾ªç¯ï¼Œä¼šç»§ç»­æ‰§è¡Œå®Œæ•´è¡¨è¾¾å¼`%{"tomcatBinDir{"+[@java](https://github.com/java
"@java").lang.System[@getProperty](https://github.com/getProperty
"@getProperty")("user.dir")+"}"}`çš„å…¶ä»–éƒ¨åˆ†ã€‚
æ·±å…¥è·Ÿè¿›æ—¶ï¼Œå‘ç”Ÿäº†ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼Œ
è¿™é‡Œè°ƒç”¨äº†System.getProperty()ï¼Œå®é™…ä¸Šå®ç°äº†ä»£ç æ‰§è¡Œã€‚
å›åˆ°getValueBodyï¼Œæ­¤æ—¶resultå·²ç»è¢«addä¸Šäº†æ–°çš„ä¸€éƒ¨åˆ†ï¼Œ
å„éƒ¨åˆ†addä¹‹åï¼Œæœ€ç»ˆçš„resultå¦‚ä¸‹ã€‚
é€çº§æ­¥å‡ºï¼Œå›åˆ°TextParseUtil.translateVariablesï¼Œexpressionè¢«æ‹¼æ¥ä¸ºtomcatBinDir{/usr/local/tomcat}ï¼Œå¼€å¯ä¸€ä¸ªæ–°çš„å¾ªç¯ã€‚
ä½†æ˜¯æ­¤æ—¶ï¼Œopenä¸º%ï¼Œexpression.indexOf(open + â€œ{â€œ)ä¸º-1ï¼Œè€Œstartä¸º-1æ—¶ï¼Œå°†ä¼šreturnã€‚
ç®€å•è·Ÿè¿›ä¸€ä¸‹ï¼Œ
å¯ä»¥çŒœæµ‹ï¼Œè¿™é‡Œæ˜¯å°†Objectç±»å‹çš„oè½¬åŒ–ä¸ºæ™®é€šçš„å­—ç¬¦ä¸²ã€‚
æ¥ä¸‹æ¥ç®€å•æ­¥å‡ºï¼Œå¯å°†æµç¨‹ç»“æŸã€‚
## ä¸‰ã€æ”¶è·ä¸å¯ç¤º
å€ŸåŠ©å­¦ä¹ å’Œè°ƒè¯•ï¼Œäº†è§£äº†Struts2çš„è¿è½¬æµç¨‹ï¼Œç®€å•å­¦ä¹ äº†OGNLè¡¨è¾¾å¼ï¼Œå¢å¼ºäº†åˆ†æèƒ½åŠ›ã€‚
å‚è€ƒé“¾æ¥