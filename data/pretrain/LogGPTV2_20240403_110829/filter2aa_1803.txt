刘柏江
几维安全创始人兼CTO
IoT时代LLVM编译器防护的艺术
目录
万物互联，代码安全先行
01
传统代码保护、LLVM安全编译器
02
03
混淆、块调度、代码虚拟化
万物互联，安全先行
物理安全
防止丢失或者被盗
业务安全
防止用户隐私数据泄漏
系统安全
防止底层漏洞被恶意利用
策略安全
万物互联，代码安全先行
防逆向
打配合
提高门槛
争取时间
防止核心算法被重构
提升策略安全的强度
提高破解成本，将逆向菜鸟拒之门外
加大破解难度，延长破解时间，为
运营争取更多的有利窗口期
物联网时代即将开启
Android Things
让您可以为各种消费者，
零售和工业应用程序构
建智能互联设备。
AliOS Things
面向IoT领域的轻量级物
联网嵌入式操作系统，
可广泛应用在智能家居、
智慧城市、新出行等领
域。
DuerOS
可以广泛支持手机、电
视、音箱、汽车、机器
人等多种硬件设备
IoT.MI
小米IoT开发者平台面向
智能家居、智能家电、
健康可穿戴、出行车载
等领域
芯片体系越来越多
互联网
Windows／MacOS／Linux
x86
x86-64
移动互联网
iOS／Android
x86
arm
arm64
物联网
Android／AliOS Things
x86
x86-64
arm
arm64
mips
mips64 
stm32
avr
bpf
hexagon
lanai
nvptx
riscv
sparc
systemz
csky
运行内存越来越少
互联网
Windows／MacOS／Linux
256KB-1GB
移动互联网
iOS／Android
512MB-8GB
物联网
Android／AliOS Things
2GB-16GB
物联网操作系统运行环境
跑在种类繁多的芯片架构上
受限于功耗硬件性能低下
运行在内存一般偏小的环境
概念科普
黑盒代码加密
处理的对象是最终的软件执行体，比
如Windows的EXE、Android的SO
以及DEX
白盒代码加密
处 理 的 对 象 是 源 代 码 ， 比 如
C/C++/Objective-C / Swif t
这 类 语 言 的 源 代 码 文 件
黑盒代码加密的应用
比 如 适 用 于 Windows 、
Linux、Android的UPX壳
比如利用x86指令集的可变
长特性增加误导反汇编程序
的垃圾指令
比 如 Windows 非 常 著 名 的
VMProtect
比如Android的DEX整体加
解密、类抽取
A
C
B
D
加壳
加花指令
加虚拟机
劫持
运行时
黑盒代码加密的局限
可移植性差
兼容性差
很难对多端且同源的代码做一致性的保护
芯片架构不兼容、内存需求显著增加，
很难适应新的像IoT这样的平台
对于像Android这类高碎片化的平台，干预
运行时意味着兼容性极差
对于像iOS这类完全封闭的平台，干预运行
时意味着方案没法工作
LLVM编译器登场
前端
源代码
LLVM是模块化、可复用的编译器工具链集合，最初是伊利诺伊大学的一个研究项目，
其目标是提供一种现代的，基于SSA的编译策略，能够支持任意编程语言的静态和动态
编译。
IR处理
LLVM-IR
后端
LLVM-MIR
目标文件
Object
LLVM-IR
函数
模块
IR指令
基本块
LLVM提供了完整的IR文件操作API，可以对IR文件的模块、函数、基本块、IR指令做任意修改。
||
架构信息
全局数据
函数申明
函数实现
编译元数据
||
函数申明
变量申明
代码块
||
IR指令序列
||
算术指令
逻辑指令
控制指令
......
挖掘LLVM-IR的潜能
架构无关
可以适应任意芯片架构
方案丰富
可以满足任意要求的安全级别
函数粒度
可以适应低内存运行环境
初级防护
原始流程图
混淆流程图
高级防护
原始流程图
块调度流程图
代码虚拟化KIWIVM
KiwiVM代码虚拟化编译器基于LLVM编译器中间层实现，通过设计独有保密的虚拟CPU指令，将原始CPU指令进行加
密转换为只能由KiwiVM解释执行的虚拟指令，能够完全隐藏函数代码逻辑，让代码无法被逆向工程。
虚拟CPU执行
函数保护粒度
全平台全架构
100%兼容性
KIWIVM转换过程
LLVM-BC
源文件
Clang
KiwiVM
源文件
KiwiVM的中心思想是利用LLVM-BC编码成自定义虚拟CPU的指令集和元数据，包括指令集数据、重定位数据、函数调用
签名数据等。
||
C
C++
ObjC
||
BC函数列表
||
功能等价的C
||
生成最终的
Obj文件
KIWIVM转换样例
旗舰防护
原始流程图
虚拟机流程图
差异对比
混淆
块调度
代码虚拟化
结束之前
几维安全编译器产品简介
级别
功能
平台
混淆编译器
初级
代码膨胀
乱序执行
iOS、Android、IoT
块调度编译器
高级
逻辑断链
函数调用隐藏
iOS、Android、IoT
虚拟化编译器
旗舰级
逻辑隐藏
虚拟CPU执行
iOS、Android、IoT
谢 谢！