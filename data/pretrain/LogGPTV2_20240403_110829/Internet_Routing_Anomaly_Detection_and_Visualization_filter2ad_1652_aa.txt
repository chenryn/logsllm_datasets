title:Internet Routing Anomaly Detection and Visualization
author:Tina Wong and
Van Jacobson and
Cengiz Alaettinoglu
Internet Routing Anomaly Detection and Visualization
Tina Wong
Carnegie Mellon University
PI:EMAIL
Van Jacobson
Packet Design, Inc.
PI:EMAIL
Cengiz Alaettinoglu
Packet Design, Inc.
PI:EMAIL
Abstract
Diagnosing inter-domain routing problems in the Inter-
net is hard. BGP, the defacto inter-domain glue, is designed
for routing, not diagnosis. It is extremely chatty — the most
minor connectivity change produces hundreds of BGP mes-
sages and a major peering loss can generate millions —
and making sense of the deluge of data remains challeng-
ing. We have developed statistical techniques to extract the
large-scale structure of BGP events and visualization tech-
niques to display that structure in operationally meaningful
ways. These tools can be used to detect routing anomalies
in real-time. We show case studies of routing instabilities
at a Tier-1 ISP and a large institutional network, automat-
ically diagnosed by our tools. We present drawbacks in us-
ing BGP events alone to understand inter-domain routing,
and discuss how to solve them through the integration of
additional data sources.
1 Introduction
The Internet comprises of Autonomous Systems (ASs)
and relies on two-level routing:
intra-domain and inter-
domain. An AS is a collection of network resources under
the administrative control of a single entity. An AS can use
any Interior Gateway Protocol (IGP) for routing within its
network. ISPs usually run Open Shortest Path First (OSPF)
or Intermediate System to Intermediate System (ISIS) as
their IGPs, whereas enterprises commonly run Enhanced
Interior Gateway Routing Protocol (EIGRP) or OSPF. An
IGP can only route data from one point to another inside an
AS; it does not know routes to external ASs. Instead, an
AS runs the Border Gateway Protocol (BGP) [8], the de-
facto inter-domain routing glue, to facilitate connectivity to
the rest of the Internet. A BGP router peers with routers
in other ASs, and sends route announcement messages con-
taining reachability information to preﬁxes either originat-
ing from its own AS or from ASs for whom it is willing
Tina was a Member of Technical staff at Packet Design during the
duration of this work.
to transport trafﬁc. It also sends withdrawals when routes
become unreachable or infeasible. In inter-domain routing,
ASs can have different roles. An enterprise AS should not
allow outside networks to use itself as transit, while an ISP’s
business model is to provide that service. An AS achieves
this differentiation through conﬁguring routing policies. As
BGP announcements move along the Internet, routers at-
tach to them path attributes, for example, AS paths to de-
note the ASs traversed and community tags to distinguish
routes from one peer from another. Depending on its role,
an AS conﬁgures policies based on these attributes to ﬁlter
out or let in routes, as well as to carry out speciﬁc actions to
achieve its business goals.
Although the protocol itself is simple, the routing poli-
cies associated with BGP are complex. Various intricate
Internet routing behaviors are realized through conﬁguring
policies on many routers. The process is intensive and error-
prone. Serious misconﬁguration incidents have put BGP on
news headlines when main parts of the Internet went down
because of routing anomalies. Once, a small AS acciden-
tally announced the full Internet routing table with one-hop
AS paths, and most ASs started to prefer those routes be-
cause of the very short paths. Unintentionally, the small AS
became transit for majority of Internet trafﬁc. It was not
able to handle the avalanche, taking down the Internet with
it for many hours. A more common, day-to-day anomaly is
route hijacking, in which a BGP router announces reacha-
bility to preﬁxes it does not own nor able to route to, in ef-
fect black-holing the trafﬁc to those preﬁxes. Route hijack-
ing is usually the result of misconﬁgurations, for example, a
typo advertising the preﬁx 1.3.3.0/24 instead of 1.2.3.0/24.
But it can also be malicious, employed as a form of Denial-
of-Service attack. Some spammers announce preﬁxes be-
longing to legitimate organizations, dump spam trafﬁc, and
then withdraw the routes when done, in order to prevent
tracking and to place blame on others. Another anomaly
is route leakage, when a misconﬁgured BGP router mistak-
enly sends a lot of routes to a peer with limited resources,
which can completely melt down the peer router. Some
BGP dynamics can also severely affect routing stability, for
example, persistent route oscillation. Route oscillation not
only affects trafﬁc for the preﬁx involved, but also more
importantly, a router can become so busy processing rout-
ing messages for that one preﬁx, its CPU utilization pushed
to near 100%. Crucial real-time functions on the router can
suffer as a result, such as responding to IGP keepalives from
other routers required to maintain stable IGP routing.
In short, BGP can cause harm in multiple ways. Unfor-
tunately, carefully managing BGP is hard. The challenges
are multi-fold. BGP is designed to facilitate routing, not di-
agnosis. Take a peering session reset between two external
BGP peers (cid:0) and (cid:1) as an example. BGP does not send out
a message saying “peering between (cid:0) and (cid:1) has reset”. In-
stead, the protocol requires (cid:0) and (cid:1) to explicitly withdraw
previously advertised routes from each other before doing
full table exchanges to re-establish their session. These
withdrawals and subsequent announcements must be prop-
agated to both (cid:0)’s and (cid:1)’s neighbors, and their neighbors,
and so on. Moreover, the simplicity of BGP’s path vector
nature can trigger a long exploration process in which an
AS tries all invalid AS paths before convergence, even for a
simple path failover. Another challenge is the sheer number
of preﬁxes in BGP and the multiple possible paths to get to
a destination. There are about 150K preﬁxes in the Internet.
For a dual-homed AS, this would be 300K routes (i.e., paths
to the preﬁxes); for an ISP, there could be millions of routes.
Finding out what is happening in the Internet through
BGP is no easy task. While gigahertz processors and ter-
abyte disks have made it possible to capture and record BGP
messages via passive peering, making sense of the deluge
of data remains difﬁcult. In this paper, we tackle the chal-
lenges outlined above and present solutions to detect and
visualize Internet routing anomalies. The major contribu-
tions are:
(cid:0) “One picture says a million routes”: A visualization
technique that shows the large-scale structure of some
set of BGP routes in an operationally meaningful way.
It can either draw a picture to present BGP routes at a
point in time, or generate an animation to track routing
changes driven by BGP events.
(cid:0) An analysis technique that does anomaly detection
with BGP events. It allows network operators to an-
swer questions like “what happened during this up-
surge of updates?”, “where in the network did it hap-
pen?” and “how does it affect me?” in real-time on a
modern processor. The technique is fast enough even
when dealing with the entire backbone mesh of a typi-
cal Tier-1 ISP.
(cid:0) We describe the integration of router conﬁguration
ﬁles, trafﬁc data and IGP routing data into our tech-
niques to better understand routing anomalies.
(cid:0) Case studies on Internet routing instabilities, observed
from within a large educational network and a major
U.S. Tier-1 ISP. We present a number of hard-to-detect,
problematic BGP incidents, automatically diagnosed
by the above techniques. The incidents include back-
door routes, misconﬁgured community tags, policy ﬁl-
ters with unintended consequences, unexpected leaked
paths, and persistent route oscillations.
Roadmap. We ﬁrst describe our data collection methodol-
ogy in Section 2. Section 3 goes over our techniques for
routing anomalies detection and visualization. Section 4
presents results of case studies of real networks using our
tools. We describe the integration of additional data sources
into the techniques in Section 5. We discuss related work in
Section 6, and conclude with a short status of this project in
in Section 7.
2 Data Collection Methodology
We collected both BGP and IGP routing data from real
networks using the Packet Design Route Explorer (REX).
REX forms passive, internal-BGP (iBGP) peers with all
BGP edge routers at a site, or core route reﬂectors of an
ISP, just like interior routers would iBGP peer with each
other, i.e., our view of the BGP information is the same
as other members of the site’s iBGP mesh. For the net-
works discussed in this paper, the routers passed REX their
full routes. The BGP UPDATE messages by themselves are
not sufﬁcient for analysis because route withdrawals do not
contain the attributes being withdrawn. We remedy this by
maintaining an database for each of its peers. When a peer
sends REX an explicit withdrawal or an announcement that
implicitly invalidates a route, the peer’s database tells us
the original route attributes. Our data consists of BGP mes-
sages augmented with the withdrawn attributes. We call this
an event stream or just events. REX also maintains an adja-
cency passively with a IGP router, or multiple adjacencies
for a multi-area network, to collect IGP link state advertise-
ments.
Our ﬁrst dataset was collected at U.C. Berkeley from Au-
gust to December 2003. Berkeley runs a four-area OSPF as
its IGP. REX peered with four BGP edge routers. In early
August 2003, REX saw 13 BGP Nexthops, approximately
12,600 preﬁxes and 23,000 routes at Berkeley. Berkeley’s
upstream provider CalREN was undergoing signiﬁcant tran-
sitions at the time. CalREN was migrating its members to
a CENIC backbone, and also was in the process of consoli-
dating 5 AS numbers into 2, one for commodity and reliable
access called Digital California, and another one for a high
performance research network. As a result of this transition,
BGP-related incidents happened more often than during the
usual operating environment. Nonetheless, we believe most
observations presented here are not limited to such drastic
periods.
We also collected data at a U.S. Tier-1 ISP (ISP-Anon)
from June to August 2002. To protect this ISP’s identity
we anonymize all IP addresses, preﬁxes, router names and
AS numbers from the dataset. ISP-Anon runs ISIS as its
IGP. REX peered with the full route reﬂector mesh of 67
route reﬂectors. In late June 2002, REX saw about 9150 dif-
ferent BGP Nexthops, 316 Originators, 1.5 million routes,
200,000 preﬁxes, and 850 neighbor ASs.
Although in this paper we only present iBGP data col-
lected from inside an administrative domain, our techniques
are general and designed to apply to external-BGP (eBGP)
as well. Most BGP studies so far have focused on globally
visible problems using data from publicly available servers
such as RouteViews. We argue that diagnosis from within
a site — a single AS, enterprise with multiple ASs, or ISP
— is as critical if not more so, as a network operator cares
most about effects on her own network and what she can do
locally to ﬁx a problem. As far as we know, this paper is the
ﬁrst to study root cause diagnosis and show BGP misbehav-
iors from within a network’s point-of-view.
3 Making Sense of Inter-domain Routing
In this section, we present two techniques that help de-
tect and visualize Internet inter-domain routing anomalies:
TAMP is a visualization technique that shows the large-scale
structure of some set of BGP routes, and Stemming is an
analysis technique that does root-cause diagnosis of BGP
events. The two techniques can be used together or sepa-
rately. The only coupling between them is that Stemming
can extract a subset of an event stream encompassing a rout-
ing incident, which can then be fed to TAMP to generate an
animation of that incident.
3.1 Visualization: TAMP Picture and Animation
TAMP stands for Threshold and Merge Preﬁxes. It can
generate a picture or an animation of a set of BGP routes.
Unlike projects that aim to map the whole Internet from a
global perspective, TAMP’s goal is to show inter-domain
routing as the routers see it. A BGP router stores routes
heard from its peers in a Routing Information Base (RIB).
Each entry in the RIB refers to a single preﬁx, along with its
path attributes such as BGP Nexthop and AS path to reach
the preﬁx. Figure 1(a) illustrates RIBs for routers X and Y.
Using the RIB entries, TAMP forms a virtual tree to repre-
sent the BGP routes known by a given router at a particular
time: the root is the router; the router is linked to each of
the BGP Nexthops of the routes; the Nexthops are linked to
the ASs they service; each AS is linked to the next down-
stream AS according to the AS paths; and the leaf ASs are
linked to the preﬁxes they advertise. TAMP then assigns a
weight to each edge of this virtual tree proportional to the
number of unique preﬁxes carried on the edge. See Figure
1(b) for the individual TAMP trees for X and Y. TAMP con-
structs such a tree for each of a site’s BGP edge routers, or
core route reﬂectors for an ISP, and merges the trees into
a graph. During this merging phase, TAMP cannot simply
add the edge weights together because a weight corresponds
to the number of unique preﬁxes. It computes edge weights
by combining common preﬁxes, i.e., it remembers the set
of preﬁxes on each edge, performs a set union on the pre-
ﬁxes carried on the same edge from multiple trees, and uses
the size of the union as the merged edge weight. Figure
1(c) is the combined TAMP graph for X and Y. Note the
edge weight on NexthopA-AS1 of the combined tree in (c)
is 4 not 6, because the edge carries 4 unique preﬁxes on
it (1.2.1.0/24, 1.2.2.0/24, 1.2.3.0/24, 1.2.4.0/24). Data traf-
ﬁc would ﬂow from left to right; BGP information, right to
left. The thickness of an edge is proportional to how many
preﬁxes are routed over that edge, not how much trafﬁc is
ﬂowing over the edge.
We use AT&T’s graphviz library [4] to layout a TAMP
graph. For any realistic network, the TAMP graph de-
scribed so far would be extremely bushy with most parts
representing a negligible amount of preﬁxes, because the