Note that it’s possible that Microsoft has made changes to elements described in 
this section since I performed this research and reported the issue.
https://adsecurity.org/?p=4277
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | sean@trimarc
Sean Metcalf | @PyroTek3 | PI:EMAIL
Updated docs
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Access 
Management 
for Azure 
Resources
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
https://docs.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin
Sean Metcalf | @PyroTek3 | PI:EMAIL
Except…
Sean Metcalf | @PyroTek3 | PI:EMAIL
Elevate 
Access API
Sean Metcalf | @PyroTek3 | PI:EMAIL
https://github.com/hausec/PowerZure
Sean Metcalf | @PyroTek3 | PI:EMAIL
Compromise Office 365 Global Admin
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
(Office 365) 
Global Admin
(Azure)
User Access 
Administrator 
Sean Metcalf | @PyroTek3 | PI:EMAIL
Hacker Account Added to User Access Administrator
Sean Metcalf | @PyroTek3 | PI:EMAIL
Azure RBAC Role Monitoring
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
What About Removal?
Sean Metcalf | @PyroTek3 | PI:EMAIL
Get Azure Owner Rights!
Sean Metcalf | @PyroTek3 | PI:EMAIL
Virtual 
Machine 
Contributor
“… lets you manage virtual 
machines, but not access to 
them, and not the virtual 
network or storage account 
they're connected to.” 
https://docs.microsoft.com/en-us/azure/role-
based-access-control/built-in-roles#virtual-
machine-contributor
Sean Metcalf | @PyroTek3 | PI:EMAIL
Virtual 
Machine 
Contributor
“… lets you manage virtual 
machines, but not access to 
them, and not the virtual 
network or storage account 
they're connected to.” 
https://docs.microsoft.com/en-us/azure/role-
based-access-control/built-in-roles#virtual-
machine-contributor
Sean Metcalf | @PyroTek3 | PI:EMAIL
Microsoft.Compute/
virtualMachines/ 
runCommand/
Add Attacker Controlled Account to Virtual 
Machine Contributor
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
(Office 365) 
Global Admin
(Azure)
User Access 
Administrator 
(Azure)
Subscription Admin
Add to Role
Sean Metcalf | @PyroTek3 | PI:EMAIL
Separation of 
Administration
• Companies often have 2 groups managing 
different systems.
• One team typically manages Active 
Directory & Azure AD.
• Another team typically manages servers 
on-prem and in the cloud (IAAS).
• These teams expect that they have 
exclusive control of their respective areas.
Sean Metcalf | @PyroTek3 | PI:EMAIL
Why is this 
issue 
important?
• Customers usually have no expectation that an Office 
365 Global Administrator has the ability to control 
Azure role membership.
• Microsoft documented Global Administrator as an 
“Office 365 Admin”, not as an Office 365 & potential 
Azure administrator.
• Office 365 (Azure AD) Global Administrators can gain 
Azure subscription role administration access by 
toggling a single switch.
• Azure doesn’t have great granular control over who can 
run commands on Azure VMs that are sensitive like 
Azure hosted Domain Controllers.
• Once the “Access management for Azure resources” bit 
is set, it stays set until the account that toggled the 
setting to “Yes” later changes it to “No”. 
• Removing the account from Global Administrators does 
not remove the account from “User Access 
Administrator” access either. 
Sean Metcalf | @PyroTek3 | PI:EMAIL
Detection Key Points
• Can’t detect this setting on Azure AD user accounts using PowerShell, 
portal, or other method.
• No Office 365/Azure AD logging I can find that states that an Azure AD 
account has set this bit (“Access management for Azure resources”). 
• No (Azure AD/O365) Audit Logs logging that clearly identifies this change.
• Core Directory, DirectoryManagement “Set Company Information” Log
shows success for the tenant name and the account that performed it. 
However, this only identifies that something changed relating to “Company 
Information” – no detail logged other than “Set Company Information” and 
in the event the Modified Properties section is empty stating “No modified 
properties”. 
• Didn’t find any default Azure logging after adding this account to the VM 
Contributor role in Azure. 
Sean Metcalf | @PyroTek3 | PI:EMAIL
Azure AD to Azure Mitigation
Monitor the Azure AD role “Global Administrator” for membership changes.
Monitor
Enforce MFA on all accounts in the Global Administrator role.
Enforce
Control the Global Administrator role with Azure AD Privileged Identity 
Manager (PIM).
Control
Monitor the Azure RBAC role “User Access Administrator” for membership 
changes.
Monitor
Ensure sensitive systems like Domain Controllers in Azure are isolated and 
protected as much as possible. 
Ideally, use a separate tenant for sensitive systems.
Ensure
Sean Metcalf | @PyroTek3 | PI:EMAIL
MSRC Reporting Timeline
• Reported to Microsoft in September 2019. 
• MSRC responds in early October 2019: 
“Based on [internal] conversations this appears to be By Design and the documentation is being 
updated. “
• Sent MSRC additional information in mid October 2019 after a day of testing detection and 
potential logging.
• MSRC responds that “most of what you have is accurate”
• Sent MSRC update in late January 2020 letting them know that I would be submitting this as part 
of a larger presentation to Black Hat USA & DEF CON.(2020).
• MSRC acknowledges.
• Sent MSRC notification that I would be sharing this information in this blog.
• Documentation updated – June 2020.
• MSRC Security incident still open as of July 2020. 
I was informed by Microsoft during my interactions with MSRC that they are looking into re-working this 
functionality to resolve some of the shortcomings I identified.
Sean Metcalf | @PyroTek3 | PI:EMAIL
How bad can this get?
Sean Metcalf | @PyroTek3 | PI:EMAIL
How bad can this get?
Sean Metcalf | @PyroTek3 | PI:EMAIL
How bad can this get?
Attacker takes control of Azure resources
Removes accounts from all Roles 
Ransom the Azure environment
Azure Ransomware?
AzureWare?
Sean Metcalf | @PyroTek3 | PI:EMAIL
Next Level
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
Sean Metcalf | @PyroTek3 | PI:EMAIL
On-Prem 
Datacenter
Azure
AWS
Google Cloud Platform
(GCP)
Federation
Server
Sean Metcalf | @PyroTek3 | PI:EMAIL
On-Prem 
Datacenter
Azure
AWS
Google Cloud Platform
(GCP)
Sean Metcalf | @PyroTek3 | PI:EMAIL
On-Prem 
Datacenter
Azure
AWS
Google Cloud Platform
(GCP)
Sean Metcalf | @PyroTek3 | PI:EMAIL
On-Prem 
Datacenter
Azure
AWS
Google Cloud Platform
(GCP)
Sean Metcalf | @PyroTek3 | PI:EMAIL
On-Prem 
Datacenter
Azure
AWS
Google Cloud Platform
(GCP)
“Don’t want all my eggs in one 
basket…
Sean Metcalf | @PyroTek3 | PI:EMAIL
So now eggs are in all baskets.”
Sean Metcalf (@PyroTek3)
s e a n @ Trimarc Security . com
www.ADSecurity.org
TrimarcSecurity.com
Slides:  Presentations.ADSecurity.org 
Sean Metcalf | @PyroTek3 | PI:EMAIL
• Given that cloud IAAS is similar to on-prem 
virtualization, cloud attacks are similar as well
• Connection points between on-prem & cloud 
need to be carefully considered.
• Domain Controllers can be vulnerable no 
matter where they are located (on-prem & in 
the cloud).
• Authentication flows between on-prem & cloud 
(and Cloud to Cloud!) can be vulnerable.
• Protecting admin accounts is even more 
important in a cloud-enabled world. 
Recommendations
References
•
GCP KVM reference
https://cloud.google.com/compute/docs/faq
•
Airbus Security – ILO
https://github.com/airbus-seclab/ilo4_toolbox
•
AWS Managed AD
https://docs.aws.amazon.com/directoryservice/latest/admin-guide/directory_microsoft_ad.html
•
Azure AD Domain Services 
https://azure.microsoft.com/en-us/services/active-directory-ds/
•
GCP Managed AD
https://cloud.google.com/managed-microsoft-ad
•
Amazon AD Connector
https://aws.amazon.com/blogs/security/how-to-connect-your-on-premises-active-directory-to-aws-using-ad-connector/
•
Microsoft PTA
https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta
•
Attacking Microsoft PTA & Azure AD Connect
https://blog.xpnsec.com/azuread-connect-for-redteam/
•
Azure AD Seamless SSO
https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso
•
Attacking Azure AD Seamless SSO
https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/
•
Rhino Security Labs - AWS IAM Privileged Escalation Methods
https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/
https://github.com/RhinoSecurityLabs/Security-Research/blob/master/tools/aws-pentest-tools/aws_escalate.py
•
From Azure AD to Azure: An Unanticipated Attack Path
https://adsecurity.org/?p=4277
•
Introducing ROADtools - The Azure AD exploration framework
https://dirkjanm.io/introducing-roadtools-and-roadrecon-azure-ad-exploration-framework/
•
Dirk-jan Mollema’s talks
https://dirkjanm.io/talks/
Sean Metcalf | @PyroTek3 | PI:EMAIL