Windows Kernel Programming, Second Edition
Pavel Yosifovich
This book is for sale at http://leanpub.com/windowskernelprogrammingsecondedition
This version was published on 2022-01-22
This is a Leanpub book. Leanpub empowers authors and publishers with the Lean Publishing process.
Lean Publishing is the act of publishing an in-progress ebook using lightweight tools and many iterations
to get reader feedback, pivot until you have the right book and build traction once you do.
Â© 2020 - 2022 Pavel Yosifovich
Contents
Introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
1
Who Should Read This Book . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
1
What You Should Know to Use This Book
. . . . . . . . . . . . . . . . . . . . . . . . . . . . .
1
Book Contents
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
1
Sample Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
2
Chapter 1: Windows Internals Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
3
Processes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
3
Virtual Memory
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
5
Page States . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
7
System Memory
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
7
Threads . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
8
Thread Stacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
9
System Services (a.k.a. System Calls) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
11
General System Architecture
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
13
Handles and Objects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
15
Object Names . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
16
Accessing Existing Objects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
19
Chapter 2: Getting Started with Kernel Development . . . . . . . . . . . . . . . . . . . . . . . .
22
Installing the Tools . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
22
Creating a Driver Project . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
23
The DriverEntry and Unload Routines . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
24
Deploying the Driver . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
26
Simple Tracing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
29
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
32
Chapter 3: Kernel Programming Basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
33
General Kernel Programming Guidelines . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
33
Unhandled Exceptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
34
Termination . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
34
Function Return Values
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
35
IRQL
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
35
C++ Usage
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
35
Testing and Debugging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
36
Debug vs. Release Builds . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
37
CONTENTS
The Kernel API . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
37
Functions and Error Codes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
38
Strings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
39
Dynamic Memory Allocation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
41
Linked Lists . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
43
The Driver Object
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
45
Object Attributes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
46
Device Objects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
50
Opening Devices Directly . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
52
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
55
Chapter 4: Driver from Start to Finish
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
56
Introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
56
Driver Initialization
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
57
Passing Information to the Driver . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
59
Client / Driver Communication Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . .
60
Creating the Device Object
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
60
Client Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
63
The Create and Close Dispatch Routines . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
65
The Write Dispatch Routine . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
66
Installing and Testing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
70
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
74
Chapter 5: Debugging and Tracing
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
75
Debugging Tools for Windows . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
75
Introduction to WinDbg . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
76
Tutorial: User mode debugging basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
77
Kernel Debugging
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
94
Local Kernel Debugging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
94
Local kernel Debugging Tutorial
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
96
Full Kernel Debugging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
104
Using a Virtual Serial Port . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
104
Using the Network . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
108
Kernel Driver Debugging Tutorial . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
109
Asserts and Tracing
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
114
Asserts
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
114
Extended DbgPrint . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
116
Other Debugging Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
121
Trace Logging
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
122
Viewing ETW Traces . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
125
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
130
Chapter 6: Kernel Mechanisms . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
131
Interrupt Request Level (IRQL)
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
131
Raising and Lowering IRQL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
134
Thread Priorities vs. IRQLs
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
135
CONTENTS
Deferred Procedure Calls . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
135
Using DPC with a Timer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
138
Asynchronous Procedure Calls
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
139
Critical Regions and Guarded Regions
. . . . . . . . . . . . . . . . . . . . . . . . . . . . .
140
Structured Exception Handling
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
140
Using __try/__except
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
142
Using __try/__finally . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
144
Using C++ RAII Instead of __try / __finally
. . . . . . . . . . . . . . . . . . . . . . .
146
System Crash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
148
Crash Dump Information
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
150
Analyzing a Dump File . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
154
System Hang . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
157
Thread Synchronization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
159
Interlocked Operations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
159
Dispatcher Objects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
161
Mutex . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
163
Fast Mutex . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
169
Semaphore . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
169
Event . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
170
Named Events
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
171
Executive Resource . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
173
High IRQL Synchronization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
175
The Spin Lock
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
177
Queued Spin Locks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
180
Work Items . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
181
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
183
Chapter 7: The I/O Request Packet
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
184
Introduction to IRPs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
184
Device Nodes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
185
IRP Flow
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
189
IRP and I/O Stack Location
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
190
Viewing IRP Information
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
193
Dispatch Routines
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
197
Completing a Request . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
198
Accessing User Buffers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
199
Buffered I/O
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
200
Direct I/O . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
204
User Buffers for IRP_MJ_DEVICE_CONTROL
. . . . . . . . . . . . . . . . . . . . . . . . .
209
Putting it All Together: The Zero Driver
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
211
Using a Precompiled Header . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
212
The DriverEntry Routine . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
214
The Create and Close Dispatch Routines . . . . . . . . . . . . . . . . . . . . . . . . . . . .
216
The Read Dispatch Routine
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
216
The Write Dispatch Routine . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
217
Test Application
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
218
CONTENTS
Read/Write Statistics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
219
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
223
Chapter 8: Advanced Programming Techniques (Part 1) . . . . . . . . . . . . . . . . . . . . . .
224
Driver Created Threads
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
224
Memory Management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
226
Pool Allocations
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
226
Secure Pools
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
229
Overloading the new and delete Operators . . . . . . . . . . . . . . . . . . . . . . . . . .
230
Lookaside Lists . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
233
The âClassicâ Lookaside API . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
233
The Newer Lookaside API . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
235