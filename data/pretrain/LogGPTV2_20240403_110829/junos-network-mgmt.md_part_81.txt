• 256—EX3200, EX4200,
EX4500, EX4550, and EX6200
switches
• Does not apply—EX8200
switches
Number of analyzers that you can • 1—EX2200, EX3200, EX4200, • You can configure more than the
enable concurrently (applies to
EX3300, and EX6200 switches specified number of analyzers on
both standalone switches and to
the switch, but you can enable
Virtual Chassis) • 7 port-based or 1 global— only the specified number for a
EX4500 and EX4550 switches session. Use disable ethernet-
switching-options analyzer name
• 7 total, with one based on a
to disable an analyzer.
VLAN, firewall filter, or LAG
and with the remaining 6 • See the next row entry in this
based on firewall filters— table for the exception to the
EX8200 switches number of firewall-filter–based
analyzers allowed on EX4500 and
NOTE: An analyzer configured
EX4550 switches.
using a firewall filter does not
support mirroring of packets
• On an EX4550 Virtual Chassis,
that are egressing ports.
you can configure only one
analyzer if ports in the input and
output definitions are on different
switches in a Virtual Chassis. To
configure multiple analyzers, an
entire analyzer session must be
configured on the same switch of
a Virtual Chassis.
Number of firewall-filter–based • 1—EX4500 and EX4550 If you configure multiple analyzers,
analyzers that you can configure you cannot attach any of them to a
switches
on EX4500 and EX4550 switches firewall filter.
1009
Table 119: Configuration Guidelines (Continued)
Guideline Description Comment
Types of ports on which you • Virtual Chassis ports (VCPs)
cannot mirror traffic
• Management Ethernet ports
(me0 or vme0)
• Routed VLAN interfaces (RVIs)
• VLAN-tagged Layer 3
interfaces
If port mirroring is configured to • EX8200 switches
mirror packets exiting 10-Gigabit
Ethernet ports on EX8200
switches, packets are dropped in
both network and mirrored traffic
when the mirrored packets exceed
60 percent of the 10-Gigabit
Ethernet port traffic.
Traffic directions for which you can • Ingress only—EX8200 switches
specify a ratio
• Ingress and egress—All other
switches
Protocol families that you can • Any except inet and inet6— You can use inet and inet6 on
include in a firewall-filter-based EX8200 switches EX8200 switches in a local analyzer.
remote analyzer
• Any—All other switches
Traffic directions that you can • Ingress only—All switches
configure for mirroring on ports in
firewall-filter–based configurations
1010
Table 119: Configuration Guidelines (Continued)
Guideline Description Comment
Mirrored packets on tagged • Both VLAN ID and Ethertype—
interfaces might contain an
EX2200 switches
incorrect VLAN ID or Ethertype.
• VLAN ID only—EX3200 and
EX4200 switches
• Ethertype only—EX4500 and
EX4550 switches
• Does not apply—EX8200
switches
Mirrored packets exiting an • All switches
interface do not reflect rewritten
class-of-service (CoS) DSCP or
802.1p bits.
The analyzer appends an incorrect • EX8200 switches As a workaround, configure an
802.1Q (dot1q) header to the analyzer that uses each port (member
mirrored packets on the routed • Does not apply—All other interface) of the VLAN as egress
traffic or does not mirror any switches input.
packets on the routed traffic when
an egress VLAN that belongs to a
routed VLAN interface (RVI) is
configured as the input for that
analyzer.
Packets with physical layer errors • All switches Packets with these errors are filtered
are not sent to the local or remote out and thus are not sent to the
analyzer. analyzer.
Port mirroring configuration on a • EX8200 switches
Layer 3 interface with the output
configured to a VLAN is not • Does not apply—All other
available on EX8200 switches. switches
1011
Table 119: Configuration Guidelines (Continued)
Guideline Description Comment
Port mirroring does not support • All switches Port mirroring for line-rate traffic is
line-rate traffic. done on a best-effort basis.
In an EX8200 Virtual Chassis, to • EX8200 Virtual Chassis In an EX8200 Virtual Chassis:
mirror traffic across the Virtual
• You can configure LAG as a
Chassis, the output port must be a • Does not apply—All other
monitor port only for native
LAG. switches
analyzers.
• You cannot configure LAG as a
monitor port for analyzers based
on firewall filters.
• If an analyzer configuration
contains LAG as a monitor port,
then you cannot configure VLAN
in the input definition of an
analyzer.
In standalone EX8200 switches, • EX8200 standalone switches In EX8200 standalone switches:
you can configure LAG in the
• You can configure a LAG as a
output definition. • Does not apply—All other
monitor port on both native and
switches
firewall-based analyzers.
• If a configuration contains LAG as
a monitor port, then you cannot
configure VLAN in the input
definition of an analyzer.
Port Mirroring on SRX Series Firewalls
Port mirroring copies packets entering or exiting a port and sends the copies to a local interface for
monitoring. Port mirroring is used to send traffic to applications that analyze traffic for purposes such as
monitoring compliance, enforcing policies, detecting intrusions, monitoring and predicting traffic
patterns, correlating events, and so on. Port mirroring is used to send a copy of all the
packets or only the sampled packets seen on a port to a network monitoring connection. You can mirror
the packets either on the incoming port (ingress port mirroring) or the outgoing port (egress port
mirroring).
1012
Port mirroring is supported only on the SRX Series Firewalls with the following I/O cards:
• SRX1K-SYSIO-GE
• SRX1K-SYSIO-XGE
• SRX3K-SFB-12GE
• SRX3K-2XGE-XFP
• SRX5K-FPC-IOC Flex I/O
On SRX Series Firewalls, all packets passing through the mirrored port are copied and sent to the
specified mirror-to port. These ports must be on the same Broadcom chipset in the I/O cards.
On SRX Series Firewalls, port mirroring works on physical interfaces only.
Understanding Layer 2 Port Mirroring
On routing platforms and switches that contain an Internet Processor II ASIC, you can send a copy of
any incoming packet from the routing platform or switch to an external host address or a packet
analyzer for analysis. This is known as port mirroring.
In Junos OS Release 9.3 and later, Juniper Networks MX Series 5G Universal Routing Platforms in a
Layer 2 environment support port mirroring for Layer 2 bridging traffic and virtual private LAN service
(VPLS) traffic.
In Junos OS Release 9.4 and later, MX Series routers in a Layer 2 environment support port mirroring for
Layer 2 VPN traffic over a circuit cross-connect (CCC) that transparently connects logical interfaces of
the same type.
In Junos OS Release 12.3R2, Juniper Networks EX Series switches support port mirroring for Layer 2
bridging traffic.
Layer port mirroring enables you to specify the manner in which incoming and outgoing packets at
specified ports are monitored and the manner in which copies of selected packets are forwarded to
another destination, where the packets can be analyzed.
MX Series routers and EX Series switches support Layer 2 port mirroring by performing flow monitoring
functions by using a class-of-service (CoS) architecture that is in concept similar to, but in particular
different from, other routing platforms and switches.
Like the M120 Multiservice Edge Router and M320 Multiservice Edge Router, MX Series routers and EX
Series switches support the mirroring of IPv4, IPv6, and VPLS packets simultaneously.
In a Layer 3 environment, MX Series routers and EX Series switches support the mirroring of IPv4 (family
inet) and IPv6 (family inet6) traffic. For information about Layer 3 port mirroring, see the Routing Policies,
Firewall Filters, and Traffic Policers User Guide.
1013
Layer 2 Port Mirroring Properties
IN THIS SECTION
Packet-Selection | 1013
Packet Address Family | 1013
Mirror Destination Properties | 1014
Mirror-Once Option | 1014
Port mirroring specifies the following types of properties:
Packet-Selection
The packet-selection properties of Layer 2 port-mirroring specify how the sampled packets are to be
selected for mirroring:
• The number of packets in each sample.
• The number of packets to mirror from each sample.
• The length to which mirrored packets are to be truncated.
Packet Address Family
The packet address family type specifies the type of traffic to be mirrored. In a Layer 2 environment, MX
Series routers and EX Series switches support port mirroring for the following packet address families:
• Family type ethernet-switching—For mirroring VPLS traffic when the physical interface is configured
with encapsulation type ethernet-bridge.
• Family type ccc—For mirroring Layer 2 VPN traffic.
• Family type vpls—For mirroring VPLS traffic.
NOTE: In typical applications, you send mirrored packets directly to an analyzer, not to another
router or switch. If you must send mirrored packets over a network, you should use tunnels. For
Layer 2 VPN implementations, you can use the Layer 2 VPN routing instance type l2vpn to tunnel
the packets to a remote destination.
1014
For information about configuring a routing instance for Layer 2 VPN, see the Junos OS VPNs Library
for Routing Devices. For a detailed Layer 2 VPN example configuration, see Junos OS. For information
about tunnel interfaces, see the Junos OS Network Interfaces Library for Routing Devices.
Mirror Destination Properties
For a given packet address family, the mirror destination properties of a Layer 2 port-mirroring instance
specify how the selected packets are to be sent on a particular physical interface:
• The physical interface on which to send the selected packets.
• Whether filter checking is to be disabled for the mirror destination interface. By default, filter
checking is enabled on all interfaces.
NOTE: If you apply a filter to an interface that is also a Layer 2 port-mirroring destination, a
commit failure occurs unless you have disabled filter checking for that mirror destination
interface.
Mirror-Once Option
If port mirroring is enabled at both ingress and egress interfaces, you can prevent the MX Series router
and an EX Series switch from sending duplicate packets to the same destination (which would
complicate the analysis of the mirrored traffic).
NOTE: The mirror-once port-mirroring option is a global setting. The option is independent of
the packet selection properties and the packet family type-specific mirror destination properties.
Application of Layer 2 Port Mirroring Types
You can apply different sets of Layer 2 port-mirroring properties to the VPLS packets at different ingress
or egress points of an MX Series or of an EX Series route.
Table 120 on page 1015 describes the three types of Layer 2 port mirroring that you can configure on
an MX Series routers and EX Series switches, the: global instance, named instances, and firewall filters.
1015
Table 120: Application of Layer 2 Port Mirroring Types
Type of Point of Scope of Description Configuration
Layer 2 Port Mir Application Mirroring Details
roring Definition
Global Instance All ports in the VPLS packets If configured, the global port- See Configuring
of MX Series received on all mirroring properties implicitly apply the Global
Layer 2 Port Mir router (or ports in the MX to all the VPLS packets received on Instance of
roring switch) chassis. Series router (or all ports in the router (or switch) Layer 2 Port
switch) chassis. chassis. Mirroring
Named Instance Ports grouped VPLS packets Overrides any port-mirroring See Defining a
of at the FPC level received on properties configured by the global Named Instance
Layer 2 Port Mir ports associated port-mirroring instance. of Layer 2 Port
See "Binding
roring with a specific Mirroring.
Layer 2 Port
DPC or FPC and
Mirroring to The number of
its Packet
Ports Grouped port-mirroring
Forwarding
at the FPC destinations
Engines.
Level" on page supported for
1136. an MX Series
router and for
an EX Series
Ports grouped VPLS packets Overrides any port-mirroring
switch are
at the PIC level received on properties configured at the FPC
limited to the
ports associated level or in the global port-mirroring
number of
See "Binding
with a specific instance.
Packet
Layer 2 Port
Packet
Forwarding
Mirroring to
Forwarding
Engines
Ports Grouped
Engine.
contained on
at the PIC
the DPCs or
Level" on page
FPCs installed in
1137.
the router or
switch chassis.
1016
Table 120: Application of Layer 2 Port Mirroring Types (Continued)
Type of Point of Scope of Description Configuration
Layer 2 Port Mir Application Mirroring Details
roring Definition
Layer 2 Port- Logical interface VPLS packets In the firewall filter configuration, See Defining a
Mirroring (including an received or sent include action and action-modifier Layer 2 Port-
Firewall Filter aggregated on a logical terms to apply to the packets Mirroring
Ethernet interface. selected for mirroring: Firewall Filter.
interface)
• The acceptaction is NOTE: Layer 2
See Applying recommended. port-mirroring
Layer 2 Port firewall filters
Mirroring to a • The port-mirror modifier are
Logical implicitly references the port- not supported
Interface. mirroring properties currently for logical
bound to the underlying systems.
physical interfaces.
VLAN Layer 2 traffic For mirroring
forwarding table forwarded or • The port-mirror-instance pm- tunnel interface
or flood table flooded to a instance-name modifier explicitly input packets to
VLAN references a named instance of multiple
See "Applying
port mirroring. destinations,
Layer 2 Port
also see
Mirroring to • (Optional) For tunnel interface Defining a Next-
Traffic
input packets only, to mirror the Hop Group for
Forwarded or
packets to additional Layer 2 Port
Flooded to a
destinations, include the next- Mirroring.
Bridge Domain"
hop-group next-hop-group-name
on page 1169.
modifier. This modifier
references a next-hop-group
that specifies the next-hop
VPLS routing Layer 2 traffic
addresses (for sending
instance forwarded or
additional copies of packets to
forwarding table flooded to a
an analyzer).
or flood table VPLS routing
instance
See Applying
Layer 2 Port
Mirroring to
Traffic
Forwarded or
Flooded to a
VPLS Routing
Instance.
1017
Restrictions on Layer 2 Port Mirroring
The following restrictions apply to Layer 2 port mirroring:
• Only Layer 2 transit data (packets that contain chunks of data transiting the routing platform or
switch as they are forwarded from a source to a destination) can be mirrored. Layer 2 local data
(packets that contain chunks of data that are destined for or sent by the Routing Engine, such as
Layer 2 control packets) are not mirrored.
• If you apply a port-mirroring filter to the output of a logical interface, only Unicast packets are
mirrored. To mirror Broadcast packets, Multicast packets, Unicast packets with an unknown
destination media access control (MAC) address, or packets with a MAC entry in the destination
MAC (DMAC) routing table, apply a filter to the input to the flood table of a VLAN or virtual private
LAN service (VPLS) routing instance.
• The mirror destination device should be on a dedicated VLAN and should not participate in any
bridging activity; the mirror destination device should not have a bridge to the ultimate traffic
destination, and the mirror destination device should not send the mirrored packets back to the
source address.
• For either the global port-mirroring instance or a named port-mirroring instance, you can configure
only one mirror output interface per port-mirroring instance and packet address family. If you include
more than one interface statement under the family (ethernet-switching | ccc | vpls) output statement,
the previous interface statement is overridden.
• Layer 2 port-mirroring firewall filtering is not supported for logical systems.
In a Layer 2 port-mirroring firewall filter definition, the action-modifier filter (port-mirror or port-mirror-
instance pm-instance-name) relies on port-mirroring properties defined in the global instance or named
instances of Layer 2 port mirroring, which are configured under the [edit forwarding-options port-
mirroring] hierarchy. Therefore, the term filter cannot support Layer 2 port mirroring for logical
systems.
• For a Layer 2 port mirroring firewall filter in which you implicitly reference Layer 2 port mirroring
properties by including the port-mirror statement, if multiple named instances of Layer 2 port
mirroring are bound to the underlying physical interface, then only the first binding in the stanza (or
the only binding) is used at the logical interface. This is done for backward compatibility.
• Layer 2 port-mirroring firewall filters do not support the use of next-hop subgroups for load-
balancing mirrored traffic.
1018
Configuring Port Mirroring and Analyzers
IN THIS SECTION
Understanding Port Mirroring Analyzers | 1018
Configuring Mirroring on EX9200 Switches to Analyze Traffic (CLI Procedure) | 1026
Configuring Mirroring on EX4300 Switches to Analyze Traffic (CLI Procedure) | 1036
Configuring Port Mirroring to Analyze Traffic (CLI Procedure) | 1041
Verifying Input and Output for Port Mirroring Analyzers on EX Series Switches | 1045
Example: Configuring Port Mirroring Analyzers for Local Monitoring of Employee Resource Use | 1047
Example: Configuring Port Mirroring for Remote Monitoring of Employee Resource Use | 1053
Example: Configuring Mirroring to Multiple Interfaces for Remote Monitoring of Employee Resource Use on