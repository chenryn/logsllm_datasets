# 禁用SMB1协议
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
整理者：cyg07@360CERT
> 一直以来，业界都在致力于解决SMB1协议的安全问题。
>
> 黑客们乐此不疲的进行SMB1漏洞挖掘，协议专家一直布道SMB1的种种是非，犯罪份子直接使用SMB1的“永恒之蓝”漏洞利用框架进行全球范围的网络勒索。
>
> 这一切都像是要让SMB1协议走向尽头似的。
>
> 是时候告别SMB1了吗？
## SMB的古代史
上世纪1983年初，就职于IBM公司的Barry
Feigenbaum开发了一个网络共享协议，试图让现在听上去已古老的DOS操作系统支持网络文件访问。作者在雏形版本中称呼它
“BAF”，后在正式发版的时候更名为“SMB”(Server Message Block)，最早见于1984年11月8日的IBM Personal
Computer Seminar Proceedings, 卷2。
随后，微软在IBM版本的基础上作了大幅修改，形成通用版本。分别在1987年和1992年将其引入Microsoft LAN Manager和Windows
Workgroups项目， 从此SMB也开启在Windows平台漫长的生涯。
1996年微软的SMB迎来一次不小的挑战，SUN公司强势推出了WebNFS。微软针锋相对，一方面将SMB更名为更通用的CIFS（Common
Internet File System），并递交公开的IETF CIFS
1.0草案。此外继续给SMB/CIFS增加一系列特性，包括符号连接，硬链接等来迎合市场，为减少性能损耗，微软也着手优化掉不必要的NetBIOS协议。
20世纪末，随着微软Windows NT 技术的应用，SMB/CIFS协议更加活跃。因此微软启动“Direct hosting of SMB over
TCP/IP”计划，正式将NetBIOS协议象征性保留，SMB将直接运行于TCP协议之上，端口也
从139/TCP转向445/TCP。同时，IT架构方面也在发生着变化，增加了Kerberos，影子拷贝，服务器互拷等一系列场景需求，为此，专家们在SMB/CIFS上进一步引入了对应的协议扩展。
SMB/CIFS的易扩展性让它在Windows，Linux，NAS等平台或场景中扮演着重要的角色，SMB/CIFS协议支持了超过100条的复杂主指令(Command)。但是SMB相关的文档都是不精确，不完整，不可理解的。SMB/CIFS开始变得臃肿了，自身啰里啰唆的交互让它成了当时的网络资源杀手，很少用户会把它应用在WAN下，甚至一些厂家不得不搭建中间协议缓存系统来提高整体的网络性能。
SMB这样的情况让很多人都很不开心，（当然有些人是很开心的，比如Hackers）。
直到2007年，SMB2项目的出现给SMB协议带来了光明的希望。
至此，第一代SMB协议缝缝补补24年，即SMB1（全名：Server Message Block，曾用名：CIFS，1983年－2007年）。
## SMB1是不安全的
2017年，SMB1已经近34岁了，和很多“出生”于80年代的软件一样，它的设计和出现更多是为了迎合那个已经不再存在的世界。那个还没有恶意攻击行为，还没有海量重要数据，还没有普及计算机的世界。在现在看来，SMB1协议拥有一个“既天真又开放”的一生。
近年负责微软SMB协议项目的专家[NedPyle](https://social.technet.microsoft.com/profile/NedPyle+%5BMSFT%5D)，在Twitter中说了这么一个比喻，“当今社会还在运行SMB1协议就像带着你的祖母去一个热闹的舞会，她是出于好意前往的，但她是真得跳不动了。而且，这可能会是个令人害怕和难堪的事情。”。
SMB1确实给互联网带来过人人恐慌的经历。
2017年3月，早在MS17-010漏洞被WannaCRY勒索蠕虫利用前，微软发布了MS17-10补丁程序并提醒用户这是一个重要更新，用户没有多少感知。安全人员根据补丁文件数字签名发现微软在2月份的时候就知道漏洞细节。4月，著名的黑客组织影子经纪人（The
Shadow
Brockers）发布“永恒之蓝”的完整漏洞利用框架，信息安全行业沸腾了，但用户依然没有太强烈的感知。5月，WannaCRY勒索蠕虫直接利用“永恒之蓝”漏洞和框架配套的“双星脉冲”后门成功扫荡互联网，一时间人人自危，短时间波及150多个国家，超过30万台主机受到影响，有信息表示该攻击事件造成了全球80亿美元的直接经济损失。
“永恒之蓝”是微软SMB1协议漏洞的一个近乎完美攻击利用，能够稳定攻击Windows 2K，Windows
XP，Windows7，Windows8，甚至Windows
10在内的操作系统。SMB1长远的历史地位，大规模用户量和远程网络服务功能，让它的漏洞与生俱来就具备成为最有价值漏洞的资本。实际上，微软的MS17-010系列漏洞拿到了2017安全奥斯卡（Pwnie
Awards 2017）的最佳服务器端漏洞奖，也因其罕见的影响力而被作为一个划时代的漏洞写入到了互联网安全历史。
WannaCRY事件之后，安全行业普遍认为互联网安全进入了后“永恒之蓝”时代，但有关微软SMB1协议的安全漏洞还没有结束：
  * 2017年5月，包括CVE-2017-0272, CVE-2017-0277, CVE-2017-0278, CVE-2017-0279的多个可被远程利用的SMB1漏洞曝光；
  * 2017年10月，包括CVE-2017-11781，CVE-2017-11782，CVE-2017-11815，CVE-2017-11780的多个可被远程利用的SMB1漏洞曝光；
衡量微软SMB1在现阶段是否足够安全，举证其发生过的严重漏洞和其近期的漏洞还是比较肤浅的，更需要从当代的安全需求和角度去考虑。2007年至今，微软和业界对SMB作了大幅度改进，修订出了更符合现代安全需求的SMB2,3协议和实现。
对比SMB2, 3协议，使用SMB1将失去SMB2, 3协议上一系列现代化的保护：
  * 攻击面变窄（SMB2+）：SMB1协议命令100条+，SMB2缩减到19条，大幅度降低SMB协议攻击面；
  * 预认证完整性（SMB 3.1.1+），对抗降级攻击。
  * 会话协商安全（SMB 3.0, 3.02），对抗降级攻击。