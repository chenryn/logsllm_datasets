## PostgreSQL 持续稳定使用的小技巧 - 最佳实践、规约、规范 
### 作者                                        
digoal                                        
### 日期                                        
2019-02-19                                        
### 标签                                        
PostgreSQL , 稳定 , 技巧 , 实践    
----                                  
## 背景    
如同其他数据库一样，使用时需要注意一些问题，那么如何使用PG，可以保证长期稳定。  
## 部署形态设计实践  
根据对可靠性、可恢复性、可用性等等的不同要求，选择部署形态：  
### 1、分布式部署（例如pg+citus插件）    
容量上限：100节点以上，PB级。    
计算能力上限：100节点以上，6400核以上。    
读写带宽上限：100节点以上，200GB/s以上。    
RPO：如果每个计算节点都采用多副本存储，RPO=0。    
RTO：如果每个计算节点都采用HA，RTO可以做到1分钟内。    
使用限制：有一些SQL限制。    
适应场景：应用代码可控程度高的情况下，适合TP和AP业务。    
### 2、单节点本地存储    
容量上限：10TB级。    
计算能力上限：64核级。    
读写带宽上限：2GB/s级。    
RPO：RPO无保障。    
RTO：RTO无保障。    
使用限制：SQL无限制。    
适应场景：测试环境，非生产环境，对数据库RPO，RTO都没有要求的环境。    
### 3、单节点多副本存储    
容量上限：32TB级。    
计算能力上限：64核级。    
读写带宽上限：2GB/s级。    
RPO：单机房RPO=0，（如果存储支持跨机房多副本，可以做到多机房RPO=0）。    
RTO：10分钟级。    
使用限制：SQL无限制。    
适应场景：非核心场景生产、测试。    
### 4、双节点共享存储    
容量上限：32TB级。    
计算能力上限：64核级。    
读写带宽上限：2GB/s级。    
RPO：单机房RPO=0，（如果存储支持跨机房多副本，可以做到多机房RPO=0）。    
RTO：1分钟级。    
使用限制：SQL无限制。    
适应场景：核心、非核心场景生产。    
### 5、双节点主备异步复制    
容量上限：32TB级（使用远程存储），10TB级（使用本机存储）    
计算能力上限：64核级。    
读写带宽上限：2GB/s级。    
RPO：10GB网络，REDO延迟毫秒级、1MB以内。（支持跨机房部署）。心跳机制可确保RPO < 60秒     
RTO：1分钟级。    
使用限制：SQL无限制。    
适应场景：非核心场景生产。    
### 6、双节点主备半同步复制    
容量上限：32TB级（使用远程存储），10TB级（使用本机存储）    
计算能力上限：64核级。    
读写带宽上限：2GB/s级。    
RPO：    
无节点或单一节点异常时，可保证RPO=0。    
两个节点都异常时，RPO取决于备份延迟。采用基于PG流复制的持续REDO备份，可以做到RPO毫秒级。    
RTO：1分钟级。    
使用限制：SQL无限制。    
适应场景：核心、非核心场景生产。    
### 7、三节点及以上多副本全同步复制    
容量上限：32TB级（使用远程存储），10TB级（使用本机存储）    
计算能力上限：64核级。    
读写带宽上限：2GB/s级。    
RPO：    
小于半数节点异常时，可保证RPO=0。    
半数以上节点异常时，RPO取决于 1、10GB网络，REDO延迟毫秒级、1MB以内。2、备份延迟。采用基于PG流复制的持续REDO备份，可以做到RPO毫秒级。     
RTO：1分钟级。    
使用限制：SQL无限制。    
适应场景：核心场景生产。    
### 8、计算存储分离（存储多副本）（比如阿里云POLARDB PG）    
容量上限：100TB级。    
计算能力上限：16节点，1024核级。    
读写带宽上限：32GB/s级。    
RPO：单机房RPO=0，（如果存储支持跨机房多副本，可以做到多机房RPO=0）。    
RTO：15秒级。    
使用限制：SQL无限制。    
适应场景：核心、非核心场景生产。    
### 9、计算存储分离（存储多副本）+ 双机房半同步    
容量上限：100TB级。    
计算能力上限：16节点，1024核级。    
读写带宽上限：32GB/s级。    
RPO：    
无节点或单一节点异常时，可保证RPO=0。    
两个节点都异常时，RPO取决于备份延迟。采用基于PG流复制的持续REDO备份，可以做到RPO毫秒级。    
RTO：15秒级。    
使用限制：SQL无限制。    
适应场景：核心、非核心场景生产。    
### 10、计算存储分离（存储多副本）+ 多机房多副本全同步    
容量上限：100TB级。    
计算能力上限：16节点，1024核级。    
读写带宽上限：32GB/s级。    
RPO：    
小于半数节点异常时，可保证RPO=0。    
半数以上节点异常时，RPO取决于 1、10GB网络，REDO延迟毫秒级、1MB以内。2、备份延迟。采用基于PG流复制的持续REDO备份，可以做到RPO毫秒级。     
RTO：15秒级。    
使用限制：SQL无限制。    
适应场景：核心场景生产。    
### 11、只读节点    
使用限制：SQL无限制。    
适应场景：扩展读能力。    
### 12、非核心功能    
12\.1、业务透明的读写分离    
使用限制：SQL无限制。    
适应场景：扩展读能力。    
12\.2、跨库交互    
使用限制：SQL无限制。    
适应场景：跨库DBLINK，跨库外部表，跨库物化视图。    
12\.3、单元化    
使用限制：SQL无限制。    
适应场景：多实例共享少量数据，多写。    
## 使用实践(规约) - 避坑大法   
1、连接数过多（2000以上），可能导致性能下降。  
建议使用连接池（例如应用程序使用连接池，或者使用pgbouncer之类的连接池）。连接到数据库的连接在10倍CPU核数以内，达到最高的处理吞吐能力。  
2、大吞吐高并发的短连接，性能下降。  
建议使用长连接。  
3、长连接，长期不释放重建。如果连接访问了大量元数据，可能导致内存占用过大。  
建议设置空闲长连接释放机制。确保不会出现大量内存霸占的情况。  
[《PostgreSQL relcache在长连接应用中的内存霸占"坑"》](../201607/20160709_01.md)    
4、长事务，以及未结束的2PC事务。   