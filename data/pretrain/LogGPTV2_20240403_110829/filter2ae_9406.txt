# 恶意文档分析：利用CVE-2017-11882和CVE-2018-0802组合漏洞

##### 译文声明
本文为翻译文章，具体内容及含义以原文为准。

## 摘要
最近截获了一个扩展名为 `.doc` 的 Word 文档攻击样本，其实际格式为 RTF。通过分析发现，该文档组合利用了 CVE-2017-11882 和 CVE-2018-0802 漏洞，并使用内嵌的 Excel 对象触发漏洞。释放的 PE 文件用于收集目标用户的敏感信息。

## 一、基本情况
在实验环境（Windows 7 64位，Office 2010）中打开文档并进行进程监控，发现 `winword.exe` 进程启动后，依次执行了 `excel.exe`、`EQNEDT32.exe` 和 `cmd.exe`，最终运行了 `A.X` 进程。其中 `EQNEDT32.exe` 运行了两次。这表明该样本可能利用了 CVE-2017-11882 或 CVE-2018-0802 漏洞。

文档打开后显示为空白，但仔细观察可以发现左上角有一个小黑点图标。双击该图标会弹出“Windows 无法打开此文件：A.X”的错误提示，说明这是一个外部链接对象。

右键点击该对象并选择“包装程序外壳对象”，可以查看其属性。通过这些属性，我们可以确定该样本利用 RTF 嵌入了一个 PE 对象，在打开文档时默认将其释放到 `%temp%` 目录下，并利用上述漏洞执行该进程。

## 二、RTF 分析
### 1. 文档结构分析
使用 `rtfobj` 工具对文档进行分析，发现其内嵌了两个对象：一个 `package` 对象和一个 `Excel.Sheet.8` 对象。`package` 对象的原文件路径为 `C:\Users\n3o\AppData\Local\Microsoft\Windows\INetCache\Content.Word\A.X`，由此可知作者的操作系统用户名为 `n3o`。

提取的 Excel 表包含两个 `Equation.3` 对象 `AAAA` 和 `bbbb`，其 CLSID 为 `0002ce02-0000-0000-c000-000000000046`（Microsoft 公式 3.0）。这两个对象的 `Ole10Native` 数据中包含了 `cmd.exe /c %tmp%\A.X` 字样，用于执行 `A.X` 进程。这表明该样本组合使用了 CVE-2017-11882 和 CVE-2018-0802 漏洞。

### 2. 静态文档分析
使用 WinHex 打开文档，可以发现第一个 `package` 对象位于文件的 0x2A8A 处。其大小为 0x00137158（十进制 1274200），正是释放的 `A.X` 的大小。紧跟其后的就是 PE 文件，作者修改了 PE 头 `0x4D5A`，插入 `0x090d` 进行分割，以避免某些杀软的查杀。

另一个对象位于 0x299061 处，是一个 `Excel.Sheet.8` 对象，其大小为 0x00005C00（十进制 23552）。作者同样对复合文档的头进行了变化，用 `0x0909` 进行分割，以实现免杀混淆。

## 三、PE 文件分析
### 1. 实体文件
释放的实体文件名为 `A.X`，大小为 1274200 字节。该 PE 文件是用 VB 语言编写的 32 位程序，包含数字签名。以下是 PE 查看信息：

- **文件压缩状态**：未压缩
- **文件类型**：32 位 EXE (Win GUI 子系统)
- **文件大小**：1274200 字节
- **编译时间戳**：1999 年 11 月 4 日 10:15:20 (GMT)
- **PE 头偏移量**：0x000000C0
- **虚拟地址**：0x004000C0
- **数字签名**：偏移量 0BD000h，大小 01678h / 05752 字节
- **附加数据**：从偏移量 0BE678h 开始，大小 494304 字节
- **版本信息**：
  - 产品名称：CUFFIN10
  - 产品版本：3.05.0004
  - 文件描述：BARTRAMIA1
  - 文件版本：3.05.0004
  - 原始文件名：Moistness9.exe
  - 内部名称：Moistness9

### 2. 网络连接
`A.X` 运行后，连接到 IP 地址 104.16.18.96 的 80 端口和 208.91.198.143 的 587 端口。80 端口用于获取本地机器的外网 IP 地址，但在测试中返回 403 错误。587 端口用于发送 SMTP 数据包，将本地获取的信息发送出去。邮件标题为“HawkEye Keylogger | Stealer Records | 机器名 | 0FABFBFF000506E3”。

### 3. 启动方式和自保护
`A.X` 运行后，会将自身文件拷贝到 `%appdata%\WindowsUpdate.exe`，并启动实时保护进程。如果该目录下的 `WindowsUpdate.exe` 被删除，则会重新生成。此外，还会在注册表 `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run` 下生成启动项 `Windows Update`，确保自启动。

### 4. 域名解析
对 `smtp.lledil.com` 域名进行 whois 查询，结果如下：

## 四、总结
通过分析，我们得知该文档是一个组合利用 CVE-2017-11882 和 CVE-2018-0802 漏洞的攻击文档。RTF 格式的文档通过内嵌 Excel 对象触发漏洞，释放并运行的 PE 文件用于收集用户敏感信息（如浏览器和邮件账号密码），并通过邮件发送回传。根据邮件标题“Hawkeye keylogger|Steal…”，怀疑该 PE 文件可能是著名的“Hawkeye Keylogger”或“iSpy Keylogger键盘记录器”，这是一种窃取信息的恶意软件，作为恶意软件服务出售。

### IoC
- **DOC 文档（RTF）**：43f97093c3f812dce0e442c9be7a86a5
- **PE 文件（A.X）**：0ed7129ebd65f08a5c7f1f8fa668b72c
- **C&C**：smtp.lledil.com
- **邮箱**：PI:EMAIL