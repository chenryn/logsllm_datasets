[2021‚àí09‚àí28T10:10:39.1234] [ip=192.168.1.1]
describeotheroptimizationsforspecificquerytypes.
XXXXXXXX
Normally,toacceleratelogquery,thesystemwillcreateindexes 4.4.1 Whykeepingthelogsortedintime. Inordertoexplainthe
forthetimestamp,textandpropertiesrespectively. reasonwhyTencentCLSkeepsthelogsortedintime,weneedto
Atypicallogqueryspecifyafewconditions,andatimerange. firstdescribewhatthatchangestherangequeryprocedureinto.
Belowisanexample. Thenewprocedureisprovidedbelow.
SELECT ‚àó FROM xxxx_index (1) Suppose the timestamp range is specified to [ts_i, ts_j],
WHERE ip = 192.168.1.1 weusetheindextofindthesmallestdocid,docid_p,that
and timestmap >= 2021‚àí09‚àí28T00:00:00 corresponds to ts_i, and the largest docid, docid_q, that
and timestamp =Kthen
DESC LIMIT 10; returnThefirstùêæ elementsofdocuments
endif
Althoughbothquerieslooksimilar,whenitcomestotailqueries,
endfor
Lucene‚Äôsimplementationcanbeveryinefficient,duetothefollow-
ingreasons.
The iterators implemented in Lucene only support one-way
iterations.Therefore,fortailqueries,wehavetoiteratethrough 4.5.3 Optimization3.TheHistogramQuery. Lastly,optimization
alldatatilltheend,asisshowninFigure7.Thecomplexityofthis arecarriedoutforhistogramquery.Thehistogramqueryisavery
processisùëÇ(ùëõ),whereùëõisthenumberofthedocumentsthatmeet commontypeofquery,whichasksforthedistributionofnumber
thecondition. oflogsintime,thatmeetasetofconditions.
EvenifweaddsupportforreverseiterationontopofLucene, Bydefault,tohandlesuchqueries,Lucenefirstfilterthelogsby
tailquerieswouldstillbeinefficient.Thereasonisthatthereverse theconditions,thencheckthetimestampsoftheremaininglogs.
accesstodiskswouldrenderthefilecacheprovidedbyoperating However,thisprocessmaycausetensofthousandsoflook-upsin
systemsineffective. thetable,whichcauseshugelatency.EspeciallywithTencentCLS,
Therefore,toaddresstheinefficiencyoftailqueries,wepropose ahistogramqueryalmostalwaysaccompaniesanormalquery,in
theReverseBinarySearchalgorithm.Thealgorithmisimplemented ordertoprovideabetteruserexperience.
6
Table1:StatisticsoftheNYCTaxiBenchmark
Name Value
No.ofdocuments ‚àº12b
No.ofshards 6
averageESsegmentsize ‚àº5GB
No.ofdocumentsperESsegment ‚àº24m
averageNo.ofhitsperquery ‚àº40m
(2) Differenttypesofstoragedevices:TencentPremiumCloud
StorageR,NVMeSSDdriveR,andSATAHDDdrivesR.
(3) Differentnumberofusers:1,2,4,6,8,10,15,20,50,100,
150,200.
Figure9:Optimizationforhistogramqueries.Thenumberof (4) Differenttimestampprecisions:second-level,andmillisecond-
logsincertainbinsaredirectlycalculatedusingthedocidsof level.
theendpoints.Forexample,forbin[ti,tj),thecorresponding ThemostimportantscenarioisonesthatuseTencentPremium
numberoflogsiscalculatedasdocid_j-docid_i CloudStorageasstoragedevices,andadoptsecond-leveltimes-
tampprecision.ThereasonforprioritizingtheTencentPremium
CloudStorageisthatTencentCLSisbuiltonTencentCloud.And
Oursolutionisthat,insteadofcheckingthetimestampofevery
thereasonforusingsecond-leveltimestampprecisionisthatthe
hitlogdocument,weonlyneedtogathertheedgeofeachbinofthe
timestampinthebenchmarkdatasethasthesecond-levelprecision.
histogram.Thereasonisthatsincethelogsaresorted,thenumber
Basedontheresults,wehavebeenabletoanswerthefollowing
oflogswithinaparticularbincanbedirectlycalculatedbythe
researchquestions.
docidsofthetwoendpoints.Withsuchtechnique,wereducethe
numberoflook-upsfromtensofthousandstounderten. 5.1.1 RQ1.Whatistheoverallperformanceincreasecomparedwith
TheprocessisshowninFigure9. Lucene? Underthemostimportantscenariodescribedabove(Ten-
centPremiumCloudStorage+second-leveltimeprecision),using
5 EXPERIMENTALEVALUATION
theinverseoftheservicetime(inmilliseconds)astheindicator
Theexperimentalevaluationsaremainlytodemonstratetheeffec- fortheperformance,weobservethattheperformancesincreaseby
tivenessofthedesignofthesearchengineinTencentCLS. 38xforheadqueries,26xfortailqueriesand7.5xforthehistogram
Overall,theexperimentsconsistoftwoparts:offlineexperiments queries.
withopenbenchmarksandonlineexperimentswithrealworlddata. Figure10showsamoredetailedresult,distinguishingtheper-
Thefirstpartofexperimentsisrelativelycheaptoperform,we formancesunderdifferentusercounts.Generally,theperformance
usethemtoanalyzetheperformancegainsofourmethodsunder steadilyincreasesmore,astheusercountsgethigher.Thereason
variousscenarios.Thesecondpart,ontheotherhand,providemore isthatwhentheusercountsarelow,theworkloadislow,andthe
convincingevidencesoftheeffectivenessofoursolution,sinceit strengthofthesystemdesignisnotfullydisplayed.Therefore,we
utilizesreal-worlddataatTencentCLS. alwaysusetheresultsfromtheheaviestworkloadasthearguments
forouranalyses.
5.1 OpenBenchmarkEvaluation
5.1.2 RQ2. How much does each of the optimization techniques
Intheopendatasetexperiments,wequantitativelyinvestigatethe
contributetotheperformanceimprovements? Therearefouropti-
effectivenessofthequeryoptimizationsinasingle-machinesce-
mizationtechniquesdescribedinthispaper:
nario.
TheexperimentisperformedonTencentCloudmachines,each ‚Ä¢ O0:Keepingthedocumentssorted.
witha16-corevCPUand64GBofram.Thestoragedevicesare ‚Ä¢ O1:Constructingthesecondaryindexforthetimestamp
localNVMeSSDdrives(IT3.4XLARGE64),localSATAHDDdrives field.
(D3.4XLARGE64)andTencentPremiumCloudStorage. ‚Ä¢ O2:Reversebinarysearchalgorithmfortailqueries.
ThebenchmarkweuseistheNYCtaxibenchmarkprovidedby ‚Ä¢ O3:Optimizinghistogramqueries.
esrallyR.ThedatasetconsistsoftaxiridesinformationinNewYork Weturnthemonandoffindividually(whilewecan)inorder
in2015,andcontainsuptoatotalof12billiondocuments.Some tounderstandthecontributionofeachtechniquetotheoverall
importantstatisticsforthisbenchmarkarelistedinTable1. performanceincrease.Otherexperimentalsetupisthesameasthe
Theexperimentsaredesignedwiththegoalofanalyzingthe oneusedinRQ1.
performanceincreasesinthefollowingscenarios. ResultsshowthatturningonO0aloneincreasestheheadquery
(1) Differenttypesofqueries:headqueries,tailqueries,andhis- performancesby12x,increasestheheadqueryperformancesby3x
togramqueries(definedinSection4.5.2andSection4.5.3). andincreasesthehistogramqueryperformancesby3x.
7
Table 2: Performances when turning on and off different
optimizationtechniques.Multiplierreferstotheboostmul-
tiplierofcurrentoptimizationconfig,comparedwiththe
previousone.AccumulativeMultiplierreferstotheaccumu-
lativeboostmultiplierofthecurrentoptimizationconfig.