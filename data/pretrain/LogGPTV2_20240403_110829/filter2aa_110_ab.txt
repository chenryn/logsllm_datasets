call    _GeoIP_country_id_by_addr
add     esp, 10h
cmp     eax, 0FFh
jle     loc_8049933
sub     esp, 0Ch
push    [ebp+timer]    
call    get_ip_hash
add     esp, 10h
cmp     eax, [ebp+var_468]
jnz     loc_8049ABE
loc_8049BE8:
sub     esp, 8
push    [ebp+var_7C]    ; char *
push    [ebp+var_54]    ; int
call    referer_validate
add     esp, 10h
test    eax, eax
jnz     short loc_8049C07
push    [ebp+var_84]
push    [ebp+var_2C]
push    offset a?o6PURU 
lea     ebx, [ebp+var_338]
push    ebx             
call    _sprintf
add     esp, 0Ch
push    ebx
push    offset aData 
push    offset exp_quicktime_opera
sub     esp, 8
push    0
push    [ebp+var_4AC]
call    js_crypter_put
mov     eax, [ebp+var_4AC]
add     esp, 10h
test    eax, eax
Scripts – what’s the next address?
• The modified Torpig domain generator
– Modified the domain generation logic (last part 
has an extra letter).
– Modified to also provide the injection in different 
formats (popunder variants).
• Great for keeping track of 
“next hop” planning…
Sources: /ifrmcrypt/crypt.htm, 
crypt_js.htm, crypt_js_jok.htm
Scripts ‐ ProxyJudge
• A cgi to test whether the victim is behind a 
proxy.
– Smart criminals don’t attack twice at the same 
spot, and need to know whether it’s worthy to 
unleash their mojo…
Other goodies
• “Howto” in word.
– (someone from MS wants to check 
for licensing?)
– Run install.php, make sure the dir is 
writeable, and accessible from the 
web…
– Packer will verify the integrity of the 
install (!!!)
– Change the settings…
– Check results.
– Options description, logging, 
interpreting logs (ASCII graphics!)
• All in Russian 
Scripts – CPanel goodies
• Looks like a “braindump” from grabbing 
interesting credentials.
• TONS of CPanel login info – hundreds of 
domains…
– Inline comments in Russian on some of the sections:
• “clearly has not been able to look after !!!!!! ”
• “glyant OWL. previously worked as щас clearly no longer 
works ”
• “ekspa need to pop in and remove the soap base ”
• “this, too many sites and is not small ”
• “master admin cpanel” (near a hosting site address…)
More goods
• Criminal humor:
– Under 
“marshals_investigations
_most_wanted” there are 
a few HTMLs, must be 
some internal joke or a 
teaser to LE…
– Nicks for the gang crew 
are on this (instead of the 
original page from the US 
Marshal site), along with 
funny caricatures of 
them…
Meanwhile…
• We haven’t just started debugging, tracing and 
poking around for fun!
– The second we managed to clear out the legalities, we 
pushed everything to CERT‐CC
• Coordination efforts:
– CERT‐CC was highly responsive! Created a small task‐
force to handle the data
– Analyzed logs, segmented it to 86 different affected 
countries, started managing the notification process 
to ALL of them (inc. establishing secure comm. with a 
few)
– Worked with FBI and SS in the US
Fancy maps and all…
Closure?
• So, worked with CERT, got a lot of ricochets 
from the field (some countries the notification 
process was sloooooow, data got out before 
the notifications got to the affected parties…)
• A few days to get the bulk of the sites notified.
• Shows up on the “bad‐guys” stats as well:
Graphing the main 5 “clients”
0
2000
4000
6000
8000
10000
12000
14000
16000
18000
20000
9/22/2008
9/23/2008
9/24/2008
9/25/2008
9/26/2008
9/27/2008
9/28/2008
9/29/2008
9/30/2008
10/1/2008
10/2/2008
10/3/2008
10/4/2008
10/5/2008
10/6/2008
10/7/2008
10/8/2008
10/9/2008
10/10/2008
10/11/2008
10/12/2008
10/13/2008
10/14/2008
10/15/2008
10/16/2008
10/17/2008
10/18/2008
10/19/2008
10/20/2008
10/21/2008
10/22/2008
10/23/2008
10/24/2008
10/25/2008
10/26/2008
10/27/2008
10/28/2008
Hits
Hits per user ‐ Daily
eagle
chlu
grey
grobin
leet
Let’s see…
0
5000
10000
15000
20000
25000
30000
35000
Post news publication 
– cleanup as sites 
notified of breaches
eCrime operator 
regroups and recruits 
new sites, 
notification process 
continues…
eCrime operation back to normal –
after stabilizing when the 
notification is mostly done, the new 
“batch” is showing some nice 
performance…
Graphing the total hits per day for the top 5 users of the system
The McColo Connection?
• Remember the door we were peeking 
through?...
Yup – well into the investigation, 
we caught a glimpse of the joker 
while he was at it…
And if we are getting that close and 
personal
• How ‘bout them .htaccess files?
– FTP IFramer, PHPMyAdmin, scripts directory… 
were not accessible to the general public
allow from 90.189.250.93 66.36.244.234 
66.235.182.115 208.72.169.56 208.72.169.61 
82.103.131.138 82.103.135.175
(That’s DC, Newark, Denmark and Russia)
• Yup – these got to LE as well…
Final words
• Can this happen again?
• YES?!
This is bad!
FIX IT!!!
Source: “Understanding web browser threat: examination of vulnerable online web browser populations
and the ‘insecurity iceberg’”, http://www.techzoom.net/insecurity‐iceberg
Yes… (until the rise of the machines)
• Picture taken on Thursday October 16th 2008 
at BlueHat. 2 days after the Patch Tuesday. In 
Microsoft. At Redmond…
How bad can this be anyway?
Final final words…
• What should we be looking for in terms of 
advancements in “Trojan technology”?
– Mostly communication
– What have we learned from the use of legitimate 
websites on the attack vector?
– Why not apply it to the rest of the communication 
channels?
Trojans 2.0 Illustrated 
Q&A
•Questions?
• Thank you!
PI:EMAIL