Subheader中含有下面的域：
    •   Offset 0: total length (QWORD)
    •   Offset 8: hardcoded -1 (DWORD)
    •   Offset 0xc: affiliate ID (DWORD)
    •   Offset 0x17: length of next field (BYTE)
    •   Offset 0x18: bot ID (32 bytes)
    •   Offset 0x38: length of next field (BYTE)
    •   Offset 0x39: MD5 hex digest of plaintext data (32 bytes)
    •   Offset 0x5a: filename (520-byte wide string)
    •   Offset 0x264: data type (DWORD)
    •   Offset 0x270: system time (unknown format) (QWORD)
    •   Offset 0x280: timezone bias (DWORD)
    •   Offset 0x288: encrypted data length (QWORD)
数据可以用IV和16\x00字节进行ZLIB压缩和AES-256-CBC加密。加密key是用CryptDeriveKey
Windows函数生成的，RSA加密使用的是嵌入的RSA公钥。然后把RSA加密的AES加到加密数据的尾部。
表3: 发送的文件
## C&C基础设施
DanaBot用加载器来从C2服务器下载主组件。主组件含有10个硬编码的C2
IP地址列表，该IP地址被用作恶意软件通信。研究人员发现硬编码的C2列表每个消失会变化一次，而此时主模块会下载下来。研究人员发现每个样本的C2列表是不同的。研究人员24小时内共获得24个列表，240个IP地址，其中194个（80%）的IP是唯一的。重复数最多的前10个IP是：
    •   158.255.215[.]31 (in 7 lists)
    •   149.154.152[.]64 (in 7 lists)
    •   37.235.53[.]232 (in 6 lists)
    •   95.179.151[.]252 (in 5 lists)
    •   178.209.51[.]227 (in 5 lists)
    •   149.154.157[.]220 (in 5 lists)
    •   45.77.54[.]180 (in 4 lists)
    •   45.77.96[.]198 (in 3 lists)
    •   45.77.51[.]69 (in 3 lists)
    •   45.77.231[.]138 (in 3 lists)
整个C2的IP列表中，只有下面10个好像是有响应的：
    •   149.154.152[.]64
    •   149.154.157[.]220
    •   158.255.215[.]31
    •   178.209.51[.]227
    •   37.235.53[.]232
    •   45.77.231[.]138
    •   45.77.51[.]69
    •   45.77.54[.]180
    •   45.77.96[.]198
    •   95.179.151[.]252
研究人员还发现这些重叠、交叉的IP列表中还含有一些不能路由的IP：
    •   10.181.255[.]78
    •   225.100.146[.]224
    •   225.21.55[.]173
    •   226.181.243[.]104
    •   228.226.171[.]37
    •   234.106.187[.]114
    •   234.63.249[.]87
    •   234.97.12[.]178
    •   235.40.105[.]171
    •   238.87.111[.]55
因此，研究人员推测，主组件可能只含有几个真实的C2地址，其他的都是随机的诱饵地址。
# Affiliate System
根据传播方法和攻击目标，研究人员将DanaBot活动用affiliate ID进行分组：
不同affiliate ID的DanaBot样本也会使用相同的C2 IP地址。因此，研究人员推测DanaBot可能被设置为恶意软件即服务（MAAS）系统。
# 对比CryptXXX勒索软件
Proofpoint研究人员在2016年分析过CryptXXX文件加密勒索软件，该勒索软件与Reveton
“police”勒索软件有一些相似处。而且也是用Delphi语言编写，使用基于TCP 443端口的定制C2协议。
DanaBot的C2流量看似是该协议的进化版，使用AES加密和ZLIB压缩。CryptXXX checkin的格式是：
图9: CryptXXX checkin格式
CryptXXX和DanaBot都有下面的域：
    •   Offset 0: length of next field (BYTE)
    •   Offset 2: bot ID (32 bytes)
    •   Offset 0x34 : length of compressed buffer
    •   Offset 0x38: Zlib-compressed buffer (0x4e bytes)
压缩的缓存解码后：
图10: 解码的payload buffer
解码的缓存中有以下域：
    •   Offset 4: length of next field (BYTE)
    •   Offset 5: bot ID (32 bytes)
    •   Offset 0xce : length of next field (BYTE)
    •   Offset 0xcf : Affiliate ID (7 bytes)
    •   Offset 0xfc : length of next field (BYTE)
    •   Offset 0xfd : Version string (5 bytes)
之后的通信中会有一个解码的请求来下载Stealer模块——stiller.dll：
图11:解码的下载Stealer模块的请求
这样看来Danabot可能是同一个组织的不同恶意软件。该恶意软件家族最早的产品是恶意软件，随后在Reveton加入窃取器功能，进一步进化为CryptXXX勒索软件，现在在Danabot中加入了含有Stealer的银行木马和远程访问功能。
# 结论
DanaBot恶意软件的传播已经超越澳大利亚国界，目前攻击波兰、意大利、德国、奥德利、美国等。DanaBot是一款银行木马，也就是说其攻击目标一定程度上是有地理范围的。恶意软件本身含有反分析技术，更新的stealer和远程控制模块增加了其吸引力和可用性。
**参考文献**
[1] 
[2] 
[3] 
[4] 
[5] 
[6] 
[7]
[8]
[9]
[10]
[11]
[12]
[13]