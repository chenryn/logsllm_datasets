由NetFlow收集的数据保存在/var/cache/nfdump/flows/live/ossim/目录下，并存储为
在OSSIM系统中查询NetFlow流量如图13-3所示。
NetflowProce
TracFoiesTraic capa
A Soerces
locahosr
客
Channel
4222
ing
1.Cisco输人Netflow
Displavsum
0
03
94993
andnone
图13-2OSSIM系统分析NetFlow数据
2i
fprobe收集数据并
图13-3NetFlow流量查询
117.3
roto
K
t269022
UstFlows
SrcIPsTp100stI）
g b24517ng Pngbp
Stat
Topk
24.6kb/s
4.Nfsen
p0
由Nfdump
WEB前端
/vG ong
24.1kb/s
录
调取netflow
第13章网络流量监控333
241kb/
数据显示
Clearfomfrocess
在指
427.6b/s
udp:
0
ppa
---
## Page 357
Analyzer都是不错的选择。
提供了很好的分析工具，例如 Solarwinds NetFlow TrafficAnalysis和 Manage Engine NetFlow
外，还支持多种 NetFlow 新功能，如支持 Multicast、MPLS、IPv6 等。另外一些商业软件都
以包括二层到七层的内容，这是其他版本无法相比的。V9除了方便添加需要输出的数据域
与设备联动的方式，采用ACL对设备进行自动配置，当攻击流消退后再自动取消ACL。
定时运行，从中发现满足这些条件的Flow。
NetFlow信息存储入OSSIM数据库中。
式，再用OSSIM 内的Perl 程序对 NetFlow 进行分析和规范格式的操作，并将读取的
NetFlow数据包并存储为特定格式。
nfprofile和nfreplay这4个进程组成，功能见表13-3。
（IP）的固定UDP端口。
注意，以上分析了NetFlowV5版本的应用。
序号
34
5）将分析结果在Web 客户端中展示，或者通过E-mail、短信等接口发送。也可以通过
4）依据蠕虫和DDoS攻击等异常报文的流量特征，在分析程序中预设各种触发条件，
2）采集器软件为OSSIM系统的Flow-tool工具，该软件监听UDP端口，接收进入的
3）使用Nfsen等软件包中的工具对NetFlow源文件进行读取，转换成可读的ASICII 格
1）在Cisco6509上配置NetFlow（或其他网络设备），并输出到指定到OSSIM采集器
接下来，我们归纳一下实施流量监控的步骤（以Cisco6000系列为例）：
从系统捕获数据包的过程来看Nfdump 这一过程至关重要，它由nfcpad、fdump、
UNIX/Linux网络日志分析与流量监控
nfreplay数据转发
nfprofile分析器
nfdump数据挖掘
nfcapd捕获守护进程
d
禁
流IP地址、端口等的topN统计信息，并根据想要的顺序显示出来
在这些文件中轮转。必须为每个NetFlow 流创建一个nfcapd进程
将nfcapd产生的数据文件转发到另一台主机
从由nfcapd产生的数据文件中解析出NetFlow数据并显示出来，它能够建立大量关于
从网络中捕获NetFlow数据，然后将数据存到文件中。它会每隔n（一般为5）分钟
图13-4nfcapd产生的数据
NetFlowV9是目前的新版本，V9的输出可
作用
---
## Page 358
位读者可根据自己的情况酌情处理。
者在使用前注意。
面。vSwitch 可由一块或多块 vmnic 组成，当启用嗅探模式后会牺牲 20~30%的性能，请读
（包括网络、服务器以及存储）的各种指标。可是监控内容多了会导致系统性能下降。各
Wireshark协议分析仪将开始看到所有来自其他虚拟机的所有流量。
口组中的每个端口都能够看到流过vSwitch的流量（来自vSwitch上虚拟机的流量）。并且
Console。配置ESX为混杂模式如图13-5所示。
promiscuous mode，Host ESX Server 才能正确地将包传递给 Guest ESX Server 的 Service
认在 ESX 中不允许混杂模式（promiscuous mode），必须在 Host ESX Server 中允许
网管解决网络故障。有什么办法呢？很显然需要将虚拟机设置为混杂模式，可是vSwitch默
环境下默认的协议分析软件只能看到发往或发自运行分析仪的计算机的流量，这不能帮助
是Openflow技术。
情。笔者总结了几种方法。
用的情况比比皆是。如何对各个虚拟机流量及日志情况做个准确了解是很多人所关心的事
在物理交换机环境下，若要监控网段内的服务器可以采用SPAN方式，
从VMware收购了OpenFlow先驱Nicira后，其虚拟化监控能力得以增强。下面利用的就
113.3
目前虚拟化技术已深入企业应用，在一台高性能服务器上安装多台虚拟机，部署多个应
下载网站地址：htp://angaticom/vdi_ dashboard/，从这个网站上下载大约 1.5GB 的压
（1）下载安装VDI。
这里介绍的 Xangati VDI Dashboard，能够收集虚拟桌面环境中的所有不同的后端组件
2.基于VDI流量面板法
注意：
当vSwitch配置好混杂模式后，该vSwitch的端口组都进入混杂模式。现在，虚拟机端
下面讲解安装步骤
vSwitch由ESXi 内核提供，是一个虚拟的交换机，用于连接不同的虚拟机及管理界
将这些信息收集整理分析后，就可以发现网络通信的规律，只不过它是Cisco的技术。
前面讲过Cisco的Netflow，它可以统计记录网络中数据包的源目的地址、端口号等信
1.基于嗅探方法
VMwareESXi服务器监控
SPAN Port Properties
GeneralSecurityTraffe Shaping|NCTeaing
Poic
ExO
IsMode
Sons
图13-5配置ESX嗅探模式
isab
区
第13章网络流量监控335
在多虚拟机
---
## Page 359
需要监控的虚拟机。
应为没有监控对象，所以没有数据显示，这时需要选取添加按钮10HoHosPachs，导入
后，系统会打开登录界面，经过IP设置后即可使用。
高，例如CPU至强2.4GHz以上，可用磁盘空间至少需要50GB以上，内存在8GB以上。
缩包，其中包含了OVF（开放虚拟机格式）格式的文件，准备的计算机硬件配置应该比较
336UNIX/Linux网络日志分析与流量监控
然后在客户端进行设置。客户端成功登录会显示（如图13-7所示）界面，当打开主程序时
在vSphereClient中导入虚拟机，然后选中虚拟机并启动，如图13-6所示。当启动完成
（2）将OVF工具导入虚拟机。
InitialSetup
Infrastructure Data Feeds
hosts.
Manua
图13-7导入监控对象
图13-6添加主机
htm
arate
cep
点击此添加待监控对象
---
## Page 360
环境，所以要将JDK-1.6装上，确保JVM正常工作。
splunk 安装目录的 apps 目录下，比如：SSPLUNK_HOME\etclapps。
行效果图如图13-9所示。目前Splunk6.x支持ESX5i。安装过程如下：
的使用细节报告，就连在CitrixXen环境中的虚拟机一样可以监控到。SplunkforVMware 运
进行复杂系统的日志分析，Splunk利用WMI的Virtualization Planning可以提供OS 等资源
存储、操作系统或应用事件关联起来。借助Splunk 提供的全面可见性，能够对虚拟服务器
不要修改。
网段。最后选择Netflows Generator，即启用Ossim的Netflow功能。默认远程收集端口555
段，例如192.168.150.0/24，写成CIDR的形式，支持多个网段，建议设置初期不要超过2个
模式以便监听，eth1用作远程管理接口。接下来配置MonitoredNetworks，选择监听的网
Sensor→Configure Server IP，在这个界面有两块网卡，分别为eth0、eth1，选择etho为混杂
Ports"，同时保证“connect at powper on”为选中状态。
SPAN Ports 端口配置选项，注意要把 Promiscuous Mode 设为 Accept 状态。然后在 OSSIM-
项卡中，会弹出vSwitch0属性配置对话框，这里是24口虚拟交换机的配置对话界面，选中
控制台上的Configurations菜单中选择Networking选项，在右边的属性（Properties）配置选
所示。
RouterInterfacesoRouter tmterfacs导入。接着就可以打开“Monitor”标签查看。如图13-8
然后编辑vmware.conf 配置文件，设置 vmware ESX的账号密码。由于App 需要有JVM
接着在Ossim控制台中登录直接进入OSSIM 4.2.1的控制台，具体操作顺序为Configure
losts
接着，用同样方法导入Host Paths，导入成功后会显示oPoncroups，接着按
SplunkforVMware 能收集来自虚拟机的性能统计、日志和事件并把这些信息与网络
4.SplunkforVMware应用
在下面的设置例子中，首先以检测OSSIM Serve的流量为例，在vSphere Client客户端
3.ESX中添加SPAN端口检测法
OARD
监控的内容要根据需要逐次添加，选取完毕点击“Add”按钮，成功后点击“OK”按钮。
MONITOR
RECORDINGS
图13-8Monitor标签中显示虚拟机的数据
REPORTS
PROFLE
第13章网络流量监控337
E
---
## Page 361
lib/splunk.jar命令：2
338UNIX/Linux网络日志分析与流量监控
接着开始测试，首先在Windows 计算机上进入appslvmware 目录下，执行 java -jar
DEBUG:PropertyCollector:getProperties:service connection successful
DEBUG: PropertyCollector:getProperties:service cache is null.willtry and connect
2013年5月5日下午12:13:50StartingSplunk4Vmwareversion=2.0
Started
st24hours
pev2next
acity Planning(Hosts)Actions
rch
vCentero1
vCenterot
vCenterot
vCenter01
ostPerformance
PP
nter01
About Splunk App for VMwareViewsIaventoryPerformanceSecurityTaskEven
he
VCENTERSOO
3
400
图13-9Splunk forVMware监控画面
口
Cluster
apps-esxi501.sv.splunk.com
ESX
A
502.sv
ESXiVMMetrics Overview
ESXi HostMetrics Overview
ESXi CPUMetrics Overview
overtime
Host:
more than20
koom
Virtual!
---
## Page 362
IMAP和SMTP协议），解析HTTP内容，以及VOIP应用等。
网关的流量，也可以从PCAP文件中解析出IP流量数据，并解析每个邮箱（包括POP、
各种网络应用中所包含的数据，并从中分析出各种网络应用。例如Xplico可以实时解析通过
的主要作用是捕获网络应用层数据并显示出来，这指的是通过捕获Intermet网络流量来提取
(NFAT）。网络取证分析工具是记录和检测入侵并进行调查的网络流量分析处理系统。Xplico
13.4.1概述
PandoraAgent）。监控效果如图13-10所示。
墙/交换机流量等功能，最新的5.1版特别增强了对虚拟化系统的支持。Pandora的Web前端
用了。
13.4
Xplico是一个网络协议分析工具，主要分析Pcap 文件，可用做网络取证分析工具
在 Xplico Web 界面中的 Menu->Dissectors 中能看到它所支持的应用层协议。
注意：
Pandora 的下载地址是 http://pandorafms.com。
PandoraFMS是一款开源应用程序，不但能用来监测网站的各种活动，而且能监控防火
最后重启 Splunk 服务，系统将重新载入Vmware App，之后就可以从 web 界面登录使
5.使用Pandora监控虚拟机
C:Program Files\Splunk\bin>splunk.exe restart
应用层数据包解码
Sugest new
Report abug
Pandora FMS
PandoraFMS