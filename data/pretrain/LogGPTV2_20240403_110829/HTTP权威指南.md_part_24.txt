了那个客户端信息的服务器上去。状态码303 See Other和307 Temporary Redirect
可用于此类重定向。
注7： 有时会将这些经过扩展和状态增强的URL称为“胖URL”。
Web服务器 ｜ 133
• 规范目录名称
客户端请求的URI是一个不带尾部斜线的目录名时，大多数Web服务器都会将
客户端重定向到一个加了斜线的URI上，这样相对链接就可以正常工作了。
5.9 第六步——发送响应
Web服务器通过连接发送数据时也会面临与接收数据一样的问题。服务器可能有很
多条到各个客户端的连接，有些是空闲的，有些在向服务器发送数据，还有一些在
向客户端回送响应数据。
服务器要记录连接的状态，还要特别注意对持久连接的处理。对非持久连接而言，
服务器应该在发送了整条报文之后，关闭自己这一端的连接。
对持久连接来说，连接可能仍保持打开状态，在这种情况下，服务器要特别小心，
要正确地计算Content-Length首部，不然客户端就无法知道响应什么时候结束了
（参见第4章）。
5.10 第七步——记录日志
最后，当事务结束时，Web服务器会在日志文件中添加一个条目，来描述已执行的
事务。大多数Web服务器都提供了几种日志配置格式。更多细节请参见第21章。
5.11 更多信息
更多有关Apache、Jigsaw和ident的信息，参见以下参考资源
• Apache:The Definitive Guide8（《Apache权威指南》）
Ben Laurie和Peter Laurie编写，O’Reilly & Associates公司出版。
• Professional Apache
127 Peter Wainwright编写，Wrox公司出版。
• http://www.w3c.org/Jigsaw/
Jigsaw——W3C的服务器W3C联盟Web站点。
• http://www.ietf.org/rfc/rfc1413.txt
128 RFC 1413，M. St. Johns编写的“Identification Protocol”（“标识协议”）。
注8： 本书影印版由中国电力出版社出版。（编者注）
134 ｜ 第5章
第6章
代 理
135
Web代理（proxy）服务器是网络的中间实体。代理位于客户端和服务器之间，扮演
“中间人”的角色，在各端点之间来回传送HTTP报文。本章介绍了所有与HTTP
代理服务器有关的内容，为代理特性提供的特殊支持，以及使用代理服务器时会遇
到的一些棘手的问题。
本章主要内容如下：
• 对HTTP代理进行解释，将其与Web网关进行对比，并说明如何部署代理；
• 给出一些代理所能提供的帮助；
• 说明在现实网络中是怎样部署代理以及如何将网络流量导向代理服务器；
• 说明如何配置浏览器来使用代理；
• 展示HTTP的代理请求，说明它们与服务器请求的区别，以及代理是如何微妙地
改变浏览器行为的；
• 解释如何通过Via首部和TRACE方法来记录报文传输路径上的代理服务器链；
• 描述基于代理的HTTP访问控制方法；
• 解释代理如何与客户端和服务器进行交互，每个客户端和服务器支持的特性和使
用的版本都可能有所不同。
6.1 Web的中间实体
Web上的代理服务器是代表客户端完成事务处理的中间人。如果没有Web代理，
HTTP客户端就要直接与HTTP服务器进行对话。有了Web代理，客户端就可以与
代理进行对话，然后由代理代表客户端与服务器进行交流。客户端仍然会完成对事
129 务的处理，但它是通过代理服务器提供的优质服务来实现的。
HTTP的代理服务器既是Web服务器又是Web客户端。HTTP客户端会向代理发送
请求报文，代理服务器必须像Web服务器一样，正确地处理请求和连接，然后返回
响应。同时，代理自身要向服务器发送请求，这样，其行为就必须像正确的HTTP
客户端一样，要发送请求并接收响应（参见图6-1）。如果要创建自己的HTTP 代
理，就要认真地遵循为HTTP客户端和HTTP服务器制定的规则。
6.1.1 私有和共享代理
代理服务器可以是某个客户端专用的，也可以是很多客户端共享的。单个客户端专
用的代理被称为私有代理。众多客户端共享的代理被称为公共代理。
• 公共代理
大多数代理都是公共的共享代理。集中式代理的成本效率更高，更容易管理。某些
136 ｜ 第6章
代理应用，比如高速缓存代理服务器，会利用用户间共同的请求，这样的话，汇
入同一个代理服务器的用户越多，它就越有用。
• 私有代理
专用的私有代理并不常见，但它们确实存在，尤其是直接运行在客户端计算机上
的时候。有些浏览器辅助产品，以及一些ISP服务，会在用户的PC上直接运行
一些小型的代理，以便扩展浏览器特性，提高性能，或为免费ISP服务提供主机
广告。
对Web客户端来说，代理扮演
的是服务器的角色，接收请求
报文，返回响应报文。 对Web服务器来说，代理扮演的是客户端的角色，
发送Web请求报文，接收Web响应报文。
请求 请求
响应 响应
代理
客户端 服务器
图6-1 代理既是服务器，又是客户端
6.1.2 代理与网关的对比
严格来说，代理连接的是两个或多个使用相同协议的应用程序，而网关连接的则是
两个或多个使用不同协议的端点。网关扮演的是“协议转换器”的角色，即使客户
端和服务器使用的是不同的协议，客户端也可以通过它完成与服务器之间的事务
处理。 130
图6-2显示了代理和网关之间的区别。
• 图6-2a中的中间设备是一个HTTP 代理，因为代理与客户端和服务器之间使用
的都是HTTP协议。
• 图6-2b中的中间设备是一个HTTP/POP网关，因为它把HTTP的前台与POP
E-mail的后端连接了起来。网关将Web事务转换成适当的POP事务，这样用户
就可以通过HTTP读取E-mail了。基于Web的E-mail程序，比如Yahoo!邮件
和MSN Hotmail都是HTTP E-mail网关。
代 理 ｜ 137
(a)HTTP/HTTP 代理
HTTP HTTP
Web代理
浏览器 Web服务器
(b)HTTP/POP网关
HTTP POP
浏览器 Web/E-mail网关 E-mail服务器
图6-2 代理使用同一种协议，网关则将不同的协议连接起来
实际上，代理和网关之间的区别很模糊。由于浏览器和服务器实现的是不同版本的
HTTP，代理也经常要做一些协议转换工作。而商业化的代理服务器也会实现网关
的功能来支持SSL安全协议、SOCKS防火墙、FTP访问，以及基于Web的应用程
序。我们将在第8章详细介绍网关。
6.2 为什么使用代理
代理服务器可以实现各种时髦且有用的功能。它们可以改善安全性，提高性能，节
省费用。代理服务器可以看到并接触到所有流过的HTTP流量，所以代理可以监视
流量并对其进行修改，以实现很多有用的增值Web服务。这里给出了几种代理使用
方法的示例。
• 儿童过滤器
小学在为教育站点提供无阻碍访问的同时，可以利用过滤器代理来阻止学生访问
131 成人内容。如图6-3所示，代理应该允许学生无限制地访问教育性内容，但对不
适合儿童的站点要强行禁止访问。1
• 文档访问控制
可以用代理服务器在大量Web服务器和Web资源之间实现统一的访问控制策
略，创建审核跟踪机制。这在大型企业环境或其他分布式机构中是很有用的。
在集中式代理服务器上可以对所有访问控制功能进行配置，而无需在众多由
不同组织管理、不同厂商制造、使用不同模式的 Web 服务器上进行经常性
注1： 有些公司和非营利性组织提供了过滤软件，维护了一些“黑名单”，以识别并限制对危害性内容的访问。
138 ｜ 第6章
的访问控制升级。2
OK
儿童用户
服务器
因特网
DENY
儿童用户
服务器
学校的过滤代理
图6-3 代理应用程序实例：儿童安全的因特网过滤器
在图6-4中，集中式访问控制代理：
 允许客户端1无限制地访问服务器A的新闻页面；
 客户端2可以无限制地访问因特网；
 在允许客户端3访问服务器B之前，要求其输入口令。
一般 一般
的新闻 的新闻
访问控
客户端1
制代理
服务器A
连接到因特网 因特网
客户端2 局域网
保密
的财
想要发往服 务数据
客户端3 务器B的请求
服务器B
被阻止了
访问这些财务数
据的密码是什么？
图6-4 代理应用程序实例：集中式文档访问控制
注2： 为防止一些经验丰富的用户蓄意绕过控制代理，可以静态地配置Web服务器，使其仅接受来自代理
服务器的请求。
代 理 ｜ 139
• 安全防火墙
网络安全工程师通常会使用代理服务器来提高安全性。代理服务器会在网络中的
单一安全节点上限制哪些应用层协议的数据可以流入或流出一个组织。还可以提
供用来消除病毒的Web和E-mail代理使用的那种挂钩程序，以便对流量进行详
132 细的检查（参见图6-5）。
服务器
客户端
因特网
客户端 过滤路由器 过滤路由器
服务器
防火墙代理 病毒
客户端
防火墙 防火墙
服务器
图6-5 代理应用程序实例：安全防火墙
• Web缓存
代理缓存维护了常用文档的本地副本，并将它们按需提供，以减少缓慢且昂贵的
因特网通信。
在图6-6中，客户端1和客户端2会去访问附近Web缓存上的对象A，而客户
133 端3和客户端4访问的则是原始服务器上的文档。
• 反向代理
代理可以假扮Web服务器。这些被称为替代物（surrogate）或反向代理（re-
verse proxy）的代理接收发给Web服务器的真实请求，但与Web服务器不同的
是，它们可以发起与其他服务器的通信，以便按需定位所请求的内容。
可以用这些反向代理来提高访问慢速Web服务器上公共内容时的性能。在这种
配置中，通常将这些反向代理称为服务器加速器（server accelerator）（参见图
6-7）。还可以将替代物与内容路由功能配合使用，以创建按需复制内容的分布式
网络。
140 ｜ 第6章
客户端3
客户端1
客户端4
Web代理缓存
客户端2
原始
服务器
图6-6 代理应用程序实例：Web缓存
因特网
替代物
客户端 (也称为反向代理 服务器
或服务器加速器)
图6-7 代理应用程序实例：（服务器加速器实现方式中的）替代物
• 内容路由器
代理服务器可以作为“内容路由器”使用，根据因特网流量状况以及内容类型将
请求导向特定的Web服务器。
内容路由器也可以用来实现各种服务级的请求。比如，如果用户或内容提供者付
费要求提供更高的性能，内容路由器可以将请求转发到附近的复制缓存（参见图 134