**7、使用永恒之蓝漏洞攻击**
接下来，启动线程进行永恒之蓝漏洞攻击。
病毒使用异或的方式加密了部分数据包，在内存中重构后发送数据包，这样就避免了杀毒软件的静态查杀。
**8、文件加密**
Petya采用RSA2048 +
AES128的方式对文件进行加密，程序中硬编码RSA公钥文件，每一个盘符会生成一个AES128的会话密钥，该盘符所有文件均对该AES Key进行加密。
**9、清除日志并重启**
执行完加密文件和网络传播流程后，病毒将清除Windows系统日志并强制重启。重启后将执行病毒写入的MBR并加密磁盘。加密完成后显示勒索信息并等待用户输入key。
**Petya勒索加密技术分析**
**1、 篡改MBR**
当系统重启后，执行病毒的MBR，伪装成CHKDSK进行加密磁盘，加密完成后弹出敲诈信息对用户进行敲诈。
图 4 Petya敲诈信息
下面，我们来对修改后的MBR进行分析:
1）读取第20个扇区判断是否已经加密，执行相应流程
2）加密流程，读取病毒配置信息， 病毒加密用的key存在第0x20个扇区
3）设置已经加密的标志位，并把配置信息中的key清0， 写回磁盘第20扇区
4）使用用户输入的key尝试解密
**2、加密文件**
勒索木马Petya采用RSA2048 +
AES128的方式对文件进行加密，程序中硬编码RSA公钥文件，针对每一个盘符都会生成一个AES128的会话密钥，该盘符所有文件均对该AES Key进行加密。
根据后缀名对相关文件进行分类，涉及的文件格式如下表：
_“.3ds “,”.7z “,”.accdb “,”.ai “,”.asp “,”.aspx “,”.avhd “,”.back “,”.bak
“,”.c “,”.cfg “,”.conf “,”.cpp “,”.cs “,”.ctl “,”.dbf “,”.disk “,”.djvu
“,”.doc “,”.docx “,”.dwg “,”.eml “,”.fdb “,”.gz “,”.h “,”.hdd “,”.kdbx
“,”.mail “,”.mdb “,”.msg “,”.nrg “,”.ora “,”.ost “,”.ova “,”.ovf “,”.pdf
“,”.php “,”.pmf “,”.ppt “,”.pptx “,”.pst “,”.pvi “,”.py “,”.pyc “,”.rar
“,”.rtf “,”.sln “,”.sql “,”.tar “,”.vbox “,”.vbs “,”.vcb “,”.vdi “,”.vfd
“,”.vmc “,”.vmdk “,”.vmsd “,”.vmx “,”.vsdx “,”.vsv “,”.work “,”.xls “,”.xlsx
“,”.xvd “,”.zip “_
Petya的加密流程如下图：
图 5 加密流程
1）启动加密文件线程
2）递归枚举目录并加密
3）写入Readme .txt文件
Readme .txt文件中包含比特币支付地址。
**Petya勒索杀毒软件攻防分析**
在提权阶段，Petya会通过CreateToolhelp32Snapshot枚举系统进程，判断是否有指定的安全软件，并设置标记。枚举过程中，通过将进程名称进行异或计算得出一个值，并将该值与预设的值进行比较，可见此处Petya是在寻找特定名称的进程。
通过分析，我们确认Petya主要针对杀毒软件诺顿和卡巴斯基进行了反检测处理。
1、当存在NS.exe(诺顿)或ccSvcHst.exe(诺顿)进程时，不执行漏洞感染流程。
2、当存在avp.exe(卡巴斯基)进程时，不执行MBR感染流程。
**缓解措施建议**
针对Petya勒索软件，360追日团队提醒广大用户警惕防范，我们建议用户采取以下措施以保障系统安全：
1、保证系统的补丁已升级到最新，修复永恒之蓝(ms17-010）漏洞。
2、临时关闭系统的WMI服务和删除admin$共享，阻断蠕虫的横向传播方式。具体操作为，右键cmd.exe"以管理员身份运行"，输入如下命令：
    net stop winmgmt
    net share admin$ /delete
3、如若不幸中招，也可以采取一些措施来减小损失。
由于在感染Petya的过程中，病毒会先重启电脑加载恶意的磁盘主引导记录（MBR）来加密文件，这中间会启用一个伪造的加载界面。中招者如果能感知到重启异常，在引导界面启动系统前关机或拔掉电源，随后可以通过设置U盘或光盘第一顺序启动PE系统，使用PE系统修复MBR或者直接转移硬盘里的数据，可以在一定程度上避免文件的损失。
**总结**
Petya勒索病毒早已被安全厂商披露，而此次Petya卷土重来，肆虐欧洲大陆在于其利用了已知的OFFICE漏洞、永恒之蓝SMB漏洞、局域网感染等网络自我复制技术，使得病毒可以在短时间内呈暴发态势。另一方面，Petya木马主要通过加密硬盘驱动器主文件表（MFT），使主引导记录（MBR）不可操作，通过占用物理磁盘上的文件名、大小和位置的信息来限制对完整系统的访问，从而让电脑无法启动，相较普通勒索软件对系统更具破坏性。
自5月份WannaCry勒索病毒爆发后，中国用户已经安装了上述漏洞的补丁，同时360安全卫士具备此次黑客横向攻击的主动防御拦截技术，故而并没有为Petya勒索病毒的泛滥传播提供可乘之机。
**360追日团队（Helios Team）**
360 追日团队（Helios
Team）是360公司高级威胁研究团队，从事APT攻击发现与追踪、互联网安全事件应急响应、黑客产业链挖掘和研究等工作。团队成立于2014年12月，通过整合360公司海量安全大数据，实现了威胁情报快速关联溯源，独家首次发现并追踪了三十余个APT组织及黑客团伙，大大拓宽了国内关于黑客产业的研究视野，填补了国内APT研究的空白，并为大量企业和政府机构提供安全威胁评估及解决方案输出。
已公开APT相关研究成果
[](https://p4.ssl.qhimg.com/t01145db6017e6d3037.png)
联系方式
邮箱：PI:EMAIL
微信公众号：360追日团队
扫描下方二维码关注微信公众号
[](https://p5.ssl.qhimg.com/t016b2dd452d92d8e0f.png)