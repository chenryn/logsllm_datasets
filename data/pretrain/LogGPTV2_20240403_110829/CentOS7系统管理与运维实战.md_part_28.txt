./configure
--prefix=/usr/local/php
第7章搭建LNMP服务
189
---
## Page 202
机器之间的轮询转发。轮询算法的负载均衡配置如【示例7-5】所示。
7.2.1Nginx负载均衡设置
定制方法可以参考第6章中的相关章节。
将PHP请求发送给FastCGI进程处理，因此安装时需要使用上述参数。更多参数及更详细的
为指定“--enable-fpm”参数。在Apache 将 PHP 作为一个模块进行加载，而 Nginx通常则是
Centos7系统管理与运维实战
190
哈希等。
的负载均衡和反向代理相关的设置。
Nginx 除作为 Web 服务器外，另外支持多种负载均衡算法。常见的算法如轮询、权重、IP
【示例7-5】
（1）轮询算法：每次将请求顺序分配到不同的服务器，通过此算法可以实现请求在多台
[rooteCentos vhost]# cat -n www.test.com.conf
Nginx是一款优秀的 Web 软件，同时支持负载均衡和反向代理功能，本节主要介绍Nginx
[root@Centos php-5.4.16]#make install
安装
[root@Cent0s php-5.4.16]#make
编译源码
“--enable-fastcgi”含义为开启PHP的FastCGI支持，另外一种开启FastCGI支持的方式
MySQL安装方法与第6章中介绍的方法相同，此处不再赘述。
servert
upstream test_svr
Nginx负载均衡与反向代理
server
server192.168.19.79:8080;
server 192.168.19.78:8080;
locatior
access_log
server_name
listen
error_log
192.168.19.80:8080;
/data/logs/www.test.com.error.log;
/data/logs/www.test.com.log main;
www.test.com;
192.168.19.101:80;
---
## Page 203
需要在conf目录中建立文件proxy.conf并修改www.test.com.conf，如【示例7-8】所示。
合在一起，从而提升静态网页的访问速度，因此可以实现较好的负载均衡。如需设置反向代理，
算法将请求转发给后端的真实Web服务器，可以将负载均衡和代理服务器的高速缓存技术结
7.2.2Nginx反向代理配置
服务器上。IP哈希负载均衡主要通过指令ip_hash 指定，如【示例7-7】所示。
相同的客户端经过IP哈希算法后的值相同，因此同一客户端的请求可以分配到后端的同一台
务器。
时间内出现了max_fails次连接失败，那么Nginx就会认为该服务器已经故障，从而剔除该服
示该服务器可以接收更多的请求。max_fails和fail_timeout表示如果某台服务器在fail_timeout
当后端服务器故障时可以自动剔除该服务器，此算法配置方法如【示例7-6】所示。
反向代理方式与普通的代理方式有所不同，使用反向代理服务器可以根据指定的负载均衡
【示例7-7】
其中，test_svr 为服务器组名。weight 设置服务器的权重，默认值是1，权重值越大，表
【示例7-6】
在 nginx.conf配置文件中，用upstream 指令定义一组负载均衡后端服务器池。
（3）IP哈希算法：此算法根据用户的客户端IP将请求分配给后端的服务器，由于源IP
（2）权重算法：通过将不同的后端服务器设置不同的权重以便实现请求的按比例分配
N
N
upstream
server192.168.19.79:8080;
server
iphash:
server
server
192.168.19.78:8080
test
root
ndex
192.168.19.80:8080 weight=6max fai1s=1 fail_time0ut=10s
192.168.19.79:8080 weight=2 max fai1s=1 fai1 timeout=10s;
192.168.19.78:8080 we1ght=2
svr
svr
pass
index.html index.htm;
/data/www.test.com
http://test svr
max fails=l fail
第7章搭建LNME
AP
服务
191
---
## Page 204
CentoS7系统管理与运维实战
192
document_root$fastcgi_script_namei
[root@centos conf]# cat
【示例7-8】
N
上
N
上
serverf
proxy_next_ upstream error timeout
proxy_temp file write size 64k;
proxy buffers 4 32k;
proxy buffer_size 32k;
proxy read timeout
proxy_send
client body buffer size 128k;
client
proxy_set _header X-Forwarded-For Sremote_addr;
proxy_set header Host shost;
proxy redirect off;
location
server _name www.test.com;
listen 192.168.19.101:80;
location
Location
server 192.168.19.79:8080 weight=2
server 192.168.19.78:8080 weight=2 max_fai1s=1 fail timeout=10s;
fastcgi_param SCRIPT FILENAME
access_log /data/logs/www.test.com-access_log main;
max body size 10m;
fastcgi index index.php;
astcgi
expires 2d;
pass 127.0.0.1:9000;
^,+\.(js1css/ico1jpgljpeg/giflpnglswf|rar/zip)$
n vhost/www.test.com.conf
-n proxy.
3；
3;
conf
svr;
http_500 http_502 http_503http_504;
max fails=l fail_timeout=10s;
---
## Page 205
软件安装与设置主要经过以下几个步骤。
7.3.1spawn-fcgi集成方式
Nginx 和 PHP。
php-fm方式。两种集成方式类似，并无太大区别，本节主要介绍如何通过这两种方式集成
则可以从变量X-Forwarded-For中获取。
中第3行表示将客户端真实的IP传送给后端服务器，如后端服务器需要获取客户端的真实IP，
tp://download.1ighttpd.net/spawn-
使用 spawn-fcgi与 PHP集成首先要安装相应的软件,这里的版本为 spawn-fcgi-1.6.4.tar.gz,
1.spawn-fcgi软件安装
Nginx与PHP 的常见集成方式有两种：一种是通过 spawn-fcgi方式，另外一种是通过
如需了解更多参数的相关介绍，可以参考Nginx的帮助手册。
#安装
编译源码
rootecentos
#检查系统环境
root@centos
rootecentos
rootecentos
[rootecentos soft]# wget
#下载解压源码包
【示例7-9】
安装过程如【示例7-9】所示。
第24行表示如果是以php为扩展名的文件，则转给本地的FastCGI处理。proxy.conf文件
第17行表示请求的文件如果为指定的扩展名，则直接从指定目录读取。
其中，第14行“proxy_pass http://test_svr”用于指定反向代理的服务器池。
33
P
access
集成Nginx与 PHP
spawn-fcgi-1.6.4]#./configure
spawn-
softi#
Log
da
ta/1
ogs/www.t
-fcgi/releases-1
est
Log
main
搭建LNMF
PF
193
---
## Page 206
CentOs7系统管理与运维实战
194
结尾，则将请求转到本机127.0.0.1的9000端口处理。
本节需要的配置文件如【示例7-10】所示。
时需要使用选项“--enable-fastcgi"。
spawn-fcgi安装完成后，需要安装PHP，安装命令可参考示例7-4。
spawn-fcgi集成方式需要PHP的FastCGI程序位于/usr/local/php/bin/php-cgi，在编译PHP
[root@Centos spawn-fcgi-1.6.4]#make install
第11行指定了默认的首页文件。
【示例7-10】
本节主要进行虚拟主机的相关配置。www.test.com对应的虚拟主机配置可参考7.1.1小节。
2.虚拟主机设置
经过上面的步骤需要的软件 spawn-fcgi已经安装完成，位于/usr/local/spawn-fcgi目录下。
第8~14行为PHP与 spawn-fcgi集成的关键配置，
第4行指定了虚拟主机对应的主目录。
第3行为指定虚拟主机对应的域名，如有多个域名可以使用空格分隔。
第1行指定虚拟主机配置的开始。
以上设置为虚拟主机www.test.com支持PHP的设置。
[root@Centos vhost]# cat-n www.test.com.conf
20
13
ent
12
11
rootsfastcgi script name;
server
location~
1isten 192.168.3.88:80;
error
access log
root
server name www.test.com
index
include
fastcgi param SCRIPT FILENAME
fastcgi pass127.0.0.1:9000:
fastcgi index index.php!
log
phps
/data/logs/www.test.com.error.log;
/data/logs/www.test.
index.htm
com.access.log
，表示如果访问的文件以“php”扩展名
---
## Page 207
服务启动时监听的端口，
5015/php-cgi
所示。
125/nginx
经过上面的步骤 spawn-fcgi已经启动。“-a”参数表示服务启动时绑定的 IP，“-p”表示
tcp
#检查是否启动成功
#启动Nginx
tcp
[root@Centos bin]#./spawn-fcgi-a 127.0.0.1-P 9000 -f
【示例7-11】
经过上面的设置相关配置已经完成，然后进行 spawn-fcgi的启动，启动命名如【示例7-11】
Nginx启动成功后，
5.集成结果测试
rooteCentos sbinl#
编辑测试文件
【示例7-12】
编辑测试文件index.php并启动Nginx，文件内容及启动命令如【示例7-12】所示。
4.编辑测试文件
[root@centos ~]# netstat
[rooteCentos ~]# cd /usr/local/spawn-fcgi/bin/
#启动spawn-fcgi
3.启动spawn-fcgi
第13行表示包含/usr/local/nginx/conf目录下的fastcgi_params文件。
第12行指定了PHP对应的处理CGI。
K?php
0
phpinfo();
fcgi是否启动成功
08:00000
0127.0.0.1:9000
，可以进行访问测试，测试结果如图7.1所示。
“-f”指定了php-cgi文件所在的位置。
./nginx
-plnt1grep 9000
-plnt/grep 80
.0.0.0
0.0.0.0:*
第7章搭建LNMP服务
195
---
## Page 208
7.3.2
成，已经成功运行，然后可以进行PHP程序的开发了。
Centos7系统管理与运维实战
196
高效，为推荐的集成方式。本节主要介绍php-fpm集成过程与测试，主要经过以下几个步骤。
的源码，安装时只需开启“--enable-fpm”参数即可。相对于 spawn-fcgi，php-fpm处理方式更
配置完成后，然后可以进行PHP-FPM的启动，启动命令如【示例7-14】所示。
经过上面的步骤，PHP软件已经安装完成，关键文件位于/usr/local/php/sbin/php-fpm。
[root@Centos php-5.4.16]#./configure--prefix=/usr/local/php
1.编译安装 PHP
php-fpm同 spawn-fcgi类似，是FastCGI进程管理器，最新的PHP版本已经集成php-fpm
3.启动程序php-fpm
本节主要进行虚拟主机的相关设置，www.test.com对应的虚拟主机配置同7.3.1小节的内容。
2.虚拟主机配置
[root@CentOS php-5.4.16]#make install
[root@Cent0s php-5.4.16]#make
【示例7-13】
PHP编译安装过程如【示例7-13】所示。
如正常出现上述输出“Server API CGI/FastCGI”，则表示Nginx 通过 spawn-fcgi与 PHP 集
php-fpm集成方式
ww.test.com
Configure Command
Build Date
System
PHP Version 5.4.16
dditionel
图7.1spawn-fcgi集成方式测试
(none)
(none)-
/configu
Apr172015
00412
FastCGI
--enable-fpm
prerix=/usr/local/php
Google
-with-mysql=/usr/local/mysgl'
php
Q☆自
---
## Page 209
集成，已经成功运行，然后可以进行PHP程序的开发了。
Nginx启动成功后，测试结果如图7.2所示。
php-fpm.conf文件中的默认设置。
37815/php-fpm:mast
经过上面的步骤程序/usr/local/php/sbin/php-fpm已经启动，启动时需要的配置采用了
如正常出现上述输出“Server API FPM/FastCGI”，则表示Nginx 通过PHP-FPM与 PHP
编辑测试文件index.php并启动Nginx，
tep
[root@centos
#检查启动结果
[rootecentos
#启动相关进程
4.测试
Iroot@centos
root@centos etc)#mv php-fpm.conf.defaultphp-fpm.con
此文件为php-fpm程序需要的配置文件
root@Centos1#cd/usr/local/php/etc
【示例7-14】
0
]#/usr/local/php/sbin/php-fpm
~1#killall-9php-cgi
phpiato0
地址http://.test.com/
Zend Extension
adanthsdinfores
System
查找