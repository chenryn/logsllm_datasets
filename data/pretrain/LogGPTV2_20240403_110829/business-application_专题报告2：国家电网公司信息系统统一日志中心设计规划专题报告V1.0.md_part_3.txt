日志中心中用于日志采集的agent具有如下特点：
-   基于日志文件、无侵入式的收集日志
-   只读取文件
-   安全、可靠
-   支持文件轮转不丢失数据
-   支持本地缓存
-   网络异常重试
-   方便管理
-   web端可视化配置
-   完善自我保护
-   实时监控进程CPU、Mem消耗，限制使用上限
## 日志存储技术
采用kafka完成原始日志的收集存储以及解析后日志的存储。
Kafka 是一种高吞吐量 的分布式发布订阅消息系统，有如下特性：
通过的磁盘数据结构提供消息的持久化，这种结构对于即使数以TB的消息存储也能够保持长时间的稳定性能。
高吞吐量，即使是非常普通的硬件Kafka也可以支持每秒数百万的消息。
支持通过Kafka服务器和消费机集群来分区消息。
支持Hadoop并行数据加载。
![](media/image3.png){width="4.0159722222222225in"
height="3.6465277777777776in"}
图 4 kafka消息存储结构图
kafka对消息保存时根据Topic进行归类，一个Topic可以认为是一类消息，每个topic将被分成多个partition(区),每个partition在存储层面是append
log文件。任何发布到此partition的消息都会被直接追加到log文件的尾部，每条消息在文件中的位置称为offset（偏移量），offset为一个long型数字，它是唯一标记一条消息。
![](media/image4.png){width="3.5229166666666667in"
height="2.2729166666666667in"}
图 5 kafka消息存储结构图
日志中心的数据存储具备以下特点：
数据高安全性 :
-   用户写入的每条日志，都会被保存3份
-   任意磁盘顺坏、机器宕机情况下，数据自动复制修复
稳定服务：
-   进程crash、机器宕机kafka中的数据自动迁移
-   自动负载均衡，确保无单机热点
```{=html}
```
-   可以进行水平扩展，用户可以按需动态增加节点数来增加吞吐
## 集群资源同步与管理
采用ZooKeeper实现集群资源的同步。
ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，它包含一个简单的原语集，分布式应用程序可以基于它实现同步服务，配置维护和命名服务等。在分布式应用中，由于工程师不能很好地使用锁机制，以及基于消息的协调机制不适合在某些应用中使用，因此需要有一种可靠的、可扩展的、分布式的、可配置的协调机制来统一系统的状态。
![说明: c:\\users\\administrator\\appdata\\roaming\\360se6\\User
Data\\temp\\08171345_l5K3.jpg](media/image5.jpeg){width="5.770833333333333in"
height="2.838888888888889in"}
图 6 Zookeeper逻辑结构图
1、客户端可以连接到每个server，每个server的数据完全相同。
2、每个follower都和leader有连接，接受leader的数据更新操作。
3、Server记录事务日志和快照到持久存储。
4、大多数server可用，整体服务就可用。
## 日志分析与计算
采用Spark对海量日志进行流式实时计算处理。
Spark是继Hadoop之后，成为替代Hadoop的下一代云计算大数据核心技术。目前SPARK已经构建了自己的整个大数据处理生态系统。它是一种与
Hadoop
相似的开源集群计算环境，但是两者之间还存在一些不同之处，这些有用的不同之处使
Spark 在某些工作负载方面表现得更加优越，换句话说，Spark
启用了内存分布数据集，除了能够提供交互式查询外，它还可以优化迭代工作负载。
![说明: c:\\users\\administrator\\appdata\\roaming\\360se6\\User
Data\\temp\\214117yyvxv0nudh88t0dd.png](media/image6.png){width="5.5625in"
height="2.6041666666666665in"}
图 7 Spark集群运行模式图
Spark平台可以支持日志挖掘分析类计算、交互式实时查询计算以及允许误差范围的快速查询计算。这一点十分适合做日志这样海量数据的分析、处理及查询。
## 搜索引擎技术
借助ElasticSearch等技术实现对日志的快速、实时检索。
ElasticSearch是一个开源的分布式搜索引擎，具备高可靠性，支持非常多的企业级搜索用例。ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful
web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是第二流行的企业搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。
## 前端服务
采用LVS + Nginx构建的前端机器，主要有以下特点：
-   Http、rest协议
-   水平扩展
-   流量上涨时可快速通过增加前端机来提高处理能力
-   高吞吐、低延时
-   纯异步处理，单个请求异常不会影响其他请求
-   内部采用专门针对日志的Lz4压缩，提高单机处理能力，降低网络带宽
# 安全保障技术
日志分析平台总的安全目标有以下五个方面。
（1）完整性
完整性是指信息没有遭受到以未授权方式所作的篡改和或未经授权的使用。数据完整性服务以抵制主动攻击，在信息传输、存储过程中，保证接收者收到的信息与发送者发送的信息完全一致，也就是说数据完整性要确保信息的真实性。
（2）可用性
系统可用性是指系统无故障、不受外界影响、能稳定可靠运行的性能。它包含硬件、部件、设施的稳定可靠性、抗毁性和抗干扰性。可用性机制包括抗毁机制、设备备份机制、抗病毒机制、容错机制以及设备的安全运行措施。本方案涉及备份、容错等机制。系统的可用性强调系统的可恢复性，即系统遭受入侵、破坏以及病毒感染等各种原因受损后，能恢复系统运行环境、保持系统运行功能或系统降级运行。
（3）真实性
信息的真实性是指与现实相一致，不能被伪造或假冒。系统采用实体鉴别(身份认证)和信息源鉴别技术来保证信息的真实性。
（4）可控性
可控性包括对信息访问主体的权限划分和更换，以及信息交换双方已发生的操作进行确认，并包括对关键信息(如密钥)的控制.
（5）可审查性
可审查性是指对本系统内所发生的与安全有关的事件均有记录备查，形成一种信息系统的安全跟踪机制。
## 访问控制
（1）外部系统对本系统的访问
外部系统访问本系统数据时采用完善的数据防火墙技术，支持基于源、目的IP、协议、端口以及时间段的访问控制列表策略；支持IP
与MAC 地址的绑定，有效防止IP
地址的欺骗；支持认证、授权、记录用户信息的AAA
认证技术；支持基于数据包内容的地址识别；只接收系统认可的地址传送来的数据，从其它地址送来的数据，系统不接收；对数据流量进行实时监视，当数据流量超过系统适应性门限时，对数据进行过滤，防止瞬时大容量数据对系统内部网络造成阻塞。
（2）本系统对外部系统的访问
系统对向外部系统送出的数据进行基于源、目的地址、端口和数据类型的认证，禁止向非认可地址发送数据，禁止向认可地址发送非认可类型的数据。
（3）内部访问
对数据的访问需授权(Authorization)
：应用操作权限控制、数据库和文件访问权限控制等。用户在登录和进行某些关键性操作、系统维护人员对适应性数据进行操作、对数据进行整理输出等时，均需对其进行身份和权限的鉴别。不同的角色具有不同的权限，分级设置管理权限。
具有审计(Auditing)功能：对系统的登录、操作访问及越权操作、非法入侵等作详细的记录，以发现、告警系统中的非法活动，以及追查责任。
## 网络隔离技术
网络隔离技术是指通过专用硬件使两个或两个以上的网络在不连通的情况下进行网络之间的安全数据传输和资源共享的技术。其基本原理是：切断网络之间的通用协议连接；将数据包进行分解或重组为静态数据；对静态数据进行安全审查，包括网络协议检查和代码扫描等；确认后的安全数据流入内部单元；内部用户通过严格的身份认证机制获取所需数据。
## 加密技术
加密技术是信息系统采取的主要安全保密措施，是最常用的安全保密手段,利用技术手段把重要的数据变为乱码(加密)传送，到达目的地后再用相同或不同的手段还原(解密)。加密技术包括两个元素：算法和密钥。
## 防火墙技术
防火墙实际上是一种访问控制技术，在某个机构的网络和不安全的网络之间设置障碍，阻止对信息资源的非法访问，也可以使用防火墙阻止保密信息从受保护网络上被非法输出。换言之，防火墙是一道门槛，控制进出两个方向的通信。通过限制与网络或某一特定区域的通信，以达到防止非法用户侵犯受保护网络的目的
## 采用入侵检测系统
试图破坏信息系统的完整性、机密性、可信性的任何网络活动，都称为网络入侵。入侵检测技术是为保证计算机系统的安全而设计与配置的一种能够及时发现并报告系统中未授权或异常现象的技术，是一种用于检测计算机网络中违反安全策略行为的技术。在入侵检测系统中利用审计记录，入侵检测系统能够识别出任何不希望有的活动，从而达到限制这些活动，以保护系统的安全。
## 网络安全管理规范
网络安全技术的解决方案必须依赖安全管理规范的支持，在网络安全中，除采用技术措施之外，加强网络的安全管理，制定有关的规章制度，对于确保网络安全、可靠地运行将起到十分有效的作用。网络的安全管理策略包括：确定安全管理等级和安全管理范围；制订有关网络操作使用规程和人员出入机房管理制度；制定网络系统的维护制度和应急措施等。
# 非功能性相关设计
## 性能
采用高性能分布式架构，支持每日TB级别的日志量，每秒钟可处理10万条日志，搜索分析结果秒级延时，让用户查询到十几秒钟之前产生的日志。系统在云环境中运行，可根据日志量的增长逐步扩容。
（1）以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间复杂度的访问性能。