# AAAI-20论文解读：基于图神经网络的二进制代码分析

##### 译文声明
本文是翻译文章，仅供参考。具体内容和含义以原文为准。

腾讯安全科恩实验室的研究论文《Order Matters: Semantic-Aware Neural Networks for Binary Code Similarity Detection》入选了人工智能领域顶级学术会议AAAI-20。该研究利用AI算法解决大规模二进制程序函数相似性分析的问题。本文将对该论文进行深入解读。点击以下链接获取完整论文：[Order Matters: Semantic-Aware Neural Networks for Binary Code Similarity Detection](https://keenlab.tencent.com/en/whitepapers/Ordermatters.pdf)

## 引言 & 背景

二进制代码分析是信息安全领域的重要研究方向之一，其目标之一是在不访问源代码的情况下检测相似的二进制函数。同一份源代码在不同编译器、平台和优化选项下生成的二进制代码各不相同。我们的任务是识别出这些由同一源代码编译而来的不同二进制代码。传统方法使用图匹配算法来解决这一问题，但这种方法速度慢且准确率低。近年来，随着深度学习的发展，研究人员开始尝试在控制流图（CFG）上应用图神经网络算法，并取得了显著成果。

### Gemini算法概述

Gemini是一种基于图神经网络的算法，用于比较两个二进制函数的相似度。其输入是一对二进制函数，输出是它们之间的相似度得分。首先，Gemini将二进制函数的控制流图作为输入，并通过人工设计的特征提取方法将每个基本块（block）表示为一个低维向量。然后，它使用Structure2vec算法计算图嵌入（graph embedding），最后通过Siamese网络计算相似度得分并使用梯度下降法训练模型。

尽管Gemini在速度和准确性方面有所提升，但仍存在一些关键问题：
1. **语义信息损失**：每个基本块被压缩成一个8维向量，这会导致大量语义信息的丢失。
2. **节点顺序特征未被充分利用**：在二进制代码中，节点顺序是一个重要特征，但之前的模型并未专门设计算法来提取这一特征。

### 新框架的设计

为了解决上述问题，我们提出了一种新的框架，包含三个模块：语义感知（semantic-aware）、结构感知（structural-aware）和顺序感知（order-aware）。

## 模型

### 整体结构

模型的输入是二进制代码的控制流图，整体结构如图4所示，包括三个主要模块：
1. **语义感知模块**：使用BERT等预训练模型提取语义信息。
2. **结构感知模块**：使用消息传递神经网络（MPNN）算法计算图的语义和结构嵌入。
3. **顺序感知模块**：使用卷积神经网络（CNN）从邻接矩阵中提取节点顺序信息。

最终，通过拼接和多层感知机（MLP）得到最终的图嵌入。

### 语义感知模块

在语义感知模块中，我们使用BERT对控制流图进行预训练，以提取每个基本块的语义信息。BERT原本用于自然语言处理（NLP）中的词语和句子预训练。在我们的任务中，控制流图的基本块可以看作句子，其中的token可以看作词语。BERT的预训练任务包括：
- **掩码语言模型（MLM）**：对基本块中的token进行掩码操作并预测。
- **相邻节点预测（ANP）**：预测控制流图中相邻的基本块。
- **块内图（BIG）**：判断两个基本块是否在同一图中。
- **图分类（GC）**：对基本块进行分类，判断其属于哪个平台、编译器和优化选项。

### 结构感知模块

经过BERT预训练后，我们使用MPNN算法计算控制流图的语义和结构嵌入。MPNN包含三个步骤：
- **消息函数（M）**：使用多层感知机（MLP）。
- **更新函数（U）**：使用门控循环单元（GRU）。
- **读出函数（R）**：使用求和操作。

### 顺序感知模块

顺序感知模块旨在提取节点顺序的信息。我们选择使用卷积神经网络（CNN）模型。这是因为CNN能够学习到平移不变性和伸缩不变性，从而有效地捕捉节点顺序的变化。具体来说，我们考虑图6中的三个图及其邻接矩阵，通过CNN可以从邻接矩阵中提取出重要的顺序特征。

## 总结

本文介绍了一种基于图神经网络的新框架，用于二进制代码相似性检测。该框架通过语义感知、结构感知和顺序感知模块，有效解决了传统方法中的语义信息损失和节点顺序特征未充分利用的问题。实验结果表明，新框架在速度和准确性方面均有显著提升。