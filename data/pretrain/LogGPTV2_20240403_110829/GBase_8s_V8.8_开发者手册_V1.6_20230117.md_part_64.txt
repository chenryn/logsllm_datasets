 日志记录
MOT日志记录与基于磁盘的表的其它记录写入同一个数据库事务日志。
日志的大小取决于事务吞吐量、数据更改的大小和检查点之间的时间（每次检查点，重
做日志被截断并重新开始扩展）。
与基于磁盘的表相比，MOT使用较少的日志带宽和较低的IO争用。这由多种机制实现。
例如，MOT不会在事务完成之前记录每个操作。它只在提交阶段记录，并且只记录更
新的增量记录（不像基于磁盘的表那样的完整记录）。
为了确保日志IO设备不会成为瓶颈，日志文件必须放在具有低延迟的驱动器上。
有关配置的更多信息，请参阅存储（MOT）。
南大通用数据技术股份有限公司
449
GBase 8s V8.8开发者手册
13.2.3 MOT 部署
以下各小节介绍了各种必需和可选的设置，以达到最佳部署效果。
13.2.3.1 MOT 服务器优化
通常情况下，数据库由以下组件绑定：
 CPU：更快的CPU可以加速任何CPU绑定的数据库。
 磁盘：高速SSD/NVME可加速任何I/O绑定数据库。
 网络：更快的网络可以加速任何SQL*Net绑定数据库。
除以上内容外，以下通用服务器设置默认使用，可能会明显影响数据库的性能。
MOT性能调优是确保快速的应用程序功能和数据检索的关键步骤。MOT支持最新的硬
件，因此调整每个系统以达到最大吞吐量是极为重要的。
BIOS
HyperThreading设置为ON。
建议打开超线程（HT=ON）。建议在MOT上运行OLTP工作负载时打开超线程。当使
用超线程时，某些OLTP工作负载显示高达40%的性能增益。
操作系统环境设置
 NUMA
禁用NUMA平衡，如下所示。MOT以极其高效的NUMA-aware方式进行内存管理，
远远超过操作系统使用的默认方法。
echo0>/proc/sys/kernel/numa_balancing
 服务
禁用如下服务：
serviceirqbalancestop #MANADATORY
servicesysmonitorstop #OPTIONAL,performance
servicersyslogstop #OPTIONAL,performance
 调优服务
以下为必填项。
服务器必须运行throughput-performance配置文件。
南大通用数据技术股份有限公司
450
GBase 8s V8.8开发者手册
[...]$tuned-admprofilethroughput-performance
throughput-performance配置文件是广泛适用的调优，它为各种常见服务器工作负载提供
卓越的性能。
其他不太适合GBase8s和MOT服务器的配置可能会影响MOT的整体性能，包括：平
衡配置、桌面配置、延迟性能配置、网络延迟配置、网络吞吐量配置和节能配置。
 系统命令
推荐使用下列操作系统设置以获得最佳性能。
在/etc/sysctl.conf文件中添加如下配置，然后执行sysctl-p命令：
net.ipv4.ip_local_port_range=900065535
kernel.sysrq=1
kernel.panic_on_oops=1
kernel.panic=5
kernel.hung_task_timeout_secs=3600
kernel.hung_task_panic=1
vm.oom_dump_tasks=1
kernel.softlockup_panic=1
fs.file-max=640000
kernel.msgmnb=7000000
kernel.sched_min_granularity_ns=10000000
kernel.sched_wakeup_granularity_ns=15000000
kernel.numa_balancing=0
vm.max_map_count=1048576
net.ipv4.tcp_max_tw_buckets=10000
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_tw_recycle=1
net.ipv4.tcp_keepalive_time=30
net.ipv4.tcp_keepalive_probes=9
net.ipv4.tcp_keepalive_intvl=30
net.ipv4.tcp_retries2=80
kernel.sem=25064000001000215432
net.core.wmem_max=21299200
net.core.rmem_max=21299200
net.core.wmem_default=21299200
net.core.rmem_default=21299200
#net.sctp.sctp_mem=94500000915000000927000000
#net.sctp.sctp_rmem=819225000016777216
#net.sctp.sctp_wmem=819225000016777216
南大通用数据技术股份有限公司
451
GBase 8s V8.8开发者手册
net.ipv4.tcp_rmem=819225000016777216
net.ipv4.tcp_wmem=819225000016777216
net.core.somaxconn=65535
vm.min_free_kbytes=26351629
net.core.netdev_max_backlog=65535
net.ipv4.tcp_max_syn_backlog=65535
#net.sctp.addip_enable=0
net.ipv4.tcp_syncookies=1
vm.overcommit_memory=0
net.ipv4.tcp_retries1=5
net.ipv4.tcp_syn_retries=5
按如下方式修改/etc/security/limits.conf对应部分：
softnofile100000
hardnofile100000
软限制和硬限制设置可指定一个进程同时打开的文件数量。软限制可由各自运行这些限
制的进程进行更改，直至达到硬限制值。
 磁盘/SSD
下面以数据库同步提交模式为例，介绍如何保证磁盘读写性能适合数据库同步提交模式。
按如下方式运行磁盘/SSD性能测试：
[...]$sync;ddif=/dev/zeroof=testfilebs=1Mcount=1024;sync
1024+0recordsin
1024+0recordsout
1073741824bytes(1.1GB)copied,1.36034s,789MB/s
当磁盘带宽明显低于789MB/s 时，可能会造成GBase8s性能瓶颈，尤其是造成MOT
性能瓶颈。
网络
需要使用10Gbps以上网络。
运行iperf命令进行验证：
Serverside:iperf-s
Clientside:iperf-c
rc.local：网卡调优
以下可选设置对性能有显著影响：
1 将 https://gist.github.com/SaveTheRbtz/8875474 下的 set_irq_privacy.sh 文件拷贝到
南大通用数据技术股份有限公司
452
GBase 8s V8.8开发者手册
/var/scripts/目录下。
2 进入/etc/rc.d/rc.local，执行chmod命令，确保在boot时执行以下脚本：
'chmod+x/etc/rc.d/rc.local'
var/scripts/set_irq_affinity.sh-xall
ethtool-Kgrooff
ethtool-Cadaptive-rxonadaptive-txon
Replacewiththenetworkcard,i.e.ens5f1
13.2.3.2 MOT 配置
预置MOT用于创建工作MOT。为了获得最佳效果，建议根据应用程序的特定要求和
偏好自定义MOT配置（在mot.conf文件中定义）。
该文件在服务器启动时只读。如果在系统运行中编辑此文件，则必须重新加载服务器才
能使修改内容生效。
mot.conf文件与postgresql.conf配置文件在同一文件夹下。
在主备部署模式下，主备节点的mot.conf文件需要完全相同，否则，系统行为不明确。
阅读总体原则，根据需要查看和配置mot.conf文件。
以上描述了mot.conf文件中的各个设置。除上述内容外，要了解特定MOT功能（如恢
复），可参考本用户手册的相关章节。例如，MOT恢复说明了mot.conf文件的恢复，
包含影响MOT恢复的设置。此外，有关恢复的完整说明，请参阅“MOT管理”章节
的MOT恢复。下文各相关章节中还提供了参考链接。
以下介绍了mot.conf文件中的各个部分，其包含的设置以及默认值。
总体原则
以下是编辑mot.conf文件的总体原则。
 每个设置项都带有默认值，如下所示：
#name=value
 可以接受空格或留空。
 在各行添加#号可进行注释。
 每个设置项的默认值将作为注释显示在整个文件中。
南大通用数据技术股份有限公司
453
GBase 8s V8.8开发者手册
 如果参数没有注释并且置入了新值，则定义新设置。
 对mot.conf文件的更改仅在数据库服务器启动或重装时生效。
内存单元的表示如下：
 KB：千字节
 MB：兆字节
 GB：吉字节
 TB：太字节
如果未指定内存单元，则假定为字节。
某些内存单位为postgresql.conf中的max_process_memory的百分比值。例如，20%。
时间单位表示如下：
 us：微秒
 ms：毫秒
 s：秒
 min：分钟
 h：小时
 d：天
如果未指定时间单位，则假定为微秒。
重做日志（MOT）
 enable_group_commit=false
是否使用组提交。
该选项仅在 GBase 8s 配置为使用同步提交时相关，即仅当 postgresql.conf 中的
synchronization_commit设置为除off以外的任何值时相关。
有关WAL重做日志的详细信息，请参阅MOT日志记录：WAL重做日志。
 group_commit_size=16
 group_commit_timeout=10ms
只有当MOT引擎配置为同步组提交日志记录时，此选项才相关。即postgresql.conf中
南大通用数据技术股份有限公司
454
GBase 8s V8.8开发者手册
的synchronization_commit配置为true，mot.conf配置文件中的enable_group_commit配置为
true。
当一组事务记录在WAL重做日志中时，需确定以下设置项取值：
group_commit_size：一组已提交的事务数。例如，16表示当同一组中的16个事务已由
它们的客户端应用程序提交时，则针对16个事务中的每个事务，在磁盘的WAL重做日志
中写入一个条目。
group_commit_timeout：超时时间，单位为毫秒。例如，10表示在10毫秒之后，为同
一组由客户端应用程序在最近10毫秒内提交的每个事务，在磁盘的WAL重做日志中写入
一个条目。
提交组在到达配置的事务数后或者在超时后关闭。组关闭后，组中的所有事务等待一个
组落盘完成执行，然后通知客户端每个事务都已经结束。
有关同步组提交日志记录的详细信息，请参阅MOT日志类型。
检查点（MOT）
 checkpoint_dir=
指定检查点数据存放目录。默认位置在每个数据节点的data文件夹中。
 checkpoint_segsize=16MB
指定检查点时使用的段大小。分段执行检查点。当一个段已满时，它将被序列化到磁盘，
并为后续的检查点数据打开一个新的段。
 checkpoint_workers=3
指定在检查点期间要使用的工作线程数。
检查点由多个MOT引擎工作线程并行执行。工作线程的数量可能会大大影响整个检查
点操作的整体性能，以及其它正在运行的事务的操作。为了实现较短的检查点持续时间，应
使用更多线程，直至达到最佳数量（根据硬件和工作负载的不同而不同）。但请注意，如果
这个数目太大，可能会对其他正在运行的事务的执行时间产生负面影响。尽可能低这个数字，
以最小化对其他运行事务的运行时的影响。当此数目过高时，检查点持续时间会较长。
有关配置的更多信息，请参阅MOT持久性中的MOT检查点。
恢复（MOT）
南大通用数据技术股份有限公司
455
GBase 8s V8.8开发者手册
 checkpoint_recovery_workers=3
指定在检查点数据恢复期间要使用的工作线程数。每个MOT引擎工作线程在自己的核
上运行，通过将不同的表读入内存，可以并行处理不同的表。缺省值为3，可将此参数设置
为可处理的核数。恢复后，将停止并杀死这些线程。
有关配置的详细信息，请参阅MOT恢复。
统计（MOT）
 enable_stats=false
设置周期性统计打印信息。
 print_stats_period=10minute
设置汇总统计报表打印的时间范围。
 print_full_stats_period=1hours
设置全量统计报表打印的时间范围。
以下设置为周期性统计报表中的各个部分。如果没有配置，则抑制统计报表。
 enable_log_recovery_stats=false
日志恢复统计信息包含各种重做日志的恢复指标。
 enable_db_session_stats=false
数据库会话统计信息包含事务事件，如提交、回滚等。
 enable_network_stats=false
网络统计信息包括连接/断连事件。
 enable_log_stats=false
日志统计信息包含重做日志详情。
 enable_memory_stats=false
内存统计信息包含内存层详情。
 enable_process_stats=false
进程统计信息包含当前进程的内存和CPU消耗总量。
南大通用数据技术股份有限公司
456
GBase 8s V8.8开发者手册
 enable_system_stats=false
系统统计信息包含整个系统的内存和CPU消耗总量。
 enable_jit_stats=false
JIT统计信息包含有关JIT查询编译和执行的信息。
错误日志（MOT）
 log_level=INFO
设置MOT 引擎下发的消息在数据库服务器的错误日志中记录的日志级别。有效值为
PANIC、ERROR、WARN、INFO、TRACE、DEBUG、DIAG1、DIAG2。
 Log/COMPONENT/LOGGER=LOG_LEVEL
使用以下语法设置特定的日志记录器。
例如，要为系统组件中的ThreadIdPool日志记录器配置TRACE日志级别，请使用以下
语法：
 Log.System.ThreadIdPool.log_level=TRACE
要为某个组件下的所有记录器配置日志级别，请使用以下语法：
 Log.COMPONENT.log_level=LOG_LEVEL
例如：
Log.System.log_level=DEBUG
内存（MOT）
 enable_numa=true
指定是否使用可识别NUMA的内存。禁用时，所有亲和性配置也将被禁用。MOT引擎
假定所有可用的NUMA节点都有内存。如果计算机具有某些特殊配置，其中某些NUMA
节点没有内存，则MOT引擎初始化将因此失败，因此数据库服务器启动将失败。在此类计
算机中，建议将此配置值设置为 false，以防止启动失败并让 MOT 引擎在不使用可识别
NUMA的内存分配的情况下正常运行。
 affinity_mode=fill-physical-first
设置用户会话和内部MOT任务的线程亲和模式。
使用线程池时，用户会话将忽略此值，因为它们的亲和性由线程池控制。但内部MOT
南大通用数据技术股份有限公司
457
GBase 8s V8.8开发者手册
任务仍然使用。
有效值为fill-socket-first、equal-per-socket、fill-physical-first、none。
 Fill-socket-first将线程连接到同一个槽位的核上，直到槽位已满，然后移动到下一
个槽位。
 Equal-per-socket使线程均匀分布在所有槽位中。