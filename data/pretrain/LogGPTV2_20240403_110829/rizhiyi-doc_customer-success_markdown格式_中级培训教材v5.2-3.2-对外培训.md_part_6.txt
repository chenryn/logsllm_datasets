因为数据备份功能依赖于Logriver模块的输出topic：log_river，请确保日志易Manager中，
logriver模块的kafka_sink.enable_sink_to_kafka配置是开启状态(true)；也需要确保kafka中这
个log_river的topic已经创建：
1-49
日志学院
前2项配置可以通过排列组合实现这些功能：
kafka_sink .enable_sink_to_kafka=true .enable_sink_to_kafka=false
.enable_filter=true web备份配置生效 不能写入
.enable_filter=false 全量备份到kafkatopic 不能写入
进行备份配置
要使用数据备份功能，进入设置-数据-备份策略页面：
在页面右上角添加一个appname到需要备份的列表中，即可完成增加备份操作。
1-50
日志学院
而从需要备份的列表中删除一个appname，该appname从即刻起，不再备份。
添加备份appname时，可以使用通配符 * 和 ? 号。系统会根据实际情况自动展开所有匹
配上的appname到列表中。删除备份appname时，则只能逐一点击操作。
数据恢复
在数据备份同一界面，可以进行数据恢复。按时间、appname、备份状态等条件过滤数据列
表进行条件过滤，可停止正在进行的数据恢复工作，或恢复一个已备份完成的数据。
列表中的状态分为如下五种：
 不可恢复：正常入库的索引尚未删除；
 已恢复：数据已经恢复到索引中。当您手动删除掉当前domain对应的索引，又将重新
变成可恢复状态；
 正在运行：正在执行恢复操作，您可以执行停止操作；
 可恢复：除以上三种状态，其他时候都是可恢复状态；
 等待：系统在同一时刻只能有一个日期和appname对应的数据处于正在恢复状态，因
此其他提交的恢复操作将是等待状态。等待状态时，您同样可以执行停止操作。
由于数据备份时，偏移量是定时提交，备份数据在异常时可能出现重复。日志易系统通过唯
一标识符保证备份数据恢复到索引中时自动去重，可以放心搜索统计。
1.5. 入库优先级
日志易系统中的数据是默认以低优先级接入的，而对于资源紧张的用户群体，其对不同数据
实时性有较高要求。遇到此类情况，可通过使用日志易的入库优先级设置，针对appname、
tag设定不同的优先级来满足客户的需求。
点击“设置-数据-入库优先级”，可进入数据接入时入库优先级规则的列表，该界面可实现不
同appname对应优先级的增删改查操作。如下图：
1-51
日志学院
目前日志易系统中，在新建优先级规则时只可一次性添加一个appname的优先级，优先级
分为高、中、低三个固定的级别，代表的实际配置值分别为300，200，100。如下图：
若系统默认的3:2:1的权重优先级配置规则仍然不能满足您对高优先级数据的接入需求，还
可以在Manager对logriver的配置项进行修改(参数字段名为
kafka_source.topic_priority_weight)。具体方式如下图所示：
1-52
日志学院
如果修改了这个配置，由于不能默认的级别仅有3级，还需要在创建Topic时指定Topic的
优先级。
更多日志备份配置见产品文档《日志易数据接入手册》。
1.6. 数据集
数据集是在3.1及其后版本出现的功能。与日志搜索权限单一的搜索权限不同，数据集可实
现更灵活的数据查询权限管理。相比日志来源，数据集可直接通过query语句（第一个管
道符“|”之间的查询语句）来约束日志查询范围。
数据集在原有日志来源的概念上发展而来，不同与日志来源仅用于搜索权限的是，数据集是
一种资源。可以对数据集进行编辑，分组，删除，授权和导入导出操作。此外，仪表盘、报
表、告警等各个地方也都可以引用数据集。
数据集具备别名属性，可以使用数据源别名构建树状结构，使用汇聚或继承构建不同的父子
行为，进而得到不同的数据集合。如下图所示：
在客户环境中，可以通过数据集定义客户比较关注的日志的树形结构。方便客户查看不同类
别的日志：
1-53
日志学院
1-54
日志学院
数据集还可与权限管理配合使用，使每个客户都可通过数据集快速查看自己关心的日志集合。
你可以通过“*NOTindex:ops-cs*”的约束语句，指定某数据集可查看除ops-cs开头的索引之
外的所有数据。点击操作列的"设为默认"，则每次打开搜索页面，默认选择该数据集。
1-55
日志学院
我们可以用新建开始，了解数据集的概念。
新建数据集
点击数据集列表页右上角的"新建数据集"，弹出悬浮层如上图，依次解释下各个属性：
 名称：数据集名称。
 别名：域内唯一，数据集展示的名称。可以使用dot(".")合并多个数据集展示，最多4
层的dot分割描述，如应用.手机银行.esb系统。详见"别名使用dot合并展示结构"章节。
 父子行为：无/汇聚/继承。父子行为是"无"时，父子节点之间没有继承（AND）和汇聚
（OR）的关系，节点的约束语句保持独立。父子行为是汇聚或继承时，详见"汇聚式数
据集"或"继承式数据集"章节。
 约束语句：query语句，目前不能填写统计类 SPL 语句，例：*或*NOTindex:ops-cs*。
1-56
日志学院
 字段列表：在query语句约束下，数据实际会拥有，且有分析意义的字段名称和类型。
目前仅支持字段提取字段，以及时间、文本、数值三种类型。
 所属应用：选择所属应用。
 资源标签：选择资源所属的标签属性。
 分组：选择/新建分组标签。
点击"保存"，进入数据集编辑模式，如图：
数据集结构
数据集结构是由父子节点组成的树状结构。节点包括节点名称、约束语句和字段列表，根节
点是新建数据集时填写别名和约束语句，可以在编辑模式下，点击右上角"编辑根事件"，进
行编辑。
1-57
日志学院
添加节点
鼠标放在节点上，显示"+"，点击"+"添加子节点。输入节点名称，点击"✔"，保存节点名称。
输入节点的约束语句，编辑"保存"，成功添加节点。
编辑节点
如图，在数据集结构右侧，编辑子节点名称和约束语句。注意：修改完成后请进行保存。
1-58
日志学院
删除节点
鼠标放在子节点上，显示"X"，点击"X"，删除该节点。或者点击右侧的"删除"，删除该节点。
别名使用 dot 合并展示结构
数据集之间是平行关系，可以平行展示，也可以根据别名的dot分隔描述，合并展示。比如：
定义数据集手机银行ESB，别名为：应用.手机银行.esb系统，可以看到其数据结构是：
定义数据集支付ESB，别名为：应用.二代支付.esb系统，可以看到其数据结构是：
则，在搜索页上看到的树状结构如下：
1-59
日志学院
其中，应用，手机银行，二代支付这三个层级是不可点击的，纯展示级别。
数据集父子关系
数据集可以定义父子关系。父子行为有继承式和汇聚式。继承式父节点作为子节点的前置条
件，子节点的约束关系较多；汇聚式子节点为父节点的分支条件，父节点的约束条件较多。
两种关系具体解释如下：
继承式数据集
父子行为是继承，子节点继承父节点的约束语句。
例如：定义数据集Database，约束语句为：appname:database。
添加一个子数据集SlowLog,约束语句为：tag:slowlog。
则，在搜索页看到的树状结构如下：
1-60
日志学院
当点击Database时，生成到右侧的实际过滤语句为：appname:database；
当点击SlowLog时，生成到右侧的实际过滤语句为：appname:databaseANDtag:slowlog。
汇聚式数据集
父子行为是汇聚，父节点汇聚子节点的约束语句。
例如：定义数据集ESB，约束语句为：“appname:esb”。
添加第一个子数据集esb1.mobile.cmb.com，约束语句为：“hostname:192.168.1.12”。
再添加第二个子数据集esb2.mobile.cmb.com，约束语句为：“hostname:192.168.1.14”。
则，在搜索页看到的树状结构如下：
当点击esb1.mobile.cmb.com时，生成到右侧的实际过滤语句为：“hostname:192.168.1.12”；
当点击ESB时，生成到右侧的实际过滤语句为：“appname:esbAND(hostname:192.168.1.12
ORhostname:192.168.1.14)”。
数据集的展示和使用
数据集在搜索页
1-61
日志学院
数据集在搜索页展示如上图。
 鼠标放在节点上展示节点对应的约束语句，如果该节点只是展示结构，则没有约束语句，
且不可点击。
 ↑表示汇聚关系，↓表示继承关系。
 节点可以多选，选中的节点在右侧搜索框上方展示，选中的节点之间是OR的关系。
 搜索页默认没有选中数据集，选中数据集后，可以点击"展示"查看选中的数据集。
由于数据集节点名称长度不一，搜索页左侧区域支持用户拖拽自定义宽度。拖放到合适宽度
以后，系统将自动记录，刷新或重新登录时都将自动沿用这个宽度。
当用户可见范围内没有数据集定义时，搜索页左侧区域默认为完全收起状态。
1-62
日志学院
数据集在监控配置页
在监控配置中，当搜索配置选定数据集节点以后，填写触发条件中的字段名称时，系统会自
动提供该数据集节点的字段列表供您选择。
数据集在趋势图新建页
在新建趋势图流程中，也可以直接选择数据集节点并基于节点字段列表进行快速配置。详细
说明参见数据透视表章节。
本章习题：
1、简述日志搜索权限与数据集的异同点。
2、当采集一个目录时，每小时产生上千个小文件，怎么采集才能降低资源消耗？
3、客户要接入日志的设备较多时，可能遇到什么问题？该怎么解决？
思考：
当采集的日志量足够大，还有哪些地方可能会成为瓶颈？
1-63
日志学院
2.日志解析
日志解析，也可以称作数据结构化、数据正规化、字段解析、字段提取。我们是通过正则的
方式来进行的。
初级产品学习过程中，我们已经简单了解了如何对日志进行结构化解析，也知道了如何使用
正则对日志进行简单解析。
面对复杂场景时，仅仅使用正则进行解析还不足够，因此日志易还提供了多种样式的解析规
则，以应对多种场景的日志解析。
使用这些日志解析规则，首先要对日志易的解析规则有一定了解。所以：
 本章第一小节，我们会对日志易的解析规则作出说明，这些说明包括解析规则和
appname、tag的关系，解析规则与日志进行匹配的逻辑，以及对日志进行解析的原则
等；
 之后我们会介绍常用的日志解析方法，日志易提供了多种解析方法以满足各种场景的日
志分析；
 再之后会介绍日志解析中常用的管理功能，这部分包括条件控制、规则验证、解析规则
运行状况查看、解析规则管理等内容。
2.1. 日志解析规则简述
规则与 appname、tag 的关系
日志易是通过Appname和tag来定义解析规则的，一个appname和tag确定一条解析规则，
一条解析规则可用于同一种格式的日志解析。
根据日志入库的流程，解析规则与appname、tag的对应关系有以下几条：
1、日志采集时定义了该日志的appname和tag，appname或tag至少需要绑定一条解析规
则，如果未绑定将使用内置规则解析；
2、一条规则可以同时作用于多个 appname、tag对：定义解析规则时需指明该解析规则对
应的appname及tag，如定义appname:*tag:nginx，可使该规则匹配到所有tag为nginx的
日志。
3、appname和tag匹配流程：
日志的appname需要和解析规则的appname完全匹配；
日志的tag有多个，只要有一个能匹配到配置的tag就能匹配；
appname和tag同时匹配才执行对应的规则。
2-64
日志学院
4、配置查找过程：
用日志的appname、tags和配置的appname、tag匹配；
匹配到多个规则，只用第一条规则；
没找到对应规则，用内置的规则(json,apache,mysql等)。
5、根据appname、tag匹配流程，建议规则和appname、tag对应关系为1对多，而非多
对多。
解析规则与解析项
日志经过进行正则分析后，默认各字段都是字符串格式，而对日志进行分析，可能需要进行
时间戳格式转换、数值型转换等处理，这些字段转换可以在日志分析时进行，但为后续使用
方便，关键字段需在日志解析时就做好转换。
一般而言，一条解析规则应有以下解析项：
1、正则或json解析：使用正则或json提取日志中的若干字段；使用正则解析时，时间戳、
日志级别一般为必提字段；
2-65
日志学院
2、时间戳解析：将不规则的时间格式转化为标准的日志易系统可识别的时间格式，以便后
续可以按照时间范围搜索日志；如果日志原文中的时间戳不完整，还需对时间做进一步
处理，才能将其转换为标准时间格式；
3、数值型转换：如将nginx的返回状态、请求时间等需进行计算的字段由字符型转换为数
数值型。
多条解析项的匹配顺序为：