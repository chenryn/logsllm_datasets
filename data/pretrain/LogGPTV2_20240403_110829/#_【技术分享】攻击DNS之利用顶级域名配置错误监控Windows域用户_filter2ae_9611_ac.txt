更改你计算机的DNS后缀，以匹配危地马拉活动目录域，并将主DNS后缀设置为“.gt”顶级域名下的任何域，如下图所示：
单击确定并应用此新设置，将提示你重启计算机。继续进行，并且当Windows重启时，请保持Wireshark一直运行。你可以看到，在启动过程中，一些动态更新查询发生了：
上图是当Windows在启动期间，Wireshark的输出结果，具体活动如下：
1.尝试向8.8.8.8DNS解析器查询mandatory.dnsleaktestnetwork.com.gt的SOA记录(结果是一个NXDOMAIN错误，因为它查询的配置是8.8.8.8，而该域名在公共互联网上是不存在的)。
2.Windows然后会对这个NXDOMAIN响应进行解析，并从顶级域名的响应中找到一个无效的SOA主名称服务器记录，这就是maestro.gt。
3.然后，Windows会访问maestro.gt(此时它已经是我的服务器了)，并尝试发送一个DNS更新请求。这会失败，因为我把服务器设置成了拒绝模式。
4.然后，Windows会再次尝试整个过程。
**那么，这个问题有多普遍？**
因为危地马拉国家使用的是“.gt”域名空间，该空间和一些大的顶级域名相比很小，如.com、.net、.org、.us等等，因此，我们看到只有一小部分DNS请求受到这个问题的影响。但是，在较大规模的顶级域名空间上，使用了顶级域名的活动目录域、并访问常用顶级域名服务器的流量，有可能很大。
尽管我还没有明确地找到任何以前的“关于动态更新SOA劫持”的研究报告，但幸运的是，我们有很多以前的“关于名称碰撞”的研究，这很大程度上是由于担心发布的顶级域名和内部网络域名相矛盾，而内部网络遍布全球。想要研究这个问题有多么普遍，我推荐读一下《[DNS中的名称碰撞](https://www.icann.org/en/system/files/files/name-collision-02aug13-en.pdf)》这篇文章，这是ICANN委员会的报告，它对于这个问题有一个很好的概述，能更好的理解名称碰撞问题、及它在互联网中的影响。这篇文章包括了很多真实世界的数据，展现出了名称碰撞问题有多大，这使得我们有一个很好的基础，让我们推断出在这个世界里特殊的SOA动态更新变种分布有多广泛。
也许，在这个报告中，真实世界中最震撼的数据是下面的这张表：
上表是一个顶级域名请求数据表，按照根域名服务器的DNS请求数量排列，单位是千。在原始报告中包含了前100个顶级域名，在这里我们只列出前20个。这张表揭示了原始数据中DNS请求泄漏、并访问了根域名服务器的情况，而这个情况并不意味着到此为止。可以看出，有很多无效的“.local”顶级域名请求并查询了根域名服务器，数据排在了第三位，而且比所有“.org”和“.arpa”的请求数量加起来还多。下面的饼状图也能进一步揭示问题的规模：
上图显示了一个惊人的结果，有45%的请求访问了根服务器，这些请求来自于顶级域名，并且是不存在的、无效的域名，它们有可能是DNS请求泄漏的结果。也许更令人震惊的是，该数字可能更高，由于有些内部域有一个有效的顶级域名，但有一个无效的二级域名，例如之前我们提到过的microsoftinternal.com.gt。这些请求对于根服务器来讲是有效的(因为“.gt”在根区域是一个有效的记录)，但是可能在com.gt顶级服务器上会被视为泄漏/无效的。
该报告中提到了一个同样很有趣的问题，它们观察到了这些问题的流量，但是却没有进行更进一步的调查，如下图：
很多请求采用了上面的格式，通常这是在查询SRV记录，尽管有些时候它们是在请求SOA记录，但是它们似乎与微软活动目录服务有关。说明它们存在和本文相同的问题。
报告后面又再次提到：
意思是：“虽然在本研究中绝大多数观察到的DNS流量是用名字查找的(例如，传统的查询)，但也探测到了其它一些DNS请求。这些都是动态更新的流量，应该永远不会到达根服务器。毕竟，修改根服务器是不会使用动态更新的，更不用说起源于互联网的随机IP了。最可能的解释是它们可能由于活动目录安装配置错误，流量走出了内部网络，并泄漏到了公共互联网上。需要注意的是，这项研究并没有检查导致这种流量的根本原因。”
该文章最终得到的结论是：
可惜的是，该报告对这个流量的大小并没有给出任何陈述，因此和其它名称碰撞相比，我们没有好的办法得到这个问题的百分比和总量。基于顶级域名可能返回完全随意的SOA主名称服务器域名这个事实(就是.gt和maestro.gt这种情况)，实际上要在更大的范围内考虑安全问题，而报告中还没有认识到这一点。这允许潜在的攻击者通过注册一个域名，就像我们利用的maestro.gt，进入到DNS的中间过程。
鉴于公认的这个有限的信息，我认为这个问题有可能正在积极地发生，许多顶级域名服务器在这个问题上肯定能看到一些不平常的流量。依赖于每个顶级域名SOA记录的特殊配置，如果它们的SOA主名称服务器是可以被注册的，就像本案例中一样，它们就有可能存在易受攻击的漏洞。
**修复这个问题 &充分的TLD安全考虑**
鉴于利用这个漏洞的门槛是如此之低(基本上仅仅需要买一个域名)，关注它所造成的影响有很多原因，我认为应该要求TLD确保它们响应的SOA的主名称服务器字段是不能被解析的、或解析到TLD控制的服务器上，然后拒绝处理动态更新查询。考虑到这个错误似乎很容易造成，因为SOA主名称服务器字段不再用于从属DNS复制，我不认为这种改变是不合理的。悲哀的是，如果你读过本文前面提到过的生成的TLD健康报告的结果，你将会看到惊人数量的TLD在功能配置上是有问题的。鉴于这一事实，修复这个安全问题的希望也很低，即使是简单的事情，就像是“使所有TLD名称服务器处理于正确工作状态”对于TLDs来讲也是不实际的。如果我们甚至不能确保TLDs的健康，那么我们又怎么能希望确保所有TLDs能减轻这个问题呢？
呼叫网络管理员去阻止他们自己网络中这种类型的问题似乎也无法打赢这场战争，况且还有那么多的DNS名称碰撞。同时通知并确保网络管理员了解这个风险是很重要的，不过确保100%的网络都能正确配置是不可能的。
**隐私的噩梦**
鉴于这个事实，这台危地马拉机器的问题建立在一个相当普通的基础上，这个漏洞带来了一个相当大的隐私问题，很多DNS请求包含了主机名，这是很隐私的(想像一下NANCY-PC、MYLAPTOP，等等)。由于各种触发因素，造成机器发送了DNS更新查询包，意味着用户的个人电脑在他每次旅行、改变网络、或重启时都会向我的名称服务器发送信息。这导致这个人只要带着他的个人便携电脑，不管他是去上班、还是回家、去本地咖啡店等等，我们都能很容易的监控到他。内部IP地址也增加了隐私风险，因为用它可以绘制出远程网络的IP地址图，这些人的电脑在默默地报告他们的位置，想象一下下面这样的图片就有可能是以这些数据为基础：
不用多说，这种隐私问题肯定会让人有所触动。
**有道德的处理研究数据**
出于对当事人隐私的尊重，我们在这次研究中收集的数据将不会被公开，并会安全的删除。此外，所有这些计算机的进一步流量都会被路由到127.0.53.53，以确保在我maestro.gt域名剩下的注册期限里(大约两年)，没有发送进一步的更新查询。127.0.53.53这个IP是很特殊的，因为它是ICANN专门授权的用于提醒网络管理员存在名称碰撞问题的IP地址。希望危地马拉的网络管理员/技术精明的用户看到DNS流量路由到这个IP后，他能搜索这个IP，并立即发现他们的网络/活动目录设置存在这个易受攻击的问题。
此外，我已经给“.gt”顶级域名的DNS管理员发送了邮件，给她们通知了这个问题，并要求她修改主名称服务器的设置，使它不再被解析。基于没有人可以再利用这一点，并且我已经将流量引导到了127.0.53.53这个事实，同时我的域名注册时间是两年，因此，我决定发布这篇文章，尽管此时主名称服务器仍然是maestro.gt。
总的来说这是一个非常有趣的实验，强调即使是TLD的一个轻微配置错误，也可能造成一些有趣的后果。
状态更新：在我将这个问题发送给危地马拉的DNS管理员后，他们很快修复了这个问题(并很快进行了回复)。
**参考链接**