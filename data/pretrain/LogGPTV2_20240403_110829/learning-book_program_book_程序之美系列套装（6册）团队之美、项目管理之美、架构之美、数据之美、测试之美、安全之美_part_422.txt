## 日志记录的多样性和复杂性

日志记录可能通过不同的端口进行，有时看似不同但实际上描述的是同一件事情，而有时看似相同却在描述不同的事情。例如，以下字符串都表示成功访问了一个系统，尽管这些系统可能各不相同：
- `login`
- `logon`
- `log on`
- `access granted`
- `password accepted`

除了消息的多样性外，许多消息还非常模糊。很多系统没有提供如何生成或解释日志的消息目录。在极端情况下，由个别程序员决定与日志相关的格式、语法和内容，这往往导致日志难以理解，因此有了“日志分析是一门艺术”的说法。

此外，除了处理二进制日志外，还需要处理文本日志。有些文本日志格式松散，难以解析或转换为结构化数据。

### 多样化的IT环境

有多少人只使用一个平台、一段网络、一种安全设备类型以及一个生产商的产品呢？显然不多。大多数公司使用来自多个生产商的多种类型的设备。

多样化的IT环境不仅加剧了上述问题，还引入了新的挑战。例如，需要理解和处理更特殊的文件格式以获取关键信息。容量可能会超出控制，网络入侵检测系统（NIDS）可能会被其监测的对象所混淆，自定义应用程序日志会使本已复杂的问题更加棘手。

在接下来的案例研究中，我们将展示这些困难，并讨论其他一些问题。

### 13.5 案例研究：瘫痪服务器的背后

#### 13.5.1 事故架构和环境

出问题的是一家规模适中的在线零售商。该公司高度重视网络安全，因为其业务依赖于可靠且安全的在线交易。其内部网络和DMZ设计时就考虑了安全性，并采用了最新的安全技术。DMZ是一种堡垒网络，用防火墙将其与恶意攻击者隔离，并用另一道防火墙将内部网络与DMZ和互联网隔离开来（所有从DMZ到内部网络的连接都被阻塞）。

公司在防火墙内部部署了网络入侵保护系统（IPS），以隔离内部和外部网络。在DMZ中，公司拥有标准的网络服务器集合，包括Web、电子邮件和一台遗留FTP服务器，用于支持某些长时间运行的操作。像DNS这样的网络服务则从外部供应商采购。

#### 13.5.2 被观察的事件

周一早晨，公司的支持小组接到一名现场工作人员的警报，他试图从FTP服务器下载一个大型ZIP文件，但浏览器在尝试连接时超时。由于无法通过安全shell远程登录FTP服务器，一位支持小组成员进入服务器房间，发现该机器已经瘫痪，无法启动。原因是操作系统丢失。

此时，公司的事故响应计划被触发。虽然安全小组早已建议替换这台FTP服务器，但这起事故最终促使它退役。然而，安全小组仍需完成调查，以防止其他关键网络服务中断。此时，我们还不知道系统的瘫痪是由于恶意攻击还是其他长期存在的原因所致。

#### 13.5.3 调查开始

此次调查的主要目的是找出服务器瘫痪的原因。如果是由恶意攻击引起的，则需要采取措施保护其他系统，防止类似事件再次发生。主要证据是服务器的磁盘驱动器。没有任何目击者，因为机器是在无人注意的情况下突然瘫痪的，内存中的内容和其他现场数据均已丢失。

不过，我们从防火墙、IPS和其他DMZ系统中获得了日志文件，这些文件由日志管理系统收集。遗憾的是，由于疏忽，这台FTP服务器未启用远程日志记录，因此无法从其本身获取第一手攻击信息。

我们首先审查流量日志模式。通过对网络防火墙的日志数据分析，我们发现有人在事故发生几小时前对公司外部可见的IP地址进行了探测。此人试图连接到DMZ中的多台服务器，但所有尝试均未成功并被记录下来。

以下是防火墙日志记录，显示了对所有面向外部系统的快速尝试：

```
Oct 1 13:36:56: %PIX-2-106001: Inbound TCP connection denied from 10.10.7.196/41031 to 10.10.15.21/135 flags SYN on interface outside
Oct 1 13:36:57: %PIX-2-106001: Inbound TCP connection denied from 10.10.7.196/41031 to 10.10.15.21/80 flags SYN on interface outside
Oct 1 13:36:58: %PIX-2-106001: Inbound TCP connection denied from 10.10.7.196/41031 to 10.10.15.21/21 flags SYN on interface outside
Oct 1 13:37:15: %PIX-2-106002: udp connection denied by outbound list1 src 10.10.7.196 3156 dest 10.10.175.7 53
```

最后，攻击者连接到了FTP服务器，如以下日志记录所示：

```
Oct 1 13:36:59: %PIX-6-302001: Built inbound TCP connection 11258524 for faddr 10.10.7.196/3904 gaddr 10.10.15.16/21 laddr 10.10.16.120.122/21
```

获得访问后，攻击者最终上传了一个文件到FTP服务器，如下所示：

```
Oct 1 14:03:30 2008 11:10:49: %PIX-6-303002: 10.10.7.196 Stored\10.10.15.66: rollup.tar.gz
```

我们怀疑这个文件`rollup.tar.gz`包含了一个恶意软件工具包，这一猜测后来得到了证实。

最后一段记录让我们感到困惑：如果不允许从DMZ发起任何连接，攻击者是如何进入系统的呢？经过调查，我们发现这台FTP服务器有一个全局可写的目录，允许客户上传日志文件以进行故障排除。这种设置可能导致风险，FTP服务器可能被匿名外部方用来存储和交换劫持的软件。

#### 13.5.4 数据恢复

分析完网络日志后，我们在硬盘驱动器上寻找更多证据。我们找到了系统消息日志、网络访问日志和FTP传输日志中的片段（幸运的是，这台FTP服务器记录了所有传输）：

```
LOGIN FROM 10.10.7.196[10.10.7.196], mozilla@
Oct 1 00:17:19 ftp ftpd[27649]: lost connection to 10.10.7.196[10.10.7.196]
Oct 1 00:17:19 ftp ftpd[27649]: FTP session closed
Oct 1 02:21:57 ftp ftpd[27703]: ANONYMOUS FTP LOGIN FROM 10.10.7.196 [10.10.7.196], mozilla@
Oct 1 02:29:45 ftp ftpd[27731]: ANONYMOUS FTP LOGIN FROM 10.10.7.196 [192.168.2.3], x@
Oct 1 02:30:04 ftp ftpd[27731]: Can't connect to a mailserver
Oct 1 02:30:07 ftp ftpd[27731]: FTP session closed
```

这些序列提示攻击者首先用浏览器进行查找（留下了标准痕迹`mozilla@`）。接着，可以推测攻击者运行了漏洞攻击（密码`x@`）。这行消息显示了攻击者对邮件服务器的企图访问也存在预兆。

另外，从硬盘驱动器的FTP日志中得到以下信息：

```
Oct 1 00:08:25 ftp xinetd[921]: START: ftp pid=27692 from=10.10.7.196
Oct 1 00:17:19 ftp xinetd[921]: EXIT: ftp pid=27692 duration=255 (sec)
```

由于公司的外部防火墙规则，从FTP服务器到攻击者计算机的所有下载都失败了。但此时，攻击者已经通过漏洞攻击获得了“root shell”权限。

#### 13.5.5 小结

从这次事故中得出两个结论：首先，这台服务器确实被外部人员通过位于10.10.7.196（地址经过处理）的计算机成功入侵；其次，攻击者设法在受害主机上放置了一些文件。

总之，尽管日志存在许多缺陷，但在调查事故原因时仍然能够发挥重要作用。即使删除，它们也常常能够被恢复。

### 13.6 未来的日志

目前显得简陋的日志文件在未来将如何演变，从而继续在系统管理和安全中扮演关键角色？

#### 13.6.1 来源的扩大化

首先，我们应该考虑扩大日志来源的范围。以前的日志来源仅限于防火墙和IDS日志，然后扩展到服务器，现在已经扩展到所有类型的日志来源，包括数据库、Web服务器和应用程序等。

几年前，称职的防火墙或网络管理员至少会查看早期PIX或Checkpoint路由器记录的连接日志摘要。事实上，对于日志管理厂商而言，防火墙日志分析在早期提供了大量商机。许多防火墙使用syslog格式记录日志，这种格式易于收集和查看。

在下一阶段，尽管系统管理员总是知道在出现问题时去查看日志，但直到最近才开始对服务器上的大量操作系统日志进行分析。例如，从所有关键（甚至非关键）Windows服务器收集日志长期以来由于缺乏自动化日志收集工具而难以实现。另一方面，Unix服务器的日志分析因syslog记录中日志内容格式不统一而受到严重影响。

通过邮件服务器日志进行的电子邮件跟踪也同样处于衰退状态。人们只有在出现电子邮件失败甚至发生严重错误（外部人员访问日志）时才会关注邮件日志。由于缺乏本地化并且使用复杂的日志格式，电子邮件的日志分析进展缓慢。

数据库日志直到去年才成为大多数IT人群的关注对象。事实上，IT人群一直以不启用DBMS提供的扩展日志和数据访问审核功能而自豪，但这种情况正在发生变化！预计Oracle、MSSQL、DB2和MySQL都将提供出色的日志功能，只要知道如何启用。