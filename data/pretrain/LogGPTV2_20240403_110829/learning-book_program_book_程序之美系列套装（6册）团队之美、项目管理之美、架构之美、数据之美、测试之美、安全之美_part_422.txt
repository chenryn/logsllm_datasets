2442
---
## Page 2444
格式，可能通过不同的端口记录，有时候看上去不一样，但实际上
说的是同一件事情，有时候看上去相同，但说的是不同的事情。例
如，下面的字符串都提示成功地访问了一个系统，尽管这些系统可
能各不相同：
login
logon
log on
access granted
password accepted
除了消息的多样性之外，许多消息还非常含糊。许多系统并没有提
供如何产生或解释日志的消息目录。在极端的情况下，由个人程序
员作出关于与日志有关的决定，例如格式、语法和消息的内容，常
常导致日志完全无法理解，因此出现了一句名言“日志分析是一门艺
术”。
另外，除了处理二进制日志之外，还需要处理文本日志，有些文本
日志格式散漫，很难进行解析或者从文本转换为结构化的数据。
多样化的IT环境
有多少人只使用一个平台、一段网络、一种安全设备类型以及一个
生产商的产品呢？显然不多，大多数公司使用来自多个生产商的多
种类型的设备。
多样化的IT环境加深了前面所提到的问题，而且还引入了自身的问
题。例如，更特殊的文件格式需要被理解和处理，以获得重点。容
量会超出控制，NIDS会被它们所监测的东西混淆，自定义的应用程
序日志会使本来就很复杂的问题雪上加霜。
在下面这个调查日志使用的案例研究中，我们将演示这些困难，并
将讨论其他的一些困难。
13.5案例研究：瘫痪服务器的背后
2443
---
## Page 2445
本节的这个例子来源于作者所领导的几个调查。作者把它们组合在
一起，在一个很小的空间里提供了几个概念性有趣说明。
13.5.1事故的架构和环境
出现问题的公司是一家中等规模的在线零售商。这家公司理解网络
和主机安全的价值，因为它的业务需要依赖可靠、安全的在线交
易。它的内部网络和DM亿设置在设计时就考虑了安全性，得到了最
新安全技术的保护。DM亿是一种堡垒网络，用一道防火墙将DM亿与
充满恶意攻击者的Intermet进行隔离，并使用另一道防火墙把内部网
络与DMZ和Internet攻击隔离开来（DMZ到内部网络的所有连接都被
阻塞）。
这家公司在防火墙内部部署了一个网络入侵保护系统（IPS），把内
部网络与外部网络进行隔离。在DM亿中，公司收集了网络服务器的
标准集合：Web、电子邮件和一个专门用于支持一些长时间运行操
作的遗留FTP服务器，它是旧时代所留下来的。一些像DNS这样的网
络服务则是从外部供应商采购的。
13.5.2被观察的事件
星期一早晨，这家公司的支持小组接到了一位试图从FTP服务器下载
一个大型ZIP文件的现场工作人员的警报。他报告说，他的浏览器在
试图连接到公司的FTP服务器时“超时”。由于无法从内部网络通过安
全的shell远程登录到FTP服务器，支持小组的一位成员走进了服务器
房间，结果发现这台机器已经瘫痪，无法启动。原因很简单，它的
操作系统不见了。
此时，公司的事故响应计划被触发。由于安全小组很早就提出这台
FTP服务器应该退休，由一些更安全的文件传输方法来代替。这个事
故在"FTP的棺材上钉上了最后一颗钉子”，这台服务器顺理成章地不
再被使用。但是，安全小组被告知需要完成一项调查，防止其他关
键的网络服务中断。注意，这个时候我们并不知道系统的瘫痪到底
是由于恶意攻击所致还是由于其他长期存在的原因所致。
13.5.3调查开始
因此，这次调查的主要目的是找出服务器瘫痪的原因。如果它是由
于恶意攻击所致，就需要采取措施保护其他系统服务器，防正这类
2444
---
## Page 2446
事件再次发生。调查的主要证据片断是服务器的磁盘驱动器。没有
任何现场证人，因为机器是在没人注意的情况下运行时突然瘫痪
的，内存中的内容或其他现场数据都丢失了。
但是，我们从防火墙和IPS以及其他DM亿系统中得到了一组日志文
件，它们是由一个日志管理系统所收集的。我们本该为日志管理系
统从FTP服务器收集到日志而感到高兴，但由于蔬忽之故，这台FTP
服务器并没有启用远程日志。因此，我们无法从这台FTP服务器本身
获取第一手的攻击信息。
我们从审查流量日志模式开始着手调查。
首先，通过对来自网络防火墙的防火墙日志数据进行分析，我们发
现有人在距离事故儿个小时之前对公司的外部可见IP地址进行了探
查。这个人试图连接到DM亿中的多台服务器。当然，所有这些尝试
都没有成功，并且被日志所记录。
下面是向我们提供了试图访问所有面向外部系统的快速尝试的证据
的防火墙日志记录。（本节中的所有日志记录中的所有IP地址都进
行了处理，位于局域网10.10.0.0/16的范围之内。）
Oct113:36:56:%PIX-2-106001:InboundTCPconnection denied
from10.10.7.196 /41031 to 10.10.15.21/135 flags SYN on interface
outside
Oct 1 13:36:57:%PlX-2-106001:Inbound TCP connection denied
from10.10.7.196 /41031 to 10.10.15.21/80 flags SYN on interface
outside
Oct 1 13:36:58:%PIX-2-106001:Inbound TCPconnection denied
outside
Oct 1 13:37:15:%PlX-2-106002:udp connection deniedby outbound
list1 src 10.10.7.196 3156 dest 10.10.175.7 53
最后，他连接到这台FTP服务器，如下面这条日志记录所示：
Oct 113:36:59:%PIX-6-302001:Built inbound TCP connection
11258524for faddr 10.10.7.196/3904 gaddr 10.10.15.16/21 1addr
10.10.16.120.122/21
2445
---
## Page 2447
在获得访问之后，攻击者最终把一个文件上传到这台FTP服务器，如
下面这条防火墙日志记录所示：
Oct 1 14:03:30 2008 11:10:49: %PIX-6-303002: 10.10.7.196
Stored\10.10.15.66: rollup.tar.gz
我们怀疑这个文件rollup.tar.gz包含了一个恶意软件工具包，这个怀
疑后来被一项更完整的调查证实。
最后一条记录是另一个令我们颇感郁闷的惊奇。如果不允许来自
DM亿的任何连接，攻击者如何进入系统呢？公司的系统管理队伍展
开了调查，令人不快的事实浮出了水面：这台FTP服务器具有一个全
局可写入的目录，允许顾客上传日志文件以进行故障排除。在许多
经典的FTP服务器上，不受限制的匿名上传是可以的。匿名用户可以
把文件上传到一个称为"incoming"的目录，并且这个目录的设置很可
能采用了最不安全的方式：匿名用户可以读取其他人所上传的任何
文件。这就导致了一个风险，FTP服务器可能被匿名的外部方用来存
储和交换它们所劫持的软件。
13.5.4使数据起死回生
分析了网络日志之后，现在是时候在硬盘驱动器上寻找一些证据
了。我们决定寻找日志文件的碎片（最初位于/var/log），证实攻击
的本质并了解其他细节。调查小组从系统消息日志、网络访问日志
和FTP传输日志中找到了下面这些日志片断（幸运的是，这台FTP服
务器记录了所有的传输）：
LOGIN FROM 10.10.7.196[10.10.7.196], mozilla@
Oct 1 00:17:19 ftp ftpd[27649]: lost connection to
10.10.7.196[10.10.7.196]
Oct 1 00:17:19 ftp ftpd[27649]: FTP session closed
Oct 1 02:21:57 ftp ftpd[27703]: ANONYMOUS FTP LOGIN FROM
10.10.7.196 [10.10.7.196], mozilla@
2446
---
## Page 2448
Oct 1 02:29:45 ftp ftpd[27731]: ANONYMOUS FTP LOGIN FROM
10.10.7.196 [192.168.2.3]， x@
Oct 1 02:30:04 ftp ftpd[27731]: Can't connect to a mailserver
Oct 1 02:30:07 ftp ftpd[27731]: FTP session closed
（此时，细心的读者可能会注意到我在前面所提到的难题之一：FTP
服务器和防火墙日志之间的时间戳并没有同步。）
这个序列提示了攻击者首先用一个浏览器进行查找（留下了标准痕
迹mozilla@）。接着，可以推测攻击者运行了漏洞攻击（password
x@）。这行消息显示了攻击者对邮件服务器的试图访问也存在预
兆。
另外，从硬盘驱动器的FTP日志上得到了下面的信息：
Oct 1 00:08:25 ftp xinetd[921]: START: ftp pid=27692
from=10.10.7.196
Oct 1 00:17:19 ftp xinetd[921]: EXIT: ftp pid=27692
duration=255（sec）
由于公司的外部防火墙规则，从这个FTP服务器到攻击者计算机的所
有下载都失败了。但是，此时攻击者已经通过漏洞攻击获得了一
个"root shell"权限。
13.5.5小结
从这次事故可以得出两个结论：首先，这台服务器的确由外部人土
用一台位于10.10.7.196（地址经过了处理）的计算机成功入侵；其
次，攻击者设法把一些文件放在受害主机上。
总之，这个事故告诉我们，尽管日志存在许多漏洞缺陷，但它在调
查事故原因时仍然能够发挥极大的作用。即使删除，它们也常常能
够取回。
13.6未来的日志
2447
---
## Page 2449
目前还显得比较简陋的日志文件在未来将会怎么演变，从而继续在
系统管理和安全中扮演关键角色呢？
13.6.1来源的扩大化
首先，我们应该考虑扩大日志来源的范围。以前的日志来源仅限于
防火墙和IDS日志，接着扩展到服务器，现在已经扩展到所有类型的
日志来源：数据库、Web服务器、应用程序等。
几年前，所有称职的防火墙或网络管理员至少会扫一眼由早期的PIX
或Checkpoint路由器所记录的连接日志的简单总结。事实上，对于日
志管理厂商而言，防火墙日志分析在早期提供了大量的商机。许多
防火墙用一种syslog格式记录日志，幸运的是这种格式很容易收集和
查看。
在下一个阶段，尽管系统管理员总是知道在发生问题时去查看日
志，但是直到最近对服务器上的大量操作系统日志进行分析才变成
现实。例如，从所有关键的（许多是非关键的）Windows服务器收
集日志长期以来由于缺之像LASSO这样的无人日志收集工具而滩以
进行。另一方面，Umix服务器的日志分析由于syslog记录中日志内容
的格式不统一而受到严重的影响。
通过邮件服务器日志所进行的电子邮件跟踪也同样处于衰退状态。
人们只有在出现了问题（电子邮件失败）甚至发生恐怖的错误（外
人访问了你的日志）的时候才会关注邮件日志。由于缺乏本地中英
化，并且在某种程度上由于使用了复杂的日志格式，导致电子邮件
的日志分析进展缓慢。
数据库日志很可能直到去年才成为大多数IT人群关注的对象。事实
上，IT人群一直以不用打开DBMS所提供的扩展日志和数据访问的审
核功能而津津乐道，但是这个情况现在正在发生变化！预计Oracle、
MSSQL、DB2和MySQL都将提供出色的日志功能，只要知道怎么启