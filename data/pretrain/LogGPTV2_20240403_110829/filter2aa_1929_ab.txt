Logging is asynchronous 
Does not block the application
Log size limit removed 
limited only by disk space
Record Header
Section Descriptor
Section Header
Section Body
Section Header
Section Body
Section Header
Section Body
Section Descriptor
Section Descriptor
27
Vista Events
XML events have rich information
XP Events have flat structure, no parameter names
Filtering and Subscriptions – XPath
 Event[System/EventID=101]
Select events - filter out noise
Event[System/Provider=Foo]
Event[System/Level>2]
Filter across live logs, files, Vista, and XP
Subscribe to a custom view of events centrally
Integrates with existing tools
Triggering Actions
Associate a task with an event with a single click
28
Vista Log Signature
Vista Log Signature
4K Header starts with “ElfFile”
Each 64K block starts with “ElfChnk”
Size: 1024 + 4 = 1028 K bytes
29
Registering a Provider
Providers are sources of the events
Identified by unique GUID and name
Specifies the location of resources for 
decoding
PDC 06
30
PDC 06
Channel Definition
System-defined channels are imported 
(System channel above)
New provider-specific channels can be 
defined and configured
true
268435456
2
1
31
PDC 06
Template Definition
Templates define the payload shape 
of events
Data elements define fields of events
Can add user-defined XML representation 
for the payload
32
PDC 06
Event
 Manifest defines event  attributes: ID (value), 
version, keywords, task, opcode, and level
 References previously declared template that 
defines instance data
 Message - a user readable string
 Channel - the name of the channel that 
transports the event to logs
33
Logging Interface
How to log an event:
At compile time
Write a schema
Compile schema
At run time
Register source
Create a session
Send events
Publishing API
Publisher
Published
Events
session
Event publishing 
application
User mode
Kernel mode
Logs
Event
Schema
Schema
compiler
Kernel Component
Sessions
Publishing
API
Published
Events
PDC 06
34
Roadmap
Background
Case Study
 Engagement
 Preliminary Results
 Revised Scope
Vista Event Logging
 Events
 Logging Service
 Undocumented Internals
Event Log Analysis
 Recovery
 Correlation
 Report
Shadow Copy Services
Provider C
Provider C
Provider B
Provider B
Provider A
Provider A
Controller
Controller
Log files
Log files
Controller
Controller
…
Consumer
Consumer
Real time 
delivery
Logged Events
Session 1
Buffers
Session 2
Session 64
Events
Events
Enable/Disable
Session Control
Consumer
Consumer
Windows Kernel
Repair
Correlate
Recover
35
“Cutting-Edge Forensics”
“Conduct Cutting-Edge 
Forensic Investigations”
– back cover
On Event Log Repair:
 “We found no methods that 
were complete, and none 
explained the underlying 
principles for why the repair 
was needed.” – pg. 444
Available April 2, 2007
36
For More Info
C. R. Murphey, “Automated Windows 
Event Log Forensics,” Digital 
Investigation, August 2007
A peer-reviewed paper on a
new tool for automating XP
log recovery and analysis
Digital Forensic Research 
Workshop, 8/13/07
HTCIA National 8/27/07
37
Log Analysis Roadmap
Forensic Process Models
Repair
Correlate
Recover
Extract
Analyze
Interpret
38
Log Analysis Roadmap
Forensic Process Models
Repair
Correlate
Recover
Extract:
Step 1 – Recover
•Data Carve for Logs, etc.
Step 2 – Validate
•Identify intact log files.
Step 3 – Correlate
•Corresponding time, files, names,…
Analyze
Interpret
39
Using DataLifter:
40
XP log signature – 16 bytes
30 00 00 00 4c 66 4c 65 01 00 00 00 01 00 00 00
Vista log signature – 16 bytes
“ElfFile” padded with nulls
Signatures
41
Step 1 – Recover
The Results:
Step 1 – Recover
Run DataLifter
100 logs are recovered.
Only two are viewable.
98 corrupt logs
Step 2
Validate 98 logs?
42
Vista Event Viewer
New: Views, Filters
43
Correlate
SQL queries to identify 
patterns
*[System/Provider=“CD Burning 
Service”]
Repair
Correlate
Recover
The CD Burning service entered the running state. 
11/11/2006 15:21
Message
Time (UTC)
11/11/2006 15:26 The CD Burning service entered the running state. 
11/11/2006 15:25 The CD Burning service entered the running state. 
11/11/2006 15:24 The CD Burning service entered the running state. 
11/11/2006 15:23 The CD Burning service entered the running state. 
The CD Burning service entered the running state. 
11/11/2006 15:22
11/11/2006 15:27 The CD Burning service entered the stopped state. 
The CD Burning service entered the running state. 
11/11/2006 15:27
11/11/2006 15:21 The CD Burning service was successfully sent a start control. 
44
Shortcuts
Shortcuts may contain IDs, label, size
A snapshot of file’s attributes, media’s attributes
Shortcut File
Read-only
File attributes
N/A
Last access time (UTC)
11/3/2006 10:12:34 AM
Last write time (UTC)
11/11/2006 3:21:14 PM
Creation time (UTC)
1643743
File size
E2C3-F184
Volume Serial Number
Nov 11 2006
Volume Label
CD-ROM
Volume Type
D:\OfInterest.doc
Local Path
Link target information
45
Report
Correlations indicate
A CD-ROM was burned
By username: Bob
At: 11/11/2006 3:21 PM UTC
We can uniquely identify the CD
Label: “Nov 11 2006”
Volume serial number: E2C3-F184
Proprietary documents were transferred.
OfInterest.doc, 1.6Mb
Last Modified 11/3/2006 10:12:34 AM UTC
Repair
Correlate
Recover
46
Shortcuts
Shortcuts may contain IDs, label, size
A snapshot of file’s attributes, media’s attributes
Shortcut File
Read-only
File attributes
N/A
Last access time (UTC)
11/3/2006 10:12:34 AM
Last write time (UTC)
11/11/2006 3:21:14 PM
Creation time (UTC)
1643743
File size
E2C3-F184
Volume Serial Number
Nov 11 2006
Volume Label
CD-ROM
Volume Type
D:\OfInterest.doc
Local Path
Link target information
47
Timestamp Analysis
Last write time is earlier than created. 
Can indicate the time at which a file was 
transferred from source media.
Can help identify the source file on source 
media.
11/3/2006 10:12:34 AM
Last write
11/11/2006 3:21:14 PM
Created
Read-only
File attributes
N/A
Last access time (UTC)
11/3/2006 10:12:34 AM
Last write time (UTC)
11/11/2006 3:21:14 PM
Creation time (UTC)
1643743
File size
E2C3-F184
Volume Serial Number
Nov 11 2006
Volume Label
CD-ROM
Volume Type
D:\OfInterest.doc
Local Path
Link target information
48
Roadmap
Background
Case Study
 Engagement
 Preliminary Results
 Revised Scope
Vista Event Logging
 Events
 Logging Service
 Undocumented Internals
Event Log Analysis
 Recovery
 Correlation
 Report
Shadow Copy Services
Provider C
Provider C
Provider B
Provider B
Provider A
Provider A
Controller
Controller
Log files
Log files
Controller
Controller
…
Consumer
Consumer
Real time 
delivery
Logged Events
Session 1
Buffers
Session 2
Session 64
Events
Events
Enable/Disable
Session Control
Consumer
Consumer
Windows Kernel
Repair
Correlate
Recover
49
"Shadow Copy tracks your 
every change."
Automatic point-in-time 
copies.
Incremental block level 
differences minimize 
space.
Deletes older copies as 
needed for space (LRU).
X
50
Legal Concerns Related to Vista
Revised Federal Rules of Civil Procedure
Scope of Production
Historical snapshots are readily available in Vista
Duty to Preserve
Litigation Hold Notices
Potential for Sanctions
Form of Production
Native files?
Metadata?
Point-in-time Image Snapshots?
51
Impact on Policy Maintenance
May Complicate Corporate Policy Issues
Document retention policies
Complicates policy maintenance
Disabling shadow copies in turn breaks backups, 
restore engine
Metadata retention policy
Ownership changes are visible now
Gaps in documentation policy for Vista
52
Impact of Vista on Forensics
FRCP: The rules have changed.
Vista, in turn, changes the rules.
What happens if one accepts the default 
system behavior?
Things may never go away permanently.
Vista leaves far more information than XP
Changes in ownership (SID)
Executives dislike surprises
Risks regarding SOX compliance and litigation.
53
How Shadow Copy Works
Acts like block device
A layer between the device and file system
Snapshot as of Wed.   7:00
Snapshot as of Wed. 10:00
Snapshot as of Wed. 13:00
Snapshot as of Wed. 15:00
Snapshot as of Wed. 19:00
File System
Volume Shadow Copy (VSS)
Service
Block Device (disk)
Blocks
Blocks
Current File System
54
Application writes
data to disk
Shadow Copies
Disk Before
Stevenson, WinHec 06
Upon write, overwritten 
block moves to shadow copy
shadow copy holds only
blocks that changed.
Disk After
Shadow Before
Shadow After
55
Enabling Shadow Copies
56
Enabling Shadow Copies
57
58
59
60
61
62
63
64
Stevenson, WinHec 06
65
Stevenson, WinHec 06
66
Windows RE Auto-Repair
Computer
Bluescreens
Reboot
>5
attempts?
Auto-launch
Startup 
Repair
Boot manager
detects failure
Fail over into
Windows RE
Diagnose 
and repair
computer
Reboot
Successful boot?
Windows Vista
starts
Cannot 
auto-repair
(try manual)
Yes
Yes
No
No
No
No
Yes
Yes
Stevenson, WinHec 06
67
Stevenson, WinHec 06
68
Tools - VSSAdmin
C:\>vssadmin /?
vssadmin 1.1 - Volume Shadow Copy Service administrative command-
line tool
(C) Copyright 2001 Microsoft Corp.
---- Commands Supported ----
Add ShadowStorage     - Add a new volume shadow copy storage 
association
Create Shadow         - Create a new volume shadow copy
Delete Shadows        - Delete volume shadow copies
Delete ShadowStorage  - Delete volume shadow copy storage associations
List Providers        - List registered volume shadow copy providers
List Shadows          - List existing volume shadow copies
List ShadowStorage    - List volume shadow copy storage associations
List Volumes          - List volumes eligible for shadow copies
List Writers          - List subscribed volume shadow copy writers
Resize ShadowStorage  - Resize a volume shadow copy storage 
association
69
Resource Kit – VolRest
C:\Resource Kit>volrest
VOLREST 1.1 - Timewarp Previous Version command-line tool
(C) Copyright 2003 Microsoft Corp.
Usage: VOLREST [options] FileName
Options are:
/?    - Displays this help.
/A    - Includes files with specified attributes.
/AD  Directories (only).
/AS  System files.
/AH  Hidden files.
/B     - Uses bare format (no heading information or summary).
/S     - Includes files in specified directory and all subdirectories.
/R: -
Restore all previous versions in target directory.
/E     - Restores empty directories (use with /R).
/SCT   - Decorates restored file names with the shadow copy timestamp.
Use with /R. For example:
"foo (Wednesday, January 01, 2003, 14.00.00).doc"
Examples:
VOLREST Z:\MYDIRECTORY\MYFILE.DOC
VOLREST //server\share\MYDIRECTORY\*.DOC
VOLREST Z:\*.* /s /r:C:\OLDFILES
VOLREST Z:\*.DOC /s /r:C:\OLDFILES /SCT
70
Questions?
PI:EMAIL
http://murphey.org
http://acsworldwide.com
Provider C
Provider C
Provider B
Provider B
Provider A
Provider A
Controller
Controller
Log files
Log files
Controller
Controller
…
Consumer
Consumer
Real time 
delivery
Logged Events
Session 1
Buffers
Session 2
Session 64
Events
Events
Enable/Disable
Session Control
Consumer
Consumer
Windows Kernel
Repair
Correlate
Recover
71
For More Info
C. R. Murphey, “Automated Windows 
Event Log Forensics,” Digital 
Investigation, August 2007
Digital Forensic Research 
Workshop, 8/13/07
GMU Forensics Symposium
HTCIA National 8/27/07