This provides an estimate on the threat posed by network-level
attackers.
To understand the tightness of this estimate, we analyzed
the fraction of the actually vulnerable paths in each of 20,000
unique “vulnerable” circuits generated by our experiments.
Figure 3 shows the result of this analysis. 25% of all circuits
had all their paths in P vulnerable to at-least one network-
level attacker and 56% of all circuits had at-least 50% of their
paths (in P) vulnerable to at-least one network-level attacker.
B. Measurement methodology and results
To understand the threat posed by the adversary described
in Section II, we performed several experiments. In particular,
our goal was to understand the threat faced by the Tor client
under various conﬁgurations, and in different network and
geographic locations.
Experimental setup.
In our experiments, we consider the
fact that Tor users in different countries face different levels
of threats from local ASes. To this end, each experiment
was performed in 10 different countries: Brazil (BR), China
(CN), Germany (DE), Spain (ES), France (FR), England (GB),
Iran (IR), Italy (IT), Russia (RU), and the United States
(US). This list was obtained by considering the intersections
of the number of Tor users in each country [42] and the
Freedom House rankings for Internet freedom [19]. In order
to completely understand the threats faced by Tor users, ﬁve
experiments were conducted in each country; a summary of
each experiment is shown in Table I.
5
 0 0.2 0.4 0.6 0.8 1 0 0.2 0.4 0.6 0.8 1CDF of circuitsFraction of actually vulnerable paths per circuitID
E1
E2
E3
E4
E5
Question Answered
How vulnerable are circuits to asymmetric correlation attacks?
How many attacker-free paths are available to the vanilla Tor client
in each country?
How much of a threat do colluding sibling ASes pose?
How much of a threat do state-level attackers pose?
Do guard settings have a signiﬁcant effect on the availability of
attacker-free paths to the vanilla Tor client?
Vantage Point
VPN
100 ASes per country
Setting
Live (3 guards)
Simulation (all entry- and exit-relays)
Results
Figures 4, 14a and 14b
Figures 14 and 6
VPN
VPN
100 ASes per country
Live (3 guards)
Live (3 guards)
Simulation (20 guard-sets of 1,2, and
3 guards and all exit-relays)
Figures 7, 14c, and 14d
Figures 8, 14e, and 14f
Figure 9
TABLE I: Summary of security experiment settings used for the evaluation of the vanilla Tor client and Astoria. For each country, all experiments
used a dataset containing the local Alexa Top 100 and 100 locally sensitive websites (obtained from the Citizen Lab testing repository [2]).
Fig. 4: An estimate of the percentage of websites that have main page
requests and any requests serviced by a vulnerable Tor circuit.
on circuits built for serving the request for their main page
(GET) and for serving any request. We ﬁnd that the threat
is not uniformly spread. Clients using the vanilla Tor client
from our VPN vantage point in three countries: China (CN),
Russia (RU), and the United States (US) were found to be most
vulnerable. This can be explained by the fact that of our 10
countries, the US, RU, and CN had the most amount of locally
hosted content (i.e., content hosted within the country). Of the
200 sites used for each of the countries, 95% (US), 57% (RU),
and 47% (CN) made requests to ASes within the country itself
– making it more likely for the same AS to be on paths from/to
client to/from entry-relay and exit-relay to/from destination.
E2: Measuring fraction of available attacker-free paths.
Since the results of our experiments on the live Tor network
were highly dependent on the location of the VPN, simulations
were required to understand the distribution of threat in other
locations within each country. To this end, for each country,
100 ASes were randomly selected as client locations and the
targets of the each of the requests generated by the 200 sites
(sensitive and popular) for each of our 10 countries were used
as destinations. The simulation toolkit generated a list of all
entry- and exit-relays available to each client for performing
the page load (using Tor client consensus data).
Each generated (source, entry, exit, destination) combina-
tion was then analyzed for the threat of attackers to understand
how many “safe” or “attacker-free” entry-exit pairs were
available. We see in Figure 14 the cumulative distribution
function of the fraction of attacker free entry-exit pairs for
each source-destination pair. Figure 5a shows this for the ﬁve
most vulnerable countries in our study, and 5b shows this for
the remaining countries.
China (CN) and Iran (IR) stand out as the most interesting
cases. First, we see that 8% of all source-destination pairs have
less than 10% of their entry-exit options being safe. Next, we
also notice that there are no known attackers present on 18%
of all source-destination pairs. This appears to indicate that
the threat of de-anonymization is non-uniform even within a
country, with certain client locations being much safer than
others.
In order to understand which set of websites are more
vulnerable in each of the countries, in Figure 6 we show the
percentage of source- destination pairs having fewer than 5%
safe circuit options for each set of websites. We ﬁnd that in
all cases, the Alexa top 100 local websites have fewer safe
circuit options. This can be explained by the fact that locally
popular websites are likely to be hosted within a regional AS.
Additionally, we ﬁnd that China and Iran have a signiﬁcant
number of their source-destination pairs having fewer than 5%
safe circuit options – i.e., over 8% of the source-destination
pairs have less than 5% of all their circuit options being safe
from network-level correlation attacks.
However, in general, the results of E1 and E2 indicate
that although in most cases there are many safe entry-exit
options available to the Tor client, it often does not select these
options – leading to a large number of vulnerable circuits being
created.
Fig. 6: (Logscale) Percentage of (source, destination) pairs having
fewer than 5% attacker-free (entry, exit) options in each country.
E3: Measuring the impact of sibling ASes.
In this experi-
ment we consider the possibility that ASes owned by the same
organization (referred to as sibling ASes) may collude with
each other in order to de-anonymize Tor users via asymmetric
correlation attacks. We use data gathered by Anwar et al. [10]
to identify such ASes. The same setup as E1 was used.
We observe from Figure 7 that the increase in threat from
considering sibling ASes is marginal. Over the 10 countries,
only 3% additional websites from our list of 200 for each coun-
try had some request served by a circuit that was vulnerable to
asymmetric attacks by sibling ASes. However, the increase in
threat is not uniform. Clients in Brazil and Germany face an 8-
10% increase in vulnerable websites. This can be attributed to
the large telecom conglomerates operating within the countries
6
 0 20 40 60 80 100BRCNDEESFRGBIRITRUUSAllWebsites using vulnerable circuits (%)CountryMain requestAny request 0.01 0.1 1 10 100BRCNDEESFRGBIRITRUUSPercentage of (source, destination) pairsCountryAlexa Local 100Citizen Lab 100(a) Most vulnerable countries (all websites): BR, CN, IR, RU, US
(b) Least vulnerable countries (all websites): DE, ES, FR, GB, IT
Fig. 5: Distribution of the fraction of attacker-free circuits for 100 source ASes connecting to 200 websites in 10 different countries of interest.
More skewed to the right indicates the availability of more safe circuits.
Fig. 7: An estimate of the percentage of websites that have any
requests served by a vulnerable Tor circuit when considering siblings.
– e.g., many paths from our vantage points in Germany and
Brazil were vulnerable to correlation attacks due to transiting
one of the large number of ASes owned by Telefonica (in
Spain) and Durand (in Brazil), respectively.
E4: Measuring the impact of state-level adversaries. In this
experiment we consider the threat that Tor clients face from
state-level adversaries. We assume that a state-level adversary
is able to gain insight into the trafﬁc ﬂowing through all ASes
operating within the state. Therefore, we consider a circuit
originating from country X to be vulnerable if its path to/from
its entry-relay and from/to the exit-relay to the destination
contains some AS operating within X. The same setup as E1
was used for data collection.
The results are broken down per country in Figure 8. Here,
we see that the situation is quite dire with 82% of all (over
all 10 countries) websites having their main page served by
a vulnerable circuit. In particular, clients in Brazil, China,
France, Iran, and the United States face the biggest threat from
state-level attacks with over 95% of their main page requests
being vulnerable to state-level attackers.
E5: Measuring the effect of guards.
In this experiment we
consider the effect of the number of guards on the vulnerability
of Tor clients to network-level asymmetric correlation attacks.
For each of our 10 countries, 100 ASes were randomly selected
Fig. 8: An estimate of the percentage of websites that have main
page requests or any requests served by a vulnerable Tor circuit when
considering state-level adversaries.
as client locations and the targets of all the requests generated
by the 200 websites in our earlier experiments were used as
the destinations. The simulation toolkit generated 60 unique
guard-sets (20 each for 3 guards, 2 guards, and 1 guard) in
an identical manner to the vanilla Tor client, and a list of all
exit-relays available to each client for performing the page
load (using Tor consensus data). Each (source, entry, exit,
destination) combination was checked for the presence of our
adversary.
Fig. 9: Distribution of the fraction of attacker-free (entry, exit) pairs
for vanilla Tor with 3, 2, and 1 guard(s).
Figure 9 illustrates the effect that reducing the size of the
7
 0 0.2 0.4 0.6 0.8 1 0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1Fraction of (source, destination) pairsFraction of attacker-free (entry, exit) pairs 0 0.2 0.4 0.6 0.8 1 0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1Fraction of (source, destination) pairsFraction of attacker-free (entry, exit) pairsBRCNDEESFRGBIRITRUUS 0 20 40 60 80 100BRCNDEESFRGBIRITRUUSAllWebsites using vulnerable circuits for any request (%)Countrywithout Siblingswith Siblings 0 20 40 60 80 100BRCNDEESFRGBIRITRUUSAllWebsites using vulnerable circuits (%)Main requestAny request 0 0.2 0.4 0.6 0.8 1 0 0.2 0.4 0.6 0.8 1Fraction of (source, destination) pairsFraction of attacker-free (entry, exit) pairs1 Guard2 Guards3 Guardsguard-set has on the fraction of network-level attacker-free-
paths available to the Tor client.
While it is known that a smaller number of guards provides
better security against relay-level attackers in the long-term
[14], we see from the results of this experiment that the effect
is the opposite against network-level adversaries – i.e., as the
size of the guard-set decreases, Tor is more likely to select
a circuit vulnerable to network-level asymmetric correlation
attacks due to the reduced number of available safe paths.
In particular, when only 1 guard is used, over 15% of the
(source, destination) pairs in our experiment had no safe-
options, whereas the difference in security provided by two
or three guards was marginal. This experiment demonstrates
one of the conﬂicts between Tor clients geared for defending
against relay-level attackers and those geared for defending
against network-level attackers.
IV. ASTORIA: AN AS- AND CAPACITY-AWARE TOR
CLIENT
Motivated by the observation that vanilla Tor very often
selects entry-exit pairs that may be subject to asymmetric cor-
relation attacks, we seek to design a relay selection algorithm
to mitigate the opportunities for such attackers. We design our
relay selection system, Astoria, based on the idea of stochastic
relay selection. This works by having the Tor client generate
a probability distribution that minimizes the chance of attack
over all possible entry- and exit- relay selection choices, and
selecting an entry- and exit-relay based on this distribution.
The advantage of stochastic selection is that even if the client
has no safe options, relay-selection can be engineered to
minimize the amount of information gained by the adversary
over some period of time (as we show below). Further, it allows
clients to select relays in a way such that no set of relays in
the Tor eco-system is overloaded, even if every client uses the
same relay-selection strategy.
A. Astoria goals
Astoria is constructed with several security and perfor-
mance goals in mind:
•
•
•
Deal with asymmetric attackers. Astoria avoids con-
structing circuits involving common ASes on the
forward- or reverse-paths between the client to the
entry-relay and the exit-relay and the destination.
Deal with the possibility of colluding attackers. Asto-
ria considers the threat of ASes that may collude to
de-anonymize Tor users. Astoria can be conﬁgured to
build circuits that do not contain known to be collud-
ing ASes on the forward- or reverse-path between the
client and entry-relay and exit-relay and destination.
This mitigates the threat from sibling ASes and state-
level attackers.
Consider the worst case possibility. Astoria uses a
probabilistic relay selection algorithm that ensures,
even in the worst-case (where there are no safe paths
to and from the entry- and exit-relay), that the ability
of a single AS (or, family of ASes) to de-anonymize
a large number of circuits is minimized.
Fig. 10: Example of optimizing relay selection. Simpliﬁed to unidi-
rectional paths and only entry-relay selection.
• Minimize performance impact. It is clear that any AS-
aware client will lose its ability to perform many op-
timizations such as pre-constructing circuits. Our goal
is to minimize the effect of the above considerations
on the performance of the Tor client.
•
Be a good network citizen. Astoria takes into account
the capacities of all relays available in the Tor eco-
system and performs selection in a way that no single
set of relays are overloaded, even when all clients in
the network use the same relay-selection strategy.
B. Minimizing information gained by the adversary
While there often are cases when there is a relay selection
that will completely eliminate the risk of our adversary, we
develop our relay selection to be robust, even if this is not the
case. Further, with attacks implemented using BGP hijacking
and interception the number of unsafe paths may be higher
than what we observe in our analysis (we discuss this more in
Section VI).
To minimize the risk of correlation attacks, we deﬁne a
linear program which generates a probability for each relay
selection with the objective to minimize the maximum proba-
bility of a circuit encountering the attacker. Recall that in our
adversary model, we consider a long-lived adversary and that
minimizing the probability of an attacker may also be seen
as minimizing the number of circuits the adversary is able
to observe over a long period of time and numerous circuit
construction cycles.
Figure 10 shows an example of relay selection to give
intuition about how the LP minimizes the risk from the
attacker. In this example, we consider unidirectional paths and
only entry-relay selection for clarity. In the ﬁgure, if the source
were to choose uniformly at random across the three entry-
relays, there is a 2/3 chance that AS1 will be able to observe
trafﬁc and only a 1/3 chance that AS2 will. In this case, the
optimal selection is intuitive, that the source should choose
entry-relays 1 and 2 with probability 1/4 each and entry-relay
3 with probability 1/2. This lowers the probability that AS1
can observe a circuit from 2/3 to 1/2. This probability of the
most likely adversary is the quantity that our LP minimizes.