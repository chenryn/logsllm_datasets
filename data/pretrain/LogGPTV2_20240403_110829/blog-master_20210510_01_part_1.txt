## PostgreSQL 应用开发解决方案最佳实践系列课程 - 7. 标签搜索和圈选、相似搜索和圈选、任意字段组合搜索和圈选系统           
### 作者                
digoal                
### 日期                
2021-05-10                 
### 标签                
PostgreSQL , 解决方案 , 最佳实践 , 课程                 
----                
## 背景                
本文信息量很大.   
PostgreSQL 应用开发解决方案最佳实践系列课程 - 7. 标签搜索和圈选、相似搜索和圈选、任意字段组合搜索和圈选系统      
[视频回放](xx)              
## 课程对象                
数据库架构师, 应用开发者, DBA.                 
## 1、应用场景                
- 电商:   
    - 精准营销 - 目标人群圈选  
- 社交:   
    - 按兴趣精准推荐  
- 论坛:   
    - 按用户标签、浏览行为推荐内容  
- 短视频:   
    - 按用户行为更新喜好标签, 根据喜好标签推荐短视频  
- 淘票票:   
    - 根据用户标签推荐电影  
- 音视频网站:   
    - 根据用户观影喜好、营销策略等算法推荐影视  
- 教育行业:   
    - 根据学生特征标签推荐教育资源   
- 软件行业:  
    - 例如CRM软件, 任意字段组合条件过滤     
## 2、业界解决方案                
应用连数据库    
数据库增量订阅到MQ    
MQ同步到搜索引擎ES    
应用连ES搜索    
应用既要访问数据库又要访问ES, 并在应用中后合并结果    
## 3、业界解决方案的挑战或痛点        
开发成本增加    
维护成本增加    
软硬件成本增加    
同步延时增加, 标签更新慢, 无法实时写入实时查询    
同步容易出现错误, 导致查询结果不一致, 需定期刷全量或定期检查和修复差异    
跨库查询代价高, 例如业务查询需要同时访问ES和数据库     
不支持向量距离搜索、不支持向量索引, 特征向量搜索性能极差    
不支持位图类型和按位图圈选    
## 4、PG的解决方案      
PostgreSQL 内置位图类型、向量索引、倒排索引、多值类型(数组)、支持按位图圈选、按数组圈选、按任意字段组合圈选、按向量距离圈选功能. 性能高  
一份数据, 不需要同步数据, 无同步延迟.   
除了以上常规圈选, PG还支持GIS, 支持按地理位置的综合圈选  
开发成本低  
维护成本低  
软硬件成本低  
无需跨库查询  
1、位图计算圈选  
- varbitx  
- pg_roaringbitmap  
2、特征向量相似圈选, 向量距离相似性(带权重)  
- pase 插件  
- ivfflat 索引接口  
- hnsw 索引接口  
- vector 插件  
- cube 插件  
3、包含标签组合圈选、任意字段组合条件圈选  
- array 数组类型  
- gin 倒排索引  
- rum 增强倒排索引  
- btree_gin 增强倒排混合索引  
- 字典化  
4、标签交叉率相似圈选  
- smlar 数组交叉率相似插件  
- gin 倒排索引  
5、稀疏值优化  
- partial index  
## 5、PG的解决方案原理                
## 6、PG的解决方案 VS 业界解决方案                
PG 支持更丰富的圈选场景  
PostgreSQL 内置位图类型、向量索引、倒排索引、多值类型(数组)、支持按位图圈选、按数组圈选、按任意字段组合圈选、按向量距离圈选功能. 性能高  
一份数据, 不需要同步数据, 无同步延迟.   
开发成本低  
维护成本低  
软硬件成本低  
无需跨库查询  
## 7、DEMO                
准备工作                
ECS , Linux + PostgreSQL 客户端软件                
阿里云 RDS PostgreSQL 11,12,13         
### 7.1、 基于tag数组, 包含某些tag进行圈选        
(阿里云rds pg 13)  
[《恭迎万亿级营销(圈人)潇洒的迈入毫秒时代 - 万亿user_tags级实时推荐系统数据库设计 - 数组包含查询 - 根据用户浏览行为的FEED LOG给商家推荐意向用户》](../201612/20161225_01.md)    
[《阿里云PostgreSQL案例精选1 - 实时精准营销、人群圈选》](../202002/20200220_01.md)    
### 7.2、 基于tag数组, 按tag命中率排序进行圈选  
(阿里云rds pg 13)  
[《PostgreSQL 相似搜索设计与性能 - 地址、QA、POI等文本 毫秒级相似搜索实践 - smlar 标签重叠率相似性》](../201802/20180202_01.md)            
[《HTAP数据库 PostgreSQL 场景与性能测试之 17 - (OLTP) 数组相似查询 - smlar 标签重叠率相似性》](../201711/20171107_18.md)      
### 7.3、 tag:uids bitmaps结构的反向存储, tag条件组合后的uids bitmap and|or|xor计算进行用户圈选  
varbitx   
(阿里云rds pg 11)  
[《基于 阿里云 RDS PostgreSQL 打造实时用户画像推荐系统(varbitx)》](../201610/20161021_01.md)    
roaringbitmap   
(阿里云rds pg 12)  
https://help.aliyun.com/document_detail/154080.html  
### 7.4、 根据特征向量相似度进行人群圈选  
(阿里云rds pg 11)  
[《阿里云PostgreSQL案例精选2 - 图像识别、人脸识别、相似特征检索、相似人群圈选》](../202002/20200227_01.md)    
### 7.5、 任意字段组合条件圈选  
(阿里云rds pg 13)  
[《PostgreSQL ADHoc(任意字段组合)查询(rums索引加速) - 非字典化，普通、数组等组合字段生成新数组》](../201805/20180518_02.md)    
[《PostgreSQL ADHoc(任意字段组合)查询 与 字典化 (rum索引加速) - 实践与方案1》](../201802/20180228_01.md)    