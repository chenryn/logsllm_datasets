Return to libc (1997)
...
sh”
/bas
“/bin
...
...
...
...
Return to libc (1997)
...
sh”
/bas
“/bin
...
...
...
...
Return Oriented Programming ('07)
...
push eax
ret
pop eax
ret
pop ebx
ret
mov [ebx],eax
ret
xchg ebx,esp
ret
pop edi
pop ebp
ret
Address Space Layout 
Randomization (2003)
0...00
f...ff
Stack
Heap
mmap
Library A
Library B
Library C
Program Code
Stack
Heap
mmap
Library A
Library B
Library C
Program Code
Part IV:
Memory Disclosure
&
Advanced Code Reuse
Offset Fix Ups
Library Relative 0..00
libc
Offset Fix Ups
Library Relative 0..00
libc
Library Relative 0..23:
location of system()
Offset Fix Ups
Library Relative 0..00
libc
Library Relative 0..23:
location of system()
Library Relative 0..46:
location of printf()
Offset Fix Ups
Library Relative 0..00
libc
Library Relative 0..23:
location of system()
Library Relative 0..46:
location of printf()
Randomized Virtual Addr
for printf: 0xdefc0b46
Offset Fix Ups
Library Relative 0..00
libc
Library Relative 0..23:
location of system()
Library Relative 0..46:
location of printf()
Randomized Virtual Addr
for printf: 0xdefc0b46
Randomized Virtual Addr
for system: 0xdefc0b23
Offset Fix Ups
Library Relative 0..00
libc
Library Relative 0..23:
location of system()
Library Relative 0..46:
location of printf()
Randomized Virtual Addr
for printf: 0xdefc0b46
Randomized Virtual Addr
for system: 0xdefc0b23
Fine Grained ASLR
● Smashing the 
Gadgets (2012)
● Address Space 
Layout Permutation 
(2006)
lib-func-a
lib-func-b
lib-func-b
lib-func-f
lib-func-c
lib-func-a
lib-func-d
lib-func-c
lib-func-f
lib-func-d
Function level FG-ASLR:
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
xor ecx, ecx
push eax
push ebx
push ecx
call foo
mov edx, [ebp-4]
mov esi, [ebp-8]
add edx, esi
xor edi, edi
push edx
push esi
push edi
call foo
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
4K Page @
0x64616000
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
4K Page @
0x64616000
Just-in-Time Code Reuse (2013)
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
4K Page @
0x64616000
The Value of One Pointer?
Volcano and Hobbit: sold separately.
Part V:
Conceal
&
Forget
C++ Virtual Function Tables
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Instance of class Cat
Vtable ptr
Member: name
Member: fav. catnip
Member: sharp claws?
Function ptr: feed()
Function ptr: pet()
Function ptr: sound()
Function ptr: feed()
Function ptr: pet()
Function ptr: sound()
Animal → Dog, Animal → Cat
class Cat : public Animal {
…
    void sound() {
        printf(“Meow!”);
    }
…
}
class Dog : public Animal {
…
    void sound() {
        printf(“Woof!”);
    }
…
}
C++ Virtual Function Tables
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Instance of class Cat
Vtable ptr
Member: name
Member: fav. catnip
Member: sharp claws?
Function ptr: feed()
Function ptr: pet()
Function ptr: sound()
Function ptr: feed()
Function ptr: pet()
Function ptr: sound()
Animal → Dog, Animal → Cat
class Cat : public Animal {
…
    void sound() {
        printf(“Meow!”);
    }
…
}
class Dog : public Animal {
…
    void sound() {
        printf(“Woof!”);
    }
…
}
Knights and Knaves
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Function ptr: feed()
Function ptr: pet()
Function ptr: sound()
Knights and Knaves
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Function ptr: feed()
Function ptr: pet()
Function ptr: sound()
Function ptr? feed()
Function ptr? feed()
Function ptr? feed()
Function ptr? pet()
Function ptr? pet()
Function ptr? pet()
Function ptr? sound()
Function ptr? sound()
Function ptr? sound()
Knights and Knaves
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Function ptr? feed()
Function ptr? feed()
Function ptr? feed()
Function ptr? pet()
Function ptr? pet()
Function ptr? pet()
Function ptr? sound()
Function ptr? sound()
Function ptr? sound()
Knights and Knaves
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Function ptr? feed()
Function ptr? feed()
Function ptr? feed()
Function ptr? pet()
Function ptr? pet()
Function ptr? pet()
Function ptr? sound()
Function ptr? sound()
Function ptr? sound()
Knights and Knaves
Instance of class Dog
Vtable ptr
Member: name
Member: age
Member: breed
Function ptr? feed()
Function ptr? feed()
Function ptr? feed()
Function ptr? pet()
Function ptr? pet()
Function ptr? pet()
Function ptr? sound()
Function ptr? sound()
Function ptr? sound()
Execute Only Memory
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
Execute Only Memory
Code Ptr:
0xdeadbeef
4K Page @
0xdeadb000
...
mov eax, [ebp-4]
mov ebx, [ebp-8]
add eax, ebx
push eax
push ebx
call 0x64616d6e
...
Necessary vs. Sufficient
● Code reuse requires:
– No ASLR: A priori knowledge of place
– ASLR: A priori knowledge of relative place + runtime 
discovery of offset
– FG-ASLR: Runtime discovery of value at discovered 
place
● No runtime discovery? No discovery of value or 
place and no code to reuse:
– XO-M + FG-ASLR = 
● White Paper: 
● Email: PI:EMAIL 
● Twitter: @dsThyth
● PGP:
– 201a 7b59 a15b e5f0 bc37 08d3 bc7f 39b2 dfc0 2d75