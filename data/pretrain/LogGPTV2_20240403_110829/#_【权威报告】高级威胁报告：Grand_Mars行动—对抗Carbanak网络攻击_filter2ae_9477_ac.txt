• 95.215.46.229
• 95.215.46.234
• 81.17.28.124
通过VirusTotal的报告，任何杀毒软件工具都没有将这个文件标记成恶意软件，这是一个成熟恶意软件的明确标志，及它背后的威胁角色。
UVZHDVlZ.exe
该文件是一个Anunak恶意软件的加载者，Anunak恶意软件是加密的、内嵌在可执行文件中。该载荷(Anunak)可执行并被注入到svchost.exe中，给攻击者提供连接受害系统、并持久化进入受害系统的能力。
表格 7 UVZHDVlZ.exe文件的HASH
最初，可执行文件主程序会使用异或加密密钥“PsdTsr8fer3”,对内嵌在它里面的两个代码模块进行解密,一个是载荷加载者/进程注入模块，一个是Anunak恶意W32可执行文件模块。
解密行为和加密行为一样简单，即用密钥和代码相异或，每次跳过3字节(我们发现使用了解密过程，但是为了保持简洁，在这个报告里我们没有进行详细说明)。
在对可执行文件进行反汇编后，发现了异或密钥，同时，在解密过程中也用到了这个密钥。
图 49 发现异或密钥
正如提到的，Anunak载荷的加载者(注入)模块代码会首先被解密，然后解密Anunak可执行代码。
图 50 载荷解密
图 51 在解密Anunak后，执行它
通过该恶意载荷，我们识别出了下面的C&C服务器IP：
• 179..43.140.85 (port: 443)
• 107.181.246.189 (port: 443)
该恶意软件的执行流程图可以表示成如下图片：
图 52 UVZHDVlZ.exe的直观执行流程图
有趣的是，UVZHDVlZ.exe使用了一个由Comode CA颁发的有效数字证书，似乎是用伪造的身份购买，伪造的身份是俄罗斯莫斯科的一个公司。
图 53 UVZHDVlZ.exe数字证书的详细信息
根据VirusTotal的报告，没有任何杀毒软件将UVZHDVlZ.exe标记为恶意软件。这是特定恶意软件和该攻击活动背后专业攻击者的另一个标志。
**Update.exe**
该可执行文件和前面分析中描述的Anunak加载者可执行文件一样，使用了Comode
CA颁发的一个数字证书，但是该证书是在此次攻击行动前几周买的。和Anunak加载者可执行文件一样，这个证书也包含发行细节，一家俄罗斯莫斯科的公司，可能是伪造的。
表格 8 Update.exe的HASH
图 54 Update.exe的数字证书详情
该可执行文件实际上也是一个加载者，它会创建一个Cobalt Strike post-exploitation工具的新线程，名为“beacon”。Beacon动态链接库是加密的，内嵌在恶意软件中。
最初，主可执行文件会解密内嵌在它里面的两个代码模块，一个是加载代码模块(它本身)，一个是载荷PE文件(内嵌在它里面)，
和我们之前描述过的Anunak加载者可执行文件一样，该文件也使用异或进行加密，密钥是“keDx8”，加密解密是一个密钥，作用于加载者代码和内嵌的PE可执行文件上。下图显示的是解密异或代码的反汇编代码：
图 55 异或密钥的解密流程
下图显示的是加密的/解密的加载者，和PE可执行文件(载荷)：
加载者代码(解密前、解密后)：
图 56 加载者代码
PE可执行文件(解密前、解密后)：
图 57 PE可执行文件
在成功对载荷可执行文件解密后，该载荷会在内存中被执行。
当载荷执行后，它首先会为即将解密的beacon动态链接库预先分配内存。
图 58 载荷分配内存
然后会解密DLL文件。
图 59 解密beacon DLL的流程
图 60 beacon DLL解密
然后，该DLL会被加载到一个新线程中。
图 61 反射beacon DLL
beacon DLL会无限期循环，在两次循环之间会睡眠10秒钟。
该可执行文件使用了一个技术，来探测目标系统或网络中的杀毒软件工具。它连接外部，并从一个硬编码的主机上下载EICAR反恶意软件测试字符串，此文本是一个特殊的“虚拟”字符串，用于测试安全控制系统，如AV软件、IDS等。这给恶意软件一个指示：在目标系统中没有AV工具。
它使用了一个C&C服务器：95.215.44.12 (HTTP)。
图 62 X-Malware字段中的EICAR测试字符串
自撰写本报告之日起，根据VirusTotal的报告，该可执行文件没有被任何杀毒软件标记为恶意软件。
**322.exe**
经过分析，发现它是一个持续性访问受害系统的TCP反弹式后门。
表格 9 322.exe的HASH
该可执行文件会检查系统上的AV进程，基于它发现的信息，要么执行一个新进程“wuauclt.exe”(发现AV)，要么执行“svchost.exe -k
netsvcs”。如果它不能执行前一个命令，会产生explorer.exe进程。
通过分析反汇编的可执行文件代码，该恶意软件需要以下三个参数：{transport}、{LHOST}、{LPORT}。
例如：“322.exe 4 127.0.0.1 53”。
{transport}参数可以是下面的变量：
表格 10 {transport}变量的命令行参数
当可执行文件利用上面的一个选项运行时，它会从对应的远程IP中接收一个DLL载荷，并将它注入到之前成功启动的进程中(wuauclt.exe或svchost.exe或explorer.exe)。然后将执行转移到该进程。这给攻击者提供了三种类型的命令shell,用于访问受害系统。
这不是犯罪份子第一次利用众所周知的工具，因为该可执行文件无非是一个定制的Metasploit载荷，负责下载和执行反弹TCP。322.exe的最后一步是删除自己，为的是不留下踪迹。
VirusTotal在最后一次扫描该恶意可执行文件时，得分是8/57，这是一个低分。结合对文件的分析结果表明，一部分恶意软件作者是高度成熟的，他们能够有效地规避大部分AV工具。
**三、结论**
在对多个恶意可执行文件的调查中，发现了混淆的PowerShell命令、VBS脚本、JavaScript。如下图：
表格 11 此次攻击行动的攻击指示器
一些可执行文件是被他们的父进程下载的，并直接写入到内存中，然后作为DLLs,注入到其它进程中，并在执行后删除。同样，使用PowerShell的好处是：恶意软件不用存储在磁盘里，直接在内存中运行。此外，利用脚本的做法具有很强的灵活性，这是另一个强大的优势，允许攻击者毫不费力地修改他们的代码。
此外，基于利用了多个不同恶意软件这个事实，表明多个实体在进行合作和交流，并在地下市场交流工具和技术。当然，也有可能多个不同的恶意群体是合伙关系，各自负责一些攻击阶段的任务。
同样，部署在全球范围内的网络主机的数量，作为提取点或C&C服务器，也表明这可能是一个有组织的犯罪行动。在下图中，已经描绘出了它们的位置和角色(3个在美国的服务器没有描绘出来)：
图 63 恶意服务器地理位置
实际情况是有人从Comode
CA购买并使用了合法的数字证书，证书使用了有效但可能伪造的身份，俄罗斯莫斯科。这是另一个指向有组织犯罪网络的间接证据，同时，对于此次攻击行为，他们有强烈的攻击动机。
证书签名时间(创建时间)和攻击时间线很接近，有力的表明了购买这些证书就是为了这次攻击行动。这些数字证书是从一个有效的公司偷的或“借”的吗？攻击的时间线和CA产生证书的时间/日期的相关性表明，这不太可能。
此外，攻击者在攻击中使用了Pastebin
URL作为C&C机制的一部分，该URL属于一个个体，名为“Shtokov”。这是另一个弱的标志，表明俄罗斯/东欧的角色参与了这次的攻击行动。
图 64 Shtokov Pastebin网站被用到了C&C机制中
使用像Google
Docs这样的服务是为了保持对受害人的跟踪，并传播恶意文件。这给防御者带来了很大的挑战，因为利用这些流行的公共云服务后，防御者很难将好人和坏人区分开。
最后，随着对carbanak APT活动的不断了解，该恶意软件家族的攻击特征有几个共同的特点，这很可能归因于俄罗斯地下金融网络犯罪。
我们唯一能确定的是，攻击者不会停止寻求新的、创新的方法去感染企业环境和操纵公共服务，这被公众认为是忠实的和值得信赖的。
**四、应对措施**
根据我们的调查，我们发现有多个案件都是“Grand Mars”APT活动的一部分，Trustwave
SpiderLabs推荐以下补救措施，有效地消除或减少由攻击造成的损害，并在威胁实现之前主动解决威胁。
关键对策(中短期)
1) 定期对所有人员进行安全意识培训。
2) 基于互联网的文件禁止执行vbs/宏/VBE。
3) 禁止可执行文件(EXE,VBS等)从AppData、用户临时文件夹启动。
4) 禁用不需要的、完全不受限制的Internet访问。
5) 最小化管理员帐户的数量和使用。
6) 防止常规用户以管理员登录。
7) 对广泛使用的应用层协议实施过滤。
8) 给本地用户和管理员创建单独的密钥，并经常更改。
9) 限制管理员访问权限，除非系统需要。
由于恶意软件主要驻留在内存中，不用读写磁盘，且对主机文件系统改变很少，建议在所有终端、服务器和网络上进行下列检查。我们建议检查的攻击标志是：
1) 系统中是否安装并启动了具有随机名称的服务。
2) 服务是否按以下方法启动：
 PowerShell命令/脚本。
 一个可疑/随机的、未知起源和目的的命令、程序或二进制文件(如我们报告中提到的Update.exe/322.exe)。
 带有随机名称的一个批处理脚本(.bat)。
3)
系统是否尝试连接一个外部IP，特别是用了常见的端口，但是又没有使用这些端口上常用的协议，如110、53、80、443、8080，防火墙通常会允许这些端口的出站连接。
4) 是否存在计划任务或系统自启动位置。
在本报告中，有关恶意软件连接的IP地址和主机/域的完整列表如下图所示：
表格 12 恶意主机和IP地址
**关键行业需要有所意识**
强烈建议零售、电子商务和酒店行业的组织立即实施关键对策。主动进行彻底的威胁评估，而不是等待发现攻击迹象。使用我们高级威胁报告中的信息，在整个网络，包括服务器和终端，实施全面的威胁检查，以确定任何恶意活动的迹象。最后，评估您当前的事件响应能力，并找到影响你们组织响应能力的差距。没有哪个组织可以防御所有攻击。但是如果你有阻止攻击、并迅速作出有效响应的能力，那将长期给你在面对高级攻击时的生存能力带来好的影响。
**参考链接**
[https://www.trustwave.com/Resources/SpiderLabs-Blog/Operation-Grand-Mars–a-comprehensive-profile-of-Carbanak-activity-in-2016/17/?utm_source=tuicool&utm_medium=referral](https://www.trustwave.com/Resources/SpiderLabs-Blog/Operation-Grand-Mars--a-comprehensive-profile-of-Carbanak-activity-in-2016/17/?utm_source=tuicool&utm_medium=referral)