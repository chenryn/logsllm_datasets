Detecting Lateral Movement through Tracking Event Logs
JPCERT Coordination Center
June 12, 2017
Table of Contents
1. Introduction .......................................................................................................................4
2. Research Method .............................................................................................................5
2.1. Approach ................................................................................................................................ 5
2.2. Tested Tools ........................................................................................................................... 6
2.3. Research Environment .......................................................................................................... 8
3. Research Results .............................................................................................................9
3.1. Layout of This Chapter .......................................................................................................... 9
3.2. Command Execution ............................................................................................................1 1
3.2.1. PsExec ...........................................................................................................................1 1
3.2.2. wmic .............................................................................................................................. 13
3.2.3. PowerShell .................................................................................................................... 14
3.2.4. wmiexec.vbs ................................................................................................................. 16
3.2.5. BeginX .......................................................................................................................... 18
3.2.6. WinRM .......................................................................................................................... 19
3.2.7. WinRS ........................................................................................................................... 21
3.2.8. AT .................................................................................................................................. 23
3.2.9. BITS .............................................................................................................................. 25
3.3. Obtaining Password Hash ................................................................................................... 26
3.3.1. PWDump7 .................................................................................................................... 26
3.3.2. PWDumpX .................................................................................................................... 27
3.3.3. Quarks PwDump .......................................................................................................... 29
3.3.4. Mimikatz (Obtaining Password Hash) .......................................................................... 30
3.3.5. Mimikatz (Obtaining Ticket) ........................................................................................... 31
3.3.6. WCE.............................................................................................................................. 32
3.3.7. gsecdump ..................................................................................................................... 33
3.3.8. lslsass ........................................................................................................................... 34
3.3.9. Find-GPOPasswords.ps1 ............................................................................................. 35
3.3.10. Mail PassView ........................................................................................................... 36
3.3.11. WebBrowserPassView .............................................................................................. 37
3.3.12. Remote Desktop PassView ...................................................................................... 38
3.4. Malicious Communication Relay ......................................................................................... 39
3.4.1. Htran ............................................................................................................................. 39
3.4.2. Fake wpad .................................................................................................................... 40
3.5. Remote Login ....................................................................................................................... 42
3.5.1. RDP (Remote Desktop Protocol) ................................................................................. 42
3.6. Pass-the-hash, Pass-the-ticket ............................................................................................ 43
3.6.1. WCE (Remote Login) ................................................................................................... 43
1
3.6.2. Mimikatz (Remote login) ............................................................................................... 45
3.7. Escalation to the SYSTEM Privilege ................................................................................... 46
3.7.1. MS14-058 Exploit ......................................................................................................... 46
3.7.2. MS15-078 Exploit ......................................................................................................... 47
3.8. Privilege Escalation ............................................................................................................. 48
3.8.1. SDB UAC Bypass ......................................................................................................... 48
3.9. Capturing Domain Administrator Rights Account ................................................................ 50
3.9.1. MS14-068 Exploit ......................................................................................................... 50
3.9.2. Mimikatz (Golden Ticket) .............................................................................................. 52
3.9.3. Mimikatz (Silver Ticket) ................................................................................................. 54
3.10. Capturing Active Directory Database ............................................................................... 55
3.10.1. ntdsutil ....................................................................................................................... 55
3.10.2. vssadmin ................................................................................................................... 56
3.11. Adding or Deleting Local User and Group ....................................................................... 57
3.11.1. net user ..................................................................................................................... 57
3.12. File Sharing ...................................................................................................................... 58
3.12.1. net use ...................................................................................................................... 58
3.12.2. net share ................................................................................................................... 59
3.12.3. icacls ......................................................................................................................... 60
3.13. Deleting Evidence ............................................................................................................ 61
3.13.1. sdelete ....................................................................................................................... 61
3.13.2. timestomp.................................................................................................................. 62
3.14. Deleting Event Log ........................................................................................................... 63
3.14.1. wevtutil ...................................................................................................................... 63
3.15. Obtaining Account Information ......................................................................................... 64
3.15.1. csvde ......................................................................................................................... 64
3.15.2. ldifde .......................................................................................................................... 66
3.15.3. dsquery ..................................................................................................................... 67
3.16. Evidence That Can Be Observed for Successful Tool Execution .................................... 68
4. Acquiring Additional Logs ...............................................................................................7 0
4.1. Importance of Acquiring Additional Logs ............................................................................. 70
4.2. Precautions When Changing the Additional Log Acquisition Settings ................................ 70
5. How to Use This Report in Incident Investigation ..........................................................7 1
5.1. Incident Investigation Using This Report ............................................................................. 71
6. Conclusion ......................................................................................................................7 2
7. Appendix A .....................................................................................................................7 3
7.1. How to Install Sysmon ......................................................................................................... 73
7.2. How to Enable the Audit Policy ............................................................................................ 73
8. Appendix B .....................................................................................................................7 7
2
Index ......................................................................................................................................7 9
3
1. Introduction
Many recent cyberattacks have been confirmed in which malware infects a host and in turn
spreads to other hosts and internal servers, resulting in the whole organization becoming
compromised. In such cases, many points need to be investigated. Accordingly, an approach for
quickly and thoroughly investigating such critical events, ascertaining the overall picture of the
damage as accurately as possible, and collecting facts necessary for devising remedial measures is
required.
While the configuration of the network that is targeted by an attack varies depending on the
organization, there are some common patterns in the attack methods. First, an attacker that has
infiltrated a network collects information of the host it has infected using "ipconfig", "systeminfo", and
other tools installed on Windows by default. T hen, they examine information of other hosts
connected to the network, domain information, account information, and other information using "net"
and other tools. After choosing a host to infect next based on the examined information, the attacker
obtains the credential information of the user using "mimikatz", "pwdump", or other password dump
tools. Then, by fully utilizing "net", "at", or other tools, the attacker infects other hosts and collects
confidential information.
For such conventional attack methods, limited set of tools are used in many different incidents. The
many points that need to be investigated can be dealt with quickly and systematically by
understanding typical tools often used by such attackers, and what kind of and where evidence is
left.
For such use of tools, the Japan Computer Emergency Response Team Coordination
Center (JPCERT/CC) extracted tools used by many attackers by investigating recently confirmed
cases of targeted attacks. Then, a research was conducted to investigate what kind of logs were
left on the server and clients by using such tools, and what settings need to be configured to
obtain logs that contain sufficient evidential information. This report is a summary of the results of
this research.
The outline of this report is as follows. First, Chapter 2 describes the environment and the
tools used for this research. Next, Chapter 3 describes the results of this research. Then,
Chapter 4 explains how to investigate an incident based on this research results described in
Chapter 3.
4
2. Research Method
This chapter describes the method that was used for this research.
2.1. Approach
The research aims to provide basic information which is useful in log analysis by investigating
evidence of tools used by many attackers. More specifically, this report aims to be a dictionary that
can be used as a guide for effective log analysis by identifying which tools were used based on logs
or which log is recorded when a certain tool is executed.
In this research, tools that are used by many attackers were investigated. The specific tools that
JPCERT/CC knows are used by many attackers are described in the next section. The following log
items were investigated so that persons who are not experts in incident investigation can analyze
more easily:
• Event log
• Execution history
• Registry entry
Note that a sufficient amount of event logs cannot be acquired with the default Windows settings. In
this research, logs that are recorded with the default setting and the following setting were
investigated:
• Enabling the audit policy
• Installing Sysmon
The audit policy is a default Windows setting for acquiring detailed logs about logon, logoff, file
access, etc. The audit policy can be confirmed and its settings can be changed from the local group
policy.
Sysmon is a tool provided by Microsoft that enables process startup, network communication, file
changes, etc., to be recorded in event logs. Installing Sysmon enables recorded logs from Event
Viewer to be checked as shown below.
5
Fig. 2-1: Checking Sysmon Logs from Event Viewer
In this research, the tools listed in Section 2.2 were actually executed on a virtual network made up
of Windows Domain Controller and a client. By checking changes in the system before and after
executing each tool, execution history, event logs, and registry entry records were collected and
summarized in Chapter 3. The network environment used for this research are described in detail in
Section 2.3.
2.2. Tested Tools
Among tools observed in multiple incidents that JPCERT/CC handled, 44 tools that are directly
related to attack operations were selected as typical tools, such as command execution, obtaining
password hash, and remote login. Table 2-1 shows these tools grouped by the attackers' purpose of
use.
Table 2-1: List of Tested Tools
Attacker's Purpose of Using Tool Tool Chapter
Number
PsExec 3.2.1
wmic 3.2.2
Command execution
PowerShell 3.2.3
wmiexec.vbs 3.2.4
6
Attacker's Purpose of Using Tool Tool Chapter
Number
BeginX 3.2.5
winrm 3.2.6
at 3.2.7
winrs 3.2.8
BITS 3.2.9
PWDump7 3.3.1
PWDumpX 3.3.2
Quarks PwDump 3.3.3
Mimikatz (Obtaining password hash) 3.3.4
Mimikatz (Obtaining ticket) 3.3.5
WCE 3.3.6
Obtaining password hash
gsecdump 3.3.7
lslsass 3.3.8
Find-GPOPasswords.ps1 3.3.9
Mail PassView 3.3.10
WebBrowserPassView 3.3.11
Remote Desktop PassView 3.3.12
Malicious communication relay Htran 3.4.1
(Packet tunneling) Fake wpad 3.4.2
Remote login RDP 3.5.1
Pass-the-hash WCE (Remote login) 3.6.1
Pass-the-ticket Mimikatz (Remote login) 3.6.2
MS14-058 Exploit 3.7.1
Escalation to SYSTEM privilege
MS15-078 Exploit 3.7.2
Privilege escalation SDB UAC Bypass 3.8.1
MS14-068 Exploit 3.9.1
Capturing domain administrator
Golden Ticket (Mimikatz) 3.9.2
rights account
Silver Ticket (Mimikatz) 3.9.3
Capturing Active Directory database
ntdsutil 3.10.1
(Creating a domain administrator user or
vssadmin 3.10.2
adding it to an administrator group)
Adding or deleting a user group net user 3.11.1
net use 3.12.1
File sharing net share 3.12.2
icacls 3.12.3
7
Attacker's Purpose of Using Tool Tool Chapter
Number
sdelete 3.13.1
Deleting evidence
timestomp 3.13.2
Deleting event log wevtutil 3.14.1
csvde 3.15.1
Obtaining account information ldifde 3.15.2
dsquery 3.15.3
2.3. Research Environment
A simplified system with a pair of client and server, was built on a virtual network as a target. The
selected tools were executed in the environment to observe changes to files and registries resulting
from the execution. By installing the following Windows versions on the server and client, a total of
four types of system configurations were tested. In each system configuration, Active Directory
service was configured on the server to manage the client computer.
• OS installed on the client
 Windows 7 Professional Service Pack 1
 Windows 8.1 Pro
• OS installed on the server
 Windows Server 2008 R2 Service Pack 1
 Windows Server 2012 R2
8
3. Research Results
This chapter summarizes the basic information including functionality of the tools tested in this
research and log information recorded when the relevant tools were executed. The attacker's
perspective was also taken into account in the description of the basic information so that the
significance of each tool in an attack sequence can be easily understood. This chapter also
describes the details of logs that can be acquired when the settings described in section 2.1 are
configured. (Note that how to set up the audit policy and how to install Sysmon are described in
Chapter 7.)
3.1. Layout of This Chapter
The following describes the 44 tools using the table format shown below.
Fig. 3-1: Content of the Descriptions in the Subsequent Sections
9
The following describes the content described for each item.
(1) Description of the tool
 The impact from the use of the tool, privileges for using the tool, communication protocol,
and related services are described.
(2) Test environment
 Information about the OS at the source host and destination host.
(3) Log storage location
 Storage location of registries and event logs.
(4) Evidence that can be confirmed when execution is successful
 The method to confirm successful execution of the tool.
(5) Information described in event logs, registries, and files
 If the record in an event log, registry, or file match the description in this item, it is likely
that the record was made by executing the relevant tool and thus investigation is
required.
(6) Important information that can be confirmed in a log
 Important information that can be used for the investigation of records in the targeted logs
(This does not necessarily mean that all information that is recorded is described.)
(7) Whether or not an additional setting is required for acquiring the relevant log
 Indicated as "-" when the log can be obtained in the standard setting, or "Required" when
an additional setting is needed.
(8) Additional event logs that may be output
 Any logs that may be additionally recorded.
10
3.2.1. PsExec
Basic Information
Tool Name PsExec Legend
Category Command Execution - Acquirable
Tool Overview Executes a process on a remote system Information
Tool - Event ID/Item Name
Example of The tool may be used to remotely execute a command on client and servers in a domain.
- Field Name
Presumed Tool Use - Source host: PsExec command execution source
- "Field Value"
During an Attack - Destination host: The destination logged in by the PsExec command
- Source host: Standard user
Authority
- Destination host: Administrator
Targeted OS Windows
Operating
Domain Not required
Condition
Communication 135/tcp, 445/tcp, a random high port
Protocol *When executing in a domain environment, communication for Kerberos authentication with the domain controller occurs.
Service -
- Source host: A registry to the effect that the PsExec License Agreement has been entered is registered.
Standard Settings
- Destination host: The fact that the "PSEXESVC" service has been installed, started, and ended is recorded.
Information - Execution history (Sysmon/audit policy)
Acquired from - Source host: The fact that the PsExec process was executed and that connection was made to the destination via the network, as well as the command name and argument for a
Log Additional Settings remotely executed command are recorded.
- Destination host: The fact that the PSEXESVC's binary was created and accessed, and that connection was made from the source via the network, as well as the command name and
argument for a remotely executed command are recorded.
If the following is confirmed, it is possible that PsExec was executed.
Evidence That Can Be Confirmed - Source host: If the following log is in the event log
When Execution is Successful - The Event ID 4689 (A process has exited) of psexec.exe was recorded in the event log "Security" with the execution result (return value) of "0x0".
- Destination host: PSEXESVC.exe is installed.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[Execution File (psexec.exe)]"
Event Log
- Confirmable Information
- Required
- Process Start/End Time and Date: Log Date
Security
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 1 (Process Create)
Source Host
5 (Process Terminated)
- Image: "[Execution File (psexec.exe)]"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *The remotely executed command is recorded in the argument in
- User Name: User the command line.
- Process ID: ProcessId
Execution history Registry Entry:
HKEY_USERS\[SID]\Software\Sysinternals\PsExec
- - EulaAccepted -
Registry *If PsExec has not been executed in the past, the registry to the effect that the License Agreement has been entered is output.
(If the service was executed in the past, the registry will remain unchanged.)
Event ID: 7045 (A service was installed in the system)
- Confirmable Information
Event Log - Process Name: "PSEXESVC"
- - Path: "%SystemRoot%\PSEXESVC.exe" -
System
Event ID: 7036 (The service state has changed)
*The "PSEXESVC" service enters the "Executing" state before executing a remote process, and enters the "Stopped" state
OS: Windows after the execution.
user
↓ Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
OS: Windows *Communication occurs from the source host to the destination with destination ports 135 and 445.
administrator (Example: The Windows Filtering Platform has allowed communication from 192.168.0.10:49210 to 192.168.0.2:445)
*Communication occurs from the source host to the destination with a random high port (1024 and higher) as the destination port.
Event ID: 5140 (A network share object was accessed)
- Confirmable Information
- Connection Date and Time: Log Date *The date and time before the start of PSEXESVC.exe
- Account Used for Connection: Subject -> Security ID and Account Name
- Source Host: Network Information -> Source Address and Source Port
- Connected Share: "\??\C:\Windows" (administrative share)
Destination Host
Event ID: 4672 (Special privileges assigned to new logon) *Before this event occurs, the event 4624 occurs.
An account logged on when the event 4624 occurs is assigned privileges.
- Confirmable Information
- Account Used for Connection: Subject -> Security ID and Account Name
Event Log
- Assigned Privileges: Privileges
- Required
Security
Event ID: 4656 (A handle to an object was requested), 4663 (An attempt was made to access an object)
- Object -> Object Name:"C:\Windows\PSEXESVC.exe"