and
con
trol.
Whenev
er
a
hostname
is
iden
tied
b
y
la
w
enforcemen
t
agencies
as
a
C
and
C,
they
t
ypically
p
erform
a
DNS
tak
e
o
v
er,
redirect
the
DNS
to
a
public
IP
they
con
trol,
and
send
a
sh
utdo
wn
command
to
an
y
infected
host
connecting
to
this
IP
.
Den
ying
la
w
enforcemen
t
agencies
(or
who
ev
er
else)
the
capabilit
y
to
send
a
sh
utdo
wn
command
to
a
b
otnet
is
relativ
ely
easy
:
all
it
really
tak
es
is
to
digitally
sign
the
commands
using
strong
assymetric
cryptograph
y
.
The
up
dates
of
Rakshasa
could
also
b
e
digitally
signed,
whic
h
w
ould
prev
en
t
mo
dica-
tion
of
the
up
dates
b
y
the
same
agencies.
This
w
a
y
,
in
tegrit
y
is
ensured.
The
only
remaining
problem
is
the
a
v
ailabilit
y
(at
least
partial
and
sp
oradic
:
after
all,
w
e
probably
don't
need
to
upgrade
our
bac
kdo
or
at
ev
ery
reb
o
ot
strictly
sp
eaking)
of
the
command
and
con
trol.
A
trivial
w
a
y
to
solv
e
this
issue
is
to
ha
v
e
a
rotativ
e
command
and
con
trol
that
is
randomly
pic
k
ed
b
y
Rakshasa
ev
ery
time
from
a
random
address
accross
all
the
in
ternet
IP
range
14
.
There
again,
the
bac
kdo
or
w
ould
b
e
upgraded
less
often,
but
the
command
and
con
trol
could
simply
not
b
e
sh
ut
do
wn.
Finally
,
em
b
edding
clien
t
side
SSL
certicates
on
the
bac
kdo
or
w
ould
prev
en
t
trivial
detection
of
com-
mand
and
con
trol
hosts
b
y
scanning
all
the
in
ternet
for
giv
en
les.
It
is
w
orth
men
tioning
that
Coreb
o
ot
is
capable
of
using
its
o
wn
em
b
edded
CMOS
image,
hence
lea
ving
the
real
CMOS
n
vram
a
v
ailable
to
store
v
olatile
cryptographic
k
eys.
By
using
this
feature
as
w
ell
as
hardw
are
ngerprin
ting
(t
ypically
the
MA
C
address)
to
regenerate
decryption
k
eys
at
eac
h
reb
o
ot,
it
is
p
ossible
to
create
a
bac
kdo
or
extremely
hard
to
extract
from
the
bac
kdo
ored
hardw
are
(eg:
it
can't
b
e
simply
copied
in
to
a
virtal
mac
hine
for
analysos).
W
e
b
eliev
e
a
BIOSBotnet
rela
ying
on
suc
h
an
arc
hitecture
can
literally
not
b
e
sh
ut
do
wn.
13
Mo
dulo
the
Flame
w
orm,
whic
h
seems
to
ha
v
e
spread,
among
other
v
ectors,
thanks
to
a
rogue
cryptographic
certicate
based
on
a
rogue
MD5
hash
collision
-using
an
unkno
wn
tec
hnique
at
the
time
of
writting-
and
b
y
hijac
king
DNS
answ
ers
to
the
Microsoft
up
date
serv
er.
14
In
p
cractice,
a
large
subset
including
a
sucien
t
n
um
b
er
of
non
con
troled
IP
w
ould
suce
:
la
w
enforcemen
t
agencies
are
unlik
ely
to
ev
er
sh
ut
do
wn
the
whole
A
T&T
range
or
sa
y
go
ogle.com.
11
9
Wh
y
(p
ossibly
hardw
are
assisted)
encryption
w
on't
solv
e
the
problem
A
t
this
stage
of
the
demonstration,
some
ma
y
b
eliev
e
cryptograph
y
,
and
in
particular
full
disk
cryp-
tograph
y
com
bined
with
TPM
shall
prev
en
t
the
bac
kdo
or
from
doing
an
y
damage.
W
e
shall
therefore
discuss
those
tec
hnologies
in
the
presen
t
c
hapter.
First
of,
F
ull
Disk
Encryption
(FDE)
in
itself
has
b
een
pro
v
ed
vulnerable
to
m
ultiple
implemen
tation
a
ws[23
℄[24℄,
and
can
often
b
e
attac
k
ed
via
bruteforce[25
℄,
but
in
all
generalit
y
,
it
as
simply
b
een
pro
v
ed
not
to
prev
en
t
b
o
otkitting
at
all
when
not
asso
ciated
with
TPM[13℄.
W
e
briey
prop
ose
a
v
arian
t
of
the
evil
maid[26℄
attac
k
applicable
to
the
scenario
of
Rakshasa
ha
ving
to
b
ypass
suc
h
a
securit
y
feature.
First
of,
TPM
b
eing
a
passiv
e
c
hip,
Rakshasa
can
still
b
o
ot
a
remote
OS
silen
tly
,
w
ether
TPM
is
presen
t
or
not.
Let's
rst
assume
TPM
is
not
presen
t.
Instead
of
fetc
hing
a
b
o
otkit,
Rakshasa
can
detect
that
the
rst
b
o
otable
hard
driv
e
is
en
trypted,
and
b
o
ot
a
small
op
erating
system
mimic
king
the
login
prompt
of
the
FDE,
w
ait
for
the
user
to
en
ter
their
creden
tials,
sa
v
e
the
passw
ord
to
CMOS,
optionally
sending
the
passw
ord
bac
k
to
the
command
and
con
trol
serv
er.
Once
the
passw
ord
is
kno
wn,
Rakshasa
can
disable
in
terrupt
0x10
(video)
em
ulate
an
in
terruption
0x19
to
reload
the
real
b
o
ot
loader,
sim
ulate
k
eyb
oard
t
yping[23
℄
in
16b
real
mo
de
b
y
programming
directly
the
PIC
micro
con
trolers
em
b
edded
in
b
oth
the
k
eyb
oard
and
the
motherb
oard,
and
ev
en
tually
let
the
system
b
o
ot
normally
.
Let's
no
w
assume
TPM
is
indeed
presen
t
:
if
the
mac
hine
w
as
bac
kdo
ored
b
efore
the
conguration
w
as
sealed
with
TPM
(t
ypically
:
the
mac
hine
w
as
bac
kdo
ored
b
y
the
man
ufacturer
or
b
y
an
y
one
in
the
supply
c
hain
b
efore
deliv
ery),
the
attac
k
is
absolutly
unc
hanged.
The
only
case
where
TPM
is
mo
deratly
usefull
is
if
Rakshasa
w
as
installed
after
the
TPM
w
as
sealed.
Ev
en
in
this
later
case,
Rakshasa
can
still,
b
o
ot
a
remote
fak
e
login
prompt
(and
ev
en
an
en
tire
fak
e
OS
!)
since
once
again,
TPM
is
passiv
e.
Optionally
,
the
bac
kdo
or
can,
after
stealing
the
user
creden
tials
and
sending
them
to
the
command
and
con
trol,
ash
the
original
BIOS
bac
k
(ak
a:
desinfect
the
mac
hine)
and
p
erform
a
hard
reb
o
ot.
Upp
on
next
reb
o
ot,
the
attac
k
w
ould
remain
unoticed
(as
FDE
w
ould
w
ork
again).
12
10
Remediation
11
Conclusion
13
12
A
c
kno
wledgemen
ts
W
e
w
ould
lik
e
to
thank:
Floren
tin
Demetrescu,
mem
b
er
of
the
Coreb
o
ot
pro
ject,
without
whom
this
researc
h
w
ould
ha
v
e
nev
er
started
in
rst
place.
Piotr
Bania,
for
kindly
con
tributing
a
custom
v
ersion
of
k
on-b
o
ot
to
facilitate
this
pro
of
of
concept.
The
T
oucan
System
team
b
oth
in
F
rance
and
Australia
:
I
w
ouldn't
b
e
doing
researc
h
without
y
our
con
tin
uous
moral
and
tec
hnical
bac
kdup.
The
Hac
kito
Ergo
Sum
team,
Programming
comitee,
Sp
eak
ers
and
attendees
for
their
constan
t
passion.
Matthieu
Suic
he,
Mark
Do
wd,
T
arjei
Mandt,
Sid,
Meder
Kyderaliev,
Cesar
Cerrudo,
F
y
o
dor
Y
aroshkin
Ro
drigo
"BS-
Deamon"
Branco,
Silvio
Cesare,
Tim
shelton,
Andrewg,
Nemo,
Mercy
,
Caddis,
TGO,
Dan
Rosen
b
erg,
Morla,
mxn,
Xort,
the
Grugq,
Nergal,
Pipax,
Sp
ender,
FX
and
the
en
tire
Pheno
elite
crew,
for
their
friendship,
inspiration,
h
umilit
y
,
passion
and
supp
ort.
All
those
I
ha
v
en't
men
tioned
here
but
help
me
c
hallenge
m
yself
(y
ou
kno
w
who
y
ou
are),
the
HITB,
Recon,
H2HC,
CBA
Cert,
Ruxcon
teams,
as
w
ell
as
the
SV
C.
#so
cial,
#blac
ksec,
#busticati.Thanks
heaps
:
y
ou
made
me
write
this
;)
14
References
1.
Duot,
L.:
Securit
y
issues
related
to
p
en
tium
system
managemen
t
mo
de,
CanSecW
est
(2006)
2.
In
tel:
Extensible
rm
w
are
in
terface
sp
ecications
v1.10
(2003)
3.
In
tel:
Unied
extensible
rm
w
are
in
terface
sp
ecications
(2005)
4.
PCI-SIG:
P
eripheral
comp
onen
t
in
terconnect
sp
ecications
lb3
v0.2.6
(2004)
5.
Coreb
o
ot:
(Coreb
o
ot
-
formerly
lin
uxbios)
6.
Coreb
o
ot:
(Seabios
-
op
en
source
implemen
tation
of
a
16bit
x86
bios)
7.
iPXE:
(ip
xe
-
op
en
source
b
o
ot
rm
w
are)
8.
Northrop-Grumman-Corp:
Occup
ying
the
information
high
ground:
Chinese
capabilities
for
com-
puter
net
w
ork
op
erations
and
cyb
er
espionage
(2012)
9.
Saco,
A.,
Ortega,
A.:
P
ersistan
t
bios
infection,
CanSecW
est
(2009)
10.
Heasman,
J.:
Firm
w
are
ro
otkits
and
the
threat
to
the
en
terprise,
Blac
khat
USA
(2007)
11.
So
eder,
D.,
P
ermeh,
R.:
Bo
otro
ot,
Blac
khat
USA
(2005)
12.
Kumar,
Kumar:
Bo
otkit
2.0
:
A
ttac
king
windo
ws
7
via
b
o
ot
sectors,
Hac
kinTheBo
x
(2010)
13.
Kleissner,
P
.:
Stoned
b
o
otkit,
Blac
khat
USA
(2009)
14.
Bania,
P
.:
K
on-b
o
ot
(2008)
15.
Roux,
P
.L.:
(T
ruecrypt
-
free
op
en-source
on-the-y
disk
encryption
soft
w
are)
16.
P
aX:
(A
ddress
space
la
y
out
randomization)
17.
IBM:
(Connector
bus
isa
(industry
standard
arc
hitecture))
18.
PCI-SIG:
Pci
exptress
base
r3.0
v1.0
(2010)
19.
AMD:
(I/o
virtualization
tec
hnology
(iomm
u)
sp
ecication
revision
1.26)
20.
BSDaemon-Coidelok
o-D0nAnd0n:
System
managemen
t
mo
de
hac
k
using
smm
for
"other
purp
oses".
(Phrac
k
magazine)
21.
T
rusted-Computing-Group:
(T
rusted
platform
mo
dule
sp
ecications)
22.
In
tel:
(The
preb
o
ot
execution
en
vironmen
t
sp
ecication
v2.1)
23.
Brossard,
J.:
Bypassing
preb
o
ot
authen
tication
passw
ords
b
y
instrumen
ting
the
bios
k
eyb
oard
buer,
Defcon
(2008)
24.
Brossard,
J.:
Bios
information
leak
age.
(2005)
25.
Brossard,
J.:
Bruteforcing
preb
o
ot
authen
tication
passw
ords,
h2hc
conference
(2009)
26.
Rutk
o
wsk
a,
J.:
Evil
maid
go
es
after
truecrypt!
(2009)
15