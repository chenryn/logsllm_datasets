Reno, 9503,United 
+Coge
图3-1使用Netcraft来找出承载某个特定网站的服务器IP地址
查明secmaniac.net的IP地址是75.118.185.142后，我们再做一次针对这个IP地址的whois
查询：
msf>whois 75.118.185.142
[*]exec:whois75.118.185.142
WideOpenWest Finance LLC WIDEOPENWEST (NET-75-118-0-0-1)
75.118.0.0-75.118.255.255
WIDEOPENWEST OHIOWOW-CL11-1-184-118-75 (NET-75-118-184-0-1)
75.118.184.0-75.118.191.255
从whois的查询结果我们发现WIDEOPENWEST看起来很像是网站的服务提供商。由于真
实的子网范围并不注册在secmaniac.net或secmaniac.com的名下，我们能够判断这个网站可能
运行在其所有者的家里，因为IP地址看起来像在家庭用户的地址段内。
17
---
## Page 45
Metasploit渗透测试指南
3.1.3 NSLookup
为了获取关于服务器的附加信息，我们使用Back|Track执行nslookup，大多数操作系统均
集成了这个工具，我们利用它来挖掘secmaniac.net的更多信息。
root@bt:~# nslookup
set type=mx
>secmaniac.net
Server:
172.16.32.2
Address:
172.16.32.2#53
Non-authoritativeanswer:
secmaniac.net  mail exchanger = 10 mailstore1.secureserver.net.
secmaniac.netmailexchanger=0smtp.secureserver.net
在上述列表中，我们看到邮件服务器的DNS记录指向mailstorel.secureserver.net和
smtp.secureserver.net。很明显，这些邮件服务器是由第三方运维的，同样不在我们的渗透测试
范围内。
到自前为止，我们已经搜集到了一些在后续工作中可能会用到的有价值的自标信息。然而
最终我们还要借助主动信息搜集技术对目标IP地址（75.118.185.142）进行更准确的信息探测。
提示：被动信息搜集是一门艺术，它不是几页纸的讨论就能轻松掌握的。可以参考“渗
透测试执行标准（PTES；http://www.pentest-standard.org/）”上的方法，拓展你的被动信息
搜集工作。
3.2主动信息搜集
说，我们可以执行端口扫描来确定目标系统开放了哪些端口、运行了哪些服务。多发现一个存
活的主机或运行中的服务，就多一些渗透成功的机会。但是请注意：如果你在主动信息搜集过
程中不够小心，那么你很可能会被入侵检测系统（IDS）或入侵防御系统（IPS）给逮住，这绝
3.2.1使用Nmap进行端口扫描
通过被动信息搜集确定了目标的IP范围后（这里仍以secmaniac.net的IP地址为例)，我们
可以开始使用端口扫描获取目标开放的端口。端口扫描的过程实际上是逐个对远程主机的端口
发起连接，从而确定哪些端口是开放的。（很明显如果目标是大型企业，我们会有很多待攻击的
IP地址，而不是本例中的一个IP。）
到目前为止，Nmap是最为流行的端口扫描工具，它与Metasploit的集成可谓是“珠联璧合”，
在Metasploit中，Nmap的输出结果可以保存在后端数据库中以备后续使用。Nmap能够让你一
18
---
## Page 46
第3章情报搜集
在本例中，我们先把secmaniac.net放在一边，将关注转向附录A中描述的IP地址为
172.16.32.131的虚拟机，我们将用它作为我们演练nmap使用技巧的目标靶机。开始之前，请
你会立刻发现nmap有着繁多的参数和选项，不过好在大多数情况下我们只会用到其中的
一小部分。
我们推荐的nmap选项之一是-sS，使用它来执行一次隐秘的TCP扫描，以确定某个特定的
TCP端口是否开放。另一个推荐的选项是-Pn，它会告诉nmap不要使用ping命令预先判断主机
是否存活，而是默认所有主机都是存活状态。这个选项适用于Internet上的渗透测试环境，因为
在Intermnet上大多数网络均不允许ping命令所使用的“Intermet控制报文协议（ICMP）”通行，
如果预先使用ping进行判断，那么你可能会漏掉许多实际存活的主机。而如果你在内网的环境
中运行nmap，则可以忽略掉这个选项以加快扫描速度。
现在让我们使用-sS和-Pn选项对我们的WindowsXP虚拟机执行一次简单的nmap扫描。
r0ot@bt:~#nmap-sS-Pn172.16.32.131
Nmap scanreport for 172.16.32.131
Host is up (o.o0057s latency).
Not shown:99o closedports
PORT
STATE SERVICE
21/tcpopen ftp
25/tcp
opensmtp
80/tcp
openhttp
135/tcp open msrpc
139/tcp open netbios-ssn
443/tcp open https
445/tcp open microsoft-ds
1025/tcp open NFS-or-IIS
1433/tcp open ms-sql-s
3389/tcpopenms-term-serv
如你所见，nmap会报告一个开放端口的列表，并且在每个端口后面附上其绑定服务的描
述。
为了获取更多信息，可以尝试使用-A选项，它将尝试进行深入的服务枚举和旗标获取，这
些能够为你提供目标系统更多的细节信息。下面是我们使用-sS和-A选项，对相同的目标扫描
得到的结果。
T1.2'91.241 - 5s- u- deu #4q1001
Nmapscan report for172.16.32.131
Host is up (o.0035s latency).
Not shown:993 closed ports
PORTSTATE SERVICE
VERSION
135/tcpopenmsrpc
Microsoft Windows RPC
139/tcpopennetbios-ssn
445/tcpopenmicrosoft-ds Microsoft windows XP microsoft-ds
19
---
## Page 47
Metasploit渗透测试指南
777/tcpopenunknown
1039/tcp open unknown
1138/tcp open msrpc
Microsoft Windows RPC
1433/tcp open ms-sql-s
Micr0soft SQL Server 2005 9.00.1399; RTM
...SnIP..·
Devicetype:generalpurpose
Running:Microsoft WindowsXP|2003
OS details: Microsoft Windows XP Professional SP2 or Windows Server 2003
Network Distance:1 hop
ServiceInfo:OS:Windows
Host script results:
I_nbstat: NetBIOS name:V-MAC-XP，NetBIOS user:，NetBIOS MAC:
00:0c:29:c9:38:4c(VMware)
!_smbv2-enabled:Server doesn't support SMBv2protocol
ismb-os-discovery:
OS:Windows XP（Windows 2oo0LAN Manager）
Name:WORKGROUP\V-MAC-XP
3.2.2在Metasploit中使用数据库
如果你正在执行一项复杂的渗透测试工作，有大量的测试目标，那么想要把所有的操作记
录下来并非易事。幸运的是，Metasploit提供了对多种数据库的广泛支持，这些数据库能够帮助
你完成这些繁杂的工作。
你可以根据系统的数据库支持情况来选择Metasploit使用的数据库类型，Metasploit支持
MySQL、PostgreSQL和SQLite3数据库，我们在本次讨论中将使用PostgreSQL作为例子，因
为它是Metasploit默认的。
首先，我们使用集成在BackTrack中的init.d脚本启动数据库子系统。
root@bt~#/etc/init.d/postgresql-8.3start
PostgreSQL启动后，我们让Metasploit框架连接到这个数据库实例上。连接到数据库需要
用户名、口令、运行数据库系统的主机名以及想要使用的数据库名。BackITrack中PostgreSQL
默认的用户名是postgres，口令是toor，我们将使用msfbook作为数据库名。输入如下命令建立
与数据库的连接：
msf > db_connect postgres:toor@127.0.0.1/msfbook
如果是第一次连接到msfbook数据库，我们会看见一堆冗长的输出，这是由于Metasploit
在生成所有必须的数据表。如果不是第一次连接，这条命令会直接返回到MSF终端提示符，等
待下一步的指令。
Metasploit提供一系列的命令让我们能与数据库进行交互，对这些命令的介绍和使用会贯穿
本书的各个章节。如果需要一个完整的数据库命令列表，可以在MSF终端中输入help来查看。
现在，我们使用db_status命令来确认数据连接是正确的。
20
---
## Page 48
第3章情报搜集
msf>db_status
[*] postgresql connected to msfbook
看起来一切正常。
1.将Nmap输出的结果导入Metasploit
当你与其他组员一起协同进行渗透测试工作时，不同的人可能在不同的时间和地点进行扫
描，应当了解如何将每个人独立运行的nmap 扫描结果导入到Metasploit 框架中。下面我们看一
看如何将一个nmap生成的基本XML报告文件（通过nmap的-oX选项生成）导入到Metasploit中。
首先，我们对这台Windows虚拟机使用-oX选项进行扫描，生成一个名为Subnetl.xml的
文件：
t/01.891z61 14auqn9 xo-v-Ss-ud- deu
XML文件生成后，我们使用db_import命令将文件导入到数据库中。操作完毕后，可以使
用db_hosts命令核实导入的结果，db_hosts 命令将显示数据库中所有已保存的主机信息，如下
所示：
msf>db_connectpostgres:toor@127.0.0.1/msf3
msf > db_import Subnet1.xml
msf>db_hosts -C address
Hosts
address
192.168.1.1
192.168.1.10
192.168.1.101
192.168.1.102
192.168.1.109
192.168.1.116
192.168.1.142
192.168.1.152
192.168.1.154
192.168.1.171
192.168.1.155
192.168.1.174
192.168.1.180
192.168.1.181
192.168.1.2
192.168.1.99
msf >
21
---
## Page 49
Metasploit渗透测试指南
当我们执行db_hosts命令后，返回了一个主机的IP地址列表，这证明我们已经成功地将
nmap输出导入到了Metasploit中。
2.高级Nmap扫描技巧：TCP空闲扫描
一种更加高级的nmap扫描方式是TCP空闲扫描，这种扫描能让我们冒充网络上另一台主
机的IP地址，对目标进行更为隐秘的扫描。进行这种扫描之前，我们需要在网络上定位一台使
用递增IP顿标识（IPID：用于跟踪IP包的次序的一种技术）机制的空闲主机（空闲是指该主
机在一段特定时间内不向网络发送数据包）。当我们发现这样一台主机后，它的IP帧标识是可
以被预测的，利用这一特性可以计算出它下一个IP顿的标识。当我们冒充这台空闲主机的IP
地址对目标主机的某个端口进行探测后，如果该空闲主机实际的IP帧标识与预测得出的IP帧
标识发生断档，那么意味着该端口可能是开放的。（如果想了解更多关于此模块的以及IP帧标
识的信息，可以访问http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/。）
可以使用Metasploit框架的scanner/ip/ipidseq模块，来寻找能够满足TCP空闲扫描要求的
空闲主机，如下所示：
msf>useauxiliary/scanner/ip/ipidseq
msf auxiliary(ipidseq)> show options
Moduleoptions:
Name
CurrentSettingRequiredDescription
GWHOST
no
The gateway IP address
INTERFACE
no
The name of the interface
LHOST
no
Thelocal IPaddress
RHOSTS
yes
The target address range or CIDR identifier
RPORT
08
yes
The target port
SNAPLEN
65535
yes
Thenumber ofbytes tocapture
?
THREADS
1
yes
The number of concurrent threads
TIMEOUT
500
yes
The reply read timeout in milliseconds
这个列表显示了执行ipidseq扫描所需的所有参数。重点对RHOST参数·进行说明，此参
数可以使用IP地址段（如192.168.1.20-192.168.1.30）、CIDR（无类型域间选路）地址块（如
192.168.1.0/24）、使用逗号分隔的多个CIDR地址块（如192.168.1.0/24，192.168.3.0/24），以
及每行包含一个IP地址的IP列表文本文件（如file:/tmp/hostlist.txt）。这些选项让我们在设定
扫描目标时具有很大的灵活性。
在THREAD参数?中设定扫描的线程数。所有的扫描模块默认线程数为1。增加参数值可
以提高扫描速度，降低参数值可以减少网络上的数据流量。一般来说，在Windows平台上运行
Metasploit，线程数最好不要超过16，在类UNIX平台运行不要超过128。
22
---
## Page 50
第3章情报搜集
现在我们设定好参数值并执行扫描模块。我们将RHOST参数设置为192.168.1.0/24，将线
程数设置为50，然后运行扫描。
msf auxiliary(ipidseq) > set RH0STS 192.168.1.0/24
RHOSTS => 192.168.1.0/24
msf auxiliary(ipidseq)> set THREADS 50
THREADS=>50
msf auxiliary(ipidseq)>run
[*]192.168.1.1's IPID sequence class: All zeros
[*]192.168.1.10'sIPID sequence class:Incremental!
[*]Scanned 030 of 256 hosts(011% complete)
[*] 192.168.1.116's IPID sequence class: All zeros
0 [*] 192.168.1.109's IPID sequence class: Incremental!
[*]Scanned 128 of 256 hosts (050% complete)
[*] 192.168.1.154's IPID sequence class: Incremental!
[*] 192.168.1.155's IPID sequence class: Incremental!