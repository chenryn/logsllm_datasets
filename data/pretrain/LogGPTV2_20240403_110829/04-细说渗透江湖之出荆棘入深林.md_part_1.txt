2020/7/27 细说渗透江湖之出荆棘⼊深林
细说渗透江湖之出荆棘⼊深林
原创 队员编号004 酒仙桥六号部队 5⽉9⽇
这是 酒仙桥六号部队 的第 4 篇⽂章。
全⽂共计4133个字，预计阅读时⻓12分钟。
前⾔
⼤家好，我是⼀名正义的使者，常常在⿊夜来临的时候，徜徉在⽹络的海洋中，突破层
层防御抵近核⼼区域，在“游戏规则”的限定内为了达到我的⽬的，我不断突破⾃⼰。不
知道这样过了多少个⿊夜。
当我第⼀次看⻅⽬标应⽤的时候，感觉它就跟以往测试的⽬标⼀样没什么区别。但是，
这个起初看起来像是单个的SQL注⼊漏洞的⽹站，让我头发都多掉了好⼏根，北京的冬
天太冷，我的脑袋有点凉。
今天像往常⼀样，我对⽬标发起了攻击，以为是⼀次很普通的提权之路，没想到却是⼀
次曲折的历程。
思路开始的地⽅，才是漏洞利⽤的关键过程。具体利⽤图⽚细节我们会打码放出，重点
分析此次实战精华思路。
整个架构⼤概是这样的：
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 1/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
SQL inject
起源是⼀个接⼝注⼊，数据库环境是mysql，服务器系统是windows，正常来说的话这
种注⼊通过sqlmap去跑就⾏了，sqlmap会⾃动创建dll⽂件，通过os-shell返回⼀个
交互式的shell回来⼀切顺利。
经历过腥⻛⾎⾬的我对这么轻松就拿到shell的环境已经没什么成就感了，我⾯对着⿊⾊
界⾯返回来的os-shell界⾯习惯性的敲了⼀个“whoami”。
Ok，⼀切尽在掌握，当我尝试执⾏其它命令的时候，⼼中就有⼀万匹⻢奔腾⽽过了。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 2/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
⼀开始怀疑是sqlmap写⼊的dll⽂件有问题，遂想尝试通过sqlmap的os-pwn看能否直
接弹回来⼀个msf的shell。
执⾏：
⼀切都那么和谐。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 3/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
失败！
执⾏sql-shell也没法执⾏交互式的sql语句，接下来就通过burp去⼿⼯调⽤了⼀下
sqlmap传上去的dll⽂件中的“sys_eval”函数。
Request：
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 4/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
Response：
也是存在同样的问题只能执⾏whoami的命令，其它命令都是返回有问题的。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 5/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
到这⾥，起码说明了我们的权限还是⽐较⾼的，“nt system”权限，之前尝试过通过
empire⽣成⼀个powershell直接反弹shell回来，这⾥也是不⾏的，⽽且“sys_eval”
函数内存在⼀些特殊字符也是不⾏的。
从现在我们了解到的讯息来看⽆法确定是什么原因造成的，于是产⽣了两个假设：
1、 命令没有传递过去也就没有执⾏。
2、 该服务器所在环境不通外⽹。
我们先去测试第⼆种假设，如果是第⼆种假设的话服务器去ping外⽹是不通的，我们尝
试去ping⼀下dnslog，看是否有接收。
执⾏之后⼀直没有接收到数据，于是我们⼀切的推断回归到了第⼀种假设上⾯去。第⼀
种假设命令没有传递过去，当然了还有⼀种情况是数据执⾏成功了数据没有返回回来，
当尝试了dnslog没有回显之后还不能完全判断该服务器不能通公⽹，因为还存在第⼀种
假设的情况。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 6/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
此时已经夜已经深了，我看着窗外点起了⼀根烦恼丝，脑海中回想着各种可能性，对了
我还喜欢柯南，喜欢整理线索从⽽去突破⼀道道屏障，同时我也不是⼀个轻⾔放弃的
⼈，此时我做了⼀个决定。。。睡觉。。。
醒来已是第⼆天中午，在梦中仿佛某个绝世⾼⼈传授了我⼀招⼼法，我迫不及待打开电
脑去尝试，当burp回显出结果的时候，我脑海中闪过⼀句名⾔“多读书，多看报，少吃
零⻝，多睡觉”，前辈的积累还是有⼀定道理的，这让我瞬间发觉多睡觉还是有好处
的。。。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 7/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
Request：
Response：
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 8/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
通过powershell做base64加密，传递到服务器之后执⾏，返回的结果也是base64加
密的：
1 Powershell "string="ipconfig";[convert]::ToBase64String([Text.Encoding]::
接下来就是⼀段⾮常枯燥的找⽬录了，由于⼿⼯注⼊的诸多不⽅便，只能通过⼀层⼀层
查⽬录获得我们想要的绝对路径（也可通过写脚本去跑，但是我在⼤脑中带⼊了⼿⼯翻
⽬录和写脚本跑的时间参数之后，得出来的结果是还是乖乖翻⽬录吧）。
此处说明⼀下，这个站开放了好⼏个端⼝，⽽且我们现在也能够顺利地执⾏命令了，就
可以知道这个站的⼤致架构了。虽然⽬标公⽹ip开放了很多端⼝，但是这些站都是部署
在不同的内⽹服务器上的，通过映射去映射到公⽹ip的，也就是说这个内⽹是不通外⽹
的，只能先传⼀个webshell上去看⼀下情况然后再做http代理。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 9/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
SSRF 另辟捷径
此刻，我⼜暗暗翻了⼀下我那本积满灰尘的武林秘籍，它总能在我迷茫的时候给我指明
⽅向，虽然我久经沙场，深谙这个世界的诸多烦恼和不公，但是每当我拿起我那本秘
籍，它总能让我看到光明。
我想很多朋友可能好奇我那本武林秘籍⻓什么样，为了满⾜⼤家的好奇⼼，这⾥分享给
⼤家，它⻓这样。。。
这个时候⼜遇到了⼀个坑，当我尝试写webshell的时候遇到问题了。⽤ps进⾏转义的
命令写进去之后也是以base64加密的⽅式进⾏了存储，⽽且当前⽹站写webshell的时
候 去 访 问 存 在 了 问 题 ， 我 猜 测 就 算 webshell 正 常 写 ⼊ 我 也 ⽆ 法 正 常 访 问 这 个
webshell。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 10/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
我得想办法解决这个问题，思考了⼀下逻辑之后我想到了前期挖到的SSRF，在脑海中思
索 了 ⼀ 会 我 能 否 先 通 过 这 个 SSRF 去 探 测 ⼀ 下 内 ⽹ ⾥ ⾯ 的 东 ⻄ 。 也 为 我 去 想 办 法 传
webshell 留 有 ⼀ 部 分 时 间 ， 同 时 我 ⼜ 能 提 早 知 道 ⼀ 些 内 ⽹ 的 情 况 ， 毕 竟 就 算 拿 到
webshell也得去尝试做http隧道，这种情况⽇志数据是很⼤的。
SSRF挖掘利⽤，通常⼤致步骤：
1、寻找WEB应⽤功能、抓包分析链接请求敏感参数
2、是否有过滤，是否进⾏绕过尝试
3、验证是否可回显（是否能能够探测内⽹）
4、判断⽀持协议，是否能获取更多信息