# 【技术分享】NSA武器库：CVE-2017-9073 EsteemAudit分析
|
##### 译文声明
本文是翻译文章，文章来源：paloaltonetworks.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
****
**  
**
翻译：[ **WeaponX**](http://bobao.360.cn/member/contribute?uid=2803578480)
预估稿费：200RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**  
**
**背景**
四月份，一个名为“影子经纪人”的组织发布了一部分他们从NSA窃取的漏洞利用工具，主要是针对windows操作系统。其中最著名就是被勒索软件WanaCryp0t利用的exploit"EternalBlue"。另一个被放出利用工具针对的CVE-2017-9073叫做"EsteemAudit"，是一个Windows
2003和Windows XP上RDP(Remote Desktop
Protocol，远程桌面协议)的利用工具。"EsteemAudit"利用的漏洞影响的操作系统微软均已不再支持(2014年结束对XP的支持，2015年结束对2003的支持)，所以微软官方并没有发布这个漏洞的补丁。
**EsteemAudit 总览**
RDP远程利用工具名为"EsteemAudit"。使用inter-chunk heap
overflow方法。Windows智能卡模块的gpkcsp.dll分配的名为key_set，大小为0x24a8的数据结构。在key_set中有一个名为key_data的数据结构大小0x80，这个内存空间用来存放智能卡相关信息。在相邻的内存空间中中存储着两个key_object指针。然而，在gpkcsp!MyCPAcquireContext中调用了内存拷贝函数memcpy，在没有进行边界检查的情况下拷贝了一块用户可完全控制的数据到key_data中，如果攻击者控制的这块内存大于0x80，则相邻内存的指针key_object将会被用户的恶意数据覆盖。EsteemAudit中的代码通过部署一块0xb2-7大小的内存，利用代码中的memcpy拷贝恶意数据到key_data中，随后key_object会被覆盖为0x080190dc这个地址。这个地址正好在gpkcsp.dll的数据段中，随后EsteemAudit会在这个地址部署恶意数据。exploit会将用户控制的数据放到全局变量中去，地址是0x080190d8，随后函数gpkcsp!ReleaseProvider会释放C++对象call
[vatble+8]，这时就控制了EIP。最终，通过使用SharedUserData技术使用syscall调用syscall
id为0x8f的函数VirtualProtect修改shellcode内存的执行权限，然后调用shellcode第一阶段就完成了。
**介绍**
RDP远程代码执行漏洞很多，不过幸运的是在NT4/Win98后没有任何利用代码被公开发布。然而在2017年4月，影子经纪人公布出的从NSA窃取工具包含了Windows
XP和Windows
2003操作系统上RDP远程代码执行漏洞的利用工具EsteemAudit。在本文中，我们将首先介绍RDP协议的内部机制，随后分析EsteemAudit.exe本身。接着，我们会分析RDP协议在用户态和内核态是如何工作的、inter-chunk heap overflow是如何发生的、如何利用inter-chunk heap
overflow在有漏洞的操作系统上来执行shellcode。最终我们会介绍在没有patch的情况下如何防御这个漏洞。
**架构和组件**
[终端服务架构](https://technet.microsoft.com/en-us/library/cc755399.aspx)主要分为四部分：
**multi-user kernel**
**Remote Desktop client**
**Terminal Services Licensing service**
**Session Directory Services**
下表是终端服务的组件及说明
Nicolas Collignon在论文中[Tunneling TCP over
RDP](http://www.hsc.fr/ressources/presentations/ossir_rdp/rdp2tcp.pdf)描述了各个组件之间的联系。
在内核态，相关的组件在rdpwd.sys中，负责MCS(Multipoint Communication Service)协议栈。RDP
PDU(Protocol Data Unit，协议数据单元)在此模块被解密并解析。
在用户态，winlogon组件负责客户端的认证。例如，如果一个客户端请求智能卡认证，winlogon.exe会运行智能卡模块与客户端交互。
**RDP 协议**
通过对远程桌面服务的简要介绍，我们可以深入了解RDP协议中的被EsteemAudit利用的含有漏洞的模块。在MSDN中有一些RDP的说明文档。[[MS-RDPBCGR]: Remote Desktop Protocol: Basic
Connectivity and Graphics Remoting](https://msdn.microsoft.com/en-us/library/cc240445.aspx)介绍了RDP协议的基本情况，[[MS-RDPESC]: Remote Desktop Protocol:
Smart Card Virtual Channel Extension](https://msdn.microsoft.com/en-us/library/cc242596.aspx)介绍了RDP协议的一些扩展模块。还有一些文档针对指定的扩展模块进行的描述，例如[[MS-RDPESC]:
Remote Desktop Protocol: Smart Card Virtual Channel
Extension](https://msdn.microsoft.com/en-us/library/cc242596.aspx)。在OSSIR
2010中，Aurélien Bordes在他的议题中列出了所有RDP的扩展模块。
为了深入分析，我们阅读了如下文档：
[[MS-RDPBCGR] – Remote Desktop Protocol: Basic Connectivity and Graphics
Remoting](https://msdn.microsoft.com/en-us/library/cc240445.aspx)
[[MS-RDPESC] – Remote Desktop Protocol: Smart Card Virtual Channel
Extension](https://msdn.microsoft.com/en-us/library/cc242596.aspx)
[[MS-RDPEFS] – Remote Desktop Protocol: File System Virtual Channel
Extension](https://msdn.microsoft.com/en-us/library/cc241305.aspx)
[[MS-RPCE] – Remote Procedure Call Protocol
Extensions.](https://msdn.microsoft.com/en-us/library/cc243560.aspx)
MS-RDPBCGR基于ITU(International Telecommunication
Union，国际电信联盟)的[T.120](https://www.itu.int/rec/T-REC-T.120-200701-I/en)系列协议。T.120包含很多其他的标准，例如使用X.224标准用来阐述传输层协议如何交互。[X.224](https://www.itu.int/rec/T-REC-X.224/en)标准阐述了我们看到的request
PDU和Confirm PDU需要使用何种加密方法进行RDP数据包加密。
在下放的示例中，X.224请求中的encryptionMethods标志位被设置成了0x00000012，代表客户端请求使用128-bit的RC4进行加密[128BIT_ENCRYPTION_FLAG
0x00000002]
服务端在X.224 confirm PDU中设置encryptionMethod标志位0x00000002(128-bit RC4)确认使用128-bit
RC4加密。
本文不再阐述RDP连接过程接下来的步骤，详细文档可在[[MS-RDPBCGR] – Remote Desktop Protocol: Basic
Connectivity and Graphics Remoting](https://msdn.microsoft.com/en-us/library/cc240445.aspx)进行查阅。
RDP连接建立完成后，客户端和服务器段的PDU会使用协商的加密算法进行加密。下图是被加密的PDU实例
PDU中的数据如下
    64 00 04 03 eb 70 81 56 -> PER encoded (ALIGNED variant of BASIC-PER) SendDataRequest
    initiator = 1005 (0x03ed)
    channelId = 1003 (0x03eb)
    dataPriority = high
    segmentation = begin | end
    userData length = 0x156 = 342 bytes
    48 00 -> TS_SECURITY_HEADER::flags = 0x0048 0x0048 (SEC_INFO_PKT | SEC_ENCRYPT
    00 00 -> TS_SECURITY_HEADER::flagsHi – ignored as flags field does not contain SEC_FLAGSHI_VALID (0x8000)
    6f 6d 0c d5 b7 0c 5d 7e -> TS_SECURITY_HEADER1::dataSignature
以86 b8 8a a9开始，从偏移为0x51后剩余的数据TS_INFO_PACKET被加密
    len
    0178d254  0000014a   
                              J…
    encrypted
    038e3c8b  a98ab886 dabad90d d9d8f9e3 8dd5bafa  …………….
    038e3c9b  1407ea51 883cb6af 21ca2bdb cab1e030  Q…..<..+.!0…
    038e3cab  d6aaeccd 1c599171 1be8c40d 96d651dc  ….q.Y……Q..
    038e3cbb  2d018a22 242aac0d 7b58948f 4be28b23  “..-..*$..X{#..K
    038e3ccb  36cf54c6 52b70939 4064362b 9e37e989  .T.69..R+6d@..7.
    038e3cdb  9ff09b06 4f862c80 1546198a ac9b03ed  …..,.O..F…..
    038e3ceb  420acbdf 566591c1 7f471159 0e1d6906  …B..eVY.G..i..
    038e3cfb  906474f4 476ea91e 4db2edd2 fb464bfd  .td…nG…M.KF.
    plain
    038e3c8b  00000000 00000133 001a0000 00000000  ….3………..
    038e3c9b  00000000 00640061 0069006d 0069006e  ….a.d.m.i.n.i.
    038e3cab  00740073 00610072 006f0074 00000072  s.t.r.a.t.o.r…
    038e3cbb  00000000 00020000 0031001c 00320039  ……….1.9.2.
    038e3ccb  0031002e 00380036 0032002e 00320034  ..1.6.8…2.4.2.
    038e3cdb  0031002e 003c0000 003a0043 0057005c  ..1…<.C.:..W.
    038e3ceb  004e0049 0054004e 0053005c 00730079  I.N.N.T..S.y.s.
    038e3cfb  00650074 0033006d 005c0032 0073006d  t.e.m.3.2..m.s.
我们可以通过文档[MS-RDPBCGR]查阅协议的细节来查看TS_INFO_PACKET。
**智能卡扩展**
RDP协议支持客户端使用智能卡模式登录，根据文档[MS-RDPESC]交互的流程如下
EsteemAudit使用SCARD_IOCTL_TRANSMIT与服务器端的智能卡模块进行交互。
文档描述了服务器端响应客户端的数据包的各种类型，其中包含了Transmit_Return类型
服务器端
**RDP 利用工具 (EsteemAudit.exe)**
了解RDP的基础知识后，我们看看EsteemAudit具体看了什么。EsteemAudit.exe类似于RDP客户端，完成了和服务器端的RDP协议交互。EsteemAudit使用了RDP协议中的智能卡扩展，向服务器端发送智能卡认证请求。随后RDP服务端会使用智能卡模块gpkcsp.dll处理收到的数据，漏洞在此出现。
**EsteemAudit.exe 总览**
通过逆向EsteemAudit二进制文件，在地址.text:00381009我们找到了名为GoRunExp的函数
    GoRunExp
    à InitializeInputParameters // 获取配置信息
    à connect2Target
    ààinitRDPLib
    ààemulateSmartCard