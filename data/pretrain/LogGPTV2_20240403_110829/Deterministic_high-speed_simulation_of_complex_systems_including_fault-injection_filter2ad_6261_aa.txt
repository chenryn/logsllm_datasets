title:Deterministic high-speed simulation of complex systems including fault-injection
author:Matthias Sand and
Stefan Potyra and
Volkmar Sieh
978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
211
DeterministicHigh-SpeedSimulationofComplexSystemsIncludingFault-InjectionMatthiasSand,StefanPotyra,VolkmarSiehFriedrich-Alexander-Universit¨atErlangen-N¨urnbergDepartmentInformatik3(ComputerArchitecture)Martensstr.3,91058Erlangen,Germany{Matthias.Sand,Stefan.Potyra,Volkmar.Sieh}@informatik.uni-erlangen.deAbstractFAUmachineisavirtualmachineforthehighlydetailedsimulationofstandardPChardwaretogetherwithanenvi-ronment.FAUmachinecomeswithfaultinjectioncapabil-itiesandanautomaticexperimentcontrollerfacility.Duetoitsuseofjust-in-timecompilertechniques,itoffersgoodperformance.Thistooldescriptionintroducesthenewfea-tureofFAUmachinetosimulatesystemsdeterministically.Thiswillenabledeveloperstodesignandtestcomplexsys-temsforfaulttolerancebyrunningidenticallyreproducibleautomatedtestsinreasonabletimeandthusevenallowtest-ingforrealtimeconstraints.1.IntroductionTodevelopfaulttolerantsystemsorevaluatethedepend-abilitypropertiesofcomplexsystemsitisacommonprac-ticetousefaultinjectionexperiments.Tobefeasibleandyieldsigniﬁcantresults,theexperimentsshouldbeautomat-able,i.e.theusershouldhavethepossibilitytodeﬁneatestbench,whichisasetofpre-deﬁnedstimuliandresponsesthatarefedtoandawaitedfromthesystemundertest,re-spectively.Beyondthat,itismostdesirabletohavetheop-portunityofrunningexperimentsdeterministically,whichmeansthateachruncanberepeatedforanarbitrarynumberoftimes,withthesystemundertestexperiencingexactlythesameconditionsastothetemporalﬂowofevents.ThistoolpresentationdescribesthenewdeterministicsimulationfeatureofFAUmachine,avirtualmachinepro-vidingautomatedfaultinjectionexperimentsforcomplex,standard-PChardware.Therestofthepaperisstructuredasfollows.Section2givesashortoverviewofdifferentrelatedvirtualizationandsimulationapproachesandtheirlimitationswithrespecttodeterministichigh-speedruns.Italsopresentsthegeneralideaofourapproach.Section3describesthecommonfea-turesofourtoolFAUmachinewhichalreadyhaveexistedforalongerperiodoftime,includingfaultinjection,inter-activesimulationandautomatedtesting.AdescriptionofthenewdeterministicsimulationprovidedbyFAUmachinecanbefoundinsection4.Section5presentsexampleexper-imentsetupstodemonstratethedifferencesbetweendeter-ministicandnon-deterministicsimulation.Section6con-cludesthepaper,andtheﬁnalsectiongivesanoutlookonfurtherextensionsandimprovementstoFAUmachinewhichareplannedorcurrentlyinprogress.2.RelatedapproachesandgeneralideaWhenintendingtorunautomatedfault-injectionexperi-mentsinwhichcomplexsystemsaresimulatedinawaythatallowsidenticalreproductionoftheirruns,weﬁrsthavetoconsiderthedifferentapproachesfromtheareasofvirtual-izationandsimulationwhichhavebeenproposedsofar.Ontheonehand,thereexistseveralsolutionsforhighperformance(para-)virtualization,likeVMware[23],Vir-tualBox[11],Xen[1],etc.,andemulators,likeQEMU[3]andBochs[20].BothgroupsofapproachesprovidevirtualmachinesrepresentingcompletePC-systemsornetworks.Theycanruncomplexsystems,calledguests,ontopofrealsystems,calledhosts,andusuallyofferreasonableperfor-mance,whichisclosetotheperformanceofthecorrespond-ingrealhardware.Asafurtheradvantage,mostsoftwareofthiskindisquiteeasytouse.Buttherearealsosomedisadvantageswhichmakecurrentvirtualmachinesinap-propriateforourpurpose:First,thereisnopossibilitytorunautomated,predeﬁnedexperimentsunattendetly.Next,thereisnofacilitytoallowtheinjectionoffaultsintothesimulatedhardware.Finally–andmostimportantly–runscannotberepeatedidentically,i.e.thevirtualmachinesarenon-deterministicbydesign.Ontheotherhand,alargevarietyofapproachesus-978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
212
ingdetailed,deterministicsimulationisproposed,bothonHDL-level,usingModelSim[15,8],forexample,andforspeciﬁcpurposesoraspects,likenetworkinteraction[21,24,2,13],memoryhierarchies[16,12,5],andmanymore,whichmostofthetimeuseproprietarydescriptionlanguages.Theygenerallyofferthepossibilitytodeﬁnesetsofstimuli,i.e.testbenches,toexaminethesystemun-dertestinanautomaticway.Usually,theseapproachesaredeterministicbydesign,identicallyrepeatablerunsarepos-siblethen.Asagreatdisadvantage,setupsforHDL-levelandproprietarysimulationsolutionsareoftendifﬁcultandtedioustowritedown.Apartfromthat,mostoftheseap-proachesareonlysuited–orhaveatleastonlybeentestedsofar–,foralimitedrangeofsub-systemsoraspects.Butthebiggestproblemcertainlyisthepoorperformanceofthesimulators,whichareofteninterpreters.Theirspeedisusu-allyfarfrombeingsufﬁcienttosimulatecompletePCsorevennetworksofcomputersinreasonabletime.Allthatledustotheideatocombinethehigh-speed,just-in-timecompilerbasedemulationprovidedbyourvir-tualmachineFAUmachine,whichalreadycontainsanau-tomaticexperimentcontrollerandfaultinjectionfacilities,withdeterministicsimulationabilities.3.FAUmachineFAUmachine[7]isanopensourcevirtualmachineforstandardPChardware.AvarietyofdifferentoperatingsystemscanberunonFAUmachinewithoutbeingmodi-ﬁed,includingWindows,Linux,Dos,Free-andOpenBSD.CurrentlysupportedhostoperatingsystemsincludeseveralLinuxdistributionsandOpenBSD;aporttoMacOSXisworkingbutnotofﬁciallysupported.FAUmachinecansimulatestandardIntelCPUsandIDEcontrollers,NE2000-andInteleepro100networkinterfaceadaptersbutalsoperipheriphalssuchasnetworkinghubs,serialterminals,ormodems.OneofthedifferencestoothervirtualmachineslikeQEMU,VirtualBox,BochsorVMwareis,thatFAUma-chinecanbeconﬁguredonaveryﬁnegranularlevel.Suchdetailsinclude,towhatmemorybankamemorymoduleisconnectedto,orwhichPCI-slotaPCI-cardisinsertedinto.AnotherdifferencetobothQEMUandVMWareisthedesigngoalofFAUmachine.Whiletheaforementionedvir-tualmachinesaimatexecutingthesimulatedsystemasfastaspossible–whichisoftenachievedbydivergingfromtheexactbehaviorofrealhardwareinthecaseofneed–FAU-machinetriestoachieveasimulationascloseaspossibletorealhardware.Additionally,FAUmachinecannotonlysim-ulateaPC,butalsotheenvironment,likepowerswitches,monitor,thepowersupplyandeventheinteractionoftheuser(cf.section3.3).Inordertoneverthelessachieveahighperformancesim-ulation,FAUmachineusesthetechniquesofajust-in-timecompiler[9]totransformastreamofmachinecodeinstruc-tionsoftheworkloadintoasequenceofmachinecodein-structionsthatcanberunnativelyonthehostsystem.Ifaperipheralisaccessed,aninstructiontocallthecorrespond-ingsimulationprocedureisinserted.Usingthistechnique,theoverallperformanceofFAUmachineisabout5-20%asgoodastheperformanceofthecorrespondingrealsystem.3.1.FaultinjectioncapabilitiesofFAUma-chineCurrently,faultinjectioninsideFAUmachineisimple-mentedinsidethesimulatorsfordifferentcomponents[10].Thisapproachhastheadvantage,thatdifferentcomponentscanprovidespecializedfaulttypes.Forexamplethesim-ulatorofthenetworkcardmakesitpossibletospecifyapercentileamountofpackageloss.Tothevirtualdisksim-ulator,bothpersistentandtransientblockfaultscangetin-jected.Othercurrentlysupportedfaultinjectionmecha-nismsincludeintermittentandpersistentbit-ﬂipsforboththesimulatedCPUandmemorymodules(q.v.section5).ThecorrespondingC-Codeofthesimulatedhardwaretriestoreﬂectrealhardware.Thatmakesitpossibletoaddnewfaultinjectioncapabilities,whichreﬂectfaultybehav-iorofrealhardwarewithouthavingtorewritelargepartsofFAUmachine.3.2.InteractivesimulationFAUmachineoffersacompletegraphicaluserinterfaceforinteractivesimulation.Itallowsmanydifferentkindsofinteractionbetweenuserandguestsystemaswellasguestsystemandhostenvironment,includingdisplayofthesim-ulatedmonitor,networkbridgingandroutingtotherealnetworkthehostisconnectedto,audioplaybackviathehost’saudiosubsystem,forwardingofkeyboardandmouseevents,GUI-elementsforpowerandresetswitchesandbut-tons.Furthermore,elementsareprovidedtoinsertandre-movestoragemedia,likeCD-ROMs,DVDs,andﬂoppies.Inaddition,FAUmachinecomeswithaGUI-interfaceforitsfaultinjectionfacilities.Itcanbeusedtodeﬁne,enableanddisablehardwarefaultsinteractivelyduringruntime.Apartfromthat,FAUmachinealsoimplementsanalgo-rithmtosynchronizetherealtimeofthehostwiththesim-ulatedrealtime.Ittriestokeepthedifferenttime-sourcesofthesimulatedsystem(including,amongothers,therealtimeclock,timerinterrupts,andthetimestampcounter)consistent,andthusprovidesplausiblevaluestotheguestoperatingsystemandapplicationsrunningontopofit.Itisquiteobviousthatuser-interactionandthesynchro-nizationofsimulatedrealtimeandhosttimewillresultin978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE