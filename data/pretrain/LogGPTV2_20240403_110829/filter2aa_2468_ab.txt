保护芯片
使用编程器
使用专用读写座
直接焊接到SD卡上
直接在存储芯片上飞
线，连接到SD读卡
器
在线读写
某款车机系统在线读写
准备工作-Getshell
目的：
• Getshell后直接tar导出文件系统（固件），分析bin、web脚本
• 更方便的查看数据，例如查看端口、进程、网络、文件
• 搭建测试环境，编译好的测试工具
• 方便的在线调试（有时lib库、硬件限制，QEMU很难离线run起来）
总之，能getshell就是最理想的破解前提环境
• 如果通过远程getshell了，其实已经完成了破解
准备工作-Getshell
方法：
扫描端口，寻找是否开启telnet、ssh、adb服务等
• 使用快速扫描，masscan、nmap -sS
• 密码&hash可以在固件里找，离线破解（如何加速破解？）
lsusb，查看是否开启usb adb
寻找web上传漏洞、命令注入漏洞等
在线or离线修改存储
• 例如init启动项中添加：busybox telnetd -l /bin/sh &
• 对于采用EMMC存储结构，修改非常方便
寻找板上TTL针脚
• 明显标注
• 根据CPU datasheet
使用hashcat破解ssh、telnet密码
使用nmap进行快速扫描
使用masscan进行快速扫描
准备工作-Getshell
方法：
修改Bootloader启动参数
• 强制进入uboot配置模式，修改内核参数 例如添加 1 ,进入单用户模式
• 使用JTAG接口修改内核参数
准备工作-Getshell
方法：
使用JTAG修改内核参数 获取shell
• 设备需要具有JTAG口，并且有对应JTAG设备、CPU配置文件
• 软件推荐OpenOCD，支持CPU种类多 硬件推荐jlink
• 修改启动参数
• 固件中寻找启动参数位置
• 添加断点
• 修改启动参数，例如添加 1 ,进入单用户模式
• 引导内核，console 串口获取shell
准备工作-获取通信数据
目的：
• 了解工作逻辑（辅助分析，例如根据http请求寻找加密代码）
• 获取cookie、token等认证信息，敏感隐私数据
• 获取服务器接口，以便渗透服务器（授权渗透）
• 截获修改数据包，或根据已知数据包构造重放
• 最终下发合法指令、构造poc、拿到关键key等
通常使用Wifi/234G/蓝牙/低功耗蓝牙/红外/有线/其他频段无线电
准备工作-获取通信数据
方法：针对IP数据（TCP、UDP、HTTP、MQTT等）
Wifi：
• 实时wireshark：
• 开启无线热点并连接，wireshark直接监听这块网卡
• Android adb forward + tcpdump + 管道 给 PC机wireshark
• 在路由设备上抓包
• 如果是Android APP，直接在本机模拟器运行，监听本网卡
• 如果是HTTP、HTTPS，设置代理，
• 交叉编译tcpdump（arm、mips），-A选项or –w
• 如果远端设备，arp中间人
• 如果远端设备，且动作小：wifi实时解密（强大网卡支持，例如RTL8812U）
设置wpa/wpa2实时解密
如果通讯数据全是密文
SSL/TLS 加密信道
• https代理
• 如果验证证书，导入burp根证书
• Android中：
• Xposed bypass 强制不验证证书
• Hook大法（okhttp）
AES\DES等对称加密，采用TCP传输
• 逆向分析APP、二进制，获取秘钥
• Android中：Hook大法（Crypto)
对常用的http操作库okhttp进行hook
对java自带的加解密库crypto进行hook
关于hook（针对Android）
框架
• Xposed：
• 仅支持java层面hook
• 适合批量部署 安装
• CydiaSubstrate：
• 支持java/native
• 不开源，且不更新无法适配新Android系统
• Frida：
• 适合破解使用
• 支持java/native，支持多平台，适配最新系统
工具
集成了http、加解密、sql查询、文件操作、IPC、
自定义hook的功能
• 基于Xposed：
• Inspeckage
• https://github.com/ac-pm/Inspeckage
• 基于Frida：
• appmon
• https://github.com/dpnishant/appmon
Hook什么？
敏感操作hook
• 对称加密key、明文密文
• Sqlite查询（判断是否有注入、有助理解逻辑）
• http、https请求内容
• Hash调用情况
• 其他（webView、序列化、文件系统操作、SharedPreference、IPC等）
目标函数自定义hook
• 获取返回值
• 修改返回值
• 如何确定hook 的class、method（trace)
Subtitle (if needed)
使用Inspeckage Hook http请求
使用Inspeckage 自定义hook
Subtitle (if needed)
使用Inspeckage hook AES加密
获取通信数据-其他信道
234G：
• 需要远端通信的设备，例如自动售货、共享单车锁等等
• 开发人员通常认为这个信道十分安全，很少考虑加固
• 通过假基站GPRS劫持，可以完全控制与基站连接的网络流量
• 根据运营商网络互通问题，也可以进行远程访问触发漏洞
蓝牙：
• 现阶段主要以低功耗蓝牙为主，例如运动手环、智能温度计、蓝牙开锁等
• 开发人员通常认为这个信道十分安全，基本很少考虑加固，多存在密钥泄露
• 传统蓝牙分析只能跟踪广播包，山寨设备可以跟踪跳频
• 手机调试模式开启蓝牙log，简单稳定
针对234G设备的流量访问、嗅探、MITM
• 2G网络由于手机无法对基站进行认证，存在假基站风险
• 搭建GSM基站系统（合法条件下测试）
• 硬件：Bladerf（相对其他SDR设备，精度高）
• 软件：YateBTS（图形化界面/安装方便）
• 如何让智能设备自动连接到假基站
• 借鉴伪基站给手机发短信的思路：增大小区重选参数C1、C2
• 修改YateBTS源码实现
• 详细内容可以参考我将要再Defcon China上关于这方面的议题
• 攻击：获取流量、MITM、访问端口触发….
• 其他简单方法：
• 运营商网络互通（10 or 172网段），买两张sim卡，可以触发基
于端口的漏洞
第二步-分析
结合已有文件、网络请求、shell
• Netstat –tunlp 看监听端口对应进程，分析之
• 命令注入，例如fopen()中的内容可以控制
• 危险函数导致溢出，例如strcpy()
• 如果没有shell，就端口扫描，无状态扫描
• 如果有web
• 确定配置文件、web源文件
• 对web页面进行漏洞挖掘（php、cgi、lua脚本等）
• 根据网络访问定位关键代码位置（反编译、关键词、trace），获取加密逻辑，获取接口参数格式
最终获取到关键数据，或者下发指令
分析举例：某自动售货机 核心逻辑问题
Subtitle (if needed)
Bin文件中泄露FTP升级服务器密码
支付服务未验签导致0元支付
可以控制其他售货机任意更新固件
两款手表 信息泄露及配置修改
Subtitle (if needed)
云端登录过程泄露密钥
云端交互过程中MITM修改配置
某共享车锁 信息泄露及解密
Subtitle (if needed)
与云端加密传输
分析固件，获取密钥及升级协议
某通讯模块 FTP server协议存在命令注入
Subtitle (if needed)
一些必备技能、小tips
• 焊接技能
• 烙铁焊接，拆焊、拖焊、吸锡、洗板，不连焊&脱焊
• 热风枪拆焊焊接，植球植锡 （低温锡浆）
• 飞线
• 买正品白光烙铁，调温&8秒升温不老化
• APK反编译、hook、动态调试、Java代码阅读
• Web攻防，源码审计能力
• Python、Java编码能力
• 简单的二进制逆向分析
• Wireshark TCP、HTTP数据包分析
• 熟悉跨平台、交叉编译
一些必备技能、小tips
• 常用工具：
• 准备好多平台下的gdb、tcpdmp、telnetd、nmap、masscan….
• 好朋友 多平台下的busybox
• 常用命令：
• busybox netstat -tunlp
• busybox telnetd -l /bin/sh &
• tcpdump -i xxx not tcp port xxxx -A
• nmap -sS -PN -T5
Q&A