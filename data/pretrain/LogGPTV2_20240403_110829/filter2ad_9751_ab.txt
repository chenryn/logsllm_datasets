图5-6 写注册表实现自启动
此外，蠕虫在安装之前会测试C&C服务器是否有效，如果无效，便不会进行安装操作。
###### 5.1.3、获取上线信息
Loader将蠕虫成功安装后，便会上线通知C&C并且以此获取执行指令。该变种Dridex的C&C是内嵌在Loader文件中的加密数据中，每个样本大概有10-20个数量不等的C&C。解密后C&C数据格式如图5-7所示：
图5-7 内置的C&C信息
该列表每一项为8个字节的二进制数据，其中前4个字节为IP地址后4个字节为端口。比如在0x001B1278地址存储的是IP：0x6BAAB199转为点分十进制后得到IP地址为107.170.177.15。在0x001B127C地址存储的是端口信息，0x00001F90，转为十进制后为8080。
Dridex蠕虫病毒通过调用一个使用频率较低的Windows API（CreateTimerQueueTimer）来启动上线和扩展组件的下载。
图5-8 启动定时队列回调
通过该API来实现定时队列调用，每一秒钟启动回调函数执行。回调函数中使用一个全局控制标志来控制代码执行流程。
回调函数在经过一系列初始化工作之后，将系统中的进程列表、系统版本型号等信息加密发送给控制端完成上线操作，C&C服务器会根据上线信息来下发合适的扩展组件执行。
图5-9 获取系统信息
图5-10 进程列表
在我们分析期间，该样本自我更新速度非常快，而且更新的样本编译时间基本没有规律，可以看出Dridex新变种的C&C服务器后端是一个高度自动化的样本生成平台。
###### 5.1.4、上线协议分析
该样本的上线数据是通过POST方式提交给控制端服务器的。上线信息中携带了当前样本的运行模式、样本CRC值、感染机的硬件标识，进程列表信息等内容。
通信过程中，样本会将启动时随机生成的AES秘钥通过RSA加密后发送给C&C服务器，C&C服务器得到秘钥后通过自有私钥解密，获得通信秘钥。之后，样本的所有通信数据都通过该秘钥进行加密，其采用的加密算法为AES-128-CBC。内置的公钥数据如图5-11所示：
图5-11 内置公钥
通过对多个蠕虫样本的跟踪，我们发现这个公钥每隔2-5天会更换一次。
此外，样本通过ObtainUserAgentString函数获取Windows操作系统下的User-Agent，然后构造HTTP的POST请求发送给C&C服务器。比较有意思的是，请求成功后，服务器端会返回“伪404”响应来传输数据，猜测可能是为了绕过IDS检测或者迷惑运维人员。网络请求的数据包如图5-12所示：
图5-12 POST请求和应答
发送的数据结构内容的二进制代码如图5-13所示：
图5-13 构造数据包
接收的数据内容解密的二进制代码如图5-14所示：
图5-14 解密数据包
通过对通信数据加密、解密逻辑的分析发现，发送数据的前0x60字节存储的是被公钥加密的KEY，从0x61-0x74存储的是发送明文的SHA1，从0x75字节开始到结尾的数据是被AES加密的数据。服务器接收到请求数据后，首先会通过私钥解密前边的KEY，然后用这个KEY来解密0x74之后的密文，最后通过计算解密后的内容的SHA1来和0x61-0x74的HASH进行比较，来确认数据是否被篡改。当被蠕虫感染的主机接收服务器返回的内容时，会使用前面生成的KEY对0x75字节之后的数据进行解密，然后计算解密后的明文SHA1，最后通过公钥对该HASH进行签名认证。
根据前面分析的通信数据格式，我们可以看出，每条数据并没有携带时间戳，因此Dridex蠕虫病毒存在数据包重放漏洞。
###### 5.1.5、启动执行下载组件
Loader模块只是作为一个先导模块用于安装驻留，本身并没有实现相关的恶意操作，具体恶意操作均由从C&C端下载而来的扩展组件实现。在需要下载扩展组件执行时，Loader会从自带的一个C&C列表中顺序连接这些C&C下载相应的扩展组件执行。根据对Loader中的启动逻辑的分析，我们发现其有3种不同的组件执行方式：
（1）落地启动进程：这种方式下载的程序文件为exe可执行文件，下载的模块文件会写到磁盘中，可用于Dridex
Loader的自动升级和扩展组件的下载，实现代码如图5-15所示：
图5-15 落地文件
（2）内存加载DLL，这种方式主要用于下载扩展DLL组件，下载的模块文件不落地磁盘。样本通过自主实现的PE加载器直接将下载到内存中的PE格式数据加载执行，如内网感染模块、邮件传播模块、窃密模块等都是由此下载执行。部分代码如图5-16所示：
图5-16 线程启动DLL
（3）指定session执行下载模块，同样可用于自我更新和扩展组件执行，下载的模块文件会写入到磁盘上。由于该样本在Windwos
XP和没有开启UAC的机器上会通过服务启动，所以当有些功能模块（如登录凭证获取）加载时需要借助当前登录用户的身份。如果当前系统开启UAC,落地文件则以当前登录用户启动。功能代码如图5-17所示：
图5-17 根据不同环境创建进程
##### 5.2、内网感染模块分析
内网感染模块是Loader下载的用于局域网传播的模块，该模块是一个DLL文件，采用第二种方式加载执行。其主要功能就是扫描感染主机局域网并尝试弱口令爆破目标，如果成功则使用Loader程序感染局域网内其他主机。其中弱口令密码字典加密存储在该模块的数据区，通过对加密数据解密后统计其自身携带有共计999个密码项的密码字典。部分经过解密的弱口令密码内容如图5-18所示：
图5-18 部分弱口令
感染局域网过程如下：
调用WNetEnumResourceW，枚举系统所有连接的网络资源。
使用空口令调用WNetAddConnection2W，建立网络链接。
如果连接失败，则调用NetUserEnum枚举系统所有用户，然后使用上边内置的弱口令对网络资源进行连接。如果连接成功，则将当前的Loader文件拷贝到目标主机上并以服务的方式启动执行。局域网电脑的伪代码，如图5-19所示。
图5-19 感染局域网伪代码
##### 5.3、邮件传播模块
邮件传播模块要以群发带有恶意word、excel等文件附件的邮件来达到外网感染的目的，该模块延续了老版Dridex的感染模块，但不同的是新型变种采用了SSL加密STMPS协议进行邮件的传播感染，使得IDS，IPS等设备难以监测。邮件感染模块在进行邮件传播之前，会向C&C服务器(与Loader类似，以加密C&C列表方式内嵌在PE文件中)请求大量的邮箱账号和密码作为发送者，大量邮箱地址作为收件者（攻击目标）以及邮件内容模板作为感染邮件内容。而这些信息的请求都是通过RSA+AES的方式进行加密，通信协议类似Loader，但内置的公钥不同。公钥内容的内存dump如下：
图5-20 公钥数据
邮件感染模块在进行感染传播过程中会将一段固定格式的数据作为攻击结果和状态回馈给C&C服务器，这段数据同样也是加密传输，采用的通信方式是HTTP
POST方式。我们通过逆向还原了该结构如下：
    struct POSTMAILSERVER
    {
    int nFlag;          //常量0x5818DA3
    char *strSingleFlag;    // 机器名+C盘卷标识
    int nLenFlag;       // strSingleFlag的长度
    int nCountNum;      //邮件发送序号
    int nCountSend;     //邮件发送个数
    int nCountSuccess;  //邮件发送成功个数
    int nSuccessNum;    //邮件发送成功序号
    };
此外，模块在请求发件人账号密码、收件人邮箱地址、邮件内容模板时该结构初始化为0。
表5-2是其中用于请求数据和回馈数据的C&C。
 表5-2 用于请求数据和回馈数据的C&C
如果请求的POST数据合法，C&C服务器则会返回这三种类型的信息。
###### 5.3.1、获取发送邮件账户信息
邮件感染模块会向C&C服务请求大量的邮箱账户和密码信息。黑客通过Dridex将窃取到的大量邮箱账号登录凭证信息上传到C&C服务器中，并利用这些已窃取的邮箱登录凭证用于传播Dridex，新传播的Dridex又会将窃取到的邮箱登录凭证上传给C&C服务器，这样Dridex的感染路径就形成了一个自我传播的正反馈回路，大大增强了感染速度。在追踪分析过程中，我们发现了近千个邮箱的登录凭证，图5-21是分析过程中所dump出的部分邮箱登录凭证。
图5-21 部分邮箱登录凭证
###### 5.3.2、获取接收者邮箱信息
接收者邮箱同样也是由C&C指定，这些邮箱地址的用户名看起来比较像根据字典生成的，但是目前无法完全确认，也有可能是窃密模块收集的受害者的邮件联系人。部分受害者邮箱见表5-3。
表5-3 部分受害者邮箱列表
###### 5.3.3、获取邮件内容
Dridex的邮件内容是由C&C指定并由邮件传播模块下载并组装成邮件发送到受害者邮箱。这样黑客可以更加灵活的构造邮件内容，一方面可以在传播过程中调整邮件内容更好地欺骗受攻击者，另一方面还可以快速更换已经被列为垃圾邮件或者恶意邮件的内容，提高感染率。下面是两封邮件的例子:
邮件内容1
    Dear {RCPT.NAME},
    I have paid the outstanding balance today by bank transfer - $4124.81.
    Please see attached our new address details, please could you update your records.
    http://fwstation.com/New-invoice-738536/GB-MCB/2017-12-Oct-17/
    Thanks for your business!
    {FRIEND.NAME}
    {FRIEND.EMAIL}
邮件内容2