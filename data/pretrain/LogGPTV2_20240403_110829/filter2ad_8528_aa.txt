**作者：启明星辰ADLab  
原文链接：**
# 1\. 概述
《中华人民共和国数据安全法》于今日起（2021年9月1日）正式施行，这是一部数据领域的基础性法律，也是国家安全领域的一部重要法律。数字化改革推动着国家生产模式的变革，随着经济数字化、政府数字化、企业数字化的建设，数据已经成为我国政府和企业最为核心的资产之一。而针对这些核心数据资产的网络攻击却逐年递增，除了越来越频繁的数据泄露安全事件外，日益猖獗的勒索攻击是数据安全面临的最为严重且危险的威胁，其具有破坏性大、匿名性高、恢复难等特点。一旦数据资产遭到攻击，除了大量宝贵的数据被破坏外，还会导致工厂停工停产（如：富士康勒索攻击导致停工的事件），甚至会威胁到国家安全（如：燃油管道公司Colonial
Pipeline勒索攻击事件）。
目前勒索组织普遍利用漏洞或者人工渗透的手段进入企业/组织内部系统，并在其中植入勒索病毒，并利用勒索病毒对其企业的重要数据资产进行加密然后实施赎金勒索。仅今年以来，就出现了多起重大的勒索病毒攻击事件。5月份，美国最大的燃油管道公司Colonial
Pipeline遭遇勒索病毒攻击，从而导致美国东部17个州和首都所在的华盛顿特区宣布进入紧急状态；
7月份，美国IT管理软件制造商Kaseya受到供应链攻击，黑客利用其软件中存在的漏洞向其客户发送勒索软件，超过1500家企业受到勒索攻击影响。
随着市场和技术的变革，勒索组织也在不断寻求新的攻击目标和攻击手段以获取更丰厚的赎金。据调查发现，自去年开始，勒索组织将目标扩展到了VMware的企业产品vSphere中并且对相应勒索软件进行针对性升级以适配针对VMware虚拟机的勒索。到目前为止，多家使用vSphere的企业已经遭到勒索，由于使用vSphere的企业需要在VMware
ESX/ESXi主机上部署多台虚拟机以满足日常的服务器或数据库需求，勒索组织只要设法登录到企业的VMware
ESX/ESXi主机，就能部署勒索软件对主机上的多台虚拟机源文件进行加密实施勒索。与以往传统的勒索攻击不同，以往的勒索攻击仅仅是针对某台或数台服务器中的部分重要数据加密，而系统依旧可以正常运行；而针对vSphere的勒索攻击可直接加密VMware
ESX/ESXi主机中的所有的虚拟机源文件，这将直接导致数台工作服务器或数据库服务器无法正常运行，使企业/组织的主要业务中断甚至系统瘫痪，这对企业/组织来说将是致命的打击。
勒索攻击已经成为各大企业/组织的重要网络安全威胁来源，这种新流行的针对vSphere的勒索攻击将带来比以往的勒索攻击更大的威胁。本文对“针对VMware
vSphere的勒索攻击”进行了全面地分析，通过结合技术背景和相关事件活动分析了勒索组织将攻击目标扩展到VMware
vSphere的原因，并且根据相关攻击样本的分析揭露了此类勒索攻击的勒索流程，同时根据相关材料为广大企业/组织提供了相关的防御建议。
# 2\. 攻击目标：vSphere
VMware
vSphere（简称vSphere）是VMware旗下的一整套云计算基础架构虚拟化平台，自发布更新以来在全球已经拥有超过250000客户，其客户包括政府、军队、医疗、能源、交通、教育等在内的基础设施领域，如图1所示；同时，谷歌云、阿里云、亚马逊云等云服务提供厂商均对客户提供完整的vSphere虚拟化服务，相关市场也同样庞大，如图2所示。拥有如此庞大的市场，vSphere被勒索组织盯上也不足为奇，但是其客户几乎涵盖所有领域，一旦产品出现漏洞被攻击者利用导致主机被勒索病毒攻击，不仅将造成财产损失，更有可能直接威胁国家安全。
图1.vSphere的客户领域分布
图2.云服务商提供VMware服务示例
VMware
ESX/ESXi（简称ESX/ESXi）是vSphere的核心组件之一。在vSphere中，ESX/ESXi是一个虚拟机管理程序，用于创建、运行和管理虚拟机进程的中间软件层，运行在基础物理服务器和操作系统之间，并且允许多个操作系统共享主机硬件。其实，ESX/ESXi并不依赖其它操作系统，而是直接安装在物理设备上，然后以ISO
的形式提供服务；用户直接在ESX/ESXi中创建、运行和管理自己的虚拟机，如图3所示。
在实际场景中，企业为了提高性能和成本效益同时实现简化数据中心和方便大规模管理，往往会在一台ESX/ESXi服务器中部署数台甚至数十台虚拟机作为日常的工作服务主机或者数据库。所以，ESX/ESXi主机中会保存着与它在同一物理主机上的其他虚拟机的源文件以便对这些虚拟机进行管理，它就好比存放着数台服务器的机房，如果机房被人劫持，将对一个企业或组织造成难以估量的损失，这也是ESX/ESXi主机会成为勒索组织攻击目标的主要原因之一；另一个原因则是，ESX/ESXi上部署的服务器/数据库可能需要向客户提供服务，这也使得攻击者有机会直接从网络接触到VMware
ESX/ESXi主机，为攻击者提供了入侵的可能性。VMware公司当然也非常清楚其产品安全的重要性，vSphere 5.0
之前的版本中均采用ESX体系结构来实现对虚拟机的管理，ESX是依赖于Linux的控制台操作系统 (COS)
来实现可维护性和基于代理的合作伙伴集成的，而Linux作为开源系统，与Linux相关的漏洞在各大安全社区和地下产业中层出不穷，这将VMware
ESX架构置于一个高风险处境；为了提高基础架构的安全性，vSphere 5.0之后的版本中则采用了独立于操纵系统的新 ESXi
体系结构，并且在自己研发的核心 VMkernel 中实现了必备的虚拟机管理功能，这也就规避了与通用操作系统相关的安全漏洞引发的安全风险。
图3. VMware ESX/ ESXi 工作结构
VMware vCenter Server（简称vCenter
Server）是vSphere的另外一个核心组件，它是一个可以帮助用户管理多个VMware虚拟化平台的软件，需要单独安装在一台服务器中。在vSphere中，用户可以将多个ESX/ESXi
主机添加到vCenter Server 管理平台中，然后通过vCenter
Server管理ESX/ESXi主机和其中创建的所有虚拟机，整个工作结构如图4所示。虽然目前发现的勒索软件针对的是ESX/ESXi主机，但vCenter
Server可以直接管理ESX/ESXi多台主机。如果vCenter
Server存在漏洞被攻击者利用，那么就无疑将数台ESX/ESXi主机的大门向攻击者敞开，攻击者可以肆意在ESX/ESXi中部署勒索软件，其后果的严重性可想而知。
图4. vCenter Server 工作结构
# 3\. 针对vSphere勒索的相关活动
病毒勒索作为近年来流行的网络攻击手段，逐渐获得黑客团伙青睐，越来越多的勒索组织出现在大众视野，各大病毒勒索事件也逐渐占据了重大网络攻击事件的头版头条。近几年，勒索攻击事件层出不穷，对受害企业/组织造成重大财产损失，勒索病毒已经成为各政府部门、组织和企业需要面临的重要网络危害之一。自去年开始，勒索组织逐渐开始把目标延伸到VMware
vSphere平台上，通过对其中ESX/ESXi服务器上的数台虚拟机系统文件进行加密从而向受害组织/企业勒索高额的赎金。去年7月，Sprite
Spider勒索组织就开始对其勒索软件进行升级，使其在检测到ESXi主机后部署RansomEXX恶意程序试图窃取登录凭证向vCenter进行身份认证；同样对勒索软件进行ESX/ESXi针对性升级的还有勒索组织carbon
spider、BabukLocker、REvil和BlackMatter。自去年开始，针对VMware虚拟机的勒索病毒攻击事件也开始频发，去年11月巴西高等法院（STJ）受到大规模
RansomExx 勒索软件攻击，超过1000台虚拟机文件被加密，此次事件与7月份进行VMware ESX/ESXi软件升级的Sprite
Spider勒索组织是否有关联，我们无从得知；不仅国外用户遭遇了针对VMware
ESX/ESXi的勒索攻击，国内用户同样也遭遇了此类攻击，在今年3月，国内某公司运维人员发现公司内部VMware
ESXi主机上大量虚拟机文件被加密，我们整理的相关的事件时间线如图5。
 图5. 勒索病毒针对vSphere相关事件时间线
从去年开始，IABs团队逐渐与勒索病毒一起进入公众的视野。IABs团队作为网络攻击地下产业的长期活跃参与者，通过在各大论坛出售主机权限来获取利益，它们将受害者主机的root权限出售给其他网络攻击从业者，由其他网络攻击者开展下一步的攻击活动，IABs团队并不直接参与攻击，这也减少了它们被其他执法机构追踪的风险。在以往的勒索攻击中，我们无法确定勒索组织是否是从IABs团队手中购买受害者主机权限，勒索组织与IABs团队合作这种模式可能早已出现，但是这种合作模式正在逐渐被各个勒索组织采用：据消息称，美国最大燃油管道勒索事件中的主角DarkSide在勒索美国石油管道运营商Colonial
Pipeline之前就曾在地下论坛发文寻找能够让其接触到市值4亿美元公司的IABs合作，如图6，美国燃油管道勒索事件是否有IABs团队参与，我们无从考证；另外，在地下论坛中，我们也观察到有多个IABs正在寻求勒索团队合作并出售vCenter/ESXi的Root权限，如图7。
图6. DarkSide寻求与IABs团队合作
图7. IABs团队寻求与勒索组织合作
# 4\. 针对vSphere勒索的原因分析
众多勒索组织开始将目标延伸到vSphere平台上，无非是为了加密更多更重要的数据以勒索更高额的赎金。针对vSphere平台的勒索攻击，能够使勒索组织像控制一间企业服务器的机房一样对数台服务器进行控制，攻击者对这些虚拟机的源文件进行加密，可能直接造成数据库被加密、对外提供服务中断甚至公司系统瘫痪，勒索组织往往开出更高额的赎金。如此釜底抽薪的勒索方式，让受害者企业/组织短时间难以应付，极大地增加了勒索攻击的成功率和收益。其实，随着互联网技术的革新，勒索组织一直在不断寻找新的攻击目标和攻击手段，勒索组织做出
“针对vSphere平台攻击” 的这种改变并非偶然，结合相关资料，我们将在本章对勒索组织的这种改变进行一个原因分析。
**背景条件：**
随着互联网技术的快速更新，网络用户量剧增，各个政府部门、组织和企业对计算资源和存储资源的需求骤增；云计算和虚拟技术的兴起让各大云服务提供商和虚拟化技术公司为各个政府部门、组织和企业提供了定制化资源服务和虚拟化解决方案以满足日常资源需求。VMware作为云服务和虚拟化领域的领头企业，其客户几乎涵盖所有领域；除此之外，各大云服务提供商也为其客户提供间接的VMware虚拟化服务，从图8
“2020年服务器虚拟化市场分布” 中可以看出，VMware已经成为虚拟化市场的绝对霸主。针对VMware
vSphere进行勒索可以拥有众多勒索对象，同时能够通过虚拟化平台vSphere控制企业/组织的大量数字资产，极大地提高了勒索的收益和成功率。
 图8. 2020年服务器虚拟化解决方案的业务市场分布（来源：spiceworks）