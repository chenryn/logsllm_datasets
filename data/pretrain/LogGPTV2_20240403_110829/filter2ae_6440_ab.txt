IDE（集成开发环境）中查看VBA项目时才需要密码：
 图11 –查看VBA项目的密码提示。
我们无法恢复这些密码。我们将开膛手约翰（John the
Ripper）与rockyou.txt密码列表[[4]](https://www.kaggle.com/wjburns/common-password-list-rockyoutxt "\[4\]")结合使用，对Hashcat使用了小型ASCII蛮力攻击。
尽管每个恶意文档都有其自己的VBA代码，但每个恶意文档都是唯一的，迄今为止已分析了200多个样本，但我们可以将所有这些VBA代码概括和抽象为少数几个模板。VBA代码将使用PowerShell或ActiveX对象下载有效负载。不同的字符串使用十六进制，BASE64或XOR编码进行编码，或这些编码的组合。本博客文章的末尾提供了一个Yara规则来检测这些恶意文档，以进行识别和检测。
## 有效负载分析
如上一部分所述，通过恶意VBA代码，从各个网站下载了第二阶段的有效负载。由其各自的恶意文档创建的每个第二阶段可执行文件都充当最终有效负载的放置程序。为了阻止诸如防病毒解决方案之类的检测机制，利用了多种混淆技术，但是这些技术不够先进，无法掩盖恶意意图。攻击者所使用的基础设施似乎主要包括受感染的网站。
流行的防病毒解决方案，例如VirusTotal上列出的解决方案，如图12所示，通常将第二阶段的可执行文件标识为“
AgentTesla”。尽管利用VirusTotal进行恶意软件识别不是一种理想的方法，但它确实显示了简单的混淆会导致错误的分类。在整个分析过程中，我们将解释这些流行的检测中只有很少的结果是准确的。
图12：VirusTotal的“ AgentTesla”错误识别。
我们观察到的不同混淆技术概述了操作Epic
Manchego的所有第二阶段可执行文件所共有的模式。从图13中可以看到，第二阶段将动态加载解密DLL。然后，此DLL组件继续提取其他设置和第三阶段有效负载，然后再将执行转移到最终的有效负载（通常是信息窃取者）。
图13：Epic Manchego操作的最后阶段交付机制。
尽管以上混淆模式对于所有样本都是通用的，但我们已经观察到其复杂性的演变以及可能采用更多机会主义技术的广泛变化。
该行动第二阶段样本的一个共同因素是使用隐写术掩盖其恶意意图。图14标识了在最近的变体中使用的部分配置，其中包括最终有效负载在内的设置字典被编码为数百个图像，这是作为第二阶段嵌入式资源的一部分。
 图14：BMP图像中编码的部分字典。
图像本身是以下第二阶段样本的一部分，该样本具有以下属性：
**文件名** ：crefgyu.exe  
**MD5** ：7D71F885128A27C00C4D72BF488CD7CC  
**SHA256** :C40FA887BE0159016F3AFD43A3BDEC6D11078E19974B60028B93DEF1C2F95726  
**文件大小** ：761 KB（779.776字节）  
**编译时间** ： 2020-03-09 16:39
值得注意的是，混淆过程不是由攻击者自己建立的。对第二阶段隐写术解码程序的仔细审查揭示了大多数样本是如何错误地将最终有效载荷包含两次。在加载程序配置的以下表示形式（图15）中，我们可以看到其有效负载确实是重复的。第二级和第三级有效载荷的复杂性还倾向于表明操作涉及不同的参与者，因为初始文档反映了经验不足的参与者。
在分析的多个基于字典的变体中，我们还注意到，无论最终的有效负载如何，相似的键都用作设置的一部分。所有字典都包含最终的有效载荷，即“EpkVBztLXeSpKwe”，而某些字典（如图15所示）也包含与“PXcli.0.XdHg”相同的值。这暗示了可能的有效载荷传递构建器，可以由多个参与者使用。
 图15：第二阶段解码字典。
在30个不同的基于字典的第二阶段的手动分析数据集中，观察到19个唯一的最终有效载荷。从这些中，“Azorult”窃贼占该变种交付量的50％（图16）。其他有效负载包括“
AgentTesla”，“Formbook”，“Matiex”和“njRat”，这些都已经有据可查。“Azurult”和“njRAT”都有明显的重用率。
图16：基于字典的有效载荷分类和带有修剪散列的样本的（重新）使用。
我们对滴管和相应有效负载的分析揭示了混淆例程中的常见模式。尽管机会主义混淆方法可能会发展，但交付的有效负载仍然是相当有限的一组恶意软件系列的一部分。
## 指定目标
我们从VirusTotal检索到的少量恶意文档与网络钓鱼电子邮件本身一起上传。对这些电子邮件的分析可以为该参与者的潜在目标提供一些启示。由于检索到的源电子邮件数量有限，因此无法根据受害者确定明确的模式。在我们能够检索到的6封电子邮件中，收件人分别是医疗设备部门，铝业，设施管理部门和定制压机供应商。
在调查发件人域时，似乎大多数电子邮件都是从合法公司发送的。使用“已被我拥有” [[5]](https://haveibeenpwned.com/
"\[5\]")服务确认是否已知有任何电子邮件地址遭到破坏，但没有结果。这使我们想知道攻击者在早期感染期间是否能够利用这些帐户，或者是否由另一方提供。无论谁破坏了帐户，攻击者似乎主要使用合法的公司电子邮件帐户来发起网络钓鱼活动。
从发送者和接收者这两个角度来看，似乎没有一种可以推断出潜在新目标的模式。似乎没有针对的特定部门，发送域也没有关联。
电子邮件的正文（内容）和主题均与更经典的网络钓鱼方案有关，例如，发起业务的请求，附件提供了“详细信息”。观察到的主题概述可以在下面看到，请注意，某些主题已被各自的邮件网关更改：
  * 回复：需要报价/
  * 报价量和重量为首选
  * **_*_ SPAM ***** FW：Offer_10044885_ [companyname] _2_09_2020.xlsx *
  * [怀疑的垃圾邮件]替代要求*
  * 采购订单明细
  * 报价请求
图17 –网络钓鱼电子邮件示例。
这种诱使用户打开附件的方法并不是什么新鲜事物，并且没有提供很多其他信息来精确定位针对任何特定组织或行业的广告系列。
但是，通过VirusTotal利用maldocs的公开提交，我们聚集了200多个文档，这使我们能够按提交计数对27个国家/地区进行排名，而无需区分可能通过VPN执行的上传。如图18所示，美国，捷克共和国，法国，德国以及中国等地区占了大多数目标区域。
图18 – VT提交的地理分布。
在分析目标区域的初始文档时，我们主要识别基于英语，西班牙语，中文和土耳其语的图像。
图19 – Maldoc内容分别为中文，土耳其语，西班牙语和英语。
但是，某些图像包含一个有趣的细节：某些文档属性使用西里尔字母，而与图像的主要语言无关。
尽管在多幅图像中观察到了西里尔字母设置，但是在撰写此文章时发现了一个新的恶意文档，这引起了我们的兴趣，因为它似乎是第一个明确冒充医疗保健部门成员的人（“俄亥俄·哈丁纪念医院”），如图20所示。还要注意上述设置：СТРАНИЦА1ИЗ1
; 表示第1页，共1页。
图20 –带有西里尔字母设置的Maldoc内容模拟了“ Ohiohealth Hardin Memorial Hospital”。
此Microsoft Excel文档具有以下详细信息：
**文件名** ： 새 로 운 주 문 _2608.xlsm（韩文：新订单_2608.xlsm）  
**MD5** ：551b5dd7aff4ee07f98d11aac910e174  
**SHA256** :45cab564386a568a4569d66f6781c6d0b06a9561ae4ac362f0e76a8abfede7bb  
**文件大小** ：5.77 KB（5911个字节）  
**最早修改内容时间** ： 2020年6月22日14时01分46秒
尽管可以从网上简单地找到来自该医院的模板，然后由攻击者使用，但是这种令人惊讶的操作方式变化似乎与自跟踪开始以来观察到的行为者的不断发展相吻合。
## 评价
根据分析，NVISO评估以下内容：
  * 所观察到的威胁行动者已经找到了一种创建恶意Office文档的新方法，该方法可以至少略微减少检测机制。
  * 攻击者可能正在尝试和发展其方法，以创建恶意Office文档，从而可能使工作流程自动化。
  * 尽管目前的定位似乎很有限，但这些首次投放可能是为了测试而不是全面的广告系列。 提交给VirusTotal的最新检测结果表明，该攻击者可能正在加强其行动。
  * 尽管创建恶意文档的方法是唯一的，但有效负载传送和实际有效负载的方法并不是唯一的方法，应该由现代技术加以阻止或检测。
  * 有趣的是Xavier Mertens最近在SANS日记中通过VT追踪恶意软件活动[[6]](https://isc.sans.edu/forums/diary/Tracking+A+Malware+Campaign+Through+VT/26498/ "\[6\]")发表的文章。似乎另一位安全研究人员也一直在跟踪这些文档，但是，他们已经从maldocs中提取了VBA代码并上传了该部分。这些模板与PowerShell的下一阶段下载方式有关。
总之，NVISO评估了这种特定的恶意Excel文档创建技术，尽管有效载荷分析通常被认为更有趣，但它可能会被更多地在野外观察到，尽管它被电子邮件网关或分析人员遗漏了。但是，阻止和检测这些类型的新颖性（例如本博客中描述的恶意软件创建）使组织能够在出现激增或类似活动时更快地进行检测和响应。建议部分提供了裁定和指标作为检测手段。
## 推荐建议
  * 过滤电子邮件附件和从组织外部发送的电子邮件。
  * 实施强大的端点检测和响应防御。
  * 创建网络钓鱼意识培训并执行网络钓鱼练习。
* * *