# Black Hat USA 2018 Arsenal | GhostTunnel 解读
##### 译文声明
本文为翻译文章，具体表达和含义以原文为准。
作者：360无线电安全研究院

## 1. 前言
今年是360无线电安全研究院第四次参加世界顶级的安全会议Black Hat。继4月份的HITB阿姆斯特丹站后，来自天马安全团队的柴坤哲、曹鸿健和王永涛带来的GhostTunnel再次入选了以“议题审核严苛”著称的Black Hat USA 2018。据悉，该会议的议题接受率不足20%。

GhostTunnel是一种适用于隔离环境下的后门传输方式。一旦payload在目标设备上释放，即可在用户无感知的情况下对目标进行控制并回传信息。与现有的其他类似研究（如WHID，一种通过Wi-Fi进行控制的HID设备）相比，GhostTunnel不创建或依赖于任何有线、无线网络，甚至不需要外插任何硬件模块。

在Black Hat的演讲中，我们更新了之前的GhostTunnel版本，并开源了源码。为了方便新读者理解，本文将在第2和第3小节中介绍GhostTunnel的基本使用场景和技术原理。在第3小节的末尾部分（3.3, 3.4），我们将补充之前未详细介绍的实现部分及本次更新内容。

## 2. 背景
本节将介绍“远控木马上线方式”、“网络隔离”和“HID攻击”等相关知识，部分内容引用自其他文章，在小节末将给出原文以便扩展阅读。

### 2.1 远控木马上线方式
提到远控木马，大家可能会想到许多耳熟能详的名称，如灰鸽子、冰河、PCshare、Gh0st、白金、凤凰ABC以及Poison Ivy等。从上线方式的角度来看，远控木马可以分为以下几类：

- **主动连接型**  
  被控端开启特定端口，主控端通过该主机IP及端口连接到被控端，如3389远程桌面、VNC远程桌面等。

- **反弹连接型**  
  由于主动连接的方式不适用于内网环境，许多木马采用反弹连接的方式。主控端监听特定端口，被控端执行木马后反连回主控端。这种方式适用性更广，大部分木马都采用此方式上线，如利用FTP上线、DNS域名解析上线等。

- **通过第三方域名型**  
  出于隐蔽性或反追踪的目的，一些新型木马通过第三方网站进行上线。例如，利用知名博客的文章内容及评论区、QQ空间、微博、推特的推送内容，甚至QQ个性签名作为上线地址。这些方法可以绕过某些防火墙的白名单限制。

> 参考文章：《木马的前世今生：上线方式的发展及新型上线方式的实现》
> http://www.freebuf.com/articles/terminal/77412.html

实际上，GhostTunnel也可以视为一种木马的上线方式，但它特别针对处于隔离网络中的目标。

### 2.2 网络隔离 (Air Gapping)
Wikipedia定义：“Air gapping, air walling, or air gapping is a network security measure employed on one or more computers to ensure that a secure computer network is physically isolated from unsecured networks, such as the public Internet or an unsecured local area network.”

简单来说，网络隔离是一种用于保护特定网络的物理隔离措施，通常用来防止通过网络连接途径造成的入侵和信息泄漏事件。

隔离网闸是一种常见的形式，其原理包括：
- 切断网络之间的通用协议连接；
- 将数据包分解或重组为静态数据；
- 对静态数据进行安全审查，包括网络协议检查和代码扫描；
- 确认后的安全数据流入内部单元；
- 内部用户通过严格的身份认证机制获取所需数据。

隔离网闸常用于涉密网与非涉密网之间。攻击者无论是想利用操作系统、应用软件还是通信协议的漏洞，都需要通过网络触碰目标机器，而网络隔离环境中这条路被封住了。然而，一些大新闻显示，利用恶意USB是一种可行的攻击方式。以下是几个针对隔离网攻击的案例：

**震网病毒 (Stuxnet Worm)**
著名的震网病毒利用USB将病毒传入隔离网络，随后传播到其他设备。在适当的时候，它向工控机器下发错误指令，导致机器异常直至报废。最终，震网病毒导致伊朗的核计划被迫延迟至少两年。

**水蝮蛇一号 (COTTONMOUTH-I)**
斯诺登披露的NSA秘密武器中包含了该工具，其内部包含一套ARMv7芯片和无线收发装置。当插入目标主机后，植入恶意程序并创建一个无线网桥，配套设备可通过RF信号与其交互，传输命令及数据。它被NSA用于攻击伊朗的秘密机构，从物理隔离的设备中窃取数据长达数年。

### 2.3 HID攻击
HID是Human Interface Device的缩写，指的是直接与人交互的设备，如键盘、鼠标和游戏杆等。符合HID类别规范的设备都是HID设备。针对HID的攻击主要集中在键盘和鼠标上，因为只要控制了用户的键盘，基本上就等于控制了用户的电脑。攻击者会把攻击隐藏在一个正常的鼠标键盘中，当用户插入含有攻击向量的设备时，恶意代码会被加载并执行。

**Teensy**
攻击者在定制攻击设备时，会在USB设备中置入一个攻击芯片，这个芯片是一个非常小且功能完整的单片机开发系统，名为TEENSY。通过TEENSY，你可以模拟出一个键盘和鼠标，当插入这个定制的USB设备时，电脑会识别为一个键盘，利用设备中的微处理器和存储空间编程进去的攻击代码，就可以向主机发送控制命令，从而完全控制主机，无论自动播放是否开启，都可以成功。

**USB Rubber Ducky**
简称USB橡皮鸭，是最早的按键注入工具，通过嵌入式开发板实现，后来发展成为一个成熟的商业化按键注入攻击平台。它的原理同样是将USB设备模拟成键盘，让电脑识别为键盘，然后进行脚本模拟按键进行攻击。

**BadUSB**
Teensy和橡皮鸭的缺点在于需要定制硬件设备，通用性较差。但BadUSB不同，它通过对U盘的固件进行逆向重新编程，相当于改写了U盘的操作系统来进行攻击。

**BashBunny**
这款设备的一大特色是可以发动多种payload。将开关切换到相应payload选择（如图中的Switch Position 1/2），将BashBunny插入目标设备，观察LED灯的变化就能了解攻击状态。在硬件方面，设备中包含一颗四核CPU和桌面级SSD，Hak5介绍说此设备从插入到攻击发动只需7秒。此外，这款BashBunny设备实际上拥有Linux设备的各种功能，通过特定串口可访问shell。绝大部分渗透测试工具的功能都能在其中找到。

**DuckHunter**
在Kali Linux NetHunter中提供了该工具。它可以将USB Rubber Ducky的脚本转化为NetHunter 自有的HID Attacks格式，从而将刷有Nethunter的Android设备通过数据线与电脑相连，模拟键盘进行输入。

**WHID**
WHID即WiFi + HID的组合，WHID注入器顾名思义就是对HID攻击进行无线化攻击的一种注入工具，通过在USB设备上提供WiFi功能以供远程控制。

> 参考文章：
> - 《HID攻击之TEENSY实战》
> - 《新的U盘自动运行——BadUSB原理与实现》
> - 《据说是“最先进的USB攻击平台”》
> - 《DuckHunter HID for mac》
> - 《WHID注入器：在无线环境下实现HID攻击的最新利器》

## 3. GhostTunnel
对于隔离网络的攻击一般有两个步骤：
1. 在目标系统植入恶意软件
2. 建立数据通道，以便执行命令和窃取数据

根据之前的案例可以看到，任何可以承载数据的媒介都可以用来建立数据通信通道。GhostTunnel便是一种利用WiFi信号的隐蔽传输通道。

首先，以HID攻击为例：我们使用BashBunny或DuckHunter等HID工具将恶意程序植入受害者设备，比如一台Windows笔记本。随后，恶意程序将使用受害者设备的内置无线通信模块与另一台由攻击者控制的设备建立端到端的WiFi传输通道。此时，攻击者就可以远程执行命令并窃取数据。

演示效果如下：
值得注意的是，GhostTunnel指的是通过利用受害者设备自身的无线模块来建立传输通道的一种方式，其不仅限于使用HID攻击来植入恶意程序，实际上以其他方式植入也是可行的。

### 3.1 优势
GhostTunnel的实现方式具有以下优势：
- **HID设备只用于植入攻击代码，植入完成后可以移除**（HID攻击外的其他植入方式也是可以的）
- **没有正常的网络流量，可以绕过防火墙检测**
- **不会对现有的网络通信及连接状态造成影响**
- **跨平台支持**。该攻击可用于任何拥有WiFi模块的设备，我们在Win7、Win10、Mac OSX和Linux上进行了测试。
- **支持最高256个受控端**
- **可在50米内工作，配合信号桥接设备理论上可做到无限远**

希望这些优化能使文本更加清晰、连贯和专业。