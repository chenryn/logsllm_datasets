title:Mapping an Enterprise Network by Analyzing DNS Traffic
author:Minzhao Lyu and
Hassan Habibi Gharakheili and
Craig Russell and
Vijay Sivaraman
Mapping an Enterprise Network
by Analyzing DNS Traﬃc
Minzhao Lyu1,2(B), Hassan Habibi Gharakheili1, Craig Russell2,
and Vijay Sivaraman1
1 University of New South Wales, Sydney, Australia
{minzhao.lyu,h.habibi,vijay}@unsw.edu.au
2 Data61, CSIRO, Sydney, Australia
PI:EMAIL
Abstract. Enterprise networks are becoming more complex and dyn-
amic, making it a challenge for network administrators to fully track
what is potentially exposed to cyber attack. We develop an automated
method to identify and classify organizational assets via analysis of just
0.1% of the enterprise traﬃc volume, speciﬁcally corresponding to DNS
packets. We analyze live, real-time streams of DNS traﬃc from two
organizations (a large University and a mid-sized Government Research
Institute) to: (a) highlight how DNS query and response patterns dif-
fer between recursive resolvers, authoritative name servers, web-servers,
and regular clients; (b) identify key attributes that can be extracted eﬃ-
ciently in real-time; and (c) develop an unsupervised machine learning
model that can classify enterprise assets. Application of our method to
the 10 Gbps live traﬃc streams from the two organizations yielded results
that were veriﬁed by the respective IT departments, while also revealing
new knowledge, attesting to the value provided by our automated system
for mapping and tracking enterprise assets.
Keywords: Enterprise network · DNS analysis · Machine learning
1 Introduction
Enterprise networks are not only large in size with many thousands of con-
nected devices, but also dynamic in nature as hosts come and go, web-servers
get commissioned and decommissioned, and DNS resolvers and name servers get
added and removed, to adapt to the organization’s changing needs. Enterprise
IT departments track such assets manually today, with records maintained in
spreadsheets and conﬁguration ﬁles (DHCP, DNS, Firewalls, etc.) – this is not
only cumbersome, but also error prone and almost impossible to keep up-to-date.
It is therefore not surprising that many enterprise network administrators are
not fully aware of their internal assets [12], and consequently do not know the
attack surface they expose to the outside world.
The problem is even more acute in university and research institute campus
networks for several reasons [6]: (a) they host a wide variety of sensitive and lucra-
tive data including intellectual property, cutting-edge research datasets, social
c(cid:2) Springer Nature Switzerland AG 2019
D. Choﬀnes and M. Barcellos (Eds.): PAM 2019, LNCS 11419, pp. 129–144, 2019.
https://doi.org/10.1007/978-3-030-15986-3_9
130
M. Lyu et al.
(a) Outgoing DNS queries.
(b) Incoming DNS responses.
Fig. 1. University campus: outgoing queries and incoming responses, measured on 3
May 2018. (Color ﬁgure online)
security numbers, and ﬁnancial information; (b) their open-access culture, decen-
tralized departmental-level control, as well as federated access to data makes them
particularly vulnerable targets for unauthorized access, unsafe Internet usage,
and malware; and (c) they typically have high-speed network infrastructure that
makes them an attractive target for volumetric reﬂection attacks.
Our aim in this paper is to develop an automated method to map internal
hosts of an enterprise network by focusing only on DNS traﬃc which: (a) is
a key signaling protocol that carries a wealth of information yet bypasses ﬁre-
walls easily; (b) constitutes a tiny faction of total network traﬃc by volume
(less than 0.1% from our measurements in two networks); and (c) is easy to
capture with only a couple of ﬂow entries (i.e mirroring UDP packets to/from
port 53) in an Openﬂow-based SDN switch. By capturing and analyzing DNS
traﬃc in/out of the organization, we dynamically and continually identify the
DNS resolvers, DNS name-servers, (non-DNS) public-facing servers, and regular
client hosts behind or not behind the NAT in the enterprise. This can let net-
work administrators corroborate changes in host roles in their network, and also
equip them with information to conﬁgure appropriate security postures for their
assets, such as to protect DNS resolvers from unsolicited responses, authoritative
name servers from ampliﬁcation requests, and web-servers from volumetric DNS
reﬂection attacks.
Our speciﬁc contributions are as follows. We analyze real-time live streams of
DNS traﬃc from two organizations (a large University and a mid-sized Govern-
ment Research Institute) to: (a) highlight how DNS query and response patterns
diﬀer amongst recursive resolvers, authoritative name servers, and regular hosts;
(b) identify key DNS traﬃc attributes that can be extracted eﬃciently in real-
time; and (c) develop an unsupervised machine learning model that can classify
enterprise assets. Application of our method to the traﬃc streams from the two
organizations yielded results that were veriﬁed by the respective IT departments
while revealing new information, such as unsecured name servers that were being
used by external entities to amplify DoS attacks.
Mapping an Enterprise Network by Analyzing DNS Traﬃc
131
2 Proﬁling Enterprise Hosts
In this section, we analyze the characteristics of DNS traﬃc collected from the
border of two enterprise networks, a large University campus (i.e., UNSW) and
a medium-size research institute (i.e., CSIRO). In both instances, the IT depart-
ment of the enterprise provisioned a full mirror (both inbound and outbound) of
their Internet traﬃc (each on a 10 Gbps interface) to our data collection system
from their border routers (outside of the ﬁrewall), and we obtained appropri-
ate ethics clearances for this study1. We extracted DNS packets from each of
enterprise Internet traﬃc streams in real-time by conﬁguring rules for incom-
ing/outgoing IPv4 UDP packets for port 53 on an SDN switch (extension to
IPv6 DNS packets is left for future work). The study in this paper considers the
data collected over a one week period of 3–9 May 2018.
2.1 DNS Behavior of Enterprise Hosts
Enterprises typically operate two types of DNS servers: (a) recursive resolvers
are those that act on behalf of end-hosts to resolve the network address of a URL
and return the answer to the requesting end-host (recursive resolvers commonly
keep a copy of positive responses in a local cache for time-to-live of the record
to reduce frequent recursion), and (b) authoritative servers of a domain/zone
are those that receive queries from anywhere on the Internet for the network
address of a sub-domain within the zone for which they are authoritative (e.g.,
organizationXYZ.net).
In order to better understand the DNS behavior of various hosts (and their
role) inside an enterprise network, we divide the DNS dataset into two categories:
(a) DNS queries from enterprise hosts that leave the network towards a server on
the Internet along with DNS responses that enter the network, (b) DNS queries
from external hosts that enter the network towards an enterprise host along with
DNS responses that leave the network.
This analysis helps us identify important attributes related to host DNS
behavior, characterizing its type/function including authoritative name server,
recursive resolver, generic public-facing server (e.g web/VPN servers), or end-
host inside the enterprise that may not always be fully visible to the network
operators. This also enables us to capture the normal pattern of DNS activity
for various hosts.
Outgoing Queries and Incoming Responses. Figure 1 shows a time trace of
DNS outgoing queries and incoming responses for the university campus2, with
a moving average over 1-minute intervals on a typical weekday. The university
network handles on average 353 outgoing queries and 308 incoming responses per
1 UNSW Human Research Ethics Advisory Panel approval number HC17499, and
CSIRO Data61 Ethics approval number 115/17.
2 We omit plots for the research institute in this section due to space constraint,
they are shown in Appendix 1.
132
M. Lyu et al.
(a) Incoming DNS queries.
(b) Outgoing DNS responses.
Fig. 2. University campus: incoming queries and outgoing responses, measured on 3
May 2018. (Color ﬁgure online)
second. By checking the transaction ID of queries and responses, we found that
17.28% of outgoing queries are “unanswered” (i.e., 5.26M out of 30.46M) on 3
May 2018. It is also important to note that 5.24% of incoming responses to the
university campus network (i.e., 1.39M out of 26.59M) are “unsolicited” on the
same day3. A similar pattern with lower number of outgoing queries and incom-
ing responses (i.e., average of 107 and 80 per second respectively) is observed in
the research institute network. This network experiences approximately double
the amount of unanswered queries (i.e., 34.14%) and unsolicited responses (i.e.,
12.15%) compared to the university network.
Query per Host: We now consider individual hosts in each enterprise. Unsur-
prisingly, the majority of outgoing DNS queries are generated by only two hosts
A and B in both networks, i.e., 68% of the total in the university campus (shown
by blue and yellow shades in Fig. 1(a)) and 82% of the total in the research insti-
tute – these hosts are also the major recipients of incoming DNS responses from
the Internet. We have veriﬁed with the respective IT departments of the two
enterprises that both hosts are the primary recursive resolvers of their organiza-
tions.
In addition to these recursive resolvers, we observe a number of hosts in both
organizations, shown by red shades in Fig. 1(a), that generate DNS queries to
outside of the enterprise network. The 2,642 other Univ hosts in Fig. 1(a) are
either: end-hosts conﬁgured to use public DNS resolvers that make direct queries
out of the enterprise network, or secondary recursive servers operating in smaller
sub-networks at department-level. We found that 286 of these 2,642 University
hosts actively send queries (at least once every hour) over the day and contact
more than 10 Internet-based DNS servers (resolvers or name-servers). These 286
hosts display the behavior of recursive resolvers but with fairly low throughput,
thus we deem them secondary resolvers. The remaining 2,356 hosts are only
active for a limited interval (i.e., between 5 min to 10 h) and contact a small
3 We acknowledge that some DNS packets could have been dropped by the switches
on which the span-port was conﬁgured, especially during periods of overload.
Mapping an Enterprise Network by Analyzing DNS Traﬃc
133
(a) Unsolicited incoming responses.
(b) Unanswered incoming queries.
Fig. 3. University campus: CCDF of (a) unsolicited incoming responses and (b) unan-
swered incoming queries per host, measured on 3 May 2018.
number of public resolvers (e.g., 8.8.8.8 or 8.8.4.4 of Google) over the day. We
found that 15 of 340 hosts in the research institute display behavior of secondary
resolvers.
Response per Host: Considering incoming responses (Fig. 1(b) for the uni-
versity network), a larger number of “other” hosts in both organizations are
observed – approximately 8 K hosts in the University and 5.8 K hosts in the
research institute. Most of these “other” hosts (i.e., 67%) are the destinations
of unsolicited responses. To better understand the focus target of these poten-
tially malicious responses, we analyze unsolicited incoming responses for the two
enterprises. Figure 3(a) shows the CCDF of total unsolicited incoming responses
per each host over a day for the university campus. Interestingly, the primary
recursive resolvers in both organizations are top targets: (a) in the University
campus, hosts A and B respectively are the destinations of 522 K and 201 K unso-
licited incoming responses (i.e., together receive 52% of total unsolicited DNS
responses), and (b) in the research institute, hosts A and B respectively are the
destination of 435 K and 135 K unsolicited incoming responses (i.e., together
receive 69% of total unsolicited DNS responses).
Incoming DNS Queries. Enterprises commonly receive DNS queries from the
Internet that are addressed to their authoritative name servers.
It can be seen that two hosts of the University campus (i.e., hosts C and
D in Fig. 2) and one host (we name it Host C) of the research institute are the
dominant contributors to outgoing DNS responses – we have veriﬁed (by reverse
lookup) that these hosts are indeed the name servers of their respective organi-
zations. Interestingly, for both organizations we observe that a large number of
hosts (i.e., 197K hosts of the University campus and 244K hosts of the research
institute (shown by red shades in Fig. 2(a) for the university network) receive
queries from the Internet, but a signiﬁcant majority of them are unanswered (i.e.,
82.18% and 62.09% respectively) – these hosts are supposed to neither receive
134
M. Lyu et al.
Table 1. Host attributes.
QryFracOut numExtSrv numExtClient actvTimeFrac
Univ name server (host C)
Rsch name server (host C)
0
0
Univ recursive resolver (host A) 1
Rsch recursive resolver (host A) 1
Univ mixed DNS Server
Rsch mixed DNS Server
Univ end-host
Rsch end-host
0.55
0.29
1
1
0
0
0.26
0.49
0.03
0.0008
0.00002