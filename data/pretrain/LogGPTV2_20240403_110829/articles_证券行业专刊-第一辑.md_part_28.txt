一、日志的概念 解决了记录哪些日志，输出哪些日志，下一步要做的就是挖掘日志
中包含的丰富隐藏财富。
日志是记录系统运行过程中各种重要信息的文件，在系统运行过程
中由各进程创建并记录。日志的作用是记录系统的运行过程及异常 二、安全日志的价值
信息，为快速定位系统运行中出现的问题及开发过程中的程序调试
问题提供详细信息。 日志能告诉我们很多关于系统中所发生事件的信息，最常见的用法
是用来排错，解决故障。日志还会成为在事故发生后查明“发生了
早期在软件开发过程缺少日志规范，对日志记录哪些，没有明确定 什么”的很好的溯源取证的信息来源。本文列出一些常见的日志用
义和框架，纯依赖于开发者的经验和组织的技术规范。曾在实际工 例。
作检查一个系统称之有日志记录，等我们登录上去一看时，发现只
有登入和登出的两类日志，简直让人啼笑皆非。在安全领域的日志 2.1 故障排错
框架，可参考GB/T18336中定义了评估信息技术产品和系统安全 事实上大部分情况下日志是为故障排错而设计。如果不检查日志
性所需的基础准则，是度量信息技术安全性的基准。针对安全性评 文件，无法得知系统具体错误，从而入手解决问题。例如下图中
估过程中信息技术产品和系统的安全功能及相应的保证措施提出 Windows补丁升级服务（WSUS）的日志文件显示更新报错，给
一组通用要求，使各种相对独立的安全性评估结果具有可以性。标 管理员提供解决问题的方向。
准中提出保护轮廓（PP）将信息技术安全要求分为功能和保证两
大部分。例如安全审计可分为：
2.2 性能资源管理
日志不仅仅可以告诉你主机
是否健康运行，还能够告诉
你主机上运行的应用程序在
做什么。往往系统真正宕机
前日志中就展现出硬件和软
件的错误。
…
212 213
行
业 证券行业安全日志的几个应用场景
专
刊
2.3 攻击入侵分析 据力度有待确定。举个常见的例子，如在对方不知情的情况下偷录
从安全日志分析发现攻击入侵是安全运营的重点任务。如下示例： 的语音，其证据力度、合法性在法庭上有待法官确认。如上图所示
… 的溯源取证的例子：
（1）事件描述：对恶意IP进行溯源，拿下该IP控制权限；
（2）受攻击主机：www.xxx.com；
（3）攻击源IP：103.XX.184.194；
从全流量抓取攻击数据包，查看日志携带webshell恶意字段： （4）信息收集与分析过程：从全流量抓取攻击数据包，查看日志，
（1）事件描述：攻者队使用扫描器进行IP信息收集和漏洞扫描； Webshell，确定恶意攻击行为。
（2）受攻击主机：112.XX.XX.230；
（3）攻击源IP:…59.1XX.XX.20。 三、安全日志实战应用的几个场景
这些消息表明攻击者对网络做了一次端口扫描，试图寻找有安全漏 3.1 利用流量日志查找肉鸡
洞的主机，这一系统近期发现大量易受攻击的漏洞。 1、场景描述
在恶意攻击中受控主机会从受感染的主机向攻击者控制的主机发
2.4 鉴定取证 送简短和定期的通讯的做法，以传达受感染主机恶意软件处于活动
计算机取证是近年最热门的一个专业词汇，原来专指在特定领域拥 状态、正常运行并准备好接收指令的相关信息。此通信流量通常来
有鉴定资格或司法人员在处理案例过程中使用专业工具对计算机 自受感染的内部企业主机（例如bots或zombies），并发送到企
系统获取的日志或记录，可以在侦察、诉讼等阶段作为证据使用。 业网络外部的命令和控制（C&C）服务器。这种通信允许僵尸网
其他人员如企业安全管理员、第三方安全厂商在安全事件中记录的 络管理员自动追踪、管理和控制数十万受感染的主机。
安全日志，在法律程序上不能算是严格的“证据”，其合法性和证
当我们面对恶意软件的时候，为什么不直接寻找恶意软件本身，而
要利用流量日志去作为检测的依据呢？那是因为随着技术的增长，
好的恶意软件并不总是那么容易被找到。因为恶意软件的作者知道
防病毒、反恶意软件和端点保护是如何运作的，所以复杂的恶意软
件很容易逃避各类检测。作者可以围绕它们进行设计，甚至在开始
执行任何嘈杂的活动或在受感染的主机上写入任何文件之前检查
是否存在这些防御机制。因此，仅检查机器上的恶意软件是不够的，
我们还需要从流量日志上寻找恶意软件感染的迹象。通常恶意软件
214 215
行
业 证券行业安全日志的几个应用场景
专
刊
在主机上立足后，它会迅速确定主机环境并与命令和控制服务器 NTA流量日志，未经处理的数据如下图所示：
（Command&Control…Server）取得联系。然后，C2服务器会决 …
定向受感染主机传输或者安装什么样的内容。
(2) 筛选数据流向：上文提到的恶意流量通常来自受感染的内部企
业主机，并发送到企业网络外部的命令和控制（C&C）服务器，所
以本模型关注源地址为内网IP，目的地址为外网IP的流量（Internal…
IP→External…IP）。在模型使用过程中可通过平台提供的lookup
函数对内网段作出筛选。
(3) 数据处理-时间数据：由于此模型需要计算时间间隔等数据，
时间戳字段不便于运算，故需把时间戳转化为以秒为单位的数值。
转化思路为，如时间戳成时间为10:12:14.321，则转换为秒的公式
为
Time=10×3600s+12×60s+14.321s=36734.321s
2、检测模型和检测步骤
(4) 数据处理-时间重整：在时间转化完毕后，我们需要对数据进
行重整，展示出同一源IP对同一目的IP的所有通讯时间，将时间
排序，为后续计算时间间隔作准备，同时展示两个IP之间的连接
次数。
…
(1) 采集原始日志：本模型通过安全大数据分析平台接入数据源为 (5) 时间间隔计算：使用脚本计算出同一源IP对同一目的IP所有
216 217
行
业 证券行业安全日志的几个应用场景
专
刊
相邻通讯的时间间隔。 发生通讯的总次数。通过与这个值对比可以将通讯次数较少的事件
过滤掉，降低误报，提高模型的实用性。此处设定当连接总次数阀
值=20，当conn_cnt>20时为有效事件。
百分比阀值：百分比指的是同一源地址至同一目的地址之间的通讯
存在行为的可能性。利用这个值进行筛选可以有效提高告警的精
… 度。此处设定百分比阀值为30，当百分比大于30为有效事件。百
分比计算公式为：
…
阀值的设定需要和时间框架关联，此模型使用的时间框架为24小
时，另外阀值的设定应根据环境或告警的真实情况作出调整。
(7) 验证告警：根据阀值筛选结果，由安全分析人员验证可疑事件，
如确认存在肉鸡行为以及恶意软件，标示主机失陷并进行响应。
3、减少干扰的检测
在检测时，结果可能包含已知设备供应商的合法流量，例如与
Windows更新相关的流向Microsofts的流量、流向设备制造供应
商的流量，或任何其他配置为按预定时间间隔启动网络连接的合法
应用程序。在模型使用初期，安全分析人员需要根据历史事件分析
了解基线，使用IP地址白名单来过滤此类合法IP以减少大量的误
报，提高检测精准度。
(6) 利用阀值进行过滤：在得到所有时间间隔之后，我们需要定义
异常场景的筛选条件以此作为告警条件。根据肉鸡的特性以及其它 由于检测会根据重复最多的时间间隔发出告警，但攻击者也可以添
参考定义以下两条： 加抖动或随机性使各个网络连接之间的时间间隔值看起来有所不
连接总次数阀值：连接总次数指的是同一源地址至同一目的地址所 同，并使流量百分比阀值的匹配失效，从而绕过此检测。为应对此
218 219
行
业 证券行业安全日志的几个应用场景
专
刊
问题，安全分析人员可以使用基线分析和数据集的其他参数，推导 1、攻击步骤
出额外的阀值进行更精准的匹配，提高效能。 …
4、告警以及分析样例
告警样例：如下图告警所示，告警样例中可以清晰的显示到源地址