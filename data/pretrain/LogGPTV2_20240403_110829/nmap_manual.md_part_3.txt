### UDP探测与ICMP响应
当目标机器的端口关闭时，UDP探测应立即收到一个ICMP端口不可达的回应报文。对于Nmap而言，这表明该机器处于运行状态。其他类型的ICMP错误，如主机/网络不可达或TTL超时，则表示主机可能已关闭或无法访问。同样，没有回应也会被解释为上述情况之一。如果到达的是一个开放的端口，大多数服务会忽略空报文而不做任何回应。因此，默认情况下，Nmap使用31338端口进行探测，因为这个端口极不可能被使用。少数服务，例如chargen，会对空UDP报文做出响应，从而向Nmap表明该机器正在运行。

此扫描类型的主要优势在于它能够穿透仅过滤TCP流量的防火墙和过滤器。例如，Linksys BEFW11S4无线宽带路由器默认配置下对外网卡会过滤所有TCP端口，但UDP探测仍能触发端口不可达的消息，进而暴露其存在。

### ICMP Ping类型 (-PE, -PP, -PM)
除了上述不太常见的TCP和UDP主机发现方法，Nmap还支持发送类似于传统ping程序所使用的ICMP回声请求（type 8）报文至目标IP地址，并期待从活动主机处收到回声应答（type 0）。不幸的是，许多主机及防火墙现在会阻止这些报文，而非按预期那样作出响应。因此，在互联网环境中单独依赖ICMP扫描通常不够有效。但对于内部网络监控来说，这种方法可能是实用的。启用-PE选项即可激活这项功能。

尽管回声请求是标准的ICMP ping查询，Nmap并不局限于此。根据ICMP标准([RFC 792](http://www.rfc-editor.org/rfc/rfc792.txt){target="_top"})，还有时间戳请求、信息请求以及地址掩码请求等其他形式，它们分别对应代码13、15和17。虽然这些查询主要用于获取诸如地址掩码或当前时间之类的信息，但也可以用于主机发现。简单来说，回复此类请求的系统即为活跃状态。目前，Nmap尚未实现信息请求报文，因为其支持度较低；而时间戳与地址掩码查询则可通过-PP和-PM选项发送。如果管理员特别封锁了回声请求报文却忽略了其他ICMP查询的可能性，那么这两种查询就显得尤为有用。

### ARP Ping (-PR)
在以太局域网中执行扫描是Nmap最常见的应用场景之一。特别是在那些采用[RFC1918](https://tools.ietf.org/html/rfc1918)私有地址范围的网络里，大部分IP地址在特定时刻都是未被使用的。当尝试发送原始IP数据包如ICMP回声请求时，操作系统必须首先通过ARP协议确定目标IP对应的物理地址以便正确地将帧转发给指定设备。这一过程往往较慢且容易出现问题，原因在于操作系统设计者并未预料到短时间内需要对大量不在线设备发起数百万次ARP请求。然而，在进行ARP扫描时，Nmap利用优化算法管理ARP请求，一旦接收到响应便无需再担心基于IP的ping操作，因为此时已经确认目标主机处于活跃状态。因此，相较于基于IP的扫描方式，ARP扫描更为快速可靠。所以，默认情况下，若Nmap检测到目标位于同一局域网内，则会自动执行ARP扫描。即使指定了不同的ping类型（比如-PI或-PS），Nmap也会优先对局域网内的目标使用ARP扫描。如果您确实不需要ARP扫描，请指定\--send-ip参数。

### 域名解析选项 (-n, -R, --system-dns)
- **-n (禁用域名解析)**: 指示Nmap不要对发现的任何活动IP地址执行反向DNS查找。由于DNS查询通常耗时较长，这样做可以加快整体扫描速度。
- **-R (始终解析域名)**: 强制Nmap总是对目标IP地址执行反向DNS查找，通常仅当确认主机在线后才会执行此步骤。
- **--system-dns (使用系统DNS解析器)**: 默认情况下，Nmap直接向您的计算机上配置的DNS服务器发送查询请求以提高性能，同时并发处理多个请求。若您希望改用系统自带的解析器（一次只能解析一个IP地址），则可启用此选项。除非遇到Nmap DNS代码中的bug（如有，请联系我们），否则一般不建议使用此选项，因为它会显著降低效率。对于IPv6扫描，系统解析器总是首选。

### 端口扫描基础
Nmap最初是一个高效的端口扫描工具，尽管随着时间推移其功能得到了扩展，端口扫描仍然是核心能力之一。执行`nmap *`命令可以针对主机*上的超过1660个TCP端口进行扫描。不同于仅报告端口是否开放的传统扫描工具，Nmap提供了更加细化的状态分类：open（开放）、closed（关闭）、filtered（被过滤）、unfiltered（未被过滤）、open|filtered（开放或被过滤）以及closed|filtered（关闭或被过滤）。这些状态反映了Nmap如何评估各个端口的状态。例如，同一个目标机器上的135/tcp端口，在同网络扫描时可能显示为开放，而在跨网络相同设置下则可能显示为被过滤。

#### 端口状态详解
- **Open (开放)**: 表示应用程序正在监听该端口接收TCP连接或UDP消息。这是安全扫描的主要目标之一。
- **Closed (关闭)**: 虽然端口无应用程序监听，但仍可访问并响应Nmap探测。这类端口有助于判断主机是否在线，并辅助某些操作系统识别任务。
- **Filtered (被过滤)**: 由于包过滤机制阻止探测报文到达端口，Nmap无法确定其确切状态。这种状态让攻击者难以获取有用信息。
- **Unfiltered (未被过滤)**: 说明端口可访问，但Nmap无法区分其为开放还是关闭。只有ACK扫描会产生这种结果。
- **Open|Filtered (开放或被过滤)**: 当Nmap不能明确判断端口状态时，将其归类为此种状态。这种情况常见于无响应的开放端口或被丢弃的数据包。
- **Closed|Filtered (关闭或被过滤)**: 仅出现在IP ID Idle扫描过程中，表明Nmap无法分辨端口是关闭还是被过滤。

### 端口扫描技术
掌握多种端口扫描技巧是成为专家的关键。新手用户往往只依赖默认的SYN扫描，而资深人士则会选择最适合当前需求的技术组合。随着Nmap的发展及其免费提供的特性，唯一限制用户的就是知识水平。大多数高级扫描功能都需要root权限才能运行，这是因为它们涉及发送和接收原始数据包的操作。然而，如今个人电脑普及率高，拥有独立系统的用户越来越多，使得使用Nmap变得更加方便。

接下来的部分将详细介绍Nmap支持的大约十几种不同类型的扫描技术。通常每次只会选用一种方法，不过UDP扫描(-sU)可以与其他任意TCP扫描类型结合使用。需要注意的是，非特权用户仅能执行connect()调用和FTP反弹扫描两种非特权限制下的扫描类型。