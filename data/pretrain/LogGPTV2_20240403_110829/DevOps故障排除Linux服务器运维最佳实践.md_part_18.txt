时候，BIND 就会排除该区域。
BIND，BIND 使用分号作为注释的开头。在区域文件中，除了使用
/etc/bind/db.example.net的第20行。这里出现的是一个常见的错误：
确定区域传输问题最快速的方法就是使用类似于 dig 的工具对
区域传输问题我们讨论的最后一个导致 DNS 更改没有起作用
在这个例子中，错误消息的第一行友好地告诉我们错误在文件
$dig example.net SOA
Mar 27 21:07:26 snowball named[25967]: zone example.net/IN: not loaded due to errors.
；>DiG 9.7.0-P1> example.net SOA
Mar 2721:07:26ns1 named[25967]:/etc/bind/db.example.net:20:#ns2.example.net:bad owner
db.example.net failed:bad owner name （check-names)
name(check-names)
---
## Page 114
这个域管理员的联系邮箱。第一个句点需要用@ 替换，所以在这个
net。其下一条记录admin.example.net并不是另一个名称服务器而是
从这几行中可以看到，经过授权的DNS服务器是ns1.example.
在这个输出中，
;;flags: qr a rd ra; QUERY: 1, ANSWER:1, AUTHORITY: 2,ADITIONAL: 2
ns2.example.net.
example.net.
:；AUTHORITY SECTION:
;; QUESTION SECTION:
;;->>HEADER<<- opcode: QUERY， status: NOERROR， id:62609
;；Got answer:
ANSWER SECTION:
；;MSG SIZE rcvd:143
;WHEN:Tue Mar 2721:18:462012
:; Query time: 35 msec
example.net
example.net.
:；ANSWER SECTION:
;;global options:+cmd
example.net.
:; SERVER: 192.168.0.1#53(192.168.0.1)
nsl.example.net.
:；ADDITIONAL SECTION:
;example.net.
2011062300 1080020006048007200
2011062300 108002000 6048007200
，我们对下面这几行特别有兴趣：
300
300
30
NI
SOA
A
SOA
1
M
10.1.1.4
10.1.1.3
nsl.example.net.admin.example.net.
ns1.example.net. admin.example.net.
ns1.example.net.
ns2.example.net.
6.2DNS 服务器故障排除
107
---
## Page 115
108
重启 BIND守护进程。最后，检查BIND 的name.conf和其余的区
例子中，管理员的联系方式就是PI:EMAIL。
是否正在运行：
器上的配置是否正确。首先，使用类似如下的命令看看named进程
该显示出检测到了对应的更改并发出通知：
以我们将会讨论如何确定每个问题。
部分区域传输，这样它就能获得更新。区域传输请求返回到主服务
务器上的序列号，那么从服务器将会发出一个请求，要求全部或者
主域名服务器将会发送一个配置在区域文件内、每次随着区域文件
称服务器外，还配置了额外的名称服务器列表，它也会通知它们。
务器的记录，BIND 都会针对NS记录扫描整个区域并通知其中的每
题，那么下一步就是直接登录主DNS 服务器，检查它的配置。
服务器就应该配置为主域名服务器。如果怀疑出现了区域传输问
·第6章为什么主机名无法解析？解决DNS服务器的问题
会开启区域传输。上述步骤中任何一个问题都会导致更新失败，所
下，区域内配置的所有名称服务器都允许访问)，然后主名称服务器
器，告知主服务器它来自一个允许区域传输的IP地址（默认情况
的更改自增长的序列号。如果主域名服务器上的序列号大于从属服
从主域名服务器发出的，它们就会忽略这个通知。根据这个通知，
从属名称服务器会被配置为知道谁是主域名服务器，如果通知不是
个名称服务器，告知这里有一个更新。如果BIND 除了区域内的名
在你对一个区域作了更改并重载了BIND 后，主域名服务器应
BIND 中区域传输的工作方式是：在任何时间更新到主域名服
一旦你知道哪个名称服务器是该区域的权限服务器，
如果没有运行，启动服务。如果未能恰当地重载，也可以选择
$ps-ef|grepnamed
如果你在日志中看不到通知发出的迹象，那么应该看看主服务
Mar2721:47:16ns1named[25967]:zone example.net/IN:sending notifies (serial 2012032700)
Mar 2721:47:16ns1 named[25967]:zone example.net/IN:1oaded serial 2012032700
，那么这个
---
## Page 116
件中看到显示出接收到区域已经更改的通知：
notify指令中（如果配置了的话）。
置在它们自己的NS条目中，要么配置在named.conf文件的also-
在主服务器上，请确保所有需要更新的名称服务器要么在区域内配
更新一百次，而且还能轻松地看到区域上次修改的时间)。如果发出
YYYYMMDD外加额外两个数字的格式，这样他们不仅能在一天内
的区域文件，
之一起更改。
主服务器上面的 BIND时，你可能会在日志中看到如下错误：
是从服务器。
域配置文件，
看到区域传输的初始化，那么下一步就是查看从属名称服务器。应
每个名称服务器都有这样一个条目，如果没看到这个条目且又是
10.1.1.4开始，然后也终于此。你应该会看到在这个区域上配置的
的日志文件中将会看到如下几行：
了通知，而且序列号比从属服务器的序列号大，那么在主服务器中
区域传输失败最常见的一个错误是序列号没有更新。当你重载
如果主服务器上的日志文件和配置看起来没错，但却还是无法
从上面几行中可以看到，已更改的区域文件的传输从客户端
Mar 27 21:47:16 ns1 named[25967]: client 10.1.1.4#38239: transfer of 'example.net/IN':
Mar 2721:09:52 ns1 named[25967]:zone example.net/IN:zone serial(2012011301)unchanged.
Mar 27 21:47:16 ns1 named[25967]: client 10.1.1.4#38239: transfer of *example.net/IN':
在这个例子中有一个警告，序列号在区域更改的时候没有随
Mar 2721:09:52 ns1named[25967]:zone example.net/IN:sending notifies (serial 2012011301)
Mar 27 21:09:52 ns1 named[25967]: zone example.net/IN:loaded serial 2012011301
→AXFR-style IXFR ended
AXFR-style IXFR started
zone may fail to transfer to slaves.
，确保序列号也相应地增长（很多DNS管理员使用
。如果你看到类似的信息，只需简单地重新修改你
同时确定这个特定的区域被配置成一个主服务器而不
6.2DNS服务器故障排除·109
---
## Page 117
些文件存储在BIND中配置的位置，常见的位置有/var/cache/bind、
是登录到从属服务器中，查看该区域的本地缓存区域文件。它将这
到这个错误，然后发出了一个更新通知。当下一个管理员查看的时
作为序列号，但是无意间设置了一个错误的年份），但是却没有意识
许无意间在主服务器中设置了一个非常大的序列号（比如使用日期
是从属服务器拒绝接受这个更新。发生这种情况的时候，解决方法
候，通过将序列号重新设置为当前日期的方法修复了这个错误，但
比从属服务器中的序列号大，所以它不会触发更新操作。管理员也
成一个从属服务器且主服务器的IP 被配置成主服务器IP之一。
知。在这个例子中，如果IP是正确的主服务器IP，那么你需要看
看BIND 中针对这个区域的这台从属服务器的配置，确保它被配置
子中是10.1.1.7）的机器中得到了一条通知，所以它拒绝了这个通
你可能会看到如下日志：
第6章
在这个例子中，通知发送到了从属服务器中，但是序列号并不
这里显示出从属服务器自一个未被配置为主服务器（这个例
另一方面，你可能会看到如下的日志：
从上面的日志中可以看出成功地完成了区域传输过程。然而，
Mar 2721:58:45ns2named[22774]:zone example.net/IN/external:refused notify from non-
Mar 2722:09:00 ns2named[22774]:zone example.net/IN/external:notify from10.1.1.3#42895
Mar 2722:09:00 ns2named[22774]:client 10.1.1.3#42895:view external:received notify for
Mar 27 21:58:44 ns2 named[22774]:transfer of'example.net/IN' from 10.1.1.3#53:end of
Mar 27 21:58:44 ns2 named[22774]:zone example.net/IN/external:transferred serial
Mar 27 21:58:44 ns2 named[22774]: transfer of'example.net/IN' from 10.1.1.3#53: connected
Mar 2721:58:44 ns2 named[22774]:client 10.1.1.3#50946:view external:received notify for
→master: 10.1.1.7#35615
→transfer
→zone is up to date
zone'exampTe.net
2012032700
→using 10.1.1.3#38239
zone'example.net'
为什么主机名无法解析？解决DNS服务器的问题
---
## Page 118
更新到最新的状态。
删除这个文件或者把这个文件放到别的地方，然后重启从属服务器
部，你会看到设置的序列号。如果序列号过大，最简单的方法就是
区域的全部记录，这与配置在主服务器中的记录很像，在文件的顶
上的 BIND，之后 BIND 服务会从主服务器上请求区域传输将文件
Vetc/bind和/var/lib/bind文件夹。
。当你打开这个文件的时候，会看到
6.2DNS服务器故障排除·111
---
## Page 119
的文档。在本章结尾的时候，你应该掌握追踪邮件为什么无法投递
或POP问题诊断感兴趣，我建议你翻阅专注IMAP或POP服务器
时因为技术差异很大，所以本章仅专注于SMTP。如果你对IMAP
IMAP和POP故障排除方法非常不同，这取决于它们的服务器，同
是处理与邮件投递相关的常规问题在所有的服务器上都一样。因为
SMTP（邮件传输协议，SendmailTransferProtocol）发送和接收邮件
一名常规的邮件用户，最后你都不得不回答下面的问题：
为什么无法收发邮件？追踪邮件问题
与用POP和IMAP等协议的问题不同。虽然有很多邮件服务器，但
的相关问题。这一类问题的故障排除方法相互之间都有联系，但是
公室里的技术达人、在应用中添加邮件支持的开发者，或者仅仅是
角色，如果你负责邮件服务，不论是邮件服务器的管理项，还是办
务，而且出现问题的时候也很在意。不管你在DevOps 中担任什么
第7章
口我发送了一封邮件，但是收件人却没有接收到，怎么回事？
本章，我们将会讨论如何处理邮件问题，尤其是如何解决使用
与DNS不同的是，大多数人都会直接并且频繁地使用邮件服
口某人给我发了一封邮件，但是我却没收到，怎么回事？
与DNS一样，邮件也是互联网上古老而又广泛使用的服务之
---
## Page 120
mail.example.net）应该配置成允许我们通过它回复邮件。那些允许
假设所有数据都存储在公司名为mail.example.net的邮件服务器中。
件，使用某个桌面邮件客户端（如Thunderbird或者Outlook），同时
邮件的时候，你最好基于一个简单、一般的例子。
件提供商来说，邮件的发送方式仍然相当类似，所以当你追踪一封
收取邮件，他们的系统可能相当复杂。事实上，即便对于复杂的邮
件传输的每一步，更好地了解哪一步出现了错误。
本机到收件人之间的路径，那么当出现问题的时候，你就能检查邮
你发送邮件的时候，都发生了什么事情。如果你能手动追踪邮件从
7.1追踪邮件请求
的技术和工具(越多越好）。
件。一些服务器是通过IP来限制，另一些需要客户登录并输人密码
器，因为垃圾邮件制造者会寻找并使用开放邮件服务器发送垃圾邮
任何人通过它们回复邮件的邮件服务器被称为开放传递邮件服务
（并不要求这样）获取邮件的服务器。这个外部邮件服务器（名为
务器可能是办公室中的本地邮件服务器，甚至也可能是通过IMAP
协议与它配置的外部邮件服务器通信。在这个例子中，外部邮件服
邮件服务器视为网上常见的邮件服务器。
为我们不知道Google邮件服务器的内部工作机制，所以我们将这个
我们想向个人Gmail账号（如PI:EMAIL）发送一封邮件，因
进行授权。
件，所以绝大多数邮件服务器都限制了谁可以通过它们来回复邮
首先单击“发送”按钮，然后我们的邮件客户端会使用SMTP
建立邮件系统的方法有很多种，如果你从大型邮件提供商那里
例如，假设我们想用公司账号PI:EMAIL发送一封邮
在深人到如何解决特定的邮件问题之前，首先最好要了解下当
7.1追踪邮件请求·113
---
## Page 121
114
·第7章为什么无法收发邮件？追踪邮件问题
产生问题。
example.net将会重新将邮件放人队列，稍后再试。大多数邮件服务
将会在gmail.com邮件服务器列表剩余的服务器中选择优先级数
smtp-in.l.google.com）服务器。一旦选择了要通信的服务器，它就会
有优先级数值最低的（在这个例子中是优先级数值为5的gmail-
dig gmail.com MX)，之后会得到如下的返回结果：
然后执行一个 DNS查询，找到 gmail.com全部MX记录（类似于
器都不可用的话（或者由于邮件服务器的网络问题导致无法访问它
值最低的服务器。如果没有一个邮件服务器可以使用，那么mail
通过端口25初始化一个SMTP连接。
邮件服务器都有一个优先级。mail.example.net服务器将会选择带
会为目标域（这个例子中是gmail.com）扫描FROM（发件人）地址。
待投递的邮件一起放在邮件池中。当它准备好发送邮件的时候，就
于很多用户习惯了邮件即时投递，所以即便一小时的延迟也可能会
件好事，因为你应该会喜欢邮件服务器不断尝试发送邮件。但是由
们)，那么在邮件退回之前可能需要花费很长时间。一般来说，这是
能成功投递。这一点很重要，因为如果一个远程域所有的邮件服务
发送邮件的时候，它会发送一封回退电子邮件，告诉你这个邮件未