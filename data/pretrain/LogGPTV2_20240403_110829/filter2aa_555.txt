Jesse
Michael
Mickey
Shkatov
@JesseMichael
@HackingThings
WHO ARE WE
AGENDA
• Beginning
• .
• .
• .
• .
• Conclusions
• Q&A
•
Diego Juarez
•
https://www.secureauth.com/labs/advisories/asus-drivers-elevation-privilege-vulnerabilities
•
https://www.secureauth.com/labs/advisories/gigabyte-drivers-elevation-privilege-vulnerabilities
•
https://www.secureauth.com/labs/advisories/asrock-drivers-elevation-privilege-vulnerabilities
•
@ReWolf
•
https://github.com/rwfpl/rewolf-msi-exploit  + Blog post link in Readme
•
@NOPAndRoll (Ryan Warns) / Timothy Harrison
•
https://downloads.immunityinc.com/infiltrate2019-slidepacks/ryan-warns-timothy-harrison-device-
driver-debauchery-msr-madness/MSR_Madness_v2.9_INFILTRATE.pptx
•
@SpecialHoang
•
https://medium.com/@fsx30/weaponizing-vulnerable-driver-for-privilege-escalation-gigabyte-edition-
e73ee523598b
PRIOR WORK
BACKGROUND
Application
Windows 
OS
Driver
Device
BACKGROUND
Application
Windows 
OS
Driver
Device
REQUEST
MAGIC
REQUEST
DeviceIoControl(dev, ioctl, inbuf, insize, ...)
IOCTL handler in driver called with IRP struct
•
contains args passed from userspace
2.3. Windows drivers
2.3.1. Signed 
2.3.2. WHQL signed
2.3.3. EV signing cert (A Must for Win10 signing process)
Briefly explain the process of signing code
HOW IT’S MADE
• RWEverything
• LoJax
• Slingshot
• Game Cheats and Anti-Cheats (CapCom and others)
• MSI+ASUS+GIGABYTE+ASROCK
KNOWN THREATS
• Utility to access almost all hardware interfaces via software
• User-space app + signed RwDrv.sys driver
• Driver acts as a privileged proxy to hardware interfaces
• Allows arbitrary access to privileged resources not intended 
to be available to user-space
• CHIPSEC helper to use RwDrv.sys when available
Read & Write Everything
• First UEFI malware found in the wild
• Implant tool includes RwDrv.sys driver from RWEverything
• Loads driver to gain direct access to SPI controller in PCH
• Uses direct SPI controller access to rewrite UEFI firmware
LoJax
• APT campaign brought along its own malicious driver
• Active from 2012 through at least 2018
• Exploited other drivers with read/write MSR to bypass Driver 
Signing Enforcement to install kernel rootkit
Slingshot
1. Privilege escalation from Userspace to Kernelspace
2. Bypass/disable Windows security mechanisms
3. Direct hardware access
•
Can potentially rewrite firmware
Motivations
1.
Driver is already on system and loaded
•
Access to driver is controlled by policy configured by driver itself
•
Many drivers allow access by non-admin
2.
Driver is already on system and not loaded
•
Need admin privs to load driver
•
Can also wait until admin process loads driver to avoid needing admin privs
3.
Malware brings driver along with it
•
Need admin privs to load driver
•
Can bring older version of driver
•
Lojax did this for in-the-wild campaign
Attack Scenarios
1. Signed drivers
2. Focused on drivers from firmware/hardware vendors
3. Size (MajorFunction[14]
•
Explore states forward from driver entry point
Automating Detection
•
Problems...
•
Current code only supports WDM drivers
•
Have some ideas how to support WDF drivers
•
Angr uses VEX intermediate representation lifting
•
VEX is part of Valgrind
•
Has apparently never been used to analyze privileged code
•
Decode error on rdmsr/wrmsr, read/write CR, read/write DR opcodes
•
Some drivers cause it blow up and use 64GB of ram
DISCLOSURES
DISCLOSURES
DISCLOSURES
•
Ask Microsoft what’s their policy regarding bad drivers
•
Not a security issue, open a regular ticket
•
This might be an issue, are you sure?
•
Meh, Not an issue
•
Are you REALLY, REALLY, sure?
•
Ok, let us check
•
…
•
Ok, We will do something about it
•
THANK YOU!
•
Sent disclosure Friday 5pm
•
Response came back Saturday morning
•
Fix ready to start deployment in 6 weeks
DISCLOSURES
All the primitives in one driver
•
Physical and virtual memory read/write
•
Read/Write MSR
•
Read/Write CR
•
Legacy Read/Write PCI via IN/OUT
•
IN/OUT
DISCLOSURES
ADVISORIES
Vendor
Date
Advisory
Intel
July 9, 2019
https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-
00268.html
Huawei
July 10, 2019
https://www.huawei.com/fr/psirt/security-advisories/huawei-sa-20190710-01-
pcmanager-en
Phoenix
TBD
TBD
REDACTED
Aug 13, 2019
TBD
REDACTED
TBD
TBD
NO RESPONSE
Microsoft Statement
•
Microsoft has a strong commitment to security and a demonstrated track 
record of investigating and proactively updating impacted devices as soon 
as possible. For the best protection, we recommend using Windows 10 and 
the Microsoft Edge browser.
•
In order to exploit vulnerable drivers, an attacker would need to have 
already compromised the computer. To help mitigate this class of issues, 
Microsoft recommends that customers use Windows Defender Application 
Control to block known vulnerable software and drivers.
•
Customers can further protect themselves by turning on memory integrity 
for capable devices in Windows Security.
• Bad drivers can be immensely dangerous
• Risk remains when old drivers can still be loaded by Windows
• We want to kill off this entire bug class
Conclusions
• GitHub release of all of our code
• https://github.com/eclypsium/Screwed-Drivers
Code release
Questions?