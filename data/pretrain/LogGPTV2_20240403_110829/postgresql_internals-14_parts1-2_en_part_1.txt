Egor Rogov
PostgreSQL 14
Internals
ThesearePartsI&IIofthebook.
Theotherpartswillfollowsoon:
III. Locks
IV. QueryExecution
V. IndexTypes
PostgresProfessional
Moscow,
TheelephantonthecoverisafragmentofanillustrationfromEdwardTopsell’s
TheHistoryofFour-footedBeastsandSerpents,publishedinLondonin
PostgreSQL14Internals
byEgorRogov
TranslatedfromRussianbyLiudmilaMantrova
©PostgresProfessional,2022
Thisbookinisavailableatpostgrespro.com/community/books/internals
Contents at a Glance
AboutThisBook . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9
1. Introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
PartI.IsolationandMVCC 35
2. Isolation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37
3. PagesandTuples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 64
4. Snapshots . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 86
5. PagePruningandHOTUpdates . . . . . . . . . . . . . . . . . . . . . . . . 100
6. VacuumandAutovacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . 112
7. Freezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 137
8. RebuildingTablesandIndexes . . . . . . . . . . . . . . . . . . . . . . . . 150
PartII.BufferCacheandWAL 161
9. BufferCache . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163
10.Write-AheadLog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183
11.WALModes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203
Index . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 219
3
Table of Contents
AboutThisBook 9
1. Introduction 15
1.1. DataOrganization . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
Databases . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15
SystemCatalog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
Schemas . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
Tablespaces . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18
Relations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19
FilesandForks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20
Pages . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24
TOAST . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24
1.2. ProcessesandMemory . . . . . . . . . . . . . . . . . . . . . . . . . . 29
1.3. ClientsandtheClient-ServerProtocol . . . . . . . . . . . . . . . . . 31
Part I. Isolation and MVCC 35
2. Isolation 37
2.1. Consistency . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37
2.2. IsolationLevelsandAnomaliesDefinedbytheSQLStandard . . . . 39
LostUpdate . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40
DirtyReadsandReadUncommitted . . . . . . . . . . . . . . . . . . 40
Non-RepeatableReadsandReadCommitted . . . . . . . . . . . . . 41
PhantomReadsandRepeatableRead. . . . . . . . . . . . . . . . . . 41
NoAnomaliesandSerializable . . . . . . . . . . . . . . . . . . . . . 42
WhyTheseAnomalies? . . . . . . . . . . . . . . . . . . . . . . . . . 42
2.3. IsolationLevelsinPostgreSQL . . . . . . . . . . . . . . . . . . . . . 43
ReadCommitted . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 44
RepeatableRead . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53
Serializable . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59
2.4. WhichIsolationLeveltoUse? . . . . . . . . . . . . . . . . . . . . . . 62
4
TableofContents
3. PagesandTuples 64
3.1. PageStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 64
PageHeader . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 64
SpecialSpace . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65
Tuples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65
ItemPointers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66
FreeSpace. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67
3.2. RowVersionLayout . . . . . . . . . . . . . . . . . . . . . . . . . . . 67
3.3. OperationsonTuples . . . . . . . . . . . . . . . . . . . . . . . . . . 69
Insert . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70
Commit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73
Delete . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75
Abort . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76
Update. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 77
3.4. Indexes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 78
3.5. TOAST . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
3.6. VirtualTransactions . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
3.7. Subtransactions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
Savepoints . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
ErrorsandAtomicity . . . . . . . . . . . . . . . . . . . . . . . . . . . 83
4. Snapshots 86
4.1. WhatisaSnapshot? . . . . . . . . . . . . . . . . . . . . . . . . . . . 86
4.2. RowVersionVisibility . . . . . . . . . . . . . . . . . . . . . . . . . . 87
4.3. SnapshotStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . 88
4.4. VisibilityofTransactions’OwnChanges . . . . . . . . . . . . . . . . 92
4.5. TransactionHorizon . . . . . . . . . . . . . . . . . . . . . . . . . . . 94
4.6. SystemCatalogSnapshots . . . . . . . . . . . . . . . . . . . . . . . . 97
4.7. ExportingSnapshots . . . . . . . . . . . . . . . . . . . . . . . . . . . 98
5. PagePruningandHOTUpdates 100
5.1. PagePruning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100
5.2. HOTUpdates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104
5.3. PagePruningforHOTUpdates . . . . . . . . . . . . . . . . . . . . . 107
5.4. HOTChainSplits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 109
5.5. PagePruningforIndexes . . . . . . . . . . . . . . . . . . . . . . . . 110
5
TableofContents
6. VacuumandAutovacuum 112
6.1. Vacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 112
6.2. DatabaseHorizonRevisited . . . . . . . . . . . . . . . . . . . . . . . 115
6.3. VacuumPhases . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118
HeapScan . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118
IndexVacuuming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 118
HeapVacuuming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 119
HeapTruncation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 120
6.4. Analysis . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 120
6.5. AutomaticVacuumandAnalysis . . . . . . . . . . . . . . . . . . . . 121
AbouttheAutovacuumMechanism. . . . . . . . . . . . . . . . . . . 121
WhichTablesNeedtobeVacuumed? . . . . . . . . . . . . . . . . . . 123
WhichTablesNeedtoBeAnalyzed? . . . . . . . . . . . . . . . . . . 125
AutovacuuminAction . . . . . . . . . . . . . . . . . . . . . . . . . . 126
6.6. ManagingtheLoad . . . . . . . . . . . . . . . . . . . . . . . . . . . . 130
VacuumThrottling . . . . . . . . . . . . . . . . . . . . . . . . . . . . 130
AutovacuumThrottling . . . . . . . . . . . . . . . . . . . . . . . . . 131
6.7. Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 132
MonitoringVacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . 132
MonitoringAutovacuum . . . . . . . . . . . . . . . . . . . . . . . . . 135
7. Freezing 137
7.1. TransactionIDWraparound . . . . . . . . . . . . . . . . . . . . . . . 137
7.2. TupleFreezingandVisibilityRules . . . . . . . . . . . . . . . . . . . 138
7.3. ManagingFreezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . 141
MinimalFreezingAge . . . . . . . . . . . . . . . . . . . . . . . . . . 142
AgeforAggressiveFreezing . . . . . . . . . . . . . . . . . . . . . . . 143
AgeforForcedAutovacuum . . . . . . . . . . . . . . . . . . . . . . . 145
AgeforFailsafeFreezing . . . . . . . . . . . . . . . . . . . . . . . . . 147
7.4. ManualFreezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 147
FreezingbyVacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . 148
FreezingDataattheInitialLoading . . . . . . . . . . . . . . . . . . 148
8. RebuildingTablesandIndexes 150
8.1. FullVacuuming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 150
WhyisRoutineVacuumingnotEnough? . . . . . . . . . . . . . . . . 150
EstimatingDataDensity . . . . . . . . . . . . . . . . . . . . . . . . . 151
6
TableofContents
Freezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 154
8.2. OtherRebuildingMethods. . . . . . . . . . . . . . . . . . . . . . . . 156
AlternativestoFullVacuuming . . . . . . . . . . . . . . . . . . . . . 156
ReducingDowntimeduringRebuilding. . . . . . . . . . . . . . . . . 156
8.3. PreventiveMeasures . . . . . . . . . . . . . . . . . . . . . . . . . . . 157
Read-OnlyQueries . . . . . . . . . . . . . . . . . . . . . . . . . . . . 157
DataUpdates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 158
Part II. Buffer Cache andWAL 161
9. BufferCache 163
9.1. Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163
9.2. BufferCacheDesign . . . . . . . . . . . . . . . . . . . . . . . . . . . 164
9.3. CacheHits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 166
9.4. CacheMisses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 170
BufferSearchandEviction. . . . . . . . . . . . . . . . . . . . . . . . 171
9.5. BulkEviction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 173
9.6. ChoosingtheBufferCacheSize . . . . . . . . . . . . . . . . . . . . . 176
9.7. CacheWarming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 179
9.8. LocalCache . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181
10.Write-AheadLog 183
10.1. Logging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183
10.2. WALStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184
LogicalStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184
PhysicalStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188
10.3. Checkpoint . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189
10.4. Recovery . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193
10.5. BackgroundWriting . . . . . . . . . . . . . . . . . . . . . . . . . . . 196
10.6. WALSetup . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197
ConfiguringCheckpoints . . . . . . . . . . . . . . . . . . . . . . . . 197
ConfiguringBackgroundWriting . . . . . . . . . . . . . . . . . . . . 200
Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 200
11.WALModes 203
11.1. Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203
7
TableofContents
11.2. FaultTolerance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 207
Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 207
DataCorruption . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
Non-AtomicWrites . . . . . . . . . . . . . . . . . . . . . . . . . . . . 211
11.3. WALLevels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213
Minimal . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 214
Replica . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216
Logical. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218
Index 219
8
About This Book
Booksarenotmadetobebelieved,buttobe
subjectedtoinquiry.
—UmbertoEco,TheNameoftheRose
For Whom Is This Book?
This book is for those who will not settle for a black-box approach when work-
ingwithadatabase. Ifyouareeagertolearn,prefernottotakeexpertadvicefor
granted,andwouldliketofigureouteverythingyourself,followalong.
IassumethatthereaderhasalreadytriedusingPostgreandhasatleastsome
general understanding of how it works. Entry-level users may find the text a bit
difficult.Forexample,Iwillnottellanythingabouthowtoinstalltheserver,enter
psqlcommands,orsetconfigurationparameters.
I hope that the book will also be useful for those who are familiar with another
databasesystem,butswitchovertoPostgreandwouldliketounderstandhow
they differ. Abook like this would have saved me a lot of time several years ago.
Andthat’sexactlywhyIfinallywroteit.
What This Book Will Not Provide
Thisbookisnotacollectionofrecipes. Youcannotfindready-madesolutionsfor
everyoccasion,butifyouunderstandinnermechanismsofacomplexsystem,you
willbeabletoanalyzeandcriticallyevaluateotherpeople’sexperienceandcome
to your own conclusions. For this reason,I explain such details that may at first
seemtobeofnopracticaluse.
But this book is not a tutorial either. While delving deeply into some fields (in
whichIammoreinterestedmyself),itmaysaynothingatallabouttheother.
9
AboutThisBook
By no means is this book a reference. I tried to be precise, but I did not aim at
replacingdocumentation,soIcouldeasilyleaveoutsomedetailsthatIconsidered
insignificant.Inanyunclearsituationreadthedocumentation.
ThisbookwillnotteachyouhowtodevelopthePostgrecore. Idonotexpect
any knowledge of the C language, as this book is mainly intended for database
administratorsandapplicationdevelopers.ButIdoprovidemultiplereferencesto
thesourcecode,whichcangiveyouasmanydetailsasyoulike,andevenmore.
What This Book Does Provide
Intheintroductorychapter,Ibrieflytouchuponthemaindatabaseconceptsthat
will serve as the foundation for all the further narration. I do not expect you to
get much new information from this chapter but still include it to complete the
bigpicture.Besides,thisoverviewcanbefoundusefulbythosewhoaremigrating
fromotherdatabasesystems.
PartIisdevotedtoquestionsofdataconsistencyandisolation. Ifirstcoverthem
fromtheuser’sperspective(youwilllearnwhichisolationlevelsareavailableand
what are the implications) and then dwell on their internals. For this purpose,
Ihavetoexplainimplementationdetailsofmultiversionconcurrencycontroland
snapshotisolation,payingspecialattentiontocleanupofoutdatedrowversions.
PartIIdescribesbuffercacheand,whichisusedtorestoredataconsistency
afterafailure.
Part III goes into details about the structure and usage of various types of locks:
lightweightlocksfor,heavyweightlocksforrelations,androw-levellocks.
PartIVexplainshowtheserverplansandexecutesqueries.Iwilltellyouwhich
dataaccessmethodsareavailable,whichjoinmethodscanbeused,andhowthe
collectedstatisticsareapplied.
PartVextendsthediscussionofindexesfromthealreadycoveredB-treestoother
accessmethods. Iwillexplainsomegeneralprinciplesofextensibilitythatdefine
the boundaries between the core of the indexing system, index access methods,
anddatatypes(whichwillbringustotheconceptofoperatorclasses),andthen
elaborateoneachoftheavailablemethods.
10
Conventions
Postgre includes multiple “introspective” extensions, which are not used in
routinework,butgiveusanopportunitytopeekintotheserver’sinternalbehav-
ior. Thisbookusesquiteafewofthem. Apartfromlettingusexploretheserver
internals, these extensions can also facilitate troubleshooting in complex usage
scenarios.
Conventions
Itriedtowritethisbookinawaythatwouldallowreadingitpagebypage,from
starttofinish.Butitishardlypossibletouncoverallthetruthatonce,soIhadto
getbacktooneandthesametopicseveraltimes.Writingthat“itwillbeconsidered
later”overandoveragainwouldinevitablymakethetextmuchlonger,that’swhy
insuchcasesIsimplyputthepagenumberinthemargintoreferyoutofurther p.
discussion. Asimilarnumberpointingbackwardswilltakeyoutothepagewhere
somethinghasbeenalreadysaidonthesubject.
BoththetextandallthecodeexamplesinthisbookapplytoPostgre. Next
tosomeparagraphs,youcanseeaversionnumberinthepagemargin. Itmeans v.
thattheprovidedinformationisrelevantstartingfromtheindicatedPostgre
version,while all the previous versions either did not have the described feature
atall,orusedadifferentimplementation. Suchnotescanbeusefulforthosewho
havenotupgradedtheirsystemstothelatestreleaseyet.
Ialsousethemarginstoshowthedefaultvaluesofthediscussedparameters.The
namesofbothregularandstorageparametersareprintedinitalics: work_mem. 4MB
Infootnotes,Iprovidemultiplelinkstovarioussourcesofinformation. Thereare
severalofthem,butfirstandforemost,IlistthePostgredocumentation,1which
isawellspringofknowledge.Beinganessentialpartoftheproject,itisalwayskept
up-to-datebyPostgredevelopersthemselves. However,theprimaryreference
is definitely the source code.2 It is amazing how many answers you can find by
simplyreadingcommentsandbrowsingthroughfiles,evenifyoudonot
know C.Sometimes I also refer to commitfestentries:3 you can always tracethe
1 postgresql.org/docs/14/index.html
2 git.postgresql.org/gitweb/?p=postgresql.git;a=summary
3 commitfest.postgresql.org
11
AboutThisBook
history of all changes and understand the logic of decisions taken by developers
ifyoureadtherelateddiscussionsinthepsql-hackersmailinglist,butitrequires
diggingthroughpilesofemails.
Sidenotesthatcanleadthediscussionastray(whichIcouldnothelpbutincludeintothe
book)areprintedlikethis,sotheycanbeeasilyskipped.
Naturally,thebookcontainsmultiplecodeexamples,mainlyin. Thecodeis
providedwiththeprompt=>;theserverresponsefollowsifnecessary:
=> SELECT now();
now
−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
2022−08−16 19:31:19.847661+03
(1 row)
IfyoucarefullyrepeatalltheprovidedcommandsinPostgre,youshouldget
exactly the same results (down to transaction s and other inessential details).
Anyway,allthecodeexamplesinthisbookhavebeengeneratedbythescriptcon-
tainingexactlythesecommands.
Whenitisrequiredtoillustrateconcurrentexecutionofseveraltransactions,the
coderuninanothersessionisindentedandmarkedoffbyaverticalline.
=> SHOW server_version;