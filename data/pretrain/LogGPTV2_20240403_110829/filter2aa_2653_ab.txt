●
JackM
●
PonyM(由设置helpdesk场景引起)
Jack Ma当时想都没想，直接在公司的电脑打开连接，下载了了⽂文件，打开运⾏行行。
正式开始攻击
我们的游戏开始了了，按照真实环境进⾏行行模拟后渗透中攻击者的活动。
侦察
⼀一旦攻击者进⼊入到域环境中，侦察就开始了了，在这个阶段中对⼿手花时间进⾏行行研究域内环境，进
⾏行行信息收集，枚举安全组和其他活动⽬目录对象，以根据获取的信息绘制⼀一个攻击的路路线图。
DNS协议侦察
⼤大部分攻击者进⼊入域内第⼀一件事要做的就是尝试接收DNS的所有内容。
1.
⾏行行动：DNS侦察
在以JackM身份登录的VICTIMS-PC上，攻击者刚刚⼊入侵的PC，以⽤用户运⾏行行以下命令：
nslookup
ls –d h4x0er.org
幸运的是，我们的DNS配置为默认阻⽌止此DNS针对域进⾏行行转储。但如果不不当的配置将会导致
DNS域传送泄露露漏漏洞洞，任何匿匿名⽤用户都可以获取DNS服务器器对应域的所有记录，直接把企业域
内基础服务跟⽹网络架构暴暴露露，从⽽而造成严重信息泄露露，导致攻击者可利利⽤用相关信息进⾏行行下⼀一步
的渗透。
⽬目录服务枚举
安全帐户管理理器器远程协议（SAMR）为域中的⽤用户和组提供管理理功能。了了解⽤用户、组和权限之
间的关系对于攻击者来说⾮非常重要。任何经过身份验证的⽤用户都可以执⾏行行这些命令。
枚举所有的⽤用户和组
列列举⽤用户和组对攻击者⾮非常有⽤用。知道⽤用户名和组名会很⽅方便便。作为⼀一名攻击者，你要尽可能
多地收集信息，毕竟这是侦察阶段。
2.
⾏行行动：枚举⽤用户和组
使⽤用JackM帐户，登录到VICTIMS-PC上，并尝试使⽤用以下命令拉取所有域⽤用户和组：
net user /domain
net group /domain
这些操作都属于普通⽤用户使⽤用合法凭证可以进⾏行行的操作，现在攻击者已经了了解域中所有⽤用户和
组信息。
枚举⾼高特权⽤用户
攻击者现在同时拥有⽤用户列列表和组列列表。但知道谁在哪个组中也很重要，特别是对于企业管理理
员“Enterprise Admins”和域管理理员“Domain Admins”这样的⾼高特权组。我们就这样…
3.
⾏行行动：枚举域管理理员
在VICTIMS-PC上以JackM的身份运⾏行行以下命令:
net group “domain admins” /domain
攻击者现在拥有所有⽤用户和组，并知道哪些⽤用户属于特权域管理理员“Domain Admins”组。
攻击者不不会就此停⽌止进攻，他们知道企业管理理员和域管理理员之间没有安全边界，因此他们也会
获取企业管理理员列列表。
4.
⾏行行动：枚举企业管理理员
要获取此企业管理理员组的成员，请在VICTIMS-PC上运⾏行行以下命令：
net group “enterprise admins” /domain
在企业管理理员组中有⼀一个帐户不不太有趣，因为它只是默认设置，但攻击者在JackM帐户中获取
更更多的信息，并已识别他们最想攻击的⽤用户是谁。
SMB会话枚举
攻击者知道他们愿意为获得最⼤大的凭据⽽而想妥协的⼈人，但是他们并不不完全知道如何对那些凭据
进⾏行行妥协，对叭？ SMB枚举可以为暴暴露露这些⾮非常有趣的帐户的位置，给攻击者提供精确的位
置。
所有经过身份验证的⽤用户必须连接到域控制器器以处理理组策略略（针对SYSVOL），从⽽而使SMB枚
举成为攻击者的重要⼯工具。 这使域控制器器成为执⾏行行SMB枚举的主要⽬目标
5.
⾏行行动：对DC执⾏行行SMB会话枚举
若要枚举连接到特定计算机的⽤用户，在这种情况下，请转到VICTIMS-PC上的Netess本地保存
的位置并运⾏行行以下命令：
NetSess.exe dc1.h4x0er.org
根据前⾯面的信息我们已经知道RobinL是域管理理员，现在通过SMB会话枚举，攻击者得知
RobinL的IP地址(192.168.10.21)
横向移动
仅需采取⼏几个步骤，您就已经可以获得很多信息。 ⾄至此，⽬目标变成了了您发现的IP地址：
192.168.10.21（公开了了RobinL的计算机凭据）。
枚举在内存中的凭据
Victim-PC不不仅具有JackM的凭据，⽽而且还有许多其他帐户可能对攻击者有⽤用。 我们来列列举⼀一
下Victim-PC上的内存中凭据。幸运的是，有⼀一个⽤用于此⽬目的的⼯工具：Mimikatz。
6.
⾏行行动：从VICTIMS-PC转储凭据
从VICTIMS-PC上以管理理员权限运⾏行行命令提示符，转到保存Mimikatz的⼯工具⽂文件夹，并执⾏行行以
下命令：
mimikatz.exe “privilege::debug” “sekurlsa::logonpasswords” “exit” >> c: \VICTIMS-PC.txt
上⾯面的命令将执⾏行行Mimikatz，然后在内存中获取凭据。这个⼯工具会把它写进⼀一个名为
“VICTIMS-PC.txt”的⽂文本⽂文件”.打开“VICTIMS-PC.txt”⽂文件“看看你能找到什什么。
7.
⾏行行动：解析Mimikatz的凭证转储输出
使⽤用记事本打开⽂文件“VICTIMS-PC.txt “。如果你的⽂文件，看起来不不像这个例例⼦子，是因为不不同的
密码或使⽤用的操作系统可能不不同，以及默认密码策略略设置为开/关。
攻击者找到了了JackM的凭据，这将允许他们伪装成JackM。
攻击者还发现了了计算机帐户，该帐户与⽤用户帐户⼀一样，可以添加到其他计算机的本地管理理组和
其他⾼高权限安全组中。这在这种情况下并不不有⽤用，但你应该始终记住，计算机帐户也可以映射
到其他地⽅方的特权。
攻击者还发现了了⼀一个潜在的易易攻击的帐户PonyM。记住，PonyM是在安装阶段登录到受害者电
脑的。那个凭证当时暴暴露露在内存中的LSASS.EXE进程中，
Mimikatz给了了攻击者下⼀一步进攻的可能性。当你针对域管理理员或企业管理理员中的⽤用户进⾏行行枚举
时，PonyM没有列列出，但请记住，你现在可以访问他的凭据。
但是要注意的是，在某些情况下，这个Mimikatz转储凭证可能会显示明⽂文密码，当环境未更更新
或未配置为阻⽌止WDigest时。最新的环境（Win8 & Win10&Win&Service 2012以上），遵循最
佳实践，将返回⼀一个空密码字段。
最后，在使⽤用PonyM的帐户之前，让我们看看它是否有任何价值。让我们⽤用那个帐户做些信息
收集。
有关WDigest的更更多信息，请参阅：
https://blogs.technet.microsoft.com/kfalde/2014/11/01/kb2871997-and-wdigest-part-1/
8.
⾏行行动：对PonyM帐户执⾏行行信息收集
在VICTIMS-PC的命令⾏行行中，执⾏行行以下操作：
net user PonyM /domain
攻击者将得知PonyM是HelpDesk帮助台的成员。PonyM的帐户对攻击者来说很有趣。但是，
还需要进⼀一步的分析，以查看该帐户是否在其他计算机上具有管理理员权限。毕竟，使⽤用它横向
移动到另⼀一台计算机上却发现它的权限⽐比攻击者已经拥有的权限低是没有意义的。
9.
⾏行行动：枚举远程计算机的成员身份
这⾥里里使⽤用的⼯工具是PowerSploit，渗透测试⼈人员使⽤用的其中⼀一个PowerShell模块。打开⼀一个
PowerShell会话，并遍历PowerSploit保存在VICTIMS-PC本地上的位置。在PowerShell控制台
中，执⾏行行：
Import-Module .\PowerSploit.psm1
Get-NetLocalGroup 192.168.10.21
在第⼀一⾏行行中，将PowerSploit模块导⼊入内存，在第⼆二⾏行行中执⾏行行该模块提供的函数之⼀一，在本例例中
为GetNetLocalGroup。
同样，192.168.10.21是5.⾏行行动：对DC执⾏行行SMB会话枚举阶段发现的IP地址。
攻击者刚刚发现以下内容：
●
192.168.10.21连接到ADMINS-PC（我们将IP地址解析为计算机名也通过powerspoit）
●
“h4x0er.com/Domain Admins“和”h4x0er.com/HelpDesk“是管理理员组
PonyM是Helpdesk组的成员，因此PonyM可以授予攻击者在ADMINS-PC上的管理理员权限（攻
击者从前期的信息收集中知道RobinL在其中）。
攻击者使⽤用这种类似关系之间关联的思考⽅方式是发现⽹网络中的关系，下⼀一步攻击者应该如何使
⽤用PonyM进⾏行行横向移动？
哈希传递攻击(Overpass-the-Hash)
如果攻击者所处的环境没有禁⽤用WDigest，则已经游戏结束了了，因为他们使⽤用的是明⽂文密码。
但是，本着学习的精神，让我们更更加努⼒力力，假设您不不知道/⽆无法访问明⽂文密码。
那么，只要访问PonyM的NTLM散列列，你能做什什么？
使⽤用名为Overpass the Hash的技术，您可以获取NTLM散列列，并使⽤用它通过Kerberos\Active 
Directory获取票据，授予票据TGT(Ticket Granting Ticket）。有了了TGT，你可以伪装成PonyM
并访问PonyM可以访问的任何域资源。
10. ⾏行行动：对PonyM进⾏行行哈希传递攻击
在这⾥里里你将再次使⽤用Mimikatz。从VICTIMS-PC那⾥里里复制PonyM的NTLM散列列VICTIMS-PC.txt
⽂文件，早期获取（6. ⾏行行动：从VICTIMS-PC转储凭据）。
在VICTIMS-PC上，转到⽂文件系统中存储Mimikatz的位置，并执⾏行行以下命令：