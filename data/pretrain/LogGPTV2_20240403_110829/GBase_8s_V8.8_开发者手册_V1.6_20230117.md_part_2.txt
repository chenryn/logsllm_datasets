8.3.2.6PQexecPreparedBatch............................................. 284
8.3.2.7PQfname........................................................285
8.3.2.8PQgetvalue......................................................286
8.3.2.9PQnfields....................................................... 287
8.3.2.10PQntuples......................................................287
8.3.2.11PQprepare......................................................288
8.3.2.12PQresultStatus.................................................. 289
8.3.3 异步命令处理...................................................... 290
8.3.3.1PQsendQuery....................................................291
8.3.3.2PQsendQueryParams..............................................292
8.3.3.3PQsendPrepare...................................................293
8.3.3.4PQsendQueryPrepared.............................................294
8.3.3.5PQflush.........................................................295
8.3.3.6PQgetCancel.....................................................295
8.3.3.7PQfreeCancel....................................................296
8.3.3.8PQcancel....................................................... 297
8.4Psycopg.................................................................................................................................297
8.4.1psycopg2.connect()...................................................298
8.4.2connection.cursor()...................................................298
8.4.3cursor.execute(query,vars_list).......................................... 299
8.4.4curosr.executemany(query,vars_list)......................................300
8.4.5connection.commit()..................................................300
8.4.6connection.rollback()................................................. 301
南大通用数据技术股份有限公司
X
GBase 8s V8.8开发者手册
8.4.7cursor.fetchone().....................................................301
8.4.8cursor.fetchall()......................................................301
8.4.9cursor.close()........................................................302
8.4.10connection.close()...................................................302
9 导入数据................................................................. 302
9.1 通过INSERT语句直接写入数据.....................................................................................303
9.2 使用COPYFROMSTDIN导入数据...............................................................................303
9.2.1 关于 COPYFROMSTDIN 导入数据.................................. 303
9.2.2CopyManager 类简介................................................ 304
9.2.3CopyManager 的继承关系............................................ 304
9.2.4 处理错误表........................................................ 305
9.2.5 示例1：通过本地文件导入导出数据...................................307
9.2.6 示例2：从 MY 迁移数据........................................... 309
9.3 使用gsql元命令导入数据.................................................................................................311
9.4 用gs_restore命令导入数据...............................................................................................315
9.5 更新表中数据.....................................................................................................................321
9.5.1 使用DML命令更新表...............................................321
9.5.2 使用合并方式更新和插入数据........................................ 322
9.6 深层复制.............................................................................................................................325
9.6.1 使用 CREATETABLE 执行深层复制..................................325
9.6.2 使用 CREATETABLELIKE 执行深层复制.............................325
9.6.3 通过创建临时表并截断原始表来执行深层复制.......................... 326
9.7 分析表.................................................................................................................................327
9.8 对表执行VACUUM...........................................................................................................328
9.9 管理并发写入操作.............................................................................................................328
9.9.1 写入和读写操作.................................................... 329
南大通用数据技术股份有限公司
XI
GBase 8s V8.8开发者手册
9.9.2 并发写入事务的潜在死锁情况........................................ 329
9.9.3 并发写入示例...................................................... 330
9.9.3.1 相同表的 INSERT 和 DELETE 并发.............................. 330
9.9.3.2 相同表的并发 INSERT...........................................331
9.9.3.3 相同表的并发 UPDATE..........................................331
9.9.3.4 数据导入和查询的并发...........................................332
10 导出数据................................................................ 333
10.1 使用gs_dump和gs_dumpall命令导出数据..................................................................333
10.1.1 概述............................................................. 333
10.1.2 导出单个数据库................................................... 335
10.1.2.1 导出数据库....................................................335
10.1.2.2 导出模式......................................................337
10.1.2.3 导出表........................................................340
10.1.3 导出所有数据库................................................... 344
10.1.3.1 导出所有数据库................................................344
10.1.3.2 导出全局对象..................................................346
10.1.4 无权限角色导出数据............................................... 348
11AI特性.................................................................. 351
11.1AI4DB: 数据库自治运维..................................................................................................351
11.1.1DBMind 模式说明..................................................353
11.1.1.1service 子命令..................................................354
11.1.1.2component 子命令.............................................. 357
11.1.1.3set 子命令.....................................................358
11.1.2DBMind 的支持组件................................................359
11.1.2.1PrometheusExporter 组件........................................ 359
11.1.2.1.1 概述...................................................... 359
南大通用数据技术股份有限公司
XII
GBase 8s V8.8开发者手册
11.1.2.1.2 环境部署.................................................. 360
11.1.2.1.3 使用指导.................................................. 360
11.1.2.1.4 获取帮助.................................................. 363
11.1.2.1.5 命令参考.................................................. 363
11.1.2.1.6 常见问题处理.............................................. 366
11.1.3DBMind的AI子功能...............................................367
11.1.3.1X-Tuner：参数调优与诊断....................................... 367
11.1.3.1.1 概述...................................................... 367
11.1.3.1.2 使用准备.................................................. 367
11.1.3.1.3 使用示例.................................................. 372
11.1.3.1.4 获取帮助.................................................. 377
11.1.3.1.5 命令参考.................................................. 378
11.1.3.1.6 常见问题处理.............................................. 380
11.1.3.2Index-advisor：索引推荐......................................... 381
11.1.3.2.1 单query索引推荐...........................................381
11.1.3.2.2 虚拟索引.................................................. 382
11.1.3.2.3workload级别索引推荐.......................................385
11.1.3.3AI4DB: 慢SQL根因分析........................................ 388
11.1.3.3.1 概述...................................................... 388
11.1.3.3.2 环境部署.................................................. 388
11.1.3.3.3 使用指导.................................................. 388
11.1.3.3.4 获取帮助.................................................. 388
11.1.3.3.5 命令参考.................................................. 389
11.1.3.3.6 常见问题处理.............................................. 389
11.1.3.4AI4DB：趋势预测.............................................. 390
11.1.3.4.1 概述...................................................... 390
南大通用数据技术股份有限公司
XIII
GBase 8s V8.8开发者手册
11.1.3.4.2 环境部署.................................................. 390
11.1.3.4.3 使用指导.................................................. 390
11.1.3.4.4 获取帮助.................................................. 390
11.1.3.4.5 命令参考.................................................. 391
11.1.3.4.6 常见问题处理.............................................. 391
11.1.3.5SQLdiag：慢SQL发现.......................................... 392
11.1.3.5.1 概述...................................................... 392
11.1.3.5.2 使用指导.................................................. 392
11.1.3.5.3 获取帮助.................................................. 394
11.1.3.5.4 命令参考.................................................. 395
11.1.3.5.5 常见问题处理.............................................. 395
11.2DB4AI: 数据库驱动AI....................................................................................................395
11.2.1 原生DB4AI引擎.................................................. 396
11.2.2 全流程AI.........................................................407
11.2.2.1PLPythonFenced模式........................................... 407
11.2.2.2DB4AI-Snapshots数据版本管理...................................409
11.3AIinDB: 数据库内AI功能............................................................................................415
11.3.1 概述............................................................. 415
11.3.2 环境部署......................................................... 415
11.3.3 使用指导......................................................... 419
11.3.4 最佳实践......................................................... 423
11.3.5 常见问题处理..................................................... 424
12 资源负载管理............................................................ 424
12.1 资源负载管理概述...........................................................................................................424
12.2 资源管理准备...................................................................................................................425
12.2.1 资源规划......................................................... 425
南大通用数据技术股份有限公司
XIV
GBase 8s V8.8开发者手册
12.2.2 启动资源负载管理功能............................................. 426
12.2.3 设置控制组....................................................... 427
12.2.4 创建资源池....................................................... 434
13 内存表特性.............................................................. 438
13.1MOT介绍...........................................................................................................................438
13.1.1MOT简介.........................................................438
13.1.2MOT特性及价值...................................................440
13.1.3MOT关键技术.....................................................440
13.1.4MOT应用场景.....................................................442
13.2 使用MOT..........................................................................................................................443
13.2.1MOT使用概述.....................................................443
13.2.2MOT准备.........................................................444
13.2.3MOT部署.........................................................450
13.2.3.1MOT服务器优化............................................... 450
13.2.3.2MOT配置..................................................... 453
13.2.4MOT使用.........................................................463
13.2.4.1 授予用户权限..................................................463
13.2.4.2 创建/删除MOT................................................ 464
13.2.4.3 为MOT创建索引.............................................. 464
13.2.4.4 将磁盘表转换为MOT...........................................465
13.2.4.5 查询原生编译..................................................467
13.2.4.6 重试中止事务..................................................469
13.2.4.7MOT外部支持工具............................................. 470
13.2.4.8MOTSQL覆盖和限制...........................................471
13.2.5MOT管理.........................................................475
13.2.5.1MOT持久性................................................... 475
南大通用数据技术股份有限公司
XV
GBase 8s V8.8开发者手册
13.2.5.2MOT恢复..................................................... 480
13.2.5.3MOT复制和高可用............................................. 480
13.2.5.4MOT内存管理................................................. 481
13.2.5.5MOTVACUUM清理............................................ 481
13.2.5.6MOT统计..................................................... 482
13.2.5.7MOT监控..................................................... 482
13.2.5.8MOT错误消息................................................. 484
13.3MOT的概念......................................................................................................................489
13.3.1MOT纵向扩容架构.................................................490
13.3.2MOT并发控制机制.................................................492
13.3.3MOT本地内存和全局内存...........................................493
13.3.4MOTSILO增强特性................................................493
13.3.5MOT隔离级别.....................................................494
13.3.6MOT乐观并发控制.................................................495
13.3.6.1 乐观OCC与悲观2PL...........................................495
13.3.6.2OCC与2PL的区别举例......................................... 497
13.3.7 扩展FDW与其他特性..............................................498
13.3.8NUMA-aware分配和亲和性..........................................501
13.3.9MOT索引.........................................................502
13.3.10MOT持久性概念..................................................503
13.3.10.1MOT日志记录：WAL重做日志概念............................. 504
13.3.10.2MOT检查点概念.............................................. 511
13.3.11MOT恢复概念....................................................511
13.3.12MOT查询原生编译（JIT）.........................................512
13.3.13 对比：磁盘与MOT............................................... 514
13.4 附录....................................................................................................................................515
南大通用数据技术股份有限公司
XVI
GBase 8s V8.8开发者手册
14 性能调优................................................................ 517
14.1 总体调优思路...................................................................................................................517
14.2 确定性能调优范围...........................................................................................................519
14.2.1 硬件瓶颈点分析................................................... 521
14.2.1.1CPU.......................................................... 521
14.2.1.2 内存..........................................................524
14.2.1.3I/O........................................................... 526
14.2.1.4 网络..........................................................528
14.2.2 查询最耗性能的SQL...............................................529
14.2.3 分析作业是否被阻塞............................................... 531
14.3 系统调优指南...................................................................................................................532
14.3.1 操作系统参数调优................................................. 532
14.3.2 数据库系统参数调优............................................... 535
14.3.2.1 数据库内存参数调优............................................535
14.3.2.2 数据库并发队列参数调优........................................536
14.3.3 配置SMP.........................................................537
14.3.3.1SMP适用场景与限制............................................537
14.3.3.2 资源对SMP性能的影响.........................................538
14.3.3.3 其他因素对SMP性能的影响.....................................539
14.3.3.4SMP 使用建议................................................. 539
14.3.4 配置LLVM....................................................... 540
14.3.4.1LLVM适用场景与限制.......................................... 540
14.3.4.2 其他因素对LLVM性能的影响................................... 542
14.3.4.3LLVM使用建议................................................ 542
14.4SQL调优指南....................................................................................................................543
14.4.1Query执行流程.................................................... 543
南大通用数据技术股份有限公司
XVII
GBase 8s V8.8开发者手册
14.4.2SQL执行计划介绍................................................. 545
14.4.2.1SQL执行计划概述..............................................545
14.4.2.2 详解..........................................................546
14.4.2.2.1 执行计划.................................................. 547
14.4.2.2.2 执行信息.................................................. 549
14.4.3 调优流程......................................................... 549
14.4.4 更新统计信息..................................................... 550
14.4.5 审视和修改表定义................................................. 551
14.4.5.1 审视和修改表定义概述..........................................551
14.4.5.2 选择存储模型..................................................552
14.4.5.3 使用局部聚簇..................................................552
14.4.5.4 使用分区表....................................................552
14.4.5.5 选择数据类型..................................................553
14.4.6 典型SQL调优点.................................................. 553
14.4.6.1SQL自诊断....................................................553
14.4.6.2 子查询调优....................................................554
14.4.6.3 统计信息调优..................................................566
14.4.6.4 算子级调优....................................................568
14.4.7 经验总结：SQL语句改写规则.......................................570
14.4.8SQL调优关键参数调整............................................. 571
14.4.9 使用PlanHint进行调优.............................................573
14.4.9.1PlanHint调优概述..............................................573
14.4.9.2Join顺序的Hint................................................ 579
14.4.9.3Join方式的Hint................................................ 581
14.4.9.4Join行数的Hint................................................ 582
14.4.9.5Scan方式的Hint................................................583
南大通用数据技术股份有限公司
XVIII
GBase 8s V8.8开发者手册
14.4.9.6 子链接块名的hint..............................................584
14.4.9.7Hint的错误、冲突及告警........................................ 585
14.4.9.8 优化器GUC参数的Hint........................................ 587
14.4.9.9CustomPlan和GenericPlan选择的Hint............................588
14.4.9.10 指定子查询不展开的Hint.......................................589
14.4.9.11 指定不使用全局计划缓存的Hint.................................590
14.4.9.12 同层参数化路径的Hint.........................................590
14.5 使用向量化执行引擎进行调优.......................................................................................592
14.6TPCC性能调优测试指导.................................................................................................593
14.6.1 概述............................................................. 593
14.6.2 搭建性能测试环境................................................. 594
14.6.2.1 硬件要求......................................................594