### Title: Black Hat US-22: WMI-based User-Space Attacks Evasion of SIEMs and EDRs

Security solutions engineers continually seek innovative methods to monitor operating system (OS) events to mitigate endpoint threats. These approaches often repurpose various built-in Windows mechanisms, which were not originally designed with security as a primary concern. At Black Hat Europe 2021, we demonstrated how to blind an entire class of endpoint security products by disabling Event Tracing for Windows (ETW). Our current research focuses on Windows Management Instrumentation (WMI), a mechanism that enables event filtering without the need for kernel callbacks.

WMI is a built-in feature designed to manage enterprise infrastructure and provide detailed diagnostics, including hardware, firmware, software, and configurations, both locally and remotely. It is deeply integrated into Windows user-mode applications and kernel drivers. WMI offers rich information about the computing environment, allowing for monitoring through event filters, consumers, and bindings, which can notify of important OS events. This makes WMI essential for solutions such as Endpoint Detection and Response (EDR) systems, antivirus (AV) software, and Security Information and Event Management (SIEM) platforms.

However, WMI has inherent vulnerabilities. It has been exploited for malware persistence (e.g., APT41, FIN6) and arbitrary code execution (e.g., APT29, Stuxnet). Malware can disable WMI, rendering these defense solutions ineffective. In our presentation, we will analyze the WMI architecture by reverse-engineering user-mode variables and functions from DLLs to demonstrate several new user-mode attacks.

The core vulnerability in WMI lies in the use of "flags" within the DLLs loaded into the WMI core process (WinMgmt) to perform WMI operations. Attackers can block access to WMI—preventing the reception of new OS events and the installation of new WMI filters—by modifying these flags. There are no built-in features to prevent or repair such attacks on WMI.

Our Security Sensor detects these attacks by inspecting the memory of the WMI core service and can also identify other attacks on Windows OS components, including privilege escalation, token hijacking, and ETW blinding. These attacks affect all versions of Windows, highlighting the critical nature of WMI's design and its role in endpoint security.

This research underscores the importance of understanding and addressing the vulnerabilities in WMI to enhance the effectiveness of security solutions.