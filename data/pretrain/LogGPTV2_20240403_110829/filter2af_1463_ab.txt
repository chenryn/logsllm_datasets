上面简单介绍了下RDP版本识别的一些内容，那么接下来将介绍下本文的重点内容，RDP版本识别实现的方式也比较多，而且效果比较好，利用的分析模型也都是大家平时都了解的。
关于RDP后门的识别，本文主要以shift后门为例，其它的放大镜之类的和shift原理类似.
我们从shodan上面的采样的结果来看，shift后门主要的几种形式，如下图
所以这里面面临的问题就是shift后门位置不固定，大小不一样，颜色不一样，不同版本的弹框也不一样。所以用图像识别、固定位置截图识别，或者说将图片二值化后看黑白区域所占的比例（cmd框黑色占比比较大），包括利用之前的SVM进行标记训练，都是不行的，识别效果太差了，例如shift框位置稍微变动下、大小稍微变动下，识别准确率就非常低。
在我们经过一段时间的调研之后，发现目标检测算法（Object Detection）比较适用于我们当前的项目，目标识别的算法主要有R-CNN、Faster-R-CNN、YOLO等，这个算法目前以被tensorflow、keras、Caffe等框架实现，关于目标检测算法的原理之类的，建议大家先从卷积神经网络（CNN）去看相关paper，本文也只是目标检测算法在安全上的一些应用的探索。
综合几个方面的因素，我们选择了YOLO-V2来进行样本训练和识别（目前最新版本是YOLO-V3，但是测试的时候老是有GPU内存不足的问题，调整了训练的batch_size还是不行，所以就回退到V2），YOLO主要是做目标识别以及实时图像目标识别，由于YOLO
是属于深度学习的范畴，最好你要有GPU的计算环境，否则用CPU来训练的时候会非常慢。
YOLO的使用大家可以参考作者的博客
，这里有相关的原理Paper，当然还有一些训练好的模型可以直接用，安装过程就不详细解释了，包括GPU环境的编译，作者博客上都有详细的说明，YOLO是一个目标检测框架，作者提供了两种类型（PASCAL
VOC、COCO）的数据集来进行模型的训练，我们可以根据这两种类型来定制自己的数据集来训练自己的模型，本文采用PASCAL
VOC2007类型来指定自己的数据集，PASCAL VOC2007数据集的目录结构如下：
**JPEGImages：** 包含了PASCAL VOC所提供的所有的图片信息。
**Annotations：** 存放对应图片的xml格式的标签文件。
**ImageSets：** 主要是Main目录下txt文件，存储训练样本的文件名（不带后缀）。
**Labels：** 标记样本的类型等信息。
其它文件夹在YOLO中没有使用，感兴趣的自己去查下。
首先我们将shift后门的样本放在JPEGImages目录，按照如下编号进行保存
图片标记使用
，然后对每张图片进行标记，我们目前只有两个分类：normal_shift、shift_backdoor，例如
按照类似的方法将所有样本进行标记，然后用voc_label.py
将标记好的xml信息转换成相应格式的文件即可，这里这个工具在标注的xml文件中可能会出现width和height为0的情况，需要在标注后统一修正下图片的大小。
修改YOLO的训练的参数，这里主要涉及YOLO的三个文件cfg/voc.data、cfg/tiny-yolo-voc.cfg、data/voc.names，具体的参数信息大家可以根据自己的类别来设置，这里以两个类别为例子。
所有数据都准备好之后，我们就可以开始进行训练，先看看装备
注：训练的初始权重可以在作者博客进行下载。
    ./darknet detector train cfg/voc.data cfg/tiny-yolo-voc.cfg darknet19_448.conv.23 -gpus 0,1,2,3
大约几个小时之后（CPU的话大概1周左右，看性能），经过40000多次迭代直至收敛，在backup目录下面会生成最终的权重文件：tiny-yolo-voc_final.weights，至此整个过程的标注和训练工作已经完成。
识别的话我们项目用的是python，这里直接用 pip install darknetpy ，然后将最终的权重文件以及相关的配置文件按照要求正常调用就行了。
我们看看最终效果：
我们用于训练的图片大小是800 _600，我们这里用2048_ 768的图片来进行识别看看准确率如何。
当然识别率这块还有很多可以提高的地方，比如训练的样本集、图片的进一步处理等。
##### RDP版本、后门全国分布
我们对中国互联网侧暴露的130w（数据来源：
）开放3389端口的IP进行了分析，确定Windows开放远程桌面的服务器大约为31W左右，通过对这31W的数据进行了分析研究，得出以下结论：
通过对31W开放的Windows远程桌面服务器进行分析识别，发现了4500+ Shift后门，具体的shift后门分布如下：
其中广东、江苏、北京、浙江、上海、山东是重灾区，具体数量如下：
#### 总结
Windows RDP 的后门变种是非常多的，本文提供的检测方式只是最基础的一种，这些后门也只是冰山一角。
对于那些非常隐蔽的后门的检测我们还在探索之中，作为一个服务于广大客户的厂商来说，大规模、自动化的安全检测还有很长一段路需要走，接下来我们也会结合新的技术去探索更具挑战的威胁检测。
当然如果你愿意同我们一起进行安全技术的研究和探索，请发送简历到 PI:EMAIL，我们期望你的加入。
#### 参考链接
  * 
  * 
  * 
  * 
  * 
* * *
_本文经安全客授权发布，转载请联系安全客平台。_
* * *