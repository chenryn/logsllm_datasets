参考资料
AWS Security Best Practices
http://media.amazonwcbservices.com/AWS_Security_Best_Practices.pdf
Securing Data at Rest with Encryption
http://media.amazonwebservices.com/AWS_Securing_Data_at_Rest_with_Encryption.pdf
Disk encryption
《 D2T2 - Vladimir Katalov -Cracking and Analyzing Apple's iCloud Protocol )
---
## Page 275
实践篇
■第15章业务安全与风控
■第16章大规模纵深防御体系设计与实现
第17章分阶段的安全体系建设
---
## Page 276
Ce第15章
业务安全与风控
业务安全的起源是由于黑产的存在，很多年前黑产就通过黑客人侵，拖库，然后卖数
据去赚钱。但现在随着互联网承载的各种业务的兴起，黑产盈利的门槛开始降低，不再须
要入侵了对方才能套利，仅通过业务层面的漏洞，防范不严或打法律擦边球就能获利。
另一方面，企业间的恶性竞争，黄赌毒等合规性要求也成为业务安全的驱动力。
本章将描述互联网行业各种典型业务的主要风险和控制方法。
15.1对抗原则
在谈及具体的风控措施之前，先罗列一下业务安全的策略和原则，具体如下：
相对的风控而非绝对的防黑一业务安全的目标是相对意义上的风险控制，而不是绝
对意义上的防黑。拖库只要发生一次就非常严重，但是业务安全，即使漏掉了一些，但解
决了大部分的问题，那就算及格了。
增加黑产的成本而非阻断他们的行为一黑产，羊毛党的驱动力就是为了盈利，如果
他们投入的成本超过损益点，那就没必要再去攻击你。比如注册一张银行卡的成本>获取
一张手机SIM卡的成本>注册一个免费邮箱的成本。
永远的情报一知己知彼，百战不殆。了解黑产怎么干活事半功倍，深入敌后比躲在
---
## Page 277
第15章业务安全与风控265
办公室更聪明，并非只有爬虫抓来的大数据才叫情报，蹲在对方的QQ群里也能搞到情报。
方法比技术更重要一上兵伐谋，最下攻城。技术的对抗是无止尽的，并且会不断地
消耗内部的研发资源和IDC资源，改变战场规则可能起到一招退敌的效果。
数据比算法更重要一大数据的典型特征，算法可以不高大上，但是没有数据或数据
太少，风控这件事也许你玩不起来。
勤能补拙一也许你没有大数据，但是不断地改变业务逻辑，不断地升级会使对手疲
于奔命。自PS3/PSV时代起，sony不再封堵破解，而是以更短的选代周期，更高的版本发
布频率升级操作系统，新的游戏必须运行于高版本系统之上，使破解者疲惫不堪，盗版用
户都懒得再破解。谁主导节奏，另外一方就疲惫。
忽略性能、用户体验和成本的风控没有意义一风控本身的意义在于保障正常用户和
平台自身，如果正常用户体验受损或大面积误杀，则风控起了反效果。同样，一家创业型
公司不太可能有资源为了做风控而爬遍整个ipv4的地址库。
纵深防御一纵深、多维度、降维防御在风控场景仍然适用，使用漏斗模型，由机器
规则处理最原始的数据，逐步筛选过滤，由人工审核做最后一道防线。
杀鸡给猴看一只要条件允许，用法律武器端掉主力，用风控手段扫尾。2：8原则，对
危害最大的部分不一定要用常规手段，无论什么土方法，能达成目的就好。能在安全大会
上讲的高大上的方法不一定是解决问题性价比最高的手段。
人民的战争一教育正常的用户安全意识，动用一切资源和手段反黑产，以资鼓励
全民情报。
社工库一敌人有的，我也要有。
15.2账号安全
账号安全是所有强账号体系应用的基础，强账号体系，如电商、网游、第三方支付、
社交网络、即时通信等，是需要登录后产生数据和交互的应用，面搜索、导航、杀毒客户
端不需要登录也能用，则属于弱账号体系应用。
1.注册
对于羊毛党面言，平时需要“养号”，批量注册一批号放着不用，等到促销之类的活动
开始了才用。垃圾注册、虚假小号是垃圾抢购、欺诈钓鱼的源头，账号安全要从源头收紧。
---
## Page 278
266实践篇
对抗垃圾注册一般的手段包括：
口图片验证码
口邮件验证码
口短信验证码
语音验证的
口电话语音验证码
有些产品是PC客户端，或者Web注册界面不是使用标准的加密算法通过httpspost请
求，自动注册机需要模拟客户端协议才能工作，逆向的协议如果经常变化或者复杂程度较
高就会成为黑产研发的一个门槛。
真实的新用户如果在注册时使用了原来其他网站被拖库的邮件地址和相同的密码怎么
办？对甲方安全团队而言，自己应持有各种社工库，并随时更新，在用户注册时比对社工
库内容，如个人注册信息相同，做出风险提示或强制修改密码。
对于使用分布式代理的注册机，如果有账号风控系统的可以根据来源属性和机器人行
为特征标注恶意灰度，从面给与不同级别的验证码。对于产品线较长的企业来说，一般这
个环节只做检测，不做“严打”，因为像网游等业务注册小号也是正常的，具体打击和封锁
策略留给更后端的业务系统去做。
此外，对于利用注册接口检测用户名/账号是否存在的暴力枚举也应该做人机识别。以
防止批量得到账号信息用于批量扫号等动作。
2.登录
登录环节的问题包括：撞库、暴力破解、盗号登录、非常用设备登录、黑产小号和僵
户号登录等。
对于大型平台而言，登录的人口往往不止一个，且除了Web还有其他的协议入口，例
如POP3、手机APP等，尽可能使入口统一，以使于做集中管控。
使用风控系统对比用户画像检测登录地域来源、IP属性、可信设备、登录频率、代理
使用习惯等从面推送不同复杂等级的验证码或开启多因素认证。或根据离线数据，即一段
时间内的请求（行为）异常，以及其他业务风控子系统判断的行为异常，再调用风控的接口
推送二次认证要求做人机识别，如图15-1所示。
---
## Page 279
第15章业务安全与风控267
行为数
业务X
事：判新用户风
险等版，根据需要
出二次验证，事中：
号风险系统
南线风腔引章
让已登录的高风险
业务日
用户重新验证
实时风控引禁
业务A
登/码我目
50服务器注/
2备指绘
P信登库
北工库
用户面
MFA证
号行发
图15-1账号风控架构示意图
对于大规模的扫号、暴力破解，除了依赖于机器规则外，还应准备手工策略和应急预案。
风控服务依赖于很多数据，例如设备指纹、IP信誉库、黑产手机号等，获取这些数据
是一个比较庞大的工程，对于大型企业而言相对容易获取，中小企业在不借助第三方数据
合作的情况下，自己去抓取数据成本会非常高。
3.密保/密码找回
QQ的密保功能如图15-2所示。
首先平台应提供多种密码保护手段，并在用户界面显眼处提示或安全教育。其次，应
确保平台的密码找回/密码重置等功能不存在逻辑漏洞可以被绕过，或发生过度信息披露。
账户展现本身不应该存在可以被爬虫抓取聚合后用于撞库或暴力破解的信息。
在认证设备之间提供异地登录提醒、异常登录提醒、破解账号提醒。对密码找回业务
进行人机识别，防止批量找回、密码重置等接口的机器行为。
4.多因素认证
重要的操作必须使用2FA（双因素认证）或MFA（多因素认证），例如密码找回、密码
---
## Page 280
268实践篇
重置、安装证书等。记得某大型电商平台安装证书不需要二次认证，所以他们的大BOSS
站在台上被消费者问及盗号问题时非常尴尬。
QQ安全中心
AQ.QQ.COM 4~′##00
保护
密码管理
生保FR
防盗利器：剑灵游戏锁上线
90-9
绑定即送神龙工商袋
口使用的密保
?
报存您使用
图15-2QQ 的密保功能
前段时间某厂邮箱账号疑似拖库，引发了大量的iCloud账户被盗，没有开启2FA的用
户被彻底控制，手机被iCloud远程锁定，不交钱就直接远程擦除数据，IOS擦数据是直接
擦加密文件系统的密钥，基本不可能恢复。
5.多设备登录
多设备登录时，应保证同平台不能“串号”—同一账号可以在PC端和APP端同时
登录，但不能在两个PC端登录同一账号，或不同的手持设备上登录同一账号（iCloud这
种可以在iPhone和iPad同时登录，为不同设备间共享和同步数据而设计的账户体系除外）
如果在另一台PC上登录同一账号，前一个将被强制踢下线，或前一个设备保持登录状态，
第二次登录请求由户主的认证设备通过2FA之后才能登录，再将前者踢下线。
多设备同时登录时应支持交叉认证，例如PC端的可疑登录自动发起2FA请求到手机
端，经由手机端确认后才能从PC端登录。微信的设计如图15-3所示。
---
## Page 281
第15章业务安全与风控269
 su
加果不是本人理价，可以立前退出
手机消息免扰
图15-3微信多设备登录界面
6.账号共享体系
绝大多数互联网平台都采用SSO的账号共享体系，在开放平台业务上使用Oauth、
Openid等联合认证协议。一方面Oauth等协议坑比较多，非常容易出问题，另一方面内部
在对账户数据的使用上也容易不遵守规范，过度共享和滥用账户数据，这些都需要在相关
的应用安全开发标准中约束。
大型平台一般有很多应用，凭借一个登录token直接无障碍登录所有子应用在安全上并
不是一个好的设计，一且被XSS盗取token就相当于全线溃防。所以在功能和应用人口比
较多的平台，会对业务划权重，分类分级，涉及个人认证信息、个人隐私、支付类的一般
属于高级Web安全域，信息发布类的归人一般Web域。对高安全域的应用，登录除了SSO
token之外，引人第二层认证的secure token，黑客光有一个token登录不了重要应用，只有
两个token齐备才可以继续登录。安全研究者d4rkwind实现secure token的一个例子，如图
15-4所示
---
## Page 282
270实践篇
统一登录分散认证
（用户动间产品线
Coekie 中是否
核心思想
有BDUSS
BDUSS+STOKEN,BDUSS 共用.
STOKEN 分散在重工产品线
L0GA
Cookie 中是西
 STOKEN,
on服务器查询
查陶结果判定
已登录
未登录
图15-4某互联网公司SSO登录流程
注：BDUSS是SSO token，STOKEN是 secure token，LOGA是一个用户跳转的接口，
跳转到passport（即 SSO），正常用户passport域下肯定有STOKEN，LOGA成功后会给原
域名STOKEN，所以只需要跳转就可以安全登录而无需输人密码。这个方案会比一般的单
点登录多一次跳转，但对用户基本无感知，这样做完全不显得激进。
15.3电商类
电商是互联网行业中走得比较靠前的行业，在当下互联网+和O2O时代比较热门，因