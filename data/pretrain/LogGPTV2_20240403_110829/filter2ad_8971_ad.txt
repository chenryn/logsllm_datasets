所示）；第2个导出函数负责在必要释放已申请资源；第3个导出函数根据调用参数返回其核心功能函数指针；第4个导出函数负责填写调用者提供的数据结构、向调用者传递插件版本信息。除了第4个导出函数未对参数进行严格判断而可能因访问空指针产生异常外，各插件的导出函数均不直接实现恶意功能，基于沙箱的威胁检测系统无法通过调用各导出函数触发其恶意行为，从而将其视作非恶意程序。
图 5 - 2 i1函数中的回调函数指针或参数
3\.
各个插件均只实现最基本能力。这些方程式插件均只实现最基本的功能，即使分析人员掌握了插件的调用方法，传递正确的调用参数，也只能执行最基本的程序功能，并在回调函数得到程序功能的中间结果（如进程名称、模块名称、用户密码），如果不是非常有经验的分析人员，是很难将这些程序功能与正常程序的功能实现区分开。方程式攻击组织这样设计插件，除了考虑到框架的可扩展性和功能剪裁的方便性等因素之外，很可能是以此绕过某些反病毒引擎的静态检测机制。
### 5.1 Processinfo插件遍历进程模块
由于这批插件的复杂性，安天CERT挑选了其中相对较小的文件以便于分析。通过分析发现，用于实现对指定进程的模块遍历，并调用上层模块预设的回调函数。
#### 5.1.1 样本标签
**病毒名**
|
Trojan/Win32.EquationDrug  
---|---  
**原始文件名**
|
processinfo_Implant9x.dll  
**MD5**
|
6042EA9707316784FBC77A8B450E0991  
**处理器架构**
|
X86-32  
**文件大小**
|
8 KB (8,192 字节)  
**文件格式**
|
BinExecute/Microsoft.DLL[:X86]  
**时间戳**
|
45A40EC7->2007-01-10 05:53:11  
表 5 - 1 样本标签
#### 5.1.2 主要功能
本插件提供四个基于序号导出的函数。
表 5 - 2 主要功能
**序号**
        功能
        1
        设置上层模块回调函数，创建互斥体
        2
        释放资源
        3
        返回核心功能函数地址
        4
        获取插件版本信息
图 5 - 3 1号导出函数 设置上层模块回调函数
图 5 - 4 3号导出函数 返回核心功能函数地址
图 5 - 5 4号导出函数 获取插件版本信息
图 5 - 6 遍历指定进程，默认为当前进程
图 5 - 7 遍历指定进程模块，计算模块对应文件HASH（SHA1）
### 5.2 kill_Implant插件杀进程模块
该模块是另一个相对较小的文件，安天CERT通过分析发现，该插件主要功能为根据传入的进程ID来结束对应进程。
#### 5.2.1 样本标签
表 5 - 3 样本标签
#### 5.2.2 主要功能
模块调用者传递进来进程ID，该模块利用函数OpenProcess获取句柄，再利用函数TerminateProcess结束对应进程。
图 5 - 8 结束进程
### 5.3 GROK键盘与剪贴版记录器驱动
本次泄露的文件除DLL插件外还有一些EXE格式，安天CERT发现其中几个EXE文件与之前方程式平台中的GROK组件相同，本次曝光的版本为1.2.0.1，均可以从资源段中解密并释放键盘与剪贴版记录器驱动msrtdv.sys。
#### 5.3.1 样本标签
表 5 - 4 样本标签  |
**病毒名**
        Trojan/Win32.EquationDrug
        原始文件名
        msrtdv.sys
        MD5
        6A4461AF87371B89D240A34846A7BC64
        处理器架构
        X86-32
        文件大小
        36.3
          KB (37,248 字节)
        文件格式
        BinExecute/Microsoft.SYS[:X86]
        时间戳
        0x4B7F1480->2010-02-20
          06:45:20
---  
该恶意代码样本是键盘记录器及剪贴版监视工具，在之前友商报告中曾经提到过有相似功能的恶意代码，下面对其相似之处进行对比。
#### 5.3.2 版本信息
样本包含版本信息，文件版本为5.1.1364.6430，源文件名为msrtdv.sys，文件描述为MSRTdv interface
driver。其中文件版本低于之前已经曝光的版本5.3.1365.2180，源文件名与文件描述的不同在于将两个字母"d"和"v"的位置互换，一个是"mstrdv.sys"，另一个是"msrtvd.sys"。
图 5 - 9 本次泄露版本与之前曝光版本的版本信息
5.3.3 主要功能
两个不同版本的样本其主要功能相同，通过给转储程序建立专用的进程来汇集所收集的数据，每隔30分钟，将结果压缩到文件"%TEMP%tm154o.da"。之前曝光的版本中，包含多个IoControlCode，分别对应不同的功能。
图 5 - 10 之前曝光版本的主要功能代码
而本次泄露的样本中，IoControlCode虽然只有0x22002C，但一些主要功能仍然存在，可以通过反编译后的代码看出它们的相同之处。
图 5 - 11 之前曝光版本的主要功能代码
图 5 - 12 本次泄露版本的主要功能代码
从以上分析比较中可以发现，本次泄露的恶意代码样本应为较低版本，版本信息低于之前卡巴斯基与安天分析曝光的版本，功能也弱于相关版本。在影子经纪人泄露出的文件DanderSpritz_All_Find.txt中，GROK的版本号也清楚的说明了这个问题，影子经纪人所释放出的只是GROK组件的低版本部分文件。
**但这批文件信息的丰富程度，则是将"千年暗室"打开了一个难得的缝隙。**
图 5 - 13 GROK组件的不同版本号
## 6 小结
此次"影子经纪人"释放的Equation
Group中的61个文件，对于全球网络安全研究者分析厘清EQUATION相关攻击平台的组成和架构有很大帮助。特别是能够观察其恶意代码的Debug版本，这在常规超级攻击组织的对抗中是很难想象的，这是一次难得从"内部"观察发动方程式组织的机会。经过初步打通和分析相关曝光信息，安天CERT看到、分析和梳理了该攻击平台的更多信息，包括如数百个攻击插件以及"DanderSpritz"攻击平台。
安天CERT分析相关文件后，判断其中部分组件与之前曝光的GROK组件为同类样本，而这些组件均为早期的低版本。另外，安天CERT的分析结果也表明"DanderSpritz"与Equation
Drug使用了相同的组件和架构设计，"DanderSpritz"可能就是方程式组织使用的Equation
Drug攻击平台，而其模块"原子化"的设计思路，让更多人可以看到该方程式组织支撑体系的庞大精密，作业过程的严密谨慎，以及其在武器研发使用中，绕过安全防御手段异常丰富的经验。
五年前，在安天展开针对Flame（火焰）蠕虫的马拉松分析中，有专家曾提醒我们不要"只见树叶，不见森林"，这让安天的安全工程师们深刻地反思了传统分析工程师"视野从入口点开始"的局限性，从那时开始尝试建立从微观见宏观的分析视野。安天CERT的安全工程师们通过本次分析，发现自己依然在迷宫中挣扎
--或许这就是面对超级攻击者时，安全分析团队面临的分析常态。
过去的四年，针对方程式组织的持续跟踪分析，是安天了解最高级别攻击者（即A2PT--高级的APT）的极为难得的经历。深入研究这种具有超级成本支撑和先进理念引领的超级攻击者，对于改善和增强安天探海、智甲、追影等高级威胁检测和防御产品的防御能力也非常关键。安天也在深入思考和探索面对行业和地域的大规模态势感知系统，即达成"以资产防护为核心"的有效能力，尤其是面对海量事件锁定关键威胁和高级攻击者的能力。但对于应对A2PT攻击者来说，无论是有效改善防御，还是进行更为全面深入系统的分析，都不是一家安全企业能够独立承载的，此中还需要更多协同和接力式分析，而不是重复"发明轮子"。正是基于这种共同认知，在不久之前的第四届安天网络安全冬训营上，安天和360企业安全等安全企业向部分与会专家介绍了能力型安全厂商分析成果互认的部分尝试。唯有中国的机构用户和能力型安全厂商形成一个积极互动的体系，才能更好的防御来自各方面的威胁。
我们警惕，但并不恐惧。对于一场防御战而言，除了扎实的架构、防御和分析工作之外，必胜的信念是一个最大的前提。
无形者未必无影，安天追影，画影图形。
## 附录一：参考资料
  * [1] 安天：修改硬盘固件的木马 探索方程式（EQUATION）组织的攻击组件 
  * [2] 安天：方程式（EQUATION）部分组件中的加密技巧分析 
  * [3] 安天：从“方程式”到“方程组”EQUATION攻击组织高级恶意代码的全平台能力解析 
  * [4] THESHADOWBROKERS CLOSED, GOING DARK 
  * [5] Stolen NSA "Windows Hacking Tools" Now Up For Sale! 
  * [6] Kaspersky：Equation: The Death Star of Malware Galaxy 
  * [7] Kaspersky：Inside the EquationDrug Espionage Platform https://securelist.com/blog/research/69203/inside-the-equationdrug-espionage-platform/
  * [8] Equation Group Cyber Weapons Auction - Invitation 
  * [9] The Equation giveaway 
  * [10] I just published “TheShadowBrokers Message #3” 
  * [11] Shadow Brokers reveals list of Servers Hacked by the NSA 
  * [12] ANTProductData2013 https://search.edwardsnowden.com/docs/ANTProductData2013-12-30nsadocs
  * [13] Kaspersky：A Fanny Equation: "I am your father, Stuxnet" 
  * [14] Kaspersky：Equation Group: from Houston with love 
  * [15] Kaspersky：Equation_group_questions_and_answers 
  * [16] Kaspersky：The Equation giveaway https://securelist.com/blog/incidents/75812/the-equation-giveaway/
## 附录二：关于安天
安天从反病毒引擎研发团队起步，目前已发展成为以安天实验室为总部，以企业安全公司、移动安全公司为两翼的集团化安全企业。安天始终坚持以安全保障用户价值为企业信仰，崇尚自主研发创新，在安全检测引擎、移动安全、网络协议分析还原、动态分析、终端防护、虚拟化安全等方面形成了全能力链布局。安天的监控预警能力覆盖全国、产品与服务辐射多个国家。安天将大数据分析、安全可视化等方面的技术与产品体系有效结合，以海量样本自动化分析平台延展工程师团队作业能力、缩短产品响应周期。结合多年积累的海量安全威胁知识库，综合应用大数据分析、安全可视化等方面经验，推出了应对高级持续性威胁（APT）和面向大规模网络与关键基础设施的态势感知与监控预警解决方案。
全球超过三十家以上的著名安全厂商、IT厂商选择安天作为检测能力合作伙伴，安天的反病毒引擎得以为全球近十万台网络设备和网络安全设备、超过五亿部手机提供安全防护。安天移动检测引擎是全球首个获得AV-TEST年度奖项的中国产品。安天技术实力得到行业管理机构、客户和伙伴的认可，安天已连续四届蝉联国家级安全应急支撑单位资质，亦是中国国家信息安全漏洞库六家首批一级支撑单位之一。安天是中国应急响应体系中重要的企业节点，在红色代码、口令蠕虫、震网、破壳、沙虫、方程式等重大安全事件中，安天提供了先发预警、深度分析或系统的解决方案。
关于反病毒引擎更多信息请访问：
|
（中文）
 （英文）  
---|---  
关于安天反APT相关产品更多信息请访问：
|
[http://www.antiy.cn](http://www.antiy.cn/) __  
* * *