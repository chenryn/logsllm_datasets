的是：不要给网络管理员带来麻额，不要影响局域网的正常运转。
小技巧：除了上述方法，还有一个突破的方法也比较引人注目，这个突破方法叫虚拟网卡技术，
需要使用SofEther软件.其原理是模拟以太网卡的工作顺序，模拟Hub功能特性，
实现VPN的功能，遥过此方法，可以使系统把SofEthcr识别成一块网卡，有了这个
东西，局城网内部的机器就能通过模拟网卡连通外部网络
4.4实用的反恶意代码工具
4.4.1抽丝剥茧：循序渐进巧解“IFEO映像劫持”
在网络冲浪的过程中，我们总会浏览形形色色的网页，偶尔碰到木马或病毒也会成为家常
便饭。不过，对于一些比较顽固的、较新的木马病毒，往往也难以找到合适的查杀工具。圣诞
节前的某一天，在浏览贺卡、接收礼物时，一向小心谨慎的作者还是遇到了类似的难题。尽管
安装了Ghost等系统恢复软件和瑞星等杀毒软件，但N次恢复之后仍然毫无进展，杀毒软件也
无法运行。看来，要清理此类顽固病毒，就得采用“抽丝剥茧”的方法了，即“丝得一根一根
地抽，茧得一层一层地剥”，找到症结才是解决问题的关键所在。
1.偶遇疆扰：“删不掉”的system.dll
操作系统文件”，同时选中“显示所有文件和文件夹”。很快，发现每个磁盘下都有autorun.inf
201.
---
## Page 211
网络安全进阶笔记
和system.dl文件，不过，直接删除文件之后大约3秒钟，这两个文件又生成了，看来有进程
在时刻监控这两个文件。更郁闷的是，金山毒霸、瑞星等杀毒软件无法启动，注册表也无法打
开。重新安装系统后，问题依然存在，看来，这个病毒的复制能力是很强的。查看autorun.inf
文件，具体内容如图4.35所示。
torm. inf -记本
文式
shetarapen
hellvexplore\ct
图4.35查看autorun.inf文件
般情况下，autorun.inf是用在光驱上实现光盘自动播放的工具，本身没有恶意作用，但
是很容易被病毒用于非法传播。在这台电脑上出现非自定义的autorun.inf文件，肯定是不正常
的。从该文件的字面意义来看，是rundll32调用了这个system.dll病毒控件。那么，是否存在.exe
非法文件呢？按照蛛丝马迹仔细查找之后，并没有发现.exe的可执行文件，而且系统还可以正
常显示系统文件和隐藏文件。尝试通过“msconfig”命令对运行的服务进行设置，依然无法解
决问题。重启之后，尝试删除autoruninf和system.dll两个文件，依然再生，看来，这个autorun.inf
和system.dl文件还是有点来头的
通过百度和谷歌搜案以及日期反映，很快发现这在网络上已经不是个别现象丁，面且大有
蔓延之势。更郁闷的是，网络上一时也没有比较理想的解决办法。根据各方资料初步判断，
system.dll病毒是一个结合了“机器狗、AV终结者和利用MS08067漏洞攻击”的复合型下载
者病毒。“虾有虾道，蟹有蟹道”，一番摸索之后，肯定会有解决问题的办法。
2.顺藤摸瓜：像胞丁解牛一样清除病毒
根据以往的经验，首先要使用专业的工具来了解一下中毒到底有多“深”。这里选择了
SREng（SystemRepairEngincer），这是一款计算机安全辅助和系统维护辅助软件，该软件主要用
于发现、发掘潜在的系统故障和大多数由于计算机病毒造成的破坏，并提供了许多的修改建议
和自动修复方法。软件下载地址为http://www.kztechs.com。
（1）牛刀小试：使用SREng了解进程信息。
安装并运行SREng后，打开第一项注册表项，里面有很多已经用红字标注的那些被病毒
添加的注册表项。运行SREng后，查看启动项，可以发现许多类似“IFEO[antiexe]”的红色
提示信息，如图4.36所示。
看来，电脑所中的病毒和IFEO有关。所谓的IFEO，就是ImageFile ExecutionOptions
位于注册表的[HKEY_LOCAL_MACHINEISOFTWAREMicrosoftWindowsNTCurrentVersion
ImageFileExecutionOptions项，由于该项主要用来调试程序，对一般用户意义不大。结合上
述分析判断，这些红色标记自启动项很可能在上述注册表项中。除了上述的注册表启动项，还
有一些如services.exe、system.exe之类的进程，这些可能也是病毒程序添加的。对于这些可疑
的注册表项，当然是希望能够尽快删除了。不过，现在的问题在于：无法打开注册表，也就谈
202
---
## Page 212
第4章拒绝恶意代码与神秘的黑客
不上对对注册表进行有效操作了。直接使用SREng按Shift键连续选择并删除，刷新之后问题
依然存在。看来，这些注册表开机运行项并不是能够轻易删除的。不过，初次的尝试也略有收
获，那就是Image File ExecutionOptions 中的大量安全软件都被“劫持”了，所以大部分杀毒
软件无法启动。
JODL,
口
小
40
5.1.260
Fea 2 9434 200)
Systeg Bagair Bagie
2.1.0.1200
图4.36安装井运行SREng
（2）蛛丝马迹：通过日志判断非法的病毒程序。
SREng提供了智能扫描功能，通过它的日志也许能够找出一些蛛丝马迹，单击软件界面左
侧的“智能扫描”按钮，出现了一个智能扫描界面，选择相关扫描选项后，单击“扫描”按钮，
很快生成了一份日志报告，如图4.37所示。
20/
图4.37SREng日志报告
20K
---
## Page 213
网络安全进阶笔记
通过日志分析，发现了许多可疑的内容，尤其是“正在运行的进程”中，频繁出现以下语
下所示
正在运行的进程
[PID:716/ SYsrEM](C:\Windows\system32\1sass.exe][(Verified） Microsoft
Corporation,5.1.2600.2180 (xpsp_op2_rtm.040803-2158))
[PID: 972 / NETWORK SERVICE] [C:\Windows\system32\svchost.exe]((Verified)
[C:\Windows\aystem32\7epIpDog0.d11][s/A,]
Microsoft Corporation, 5.1.2600.2180 (xpsp_sp2_rtm.040803-2158))
[C:\Windows\ayatem32\TcpIpDog0.d11][N/A,1
[PID: 1104/ NETwORK SERVICE][C:\Windows\system32\svchost.exe][(Verified)
Microsoft Corporation,5.1.2600.2180 (xpsp_sp2_rtm.040803-2158))
[C:\Windows\aystem32\7epIpDog0.d11][8/A,1
[PID: 1192 / LOCAL SERVICE] [C:\Windows\system32\svchost .exe][ (Verified)
Microsoft Corporation, 5.1.2600.2180 (xpsp_sp2_rtm.040803-2158))
[C:\Windows\ayatem32\rcpIpDog0.d11][8/A,]
[PID: 1956 / SYSTEx] [C:\windows\system32\inetsrv\inetinfo,exe][ (Verified)
Microsoft Corporation, 5.1.2600.2180 (xpsp_sp2_rtm.040803-2158))
[C:\Windows\system32\TepIpDog0.d11][8/A,]
小知识：DLL与病毒.DLL是一种磁盘文件，以.dll、.DRV、FON、.SYS和许多以.exe为扩
展名的系统文件都可以是DLL，一般来说，DLL由全局数据、服务函数和资源组成，
在运行时被系统加载到调用进程的虚拟空间中，成为调用进程的一部分，如果与其他
DLL之间没有冲突，该文件通需映射到进程虚拟空间的同一地址上，由于DLL具有
占用内存小、编辑简单等特点，因此被很多病毒加以利用，不过，DLL动态链接库通
需不能直接运行，也不能接收消息，它们是一些独立的文件，其中包含能被可执行程
序或其他DLL调用来完成某项工作的函数，只有在其他模块调用动态链接库中的函
数时，它才发挥作用。
通过查看各个进程调用的DLL动态链接库，现在基本可以确定，非正常的文件为
TeplpDog0.dll。这里的TeplpDog0.dll是启动项，是初始化动态链接库，但是有病毒通过修改
TcplpDog0.dll米执行，通过修改[HKEY_LOCAL_MACHINE\SOFTWARE\MicrosoffiWindows
NTCurrentVersioniImageFileExecutionOptions项，可以误导某些可执行程序的路径。看来，
这就是我所遇到的所谓“映像劫持”了。但是，目前大部分的进程都在使用那个文件，该怎么
办呢？
（3）锁定目标：斩断非法文件之间的联系。
当然，直接删除背定会存在一些间题，系统提示：“无法删除TeplpDogo，访间被拒绝”
出现这种情况的原因是多方面的，比较常见主要有：一是程序的某些功能模块正插入到系统进
程中，比如某些程序的DLL文件或者可执行程序正在运行，此时利用常规手段是无法删除的：
二是某个文件正被运行，此时文件的删除也是无法正常进行的，很明显，这里的问题属于前者。
现在必须使用强制刷除工具了.一般情况下，删除顽固文件时，可以使用Unlocker或IceSword。
不过，lceSword在这里却无法运行。
204
---
## Page 214
第4章拒绝恶意代码与神秘的黑客
①使用Unlocker删除非法的TeplpDog0.dn文件。下载最新的Unlocker V1.8.7，软件下
载地址为 http://www.onlinedown.net/soff/24732.htm
UnlockerV1.8.7是一个免费的解锁工具，如图4.38所示。当用户发现有文件或进程无法删
除时，可以通过右键菜单中的Unlocker命令进行解锁。值得一提的是，它并非强制关闭的程序，
而是以解除进程与程序关联性的方式进行，因此不会造成数据丢失，在这里，运行Unlocker
V1.8.7，对相关进程全部解锁，依然不能马上删除该文件。但是，软件提示“文件不能被删除，
在下次重新启动时，你想执行删除操作吗？”单击“确定”按钮，在下次重新启动时，
TeplpDog0.dll文件将会被删除。
ledrL
C
1192
图4.38使用Unlocker删除非法文件
②锁定非法的服务名。病毒清理的过程往往是让人头疼的，重启之后再次运行SREng，
剩除Image File ExecutionOptions下的被劫持文件，删除之后仍然毫无进展。看来，这些病毒
文件之间仍然存在着千丝万缕的联系。为了斩断这些文件之间的联系，在SREng中，单击左
侧的“启动项目”按钮，直接打开“服务”选项卡并单击“驱动程序”按钮。在“驱动程序”
界面中，出现了一些比较异常的服务名，如 NsPsDk00、NsPsDk01、NsPsDk02、NsPsDk03、
NsPsDk04等。这些文件应该算是一些典型病毒中的“常客”了，如图4.39所示。
为了验证这种判断，这里下载了一个“360顽固木马专杀大全”，软件下载地址为
http:/www.360.cn。初步扫描后，发现软件界面也提示NsPsDk00、NsPsDk01、NsPsDk02、
NsPsDk03、NsPsDk04等文件为木马文件。但是，使用“360顽固木马专杀大全”删除这些非
法文件时却毫无反应。
看来，必须尽快斩断这些非法文件之间的联系。重新回到SREng中，在“驱动程序”界
面选中这些服务名并选中“删除服务”单选按钮，单击右侧的“设置”按钮，逐个删除可疑的
系统提示在重启之后会生效，
205
---
## Page 215
网络安全进阶笔记
动员量：
3960
口度已认证的软目
图4.39浏览异常的服务名
③关闭驱动器的自动播放功能。通过上述方法，采用Unlocker删除C:WindowsiSystem32
目录下的 NsPass0.sys、NsPassl.sys、NsPass2.sys、NsPass3.sys、NsPass4.sys 等文件，不过，在
频繁的系统重新启动之后，这些文件依然存在，看来，症结应该就在这里了！清理过程中，根
据软件的提示频繁重新启动系统。在等待的过程中，也给作者一个启发：难道系统重启之后，
每次都会自动运行并加载system.dll文件？看来，必须马上关闭驱动器的自动播放功能。
找到症结之后，问题就好办了，关闭驱动器自动播放的步骤为：选择“开始→运行”，输
双击右方组策略窗口中的“关闭自动播放”，在打开的窗口中选择“已启用”复选框，并在“关
闭自动播放”下拉列表框中选择“所有驱动器”，如图4.40所示。
关闲自动胶性
EC)
b
上一设量量
应用
图4.40关闭自动播放
---
## Page 216
第4章拒绝恶意代码与神秘的黑客
（4）抽丝剥茧：彻底清除system.dll文件。
手工清除病毒是很辛苦的，有很多病毒会下载大量的木马，如果一个一个地删除，往往会