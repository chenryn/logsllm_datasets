» Application level filtering
> Define an ACL and use it for application access control
> Use views to restrict the exposure
© 2002 Sécurité.Org
25
Admin : SNMP (3)
» SNMP v3
> Define a user/group and what the group can do
» Two security advisories
> The “hidden” ILMI community (show snmp community 
shows all communities)
> Read-write community available with a read only access
> SNMP-wide bug (ASN.1)
snmp-server group engineering v3 priv read cutdown 10
snmp-server user nico engineering v3 auth md5 myp4ss priv des56 mydes56
snmp-server view cutdown ip.21 excluded
access-list 10 permit x.x.x.x
access-list 10 deny any log
© 2002 Sécurité.Org
26
Admin : Secure Shell (1)
» SSHv1 (client and server) support
> Routers  : as of 12.1(1)T/12.0(10)S (go for an image with 
3DES), scp as of 12.2T
> Switches : CatOS 6.x
» What are the risks/limitations ?
> Cisco’s implementation is based on SSH v1 and suffered 
from the same bugs : key recovery, CRC32, traffic analysis 
(SSHow), timing analysis and attacks
> You can’t force 3DES only nor use keys
> Fixed in 12.0(20)S, 12.1(8a)E, 12.2(3), ...
© 2002 Sécurité.Org
27
hostname 
ip domain-name 
crypto key generate rsa
ip ssh timeout 60
ip ssh authentication-retries 3
ip scp server enable
Admin : Secure Shell (2)
» SSH configuration
» scp configuration
© 2002 Sécurité.Org
28
Admin : IPsec (1)
» IPsec configuration
> Deny all traffic except IPsec related/decrypted
> Define a SA (Security Association) : traffic to encrypt
> Define an IKE policy
interface xy
ip address y.y.y.y 255.255.255.0
ip access-group 100 in
access-list 100 permit udp host x.x.x.x host y.y.y.y eq 500
access-list 100 permit esp host x.x.x.x host y.y.y.y
access-list 100 permit ahp host x.x.x.x host y.y.y.y
access-list 100 permit ip  
access-list 110 permit ip x.x.x.x  y.y.y.y 
crypto isakmp policy 1
hash md5
encryption 3des
authentication pre-share
! DH group (1024 bits)
group 2
crypto isakmp key  address y.y.y.y
© 2002 Sécurité.Org
29
crypto ipsec transform-set 3desmd5 esp-3des esp-md5-hmac
crypto map mycryptomap 10 ipsec-isakmp
set peer y.y.y.y
set transform-set 3desmd5
match address 110
interface xy
crypto-map mycryptomap
Admin : IPsec (2)
» IPsec configuration
> Define the transform-sets (tunnel mode is better, use 
transport with Win2K -- easier)
> Put all together in a crypto-map
> And affect it to an interface
© 2002 Sécurité.Org
30
service password-encryption
enable secret 5 
service tcp-keepalives-in
line vty 0 4
exec-timeout 0 60
access-class 10 in
transport input ssh
transport output none 
transport preferred none
access-list 10 permit x.x.x.x
Admin : local users/passwords
» Local users
> Encryption type 7 is reversible, MD5 as of 12.1(8a)E
» Enable secret
> Use MD5 (type 5)
» Access method
> Remove telnet and enable SSH
> Don’t forget the console and AUX port
© 2002 Sécurité.Org
31
aaa new-model
aaa authentication login default tacacs+ enable
aaa authentication enable default tacacs+ enable
aaa accounting exec default start-stop group tacacs+
ip tacacs source-interface loopback0
tacacs-server host x.x.x.x
tacacs-server key K3y
aaa accounting commands 15 default start-stop group tacacs+
AAA: Authentication / Accounting
» Authentication/accounting : RADIUS/TACACS+
» Command accounting (TACACS+ only)
© 2002 Sécurité.Org
32
privilege exec level 15 connect
privilege exec level 15 telnet
privilege exec level 15 ssh
privilege exec level 15 rlogin
privilege exec level 15 show logging
privilege exec level 15 show [ip] access-lists
username seeandgo privilege autocommand show running
AAA: Authorization
» Privilege levels
> 1 (user EXEC “view only”) to 15 (privileged EXEC “enable”)
> No intermediate levels on switches
> Change the privilege level (reduces information disclosure 
and avoids a stepping stone)
> A user can only see parts of the configuration he is allowed 
to change or gets a view-and-disconnect
» Command authorization
> Only supported with TACACS+
© 2002 Sécurité.Org
33
AAA: Kerberos (1)
» Cisco Routers
> Kerberized Telnet and password authentication using 
Kerberos (telnet, SSH and console)
> Can map instance to Cisco privilege (locally defined)
> Feature name : Kerberos V client support (Enterprise)
> Not supported on all hardware (16xx, GSR, etc)
» Cisco Switches
> Telnet only (SSH available as of 6.1 but w/o Kerberos 
support)
> At least SE Software Release 5.x
> Only supported on Catalyst 4K, 5K and 6K/6500 (with SE I, 
not SE II)
© 2002 Sécurité.Org
34
aaa authentication login default krb5-telnet local
aaa authorization exec default krb5-instance 
kerberos local-realm COLT.CH
kerberos srvtab entry host/...
kerberos server COLT.CH 192.168.0.14
kerberos instance map engineering 15
kerberos instance map support 3
kerberos credentials forward 
line vty 0 4
ntp server 192.168.0.126
set kerberos local-realm COLT.CH
set kerberos clients mandatory
set kerberos credentials forward
set kerberos server COLT.CH 192.168.0.82 88
set kerberos srvtab entry host/... 
set authentication login kerberos enable telnet primary
set authentication enable kerberos enable telnet primary 
set ntp client enable
set ntp server 192.168.0.11
AAA: Kerberos (2)
» Kerberos on a router
» Kerberos on a switch
© 2002 Sécurité.Org
35
ACLs (1)
» IP filtering with ACLs
> Is not stateful and doesn’t do any reassembly
> log-input also logs the source interface and the source MAC 
address
> Only the first fragment is filtered (unless you use the 
fragment keyword)
» Well known ACL types
> Standard : source IP address only (1-99, 1300-1999)
> Extended : limited to IP addresses, protocols, ports, 
ACK/RST (“established”) bit is set, etc. (100-199, 2000-
2699, “named” ACLs)
© 2002 Sécurité.Org
36
ACLs (2)
» Other “kinds” of ACLs
> TurboACL : uses a hash table, benefits when 5+ ACEs
> Reflexive : enables on-demand dynamic and temporary 
reply filters (doesn’t work for H.323 like protocols)
> Dynamic : adds user authentication to Extended ACLs
> Named : allows you to delete individual ACEs
> Time-based : adds a time-range option
> Context-Based Access-Control : “inspects” the protocol 
(helper/proxy/fixup-like), used in conjunction with ACLs
> MAC : filters on MAC address (700-799 for standard, 1100-
1199 for extended)
> Protocol : filters on protocol type (200-299)
© 2002 Sécurité.Org
37
ACLs (3)
» Example : Extended ACL on a router
» ACLs on a Multi-Layer Switch
> ACLs defined on Layer 3 (S/E/R/D) are pushed to the NMP 
(TCAM)
> Traffic will not hit the MSCF if you don’t use log[-input], ip 
unreachables, TCP Intercept
> VACLs (VLAN) : can filter IP level traffic and are pushed 
from the PFC to the switch
no access-list 100
access-list 100 permit 
access-list 100 deny tcp any range 1 65535 any range 0 65535 log
access-list 100 deny udp any range 1 65535 any range 0 65535 log
access-list 100 deny ip any any log-input
© 2002 Sécurité.Org
38
Router integrity checking (1)
» Four steps to build a tripwire-like for IOS/CatOS
> 1. Store your routers and switches configurations in a 
central (trusted) repository (CVS for example)
> 2. Get the configuration from the device (scripted telnet in 
Perl or expect, rsh, tftp, scp) or have the device send you 
the configuration (needs a RW SNMP access)
> 3. Check : automatically (cron/at job), when you see 
“configured by ” or a router boot in the logfile or 
when you get the “configuration changed” SNMP trap
snmpset -c   .1.3.6.1.4.1.9.2.1.55. s 
© 2002 Sécurité.Org
39
Router integrity checking (2)
» Four steps to build a tripwire-like for IOS/CatOS
> 4. Diff the configuration with your own script or use 
CVS/Rancid
» Limitations and details
> You still have to trust the running IOS/CatOS (no Cisco 
“rootkit” yet) and your network (MITM attacks)
> The configuration is transmitted in clear text over the 
network (unless you use scp or IPsec to encrypt the traffic)
> Do not forget that there are two “files”: startup-config and 
running-config
> Do the same for the IOS/CatOS images
> Cisco MIBs : CISCO-CONFIG*
© 2002 Sécurité.Org
40
“Inside Cisco IOS software architecture”  - Cisco Press :
- “In general, the IOS design emphasizes speed at the expense of
extra fault protection”
- “To minimize overhead, IOS does not employ virtual memory
protection between processes”
- “Everything, including the kernel, runs in user mode on the
CPU and has full access to system resources”
Router integrity checking (3)
» Cisco IOS rootkit/BoF/FS : is it possible ?
> Proprietary, closed source OS running on MIPS (newer 
models) or Mot68K (older models)
> Closed source but “fork” from (BSD) Unix
- (zlib/SNMP bugs :-)
> ELF 32-bit MSB executable, statically linked, stripped
> What is possible with remote gdb access :
- gdb {kernel¦pid pid-num} ?
> Is the ROMMON a good starting point (local gdb) ?
© 2002 Sécurité.Org
41
Router integrity checking (4)
» Cisco IOS rootkit/BoF/FS : open questions/issues
> No (known) local tools/command to interact and “play” with 
the kernel, memory, processes, etc.
> What can be done in enable engineer mode ?
> Is it possible to upload a modified IOS image and start it 
without a reboot (like “Linux two kernel monte”) ?
- by using dual RPs (Route Processors) - stateful in the future
- by upgrading LCs only (Line Cards)
> A lot of different images exist (but providers usually go for 
~12.0(x)S) and a tool to patch images would be required
- 37 feature sets and 2500 images out there (90% IP FS)!
> What will happen with IOS-NG (support for loadable 
modules) ?
- Is Cisco still working on it ? GSR dedicated team ?
© 2002 Sécurité.Org
42
Router forensics (1)
» Architecture and data flows
Exports/Polling
Stored locally
Needs
Flash
(non-volatile)
(D)RAM
(volatile)
Router
- DHCP/BOOTP
- (TFTP) Configuration
- NTP clock sync.
- Local or remote IOS image
- (Running) IOS
- running and
startup-config
- Running IOS &
processes
- Routing
information
- (Debug) log
- History, etc.
- Syslog
- ACLs with log[-input] keyword (filter ACLs, uRPF, …)
- “System” information (interface flaps, errors, BGP
session flap/MD5 failure, configuration change)
- SNMP traps/errors
- AAA logs
- Core dumps
- Netflow accounting data
- Routing protocol information
- Scripted telnet/expect/Perl
© 2002 Sécurité.Org
43
Router forensics (2)
» Checking your remote logs and accounting data
» Reading the flash card
> ftp://ftp.bbc.co.uk/pub/ciscoflash/
» What to do before/after reboot ?
> Local buffers/logs
> Reboot with which config-register ? Normal or ROMMON ?
» How to connect to the router ?
> Telnet/SSH or local console ?
© 2002 Sécurité.Org
44
Image: http://www.inforamp.net/~dredge/funkycomputercrowd.html
That’s all folks :-)
» Latest version of this document & presentation 
including tips/commands to secure routers (IOS) and 
switches (Cat(I)OS)
» Questions ?