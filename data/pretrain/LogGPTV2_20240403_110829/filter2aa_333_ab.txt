 ntoffset=HashDataOffset+8bytes(0x08)
 ParseasifNTLMispresent
Note:Theabove4byteincrementsusedintheoffsetcalculationsareusedtoskip
thestartandenddelineatorsthatarepresentinthedatastructure.
Whenatoolemploystheabovelogictofigures3Aand3B,theendresultistheLM
andNTLMhashdataelementsfromeachstructure:
9AC412C7DA10C788963DF9DF7E6B5EF4 (LM HASH DATA) 
  B0FD8B04845B3E6836EC62EDD3EC84CA (NTLM HASH DATA) 
Figure:4A(LMandNTLMHashDataStored)
  B0FD8B04845B3E6836EC62EDD3EC84CA (NTLM HASH DATA) 
Figure:4B(OnlyNTLMHashDataStored)
Asseenabove,whenatoolemploysthislogicitcanaccuratelyextractpassword
hashdataforthisuser.Afterthisinformationisobtainedbyatool,theresulting
hashdatacanthenbepassedtocryptographicalgorithmstodecodehashdataand
translateintotypicalLMandNTLMhashes.Thesehashescanthenbesuppliedtoa
crackingtoollikeJohntheRipper(JtR)toobtaintheclear‐textpasswords.
Asnotedpreviously,theaboveparsinglogicisusedbynearlyalltheregistry‐based
extractiontoolsexamined.Withthatinmind,acloserlookattheFandVdatafor
anaccountaffectedbythehashcorruptionproblemisilluminating.Thefollowing
figuresshowanexampleofthis:
HKEY_LOCAL_MACHINE\sam\sam\domains\account\users\000003ed 
    F   REG_BINARY      0200010000000000000000000000000000000000000000001C61A42C 
0F5ACD010000000000000000A4CE64640E5ACD01ED03000001020000100200000000000002000000 
000000000000000000844400 
    V   REG_BINARY      00000000D400000002000100D40000000A00000000000000E0000000 
0A00000000000000EC0000000000000000000000EC0000000000000000000000EC00000000000000 
00000000EC0000000000000000000000EC0000000000000000000000EC0000000000000000000000 
EC0000000000000000000000EC0000000000000000000000EC00000015000000A800000004010000 
08000000010000000C01000014000000000000002001000014000000000000003401000094000000 
00000000C8010000840000000000000001001480B4000000C4000000140000004400000002003000 
0200000002C014004400050101010000000000010000000002C01400FFFF1F000101000000000005 
070000000200700004000000000014005B03020001010000000000010000000000001800FF070F00 
0102000000000005200000002002000000001800FF070F0001020000000000052000000024020000 
00002400440002000105000000000005150000003FAD1462235F636B07E53B2BED03000001020000 
00000005200000002002000001020000000000052000000020020000740065007300740032000000 
740065007300740032000100FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5B3E6801020000 
07000000010001009AC412C7DA10C788963DF9DF7E6B5EF401000100B0FD8B04845B3E6836EC62ED 
D3EC84CA0100010015F478C0D71D99AB56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF17 
8E47CFC180A85D50451DBBCD73DB89F3E81DC94989A51D23610F8669762EBFD5DF73B40F40B95683 
5E95719E0C18D4B27CAC2754CA807AD818CB4C27677A52621BA0A5AFB8CAA34AC3DFCDA8054B9395 
14CD7E8A51840220C7E1AF65C0865C015E517C522EAB6710181584F4E2D0652C0100010030077263 
8DEB345851FF5B0CCA0123BB9B5C279A405AC24B0E98A583843488CD968264658858D5560A2047DB 
06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1C091EDDC0C054E6A47881065C4F38C5C 
F888781246B88769BCE6E08E3ADBC06193EF250EC43775C8A5AE558A44F87484AED9BE0B73464DCD 
A257CC67 
Figure:5A(LMandNTLMHashDataStored)
HKEY_LOCAL_MACHINE\sam\sam\domains\account\users\000003ed 
    F   REG_BINARY      02000100000000000000000000000000000000000000000001174DC0 
0E5ACD010000000000000000A4CE64640E5ACD01ED03000001020000100200000000000002000000 
000000000000000000844400 
    V   REG_BINARY      00000000D400000002000100D40000000A00000000000000E0000000 
0A00000000000000EC0000000000000000000000EC0000000000000000000000EC00000000000000 
00000000EC0000000000000000000000EC0000000000000000000000EC0000000000000000000000 
EC0000000000000000000000EC0000000000000000000000EC00000015000000A800000004010000 
08000000010000000C01000004000000000000001001000014000000000000002401000064000000 
0000000088010000540000000000000001001480B4000000C4000000140000004400000002003000 
0200000002C014004400050101010000000000010000000002C01400FFFF1F000101000000000005 
070000000200700004000000000014005B03020001010000000000010000000000001800FF070F00 
0102000000000005200000002002000000001800FF070F0001020000000000052000000024020000 
00002400440002000105000000000005150000003FAD1462235F636B07E53B2BED03000001020000 
00000005200000002002000001020000000000052000000020020000740065007300740032000000 
740065007300740032000100FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5B3E6801020000 
070000000100010001000100B0FD8B04845B3E6836EC62EDD3EC84CA0100010015F478C0D71D99AB 
56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF172549756090BA6CB58D6EB32C31E0714E 
B7CF5C2A4073BEBF1C979A4CD4F07404747D0EAE50AB676696E6797F4E232C0F7CAC2754CA807AD8 
18CB4C27677A526201000100BB10DCCFE8681DD551FF5B0CCA0123BBB83FA6A3F659351C0E98A583 
843488CDB5E1E55C3E5B22010A2047DB06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1 
C091EDDC0C054E6A47881065 
Figure:5B(OnlyNTLMHashDataStored)
Theprimarydifferencesinthebinarydataforwhatisstoredinfigures2Aand2B
versuswhatisstoredinfigures5Aand5Barehighlightedingreen.Thisadditional
dataispresentwhenanadministratorenablespasswordhistories(topreventuser
passwordre‐use)andtheaccount’spasswordchanges.Basedonourobservationof
howthestructuregrowseverytimeapasswordresetoccurs,thisistheprobable
storagelocationofhashdataforpreviouspasswords.
Let’snowtakeanotherlookathowthede‐facto‐standardlogicthatwedescribed
aboveisaffectedbythischangeindatastructure.Assumingweusethesame
calculationtodetermineouroffset,wethenconsidertheremainderofthestructure
tobethehashdatasection.Belowweprovidethehashdatasectionforthe
examplesdescribedinFigures5Aand5B.
010001009AC412C7DA10C788963DF9DF7E6B5EF401000100B0FD8B04845B3E6836EC62EDD3EC84CA 
0100010015F478C0D71D99AB56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF178E47CFC1 
80A85D50451DBBCD73DB89F3E81DC94989A51D23610F8669762EBFD5DF73B40F40B956835E95719E 
0C18D4B27CAC2754CA807AD818CB4C27677A52621BA0A5AFB8CAA34AC3DFCDA8054B939514CD7E8A 
51840220C7E1AF65C0865C015E517C522EAB6710181584F4E2D0652C01000100300772638DEB3458 
51FF5B0CCA0123BB9B5C279A405AC24B0E98A583843488CD968264658858D5560A2047DB06FC1126 
9C826D74B1EA6C1F2B6293F992E0360D562D62A1C091EDDC0C054E6A47881065C4F38C5CF8887812 
46B88769BCE6E08E3ADBC06193EF250EC43775C8A5AE558A44F87484AED9BE0B73464DCDA257CC67  
(hash data section) 
Figure:6A(LMandNTLMHashDataStored)
0100010001000100B0FD8B04845B3E6836EC62EDD3EC84CA0100010015F478C0D71D99AB56AB61F0 
921DE0EF9C21D096BE07202EDF579D32EF31DF172549756090BA6CB58D6EB32C31E0714EB7CF5C2A 
4073BEBF1C979A4CD4F07404747D0EAE50AB676696E6797F4E232C0F7CAC2754CA807AD818CB4C27 
677A526201000100BB10DCCFE8681DD551FF5B0CCA0123BBB83FA6A3F659351C0E98A583843488CD 
B5E1E55C3E5B22010A2047DB06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1C091EDDC 
0C054E6A47881065  
(hash data section) 
Figure:6B(OnlyNTLMHashDataStored)
Whenwecheckthesizeofbothhashdatasections,forFigures6Aand6B,theyare
bothgreaterthan40bytes(0x28)inlength.Whatthismeansisthat,regardlessof
whetherLMhashdataispresent,wewillalwaysparsethehashdatasectionasifLM
andNTLMhasharepresent.Ifwefollowthislogic,thenweendupparsingthe
followinghashdatafromFigures6Aand6B.
9AC412C7DA10C788963DF9DF7E6B5EF4 (LM HASH DATA) 
  B0FD8B04845B3E6836EC62EDD3EC84CA (NTLM HASH DATA) 
Figure:7A(LMandNTLMHashDataStored)
01000100b0fd8b04845b3e6836ec62ed (BAD LM HASH DATA) 
  0100010015f478c0d71d99ab56ab61f0 (BAD NTLM HASH DATA) 
Figure:7B(OnlyNTLMHashDataStored)
AsseeninFigure7A,thislogiccorrectlyparsedVdatathatcontainedLMandNTLM
hashes,evenwithhistoricalpasswordhashesstored.However,Figure7Bshows
thatthislogicdoesnotcorrectlyparsethedatawhenitcontainshistoricalpassword
hashesandonlyaNTLMhash.
Itisthatpointthatleadstothecruxoftheissue,theflawedassumptionthatahash
datalengthgreaterthan40bytesindicatesthepresenceofbothLMandNTLM
hashes.Underthisflawedassumption,atooltaskedwithparsinganNTLMhash
only,followedbyhistoricalpasswordhashes,willalwaysincorrectlyparsewhatit
believestobethefirsthash(actuallyonlypartofthehash),sinceitisusingthe
incorrectoffset.Itwillalsothenattempttoparseasecondhashbutgetcompletely
junkdatabecauseitisreadingintoanotherdatastructure(thehistoricalhashes).
Thisissuehasgoneundetectedbymanyextractiontoolsduetothefactthe
corrupteddataisjusthashsourcedata,whichisthenpassedtocryptographic
functionswhichresultinacorruptedLMandNTLMhashasdescribedinFigures1A
and1B.ThisexplainswhytheresultingLMandNTLMhasheslookandfeellike
validhashes,however,theyarenotatruerepresentationoftheusersencrypted
password.
Afterdiscoveringrootoftheissue,analternatealgorithmwaspursuedtoworkfor
scenerioswithorwithouttheadditionaldata(showningreeninexamples7A,7B,
6A,6B,5A,5B).Whatwaslearnedwasthatearlierinthe”V”datastructureforeach
userthereareheadervaluesthatdescribewhathashdataisbeingstoredforthe
user.Thefollowingfiguresshowthehighlightedheadervaluesthatdescribe
whethertheLMofNTLMhashdataispresent.
HKEY_LOCAL_MACHINE\sam\sam\domains\account\users\000003ed 
    F   REG_BINARY      0200010000000000000000000000000000000000000000001C61A42C 
0F5ACD010000000000000000A4CE64640E5ACD01ED03000001020000100200000000000002000000 
000000000000000000844400 
    V   REG_BINARY      00000000D400000002000100D40000000A00000000000000E0000000 
0A00000000000000EC0000000000000000000000EC0000000000000000000000EC00000000000000 
00000000EC0000000000000000000000EC0000000000000000000000EC0000000000000000000000 
EC0000000000000000000000EC0000000000000000000000EC00000015000000A800000004010000 
08000000010000000C01000014000000000000002001000014000000000000003401000094000000 
00000000C8010000840000000000000001001480B4000000C4000000140000004400000002003000 
0200000002C014004400050101010000000000010000000002C01400FFFF1F000101000000000005 
070000000200700004000000000014005B03020001010000000000010000000000001800FF070F00 
0102000000000005200000002002000000001800FF070F0001020000000000052000000024020000 
00002400440002000105000000000005150000003FAD1462235F636B07E53B2BED03000001020000 
00000005200000002002000001020000000000052000000020020000740065007300740032000000 
740065007300740032000100FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5B3E6801020000 
07000000010001009AC412C7DA10C788963DF9DF7E6B5EF401000100B0FD8B04845B3E6836EC62ED 
D3EC84CA0100010015F478C0D71D99AB56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF17 
8E47CFC180A85D50451DBBCD73DB89F3E81DC94989A51D23610F8669762EBFD5DF73B40F40B95683 
5E95719E0C18D4B27CAC2754CA807AD818CB4C27677A52621BA0A5AFB8CAA34AC3DFCDA8054B9395 
14CD7E8A51840220C7E1AF65C0865C015E517C522EAB6710181584F4E2D0652C0100010030077263 
8DEB345851FF5B0CCA0123BB9B5C279A405AC24B0E98A583843488CD968264658858D5560A2047DB 
06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1C091EDDC0C054E6A47881065C4F38C5C 
F888781246B88769BCE6E08E3ADBC06193EF250EC43775C8A5AE558A44F87484AED9BE0B73464DCD 
A257CC67 
Figure:8A(LMandNTLMHashDataStored)
HKEY_LOCAL_MACHINE\sam\sam\domains\account\users\000003ed 
    F   REG_BINARY      02000100000000000000000000000000000000000000000001174DC0 
0E5ACD010000000000000000A4CE64640E5ACD01ED03000001020000100200000000000002000000 
000000000000000000844400 
    V   REG_BINARY      00000000D400000002000100D40000000A00000000000000E0000000 
0A00000000000000EC0000000000000000000000EC0000000000000000000000EC00000000000000 
00000000EC0000000000000000000000EC0000000000000000000000EC0000000000000000000000 
EC0000000000000000000000EC0000000000000000000000EC00000015000000A800000004010000 
08000000010000000C01000004000000000000001001000014000000000000002401000064000000 
0000000088010000540000000000000001001480B4000000C4000000140000004400000002003000 
0200000002C014004400050101010000000000010000000002C01400FFFF1F000101000000000005 
070000000200700004000000000014005B03020001010000000000010000000000001800FF070F00 
0102000000000005200000002002000000001800FF070F0001020000000000052000000024020000 
00002400440002000105000000000005150000003FAD1462235F636B07E53B2BED03000001020000 
00000005200000002002000001020000000000052000000020020000740065007300740032000000 
740065007300740032000100FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5B3E6801020000 
070000000100010001000100B0FD8B04845B3E6836EC62EDD3EC84CA0100010015F478C0D71D99AB 
56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF172549756090BA6CB58D6EB32C31E0714E 
B7CF5C2A4073BEBF1C979A4CD4F07404747D0EAE50AB676696E6797F4E232C0F7CAC2754CA807AD8 