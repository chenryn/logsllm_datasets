CATCHING	
  MALWARE	
  EN	
  MASSE	
  :	
  DNS	
  &	
  IP	
  STYLE	
Dhia	
  Mahjoub	
@DhiaLite	
PI:EMAIL	
Thibault	
  Reuille	
   @ThibaultReuille	
   PI:EMAIL	
Andree	
  Toonk	
@atoonk	
PI:EMAIL	
DHIA	
  MAHJOUB	
2	
•  Senior	
  Security	
  Researcher	
  at	
  OpenDNS	
•  PhD	
  graph	
  theory	
  applied	
  on	
  sensor	
  networks	
•  Security,	
  graphs,	
  data	
  analysis	
•  @DhiaLite	
THIBAULT	
  REUILLE	
3	
•  Security	
  Researcher	
  at	
  OpenDNS	
•  Former	
  SoGware	
  Engineer	
  @	
  NVIDIA	
•  Security	
  and	
  VisualizaLon	
  ?	
•  @ThibaultReuille	
ANDREE	
  TOONK	
4	
•  Manager	
  of	
  Network	
  Engineering	
  at	
  OpenDNS	
•  Founder	
  and	
  lead	
  of	
  BGPMon.net	
•  @atoonk	
Agenda	
OpenDNS	
  presentaLon	
Catching	
  Malware	
  DNS	
  Style	
Catching	
  Malware	
  IP	
  style	
3D	
  Data	
  VisualizaLon	
Conclusion	
OpenDNS'	
  Network	
  Map	
STUB 
CLIENTS 
RECURSIVE 
NAME SERVERS 
AUTHORITATIVE 
NAME SERVERS 
root 
tld 
domain.tld 
DNS	
  Traﬃc	
Catching	
  Malware	
  DNS	
  style	
Crimeware	
  Ecosystem	
DNS	
  style	
Crimeware	
  Ecosystem	
DNS	
  style	
InvesNgaNon	
  Process	
Zbot	
  fast	
  ﬂux	
proxy	
  network	
Track	
  CnCs	
  w/
hadoop	
Track	
  CnCs	
  w/
streaming	
  DNS	
IdenLfy	
malware	
phoning	
  to	
  CnCs	
Pony	
  panel	
  on	
proxy	
  network	
Stats	
  about	
domains,	
  clients	
and	
  samples	
DNS	
  style	
Fast	
  Flux	
  Networks	
•  DNS-­‐based	
  redundancy/evasion	
  technique	
•  Fast	
  ﬂux	
  domain	
  resolves	
  to	
  many	
  IPs,	
  many	
  ASNs,	
  many	
CCs,	
  relaLvely	
  low	
  TTL	
•  Fast	
  ﬂux	
  domain	
  resolves	
  to	
  1	
  IP	
  with	
  TTL=0	
•  Ex	
  :	
  Trojan	
  CnCs,	
  spam,	
  scam,	
  pharmacy,	
  daLng	
  domains	
DNS	
  style	
Fast	
  Flux	
  Proxy	
  Networks	
  (ex:	
  Zbot)	
CnCs	
Targets	
Kelihos	
  TTL	
  =	
  0	
Zbot	
  TTL	
  =	
  150	
DNS	
  style	
Zeus	
  Crimeware	
  (1/2)	
DNS	
  style	
ConﬁguraLon	
  ﬁle	
Web	
  injects	
Zeus	
  builder	
Binary	
  ﬁle	
Zeus	
  Crimeware	
  (2/2)	
DNS	
  style	
Control	
  panel	
Zeus	
  Timeline	
DNS	
  style	
Zeus	
  CnCs	
Compromised	
Sites	
Bulletproof	
HosLng	
Fast	
  Flux	
  Botnet	
DNS	
  style	
Zeus	
  CnC	
  URLs	
ConﬁguraLon	
  Files	
Binary	
  Files	
Drop	
  Zones	
DNS	
  style	
Zeus	
  CnC	
  detecNon	
  Methods	
1)  Periodic	
  batch	
  pig	
  job	
  (Hadoop	
  script)	
2)  IP	
  harvesLng	
  +	
  streaming	
  authoritaNve	
  DNS	
  +	
  ﬁltering	
heurisLcs	
DNS	
  style	
DetecNon	
  with	
  Hadoop	
•  Periodic	
  Pig	
  job	
  extracts	
  domains	
  with	
  TTL	
  =	
  150	
•  Build	
  “domain	
  to	
  IP”	
  biparNte	
  graph	
•  Extract	
  largest	
  connected	
  component	
•  IdenLfy	
  new	
  zbot	
  CnCs	
  to	
  block	
•  Add	
  IPs	
  from	
  largest	
  connected	
  component	
  to	
  pool	
  of	
  zbot	
  IPs	
DNS	
  style	
AuthoritaNve	
  DNS	
  Stream	
ASN,	
  Domain,	
  2LD,	
  IP,	
  NS_IP,	
  Timestamp,	
  TTL,	
  type	
•  100s	
  –	
  1000s	
  entries/sec	
  (from	
  subset	
  of	
  resolvers)	
•  Need	
  to	
  implement	
  own	
  ﬁlters,	
  detecLon	
  heurisLcs	
•  Faster	
  than	
  DNSDB	
  on	
  Hadoop	
DNS	
  style	
DetecNon	
  with	
  DNS	
  stream	
• 
Seed	
  of	
  known	
  Zbot	
  CnCs	
• 
Harvest	
  IPs	
  and	
  add	
  them	
  to	
  pool	
  of	
  Zbot	
  IPs	
• 
Extract	
  domains	
  with	
  IP	
  or	
  NS_IP	
  in	
  Zbot	
  IP	
  pool	
• 
Add	
  new	
  Zbot	
  CnCs	
  to	
  seed	
DNS	
  style	
Data	
  VisualizaNon	
DNS	
  style	
Zbot	
  CnC	
  domains	
  –	
  IP	
  biparLte	
  graph	
Workﬂow	
DNS	
  style	
SemanNcNet	
  Library	
#!/usr/bin/env	
  python	
import	
  semanLcnet	
  as	
  sn	
graph	
  =	
  sn.Graph()	
a	
  =	
  graph.add_node({	
  "label"	
  :	
  “A”	
  })	
b	
  =	
  graph.add_node({	
  "label"	
  :	
  “B”	
  })	
c	
  =	
  graph.add_node({	
  "label"	
  :	
  “C”	
  })	
graph.add_edge(a,	
  b,	
  {	
  "type"	
  :	
  “belongs”	
  })	
graph.add_edge(b,	
  c,	
  {	
  "type"	
  :	
  “owns”	
  })	
graph.add_edge(c,	
  a,	
  {	
  "type"	
  :	
  “has”	
graph.save_json(“dataset.json”)	
DNS	
  style	
INSERT	
  DOMAIN-­‐IP	
  OVER	
  TIME	
  VISUALIZATION	
-­‐ 
We	
  have	
  graph	
  data	
  with	
  detecLon	
  methods	
-­‐ 
We	
  create	
  graph	
  with	
  SemanLcNet	
-­‐ 
Load	
  in	
  GraphiL	
  and	
  apply	
  force	
  directed	
-­‐ 
Build	
  event	
  Lmeline	
-­‐ 
Viz	
  over	
  Lme	
Results	
Zeus	
Citadel	
KINS	
&	
Ice	
  IX	
Conﬁg	
  URLs	
Binary	
  URLs	
Drop	
  Zone	
  URLs	
Misc	
Phishing	
Asprox	
DNS	
  style	
Results	
  :	
  Zeus	
  urls	
DNS	
  style	
Results	
  :	
  Citadel	
  urls	
DNS	
  style	
Results	
  :	
  KINS	
  &	
  Ice	
  IX	
  urls	
DNS	
  style	
Results	
  :	
  Phishing	
DNS	
  style	
Results	
  :	
  Asprox	
  (1)	
DNS	
  style	
Results	
  :	
  Asprox	
  (2)	
DNS	
  style	
Results	
  :	
  Misc	
• 
Madness	
  Pro	
  (Ddos	
  bot)	
  phoning	
  home	
netom.in,	
  GET	
  /1/?uid=17428742&ver=1.14&mk=bb3b62&os=WinXP&rs=adm&c=1&rq=0	
with	
  several	
  occurring	
  OS	
  versions:	
os=S2000	
os=Win07	
os=Win_V	
os=WinXP	
os=Win08	
DNS	
  style	
Results	
  :	
  Misc	
• 
Downloading	
  binaries	
  and	
  conﬁgs	
azg.su,	
  GET	
  /coivze7aip/modules/bot.exe	
tundra-­‐tennes.com,	
  GET	
  /infodata/soG32.dll	
tundra-­‐tennes.com,	
  GET	
  /info-­‐data/soG32.dll	
bee-­‐pass.com,	
  GET	
  /info/soG32.dll	
quarante-­‐ml.com,	
  GET	
  /nivoslider/jquery/	
quarante-­‐ml.com,	
  GET	
  /nivoslider98.45/ajax/	
quarante-­‐ml.com,	
  GET	
  /nivoslider98.45/jquery/	
tundra-­‐tennes.com,	
  GET	
  /nivoslider/ajax/	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
marmedladkos.com	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
•  Pony	
  1.9	
  leaked	
  for	
  Trojan	
  Forge	
  in	
  late	
  2012	
•  Info	
  stealer	
•  Win32/Fareit	
Payload	
  delivered	
  via:	
•  Drive-­‐by/Exploit	
  kit	
•  Avachment	
  in	
  spam	
  emails	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
DNS	
  style	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
-­‐p/Panel.zip	
  —	
  controlling	
  php	
  scripts	
-­‐includes/design/images/modules/*	
  —	
  images	
  for	
  each	
  zeus	
  plugin	
supported/tracked	
-­‐includes/password_modules.php	
  —	
  contains	
  array	
  with	
  all	
  soGware	
  it	
tries	
  to	
  steal	
  credenLals	
  for	
-­‐includes/database.php	
  —	
  contains	
  db	
  schema	
  and	
  accessors	
-­‐character	
  set	
  cp1251	
  used	
  everywhere	
-­‐mysql	
  storage	
  engine	
  is	
  MyISAM	
-­‐conﬁg.php	
  date_default_Lmezone_set(‘Europe/Moscow’)	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
Google	
  search	
  of	
  disLncLve	
  key	
  terms	
DNS	
  style	
malware	
Results	
  :	
  Pony	
  Panel	
  Discovery	
DNS	
  style	
Results	
  :	
  Pony	
  Panel	
  Discovery	
epvpcash.net16.net/Panel/temp/	
hg{g{g{fg.net/pony/temp/	
hvp://pantamaL.com/dream/Panel/temp/	
hvp://pantamaL.com/wall/Panel/temp/	
mastermetr.ru/steal/Panel/temp/	
microsoG.blg.lt/q/temp/	
santeol.su/p/temp/	
terra-­‐araucania.cl/pooo/temp/	
thinswares.com/panel/temp/	
www.broomeron.com/pn2/temp/	
www.kimclo.com/cli/temp/	
www.sumdfase2.net/adm/temp/	
www.tripplem2.com/images/money/temp/	
DNS	
  style	
Results	
  :	
  TLD	
  distribuNon	
Sample	
  of	
  925	
  zbot	
  CnC	
  domains	
DNS	
  style	
Results	
  :	
  Bots	
  geo-­‐distribuNon	
Sample	
  of	
  170,208	
  IPs	
  of	
  the	
  zbot	
  proxy	
  network	
  Map	
DNS	
  style	
UA	
  28	
  %	
RU	
  38	
  %	
Results	
  :	
  Bots	
  geo-­‐distribuNon	
DNS	
  style	
Results	
  :	
  Clients	
  phoning	
  to	
  CnCs	
2,220,230	
  DNS	
  lookups	
  to	
  CnCs	
  over	
  24	
  hours	
  Map	
DNS	
  style	
US	
  59	
  %	
Results	
  :	
  Clients	
  phoning	
  to	
  CnCs	
DNS	
  style	
CnC	
  domains	
  and	
  related	
  samples	
-­‐Sample	
  of	
  337	
  zbot	
  CnC	
  domains	
-­‐208	
  diﬀerent	
  samples	
  (sha256	
  communicated	
  with	
  the	
  CnCs)	
Top	
  recorded	
  sample	
  names:	
Trojan[Spy]/Win32.Zbot	
TrojanDownloader:Win32/Upatre	
-­‐Upatre	
  is	
  used	
  as	
  a	
  downloader	
  for	
  Zeus	
  GameOver	
-­‐Sent	
  as	
  avachment	
  in	
  spam	
  emails	
  delivered	
  by	
  Cutwail	
  botnet	
DNS	
  style	
Summary	
•  Zbot	
  fast	
  ﬂux	
  proxy	
  network	
  is	
  very	
  versaNle	
•  MulN-­‐purpose	
  based	
  on	
  clients’	
  needs	
•  CnCs	
  for	
  Zeus,	
  Citadel,	
  Ice	
  IX,	
  KINS,	
  Asprox,	