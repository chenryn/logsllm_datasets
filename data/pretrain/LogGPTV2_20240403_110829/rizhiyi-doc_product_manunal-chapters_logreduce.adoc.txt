== 模式学习
日志易的模式学习，又称“日志聚类”，界面入口在搜索页的输入框下，通过点击“模式”标签切换进入日志聚类界面。提供对原始日志根据raw_message字段的聚类功能（根据数据之间的相似度将数据分成相应的类）。通过机器自动归类以及对相关函数的计算，可方便用户对相似度高的日志数据集中分析。默认情况下，只会对10000条日志做聚类分析，可以通过改动SPL对应参数来调节改日志数限制。
image::images/logreduce.png[]
[NOTE]
====
执行模式学习的查询语句必须保证能正常返回至少包含raw_message、context_id、timestamp三个字段的信息。其中后二者用于聚类前的数据去重工作。
====
=== 聚类展示 
在“模式”的模块内，聚类列表所展示的维度有以下几种：
1. 趋势：每个模式内部事件的趋势曲线图
2. 数量：每个模式内部事件数量
3. 占比：事件数在全部数据中的占比
4. 层级：色块总数为模式内所有层级，而高亮色块数量为该模式所处层级。可通过下拉键选择层级，默认展示的是层级标注为“初始”的层级。
5. 模式：主语体现该模式下的日志内容格式，其中“******”代表的是该聚类内各日志中的差异内容。其右侧的按钮可以对该模式进行切分。
=== 模式设置
用户可设置是否启用IP和URL的模式替换，调整聚类的细节参数范围。除了IP与URL可选外，还有其它内置默认的几项，包括：DATE, TIME, ID, MAC,  HOST, NUM, EMAIL, *。大部分情况直接使用默认配置即可，如有特殊情况请联系日志易工作人员。
参数部分如图中所显示的，可将光标移动至函数上查看该函数的参数说明
image::images/logreduce-setting.png[]
系统也会给参数设置默认值，详细默认配置及各参数解释参考以下表格：
[options="header"]
|=======
|参数名|参数类型|是否可选|参数解释|默认值
|initial_dist|double 范围 [0,1]
|是
|初始距离参数，用于控制一个cluster内部pattern和center的最大距离
|0.01
|alpha
|double 范围{1,+~}
|是
|迭代过程中，dist每次增长的步伐 既下次的dist=alpha * 上次的dist (如果是一次迭代则是initial_dist
|1.8
|multi_align_threshold
|double 范围{0,1] 这些参数都将和迭代过程中的dist作比较
|是
|采用多模式对齐算法时的threshold
|0.1
|pattern_discover_align_threshold
|double 范围 [0,1] 这些参数都将和迭代过程中的dist作比较
|是
|采用pairwise寻找pattern时先做对齐的threshold
|0.05
|find_cluster_align_threshold
|double 范围 [0,1] 这些参数都将和迭代过程中的dist作比较
|是
|寻找cluster时先做对齐的threshold
|0.2
|stop_threshold
|double 范围 [0,1] 这些参数都将和迭代过程中的dist作比较
|是
|停止迭代的条件
|0.5
|mask_ip
|boolean 是否归并ip
|是
|true
|mask_url
|boolean
|是
|是否归并url
|false
|=======
=== 归并与切分
归并功能位于表右上方的“归并”按钮。可以将默认的聚类归并为更高级的聚类，并归并完成有文字提示。值得注意的是，切分后的模式不可直接归并，需首先返回默认状态。而当归并至最高层级时，按钮变灰不可用。
通过“后退”键，可在归并后回到操作之前的聚类。
切分功能位于表内每类模式的后方"切分"按钮。功能为切分当前的模式为更小的聚类，并支持多次切分，对于切分好的属于同一聚类的部分会通过底色高亮来提示。切分完成有文字提示。当不可继续拆分时，按钮变灰不可用。
=== 相关配置项
1. 由于性能的限制我们将对logreduce处理的每条日志的上限设置为500字符数，超过部分将被截断，该配置项位于splserver中的logreduce.max_log_length配置，如需单条日志支持更长的字符数修改该配置项即可
2. 由于性能的限制我们将对logreduce处理的日志的条数上限设置为10000条，超过部分将不进行计算，该配置项位于splserver中的logreduce.max_events配置，如需计算更多的日志则修改该配置项即可