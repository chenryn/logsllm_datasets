==== 模型训练与管理
在训练页面，拖动选择好样本时间范围以后，您可以直接在某个算法配置框底部直接点击训练按钮，开始训练。也可以勾选多个算法，在右侧点击批量提交，同时进行多个算法的模型训练。提交给训练的样本数据将使用当前展示范围的数据。
image::images/lynxee-kpi-training.png[]
有算法训练完成时，对应区域将提示"有新训练完成!"。同时，算法配置栏上方，自动展开已存训练模型数据菜单，在列出的全部已存模型中，最上方出现的就是本次训练新生成的算法模型。勾选即可点击下一步，进入模型验证页面。
系统自动为每个指标的每种算法保存最近 10 个训练模型。如果已经存有 10 个模型，则必须手动删除模型，留出空间后，才能进行下一次新模型的训练。
在模型列表上，还可以将鼠标悬停在模型名称右侧的眼睛图标上，查看模型的参数。
在有已存模型的情况下，您可以直接展开已存模型列表，勾选准备采用的模型，进入下一步，而不用每次重新训练数据。您可以勾选不同算法的多个模型进行对比验证，也可以勾选同一个算法下的多个模型进行对比验证。
除了采用数据验证，肉眼观测检测数据的效果以外，还可以通过算法评价指标来量化对比各模型在训练数据上的效果。勾选不同模型后，点击算法列表右上角的"模型指标对比"，即可在弹层中查看和切换不同评价指标的情况：
image::images/lynxee-kpi-training-eval.png[]
如果训练耗时较长，你可以关闭页面，稍后再登录查看指标模型的训练状态。
==== 模型验证与应用
选好准备检测验证的模型后，点进下一步，进入验证页面。在页面右上角，点击"批量检测"，将逐一展示上一步选中的每个模型，在选定时间范围内的异常检测结果。
image::images/lynxee-kpi-testing.png[]
每个模型独立展示指标的蓝色实际数据曲线、可能存在的红色异常标记点，以及黄色异常分值曲线。
如果测试效果不够满意，你可以调整算法灵敏度参数，点击"查看结果"按钮，重新发起检测，逐步修正检测结果。并在效果满意的情况下，点击"√"按钮保存。经过调整的灵敏度，将保存为该模型的检测参数。在不满意的情况下，也可以点击"×"取消，放弃修改。
此外，当灵敏度较高时，模型可能会检测出较多的异常点，不利于使用者的肉眼观察和最终判断。如下图所示：
image::images/lynxee-kpi-testing-nofilter.png[]
Lynxee 内置了单独的异常点过滤算法，对初步检测结果中，有明显周期性的、异常模式较为一致的异常点，进行二次过滤筛选。您可以通过设置 kpi_analyzer 模块的 `anomaly_filter.test_with_filter` 参数为 True，开启二次过滤。相同数据和模型的检测过滤效果如下：
image::images/lynxee-kpi-testing-filter.png[]
当出现满意的检测效果以后，你可以选定这个算法模型，点击"应用"。这个指标后续将固定采用这个算法模型进行后续监控。再次进入"指标与监控"页面时，如果所选范围内正好存在被检测出的异常数据，折线图上将直接标明。你也可以点击指标/监控项名称右侧的编辑按钮，再次修改模型。此外，已经应用模型的指标，在"指标与监控"页右下方，还会同期展示模型的评价指标情况，用户可以据此判断模型是否依然有效。 如果不关心评价的，可以关闭 kpi_analyzer 模块的 `detect.model_evaluation` 参数。
对于部分行业客户而言，只有营业时段的数据才有检测的实际意义。Lynxee 支持对特殊节假日和调休工作日的独立处理，节假日不检测指标异常，而调休日检测异常。用户可以通过 Lynxee 应用的"全局配置"页，填写特殊节假日和特殊工作日。每年按照国务院放假和调休安排填写列表即可：
image::images/lynxee-cvae-special-config.png[]
更直接的，还可以配置 kpi_monitor 模块的 `flink.detection_permit_time_range` 参数，直接对每天晚上休市时段都暂停检测。
==== 检测结果发送
默认情况下，模型应用以后，检测到异常时，会根据Lynxee"全局配置"中的"监控项告警发送配置"是否开启，来决定是否发送异常信息到 Cruxee 事件处理模块。后续的事件归并和告警通知等操作，请参考《日志易Cruxee操作手册》相关章节。
模型应用时，还可以选择不按照全局配置的独立发送行为。比如全局发送，这个指标不发送；全局不发送，这个指标发送等。
Lynxee 发送给 Cruxee 的指标异常信息结构示例及说明如下：
[source,javascript]
----
{
    "domain_id": 1,
    "signature": "730942_1590052164000",
    "alert_id": 730942, // 该监控项在Lynxee数据库中的内部ID
    "name": "network.packets_recv", //指标名称
    "event_id": "service:pkq.mysqld_mysqld.process.conns_192.168.1.135interval=2m", //指标ID
    "source_id": "192.168.1.135", //指标的采集来源设备
    "source": "192.168.1.135",
    "manager": "lynxee",
    "event_class": "KPI",
    "event_type": "kpi-anomaly",
    "agent": "kpimonitor",
    "agent_location": "",
    "agent_time": 1590052164000, //指标的某次采集时间
    "priority": "minor", //本次异常的级别
    "custom_info": {
        "content": {
            "service": "pkq.mysqld",
            "kpi_key": {
                "name": "mysqld.process.conns",
                "service": "pkq.mysqld",
                "endpoint": "192.168.1.135"
            }, //完整的指标信息
            "history_views": [
                {
                    "desc": "链接详情",
                    "url": "/app/lynxee/kpi/?id=730942&timestamp=1590052164000"
                }
            ] //用来查看指标数据的URL地址，可用于邮件中的告警列表操作
        }
    },
    "summary": "[service:pkq.mysqld,name:mysqld.process.conns,endpoint:192.168.1.135]value: 28.0", //异常描述，包含异常值信息
    "use_alert_sender": false,
    "use_incident_sender": true
}
----
Cruxee 发送的邮件通知中，您可以点击对应事件右侧的"链接详情"，自动打开对应的指标数据查看页面。