# 人面狮行动（APT-C-15）

#### 译文声明
本文为翻译文章，原文来源：360安全播报。译文仅供参考，具体内容及含义以原文为准。

## 目录
1. 概述
2. 载荷投递
   1. 社交网络水坑攻击
   2. 诱饵文档
   3. 自身伪装
3. ROCK后门分析
   1. 功能简述
   2. 功能结构
   3. 通信方式
   4. 对抗手法
4. 相关线索信息
   1. 攻击者Facebook帐号信息
   2. PDB信息
   3. 诱饵文档
   4. 释放的木马
   5. IP地理位置
附录A: 希伯来语样本来源
附录B: 最新样本查杀结果

## 一、概述
人面狮行动是活跃在中东地区的网络间谍活动，主要目标涉及埃及和以色列等国家的不同组织，目的是窃取敏感数据。该活动主要集中在2014年6月至2015年11月期间，最早可追溯到2011年12月。攻击者利用社交网络进行水坑攻击，共捕获到314个恶意代码样本和7个C&C域名。

人面狮样本将主程序伪装成文档诱导用户点击，然后释放一系列DLL文件，分为9个插件模块。通过注册资源管理器插件实现核心DLL自启动，并根据配置文件进行远程DLL注入，使得程序运行时无明显主进程。此外，使用多种加密手段干扰分析，PDB路径显示其使用了持续集成工具，表明项目规模较大且开发者为专业组织。

进一步分析推测，人面狮行动背后的组织可能是依托第三方开发相关恶意软件，而发起攻击的幕后组织可能来自中东地区。

## 二、载荷投递

### 1. 社交网络水坑攻击
我们发现其中一个希伯来语诱饵文档来自Facebook上以色列军队主页的评论。攻击者通过利用目标关注的社交网站账号进行载荷投递，这是一种典型的水坑攻击方式。与传统水坑攻击不同，APT中的主流水坑攻击主要有以下两种：

- **第一种**：攻击者攻陷目标关注的网站并植入恶意代码（如漏洞脚本），当目标访问该网站时，若触发漏洞则会被植入恶意代码。
- **第二种**：攻击者将可信应用或链接替换为恶意下载链接，当目标下载并执行这些文件时被感染。典型案例包括Havex木马（也称蜻蜓或活力熊）和海莲花（OceanLotus）APT组织。

这两种攻击的共同点是攻击者需要获取目标所关注网站的修改权限。而在本次攻击中，攻击者仅需简单注册即可在社交网络平台留言评论。

图 1: Facebook样本来源
表1: 恶意下载链接及其对应的RAR文件MD5

RAR压缩包中的诱饵文档内容为个人所得税调整，通过修改exe图标为文档来诱导用户点击。

图 2: 压缩包内诱饵文档截图
图 3: 相关C&C域名被卡巴斯基sinkhole

我们还发现，相关攻击涉及10个社交网络账号，主要涉及以色列军方和政府账号，攻击评论时间集中在2015年1月底至2月初。攻击者通过在社交网络评论下发表回复诱导用户点击，内容涉及个人所得税改革。

### 2. 诱饵文档
根据诱饵文档的内容，可以推断出攻击者关注的目标领域，主要分为以下三类：

- **埃及（阿拉伯语）**
  - 图 4: 诱饵文档1
  - 图 5: 诱饵文档2
    - 文档末尾有[爱资哈尔大学反对政变的学生]的YouTube主页。
    - annonymous rabaa是一个抗议2013年8月Rabaa大屠杀的埃及黑客组织。

- **以色列（希伯来语）**
  - 图 6: 诱饵文档5
    - 文档内容为以色列个人税收改革。

### 3. 自身伪装
攻击者采用两种伪装方式：一种伪装成文档或图片，另一种伪装成安装程序。

- **伪装成文档或图片**
  - 用户点击后不会弹出文档或图片。
- **伪装成安装程序**
  - 点击后安装成功并释放正常的安装程序。

模块文件属性为Office组件，早期版本安装目录为 `%UserProfile%\AppData\Roaming\officeplugin`，最近版本的安装目录为 `C:\Program Files\{GUID}`，例如 `C:\Program Files\{59f0641e-45ac-11e5-af9e-b8ca3af5855f}`，伪装成系统组件。

图 9: 相关文件属性信息

## 三、ROCK后门分析

### 1. 功能简述
人面狮行动使用的恶意代码主要是ROCK木马，由幕后组织自行开发或委托第三方定制。其中一个样本会释放远控木马，属于njRat的变种。通过修改自身图标为文档、图片或安装程序，诱导用户点击执行。主要功能包括窃取用户信息（如系统信息、键盘记录、Skype监控、摄像头和麦克风监控、浏览器保存的账号密码等），收集后加密并发送到指定C&C。

### 2. 功能结构
图 10: 整体结构
配置文件存储每个模块的配置信息，如是否开启、数据文件的加密Key、用户ID (rkuid)、过期日期、C&C地址、截图和录音的质量及间隔时间、注入的进程名称等。

图 11: 模块功能
Dropper总共会释放20个DLL，32位和64位各10个。部分功能模块介绍如下：
- **Zcore.dll 核心模块**：负责加载其他功能模块并注入到指定进程中，以及模块的注册、升级、卸载、日志和消息派发。
- **Plgcmd.dll 命令模块**：负责获取系统信息、删除文件或目录、截图、上传下载文件、启动和结束进程。
- **Plgcomm.dll 通信模块**：负责将其他模块生成的数据文件发送到指定C&C，每分钟向服务器发送一次请求，获取远程指令。

模块之间通过WM_COPYDATA消息跨进程通信，消息头Magic为0x34AB541作为唯一标识。

### 3. 通信方式
通过HTTP POST向服务器80端口发送数据，数据包中的敏感字符串通过查询JSON配置文件的对应表替换。

图 12: 网络通信
图 13: 网络通信字符串还原

由于网络通信模块注入到浏览器进程中，且使用HTTP POST向C&C的80端口发送数据，使异常流量难以被发现。

### 4. 对抗手法
- **文件名随机化**：Dropper释放的文件名来自于JSON文件，重命名为各种名词，如gendarme.dll, jerques.dll。
- **字符串加密**：所有字符串都经过加密，且使用多个加密算法。
- **API封装**：大量API调用被封装在公共库中，干扰静态分析。
- **无主进程运行**：核心模块作为explorer.exe的扩展启动，其他功能模块根据配置文件注入到指定进程，无主进程，较难发现。
- **行为隐藏**：主模块在explorer中运行，安全软件不会拦截；通讯模块注入到浏览器进程，无浏览器进程不与C&C通信；窃取文件模块注入到杀软，遍历文件的行为不易被用户发现。
- **PE资源和配置文件加密**：Dropper中的PE文件经过zlib压缩和AES加密，释放出来的JSON配置文件也经过此方法加密。

从对抗手段来看，人面狮攻击行动中的恶意代码开发者在静态和动态对抗方面都下了很大功夫，以达到免杀和隐藏行为的效果。

## 四、相关线索信息

### 1. 攻击者Facebook帐号信息
### 2. PDB信息
攻击者在进行社交网络水坑攻击时主要使用的两个Facebook账号。
- 开发者ID为zico
- 工程名称为ROCK-RW2-BRW6R
- 内部定义为rootkits工具

### 3. 诱饵文档
### 4. 释放的木马
从文件名可以看出，涉及埃及和以色列。其中一个样本的C&C位于埃及，且运行时释放的njRAT的C&C也在埃及。

### 5. IP地理位置
图 16: 样本和C&C对应关系

## 附录
### 附录A: 希伯来语样本来源
### 附录B: 最新样本查杀结果

参考文献：
1. “Havex Hunts For ICS/SCADA Systems”, https://www.f-secure.com/weblog/archives/00002718.html
2. 海莲花(OceanLotus)APT组织报告, https://ti.360.com/upload/report/file/OceanLotusReport.pdf
3. hxxps://docs.google.com/file/d/0ByavzARTLomhc3hFeFhGN1JOOE0/edit?pli=1