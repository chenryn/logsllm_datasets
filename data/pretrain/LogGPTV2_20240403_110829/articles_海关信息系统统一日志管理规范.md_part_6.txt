|                                                                       |
| -   ④AAA：设备类型标识，与HOSTNAME之间以%%分隔。要求大写。            |
|                                                                       |
| -   ⑤BBB：为模块标识. 要求大写。                                      |
|                                                                       |
| -   ⑥C：为严重程度，值为日志的Severity值。                            |
|                                                                       |
| -   ⑦DDD：为日志类型                                                  |
| ，包括SYSLOG、OPERLOG以及DATALOG三种类型，后面以"："结束。要求大写。  |
|                                                                       |
| -   ⑧YYYY：为日志内容。与前面的"："间有一个空格。                     |
+-----------------------------------------------------------------------+
-   绿盟IPS设备日志格式：
  ----------------------------------------------------------------------------
  time:{事件发生时
  间};danger_degree:{风险等级};breaking_sighn:{是否阻断\[0-未阻断
  1-已阻断\]};event:\'\[{规则编号}\]{事件描述}\';src_addr:{源地址};src_port:
  {源端口};dst_addr:{目的地址};dst_port: {目的端口};proto:\'{协议摘要}\'
  ----------------------------------------------------------------------------
上面分别是迪普和绿盟提供的官方日志格式，在此基础上我们分别对迪普防火墙和绿盟IPS的日志进行分析，制定相应的分析策略。对于上面两种日志类型我们可以采取如下的解析方法：
迪普防火墙日志：根据对日志格式的分析，采用正则表达式的方式对其日志进行解析。
绿盟IPS日志:根据对日志格式的分析，采用K-V分解方式，符号"；"作为每个属性的分隔符号，符号"："作为key和value的分隔符。
日志分析中的关键要素：
1.  日志事件级别：部分日志会对日志事件的级别做出定义，但不同类型的日志其级别的定义可能是不相同的，没有统一的标准，我们在保留、存储原有级别的基础上，定义了统一的日志级别标准，将日志事件定义为5个级别：
    > Debug、Info、Warn、 Error、 Fatal。
2.  事件优先级：事件优先级描述了事件的紧急程度。
3.  设备日志类型：对于某些设备来说，它的日志包含多种类型，如运行状态日志、登录日志、操作日志、安全日志等等，我们结合该设备的日志说明文档，提取其具体日志类型，形成每个类型日志的规则库。
4.  时间戳识别：时间戳用来描述这条日志事件的产生时间，这个时间的记录目前没有统一的格式，所以我们在进行日志分析时要把不同格式的时间戳统一规范成"yyyy-MM-dd
    > hh:mm:ss"的形式。
5.  关键字匹配：关键字匹配是对原始日志进行分析的主要方式，例如：我们通过app_name=switch和关键字
    > key=Fail or Bad or Error
    > 这样的关键字可以分析出关键交换机的错误和故障信息。
6.  与资产设备关联：建立日志与设备的关联，有助于日志进一步深入挖掘以及后续的关联分析，主要通过hostname、ip、tag等方式实现资产设备的关联。
> 主要分析方法：
1.   分类分析。发现分类规则可以给出识别一个特殊群体的公共属性的描述，这种描述可以用于分类日志。分类包括的挖掘技术将找出定义了一个项或事件是否属于数据中某特定子集或类的规则。该类技术是最广泛应用于各类业务问题的一类挖掘技术。分类算法最知名的是决策树方法，此外还有神经元网络、Bayesian分类等。
2.  聚类分析。可以从访问信息数据中聚类出具有相似特性的日志。在事务日志中，聚类日志信息或数据项能够便于开发和设计未来的自学习模式和学习群体。聚类是将数据集划分为多个类，使得在同一类中的数据之间有较高的相似度，而在不同类中的数据差别尽可能大。在聚类技术中，没有预先定义好的类别和训练样本存在，所有记录都根据彼此相似程度来加以归类。 
3.  统计。统计方法是从Web 站点中抽取知识的最常用方法, 它通过分析会话文件, 对浏览时间、浏览路径等进行频度、平均值等统计分析。虽然缺乏深度, 但仍可用于改进网站结构, 增强系统安全性, 提高网站访问的效率等。 
4.  协同过滤。协同过滤技术采用最近邻技术，利用用户的历史、喜好信息计算用户之间的距离，目标用户对特定商品的喜好程度由最近邻居对商品的评价的加权平均值来计算。
## 日志挖掘
日志内容挖掘是指从日志的内容中提取知识。日志挖掘可以对日志中心中大量文档集合的内容进行总结、分类、聚类、关联分析,以及利用日志进行趋势预测等。  
日志结构挖掘是从日志的组织结构和链接关系中推导知识。它不仅仅局限于日志之间的关联结构,还包括日志内部的结构。日志结构挖掘能够利日志间的关联信息对搜索引擎的检索结果进行相关度排序。  
业务系统使用记录挖掘是指从业务系统的使用记录中提取感兴趣的模式，每个服务器都保留了访问日志,记录了关于用户访问和交互的信息,可以通过分析和研究日志记录中的规律,来识别业务系统的潜在用户;可以用基于扩展有向树模型来识别用户浏览序列模式,从而进行业务系统日志挖掘;可以根据用户访问的业务系统记录挖掘用户的兴趣关联规则,存放在兴趣关联知识库中,作为对用户行为进行预测的依据,从而为用户预取一些应用页面,加快用户获取页面的速度，分析这些数据还可以帮助理解用户的行为,从而改进系统的结构,或为用户提供个性化的服务。 
（一）首先，进行日志的预处理。 
从访问日志中得到的原始日志记录并不适于挖掘，必须进行适当的处理才能进行挖掘。因此，需要通过日志清理，去除无用的记录。
（二）其次，进行模式发现 
模式发现, 是对预处理后的数据用数据挖掘算法来分析数据。分有统计、分类、聚类、关等多种方法。 
1.   路径分析。它可以被用于判定在一个站点中最频繁访问的路径，还有一些其它的有关路径的信息通过路径分析可以得出。路径分析可以用来确定系统上的频繁访问路径, 从而调整和优化网站结构, 使得用户访问所需网页更加简单快捷, 。利用这些信息就可以改进系统的设计结构。 
2.  关联规则。 使用关联规则发现方法，可以从访问事务中找到的相关性。关联规则是寻找在同一个事件中出现的不同项的相关性，用数学模型来描述关联规则发现的问题：x=\>y的蕴含式，其中x,y为属性------值对集(或称为项目集)，且X∩Y空集。在数据库中若S%的包含属性------值对集X的事务也包含属性------值集Y，则关联规则X=\>Y的置信度为C%。 
3.  序列模式。在时间戳有序的事务集中，序列模式的发现就是指那些如"一些项跟随另一个项"这样的内部事务模式。它能发现数据库中如"在某一段时间内，客户购买商品A，接着会购买商品B，尔后又购买商品C，即序列A→B→C出现的频率高"之类的信息。序列模式描述的问题是：在给定的交易序列数据库中，每个序列按照交易的时间排列的一组交易集，挖掘序列函数作用是返回该数据库中高频率出现有序列。 
# 日志存储规范
## 存储原则
1.  评估适用的依从性需求
> 日志存留时间需满足相关政策法规中要求的保存的特定日志的类型和存储时间。
2.  评估组织的风险态势
> 每个风险领域的时间长度和日志的重要性是不同的，因此存储策略时需依据日志的风险态势。
3.  关注各种日志来源和生成日志的大小
> 针对防火墙、服务器、数据库、web代理服务器，不仅基于需求，也基于日志的体积及每条日志记录的大小和类型，例如主防火墙会生成大量的内容，因此为了满足此数据长期存留的需求，通常只存留30天的日志，然而，应该仔细评估某些组织的依从性需要以及主防火墙的关键程度决定是否采取更长的存留周期。
4.  评估可用的存储选项
> 日志的存储选项包括硬盘、DVD、RDBMS、日志特定存储，以及基于云的存储。这方面的决策主要取决于价格、容量、访问速度，最重要的是以合理的周期得到日志记录的能力。日志中心主要采用基于云的存储方式。
## 存储时间
> 依据日志的存储原则制定主要设备的日志存储时间策略规则如下
  -------------------- ----------------- ----------------- -----------------
  **设备**             **日志类型**      **在线**          **存档**
  服务器               错误日志          90天              3年
                       安全类日志        90天              1年
                       运行状态类        60天              1年
                       其他              30天              1年
  中间件               访问日志          90天              1年
                       Web服务器日志     90天              1年
                       其他              30天              1年
  防火墙               攻击类            90天              2年
                       运行状态类        60天              1年
                       其他              30天              1年
  入侵防御系统IPS      入侵保护          90天              3年
                       系统事件          60天              1年
                       防病毒事件        90天              3年
                       Web安全事件       90天              3年
                       其他              30天              1年
  Web应用防护系统WAF   系统日志          60天              1年
                       Web访问日志       90天              2年
                       ARP防护日志       90天              3年
                       Web安全日志       90天              3年
                       其他              30天              1年
  业务系统日志         系统运行日志      60天              1年
                       错误日志          90天              3年
                       审计操作日志      90天              3年
                       其他              30天              1年
  数据库               数据库服务日志    90天              1年
                       数据库审计日志    90天              3年
                       其他              30天              1年
  网络流量                               30天              1年
  文件类                                 30天              1年
  视频类                                 30天              1年
  -------------------- ----------------- ----------------- -----------------
## 存储格式
原始日志在多数情况下采用基于文本的日志文件、二进制文件、数据库存储方式来实现原始日志的存储，通过对原始文本日志的收集和处理统一将所有日志格式规范为文本形式，视频和文件类日志建立索引以文件形式存储。
## 存储规范
日志中心的存储需采用大数据分布式存储架构，应充分考虑高可用性设计、数据存储量大小、搜索分析效率、成本投入等因素。根据本项目的应用特点，从搜索分析效率和数据存储量方面考虑，具体技术要求如下：
（1）具有企业级分布式文件系统，具有高扩展性；
（2）结构化和非结构化数据存储的全面支持；
（3）NoSQL/非关系型的数据存储支持；
（4）并行计算能够支持任务调度控制功能，支持自动分配资源的能力；
（5）在一个节点损坏的情况下，计算结果不变；
（6）采用无共享分布式存储和分布式并行计算架构。对海量结构化数据、半结构化数据进行存储、管理、全文搜索、复杂分析；
（7）支持的数据结构：数值型、字符型、日期型、二进制型；
（8）支持超大规模文档存储，提供数据切分；
（9）支持原有数据安全迅速的迁移和备份。
（10）提供数据冗余副本机制，可以动态设置副本数量，提供查询的高吞吐量。
（11）集群部署，集群中有多个节点，其中有一个为主节点，这个主节点是可以通过选举产生的，主从节点是对于集群内部来说的。搜索引擎的一个概念就是去中心化，字面上理解就是无中心节点。
（12）索引分片，搜索引擎可以把一个完整的索引分成多个分片，这样可以把一个大的索引拆分成多个，分布到不同的节点上。构成分布式搜索。分片的数量只能在索引创建前指定，并且索引创建后不能更改。
（13）副本，搜索引擎可以设置多个索引的副本，副本的作用一是提高系统的容错性，当某个节点某个分片损坏或丢失时可以从副本中恢复。二是提高搜索引擎的查询效率，搜索引擎会自动对搜索请求进行负载均衡。
（14）数据恢复，搜索引擎在有节点加入或退出时会根据机器的负载对索引分片进行重新分配，挂掉的节点重新启动时也会进行数据恢复。
（15）索引快照的存储方式，搜索引擎默认是先把索引存放到内存中，当内存满了时再持久化到本地硬盘。对索引快照进行存储，当这个搜索引擎集群关闭再重新启动时就会从中读取索引备份数据。
# 日志使用规范
## 日志检索
日志检索的四种方式包括范围查询、正则表达式、NOT/AND/OR布尔值和字段过滤，这些方式都是建立在锁定一个时间范围的基础上进行的。
-   范围查询：可快速发现满足一定条件参数的事件，例如检索Apache
    Web服务器响应时间大于200ms的事件。
-   正则表达式：可以定义查询模版来简化你的搜索输入，假如你有一批名为app01-app99机器，如果你只想搜索前30台，你可以输入"/app\[0-2\]\[0-9\]/"
    来简化搜索输入。
-   AND/OR/NOT布尔值：利用AND、OR、NOT和(
    )的组合，用户可以自由构造各种复杂的组合查询语句。
```{=html}
```
-   字段过滤：字段过滤快速显示用户所有结构化/半结构化特殊字段的统计聚合，点击其中的字段值进行过滤操作，可快速缩小事件的查询范围。
日志检索其它规范要求：
（1）根据用户角色信息设定其能检索的日志类范围，不同用户可检索不同的日志主题类型，检索内容包含日志记录规范中记录的日志内容，同时包含原始日志信息。
（2）根据日志类型确定检索日志的时间范围，不同类型日志的在线热数据和存档时间不同，只能查询日志存留规范中制定范围内的日志信息。
（3）检索查询时间要求：在线热数值的查询要求在10秒内完成。
## 日志数据可视化
用户自定义数据可视化图表分析，可完成如下类数据可视化分析。
（1）
事件计数：展示日志中某个字段在一个特定的查询范围内的数量，可以进行独立统计和对比分析，可根据展示效果选择合适的图表。该统计在5秒内完成。
（2）
时间分段：统计某段时间范围内日志内容中指定的字段的最大值，最小值、平均值等，可选择用于展示的图表类型。该统计在10秒内完成。
（3）
数值分段：分析展示日志中的数值字段的事件统计情况，可添加多个数值分段值，例如appache日志中的status字段，可针对该字段进行制定范围的数值分段统计。该统计在10秒内完成。
（4）
时间直方图：以秒、分、小时、天、周为维度，展示特定日志的时间直方图统计，以柱形图作为呈现的效果。该统计在5秒内完成。
（5）
数值直方图：统计展示日志中的数值字段，以某个数值为时间间隔为单位的变化情况。该统计在5秒内完成。
（6）
字段分类：展示日志中的描述类别的字段的TOP排名情况。该统计在5秒内完成。
（7）
字段数值统计：统计分析日志的数值字段的最大值、最小值、平均值及总数情况。该统计在10秒内完成。
（8）
累计百分比：统计日志中置顶字段数值在特定时间范围和指定的百分比分段中所的分布情况，该统计在10秒内完成。
（9） 多级统计：实现分析的逐步钻取。该统计在5秒内完成。
（10） 地理分布：展示攻击行为的地理分布情况，该展示效果在5秒内完成。
## 日志导出
提供对原始日志和规范后的日志的导出功能，在系统在线:最大可导出约10000条日志，存储格式为csv格式文件。通过对API的调用可导出1TB级日志数据。
## 对外接口
（1） 对外告警事件发送接口
-   事件频率告警
支持事件频率告警，在一个设定的时间范围内触发告警的阈值数。例如，可以设置告警条件为
10 分钟内某个事件结果计数超过 20 次。
-   基于顺序发生的关联告警
支持基于顺序发生的多日志源关联告警规则，可统计告警设定的时间范围内，多数据源某种事件按顺序发生的情况。例如，可以设置告警条件为
10 分钟内入侵检测某个 IP
下载二进制文件事件，然后在此主机上出现用户权限变更操作事件。
-   基于同时发生的关联告警
支持基于同时发生的多日志源关联告警规则，可统计告警设定的时间范围内，多数据源某种事件同时发生的情况。
-   基于未同时发生的关联告警
支持基于未同时发生的多日志源关联告警规则，可统计告警设定的时间范围内，多数据源某种事件未同时发生的情况。
通过与第三方程序对接的方式发送告警，可支持syslog、SNMP、TCP等多种协议的发送方式，告警信息包含如下关键信息：告警名称、告警描述、日志主题、告警类型、告警方式、告警字段、检测频率，备注说明等。
（2） 日志提供接口
采用稳定的TCP方式持续提供日志分析结果以及原始日志数据。日志提供接口包含如下关键信息：日志提供方信息、发送时间、发送目标信息、发送方式、日志信息内容等。
# 日志维护规范
## 日志安全
日志应该符合的安全规范，不要在日志信息里包含安全敏感信息。遇到敏感信息应该进行脱敏处理输出。例如密码不输出或者使用\*\*\*\*\*\*代替，身份证或者账号中间8位使用\*\*\*\*
\*\*\*\*替代等
> **保密信息**：是指涉及到我行安全部门规定的敏感生产数据，主要分为以下五类：
-   密钥密码信息：是指用于确保数据机密性、完整性或用于身份验证的信息；
-   客户信息：是指各信息系统涉及的自然人客户信息和法人及非法人组织客户信息。包括客户基本信息、账户信息、产品或渠道信息、交易信息、资信信息、财务信息、营销信息等；
-   业务信息：包括账务信息和非账务信息；
-   业务参数信息：是指在业务处理过程中对处理规则起控制作用的常量或变量数据。包括业务应用参数、机构编码、柜员信息、费率等管理类参数信息；
-   技术信息：是指在技术处理过程中对具体技术细节的描述信息。包括系统命令、系统和应用的配置信息、系统漏洞信息、网络IP地址、防火墙配置等。