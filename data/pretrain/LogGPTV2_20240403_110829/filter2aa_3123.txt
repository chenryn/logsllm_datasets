!"#$%&'()
360高级攻防-灵腾实验室 – 赖志活 Wfox
0
!"#$%&'(
1
针对外网开放资产进行探测，定位远程办公类系统并进行攻击，以达到突破网络边界、窃取数
据的目的。
•
VPN系统（深信服VPN、思科VPN）
•
办公云桌面（Vmware Horizon、Citrix、深信服VDI）
•
办公OA（泛微、致远、蓝凌、通达）
•
邮件系统（Exchange、coremail、亿邮）
!"#$%&'( – )*+'(
2
1. 收集用户名、密码规律
1)
用户名规律
•
常见用户名、姓名全拼zhangsan、名字缩写wangsm、姓名倒序sanzhang、工号01111
•
已有通讯录、top500、top1000、百家姓top50w
2)
密码规律
•
已知初始密码、弱口令、键盘密码
!"#$%&'( – )*+'(
3
2. 密码喷洒
动态代理池绕过登录限制接口，密码喷洒弱口令
POST /por/login_psw.csp?type=cs&dev=mac&language=zh_CN&encrypt=0 HTTP/1.1
Host: vpn.xxx.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 49
svpn_name=test&svpn_password=test&svpn_rand_code=
!"#$%&'( – )*+'(
4
2. 密码喷洒
•
爆破成功
•
爆破失败
!"#$%&'( – )*+'(
5
3. 双因子认证突破
•
手机验证码
1)
社工骗取验证码
•
手机动态口令
1)
综合其他社工途径获取到的VPN使用文档，得知动态令牌绑定过程
2)
尝试获取种子二维码，如邮箱、微信、企业IM、key文件等途径
•
机器码绑定
1)
初次登录可直接绑定机器
!"#$%&'( – )*+'(
6
4. 可达网段定位
除了导航页Web资源外，可查看本机路由表
route print定位所有可访问的内网网段。
网段10.128.0.0，掩码255.128.0.0
IP范围（10.128.0.0 – 10.255.255.255）
!"#$%&'( – )*+'(
7
5. VPN内网扫描
从小到大的原则，添加单个IP资源或IP段，一般为重要应用系统
•
针对单个IP的资源进行探测（255.255.255.255）
•
针对小C段进行探测（255.255.255.128-255）
•
针对C段进行扫描（255.255.255.0）
•
可达网段大范围扫描
!"#$%&'( – )*+
8
!"#$%&'( – )*+
9
1. 攻击入口
国内常见云桌面如Citrix、深信服VDI 、VMware Horizon，用途通常分为日常办公、开发环境、
测试环境、准生产环境等。
•
口令收集登录
•
弱口令喷洒
•
历史漏洞利用（Citrix）
!"#$%&'( – )*+
10
2. 横向手法
云桌面内访问的资源取决于当前云桌面的用途。
•
信息收集：浏览器记录、保存密码、其他用户目录的文件、共享盘文件
•
业务相关：gitlab、wiki、jira、Jenkins
•
集权管控：AD域控、VMware ESXi、VMware Vcenter
•
传统攻击：弱口令、通用漏洞、0day漏洞
!"#$%&'( – )*+
11
3. 攻击案例1
!"#$%&'( – )*+
12
4. 攻击案例2
云桌面资源、用户认证等都是基于AD域，拿下域控等于控制所有办公电脑。
1.
常见手段攻击域控，zerologon、ms17010、弱口令等
2.
定位运维人员账号、云桌面
3.
控制权限并信息收集服务器资源表、密码本
4.
通过密码本或基于当前权限xshell软件保存密码直接登录测试环境
5.
控制集权管控类设备，如堡垒机、VCenter、ESXi
!"#$%&'( – )*+
13
5. 网络突破
1)
突破出网限制
1)
部分机器可直接出网
2)
部分机器配置IE代理可出网
2)
测试网突破生产网
1)
测试、生产区分不明确，区域之间可互相访问
2)
寻找高权限机器当跳板突破生产网
3)
利用VCenter的生产vSwitch（vlan）创建虚拟机，以此作为跳板攻击生产网
!"#$%&'( – %&)*
14
办公OA是近年攻防演练突破边界的重灾区，0day漏洞频出（泛微、致远、蓝凌、通达）
1.
0day漏洞、1day漏洞、nday漏洞撕口子
2.
密码收集、弱口令登入办公OA，收集各类文档
3.
收集员工通讯录（姓名、岗位、手机号、邮箱），再次定点钓鱼
!"#$%&'( – )*'(
15
1.
邮件钓鱼
1)
探测存活邮箱：互联网检索、SMTP协议爆破、coremail接口爆破
2)
邮件伪造
3)
安全网关绕过
2.
漏洞攻击
1)
Exchange Server（CVE-2020-0688、proxylogon、proxyshell）
2)
亿邮RCE
3)
Coremail RCE
!"#$%&
16
在金融行业的大型生产内网环境中，必然会部署大规模性能监控、自动化运维、资产运营等系统，
但随着时间的推移，这些系统常年未经维护、存在诸多配置不当、历史漏洞，成为攻击者的重点
突破对象。
•
性能监控：Zabbix
•
自动化运维：SaltStack、Ansible
•
堡垒机：JumpServer、启明堡垒机、齐治堡垒机
!"#$%& ' ()**+,
17
Zabbix是一个支持实时监控数千台服务器、虚拟机和网络设备的企业级解决方案，客户覆盖许多
大型企业。
最为常见的Zabbix部署架构，Server与Agent同处于内网区域，Agent能够直接与Server通讯，不受
跨区域限制。
!"#$%& ' ()**+,
18
1. Agent入口分析
Linux进程名为zabbix_agentd，Windows进程名为zabbix_agentd.exe
查看配置文件：
cat /etc/zabbix/zabbix_agentd.conf | grep -v '^#' | grep -v '^$'
!"#$%& ' ()**+,
19
2. 分析配置文件
主要关注Zabbix服务端IP、不安全的配置选项。
•
Server：Server或Proxy的IP、CIDR、域名
•
EnableRemoteCommands：开启后可通过Server下发shell脚本在Agent上执行
•
UnsafeUserParameters：自定义用户参数是否允许传参任意字符
•
AllowRoot：开启后以root权限运行zabbix_agentd服务
•
UserParameter：自定义用户参数
!"#$%& ' ()**+,
20
3. 不安全的配置案例
•
EnableRemoteCommands
开启后可通过Server下发shell脚本在Agent上执行。
•
UserParameter + UnsafeUserParameters
当UnsafeUserParameters参数配置不当时，组合UserParameter
自定义参数的传参命令拼接，可导致远程命令注入漏洞。
EnableRemoteCommands=1
UserParameter=ping[*],echo $1
UnsafeUserParameters=1
!"#$%& ' ()**+,
21
4. 攻击Zabbix Server
•
Web后台弱口令
管理员默认账号：Admin，密码：zabbix
•
MySQL弱口令
用户名zabbix，密码：
123456
zabbix
zabbix123
zabbix1234
zabbix12345
zabbix123456
!"#$%& ' ()**+,
22
5. Zabbix Server权限后利用
Agent统一部署的情况下，存在不安全配置的Agent会遍布所有生产服务器。
1)
控制Zabbix Server权限
添加脚本，指定为zabbix服务器执行，
在仪表盘选择一台机器运行即可。
出网情况下可上linux远控，不推荐bash反弹
!"#$%& ' ()**+,
23
5. Zabbix Server权限后利用
2) 控制Zabbix Agent权限 - EnableRemoteCommands
添加脚本，指定为zabbix客户端执行，在“监测中 -> 最新数据”功能中根据过滤条件找到想要
执行脚本的主机并单击运行脚本。
!"#$%& ' ()**+,
24
5. Zabbix Server权限后利用
3) 控制Zabbix Agent权限 - UnsafeUserParameters
当UnsafeUserParameters参数配置不当时，组合UserParameter自定义参数的传参命令拼接，可
导致远程命令注入漏洞。
UserParameter=ping[*],echo $1
ping[test && id]
echo test && id
配置项
发送Payload
命令注入
!"#$%& ' ()**+,
5. Zabbix Server权限后利用
3) 控制Zabbix Agent权限 - UnsafeUserParameters
当UnsafeUserParameters参数配置不当时，组合UserParameter自定义参数的传参命令拼接，可
导致远程命令注入漏洞。
UserParameter=ping[*],echo $1
UnsafeUserParameters=1
ping[test && id]
echo test && id
配置项
发送Payload
命令注入
25
!"#$%& ' ()**+,
5. Zabbix Server权限后利用
3) 控制Zabbix Agent权限 - UnsafeUserParameters
指定主机添加监控项，“键值”中填入监控项命令，等待片刻就能在“最新数据”功能看到执行结果。
26
!"#$%& ' ()**+,
6. Zabbix定位靶标信息
信息收集 -> 整理 -> 转化，快速定位企业内网的核心系统。
1) 信息整理
主机名称、主机别名、IP地址、主机分组
2) 机器名规律分析
内部系统代号、区域（dmz、prod、uat、qz）、用途（web、db、redis）
27
!"#$%& – '()*+,-
1. 攻击手法
进程分析
->
监听端口分析
->
文件分析
->
漏洞挖掘
28
ps aux
netstat -ntlp
常见风险点
•
deamon服务0.0.0.0监听端口
•
监听端口的服务未对请求进行鉴权
•
监听服务的指令模块存在远程命令执行漏洞
•
源码文件泄露敏感信息
!"#$%& – '()*+,-
2. 进程分析
分析当前运行进程，排除系统服务、常见应用服务等进程，结合进程名基本可以判断为Agent进程。
Linux、Windows环境通常会部署同一套Agent。
29
!"#$%& – '()*+,-
3. 监听端口分析
若服务端口监听在0.0.0.0，且服务存在漏洞的情况下，可通过Agent漏洞横向攻击内网其他机器。
可根据端口监听的进程PID找到对应运行进程。
30
!"#$%& – '()*+,-
4. 文件分析
结合进程信息、程序目录内的文件，可以判断该进程为Python编写。
31
!"#$%& – '()*+,-
5. 漏洞挖掘
9003端口对应脚本bin/updater/updater.py，监听9003接收socket原始连接。
32
!"#$%& – '()*+,-
5. 漏洞挖掘
监听端口接受连接请求并处理
消息。
33
!"#$%& – '()*+,-
5. 漏洞挖掘
JSON解析消息体，判断msgtype消息类型，并调用对应处理模块。
34
!"#$%& – '()*+,-
5. 漏洞挖掘
命令执行模块
35
!"#$%& – '()*+,-
6. 漏洞利用
Agent监听9003端口，且可以构造固定指令即可未授权远程执行系统命令。从而实现对内网其他服务器
进行攻击。
根据代码逻辑，构造命令执行的请求包，向其他机器发送请求即可获得服务器权限。
36
!"#$%&