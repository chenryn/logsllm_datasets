当Client写完一个数据块时，HDFS会将这个数据块再复制两份存储在其他DataNode
---
## Page 86
术选型和架构决策依赖业务规划乃至企业战略规划，离开业务发展的支撑和驱动，技术
有多大意义。而用户体验的快或是慢，可以通过技术手段改善，也可以通过优化交互体
验，使他们感觉网站很快。离开这个目的，追求技术上的所谓高性能，是舍本逐末，没
走不远，
以接受？这类问题的答案不是技术团队能回答的。归根结底，技术是为业务服务的，技
数量也需要增加一倍；或者响应时间缩短，同时数据一致性也下降，这样的优化是否可
验改善。
即使在技术层面，性能优化也需要全面考虑，综合权衡：性能提升一倍，但服务器
网站性能对最终用户而言是一种主观感受，性能优化的最终目的就是改善用户的体
领跑IT前沿技术潮流，是因为互联网企业的业务发展远超传统IT企业领域，
业务，逐步蚕食IBM、HP、Oracle、微软等传统软件巨头的市场。
的技术优势进军企业级市场，以技术驱动业务，开展云计算、SaaS 等新兴IT
面临更多挑战，对IT系统提出了更高的要求。
，甚至还会迷路。
新技术的出现又会驱动企业开展新的业务。亚马逊等互联网公司利用自己
前沿技术总是出现在前沿业务领域。近几年，以 Google 为首的互联网企业
4瞬时响应：网站的高性能架构下
---
## Page 87
绩效考核，与奖金升迁等利益挂钩。
标：Usability，通常也被译作可用性，但是后者强调的是网站的有用性，即对最终用户的
时不可访问。该事件一时成为新闻焦点，各种媒体争相报道。
复。这一故障导致美国许多使用亚马逊云服务的知名网站（如：Foursquare，Quora）受
的不可用事故直接影响公司形象和利益，许多互联网公司都将网站可用性列入工程师的
使用价值），相比于网站的其他非功能特性，网站的可用性更牵动人们的神经，大型网站
到影响，并引发了人们对使用云计算安全性、可靠性的大规模讨论。
ESB（ElasticBlockStorage）服务不可用，故障持续了数天，最终还是有部分数据未能恢
网站的可用性（Availability）描述网站可有效访问的特性（不同于另一个网站运营指
2010年1月12日，百度被黑客攻击，其DNS域名被劫持，导致百度全站长达数小
2011年4月12日，亚马逊云计算服务EC2（ElasticComputer Cloud）发生故障，其
架构
万无一失：网站的高可用
---
## Page 88
理层面，可用性指标是网站或者产品的整体考核指标，具体到每个工程师的考核，更多
可用性是4个9,即QQ服务99.99%可用，这意味着QQ服务要保证其在所有运行时间中，
空调会失灵、程序会有Bug、黑客会攻击、促销会引来大量访问、第三方合作伙伴的服务
5.1
的是使用故障分。
5.1.2
站年度不可用时间小于53分钟；5个9是极高可用性，网站年度不可用时间小于5分钟。
只有0.01%的时间不可用，也就是一年中大约最多53分钟不可用。
5.1.1
会不可用…..要保证一个网站永远完全可用几乎是一件不可能完成的使命。
器可能会宕机、网络交换机可能会失效、硬盘会损坏、网卡会松掉、甚至机房会停电、
问题，都可能导致网站页面不可访问。DNS会被劫持、CDN服务可能会挂掉、网站服务
Twitter网站的可用性不足2个9。
除了过硬的技术、大量的设备资金投入和工程师的责任心，还要有个好运气。
是较高可用，网站年度不可用时间小于9小时；4个9是具有自动恢复能力的高可用，网
网站的页面能完整呈现在最终用户面前，需要经过很多个环节，任何一个环节出了
由于可用性影响因素很多，对于网站整体而言，达到4个9，乃至5个9的可用性
可用性指标是网站架构设计的重要指标，对外是服务承诺，对内是考核指标。从管
常使用Twitter的用户或多或少遇到过那个著名的服务不可用的鲸鱼页面，事实上，
对于大多数网站而言，2个9是基本可用，网站年度不可用时间小于88小时；3个9
网站年度可用性指标=（1-网站不可用时间/年度总时间）×100%
网站不可用也被称作网站故障，业界通常用多少个9来衡量网站的可用性，如QQ的
所谓故障分是指对网站故障进行分类加权计算故障责任的方法。表5.1为某网站故障
网站不可用时间（故障时间）=故障修复时间点-故障发现（报告）时间点
网站可用性的度量与考核
网站可用性考核
网站可用性度量
5万无一失：网站的高可用架构一
67
---
## Page 89
分类权重表。
分，绩效考核就会受到影响。
年末或者考核季度末的时候，个人及团队实际承担的故障分如果超过了年初分摊的故障
发生故障的时候，根据故障分类和责任划分将故障产生的故障分分配给责任者承担。等
根据团队和个人的职责角色分摊故障分，这个可用性指标和故障分是管理预期。在实际
68
不同的团队和个人。
大型网站技术架构核心原理与案例分析
A类故障
事故级故障
C类故障
B类故障
在年初或者考核季度的开始，会根据网站产品的可用性指标计算总的故障分，然后
故障分的计算公式为：
有时候一个故障责任可能由多个部门或团队来承担，故障分也会相应按责任分摊到
一个简化的故障处理流程如图5.1所示。
类
非核心功能不可用，或核心功能少数用户不可用
严重故障，网站整体不可用
故障分=故障时间（分钟）×故障权重
以上故障以外的其他故障
网站访问不顺畅或核心功能不可用
客服报告故障
故障处理完毕
表5.1网站故障分类权重表示例
图5.1网站故障处理流程示例
述
故障接手&处理
部门接口人
提交故障给相关
权
100
20
5
---
## Page 90
5.2高可用的网站架构
务器宕机，就将服务切换到其他可用的服务器上，如果磁盘损坏，则从备份的磁盘读取
时服务依然可用、数据依然保存并能够被访问。
于免费用户的网站对可用性更加敏感，服务不可用或关键用户数据丢失可能会导致收费
绩效考核息息相关，因此在架构设计与评审会议上，关于系统可用性的讨论与争执总是
也降低了可用性，特别是服务器硬件设备，低价的商业级服务器一年宕机一次是一个大
更多地采用PC 级服务器、开源的数据库和操作系统，这些廉价的设备在节约成本的同时
型机乃至中型机大型机及专有操作系统、Oracle 数据库、EMC存储设备等。互联网公司
用户的投诉甚至引来官司。
于应对指数级增长的用户，也会降低可用性的标准；服务于收费用户的网站则会比服务
的架构决策，崇尚创新和风险的企业会对可用性要求稍低一些；业务快速增长的网站忙
最花费时间与精力的部分。
数据。
概率事件，
实现上述高可用架构的主要手段是数据和服务的余备份及失效转移，一旦某些服
通常企业级应用系统为提高系统可用性，会采用较昂贵的软硬件设备，如 IBM的小
当然，
既然硬件故障是常态，网站的高可用架构设计的主要目的就是保证服务器硬件故障
不同于其他架构指标，网站可用性更加看得见摸得着，跟技术、运营、相关各方的
一个典型的网站设计通常遵循如图5.2所示的基本分层架构模型。
，而那些高强度频繁读写的普通硬盘，损坏的概率则要更高一些。
，不同的公司有不同的企业文化和市场策略，这些因素也会影响到系统可用性
图5.2网站架构基本分层模型
服务层
数据层
应用层
5万无一失：网站的高可用架构一
69
---
## Page 91
模更加庞大，但通常还是能够把这些服务器划分到这三层中。如图5.4所示。
则另外部署，如图5.3所示（事实上，这也是网站架构演化的第一步）。
存储与访问。中小型网站在具体部署时，通常将应用层和服务层部署在一起，而数据层
应用层主要负责具体业务逻辑处理；服务层负责提供可复用的服务；数据层负责数据的
70
服务、搜索服务等数据存储与访问服务都部署在各自独立的服务器集群上。
务服务也各自部署在独立的服务器集群上。至于数据层，数据库服务、文件服务、缓存
同的复用业务，如注册登录服务、Session 管理服务、账户管理服务等，这些可复用的业
于不同的产品，部署在各自独立的服务器集群上，互不相干。这些产品又会依赖一些共
大型网站技术架构核心原理与案例分析
典型的分层模型是三层，即应用层、
在复杂的大型网站架构中，划分的粒度会更小、更详细，结构更加复杂，服务器规
不同的业务产品会部署在不同的服务器集群上，如某网站的文库、贴吧、百科等属
用户浏览器
图5.4分层后按模块分割的网站架构模型
图5.3应用和数据分离部署的网站架构
搬务
账户服务
文库
贴吧
Session服务
、服务层、数据层；各层之间具有相对独立性，
服务层
应用层
数据层
知道
登录服务
百科
紫
L
---
## Page 92
的宕机，而后者更加频繁，不能因为系统可以接受偶尔的停机故障就降低可用性设计的
每次网站发布都需要关闭服务，重新部署系统，整个过程相当于服务器宕机。因此网站
写入多台服务器上，实现数据余备份。当数据服务器宕机时，应用程序将访问切换到
机时数据不丢失，数据访问服务不中断，需要在数据写入时进行数据同步复制，将数据
测，发现有服务不可用，立即通知客户端程序修改服务访问列表，剔除不可用的服务器。
层客户端程序中实现软件负载均衡，并通过服务注册中心对提供服务的服务器进行心跳检
服务器上，使整个集群保持可用，从而实现应用高可用。
台应用服务器不可用时，就将其从集群列表中剔除，并将请求分发到集群中其他可用的
服务器组成一个集群共同对外提供服务，当负载均衡设备通过心跳检测等手段监控到某
交的数据进行相应的业务逻辑处理，多个服务实例（服务器）之间完全对等，请求提交
著特点是应用的无状态性。
5.3
的可用性架构设计不但要考虑实际的硬件故障引起的宕机，还要考虑网站升级发布引起
有备份数据的服务器上。
只是这些服务器被应用层通过分布式服务调用框架访问，分布式服务调用框架会在应用
标准。
位于数据层的服务器情况比较特殊，数据服务器上存储着数据，为了保证服务器宕
位于服务层的服务器情况和应用层的服务器类似，也是通过集群方式实现高可用，
所谓无状态的应用是指应用服务器不保存业务的上下文信息，而仅根据每次请求提
网站升级的频率一般都非常高，大型网站一周发布一次，中小型网站一天发布几次。
位于应用层的服务器通常为了应对高并发的访问请求，会通过负载均衡设备将一组
应用层主要处理网站应用的业务逻辑，因此有时也称作业务逻辑层，应用的一个显
高可用的解决方案也差异甚大。
器具有不同的可用性特点。关闭服务或者服务器宕机时产生的影响也不相同，