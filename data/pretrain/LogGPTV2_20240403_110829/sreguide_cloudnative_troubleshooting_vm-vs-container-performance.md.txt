---
isOriginal: true
category: äº‘åŽŸç”Ÿ
tag:
  - Kubernetes
---

# ä»€ä¹ˆï¼Ÿç›¸åŒåž‹å·ç‰©ç†æœº å®¹å™¨æ€§èƒ½ä¸å¦‚è™šæ‹Ÿæœºï¼Ÿ

## äº‹ä»¶ç»è¿‡

> è¯¥åº”ç”¨é€šè¿‡è™šæ‹Ÿæœºå’Œå®¹å™¨æ··åˆéƒ¨ç½²ï¼Œä¸Šçº¿å‰åŽ‹æµ‹äº†è™šæ‹Ÿæœºä¸Šçš„åº”ç”¨æ€§èƒ½ï¼Œç†è®ºä¸Šæµé‡é«˜å³°èƒ½æŠ—ä½ã€‚

[xx:xx] æµé‡çªå¢žï¼ŒæŽ¥å£å¤§é‡è¶…æ—¶

[xx:xx] **é™æµ**

[xx:xx] **é‡å¯**ï¼Œè™šæ‹Ÿæœºèƒ½é‡å¯æˆåŠŸï¼Œå®¹å™¨é‡å¯å¤±è´¥ï¼Œå®¹å™¨æµé‡æ‘˜é™¤ï¼Œæš‚æ—¶æ¢å¤

[xx:xx] **æ‰©å®¹**ï¼Œ å®¹å™¨è™šæ‹Ÿæœºå‡æ‰©å®¹

[xx:xx] ä¸¤å°å®¹å™¨å¼‚å¸¸ï¼Œæµé‡æ‘˜é™¤

[xx:xx] ä¸€æ®µæ—¶é—´åŽè§‚å¯Ÿæ­£å¸¸ï¼Œ**è§£é™¤é™æµ**

[xx:xx] æµé‡æ¯”ä¸Šä¸€æ¬¡è¿˜å¤§ï¼ŒæŽ¥å£å¤§é‡è¶…æ—¶

[xx:xx] **é™æµ**

[xx:xx] **æ‰©å®¹**ï¼Œæ‰©å®¹å‘å¸ƒå‡æœ‰å¤±è´¥ï¼Œä½†æ˜¯è™šæ‹ŸæœºæˆåŠŸçŽ‡é«˜ï¼Œå®¹å™¨ fullGC æ—¶é—´é•¿ï¼Œè¯·æ±‚å †ç§¯ï¼Œå¼‚å¸¸

[xx:xx] å®šä½ä»£ç å­˜åœ¨æ€§èƒ½é—®é¢˜

[xx:xx] ä¿®å¤ä»£ç  bugï¼Œè§£å†³é—®é¢˜

[xx:xx] å®šä½åˆ°å®¹å™¨æ€§èƒ½ä¸Žè™šæ‹Ÿæœºæœ‰ä¸€å®šå·®è·ï¼ˆTPS å·®ä¸€å€ï¼Œå¹³å‡ RT é«˜ï¼‰

[xx:xx] è§£å†³å®¹å™¨æ€§èƒ½é—®é¢˜



## æ ¹å› åˆ†æž

> ä»£ç æœ‰ Bug ï¼Œ å¯åŠ¨éƒ½ä¼š fullGC ï¼Œéƒ½æœ‰å¯åŠ¨å¤±è´¥çš„æ¦‚çŽ‡ï¼Œä½†æ˜¯å®¹å™¨ fullGC è€—æ—¶é•¿ï¼Œè¯·æ±‚ä¼šä¸æ–­å †ç§¯ï¼Œ è€Œè™šæ‹Ÿæœºè¿‡æ®µæ—¶é—´å¯ä»¥è‡ªè¡Œæ¢å¤
>
> è¿™é‡Œä¸»è¦å®šä½ï¼Œä¸ºä»€ä¹ˆå®¹å™¨ fullGC æ—¶é—´é•¿ï¼Œä»¥åŠå®¹å™¨ TPS ä½Žï¼Œå¹³å‡ RT é«˜çš„é—®é¢˜

å®šä½åˆ†æžä¸šåŠ¡çš„æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿæ˜¯å¾ˆå¤šç¨‹åºå‘˜éƒ½å¾ˆå¤´ç–¼çš„é—®é¢˜ã€‚éœ€è¦ä½ å…·å¤‡å¾ˆé«˜çš„ä¸šåŠ¡èƒ½åŠ›ï¼ŒåŒ…æ‹¬å¯¹ä¸šåŠ¡æµç¨‹çš„ç†Ÿæ‚‰åº¦ã€å¯¹è½¯ä»¶æž¶æž„åŠè½¯ä»¶å†…å®žçŽ°é€»è¾‘çš„ç†è§£ç¨‹åº¦ï¼Œç”šè‡³æ˜¯å¯¹OSå’Œç¡¬ä»¶åŽŸç†éƒ½è¦æœ‰æ·±å…¥çš„ç†è§£ã€‚å³ä½¿æ˜¯æŽŒæ¡äº†è¿™äº›ä¿¡æ¯ï¼Œå¦‚æžœæ²¡æœ‰ç³»ç»Ÿçš„å®šä½åˆ†æžæ–¹æ³•çš„æŒ‡å¯¼ï¼Œé‚£ä½ ä¾æ—§å¾ˆéš¾å®šä½å‡ºæ€§èƒ½é—®é¢˜ã€‚

 ![](https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240220164332294.png)

å¦‚ä¸Šå›¾ï¼š æŽ’é™¤  ä¸šåŠ¡å±‚ å’Œ è½¯ä»¶æž¶æž„  ä¸¤å±‚ï¼Œç›¸åŒä»£ç ï¼Œç›¸åŒç‰©ç†æœºåž‹å·ï¼Œç›¸åŒæœºæˆ¿çš„æƒ…å†µä¸‹ï¼ŒçŽ°åœ¨éœ€è¦è¯†åˆ« è½¯ç¡¬ä»¶æ€§èƒ½ç“¶é¢ˆã€‚

okï¼Œçƒ­çƒˆæ¬¢è¿Ž æ€§èƒ½é¢†åŸŸçš„å¤§å¸ˆå¸ƒä¼¦ä¸¹Â·æ ¼é›·æ ¼ï¼ˆBrendan Greggï¼‰ç™»åœº ðŸ‘ðŸ‘ðŸ‘

![linux_perf_tools_full](https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/linux_perf_tools_full.png)

åˆ©ç”¨ éšæœºå˜åŠ¨è®¹æ–¹æ³•ï¼ˆçŒœæµ‹ï¼Œæ”¹åŠ¨ï¼Œè§‚å¯ŸéªŒè¯ï¼‰ æŸ¥é—®é¢˜

```bash
# å…ˆçœ‹ CPU,è§‚å¯Ÿ CPU MHzã€CPU max MHzã€CPU min MHzï¼Œå‘çŽ°CPU MHz å¤„äºŽ min å€¼
lscpu
# æŸ¥çœ‹å½“å‰ CPU æ€§èƒ½æ¨¡å¼
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
# è°ƒæ•´è®¾ç½®ä¸º performance æ¨¡å¼ï¼Œè¿›è¡ŒéªŒè¯
cpupower frequency-set -g performance
```

Niceï¼Œå®šä½åˆ°äº†æ ¹å›  âœŒï¸



## åŽç»­ TODO

1ï¼‰è¡¥å…¨ç›‘æŽ§å‘Šè­¦

å°† node_exporter å‡çº§åˆ° 1.6.0

- [ENHANCEMENT] Add cpu frequency governor metrics [#2569](https://github.com/prometheus/node_exporter/pull/2569)

æ·»åŠ å‘Šè­¦è§„åˆ™

```yaml
name: CPU æ€§èƒ½æ¨¡å¼éž performance
expr: (sum by(instance) (node_cpu_scaling_governor{governor!="performance"}) > 0)
```



2ï¼‰å°†è™šæ‹Ÿæœºå’Œå®¹å™¨ï¼Œ è¿›è¡Œ åŸºç¡€æ€§èƒ½åŽ‹æµ‹å’ŒæœåŠ¡æ€§èƒ½åŽ‹æµ‹ï¼Œå½¢æˆå¯¹æ¯”åŽ‹æµ‹æŠ¥å‘Š

> è°ƒæ•´ CPU æ€§èƒ½æ¨¡å¼åŽï¼Œ å®¹å™¨çš„æ•´ä½“æ€§èƒ½ å¥½äºŽ è™šæ‹Ÿæœºï¼Œä¸»è¦ä½“çŽ°åœ¨ ç£ç›˜æ€§èƒ½æ–¹é¢ï¼Œå®¹å™¨æ›´ä¼˜
>
> è§„æ ¼å‡ä¸ºï¼š4c8gï¼Œ ç›¸åŒåž‹å·ç‰©ç†æœº
>



|             |                          | è™šæ‹Ÿæœº          | å®¹å™¨            |      |
| :---------- | :----------------------- | :-------------- | :-------------- | :--- |
|             | **åŸºç¡€æ€§èƒ½**             |                 |                 |      |
| è®¡ç®—æ€§èƒ½    | Super_Pi                 | 21.244ç§’        | 20.915ç§’        | ~=   |
|             | CPUè°ƒåº¦å»¶æ—¶ å•çº¿ç¨‹       | 56.7å¾®ç§’        | 16.7å¾®ç§’        | â†‘    |
|             | CPUè°ƒåº¦å»¶æ—¶ 2çº¿ç¨‹        | 58.7å¾®ç§’        | 19.3å¾®ç§’        | â†‘    |
|             | CPUè°ƒåº¦å»¶æ—¶ 4çº¿ç¨‹        | 66.3å¾®ç§’        | 26.3å¾®ç§’        | â†‘    |
|             | sysbench ç´ æ•°è®¡ç®— å•çº¿ç¨‹ | 4.483ç§’         | 4.454ç§’         | ~=   |
|             | sysbench ç´ æ•°è®¡ç®— 2çº¿ç¨‹  | 2.244ç§’         | 2.227ç§’         | ~=   |
|             | sysbench ç´ æ•°è®¡ç®— 4çº¿ç¨‹  | 1.124ç§’         | 1.116ç§’         | ~=   |
| å†…å­˜æ€§èƒ½    | å†…å­˜å¸¦å®½(stream) å•çº¿ç¨‹  | Copyï¼š11.0GB/s  | Copyï¼š12.9GB/s  | ~=   |
|             | å†…å­˜å¸¦å®½(stream) å•çº¿ç¨‹  | Scaleï¼š11.1GB/s | Scaleï¼š13.0GB/s | ~=   |
|             | å†…å­˜å¸¦å®½(stream) å•çº¿ç¨‹  | Addï¼š12.5GB/s   | Addï¼š14.4GB/s   | ~=   |
|             | å†…å­˜å¸¦å®½(stream) å•çº¿ç¨‹  | Triadï¼š12.7GB/s | Triadï¼š14.6GB/s | ~=   |
|             | å†…å­˜æ—¶å»¶(mlc)            | 138.0çº³ç§’       | 146.8çº³ç§’       | ~=   |
|             | sysbench é¡ºåºå†™          | 4082.59MiB/sec  | 4657.52MiB/sec  | ~=   |
|             | sysbench é¡ºåºè¯»          | 52616.00MiB/sec | 74925.36MiB/sec | â†‘    |
|             | sysbench éšæœºå†™          | 527.66MiB/sec   | 533.09MiB/sec   |      |
|             | sysbench éšæœºè¯»          | 7485.14MiB/sec  | 8376.67MiB/sec  | â†‘    |
| æ–‡ä»¶I/Oæ€§èƒ½ | sysbench éšæœºè¯» IOPS     | 2759.53         | 14136.79        | â†‘    |
|             | sysbench éšæœºå†™ IOPS     | 1839.72         | 9424.53         | â†‘    |
|             | sysbench é¡ºåºå†™åžåé‡    | 76.89 MiB/s     | 1726.56 MiB/s   | â†‘    |
|             | sysbench é¡ºåºè¯»åžåé‡    | 17560.41 MiB/s  | 12356.24 MiB/s  | â†“    |
|             | dd é¡ºåºå†™                | 125.3 MB/s      | 1262.9 MB/s     | â†‘    |
| ç½‘ç»œæ€§èƒ½    | ä¼ è¾“é€ŸçŽ‡(pps)            | 60w/s           | 49w/s           | â†“    |
|             | ç½‘ç»œå¸¦å®½                 | 8.75Gbps        | 8.75Gbps        | ~=   |
|             | å•å‘æ—¶å»¶                 | 104.274å¾®å¦™     | 30.743å¾®ç§’      | ~=   |
|             | ping æ—¶å»¶                | 0.143æ¯«ç§’       | 0.102æ¯«ç§’       | ~=   |
|             | **åº”ç”¨æ€§èƒ½**             |                 |                 |      |
| Nginx       | çŸ­è¿žæŽ¥ QPS               | 2.92ä¸‡          | 3.20ä¸‡          | ~=   |
|             | é•¿è¿žæŽ¥ QPS               | 17.75ä¸‡         | 14.13ä¸‡         | â†“    |
| MySQL       | è¯»                       | 79.19ä¸‡/300ç§’   | 651.29ä¸‡/300ç§’  | â†‘    |
|             | å†™                       | 22.63ä¸‡/300ç§’   | 186.08ä¸‡/300ç§’  | â†‘    |
| Redis       | Set                      | 14.88ä¸‡/ç§’      | 15.42ä¸‡/ç§’      | â†‘    |
|             | Get                      | 15.22ä¸‡/ç§’      | 14.74ä¸‡/ç§’      | â†“    |

## åŒç±»ç¡¬ä»¶é—®é¢˜æ€»ç»“

### CPU

**CPU-åŠ¨æ€èŠ‚èƒ½æŠ€æœ¯**

cpufreq æ˜¯ä¸€ä¸ªåŠ¨æ€è°ƒæ•´ CPU é¢‘çŽ‡çš„æ¨¡å—ï¼Œå¯æ”¯æŒäº”ç§æ¨¡å¼ã€‚ä¸ºä¿è¯æœåŠ¡æ€§èƒ½åº”é€‰ç”¨ performance æ¨¡å¼ï¼Œå°† CPU é¢‘çŽ‡å›ºå®šå·¥ä½œåœ¨å…¶æ”¯æŒçš„æœ€é«˜è¿è¡Œé¢‘çŽ‡ä¸Šï¼Œä»Žè€ŒèŽ·å–æœ€ä½³çš„æ€§èƒ½ï¼Œä¸€èˆ¬éƒ½æ˜¯é»˜è®¤ powersaveï¼Œå¯ä»¥é€šè¿‡ cpupower frequency-set ä¿®æ”¹ã€‚

```bash
# æŸ¥çœ‹å½“å‰ CPU æ€§èƒ½æ¨¡å¼
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
# æŸ¥çœ‹å½“å‰ CPU ä½¿ç”¨é¢‘çŽ‡
cat /proc/cpuinfo | grep -i "cpu mhz"
# ç»¼åˆæŸ¥çœ‹æ–¹å¼
cpupower frequency-info
# è®¾ç½®ä¸º performance æ¨¡å¼
cpupower frequency-set -g performance
# æ³¨æ„ï¼šå¦‚æžœä½¿ç”¨ cpupower frequency-set è®¾ç½®åŽï¼Œé‡å¯ç‰©ç†æœºåŽï¼Œé…ç½®å¤±è´¥ï¼Œå¯èƒ½æ˜¯ tuned-adm çš„åŽŸå› 
# æ‰€ä»¥å»ºè®®ä½¿ç”¨ tuned-adm è®¾ç½® CPU æ€§èƒ½æ¨¡å¼
tuned-adm profile latency-performance
```

### RAID å¡

å†™å…¥ç­–ç•¥å¯¹é¡ºåºå†™å…¥æ€§èƒ½å½±å“æ¯”è¾ƒå¤§

* `Write Policy`ï¼ˆå†™å…¥ç­–ç•¥ï¼‰ï¼š
  * `Write Through`ï¼ˆé€å†™ï¼‰ï¼šå¹¶ä¸åˆ©ç”¨ Raid å¡çš„ Cacheï¼Œç›´æŽ¥ä¸Žç£ç›˜è¿›è¡Œäº¤äº’ã€‚
  * `Write Back`ï¼ˆå›žå†™ï¼‰ï¼šæ˜¯å…ˆå†™ Raid å¡ç¼“å­˜ï¼Œå†ä¼ å…¥ç£ç›˜ã€‚å› ä¸ºå†™å…¥ç¼“å­˜ï¼Œæ“ä½œç³»ç»Ÿå°±è®¤ä¸ºæˆåŠŸäº†ï¼Œæ‰€ä»¥æµ‹è¯•ä¼šå‘çŽ°å†™å…¥æ€§èƒ½éžå¸¸å¿«ã€‚ æŽ¨è
* `Read Policy` ï¼ˆè¯»å–ç­–ç•¥ï¼‰:
  * `Read-ahead` ï¼ˆé¢„è¯»ï¼Œé€‚åˆé¡ºåºè¯»ï¼‰
  * `No-Read-Ahead`ï¼ˆNormaléžé¢„è¯»ï¼Œä¸€èˆ¬åœ¨ Windows æœåŠ¡å™¨ä¸‹æŽ¨èï¼‰

å¼€å¯é¢„è¯»å¯¹é¡ºåºè¯»å½±å“å¾ˆå¤§æµ‹è¯•ä¼šå·®20%-40%æ€§èƒ½ã€‚

> **Tips** åœ¨ã€ŠMySQL æŠ€æœ¯å†…å¹•-InnoDBå­˜å‚¨å¼•æ“Žã€‹ ç¬¬äºŒç‰ˆç¬¬9ç« ï¼Œæ€§èƒ½è°ƒä¼˜éƒ¨åˆ†ã€‚æœ‰å…³äºŽ `Write Policy` çš„ä»‹ç»ï¼Œæ ¹æ®ä½œè€…å®žæµ‹ MySQLï¼Œ`Write Back` æ¯” `Write Through` å¿«å°†è¿‘ 40 å€å·®è·ã€‚

```bash
# æŸ¥çœ‹ RAID å¡å½“å‰è¯»å†™ç­–ç•¥ï¼ŒåŽ»å¸¦å¤–ç®¡ç†å°çœ‹ä¼šæ–¹ä¾¿ä¸€äº›
# åŽ»å®˜ç½‘ Broadcom ä¸‹è½½ rpm åŒ…ï¼Œåˆ°æœåŠ¡å™¨ä¸ŠåŽ»å®‰è£…
rpm -ivh storcli-007.2508.0000.0000-1.noarch.rpm
# å†™å…¥ç­–ç•¥æ”¹ä¸º WB
## v0 æ˜¯æŸ¥è¯¢ç»“æžœï¼Œä¸åŒåž‹å· name ä¸åŒ
cd /opt/MegaRAID/storcli/ &&  ./storcli64 /c0 /v0 set wrcache=WB
# è¯»å–ç­–ç•¥æ”¹ä¸º RA
cd /opt/MegaRAID/storcli/ &&  ./storcli64 /c0 /v0 set rdcache=ra
```

## ç»éªŒæ•™è®­

**ä¸Šçº¿å‰ï¼ŒåŸºå‡†æµ‹è¯•çš„é‡è¦æ€§ & åŸºå‡†æµ‹è¯•è¦åŒ…å«åº”ç”¨çš„ï¼Œä»¥åº”ç”¨æ„ŸçŸ¥ä¸ºå‡†ã€‚**

ä¸‹ç¯‡ä¼šè¯¦ç»† æœåŠ¡å™¨æ€§èƒ½åŽ‹æµ‹æŒ‡æ ‡åŠæ–¹æ³•ã€‚



å‚è€ƒé“¾æŽ¥ï¼šæ€§èƒ½ä¼˜åŒ–é«˜æ‰‹è¯¾ | å°‰åˆšå¼º




---



>






