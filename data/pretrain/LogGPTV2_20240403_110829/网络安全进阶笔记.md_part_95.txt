间都会产生一个会话连接，每个会话连接都有一个独立的SessionID表示。因此，在服务器上
可以利用SessionID进行防盗链。这个思路大概可以这样进行：首先，在用户浏览到网站首页
时，产生一个SessionID，用户发送对网络资源的请求都带有该SessionID.同时在服务器上维
持一个数组，将SessionID和用户IP和端口进行临时绑定。然后，用户发送的网络资源请求都
将与数组信息进行比较，比较正确则有效，否则都表示非法盗链或非法下载。动态生成URL
的格式如下：
http://网站名/日录路径/资源名？CeoionID
其中，SessionID是动态随机的，另外这里问号和SessionID也将起到一定的作用。很多的
下载软件在进行下载时，是不会发送问号之后的内容的。因此，网站服务端可以很轻易地判断
当前对资源发起的请求是否为非法请求。另外，这种技术由于用户每次进入资源网站时，
SessionID都是不同的，这样也在一定程度上保护了URL的安全性。
除了上述方法，还可以通过判断客户端播放软件的版本系列号，和通过网页润览时的软件
代理信息来判断用户是否在进行非法链接和非法下载。需要注意的是，由于协议等的公开性，
易地开发出一个软件实现IE的功能，以上技术中的验证可以很轻易地被这类下载软件所欺骗，
从而被非法下载。因此，从理论上来说，这种方法和技术是不能从根本上杜绝非法下载的。
(3）铜墙铁壁：使用rewrite技术实现防盗链
防盗链的工作是多方面的。对于网络管理员而言，还可以通过服务器设置来加强防盗链工
作。这里以Apache服务器为例。Apache防盗链的原理是，服务器获取用户提交信息的网站地
址，然后和真正的服务端的地址相比较，如果一致，则表明是站内提交，或者为自己信任的站
点提交，否则视为盗链。
实现时可以使用HTTP_REFERER和htaccess文件（需要启用mod_Rewrite），结合正则表达
式去匹配用户的每一个访问请求。在实现过程中，首先要确认Apache的rewritemodule可用。
即能够控制Apachehtpd.conf文件的，打开htpd.conf，有以下配置：
LoadModule rewrite_module modules/mod_rewrite.so
465
---
## Page 471
网络安全进阶笔记
找到网站对应的地方，加入下列代码：
ServerName test.com
防盗链配置
RewriteEngine On
RewriteCond (HTTP_REFERER)I^http://test.com/.*s[NC]
RewriteCond (HTrP_REPERER)Ihttp://test.comS [NC]
RewriteCond &(HrTP_REPERER)1^http://www.test.com/.*S[NC]
RewriteCond(HTTP_REFERER)Ihttp1//www.test.comS (NC)
小知识：信任站点设置.在Apache服务器的防范过程中，需要设置信任站点，这里设置为
hp:/www.test.com和http:/test.com.对于需要保护文件的扩展名，以”号分开
对于盗链后的重定向页面，用于输出警示信息，这张图片应该尽可能地小，设置完毕，
重新启动Apache服务器即可.
有些用户使用的是虚拟主机，没有服务器的控制权，无法修改httpd.conf文件和重启服务
器。那么需要确认虚拟主机支持.htaccess，将上面的配置写入.htaccess文件，放入根目录或图
片所在的目录即可，htaccess文件的内容如下：
防盗链配置
RewriteEngine On
RewriteCond (HTTP_REFERER)!http://test.com/.*S[NC]
RewriteCond （HTTP_REFERER)I^http://teat.comS [NC]
RewriteCond （HTTP_REFERER)1http://w.test.com/.*s[NC]
RewriteCond (HTTP_REFERER)1http://www.test.comS[NC]
RewriteRule,*\.(gif1jpglswf)Shttp://www.test.com/about/nolink.png[R,Nc]
小提示：hupd.conf文件里的配置，是在Apache启动时一次读取，效率很高：htaccess文件里
的配置，每次访问都需要读取分析，效率很低，
除了上述方法，还可以使用ctEnvIfNoCase和access技术实现Apache防盗链。具体代码
如下：
SetEnvIfNoCase Referer *^http://test.com*1ocal_ref-1
SetEnvIfNoCase Referer *http://www.test.com1ocal_ref=1
Order A11ow,Deny
Allow from env=local_ref
将上述代码放入hupd.conf或.htaccess文件即可。通过判断referer变量的值，判断图片或
资源的引用是否合法，只有在设定范围内的referer，才能访问指定的资源，从而实现了防盗链
的目的。
由此可见，防盗链是一个系统化的工程，需要多方面的严格防范，才能确保自身利益不受
别人侵犯。不过，“道高一尺，魔高一丈”，反盗链技术在发展，盗链技术也在进步，任何防
盗链机制都不是百分之百可靠。网站采用反盗链技术是以牺牲网站的某些功能为代价的，必然
导致网站的可用性降低。因此，应该在保护自己不受盗链网站的侵害与保证网站可用性之间寻
---
## Page 472
第9章举一反三学语言：以.NET为例
得一个可以接受的平衡点，要把网站的可用性放在第一位。就像现在的盗版音乐一样，用户接
受了资源，大家都认同了，才会有更多的利益。盗链与反盗链，也将是一个不断促进、不断平
衡的过程。因此，合理的反盗链机制能够让网站有效地远离不法网站的侵扰，让网站资源最大
限度地为自己的用户服务，而不是被人家“空手套白狼”，在不知不觉地为其他网站作贡献。
9.3.4实战支付宝转接安全应用
随看电子商务的日益成熟，网络转账的安全要求越来越高。支付宝就是在这种背景下发展
起米的。例如，对于大型网上购物系统而言，除了能够让会员选择货到付款结账方式外，还应
该提供一些更方便快捷的网上支付方式：对于中小型网络商店面言，如果没有足够的实力提供
会员直接在网站中建立现金账户的功能，就可以将订单信息转接到支付宝，让会员从支付宝付
款。当然，用户也可以将支付宝作为一种方便快捷的支付方式，从而给客户提供更多可选的支
付方式。不过，谈到“钱”和“网络”，自然就会联想到“安全”的问题。如何在网络开发中
合理利用支付宝，就成为当前的一个重要话题。
1.支付宝安全操作基础知识
支付宝转接的原理很简单，实际上就是通过测览器传参数到支付网关，支付网关获得浏览
器参数并进行内部解析，浏览器传的参数都经过了加密处理。商户系统与支付宝之间有两种交
互模式，分别是请求/响应交互模式和主动通知交互模式：
·请求/响应交互模式。这是最常用的一种交互模式。在这种模式下，商户系统向支付
宝系统发送请求数据，并“同步”等待文付宝系统处理完毕之后返回的响应数据。请
求/响应模式根据页面流程，可分为系统调用和页面跳转。面同步就是指商户系统在
等待：支付宝自身的处理结束，并调用商户系统的接口文件或买家需要再回到商户网
站进行操作，如图9.37所示。
·主动通知交互模式，买家从商户网站转跳到支付宝网站，在支付宝网站完成最后操作，
买家不需要再回到商户网站。支付宝系统会将时间采用主动通知的方式提交给商户系
统。这种交互模式如果需要异步返回结果，商户网站必须传递参数给支付宝网站，支
付宝会将相关的消息传递到指定的消息处理程序。
合作商户系统
支付宝系统
8.薄求的交
图9.37请求/响应交互模式
---
## Page 473
网络安全进阶笔记
目前，申请支付宝接口主要有两种方式。第一种为免费接口，淘宝抽取2%的手续费：第
二种为付费接口，例如600元允许48000元交易金额的配额等。在免费接口中，又分为标准双
接口交易类型和纯即时到账交易。这两种支付方式中，前者为淘宝担保交易+即时到账交易，
面后者仅仅为即时到账交易。
小提示：支付宝接口的区别，支付宝接口包括标准双接口和纯即时到账接口，标准双接口又称
为中介担保接口，包括担保交易和即时到账方式，对于担保交易，客户支付的货款都
会到支付宝，然后由客户点击收货确认，货款才能真正到指定的支付宝账号，标准双
接口里面的即时到账无需买家确认，货款直接到卖家的支付宝账号。这里的即时到账
方式跟纯即时到账接口是一样的，标准双接口主要用于实物销售，一些批发行业或者
客户二次购买的时候可以使用其中的即时到账方式，纯即时到账无需买家确认，客户
支付货款资金直接到达卖家的支付室账户，纯即时到账主要是开放给虚拟行业，如广
告、点卡、彩票、VOD等、
支付接口申请成功后，会得到两个重要的参数：支付宝安全校验码和合作伙伴ID，这两
个参数起到了反映支付是否成功的重要作用。如图9.38所示是一个具体的演示步骤。
网上购物系统选择合适的支付宝接口，与支付宝签约
整理订单信息发送给支付宝，跳转到支付宝页面，并收到支付宝
止确肤得订单的确认信息
遂回到购物系统页面，进行订单信息的修改
围9.38支付宝接口使用流程
（1）网上购物系统与支付宝公司签订合作协议，以确保从本购物网站上传到支付宝网站上
的订单信息能被正确接收。
(2）当会员于购物网站上买下一系列商品并选择支付宝付款方式后，购物系统即将会员购
物的订单信息转发到支付宝，网站页面也会转到支付宝的付款页面。此时，支付宝页面会发送
一个验证信息到本网站，以确认支付宝正确收到订单信息。
小提示：遥知页面是传递给支付宝时的notify_url参数所对应的页面文件，返田页面是传遥给
支付宝时的returmurl参数所对应的页面文件。
（3）会员在支付宝网站完成付款后，网站页面会重新跳回购物网站，同时支付宝会将已付
款的订单信息发回本网站以对本购物网站的数据库进行必要的修改操作。另外，还需要向支付
宝网站发送一个返回信息，告知支付宝本系统已正确收到付款完毕的订单信息并且已经完成对
数据的处理操作。
468
---
## Page 474
第9章举一反三学语言：以.NET为例
2.支付宝源码实现过程分析
在与支付宝签订完合同后，就可以使用合同中的商家ID、商家支付宝账号和安全校验码，
整合支付宝到自已的电子商务系统中了。下面，以一个典型的电子商务网站开发为例，对支付
宝操作的一些关键代码进行分析。首先，需要建立一个通知页面（CvicseAlipayNotify.aspx）和一
个返回页面（CvicseAlipayRetumaspx)，用于接受并验证从支付宝返回的信息并对数据库中相应
的订单信息做修改处理操作。
(1）通知页面和返回页面的关键代码
下面，对通知页面CvicseAlipayNotify.aspx的后台代码进行分析。通知页面是传递给支付
宝时的notify_url参数所对应的页面文件。通知页面就是被支付宝调用才能启动的，它获得参
数的方法是用POST方式获取，该页面的HTML页面中必须是空白、无任何HTML标签、无
任何空格、不允许做页面跳转。
①从配置文件中取出商家ID、商家支付宝账号和安全校验码，这里有一些已经定义的
变量：
01.atringalipayotifyuRL-*https://ww.alipay.com/cooperate/gateway.do?*:
02.
string partner-
ConfigurationManager.AppSettingsI"partnerAlipay*1.ToString():
03.string key=ConfigurationManager.AppSettings（*keyAlipay*].ToString（1;
04.atring_input_charset=
05.alipayNotifyURL=alipayNotityURL.*service=notify_verify*.*spartner
ContigurationManager.AppSettings[*input_charsetAlipay*].ToString1);
07.int11
06.sttinyzeapuuseTxL=Alipay.GeL_HLLg（alipayMuLifyURL,120000);
08.NameValueCollection coll:
09.coll=Request.Form;
10.String[l requestarr-coll.Allkeys;
11.string[] Sortedstr -Alipay.BubbleSort(requestarr):
下面对其中的一些典型代码进行详细分析。
第1行，定义支付网关，支付网关把组装好的订单信息传送给支付宝服务器，服务器做一
些付款处理。支付宝、财付通、快钱等第三方在线平台的支付网关，各大银行都会支持。
第2行，从配置文件读取合作伙伴ID，商户与支付宝签订合同时会获得此值，在支付宝
系统中用来唯一标识商户。
第3行，从配置文件中读取商户的交易安全校验码Key，商户与支付宝签订合时也会获得
此值。安全校验码主要用来对数据加密，防止别人伪造交易数据的，这个Key就像钥是一样，
相当重要。
第4行，从配置文件中读取编码格式，在通过支付接口传递参数信息到支付宝服务器时使
用此编码格式，当是UTF-8的编码格式时，必须得用到且不允许为空的。
第5行，组装通知URL，用于确认支付宝服务器已经接收到正确的订单信息。
第6行，获取支付宝ATN返回结果，true表示正确的订单信息，false表示无效。
第8行，定义键值变量，用来存放表单中所有变量值。NameValucCollection类表示可通过
键或索引访问的关联String键和 String值的集合。
---
## Page 475
网络安全进阶笔记
第9行，加载表单所有变量并赋值于变量coll。