ITDR 介绍
A
ITDR 之 vSphere
B
ITDR 之 vSphere
赛博昆仑 昆仑实验室负责人-古河 （Yuki Chen）
vSphere 作为基础计算平台在如今企业环境中被广泛应用 , 同时对其的攻击和漏洞挖掘一直是非常热门的话
题 , 本书深入浅出地讲解了 vCenter 的攻防两面 , 对企业进行 vSphere 安全建设起到了重要的参考和指导意义。
奇安信 观星实验室负责人-龚玉山（ISWIN）
vCenter 作为 vSphere 的核心控制节点，一直是攻击者的首选目标，本书总结了针对 vCenter 各个阶段的
攻击手法和实际案例以及对应的检测和加固方案，方便企业安全管理者快速了解 vSphere 攻击流程以及针对性
的防御方法。
深信服 深蓝实验室负责人-潘立亚（sm0nk）
集权类产品是攻防实战的兵家必争之地，拿到集权类产品权限相当于站到了攻击的制高点。vSphere 作为
重要的集权产品，同时又是云化虚拟化的的关键套件，倍受广大红队攻击手和漏洞挖掘者的关注和热爱。本书对
vSphere 产品体系、风险攻击面、攻击技战法（信息收集、权限获取、权限维持、防御绕过、虚拟机权限获取、
虚拟机逃逸）、安全加固 等维度 做出了攻击与防御的方法总结。无论是实战攻击手还是企业安全建设者均有重
要的参考和指导意义。
360 灵腾实验室负责人-赖志活 （wfox）
vSphere 在攻防领域有小域控之称，vSphere 被攻破之后，不单单只是获取一台服务器的权限，其管理的多
台服务器都将沦陷。在攻防活动领域越来越多的攻击者把矛头放在攻击 vSphere 服务上，本书能够深入浅出地
讲解 vSphere 的风险威胁场景、实战攻击技战法以及如何应对加固防御，帮助读者更好地了解 vSphere 攻防技
术体系。
360安全专家-Ricter Z
本白皮书对于 vCenter 的各类研究都非常透彻，涉及 vCenter 相关的整体架构、攻防对抗、漏洞利用、后渗
透利用、防御加固等方面，覆盖了完整的利用生命周期。对于想针对 vCenter 进行漏洞挖掘研究的攻击方和想针
对 vCenter 进行加固的防御方都有极大的帮助和指导。vCenter 架构复杂，攻击面极多，想要完整研究需要深入
了解各个组件和功能，本书对于主要功能都有详细的研究，无疑是一个极佳的研究入手参考。
中安网星御守实验室
vSphere 是企业身份认证和集中计算的一个重要基础设施，同时也是攻防对抗中的一个火力焦点，是 ITDR
体系中绕不开的一环，在对其进行保护的研究的过程中我们深入分析了 vSphere 体系中的各个组件，梳理出了
其复杂的攻击面，输出了一份 vSphere 攻防技术白皮书，其中涉及 vSphere 的体系介绍、安全风险、攻击手法、
防御方案等，希望能对 vSphere 的研究起到一定的帮助作用。
ITDR 介绍
C
目录
1. ITDR介绍 
1
2. vSphere体系介绍 
2
2.1 ESXI 
3
2.2 vCenter Server 
4
2.3 管理客户端 
5
2.4 存储网络和阵列 
6
2.5 应用场景 
6
2.6 小结 
8
3. vSphere风险介绍 
10
3.1 攻防场景下的vSphere 
11
3.2 vSphere勒索分析 
11
3.2.1 Babuk 
12
3.2.2 Luna 
12
3.2.3 REvil 
13
4. vSphere攻击技战法 
14
4.1 vSphere攻击场景介绍 
15
4.2 vSphere攻击手法一览 
16
4.3 信息探测 
16
4.3.1 SOAP版本探测 
16
4.3.2 密码爆破 
18
4.3.3 密码喷洒 
20
4.3.4 PSQL敏感信息查询 
20
4.3.5 LDAP敏感信息查询 
24
4.3.6 vCenter备份文件泄露 
27
4.3.7 EAM用户服务文件读取 
28
4.3.8 vCenter服务扫描 
29
4.4 权限获取 
31
4.4.1 CVE-2021-21985 
31
4.4.2 CVE-2021-22005 
33
4.4.3 log4j2 JNDI注入 
35
4.4.4 利用Automation API操作虚拟机 
40
4.4.5 利用Web Services API操作虚拟机 
44
4.4.6 利用PowerCLI操作虚拟机 
45
4.4.7 利用SSH登陆ESXI 
48
4.4.8 CVE-2021-21972 
50
4.4.9 Provider-SSRF 
51
目录
CONTENTS
ITDR 之 vSphere
D
ITDR 之 vSphere
4.4.10 Struts2-045 
53
4.4.11 标识源凭据窃取 
56
4.4.12 SAML证书认证 
57
4.5 权限维持 
59
4.5.1 LDAP新增账户 
59
4.5.2 强制重置用户密码 
61
4.5.3 高权限角色赋予 
64
4.5.4 强制重置管理员密码 
66
4.5.5 恶意vib安装包 
67
4.5.6 恶意系统镜像 
68
4.6 防御绕过 
69
4.6.1 禁用日志记录 
69
4.6.2 日志清除 
70
4.6.3 关闭安全监控软件 
71
4.7 虚拟机权限获取 
71
4.7.1 Kon-Boot利用 
71
4.7.2 VMDK文件挂载 
75
4.7.3 快照读取HASH 
78
4.7.4 利用PE获取虚拟机权限 
79
4.8 虚拟机逃逸 
82
5. vSphere加固 
84
5.1 ESXI加固方案 
85
5.1.1 限制ESXI对SSH访问 
85
5.1.2 ESXI最小化权限管理 
86
5.1.3 ESXI 端口管理 
88
5.1.4 开启ESXI锁定模式 
88
5.1.5 虚拟主机启用UEFI安全引导 
89
5.1.6 ESXI启用TLS加密通信 
91
5.1.7 ESXI配置PTP或NTP 
92
5.1.8 对ESXI网络流量进行分层管理 
93
5.1.9 启用主机加密模式 
94
5.1.10 使用TPM2.0验证ESXI 
95
5.2 vCenter Server 加固方案 
96
5.2.1 开启双因素身份验证 
96
5.2.2 加固 vCenter Server 系统 
96
5.2.3 vCenter 配置SSO(Single Sign-On) 
97
5.2.4 避免匿名管理员登录 
98
5.2.5 验证 vSphere Client 证书 
99
5.2.6 设置vCenter虚拟主机RDP高级别加密 
99
5.2.7 限制vCenter Server网络连接 
101