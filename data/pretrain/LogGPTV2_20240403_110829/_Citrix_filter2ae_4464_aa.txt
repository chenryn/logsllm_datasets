# 【技术分享】如何突破Citrix和其他受限桌面环境
|
##### 译文声明
本文是翻译文章，文章来源：pentestpartners.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
****
****
翻译：[ **兴趣使然的小胃**](http://bobao.360.cn/member/contribute?uid=2819002922)
预估稿费：300RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**一、前言**
许多组织及机构正逐步转向虚拟化架构，包括应用及桌面的虚拟化。这一过程通常会涉及如Citrix之类的虚拟化平台来提供服务。
对虚拟化平台而言，如果你配置不当或者锁定失败，那么用户可能会打破你原以为牢不可破的虚拟化环境。可能随后不久，你就会发现你的整个域都被攻陷了。
在这之前，网上可能有很多教程指导用户如何突破受限桌面环境，但据我们所知，这方面还没有一个全面的教程囊括受限桌面环境突破的各种办法。
这正是本文的目的所在，我们希望这是一篇实用的文章。当然，本文也会是一篇不断更新的文章，虽然我们做了大量的努力和研究，但可以肯定的是，我们没有覆盖每一种攻击方法。如果你认为我们在某些方面有所欠缺，请及时告知我们加以补充。
**二、对话框**
获取一个对话框通常是突破虚拟化环境的首个突破口，如果系统经过某种加固，这种方法常常能起到奇效。
即使你只能看到一个非常简单的Notepad应用，你手头上还是有许多可选项的。
即使看起来最为无害、最为简单的应用也可能导致客户域被攻陷，这一点上已经有很多现实案例了。这种现象通常被称为“滚雪球”效应，其中某个小问题引发另一个问题，最终导致整个环境存在极大的安全风险。
许多标准的Windows应用程序通常都会提供某种接口来打开一个对话框：
当然有很多种方法可以打开一个对话框，然而，最简单的方法是：
1、“另存为（Save as）”/“打开为（Open as）”菜单项。
2、“打印（Print）”菜单项：选择“打印到文件（print to file）”选项（比如XPS/PDF等）。
**三、滥用对话框**
打开对话框之后，我们可以此为立足点，开始探索整个系统，或者用来提升权限。能达到什么效果通常与你的创造力有关，但我们通常可以有以下几种方案：
**1、创建新文件**
（1）批处理文件：右键，依次选择“新建（New）”、“文本文件（Text
File）”，重命名为.BAT（或者.CMD）文件，之后选择“编辑（Edit）”，“打开（Open）”。
（2）快捷方式：右键，依次选择“新建（New）”、“快捷方式（Shortcut）”、选择“%WINDIR%system32”。
**2、打开新的Windows资源管理器实例**
在任意文件夹上右键，选择“在新窗口中打开（Open in new window）”。
**3、探索上下文菜单**
（1）在任意文件或目录上右键，观察上下文菜单。
（2）点击“属性（Properties）”，重点观察对象是快捷方式，选择“打开文件路径（Open File Location）”按钮。
**4、输入框**
许多输入框都会接受文件路径，你可以尝试输入UNC路径，如“//attacker–pc/”或者“//127.0.0.1/c$”或者“C:”。
**5、绕过文件限制**
在“文件名（File name）”框中，输入“*.*”或者“*.exe”。
**四、帮助菜单**
帮助菜单有多种存在形式，但我们重点关注的是应用程序的帮助菜单以及通用的“Windows帮助及支持”菜单（可以通过Windows+F1快捷方式启动）。
帮助菜单中通常具有链接及快捷方式，以提供各种功能。如下图所示，用户可以点击其中的链接打开命令提示符：
其他方式：
1、在任意空白处点击右键，选择“查看源码（view source）”，通常会打开一个notepad实例。
2、顶部的打印图标可以引出一个打印对话框。
3、你可以通过语言栏访问帮助菜单。许多需要提供多语言服务的环境中（比如机场）经常会遇到这种场景。
4、许多应用程序经常会在开始菜单中带有指向厂商网页的超链接（比如www.vendor.com）。点击这种链接通常可以引出一个IE浏览器窗口，这也是一个突破口。
**五、环境变量/绕过路径限制**
某些系统做了些加固处理，我们无法直接访问某个敏感路径，如“C:WindowsSystem32”目录。但我们还是有可能使用各种符号链接绕过这个限制。
    %ALLUSERSPROFILE%
    %APPDATA%
    %CommonProgramFiles%
    %COMMONPROGRAMFILES(x86)%
    %COMPUTERNAME%
    %COMSPEC%
    %HOMEDRIVE%
    %HOMEPATH%
    %LOCALAPPDATA%
    %LOGONSERVER%
    %PATH%
    %PATHEXT%
    %ProgramData%
    %ProgramFiles%
    %ProgramFiles(x86)%
    %PROMPT%
    %PSModulePath%
    %Public%
    %SYSTEMDRIVE%
    %SYSTEMROOT%
    %TEMP%
    %TMP%
    %USERDOMAIN%
    %USERNAME%
    %USERPROFILE%
    %WINDIR%
    shell:Administrative Tools
    shell:DocumentsLibrary
    shell:Libraries
    shell:UserProfiles
    shell:Personal
    shell:SearchHomeFolder
    shell:System
    shell:NetworkPlacesFolder
    shell:SendTo
    shell:UserProfiles
    shell:Common Administrative Tools
    shell:MyComputerFolder
    shell:InternetFolder
我们也可以使用文件协议前缀，打开使用其他方式无法打开的应用程序：
    about:
    data:
    ftp:
    mailto:
    news:
    res:
    telnet:
    view-source:
即使在某些经过大量加固处理的系统上，我们也是有可能使用UNC路径：
    \127.0.0.1c$WindowsSystem32
**六、夺取命令提示符**
如果我们能够访问命令提示符，那么我们在突破受控系统上已经取得了第一阶段的胜利，我们可以借此获取操作系统的许多控制权，比如枚举许多有用的信息，为权限提升做准备。许多系统的加固强度不够大，在开始菜单中都能看到cmd.exe的标准快捷方式，我们自然可以将这个接口当成第一个突破口：
通常情况下，我们可以使用多个可执行程序获取系统的shell接口：
1、Cmd.exe
2、COMMAND.COM
3、Powershell.exe
4、第三方的管理/shell工具
**6.1 通过“运行（Run）”对话框**
这可能是最简单的一种办法。可以通过开始菜单或者“Windows+R”快捷键打开运行对话框：
**6.2 通过资源管理器**
这也是种简单有效的方法。浏览包含可执行程序的目录（例如“C:windowssystem32”），我们可以选择可执行程序，在弹出的右键菜单中选择：
**6.3 文件拖放**
我们可以将任何文件拖放到cmd.exe文件上（即便不正确的扩展名，如*.txt也可以），这样会弹出一个命令提示符窗口：
**6.4 超链接/快捷方式**
我们可以利用文件处理器，使用与可执行程序绑定的链接。这个链接可以在许多地方使用，比如对话框、在微软Office内部按住CTRL再点击链接等等。这个链接为“file:///c:/Windows/System32/cmd.exe”。
**6.5 任务管理器**
Windows的任务管理器能帮我们不少忙，此外，它也可以用来创建新的进程。我们可以通过各种方式启动任务管理器（taskmgr），比如开始菜单、较新版的Windows中的CTRL+ALT+DELETE组合键，以及直接使用CTRL+SHIFT+ESCAPE组合键。
**6.6 计划任务（Task Scheduler）**
这是个非常有趣的薄弱点。某些系统可能会限制cmd.exe的访问，但还是可以通过计划任务启动cmd.exe。我们可以用过命令行形式的计划任务工具（at.exe）或者GUI形式的计划任务工具（taskschd.msc）完成这一任务。在计划任务中，我们可以指定在特定时间（如1分钟内）或者特定事件（如用户登录）发生时运行cmd.exe。
**6.7 COMMAND.COM**
这是Windows出于兼容性而保留的一个16位程序。即使cmd.exe被禁用，这个程序通常也是可以访问的。不幸的是，64位的Windows中再也不提供COMMAND.COM了。
**6.8 Powershell.exe**
与cmd.exe类似，但PowerShell具备某些更加高级的功能，例如它可以使用并调用.NET的某些功能。
**6.9 MSPAINT.exe**
这是一种不常用但行之有效的方法，我们可以在微软的画图工具中绘制特定的颜色，创建指向cmd.exe的快捷方式，最终获取shell接口。其原理与创建BMP文件所使用的编码算法有关，我们可以小心选择特定的RGB颜色，将ASCII数据写入到某个文件中。
1、打开MSPaint.exe，设置画布大小为：宽度=6，高度=1像素。
2、放大画布，以便操作。
3、使用颜色选择器，按从左到右的顺序，依次使用以下数值设置像素值：
（1）R: 10, G: 0, B: 0
（2）R: 13, G: 10, B: 13
（3）R: 100, G: 109, B: 99
（4）R: 120, G: 101, B: 46
（5）R: 0, G: 0, B: 101
（6）R: 0, G: 0, B: 0
4、将该图保存为24位位图（*.bmp；*.dlib）
5、将其扩展名从bmp改为bat，然后运行。
**6.10 绕过交互式控制台限制**
当交互式命令提示符被禁用时，我们通常可以使用“/K”或者“/C”参数运行cmd.exe。我们可以使用“cmd.exe /K
pause”命令，就能绕过限制，载入一个交互式shell：
此外，我们也可以将“/C”参数传递给cmd.exe，创建一个非交互式的命令提示符会话。比如，我们可以使用如下命令“cmd.exe /C tasklist >
c:tasks.txt”。
**6.11 FTP方式**
虽然FTP客户端不能提供完全形式的命令行访问接口，但它通常是可用的，在其他通道都被堵死的情况下，我们可以在FTP客户端中使用“!dir”命令，罗列系统文件。此外，FTP客户端也可以用来传输数据，下载第三方工具。
其他一些有用的FTP命令：
    !whoami
    !date
    !ping 127.0.0.1
**七、绕过写入限制**
绕过目标环境的写入限制是非常重要的一点，我们可以借助这类技术，找到上传第三方工具以及写入数据的系统区域。
在一个理想的环境中，最好的管理原则就是用户只能具备最低的写入权限，同时不会对其正常工作造成影响。在现实中，这意味着用户在本地文件系统中只能具备非常低的写权限。
临时目录是一个很好的突破口，用户几乎总是具备该目录的写权限。我们可以通过“%TEMP%”环境变量，枚举默认的临时目录位置，类似的命令为“echo
%TEMP%”。临时文件目录通常为：
1、C:UsersUSERAppDataLocalTemp
2、C:temp
3、C:tmp
当然“%USERPROFILE%”目录也是另一个选择，不过该目录有可能会链接到某个网络共享文件夹。
Accesschk.exe
该工具属于Sysinternals工具集中的一员，与“cacls”/“icacls”功能类似。
我们可以使用这个工具，查找文件系统中我们具备哪些目录的写权限：
accesschk.exe -uwdqs Users c:
accesschk.exe -uwdqs “Authenticated Users” c:
**八、绕过执行限制**
某些系统会使用白名单机制，只允许某些具备特定文件名或文件扩展名的应用程序运行。有些时候，我们可以将malware.exe重命名为白名单中的合法名称（如mspaint.exe），绕过白名单限制。
在某些配置不当的环境中，只要目录符合白名单标准，任何应用程序都可以运行。如果你正在测试的系统允许运行微软的Word程序，你可以尝试将待运行的程序拷贝到WINWORD.EXE所在的目录加以运行。