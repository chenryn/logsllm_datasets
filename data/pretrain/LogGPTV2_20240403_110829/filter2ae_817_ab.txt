    039f79ec  00000000 00000000 00000000 00000000
    039f79fc  ffff0000 ffffffff 0000ffff 00000000
    039f7a0c  ffff0000 0000ffff 00000000 00000000
    039f7a1c  00000000 01500640 5b694a29 00000000
    039f7a2c  00000000 00000000 00000000
由前面断下时寄存器edx可知，程序在取得index=4对应的对象后，产生了崩溃，让我们看看这是个什么神仙。
    0:000> dd poi(ecx)+10+5c*4 l5c/4
    039f7980  0000020a 000000e0 0000002e 00000027
    039f7990  00000000 00000000 00000000 00000000
    039f79a0  ffff0000 ffffffff 0000ffff 00000000
    039f79b0  ffff0000 0000ffff 00000000 00000000
    039f79c0  00000000 0148d300 5b2acb04 00000000
    039f79d0  00000000 00000000 00000000
    0:000> dc 0148d300
    0148d300  0000045f 00000000 00000000 00000000  _...............
    0148d310  00000000 00000000 00000000 00000000  ................
    0148d320  00000000 00000000 0069004c 0063006e  ........L.i.n.c.
    0148d330  00720065 00680043 00720061 00680043  e.r.C.h.a.r.C.h.
    0148d340  00720061 088888ec 006f0066 0074006e  a.r.....f.o.n.t.
    0148d350  0062ff1a 00740061 006e0061 00000067  ..b.a.t.a.n.g...
    0148d360  00000000 00000000 00000000 00000000  ................
    0148d370  00000000 00000000 00000000 00000000  ................
这时我们发现那个0x088888ec在这对象的+44h处了，对照docx中的样式，我们可以推断这是那个font对象。
不知道客官是否好奇那个结构体数组中其它对象是什么呢，我们再来一探究竟。
    0:000> dd poi(ecx)+10+5c*3 l5c/4
    039f7924  0000ffff 0000ffff 0000001a 0000001a
    039f7934  00000001 00000000 00000000 00000000
    039f7944  ffff0000 ffffffff 0000ffff 00000000
    039f7954  ffff0000 0000ffff 00000000 00000000
    039f7964  00000000 015006e0 5b694a29 00000000
    039f7974  00000000 00000000 00000000
    0:000> dc 015006e0
    015006e0  00000001 00000001 0148cf18 00000009  ..........H.....
    015006f0  00000000 00000000 00000000 00000000  ................
    01500700  00000000 000004b0 00000000 00000000  ................
    01500710  0005003c 00000000 00000000 00000000   du 0148cf18 l9
    0148cf18  "OLEObject"
    0:000> dd poi(ecx)+10+5c*5 l5c/4
    039f79dc  0000ffff 0000ffff 0000001a 0000001a
    039f79ec  00000000 00000000 00000000 00000000
    039f79fc  ffff0000 ffffffff 0000ffff 00000000
    039f7a0c  ffff0000 0000ffff 00000000 00000000
    039f7a1c  00000000 01500640 5b694a29 00000000
    039f7a2c  00000000 00000000 00000000
    0:000> dc 01500640
    01500640  00000001 00000001 01f86ee0 00000005  .........n......
    01500650  00000000 00000000 00000000 00000000  ................
    01500660  00000000 000004b0 00000000 00000000  ................
    01500670  0005003c 00000000 00000000 00000000   du 01f86ee0 l5
    01f86ee0  "idmap"
原来它们分别对应OLEObject和idmap，和xml相呼应。至此，我想客官可以大胆猜上一猜了，Office在解析那段xml时，解析器维护了一段内存来保存解析状态，当处理``时，存在type
confusion漏洞，取得了前置font对象内容，且可以被利用来控制寄存器eax，从而控制程序流程。如果``这个tag正确闭合，可以验证该font对象内容不会存在于那段内存中。
#### 补丁
知道漏洞关键点后，寻找补丁也就顺理成章，不难找到具体位置了。取得对象指针后，再比较了+48h处的指针，如果不对应则跳转了。
    .text:31B8960B 8B 01               mov     eax, [ecx]
    .text:31B8960D 8B 10               mov     edx, [eax]
    .text:31B8960F 4A                  dec     edx
    .text:31B89610 4A                  dec     edx
    .text:31B89611 E8 E8 70 D4 FF      call    xxx_retrieve_obj_ptr
    .text:31B89616 81 78 48 4A 4A E9+  cmp     dword ptr [eax+48h], offset sub_31E94A4A ; patch for CVE-2017-11826
    .text:31B8961D 75 1D               jnz     short loc_31B8963C
    .text:31B8961F 8B 40 44            mov     eax, [eax+44h]
    .text:31B89622 8B 40 44            mov     eax, [eax+44h]
    .text:31B89625 8B 4F 44            mov     ecx, [edi+44h]
    .text:31B89628 89 41 44            mov     [ecx+44h], eax
    .text:31B8962B 8B 47 44            mov     eax, [edi+44h]
    .text:31B8962E 8B 40 44            mov     eax, [eax+44h]
    .text:31B89631 8B 08               mov     ecx, [eax]
    .text:31B89633 50                  push    eax
    .text:31B89634 FF 51 04            call    dword ptr [ecx+4]
#### 禅(xian)定(zhe)时刻
正常打开利用文件，咣当崩溃了，这是为啥呢？
    (a70.544): Access violation - code c0000005 (!!! second chance !!!)
    eax=768a0000 ebx=088883ec ecx=00000000 edx=77206c74 esi=768a0000 edi=08888f70
    eip=08889000 esp=08888f70 ebp=08888f70 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
    08889000 e893ffffff      call    08888f98
许久没写文章，疏漏在所难免，欢迎到微博联系指正。[@binjo_](http://weibo.com/binjo8)
欢迎转发分享，或者打赏一杯咖啡钱。 :)
#### 参考
  1. 
  2. 
  3. 
  4. 
* * *