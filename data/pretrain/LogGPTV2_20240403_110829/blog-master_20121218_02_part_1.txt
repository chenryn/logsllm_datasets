## PostgreSQL aggregate function customize
### 作者                                                                                 
digoal                                                                                  
### 日期                                                                                 
2012-12-18                                                                                      
### 标签                                                                                
PostgreSQL , 自定义聚合函数 , aggregate function , udf                                                                                                                                       
----                                                                                
## 背景            
聚合操作是统计分析的常见需求，聚合实际上就是把多行变成单行。    
比如count, sum, avg, min, max, 线性相关性等等    
本文介绍一下如何编写聚合函数。    
## 正文    
昨天聊到了一个关于多行转换成单行以提高查询性能的场景。  
http://blog.163.com/digoal@126/blog/static/163877040201211174617734/  
这里用到了PostgreSQL的聚合函数, 将多行聚合成单行.  
当然其他数据库也有聚合函数, 但是PostgreSQL 支持自建聚合函数, 这就给开发带来了较大的便利.  
例如PostgreSQL 8.2 并没有昨天用到的array_agg聚合函数.  
那么要实现同样的场景怎么办呢?  
例如在GreenPlum 3.3.6中, 实际上是PostgreSQL 8.2.13的版本.  
要实现同样的功能, 可以简单通过的创建一个自定义聚合函数来实现。  
例如我们的目标是整合成app_id||'_'||rating 逗号隔开的一个text值.   
那么可以通过||这个操作符或者函数来实现, 如下.  
```  
-- 创建聚合函数  
digoal=# create aggregate agg_append (text) (  
sfunc = textcat,  
stype = text);  
-- 创建测试表  
digoal=# create table recommendation_mpt (user_id int8, app_id numeric, rating numeric) distributed randomly;  
CREATE TABLE  
-- 插入测试数据  
digoal=# insert into recommendation_mpt select generate_series(1,1000000), generate_series(1,41), random();  
INSERT 0 41000000  
-- 创建聚合后的表  
digoal=# create table recommendation_mpt_new ( user_id int8, app_id text ) distributed randomly;  
CREATE TABLE  
-- 插入聚合后的数据  
digoal=# insert into recommendation_mpt_new select user_id, agg_append(app_id||'_'||rating||',')  from  recommendation_mpt group by user_id;  
INSERT 0 1000000  
-- 查询结果  
digoal=# \x  
Expanded display is on.  
digoal=# select * from recommendation_mpt_new limit 2;  
-[ RECORD 1 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
user_id | 1  
app_id  | 21_0.936229802202433,19_0.241772226057947,27_0.956521810032427,9_0.8754295501858,7_0.338058620225638,41_0.226744973100722,38_0.204116075765342,40_0.884842214174569,17_0.659971259534359,10_0.767988855019212,37_0.901241634506732,6_0.853149639908224,16_0.745244240853935,39_0.813799708615988,1_0.868315862957388,28_0.228956982959062,31_0.311310657765716,26_0.180641509592533,30_0.0854418091475964,29_0.289730631746352,36_0.90720307873562,18_0.533597331959754,8_0.459905118215829,20_0.144313692115247,11_0.18922403594479,25_0.202533770818263,24_0.994741758797318,2_0.458359555341303,34_0.530500751920044,4_0.789138578809798,14_0.557009539101273,15_0.853544842917472,22_0.110565081238747,13_0.238142486196011,3_0.734461918473244,32_0.154231588821858,5_0.299331326968968,33_0.53225368168205,35_0.422972090076655,12_0.806360349990427,23_0.380616633687168,  
-[ RECORD 2 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
user_id | 346  
app_id  | 21_0.923598561901599,39_0.534792800433934,29_0.0692782052792609,22_0.206713933963329,9_0.9313296796754,31_0.67749793222174,1_0.0934103117324412,10_0.695828275289387,41_0.621980169788003,11_0.87125027552247,30_0.079912081360817,40_0.478423351421952,19_0.387606668751687,20_0.496157462708652,8_0.552907709032297,24_0.0219633430242538,23_0.76717281434685,28_0.927976955194026,14_0.818206876516342,16_0.478273885324597,17_0.306423192843795,3_0.193629603367299,33_0.418421885930002,13_0.748691521584988,5_0.0270167640410364,36_0.358466576784849,34_0.444800178986043,27_0.790532193612307,26_0.380120156798512,35_0.933182283304632,2_0.253765208646655,37_0.922488207463175,4_0.0538468402810395,38_0.768641801085323,15_0.406475386582315,18_0.493758061900735,25_0.463594998698682,7_0.884454429149628,12_0.0971177448518574,32_0.395383660681546,6_0.936530550476164,  
```  
注意  
因为aggregate函数支持order by是从9.0开始才有的, 所以在greenplum 3.3.6也就是PostgreSQL8.2中创建的aggregate当然无法使用orderby来对rating排序. 语法错误如下 :   
```  
digoal=# insert into recommendation_mpt_new select user_id, agg_append(app_id||'_'||rating||',' order by rating desc)  from  recommendation_mpt group by user_id;  
ERROR:  syntax error at or near "order"  
LINE 1: ...lect user_id, agg_append(app_id||'_'||rating||',' order by r...  
                                                             ^  
```  
当然array_agg也是可以实现的, 需要用到的函数是array_append. 如下 :   
```  
digoal=# create aggregate array_agg (anyelement) (  
  sfunc = array_append,  
  stype = anyarray);  
select user_id, array_agg(app_id||'_'||rating) from recommendation_mpt group by user_id;  
                                              array_agg                                                                               
---------+--------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------------------------------------------------------  
--------------------------------------------------------------------------------------------  
       3 | {12_0.337564039975405,18_0.605327501893044,39_0.0606710785068572,30_0.249253052286804,31_0.68522938946262,1_0.58626456419  
006,11_0.342015425674617,3_0.383131602779031,29_0.485176796559244,9_0.489787132013589,21_0.478506665676832,22_0.881940244697034,19_0  
.501696343999356,38_0.611436820123345,23_0.740357991773635,40_0.657328587025404,2_0.973510192707181,13_0.987239361740649,20_0.827145  
711518824,28_0.930344801396132,32_0.726034674327821,41_0.175069946330041,10_0.876182099804282,7_0.609756181947887,33_0.3557396410033  
11,8_0.861955059692264,27_0.173304431606084,15_0.544581302441657,25_0.661107395309955,16_0.671136009506881,24_0.384254441130906,6_0.  
0688453107140958,34_0.290453566238284,17_0.787856891285628,14_0.0598205337300897,26_0.78198639722541,5_0.641678368207067,37_0.560569  
697991014,4_0.314639654941857,35_0.1592174815014,36_0.154369496740401}  
...  
略  
```  
那么排序怎么来实现呢?  
我们来看看aggregate的语法, 有一个finalfunc这个是在每次分组的聚合处理完后执行的函数. 例如上面得到的结果  
```  
12_0.337564039975405,18_0.605327501893044,39_0.0606710785068572,30_0.249253052286804,31_0.68522938946262,1_0.58626456419  
006,11_0.342015425674617,3_0.383131602779031,29_0.485176796559244,9_0.489787132013589,21_0.478506665676832,22_0.881940244697034,19_0  
.501696343999356,38_0.611436820123345,23_0.740357991773635,40_0.657328587025404,2_0.973510192707181,13_0.987239361740649,20_0.827145  
711518824,28_0.930344801396132,32_0.726034674327821,41_0.175069946330041,10_0.876182099804282,7_0.609756181947887,33_0.3557396410033  
11,8_0.861955059692264,27_0.173304431606084,15_0.544581302441657,25_0.661107395309955,16_0.671136009506881,24_0.384254441130906,6_0.  
0688453107140958,34_0.290453566238284,17_0.787856891285628,14_0.0598205337300897,26_0.78198639722541,5_0.641678368207067,37_0.560569  
697991014,4_0.314639654941857,35_0.1592174815014,36_0.154369496740401  
```  
对这个结果进行处理, 每个分组都会调用一次  
我们可以利用这个finalfunc指定的函数来对每个分组的聚合结果进行排序.  
例如 :   
```  
digoal=# select split_part(i,'_',1) as app_id, split_part(i,'_',2) as rating from regexp_split_to_table('21_0.923598561901599,39_0.534792800433934,29_0.0692782052792609,22_0.206713933963329,9_0.9313296796754,31_0.67749793222174,1_0.0934103117324412,10_0.695828275289387,41_0.621980169788003,11_0.87125027552247,30_0.079912081360817,40_0.478423351421952,19_0.387606668751687,20_0.496157462708652,8_0.552907709032297,24_0.0219633430242538,23_0.76717281434685,28_0.927976955194026,14_0.818206876516342,16_0.478273885324597,17_0.306423192843795,3_0.193629603367299,33_0.418421885930002,13_0.748691521584988,5_0.0270167640410364,36_0.358466576784849,34_0.444800178986043,27_0.790532193612307,26_0.380120156798512,35_0.933182283304632,2_0.253765208646655,37_0.922488207463175,4_0.0538468402810395,38_0.768641801085323,15_0.406475386582315,18_0.493758061900735,25_0.463594998698682,7_0.884454429149628,12_0.0971177448518574,32_0.395383660681546,6_0.936530550476164',',') t(i) order by 2 desc;  
 app_id |       rating         
--------+--------------------  
 6      | 0.936530550476164  
 35     | 0.933182283304632  
 9      | 0.9313296796754  
 28     | 0.927976955194026  
 21     | 0.923598561901599  
 37     | 0.922488207463175  
 7      | 0.884454429149628  
 11     | 0.87125027552247  
 14     | 0.818206876516342  
 27     | 0.790532193612307  
 38     | 0.768641801085323  
 23     | 0.76717281434685  
 13     | 0.748691521584988  
 10     | 0.695828275289387  
 31     | 0.67749793222174  
 41     | 0.621980169788003  
 8      | 0.552907709032297  
 39     | 0.534792800433934  
 20     | 0.496157462708652  
 18     | 0.493758061900735  
 40     | 0.478423351421952  
 16     | 0.478273885324597  
 25     | 0.463594998698682  
 34     | 0.444800178986043  
 33     | 0.418421885930002  
 15     | 0.406475386582315  
 32     | 0.395383660681546  
 19     | 0.387606668751687  
 26     | 0.380120156798512  
 36     | 0.358466576784849  
 17     | 0.306423192843795  
 2      | 0.253765208646655  
 22     | 0.206713933963329  
 3      | 0.193629603367299  
 12     | 0.0971177448518574  
 1      | 0.0934103117324412  
 30     | 0.079912081360817  
 29     | 0.0692782052792609  
 4      | 0.0538468402810395  
 5      | 0.0270167640410364  
 24     | 0.0219633430242538  
(41 rows)  
```  
但是greenplum中有点问题, 如下 :   
```  
create table recommendation_mpt (user_id int8, app_id numeric, rating numeric);  