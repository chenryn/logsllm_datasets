### Optimized Text

To enhance the performance of the scanning process, Exitmap employs two-hop circuits instead of the default three-hop circuits. Single-hop circuits are not an option because, by default, exit nodes do not allow direct connections from non-Tor IP addresses [14]. Additionally, the authors of Exitmap argue that one-hop circuits may enable exit node operators to treat scanning connections differently [30, §3.2].

To measure discrimination against Tor, we send multiple HTTP requests per URL: with Tor through every available exit node and one without Tor. We use Exitmap to build Tor circuits and a Python program to send the HTTP requests. Our experiment, which involved downloading thousands of URLs per exit node, pushed Exitmap beyond its original design parameters, requiring us to overcome several scanning challenges. Downloading a single URL using all Tor exits typically takes 45–50 minutes on average, much of which is due to circuit-construction overhead. To reduce the total scanning time, we ran five instances of Exitmap in parallel and downloaded 20 URLs at a time through each circuit. With these changes, visiting 100 URLs through every Tor exit node takes approximately 1–2 hours on average. By default, Tor rebuilds circuits and streams every hour, but we configured parameters to prevent this.

We collected data over five days, from August 10 to August 14, 2015, selecting exit nodes that allow traffic through ports 80 and 443. Different runs of Exitmap can select different exit nodes for two reasons: 
1. The Tor directory authorities release a fresh consensus on available nodes every hour. New nodes might appear, old nodes might disappear, and nodes can change their 'exit policy' of allowed ports. Thus, the available exit nodes can change every hour.
2. To build circuits, Tor clients need to download 'enough' of the network to construct a sufficiently large number of possible paths. By default, Tor uses a value chosen by the directory authorities, which can change every hour. Therefore, different exit nodes might be selected at different times.

During our data collection period, we gathered data from 899–915 exit nodes. The distribution of exit probabilities in our dataset is within the regular range, as shown in Figure 3. We have a good mix of both high- and low-probability exit nodes. We observed that 83%–89% of the circuits succeeded, a success rate similar to previous exit scanning studies [30].

Table VIII shows the total number of HTTP requests sent and responses received each day. We intended to send 1,000 HTTP requests through over 900 exit nodes. The number of HTTP requests per exit node should be 1,000, but the average was less than 800. This discrepancy occurs for two reasons:
1. As mentioned earlier, different exit nodes can be selected during different runs of Exitmap because the available exit nodes can change every hour. Since our crawl takes over 10 hours to complete, some exit nodes were not available for the entire duration.
2. Even when the same exit nodes are selected, some exit nodes cannot handle 1,000 HTTP requests due to resource limitations.

We consider a website to discriminate against Tor if it responds with a 200 'OK' status code when visited without Tor and some other valid but non-200 level status code when visited with Tor. On average, around 3.67% of the Alexa top 1,000 websites responded with a non-200 status code when visited through Tor (Table VIII), whereas only at most 6 sites responded with a non-200 code when visited without Tor.

To check whether this difference is statistically significant, we computed the p-value using a permutation test under the null hypothesis of independence. We chose the permutation test because it does not assume that the responses of the experimental units are independent and identically distributed. In our case, many of the top Alexa 1,000 websites are hosted on CloudFlare and Akamai CDNs. For all of these sites, whether they send a non-200 response to a Tor exit is not independent. The p-value of the permutation test is 0.008, indicating that web visits through Tor receive different treatment from the websites. We also encountered around 8% non-HTTP errors such as timeouts and connection resets, which can be caused by discrimination at layers 3 and 4.

We noticed that no site blocks all Tor exit nodes (Figure 5). During these five days, on average, 15.6 sites out of the Alexa 1,000 top sites blocked over 60% of Tor exit nodes. These sites include yelp.com (up to ≈ 70% exit nodes blocked), macys.com (up to ≈ 60%), and bestbuy.com (up to ≈ 66%). The majority of these sites are hosted on Akamai and Amazon Web Services. Websites on Akamai all show a 403 'Access Denied' block page, which a user cannot bypass. Yelp and Craigslist have their own block pages. Some websites, such as macys.com, return a redirect error that often leads to an infinite redirect loop. On average, around 69 sites block over 10–50% of the Tor exit nodes (Figure 4). The majority of these websites are hosted on CloudFlare. On average, around 150 websites block less than 10% of the Tor exit nodes, and the rest of the websites (over 700) do not block any exit nodes at the home page.

To determine whether these blocking events are abuse-based or Tor-specific, we examined the age and exit probability of exit nodes. We assume that abuse-based blocking is more likely to block old or high-probability exit nodes because they have more opportunity to attract abuse, while blacklist-based or Tor-specific blocking tends to block all exits equally. We downloaded node exit probabilities and ages from Onionoo [20] and used logistic regression to determine the effect of exit characteristics on blocking rates. Overall, across all measured sites, we did not find any statistically significant effect; however, for specific websites and specific blockers, we found significant effects. We manually tested three sites: bestbuy.com (on Akamai), change.org (on CloudFlare), and 4chan.org (on CloudFlare). Figure 4 compares the different subsets of exits blocked by these three sites.

Some sites do not block Tor on their home page but block other pages or functions. We conducted a small ancillary experiment on search engines with URLs containing search queries. The home page of google.com is not blocked for any Tor exit node, but searching on Google was blocked for 23–40% of them (varying on different days). We observed similar behavior on Yahoo!, where searching is blocked for around 1% of the exits, but the homepage is always accessible.

We found 42 exit nodes that were not blocked by any of the Alexa top 1,000 websites during our 5-day crawl. These exits do not appear to be dedicated Tor exit nodes. All the exits have similar characteristics: 1) All except one are hosted on...