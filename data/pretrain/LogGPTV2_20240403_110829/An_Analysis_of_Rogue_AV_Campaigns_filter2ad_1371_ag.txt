116213 3785 14340
US
2574
CN 34778
1760
20147
JP
483
NL
17651
FR
16261
482
1316
KR 14822
569
12824
IT
952
9587
GB
DE
9441
818
355
9119
SE
90
329
172
164
326
204
414
408
113
Fig. 4. A summary of the diverse ORDNS
scanning targets
26
M. Antonakakis et al.
F
D
C
 1
 0.98
 0.96
 0.94
 0.92
 0.9
 0.88
 0.86
 0.84
 0.82
 0.8
e
m
u
o
V
l
 100
 90
 80
 70
 60
 50
 40
 30
 20
 10
 0
 0
 50  100  150  200  250
Days
 0
 10
 20
 30
 40
 50
Days
 60
 70
 80
 90
 100
bestbuy.com
amazon.com
blogger.com
ebay.com
F
D
C
 1
 0.98
 0.96
 0.94
 0.92
 0.9
 0.88
 0.86
 0.84
 0.82
 0.8
e
m
u
o
V
l
 80
 70
 60
 50
 40
 30
 20
 10
 0
 0
 50  100  150  200  250
 0
 10
 20
 30
Days
 40
Days
 50
 60
 70
 80
capitalone.com
chase.com
citibank.com
fedex.com
Fig. 5. IP discovery trend in Anax for zones
that use CDN networks or are network
diverse
Fig. 6. IP discovery trend in Anax for network
stable zones
reason for selecting these different types of queries is to discover as many different RRs
as possible for each zone without requiring access to the zone itself.
Let us assume that d is a domain of interest. The complete probing protocol we use
is the following querying sequence: the ﬁrst query is an A-type and for the domain
dcontrol, which we own and for which we operate the only “legitimate” authority name
server (ANS). The A-type of record for this domain contains a single IP that we never
change. Using this simple technique we can check if the ORDNS server we probe is
acting as a real open-recursive, is mis-conﬁgured or provides a DNS-tunneling service.
The second query is an A-type and for the domain d. These queries provide Anax
with the current IP address of the probed domain d. The third is an A-type query
for random value.d. Since the random nonce (random value) does not exist, and
the zone does not use wild-card entries, this query ensures that the remote ORDNS
always reaches the authority name server (ANS) of d. This results in an answer of
NXDOMAIN. We are certain about this since we can trivially verify that none of the
zones of interest are wild-carded in the 2nd level domain (2LD). The fourth query
is an NS-type query for d, from which Anax discovers the current IP and domain
name information about the authority name servers for the domain name d. Some CDN
enabled zones (e.g., bestbuy.com) tend to have their authority name servers operated
by the CDN network. We want to capture this diversity in our dataset.The ﬁfth query
is an MX-type query for d, which provides us with the current email servers for the
domain name d. Typically this IP location is managed by the same owner of the domain
name d. Some zones, however, simply outsource their e-mail services (e.g., AT&T and
MessageLabs). The sixth is an AAAA-type query for the domain name d, based on
which we can record again the start of authority record (SOA-type) for the domain d.
As noted above, we probe using this sequence of queries so we can obtain key char-
acteristics about the open-recursive server in a single scan event: IP and nameserver
information for each domain of interest. We discover as many IP to domain name map-
pings for each zone as possible due to query type variation (A, NS, MX, AAAA). In
Figures 5 and 6 we can see a sample of the two observed IP address discovery growth
trends that we observe with Anax’s scanning engine. Figure 5 shows that domain names
that exhibit signiﬁcant network diversity for IP address present in legitimate A-type
A Centralized Monitoring Infrastructure for Improving DNS Security
27
answers (e.g., blogger.com, amazon.com) or utilize CDN networks (e.g., bestbuy.com
uses akamai.net), Anax needs more time to identify all possible IPs addresses. In this
case Anax will identify 95% of address records for these network diverse zones in 8-12
days while at the same time continue discovering new IP addresses months after the
start of scanning. In Figure 6 domain names with a more stable network proﬁle utilize
signiﬁcantly fewer IP addresses over time. In this case Anax takes less time (95% of
address records will be discovered in 2-3 days) to discover almost all of them.
4 Dataset Evaluation
Using the Anax infrastructure described in Section 3, we periodically made a large
number of DNS queries to a set of 300,000 ORDNSs for the 131 zones of interest.
The raw DNS collector holds the DNS data generated by Anax’s scanning engines. The
scanning points periodically synchronize their data to this server for analysis. When the
system is in on-line mode (Figure 2; step ﬁve) the data can be instantly classiﬁed as
it arrives in the raw DNS collector. Potentially, the detection engine could be placed
directly at the scanning points and classify new RRs on-the-ﬂy.
We evaluated the system in its off-line mode since it was necessary for us to carefully
obtain ground truth for our classiﬁcation process. We used part of the captured trafﬁc to
evaluate our detection algorithm. For training our detection system, we used 23 million
DNS answers recorded between January 2009 ant the end of February 2009. To create
the testing dataset, we used 57 million DNS answers recorded between March 2009 and
August 2009.
The raw DNS data gathered by Anax holds all possible observations made about
the resource records (RRs) in the received answers for all zones of interest. Our dataset
provides “evidence”—that is the RRs (“Domain Name to IP” and “Domain Name to NS
server”) returned by the ORDNS. A portion of the unique RRs present in these datasets
were manually classiﬁed to provide the ground truth for our study. At this point we
should note that Anax is able to classify A-type resource records or “Domain Name
to IP” mappings. The collection of the NS-type records (or “Domain Name to Name
Server” mappings) helped us in the manual classiﬁcation process and forensic analysis
of the hand veriﬁed poisoning cases.
4.1 Dataset Labeling
We constructed our limited whitelist by selecting 23 “major” recursive DNS servers
across the US. Using a one-time probe against these open-recursive servers, we obtained
all address records for the 131 zones of interest. We hand veriﬁed that each address
found in the returned answers was indeed part of the legitimate domain resolution. After
mapping the returned IPs to the corresponding Classless Inter-Domain Routing (CIDR)
block, we used this newly created set of CIDRs as our only CIDR based whitelist.
During our eight month scanning period, while most of the answers were deemed
legitimate, not all illegitimate answers were necessarily poisonous. DNS misconﬁgura-
tion is a common phenomenon, and sometimes resembles malicious behavior (39; 16).
To account for this, we created several labels for a range of responses: Legitimate
28
M. Antonakakis et al.
Response, CDN, Misconﬁguration, NXDOMAIN rewriting, DNS Proxy, and Poison-
ing, as described below:
Legitimate Response: Legitimate responses indicate a properly functioning ORDNS
server returning correct results. The resolutions and authoritative name servers for
the list of domain names of interest all point to machines in the same autonomous
system among open-recursive servers in the same geographic region, and match
prior, veriﬁed answers. Our initial whitelist is a small subset of this category.
Content Delivery Networks (CDN): Many zones use DNS to load balance and local-
ize web trafﬁc for popular destinations. This appears where the domain’s addresses
are assigned to a known content delivery network such as Akamai or Limelight.
Network blocks operated by content delivery networks are highly diverse and it
is difﬁcult to whitelist all their members. We consulted passive DNS databases
(e.g., (22)), to assist on labeling IPs on this category.
Misconﬁguration: Some answers showed clear signs of misconﬁguration. This is of-
ten seen when hosts answer as an authoritative for the root servers or common
TLDs such as .com, .net, or .org, or instead return an RFC 1918 or RFC
3330 address. These errant authoritative answers are described in (39) as
misconﬁguration.
NXDOMAIN rewriting Services: When an IP address was returned for a query that
should elicit an NXDOMAIN response, the result was labeled as NXDOMAIN
rewriting. These results are not cases of malicious poisoning, and can be detected
when an open-recursive DNS server returns an IP address instead of NXDOMAIN
for a domain known not to exist. Generally, the resulting IP address points to an
advertising portal or a search engine.
DNS proxy: When the ORDNS always provides the same IP address for multiple zone
and query types, and at the same time we can identify it as DNS tunnel (2) or a
ToTD (31) server, we classify it as DNS proxy. Most tellingly, such resolvers ex-
hibit no IP variations, since they never consult authorities and maintain no cache.
Strictly speaking, we do not treat this as DNS poisoning, even though local net-
works may likely wish to ban the use of DNS proxies.
Poisoning: We hand-verify and label as “poisonous” any address returned by an
ORDNS that was not owned by the domain name owner, and pointed to a machine
under the control of a malicious party. To assist with this labeling, we consulted
numerous IP blacklists (30; 24; 13), do-not-route-lists (28), dynamic IP space (29)
and passive DNS databases (22). IPs in RRs that pointed to such hosts indicated
malicious poisoning of an ORDNS.
5 Detection Model and Results
The poison detection ﬂow in Anax consists of detection modules placed in series to
reduce false positives and produce as few false negatives as possible. (As noted below,
we arranged these detection modules to place the highest false positive rate ﬁrst, to
maximize the ﬁnal true detection rate) Figure 7 shows the various steps of the detection
ﬂow. RRs not in the Anax DB are forwarded to the CIDR analysis module deﬁned
A Centralized Monitoring Infrastructure for Improving DNS Security
29
RR(s)
Not in  
Anax DB
DB Check
Anax
DB
Yes - L[3]
CIDR Analysis
Module
Poisoning?
No - L[0,1,2]
L[4] - 
Unknown
Anax 2-Class
Classiﬁer
Fig. 7. Poisoning detection ﬂow in Anax
Poisoning 
Alert
Yes
Poisoning?
No
in Section 5.2. The L[0]-L[4] categories (deﬁned in Section 5.1) represent the various
ways the CIDR analysis module may classify a new RR. The 2-Class classiﬁer (deﬁned
in Section 5.3) handles the unknown RRs from the CIDR analysis module (category
L[4]) and ﬂags them as benign or poisonous, based on trained models of benign and
poisonous RRs. In the case of poisonings, Anax produces a detailed poisoning report
on the RR that caused this alert. The detection ﬂow ends by updating the Anax DB on
the analyzed RRs. In the following sections we examine in detail the key modules of
Anax’s detection ﬂow, namely the CIDR analysis module and Anax’s 2-class classiﬁer.
5.1 Categories of Resource Records
In Section 4.1 we identiﬁed the type of DNS responses we anticipate to receive. Be-
fore we elaborate on the details of the CIDR analysis module and 2-Class classiﬁer we
introduce the categories of resource records that the modules can handle. Anax groups
RRs in the following ﬁve categories in order to clearly deﬁne the detection actions that
each detection module will enforce. These ﬁve categories are:
L[0] - Whitelisted RRs: This category is comprised of address records known to be
benign, based on our small CIDR-based whitelist.
L[1] - Misconﬁguration & “non-routable” IPs: This category is comprised of RRs
with IPs that should be considered as misconﬁgurations since they point to “non-
routable” address space. Although interesting, they are not useful for detecting
DNS poisoning and are counted as benign when calculating the ﬁnal detection rates.
L[2] - NXDomain rewriting & Proxies: This category contains two special cases of
A-type records. The ﬁrst category contains address records that are meant to pro-
duce NXDOMAIN answers according to our probing protocol but did not. Ad-
dresses from such NXDOMAIN rewriting services are of no interest as poison,
and are deemed benign. The second category is composed of address records from
ORDNS acting as DNS tunneling servers. There is no interest in further analyzing
these RRs as poison.
30
M. Antonakakis et al.
L[3] - Poisonous RRs: This category includes address records that reside in any of
the following public lists: do-not-route or peer list (28), dynamic IP address space
(PBL) (29), hosts reported to drop malware (XBL) (30) or engage in other mali-
cious activity (24). These RRs will cause the detection algorithm to exit while cre-
ating a poisoning alert. The reason why these records will be considered as cases
of poisoning attacks is that none of the domains present in our list of “domains
of interest” would ever internationally serve malware. Therefore, none of the IPs
present in their resource records should ever be in any of these lists.
L[4] - Unknown RRs: This category contains address records from which the CIDR
analysis module (deﬁned in Section 5.2) can make no immediate detection decision
based on the four previous categories. Finer grained analysis is needed for these
RRs. As we will describe in Section 5.3, this can be achieved by computing a six-
dimension statistical feature vector.
5.2 CIDR Analysis Module
Address records in RRs that fall into these ﬁve categories will initially be used by
the CIDR analysis to either create a poisoning report (category L[3]), claim that the
RR is not the subject of a poisoning attack (categories L[0]-L[2]) or forward any RR
that requires more expensive, ﬁne-grained analysis to the Anax 2-Class classiﬁer (cat-
egory L[4]). The CIDR analysis module receives RRs, such us google.com IN
74.125.67.104, with IP addresses from the monitored zones. Its goal is to make an
immediate detection decision about the address record. Based on the categories men-
tioned in Section 5.1, any IP address within the RR will reside in one of the ﬁve cate-
gories (L[0]-L[4]).
The primary motivation behind the use of this module is to reduce the overall false
positives and to eliminate unnecessary analysis of IPs that fall into the L[0]-L[3]