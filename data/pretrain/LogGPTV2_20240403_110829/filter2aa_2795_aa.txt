2015-­‐8  汪涛
¡
汪涛 of  BaiduX-­‐Team，ID  neobyte
¡
多年安全评估经验，涉及⽅方向较杂，web安全、java安全、android安
全、前端安全…
3
parseUri注入
PendingIntent误用
Action/Component/Data注入
Intent转换与复制
Intent注⼊入的概念
¡ Android提供的⼀一种java环境下IPC的形式。Intent是⼀一种
IPC消息对象，用于向APP的组件请求⼀一次操作
§ 发送与接收组件可能运⾏行在同⼀一个APP或不同的APP（进程）中
§ 请求的操作可以是启动⼀一个Activity，Service或处理Broadcast
§ Intent中通常有Action（⾏行动）或Component（目标组件名），系
统据此决定接收Intent的目标组件
§ Intent中还通常包含额外的数据（Extras，Data），供目标组件处
理
Action
Compo
Extras
Data
…
Intent
¡ Intent是安卓app的重要本地攻击界面：APP公开
组件接收外部Intent数据处理时可能存在安全漏洞
¡ 实例：
§
Webview JsInterface
§
SQL  injection
§
Path  Traversal
§
权限泄漏，⽹网络权限，读写短信的权限
Action
Compo
Extras
Data
…
Intent
目标
数据
¡
http://oasam.org/en/oasam/oasam-­‐dv-­‐data-­‐validation/oasam-­‐dv-­‐007-­‐
intent-­‐injection
¡
If  user’s  input  is  loaded  in  a  dynamic  manner  in  the  Intent  data,  a  
malicious  user  could  manipulate  such  data  in  order  to  execute  code  
through  it.  In  particular,  the  existence  of  dynamic  data  must  be  checked  
while  including  such  data  in  an  Intent,  especially  through  the  following  
Intent  methods:  addCategory(),  setAction(),  setClass(),  setClassName(),  
setComponent(),  setData()  and  setDataAndType().
App
Intent
startService
Activity
Service
Receiver
外部输⼊入
¡ 本地Intent注⼊入的风险
§ 本地权限提升
§ 访问私有组件等
¡ 场景
§ 某APP存在本地Intent注⼊入漏洞，因此注⼊入的
Intent可以攻击其敏感的私有组件
§ System权限的APP若存在Intent注⼊入漏洞，可以
绕过IPC权限，启动⼀一些敏感的组件，例如
launchAnyWhere,  BroadcastAnyWhere
¡ 远程Intent注⼊入的风险
§ 等同于有限的远程命令执⾏行
§ 本地暴露组件的漏洞可从远程攻击
¡ 场景
§ 来自⽹网页中的JS，可以发起intent，播打电话
§ 来自通信⽹网络中的短信，可以发起intent
Intent转换与复制
n构造intent的元素来自外部
nAction注⼊入
nComponent注⼊入
nData注⼊入
n泄漏pendingintent可能使其
他进程修改intent并以APP的
身份发出
n Intent.parseUri可解析String
为Intent，如果未进⾏行校验，
可能被攻击者篡改Intent
n完整接收intent后转发
nIntent代理
ngetParcelable()
nnew  Intent(intent)
Action/Compo/Data注⼊入
PendingIntent误用
parseUri注⼊入
• ⼀一个开源的java  bytecode 缺陷分析⼯工具
• 分析⼀一个目录下的所有class⽂文件
• 编译安卓4.4.4，得到所有中间过程的class⽂文件
（这样就⽆无需dex2jar），共约3万个class
11
parseUri注入
PendingIntent误用
Action/Component/Data注入
Intent转换与复制
Intent注入的概念
¡ 最早由申迪分析，AccountManager存在缺陷，恶意APP可
以发出任意intent来启动activity（绕过IPC权限限制）
（ http://blogs.360.cn/360mobile/2014/08/19/launchanywhere-­‐google-­‐bug-­‐
7699048/  ）
¡ 本质上就是⼀一个intent注⼊入
android.accounts.AccountManager$AmsTask$Response.onResult(Bundle)
¡ Intent本身可以传递数据。如果在intent中传递⼀一个intent，
往往代表需要用这个intent发起⼀一个新的IPCàintent注⼊入
¡ 为了寻找这种Intent转换的特征，可以看看Bytecode
android.accounts.AccountManager$AmsTask$Response.onResult(Bundle)
¡ 在findbugs中扫描所有Bytecode指令，如果是checkcast，
进⼀一步检查是否是cast为intent类型
¡ 对Android  4.4全系统扫描后发现106例Intent的checkcast，
根据是否在同⽅方法中发送了该intent调整优先级，结果第
⼀一个就是launchAnywhere漏洞，另外还发现⼀一个0day…
¡
ChooserActivity存在Intent注⼊入漏洞，恶意⽆无权限APP可以System权限
启动任意Activity（类似launchAnywhere）
¡
安卓Framework层有⼀一个导出的Activity组件：ChooserActivity
com.android.internal.app.ChooserActivity (4.4.4版截图）
¡
启动该activity会从输⼊入intent中读取EXTRA_INTENT与
EXTRA_INITIAL_INTENTS，分别是⼀一个intent以及⼀一个intent数组，然
后传递给super.onCreate
¡
super类为com.android.internal.app.ResolverActivity，将启动用户选择
的intent
¡
2012年（4.1）的⼀一个补丁中增加了对是否有权限启动
EXTRA_INTENT的检查，但依然遗漏了对EXTRA_INITIAL_INTENTS的
检查，所以可以利用EXTRA_INITIAL_INTENTS来launchAnywhere
¡
https://android.googlesource.com/platform/frameworks/base/+/5320eb8
938098c9824093f7f842a0a97bbc190a4%5E%21/#F4
Whether  an  instance  of  the  activity  can  be  launched  into  the  process  of  the  
component  that  started  it -­‐ "true"  if  it  can  be,  and  "false"  if  not.  The  default  value  
is  "false“.  Normally,  a  new  instance  of  an  activity  is  launched  into  the  process  of  
the  application  that  defined  it
¡ 但当我们去launch时，发现权限错误…
¡
http://developer.android.com/guide/topics/manifest/activity-­‐
element.html#multi
¡
com.android.server.am.ActivityRecord
¡
com.android.server.am.PendingIntentRecord
¡
com.android.server.am.ActivityManagerService
¡
com.android.server.am.ActivityStackSupervisor
¡
com.android.server.am.ActivityStackSupervisor
¡ 通过pendingintent，ChooserActivity将在
system进程启动并launch我们的intent
¡ 因为是system进程，可以
启动需要权限的Activity，
或者是私有的Activity
¡ Demo演示弹出两个图标
让用户选择，如果选择了
⼿手机，将开始拨打电话
¡
2014-­‐09-­‐15报告给Android，但是…
¡
补丁 com.android.internal.app.ResolverActivity，startActivityAsCaller
¡
Fix  issue  #14617210:  Apps  can  gain  access  to  any  ContentProvider with  
grantUriPermissions(no  user  interaction  required)    
https://android.googlesource.com/platform/frameworks/base/+/028ceeb
472801bcfa5844fc89ed0da8463098824
Thanks  for  the  report.  This  issue  was  previously  reported  to  us  by  another  
researcher.  We're  testing  a  fix  for  the  next  release  of  Android.
We  ask  that  you  keep  this  issue  confidential  until  our  fix  is  released.
¡
https://android.googlesource.com/platform/frameworks/base/+/android-­‐
5.1.1_r8/packages/Shell/src/com/android/shell/BugreportWarningActivity.java
¡
https://android.googlesource.com/platform/packages/apps/Camera2/+/android-­‐
5.1.1_r8/src/com/android/camera/ProxyLauncher.java
¡
https://android.googlesource.com/platform/packages/apps/Settings/+/android-­‐
5.1.1_r8/src/com/android/settings/users/AppRestrictionsFragment.java
¡
https://android.googlesource.com/platform/packages/apps/Browser/+/android-­‐
5.1.1_r8/src/com/android/browser/widget/BookmarkWidgetProxy.java
31
parseUri注入
PendingIntent误用
Action/Component/Data注⼊入
Intent转换与复制
Intent注入的概念