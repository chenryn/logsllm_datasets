# 大规模互联网扫描

## 摘要
本文档将介绍大规模互联网扫描的技巧、方法及其结果。我们将从防御和攻击两个角度探讨为何需要进行互联网扫描，并讨论扫描过程中的物理基础设施要求、ISP计费方式以及如何处理滥用投诉等问题。

## 作者
- Robert Graham
- Paul McMillan
- Dan Tentler

## 扫描范围
- **0.0.0.0/0** (整个互联网)

## 为什么扫描互联网（防御角度）
1. **漏洞检测**
   - 心脏出血（Heartbleed）：有多少系统易受心脏出血漏洞影响？
   - NTP放大攻击：有多少系统可以被用于NTP放大攻击？
   - D-Link路由器漏洞：有多少系统易受D-Link路由器漏洞影响？
2. **SSL证书调查**
   - 调查所有正在使用的SSL证书情况

## 为什么扫描互联网（攻击角度）
1. **探索未知领域**
   - 网络深网（Deepnet）：通过随机端口和masscan工具的“--banners”选项，几分钟内即可发现可被利用的目标。
2. **提高知名度**
   - 选择一个目标（例如西门子控制系统），扫描整个互联网找到该设备，然后在BlackHat大会上做演讲并登上新闻头条。

## 物理基础设施理论
- **数据包开销**
  - 以太网数据包有44字节的开销。
  - TCP SYN数据包为40字节。
- **1Gbps以太网的最大速率**
  - 实际流量速率为476Mbps。
  - 以太网开销速率为524Mbps。
  - 每秒最多传输1,488,000个数据包。
  - 参考：[http://blog.erratasec.com/2013/10/whats-max-speed-on-ethernet.html](http://blog.erratasec.com/2013/10/whats-max-speed-on-ethernet.html)

## ISP计费
- **不同ISP的计费方式**
  - 有些ISP按照以太网速率收费，收取全额1Gbps费用。
  - 有些ISP按照WAN速率收费，大约收取600Mbps费用。
  - 有些ISP无法识别小数据包。
  - 有些ISP不计量流量，这是非常理想的。

## 实际物理基础设施
- **VPS压力**
  - VPS可能因大量小数据包而负载过重。
- **以太网交换机性能**
  - 以太网交换机处理小数据包时可能会遇到困难，通常超过500,000pps就很难处理。
  - 关闭流控制功能可能有所帮助。
- **丢包问题**
  - 发送500,000pps并不意味着所有数据包都能到达互联网。
- **推荐速率**
  - 通常使用约150,000pps的速率，当对速度没有特别要求时。

## 滥用投诉
- **投诉不可避免**
  - 你将收到滥用投诉。
  - 你的ISP也会因此感到不满。
- **不同类型的影响**
  - 心脏出血扫描会在几周后生成投诉。
  - HTTP扫描会让你被列入fail2ban列表。
  - Snort/emergingthreat规则会生成大量投诉。
- **ISP应对措施**
  - 一些网络会通过黑洞化整个自治系统来应对。
  - 国防部对此反应尤为强烈。

## 维护排除列表
- **配置文件**
  - `/etc/masscan/masscan.conf`
  - `exclude = 224.0.0.0/255.255.255.255`
  - `exclude-file = exclude.ips`

## 投诉者的行为
- **恶意投诉**
  - “我要向互联网警察举报你。”
  - “我们在防火墙上屏蔽了你，哼！”
- **无知投诉**
  - “Woori金融集团的基础设施被列为‘国家重要设施A类’，未经授权访问是严格禁止的。”

## 与ISP保持友好关系
- **紧密合作**
  - 我们与ISP密切合作，提供免费网络安全咨询服务。
  - 自行处理滥用投诉。
  - 使用SWIP（共享WHOIS项目）。
  - 将所有请求者添加到“排除”或“黑名单”文件中。

## 匿名VPS
- **匿名方式**
  - 用比特币支付廉价VPS提供商。
  - 在投诉导致账户关闭之前完成扫描。
  - 许多VPS提供商本身就是垃圾邮件和诈骗者的友好平台。

## masscan工具
- **类似nmap**
  - 解析所有nmap选项。
  - 输出格式接近nmap，可以导入其他工具。
  - 支持许多功能，如SCTP扫描、UDP nmap有效载荷。
- **不同于nmap**
  - 按端口而非按主机进行扫描。
  - 异步处理，发送线程和接收线程分别处理请求和响应。
  - 速度比nmap快1000倍。
- **独立TCP/IP栈**
  - masscan有自己的TCP/IP栈，与现有栈并行运行。
  - 默认使用相同地址，可能导致重复ARP和TCP RST。
  - 建议使用不同的IP地址或过滤端口范围以避免这些问题。

## 标签检查
- **建立TCP连接**
  - 启动TCP连接，通过启发式方法识别协议。
  - 目前支持的功能有限，未来可能支持NSE风格脚本。

## 多源扫描
- **多机器扫描**
  - `--shard 1/50`：用于多台机器执行相同扫描。
- **多IP地址扫描**
  - `--source-ip 10.0.0.32-10.0.0.63`：从同一台机器的不同IP地址分散扫描。
  - `--source-ip 0.0.0.0-255.255.255.255`：用于恶搞。

## 负载测试
- **防火墙崩溃**
  - 这种扫描会导致防火墙崩溃。
  - 非常适合防火墙负载测试。
  - `--infinite --banners --source-ip`：维持大量开放连接。

## 二进制格式
- **输出格式**
  - 使用`--output-binary foo.scan`代替`--output-xml foo.xml`。
  - 之后转换：`masscan --readscan foo.scan --output-xml foo.xml`。
  - 优点：更紧凑，便于修复输出错误。

## 伪装扫描
- **接收和发送分离**
  - 在一个IP地址上接收数据（如一次性Android手机）。
  - 从数据中心发送数据，不进行出口过滤。
  - `--source-ip`伪装成另一个源地址。

## 扫描结果
- **VNC扫描**
  - 结果未详述。
- **心脏出血**
  - 4月10日，约60万台系统易受心脏出血漏洞影响。
  - 7月，仍有约30万台系统存在漏洞，主要是各种设备。
- **安全：这个词你一直在用**
  - 有些人认为这些只是蜜罐。
- **大型机扫描**
  - TN3270 Telnet-over-SSL端口992。
  - 查看@mainframed767获取IBM大型机登录屏幕的酷图。

希望这份文档能帮助您更好地理解大规模互联网扫描的相关知识和技术。