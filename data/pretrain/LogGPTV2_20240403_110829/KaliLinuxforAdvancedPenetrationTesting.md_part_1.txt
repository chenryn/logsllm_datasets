Mastering Kali Linux for
Advanced Penetration Testing
A practical guide to testing your network's security with
Kali Linux, the preferred choice of penetration testers
and hackers
Robert W. Beggs
BIRMINGHAM - MUMBAI
Mastering Kali Linux for Advanced Penetration Testing
Copyright © 2014 Packt Publishing
All rights reserved. No part of this book may be reproduced, stored in a retrieval
system, or transmitted in any form or by any means, without the prior written
permission of the publisher, except in the case of brief quotations embedded in
critical articles or reviews.
Every effort has been made in the preparation of this book to ensure the accuracy
of the information presented. However, the information contained in this book is
sold without warranty, either express or implied. Neither the author, nor Packt
Publishing, and its dealers and distributors will be held liable for any damages
caused or alleged to be caused directly or indirectly by this book.
Packt Publishing has endeavored to provide trademark information about all of the
companies and products mentioned in this book by the appropriate use of capitals.
However, Packt Publishing cannot guarantee the accuracy of this information.
First published: June 2014
Production reference: 1160614
Published by Packt Publishing Ltd.
Livery Place
35 Livery Street
Birmingham B3 2PB, UK.
ISBN 978-1-78216-312-1
www.packtpub.com
Cover image by Robert W. Beggs (PI:EMAIL)
Credits
Author Copy Editors
Robert W. Beggs Tanvi Gaitonde
Dipti Kapadia
Reviewers Insiya Morbiwala
Terry P. Cutler Kirti Pai
Danang Heriyadi Alfida Paiva
Tajinder Singh Kalsi Stuti Srivastava
Amit Pandurang Karpe
Proofreaders
Ashish Pandurang Karpe
Simran Bhogal
Kunal Sehgal
Mario Cecere
Joel Johnson
Acquisition Editor
James Jones
Indexers
Hemangini Bari
Content Development Editor
Monica Ajmera Mehta
Amey Varangaonkar
Graphics
Technical Editors
Ronak Dhruv
Pragnesh Bilimoria
Mrunal Chavan
Production Coordinators
Aparna Kumar
Pooja Chiplunkar
Pooja Nair
Manu Joseph
Project Coordinator
Cover Work
Akash Poojary
Pooja Chiplunkar
About the Author
Robert W. Beggs is the founder and CEO of Digital Defence, a company
that specializes in preventing and responding to information security incidents.
He has more than 15 years of experience in the technical leadership of security
engagements, including penetration testing of wired and wireless networks,
incident response, and data forensics.
Robert is a strong evangelist of security and is a cofounder of Toronto Area Security
Klatch, the largest known vendor-independent security user group in North America.
He is a member on the advisory board of the SecTor Security Conference as well as
on several academic security programs. He is an enthusiastic security trainer and
has taught graduates, undergraduates, and continuing education students courses
in information security at several Canadian universities.
Robert holds an MBA in Science and Technology from Queen's University and is
a Certified Information Systems Security Professional.
Firstly, and perhaps most importantly, I would like to thank the
developers and supporters of Kali Linux. Together, they have
produced one of the most significant tools for securing networks
and data. I would like to thank the editors and reviewers at Packt
Publishing for their support and seemingly unending patience during
the writing of this book. I promise that the next one will go quicker!
I would also like to thank Brian Bourne and other members of
the Toronto Area Security Klatch. They've given me an incredible
opportunity to learn and share knowledge with the best-ever
community of security geeks.
Throughout the writing of this book, my family has given me both
incredible motivation and support. Thank you Sarah, Alex, and Annika.
And finally, a very special thank you to my mother and father—I can't
remember when I first learned to read—with your encouragement, it
was always just natural to have a book in my hands.
Thank you.
About the Reviewers
Terry P. Cutler is a cyber security expert (a certified ethical hacker) and the
cofounder and chief technology officer of IT security and data defense firm, Digital
Locksmiths Inc. in Montréal, Canada. They protect small businesses, large agencies,
families, and individuals from cyber criminals who victimize an estimated 1.5
million people a day (600,000 on Facebook alone).
He specializes in anticipation, assessment, and prevention of security breaches for
governments, corporations, businesses, and consumers. Having been a certified
ethical hacker, among other things since 2005, he had an opportunity to present in
front of a live audience of 2,500 people and with tens of thousands across the world,
on live and recorded streaming, how a hacker could break into almost any company
with a fake LinkedIn request. You can view this video on his YouTube channel.
Terry has been delivering Internet safety for children, parents, and law
enforcement since 2006. He believes that prevention, street proofing, and
parent-child communication are the most effective ways to prevent a child from
being abducted or falling victim to aggression and exploitation. Giving children
the knowledge and practical skills they need to look after themselves is as
important as teaching them to read and write. You can find out more on this at
http://www.TheCourseOnInternetSafety.com.
He is a frequent contributor to media reportage about cybercrime, spying, security
failures, Internet scams, and the real social network dangers that families and
individuals face every day. He is acknowledged as a transformational leader,
problem solver, and trusted advisor with a genuine talent for fostering positive
and collaborative working relationships at all organizational levels.
Before leaving his job in 2011 to concentrate full time on Digital Locksmiths, Terry
worked for a software giant, Novell. He joined this global software corporation
that specializes in enterprise operating systems and identity, security, and systems
management solutions to provide engineering support to the company's premium
service customers consisting of up to 45,000 users and 600 servers all across the world.
I'd like to take a moment to thank Robert W. Beggs for generously
taking me under his wing as a mentor back in 2004 and guiding
me through the processes and pitfalls of working in this industry.
Now that I've matured as an industry specialist, I'm honored to be
able to share some of my own learning and experiences with Rob
and with his readers.
A very special thanks to my family, my wife, Franca, and our sons,
David and Matthew, for their support, encouragement, patience,
hugs, and unconditional love over the last few years.
Danang Heriyadi is an Indonesian computer security researcher, specialized
in reverse engineering and software exploitation with more than five years of
hands-on experience.
He is currently working at Hatsecure as an instructor for Advanced Exploit and
Shellcode Development. As a researcher, he loves to share IT security knowledge
through his blog at Fuzzerbyte (http://www.fuzzerbyte.com).
I would like to thank my parents for giving me life; without them,
I wouldn't be here today; my girlfriend, for supporting me every
day with her smile and love; and my friends, whom I have no words
to describe.
Tajinder Singh Kalsi is the cofounder and a technical evangelist at Virscent
Technologies Pvt. Ltd., with more than six years of working experience in the field
of IT. He commenced his career with Wipro as a technical associate and later became
an IT consultant and trainer. As of now, he conducts seminars in colleges across
India on topics such as information security, Android application development,
website development, and cloud computing. At this point, he has covered more than
120 colleges and more than 9,000 students. Apart from imparting training, he also
maintains a blog (www.virscent.com/blog), which explains various hacking tricks.
He has earlier reviewed Web Penetration Testing with Kali Linux, Joseph Muniz and
Aamir Lakhani, Packt Publishing.
He can be found on Facebook at www.facebook.com/tajinder.kalsi.tj or you
can follow him on his website at www.tajinderkalsi.com.
I would like to thank the team of Packt Publishing for approaching
me through my blog and offering me this opportunity again. I would
also like to thank my family and close friends for all the support they
have given while I was working on this project.
Amit Pandurang Karpe works for FireEye, Inc., a global information security
company, as a support engineer supporting their Asia Pacific customers. He stays
in Singapore with his wife, Swatee, and son, Sparsh. He has been active in the open
source community from his college days, especially in Pune, where he was able to
organize various activities with the help of vibrant and thriving communities, such
as PLUG, TechPune, IT-Milan, and Embedded Nirvana. He writes blog posts about
technologies at http://www.amitkarpe.com.
He has worked on Rapid BeagleBoard Prototyping with MATLAB and Simulink,
Dr. Xuewu Dai and Dr. Fei Qin, Packt Publishing. Currently, he is working on Building
Virtual Pentesting Labs for Advanced Penetration Testing, Kevin Cardwell and Kali Linux
CTF Blueprints, Cam Buchanan, both by Packt Publishing.
I would like to thank the open source community, without whom
I couldn't have succeeded. A special thanks to the visionaries behind
Kali Linux, who believed in open source and led by providing
various examples. Also, many thanks to the community members
and information security experts, who keep doing a great job, which
makes Kali Linux a success.
I would like to thank the Packt Publishing team, editors, and the
project coordinator, who kept doing the right things so that I was
able to perform my job to the best of my abilities.
I would like to thank Pune Linux Users Group (PLUG), Embedded
Nirvana group, and VSS friends, because of whom I was able to
work on this project. I would also like to thank all my gurus, who
helped me and guided me in this field—Dr. Vijay Gokhale, Sunil
Dhadve, Sudhanwa Jogalekar, Bharathi Subramanian, Mohammed
Khasim, and Niyam Bhushan.
Finally, I would like to thank my family, my mother, my father, my
brother, my son, and my wife, Swatee, without whose continuous
support I could not have given my best efforts to this project.
Ashish Pandurang Karpe works as a system support associate with
CompuCom-CSI Systems India Pvt. Ltd. He has been active in the open source
community from his college days, where he was able to organize various activities
with the help of vibrant and thriving communities such as PLUG and VITLUG.
I would first like to thank the open source community, without
whose help, I wouldn't have been able to be here. I would like to
thank my family, that is, Anuradha (mother), Pandurang (father),
Sparsh (nephew), Amit (brother), and Swatee (sister-in-law). I
would like to thank the Packt Publishing team, editors, and project
coordinator who kept on doing the right things so that I was able to
perform my job to the best of my abilities.
I would like thank Pune GNU/Linux Users Group (PLUG). I would
also like to thank my guru, who helped me and guided me in this
field—Dr. Vijay Gokhale.
Kunal Sehgal has been a part of the IT security industry since 2006 after
specializing in Cyberspace security from Georgian College, Canada. He has been
associated with various financial organizations. This has not only equipped him with
an experience at a place where security is crucial, but it has also provided him with
valuable expertise in this field. He can be reached at KunSeh.com.
Kunal currently heads IT security operations for the APAC region of one of the
largest European banks. He has accumulated experience in diverse functions,
ranging from vulnerability assessment to security governance and from risk
assessment to security monitoring. A believer of keeping himself updated with the
latest happenings in his field, he contributes to books, holds workshops, and writes
blogs, all to promote security. He also holds a number of certifications to his name,
including Backtrack's very own OSCP, and others such as CISSP, TCNA, CISM,
CCSK, Security+, Cisco Router Security, ISO 27001 LA, and ITIL.
I am a big supporter of the Backtrack project (now Kali), and first
and foremost, I would like to thank their core team. Most specifically,
I thank muts; without his training and personal attention, I may not
have been able to get hooked to it. On the personal front, I thank
my loving family (parents, brother, and wife) for their never-ending
support and belief in me. I have neglected them, more than I like to
admit, just to spend time in the cyber world.
www.PacktPub.com
Support files, eBooks, discount offers,
and more
You might want to visit www.PacktPub.com for support files and downloads related to
your book.
Did you know that Packt offers eBook versions of every book published, with PDF and
ePub files available? You can upgrade to the eBook version at www.PacktPub.com and
as a print book customer, you are entitled to a discount on the eBook copy. Get in touch
with us at PI:EMAIL for more details.
At www.PacktPub.com, you can also read a collection of free technical articles, sign up
for a range of free newsletters and receive exclusive discounts and offers on Packt books
and eBooks.
TM
http://PacktLib.PacktPub.com
Do you need instant solutions to your IT questions? PacktLib is Packt's online digital
book library. Here, you can access, read and search across Packt's entire library of books.
Why subscribe?
• Fully searchable across every book published by Packt
• Copy and paste, print and bookmark content
• On demand and accessible via web browser
Free access for Packt account holders
If you have an account with Packt at www.PacktPub.com, you can use this to access
PacktLib today and view nine entirely free books. Simply use your login credentials for
immediate access.
Table of Contents
Preface 1
Part 1: The Attacker's Kill Chain
Chapter 1: Starting with Kali Linux 15
Kali Linux 15
Configuring network services and secure communications 18
Adjusting network proxy settings 20
Securing communications with Secure Shell 21
Updating Kali Linux 23
The Debian package management system 23
Packages and repositories 23
Dpkg 24
Using Advanced Packaging Tools 24
Configuring and customizing Kali Linux 25
Resetting the root password 26
Adding a non-root user 26
Speeding up Kali operations 26
Sharing folders with Microsoft Windows 28
Creating an encrypted folder with TrueCrypt 30
Managing third-party applications 35
Installing third-party applications 35
Running third-party applications with non-root privileges 37
Effective management of penetration tests 38
Summary 40
Table of Contents
Chapter 2: Identifying the Target – Passive Reconnaissance 43
Basic principles of reconnaissance 44
Open Source intelligence 45
DNS reconnaissance and route mapping 47
WHOIS 48
DNS reconnaissance 50
IPv4 51
IPv6 53
Mapping the route to the target 54
Obtaining user information 57
Gathering names and e-mail addresses 58
Profiling users for password lists 61
Summary 63
Chapter 3: Active Reconnaissance and Vulnerability Scanning 65
Stealth scanning strategies 66
Adjusting source IP stack and tool identification settings 66
Modifying packet parameters 68
Using proxies with anonymity networks (Tor and Privoxy) 69
Identifying the network infrastructure 73
Enumerating hosts 75
Live host discovery 75
Port, operating system, and service discovery 76
Port scanning 76
Fingerprinting the operating system 77
Determining active services 79
Employing comprehensive reconnaissance applications 80
nmap 81
The recon-ng framework 82
Maltego 85
Vulnerability scanning 88
Summary 89
Chapter 4: Exploit 91
Threat modeling 92
Using online and local vulnerability resources 93
The Metasploit Framework 98
Exploiting a vulnerable application 103
Exploiting multiple targets with Armitage 105
Team testing with Armitage 107
Scripting the Armitage attack 108
Bypassing IDs and antivirus detection 110
Summary 118
[ ii ]
Table of Contents
Chapter 5: Post Exploit – Action on the Objective 119
Bypassing Windows User Account Control 120
Conducting a rapid reconnaissance of a compromised system 122
Using the WMIC scripting language 125
Finding and taking sensitive data – pillaging the target 129
Creating additional accounts 133
Using Metasploit for post-exploit activities 134