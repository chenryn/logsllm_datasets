你也配用计划任务？
高级攻防实验室 老草
前言
标题微软雅黑20号字
01
PART
前言
• 这是一篇老草的自我反思
• 核心技术点：TaskScheduler(Windows)
• 关联知识点：RPC/IDL/COM/UAC/横向移动/武器化
• 请勿对号入座
你也配用计划任务API？
标题微软雅黑20号字
02
PART
你也配用计划任务API？
• 正常的计划任务用法
• 抄自msdn
• 按顺序十个以上必要调用
你也配用计划任务API？
• 本质呢？
你也配用计划任务API？
• 抓个包？
你也配用计划任务API？
• 理论依据呢？
• MS-TSCH
你也配用计划任务API？
• 披着COM/DCOM皮的纯RPC
• 本地对象/帮助类： ITaskService/ITaskFolder/IAction/ITrigger
• 底层协议：SchRpc
•
看到及用到的都是假的
你也配用计划任务API？
• COM简单用法
你也配用计划任务API？
• 原生RPC
你也配用计划任务API？
•
事情的本质就是这么简单
•
那你之前都做了啥？
•
天天用impacket，就是不去看源码
你也配过UAC？
标题微软雅黑20号字
03
PART
你也配过UAC？
• 思考：为什么微软引入计划任务COM对象？
• RPC：函数约定式调用（C）
• COM：面向对象（C++）
你也配过UAC？
• COM基础
• CLSID
你也配过UAC？
• COM基础
• 代理模式
你也配过UAC？
• 哪里还有计划任务？
你也配过UAC？
• 如何调用？
COM Proxy Object
你也配过UAC？
• From Elevated COM Proxy To UAC Bypass …… 
你也配过UAC？
• …And Get SYSTEM Directly ! 
你也配玩横向移动？
标题微软雅黑20号字
04
PART
你也配玩横向移动？
•
2202年了，横移回显还要目标共享
• 除了文件/注册表，有没有更直接的方式？
你也配玩横向移动？
•
天天反序列化Gadget，就不会举一反三
• 创建远程计划任务：执行命令
• PowerShell/VBS/CSC：操作本地计划任务
• 本地客户端：查询任务信息，获取回显
你也配玩横向移动？
•
计划任务协议通信/RPC端口复用（伪）
你也配玩横向移动？
•
计划任务协议通信/RPC端口复用（伪）
你也配玩横向移动？
•
原生通信加密
你也配玩横向移动？
•
白名单进程链/无上下文
你也配做武器化？
标题微软雅黑20号字
05
PART
你也配做武器化？
•
脱离实战照本宣科抄代码做“武器”
你也配做武器化？
• 优化XML
你也配做武器化？
• RPC流量加密了吗？
你也配做武器化？
• 还在用vs生成的Interop?
• MSDN COM Interop
• C++虚函数表
你也配做武器化？
• 举一反三？
• 结合Part3/Part4，进行UAC回显
配钥匙吗？
标题微软雅黑20号字
06
PART
配钥匙吗？
• 我们真的达到“武器化”标准了吗？
• 我们真的吃透每一个技术细节了吗？
• “传统”的技术真的无需研究了吗？
配钥匙吗？
• Windows没研究明白，就开始看不起COM/RPC
•
能分清COM和RPC吗？
•
能分清协议层的DCOM和RPC吗？
•
能分清进程外COM对象、远程DCOM与COM外部代理模式吗？
配钥匙吗？
• 天天搞语言之争
•
你是专业开发吗？
•
leetcode hard刷全了吗？
•
二十几种设计模式用对了吗？
配钥匙吗？
• 天天追热点炒冷饭
•
我复现===我会了？
•
官方文档看过了吗？
•
文档写明的特性研究了吗？
配钥匙吗？
• 还在跪舔洋大人
•
你家洋大人是这么写的
配钥匙吗？
• 还在跪舔洋大人
•
你家洋大人每个技术都有配套的检测方式/Yara规则甚至防御方案
•
但是你没看
•
你还在抄代码
配钥匙吗？
• 还在跪舔洋大人
•
你家洋大人甚至背后站着白头鹰
•
技术没国界，你有国籍
总结
标题微软雅黑20号字
07
PART
THANKS！