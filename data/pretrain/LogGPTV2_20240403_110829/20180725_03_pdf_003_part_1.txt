Please write title, subtitle
and speaker name in all
capital letters
Patroni
HA PostgreSQL
made easy
PostgresConf US
Alexander Kukushkin
Oleksii Kliukin
Zalando SE
16-04-2018
Put images in the grey
dotted box "unsupported
Agenda placeholder"
Please write the title in all
capital letters
Architecture overview
Hands on: your first test cluster
Dynamic cluster configuration
REST endpoints and monitoring
Client connections
Advanced features
Custom extensions
Troubleshooting
2
Please write the title in all
capital letters
PostgreSQL High Availability
● Shared storage solutions
○ DRDB + LVM
● Trigger-based and logical replication
○ pglogical, bucardo, slony, londiste, built-in logical
replication in PostgreSQL 10
● Built-in physical single master replication
○ Starting from PostgreSQL 9.0
● Multi-master replication
○ BDR, bucardo
3
Please write the title in all
capital letters
Physical single-master replication
Cons
Primary
● No partial replication
● Major versions much match wal
● Missing automatic failover
Pros Standby Standby
● Built-in since Postgres 9.0
wal wal
● Minimal overhead
● Replicates everything
● Cascading replication Cascade
● Synchronous replication
● Takes advantage of streaming and
wal
WAL shipping
4
Please write the title in all
Automatic failover done wrong:
capital letters
Running just two nodes
Run the health check from the standby and promote that
standby when the health check indicates the primary failure
health check
Primary Standby
wal stream
wal wal
5
Please write the title in all
Automatic failover done wrong:
capital letters
running just two nodes
Split-brain!
Primary Primary
wal wal
6
Please write the title in all
Automatic failover done wrong:
capital letters
Single witness node
What can possibly
go wrong?
Primary Standby
wal stream
wal wal
health c h e c k
check h e a l t h
witness
7
Please write the title in all
Automatic failover done wrong:
capital letters
Single witness node
Witness node dies
Primary Standby
wal stream
wal wal
health c h e c k
check h e a l t h
witness
8
Please write the title in all
Automatic failover done wrong:
capital letters
Single witness node
Or gets partitioned
Primary Standby
wal stream
wal wal
health c h e c k
check h e a l t h
witness
9
Please write the title in all
Automatic failover done wrong:
capital letters
Single witness node
Existing primary is running
Primary Primary
wal wal
c h e c k
h e a l t h
witness
10
Please write the title in all
Automatic failover done right
capital letters
Standby
Primary
wal wal
?
d
I e
g
a n
a
m t h e a d e r c h
l e
e L
a
d
er
Quorum
11
Please write the title in all
capital letters
Automatic failover: the right way
● Leader elections among all members of the cluster
● Each member decides only for itself
● Cluster state stored in a consistent distributed storage
● Leader key changed via atomic CAS operations
● Client follow the new leader
● Fencing of non-cooperative or failed nodes
12
Please write the title in all
capital letters
Bot pattern
● PostgreSQL cannot talk to Etcd directly
● Let’s employ a bot to manage PostgreSQL
● A bot should run alongside PostgreSQL
● A bot will talk to Etcd (or other DCS)
● A bot decides on promotion/demotion
13
Please write the title in all
Bot pattern: master acknowledges its
capital letters
presence
NODE A
Primary
U
P
D
pr A
T
e E(“/l
v
V
al e
u a
e d
=” A”)er”,
“
A”,
S
u ttl
c
c =
e s s 3 0,
NODE B
Standby
WATCH (/leader)
/leader: “A”, ttl: 30
( / l e a d e r )
H
C
T
A
NODE C W
Standby
14
Please write the title in all
capital letters
Bot pattern: master dies, leader key holds
NODE A
Primary
NODE B
Standby
WATCH (/leader)
/leader: “A”, ttl: 17
( / l e a d e r )
H
C
T
A
NODE C W
Standby
15
Please write the title in all
capital letters
Bot pattern: leader key expires
Standby
Notify (/leader,
expired=true)
/leader: “A”, ttl: 0
NODE B
e( d/ l =e a d ue er ,
NODE C N eo xt pi f iy t r )
Standby
r
16
Please write the title in all
capital letters
Bot pattern: who will be the next master?
Node B:
GET A:8008/patroni -> timeout
GET C:8008/patroni -> wal_position: 100
Standby
NODE B
NODE C
Standby
Node C:
GET A:8008/patroni -> timeout
GET C:8008/patroni -> wal_position: 100
17
Please write the title in all
capital letters
Bot pattern: leader race among equals
FAIL
Standby
C tR =E 3A ,T pE e( “ v/ El e xa i d s te sr =” , F “ aB l s” , e )
/leader: “C”, ttl: 30
r
0
t l
NODE B
SUCCESS
C ” ,
“
Standby e( “ v/ l Ee xa id e sr =” , F a l s e )
E
A T s t
E
R
C
p r
0 ,
3
=
t t l
NODE C
18
Please write the title in all
Bot pattern: promote and continue
capital letters
replication
Standby
W A T C H ( / l e a d e r )
/leader: “C”, ttl: 30
NODE B
Primary
promote
NODE C
19
Please write the title in all
capital letters
Etcd consistency store
● Distributed key-value store
● Implements RAFT
● Needs more than 2 nodes (optimal: odd number)
http://thesecretlivesofdata.com/raft/
20
Please write the title in all
capital letters
Patroni
● Patroni implements bot pattern in Python
● Official successor of Compose Governor
● Developed in the open by Zalando and volunteers all
over the world
https://github.com/zalando/patroni
21
Put images in the grey
dotted box "unsupported
placeholder" - behind the
orange box (left side
stays white)
Write the quote in all
capital letters
Your First
Patroni cluster
Your first Patroni cluster
22
Please write the title in all
capital letters
Using docker
● install docker
● docker pull kliukin/patroni-training
● docker run -d --name patroni-training kliukin/patroni-training
● docker exec -ti patroni-training bash
postgres@f40a9391f810:~$ ls *.yml
postgres0.yml postgres1.yml postgres2.yml
23
Please write the title in all
capital letters
(Optional) using vagrant
● install vagrant
● get the vagrantfile from
https://github.com/alexeyklyukin/patroni-training
● vagrant up
● vagrant ssh
ubuntu@ubuntu-xenial:~$ sudo -iu postgres
postgres@ubuntu-xenial:~$ ls *.yml
postgres0.yml postgres1.yml postgres2.yml
24
Please write the title in all
Hands on: creating your first cluster with
capital letters
Patroni
$ patroni postgres0.yml $ patroni postgres1.yml
2018-01-18 13:29:06,714 INFO: Selected new 2018-01-18 13:45:02,479 INFO: Selected new
etcd server http://127.0.0.1:2379 etcd server http://127.0.0.1:2379
2018-01-18 13:29:06,731 INFO: Lock owner: 2018-01-18 13:45:02,488 INFO: Lock owner:
None; I am postgresql0 postgresql0; I am postgresql1
2018-01-18 13:29:06,796 INFO: trying to 2018-01-18 13:45:02,499 INFO: trying to
bootstrap a new cluster bootstrap from leader 'postgresql0'
… 2018-01-18 13:45:04,470 INFO: replica has
Success. You can now start the database been created using basebackup
server using: 2018-01-18 13:45:04,474 INFO: bootstrapped
/usr/local/pgsql/bin/pg_ctl -D from leader 'postgresql0'
data/postgresql0 -l logfile start 2018-01-18 13:45:07,211 INFO: Lock owner: