**译者：** zzzhhh  
**首发平台：** 先知社区

本文由[SEC Consult Vulnerability Lab](https://www.sec-consult.com/en/vulnerability-lab/)的Rene Freingruber ([@ReneFreingruber](https://twitter.com/ReneFreingruber))撰写，分享了他在过去几年中从各种博客文章中收集或自己发现的一些文件系统技巧。这些技巧虽然不能直接被利用，但在某些特定情况下可能会间接导致可被攻击者利用的安全漏洞。

请注意，本文仅提供关于如何利用这些问题及其影响的信息，并未深入探讨Windows API的技术细节，因为这超出了本文的范围。

## 技巧1: 创建无权限文件夹 (CVE-2018-1036/NTFS EOP)

在Windows上，可以为文件夹分配“特殊权限”，例如允许用户在文件夹中创建文件但不允许创建文件夹。一个典型的例子是`C:\Windows\Tasks\`，用户可以在其中创建文件，但不允许创建文件夹。

管理员或程序可能会配置这样的权限，并假设用户无法在此文件夹中创建子文件夹。然而，通过在文件名末尾添加`::$INDEX_ALLOCATION`，用户可以绕过这一限制，成功创建文件夹。目前，Windows并未对此情况进行检查。

**示例：**
- **图1**: 在Windows 10中尝试创建文件夹。
- **图2**: 成功创建`test`文件夹。

如果应用程序只允许删除文件，`::$INDEX_ALLOCATION`技巧也可用于删除文件夹。使用以下命令即可删除文件夹：
```cmd
rd test::$INDEX_ALLOCATION
```

**微软漏洞联系时间表：**
- 2018年3月1日：通过PI:EMAIL进行初步联系，发送PGP加密的博客帖子。
- 2018年3月1日：Microsoft分配了MSRC Case 43968 CRM：0461039882。
- 2018年3月5日：微软要求延长披露期限。
- 2018年3月5日：同意延长90天的截止日期。
- 2018年3月27日：询问微软是否可以重现漏洞以及何时可以获得补丁。
- 2018年3月28日：微软确认“技巧1”漏洞已成功重现并分配编号CVE-2018-1036。该漏洞将在5B（5月补丁星期二）修复。
- 2018年4月27日：微软与我们联系，提议的修复方案导致回退。微软请求将修补的最后期限延长至2018-06-12(6月补丁周二)。
- 2018年4月30日：了解微软的情况，截止日期延长至2018-06-12。询问微软是否还会修补其他技巧。
- 2018年4月30日：微软回应称其他技巧“不会收到低级安全更新”。
- 2018年6月12日：Microsoft发布补丁（请参阅此处的发布：[CVE-2018-1036](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-1036)）。
- 2018年6月13日：博客发布。

## 技巧2：使用替代数据流绕过路径限制

上述方法之所以有效，是因为Windows内部存储文件时会使用默认的数据流名称`$DATA`。第一个技巧的原理是将数据流类型更改为`INDEX_ALLOCATION`，从而创建一个文件夹。

除了默认数据流外，还可以使用不同的数据流名称来存储文件信息。例如，从互联网下载的文件可能会包含区域标识符，如`putty.exe:Zone.Identifier:$DATA`。使用`dir /r`命令可以看到这些数据流名称。

**示例：**
- **图3**: 将`zone.identifier`放入`putty.exe`中，然后尝试读取出来。
- **图4**: 运行`test:Putty.exe`。

注：本文撰写于2018-03-01，并报告给微软。随后，微软的Windows Defender被更新以检测WMIC进程调用。

### 应用场景
ADS可以用来隐藏数据（`dir`命令不带`/r`开关不会显示文件中的ADS；`explorer.exe`也不会显示ADS）。此外，ADS还可以在文件夹中添加额外的数据流，使文件夹看起来像是来自父文件夹的文件。

例如，在`C:\Windows\Tracing`文件夹中，普通用户可以创建一个名为`C:\Windows\Tracing:test.dll`的ADS。如果这个路径传递给遍历文件夹的Windows API，API将返回`C:\Windows\`作为文件夹。这可以绕过某些应用程序白名单解决方案和安全检查。

**示例：**
- **图5**: 遍历文件夹的输出。

### 其他应用
ADS还可以包含通常文件名禁止使用的字符（如`<`或`*`），这可能导致一些安全问题。例如，如果文件名以`<`开头且路径被`>`包围，可能会导致XSS或命令注入攻击。

**示例：**
- **图6**: 特殊符号。
- **图7**: ADS的XSS利用。

## 技巧3: 创建无法通过“…”文件夹找到的文件

每个文件夹都包含两个特殊条目：“.”表示当前文件夹，“..”表示父文件夹。在Windows上，不能使用点号创建文件/文件夹，以防止解析器混淆。

**示例：**
- **图8**: 创建“…”或“....”文件夹失败。

然而，可以使用`::$INDEX_ALLOCATION`技巧绕过这一限制，成功创建这些文件夹。

**示例：**
- **图9**: 使用ADS创建“....”文件夹。

### 访问和操作
使用第二个技巧，我们可以进入这些文件夹并在其中存储文件，甚至执行程序。

**示例：**
- **图10**: 向“...”文件夹写入文件的方法。

注意，无法仅使用名称进入文件夹（例如：“cd …”或“cd …\”不起作用），必须使用“cd …\…\”的语法。进入文件夹后，可以在此文件夹中创建文件。

此外，也无法从GUI（explorer.exe）打开这些文件夹。双击这样的文件夹可能没有效果，或者资源管理器中的路径会发生变化。

**示例：**
- **图11**: “...”文件夹在地址栏中的显示情况。

通过GUI搜索这些文件夹中的文件也不起作用，但通过命令提示符进行搜索则没有问题。

希望这些优化后的文本更加清晰、连贯和专业。