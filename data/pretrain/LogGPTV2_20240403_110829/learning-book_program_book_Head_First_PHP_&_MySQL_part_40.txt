echo';
yqliclose（5dbc）:
C/hEE1>
admin.php
314
第6章
---
## Page 351
保证应用安全
Guitar WarsSorry, you must enter a valid user name and password to access this page.*) ;
removescore.php
BULLETPOINTS
PHP脚本可以使用首部来控制服务器如何向浏览
使用HTTP认证保护一个页面时，用户输入的用
器传送Web内容。
户名和口令存储在SSERVER超级全局变量中。
内置PHPheader（）函数用于向浏览器发送首
HTTP认证的“基本域”是一个安全区，与一个
部，这可以用来重定向一个页面、控制页面的
特定的用户名和口令关联，允许多个页面共同
内容类型，或者请求对一个页面认证。
得到保护。
使用header（）函数向浏览器发送首部时，
内置PHPexit（）函数会退出一个PHP脚本，避
header（）函数调用必须出现在所有其他内容的
免该函数调用之后执行任何代码，也不允许向
发送之前。
浏览器发送内容。
你现在的位置》
315
---
## Page 352
关于安全性的问题
thereareno
DumbQuestions
施。她是怎么做的？
而实际上删除分数特性要依赖于两个页面（Admin和Remove
Score）。Admin页面提供了一系列Remove链接，它们链接到
RemoveScore页面。要删除的分数的有关信息在URL中传递，
从而允许RemoveScore脚本通过S_GET超级全局变量来访问这些
信息。如果能够为RemoveScore页面组合出一个合法的URL，就
可以删除分数而无需通过Admin页面。Ethel正是这样做的。
曾经在整个网站未做保护时对RemoveScore页面建立了书签。没
错，书签就是一个URL，她能利用这个书签来构造一个URL直
接访问RemoveScore页面而不必通过Admin页面。
难道这不意味着由于日期不同，之前的URL不再起作用了吗？
查看GuitarWars主页，看到新的日期，然后把这个新日期插入到
之前的URL中，这样就能毫不费力地删除新的分数。有一点很
有些人可能下定决心
重要，有些人可能下定决心通过逆向工程分析你的PHP脚本，并
利用其中的漏洞润。绝对不要低估这些人的能力。
通过逆向工程分析你
的PHP脚本，并利用
阻止Ethel，但是这样一来，现在要合法地删除分数会不会太过
其中的漏洞。绝对不
麻烦？
要低估远些人的能力。
除分数确实会相当麻烦，因为你必须分别为Admin和Remove
Score页面输入用户名和口令。不过要记住，现在建立了一个基
本域，而且两个页面的基本域都是一样的，这说明这两个页面在
同一个安全区中。一旦通过一个页面的认证窗口，就会在该页
面所在的整个基本域中记住该用户名和口令。其最终结果是，只
需成功地输入一次用户名和口令，就足以解开两个页面。
316第6章
---
## Page 353
保证应用安全
运行测试
创建Authorize脚本，并包含在Admin和RemoveScore脚本中来提供保护。
创建一个新的文本文件，名为authorize.php，在其中输人Authorize脚本的代码。然
后修改admin.php脚本，使它包含这个Authorize脚本而不是具体的HTTP认证代码。在
removescore.php脚本的开始处增加同样的require_once语句，使这个脚本也通
过HTTP认证得到保护。
将所有脚本上传到你的Web服务器，然后尝试在Web浏览器中直接打开RemoveScore脚
本。你可能必须清除浏览器中原有的所有HTTP认证会话才能让它再次提示输入用户名
和口令，大多数浏览器会记住认证域，使你不必不断重新输入用户名和口令。
现在Admin和oRemove Score页面
都需要一个用户名和口今。
GunitarWars-HighScores
http://www.guitarwars.net/res
id=106
ovescore.php?
name=Jacobt20Scorcherson&
date=2008-05-01$2020:36:456
score=3897406
Name:
这个URL绕过了Admin页面并直接访
ltupfaoy Aa u)
问Remove Score页面。
Canceogin
不论用户如何访
问，Remove Score
页面都能得到保护。
BRAIN
XPOWER
000
Guitar Wars-Remove a High Score
你能想到GuitarWars高分应用
The high scorte of 314340 for Biff Jeck was succesfully removed
还在哪些方面存在风险？
≤s.Beck.tnuadait.2ege
你现在的位置
317
---
## Page 354
伪造分数的灾难
高分
GuitarWars第2幕：克隆攻击
不幸的是，GuitarY
Wars世界的快乐并没有持续太长时间，因为应用中开始
显示一些仿造的分数，抢占了合法分数的位置.这个问题再一次在Guitar
Wars世界掀起轩然大波。显然，即使不删除分数也完全有可能破坏Guitar
Wars高分表。但是这是怎么做的呢？
Cutar Wars-High Scores
Guitar Wars -High Scores
Welcome, Guitar Wazm
Top Score:500000
500000
Guitar
Name:Etel Heckel
Date: 2008 05-02 14:02:54
Wars
Nane:
Ethel的最高分显然是伪造的.因为她
EthelHeck
提供的截屏图像很粗糙，而且她的得
500000
分居然不多不少恰好是500000。
389740
Guitar
Name: Jacob Scorchersoe
Date: 2008 05-01 20:36:45
ar
score
screenshot
Nam
ACOBONNSU
BelitaChevy
282470
belitasscore.gif
22
2008-05-0120:36:45
Jacob Scorcherson
389740
jacobsscore.gif
23
2008-05-0120:37:02
Nevil Johansson
98430
nevilsscore.gif
24
2008-05-0120:37:23
Paco Jastorius
127650
pacosscore.gif
25
2008-05-0120:37:40
Phiz Lairston
186580
phizscore.gif
26
2008-05-0120:38:00
Kenny Lavitz
64930
kennysscore.gif
27
2008-05-0120:38:23
Jean Paul Jones
243260
jeanpaulsscore.gif
28
2008-05-0121:14:56
Leddy Gee
308710
leddysscore.gif
29
2008-05-0121:15:17
T-Bone Taylor
354190
tbonesscore.gif
30
2008-05-02 14:02:54
Ethel Heckel
500000
ethelsscore.gif
318
第6章
---
## Page 355
保证应用安全
假增实减
直到现在我们一直有一个假设，认为提交了截屏图像的高分就能通过验证。
但现在完全可以断定并非如此！显而易见作假者是谁
噢，没错，就是我指控罪名成立！我只
是提交了完全伪造的分数，另外提供了做过手
脚的截屏围像。哈哈，成为最佳吉他手的感觉
很不错。
Ethel发现只需要在提交伪造分数
时提供加工过的截属图像就可以
对GuitarWats带来严重破坏。
现在人们能够向GuitarWars应用提交伪造的高分，你将如何解决
这个间题，请写出你的想法：
你现在的位置
319
---
## Page 356
GuitarWars需要人类仲裁
安全性需要人类的干预
即使在我们生活的这个现代社会中，有时人类的思考仍是不能取代的，
人类仲裁是一种
这是指能呼吸的真正的人类。在这种情况下，要分析一个信息并评价
非常好的方法，
它是否合法，很难脱离人的参与。这里讨论的就是仲裁（moderation），
可以改善用户所
在公众看到某个内容之前，要由一个人负责批准将这个内容发布到Web
应用。
提交内容的完整
利用伸裁，尽管新的高分可以增加
性。
到数据库中，但是在仲裁人批准之
Score
Action
前不会对公众显示。
500000Remove/Approve
389740 Rcmove
Admin为各个新的高分增加
要想让这些伪造的文格（嗯，我
了一个“Approve”链接，以
是指高分）从我的眼皮底下溜过
便这些分数得到批准。
去，实在是很困难，只能靠你的
运气了。我很严格，而且根少
Guitar Wars - Add Your High Sct
犯错。
只是增加一个新的高分，不
金再把它自动增加到公开的
高分表中。
GuitarWars确实可以使用某种人类仲裁。当然，还是有可能有人精心
加工一个截屏图，并逃过人类仲裁的法眼。但是这很不容易，而且有
一点是肯定的：仲裁是一种很好的威慨。要记住，保护一个PHP应用
的安全很大程度上都在于防范。
无畏的Guitat Wats伸裁
人….从来不究全信任
所看到的高分。
320
第6章
---
## Page 357
保证应用安全
规划GuitarWars中的仲裁
为GuitarWars增加人类仲裁特性的工作量很大，因为这会影响到应用
的很多方面。数据库必须修改，而且必须创建一个新的脚本来完成批
准工作，Admin页面必须为每个分数增加一个“Approve”链接，最后，
必须修改主页使之只显示经过批准的分数。由于涉及这么多的修改，
因此先做出规划非常重要，然后再逐步分别完成各个修改。
2
创建一个ApproveScore脚本，处理是否批准一
使用ALTER向数据库表增加一个approved列。
个新的高分（设置approved列为1）。
先从数据库开始，它需要一个新列来维护一个分
一且数据库准备就绪，可以完成批准高分的工作，
数是否得到批准。
还需要一个脚本具体处理是否批准一个分数。这
个ApproveScore脚本负责在数据库中查找一个特
定的分数，并修改相应的approved列。
21:14:5
leddy Ge
 igh Se
修改Admin页面，为尚未批准的分数显示一
个“Approve”链接。
修改主页上的查询，只显示经批准的分数。
ApproveScore脚本是一个后台脚本，它不能以正
常方式直接访问。相反，要通过Admin页面上生
最后一步是确保这些批准工作反映到高分主视图
成和显示的“Approve”链接来访问，只有未批准
中。所以要修改应用的主页，只显示已经得到批
的分数旁边有“Approve”链接。
准的高分。如果没有做这个修改，与批准工作相
关的所有其他修改都将毫无意义。
Top
Guitar
Guitar
-E3t
你现在的位置
321
---
## Page 358
向guitarwars表增加approved列
用ALTER为批准项留出空间
要向guitarwars表增加新的approved列，需要使用一次ALTER
TABLE语句，这是我们之前已经用过的一个SQL语句。
MySQL数据类型BOOL是TNYJNT的一个
ALTER TABLE guitarwars
别名，所以这两个类型都可以使用。
ADD COLUMN approved TINYINT
新的apProved列是一个TINYINT，O指示一个未经批准的分
数，或者1指示一个分数已经得到批准。所以所有新分数初始时
使用ALTER向数据库表
approved值都为o，指示它们最初都是未经批准的。
增加一个approved列。
等一下。我不认为可以直接向数据厚增加一
列而不用修改AddScore膨本，难运INSERT不
该向新列中插入数据吗？
说得对，增加一个新列意味着AddScore脚本中的INSERT查询要增加一个新值。
重要的是，不要忘记一点，PHP应用是由多个部分精心合成的“交响乐”：包括
由表组成的数据库（表本身包含行和列）、PHP代码、HTML代码，通常还有CSS
代码。并不总能明显地看出修改某一部分会导致需要修改另一部分。为了完成这
个新的ApproveScore脚本，需要在guitarwars表中增加approved列，为此还
需要修改AddScore脚本中的INSERT查询：
所有新括入的高分行中approved都设置
为..…·表示未得到批准！
INSERT INTO guitarwars
VALUES （O，NOW()，'$name'，'$score'，'$screenshot'，O)
dete
oome
score
sreenshot
paAoddo
增加一个新行时
30
2008-05-02 14:02:54
Ethel Heckel
500000
ethelsscore.gif
其aproved列设置为
31
2008-05-02 20:32:54
0.表示初始时来
Biff Jeck
314340
biffscore.gif
经过批准。
32
2008-05-02 20:36:38
Pez Law
322710
pezsscore.gif
322
第6章
---
## Page 359
保证应用安全
Approve Score脚本的结构与Remove Score脚本很类似，只是它的任务
是批准一个分数。补充ApproveScore脚本缺少的代码，确保页面的安
全，另外根据通过URL传递的分数数据来批准相应的分数。
<?php
require_once('appvars.php');
require_once('connectvars.php');