# 360 Marvel Team 虚拟化漏洞第三弹 - CVE-2015-7504 漏洞分析（含高清视频）

#### 译文声明
本文为翻译文章，原文来源：360 Marvel Team。译文仅供参考，具体内容和含义以原文为准。

**作者**: 360 Marvel Team 团队负责人 唐青昊 (新浪微博: SunSky0101)

### 前言
近期，亚马逊、阿里云等云供应商已收到 Xen 官方关于高危漏洞的通知邮件（[http://lists.xen.org/archives/html/xen-devel/2015-11/msg03351.html](http://lists.xen.org/archives/html/xen-devel/2015-11/msg03351.html) 或 [http://seclists.org/oss-sec/2015/q4/405](http://seclists.org/oss-sec/2015/q4/405)）。在这封邮件中，官方确认了由 360 Marvel Team 发现并报告的这枚高危漏洞。本文将重点介绍编号为 CVE-2015-7504 的高危虚拟化安全漏洞，该漏洞同时影响 KVM 和 Xen 平台。

2015 年是云计算虚拟化安全问题爆发的一年。继毒液漏洞席卷全球之后，360 Marvel Team 在 KVM、Xen 和 VMware 平台上发现了多个高危安全漏洞。这些漏洞可能导致 **云系统被黑客攻破**。当前，云系统存储着大量用户的个人隐私信息、企业数据库信息以及政府敏感信息。一旦云系统被攻破，这些重要信息将面临泄露风险。本文所介绍的 CVE-2015-7504 漏洞具备这样的危害性，黑客不仅可以通过该漏洞窃取重要信息，还可以从一台虚拟机的普通用户发起攻击，控制宿主机，最终控制整个云环境中的所有用户。因此，对该漏洞进行深入分析至关重要。

360 Marvel Team 虚拟化漏洞系列文章旨在对团队独立发现的虚拟化软件高危零日漏洞进行分析，揭开虚拟化攻击技术的神秘面纱。在刚刚结束的日本东京太平洋安全大会（PACSEC）上，360 Marvel Team 安全研究员唐青昊发表了题为《虚拟化系统漏洞挖掘技术》的演讲，分享了漏洞挖掘的核心技术。

结合在漏洞挖掘和利用过程中的经验，360 Marvel Team 提供了针对云计算平台的防御解决方案，以抵御虚拟化平台的安全威胁，确保 360 云的安全。

本文是该系列的第三篇文章，将详细分析团队于 9 月 22 日提交的 CVE-2015-7504 QEMU pcnet 网卡缓冲区溢出漏洞。与之前披露的漏洞不同，该漏洞溢出的位置非常精妙，可轻易使黑客控制代码流程，是一枚严重的安全漏洞。此外，我们也注意到 QEMU 官方处理效率较低，从提交到正式公开历时两个月零七天。如此高危的漏洞在此期间被黑客用于攻击云计算系统的可能性很大！

前两篇文章链接如下：
- [第一篇](http://www.freebuf.com/vuls/77834.html)
- [第二篇](http://blogs.360.cn/blog/360marvelteam%E8%99%9A%E6%8B%9F%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%AC%E4%BA%8C%E5%BC%B9-cve-2015-5279-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/)

### 一、什么是 pcnet
QEMU 软件实现了对多种网卡的模拟，如 pcnet、rtl8139、ne2000、eepro100 和 e1000，以满足虚拟机用户对各种网卡的需求。网卡相关的漏洞也屡见不鲜，例如我们之前发现的 e1000 网卡漏洞，就是在数据报接收过程中出现的代码问题引起的。

pcnet 是 QEMU 中实现 AMD PCNET 网卡功能模拟的组件，相关代码位于 `/hw/net/pcnet.c` 文件中。在 QEMU 中使用 pcnet 网卡，需要通过以下命令行进行配置：

```bash
qemu-system-x86_64 centos-6.5-x64.img -m 1024 –net nic,model=pcnet -net user
```

### 二、漏洞原理分析
了解了 pcnet 的基础知识后，我们来探讨 CVE-2015-7504 漏洞的原理。正如前面所述，该漏洞利用时可以直接控制代码执行路径。具体来说，漏洞发生在 pcnet 网卡模块的数据包接收过程中，相关函数 `pcnet_receive` 的执行逻辑如下：首先检测 `CSR_DRX(s)`、`CSR_STOP(s)`、`CSR_SPND(s)`、`size`、`CSR_LOOP(s)` 和 `s->looptest` 这些值是否符合边界要求，确定函数是否继续处理。如果 `buf` 太小，则将其扩充到 `MIN_BUF_SIZE`，然后检查是否接受此数据包，并最终将数据拷贝到 `rmd` 物理地址中。相关代码截图如下：

图1. 有缺陷的代码

在上述代码中，程序员在实现数据包 buffer 操作时，未判断数据包长度是否等于 buffer 长度，这是一个明显的错误。另外，在 `pcnet.c` 的另一个函数 `pcnet_transmit` 中也有对缓冲区位置和数据包长度的处理，相关代码截图如下：

图2. `pcnet_transmit` 函数中进行缓冲区相关的处理

当数据包长度接近缓冲区长度（4096 字节）时，由于代码逻辑会自动添加 4 个字节的 CRC 值，因此会发生缓冲区溢出。巧合的是，溢出后的四个字节恰好覆盖了一个结构体指针，如图所示：

图3. buffer 所在的结构体
图4. `qemu_irq` 结构体

溢出发生后，代码流程进入 `pcnet_update_irq` 函数中，该函数经过层层调用，最终使用 `irq->handler` 作为函数指针。而我们可以控制该 `irq` 结构体指针，从而完成对代码逻辑的劫持。

图5. `pcnet_update_irq` 的代码逻辑

### 三、漏洞危害及利用演示
CVE-2015-7504 被 Xen 和 QEMU 社区官方安全团队定义为高危漏洞。一旦被黑客恶意利用，可以实现 **虚拟机逃逸** 攻击。成功利用该漏洞发动攻击后，黑客可以控制宿主机执行任意指令，后果十分严重。

图6. Xen 官方对该漏洞内容和危害的描述

Marvel Team 在演示环境中（64 位 CentOS 系统）完成了对该漏洞的完美利用。在该视频中，黑客通过虚拟机漏洞实现代理功能，控制虚拟机所在宿主机，并在宿主机中执行任意指令。（观看视频时，请注意“被攻击的宿主机”和“黑客主机”两个标签页之间的切换。此外，视频演示的攻击方式绕过了目前大部分针对宿主机和虚拟机的防护手段，堪称相当残暴。）

视频链接如下：
- [漏洞利用视频](http://yunpan.cn/c3wGdEInx7LMC 访问密码: 5299)

### 四、漏洞修复方案
Xen 官方在 Marvel Team 的帮助下提供了对该漏洞的修复补丁，截图如下：

图7. 官方公布的补丁信息

该补丁文件对 `pcnet_receive` 和 `pcnet_transmit` 两个函数的缓冲区处理进行了修正，完美修复了之前存在的漏洞。

### 小结
本文详细分析了 360 Marvel Team 独立发现的虚拟化安全漏洞 CVE-2015-7504 的原理、危害及修复方案。在漏洞利用视频中，Marvel Team 演示了黑客控制宿主机的全过程。希望此文能引起更多云服务供应商对虚拟化安全问题的重视。

### 关于 360 Marvel Team
360 Marvel Team 是国内首支虚拟化安全研究团队，专注于云安全领域的虚拟化平台攻防技术，致力于保持领先的脆弱性安全风险发现和防护能力。团队提供主流虚拟化平台的漏洞检测和系统加固解决方案。