### 360 企业安全集团
#### 演讲主题：攻击 Kerberos
**演讲人：吴方东（n1nty）@ 360 A-TEAM**
**日期：2018年**

**吴方东（n1nty）简介**
- **职位**：安全研究员
- **团队**：360 A-TEAM，隶属于360企业安全集团，专注于Web渗透、APT攻防对抗及前瞻性攻防工具预研。
- **研究方向**：深入探讨攻防技术的本质。

### 360 A-TEAM
- **团队特色**：资深失眠患者组成的纯技术研究团队。
- **研究领域**：Web渗透、APT攻防对抗及前瞻性攻防工具预研。
- **目标**：进行严肃且有深度的技术研究，还原攻与防的技术本质。

### Kerberos 身份验证协议
Kerberos 是一种基于票据的身份认证协议，最初由MIT发明，并被微软扩展为域环境下的首选认证协议。它通过向服务端发送“票”来证明用户身份，而不需要传输密码本身，因此可以在非加密通道中使用。

#### 基本概念
- **KDC (Key Distribution Center)**：域内最重要的服务器，统一保存所有账号的密码。
- **TGT (Ticket Granting Ticket)**：访问TGS服务的票。
- **普通票据**：访问其他服务的票。

#### 工作流程
1. **客户端请求 TGT**：
   - 客户端向KDC发送AS-REQ请求，声明自己的身份并提供一段加密数据以证明其身份。
   - KDC验证后返回AS-REP，包含一张TGT和对应的Session Key。

2. **客户端请求服务票据**：
   - 客户端利用TGT向KDC请求访问特定服务的票据（TGS-REQ）。
   - KDC验证TGT和加密数据后，返回TGS-REP，包含服务票据和服务Session Key。

3. **客户端访问服务**：
   - 客户端使用服务票据向目标服务发起请求（AP-REQ）。
   - 目标服务验证票据后，允许客户端访问。

#### AS-REQ 和 AS-REP
- **AS-REQ**：客户端发送请求，声明身份并提供加密数据。
- **AS-REP**：KDC返回响应，包含TGT和Session Key。

#### 预身份验证
- **预身份验证**：客户端在发送AS-REQ时提供额外的身份验证信息（如时间戳）。
- **不进行预身份验证**：客户端直接请求TGT，KDC根据配置返回相应结果。

#### 用户枚举
- **AS-REQ 用户枚举**：通过发送AS-REQ请求并分析KDC的响应，可以判断用户是否存在及其配置情况。
- **LDAP 查询**：另一种用户枚举方法，但可能留下日志。

#### 离线暴力破解
- **离线暴破 Session Key**：通过暴力破解被NT HASH加密的Session Key，可以恢复用户的明文密码。
- **优势**：不在域控留下日志，绕过密码锁定策略。

#### Pass the Hash 和 Overpass the Hash
- **Pass the Hash**：在没有明文密码的情况下进行NTLM/Kerberos身份认证。
- **Overpass the Hash**：利用NT HASH进行Kerberos身份认证。

#### 加密算法
- **常用算法**：AES 256, AES 128, RC4等。
- **加密数据**：通常是当前时间戳。
- **加密Key**：用户的NT HASH或AES KEY。

通过上述过程，Kerberos协议能够实现安全的身份验证，但在某些情况下也可能存在被攻击的风险。