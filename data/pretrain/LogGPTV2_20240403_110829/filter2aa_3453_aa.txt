如何去挖掘物联网环境中的高级恶意软件威胁
叶根深
360网络安全研究院研究员
$ whoami
Email：PI:EMAIL
Twitter/WeChat：@zom3y3
Network Security Researcher @360Netlab
TO BE A MALWARE HUNTER! 
#Botnet #Pentest #Honeypot #Sandbox
PART 01
背景介绍
目录
CONTENTS
PART 02
IoT安全现状
PART 03
挖掘未知的IoT Exploit
PART 04
挖掘未知的IoT Botnet
01
03
04
02
PART 05
总结
05
PART 
01
背景介绍
What is an advanced malware threat ?
0-day Exploit      or        Cyberweapon
概览
通过Anglerfish蜜罐，我捕获到大量网络扫描Payload和IoT Botnet，并和同事一起公开披露了部分报告，其中包括：Mirai，
http81，DDG，Hajime，TheMoon，IoT_reaper，Satori，Muhstik，HNS，Fbot，MikroTik，GhostDNS，Ngioweb，
Godlua，Gwmndy等。
我还挖掘到一些有意思的样本，部分贴在了推特上#unknown_botnet，还有一个是针对IoT平台的特马但没有公开披露。
此外，我还捕获到3个0day，其中包括被Satori Botnet利用的CVE-2017-17215漏洞，被TheMoon Botnet利用的Gpon Home 
Routers RCE漏洞，被Fbot利用的雄迈DVRIP协议漏洞。
我是如何研究IoT安全的？
•
开发Anglerfish蜜罐，模拟IoT设备指纹/漏洞，捕获网络扫描Payload和样本
•
筛选x86 ，ARM，MIPS等CPU架构样本，分析未被杀软件识别的恶意软件
•
开发特定漏洞扫描程序，统计全网受影响设备数量等
•
从设备官网下载相应固件，统计受影响的设备型号等
Network Scan 
Payload Analysis
40%
IoT Firmware 
Reversing
10%
IoT Vulnerability 
Scan
10%
ELF Malware 
Analysis
40%
PART 
02
IoT安全现状
IoT 安全现状
IoT 安全防御能力不足
IoT Botnet 攻击能力不断升级
IoT 设备已经成为APT攻击目标
01
02
03
Vulnerability：漏洞补丁能不能打上
Exploits：恶意流量能不能拦截
Malware：恶意程序能不能阻止运行
IoT 安全防御能力不足
IoT Botnet感染能力不断升级
Mirai内置大量弱口令，
通过暴力破解Telnet服
务传播。
Mirai变种集成Zyxel 
tr069协议漏洞传播，但
因为Exploit不稳定导致
路由器重启，从而引发
德国电信大断网事件。
Reaper集成9个IoT漏
洞，其中Varcon NVR
个 RCE漏洞在公开后2
天就被集成。
Satori利用Huawei 
Router HG532 0-day
漏洞传播，12月5号当天
统计到感染IP数量在57
万。全球ISP联合行动，
封锁TCP/37215端口。
2016年8月1日
2016年11月28日
2017年9月13日
2017年12月5日
1
2
3
4
2018年9月4日
5
2019年2月16日
6
MikroTik设备受泄露的 
CIA ChimayRed黑客工
具影响，路由器被攻击
者监听网络流量，充当
代理节点，植入js挖矿
代码。
Fbot使用XiongMai 
硬编码账号密码和
DVRIP升级接口0-
day漏洞传播。
IoT Botnet感染能力不断升级
暴力破解
漏洞集成
漏洞挖掘
• 暴力破解Telnet服务
• Mirai，Gafgyt
• 集成大量已公开漏洞
• IoT_Reaper，Mirai
• 0-day 漏洞利用
• Satori，TheMoon，Fbot
IoT Botnet C2技术不断升级
冗余机制
通信协议
复杂化
• 硬编码多个C2地址
• 使用DGA技术
• Mirai，Godlua
• 使用P2P协议通信
• 使用DOH解析DNS请求
• Hajime，Godlua，HNS
• C2功能插件化
• 构造多级C2协议
• VPNFilter，Ngioweb
IoT 设备已经成为APT攻击目标
情报监控
窃听风云: 你的MikroTik路由器正在被监听
IP
Count
37.1.207.114
5164
185.69.155.23
1347
188.127.251.61
1155
MikroTik设备受泄露的 CIA ChimayRed黑客工具影响，路由器被攻击者监听网络流量，充当代理节点，植入js挖矿代码。
MikroTik RouterOS设备允许用户在路由器上抓包，并把捕获的网络流量转发到指定Stream服务器。
目前共检测到 7.5k MikroTik RouterOS设备IP已经被攻击者非法监听，并转发TZSP流量到指定的IP地址，通信端口UDP/37008。
其中一个攻击者（37.1.207.114）监听了大量MikroTik RouterOS设备，主要监听TCP协议20，21，25，110，143端口，分别对应FTP-data，FTP，
SMTP，POP3，IMAP协议流量。这些应用协议都是通过明文传输数据的，攻击者可以完全掌握连接到该设备下的所有受害者的相关网络流量，包括FTP
文件，FTP账号密码，电子邮件内容，电子邮件账号密码等。
通过对受害者IP归属地统计，我们看到俄罗斯受影响最严重。
更多内容：https://blog.netlab.360.com/7500-mikrotik-routers-are-forwarding-owners-traffic-to-the-attackers-how-is-yours/
VPNFilter
更多内容：https://blog.talosintelligence.com/2018/05/VPNFilter.html
The VPNFilter malware is a multi-stage, modular platform with versatile capabilities to support 
both intelligence-collection and destructive cyber attack operations.
As of this writing, we are aware of two plugin modules: a packet sniffer for collecting traffic that 
passes through the device, including theft of website credentials and monitoring of Modbus 
SCADA protocols, and a communications module that allows stage 2 to communicate over Tor. 
PART 
03
如何去挖掘未知的IoT Exploit
Anglerfish - Most Probed Port
Telnet和HTTP协议在Anglerfish蜜罐中被扫描次数最多。
简单的IoT漏洞利用也最受攻击者欢迎。
Anglerfish - Exploits Statics
Anglerfish蜜罐已捕获100多种被Botnet利用的RCE Exploit，
每天能监测到数十种针对IoT设备的RCE漏洞利用。
绝大部分IoT漏洞利用代码都是公开的，开箱即用。
Anglerfish - ELF Malware Family Statics
当前IoT Botnet主流是Mirai和Gafgyt家族，
每天都能捕获1000多个Mirai样本MD5。
• 响应任意端口的TCP SYN Packet
• 根据协议特征，永远返回正确响应（http，mysql，mssql，redis，memcache等）
• 返回预定义或者随机的Payload特征库集合
Fuzz testing
更多内容：《通过Anglerfish蜜罐发现未知的恶意软件威胁》
Botnet扫描检测算法
First seen
Last seen
Protocol
Port
Coefficient
Payload Count
(one of ) Payload MD5
2017-02-09 23:52
2018-10-07 02:02
UDP
53413
91.64
7
2c3d957fcc56caf402b84894e4f986de
2018-07-09 06:11
2019-08-19 10:56
TCP
5555
99.09
11
7b0ae0038cc4a8ba3cee0d459d9943f8
2018-08-09 20:13
2019-08-20 10:46
TCP
52869
98.81
17
abde9f41a92f8132c9ba582c866d7cb7
2018-08-11 13:25
2019-08-13 20:35
TCP
37215
98.86
30