    RunDll32.exe SHELL32.DLL,ShellAboutW
**14.2 WMIC.exe**
WMIC（Windows Management Instrumentation Command-Line）是一个非常强大的命令行工具，可以用来收集信息：
WMIC覆盖的范围非常广泛，我们只选取某些使用案例：
本地共享：
    wmic share list /format:table
本地用户：
    wmic useraccount list full
本地用户 – 输出到HTML文件：
    wmic /output:c:users.html useraccount list full /format:hform
进程：
    wmic process list full
服务：
    wmic service list full
软件：
    wmic os lsit full
已安装的补丁/服务包/修补程序：
    wmic qfe
**十五、快捷方式**
与大多数操作系统一样，Windows中经常使用的功能都会有快捷方式。特别是系统加固方式只是浮于表面时（例如只是简单删除了开始菜单链接），某些快捷方式在这种场景中就显得尤为有用。
**15.1 标准的操作系统快捷方式**
我们可以在Windows系统的许多地方创建标准的系统快捷方式，比如我们可以尝试在桌面或者资源管理器中点击右键，在弹出的右键菜单中创建指向其他资源的链接，如“%WINDIR%system32cmd.exe“。
**15.2 辅助功能快捷键**
许多快捷方式指向的是辅助功能，比如“粘滞键“以及”鼠标按键“等。按下正确的组合键会弹出相应的对话框，这些对话框可以用来访问轻松访问中心（Ease of
Access Centre，EAC）。我们可以使用EAC作为突破口。
1、粘滞键：按下SHIFT键5次。
2、鼠标按键：SHIFT+ALT+NUMLOCK
3、高对比度：SHIFT+ALT+PRINTSCN
4、切换键：按住NUMLOCK键5秒钟
5、过滤键：按住右SHIFT键12秒钟
其他标准快捷方式也有用处，有些快捷键与特定程序有关：
1、WINDOWS+F1 – Windows搜索
2、WINDOWS+D – 显示桌面
3、WINDOWS+E – 启动Windows资源管理器
4、WINDOWS+R – 运行对话框
5、WINDOWS+U – 轻松访问中心
6、WINDOWS+F – 搜索
7、SHIFT+F10 – 右键上下文菜单
8、CTRL+SHIFT+ESC – 任务管理器
9、CTRL+ALT+DEL – 显示锁定屏幕
10、F1 – 帮助
11、F3 – 搜索
12、F6 – 地址栏
13、F11 – IE浏览器会进入全屏模式
14、CTRL+H – IE浏览器历史记录
15、CTRL+T – IE浏览器新标签页
16、CTRL+N – IE浏览器新页面
17、CTRL+O – 打开文件
18、CTRL+S – 保存
19、CTRL+N – 新建
**十六、RDP/Citrix快捷方式**
Citrix以及微软远程桌面协议（RDP）有一套自己的快捷方式或者“热键“，对应操作系统功能或者其他功能。
**16.1 远程桌面热键**
1、CTRL+ALT+END – 打开Windows安全对话框
2、CTRL+ALT+BREAK – 在窗口和全屏之间切换
3、ALT+INSERT – 循环切换窗口
4、ALT+HOME – 显示开始菜单
5、ALT+DELETE – 显示控制/上下文菜单
6、CTRL+ALT+NUMBER 结合-号 – 截取活动窗口屏幕并保存到RDP剪贴板中
7、CTRL+ALT+NUMBER 结合+号 – 截取整个RDP会话屏幕并保存到RDP剪贴板中
**16.2 Citrix ICA热键**
1、SHIFT+F1 – 显示Windows任务列表
2、SHIFT+F2 – 切换标题栏
3、SHIFT+F3 – 关闭远程应用/Citrix连接
4、CTRL+F1 – 显示Windows NT安全桌面
5、CTRL+F2 – 显示远程任务列表或者开始菜单
6、CTRL+F3 – 显示任务管理器
7、ALT+F2 – 循环切换最大化及最小化窗口
8、ALT+PLUS – 循环切换已打开的窗口
9、ALT+MINUS – 反向循环切换已打开的窗口
**十七、批处理文件及脚本**
当交互式shell被禁用时，我们可以使用诸如.BAT和.CMD之类的批处理文件来执行系统命令。虽然.BAT文件可能会被禁用，但较为陌生的.CMD文件有时候还是能发挥作用的。
**17.1 Windows脚本宿主（Windows Script Host，WSH）**
假如“cscript.exe“或者”wscript.exe“未被禁用，我们可以使用WSH来运行许多脚本语言，默认情况下可以运行VBScript、VBA以及JScript语言。
例如，我们可以执行如下VBScript片段，将代码片段保存为.VBS文件即可。使用这段代码，我们有可能可以启动一个CMD命令行：
    set objApp = CreateObject(“WScript.Shell”)
    objApp.Run “CMD C:”
我们可以通过双击方式来运行这个VBS文件，也可以将文件名作为参数传递给cscript.exe或者wscript.exe来运行。
系统支持的其他语言也有可能被攻击者滥用，如Python、Perl、PHP等，我们可以尝试使用这些语言。许多主机上默认会安装Java运行环境，我们可以采用类似方式使用javac.exe以及java.exe完成命令运行目的。
**十八、敏感文件及数据**
许多敏感数据对（快速）权限提升来说非常有用。总会有某些人会以明文形式将密码保存在某个文件中。
**18.1 使用十八般武艺来搜索文件**
1、Windows资源管理器
2、Windows搜索功能
3、命令行配合“dir c: /s juicy.txt“以及“dir c: /s *password* == *cred* == *vnc* ==
*.config*”命令。
**18.2 枚举可能保存敏感数据的应用程序**
1、VNC：ultravnc.ini等
2、Apache：httpd.conf，.htaccess等
3、KeePass以及类似应用程序
**18.3 敏感注册表项**
1、reg query “HKCUSoftwareORLWinVNC3Password”
2、reg query “HKLMSOFTWAREMicrosoftWindows NTCurrentversionWinlogon”
3、reg query “HKLMSYSTEMCurrentControlSetServicesSNMP”
4、reg query “HKCUSoftwareSimonTathamPuTTYSessions”
**18.4 敏感文件**
1、sysprep.inf
2、sysprep.xml
3、%WINDIR%PantherUnattendUnattended.xml
4、%WINDIR%PantherUnattended.xml
5、%WINDIR%debugNetSetup.log
6、%WINDIR%repairsam
7、%WINDIR%repairsystem
8、%WINDIR%repairsoftware
9、%WINDIR%repairsecurity
10、%WINDIR%system32configAppEvent.Evt
11、%WINDIR%system32configSecEvent.Evt
12、%WINDIR%system32configdefault.sav
13、%WINDIR%system32configsecurity.sav
14、%WINDIR%system32configsoftware.sav
15、%WINDIR%system32configsystem.sav
16、%USERPROFILE%ntuser.dat
**18.5 Citrix ICAClient缓存连接**
我们有可能会在本地应用数据仓库中找到已缓存的连接信息。检查“ICAClient”目录，这个目录通常位于%APPDATA%目录。使用“dir /s
ICAClient”命令也可以。
我们可以将其他用户的ICAClient内容复制到自己的目录中，这样有可能可以劫持他们已缓存的连接。
**18.6 组策略首选项中保存的密码**
如果你正在测试的主机属于某个域，并且你可以访问域控上的SYSVOL网络共享目录，那么我们可以寻找存储在各种XML文件中的“cPassword”字段。我们可以手动浏览SYSVOL文件夹，查看以下相关文件：
1、Groups.xml
2、Services.xml
3、ScheduledTasks.xml
4、Printers.xml
5、Drives.xml
6、DataSources.xml
“Password”属性经过AES加密，然而密钥为静态密钥，并且微软官方通过许多MSDN文章介绍了这个静态密钥。
**十九、二进制驻留**
二进制程序的驻留涉及到将恶意代码放在某个目录，而这个目录经常会被存在漏洞的应用或服务所使用。通常我们需要结合多种脆弱配置才能完成这一任务。
**19.1 脆弱的Windwos服务权限**
常见的一个攻击点就是存在漏洞的Windows服务以及文件/目录权限。正如前文所述，Sysinternals的accesschk.exe工具可以用来枚举此类信息。
首先，要确认我们位于那个用户组。对于低权限用户来说，他们通常位于标准的“已认证用户”组中。
现在我们需要枚举哪些服务可以被我们修改：
    accesschk.exe -uwcqv “Authenticated Users” *
如果结果中包含任意服务，我们就可以选择它作为攻击目标。
许多服务会运行在SYSTEM权限下，因此如果我们具备这类服务的写权限，我们就能以最高权限运行任何应用程序。
    sc config SERVICENAME binpath= “C:malicious.exe” -e
    C:WINDOWSSystem32cmd.exe”
    sc config SERVICENAME obj= “.LocalSystem” password =””
    net stop SERVICENAME
    net start SERVICENAME
**19.2 DLL劫持**
应用程序通常不能自己启动运行，而是以来他们挂载的资源池来完成运行目的。这种情况对诸如DLL之类的代码库来说非常普遍。通常情况下，Windows应用程序会按照预设路径来查找DLL文件，会依次检查如下目录：
1、应用程序加载的目录
2、32位系统目录（C:WindowsSystem32）
3、16位系统目录（C:WindowsSystem）
4、Windows目录（C:Windows）
5、当前工作目录（CWD）
6、PATH环境变量指定的目录（先是系统变量然后是用户变量）
如果我们可以将我们的恶意DLL放在上游路径，那么应用程序就会优先加载我们的恶意代码。
**二十、总结**
通过本文分析，我们知道这类环境通常难以进行安全防护，甚至难以正确地进行安全防护。
当用户可以使用全功能的桌面环境时，这种安全防护可能是一项更具挑战的任务。操作系统的设计初衷是提供丰富的功能，尽可能地对用户友好。不幸的是，这两点都与系统安全存在某种冲突。
我们建议任何远程环境都按照务实方式进行配置，尽可能少地向用户提供可用功能，满足用户日常需求即可，这样能尽可能少地减少整体攻击面。
所有的默认配置都应该被调整和加强，以尽可能地减少攻击者可以使用的攻击路径。
当然这些环境应该提供尽可能丰富的日志功能，同时将日志报告给中央监控/报告系统。这样管理员就能实时监控可能发生的任何攻击行为。
**二十一、参考资料及延伸阅读**
1、Citrix安全规范：
2、SANS白皮书：Citrix以及远程服务环境中的服务器安全：
3、Tariq Azad撰写的《如何对企业中的Citrix
XenApp服务器进行安全加固》：
4、windows-privesc-check：
5、使用mspaint创建cmd.exe：