未来一天以内的预测指标情况。在实时接入的过程中，系统会根据接入指标情况
修正提取的特征，对预测值进行微调，并实时评估预测的准确度。当一段时间累
积的准确度低于一定数值时，系统会认为目前的预测模型已经不够准确。这一般
是由于指标的特性已经发生改变，之前训练的模型已经不再满足需求导致的。此
时会触发模型的重新训练过程。
系统提供了阈值配置接口，对产生的预测值进行实时的阈值判断。当预测值
连续突破既定阈值时便会以告警的方式提醒运维人员执行预备操作，例如扩充磁
盘、将即将溢出的日志进行删除或归档转移，等等。
4.2.3 多维指标异常定位
为了解决异常机器和模块定位的问题与挑战，本项目提出了一个自动化的定
位系统，总体架构如下图所示：
在故障发生时（业务指标发生异常），会触发定位系统开始分析。其主要分
为三部分：
 指标异常程度评判:系统会收集当前一段时间所有机器和模块的指标数据，
并执行异常检测算法去检测所有指标的异常程度。
 相似异常机器聚类：得到所有指标的异常程度后，通过聚类算法将具有类似
指标异常的机器进行聚类。
 定位结果排序：通过运行智能排序算法，将所有的聚类结果按照异常程度排
名，并最终展现给运维人员。
以上所有流程运行在大数据平台Spark、Hadoop、InfluxDB等工具上，最终
以多样化的Web形式展示给运维人员。
4.2.4 日志异常分析与定位
为了对文本日志进行有效的利用，对其内容进行分析，并在系统产生异常时
对其进行异常定位，本项目提出了一套基于模板提取的日志异常分析与定位系统。
总体架构如下图所示：
日志经过分析处理后从纯文本转化为半结构化数据，将会降低其处理的成本
和难度。本项目采用了 FT-Tree 作为模板提取的方法。通过对 3-7 天的日志进行
处理分析并建立模型，学习其规律后，系统可以在线地对日志进行处理并分类接
入Elasticsearch 平台。步骤如下：
 对每条日志进行预处理分词，将时间、数字、IP 地址、路径等变量和其他词
语区分开来。
 利用 FT-Tree 对其进行模板学习，提取日志的公共部分，并将分析结果作为
标签实时插入Elasticsearch。
经过以上分析步骤后，日志内容将会以半结构化的 json 数据的形式存储在
Elasticsearch 中。这些数据将会提供两种使用方式。可以通过Elasticsearch 的SPL
查询语句对其进行检索，实时生成图表和仪表盘；同时，在异常发生时段，也可
以通过异常定位算法分析日志内容和正常时段的区别，从而帮助定位系统异常在
文本日志中的体现。
第 章智能运维体系架构
5
5.1 体系架构
智能运维平台的整体系统架构采用Hadoop平台作为存储和计算的支撑平台，
开放式的智能模型架构提供智能能力输出，通过基于微服务与分布式消息的运维
管理总线为主线，搭建而成。整体架构如下：
自下而上，最下面一层是数据源层，提供各种运维数据库包括结构化数据如
关系型数据库以及非结构化数据例如各种系统日志，这些数据可以通过代理采集
方式获取；另外一部分数据来源是现有系统，例如监控平台、网管、APM 等工
具，这些平台本身已经提供了各自所管里设备或者系统的事件或者性能数据，可
以通过API的方式进行数据采集或者推送；
数据源之上是运维管理总线，运维管理总线提供数据的接入、缓存、预处理，
以及各个系统之间的消息传递、API 调用。这一层通过搭建异步消息总线例如
kafka 集群来实现消息交互；
第三层是数据处理层，包括两个方面，首先是大数据平台，大数据平台提供
的是数据流式解析（例如数据加工、实时告警），数据计算以及存储能力；另外
一部分是智能算法层，主要提供、训练各种智能算法模型；
数据处理层之上是接口层，接口层是为了根据不同的智能化运维场景提供接
口调用，包括服务总线，主要提供 API 的注册、接口网关、状态、调用的管理，
数据网关主要提供数据的查询，数据网关等功能；采用的架构为微服务架构和总
线架构：微服务架构可以将运维子系统的所有功能、操作、指令全部转变为原子
操作，接受AIOPS 的总体调度。运维总线架构可以将各类系统的相互通讯模式由
网状变为星型，降低关联耦合度，提高通讯的速度、稳定性、可用性、可扩展性，
使得大数据通讯不再成为瓶颈；
最上面一层是AIOps场景层，该层次是通过调用API层提供的各种能力来实
现智能化场景。场景层的设置是根据事件的生命周期进行设置的，例如在发现问
题阶段通过自动基线、通过日志分类来判断异常，发现问题；到通过关联分析、
日志深度检查、应用全链路监控等来分析问题；通过匹配知识库，调用运维调度
平台来定位问题；最后通过智能预测来预测容量、故障的发生。另外提供了为领
导层提供辅助决策的功能，例如系统画像、用户工单、请求分析等。
5.2 数据架构
从左至右依次为数据接入、数据总线、数据计算以及数据的存储。
数据接入，提供的数据的采集，根据数据来源的不同进行有代理和无代理方
式采集。在该层建设采集中心，需要实现采集策略的定制下发、采集代理的管理、
采集延迟、补采的处理。另外发现层的覆盖度、指标丰富度、准确性、采集频率
将极大制约AIOPS的综合效益。应用系统和资源的云化趋势将简化采集技术的复
杂度，但将增加故障分析的复杂度（底层物理资源的屏蔽、云资源的耦合度等），
人工故障定位。建议按照证券行业一类、二类、三类系统的定级对不同系统采用
不同频率、覆盖程度的发现模型；
数据总线层，该层主要提供数据的缓存与处理，数据进入到消息总线（例如
kafka）之后，进行数据的 ETL 处理，过滤、切分、扩展等操作，处理之后的数
据进入再一次进入kafka集群进行流式计算如实时计算采用kafkastream，storm
等框架，离线运算采用spark；
数据计算层，数据计算主要提供数据的实时计算和离线计算。实时计算例如
指标的异常、日志关键字等实时告警功能，离线数据例如数据的基线、预测等。
常用的海量数据机器学习解决方案有 MPI, Spark, MapReduce。MapReduce 被用
来做常见的重 IO 型的 ETL 相关数据处理任务，MPI 和 Spark 则主要用做算法模
型训练；
数据存储层，是根据运用场景和数据的不同进行不同的存储方式，例如存储
到 Elasticsearch 做全文搜索，性能数据存储到时序数据库（TSDB），关系存储到
关系型数据库(如mysql)，复杂的关系，图形等存储到图形数据库（如graphDB），
历史数据等存储到HDFS，提供离线计算数据。
基于每个模块都可横向扩展的架构设计，确保系统的整体吞吐量以及性能都
可以随着节点增多而线性提升，基于实际测试结果，单节点(16 core, 32G)的配
置基础上，可以满足每秒 4 万条记录的结构化处理以及写入速度(界面可以查询
到)，单日处理量可以达到百亿条级别记录的吞吐量，可以满足性能数据每秒 1
万条以及日志数据峰值1g/s的写入速度要求。
详细性能测试结果见下表：
节点数 性能数据写入速 日志数据写入速 时间延迟
(单节点16c/32g) 度 度 (秒)
(万条/秒) (万条/秒)
1 4 4 1
5 4 20 1
备注：kafka分区数量与节点数相同。
5.3 基于微服务架构的服务总线
通过微服务平台将应用程序的不同功能单元通过服务之间定义良好的接口
和契约联系起来。使用户可以不受限制地重复使用软件、把各种资源互连起来，
提供统一的标准接口构建成分布式可扩展又相互独立的服务，以便各应用系统方
便使用各种功能服务。
基于运维业务的特殊性，落地微服务主要从以下几个步骤开展：
 梳理业务流程
通过调研、沟通从而了解真实的业务流程，并将其绘制成流程图。对于过于
复杂的业务流程，可单独绘制流程图，并增加相关的流程说明，标注业务流程中
所涉及状态的变化过程。
 抽取公共服务
在业务流程中与业务不太相关的部分，将其剥离出来，并形成公共服务。例
如，邮件发送、文件上传、其他第三方接口等。每种公共服务都对应一个微服务，
每个微服务都有相关API，要形成文档，便其他服务调用。
 定义业务服务
当公共服务抽取完毕后，业务流程中剩下来的部分就是业务服务了。不要将
业务服务的边界切得太细，可以考虑先“大切几块”，每个服务都是独立的，确
保这些大块头服务可以运行在微服务基础设施上，再不断将其进行细化，拆解为
更小的服务。
 设计数据模型
深入到每个业务服务中，定义它底层所涉及的数据模型，也称为“领域模型”。
此时会涉及数据库表结构设计，以及数据模型与关系设计。在数据层面上的设计
是至关重要的，如果该部分设计得不到位，将增加后期实现微服务的成本。
 定义服务接口
底层的数据模型设计完毕后，将视角转换到顶层的服务接口上。服务接口是
一组API，这些API需做到职责单一，而且需要通过名称就能识别出它的业务含
义。确保每个API的命名是全局唯一的，都有各自的版本号，版本号可以用自增
长的方式来体现。
5.3.1 服务网关建设
服务网关是在微服务前边设置一道屏障，请求先到服务网关，网关会对请求
进行过虑、校验、路由等处理。有了服务网关可以提高微服务的安全性，校验不
通过的请求将被拒绝访问。
目前开源的服务网关方案较多，如基于spring cloud zuul进行建设。Spring
Cloud Zuul是整合Netflix公司的Zuul开源项目实现的微服务网关，它实现了
请求路由、负载均衡、校验过滤等功能。在 Zuul 提供的请求路由、负载均衡、
校验过虑等基础功能之上，建立统一认证中心，用于管理用户授权和认证。对于
客户端的应用服务请求，首先在网关层和统一认证中心做交互，验证请求客户端
的合法性。同时提供限流机制，可以在单位时间对来自统一来源（同用户/同IP）
的请求做流量限制。
5.3.2 认证和权限管理
前端访问特定用户服务时，需要先登录才允许访问，接入网关提供统一会话