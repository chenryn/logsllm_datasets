== 指标异常预警
指标异常检测是问题出现后自动发现问题，从而解决问题，是一种被动运维，指标异常预警是在问题出现之前就进行预警，变被动为主动，是一种主动运维。
=== 预警总览
点击“指标异常预警”导航栏进入预警总览页面，页面包含预警总览信息，如预警总数、不同状态下的预警总数，点击不同状态下的预警可以进行状态过滤；还包含预警列表。
image::images/lynxee/kpi-anomaly-prediction-overview.png[]
1.状态：预警状态，包括告警、正常，未知，无数据四种状态
2.预警名称：预警定义时的名称，可以相同
3.指标：对那个指标序列进行预警
4.创建者：谁创建的，暂未对预警进行权限控制
5.模式：预测使用的算法模式
6.创建时间：什么时间创建的
7.更新时间：最近更新时间
8.操作
点击列定制可以对要展示的列进行自定制。
支持的操作：
* 单个操作
** 编辑：对预警配置进行编辑
** 静默：点击“更多”中的“静默”，对预警进行永久静默，静默后此预警的状态不再进行通知
** 启用：点击“更多”中的“启用”，对处于静默的预警重新启用
** 删除：点击“更多”中的“删除”，删除此预警，确认删除后此预警会被删除
* 批量操作：点击批量操作，选择要操作的预警进行批量操作
+
image::images/lynxee/kpi-anomaly-prediction-batch-ops.png[]
** 静默：此处静默支持选择静默时长，支持1小时、1天、1周，和永久
** 模型对比：对选取的预警基于不同量化指标进行模型对比
+
image::images/lynxee/kpi-anomaly-pre-comparsion.png[]
** 删除：批量删除
点击某个预警名称，进入异常预警运行历史情况：
image::images/lynxee/kpi-anomaly-pre-history.png[]
上面的柱状图默认展示最近一天的预警情况，不同状态用不同颜色标示。下面的折线图默认展示当下时间的下一个周期的预测情况。
用户可以在柱状图中选取感兴趣的时间段，下图会显示预测的情况。
=== 新建预警
预警页面点击“新建”进入预警新建页面，选择指标，也可以进一步选择过滤条件缩小搜索范围，点击“搜索”
image::images/lynxee/kpi-anomaly-pred-def-search.png[]
在搜索到的指标序列弹窗中选取需要预警的时序，最多选取20个指标序列。
image::images/lynxee/kpi-anomaly-pred-def-search-result.png[]
确认要进行预警的指标后，可以对指标预警进行预览，如果选取了多个指标序列，可以在右上侧下拉框中选择要进行预览的指标序列查看预测效果。
image::images/lynxee/kpi-anomaly-pred-def-preview.png[]
图中红色虚线代表当前时间，左侧是真实数据，右侧是预测数据和置信区间，当历史数据长度大于一周时，左侧最多展示一周数据，橙色部分是预警区间，预警区间可能有上下部分，也可能只有上或者下，取决于后面的配置。
配置：
image::images/lynxee/kpi-anomaly-pred-def-config.png[]
* 算法模式：默认自动模式，会自动选择预测算法和参数，也可以定义适合自己数据的模式
* 预警数据长度：支持分钟，小时，天，周，月等粒度，预测数据长度不超过3个月
* 历史数据长度：支持粒度和上面一样，历史数据长度不超过十二个月
* 预警名称：预警名称
* 告警阈值： 支持自动/手动2种方式
** 自动：系统会根据历史数据自动计算告警阈值
** 手动：根据领域知识填写，注意，填写的是告警异常阈值，可以只填写大于或小于，也可以都填写
* 预警优先级：告警优先级，支持较低、一般、中等、重要、严重5个级别
* 触发条件：配置连续几次预测超过阈值进行告警，默认1次
* 恢复条件：配置连续几次在合理范围内进行恢复通知
* 恢复发送通知：恢复是否发送通知配置，默认发送
=== 预测算法
由于时效性要求更高，指标预测的算法和异常检测算法，模型会实时更新，也就是每次预测都会对模型进行重新训练。
根据数据特征一般分为周期预测算法和趋势预测算法。
==== 周期预测算法
周期预测算法在趋势算法的基础上，同样考虑了指标规律性的短期变化，并且容许这种短期变化在不同的周期内有所不同，也就是存在“季节性”。给出的预测值也表现出这种季节性，对有周期指标的预测更加准确。值得注意的是，周期预测算法给出的自动阈值仍为静态值，不会根据时间变动。周期预测算法提供“算法”和“周期长度”两种配置
1. Agile Seasonal Model
2. Regression Seasonal Model
==== 趋势预测算法
趋势预测算法一般会忽略指标在短期内的变化，只提取并预测指标大的变化趋势。趋势可能分为线性趋势和非线形趋势两种。
趋势预测提供“算法”和“趋势类型”两种配置：
趋势类型：
1. 线性趋势：算法会用Huber Regression进行建模及预测，Huber Regression是对异常的指标值较为稳定的一种线性回归模型，它加入了一个特殊惩罚项，使得在指标值有离群值时，拟合的结果不易受到影响。
2. 非线性趋势：算法会用Holt进行建模及预测，Holt即为二阶指数平滑模型。此时，Holt对历史数据建模后得到的拟合值是非线性的。但需要注意到，一般来说Holt对未来数据的一系列预测，整体近似于一条直线，而非类似于拟合值一样的曲线。
算法：
1. Robust Regression: 算法首先使用HP滤波对数据进行去噪，得到过滤后的指标，再根据配置的趋势类型，选择对应的模型进行预测
2. Context Regression: 算法考虑到指标在配置的历史数据长度内，可能会有分布的整体变化。针对这一可能性，算法使用CUSUM(Cumulative SUM)将原始数据转化为累积排序和序列，并找到其最大值与最小值，若最大值+最小值>0，则认为指标整体上有一个从高到低的变化，取最大值的位置为变点；若最大值+最小值 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: * BP---:blk__ src:/: dest:/: **
如果提供更多的 HDFS 日志数据，训练结果可能会变成:
  * org.apache.hadoop.hdfs.server.datanode.*: * ** src:/: dest:/: **
从一般的运维知识经验，可以看出，其中三个位置的参数(实际含义分别是level/action/srcport)，值得后续关注。
=== 训练任务配置
点击顶部菜单栏"日志异常检测"，进入检测任务列表页。点击右上角的"新建"按钮，开始创建日志模式训练任务。
image::images/lynxee/log-anomaly-detection-config.png[]
点击“更多配置”，可以展开日志模式挖掘算法相关的配置。
image::images/lynxee/log-pattern-alg-config.png[]
目前支持3种算法，LynxeeDL、LynxeeLM、LynxeeFLM，不同的算法参数会有些不同，一般情况下，保持默认即可；分词配置中，目前能中文分词。
任务可以关联到 Lynxee 服务上，并配置任务类型。任务运行后，Lynxee 会根据归属服务和类型等信息，汇聚展示检测任务的状态统计、最新异常等信息。状态统计包括：被检测的日志条数、字节数、涉及的主机数、异常数等。其中，被检测的主机名称和日志条数，记录在 `_detected_log_stat` 内部索引中，用户可以自行检索使用，索引数据包括 timestamp, detected_log_stat, ip_set, job_name 等字段。
正常样本通常较大，Lynxee 支持配置特定时间段、SPL 过滤查询语句和目标字段，直接从日志易任意索引中，读取原始数据，作为训练的正常样本。
在创建之前，请确保该查询命中的结果范围内，不存在异常事件。
模型训练耗时较长，请耐心等待一段时间。你也可以关闭页面，检测任务将在后台执行，最终在任务列表上展示完成状态。
==== 参数正则配置
当日志中存在一些已知的关键参数，会大量存在不同日志模式中，而且您肯定会关注其参数检测结果，您可以在训练任务中添加相关的参数正则配置。系统会在数据预处理阶段，完成对该参数位的正则替换，并按需进行参数位模型训练。无需后续再逐一点击进行检测定义。
在创建训练任务时，开启"自定义参数正则"开关，页面上将出现"添加正则"按钮。点击"添加正则"按钮，在弹层中填写正则：
image::images/lynxee-logreduce-create-parameter.png[]
如图所示，正则表达式中的命名捕获组将会自动成为参数位的名称，您可以在这里预定义该参数位的数据类型，以及是否进行检测。
点击保存后，正则表达式将出现在"参数正则"表格中。您可以再次进行修改或删除。但是修改和删除操作仅在创建训练配置时可以进行，一旦训练任务提交，参数正则不再可修改。您只能在任务列表上点击"复制"操作，重新开始一次新的训练配置，并按需进行参数正则调整。
[NOTE]
====
参数正则采用 Java Pattern 实现，参数命名仅支持 `a-zA-Z` 。请不要使用横线下划线等特殊字符。
====
==== 增量训练
当数据量较大，或出现大量新模式数据等情况时，可以对任务进行增量训练。在任务列表的操作栏上点击"增量训练"，在增量训练弹层中，填写对应的查询语句、停顿词过滤和标点符号过滤设置，点击开始。
image::images/lynxee-logreduce-increasing.png[]
增量训练过程中，如果出现异常，任务可以继续使用之前的模型进行检测和合并标记等操作。
增量训练和初始训练共用相同的参数正则设置。增量训练完成后，在列表上点击任务名称，查看任务详情时，会采用表格形式，列出历次增量训练的配置。
注意：复制训练任务时，只能复制初始的训练任务配置。
==== 模型导入导出
模型调整效果较好以后，可以在日志异常监测列表页上，点击对应任务一行右侧的"更多"操作菜单，选择"导出"，将模型导出到本地。
新建日志异常检测任务时，可以切换到"导入"标签页。此时，不用填写查询语句，而直接通过本地上传的方式，上传模型，即可完成检测任务的创建。
image::images/lynxee-logreduce-create-import.png[]
此外，还可以通过对应任务的"复制模型"操作，无需导出到本地再上传，直接在系统内完成快速复制创建。复制模型比复制任务省略了重新训练的耗时，在模型效果比较满意，无需更换训练样本的情况下，更加便捷。