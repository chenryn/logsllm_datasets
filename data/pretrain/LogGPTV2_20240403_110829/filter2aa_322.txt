# KCon 智能门锁的“天灾人祸”：Bluetooth Smart Locks 安全攻防研究

## 关于作者
- 启明星辰 ADlab 安全研究员
- 研究方向：智能设备安全与漏洞挖掘
- 联系方式：邮箱 [PI:EMAIL]，看雪ID：蝴蝶

## 目录
1. 浅谈蓝牙低能耗
2. 智能门锁的安全问题
3. 研究案例分享
4. 改进方案
5. 写在最后

### 01 浅谈蓝牙低能耗
#### 蓝牙低能耗应用场景
蓝牙低能耗技术广泛应用于各种物联网设备中，如智能穿戴、智能家居等。

#### 蓝牙低能耗特点
- **低功耗**：可变连接时间，延长电池寿命。
- **远距离传输**：支持更长的数据传输距离。
- **高安全性**：采用128位AES加密。
- **低延时**：快速响应用户操作。

#### 蓝牙低能耗协议栈
- **应用层**：负责具体的应用逻辑。
- **Host层**：处理高层协议和数据交换。
- **Controller层**：管理物理层和链路控制层。
- **物理层（Physical Layer）**：
  - **频段**：2.4GHz，无需授权。
  - **射频信道**：共40个信道，其中37、38、39为广播信道，其余为数据信道。
  - **跳频特性**：提高抗干扰能力。
- **链路控制层（Link Layer）**：
  - **状态机**：Standby, Advertising, Scanning, Initiating, Connection。
- **通用属性协议（GATT）**：
  - GATT定义了客户端和服务端的角色。
  - 客户端发送请求到服务端。
  - 服务端包含多个Service，每个Service包含多个Include和Characteristic。
  - 服务端接收并处理客户端请求，并存储Characteristic的值。
- **心率计服务**：
  - 服务由数据和相关行为组成，用于特定功能。
  - Service和Characteristic的UUID可以是公共的或自定义的。
  - Properties, Descriptors, Value。

#### 安全管理（SM）
- **JustWorks**：临时密钥（tk）默认为6个0。
- **6-digit PIN/Passkey Entry**：临时密钥（tk）为随机6位数（000000-999999），适用于有屏幕输入的设备。
- **Out of band**：使用另一种无线方式将数据传给蓝牙设备，tk值为128位。

### 02 智能门锁的安全问题
#### 蓝牙协议潜在攻击面
- **配对时的密钥分配不安全**。
- **GATT Profile中的数据交互接口暴露**。
- **协议本身存在缺陷**，需要从协议层面进行分析。

#### 蓝牙智能锁的攻击面
- **APP存在的攻击面**：
  - APP被逆向分析。
  - 日志泄露关键信息。
  - APP与服务器之间的WEB安全问题。
  - APP与锁之间的认证问题。
- **蓝牙协议攻击面**：
  - 通信协议分析。
  - 工具：Ubertooth One/USB Dongle。
  - 分析btsnoop_hci.log文件。
- **固件问题**：锁中的固件可能存在漏洞。

### 03 研究案例分享
#### 案例分析（一）
- **设备**：一款BLE和GPS合一的共享车锁。
- **操作流程**：
  - 扫描设备。
  - 配对成功后操作。
- **分析方法**：
  - 分析蓝牙数据。
  - 查看APP日志。
  - 逆向分析APP。
  - 获取token并开锁。
- **攻击方式**：
  - 发送获取token指令。
  - 伪造APP。
  - 缺乏MAC认证。
  - 发送OPEN指令。

#### 案例分析（二）
- **问题**：使用HTTP明文传输，请求包可以重放。
- **漏洞**：明文密钥，弱口令。
- **获取token**：上一次的token会参与本次获取token的运算，需要从APP第一次运行入手。

#### 案例分析（三）
- **工作模式**：
  - 移动端APP通过key开锁，无数据包加密。
  - 远程服务器下发key。
- **安全隐患**：
  - APP直接发送key进行开锁。
  - 请求包可以重放。
- **攻击方式**：请求包重放。

### 04 改进方案
- **APP加固**：防止逆向工程。
- **密钥管理**：避免硬编码和弱口令。
- **配对密钥管理**：加强密钥分配和管理。
- **验证机制**：引入MAC白名单。
- **固件更新**：定期更新固件以修复漏洞。
- **非对称加密**：考虑在协议通信中使用非对称加密。
- **互认证**：通过协议实现设备与移动端的双向认证。

### 05 写在最后
物联网安全是一个持续的过程，一切才刚刚开始。我们需要不断学习和改进，确保物联网设备的安全性。

感谢您的关注！

---

希望这个优化后的文本能够更好地传达您的内容。如果有任何进一步的需求，请随时告知。