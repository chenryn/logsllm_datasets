KCon
KCon
智能门锁的“天灾人祸”
Bluetooth smart locks安全攻防研究
关于作者
• 启明星辰ADlab安全研究员
• 研究方向：智能设备安全研究与漏洞挖掘
• 邮箱：PI:EMAIL
• 看雪ID：ID蝴蝶
PART 01
浅谈蓝牙低能耗
PART 02
智能门锁的安全问题
PART 03
研究案例分享
PART 04
改进方案
PART 05
写在最后
目录
CONTENTS
01 浅谈蓝牙低能耗
蓝牙低能耗应用场景
蓝牙低能耗特点
• 低能耗，可变连接时间
• 传输距离远
• 采用128bitAES加密
• 低延时
蓝牙低能耗协议栈
• 蓝牙应用层
• Host层
• Controller层
物理层（Physical Layer）
• 频段：2.4GHz，无需授权
• 射频信道，40个。37，38，
39为广播信道。其他为数据信道。
• 跳频特性
链路控制层（Link Layer）
• 五种状态：Standby,Advertising,
Scanning，Initiating,Connection
• 状态机
通用属性协议（GATT）
• GATT定义了客户端和服务端
• 客户端发送请求到GATT服务端
• 包含多个Service，Service包
含多个Include和Characteristic
• 服务端接收客户端发来的请求
和指令并存储Characteristic的value
心率计服务
• 服务是一些列由数据和相关行为组成的集合，
为了去完成某个特定的功能和特性。
• Service和Charachteristic的UUID是公共的，
也可自定义。
• Properties
• Descriptors
• Value
安全管理（SM）
• JustWorks ：临时密钥（tk）默认6个0 
• 6-digit PIN/Passkey Entry：临时密钥（tk）随机6位数
000000-999999（适合有屏幕输入的）
• Out of band：带外是使用另一个无线方式将数据传给蓝牙设备，
这种方式下tk值为128bits
02 智能锁的安全问题
蓝牙协议本身潜在攻击面
• 配对时的密钥分配不安全
• GATT的Profile中的数据交互接口暴露
• 总归还是协议出了问题，那就从协议分析入手
蓝牙智能锁的攻击面
• APP存在的攻击面
• APP被逆向分析
• APP打印日志泄露关键信息
• APP和服务器交互的WEB安全问题
• APP和锁之间的认证问题
• 蓝牙协议攻击面
• 通信协议分析
• 工具：Ubertooth One/usb Dongle
•
/直接分btsnoop_hci.log
• 锁中的固件问题
趋势比较
研究案例分享
03
案例分析（一）
• 一款BLE和GPS合一的共享车锁
APP操作端
• 先扫描设备
• 扫描到设备后，进行配对。
• 配对成功，即可操作
分析蓝牙数据
蓝牙锁响应后，返回的数据
看看APP日志
逆向分析APP
加密方式，协议包
获取token，开锁
0～1
2～3
获取token数据包，16byte
GET_TOKEN
固定值
随机数
4～15
开锁数据包，16byte
0～1
2
OPEN_TYPE
固定值
密码
9～12
3～8
token
13～15
随机数
攻击方式
发送获取token指令
伪造APP
没有做
到mac
认证
返回token
发送OPEN指令
案例分析（二）
使用http明文传输，请求包可以重放
明文密钥，弱口令
获取token的指令
• 上一次的token会参与本次获取
token的运算，如何获取上一次
token？
• 从app第一次运行入手。
案例分析（三）
工作模式
移动端APP
通过key
开锁，无
数据包加
密
智能锁
远程服
务器
用户注册，并下
放key
返回结果
存在的安全隐患
移动端APP
app直接发送key进行
开锁，并无特定开锁
指令包
智能锁
远程服
务器
获取key的请求
包可以重放
Attack
请求包重放
开锁逻辑
开锁指令蓝牙数据包
蓝牙数据包一次性只能发送20byte，超过的必须要分片发送。
改进方案
04
攻击不是目的，如何改进
• 至少要APP加固
• APP端的密钥不使用硬编码，弱口令
• 配对密钥管理与分配
• 锁和APP的验证问题，MAC白名单
• 智能设备的固件更新问题
• 协议通信能不能使用非对称加密
通过协议进行设备和移动端互认证
1、en(A1,B1),key
2、en(A2,B2),key
3、en(A3,B3),A1B1A2B2
4、en(A3,B3),A1B1A2B2
写在最后
05
物联容易，安全不易，且行且珍惜
嵌入式系统
bin
web
后台管理
交互接口
固
件
通信协议
云端
攻击面很多
• Web：弱口令、SQL注入、跨站、权限绕过...
• Bin：缓冲区溢出...
• APP：代码逆向、Log敏感信息泄露、WebView远程代码执行、拒
绝服务攻击、database配置错误...
• 协议方面
• ...
这是一个过程，一切才刚刚开始
Thank you!
Thank you!