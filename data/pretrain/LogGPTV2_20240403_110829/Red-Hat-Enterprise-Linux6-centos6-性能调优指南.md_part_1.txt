红帽企业版 Linux 6
性能调节指南
在红帽企业版 Linux 6 中优化子系统流量
版 4.0
红帽 主题专家
红帽企业版 Linux 6 性能调节指南
在红帽企业版 Linux 6 中优化子系统流量
版 4.0
红帽 主题专家
编编辑辑
Don Domingo
Laura Bailey
法法律律通通告告
Copyright © 2011 Red Hat, Inc. and others.
This document is licensed by Red Hat under the Creative Commons Attribution-ShareAlike 3.0 Unported
License. If you distribute this document, or a modified version of it, you must provide attribution to Red
Hat, Inc. and provide a link to the original. If the document is modified, all Red Hat trademarks must be
removed.
Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section
4d of CC-BY-SA to the fullest extent permitted by applicable law.
Red Hat, Red Hat Enterprise Linux, the Shadowman logo, JBoss, MetaMatrix, Fedora, the Infinity Logo,
and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
Linux ® is the registered trademark of Linus Torvalds in the United States and other countries.
Java ® is a registered trademark of Oracle and/or its affiliates.
XFS ® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States
and/or other countries.
MySQL ® is a registered trademark of MySQL AB in the United States, the European Union and other
countries.
Node.js ® is an official trademark of Joyent. Red Hat Software Collections is not formally related to or
endorsed by the official Joyent Node.js open source or commercial project.
The OpenStack ® Word Mark and OpenStack Logo are either registered trademarks/service marks or
trademarks/service marks of the OpenStack Foundation, in the United States and other countries and
are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or
sponsored by the OpenStack Foundation, or the OpenStack community.
All other trademarks are the property of their respective owners.
摘摘要要
《性能调节指南》 论述了如何优化运行红帽企业版 Linux 6 的系统性能。它还记录了与性能有关的红帽企业
版 Linux 6 升级。 虽然本指南包含实地测试和验证的步骤，红帽建议您在将其部署到产品环境前在测试环境
中全面测试所有计划的配置。您还应该在调整配置前备份所有数据。
目录
目目录录
序.序 . .言言 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .5 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
1. 文档约定 5
1.1. 排版约定 5
1.2. 抬升式引用约定 6
1.3. 备注及警告 7
2. 获得帮助并提供反馈信息 7
2.1. 您需要帮助吗？ 7
2.2. 我们需要您的反馈！ 8
第.第 . . 1. . 章章. . .概概 . .述 述. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .9 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
1.1. 读者 9
1.2. 横向可扩展性 10
1.2.1. 并行计算 10
1.3. 分布式系统 10
1.3.1. 通讯 11
1.3.2. 存储 12
1.3.3. 聚合网络 12
第.第 . . 2. . 章章. . .红红 . .帽 帽. . 企企. . 业业. . 版版. . . L. i. n. u. .x . 6. . 性性. . 能能. . 特特. . 点.点 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1. .4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
2.1. 64 位支持 14
2.2. Ticket 自旋锁 14
2.3. 动态列表结构 15
2.4. 无空循环内核 15
2.5. 控制组 15
2.6. 存储和文件系统改进 16
第.第 . . 3. .章 章. . .监监 . .控控 . .和 和. . 分分. . 析析. . 系系. . 统.统 . .性性 . .能能 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .1 .8 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
3.1. proc 文件系统 18
3.2. GNOME 和 KDE 系统监视器 18
3.3. 内嵌命令行监控工具 19
3.4. Tuned 和 ktune 20
3.5. 应用程序分析工具 21
3.5.1. SystemTap 21
3.5.2. OProfile 21
3.5.3. Valgrind 22
3.5.4. Perf 22
3.6. Red Hat Enterprise MRG 23
第.第 . . 4. . 章章. . . C. .P . U. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2. .4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
拓扑 24
线程 24
中断 24
4.1. CPU 拓扑 24
4.1.1. CPU 和 NUMA 拓扑 24
4.1.2. 调节 CPU 性能 25
4.1.2.1. 使用 taskset 设置 CPU 亲和性 27
4.1.2.2. 使用 numactl 控制 NUMA 策略 27
4.1.3. numastat 28
4.1.4. NUMA 亲和性管理守护进程（numad） 30
4.1.4.1. numad 的优点 30
4.1.4.2. 操作模式 31
4.1.4.2.1. 将 numad 作为服务使用 31
4.1.4.2.2. 将 numad 作为可执行文件使用 31
1
红帽企业版 Linux 6 性能调节指南
4.2. CPU 调度 32
4.2.1. 实时调度策略 32
4.2.2. 一般调度策略 33
4.2.3. 策略选择 33
4.3. 中断和 IRQ 调节 33
4.4. 红帽企业版 Linux 6 中 NUMA 的改进 34
4.4.1. 裸机和可扩展性优化 34
4.4.1.1. 拓扑识别改进 34
4.4.1.2. 改进多核处理器同步 35
4.4.2. 虚拟化优化 35
第.第 . . 5. . 章章. . .内内 . .存 存. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .3 .6 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
5.1. 超大转译后备缓冲器（HugeTLB） 36
5.2. 大页面和透明大页面 36
5.3. 使用 Valgrind 简要描述内存使用 36
5.3.1. 使用 Memcheck 简要概述内存使用 37
5.3.2. 使用 Cachegrind 简要概述缓存使用 37
5.3.3. 使用 Massif 查看堆和栈空间配置 39
5.4. 容量调节 40
5.5. 调整虚拟内存 42
第.第 . . 6. . 章章. . .输输 . .入 入. . /.输输 . .出出 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4. .4 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
6.1. 功能 44
6.2. 分析 44
6.3. 工具 45
6.4. 配置 48
6.4.1. 完全公平调度（CFQ） 48
6.4.2. 最后期限 I/O 调度程序 50
6.4.3. Noop 50
第.第 . . 7. . 章章. . .文文 . .件 件. . 系系. . 统统. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .5 .2 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
7.1. 为文件系统调整注意事项 52
7.1.1. 格式化选项 52
7.1.2. 挂载选项 52
7.1.3. 文件系统维护 53
7.1.4. 应用程序注意事项 54
7.2. 文件系统性能侧写 54
7.3. 文件系统 54
7.3.1. Ext4 文件系统 54
7.3.2. XFS 文件系统 55
7.3.2.1. XFS 到基本调节 55
7.3.2.2. XFS 的高级调节 56
7.4. 集群 57
7.4.1. 全局文件系统 2 57
第.第 . . 8. . 章章. . .联联 . .网 网. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .5 .9 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
8.1. 网络性能改进 59
接.接 . .收收 . .数数 . .据 据. . 包包. . 操操. . 控控. . （.（ . .R . P. .S .） ）. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .5 .9 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
接.接 . .收收 . .流流 . .程 程. . 操操. . 控控. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .5 .9 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
.T . C. .P . -.t .h . i.n . 流流. . 的.的 . . g. .e .t .s .o . c. k. o. .p . t. 支支. . 持.持 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .5 .9 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
传.传 . .输输 . .代代 . .理 理. . 服服. . 务务. . 器器. . （.（ . .T . P. .r o. .x .y .） ）. . 支支. . 持持. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .6 .0 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
8.2. 优化的网络设置 60
2