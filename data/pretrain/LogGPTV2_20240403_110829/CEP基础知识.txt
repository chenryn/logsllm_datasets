北京速德贝斯科技有限公司 文件编号：CKZL20130050 
CEP 基础知识与示例
V 1.0 
http://www.sodbase.com
北京速德贝斯科技有限公司 文件编号：CKZL20130050 
目录1. 	CEP 事件处理平台 ..................................................................................... 3 2. 	CEP 基本操作符 ......................................................................................... 3 3. 	示例 ............................................................................................................ 3 	3.1 监控 ............................................................................................................ 3 	3.1.1 简单的统计 .................................................................................... 3 	3.1.2 关联性监测 .................................................................................... 4 	3.1.3 趋势监测 ........................................................................................ 4 	3.2 事务一致性监测 ....................................................................................... 5 4. 	模式自动发现 ............................................................................................ 5 5. 	级联事件处理 ............................................................................................ 5 	自定义函数 ................................................................................................ 6 6.7. 	图形化建模工具 ........................................................................................ 6 
http://www.sodbase.com
北京速德贝斯科技有限公司 文件编号：CKZL20130050 
摘要. 本文介绍 CEP 引擎的基本操作符和相关概念，并给出了部分示例。 
1.CEP 事件处理平台 
CEP(Complex Event Processing)事件处理平台用于跟踪和分析数据流，CEP 系统能够从来自多个系统的数据流中将数据进行结合分析，实时监测数据模式，监测或推出用户感兴趣的模式或事件。 
2.CEP 基本操作符 
	同时发生 Conjunction(A&B):表示事件 A、事件 B 都发生，但不规定 A、B 发生的顺序。	顺序发生 Sequence(A;B): 表示事件 A 在事件 B 后发生，即事件 A 的结 束时间在事件 B 的开始时间之前。 
非 Negation（!A）:表示事件 A 不发生，通常需要和其它操作符一起使用。	如“A;!B;C”表示 A、C 顺序发生，但其间不能有 B 发生。 
或 Disjunction（A|B）:表示事件 A 发生或事件 B 发生或两者都发生。 
	克林包 Kleen Closure(A^+/A^num): A^+表示事件 A 发生 1 次或多次；A^num 中 num 为数字，表示事件 A 发生 num 次。 
时间窗口：一个复杂事件 e 的满足时间窗口 w，是指 e 的结束时间减去 e 的开始 时间不大于 w。 
	总之，使用基本的操作符，加上自定义函数、级联事件处理，CEP 可以构造 出各种各样满足现实需求的事件。(CEP 还提供变化监测方面的操作符)3.示例 
3.1 监控 
3.1.1 简单的统计 
CEP可以做一些统计功能，例如分批抽样计数、计算平均值等 例3.1.1.1 统计每10秒的平均价格 
CREATE QUERY query 
SELECT average(T2.price) AS output 
FROM T2:StockIn 
PATTERN T1;T2^+;T3 
WHERE T1._start_time_=T3._start_time_-10000 
WITHIN 10000  /*单位是毫秒*/ 
http://www.sodbase.com
北京速德贝斯科技有限公司 文件编号：CKZL20130050 
注：内置聚合函数包括 average、sum、tostring、max、min、first、count、countdistinct、tostringdistinct 等 
3.1.2 关联性监测3.1.2 关联性监测 
在(name,value,timestamp)流上，name 代表监控对象的名称 
3.1.2.1 正向关联 
监测正向关联对象 
PATTERN (A&B);(C&D) 
WHERE A.name=c.name 
AND B.name=D.name 
AND A.timestamp = B. timestamp 
AND C.timestamp=D.timestamp 
AND A.value>C.value 
AND B.value>D.value 
3.1.2.2 反向关联 
监测与 name='600210'的反向关联对象 
PATTERN T1;T2;T3;T4 
WHERE T1.name=T3.name 
AND T2.name=T4.name 
AND T2.name='600210' 
AND T1.value =  T4.value+0.02 
WITHIN 50000 
3.1.3 趋势监测 
例 3.1.2.1.1 值连续上升,但未达到超标值 
PATTERN A;B;C 
WHERE C.value>B.value AND B.value>A.value AND C.value<阈值 WITHIN 300000 
http://www.sodbase.com
北京速德贝斯科技有限公司 文件编号：CKZL20130050 
3.2 事务一致性监测 
	传统数据库事务处理局限于数据库服务器本身，CEP 可以辅助保障对于多系 统交互的事务一致性。 
例3.1.1（OLP0001）："用户确认支付"后,没有"银行转账成功"，就"出货" 
CREATE  QUERY  OLP0001  SELECT  T1.userid  AS  T1_userid  FROMT1:streamdata,T2:streamdata,T3:streamdata PATTERN T1;!T2;T3 
WHERE T1.userid=T3.userid 
AND T2.userid=T3.userid 
AND T1.message='verifypay' 
AND T2.message='bankpaycomplete' 
AND T3.message ='productrelease' 
AND T1.productid=T3.productid 
AND T2.productid=T3.productid 
WITHIN 50000 
例3.1.2 (OLP0002): "用户确认支付"后，"银行转账成功"，5分钟内卖家没有" 出货" 
例3.1.3(OLP0003): "用户确认支付"后，"银行转账成功"，30秒内没有卖家没有 收到"收款短信"例3.1.4 (OLP0004): "用户确认支付"后，"银行转账成功"，卖家收到"收款短信 "，收款短信的金额与银行转账金额不一致 
	监测的结果可以接到Web service或BPEL服务从而启动自动处理事务，也可 以连接到OA等系统让人工参与处理。 
4.模式自动发现 
例如在时间窗口 100 内检测支持度大于 2 的频繁顺序模式 
5.级联事件处理 
多个事件处理的输入输出可以级联起来，满足业务需求，如下图所示 
| 数据过滤 | 求平均 | 上升趋势 |
|---|---|---|
| 数据过滤 |值 |监测 |
http://www.sodbase.com
北京速德贝斯科技有限公司 文件编号：CKZL20130050 
6.自定义函数 
CEP 引擎可以直接调用 Java 函数，用户可以通过自定义函数扩展，满足业务 定制需求，例如SELECT JAVA:functiona(A.value,B.value) 
PATTERN A;B 
WHERE JAVA:functionb(A.value,B.value) 
7.图形化建模工具 
使用图形化建模工具进行单元建模和测试，不手工写 CEP 语言，建模更为快 速简便。 
http://www.sodbase.com