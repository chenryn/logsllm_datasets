**说明：**
-   整体流程：业务埋点日志采集日志汇聚存储日志分析结果展示、监控
-   各节点应用根据业务进行服务调用链日志埋点，BOMC通过采集程序从各节点应用服务器将日志采集到BOMC日志中心。
-   BOMC平台新增日志服务功能模块，对业务调用链路日志进行汇聚、存储、分析、展示
##### 逻辑架构
![](media/image3.emf)
说明：
-   BOMC新增采集程序从各节点应用服务器采集日志文件，将日志文件汇聚到BOMC日志平台
-   BOMC平台新增日志服务模块，汇聚各节点的日志信息并对日志进行存储和分析
-   BOMC平台新增查询业务调用链日志信息功能
    1.  ##### 功能架构
###### 埋点日志生成架构
![](media/image4.emf)
说明：各节点应用各自根据业务进行服务调用链日志埋点，BOMC从各节点应用服务器将日志文件采集到BOMC日志平台。
+---------------+------------------------------------------------------+
| 功能名称      | 简述                                                 |
+===============+======================================================+
| 日志埋点      | 1.  前台营业厅业务：前台WAS                          |
|               |     服务、                                           |
|               | 营业CICS服务、账务CICS服务根据业务服务调用生成埋点。 |
|               |                                                      |
|               | 2.  电子渠道                                         |
|               | ：营业CICS服务、账务CICS服务根据接口请求，生成埋点。 |
+---------------+------------------------------------------------------+
| 日志采集      | 1.BOMC通过采集程序从节点CRM CICS、节点BOSS           |
|               | CICS和节点CRM                                        |
|               | WAS将生成的调用链日志上传到BOMC日志平台。            |
+---------------+------------------------------------------------------+
###### 日志存储和分析
BOMC新增日志服务功能，将全省各节点应用服务的业务调用链日志采集汇聚到BOMC日志平台进行存储、分析、展示。
  ------------------------------------------------------------------------------
  功能名称           简述
  ------------------ -----------------------------------------------------------
  日志采集           将节点CRM CICS、节点BOSS CICS和节点CRM
                     WAS生成的业务调用链日志采集到BOMC日志平台
  日志汇聚           将CRM\\BOSS各个应用生成的业务调用链日志汇聚到BOMC日志平台
  日志存储           将各应用服务器的业务调用链日志文件解析入库保存
  日志分析、展示     提供业务调用链日志分析能力和查询展现能力
  ------------------------------------------------------------------------------
##### 关键业务埋点流程
###### 产品订购退订场景【营业厅渠道】
![](media/image5.emf)
流程描述：
整个业务调用链日志的打印以操作员点击菜单请求页面开始：
1、操作员登录CRM系统，点击产品订购退订业务菜单开始受理业务，此时生成本次业务的交易流水，并将交易流水号设置在当前会话的上下文中，用于后续本次业务的每次服务请求中，并且设置序号1作为业务调用开始，后续的服务调用序号以1开头，后续每次服务调用中涉及新服务端时则后面加1，如1.1、1.1.1、1.1.1.1等。
2、WEB客户端调用CRM
WAS服务端获取业务请求页面信息，此时为首次服务调用，前台WAS服务端生成本次业务的交易开始埋点。
3、WEB客户端调用CRM WAS服务端进行用户鉴权，前台WAS再调用后台CRM
CICS进行用户鉴权，CRM WAS、CRM
CICS服务生成服务调用埋点（请求），返回鉴权结果，CRM CICS、CRM
WAS服务生成服务调用埋点（响应）。
4、查询用户信息、查询用户订购关系、业务规则校验、产品校验、订单算费、订单预生成、订单提交等服务调用同上。
5、部分服务请求涉及CRM CICS调用账务CICS服务，CRM
CICS需要在调用前生成服务埋点（请求），接收到处理结果时生成服务埋点（响应）。账务CICS服务接收到CRM
CICS服务请求后，生成服务埋点（请求），处理完业务逻辑返回CRM时，生成服务埋点（响应），内部如果存在服务调用时，同样生成对应的服务埋点（包括请求、响应）。
6、整个业务操作过程中，存在多次界面操作及服务请求，循环上面2、3、4、5步骤生成相应的服务调用埋点日志。
7、整个业务操作完成，前台WAS生成交易结束埋点，标识业务操作完成。
说明：每笔业务有一对交易埋点日志，N对服务调用埋点日志，整个业务调用链以交易开始埋点开始到交易结束埋点整个链条中，包括了多对服务服务调用埋点，并且对服务调用埋点编号，从而可以清晰的看到整笔业务的调用逻辑和流程。
###### 产品订购退订场景【电子渠道】
![](media/image6.emf)
流程描述：
整个调用链日志的打印以电子渠道发起业务请求开始。
1、电子渠道发起业务办理请求，通过CRM接口层解析后转到到CRM CICS服务。
2、后台CICS接收到接口层的业务请求后，接口调用007接口时，CRM
CICS服务生成本次业务的交易流水，并将流水号设置在当前事务的上下文中，生成订单对象时将此流水设置到订单属性上，用于后续本次业务的服务埋点。同时生成交易开始埋点，和服务埋点（请求），并且设置序号1作为业务调用开始，后续的调用序列以1开头，后续每次服务调用中涉及新服务端时则后面加1，如1.1、1.1.1、1.1.1.1等。
3、电子渠道调用026、008接口时，CRM
CICS服务根据订单号查询007接口生成的订单对象的交易流水属性，如果有则生成服务调用埋点（请求、响应）。
3、部分业务涉及CRM
CICS调用账务CICS服务，需要在调用账务接口前生成服务埋点（请求），账务CICS返回后生成服务埋点（响应）。如果调用多次，则生成多对服务埋点。
4、账务CICS服务接收到CRM
CICS服务请求后，生成服务埋点（请求），处理完业务逻辑返回CRM时，生成服务埋点（响应），内部如果存在服务调用时，同样生成对应的服务埋点（包括请求、响应）。
5、CRM
CICS服务处理完本次业务请求后生成本次业务的交易结束埋点，标识业务操作完成。
6、CICS返回处理结果给接口层，接口层返回业务受理结果给电子渠道。
说明：每笔业务有一对交易埋点日志，N对服务埋点日志，整个业务调用链以交易开始埋点开始到交易结束埋点整个链条中，包括了多对服务埋点，并且对服务调用埋点编号，从而可以清晰的看到整笔业务的调用逻辑和流程。
###### 开户场景【营业厅渠道】
![](media/image7.emf)
流程描述：
整个调用链日志的打印以操作员点击菜单请求页面开始：
1、操作员登录CRM系统，点击个人主体产品开户业务菜单开始受理业务，此时生成本次业务的交易流水，并将交易流水号设置在当前会话的上下文中，用于后续本次业务的每次服务请求中，并且设置序号1作为业务调用开始，后续的调用序列以1开头，后续每次服务调用中涉及新服务端时则后面加1，如1.1、1.1.1、1.1.1.1等。
2、web客户端调用CRM
WAS服务端获取业务请求页面信息，此时为首次服务调用，前台WAS服务端生成本次业务的交易开始埋点。
3、web客户端调用CRM WAS服务端读取开户产品目录信息，前台WAS调用后台CRM
CICS服务读取开户产品目录信息，WAS、CRM
CICS服务生成服务调用埋点（请求），返回结果，CRM CICS、CRM
WAS服务生成服务调用埋点（响应）。
4、后续的多个服务调用请求，如证件黑名单校验、一证多机校验、选号、号卡校验、选择产品、产品校验、业务规则校验、订单算费、订单预生成、订单提交等步骤同上。
5、如果服务请求涉及CRM CICS调用账务CICS服务，CRM
CICS需要在调用前生成服务埋点（请求），接收到处理结果时生成服务埋点（响应）。账务CICS服务接收到CRM
CICS服务请求后，生成服务埋点（请求），处理完业务逻辑返回CRM时，生成服务埋点（响应），内部如果存在服务调用时，同样生成对应的服务埋点（包括请求、响应）。
6、整个业务操作过程中，存在多次界面操作及服务请求，循环上面2、3、4、5步骤生成相应的埋点日志。
7、整个业务操作完成，前台WAS生成交易结束埋点，标识业务操作完成。
说明：每笔业务有一对交易埋点日志，
N对服务埋点日志，整个业务调用链以交易开始埋点开始到交易结束埋点整个链条中，包括了多对服务调用埋点，并且对服务调用埋点编号，从而可以清晰的看到整笔业务的调用逻辑和流程。
###### 开户场景【电子渠道】（三期）
![](media/image8.emf)
###### 补卡场景【营业厅渠道】
![](media/image9.emf)
流程描述：
整个调用链日志的打印以操作员点击菜单请求页面开始：
1、操作员登录CRM系统，点击补卡业务菜单开始受理业务，此时生成本次业务的交易流水，并将交易流水号设置在当前会话的上下文中，用于后续本次业务的每次服务请求中，并且设置序号1作为业务调用开始，后续的调用序列以1开头，后续每次服务调用中涉及新服务端时则后面加1，如1.1、1.1.1、1.1.1.1等。
2、web客户端调用CRM
WAS服务端获取业务请求页面信息，此时为首次服务调用，前台WAS服务端生成本次业务的交易开始埋点。
3、web客户端调用CRM WAS服务端进行用户鉴权，前台WAS再调用后台CRM
CICS服务进行用户鉴权，CRM WAS、CRM
CICS服务生成服务埋点（请求），返回结果，CRM CICS、CRM
WAS服务生成服务埋点（响应）。
4、后续的多个步骤和服务请求，如用户信息查询、人脸识别、业务规则校验、业务辅助校验、选卡及卡号校验、订单算费、订单预生成、订单提交等步骤同上。
5、如果服务请求涉及CRM CICS调用账务CICS服务，CRM
CICS需要在调用前生成服务埋点（请求），接收到处理结果时生成服务埋点（响应）。账务CICS服务接收到CRM
CICS服务请求后，生成服务埋点（请求），处理完业务逻辑返回CRM时，生成服务埋点（响应），内部如果存在服务调用时，同样生成对应的服务埋点（包括请求、响应）。
6、整个业务操作过程中，存在多次界面操作及服务请求，循环上面2、3、4、5步骤生成相应的埋点日志。
7、整个业务操作完成，前台WAS生成交易结束埋点，标识业务操作完成。
说明：每笔业务有一对交易埋点日志，N对服务调用埋点日志，整个业务调用链以交易开始埋点开始到交易结束埋点整个链条中，包括了多对服务调用埋点，并且对服务调用埋点编号，从而可以清晰的看到整笔业务的调用逻辑和流程。
###### 补卡场景【电子渠道】（三期）
![](media/image10.emf)
![](media/image11.emf)
###### 缴费场景【营业厅渠道】
> ![](media/image12.emf)
流程描述：
整个调用链日志的打印以操作员点击菜单请求页面开始：
1、操作员登录CRM系统，点击缴费业务菜单开始受理业务，此时生成本次业务的交易流水，并将交易流水号设置在当前会话的上下文中，用于后续本次业务的每次服务请求中，并且设置序号1作为业务调用开始，后续的调用序列以1开头，后续每次服务调用中涉及新服务端时则后面加1，如1.1、1.1.1、1.1.1.1等。
2、web客户端调用CRM
WAS服务端获取业务请求页面信息，此时为首次服务调用，前台WAS服务端生成本次业务的交易开始埋点。
3、web客户端调用CRM WAS服务端查询用户信息，前台WAS再调用后台CRM
CICS服务查询用户信息，CRM WAS、CRM
CICS服务生成服务埋点（请求），返回结果，CRM CICS、CRM
WAS服务生成服务埋点（响应）。
4、后续的多个步骤和服务请求，如应结账单查询、科目余额、订单提交等步骤同上。
5、如果服务请求涉及CRM CICS调用账务CICS服务，CRM
CICS需要在调用前生成服务埋点（请求），接收到处理结果时生成服务埋点（响应）。账务CICS服务接收到CRM
CICS服务请求后，生成服务埋点（请求），并调用BDS服务进行入账。处理完业务逻辑返回CRM时，生成服务埋点（响应），内部如果存在服务调用时，同样生成对应的服务埋点（包括请求、响应）。BDS入账后会向账务发起充值通知，由账务异步进行信控处理。
6、整个业务操作过程中，存在多次界面操作及服务请求，循环上面2、3、4、5步骤生成相应的埋点日志。
7、整个业务操作完成，前台WAS生成交易结束埋点，标识业务操作完成。
说明：每笔业务有一对交易埋点日志，N对服务调用埋点日志，整个业务调用链以交易开始埋点开始到交易结束埋点整个链条中，包括了多对服务调用埋点，并且对服务调用埋点编号，从而可以清晰的看到整笔业务的调用逻辑和流程。
###### 缴费场景【电子渠道】（三期）
![](media/image13.emf)
###### 停开机场景【营业厅渠道】
![](media/image14.emf)
流程描述：
整个调用链日志的打印以操作员点击菜单请求页面开始：
1、操作员登录CRM系统，点击停开机业务菜单开始受理业务，此时生成本次业务的交易流水，并将交易流水号设置在当前会话的上下文中，用于后续本次业务的每次服务请求中，并且设置序号1作为业务调用开始，后续的调用序列以1开头，后续每次服务调用中涉及新服务端时则后面加1，如1.1、1.1.1、1.1.1.1等。
2、web客户端调用CRM
WAS服务端获取业务请求页面信息，此时为首次服务调用，前台WAS服务端生成本次业务的交易开始埋点。
3、web客户端调用CRM WAS服务端进行用户鉴权，前台WAS再调用后台CRM
CICS服务进行用户鉴权，CRM WAS、CRM
CICS服务生成服务埋点（请求），返回结果，CRM CICS、CRM
WAS服务生成服务埋点（响应）。
4、后续的多个步骤和服务请求，如查询用户信息、人脸识别、业务规则校验、用户停开机信息查询、订单算费、订单预生成、订单提交等步骤同上。
5、如果服务请求涉及CRM CICS调用账务CICS服务，CRM
CICS需要在调用前生成服务埋点（请求），接收到处理结果时生成服务埋点（响应）。账务CICS服务接收到CRM
CICS服务请求后，生成服务埋点（请求），处理完业务逻辑返回CRM时，生成服务埋点（响应），内部如果存在服务调用时，同样生成对应的服务埋点（包括请求、响应）。
6、整个业务操作过程中，存在多次界面操作及服务请求，循环上面2、3、4、5步骤生成相应的埋点日志。
7、整个业务操作完成，前台WAS生成交易结束埋点，标识业务操作完成。
说明：每笔业务有一对交易埋点日志，N对服务埋点日志，整个业务调用链以交易开始埋点开始到交易结束埋点整个链条中，包括了多对服务调用埋点，并且对服务调用埋点编号，从而可以清晰的看到整笔业务的调用逻辑和流程。
###### 停开机场景【电子渠道】（三期）
![](media/image15.emf)流程描述：
整个调用链日志的打印以电子渠道发起业务请求开始。