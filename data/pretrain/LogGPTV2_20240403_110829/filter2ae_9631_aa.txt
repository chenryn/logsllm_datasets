作者：[启明星辰ADLab](https://mp.weixin.qq.com/s/sHfXUj4I0xJqnfJVkjPHOA "启明星辰ADLab")
“螳螂捕蝉黄雀在后，不知树下之弹弓也”。启明星辰ADLab于2017年首先提出一种高效的黑客攻击手段---黑雀攻击，并阐述了黑客生态中的黑雀攻击现象及黑雀分析方法，开创了黑雀生态的研究与分析。我们以现实中存在的一款僵尸网络为例，论述了在黑客生态圈中所存在的三级黑客架构的黑雀攻击现象（大黑雀、黑雀、螳螂），并且发布了长篇深度分析报告《黑雀攻击-揭秘Death僵尸网络背后的终极控制者》；随后我们披露了”比尔盖茨僵尸”黑客生态圈中的黑雀现象，发布了《揭秘Billgates僵尸网络中的黑雀现象》。而随着物联网这块肥肉被黑客盯上后，黑雀也同样盯上了物联网黑客，本文我们将揭露支持物联网攻击与感染的Ddostf僵尸中所存在的“黑雀现象”。
### 一、僵尸物联网黑雀分析简述
启明星辰ADLab在长期的僵尸生态研究分析中发现了一款物联网僵尸被广泛的植入了黑雀。通过对其进行溯源分析确认其是一种支持多CPU平台的Ddostf僵尸网络家族变种。自2016年10月Mirai肆虐美国互联网开始，各路物联网病毒如雨后春笋般层出不穷，Ddostf僵尸也不甘落后，于2017年4月增加了植入黑雀的物联网僵尸，能够感染Arm、Mips、X86架构的物联网设备，传播广泛，危害极大。
该僵尸网络中多个螳螂黑客控制的僵尸网络异常活跃，同时我们监测到隐藏在该僵尸网络的幕后黑雀也在近期现身，分别于2018年9月20日16时59分和9月6日21时23分开始，数次通过UDP
FLOOD和TCP FLOOD向高防服务器 (218. 90. XX.XX、118. 184. XX.XX）发起攻击，导致服务器业务长时间中断。
在分析过程中我们还会分析一些有趣的现象：“毒上加毒”，部分野生黑雀通过技术手段像寄生兽一样感染并附着在僵尸程序上，黑客在发展自身资源的同时，也在无形中帮助野生黑雀进行僵尸网络的扩张。这也使得原本的两级黑客模式演变成了更为复杂的三级黑客模式。文中我们将介绍其黑雀攻击的原理以及这种“毒上加毒”的现象。
通过对Ddostf僵尸网络幕后黑雀的追踪分析和样本抽测，我们共收集到约500个关联样本，其中Arm和Mips架构共262个，物联网僵尸占比超过总样本量的一半。分析显示该黑雀至少控制着184个螳螂僵尸网络，其中大部分螳螂C&C位于中国，但随着国内打击DDoS力度越来越大，许多黑客开始将服务器外迁到网络管控宽松的国家和地区来躲避监查，以下是根据抽样数据绘制的黑雀控制下的螳螂C&C分布地区统计图：
![
](https://images.seebug.org/content/images/2018/09/5b7a2678-f371-4bc6-a996-708642ae6ed3.png-w331s)
同时，我们也对该黑雀控制的我国境内Ddostf僵尸网络螳螂C&C进行了细分，数据显示螳螂C&C分布最多的几个省份和地区依次为香港、北京、江苏、广东、辽宁和贵州等，相关分布图如下所示：
![
](https://images.seebug.org/content/images/2018/09/b992046f-a287-4b08-92cf-1f138eab7436.png-w331s)
### 二、Ddostf bot 简介
Ddostf
bot是当前中国区非常活跃的多硬件平台僵尸网络之一，由国内黑客组织编写，因僵尸程序代码包含“ddostf”而得名，自2015年起大量在黑产社群及论坛发布和售卖。其版本更迭迅速，至2017年4月共进行了8轮更迭。其中最近发布的版本为天罚压力测试系统V8.1，目前该黑客组织关闭了对外接口并停止了程序更新。
Ddostf bot
程序使用C语言编写，最新版本可入侵Windows平台和Linux平台下的Arm、Mips、X86等多种硬件平台架构的设备，相较于传统僵尸病毒，Ddostf对多平台的支持尤其是针对智能设备的攻击使其可以掌握大量的网络资源，无疑会造成更强的破坏力。Ddostf
bot 可针对目标进行12种攻击，包括TCP flood、ICMP flood、UDP flood、SYN flood、HTTP flood、CC
flood等攻击手段。
Ddostf bot在最初的编译文件中预留了黑雀攻击接口，尽管部分下游螳螂黑客发现并去除了该接口，但仍有大量的螳螂中招，成为黑雀扩展资源的免费劳动力。
### 三、黑雀发现
在对黑产僵尸网络的分析过程中，我们发现一款新型的物联网僵尸在物联网设备中快速扩散，随后我们迅速地获取到了该物联网僵尸的样本。通过样本相似度比对发现该样本为Ddostf僵尸的变种（Ddostf僵尸在以往的众多版本中并不支持物联网设备的感染），并且在我们对大量关联样本的批量分析过程中发现，该家族的大部分攻击代码都会连接两个以上C&C控制端，并且其中一个C&C控制端的连接行为异常，如大量样本均会尝试对其进行连接并且做了延迟上线。因此，我们对这些样本进行了进一步分析并最终确认该僵尸生态中被植入黑雀。
针对我们收集到的约500个僵尸样本，绘制样本上线频度占比图如下：
![
](https://images.seebug.org/content/images/2018/09/e28ee106-dbdd-4190-9ac7-b7b3e701de17.png-w331s)
从图中可以看出C&C(v8.ter.tf)上线的频度远高于其他C&C,
根据黑雀可对下游螳螂黑客的攻击样本进行感染的特性，可以判定该僵尸生态中的黑雀即是控制C&C为v8.ter.tf的黑客。
### 四、黑雀样本分析
由于Ddostf僵尸支持多架构平台，我们在分别对Windows和Linux平台的样本进行分析后发现，两类平台均存在黑雀攻击的现象，但作者对黑雀C&C的加密处理有所不同。其中Windows端采用了较为复杂的自定义加密算法，Linux端则采用了Base64的方式进行编码，两种不同难度的加密隐藏方式也造成黑客在去除黑雀后门时的难度有所不同。我们分别统计了两个平台受到黑雀攻击（带有后门）的样本占该平台总样本的比例。
![
](https://images.seebug.org/content/images/2018/09/831dc262-06bd-4aa9-9220-0cb1f64b7bb5.png-w331s)
可以看到受攻击的Windows平台的样本占比明显高于Linux平台，也即Windows端肉鸡受黑雀控制比例更高。
通过对该黑雀的信息追踪，我们发现了该黑雀最近发布的v8.1版本控制端和配置小马，并以此为例对其Linux和Windows两类平台的样本进行简要分析。
![
](https://images.seebug.org/content/images/2018/09/29284ef8-91da-4144-94d0-44c58036bf0f.png-w331s)
#### 4.1 Linux平台样本
Linux端样本包含X86、ARM和MIPS三种硬件平台，但其主要逻辑的实现并无太大差别。黑雀在程序中均使用硬编码的方式存储字符串"djgudGVyLnRm"，通过Base64解码后可得到域名“v8.ter.tf”。僵尸程序在开始阶段会校验字符串"djgudGVyLnRm"是否匹配，若不匹配则打印“不要试图破坏程序!”并重启系统。我们在《启明星辰ADLab联合电信云堤揭秘Billgates僵尸网络中的黑雀现象》一文中提出过“偷梁换柱”的攻击现象，即其它黑雀通过攻击黑雀接口来实现C&C的替换。依此我们从僵尸程序校验黑雀C&C字符串这一模块可以看出，程序作者也意识到了这一问题，并希望尽可能避免黑雀接口遭到破坏。只是其手段并不高明，许多螳螂黑客通过反编译找到黑雀加密域名和验证字符串，同时更改或采用Patch的方式依然能够破坏接口，实现黑雀攻击。
![
](https://images.seebug.org/content/images/2018/09/2e281820-cb8a-44ad-9e79-2a03b23f036b.png-w331s)
    验证成功后僵尸程序会进行如下操作：
    1.权限判定
    通过JudgeIfRoot函数依据文件/proc/cpuinfo可读性判定进程是否ROOT。
    2.进程互斥
    若进程权限为ROOT且启动时有参数传递，则通过readlink函数获取自身绝对路径，执行"ps -e"查看进程是否已运行，否则退出。