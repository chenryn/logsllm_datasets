    7    private                         
    4    gov                           
    5    air                           
    3    intelsat                      
    2    adhealthcheck                 
    1    *.ps1                         
    0    global
图5. 从用户`NTUSER.DAT`注册表文件中提取的`WorldWheelQuery`键值
通过`WorldWheelQuery`注册表键值，我们根据`MRUListEx`顺序发现`passw`这个关键词在用户资源管理器的最近搜索历史记录中排名第二位。`MRUListEx`是注册表中的一个值，按顺序给出了最近常被访问的一些元素，本质上就是资源管理器中的搜索顺序。`passw`同时也是特殊LNK文件的文件名，该文件中还包含`Search
Results in Local Disk
(C:)`字符串（如图3所示）。根据这些细节，我们似乎能推测这些LNK文件的创建与用户资源管理器的搜索行为有关。因此，我们将这些文件标记为“用户搜索LNK文件”。
## 0x03 抽丝剥茧
当我们使用用户资源管理器搜索历史记录中包含的关键词在系统中搜索LNK文件后，我们发现这些词都与用户搜索LNK文件有关。我们识别出了这类LNK文件以及相应的文件创建和修改时间戳，如图6所示。需要注意的是，虽然我们通过`WorldWheelQuery`注册表键值找到了15个搜索结果，但只找到了4个用户搜索LNK文件。
    2019-11-09 08:33:14    Created Modified
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\gov.lnk
    2019-11-09 09:29:11    Created
    2019-11-09 09:29:37    Modified
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\private.lnk
    2019-11-09 08:38:29    Created
    2019-11-13 06:47:56    Modified
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\passw.lnk
    2019-11-13 06:57:03    Created
    2019-11-13 06:57:25    Modified
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\Secret.lnk
图6. `WorldWheelQuery`资源管理器搜索关键词所对应的LNK文件
此外，我们还注意到有一些LNK文件的创建时间相同，并且这些文件具有相似的文件名。比如，有两个LNK文件的创建时间都为`2019-11-09 08:38:29
UTC`，如图7所示。
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\passw.lnk
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\password.lnk
图7. 创建时间相同的LNK文件
进一步测试后，我们发现当用户使用资源管理器搜索，并且打开搜索结果中的文件后，系统就会创建用户搜索LNK文件。如果用户没有打开搜索结果中的文件，系统就不会创建用户搜索LNK文件。
在这个案例中，`password.lnk`文件中包含目标文件元数据（与正常LNK快捷方式文件所包含的数据类似），也引用了`T:\`目录中名为`password.txt`的目标文件。前文提到过，`passw.lnk`只包含用户搜索LNK文件元数据，包括绝对路径`Search
Folder\passw`，也引用了`Search Results in Local Disk (C:)`。然而，这种目录上的差异点其实一点也不意外。
LNK快捷文件中包含最近访问文件的元数据，我们发现这一点同样适用于用户搜索LNK文件。根据`passw.lnk`不同的创建及修改时间戳，我们可知用户至少在另一种情况下搜索过`passw`（但我们并不清楚这两次搜索间是否还有其他搜索行为），并且从搜索结果中打开过一个文件。我们可以在图8中的`passw`用户搜索LNK文件中，通过查看时间戳来确认这一点：
    2019-11-09 08:38:29    Created
    2019-11-13 06:47:56    Modified
    C:\Users\\AppData\Roaming\Microsoft\Windows\Recent\passw.lnk
图8. `passw.lnk`创建及修改时间戳
第二次搜索`passw`的行为发生在2019年11月13日。在这次搜索中，用户再次使用Windows资源管理器来搜索`passw`关键词，但这次是在`C:\`驱动器上下文中搜索（即在本地磁盘`C:`中搜索），然后点击名为`password2.txt`的文档。LECmd对`password2.lnk`的分析结果如图9所示（这里为了保证结果清晰及保护客户隐私，我们隐去了部分信息）。需要注意的是，用户搜索LNK文件中包含的信息同样包含在同时创建的LNK快捷方式文件中。`passw.lnk`的搜索上下文以及`password2.lnk`的完整文件路径位置都一样，均为`C:\`。
    LECmd version 1.3.2.1
    Author: Eric Zimmerman (PI:EMAIL)
    https://github.com/EricZimmerman/LECmd
    --- Header ---      Target created:  2015-11-09 22:14:10
      Target modified: 2010-01-11 16:57:11
      Target accessed: 2015-11-09 22:14:10
      File size: 19
      Flags: HasTargetIdList, HasLinkInfo, HasRelativePath, HasWorkingDir, IsUnicode, DisableKnownFolderTracking
      File attributes: FileAttributeArchive
      Icon index: 0
      Show window: SwNormal (Activates and displays the window. The window is restored to its original size and position if the window is minimized or maximized.)
    Relative Path: ..\..\..\..\..\..\..\\password2.txt
    Working Directory: C:\
    --- Link information ---    Flags: VolumeIdAndLocalBasePath, CommonNetworkRelativeLinkAndPathSuffix
    >>Volume information
      Drive type: Fixed storage media (Hard drive)
      Serial number: 
      Label: (No label)
      Network share information
        Share name: \\\
        Provider type: 
        Share flags: ValidNetType
      Local path: C:\\
      Common path: \password2.txt
    --- Target ID information (Format: Type ==> Value) ---    
      Absolute path: Search Folder\passw\password2
      -Users property view ==> Search Folder
      >> Property store (Format: GUID\ID Description ==> Value)
         d5cdd505-2e9c-101b-9397-08002b2cf9ae\AutoList  ==> VT_STREAM not implemented (yet) See extension block section for contents for now
         d5cdd505-2e9c-101b-9397-08002b2cf9ae\AutolistCacheTime  ==> 1849138729510
         d5cdd505-2e9c-101b-9397-08002b2cf9ae\AutolistCacheKey  ==> Search Results in Local Disk (C:)0
      -Variable: Users property view ==> passw
      >> Property store (Format: GUID\ID Description ==> Value)
         1e3ee840-bc2b-476c-8237-2acd1a839b22\2      (Description not available)         ==> VT_STREAM not implemented
         1e3ee840-bc2b-476c-8237-2acd1a839b22\8      (Description not available)         ==> passw
         28636aa6-953d-11d2-b5d6-00c04fd918d0\11     Item Type                           ==> Stack
         28636aa6-953d-11d2-b5d6-00c04fd918d0\25     SFGAO Flags                         ==> 805306372
         b725f130-47ef-101a-a5f1-02608c9eebac\10     Item Name Display                   ==> passw
      -Variable: Users property view ==> password2
      >> Property store (Format: GUID\ID Description ==> Value)
         49691c90-7e17-101a-a91c-08002b2ecda9\3      Search Rank                         ==> 0
         28636aa6-953d-11d2-b5d6-00c04fd918d0\25     SFGAO Flags                         ==> 1077936503
         28636aa6-953d-11d2-b5d6-00c04fd918d0\32     Delegate ID List                    ==> VT_VECTOR data not implemented (yet) See extension block section for contents for now
         28636aa6-953d-11d2-b5d6-00c04fd918d0\11     Item Type                           ==> .txt
         28636aa6-953d-11d2-b5d6-00c04fd918d0\24     Parsing Name                        ==> password2.txt
         446d16b1-8dad-4870-a748-402ea43d788c\100    Thumbnail Cache Id                  ==> 7524032674880659487
         1e3ee840-bc2b-476c-8237-2acd1a839b22\12     (Description not available)         ==> Null
         1e3ee840-bc2b-476c-8237-2acd1a839b22\20     (Description not available)         ==> 1
         1e3ee840-bc2b-476c-8237-2acd1a839b22\3      (Description not available)         ==> document
         1e3ee840-bc2b-476c-8237-2acd1a839b22\17     (Description not available)         ==> {1685D4AB-A51B-4AF1-A4E5-CEE87002431D}.Merge Any
         1e3ee840-bc2b-476c-8237-2acd1a839b22\8      (Description not available)         ==> C:\\password2.txt
         b725f130-47ef-101a-a5f1-02608c9eebac\4      Item Type Text                      ==> Text Document
         b725f130-47ef-101a-a5f1-02608c9eebac\10     Item Name Display                   ==> password2
         b725f130-47ef-101a-a5f1-02608c9eebac\12     Size                                ==> 19
         b725f130-47ef-101a-a5f1-02608c9eebac\14     Date Modified                       ==> 01/11/2010 16:57:11
         006fdbaa-864f-4d1c-a8e8-e62772e454fe\11     (Description not available)         ==> 59
         006fdbaa-864f-4d1c-a8e8-e62772e454fe\13     (Description not available)         ==> 1077936423
         cf5be8c0-236c-4ad3-bace-cd608a2748d7\100    (Description not available)         ==> True
         e3e0584c-b788-4a5a-bb20-7f5a44c9acdd\6      Item Folder Path Display            ==> C:\
    --- End Target ID information ---    
    --- Extra blocks information ---    
    >> Property store data block (Format: GUID\ID Description ==> Value)
       (Property store is empty)
    >> Tracker database block
       Machine ID: 
       MAC Address: 
       MAC Vendor: VMWARE
       Creation: 2019-11-13 04:29:24
       Volume Droid: 
       Volume Droid Birth: 
       File Droid: 
       File Droid birth: 
图9. `LECmd.exe`对`password2.lnk`的分析结果
这里要注意的是，用户搜索LNK文件只与搜索关键字有关，与搜索上下文无关。这意味着再一次搜索同一个关键词时（比如`passw`），用户在搜索结果中打开了文件，但由于处在不同的驱动器及目录中，因此更改了用户搜索LNK文件的修改时间戳及其中包含的搜索上下文。这与LNK快捷方式文件保持一致，这类文件只依赖简单文件名，而非完整文件路径。
## 0x04 时间戳
根据Windows注册表中`WorldWheelQuery`键值的结构以及可用的时间戳信息，之前取证人员只能使用注册表键值的最近修改时间来确定最近搜索关键词的搜索时间。根据我们对用户搜索LNK文件的分析，现在如果用户在搜索关键词后，从结果中打开了某个文件，那么取证人员就可以使用新的时间戳来判断精确的搜索时间。如果更进一步，我们可以将用户搜索LNK文件与`WorldWheelQuery`
`MRUlistEx`注册表键值结合起来，推测用户执行的搜索顺序。比如，由于上文案例中用户搜索了`gov`（`WorldWheelQuery`索引值为`4`）、`passw`（索引值`6`）以及`private`（索引值`7`），我们可以推测出用户还搜索过`air`（索引值为`5`），但没有从搜索结果中打开任何文件。
## 0x05 总结
LNK快捷方式文件已经是一种可靠的取证方法，可以用来判断用户对文件及相关文件元数据的访问时间。通过用户搜索LNK文件，现在我们可以进一步丰富资源管理器的搜索历史，当用户执行搜索操作并打开搜索结果文件后，我们就获得更详细的时间戳信息。