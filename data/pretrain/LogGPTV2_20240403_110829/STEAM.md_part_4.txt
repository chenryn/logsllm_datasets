putethecosinesimilarityof(A,B)and(A,C).If(A,B)showsa
allbethesame.(iii):latency:Wedenotetheend-to-endduration
highersimilaritythan(A,C),thepredictioniscorrect,otherwise,
ofthetraceasthelatency.Sincethelatencyisnotadiscretevalue,
thepredictioniswrong.TheevaluationmetricisAccuracy,which
webucketizeitintomultiplebins(e.g.,lessthan200ms,200-400ms,
istheratiobetweenthesizeofcorrectlypredictedtripletsandtotal
etc.)basedonthelatencydistribution.(iv):combo:Sincethe(i)-
triplets.
(iii) cover different perspectives of the trace, we combine them
The results are presented in Table 3. It shows that STEAM
togethertodenotetracetypescoveringoperation,structure,and
achievesthebestperformanceonallfourbenchmarkapplications,
latency.Foreachabove-mentionedperspective,wecancomputethe
demonstrating that the GNN model indeed learned to compare
coverageandentropy,respectively.Withoutexplicitspecification,
tracesimilarityafterinfusingthedomainknowledge.Theresults
thesamplingrateinallexperimentsis1%.
metourexpectationsasthemodeltrainingisdirectlyguidedby
differentiatingthetracetriplets(A,B,C).Incontrast,otherbaseline Coverageandentropyonbenchmarkapplications. Fig.5presents
methodscanonlyleveragetheintrinsicyetsuperficialinformation thecoverageresults.Itshowsthatourmethodachievesthehigh-
intracesandtherebydonotperformwell.Surprisingly,PERCH, estscoresonallmicroserviceapplications,especiallyonthemost
whoserepresentationistheoccurrencecountembeddings,shows challengingcomboperspective.Forexample,STEAMcoversover
relativelygoodaccuracy.Wesuspectthattheeventcountvector 90%ofdifferenttypesoftracesregardingoperation,structure,la-
cancapturethetracedifferenceinstructuretoacertainextent. tencyandcomboontheTrainTicketapplication.Onthecontrary,
1756
ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA ShilinHe,BotaoFeng,LiqunLi,XuZhang,YuKang,QingweiLin,SaravanRajmohan,andDongmeiZhang
Figure8:Overheadoftracesamplingmethods(left)andscal-
abilityofSTEAMwhenvaryingtheclusternumber(right).
Coverageandentropyforspan-levelattributes. Above-mentioned
perspectivesarefromthecompletetracelevel,suchasthestructure.
However, there are certain perspectives that describe the trace
Figure 6: Entropy of different sampling methods on four
basedoneachspan,e.g.,IPaddress.Arequestisusuallyfinished
benchmarkmicroserviceapplications.
bypassingthroughmultiplehostmachinesorpods,andthespans
inatraceoftenhavedifferentIPs.WeevaluatedwhetherSTEAM
cansampletracesthatcoverthespan-levelattributes.Weusethe
setofIPsofallspanstodescribeatrace.Inagiventracedataset,
therearemanypossibleIPsets.TheresultsareshowninTable4.
ItshowsthatbothSTEAMandContrastcanachieve100%IPset
coverage,outperformingthanotherbaselinesgreatly.TheContrast
workswellbecauseitlearnstodistinguishdifferentIPaddresses
byrandomlymaskingmanyattributes,includingtheIP.Moreover,
STEAMachievesahigherentropyscorethantheContrast.
Figure 7: Coverage (left) and entropy (right) of sampling 5.4 Overhead
undervarioussamplingrates. Inthissection,weevaluatedtheefficiencyofSTEAMandthescala-
bilitywhentheparallelismisenabled.Theefficiencyismeasuredby
howmuchtimeeachmethodtakestomakethesamplingdecision.
theuniformsamplingretainsonlyaround28%ofdifferenttrace
Weexcludedthedatapreprocessingtimeforallmethods.Allexper-
typesforcombo.AsFig.6shows,ourmethodalsooutperformsall
imentsarerepeatedfivetimeswithresultsreportedafteraveraging.
baselinemethodsontheentropymetricforthefourmicroservice
Moreover,allthemodelinferencesareconductedonCPUmachines
applications.Comparedtotheuniformsampling,STEAMkeepsa
ratherthanGPUstomimicthepracticaldeployment.Thesampling
muchmorebalancedsizeoftracesinthesetypes,asdenotedbyits
isbasedonthetesttraces(58,110traces)ofTrainTicket,andthe
higherentropy.Notethattheentropyoflatencyismuchsmaller
samplingrateisconfiguredas1%with581tracessampledfinally.
thanotheraspectssincethenumberoflatencybinsissmall.
Therefore,thesamplinglatencyisthenthetotalexecutiontime
Coverage and entropy under different sampling ratios. On the dividedbythenumberofsampledtraces(namely581traces).
TrainTicketapplication,wevariedthesampleratetoseehowthe Fig.8(left)showseachmethod’ssamplinglatencyinmillisec-
samplingperformancechangesbydifferentmethods.Theresults onds.SincePERCHisbuiltontopofclustering,itssamplinglatency
areshowninFig.7.ItshowsthatSTEAMachieves100%coverage ismuchhigherthanothermethods.AstheContrastmethodalso
(on“Combo”)whenthesamplingratioislargerthan5%.Forother leveragestheGNNmodel,thetimespentontracerepresentationis
methods,ittakesmuchhighersamplingratiotoachievethesame almostthesameasours,butthetimeusedforsamplingisoptimized
results.Besides,whenincreasingthesamplingratio,theentropy withthefastDPPcomponentinSTEAM.Siftershowsgreatsam-
ofSTEAMfirstincreasesthendecreases.Recallthatthetracedata plingefficiencyclosetoours,butitdemonstratespoorsampling
isextremelyimbalanced,thoseminoritytracescouldalreadybe effectiveness(coverageandentropyinSec.5.3).Onaverage,our
completelysampledatalowsamplingratio.Whenincreasingthe methodachievesalowlatencyofaround15milliseconds.Addi-
samplingratio,onlythemajoritytraceswouldbeadded,therefore, tionally,whenend-to-enddeployedinonlineenvironmentwith
thedistributionbecomesimbalanceandlowerstheentropy. OpenTelemetry,STEAMcanprocessabout15,000tracesinabout4
secondswithasinglecollectorinstance.
Table4:CoverageandentropyonIPaddressinTrainTicket. SincefastDPPinSTEAMisaparallelmethod,wethenevaluated
theend-to-endscalabilityofSTEAMbyvaryingtheclusternumber.
Name Uniform Sifter PERCH Contrast STEAM TheresultsarepresentedinFig.8(right).Theclusternumberof1
meansthevanillaDPPwithoutparallelism.Itshowsthatthesam-
Entropy 3.65 5.72 3.74 5.86 6.23
plinglatency(theblueline)decreasesquicklywiththeincreaseof
Coverage 0.47 0.65 0.47 1.00 1.00
clusternumbers.Forexample,samplingwhentheclusternumberis
setto16is2xfasterthansamplingwithvanillaDPP.Moreover,we
1757
STEAM:Observability-PreservingTraceSampling ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA
Figure9:Thelatencydistributionoftracessampledviadif-
ferentmethods(x-axisinlogscale)
Figure11:Detectinganddiagnosingtheperformanceissue
(top)andfailure(bottom)basedonthesampledtraces.
whichoftenrepresentcommon-caseexecution.Moreover,wecan
Figure10:Thestatuscodedistributionoftracessampledvia
findthatPERCHandSifteralsosampledmoreabnormaltraces(i.e.,
differentmethods(y-axisinlogscale)
withlargelatency),butnotasmanyasourmethod.
.
Similarly,Fig.10showsthedistributionofstatuscodesintraces
sampledbyvariousmethods.The“Others”representsstatuscodes
findthatthesamplinglatencyconvergestoarelativelystablevalue fromnon-HTTPrequests.Mosttracesreturnthesuccessstatus
whentheclustersizeexceeds16.Itisbecausethattheclustering code“200”whileotherstatuscodestogetheroccupyasmallportion.
processwilltakesmoretimeonthelimitedtestdataifthecluster Therefore,itischallengingtosamplethesecorner-casestatuscodes,
numberishigher.Wealsoobservethatthesamplingeffectiveness anduniformsamplingfailstosamplethemout.WithSTEAM,we
(yellowline)ofSTEAMisnotdamagedwhenincreasingthesam- cansamplemorediversestatuscodes,including“201”,“500”,and
plingefficiency.Itmightbecausedbythatthedensityevaluation “Others”.However,formethodssuchasuniformandPERCH,there
accuratelyimplieseachcluster’ssamplingbudgetandenablesthe isalmostnostatuscodeof“500”or“Others”intheirsampledtraces.
samplingindependently. Siftercansamplemoreabnormaltraces(i.e.,“Others”category)
thanotherapproaches,whichconformstoourintuition.
5.5 TraceSamplingwithFaults
Detectionanddiagnosisonsampledtraces. Acommonwayto
Inthissection,weevaluatewhethertracesamplingcanperform
monitortheservicehealthstatusistosetupanalertbasedonthe
well under critical scenarios (i.e., when failure or performance
timeseriesofmetrics,forexample,P95-latencyfordetectingperfor-
issuehappens)andpreservetheobservability.Toachieveso,we
manceissuesanderrorcount(basedonstatuscode)fordetecting
injectedfaultstofivecoreservicesoftheTrainTicketapplication
failures.Ifthevalueishigherthanapredefinedthreshold,analert
andthencollectadditionaltraces.Thecoreservicesareidentified
willbetriggered.Inthispart,wesampletracesinastreamingway
bycheckingthemicroservicearchitectureandtracesafterapilot
(every1minute)andthenextractmetricsfromthesampledtraces
run.Tomimicthereal-worldscenario,weenabled3podreplicasfor
(namely,P95latencyandthecountoftracescontainingerroneous
eachcoreservice.Weinjectedtwokindsoffaultsintothesystem
statuscode)fordetection.Indiagnosis,weapplythesameworkflow
bythechaosengineeringtoolChaosMesh[31]:(i)PodFailure:we
todifferentservicesandidentifythefailedservices.
injectedfaulttoatargetpodandmadeitunavailable;(ii)Network
Fig.11(top)showstheP95latencycalculatedbasedontraces
Delay:thenetworkisinjectedwithaone-seconddelay.Wefirstrun
sampledbydifferentmethodsontwoservices.STEAMcansam-
theapplicationsinnormalstatesfor7minutesandtheninjectthe
plemorelong-latencytracesandtheP95latencyishigherthan
faultsforanother7minutes.Wecollectthetracesinbothperiods.
otherbaselinemethods.Forinstance,intherightfigure,themaxi-
Forthefollowingexperiments,weonlyshowtheresultsontwo
mumP95latencybyuniformsamplingisaround20ms,whiletraces
services:basic-serviceandtravel-serviceduetothepagelimits,but
withalargerlatencyaremissed.Anotherinterestingfindingis
theconclusionsstillholdontheotherthreeservices.
thatourmethodshowstheP95latencyspikeearlier(timeat“9”)
Tracedistributiononlatencyandstatuscode. Wefirstpresent thanallothermethods(timeafter“11”),indicatingitspotential
thelatencydistributionoftracesthataresampledusingdifferent todetectpossibleperformanceissuesearlier.Besidesindiagnosis,
samplingmethods.AsFig.9shows,STEAMisabletosampletraces thelong-latencytracescanbepreserved,whichtherebyallowsus
ofdifferentlatencywithamoreevenprobability(y-axis).Onthe totroubleshootthebottleneckservice.Moreover,Fig.11(bottom)
contrary,thetraceswithoutsampling(denotedas“Origin”)and presentsthenumberoferrorsfromtracesaftersampling.Likethe
withuniformsamplingaremoreconcentratedonsmalllatency, P95latency,STEAMsampledmoreproblematictracesoutthan
1758
ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA ShilinHe,BotaoFeng,LiqunLi,XuZhang,YuKang,QingweiLin,SaravanRajmohan,andDongmeiZhang
distribution(e.g.,comparingtrendsbasedontracesaggregations).
Instead,itfitsverywellthescenarioswheretheminoritytraces
areimportant(e.g.,rootcauseanalysis).
7 RELATEDWORK
Distributed tracing has been widely accepted as a fundamental
component or infrastructure to enhance the system observabil-
Figure12:Evaluationofsamplingonproductiontraces.
ity[6,16,28,37].X-Traceisatracingframeworkwithafocuson
othermethodsatanearlystage.WealsoobservedthatSifterob- applicationsthatcrossdifferentnetworklayers.Dapper[37]shows
tainserrortracesafterthetime“12”,whichoutperformsallother Google’sdistributedtracingsysteminalarge-scaleproductionen-
methods.However,thespikeappearslaterthanours. vironment.Canopy[16]isdesignedbyFacebooktorecordcausally
relatedperformancedataacrosstheentirerequestflowpath.In
5.6 TraceSamplingonProductionTraces recentyears,manyopen-sourcetracingframeworks[15,23,33]