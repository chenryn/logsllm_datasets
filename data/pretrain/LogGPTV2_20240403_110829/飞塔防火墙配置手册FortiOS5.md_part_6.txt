名字：自定义，用于标识。
应用控制: 设备该流控脚本如何被策略应用
每条策略： 每个使用该脚本的策略独立进行流控。
比如有10条策略引用了5M的流控脚本，那么每条策略均可以使用5M的带宽。
所有使用这个流量控制的策略：所有使用该脚本的策略共同进行流控。
比如有 10条策略引用了 5M的流控脚本，那么所有策略内的用户共同使用这 5M 的带
宽，即这10条策略流量加起来不会超过5M
流量优先级：
Fortinet公司 59 / 118 www.fortinet.com.cn
防火墙接口上定义了6个FIFO队列，0-5,0为最高优先级，5为最低。
0 队列用于防火墙的管理，vpn协商等，所有由防火墙发起，或者到达防火墙的流量会
自动被放入队列0中，最优先被转发。
对于防火墙转发的在策略中使用traffic shaper功能的流量，其优先级可以分为高、中、
低三个级别，级别高的流量会优先被防火墙转发。分别对应于转发对队列的1,2,3，即：
高（队列1）、中（队列2）、低（队列3）
可以根据业务类型进行分类，将VOIP等业务设置为高优先级，http, pop3,sntp，OA系
统等配置为中优先级，其他的业务放入低优先级。
如果策略中未指定任何级别的优先级，则默认被放入高优先级。
最大带宽：
该策略所能达到的最大带宽，单位kbps。当流量超过该闸值的时候，超过流量的数据
包会被丢弃。配置为0 ，则意味着最大带宽不受限制。
保证带宽：
该策略能够得到的保证带宽。当流量低于该值的时候，数据包会被放入到队列0 中，
也就是获得最优先的转发，保证该业务占用的最少带宽数量。不建议对非关键业务配置该参
数。
当策略占用带宽介于最大带宽和保证带宽之间的时候，则按照策略内定义的优先级进
行转发。
DSCP：是否使用DSCP差分服务代码点，其用于整个网络中配置端点到端点的QOS服务。
5.3.3. 每 IP 流量控制
进入如下页面进行配置：
Fortinet公司 60 / 118 www.fortinet.com.cn
脚本：
config firewall shaper per-ip-shaper
edit "1M"
set diffserv-forward disable
set diffserv-reverse disable
set max-bandwidth 1000
set max-concurrent-session 200
next
end
名字： 自定义
最大带宽：策略内的每个ip所能够使用的最大带宽，为上行和下行流量总和。
最大并发连接数： 匹配该策略的每个用户所能够发起的最大连接数。超过该连接数后，用
户无法建立新的连接。
正向DSCP：是否使用DSCP 差分服务代码点，用于整个网络中配置端点到端点的QOS 服
务
反向DSCP：是否使用DSCP 差分服务代码点，用于整个网络中配置端点到端点的QOS 服
务
5.4. 配置 session-ttl
会话生存时间，即会话建立后无任何数据传送情况下的存活时间，默认为 3600 秒，当
该会话在超时之前有任何数据匹配该会话，则该会话ttl计时器复位到该数值，如3600秒。
1) 配置全局session-ttl
Fortinet公司 61 / 118 www.fortinet.com.cn
config system session-ttl
set default 604800 //300-604800秒(最大为7天)
end
2) 全局指定服务端口session-ttl
config port
edit 1320
set protocol 6
set timeout 1800
set end-port 1320 //起始端口
set start-port 1320 //结束端口
next
end
3) 策略session-ttl
config firewall policy
edit 1
set srcintf "internal"
set dstintf "wan1"
set srcaddr "all"
set dstaddr "all"
set action accept
set schedule "always"
set service "ANY"
set session-ttl 604800
set nat enable
next
end
Fortinet公司 62 / 118 www.fortinet.com.cn
4) 服务对象session-ttl
定义不同的对象，虽然同为23端口，可以配置指定不同的session-ttl时间。
config firewall service custom
edit "telnet"
set protocol TCP/UDP/SCT
set tcp-portrange 23
set session-ttl 7200
next
edit "telnetnew"
set protocol TCP/UDP/SCTP
set tcp-portrange 23
set session-ttl 3600
next
end
5) session-ttl的优先级
低   高
全局session-ttl sink: org pre->post, reply pre->post dev=11->5/5->11 gwy=192.168.118.8/192.168.1.110
hook=post dir=org act=snat 192.168.1.110:50298->192.168.118.8:23(192.168.118.28:38130)
hook=pre dir=reply act=dnat 192.168.118.8:23->192.168.118.28:38130(192.168.1.110:50298)
pos/(before,after) 0/(0,0), 0/(0,0)
misc=0 policy_id=1 id_policy_id=0 auth_info=0 chk_client_info=0 vd=0
serial=00005ff1 tos=ff/ff ips_view=0 app_list=0 app=0
dd_type=0 dd_rule_id=0
per_ip_bandwidth meter: addr=192.168.1.110, bps=167
total session 1
session info:
proto=6 协议类型6为TCP ，1为ICMP, 17为UDP。
proto_state=07 TCP状态，代码为7,close wait状态。
duration=333 会话持续时间
expire=101 超时时间，与proto_stat状态相关
timeout=3600 session ttl.
Fortinet公司 68 / 118 www.fortinet.com.cn
4) 查看某个IP相关会话总数
Fortigate # dia sys session filter src 192.168.1.110 //查看源地址为192.168.1.110的会话
Fortigate # diagnose sys session list | grep total //根据filtger过滤条件查看会话总数