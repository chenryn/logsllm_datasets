Jailbreaking the 3DS 
@smealum(
Intro to 3DS 
”Old”(3DS(line 
What’s a 3DS? 
New(3DS(line 
3DS(XL 
2DS 
New(3DS(XL 
3DS 
New(2DS(XL 
New(3DS 
•  Out(starting(2014(
•  CPU:(4x(ARM11(MPCore((804MHz)(
•  GPU:(DMP(PICA(
•  RAM:(256MB(FCRAM,(6MB(VRAM(
•  IO/Security(CPU:(ARM946(
•  Hardware-based(backwards(
compatible(with(DS(games(
•  Fully(custom(microkernel-based(OS(
•  Out(starting(2011(
•  CPU:(2x(ARM11(MPCore((268MHz)(
•  GPU:(DMP(PICA(
•  RAM:(128MB(FCRAM,(6MB(VRAM(
•  IO/Security(CPU:(ARM946(
•  Hardware-based(backwards(
compatible(with(DS(games(
•  Fully(custom(microkernel-based(OS(
Memory 
CPUs 
Devices 
ARM9(
ARM11(
FCRAM(
WRAM(
VRAM(
ARM9(
internal(
GPU(
CRYPTO(
NAND(
3DS hardware overview 
Runs(games,(apps,(menus(–(everything(you(can(see(and(play(with(
Brokers(access(to(storage,(performs(crypto(tasks((decryption,(authentication)(
Memory 
CPUs 
Devices 
ARM9(
ARM11(
FCRAM(
WRAM(
VRAM(
ARM9(
internal(
GPU(
CRYPTO(
NAND(
ARM9: access to almost everything 
Memory 
CPUs 
Devices 
ARM9(
ARM11(
FCRAM(
WRAM(
VRAM(
ARM9(
internal(
GPU(
CRYPTO(
NAND(
ARM11: more limited access to hardware 
ARM11 Kernel 
Home Menu 
NS 
fs 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture 
ARM11 Kernel 
Home Menu 
NS 
fs 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture: system call access control 
ARM11 Kernel 
Home Menu 
NS 
fs 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture: system call access control 
ARM11 Kernel 
Home Menu 
NS 
fs 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture: system call access control 
ARM11 Kernel 
Home Menu 
NS 
fs 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture: services 
gsp::Gpu(
fs:USER(
hid:USER(
fs:USER(
gsp::Gpu(
hid:USER(
ARM11 Kernel 
Home Menu 
AM 
fs 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture: service access control 
am:sys(
fs:USER(
hid:USER(
am:sys(
gsp::Gpu(
hid:USER(
gsp::Gpu(
am:sys(
fs:USER(
hid:USER(
gsp::Gpu(
fs:USER(
ARM11 Kernel 
Home Menu 
AM 
pxi 
GSP 
HID 
System calls 
APPLICATION memory region 
SYSTEM memory region 
BASE memory region 
Game 
The ARM11’s microkernel architecture: service access control 
am:sys(
fs:USER(
hid:USER(
am:sys(
gsp::Gpu(
hid:USER(
gsp::Gpu(
fs:USER(
hid:USER(
gsp::Gpu(
pxi:am9(
pxi:am9(
ARM9 land 
Memory 
CPUs 
Devices 
ARM9(
ARM11(
GPU(
CRYPTO(
NAND(
Physical memory region separation 
APPLICATION( SYSTEM( BASE(
FCRAM(
K/P9(
Kernel11(
WRAM(
VRAM(
ARM9(
internal(
Anatomy of a 3DS “jailbreak” 
1.  Compromise(a(user-mode(game(or(app(
2.  Escalate(privilege(to(expand(attack(surface(
3.  Compromise(ARM11(kernel(
4.  Compromise(ARM9(
Getting code execution 
Where do we start? 
Previous 3DS entrypoints 
Cubic Ninja 
•  Vulnerable(custom(level(parser(
•  Levels(shareable(over(QR(codes…(
•  No(ASLR,(no(stack(cookies(etc.(makes(file(format(
bugs(fair(game(
(
Web Browsers 
•  3DS(has(a(built-in(browser(
•  ASLR,(stack(cookies(etc.(have(never(stopped(a(
browser(exploit(
•  Nintendo’s(threat(model(should(assume(
compromised(user-mode(
(
mcopy 
SMBv1(protocol(
def$_sendSMBMessage_SMB1(self,$smb_message):$
$$$$...$
$$$$$$$$input$=$smb_message.encode()$
$$$$$$$$output$=$[]$
$
$$$$$$$$#$TMP$FUZZ$TEST$
$$$$$$$$for$i$in$range(len(input)):$
$$$$$$$$$$$$val$=$input[i]$
$$$$$$$$$$$$if$randint(1,$1000)$<$FUZZ_thresh:$
$$$$$$$$$$$$$$$$mask$=$(1$<<$randint(0,$7))$
$$$$$$$$$$$$$$$$val$^=$mask$
$$$$$$$$$$$$output$+=$[val]$
$$$$$$$$#$END$TMP$FUZZ$TEST$
$
$$$$$$$$smb_message.raw_data$=$bytes(output)$
$$$$...$
$$$$self.sendNMBMessage(smb_message.raw_data)$
The worst SMB fuzzer ever written 
•  Bug(finding(strategy:(fuzzing(
•  Used(github.com/miketeo/pysmb(
•  Had(to(adjust(some(code(to(make(
it(compatible(with(mcopy(
•  Added(6(lines(of(fuzzing(code…(
Attacking mcopy 
Insert(fuzz(crash(video(here((~30s(or(less)(
Initial fuzz crash: Wireshark trace 
“Fuzzer”(
3DS(
Negotiate(protocol(request(
NTLMSSP_NEGOTIATE(request(
Negotiate(protocol(response(
NTLMSSP_AUTH(request(
NTLMSSP_CHALLENGE(response(
Initial fuzz crash: protocol diagram 
00000000"
00000008"
00000010"
00000018"
00000020"
00000028"
00000030"
00000038"
00000040"
00000048"
00000050"
00000058"
00000060"
00000068"
00000070"
00000078"
00000080"
00000088"
00000090"
00000098"
000000A0"
000000A8"
000000B0"
000000B8"
000000C0"
000000C8"
000000D0"
000000D8"
000000E0"
000000E8"
ÿSMBs...$
..AÈ....$
........$
..ì.¸’..$
.ÿ....A.$
.......¬$
.....T..$
€
±.NTLMSS
P.......
..@.....
..X.....
..š.....
..p.....
..x.....
..Š....
‚ŠàF.Þ–:
‘Â......
........
....¤Øý|
KëDŒÑ.;
%¹¨*f”vs
i¥à.U.s.
e.r.L.O.
C.A.L.H.
O.S.T..‡
lÈI9Ì‰&h
/.ºŠ=EW.
O.R.K.G.
R.O.U.P.
.....$
FF$53$4D$42$73$00$00$00$
00$18$41$C8$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$EC$0F$B8$92$03$00$
0C$FF$00$00$00$04$41$0A$
00$01$00$00$00$00$00$AC$
00$00$00$00$00$54$00$00$
80$B1$00$4E$54$4C$4D$53$
53$50$00$03$00$00$00$18$
00$18$00$40$00$00$00$18$
00$18$00$58$00$00$00$12$
00$12$00$9A$00$00$00$08$
00$08$00$70$00$00$00$12$
00$12$00$78$00$00$00$10$
00$10$00$8A$00$00$00$15$
82$8A$E0$46$0C$DE$96$3A$
91$C2$18$00$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$00$16$A4$D8$FD$7C$
4B$EB$44$8C$D1$0C$3B$25$
B9$A8$2A$66$94$76$73$69$
A5$E0$2E$55$00$73$00$65$
00$72$00$4C$00$4F$00$43$
00$41$00$4C$00$48$00$4F$
00$53$00$54$00$17$87$6C$
C8$49$39$CC$89$26$68$2F$
90$BA$8A$3D$45$57$00$4F$
00$52$00$4B$00$47$00$52$
00$4F$00$55$00$50$00$00$
00$00$00$00$00$
0x0000:$SMB(magic(number(
0x0004:$SMB(command((0x73:(Sessions(Setup(AndX)(
$...(
0x002F:$Security(blob(size((0xAC(bytes)(
$...(
0x003B:$Security(blob(magic(number(
$...(
0x005F:$Username(data(descriptor(
$$0x00:$Data(length((0x08)(
$$0x02:$Maximum(data(length((0x08)(
$$0x04:$Data(offset((0x00000070)(
$...(
0x00AB:$Username(data((“User”)(
Initial fuzz crash: normal packet 
00000000"
00000008"
00000010"
00000018"
00000020"
00000028"
00000030"
00000038"
00000040"
00000048"
00000050"
00000058"
00000060"
00000068"
00000070"
00000078"
00000080"
00000088"
00000090"
00000098"
000000A0"
000000A8"
000000B0"
000000B8"
000000C0"
000000C8"
000000D0"
000000D8"
000000E0"
000000E8"
ÿSMBs...$
..AÈ....$
........$
..ì.¸’..$
.ÿ....A.$
.......¬$
.....T..$
€
±.NTLMSS
P.......
..@.....
..X.....
..š.....
..p.....
..x.....
..Š....
‚ŠàF.Þ–:
‘Â......
........
....¤Øý|
KëDŒÑ.;
%¹¨*f”vs
i¥à.U.s.
e.r.L.O.
C.A.L.H.
O.S.T..‡
lÈI9Ì‰&h
/.ºŠ=EW.
O.R.K.G.
R.O.U.P.
.....$
FF$53$4D$42$73$00$00$00$
00$18$41$C8$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$EC$0F$B8$92$03$00$
0C$FF$00$00$00$04$41$0A$
00$01$00$00$00$00$00$AC$
00$00$00$00$00$54$00$00$
80$B1$00$4E$54$4C$4D$53$
53$50$00$03$00$00$00$18$
00$18$00$40$00$00$00$18$
00$18$00$58$00$00$00$12$
00$12$00$9A$00$00$00$08$
00$08$00$70$00$00$08$12$
00$12$00$78$00$00$00$10$
00$10$00$8A$00$00$00$15$
82$8A$E0$46$0C$DE$96$3A$
91$C2$18$00$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$00$16$A4$D8$FD$7C$
4B$EB$44$8C$D1$0C$3B$25$
B9$A8$2A$66$94$76$73$69$
A5$E0$2E$55$00$73$00$65$
00$72$00$4C$00$4F$00$43$
00$41$00$4C$00$48$00$4F$
00$53$00$54$00$17$87$6C$
C8$49$39$CC$89$26$68$2F$
90$BA$8A$3D$45$57$00$4F$
00$52$00$4B$00$47$00$52$
00$4F$00$55$00$50$00$00$
00$00$00$00$00$
0x0000:$SMB(magic(number(
0x0004:$SMB(command((0x73:(Sessions(Setup(AndX)(
$...(
0x002F:$Security(blob(size((0xAC(bytes)(
$...(