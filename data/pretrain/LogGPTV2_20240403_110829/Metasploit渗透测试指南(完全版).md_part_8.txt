[*]Scanned 155 of 256 hosts (060% complete)
[*]192.168.1.180's IPID sequence class: All zeros
[*] 192.168.1.181's IPID sequence class: Incremental!
[*] 192.168.1.185's IPID sequence class: All zeros
[*]192.168.1.184's IPID sequence class:Randomized
[*]Scanned 232 of 256 hosts (090% complete)
[*] Scanned 256 of 256 hosts (100% complete)
[*]Auxiliary moduleexecution completed
msf auxiliary(ipidseq)>
通过对扫描结果进行分析，我们发现有多个空闲主机可用于空闲扫描。我们尝试在nmap
msf auxiliary(ipidseq) > nmap -PN -sI 192.168.1.109 192.168.1.155
[*] exec: nmap -PN -sI 192.168.1.109 192.168.1.155
Idle scan using zombie 192.168.1.109 (192.168.1.109:80); Class: Incremental
Interesting ports on 192.168.1.155:
Not shown: 996 closed|filtered ports
PORT
STATE SERVICE
135/tcp open msrpc
139/tcp opennetbios-ssn
445/tcp open microsoft-ds
MAC Address:00:0C:29:E4:59:7C (VMware)
Nmap done: 1 IP address (1 host up) scanned in 7.12 seconds
msf auxiliary(ipidseq)>
使用空闲扫描，我们可以不用自身IP地址向目标主机发送任何数据包，就能获取到目标主
机上开放的端口信息。
23
---
## Page 51
Metasploit渗透测试指南
3.在MSF终端中运行Nmap
现在我们已经掌握了获取目标信息的高级技巧，下面让我们把nmap和Metasploit结合起来
使用。首先我们需要连接到msfbook数据库：
msf>db_connectpostgres:toor@127.0.0.1/msf3
自动将nmap结果存储在数据库中。
提示：本例中我们只攻击一个主机，但是你可以使用CIDR标记或地址段标记指定多个
IP地址（例如：192.168.1.1/24或192.168.1.1-254）
msf > db_nmap -sS -A 172.16.32.131
Warning: Traceroute does not support idle or connect scan, disabling...
Nmap scan report for 172.16.32.131
Host is up (0.00056s latency).
Not shown:990 closed ports
PORT
STATE SERVICE
VERSION
21/tcp Oopen ftp
Microsoft ftpd
25/tcp
open
smtp
Microsoft ESMTP 6.0.2600.2180 @
80/tcp
open
http
Microsoft IIS webserver 5.1
I_html-title:
135/tcp
open
Microsoft Windows RPC
139/tcp
open
netbios-ssn
443/tcp
open
https?
445/tcp
open
microsoft-ds
Microsoft Windows XP microsoft-ds
1025/tcp openn
msrpc
Microsoft Windows RPC
1433/tcp openn
ms-sql-s
Microsoft SQL Server 2005 9.00.1399; RTM
3389/tcp open microsoft-rdp Microsoft Terminal Service
MACAddreSS:00:0C:29:EA:26:7C(VMware)
Device type: general purpose
Running: Microsoft Windows XP|2003 ③
OS details: Microsoft Windows XP Professional SP2 or Windows Server 2003
Network Distance: 1 hop
Service Info: Host: ihazsecurity; OS: Windows
Host script results:
I_nbstat: NetBIOS name:IHAZSECURITY,NetBIOS user:,NetBIOS MAC:Oo:Oc:29:ea:26:7C
|smb-os-discovery:
OS:Windows XP(Windows 2000 LAN Manager)
Name:WORKGROUP\IHAZSECURITY
1_smbv2-enabled: Server doesn't support SMBv2 protocol
Nmap done: 1 IP address (1 host up) scanned in 33.51 seconds
我们会注意到扫描结果中包含一系列开放的端口●、软件版本·、甚至是对目标操作系统
类型的猜测。
24
---
## Page 52
第3章情报搜集
可以执行db_services命令来查看数据库中的关于系统上运行服务的扫描结果。
msf > db_services
Services
host
port
proto name
stateinfo
172.16.32.131
135
tcp
msrpc
open
Microsoft Windows RPC
172.16.32.131
139
tcp
netbios-ssn
open
172.16.32.131
445
tcp
microsoft-ds
open
MicrosoftWindowsXPmicrosoft-ds
172.16.32.131
777
tcp
unknown
open
172.16.32.131
1433
tcp
ms-sql-s
open
Micr0s0ftSQLServer20059.00.1399;RTM
至此我们已经描绘出了目标的大致轮廊，其中包含可作为攻击点的对外开放端口。
3.2.3使用Metasploit进行端口扫描
在Metasploit中不仅能够使用第三方扫描器，而且在其辅助模块中也包含了几款内建的端
口扫描器。这些内建的扫描器在很多方面与Metasploit框架进行了融合，在辅助进行渗透攻击
方面更具有优势。在后面的章节中，我们将会演示利用这些内建扫描器和已攻陷的内网主机，
获取内网的访问通道并进行攻击，这样的渗透攻击过程通常称为跳板攻击，它使我们能够利用
网络内部已攻陷的主机，将攻击数据路由到原本无法到达的目的地。
举例来说，假设你攻陷了一台位于防火墙之后使用网络地址转换（NAT）的主机。这台主
机使用无法从Internet直接连接的私有IP地址。如果你希望能够使用Metasploit对位于NAT后
方的主机进行攻击，那么你可以利用已被攻陷的主机作为跳板，将流量传送到网络内部的主
机上。
可以输入如下命令查看Metasploit框架提供的端口扫描工具：
msf>search portscan
下面我们使用Metasploit的SYN端口扫描器对单个主机进行一次简单的扫描。首先输入
usescanner/portscan/syn，然后设定RHOsT参数为192.168.1.155，设定线程数为50，最后
执行扫描。
msf>use scanner/portscan/syn
msf auxiliary(syn)> set RH0STS 192.168.1.155
RHOSTS => 192.168.1.155
msf auxiliary(syn) > set THREADS 50
THREADS => 50
25
---
## Page 53
Metasploit渗透测试指南
msf auxiliary(syn)>run
O[*] TCP OPEN 192.168.1.155:135
[*]TCP OPEN 192.168.1.155:139
[*] TCP 0PEN 192.168.1.155:445
[*]Scanned 1 of 1hosts(100% complete)
[*]Auxiliarymodule execution completed
msf auxiliary(syn)>
从结果中的0处能看到，我们利用Metasploit的portscan/syn模块在IP地址为192.168.1.155
的主机上发现了135、139和445端口是开放的。
3.3针对性扫描
在渗透测试工作中，你不必为寻找取胜捷径而感到一丝羞愧，这就是为什么要介绍针对性
扫描的原因。针对性扫描是指寻找目标网络中存在的已知可利用漏洞或能够轻松获取后门的特
定操作系统、服务、软件以及配置缺陷。举例来说，在目标网络中快速地扫描存在MS08-067
漏洞的主机是非常普遍的活动，因为MS08-067（仍然）是一个普遍存在的安全漏洞，并且能够
让你很快地取得SYSTEM的访问权限，比起扫描出整个网络中所有漏洞后再攻击要容易得多。
3.3.1服务器消息块协议扫描
Metasploit可以利用它的smb_version模块来遍历一个网络，并获取Windows系统的版本号。
提示：如果你对服务器消息块协议（SMB：一个通用的文件共享协议）不熟悉，那么在
继续阅读之前，请对这个协议进行一下基本的了解。你需要掌握关于协议和端口的一些基础
知识，才能弄明白如何成功地对一个系统进行渗透攻击。
下面我们执行这个模块，列出参数，并对RHOSTS参数值进行设定，然后开始扫描：
msf>use scanner/smb/smb_version
msf auxiliary(smb_version)>showoptions
Module options:
Name
Current SettingRequiredDescription
RHOSTS
yes
The target address range or CIDR identifier
THREADS1
yes
The number of concurrent threads
msfauxiliary(smb_version)>set RH0STS 192.168.1.155
RHOSTS => 192.168.1.155
msf auxiliary(smb_version)> run
(name:D00KIE-FA154354)(domain:WORKGR0UP)
[*]Scanned 1of 1hosts(1o0%complete)
[*]Auxiliarymoduleexecutioncompleted
26
---
## Page 54
第3章情报搜集
如你所见，在O处smb_version扫描器准确地判断出目标操作系统是WindowsXP，且安装
了ServicePack2补丁。因为此例中我们只扫描了一台主机，所以使用了默认的线程（THREAD）
参数1。如果是对一个大规模网络进行扫描，例如C类IP地址段，可以考虑使用setTHREAD
线程数增加扫描线程的数量以加快扫描速度。扫描结果将保存在Metasploit的数据库中以便后
续使用，可以使用db_hosts命令查看数据库中保存的结果。
msf auxiliary(smb_version) > db_hosts -c address,os_flavor
Hosts
address
os_flavor Svcs vulns Workspace
192.168.1.155WindowsXP30default
msf auxiliary(smb_version)>
我们并未进行大规模的扫描便发现了一个运行着WindowsXP操作系统的主机。当渗透测
试工作需要避免流量过大引起对方警觉的时候，这是一种快速且安全比定位高风险主机的方法。
3.3.2搜寻配置不当的MicrosoftSQLServer
配置不当的MicrosoftSQLServer（MS SQL）通常是进入目标系统的第一个后门。实际上，
很多系统管理员甚至不知道在他们的工作站上安装有MSSQL服务器软件，因为它经常作为其
他常用软件（如MicrosoftVisualStudio）安装的先决条件被自动地安装在系统上。在这些情况
下安装的MSSQL服务器软件通常没有实际的用处，也很少安装补丁程序，甚至从未进行过配置。
MSSQL安装后，它默认监听在TCP端口1433上或使用随机的动态TCP端口。如果在随
机的TCP端口上进行MSSQL监听，只需要简单的对UDP端口1434进行查询，便能获取这个
随机的TCP端口号。当然，Metasploit有一个模块mssql_ping可以帮助你来做这件事。
由于mssql_ping使用UDP协议，在对大规模的子网进行扫描时它的速度可能会很慢，这是
因为要处理超时的问题。但是在一个局域网中，设置线程数为255将极大地提高扫描速度。当
Metasploit发现MSSQL服务器的时候，它会将所有能够获取的关于服务器的信息都显示出来，
其中最为重要的可能就是服务器监听的TCP端口号。
以下展示了使用mssql_ping的整个过程，包括启动扫描模块、列出模块参数、设置参数以
及扫描结果显示。
msf>usescanner/mssql/mssql_ping
msf auxiliary(mssql_ping) > show options
Module options:
Name
Current Setting Required Description
-··....-
PASSWORD
no
Thepasswordfor the specifiedusername
RHOSTS
yes
The target address range or CIDR identifier
27
---
## Page 55
Metasploit渗透测试指南
THREADS
1
yes
Thenumber of concurrent threads
USERNAME
sa
no
The username toauthenticate as
WORKSPACE
no
The name of the workspace to report data into
msfauxiliary(mssql_ping)>setRH0STS 192.168.1.0/24
RHOSTS => 192.168.1.0/24
msf auxiliary(mssql_ping)> set THREADS 255
THREADS => 255
msf auxiliary(mssql_ping)>run
O[*]SQLServer informationfor 192.168.1.155:
[*]
ServerName
=V-XPSP2-BARE
[*]@
InstanceName