Red Team Ops with CS: Operations
0x00 前言
CS的作者Raphael Mudge有2套公开视频，非常值得学习，一个是18年的《In-memory Evasion》，一
个是19年的《Red Team Operations with Cobalt Strike》。前段时间再次观看了《In-memory 
Evasion》并作了相应笔记，而《Red Team Operations with Cobalt Strike》始终没有完整的看过一
遍，正好这次一口气搞完。学习一定要做笔记，能写出工具的一定要写成工具。
《Red Team Operations with Cobalt Strike》这个课程分为了9个部分，分别是：
Operations（运营）
Infrastructure（基础设施）
C2（命令和控制）
Weaponization（武器化构建）
Initial Access（初始化权限获取）
Post Exploitation（后利用）
Privilege Escalation（权限提升）
Lateral Movement（横向移动）
Pivoting（中转）
在第一部分运营中，作者先介绍了以邮件钓鱼为例子的整个攻击链和攻击链上防御手段，然后讲解了“逃
逸思想”，最后是解释了一些CS的运营相关的知识。
0x01 攻击链以及相应防御手段
作者以邮件投递钓鱼为例讲解整个攻击链，邮件钓鱼一直是APT中最常见的初始化权限获取手法，以此
为例非常合适，下图是我整理的整个攻击链以及相应防御手段：
真的是一路过关斩将，太不容易了，恶意邮件投递会经过以下防御手段：
如果你DMARC、DKIM、SPF等邮件发送服务器没有配置好，很有可能被反垃圾邮件和反钓鱼邮件
过滤自动拦截。
mail antivirus gateway or sandbox，沙箱技术会自动打开你的附件或者访问邮件中的url，然后判
断是否是恶意。
当邮件附件落地后，会有各式各样的终端安全产品（A/V）来一波静态的和简单的动态分析
如果主机上有应用白名单策略，你这个来源不明的可执行程序还需要绕过应用白名单策略，用什么
白加黑之类的手法。
植入体执行起来会有各种进程、线程、内存操作，然后反病毒产品，各种EDR就开始记录你的相关
行为，稍微不注意就触发恶意规则，然后被拦截上报
过了这一关，接下来就是出网问题，防火墙策略、代理上网、域名分类、域名白名单等等限制C2出
网。
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-09-28
No. 1 / 5 - Welcome to www.red-team.cn
同时网络监控设备一直分析监控流量，稍微流量异常就可能触发告警。
即使过了这一次，威胁情报对域名和IP、样本等分析，例如C2的TeamServer被全网测绘识别了，
导致IP被标记。
植入体正常启动运行并回连以后，就是后利用了，例如：横向移动、截屏、键盘记录、本机信息收
集、网络信息收集等等，每一个行为都可能被EDR做侦测，被EDR云端的机器学习、人工分析给标
记为恶意。
要完成一次成功的红队行动，前期既要完整的bypass所有防御，后期还要思考驻留办法，防止被云端分
析样本存活时间太短。
0x02 逃逸哲学
作者讲到这个部分的时候，非常有共鸣，他有一下观点：
CS不是一个魔法棒，不可能对抗你所遇到的所有防御和场景。
但是：CS提供了选择+扩展
如何成功逃逸（Evasion）
理解你所使用的工具和它产生的行为（知己）
评估和理解防御机制（知彼）
做出一个最好的选择，然后执行（评估执行）
通过”如果成功逃逸“这3点总结，其实就是一个红队人员的成长路径，先学会理解使用各种攻击工具、然
后学习理解防御机制、再修改攻击方法bypass防御机制，最后在知己知彼以后做出一个最佳选择。红队
行动就是在不停的重复”了解目标、选择攻击方法、抉择并执行攻击方法“的过程中完成的。
0x03 CS运营相关知识
CS的使命和愿景
使命：弥补渗透测试工具和高级威胁恶意软件之间的差距
愿景：有用的、可信的对手模拟工具
培育身经百战的安全分析师
驱动客观的有意义的安全提升
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-09-28
No. 2 / 5 - Welcome to www.red-team.cn
培训安全专业人才和高级威胁策略的决策者
分散操作
作者分享了一些最佳实践，用多个TeamServer做功能分离
作者建议最好分开搭建3个TeamServer用作不同目的:
Staging
用作初始化权限时候的Teamserver，可能你是钓鱼或者其他方式获取的初始化权限，你会在
上面使用提权或者横向移动等等操作，由于你开始对目标环境不是很熟悉，难免会触发告警，
这个teamserver被发现的可能基本上是100%，因此在被发现之前尽快横向移动到其他机器，
然后建立long haul的Teamserver，也就是我们说的潜伏通道。
long haul
潜伏通道，基本不做任何操作，再红队行动的生命周期中保持存活，防止其他通道失败的时
候，还可以唤起新的post-ex通道。
潜伏通道保持着低速的回连频率
post-ex
这个是后利用通道，就是执行各种命令操作横向移动的通道。
这是单个目标的最佳时间，如果同时服务于多个目标的红队评估，作者提供了如下的最佳实践：
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-09-28
No. 3 / 5 - Welcome to www.red-team.cn
Target Cell
负责具体的目标网络
获取权限、后利用和横向移动
维护本目标的此次任务的基础设施
Access Management Cell
保存所有目标网络的权限
获取权限和接受Target Cell给的权限
当Target Cell权限掉了的时候，给Target Cell新的权限
维护全局的基础设施为了持久化回连
团队人员配置
在当前的高强度的攻防对抗中，一个人很难在短时间内完成大量的评估演练工作，因此团队化作战是必
然的情况，作者给了他自己的思考和最佳实践。
Access(打点)组
主要是初始化立柱点获取，他们主要的工作就是初始化权限获取的武器化，和横向移动的武器
化
Post-Exploitation(后利用)组
主要信息收集、数据挖掘、用户监控、键盘记录、截屏等等，在目标网络中寻找最终目标（靶
标）
Local Access Manager(shell Sherpa)权限维持组
管理回连
配置基础设施
持久化权限维持
和Access Management Cell保持沟通
这个团队人员配置，说的是target cell的配置，尼玛，这经验不愧是从老美空军出来的大哥。一看就是见
过大场面的。上面人员配置中组可能就是一个人或者多个人。其中权限维持组和全局的权限维持团队沟
通。整体人员配置看，在权限控制这一块儿都投入了大量人员和精力。也非常符合实战中，权限控制是
整个行动中的难点的特征。
0x04 总结
这第一部分其实和CS相关的知识并不多，大部分是讲红队相关东西，非常的干货，从攻击链到红队团队
人员分配，很多结论都是实际经验中总结出来的，收获颇丰。我省略了视频中关于Beacon、Malleable 
C2、Aggressor Script以及log和report相关的基础功能介绍。本部门总体来看，都是作者的经验总结出
来的最佳实践，非常值得学习，不管实在红队评估还是攻防演练中都非常有借鉴意义，结合自身团队实
际情况，灵活的配置团队技术能力。
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-09-28
No. 4 / 5 - Welcome to www.red-team.cn
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-09-28
No. 5 / 5 - Welcome to www.red-team.cn