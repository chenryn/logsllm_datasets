# 红队操作与Cobalt Strike

## 0x00 前言
Cobalt Strike (CS) 的作者Raphael Mudge提供了两套非常值得学习的公开视频课程：2018年的《In-memory Evasion》和2019年的《Red Team Operations with Cobalt Strike》。我最近重新观看了《In-memory Evasion》并做了相应的笔记，但《Red Team Operations with Cobalt Strike》一直没有完整地看过一遍，这次决定一次性完成学习。做笔记是学习过程中不可或缺的一部分，尤其是将工具编写成实际可用的程序。

《Red Team Operations with Cobalt Strike》这门课程分为九个部分：
1. 运营（Operations）
2. 基础设施（Infrastructure）
3. 命令与控制（C2）
4. 武器化构建（Weaponization）
5. 初始权限获取（Initial Access）
6. 后利用（Post Exploitation）
7. 权限提升（Privilege Escalation）
8. 横向移动（Lateral Movement）
9. 中转（Pivoting）

在第一部分“运营”中，Mudge先介绍了以邮件钓鱼为例的攻击链及其防御手段，然后讲解了逃逸思想，并解释了一些关于CS运营的知识。

## 0x01 攻击链及相应防御手段
### 邮件钓鱼攻击链
邮件钓鱼一直是APT中最常见的初始权限获取手法。以下是整个攻击链及其对应的防御措施：

1. **邮件投递**：
   - 如果DMARC、DKIM、SPF等邮件发送服务器配置不当，邮件可能会被反垃圾邮件和反钓鱼邮件过滤自动拦截。
   
2. **附件或URL检查**：
   - 沙箱技术会自动打开附件或访问邮件中的URL，判断是否为恶意内容。
   
3. **终端安全产品**：
   - 终端安全产品（如A/V）会对附件进行静态和简单的动态分析。
   
4. **应用白名单策略**：
   - 如果主机上有应用白名单策略，来源不明的可执行文件需要绕过这些策略，例如使用“白加黑”手法。
   
5. **进程和内存操作**：
   - 植入体执行时，会有各种进程、线程和内存操作，反病毒产品和EDR会记录相关行为，稍有不慎就可能触发恶意规则。
   
6. **出网问题**：
   - 防火墙策略、代理上网、域名分类、域名白名单等限制C2出网。
   - 网络监控设备会持续分析流量，异常流量可能触发告警。
   
7. **威胁情报**：
   - 即使通过了上述所有关卡，威胁情报也可能对域名、IP和样本进行分析，导致C2的TeamServer被全网测绘识别并标记。

### 后利用
植入体正常启动运行并回连后，进入后利用阶段，包括横向移动、截屏、键盘记录、本机信息收集、网络信息收集等。每一个行为都可能被EDR侦测，并被云端机器学习和人工分析标记为恶意。

要成功完成一次红队行动，前期需完整绕过所有防御，后期还需考虑驻留方法，防止样本存活时间太短。

## 0x02 逃逸哲学
Mudge在这个部分的观点很有共鸣：
- CS不是一个万能的魔法棒，无法对抗所有防御和场景。
- 但是，CS提供了选择和扩展的可能性。

### 如何成功逃逸
1. **理解你所使用的工具及其产生的行为**（知己）
2. **评估和理解防御机制**（知彼）
3. **做出最佳选择并执行**（评估执行）

这三点总结实际上是一个红队人员的成长路径：先学会使用各种攻击工具，然后学习理解防御机制，再修改攻击方法绕过防御机制，最后在知己知彼的情况下做出最佳选择。红队行动就是在不断重复“了解目标、选择攻击方法、抉择并执行”的过程中完成的。

## 0x03 CS运营相关知识
### CS的使命和愿景
- **使命**：弥补渗透测试工具和高级威胁恶意软件之间的差距。
- **愿景**：成为有用的、可信的对手模拟工具，培养身经百战的安全分析师，推动客观且有意义的安全提升，培训安全专业人才和高级威胁策略的决策者。

### 分散操作
Mudge分享了一些最佳实践，建议使用多个TeamServer进行功能分离：
1. **Staging**：
   - 用于初始权限获取时的TeamServer，可能通过钓鱼或其他方式获取权限。由于对目标环境不熟悉，容易触发告警，因此尽快横向移动到其他机器，并建立潜伏通道。
   
2. **Long Haul**：
   - 潜伏通道，基本不做任何操作，在红队行动的生命周期中保持存活，以防其他通道失败时唤起新的post-ex通道。潜伏通道保持低速的回连频率。
   
3. **Post-Ex**：
   - 后利用通道，用于执行各种命令操作和横向移动。

### 多目标红队评估的最佳实践
- **Target Cell**：
  - 负责具体的目标网络，获取权限、后利用和横向移动，维护本目标的此次任务的基础设施。
  
- **Access Management Cell**：
  - 保存所有目标网络的权限，获取和接受Target Cell给的权限，当Target Cell权限丢失时提供新的权限，维护全局基础设施以确保持久化回连。

### 团队人员配置
- **Access组**：
  - 主要负责初始化立柱点获取，包括初始化权限获取的武器化和横向移动的武器化。
  
- **Post-Exploitation组**：
  - 主要负责信息收集、数据挖掘、用户监控、键盘记录、截屏等，在目标网络中寻找最终目标。
  
- **Local Access Manager (Shell Sherpa) 组**：
  - 管理回连，配置基础设施，维持持久化权限，并与Access Management Cell保持沟通。

这种团队配置显示了在权限控制方面的大量投入，符合实战中权限控制是整个行动难点的特点。

## 0x04 总结
第一部分主要讲述了红队相关的内容，干货满满，从攻击链到红队团队人员分配，许多结论都是实际经验总结出来的。虽然这部分与CS相关的知识不多，但非常有价值，无论是在红队评估还是攻防演练中都有很高的借鉴意义。结合自身团队实际情况，灵活配置团队技术能力，可以更好地应对各种挑战。

Produced by AttackTeamFamily - Author: L.N. - Date: 2021-09-28