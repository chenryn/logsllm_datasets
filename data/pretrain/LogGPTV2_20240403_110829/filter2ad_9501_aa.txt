**作者：karmayu、murphyzhang @云鼎实验室  
公众号：  
相关阅读：[密码学幼稚园 | 密码朋克的社会实验（二）](https://paper.seebug.org/778/ "密码学幼稚园 |
密码朋克的社会实验（二）")**
…… 2018年3月8日，某视频网站800余万用户数据在暗网销售 2018年8月1日，某省1000万学籍数据出现在暗网
2018年8月28日，某酒店集团5亿数据疑似在暗网出售 ……
本年度最严重的几次数据泄漏，都指向了同一个词——“ **暗网**
”。在中文的语境里，这是一个犹如“月黑风高夜”般的词汇，透着诡秘和犯罪的气息。而与“暗网”关系最密切的另一个词，则非“黑客”莫属。“黑”与“暗”的组合，意味着高超的匿名和隐身技巧，令人忍不住想揭开它精巧的面纱。
### **暗网是什么**
要解释暗网，先给整个互联网做一个简单的分层定义，如图：
图片来源网络
**表网（Surface Web）**
通常认为，普通用户或者搜索引擎能直接访问的内容属于表网。表现形式为网页或者 APP 提供的内容。
**深网（Deep Web）**
指不能被标准搜索引擎检索到的网络数据。通常是存储在各公司或组织的数据库中，需要用专有的接口查询或干脆不对外查询，例如 Google
的后端数据库。深网数据量远大于表层网络，犹如海面和大海的关系。
**暗网（Dark Web）**
需要通过特殊的加密通道访问的网页或数据。暗网通常具有匿名的特性，既保证访问者的匿名，同时也保证服务提供者的匿名。因此，其中充斥着各种犯罪信息和违法交易（枪支、毒品、色情、暴恐、黑客等）。
暗网有多个不同的实现版本，下文我们说暗网特指“Tor 网络”。
网络上有些说法说暗网远大于表层网络，其实很不严谨，是把深网和暗网混为一谈了，真实的暗网只有一小部分人使用，远小于大众使用的表层网络。
### **谁创造了暗网**
**密码朋克**
故事要从90年代的一个极小众群体说起——“密码朋克”。这是一个由顶尖数学家、密码学家和程序员组成的群体，他们关注“匿名、自由、隐私”，其中许多人抱着自由主义和无政府主义的理念，并在美国掀起了“加密无政府主义运动”，他们以密码学和互联网为武器，与强权展开直接对抗。
正是这群人，创造了许多加密技术和协议，也奠定了互联网的许多底层技术和通信协议，从加密邮件到 HTTPS，从 RSA 到区块链，等等等等。
![
](https://images.seebug.org/content/images/2018/12/f587a454-5159-4963-9c52-458364ad8a7b.png-w331s)
图片来源网络
**国外政府部门**
花开两朵，密码朋克们希望保护自己的信息和隐私不被政府获取；而政府同样也有这个需求，甚至更强烈得多，因为他们要保证情报的传输安全，同时要保护情报人员传递信息时无法被网络追踪。因此，1995年，美国海军研究实验室也进行了匿名网络的相关项目研究，这也就是暗网的前身。
2004年，“Tor
洋葱网络”正式对外发布，意味着普通用户也可以使用匿名网络技术来保证自己的匿名性。也就代表着“暗网”这个概念正式走向公众。为什么叫洋葱网络，因为其中的通信内容被三重加密，像洋葱一样，剥开一层还有一层。
![
](https://images.seebug.org/content/images/2018/12/b99a954e-c9c8-44ca-9c75-b2c23b49bb53.png-w331s)
Tor
网络虽然理论上比较安全，但其中的中转节点是由志愿者部署，如果掌握了其中足够的节点，也是有概率进行完整通信追踪的。而且这毕竟是孵化自美国海军的一个项目，是否有一些精心构造的安全缺陷，难以确认。
**暗网上的数据泄露**
一个能保证访问者和服务提供者都匿名的网络，天生就是法外之地。
因此，各路违法信息交流充斥暗网，尤其是2011年后，由于比特币技术的兴起，暗网终于从“匿名的信息交流”进化到了“匿名的价值交换”阶段，这个颠覆性变革，随着“Silk
Road”的建立（丝绸之路：可以理解为基于比特币的暗网淘宝），掀起了违法交易的高潮。当然，大概同时也掀起了 FBI 相关部门的加班高潮。
很巧的是，同样是2011年底，国内发生了一轮标志性的大规模的用户数据泄漏事件，之后各种数据泄漏就成为了每年的常态。早期此类数据交易往往是黑客私下交易，而近年来逐渐被搬到暗网进行交易。为此，腾讯安全云鼎实验室对暗网的主要交易平台进行了监测，并抽取了近几个月针对国内用户的数据泄漏的情况进行了统计。
![
](https://images.seebug.org/content/images/2018/12/8be3cb38-e103-4d0e-87ff-47189ac6e19a.png-w331s)
可以看到，近期泄漏数据，主要以网购/物流/身份证/酒店/社交帐号数据为主。
### **暗网上的业务**
暗网最大的几个市场均在近年被 FBI 捣毁，如 Silk
Road、AlphaBay，因此，2017年来暗网黑市有所收敛，并不如前几年火爆。我们统计了目前存在的几大市场商品分类，可以看出，毒品/药物类还是占据了超过50%的份额，海外使用违禁药物的情形非常严峻，其次是数字商品类，并充斥着各种色情、黑客、枪支、护照、假钞等违法内容。
![
](https://images.seebug.org/content/images/2018/12/69e7de0a-0007-4d00-8b69-1fd0f9c75236.png-w331s)
### **暗网匿名原理**
暗网最重要的作用是保证匿名，其匿名性体现在两个方面：
  * 访问普通网站时，网站无法得知访问者 IP 地址。
  * 提供暗网服务时，用户无法得知服务器 IP 地址。
两个能力加起来则保障了暗网用户访问暗网网站时，双方都无法得知对方 IP 地址，且中间节点也无法同时得知双方 IP 地址。
听起来挺科幻的，毕竟我们平时使用的 VPN 等科学上网技术只使用了一层跳板，而 Tor 技术使用了三层跳板。
关于 VPN 的原理，可以参考下图：
![
](https://images.seebug.org/content/images/2018/12/b690bc51-ed52-42e6-9f49-622d6e489e41.png-w331s)
VPN 原理图解 | 图片来源网络
下面对暗网匿名原理进行详细解析：
**访问普通网站**
先来看一个真实访问普通网站的跳转情况：
![
](https://images.seebug.org/content/images/2018/12/3ba69d49-b162-4704-a906-654e99ba60b7.png-w331s)
从上图可以看到，我们使用浏览器访问 google.com，但中间经过了3个节点 IP 地址，分别在匈牙利、西班牙、德国，然后再访问到谷歌的服务器。
Tor 用户针对普通网站访问流程，如下图所示。Tor网络中的每个节点都是随机选取，且每个节点看到的信息不超过一跳，所以通过网络流量监控嗅探到的 Tor
流量不能同时获取通信两端的IP信息；且每一个节点处都是加密形式。这里随机选取的三个节点的功能顺序是：入口节点、中间节点、出口节点；数据流方向为：客户端、入口节点、中间节点、出口节点、WEB服务器。
![
](https://images.seebug.org/content/images/2018/12/c87958ee-39d9-4c82-8d5d-8cd488bcdca9.png-w331s)
Tor 网络有其特有的加密方式--三层密钥加密。三层密钥的建立是在网络请求的初始，当和下一个节点连接时创建一对非对称密钥，三个随机节点共创建了三对密钥并将公钥回传到客户端。数据经客户端三层密钥加密后，进行Tor
网络的传输，每经过一个节点，便解开一层加密，顺序依次为：入口节点解开第一层加密，中间节点解开第二层加密，出口节点解开第三层加密。通过层层加密让流量监控无法嗅探明文数据。
**访问匿名网站**
先来看一次真实访问匿名网站的跳转情况：
从上图可以看到，我们通过浏览器尝试访问一个奇怪的域名（uffti3lhacanefgy.onion），但和前面普通网站不一样的是，中间经过了6个节点，其中前3个可见
IP，另外3个命名为 Relay，然后再访问到那个奇怪的域名。
这个访问匿名网站的流程比较复杂，在普通互联网上，当我们知道网站域名时，通过 DNS 协议解析到 IP 地址，然后访问。但 Tor 网络域名是 .onion
为后缀，并不是使用普通的 DNS 方式来解析，而是使用下面的方法。
下面我们结合 torproject.org 网站介绍的洋葱服务协议、业界约定俗成的各个环节的名称、及上面的原理图进行 Tor