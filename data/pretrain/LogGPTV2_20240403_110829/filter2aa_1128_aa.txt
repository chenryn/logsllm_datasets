Vista system restore 
Vista system restore rootkit
rootkit
Principle and protection
Principle and protection
Edward Sun
Edward Sun
PDF created with pdfFactory Pro trial version www.pdffactory.com
About speaker
About speaker
u
u Network ID : 
Network ID : CardMagic
CardMagic
u
u Author of 
Author of DarkSpy
DarkSpy anti
anti--rootkit
rootkit
u
u Posted several articles on 
Posted several articles on rootkit.com
rootkit.com
u
u R&D of some world famous kernel level 
R&D of some world famous kernel level 
products in global companies
products in global companies
u
u Experienced in Windows kernel mode 
Experienced in Windows kernel mode 
research and programming
research and programming
u
u Now is a researcher of Trend Micro threat 
Now is a researcher of Trend Micro threat 
solution team
solution team
PDF created with pdfFactory Pro trial version www.pdffactory.com
What will be introduced 
What will be introduced 
u
u Internals of Vista system restore
Internals of Vista system restore
u
u A user
A user--mode 
mode rootkit
rootkit to hide arbitrary file 
to hide arbitrary file 
or registry key from Windows Vista 
or registry key from Windows Vista 
system restore
system restore
u
u A new way to bypass modern HIPS 
A new way to bypass modern HIPS 
u
u Detection and protection of the threat
Detection and protection of the threat
PDF created with pdfFactory Pro trial version www.pdffactory.com
Agenda
Agenda
u
u Vista system restore (VSR) introduction
Vista system restore (VSR) introduction
u
u VSR internals
VSR internals
u
u VSR 
VSR rootkit
rootkit
u
u A new way to bypass HIPS
A new way to bypass HIPS
u
u Protect & detect VSR
Protect & detect VSR
u
u Demo
Demo
PDF created with pdfFactory Pro trial version www.pdffactory.com
Vista system restore (VSR) 
Vista system restore (VSR) 
introduction
introduction
u
u VSR allows user to use restore point to return 
VSR allows user to use restore point to return 
their system files and settings to an earlier point 
their system files and settings to an earlier point 
in time
in time
u
u System restore in Vista has been enhanced a lot 
System restore in Vista has been enhanced a lot 
and use new architecture & implementation 
and use new architecture & implementation 
which is different from XP
which is different from XP’’ss
u
u System Restore can make changes to Windows 
System Restore can make changes to Windows 
system files, registry settings, and programs 
system files, registry settings, and programs 
installed on your computer. It also can make 
installed on your computer. It also can make 
changes to scripts, batch files, and other types of 
changes to scripts, batch files, and other types of 
executable files on your computer
executable files on your computer
PDF created with pdfFactory Pro trial version www.pdffactory.com
VSR internals
VSR internals
u
u But how does VSR work? Microsoft hasn
But how does VSR work? Microsoft hasn’’t 
t 
provided detail document about how it works .
provided detail document about how it works .
u
u We will introduce t
We will introduce the whole process in three 
he whole process in three 
phases
phases
1. 
1. CCreate 
reate restore point
restore point (when you click 
(when you click ““Create
Create”” button)
button)
2. 
2. Serve a restore request
Serve a restore request (when you click 
(when you click ““Restore
Restore”” button)
button)
3. 
3. Shutdown & Startup
Shutdown & Startup (when the system shuts down after 
(when the system shuts down after 
you clicking 
you clicking ““Restore
Restore””))
PDF created with pdfFactory Pro trial version www.pdffactory.com
u
u CCreate 
reate restore point
restore point
Rely on shadow copy mechanism to create a 
Rely on shadow copy mechanism to create a 
volume shadow copy, see the call stack of 
volume shadow copy, see the call stack of 
SRSetRestorePoint
SRSetRestorePoint
PDF created with pdfFactory Pro trial version www.pdffactory.com
Shadow copy
Shadow copy
Implemented with disk filter 
Implemented with disk filter --
-- Volsnap.sys
Volsnap.sys
It can back up original sector when it finds any 
It can back up original sector when it finds any 
writer
writer’’s modification action and provide backup 
s modification action and provide backup 
application a point in time view of a volume 
application a point in time view of a volume 
E.g. if 
E.g. if application(writer
application(writer) has written 
) has written a,b,d
a,b,d, the original 
, the original 
copy of these sectors are kept by shadow copy service in 
copy of these sectors are kept by shadow copy service in 
storage. When backup application accesses the three 
storage. When backup application accesses the three 
sectors, shadow copy service will route the request to 
sectors, shadow copy service will route the request to 
original copy. However, when c is requested, the service 
original copy. However, when c is requested, the service 
will direct the request to real volume.
will direct the request to real volume.
PDF created with pdfFactory Pro trial version www.pdffactory.com
PDF created with pdfFactory Pro trial version www.pdffactory.com
Associated shadow copy files located here:
Associated shadow copy files located here:
Backup file id 
matches the name 
of shadow volume 
device name
PDF created with pdfFactory Pro trial version www.pdffactory.com
u
u Serve a restore request
Serve a restore request
When backup program calls restoration method, 
When backup program calls restoration method, 
two processes will be launched : 
two processes will be launched : 
WmiPrvSE.exe
WmiPrvSE.exe( to hold 
( to hold srwmi.dll
srwmi.dll) , 
) , dllhost.exe(to
dllhost.exe(to
hold 
hold srcore.dll
srcore.dll))
PDF created with pdfFactory Pro trial version www.pdffactory.com
Then the control transferred to 
Then the control transferred to srwmi.dll
srwmi.dll --
--
CSrWMIProvider::Restore
CSrWMIProvider::Restore
This method will involve 
This method will involve srcore.dll
srcore.dll::
CreateInstance here
Clsid
Corresponding 
Registry key
PDF created with pdfFactory Pro trial version www.pdffactory.com
srcore.dll
srcore.dll will do some preparation and 
will do some preparation and 
configuration work and then call its internal 
configuration work and then call its internal 
interface _
interface _RegisterForShutdownContinuation
RegisterForShutdownContinuation..
This routine will create 
This routine will create WinInit
WinInit key and register a 
key and register a 
callback function for Windows shutdown. And the 
callback function for Windows shutdown. And the 
key looks like 
key looks like 
The routine will be called for shutdown 
restoration logic
PDF created with pdfFactory Pro trial version www.pdffactory.com
u
u Shutdown & Startup
Shutdown & Startup
The Shutdown Call back:
The Shutdown Call back:
When system shuts down, the 
When system shuts down, the ShutdownContinuation
ShutdownContinuation will 
will 
be called, and this callback routine is exported by 
be called, and this callback routine is exported by srcore.dll
srcore.dll. 
. 
In this routine, it will parse shadow volume information and 
In this routine, it will parse shadow volume information and 
restore various system elements. The main restore logic 
restore various system elements. The main restore logic 
include two parts :
include two parts :
PDF created with pdfFactory Pro trial version www.pdffactory.com
a. Registry restore :
a. Registry restore :
The registry restore is based on hive file:
The registry restore is based on hive file:
srcore
srcore will firstly rename the original hive file and then copy 
will firstly rename the original hive file and then copy 
the backed hive file from volume shadow copy. The original 
the backed hive file from volume shadow copy. The original 
hive file will be renamed as 
hive file will be renamed as xxxx_previous
xxxx_previous, and after reboot 
, and after reboot 
system will use the backed hive file.
system will use the backed hive file.
PDF created with pdfFactory Pro trial version www.pdffactory.com
b. File restore:
b. File restore:
Modified file will be restored immediately, excepted 
Modified file will be restored immediately, excepted 
inaccessible file.
inaccessible file.
For inaccessible file :
For inaccessible file :
srcore
srcore will firstly copy the old version file to the restore folder an
will firstly copy the old version file to the restore folder and 
d 
name it like :
name it like :
Then it will register an 
Then it will register an autorun
autorun program called 
program called srdelayed.exe
srdelayed.exe
which will be executed when system starts up, and meanwhile log 