2017/12/07 
HITCON PACIFIC
1
KRACK & ROCA
吴忠宪 1,3
陈君明 1,2,3
J.-S. Wu              Jimmy Chen
1.
NTU, National Taiwan University
2.
IKV, InfoKeyVault Technology
3.
CHROOT & HITCON
Agenda
 KRACK  Key Reinstallation Attacks
– Serious weaknesses in WPA2, a protocol that 
secures all modern protected Wi-Fi networks
 ROCA  Return of Coppersmith’s Attack
– A vulnerability in the implementation of RSA 
key pair generation in a cryptographic library 
used in a wide range of cryptographic chips 
2017/12/07 
HITCON PACIFIC
2
KRACK
2017/12/07 
HITCON PACIFIC
3
14 Years of WPA/WPA2
 1997: WEP (completely broken)
 2003: WPA
 2004: WPA2
 Many attacks against Wi-Fi, but
 Handshake & encryption remain “secure”
– Until 2017
– KRACK discovered by Mathy Vanhoef
2017/12/07 
HITCON PACIFIC
4
2017/12/07 
HITCON PACIFIC
5
10 CVE IDs for KRACKs
 Targeting different aspects of WPA/WPA2
– CVE-2017-130{77,78,79,80,81}
– CVE-2017-130{82,84,86,87,88}
2017/12/07 
HITCON PACIFIC
6
10 CVE IDs for KRACKs
 Targeting different aspects of WPA/WPA2
– CVE-2017-130{77,78,79,80,81}
– CVE-2017-130{82,84,86,87,88}
 Let’s see how to KRACK the 4-way 
handshake
2017/12/07 
HITCON PACIFIC
7
Before the 4-way Handshake
 A client and an AP need to setup a 
shared secret master key MK
2017/12/07 
HITCON PACIFIC
8
“Personal” Network
2017/12/07 
HITCON PACIFIC
9
MK = Password
MK = Password
MK = Password
MK = Password
“Enterprise” Network
2017/12/07 
HITCON PACIFIC
10
MK1
MK1
MK3
MK3
MK2
MK2
MK4
MK4
MK5
MK5
802.1X
PEAP
Certificate
Username
Password
The 4-way Handshake
 Based on a shared MK between an AP 
and a client…
 Mutual authentication
 Negotiate a fresh temporal key TK
– for actual encryption
– can be refreshed
2017/12/07 
HITCON PACIFIC
11
2017/12/07 
HITCON PACIFIC
12
Msg1 (ANonce)
Msg2 (CNonce, …)
Msg3 (…)
Msg4 (…)
Client
AP
compute TK
install TK
reset PN
compute TK
install TK
reset PN
setup MK
setup MK
WPA2 Wi-Fi Encryption
 3 parameters are installed on both ends
– the temporal key TK
– the RxPN (replay counter)
– the TxPN (encryption nonce)
 Using CCM or GCM with AES-128
– TK is the encryption key
2017/12/07 
HITCON PACIFIC
13
2017/12/07 
HITCON PACIFIC
14
Msg1 (ANonce)
Msg2 (CNonce, …)
Msg3 (…)
Msg4 (…)
Client
AP
compute TK
install TK
reset PN
compute TK
install TK
reset PN
encrypted packets
setup MK
setup MK
2017/12/07 
HITCON PACIFIC
15
Msg1 (ANonce)
Msg2 (CNonce, …)
Msg3 (…)
Msg4 (…)
Client
AP
compute TK
install TK
reset PN
compute TK
encrypted packets
setup MK
setup MK
Key Reinstallation
 Under the same secret key…
 If encryption nonce (TxPN) gets reset:
– packets can be decrypted
– packets can be spoofed (for GCM)
 If replay counter (RxPN) gets reset:
– packets can be replayed
2017/12/07 
HITCON PACIFIC
16
2017/12/07 
HITCON PACIFIC
17
Msg3 (…)
Msg4
Client (victim)
AP
install TK
reset PN
enc. packets
Msg3 (…)
timeout
for Msg4
Msg4
enc. packets
reinstall TK
reset PN
Reinstall an All-Zero Key
 A serious bug found in wpa_supplicant
 Android 6.0+ and Linux
2017/12/07 
HITCON PACIFIC
18
Man-in-the-Middle
2017/12/07 
HITCON PACIFIC
19
Channel 1
Channel 2
21:D8:29:06:B7:58
5B:16:E3:54:71:A6
5B:16:E3:54:71:A6
21:D8:29:06:B7:58
Many Networks are “Unaffected” by KRACK
2017/12/07 
HITCON PACIFIC
20
MK = Password
MK = Password
MK = Password
MK = Password
2017/12/07 
HITCON PACIFIC
21
Properly configured
HTTPS, TLS, VPN…
are unaffected too
KRACK the Wi-Fi Fast Roaming
 Enterprise networks with multiple APs
– clients are moving
 FT (Fast Transition) handshake
2017/12/07 
HITCON PACIFIC
22
MK
MK
Moving
KRACK the Wi-Fi Fast Roaming
 Enterprise networks with multiple APs
– clients are moving
 FT (Fast Transition) handshake
– similar reinstallation issue on the AP side
– no replay counter at all
– more exploitable!!!
2017/12/07 
HITCON PACIFIC
23
No MitM Needed to KRACK FT
2017/12/07 
HITCON PACIFIC
24
21:D8:29:06:B7:58
5B:16:E3:54:71:A6
replay
handshake
messages
The Root Cause of KRACK
 The IEEE 802.11 standards didn’t specify 
the precise behaviors
 Previous formal analyses didn’t model 
“key installation”
– 4-way handshake proven secure
– CCM/GCM encryption proven secure
2017/12/07 
HITCON PACIFIC
25
Fix the KRACK Vulnerabilities
 Both clients and APs need patches
– Android 6.0+ and Linux devices!
– APs in enterprise networks!
 Don’t do the harmful key reinstallation
 Mitigate at the other end
2017/12/07 
HITCON PACIFIC
26
Lessons Learned (1/2)
 Good spec & correct code
 Abstract model vs. reality
2017/12/07 
HITCON PACIFIC
27
Lessons Learned (2/2)
 What if some part of your infrastructure is 
compromised?
– control the threats
 Encrypt everything properly in transit
– don’t assume enough (if any) security from 
(wireless) LAN
– HTTPS, TLS, VPN
2017/12/07 
HITCON PACIFIC
28
ROCA
2017/12/07 
HITCON PACIFIC
29
Crypto Flaws on Chips
 EasyCard (悠游卡) / Mifare Classic, NXP, 2008
 Citizen Certificate (自然人凭证), Renesas, 2013
– “Coppersmith in The Wild”
 Devices around the world, Infineon, 2017
– “Return of Coppersmith’s Attack (ROCA)”
– CVE-2017-15361
2017/12/07 
HITCON PACIFIC
30
EasyCard / Mifare  NXP
 The "Mifare Classic" RFID chip is used in hundreds of 
transport systems — London, Boston, Los Angeles, 
Amsterdam, Taipei, Shanghai, Rio de Janeiro — and as 
an access pass in thousands of companies, schools, 