  9 | 1301672 | 50534894 | public       | TBL        | AFTER   | ROW   | UPDATE | UTF8     | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.79597")    | (2,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.79597")  | 2014-08-28 23:08:52.887568 | postgres |        
       |              
 10 | 1301672 | 50534894 | public       | TBL        | AFTER   | ROW   | UPDATE | UTF8     | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.80206")    | (3,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.80206")  | 2014-08-28 23:08:52.887568 | postgres |        
       |              
 11 | 1301672 | 50534894 | public       | TBL        | AFTER   | ROW   | UPDATE | UTF8     | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.80903")    | (4,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.80903")  | 2014-08-28 23:08:52.887568 | postgres |        
       |              
 12 | 1301672 | 50534894 | public       | TBL        | AFTER   | ROW   | UPDATE | UTF8     | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.819092")   | (5,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.819092") | 2014-08-28 23:08:52.887568 | postgres |        
       |              
 13 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (5,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08  
-28 23:06:09.819092") |                                                              | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 14 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | INSERT | UTF8     |                                          
                      | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.819092")   | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 15 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (4,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08  
-28 23:06:09.80903")  |                                                              | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 16 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | INSERT | UTF8     |                                          
                      | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80903")    | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 17 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (3,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08  
-28 23:06:09.80206")  |                                                              | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 18 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | INSERT | UTF8     |                                          
                      | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80206")    | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 19 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (2,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08  
-28 23:06:09.79597")  |                                                              | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 20 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | INSERT | UTF8     |                                          
                      | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.79597")    | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 21 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (1,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08  
-28 23:06:09.790227") |                                                              | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 22 | 1301673 | 50534894 | public       | TBL        | AFTER   | ROW   | INSERT | UTF8     |                                          
                      | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.790227")   | 2014-08-28 23:09:50.590689 | postgres |        
       |              
 23 | 1301674 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.819092")   |                                                              | 2014-08-28 23:10:17.32766  | postgres |        
       |              
 24 | 1301674 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.80903")    |                                                              | 2014-08-28 23:10:17.32766  | postgres |        
       |              
 25 | 1301674 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.80206")    |                                                              | 2014-08-28 23:10:17.32766  | postgres |        
       |              
 26 | 1301674 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.79597")    |                                                              | 2014-08-28 23:10:17.32766  | postgres |        
       |              
 27 | 1301674 | 50534894 | public       | TBL        | AFTER   | ROW   | DELETE | UTF8     | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2  
8 23:06:09.790227")   |                                                              | 2014-08-28 23:10:17.32766  | postgres |        
       |              
(27 rows)  
```  
回退到删除前, 即1301674回退掉.  
```  
do language plpgsql $$  
declare  
  v_op text;  
  v_encoding_curr text := pg_client_encoding();  
  v_encoding_tmp text;  
  v_old text;  
  v_new text;  
  v_xid int8 := 1301674;   
begin  
  for v_op, v_encoding_tmp, v_old, v_new in   
    select op,encoding,old_rec::text,new_rec::text from undo_t where xid>=v_xid order by xid desc,id desc  
  LOOP  
    execute 'set client_encoding='''||v_encoding_tmp||'''';   
    case v_op   
    when 'INSERT' then   
      delete from public."TBL" t where t=v_new::public."TBL";   
    when 'DELETE' then  
      insert into public."TBL" values ((v_old::public."TBL").*);   
    when 'TRUNCATE' then  
      insert into public."TBL" values ((v_old::public."TBL").*);   
    when 'UPDATE' then  
      delete from public."TBL" t where t=v_new::public."TBL";   
      insert into public."TBL" values ((v_old::public."TBL").*);   
    else  
    end case;   
  end loop;   
  execute 'set client_encoding='''||v_encoding_curr||'''';   
end;   
$$;  
postgres=# select * from "TBL";  
 c1 | c2 |   C3    | c4 | c5 | c6 | c7 |          crt_time            
----+----+---------+----+----+----+----+----------------------------  
  1 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.790227  
  2 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.79597  
  3 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.80206  
  4 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.80903  
  5 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.819092  
(5 rows)  
```  
现在回退到只有一条记录的时候. 即1301666   
```  
postgres=#  do language plpgsql $$  
declare  
  v_op text;  
  v_encoding_curr text := pg_client_encoding();  
  v_encoding_tmp text;  
  v_old text;  
  v_new text;  
  v_xid int8 := 1301666;   
begin  
  for v_op, v_encoding_tmp, v_old, v_new in   
    select op,encoding,old_rec::text,new_rec::text from undo_t where xid>=v_xid order by xid desc,id desc  
  LOOP  
    execute 'set client_encoding='''||v_encoding_tmp||'''';   
    case v_op   
    when 'INSERT' then   
      delete from public."TBL" t where t=v_new::public."TBL";   
    when 'DELETE' then  
      insert into public."TBL" values ((v_old::public."TBL").*);   
    when 'TRUNCATE' then  
      insert into public."TBL" values ((v_old::public."TBL").*);   
    when 'UPDATE' then  
      delete from public."TBL" t where t=v_new::public."TBL";   
      insert into public."TBL" values ((v_old::public."TBL").*);   
    else  
    end case;   
  end loop;   
  execute 'set client_encoding='''||v_encoding_curr||'''';   
end;   
$$;  
DO  
postgres=# select * from "TBL";  
 c1 | c2 |   C3    | c4 | c5 | c6 | c7 |          crt_time            
----+----+---------+----+----+----+----+----------------------------  
  1 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.790227  
(1 row)  
```  
接下来测试一下添加字段后的回退.  
```  
postgres=# alter table "TBL" add column c8 text;  
ALTER TABLE  
postgres=# insert into "TBL" values (2,1,'test','c4','c5','c6',1,now(),'c8');  
INSERT 0 1  
postgres=# insert into "TBL" values (3,1,'test','c4','c5','c6',1,now(),'c8');  
INSERT 0 1  
postgres=# select * from "TBL";  
 c1 | c2 |   C3    | c4 | c5 | c6 | c7 |          crt_time          | c8   
----+----+---------+----+----+----+----+----------------------------+----  
  1 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.790227 |   
  2 |  1 | test    | c4 | c5 | c6 |  1 | 2014-08-28 23:14:00.235677 | c8  
  3 |  1 | test    | c4 | c5 | c6 |  1 | 2014-08-28 23:14:35.012675 | c8  
```  
回退到添加字段前1301666.  
```  
postgres=#  do language plpgsql $$  
declare  
  v_op text;  
  v_encoding_curr text := pg_client_encoding();  
  v_encoding_tmp text;  
  v_old text;  
  v_new text;  
  v_xid int8 := 1301666;   
begin  
  for v_op, v_encoding_tmp, v_old, v_new in   
    select op,encoding,old_rec::text,new_rec::text from undo_t where xid>=v_xid order by xid desc,id desc  
  LOOP  
    execute 'set client_encoding='''||v_encoding_tmp||'''';   
    case v_op   
    when 'INSERT' then   
      delete from public."TBL" t where t=v_new::public."TBL";   
    when 'DELETE' then  
      insert into public."TBL" values ((v_old::public."TBL").*);   
    when 'TRUNCATE' then  
      insert into public."TBL" values ((v_old::public."TBL").*);   
    when 'UPDATE' then  
      delete from public."TBL" t where t=v_new::public."TBL";   
      insert into public."TBL" values ((v_old::public."TBL").*);   
    else  
    end case;   
  end loop;   
  execute 'set client_encoding='''||v_encoding_curr||'''';   
end;   
$$;  
DO  
postgres=# select * from "TBL";  
 c1 | c2 |   C3    | c4 | c5 | c6 | c7 |          crt_time          | c8   
----+----+---------+----+----+----+----+----------------------------+----  
  1 |  1 | te\\s\t | c4 | c5 | c6 |  1 | 2014-08-28 23:06:09.790227 |   
(1 row)  
```  
接下来删除字段测试  
```  
postgres=# alter table "TBL" drop column c5;  
ALTER TABLE  
postgres=# select * from "TBL";  
 c1 | c2 |   C3    | c4 | c6 | c7 |          crt_time          | c8   