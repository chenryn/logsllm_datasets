# 如何通过外部接口访问APIC-EM的内部网络：CVE-2017-12262
##### 译文声明
本文为翻译文章，原作者为Georgi Geshev，来源于mwrinfosecurity.com。译文仅供参考，具体内容及含义以原文为准。

## 一、前言
应用策略基础设施控制器企业模块（Application Policy Infrastructure Controller Enterprise Module, APIC-EM）是思科为企业网络设计的软件定义网络（SDN）控制器。根据思科的说法，APIC-EM利用了多种先进的技术来解决各种问题。

“APIC-EM提供了基于策略的自动化平台，可以简化并抽象网络相关信息，将业务意图转化为具体的网络控制流程。该平台支持多个易于使用的SDN应用，并提供了开放的REST API北向接口，以推动网络自动化解决方案。同时，它还支持多种南向协议，与已部署的网络设备进行通信，从而将SDN的优势扩展到新网络或现有网络环境中。APIC-EM的目标是支持下一代SDN应用，以降低运营成本，提高网络灵活性，满足业务需求。”

## 二、技术背景
思科APIC-EM实现了一个PaaS（平台即服务）环境，使用Grapevine作为Elastic Services平台，支持控制器的基础架构和服务。该解决方案由两种类型的系统组成：Grapevine root和Grapevine client。Grapevine root作为应用程序运行在主机上，使用修改版的Ubuntu Linux操作系统；而Grapevine client则运行在LXC（Linux容器）中。Grapevine root负责处理所有与服务相关的策略管理事务，如服务更新、生命周期管理等。Grapevine client运行在root系统之上，提供平台支持的服务。

思科的APIC-EM需要两个网络才能正常工作。第一个是内部网，包含Grapevine root和client，这些组件之间相互连接并相互通信。这个网络是隔离的，外部网络无法访问。另一方面，APIC-EM通过外部网络接口提供Web前端（GUI）和REST API接口。

## 三、环境搭建
以下是实验环境的搭建步骤。我们使用的产品版本为APIC-EM-1.4.3.1009，并采用独立模式部署APIC-EM虚拟设备，参考思科的官方文档进行配置。

APIC-EM虚拟机包含一个外部网卡（NIC），其IP地址为`172.16.231.254/24`。具体信息如下：
```sh
$ ifconfig 
eth0: Link encap:Ethernet HWaddr 00:0c:29:39:ba:b7 
    inet addr:172.16.231.254 Bcast:172.16.231.255 Mask:255.255.255.0
    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
    RX packets:486859 errors:0 dropped:0 overruns:0 frame:0
    TX packets:479599 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:1000 
    RX bytes:36431324 (36.4 MB) TX bytes:40919272 (40.9 MB)
grape-br0: Link encap:Ethernet HWaddr fe:24:34:a0:f7:1b 
    inet addr:169.254.0.1 Bcast:169.254.0.255 Mask:255.255.255.0
    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
    RX packets:169165 errors:0 dropped:0 overruns:0 frame:0
    TX packets:169964 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:0 
    RX bytes:10041555 (10.0 MB) TX bytes:12541655 (12.5 MB)
lo: Link encap:Local Loopback 
    inet addr:127.0.0.1 Mask:255.0.0.0
    UP LOOPBACK RUNNING MTU:65536 Metric:1
    RX packets:1396822 errors:0 dropped:0 overruns:0 frame:0
    TX packets:1396822 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:0 
    RX bytes:6805835191 (6.8 GB) TX bytes:6805835191 (6.8 GB)
veth7D8YVY: Link encap:Ethernet HWaddr fe:24:34:a0:f7:1b 
    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
    RX packets:84559 errors:0 dropped:0 overruns:0 frame:0
    TX packets:85335 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:1000 
    RX bytes:6204723 (6.2 MB) TX bytes:6285922 (6.2 MB)
vethP5HRD4: Link encap:Ethernet HWaddr fe:96:03:f1:2d:8c 
    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
    RX packets:84606 errors:0 dropped:0 overruns:0 frame:0
    TX packets:85389 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:1000 
    RX bytes:6205142 (6.2 MB) TX bytes:6288509 (6.2 MB)
```
其中，`eth0`接口连接的是外部网络，而`grape-br0`属于内部的Grapevine网络区域，只有可信的LXC才能访问这个网段。

攻击者的系统位于外部LAN中，即`172.16.231.0/24`。我们对APIC-EM外部接口的端口进行了快速扫描，结果如下：
```sh
munmap@oceania:~$ nmap -n -p1-65535 -sT 172.16.231.254
Starting Nmap 6.47 ( http://nmap.org ) at 2017-06-16 15:36 BST
Nmap scan report for 172.16.231.254
Host is up (0.0069s latency).
Not shown: 65526 closed ports
PORT   STATE    SERVICE
22/tcp open     ssh
53/tcp filtered domain
80/tcp open     http
443/tcp open    https
3000/tcp open   ppp
4369/tcp open   epmd
14141/tcp open  bo2k
24007/tcp open  unknown
49152/tcp open  unknown
Nmap done: 1 IP address (1 host up) scanned in 3.01 seconds
munmap@oceania:~$
```
从扫描结果来看，80、443和3000端口是Web前端接口，需要身份认证才能访问。4369端口对应EPMD（Erlang Port Mapper Daemon）服务，14141端口用于访问Grapevine开发者控制台，同样需要身份认证。24007和49152端口被GlusterFS集群文件系统守护进程占用。

同时，APIC-EM内部网络上有多个服务正在运行，Grapevine root和client可以使用这些服务。内部网络范围被硬编码限制为`169.254.0.0/24`。这些服务包括Apache Cassandra、RabbitMQ、Supervisor和Hazelcast。然而，外部LAN中的恶意主机无法与这些服务通信，因为根据RFC 5735的规定，`169.254.0.0/16`是保留网络，专用于链路本地场景，数据包无法路由到这个网络。我们可以使用以下命令来确认这一点：

```sh
ping 169.254.0.1
```

希望这些信息能帮助你更好地理解如何通过外部接口访问APIC-EM的内部网络。