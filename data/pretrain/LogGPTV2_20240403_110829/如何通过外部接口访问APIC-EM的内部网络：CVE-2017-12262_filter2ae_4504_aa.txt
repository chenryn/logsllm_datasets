# 如何通过外部接口访问APIC-EM的内部网络：CVE-2017-12262
##### 译文声明
本文是翻译文章，文章原作者 Georgi Geshev，文章来源：mwrinfosecurity.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
## 一、前言
应用策略基础设施控制器企业模块（Application Policy Infrastructure Controller Enterprise
Module， APIC-EM）是思科针对企业网络设计的SDN（软件定义网络）控制器，根据思科的说法，APIC-EM利用了许多非常先进的前沿技术，可以解决五花八门的问题。
_“（APIC-EM）提供了基于策略的自动化平台，可以简化并抽象网络相关信息，能够将业务意图转化为具体的网络控制流程。这个平台可以托管多个易于使用的SDN应用，这些应用提供了开放式REST（Representational
State Transfer，表述性状态传递）
API北向接口（即向上提供的接口），以推动网络自动化解决方案。该平台同样支持许多南向协议（即向下提供的协议），通过这些协议与客户已部署的网络设备进行通信，因此能够将SDN的优势拓展到全新网络或者已有一定基础的网络环境中。APIC-EM平台的目标是为下一代SDN应用提供支持，以大大降低运营成本，提高网络灵活性，以满足业务需求。”_
## 二、技术背景
思科APIC-EM实现了一种PaaS（Platform as a Service，平台即服务）环境，其中使用了Grapevine作为Elastic
Services平台，以支持控制器的基础架构及服务。这种解决方案由两种类型的系统组成，即Grapevine root（根）以及Grapevine
client（客户）。Grapevine root作为应用程序运行在某台主机上，使用了修改版的Ubuntu Linux作为操作系统，而Grapevine
client则位于LXC（Linux
containers，Linux容器）中。root负责处理与服务有关的所有策略管理事务，如服务更新、root及Grapevine
client的服务生命周期。Grapevine client运行在root系统之上，运行着平台支持的那些服务。
思科的APIC-EM需要配备两个网络才能正常工作。第一个为内部网，包含Grapevine
root以及client，这些root及client之间相互连接，可以相互通信。这个网络为隔离网络，外部网络无法路由到或者访问到这个网络。另一方面，APIC-EM通过外部网络接口提供了控制器的Web前端（GUI）访问界面以及REST API接口。
## 三、环境搭建
首先介绍一下如何搭建实验环境。我们所使用的产品版本为APIC-EM-1.4.3.1009。我们使用独立（standalone）模式来部署APIC-EM虚拟设备，并参考思科的官方文档进行配置。
APIC-EM虚拟机中包含一个外部NIC（网卡），其IP地址为`172.16.231.254/24`，具体信息如下：
    $ ifconfig 
    eth0 Link encap:Ethernet HWaddr 00:0c:29:39:ba:b7 
     inet addr:172.16.231.254 Bcast:172.16.231.255 Mask:255.255.255.0
     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
     RX packets:486859 errors:0 dropped:0 overruns:0 frame:0
     TX packets:479599 errors:0 dropped:0 overruns:0 carrier:0
     collisions:0 txqueuelen:1000 
     RX bytes:36431324 (36.4 MB) TX bytes:40919272 (40.9 MB)
    grape-br0 Link encap:Ethernet HWaddr fe:24:34:a0:f7:1b 
     inet addr:169.254.0.1 Bcast:169.254.0.255 Mask:255.255.255.0
     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
     RX packets:169165 errors:0 dropped:0 overruns:0 frame:0
     TX packets:169964 errors:0 dropped:0 overruns:0 carrier:0
     collisions:0 txqueuelen:0 
     RX bytes:10041555 (10.0 MB) TX bytes:12541655 (12.5 MB)
    lo Link encap:Local Loopback 
     inet addr:127.0.0.1 Mask:255.0.0.0
     UP LOOPBACK RUNNING MTU:65536 Metric:1
     RX packets:1396822 errors:0 dropped:0 overruns:0 frame:0
     TX packets:1396822 errors:0 dropped:0 overruns:0 carrier:0
     collisions:0 txqueuelen:0 
     RX bytes:6805835191 (6.8 GB) TX bytes:6805835191 (6.8 GB)
    veth7D8YVY Link encap:Ethernet HWaddr fe:24:34:a0:f7:1b 
     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
     RX packets:84559 errors:0 dropped:0 overruns:0 frame:0
     TX packets:85335 errors:0 dropped:0 overruns:0 carrier:0
     collisions:0 txqueuelen:1000 
     RX bytes:6204723 (6.2 MB) TX bytes:6285922 (6.2 MB)
    vethP5HRD4 Link encap:Ethernet HWaddr fe:96:03:f1:2d:8c 
     UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
     RX packets:84606 errors:0 dropped:0 overruns:0 frame:0
     TX packets:85389 errors:0 dropped:0 overruns:0 carrier:0
     collisions:0 txqueuelen:1000 
     RX bytes:6205142 (6.2 MB) TX bytes:6288509 (6.2 MB)
    (grapevine)
    [Fri Jun 16 15:11:47 UTC] PI:EMAIL (grapevine-root-1) ~
    $
其中，`eth0`接口连接的是外部网络，而`grape-br0`属于内部的Grapevine网络区域，只有可信的LXC才能访问这个网段。
攻击者的系统位于外部LAN中，即`172.16.231.0/24`。我们快速扫描了APIC-EM外部接口的端口开放情况，得到如下结果：
    munmap@oceania:~$ nmap -n -p1-65535 -sT 172.16.231.254
    Starting Nmap 6.47 ( http://nmap.org ) at 2017-06-16 15:36 BST
    Nmap scan report for 172.16.231.254
    Host is up (0.0069s latency).
    Not shown: 65526 closed ports
    PORT STATE SERVICE
    22/tcp open ssh
    53/tcp filtered domain
    80/tcp open http
    443/tcp open https
    3000/tcp open ppp
    4369/tcp open epmd
    14141/tcp open bo2k
    24007/tcp open unknown
    49152/tcp open unknown
    Nmap done: 1 IP address (1 host up) scanned in 3.01 seconds
    munmap@oceania:~$
如上所示，我们并没有发现特别有用的信息。80、443以及3000端口都是Web前端接口，需要身份认证才能访问。根据上述信息，我们可知4369端口对应的是EPMD（Erlang
Port Mapper
Daemon）服务，并且我们可以通过14141端口访问Grapevine开发者控制台，这个控制台同样需要身份认证。此外，24007以及49152端口均已被GlusterFS集群文件系统守护进程占用。
与此同时，有多个服务正在APIC-EM内部网络上运行，Grapevine
root及client可以使用这些服务。内部网络范围已被硬编码限制为`169.254.0.0/24`。这些服务中有一些非常知名的服务，如Apache
Cassandra、RabbitMQ、Supervisor以及Hazelcast。然而，外部LAN中的恶意主机无法与这些服务通信，根据RFC
5735的规定，`169.254.0.0/16`是保留网络，专用于链路本地（link-local）场景，也就是说数据包无法路由到这个网络。我们可以使用如下命令来确认这一点：