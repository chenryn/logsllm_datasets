际
一下，在TCP 首部信息中有6个标志位，它们中多
11707075697440703023664十
控
7647366565613023
一个连接
+=t=t=+=+=t=
109087180141800009000090000008
15690F20156140000000909033
Host!".
.......
22
72
：
8:
....
80
-Agent:
......
......
en-us.
：
3
00期
2
日到
E
---
## Page 318
去。之后，攻击者企图用 hk.exe 程序来提升自己的权限，就像 ⅡIS 日志中记录的那样：
个系统级会话，这样，攻击者用一条简单的DOS 命令就可以将IUSR_Machine 加入管理员组中
权“TUSER”提升到“ADMINISTRATOR”。它可以利用ISWebTraversalUnicode漏洞建立一
小孙在网上找到了这个不知名的“hk.exe”的背景资料，它是用来提升权限的，能将用户特
件和目录处在合适的位置。
hk.exe 和 netcat 这两个程序传入到小孙的计算机。他还通过枚举目录的方法来确定适当的文
hk.exe 和netcat 上传到小孙的服务器中。
的参数来检测小孙的操作系统类型。攻击者首先枚举了他所能攻击的服务，然后用 ttp 将
说攻击者想通过 Nmap 扫描获取他计算机的基本信息。
取证分析
互动问答
江个
小孙注意到第一段 Snort 日志是明显的 Nmap 扫描。这是服务器被攻击的征兆，也就是
从以上日志可以看出，攻击者创建了一个新目录树，包含hk子目录，并通过TFTP将
继续往后看，我们并不能马上确定Nmap扫描是否正常运行，或者说攻击者使用了适当
1.攻击者是如何提升超越IUSR_Machine用户的权限的？
各位读者根据以上信息，请尝试回答下面4个问题。
2.
有什么办法可以防止Nmap等扫描器扫描服务器？
小孙应该注意哪些关于他的网站设计的额外安全事项？
什么漏洞导致攻击者最终获得了管理员权限？
ections across 1 hosts:TCP(225),UDP (0)[**]
[**] spp_portscan:portscan status from jack.com:225 conn
TCP Options (5) => WS: 10 NOP MSS: 265 TS: 1061109567 0 EOL
**U*p*SFSeq:0x410B2CF5Ack:0x0Win:0xC00TcpLen:40UrgPtr:0x0
TCPTTL:58TOS:0x0ID:43605IpLen:20DgmLen:60
05/10-21:30:24.455356jack.com:38421->sandmore.com:25
01
22:14:
22:13:
22:10
atible;
8
GET
第10章Snort系统部署及应用案例295
ripts/../../winnt/system32/cmd.exe
./winnt/system32/cmd.exe/c+dir.exe+\inetpub\scrip
/wrint/system32/cmd.exe/c+dir.exe+\jackji11\hk\
./winnt/system32/cmd.exe
/c+mkdir.exe+\jackjil1\hk
/c+dir.exe+\jackjill\
2000
---
## Page 319
它运行时的命令行界面如下所示：
中另外，在 Intermet上还可以搜索到一个叫 jill-win32.exe的程序，它是 jilc的编译版本。
用这一漏洞，基于此种分析，我们将这一工具与此次攻击联系在一起。
0x90，这在Snort日志里极易看到，执行它们会实现缓冲区溢出。还有其他一些程序也能利
以下是来自 jill.c 的部分摘要：
称为 jill的工具就是利用此漏洞进行缓冲区溢出攻击，并且在 Intermet上可以得到这个工具。
为CA-2001-10的IIS5.0版缓冲区溢出漏洞公告。对这个漏洞的进一步研究表明，有一个被
试工具时方便地区分出 shellcode的代码。
代码中应用广泛，之所以在汇编代码的前后都加上一段NOP(x90)是为了在反汇编工具或调
示曾尝试缓冲区溢出攻击，0x90在x86汇编语言中标记为空操作（NOP），它在缓冲区溢出
2003。也可能没有成功，也可能攻击者根本就没有分析那些扫描得出的信息。
否成功。如果它成功了，攻击者就可以辨认出sandmore.com 运行的是Windows Server
sandmore.com 运行的是Windows 2003/IIS 系统。如上所述，还不清楚攻击者的Nmap 扫描是
文件。通过几次尝试，日志记录显示修改成功，另外 Snort日志还记录了如下信息：
296
这段代码中，十六进制字符串0x47，0x45，0x54，0x20及0x2F后面跟着一系列的
大家注意，一开始有条命令调用了IISNull-Printer守护进程。
结果攻击者使用了另外一种方法，即IIS空指针溢出。部分 Snort日志记录如下：
攻击者在经历了一系列的尝试后，没有日志迹象显示攻击者运行hk.exe 成功了。而站点
以上日志记录表明，攻击者曾尝试通过简单的命令将default.htm首页文件重命名为其他
UNIX/Linux网络日志分析与流量监控
7217500
7387388655FF
+dir.exe+\inetpub\
286878
6
54255
x65
8
22
192
9
919
Z9
999982
x68
9
Ack
223
294
40
8
..j
mdt
ctren
s/sy
十六进制字符串0x90表
ndowst
---
## Page 320
用，而jil程序成功了。
疑难解答
载了包含所有 Windows 密码的 SAM 数据库。
网站。
访问权限，运行了相应的命令。现在，我们将这一系列可能的事件列在下面：
到，目前我们已搞明白这个Web 站点是如何被篡改的，以及攻击者是怎样获取了管理员的
10phtcrack 的程序来破解这些密码。攻击者的攻击行为在网络数据流存档文件中尚没有找
密码。当然，攻击者获得了这些权限。但这还不够，小孙还想进一步证实他的观点。
账号管理器）文件传到了自己的计算机上。Windows 系统的SAM文件包含所有用户的加密
删除小孙计算机内的任何文件。从以下的Snort日志可以看出：攻击者用tftp 将SAM（安全
Snort就能检测到该连接。
行在监听模式，然后运行jill，建立直接连接。只要netcat与 sandmore.com建立TCP连接，
现。它的执行情况如下面的Snort日志记录所示：
1．在试图提高自己的 IIS 使用权限时攻击者使用了 hk.exe 和 jil 两个程序。hk 程序不管
此时，攻击者获取了 sandmore.com 站点的系统级访问权限。他篡改了网页，用 TFTP 下
一旦攻击者远程连接到小孙的计算机上，他就拥有了管理员权限，可以遍历、修改或者
2）攻击者利用ⅡISUnicode 漏洞获得了小孙网站的目录结构，但此时他没有用此来篡改
并建立了通过netcat的控制连接。
5）攻击者执行二进制的 jill 程序，实现 IIS 空指针缓冲区溢出。它发出一个 clear 命
4）攻击者在jack.com的666端口运行了一个netcat监听程序。
3）攻击者试图用hk.exe提升他的权限，结果未成功。
1）攻击者用Nmap扫描了小孙的网站（sandmore.com），确认它运行的是IIS。自
攻击者在获得了这个SAM文件（安全账号管理器）之后，极有可能运行了一个类似
假设攻击者使用了 netcat 命令，通过对 jill 的工作方式的了解，攻击者必须使 netcat 运
它一旦执行，攻击者就可以通过远程连接执行系统级的命令，极有可能是通过 netcat 实
2E31 20 70 7574 20 7361 6D 0A.1 put sam.
***AP***Seq:0x4F03BFB7Ack:0x3E94C050 Win:0x4480TcpLen:20
TCPTTL:128TOS:0x0ID:18590IpLen:20DgmLen:67DF
05/10-22:40:07.160752jack.com:666->sandmore.com:1051
TCP Options (4) =>MSS: 1460 NOP NOP S ack OK
TCPTTL:128TOS:0x0ID:31806IpLen:20DgmLen:48DF
05/10-22:30:36.009892 sandmore.com:1051->jack.com:666
usage: jill-win32
dark spyrit / beavuh labs.
iis5remote.printeroverflow.
第10章Snort系统部署及应用案例297
+=+=+=+=+=+=+=
---
## Page 321
检查，重新评估安全性，
好结合。
jill 程序，我们根本无法觉察开始发生了什么。所有良好的安全措施应该是预防和检测的良
仔细检查，以确认没有额外的损失（例如用户ID和密码信息泄漏）。
用此计算机作为跳板攻击其他计算机。一旦发现被入侵，即使看上去不具有破坏性，也应该
案例启示
攻击：
出总是伴随其左右。因此，从补丁的角度看，这部分攻击很难预防。以下措施可以预防类似
预防措施
PortSentry可以采取如下一些特定措施来加强防范：肯
以实时检测几乎所有类型的网络扫描，并对扫描行为做出反应。一旦发现可疑的行为，
Snort日志中分析。PortSentry是入侵检测工具中配置最简单、效果最直接的工具之一，它可
口扫描往往是入侵的前奏，使用PortSentry可以有效地发现此类安全事件，而不必在众多的
一定的缓解作用。
个安全网段中。另外，这些数据的传输应该被加密。这样，在Web服务器被入侵时能起到
时，Web服务器必然连接一个数据库，而这个数据库应该采用防火墙设备来把它们分隔在一
员权限。
298UNIX/Linux网络日志分析与流量监控
，其次，并不是所有的工具都会在遭受攻击的计算机上留下痕迹。如果攻击者适当地使用
当遭遇漏洞攻击时，Unicode网络遍历漏洞总脱不了干系。但实际上，空指针缓冲区溢
4.攻击者还会用端口扫描程序扫描服务器的所有端口，以收集有用的信息。服务器端
3．最首要的问题是，必须用一台独立的计算机提供Web站点服务。当用于商业用途
2.正是1IS5.0空指针缓冲区溢出漏洞导致攻击者获取了sandmore.com站点的管理
最后，在本案例中，小孙应该备份数据，然后重装系统。所有邻近的计算机都应该仔细
3）在计算机上运行防火墙软件和IDS，这起码可以在事发时起警示作用。
更容易维护和安装。
2）使用功能较单一的 Web 服务器。这些程序本身更为安全，因为它们提供更少的功
1）去除IS Web 服务器不使用的扩展映射（如.ptr，.htr等)。
·给出虚假的路由信息，把所有的信息流都重定向到一个不存在的主机。
）自动将对服务器进行端口扫描的主机加到TCP-Wrappers的/etc/hosts.deny文件中去。
口扫描、慢速扫描等复杂扫描行为无法有效检测。
务器进行端口扫描的主机）都过滤掉；但是PortSentry并不是万能的，对于分布式端
利用Netfilter机制，用包过滤程序，比如iptables等，把所有非法数据包（来自对服
，以确定它们是否也被攻击过。
赶酷品
---
## Page 322
为目标网络中的合法接入AP或合法站点，攻击者即可轻而易举地获取WLAN访问权限。
具均可以对WLAN实施网络窃听，使得攻击行为更加难以被发现。
加之NetStumbler（Windows平台下用）、Wellenreiter（Linux平台下用）等无线网络审计工
于WLAN中的管理帧是明文传输，SSID和MAC等重要网络数据信息极易被攻击者截获，
安全威胁。攻击者利用WLAN信号覆盖范围内的报文截获方式，提取关键敏感信息，且鉴
11.1.2WLAN面对的安全威胁
等。因此，一旦其他用户进入该无线AP的覆盖范围内，便有机会入侵WLAN。
设置WEP（WiredEquivalentPrivacy）加密算法密钥，以及未设置无线AP设备的安全策略
旦被不法分子利用，极易受到攻击，在下面的案例中就会讨论这种情况。
利于接入的便捷和使用的方便，但覆盖范围过大却也会导致WLAN易于被嗅探和发现，
射功率和增益较大的无线AP设备，且将其置于不被遮蔽阻挡的显著位置。这种做法确实有
11.1.1WLAN主要安全漏洞
还应该确保数据的完整性。
程度，要求密钥具备动态更新、减少密钥通信数量等功能。！
有密钥而无法顺利获取WLAN明文。WLAN的数据加密性高，其加密算法目标有3个：
数据加密算法达到较高的综合性能，才能使得WLAN攻击者即使获得了密文，也会因为没
之而来。WLAN对安全的诉求主要取决于以下几个方面：
（1）WLAN的AP过度覆盖：当用户追求WLAN的AP覆盖范围时，常会选择使用发
11.1WLAN安全漏洞与威胁
（1）数据加密性：要确保WLAN信息只能被特定的合法对象读取，必须保证WLAN的
（2）伪装入侵：伪装入侵指攻击者将自己伪装成合法设备，一旦成功实施网络欺骗，成
：（1）网络窃听：鉴于WLAN的开放信道特点，网络窃听是WLAN面临的最具伤害性的
（2）需要自行设置WLAN安全访问配置：无线AP的管理员登录密码和SSID重设、未
（3）数据完整性：WLAN网络信息安全防护中，除了需要保证加密数据的安全，同时
（2）密钥强壮性：密钥强壮性是指密钥的产生、传递、保存以及销毁等环节的实用健壮
随着无线局域网技术的快速发展，以及用户规模的持续扩大，WLAN的安全问题也随
●安全性能够经受WLAN网络不断增大的带宽要求。
灵活度应足够强，适合在各种类型的网络上部署。
高速度和高效的内存使用。
第11章WLAN案例分析
---
## Page 323
可以接入的无线网卡。
对认证和数据安全使用128位的WEP加密，还使用了 MAC访问控制列表，在访问点限制
非常高兴有了新的无线网络，如图11-1所示。
内。最近公司的网络工程升级工作刚刚完成，大厦内安装了802.11n无线网络环境。用户们
事件背景
友）、可疑帐号（Bell，Kate）
速定位非法接入点？
攻击者是如何突破公司无线网的访问控制的？又是如何入侵VPN的？你会采取什么措施快
各类日志筛查对比，最后，他顺藤摸瓜找到了那个来自公司外部无线VPN的地址。你知道
WLAN密钥，集中对网络弱密钥进行攻击。
仿造接入点并尝试连接，最终骗取用户的账户登录信息。
模拟建立仿造接入点，并将仿造接入点的信噪比调制为强于目标接入点以便用户优先搜索至
喜欢采用的攻击手段。
手法有MAC地址欺骗等。
作为一种极难被发现且十分容易实现的网络攻击行为，这种伪装入侵的安全威胁极大。常用
300UNIX/Linux网络日志分析与流量监控
11.2
大，