1
1:::n, consist of those items whose multiplicity exceeds the fraction  of the total cardinality,
i.e., a  jjajj . There can be between 0 and 1 heavy hitters in any given sequence of items.
i 1 
Approximationcomesbyacceptinganyisuchthata  ()jjajj forsomespecified "  a +"jjajj ] = Pr [8 : count[j;h (i)] > a +"jjajj ]
i i 1 j j i 1
= Pr [8 : a +X > a +"jjajj ]
j i i;j i 1
= Pr [8 : X > eE (X )]  1 to get the same accuracy
b 
guarantee. Choosing b = e minimizes the space used, since this solves d(wd) = 0, giving a cost
db
of (2 + e)ln 1 words. For implementations, it may be preferable to use other (integer) values of
" 
b for simpler computations or faster updates. Note that for values of a that are large relative to
i
jjajj , the bound in terms of "jjajj can be translated into a relative error in terms of a . This has
1 1 i
implicationsforcertainapplicationswhichrelyonretrievinglargevalues,suchaslargewaveletor
Fourierco-efficients.
Thebestknownpreviousresultusingsketcheswasin[5]:theresketcheswereusedtoapproximate
pointqueries.Resultswerestatedintermsofthefrequenciesofindividualitems.Forarbitrarydis-
tributions, the space used is O( 1 log 1), and the dependency on " is 1 in every case considered.
"2  "2
Asignificant differencebetweenCMsketchesandpreviousworkcomesin theanalysis:
 All prior analyses of sketch structures compute the variance of their estimators in order to ap-
plytheChebyshevinequality,whichbringsthedependencyon"2.DirectlyapplyingtheMarkov
inequalityyieldsamoredirectanalysiswhichdependsonlyon".Practitionersmayhavediscov-
ered that less than O(1) space is needed in practice: here, we give proof of why this is so and
2
thetighterbound.
7
 Becauseonlypositivequantitiesareaddedtothecountersthenitispossibletotaketheminimum
insteadofthemedianfortheestimate.Thisallowsasimplecalculationofthefailureprobability,
without recourse to Chernoff bounds.This significantly improvesthe constantsinvolved: in [5]
for example, the constant factors within the big-Oh notation is at least 256; here, the constant
factorisless than3.
 Theerrorboundhereisone-sided,asopposedtoallpreviousconstructionswhichgavetwo-sided
errors.Thisbringsbenefits formanyapplicationswhich usesketches.
InSection6weshowhowallexistingsketchconstructionscanbeviewedasvariationsofacommon
procedure. Thisemphasizestheimportanceofourattempttofind thesimplestsketchconstruction
which has the best guarantees and smallest constants. A similar result holds when entries of the
implicitvectoramaybenegative,whichisthe generalcase.
EstimationProcedure. Thistime Q(i)isansweredwitha^ = median count[j;h (i)].
i j j
Theorem 2 Withprobability11=4,
a 3"jjajj  a^  a +3"jjajj :
i 1 i i 1
PROOF. ObservethatE (jcount[j;h (i)]a j)  "jjajj ,andsotheprobabilitythatanycountis
j i e 1
off by more than 3"jjajj is less than 1. Applying Chernoff bounds tells us that the probability of
1 8
the medianofln 1 copiesofthisprocedurebeingwrong isless than1=4.
ThetimetoproducetheestimateisO(ln 1)andthespaceusedis(2+ e)ln 1 words.Thebestprior
 " 
result for this problem was the method of [5]. Again, the dependence on " here is improved from
1="2 to 1=". By avoiding analyzing the variance of the estimator, again the analysis is simplified,
andtheconstantsare significantly smallerthan inpreviousworks.
4.2 InnerProductQuery
EstimationProcedure. Set(ab) = w k=1counta[j;k]countb[j;k].OurestimationofQ(a;b)
j
fornon-negativevectorsaandbis ab = min (ab) .
P j j
d
d d
Theorem 3 ab  aband,with probability1, ab  ab+"jjajj jjbjj :
1 1
d d
n
PROOF.
(ab) = a b + a b
j i i p q
Xi=1 p6=q;hjX(p)=hj(q)
d
8
Clearly,ab  ab fornon-negativevectors.Bypairwise independenceofh,
j
d "a b "jjajj jjbjj
E (ab ab) = Pr [h (p) = h (q)]a b  p q  1 1
j j j p q
e e
p6=q p6=q
X X
d
So,by theMarkov inequality,Pr [abab > "jjajj jjbjj ]  ,asrequired.
1 1
d
ThespaceandtimetoproducetheestimateisO(1 log 1).UpdatesareperformedintimeO(log 1).
"  
Note that in the special case where b = 1, and b is zero at all other locations, then this procedure
i
is identical to the above procedure for point estimation, and gives the same error guarantee (since
jjbjj = 1). A similar result holds in the general case, where vectors may have negative entries.
1
Takingthemedianof(ab) wouldgiveaguaranteedgoodqualityapproximation;however,we
j
do not know of any application which makes use of inner products of such vectors, so we do not
d
givethefulldetailshere.Wenextconsidertheapplicationofinner-productcomputationtoJoinsize
estimation,wherethe vectorsgeneratedhavenon-negativeentries.
Join size estimation is important in database query planners in order to determine the best order
in which to evaluatequeries.The joinsize of two databaserelations on a particularattributeis the
numberofitemsinthecartesianproductofthetworelationswhichagreethevalueofthatattribute.
We assume without loss of generality that attribute values in the relation are integers in the range
1:::n. We represent the relations being joined as vectors a and b so that the values a represents
i
thenumberoftupleswhichhavevalueiinthefirst relation,andb similarlyforthesecondrelation.
i
Thenclearlyabisthejoinsizeofthetworelations.Usingsketchesallowsestimatestobemadein
thepresenceofitemsbeinginsertedtoanddeletedfromrelations.Thefollowingcorollaryfollows
from theabovetheorem.
Corollary1 The Join size of two relations on a particular attribute can be approximated up to
"jjajj jjbjj withprobability1,bykeepingspaceO(1 log 1).
1 1 " 