作者：安天  
来源：[《“绿斑”行动——持续多年的攻击》](https://www.antiy.cn/research/notice&report/research_report/20180919.html
"“绿斑”行动——持续多年的攻击")
### 1、概述
在过去的数年时间里，安天始终警惕地监测、分析、跟踪着各种针对中国的APT攻击活动，并谨慎地披露了“海莲花”(APT-TOCS)、“白象”（White
Elephant）、“方程式”（Equation）等攻击组织的活动或攻击装备分析，同时也对更多的攻击组织和行动形成了持续监测分析成果。本报告主要分析了某地缘性攻击组织在2015年前的攻击活动，安天以与该地区有一定关联的海洋生物作为了该攻击组织的名字——“绿斑”（GreenSpot）。为提升中国用户的安全意识，推动网络安全与信息化建设，安天公布这份报告。
综合来看，“绿斑”组织的攻击以互联网暴露目标和资产为攻击入口，采用社工邮件结合漏洞进行攻击，其活跃周期可能长达十年以上。
#### 1.1 疑似的早期（2007年）攻击活动
在2007年，安天对来自该地区的网络入侵活动进行了应急响应，表1-1是在相关被攻击的服务器系统上所提取到的相关攻击载荷的主要行为和功能列表。
表 1-1 早期“绿斑”组织攻击活动相关载荷及功能列表 ![
](https://images.seebug.org/content/images/2018/09/785fa0cc-5267-4379-b605-3eaab5dcc08d.png-w331s)
这些工具多数为开源或免费工具，从而形成了攻击方鲜明的DIY式的作业风格。由于这些工具多数不是专门为恶意意图所编写的恶意代码，有的还是常见的网管工具，因此反而起到了一定的“免杀”效果。但同时，这种DIY作业，并无Rootkit技术的掩护，给系统环境带来的变化较为明显，作业粒度也较为粗糙。同时只能用于控制可以被攻击跳板直接链接的节点，而无法反向链接。和其他一些APT攻击中出现的自研木马、商用木马相比，是一种相对低成本、更多依靠作业者技巧的攻击方式。
![
](https://images.seebug.org/content/images/2018/09/9c882a33-37c3-4c96-b6fa-c3e01443157a.png-w331s)
图 1-1 早期“绿斑”组织攻击活动相关载荷调用关系图
这些工具可以在被入侵环境中形成一个作业闭环。攻击者使用网络渗透手段进入目标主机后，向目标主机上传表1-1中的多种攻击载荷，利用持久化工具达成开机启动效果，实现长期驻留；通过NC开启远程Shell实现对目标主机远程命令控制；调用Mt1.exe获取系统基本信息和进一步的管理；同时攻击者可以通过Spooler.exe形成磁盘文件列表并记录、通过keylog.exe收集键盘输入并记录、通过Rar.exe收集指定的文件并打包、通过HTTP.exe开启HTTP服务，即可远程获取全盘文件列表，获取用户击键记录，回传要收集的文件和日志。
我们倾向认为，2007年前后，相关攻击组织总体上自研能力有限，对开源和免费工具比较依赖，喜好行命令作业。同时，作业风格受到类似Coolfire式的早期网络渗透攻击教程的影响较大。目前我们无法确认这一攻击事件与我们后面命名的“绿斑”组织是同一个组织，但可以确定其来自同一个来源方向。
#### 1.2 2011-2015年攻击活动
从时间上来看，自2010年以后，该地区组织攻击能力已经有所提升，善于改良1day和陈旧漏洞进行利用，能够对公开的网络攻击程序进行定制修改，也出现了自研的网络攻击装备。2010年以后相关活动明显增多、攻击能力提升较快。
“绿斑”组织主要针对中国政府部门和航空、军事相关的科研机构进行攻击。该组织通过鱼叉式钓鱼邮件附加漏洞文档或捆绑可执行文件进行传播，主要投放RAT（Remote
Administration
Tool，远程管理工具）程序对目标主机进行控制和信息窃取，其典型攻击手法和流程是以邮件为载体进行传播，邮件附件中包含恶意文档，文档以MHT格式居多（MHT是MIME
HTML的缩写，是一种用来保存HTML文件的格式），该文档打开后会释放并执行可执行载荷。作为迷惑用户的一种方法，嵌入在MHT中的一份起到欺骗作用的正常的文档文件也会被打开显示，攻击过程图1-2所示：
![
](https://images.seebug.org/content/images/2018/09/2e2b68be-8495-4d23-9e29-e9e5e2c99400.png-w331s)
图 1-2 “绿斑”组织活动攻击流程
通过人工分析结合安天追影威胁分析系统及安天分析平台进行关联分析，我们对其攻击目标、攻击者采用的IP和常见的手法进行了梳理。该组织利用漏洞的文件是不常见的附件文件格式，相关攻击技术和手法也是经过长期准备和试验的。安天基于原始线索对该组织进行了全面跟踪、关联、分析，最终获得了近百条IoC（信标）数据。通过对事件和样本的整体分析，我们梳理了该组织在2011-2014年的部分活动时间轴。
![
](https://images.seebug.org/content/images/2018/09/870afd51-bfb8-4e15-b47e-3947a5ba90ab.png-w331s)
图 1-3 “绿斑”组织2011-2014攻击活动时间轴
#### 1.3 近期的部分攻击活动（2017年）
“绿斑”组织在2015年后继续活跃，我们在2017年监测到该组织建立了一个新的传播源，该次活动的载荷都存储在同一个WEB服务器上，每一个攻击流程内的载荷都按照目录存放，其攻击流程是首先传播含有漏洞的Office文档，通过漏洞文档下载执行恶意载荷（EXE），随后通过C2对目标主机进行远程控制，具体攻击流程参见图1-4。
![
](https://images.seebug.org/content/images/2018/09/c060fd5a-11c5-4e75-a443-42854d0516dd.png-w331s)
图 1-4 最新活动攻击流程
该WEB服务器上存放了多个不同配置的恶意脚本和可执行文件，一个目录下是一组攻击样本，最终运行的Poison Ivy ShellCode（Poison
Ivy是一个远程管理工具）都会连接一个单独C2地址，图1-5中红色的域名（pps.*.com）是与2011-2015年活动相关联的C2域名。
![
](https://images.seebug.org/content/images/2018/09/3d115a63-7e1d-4bf3-be9f-870fd0662ae3.png-w331s)
图 1-5 传播源服务器样本部署及C&C关系图
### 2、攻击手法分析：通过定向社工邮件传送攻击载荷
#### 2.1 典型案例
针对“绿斑”组织2011-2015年间的攻击活动中，安天通过监测发现和关联分析，梳理出了数十起事件和载荷的关联关系。通过对典型案例的基本信息和诱饵文件等进行分析，我们可以看出“绿斑”组织多采用通过定向社工邮件传送攻击载荷，攻击载荷有两种：一种是捆绑型PE恶意代码，在被攻击者打开执行后，其会打开嵌入在PE中的欺骗收件人的“正常”文档文件；另一种是格式攻击文档，利用漏洞CVE-2012-0158来释放并执行可执行文件，同时打开欺骗收件人的“正常”文档文件。但在两种攻击方式中，所释放的可执行文件路径和名称相同，除部分案例采用%TEMP%路径外，其他均为C:\Documents
and Settings\All
Users\“开始”菜单\程序\启动\update.exe，来达成开机执行的持久化效果，从释放路径、文件名称可以看出这些样本是具有关联性的（具体分析参见4.4节）。从时间上来看，使用捆绑型PE恶意代码的攻击晚于漏洞文档，这有可能是在利用漏洞文档攻击无效后，才使用了这种虽然简单粗暴但可能最有效的方式。
##### 2.1.1 案例1
![
](https://images.seebug.org/content/images/2018/09/9397ac59-f9e0-4a8b-a292-eb6b8f17f7f3.png-w331s)
##### 2.1.2 案例2
![
](https://images.seebug.org/content/images/2018/09/353a8295-eb32-44ec-9021-210cad64cc0a.png-w331s)
##### 2.1.3 案例3
![
](https://images.seebug.org/content/images/2018/09/d51ba398-e62a-4390-ae1a-fefcd3ffb5f3.png-w331s)
另外值得注意的地方是图2-3中相关文字内容为从“全国人民代表大会网站”（文档内容出处：“”2013年的网页内容，目前网页内容已更新。）页面直接复制粘贴的内容。
##### 2.1.4 案例4
![
](https://images.seebug.org/content/images/2018/09/7e2a5c8d-8170-41d4-b038-79504b84f9b8.png-w331s)
##### 2.1.5 案例5
![
](https://images.seebug.org/content/images/2018/09/3c9cd7c4-c945-47c5-83be-7eef354f522e.png-w331s)
##### 2.1.6 案例6
##### 2.1.7 案例7
![
](https://images.seebug.org/content/images/2018/09/f698b082-ffe8-4394-ada9-ea920cdb9af0.png-w331s)
##### 2.1.8 案例8
![
](https://images.seebug.org/content/images/2018/09/800726d0-2338-4552-83b6-78032990bf0d.png-w331s)
##### 2.1.9 案例9
![
](https://images.seebug.org/content/images/2018/09/01770f10-41b8-4c6b-9ac9-b500706b6a6e.png-w331s)
#### 2.2 社工技巧分析
“绿斑”攻击组织主要针对被攻击者的职业、岗位、身份等定制文档内容，伪装成中国政府的公告、学会组织的年会文件、相关单位的通知、以及被攻击者可能感兴趣的政治、经济、军事、科研、地缘安全等内容，其所使用的欺骗性文档多数下载自中国相关部委机构、学会的网站。
### 3、攻击载荷分析：漏洞、后门及可执行文件
#### 3.1 CVE-2012-0158漏洞利用
CVE-2012-0158是一个文档格式溢出漏洞，格式溢出漏洞的利用方式是在正常的文档中插入精心构造的恶意代码，从表面上看其是一个正常的文档，很难引起用户的怀疑，因此经常被用于APT攻击。CVE-2012-0158漏洞是各种APT攻击中迄今为止使用频度最高的。利用该漏洞的载体通常是RTF格式的文件，其内部数据以十六进制字符串形式保存。
##### 3.1.1 由RTF到MHT的高级对抗
传统的CVE-2012-0158漏洞利用格式主要以RTF为主，而该组织则使用了MHT格式，这种格式同样可以触发漏洞，而且在当时一段时间内可以躲避多种杀毒软件的查杀。
![
](https://images.seebug.org/content/images/2018/09/12d24f3b-72a7-493c-907a-08f2cd03867c.png-w331s)