=== 检测任务配置
模型训练完成后，你可以设置模型上线运行的检测任务，也可以先预览并配置一些模型的检测细节。
检测任务可以检测并发出三种类型的异常告警：
1. 模式异常：一个系统中的日志输出语句是有限的，每一个输出语句对应一个日志模式，如果检测到一条日志不能匹配任何正常模式，我们就称这条日志是模式异常的。
** 当日志不能匹配上任何已知模式时，称为未知模式异常。
** 当日志匹配上程度为"异常"的某个已知模式时，称为已知模式异常。
2. 参数异常：一条日志匹配到对应模式之后，参数位的值如果和已有经验不符合，我们就称这条日志是参数异常的。
3. 占比异常：一个模式对应的日志数量在某一个时间区间内如果发生突变，我们就称这个模式是百分比异常的。
模式异常是检测任务必须启用的异常检测类型，用户只需要关注检测的敏感度。参数和占比异常，则是可选的启用项，用户可以不开启。
==== 运行设置
点击任务列表上特定任务的"运行设置"，看到设置界面如下:
image::images/lynxee-logreduce-running-options.png[]
* 任务查询语句: 匹配该过滤语句的线上日志将运用该任务模型进行检测。当启用分布式实时检测(即: 日志易 Manager 上 loganalyzer 模块 `flink.use_flink` 参数设为 true)时，仅支持使用 `appname:xxx` 或 `tag:xxx` 字段过滤语句。实时检测可以从多个 Kafka Topic 中同时获取数据，用户可以通过日志易 Manager 中 loganalyzer 模块的 `kafka.consumer.topics` 参数配置。
* 参数检测: 勾选启用的话，将对设置为"关注"状态的参数位置进行频数分布检测。
* 占比检测: 勾选启用的话，将根据指定间隔时间，计算各正常模式的数量占比进行阈值检测。
* 间隔时间: 设置模式异常检测和占比异常检测的间隔时间。当启用分布式实时检测时，模式异常检测纯实时运行，不受该配置限制。
* 每分钟最大异常数：为了保护检测程序，可以设置异常数量过载的上限，当短时间内检测出过多异常时，任务将进入"异常过多"状态。通过日志易 Manager 中 loganalyzer 模块的 `job.is_suspend` 参数，可以设定进入"异常过多"状态时，是否自动暂停任务。一般情况下，1 分钟内检测出 1000 个异常即报警"异常过多"。
* 告警发送配置：在检测发现异常时，是否发送异常信息到 Cruxee 模块。默认将按照"全局配置"中"日志异常检测告警发送配置"是否开启来决定。也可以选择"使用特殊发送配置"，单独定义本检测任务是否发送。
勾选"占比检测"后，间隔时间配置中将新增四栏配置：占比检测间隔时间、数量变化率阈值、占比变化阈值、占比对比时段。
* 间隔时间：为各模式按照固定间隔统计数量和占比，并进行检测。数据记录在 `_normal_log_stat` 内部索引中，索引数据包括 timestamp, model_name, cluster_id, normal_log_count 等字段。
* 数量变化率阈值：为数量变化率添加不同等级的阈值，Lynxee 支持低、中、高、严重四个等级。
* 占比变化阈值：为占比变化添加不同等级的阈值，Lynxee 支持低、中、高、严重四个等级。
* 占比对比时段：设置对比时段，可同比昨天、同比上周和环比。
系统将收集该间隔内各模式的数据量占比情况，并对比上一个时间段的已有数据，对超过设定阈值的，发出占比异常告警。系统占比检测行为分为两种，设上一时间段内，模式p1内日志的数量为n，在总日志数中的占比为p；当前时间段内，该模式p1内日志的的数量为n'，在总日志数中的占比为p'。则：
1. 数量变化率异常：检测单一模式内日志的数量，变化率的绝对值超过阈值e1(即|n'-n|/n >= e1)
2. 占比变化异常：检测单一模式内日志的数量占总日志数量的比例，变化率的绝对值超过阈值e2(即|p'-p| >= e2)
注意，日志易Manager上loganalyzer模块有一个 `monitor.cluster_percentage_lower_bound` 参数，默认为 0.01，即如果一个模式的数据量太小，占比小于 1% 的，就不参与占比检测了。
勾选"参数检测"后，系统将自动从原训练样本中，获取各参数位的取值，生成参数检测模型。由于参数位较多，为了防止告警风暴，系统默认只做模型训练，并不实际开启检测。你需要进入模型预览界面，明确指定自己关注哪些参数位。
==== 模型预览
参数包括几种类型:
* 数值：检测参数数值是否符合分布（如正态分布，二项分布）
* 常量：取值唯一
* 离散值：可枚举的字符串，检测参数是否在取值集合范围内
* 高基值：当去重值超过总数量的 70% 以上且总数量在 20 以上，或者总数量在 20 以下且去重值大于 10 时，认定为高基值，只检测参数类型是否一致即可（如ip,url,id）。用户可以通过日志易 Manager 上 loganalyzer 模块的 `model.parameter_detector.distinct_threshold` 参数调整高基值认定规则的百分比阈值。
* 内置实体：目前 Lynxee 内置实体参数识别规则支持识别的参数类型包括：
** DATE：日期
** TIME：时间
** DATETIME：时间戳
** IP：网络地址
** MAC：MAC地址
** URL：网络资源访问路径
** PATH：文件系统访问路径
** EMAIL：邮箱
** ID：常见id
** UNICODE: Unicode编码格式
** PARAMETER：在大小括号、双引号等包裹内的文本，如果经分词后词的数量超过 5 个的，Lynxee 认为属于无需关注内容的特殊实体
** CHINESE_WORD：中文文本。Lynxee 目前对中文文本的处理较为简略，行为配置说明见后续特殊参数章节
以前一节的模式样例为例
  * org.apache.hadoop.hdfs.server.datanode.*: * ** src:/: dest:/: **
参数类型说明如下：
[options="header"]
|=====
|模式|参数位置|参数类型|示例 
||1|高基值| 2015-09-18 07:50:58,035
|*|2|离散值|INFO
|org.apache.hadoop.hdfs.server.datanode.|3|常量|org.apache.hadoop.hdfs.server.datanode.
|*|4|离散值|DataNode
|:|5|常量|:
|*|6|离散值|Receiving
|**|7|离散值|BP-1578427263-10.0.52.144-1441855472637:blk_1073741853_1029
|src|8|常量|src
|:|9|常量|:
|/|10|常量|/
||11|高基值|10.0.52.146
|:|12|常量|:
||13|数值|56860
|dest|14|常量|dest
|:|15|常量|:
|/|16|常量|/
||17|高基值|10.0.52.145
|:|18|常量|:
||19|数值|50010
|**|20|离散值|of size 134217728
|=====
根据运维经验可知，我们实际要关注的参数位是：参数2、参数6、参数13。
在模型预览页面上，找到对应的模式，在"模式"列点击具体的参数，打开参数设置浮层。分别点击相应的参数位置，查看其取值分布，确认无误以后，点击"关注"即可。
image::images/lynxee-logreduce-parameters.png[]
如果您对数据细节非常关注，并有一定把握的情况下，可以通过页面左上角的批量操作按钮，一键关注模式的全部参数位置。