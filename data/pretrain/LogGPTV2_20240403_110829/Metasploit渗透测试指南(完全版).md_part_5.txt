要完成哪些任务。
1.1.1前期交互阶段
前期交互阶段通常是由你与客户组织进行讨论，来确定渗透测试的范围和目标。这个阶段
最为关键的是需要让客户组织明确清晰地了解渗透测试将涉及哪些自标。而这个阶段也为你提
供了机会，来说服客户走出全范围渗透测试的理想化愿景，选择更加现实可行的渗透测试目标
来进行实际实施。
1.1.2情报搜集阶段
在情报搜集阶段，你需要采用各种可能的方法来搜集将要攻击的客户组织的所有信息，包
括使用社交媒体网络、GoogleHacking技术、目标系统踩点等等。而作为渗透测试者，你最为
重要的一项技能就是对目标系统的探查能力，包括获知它的行为模式、运行机理，以及最终可以
如何被攻击。对目标系统所搜集到的信息将帮助你准确地掌握目标系统所部属的安全控制措施。
在情报搜集阶段中，你将试图通过逐步深入的探测，来确定在目标系统中实施了哪些安全
防御机制。举例来说，一个组织在对外开放的网络设备上经常设置端口过滤，只允许接收发往
特定端口集合的网络流量，而一旦你在白名单之外的端口访问这些设备时，那么你就会被加入
黑名单进行阻断。通常针对这种阻断行为的一个好方法是先从你所控制的其他IP地址来进行初
始探测，而这个IP地址是你预期就会被阻断或者检测到的。当你在探测Web应用程序时，这
个方法也是非常适用的，因为一些保护Web应用程序的Web应用防火墙通常也会在你的探测
请求数量超过一定阈值后对你的IP进行阻断，使得你无法再用这个IP发起任何的请求。
为了使得在做这种类型的探测时保证不被检测到，你可以从那些无法回溯到你或你的团队
的IP地址范围来进行初始扫描。在通常情况下，在互联网上可远程访问的目标系统每天都会遭
遇到一些攻击，而你的初始扫描探测一般会落入那些背景噪声中而不会被发现。
提示：你可以使用一个与你要发起主要攻击行为处于完全不同范围的IP地址，来进行非
常“喧闹”的扫描，这样可以帮助你确定客户组织是否能够很好地检测和响应你所使用的攻
击工具和技术。
1.1.3威胁建模阶段
威胁建模主要使用你在情报搜集阶段所获取到的信息，来标识出自标系统上可能存在的安
2
---
## Page 30
第1章渗透测试技术基础
全漏洞与弱点。在进行威胁建模时，你将确定最为高效的攻击方法、你所需要进一步获取到的
信息，以及从哪里攻破目标系统。在威胁建模阶段，你通常需要将客户组织作为敌手看待，然
后以攻击者的视角和思维来尝试利用目标系统的弱点。
1.1.4漏洞分析阶段
一旦确定最为可行的攻击方法之后，你需要考虑你该如何取得目标系统的访问权。在漏洞
分析阶段，你将综合从前面的几个环节中获取到的信息，并从中分析和理解哪些攻击途径会是
可行的。特别是需要重点分析端口和漏洞扫描结果，搜取到的服务“旗帜”信息，以及在情报
搜集环节中得到的其他关键信息。
1.1.5渗透攻击阶段
渗透攻击可能是在渗透测试过程中最具魅力的环节，然而在实际情况下往往没有你所预想
的时候，才真正对自标系统实施这次渗透攻击，当然在目标系统中很可能存在着一些你没有预
期到的安全防护措施，使得这次渗透攻击无法成功。但是要记住的是，在你尝试要触发一个漏
洞时，你应该清晰地了解在目标系统上存在这个漏洞。进行大量漫无目的的渗透尝试之后期待
奇迹般地出现一个shell根本是痴心妄想，这种方式将会造成大量喧闹的报警，也不会为身为渗
透测试者的你以及你的客户组织提供任何帮助。请先做好功课，然后再针对自标系统实施已经
经过了深入研究和测试的渗透攻击，这样才有可能取得成功。
1.1.6后渗透攻击阶段
后渗透攻击阶段从你已经攻陷了客户组织的一些系统或取得域管理权限之后开始，但离你
搞定收工还有很多事情要做。
那些平庸的骇客小子们的区别，真正从你的渗透测试中为客户提供有价值信息的地方。后渗透
尝试进行安全保护的信息和资产，当你从一个系统攻入另一个系统时，你需要演示出能够对客
户组织造成最重要业务影响的攻击途径。
在后渗透攻击阶段进行系统攻击时，你需要投入更多的时间来确定各种不同系统的用途，
以及它们中不同的用户角色，举例来说，设想你已经攻陷了一个域管理服务器，现在你已经获
取企业管理员账户，或拥有域管理员一级的权限，你或许已经成为整个域的统治者，但你是否
知道与活动目录服务器进行通信的这些系统是干什么用的呢？用来支付客户组织雇员薪水的关
键财务系统在哪里运行呢？你能否攻破这台系统，并在下一轮发薪时，将公司所有的薪水都转
3
---
## Page 31
Metasploit渗透测试指南
设想你的客户组织是一家大型的软件开发外包企业，主营业务是定制开发一些应用软件，
然后发往他们的客户并在一些客户的生产环境中使用。你能否在他们开发的源码中植入后门，
在后渗透测试阶段中，就需要你在这些难以处理的场景中寻找可用信息，激发灵感，并达
成你自己所设置的攻击目标。从攻击者的角度，一个普通的攻击者往往在攻陷系统后将他的大
部分时间用于千篇一律的操作，然而作为一名职业的渗透测试者，你需要像一个恶意攻击者那
样去思考，具有创新意识，能够迅速地反应，并依赖于你的智慧和经验，而不是使用那些自动
化的攻击工具。
1.1.7报告阶段
报告是渗透测试过程中最为重要的因素，你将使用报告文档来交流你在渗透测试过程中做
了哪些，如何做的，以及最为重要的一一客户组织如何修复你所发现的安全漏洞与弱点。
在进行渗透测试时，你是从一个攻击者的角度来进行工作的，这些工作一般客户组织会很
少看到，而你在渗透测试过程中所获取到的信息是增强客户组织的信息安全措施以成功防御未
来攻击的关键所在。当你在编写和报告你的发现时，你需要站在客户组织的角度上，来分析如
何利用你的发现来提升安全意识，修补发现的问题，以及提升整体的安全水平，而并不仅仅是
对发现的安全漏洞打上补丁。
你所撰写的报告至少应该分为摘要、过程展示和技术发现这几个部分，技术发现部分将会
被你的客户组织用来修补安全漏洞，但这也是渗透测试过程真正价值的体现位置。例如，你在
客户组织的Web应用程序中找出了一个SQL注入漏洞，你会在报告的技术发现部分来建议你
的客户对所有的用户输入进行检查过滤，使用参数化的SQL查询语句，在一个受限的用户账户
上运行SQL语句，以及使用定制的出错消息。当你的客户实现了你的建议修补了这个特定的
入漏洞的根本原因是使用了未能确保安全性的第三方应用，而在你的报告中也应该充分地考虑
这些因素，并建议客户组织进行细致检查并消除这些漏洞。
1.2渗透测试类型
到现在为止，你已经对渗透测试的基本技术流程与环节有了一个初步的了解，那接下来让
我们来看看渗透测试的两种基本类型：白盒测试与黑盒测试。白盒测试，有时也被称为“白帽
测试”，是指渗透测试者在拥有客户组织所有知识的情况下所进行的测试；而黑盒测试则设计为
势和弱点。
4
---
## Page 32
第1章渗透测试技术基础
1.2.1白盒测试
使用白盒测试，你需要和客户组织一起工作，来识别出潜在的安全风险，客户组织的IT支
部知识，并可以在不需要害怕被阻断的情况下任意地实施攻击。而白盒测试的最大问题在于无
法有效地测试客户组织的应急响应程序，也无法判断出他们的安全防护计划对检测特定攻击的
效率。如果时间有限，或是特定的渗透测试环节如情报搜集并不在范围之内的话，那么白盒测
试可能是你最好的选项。
1.2.2黑盒测试
与白盒测试不同的是，经过授权的黑盒测试是设计成为模拟攻击者的入侵行为，并在不了
解客户组织大部分信息和知识的情况下实施的。黑盒测试可以用来测试内部安全团队检测和应
对一次攻击的能力。
黑盒测试是比较费时费力的，同时需要渗透测试者具备更强的技术能力。在安全业界的渗
透测试者眼中，黑盒测试通常是更受推崇的，因为它更逼真地模拟了一次真正的攻击过程。黑
盒测试依靠你的能力通过探测获取目标系统的信息，因此，作为一次黑盒测试的渗透测试者，
你通常并不需要找出目标系统的所有安全漏洞，而只需要尝试找出并利用可以获取自标系统访
问权代价最小的攻击路径，并保证不被检测到。
1.3漏洞扫描器
漏洞扫描器是用来找出指定系统或应用中安全漏洞的自动化工具。漏洞扫描器通常通过获
取目标系统的操作系统指纹信息来判断其类型与版本，以及上面所运行的所有服务，一旦已经
获取目标系统的操作系统与服务类型，你就可以使用漏洞扫描器执行一些特定的检查，来确定
存在着哪些安全漏洞。当然这些检查例程的质量取决于他们的开发者，而且与任何完全自动化
的解决方案一样，它们在很多时候会漏掉或是错误标识系统上的安全漏洞。
最新的漏洞扫描器在降低误报率方面已经取得了非常好的效果，一些组织经常使用它们来
找出已公开的系统漏洞，或是一些潜在的新漏洞，避免被攻击者所利用。漏洞扫描器在渗透测
试中也起到了一个非常关键的作用，特别是在充许你同时发起多次攻击而无须考虑如何躲避检
测的白盒测试场景中。从漏洞扫描器中获取到的知识可能是非常有价值的，但小心不要过分地
依赖它们。渗透测试的美妙之处在于它不是一个千篇一律的自动化过程，成功地攻击系统通常
需要你掌握更多的知识和技能。在大多数情况下，当你成为一名资深的渗透测试师之后，你将
很少使用漏洞扫描器，而是依靠你自已的知识和专业技能来攻破系统。
5
---
## Page 33
Metasploit渗透测试指南
1.4小结
如果你刚刚涉足渗透测试领域，或者还未了解一个标准化的方法体系，请学习一下渗透测
试执行标准PTES。在进行任何实验、执行一次渗透测试时，请确信你拥有一个细化的、可实施
的技术流程，而且还应该是可以重复的。作为一一名渗透测试者，你需要确保不断地修炼情报搜
集与漏洞分析技能，并尽可能达到精通的水平，这些技能在渗透测试过程中将是你面对各种攻
击场景时的力量之源。
PDG
6
---
## Page 34
第
章
Metasploit基础
当你第一次接触Metasploit渗透测试框架软件（MSF）时，你可能会被它提供如此多的接
口、选项、变量和模块所震撼，而感觉无所适从。在本章中，我们将聚焦Metasploit 基础，帮
助你能够从纷扰繁杂的Metasploit世界中淌出一条道路，让你快速地掌握Metasploit的基本用法。
我们将首先回顾一些基本的渗透测试术语，然后将简要地描述Metasploit所提供的不同用户接
口。Metasploit本身是免费的开源软件，在安全社区中拥有很多的贡献者，但Metasploit也存在
着两个商业版本。
在第一次使用Metasploit时，很重要的一点是：不光要关注于那些最新的渗透模块，而且
应该关注Metasploit是如何进行攻击的，以及你可以使用哪些命令来使得渗透成功实施。
2.1专业术语
在整本书中，我们将使用以下专业术语，在此首先给出一些解释。大部分以下的基础术语
是在Metasploit框架上下文环境中进行定义的，但通常它们的含义在整个安全业界都是通用的。
---
## Page 35
Metasploit渗透测试指南
2.1.1渗透攻击（Exploit）
渗透攻击是指由攻击者或渗透测试者利用一个系统、应用或服务中的安全漏洞，所进行的
攻击行为。攻击者使用渗透攻击去入侵系统时，往往会造成开发者所没有预期到的一种特殊结
果。流行的渗透攻击技术包括缓冲区溢出、Web应用程序漏洞攻击（比如SQL注入)，以及利
用配置错误等。
2.1.2攻击载荷（Payload）
攻击载荷是我们期望目标系统在被渗透攻击之后去执行的代码，在Metasploit框架中可以
自由地选择、传送和植入。例如，反弹式shell是一种从目标主机到攻击主机创建网络连接，并
绑定到一个打开的监听端口，攻击者可以连接这些端口来取得shell交互。攻击载荷也可能是简
单的在目标操作系统上执行一些命令，如添加用户账号等。
2.1.3Shellcode
Shellcode是在渗透攻击时作为攻击载荷运行的一组机器指令。Shellcode通常用汇编语言编
写。在大多数情况下，目标系统执行了Shellcode这一组指令之后，才会提供一个命令行shell
或者Meterpretershell，这也是Shellcode名称的由来。
2.1.4模块（Module）
在本书的上下文环境中，一个模块是指Metasploit 框架中所使用的一段软件代码组件。在
某些时候，你可能会使用-个渗透攻击模块（exploitmodule），也就是用于实际发起渗透攻击的
软件组件。而在其他时候，则可能使用一个辅助模块（auxiliary module），用来执行一些诸如扫
描或系统查点的攻击动作。这些在不断变化和发展中的模块才是使Metasploit框架如此强大的
核心所在。
2.1.5监听器（Listener）
监听器是Metasploit中用来等待连入网络连接的组件，举例来说，在目标主机被渗透攻击
之后，它可能会通过互联网回连到攻击主机上，而监听器组件在攻击主机上等待被渗透攻击的
系统来连接，并负责处理这些网络连接。
2.2Metasploit用户接口
Metasploit软件为它的基础功能提供了多个用户接口，包括终端、命令行和图形化界面
8
---
## Page 36
第2章Metasploit基础
等。除了这些接口之外，功能程序（utilities）则提供了对Metasploit框架中内部功能的直接
访问，这些功能程序对于渗透代码开发，以及在一些你不需要整体框架灵活性的场合中非常
有价值。
2.2.1MSF终端
MSF终端（msfconsole）是目前Metasploit框架最为流行的用户接口，而这也是非常自然的，
因为MSF终端是Metasploit框架中最灵活、功能最丰富以及支持最好的工具之一。MSF终端提
供了一站式的接口，能够访问Metasploit框架中几乎每一个选项和配置，就好比是你能够实现
所有渗透攻击梦想的大超市。你可以使用MSF终端做任何事情，包括发起一次渗透攻击、装载
辅助模块、实施查点、创建监听器，或者对整个网络进行自动化渗透攻击。
尽管Metasploit框架在不断的发展和更新中，它的命令集合还是保持着相对的稳定。通过
熟练掌握MSF终端的基本使用方法，你可以跟上Metasploit的所有更新。在本书所有的章节中，
我们都将使用MSF终端进行演示。
●启动MSF终端
启动MSF终端的方法非常简单，只需要在命令行中输入msfconsole。
root@bt:/#cd/opt/framework3/msf3/
root@bt:/opt/framework/msf3#msfconsole
（）
[|--11*
msf >
访问MSF终端的帮助文件，只需要输入help，并可以加上你所感兴趣的metasploit命令。
在下面这个例子中，我们对connect命令来搜索它的使用帮助，这个命令可以允许我们与一
台主机进行通信。显示的结果文档会列出使用方法、对该命令的描述，以及各种不同的配置
选项。
msf>helpconnect
我们将在后继章节中更加深入地来探索与了解MSF终端。
2.2.2MSF命令行
MSF命令行和MSF终端为Metasploit框架访问提供了两种截然不同的途径，MSF终端以
一种用户友好的模式来提供交互方式，用于访问软件所有的功能特性，而msfcli则主要考虑脚
---
## Page 37
Metasploit渗透测试指南
本处理和与其他命令行工具的互操作性。Msfcli可以直接从命令行shell执行，并允许你将其他工
具的输出重定向至msfcli中，以及将msfcli的输出重定向给其他的命令行工具。msfcli还支持启
动各种渗透攻击和辅助模块，这为框架软件测试和开发新的渗透攻击代码提供了非常便捷的方
式，在你明确知道你需要使用哪个渗透攻击模块和所需要的配置参数时，它将是高效率实施渗透
攻击的绝妙工具。msfcli提供了一些基本的帮助文档（包括使用说明和一个使用模式列表），
可以通过msfcli-h命令进行显示：
root@bt:/opt/framework3/msf3#msfcli-h
Mode
Description
==
(H)elp
You're looking at it, baby!
(S)ummary
Show information about this module
(0)ptions
Show available optionsfor this module
(A)dvanced
Show available advanced options for this module
(I)DS Evasion
Show available ids evasion options for this module
(P)ayloads
Show available payloads for this module
(T)argets
Show available targets for this exploit module
(AC)tions
Show available actionsfor this auxiliary module
(C)heck
Runthecheck routine of the selected module
(E)xecute
Execute the selected module
root@bt:/opt/framework3/msf3#
）使用示例
来让你对如何使用这个接口有一个初步的印象。
当你刚开始学习Metasploit，或者遇到困难不知道如何输入命令参数的时候，你可以在你输
入的字符串命令后面加上一个字符“0”，就可以看到这个模块中所提供的配置参数。在下面的
例子中，我们使用字符“o”就可以查看ms08_067_netapi模块的配置参数选项。
root@bt:/#msfcliwindows/smb/ms08_o67_netapi0
[*]Please wait while we load the module tree...
Name