title:Can Encrypted DNS Be Fast?
author:Austin Hounsel and
Paul Schmitt and
Kevin Borgolte and
Nick Feamster
Can Encrypted DNS Be Fast?
Austin Hounsel1(B), Paul Schmitt1, Kevin Borgolte2, and Nick Feamster3
1 Princeton University, Princeton, NJ 08544, USA
{ahounsel,pschmitt}@cs.princeton.edu
2 TU Delft, 2628 BX Delft, The Netherlands
PI:EMAIL
3 University of Chicago, Chicago, IL 60637, USA
PI:EMAIL
Abstract. In this paper, we study the performance of encrypted DNS
protocols and conventional DNS from thousands of home networks in the
United States, over one month in 2020. We perform these measurements
from the homes of 2,693 participating panelists in the Federal Commu-
nications Commission’s (FCC) Measuring Broadband America program.
We found that clients do not have to trade DNS performance for pri-
vacy. For certain resolvers, DoT was able to perform faster than DNS
in median response times, even as latency increased. We also found sig-
niﬁcant variation in DoH performance across recursive resolvers. Based
on these results, we recommend that DNS clients (e.g., web browsers)
should periodically conduct simple latency and response time measure-
ments to determine which protocol and resolver a client should use. No
single DNS protocol nor resolver performed the best for all clients.
Keywords: DNS · Privacy · Security · Performance
1 Introduction
The Domain Name System (DNS) is responsible for translating human-readable
domain names (e.g., nytimes.com) to IP addresses. It is a critical part of the
Internet’s infrastructure that users must interact with before almost any com-
munication can occur. For example, web browsers may require tens to hundreds
of DNS requests to be issued before a web page can be loaded. As such, many
design decisions for DNS have focused on minimizing the response times for
requests. These decisions have in turn improved the performance of almost every
application on the Internet.
In recent years, privacy has become a signiﬁcant design consideration for
the DNS. Research has shown that conventional DNS traﬃc can be passively
observed by network eavesdroppers to infer which websites a user is visiting [2,
25]. This attack can be carried out by anyone that sits between a user and their
recursive resolver. As a result, various protocols have been developed to send
DNS queries over encrypted channels. Two prominent examples are DNS-over-
TLS (DoT) and DNS-over-HTTPS (DoH) [8,10]. DoT establishes a TLS session
c(cid:2) The Author(s) 2021
O. Hohlfeld et al. (Eds.): PAM 2021, LNCS 12671, pp. 444–459, 2021.
https://doi.org/10.1007/978-3-030-72582-2_26
Can Encrypted DNS Be Fast?
445
over port 853 between a client and a recursive resolver. DoH also establishes a
TLS session, but unlike DoT, all requests and responses are encoded in HTTP
packets, and port 443 is used. In both cases, a client sends DNS queries to a
recursive resolver over an encrypted transport protocol (TLS), which in turn
relies on the Transmission Control Protocol (TCP). Encrypted DNS protocols
prevent eavesdroppers from passively observing DNS traﬃc sent between users
and their recursive resolvers. From a privacy perspective, DoT and DoH are
attractive protocols, providing conﬁdentiality guarantees that DNS lacked.
Past work has shown that typical DoT and DoH query response times are
typically marginally slower than DNS [3,9,14]. However, these measurements
were performed from university networks, proxy networks, and cloud data cen-
ters, rather than directly from homes. It is crucial to measure DNS performance
from home networks in situ, as they may be diﬀerently connected than other net-
works. An early study on encrypted DNS performance was conducted by Mozilla
at-scale with real browser users, but they did not study DoT, and they did not
explore the eﬀects of latency to resolvers, throughput, or Internet service provider
(ISP) choice on performance [15]. Thus, the lack of controlled measurements pre-
vents the networking community from fully understanding how encrypted DNS
protocols perform for real users.
In this work, we provide a large-scale performance study of DNS, DoT, and
DoH from thousands of home networks dispersed across the United States.
We perform measurements from the homes of 2,693 participating panelists
in the Federal Communications Commission’s (FCC) Measuring Broadband
America program from April 7th, 2020 through May 8th, 2020. We measure
query response times and connection setup times using popular, open recursive
resolvers, as well as resolvers provided by local networks. We also study the
eﬀects of latency to resolvers, throughput, and ISP choice on query response
times.
2 Method
In this section, we describe the measurement platform we used to study DNS,
DoT, and DoH performance and outline our analyses. We then describe the
experiments we conduct and their limitations.
2.1 Measurement Platform
The FCC contracts with SamKnows [20] to implement the operational and logis-
tical aspects of the Measuring Broadband America (MBA) program [6]. Sam-
Knows is a company that specializes in developing custom software and hard-
ware (also known as “Whiteboxes”) to evaluate the performance of broadband
access networks. Whiteboxes act as Ethernet bridges that connect directly to
existing modems/routers, which enables us to control for poor Wi-Fi signals
and cross-traﬃc. In accordance with MBA program objectives, SamKnows has
deployed Whiteboxes to thousands of volunteers’ homes across the United States.
446
A. Hounsel et al.
We were granted access to the MBA platform through the FCC’s MBA-Assisted
Research Studies program (MARS) [5], which enables researchers (generally from
the United States) to run measurements from the Whiteboxes. We utilize the
platform to evaluate how DNS, DoT, and DoH perform from home networks.
We perform measurements from each Whitebox using SamKnows’ DNS query
tool. For each query, the tool reports a success/failure status (and failure reason,
if applicable), the DNS resolution time excluding connection establishment (if
the query was successful), and the resolved record [19]. For DoT and DoH,
the tool separately reports the TCP connection setup time, the TLS session
establishment time, and the DoH resolver lookup time. For this study, we only
study queries for ‘A’ and ‘AAAA’ records. We note that queries for DNS and
DoT are sent synchronously, i.e., they must each receive a response before the
next query can be sent. On the other hand, DoH queries are sent asynchronously,
functionality that is enabled by the underlying HTTP protocol.
The query tool handles failures in several ways. First, if a response with an
error code is returned from a recursive resolver (e.g., NXDOMAIN or SERV-
FAIL), then the matching query is marked as a failure. Second, if the tool fails
to establish a DoT or DoH connection, then all queries in the current batch
(explained in Sect. 2.3) are marked as failures. Third, the query tool times out
conventional DNS queries after three seconds, at which point it re-sends them.
If three timeouts occur for a given query, the tool marks the query as a failure.
Finally, the query tool marks DoT/DoH queries as failures if either ﬁve seconds
have passed or if TCP hits the maximum number of re-transmissions allowed by
the operating system’s kernel (Linux 4.4.79). The Whiteboxes we measure use
the default TCP settings conﬁgured by the kernel (e.g., net.ipv4.tcp frto = 2,
net.ipv4.tcp retries1 = 3, and net.ipv4.tcp retries2 = 15 ).
In total, we collected measurements from 2,804 Whiteboxes, each of which
use the latest generation of hardware and software (8.0) [21]. Our measurements
were performed continuously from April 7th, 2020 through May 8th, 2020 in
collaboration with SamKnows and the FCC. We ﬁltered out certain Whiteboxes
from our analysis in several ways. First, we ﬁltered out 56 Whiteboxes that
we did not have any network conﬁguration information about (e.g., ISP speed
tier, ISP name, and access technology). Second, we ﬁltered out 25 Whiteboxes
that were connected by satellite. Third, we ﬁltered out 30 Whiteboxes for which
we did not know the access technology or ISP speed tier. This left us with
2,693 Whiteboxes to analyze, with 96% of queries marked as successful. The
Whiteboxes were connected to 14 ISPs over cable, DSL, and ﬁber.
2.2 Analyses
We studied DNS, DoT, and DoH performance across several dimensions: con-
nection setup times, query response times for each resolver and protocol, and
query response times relative to latency to resolvers, throughput, and ISPs. Our
analyses are driven by choices that DNS clients are able to make (e.g., which
protocol and resolver to use) and how these choices aﬀect DNS performance.
Can Encrypted DNS Be Fast?
447
Connection Setup Times. Before any query can be issued for DoT or DoH,
the client must establish a TCP connection and a TLS session. As such, we
measure the time to complete a 3-way TCP handshake and a TLS handshake.
Additionally, for DoH, we measure the time to resolve the domain name of the
resolver itself. The costs associated with connection establishment are amortized
over many DoT or DoH queries as the connections are kept alive and used
repeatedly once they are open. We study connection setup times in Sect. 3.1.
DNS Response Times. Query response times are crucial for determining the
performance of various applications. Before any resource can be downloaded
from a server, a DNS query often must be performed to learn the server’s IP
address (assuming a response is not cached). As such, we study query response
times for each resolver and protocol in Sect. 3.2. We remove TCP and TLS
connection establishment time from DoT and DoH query response times. The
DNS query tool we use closes and re-establishes connections after ten queries
(detailed in Sect. 2.3). As this behavior is unlikely to mimic that of stub resolvers
and web browsers [7,16,17], we remove connection establishment times to avoid
negatively biasing the performance of DoT and DoH.
DNS Response Times Relative to Latency and Throughput. Con-
ventional DNS performance depends on latency, as the protocol is relatively
lightweight; therefore, latency to the DNS resolver can have a signiﬁcant eﬀect
on overall performance. Furthermore, encrypted DNS protocols may perform
diﬀerently than conventional DNS in response to higher latency, as they are
connection-oriented protocols. We study the eﬀect of latency on query response
times for each open resolver and protocol in Sect. 3.3. SamKnows also provides
us with the subscribed downstream and upstream throughput for each White-
box. We use this information to study the eﬀect of downstream throughput on
query response times in Sect. 3.3.
DNS Response Times Relative to ISP Choice. Lastly, SamKnows provides
us with the ISP for each Whitebox. We study query response times for a selection
of ISPs in Sect. 3.4.
2.3 Experiment Design
We describe below which recursive resolvers and domain names we perform mea-
surements with and how we arrived at these choices.
DNS Resolvers. For each Whitebox, we perform measurements using three
popular open recursive DNS resolvers (anonymized as X, Y, and Z, respec-
tively1), as well as the recursive resolver automatically conﬁgured on each White-
box (the “default” resolver). Typically, the default resolver is set by the ISP that
1 We anonymize the resolvers as per our agreement with the FCC.
448
A. Hounsel et al.
Table 1. Recursive resolver latency characteristics.
Resolver
Observations Latency (ms)
Minimum Median Maximum Std dev
X DNS and DoT 1,593,506
X DoH
1,567,337
Y DNS and DoT 1,596,964
Y DoH
1,552,595
Z DNS and DoT 1,579,605
Z DoH
1,533,380
Default DNS
2,009,086
0.94
0.14
2.00
0.14
2.35
0.14
0.13
20.38
22.75
20.90
20.50
31.41
33.00
0.85
5,935.80
8,929.88
9,701.82
43.61
43.25
46.79
10,516.31
40.68
516,844.73 414.26
9,537.42
8,602.39
41.11
22.93
the Whitebox is connected to. Resolvers X, Y, and Z all oﬀer public name res-
olution for DNS, DoT, and DoH. However, the default resolver typically only
supports DNS. As such, for the default resolver, we only perform measurements
with conventional DNS. If a Whitebox has conﬁgured Resolver X, Y, or Z as
its default resolver, then we leave its default resolver measurements out of our
analysis.
In Table 1, we include the latency to each resolver across all Whiteboxes. We
measure latency by running ﬁve ICMP ping tests for each resolver at the top of
each hour and computing the average. We separate latency to DoH resolvers from
latency to DNS and DoT resolvers because the domain names of DoH resolvers