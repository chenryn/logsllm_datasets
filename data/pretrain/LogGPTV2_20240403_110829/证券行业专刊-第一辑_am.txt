互联网资产测绘引擎对于攻防双方而言都有利有弊。一方面防守 方利用 zommeye、fofa、Shodan、censys 等测绘引擎，搜索域 名、IP、关键字、证书、应用、端口等盘点互联网资产，包括利 用 icon_hash 发现隐蔽资产，收敛攻击面，另一方面，攻击者也利
某些特定的情况下，防守方网站可以接收到测绘引擎转发的攻击者 对页面访问请求，HTTP 头里的 X-Forwarded-For 字段带了攻 击者的 IP，这一般是个明确的攻击信号，而且由于还处于非直接 接触的信息收集阶段，大意的攻击者可能还没意识到伪装自己，除 了 IP 外，user…agent 也会暴露一些特征，防守方可以据此触发相 关应急与溯源。类似的还有 DNS 回显平台，攻防双方都可以利用来核查某些漏 洞。计划外的、未知的来自互联网边界或内部服务器对外的 DNS 回显请求也是一个明确的攻击信号（dnslog.cn、ceye.io、dnslog. link、dnslog.io、tu4.org、s0x.cn、burpcollaborator.net、yunsee.cn、awvsscan119.autoverify.cn 等等），这通常意味着有 漏洞已经被触发了，需要高度警惕，防守方需要实时监测、封禁服 务器对外的 DNS 回显请求 , 要应急处置已触发的漏洞。
七、真实案例
介绍一个实战的案例，2020 年网络实战攻防演练的某日，一个攻 击 IP 触发了防守方 WAF 的告警，我们分析发现是针对在线客服 的钓鱼攻击，试图诱导客服人员下载以“浏览器更新插件 .exe”
用它们探测防守方资产信息和漏洞。Checkpoint…在 2016 发布的 	等名字伪装的恶意程序。一篇博客建议阻断…Shodan…scanners…ip（https://blog.checkpoint.
com/2016/01/04/check-point-threat-alert-shodan/），当然，
在 siem 平台做进一步的分析，发现攻击者先后使用了 4 个攻击 IP…
78 	79
网络攻防实战的战术思考
对防守方进行多次探测和恶意程序投递。
( 攻击 IP：8.x.x.17、139.x.x.98、129.x.x.12、129.x.x.193；
投放服务器：139.x.x.159、47.x.x.170)
下载恶意程序样本“浏览器更新插件 .exe”在 IDA 中静态分析，
并在沙盒中运行进行动态分析，发现其流程如下：
1)… 样本运行之后，分别释放 browser_extension.exe 和 conhost.
exe 两个可执行文件到 TEMP 目录，然后分别执行；exe 两个可执行文件到 TEMP 目录，然后分别执行；
2)…browser_extension.exe 执行，仅弹出消息框显示更新浏览器插 
	件、延时、显示更新完毕，无其他实质行为；
……
	5)… 收集主机信息包括 ComputerName、UserName、OSVersion 	等作为上线数据包发送至 C2 服务器；
6)…回连 C2 服务器…6500 端口 , 可响应 C2 服务器远程指令，包括 
	远程 Shell、磁盘文件管理等。
查询 C2…IP，为位于深圳的云主机，利用相关威胁情报平台对 C2…IP 进行拓线分析，发现相近时期内存在多个恶意通信样本，样本 中包含同一攻击者的多封钓鱼邮件。钓鱼邮件里携带的附件是伪装 成 PDF 格式的 .exe 恶意程序，同样采用了文件捆绑、伪证书签名、
…3)…conhost.exe 则为主要的恶意木马模块，使用伪造的 12306 证 	C2 回连等攻击手段。书签名；（图见右上）
…	其中样本一捕获了攻击者发件地址 1，经查询邮件网关日志，发件
4)… 绑定监听本机 8900 端口和 6000 端口，通过内置的 lanproxy 	组件进行内网穿透实现 BindShell；
地址 1 曾对防守方进行过投递，但因收件人错误，被邮件网关丢弃。样本二捕获了攻击者发件地址 2，发件 IP2(139.x.x.159)，查询邮
80 	81
网络攻防实战的战术思考网络攻防实战的战术思考
件网关日志，发现发件地址 2 也曾经投递钓鱼邮件，但因 IP2 信誉 值过低被邮件网关拒绝。发件地址 2 包含攻击者私有域名，查询 域名 MX 的信息指向最初的四个攻击 IP 之一 (8.x.x.17,139)，域名 SPF 的信息则指向 IP2，同时也是前面提到的投放服务器之一（139. x.x.159）。我们推测攻击者先使用邮件进行了简单的尝试，失败 后转而攻击在线客服，日志显示攻击者以 js、jpg、svg、exe 等不 同文件格式进行了大量的尝试。值得注意的是，与以往伪装成客户，以咨询开户社工客服人员的常见套路不同，攻击者使用的话术是伪 装成系统的升级提示信息（“不支持当前用户发送的消息格式，请 点击此处下载最新 ET 系统浏览器插件！”、“ET 系统当前浏览 器插件已更新，请安装！”），这是此前的安全意识教育未曾警示 过的方式，极具欺骗性。利用两个邮件地址、私有域名信息，我们溯源到攻击者虚拟身份、真实身份、通讯方式、毕业院校、工作单位等信息以及具备工具开 发能力、具有移动安全经验等攻击能力画像。
备指纹，12…个攻击 IP…，2 个投放服务器，2 个 C2…IP，并对其中 一台…C2 服务器（121.x.x.144）成功溯源。
我们从最初的 WAF 告警出发，关联威胁情报、邮件网关日志，结 合安全设备日志与业务埋点数据，拓展线索，辅以 NTA、全流量 回溯支持，完整还原了攻击者的攻击路径、攻击方式，分析了本次 攻击采用的技战法，包括钓鱼先行、可执行文件捆绑、伪证书欺骗、内网穿透、私有域名、C2 基础设施等，并通过溯源掌握了攻击者 的更多信息与技术能力画像。本案例给我们很多启发，攻击者尽管犯了一些错误，但整体来说仍 然是非常强大的对手，工具、技能、基础设施完备，战术应用得当，而且一击即走，毫不恋战，社工的手段更是新颖独特。被拒绝的邮 件也隐含线索，情报共享拓展了方向，无意间发现的业务埋点数据 与安全结合，打开了我们平战结合的思路。兵无常势，水无常形，网络攻防的博弈是动态的，攻与防的技术在不断革新进步，我们不 能墨守成规、作茧自缚，网络安全的作战要根据形势的变化来采取 灵活机动的战略战术。
作者介绍 	SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN结合利用业务大数据埋点分析系统，我们把同一段时间内的攻击 	陈凯晖，安全架构师 安全老兵。
IP 与 device-id…双向关联、拓展分析，最终定位到 3 个攻击者设
SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN    SEC-UN 
|  |  |
|---|---|
| 82 |83 |
构建邮件纵深安全体系，
提升互联网重要入口安全运营水平
——海通证券安全运营实践分享
海通证券数据中心
 沈俞超  徐文韬  马冰  郑熊  王东海通证券数据中心
 沈俞超  徐文韬  马冰  郑熊  王东
一、海通证券邮件安全体系演进
在近年来举行的国家级攻防演练和常态化攻防对抗中，邮件系统和 
互联网暴露面成为攻击队撕开缺口的重点方向，尤其是邮件攻击
“成本低廉、效果直接”，成为了攻击者突破边界的最好手段。历 
史统计数据显示“网络攻击中有 91% 将电子邮件作为攻击入口”，
85
构建邮件纵深安全体系，提升互联网重要入口安全运营水平
2021 年 9 月“白象”组织利用新冠肺炎疫情相关热点，冒充相关 机构对我国 20 余家单位发起定向攻击，都在传递着一个信息，邮 件入口的防护体系需要动态调整，防护和检测水平需要逐步提升。
海通证券的邮件系统防护理念和水平是通过不断的对抗逐步提升 的。我们在邮件安全攻防对抗过程中，逐步总结出邮件安全演化所 经历的四代模型，从而针对邮件安全体系进化做到了有的放矢。
……
则不在主机入侵检测的防范范围内。
Step4. 绕过 NDR/ 恶意 URL 拦截：
当文件被收件用户点击后，以全程加密的方式和攻击者的 VPS 建 立连接，使得 NTA 无法发现传输内容中的命令执行；或是在最初 注册全新域名，使得恶意钓鱼域名不在威胁情报库的范围内，绕过 针对 DNS 解析的恶意域名拦截。
二、邮件系统重点威胁 	海通证券总结得出在邮件维度，攻击者的攻击主要可分为邮件本体
攻击和邮箱资产攻击，将在下文 2.2 及 2.3 中做详细介绍。
2.2 邮件本体攻击
2.1 攻击者攻击过程 
Step1. 绕过邮件网关：
通过新型的钓鱼邮件、商业欺诈邮件、附件样本变形的恶意邮件、APT 邮件等多种形式，直接穿透以规则过滤的邮件网关。
Step2. 绕过沙箱检测：
对攻击邮件的附件部分进行压缩加密、加壳、内容混淆、远程加载 宏等方式处理，使得通过静态查杀或简单动态查杀的沙盒无法发现 附件中藏有的恶意威胁文件。Step3. 绕过主机入侵检测：
恶意文件调用底层函数进内核，或是使用偏僻语言的小众工具，在
通过攻防对抗复盘，
2.2.1 附件载体 面对种类繁多利用 恶意附件进行攻击 的手段，安全团队 重点考虑如何提取 出攻击特征来进行 宏观检测。例如免 杀的Office宏病毒、
恶意邮件的利用方 
式通常是通过两种 
载体：附件和正文