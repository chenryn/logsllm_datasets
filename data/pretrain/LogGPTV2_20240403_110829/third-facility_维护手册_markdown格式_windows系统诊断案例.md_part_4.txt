![](media/image74.jpeg){width="4.973333333333334in"
height="0.3466655730533683in"}
> 这个案例中，查看 C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319
> 缺失了
> ngen.exe，同时该目录下还缺失了很多其他文件，建议相同版本正常机器尝试拷贝文件测试或者重置系统。
![](media/image75.jpeg){width="4.877949475065617in"
height="1.8256244531933508in"}
> 注：如果是多个补丁安装失败的情况，建议只选择一个补丁进行安装，针对这个补丁先看一下具体的报错。
## [查找更新时报错？ 2 个方案解决](#_bookmark1)
> 简介：Windows update 查找更新时遇到报错的案例。
1.  查看具体报错，代码为 8007000e。
![](media/image76.jpeg){width="4.891272965879265in"
height="1.4198950131233596in"}
> 解析这个错误代码，表示"ran out of memory"，内存不足的意思。
>
> 关于错误代码的解析，请参考如下链接。
![](media/image77.jpeg){width="4.8676148293963255in"
height="0.4547911198600175in"}
2.  查看内存占用量，确实不是很多（客户系统总共才 2G
    内存），而且系统日志一直有内存资源不足的告警。
> ![](media/image78.jpeg){width="4.973375984251969in" height="0.77in"}
>
> 针对这种问题，建议方案如下：
1.  增加物理内存。
2.  设置虚拟内存来增加内存使用量（但是 ecs
    > 使用须知不建议使用虚拟内存，因此最直接的方案还是方案 1
    > 增加物理内存）。
> 注：设置虚拟内存后需要重启服务器生效。
![](media/image79.jpeg){width="4.409477252843395in"
height="4.384478346456693in"}
## ["此更新不适用于你的计算机"的 3 个排查方法](#_bookmark1)
> 简介：对于报错"此更新不适用于你的计算机"的几大原因分析。
>
> 对于报错"此更新不适用于你的计算机"，大部分都是由于补丁确实不适用于当前系统，可能原因如下：
1.  系统版本不一致，比如补丁是适用于 windows 2012 的，但是客户系统版本是
    windows2012R2。
2.  系统架构不一致，比如补丁是适用于 X86 系统的，但是客户系统是 X64 的。
3.  客户已经安装了更新的补丁，如何查看：
> 打开补丁官方链接，找到 文件信息》对应系统版本》对应文件版本。以下以
> KB3042553 示例。
a.  打开
    > [https://support.microsoft.com/zh-cn/help/3042553/ms15-034-vulnerabil-]{.underline}
    > [ity-in-http-sys-could-allow-remote-code-execution-a]{.underline}
b.  可以看到这个补丁是用来更新 http.sys 的，对于 windows server 2012R2
    > 安装完这个补丁后 http.sys 将被更新到 6.3.9600.17712。
> ![](media/image80.jpeg){width="4.700009842519685in"
> height="2.8916666666666666in"}
c.  对比系统当前 http.sys 版本信息为 6.3.9600.18730，高于 KB3042553
    > 的版本，这种情况下 KB3042553
    > 补丁安装就会提示"此更新不适用于你的计算机"。
![](media/image81.jpeg){width="4.89127624671916in"
height="1.9933333333333334in"}
## [更新安装报错的 3 个实战分析](#_bookmark0)
> 简介：针对 windows 更新安装报错的实战分析。
### 案例 1
> 补丁安装失败，重启后补丁回滚并且服务器启动报错 bootmgr is missing。
![](media/image82.png){width="4.761823053368329in"
height="1.400624453193351in"}![](media/image83.png){width="3.5268744531933507in"
height="1.0415616797900262in"}
#### 排查
1.  查看 cbs log，回滚之前的报错是 copy bootmgr
    > 的时候报错了，这个就解释了为什么启动会报错 bootmgr is missing。
> 错误代码是 0x5, 这个一般表示是 acessdenied，没有权限。
>
> ![](media/image84.png){width="4.897099737532808in"
> height="1.3383333333333334in"}
2.  单独下载一个补丁，手动安装时发现直接报错 80070005。
3.  对于此类 access denied 的问题，可以收集 procmon
    看一下具体是什么导致了access denied。
    a.  从下面链接下载并且解压该工具：
> [[http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx]{.underline}](http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx)
b.  在出问题的机器上，双击 Procmon.exe 文件 ( 管理员身份打开 )
    > 来抓取进程 ,您将会看到工具开始抓取进程。
c.  当 Process Monitor 工具运行的时候 , 请重现该问题。
d.  当问题完全重现 , 在该软件的窗口中点击 File -\> Capture Events
    > 来停止工具的运行 . 然后点击 File -\> Save 来保存日志文件。
```{=html}
```
4.  收集 procmon 日志，发现在向 C 盘根目录写入文件报错了。
![](media/image85.png){width="4.891274059492563in"
height="0.8510411198600175in"}
5.  查看 C 盘根目录的权限，发现其中有一条是拒绝用户写入的权限。
> ![](media/image86.jpeg){width="4.94875656167979in"
> height="2.142915573053368in"}
#### 解决方案
> 将用户的拒绝权限删除后，补丁成功安装，服务器正常启动。
### 案例 2
> 补丁安装报错 80070005。
![](media/image87.jpeg){width="4.5306397637795275in"
height="1.9043744531933509in"}
#### 排查
1.  查看
    c:\\windows\\logs\\cbs\\cbs.log，看到在解压补丁的时候就报错了，这种多是跟三方组件有关（客户装有
    360 和安全狗），建议客户卸载，客户不同意卸载。
> ![](media/image88.jpeg){width="4.933537839020122in"
> height="0.123332239720035in"}
2.  收集 procmon 日志，看到安全狗一直对文件在进行读写请求。
![](media/image89.jpeg){width="4.921874453193351in" height="0.39375in"}
#### 解决方案
> 卸载安全狗后，补丁成功安装。
### 案例 3
> 安装补丁报错 80070005。
![](media/image90.jpeg){width="4.96503937007874in" height="1.61in"}
#### 排查
> 需要查看 c:\\windows\\windowsupdate.log（主要是下载过程）和
> c:\\windows\\ logs\\cbs（主要是安装过程），看到报错 Failed to query
> interface passed in handler for IID_ICbsUIHandler. \[HRESULT =
> 0x80070005 - E\_ ACCESSDENIED\]。
>
> ACCESSDENIED 报错表示拒绝访问，一般怀疑是三方组件的影响，禁用三方服务
>
> 后，报错依旧。
![](media/image91.jpeg){width="4.973330052493439in"
height="0.15333223972003499in"}
#### 解决方案
> 运行 dcomcnfg
> 打开组件服务，在组件服务------计算机------我的电脑上点击右键------属性，按如下截图所示设置。
![](media/image92.jpeg){width="4.848957786526684in"
height="3.130207786526684in"}
# [第五章 windows 服务问题排查](#_bookmark1)
## [服务启动失败？ 2 步轻松搞定](#_bookmark1)
> 简介：本篇文章带你从几大方面排查服务启动失败的问题。服务启动失败的问题，从以下几个方面进行排查：
1.  服务的属性信息是否正确，包括可执行文件的路径，登录身份，依存关系。
![](media/image93.png){width="4.892709973753281in"
height="3.1120833333333335in"}
> ![](media/image94.png){width="2.368323490813648in"
> height="2.4499989063867016in"}
> ![](media/image94.png){width="2.3683267716535434in"
> height="2.4499989063867016in"}
2.  服务对应的注册表各键值是否正确，注册表权限是否正常。
> 注册表路径：HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\\
> 服务名称\>
>
> 比如 Remote DesktopServices 服务名称是 TermService，对应路径就是
>
> HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\TermService
a.  各项键值是否正确。
![](media/image95.jpeg){width="4.911469816272966in"
height="1.5033333333333334in"}
b.  权限是否正确。
![](media/image96.jpeg){width="4.763017279090113in"
height="3.509270559930009in"}
## [服务启动报错"不能在本地计算机启动"](#_bookmark1)
> 简介：本文分享服务启动报错"不能在本地计算机启动"的案例。
### 问题现象
> NetworkLocation Awareness 服务无法启动，报错如下。
![](media/image97.jpeg){width="4.246669947506562in"
height="2.1758333333333333in"}
### 排查
1.  此类报错代码并不常见，从错误代码没有更多线索。查看服务属性，依存关系缺少了
    tcpip 协议驱动程序。
> ![](media/image98.jpeg){width="4.908751093613298in"
> height="4.563853893263342in"}
2.  此类问题的话，需要找到一台相同系统版本的正常机器，手动替换该服务的注册表。有如下方案：
    1.  找一台正常机器的注册表文件导出后复制到当前实例，进行导入。注册表导出：
> 右键注册表，选择导出即可。
>
> ![](media/image99.png){width="3.6640365266841646in"
> height="3.019478346456693in"}
>
> 注册表导入：
>
> 双击 .reg 文件，选择是即可。
![](media/image100.png){width="4.906662292213474in" height="1.3in"}
2.  替换系统当前的 system
    > 注册表（此操作可能会引起某些配置和应用的丢失，谨慎使用）。
> 把系统盘挂载到其他实例，挂载步骤请参考
> [[https://help.aliyun.com/docu-]{.underline}](https://help.aliyun.com/document_detail/146752.html)
> [[ment_detail/146752.html]{.underline}](https://help.aliyun.com/document_detail/146752.html)。
### 2008 之后系统
> 服务器备份注册表路径为：Windows\\System32\\config\\RegBack
![](media/image8.jpeg){width="4.916245625546806in"
height="3.028332239720035in"}
### 替换步骤
1.  把系统盘挂载到其他实例，找到源实例的系统盘，假设为 D 盘，将 D:\\win-
    dows\\system32\\config\\system 重命名为 system.old(
    万一重启仍然有问题，我们可以将该文件重命名成 system 进行恢复）。
2.  D:\\Windows\\System32\\config\\RegBack\\system 拷贝至 D:\\windows\\
    system32\\config。
> 注：备份注册表可能比较旧，让客户确认一下应用和数据情况。
### 2003 系统
> 服务器备份注册表路径在 WINDOWS\\repair。
>
> ![](media/image9.jpeg){width="4.934199475065617in"
> height="1.4402077865266842in"}
### 替换步骤
1.  把系统盘挂载到其他实例，找到源实例的系统盘，假设为 D 盘，将 D:\\win-
    dows\\system32\\config\\system 重命名为 system.old(
    万一重启仍然有问题，我们可以将该文件重命名成 system 进行恢复）
2.  D:\\WINDOWS\\repair\\system 拷贝至 D:\\windows\\system32\\config。
> 注：备份注册表可能比较旧，替换后需要确认一下应用和数据情况。
>
> 卸载系统盘，挂回源实例（[[https://help.aliyun.com/document_detail/146752.htm]{.underline}l](https://help.aliyun.com/document_detail/146752.html)），启动机器。
## [服务启动失败"系统找不到指定文件"](#_bookmark1)
> 简介：服务启动失败"系统找不到指定文件"的案例分享。