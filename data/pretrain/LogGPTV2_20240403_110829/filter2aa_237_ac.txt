procMon _LP.dll 
procMon_Implant.dll 
进程监控 
RemoteExecute_LP.dll 
RemoteExecute_Implant.dll 
远程执行文件 
安天 CERT 根据分析出的部分实体文件功能和文件列表进行梳理，再加上之前卡巴斯基[7]和安天[1]对方
程式插件的分析，整理了这些功能插件在攻击过程中可能形成的组合，并绘制了“方程式组织主机作业模
块积木图”。从图中可以看出攻击者通过对这些插件进行组合来完成相应的功能，这些插件体现了如下架构
风格——不编写功能高度复杂的单一木马，而是把功能拆解成高度独立的小模块，这种拆解的粒度，几乎
到了“原子化”的程度，即使简单如获取系统信息的操作，也把类似获取环境变量、语言集、网络状态等
都作为一个独立的小模块，这将保证系统作业可以完全按需展开，从而最大化的保证作业的谨慎和静默。
从对主机安全环境的逃逸和对抗来看，这批插件的编译时间为 2007 年，从反病毒技术发展上来看，正是主
机主动防御技术走入成熟的阶段。主动防御技术普遍采用行为加权的思路对未知文件进行判定，但这些完
成这种“原子”操作的模块，是不会累加到阈值的。这种单独功能片段不仅在当时的情况下很难被发现，
即使从现代的动静态检测角度上来看也很难被发现。每个单独功能片段不具任何明显的恶意功能，只有总
调度平台将各功能插件协调使用才会组合出各种作业能力。这种作业方式，也会导致安全厂商很难获取到
方程式组织 EQUATION DRUG 平台解析 
第 8 页 
©安天 版权所有，欢迎无损转载 
完整的模块，而在没有有效 Loader 的情况下，这些模块很难在沙箱中被加载起来，从而也很难有效地进行
行为分析，其比那些探测虚拟环境从而拒绝执行的木马更难以分析。 
从文件名上来看，这些模块的功能规划得非常清晰。当然在实际作业中，这些 DLL 可能会以其他的一
些形态表现出来，其中包括可能使用窃取的数字证书进行签名。在这种情况下，部分驱动文件的 Version 信
息预计也会被定制为对应的数字证书信息，其使用的文件名，可能与其伪装的系统或应用的风格一致，或
者使用类似震网[12]、毒曲[13]和火焰[14]中使用的伪装成预编译或者临时文件的技巧。 
表 4-3 系列 A2PT 行动中样本使用的数字签名和场景中的文件命名风格 
A2PT 事件 
使用过的签名信息 
命名规律 
Stuxnet 
JMicron Technology 
Corp 
仿冒系统文件如：MRxCls.sys，S7HKIMDX.DLL，comspol32.ocx；按
照 Windows 命名规律伪装成 oem、和 mdm 开头的 pnf 预编译文件；
伪装成临时文件。 
Realtek Semiconductor 
Corp 
Flame 
亚洲诚信数字签名测试
证书 
仿冒系统文件名，如：MSSECMGR.OCX，icsvntu32.ocx，FRAGWIZ.
OCX 
Duqu 
HON HAI PRECISION 
INDUSTRY CO. LTD 
仿冒系统文件名，如：adpu321.sys，igdkmd16b.sys，iaStor451.sys 
C-Media Electronics 
Incorporation 
Equation 
尚未发现 
仿冒系统文件名，如：mstcp32.sys，DXGHLP16.SYS，tdi6.sys；伪装
成 Dat 文件。 
当然，这些模块也可能是以采用文件不落地的方式进行投放的，其直接运行在内存中，而没有相应的
文件实体。 
方程式组织 EQUATION DRUG 平台解析 
©安天版权所有，欢迎无损转载 
第 9 页 
图 4-3 方程式组织主机作业模块积木图 
“DanderSpritz”一词在“棱镜”事件中曾被曝光，在 ANT 中的“FIREWALK”[16]工具中也提及到了
DNT 的“DanderSpritz”，DNT 与 ANT 同属于 NSA 的网络组织。类似这种攻击装备可被用于多种作业场景，
方程式组织 EQUATION DRUG 平台解析 
第 10 页 
©安天 版权所有，欢迎无损转载 
通过“FIREWALK”[16]工具的网络流量采集和注入使得受害主机与攻击者的远程控制中心建立联系，使得
远控变成了抵近战术作业，如，通过物流链劫持或者在内部节点上插入或替换设备，只要启动远控工具，
就可以达成就近控制和人工作业相结合的攻击方式。 
图 4-4 斯诺登曝光的 NSA-ANT 网络武器 FIREWALK（安天公益翻译小组译） 
方程式组织 EQUATION DRUG 平台解析 
©安天版权所有，欢迎无损转载 
第 11 页 
NSA-ANT 网络武器最早在 2013 年斯诺登事件中曝光，共包含 48 个攻击武器，随着事件的发酵，不断
有媒体和组织对其进行曝光，安天安全分析工程师根据目前曝光的全部资料和技术分析尝试初步绘制了相
关攻击装备的图谱。 
图 4-5 NSA-TAO 攻击装备体系（完善中） 
5 部分组件与插件分析（继续完善中） 
通过一段时间的跟进分析安天 CERT 发现此次曝光的插件具有模块化和反检测特点，安天 CERT 根据
现有分析情况总结了这批攻击插件的三个特点： 
1. 
各个插件在 DllMain 函数中均不直接实现恶意行为。基于沙箱的威胁检测系统在检测 DLL 形态 PE
文件时，通常会调用 Windows API LoadLibrary() 来实现动态加载待检测对象，执行待检测对象的
DllMain 函数功能，触发待检测对象动态行为。但对于这些方程式插件，由于 DllMain 函数并不表
现恶意行为（如图 5-1 所示），很容易被沙箱视作非恶意程序。 
方程式组织 EQUATION DRUG 平台解析 
第 12 页 
©安天 版权所有，欢迎无损转载 
图 5-1DllMain 函数并没有恶意功能 
2. 
各插件的导出函数中均不直接实现恶意功能。这些方程式插件均只提供 4 个按序号（而不是按名
称）导出的函数。在其函数功能中，第 1 个导出函数负责接收调用者以特定数据结构传递的回调
函数指针或参数（如图 5-2 所示）；第 2 个导出函数负责在必要释放已申请资源；第 3 个导出函数
根据调用参数返回其核心功能函数指针；第 4 个导出函数负责填写调用者提供的数据结构、向调
用者传递插件版本信息。除了第 4 个导出函数未对参数进行严格判断而可能因访问空指针产生异
常外，各插件的导出函数均不直接实现恶意功能，基于沙箱的威胁检测系统无法通过调用各导出
函数触发其恶意行为，从而将其视作非恶意程序。 
图 5-2i1 函数中的回调函数指针或参数 
3. 
各个插件均只实现最基本能力。这些方程式插件均只实现最基本的功能，即使分析人员掌握了插
件的调用方法，传递正确的调用参数，也只能执行最基本的程序功能，并在回调函数得到程序功
能的中间结果（如进程名称、模块名称、用户密码），如果不是非常有经验的分析人员，是很难将
这些程序功能与正常程序的功能实现区分开。方程式攻击组织这样设计插件，除了考虑到框架的
可扩展性和功能剪裁的方便性等因素之外，很可能是以此绕过某些反病毒引擎的静态检测机制。 
方程式组织 EQUATION DRUG 平台解析 
©安天版权所有，欢迎无损转载 
第 13 页 
5.1 
Processinfo 插件遍历进程模块 
由于这批插件的复杂性，安天 CERT 挑选了其中相对较小的文件以便于分析。通过分析发现，用于实
现对指定进程的模块遍历，并调用上层模块预设的回调函数。 
5.1.1 
样本标签 
表 5-1 样本标签 
病毒名 
Trojan/Win32.EquationDrug 
原始文件名 
processinfo_Implant9x.dll 
MD5 
6042EA9707316784FBC77A8B450E0991 
处理器架构 
X86-32 
文件大小 
8 KB (8,192 字节) 
文件格式 
BinExecute/Microsoft.DLL[:X86] 
时间戳 
45A40EC7->2007-01-10 05:53:11 
5.1.2 
主要功能 
本插件提供四个基于序号导出的函数。 
表 5-2 主要功能 
序号 
功能 
1 
设置上层模块回调函数，创建互斥体 
2 
释放资源 
3 
返回核心功能函数地址 
4 
获取插件版本信息 
方程式组织 EQUATION DRUG 平台解析 
第 14 页 
©安天 版权所有，欢迎无损转载 
图 5-3 1 号导出函数设置上层模块回调函数 
图 5-43 号导出函数返回核心功能函数地址 
图 5-54 号导出函数获取插件版本信息 
方程式组织 EQUATION DRUG 平台解析 
©安天版权所有，欢迎无损转载 
第 15 页 
图 5-6 遍历指定进程，默认为当前进程 
图 5-7 遍历指定进程模块，计算模块对应文件 HASH（SHA1） 
方程式组织 EQUATION DRUG 平台解析 
第 16 页 
©安天 版权所有，欢迎无损转载 
5.2 
kill_Implant 插件杀进程模块 
该模块是另一个相对较小的文件，安天 CERT 通过分析发现，该插件主要功能为根据传入的进程 ID 来
结束对应进程。 
5.2.1 
样本标签 
表 5-3 样本标签 
病毒名 
Trojan/Win32.EquationDrug 
原始文件名 
kill_Implant.dll 
MD5 
BDD2B462E050EF2FA7778526EA4A2A58 
处理器架构 