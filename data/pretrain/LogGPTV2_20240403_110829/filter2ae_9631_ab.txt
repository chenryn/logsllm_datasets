    3.开机自启动
    程序在Mvfile函数中会调用system函数执行命令设置开机自启动：
    chmod +x /etc/rc.local
    mv $(pwd)/c1 /etc/c1
    cd /etc;chmod 777 c1
    sed -i -e '/exit/d' /etc/rc.local
    sed -i -e '/^\r\n|\r|\n$/d' /etc/rc.local
    sed -i -e '/c1/d' /etc/rc.local
    sed -i -e '2 i/etc/c1 reboot' /etc/rc.local
    sed -i -e '2 i/etc/c1 start' /etc/rc.d/rc.local
    sed -i -e '2 i/etc/c1 start' /etc/init.d/boot.local
    4.守护进程
    通过fork创建双进程守护，并且会切换至/tmp目录。
    在此之后程序会开启两个线程，其中黑雀线程的主体功能与螳螂线程相似度很高，但控制指令功能类型少于螳螂线程。值得注意的是黑雀线程会延迟60s后上线，往往可以迷惑分析人员，使黑雀C&C隐藏在大量的C&C处理中，减少被分析发现的可能。
#### 4.2 Windows平台样本
Windows端样本首先会在磁盘根目录windows文件夹下释放子体并自我删除，之后通过服务的方式启动子体进程。相较于Linux平台针对域名的简单Base64编码“加密”,程序作者在windows端采用了自定义的加密算法，以防止被轻易发现和篡改。需解密的黑雀C&C和黑客C&C如下所示：
解密函数首先会初始化密钥Table，之后通过包括按位异或、行位移等多种方式进行10轮解密操作，由于解密流程较为复杂，在批量解密域名的过程中我们采用了动态脚本解密的方式进行提取，最终会得到解密后的螳螂C&C和黑雀域名。
![
](https://images.seebug.org/content/images/2018/09/78aa58a1-93fe-42f5-9356-35b1c2f4f6da.png-w331s)
Windows平台样本的主要逻辑同Linux平台相似，首先会进行黑雀域名的验证，验证成功后开启黑雀线程，但并未做延迟上线处理。
我们通过对黑雀域名v8.ter.tf所涉及的windows端样本的编译时间进行抽样分析，绘制如下样本编译时间轴。
![
](https://images.seebug.org/content/images/2018/09/e13520b6-8f47-48a4-9a0d-0425a6ddc59c.png-w331s)
依图所示，抽样样本大部分编译时间集中在2017年4月18日，尽管许多样本被产业链下游黑客进行过各种包装处理，如加强壳、插入Loader加载自定义代码等，但核心僵尸模板都是源于僵尸编写者在编译时生成的。所以我们推测僵尸制造者是在2017年4月18日17点10分22秒生产了被大量使用的v8.1版本的僵尸模板程序，而其它时间生产的僵尸模板程序并没有得到大规模传播。
#### 4.3 上线数据分析
以V8.1版本Linux
X86平台为例，僵尸程序各平台的通信协议相同，在获取计算机相关信息后，程序会组包发送给C&C服务器进行上线请求，上线包长度为204字节。上线数据包格式和上线包内存格式如下所示：
![
](https://images.seebug.org/content/images/2018/09/b1fffa79-73ba-47a1-973e-8318a36caf2c.png-w331s)
![
](https://images.seebug.org/content/images/2018/09/0f686028-59c0-4b9f-940a-8f9bb3f33ab6.png-w331s)
#### 4.4 控制命令及其控制功能
当僵尸程序成功上线后，会调用recv函数来等待C&C服务器下发控制命令，受限于篇幅，我们仅对主控常见命令及其攻击进行简单列举。
![
](https://images.seebug.org/content/images/2018/09/c8e7ad4e-c136-4dc4-8342-e414ca1de3cf.png-w331s)
僵尸程序从V8.1版本开始增加了出租肉鸡服务，能够将僵尸资源租用给下游黑客使用，可以看出黑雀拥有庞大的僵尸网络资源并希望借此扩大盈利。
### 五、黑雀演变
Ddostf僵尸网络的控制端在一些论坛和黑产群中广泛散播，我们找到了其中数个历史版本的控制端和配置小马，针对其中主要版本的演进做了如下归纳。
![
](https://images.seebug.org/content/images/2018/09/bb1225fb-0986-49c2-ac04-fa9cb96033b3.png-w331s)
可以看出，在较短的时间内，僵尸作者通过不断的技术更新，使僵尸病毒从单一平台扩展成为多平台、隐匿性高、可定制性强的僵尸病毒。尤其在添加了物联网僵尸之后，Ddostf黑雀僵尸网络的影响范围和危害性大大增加。另外，黑雀域名也从最初的多个分散化逐渐演变为集中统一化,这有利于域名解析管理的便捷和攻击资源的聚合。其中域名myss.myss.top、myss.basec.cc、myss.ddns.net和klss.ddns.net在2016年后解析频率较低，而域名v8.ter.tf
和myss.ter.tf则相对活跃，两者关联着大量僵尸样本。由此我们判断该黑雀目前主要操控V8及之后版本的僵尸网络，但其同时也具备着发起旧版本僵尸网络DDoS攻击的能力。
### 六、隐匿的黑雀攻击
分析至此，我们已经找到了样本中的黑雀后门，准备收工大吉。但在检测“天罚v8集群压力测试系统.exe”的过程中，我们发现事情并没有那么简单。控制端在正常运行时并未出现异常网络行为，但在点击“监听端口”按钮后程序则会不断发起可疑连接请求。
![