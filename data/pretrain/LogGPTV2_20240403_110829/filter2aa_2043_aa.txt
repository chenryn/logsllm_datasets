Let’s talk about SOAP, baby. 
Let’s talk about UPnP.
Ricky “HeadlessZeke” Lawshae – DEFCON 23
Who am I?
• Security Researcher for HP TippingPoint’s DVLabs 
team
• At Rapid7 before that, and BreakingPoint before that
• Speaker at Defcon, Recon, Insomni’hack, and 
Ruxcon
• Voider of warranties
• Reader of comic books
• Drinker of beers
• TRIVIA: I once got a job at a police department while 
I had 4 active warrants out for my arrest.
What are we talking about?
• The Internet of Things™ (ugh…)
• It’s here, whether you like it or not
• “Just put a network interface on it. We’ll worry about why later.”
• Smart devices aren’t very smart
• Need simple way to talk to each other
• Ease-of-use: Get the tech out of the way of UX
• Often accomplished with SOAP/UPnP services
• Super talkative
• Happily tell you all their capabilities in a well-structured format
• Also, don’t bother themselves with pesky issues like security
What are we talking about?
• UPnP
• Universal Plug and Play
• SSDP
• Simple Service Discovery Protocol
• SCPD
• Service Control Protocol DeBnition
• SOAP
• Simple Object Access Protocol
Let’s talk about all the good 
things…
UPnP
• 1900/UDP
• HTTP over UDP allowing devices to discover each other
• Multicast 239.255.255.250
• UPnP Stack[1]
• Discovery
• Advertising and Searching
• Description
• An XML Ble describing the device
• Control
• Call an action or query for a value
• Eventing
• Used for announcing state changes
• Presentation
• UI…web page or management portal I guess?
[1] http://www.upnp.org/specs/arch/UPnP-arch-DeviceArchitecture-v1.0-20080424.pdf
UPnP – Discovery
All you need to know about 
discovery. Also, this is the 
really noisy part.
UPnP – Discovery
All you need to know about 
discovery. Also, this is the 
really noisy part.
UPnP – Description
• XML Ble usually hosted on a high number TCP port
• Version info
• upnp.org spec 
• Usually just 1.0
• Device deBnitions
• Device type
• Make/model/UUID
• Service list
• Service type
• SCPD URL 
• Control URL
• Event URL
UPnP – Description
    1
    0
  http://10.0.0.1:5000/
    VEN_01f2&…&REV_01
    NetworkInfrastructure.Router
    Network.Router.Wireless
    urn:schemas-upnp-org:device:InternetGatewayDevice:1
    urn:schemas-upnp-org:device:InternetGatewayDevice:1
    WNDR3400v2 (Gateway)
    NETGEAR, Inc.
    http://www.NETGEAR.com
    NETGEAR WNDR3400v2 N600 Wireless Router
    WNDR3400v2
    WNDR3400v2
    http://www.netgear.com
    uuid:bc567461-ee40-a9c2-39d3-5338c402cc8d
    …
        urn:schemas-upnp-org:service:Layer3Forwarding:1
        urn:upnp-org:serviceId:L3Forwarding1
        /Public_UPNP_Layer3F.xml
        /Public_UPNP_C1
        /Public_UPNP_Event_1
UPnP – Description
    1
    0
  http://10.0.0.1:5000/
    VEN_01f2&…&REV_01
    NetworkInfrastructure.Router
    Network.Router.Wireless
    urn:schemas-upnp-org:device:InternetGatewayDevice:1
    urn:schemas-upnp-org:device:InternetGatewayDevice:1
    WNDR3400v2 (Gateway)
    NETGEAR, Inc.
    http://www.NETGEAR.com
    NETGEAR WNDR3400v2 N600 Wireless Router
    WNDR3400v2
    WNDR3400v2
    http://www.netgear.com
    uuid:bc567461-ee40-a9c2-39d3-5338c402cc8d
    …
        urn:schemas-upnp-org:service:Layer3Forwarding:1
        urn:upnp-org:serviceId:L3Forwarding1
        /Public_UPNP_Layer3F.xml
        /Public_UPNP_C1
        /Public_UPNP_Event_1
UPnP – SCPD
• XML Ble deBning the service actions and arguments
• Version info
• Same deal as description
• Action list
• Action name
• Arguments
• Argument name
• Direction (input/output)
• Variable name
• Variable list
• Variable name
• Data type
UPnP – SCPD
      SetDefaultConnectionService
          NewDefaultConnectionService
          in
          DefaultConnectionService
      GetDefaultConnectionService
          NewDefaultConnectionService
          out
          DefaultConnectionService
      DefaultConnectionService
      string
UPnP – SCPD
      SetDefaultConnectionService
          NewDefaultConnectionService
          in
          DefaultConnectionService
      GetDefaultConnectionService
          NewDefaultConnectionService
          out
          DefaultConnectionService
      DefaultConnectionService
      string
UPnP – Control
• This is where SOAP comes in (Bnally!)
• Mostly just frontends for an RPC service or CGI script
• SOAP envelopes
• XML-formatted API calls
• Service type from description XML
• Action name and arguments from SCPD XML
• POST envelope to control URL
UPnP – Control
POST /Public_UPNP_C1 HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: "urn:schemas-upnp-org:service:Layer3Forwarding:1#SetDefaultConnectionService"
Content-Length: 568
Host: x.x.x.x:12345
<env:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"