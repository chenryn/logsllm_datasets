# 关于ImageTragick漏洞的一些常见误解

#### 译文声明
本文为翻译文章，原文来源：360安全播报
原文地址：[链接]
译文仅供参考，具体内容及含义请以原文为准。

最近，媒体报道了ImageTragick软件中存在的一个漏洞，引起了广泛关注。该漏洞不仅影响了用户的正常使用，还引发了大量网页开发人员的重视。他们正试图通过修复远程代码执行（RCE）漏洞来解决这一问题。

ImageTragick是一款广受欢迎的图像处理软件，支持超过89种基本格式，包括TIFF、JPEG、GIF和PNG等。它提供了一套强大且稳定的工具集，常被前端开发者用于修改图片、转换格式或添加水印。无论是否使用过这款软件，用户都应对该漏洞保持警惕，因为其利用成本极低，容易被恶意攻击者所利用。实际上，这是一种自上世纪90年代就已存在的简单shell命令注入漏洞。随着技术的进步，这类漏洞在现代核心开发工具中已经极为罕见。此漏洞与著名的Shellshock Bug（破壳漏洞）有相似之处。

然而，媒体对此漏洞的报道忽略了一个关键点：即使开发人员修复了RCE向量，这可能也无济于事。任何通过ImageTragick处理已被攻击者控制的图片的用户仍面临巨大风险。

问题的核心在于，尽管ImageTragick具有诸多优点，但其设计时未考虑到命令行注入这种历史悠久但鲜为人知的安全威胁。几个月前，研究员Jodie Cunningham使用开源模糊测试工具afl-fuzz对该软件的即时通讯（IM）功能进行了测试，迅速发现了20多个开发漏洞和多个拒绝服务攻击漏洞。她的研究结果可在以下链接中查看：[http://www.openwall.com/lists/oss-security/2014/12/24/1](http://www.openwall.com/lists/oss-security/2014/12/24/1)

随后，Hanno Boeck也发现了更多漏洞。这些发现表明，由于缺乏对IM代码库进行重新设计的动力，短期内该漏洞趋势不太可能改变。

针对这一情况，我们提出以下几条关于使用ImageTragick的建议：

1. **避免使用ImageMagick处理低信任度图片**：如果需要对安全性较低的图片进行格式转换或尺寸调整，建议使用其他库文件，如png库、jpeg-turbo库或gif库。这些方法不仅提高了执行速度，还可以在Chrome或Firefox浏览器中查看源代码。

2. **沙盒化处理不受信任的图片**：如果你必须使用ImageMagick处理不受信任的图片，应考虑采用带有seccomp-bpf特性的沙盒代码，以限制所有控件访问用户工作区并防止内核攻击。目前常用的一些沙盒技术，如Chroot和UID分离，在面对此类攻击时效果有限。

3. **限制图片格式处理**：作为最后的手段，可以通过设置ImageMagick来限制特定格式的图片处理。至少要检查每个接收到的图片文件的标题，并明确指定输入文件的格式。例如，可以使用如下命令：
   ```bash
   convert [...other params...] -format jpg input-file.jpg output-file.jpg
   ```
   在ImageMagick中，JPEG、PNG和GIF格式的处理代码比PCX、TGA、SVG、PSD等其他格式更稳定可靠。

希望这些建议能帮助您更好地理解和防范ImageTragick漏洞。