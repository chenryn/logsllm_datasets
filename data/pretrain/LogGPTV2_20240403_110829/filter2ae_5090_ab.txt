EXEC sp_configure 'xp_cmdshell', 1;  
RECONFIGURE;
执行命令：  
EXEC master.dbo.xp_cmdshell 'whoami'
**注：**  
2005的xp_cmdshell的权限一般是system，而2008多数为nt authority\network
service。故xp_cmdshell的提权前提为两个：(1)拿到sa权限的账户密码；（2）sqlserver服务未降权  
SQL Server提权详情请参考：
**3.Procdump+mimikatz配合抓取密码**  
Procdump是微软官方工具，不会被杀软查杀，其抓取密码的原理是获取内存文件 lsass.exe 进程 (它用于本地安全和登陆策略)
中存储的明文登录密码并存储到lsass.dmp文件中，之后我们就可以使用mimikatz去读取lsass.dmp获取到明文密码。  
win10或2012R2以上操作要麻烦一些，具体请参考：  
**小tip:**  
在进行远程桌面时，为了能够将我们本地的程序或文件拷贝到远程的主机上，应在本地资源中勾选上驱动器：  
**4.木马文件执行时提示缺少某个dll文件**  
前面说到过当生成C的exe文件时，如果要生成Release版本，运行库选择MT；生成Debug版本时，运行库选择MTD。那么原理是什么呢？可以参考这篇文章：  
简单的理解就是MT,MTD是静态链接，它把程序运行时所需要的dll库文件都打包好，MT适用Release,MTD适用Debug。MD,MDD是动态链接，会在运行的电脑上去动态加载所需的dll库文件，如果没有的话，就会提示缺少库文件。
**5.CobaltStrike从内存加载.NET程序集**  
当我想使用MS16-075烂土豆提权时，最初的想法是将提权的exe脚本传到目标主机然后执行，但目标主机有火绒，MS16-075早已被杀烂，网上找到的代码也都是c#的，看不懂，不知咋改。这时请教了木佬，才知道可以不用做免杀。  
原来，在CobaltStrike中有一个名为”execute-assembly”的命令，能够从内存中加载.NET程序集。这个功能不需要向硬盘写入文件，十分隐蔽，可以用来躲避杀软。我们用的CobaltStrike提权插件也是基于这个来实现的。具体的原理有待好好研究，这里给出从网上找到的三篇文章，给想研究的师傅们做个参考：  
**6.CobaltStrike与Metasploit之间的会话传递**  
CobaltStrike与Metasploit作为红队评估的两大常用框架，各有其优缺点：Metasploit模块众多，但一次只能接受一个反弹回来的shell，显得有些笨重，不适合团队作战；CobaltStrike一个监听器可同时接收多个反弹回来的shell，适合团队作战，但其后渗透模块少，即使使用插件也难以弥补这个缺点，所以经常会需要在这两者之间进行会话传递。具体的原理和操作，可以参考这篇文章：  
**三、两个待解决的问题**  
**1.只允许本地连接的SQL Server数据库提权**  
在我们拿到的WEBServer主机上其实有一个只允许本地连接的SQL
Server数据库，翻阅目录可以查看到连接的账号密码，权限为SA，我在webshell中使用命令行连接工具osql和sqlcmd尝试去连，都提示sa用户登录失败(账号密码无误)，在冰蝎的数据库管理模块能连上，但执行提权操作时卡了；在蚁剑中也是能连上，执行提权操作时提示“ODBC
驱动程序不支持所需的属性错误”，按照这篇文章改了蚁剑的代码也没能成功：  
最后大佬D上传了一个大马就提权成功了，不过拿到的是nt authority\network service，所以本地的SQL
Server是降权运行的。这里的问题是同样都是本地，为什么osql,sqlcmd命令连不上数据库，蚁剑和冰蝎提权失败，使用大马就可以？
**2.关于云服务器**  
拿到的云服务器有个内网环境，但内网里的主机上的业务与拿下的目标完全搭不上边，可以说是完全不相关的系统。我们知道，我们自己买的云服务器都会有个内网地址，这是不是说云服务器都有一个内网环境，我们可以通过自己的这台云服务器访问到其所处内网主机的一些资源？但这些内网主机又不是共享一个外网地址？我们知道，当我们反弹回连shell的时候，输入我们自己的VPS地址是能确切的回连到我们的云服务器的，那如果这些内网主机不共享一个外网地址，又为什么会将这些主机组成一个内网呢？想不明白，这是不是涉及到了云架构、云安全领域？
上面两个问题如果有知道的师傅还请麻烦解答一下，我将思考和探究这两个问题，如果解决了后续会在公众号发文。
**四、关于红队渗透的探索与想法**  
红队渗透我认为是目前在合法范围内最贴近于实际的，效果真实猛烈，以拿权限，打穿为目的来评估系统的安全防护能力。那么红队的打法流程是怎样的呢？我这里没啥经验，暂时不敢妄加言论，之前看到Teamssix师傅的文章有谈到过这个问题，这里先附上师傅之前的连载文章：  
1.浅谈红队中的外网信息收集：  
2.浅谈红队中的打点：  
3.浅谈红队中的权限维持：  
4.浅谈红队中的提权：  
对于此次攻防演练的反思，我觉得红队在这个过程当中不能仅仅痴迷于拿权限，打穿内网，还有重要的一点就是当我们拿下一个目标之后，能否寻找下目标之前是否有被攻击过的痕迹？查看下是否有异常的对外连接，异常的进程？公安部每年牵头举办的HW行动，其初衷是想通过业内大佬的专业评估来寻找到政府、国企、央企、事业单位等重要系统薄弱环节，帮助其提升防护能力，避免受到来自外界尤其是国外APT组织的恶意攻击。HW不应成为各个公司激烈角逐的战场，更不应是安全从业者的噩耗(据说每年HW中总会猝死那么一两个)。
上面仅是一个菜鸟选手对HW红队渗透的一点小想法，大佬不喜，请轻喷~
**五、不足与改进方法**  
参加此次攻防演练，从中发现了自己许多不足的地方，特此提出来以期下次改进：  
**1.漏洞发现，外网打点能力弱**  
在整个HW过程中，自己仅发现一个普通权限的sql盲注，同事能找到弱口令登入后台，能找到shiro反序列化，而我却一个弱口令都没碰到。  
改进：有时可能不是技术上的问题，是想法和思路的问题。这个只能在平时的渗透中多注意、多思考一些，也可以通过对SRC的挖掘来提升这方面能力。
**2.知识遗忘或掌握不牢固**  
相关知识点有学过，也实操过，遗忘了，没想到或者在用到时发现自己其实对于这方面知识点其实也不太熟  
改进方法：平时空闲时多做一些靶机测试，多练，熟悉从外网打点到提权，内网横向获取内网所有主机权限的这一套流程。据我所知，相关不错的靶场国内的有红日安全ATT&CK系列靶场，暗月靶场，国外的有vulnhub，hackthebox。这点得向dayu师傅学习，之前天天打HTB
**3.攻击方式单一**  
这不仅是我，也是我们整个团队所存在的问题，都是通过传统的web来撕开口子。  
改进：多学习了解红队的一些打法，学学钓鱼、社工，平常做做实验。
如果有想一起讨论红队渗透，一起走向红队之路的师傅们，欢迎通过关注公众号：沃克学安全，添加小编微信好友哦~，感谢关注与支持，您的点赞是我最大的动力。