Uk Limited  
confusedtown.com| 2020/12/13| PI:EMAIL| 0.0.0.0| N/A  
donotfollowmeass.com| 2020/12/13| PI:EMAIL| 23.19.58.17| Leaseweb
Uk Limited  
cannibalwoman.com| 2020/12/12| REDACTED FORPRIVACY| 23.19.58.17| Leaseweb Uk
Limited  
unsecuredstorage.com| 2020/12/8| PI:EMAIL| 23.19.58.17/18|
Leaseweb Uk Limited  
hopeisstamina.com| 2020/12/8| REDACTED FORPRIVACY| 23.19.58.17/18| Leaseweb Uk
Limited  
Importantgate.com | 2020/12/8| PI:EMAIL| 0.0.0.0| N/A  
flexiblepaper.com | 2020/12/7| PI:EMAIL| 23.19.58.17| Leaseweb Uk
Limited  
acceptplan.com| 2020/12/6| PI:EMAIL| N/A| N/A  
klwebsrv.com| 2020/11/26| PI:EMAIL| 23.19.58.17| Leaseweb Uk
Limited  
## 2.4 技术演进
APT34的本次攻击活动与早期相比，有着一些改变，其中从诱饵文档到后门程序上都存在较多改进。比如增加了用于关闭宏提示的诱饵文档，基于DNS的感染上报，以及以`JavaScript`为载体的流量隐藏等等。
  * 1）关闭宏提示诱饵文档 本次攻击中，我们第一次发现`APT34`采用了一种预攻击诱饵的手法，黑客首先向目标发送一个没有任务恶意行为的诱饵文档，该诱饵文档会偷偷地在目标主机上关闭`excel`和`word`两种文件的宏提示功能。并在此后攻击中，黑客会再次利用其它诱饵文档来下发后门。
图2-10 关闭宏提示功能
  * 2）基于DNS隧道的感染上报 相比于APT34以往的攻击活动，本次添加一个利用DNS协议进行攻击活动的上报，上报的服务器是公共的网络设施。这种上报最主要的特点是阶段化以及匿名化，同时流量是难以发现和检测的。通过分析发现，上报信息中包括受害者的一些列的可识别信息（如感染时间、用户名、主机名，IP地址等）。攻击者采用这种新的技术手法，能够及时掌握入侵执行进度（侦察阶段），以便进一步调整技战术策略来提高攻击的成功率。
图2-11 DNS上报信息代码
  * 3）以JavaScript为载体的流量隐藏
根据目前掌握的信息可知，`SideTwist`是`APT34`在本次攻击活动使用的一款新后门。该后门在与C&C交互时，采用了较隐匿的通信机制。攻击者将加密后的控制指令数据隐藏在html页面的``标签中，并以注释的形式存储。当后门获取指令时，则使用HTTP请求从伪造的虚假页面中提取控制指令数据。这能非常有效地逃避流量监视和检测。
 图2-12 伪造的虚假页面部分源代码
  * 4）KarkoffDll后门改进
在以往的攻击中，APT使用的Karkoff后门是以独立的EXE可执行文件存在，文件名类似out.exe之类的文件，通过计划任务启动执行；而本次攻击中黑客将该后门分离成两部分，分别为白文件Mircroft.Exchange.WebServices.dll和后门程序System
Exchange Service.dll（提高了免杀能力），我们将新变种命名为KarkoffDll。该变种通过VBS脚本启动，而VBS以计划任务启动。
图2-13 模块分离
  * 5）EWS邮件模本改进
在本次攻击中，黑客着重针对EWS通信过程中的邮件模板进行了精心设计和伪装。从先前的攻击案例来看，用于传输数据的邮件任务模板设计简单，无论是邮件主题前缀（“Great!”），还是邮件内容（“This
is our
reusme”）都略显简易，容易引人生疑。而在此次行动中，攻击者通过精心仿造Dropbox平台（网络存储服务提供商）的服务更新邮件来混淆视听，邮箱用户即使关注到恶意邮件内容（存储于已删除邮件），也很可能会误认为是Dropbox平台正常的服务邮件而忽略。另外，在前期攻击活动中通信数据被加密隐写在图像附件（RDAT）或TXT文本附件（Karkoff）中，此次攻击则隐藏在邮件Emailbody正文尾部，一方面可以起到不错的视觉混淆效果，另一方面也能避开部分针对邮件附件的文件检测。
图2-14 邮件任务对比
此外，在前期攻击活动中使用的EWS
API邮件通信只支持2种邮件任务：“CMD”邮件任务和“结果”邮件任务，分别用于接收和发送指令，但这两种任务无法及时提供受控机器的连接情况。APT34在此次攻击中进行了升级——新增了“心跳包”邮件任务，当“已删除邮件”中不存在“CMD”邮件时，则更新“心跳包”邮件，攻击者即可掌握受控机器的上线连接情况。
图2-15 增加“心跳包”邮件
# 三、攻击案例剖析
APT34的这次攻击涉及到多种形式的诱饵文档和样本形态,在分析完这批攻击样本和攻击策略后，我们将此次攻击活动划分为三个阶段：`初期侦察`、`后门植入`和`隐匿驻留`。整套攻击流程经过了攻击者的精心策划和部署。
初期侦察阶段，`APT34`首先投递“`无害`”的恶意文档诱导受害者点击执行宏代码，并利用绕过技术“关闭”`Office`的宏安全警告。默认允许宏代码执行就如同打开了“潘多拉魔盒”，攻击者后续所有基于宏的恶意行为将会悄无声息的执行，这给攻击者后续的入侵活动提供了便利。同时，由于文档不存在明显的恶意行为，该阶段也很难被受害者察觉。在该诱饵文档的宏执行过程中，其借助了公共服务商`RequestBin`提供的`DNS`服务来传输受害设备的指纹信息和宏感染进度，由于`RequestBin`的`DNS`匿名使用特性，所以我们称这种技术为“`匿名DNS隧道技术`”，黑客巧妙地利用了这一点，并在此次攻击活动中广泛应用于诱饵文档中。
后门植入阶段，攻击者继续投递诱饵文档并通过宏代码植入后门`KarkoffDll`或`SideTwist`。植入过程包含解密释放后门和安装计划任务两部分工作，同时其也会借助公共服务商`RequestBin`提供的`DNS`服务来传输受害设备的指纹信息和宏感染进度。
隐匿驻留阶段，植入的两类后门通过不同的隧道通信技术实现敏感数据传输。后门`KarkoffDll`通过`EWS
API`与`Exchange`邮箱账户（可信服务器）通信，将数据加密隐匿在`EWS协议`中传输，我们称之为“`EWS隧道技术`”。后门`SideTwist`采用“`HTTP隧道`”来实现与控制命令服务器的通信，在通信过程中，该后门还采用了基于`HTTP协议`的“`JS控制通道`”来隐秘下发控制指令。我们将在3.3章节做相关的技术分析，攻击活动的整体流程参考图3-1。
图3-1 入侵流程
## 3.1 阶段一：初期侦察
在初期侦察阶段，攻击者通过投递“无害”的恶意文档诱导受害者点击执行宏代码。宏代码的主要功能是绕过Office宏安全警告，同时会将宏感染情况通过DNS上报给攻击者（DNS上报信息是此次攻击活动中诱饵文档的共性特点，将在阶段二中具体分析）。文档宏的核心代码如下：
图3-2 绕过Office默认宏安全警告
在检测Office版本时，首先查找注册表中excel.exe的程序路径，之后结合GetFileVersion函数获取Office的所属版本。
图3-3检测Office版本
然后，分别针对Excel和Word程序添加Office安全可信路径的注册表项（可信路径为”C:\”），并设置为支持子目录可信。最终，攻击者通过增加Office可信目录可以达到自动执行C盘下Office恶意宏的目的，为后续的入侵活动提供支持。
图3-4增加Office可信目录
## 3.2 阶段二：后门植入
在完成第一阶段的侦察并绕过宏安全警告后，攻击者继续投递恶意宏文档以植入后门。其中，攻击者巧妙的借助了公共服务商`RequestBin`提供的`DNS`隧道服务进行宏感染情况的上报。使用公共DNS隧道服务可以充分保证通信的隐匿性，攻击者根据上报的DNS信息能够及时掌握后门植入的进度，并及时调整技战术策略。
诱饵文档诱导受害者
“启用宏”来执行恶意VBA脚本（如受害者已执行阶段一的诱饵文档则会默认执行宏）。以释放后门`KarkoffDll`的恶意文档为例，VBA宏通过`Document_Open`和`Document_Close`两类事件来触发恶意行为。
图3-5 VBA行为
Document_Open（文档打开时）： DNS上报感染进度（第一次）
Base64解码提取后续的恶意代码并释放至新创建的目录“\appdata\local\Google_Corporation\”
检查环境是否有鼠标可用（反沙箱） DNS上报感染进度（第二次）
Document_Close（文档关闭时）： 检查环境是否有鼠标可用（反沙箱） DNS上报感染进度（第三次）
注册windows任务计划（伪装名称：Google Update），每5分钟运行脚本(exchange.vbs执行后续恶意代码), 持续20天
DNS上报感染进度（第四次）
### 3.2.1 DNS上报信息
在DNS上报信息的过程中，需上报内容将以DNS子域的形式传递，包括受害者的可识别信息（用户名、主机名、宏代码执行阶段）。除此之外，黑客在RequestBin端还可以识别到受害者的IP地址及感染时间。
图3-6 DNS隧道通信
当恶意文档在以下设备环境中执行时，DNS上报流量参考图3-7所示。 Hostname : WIN-36F2EAP UserName : jayer