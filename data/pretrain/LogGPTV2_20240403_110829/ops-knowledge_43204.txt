### 问题描述

我今天在Macbook上上网时，发现iTunes无法连接到Apple服务器。尝试登出并重新登录我的账户，但奇怪的是，它提示无法登录。起初我没有太在意，以为只是iTunes出现了比平常更多的bug。

然而，随后我发现了一些非常奇怪的现象：当我尝试访问www.apple.com时，浏览器（Google Chrome）警告我该网站不安全。这让我感到警觉，点击“继续访问”后，我看到了以下页面：

![](https://i.imgur.com/example.png)

作为一名网页设计师/开发者，我对网站的细节非常敏感。我立刻意识到这不是真正的Apple主页，而且Apple主页不会直接要求用户登录。我进一步查看了该页面的源代码，发现代码过于简单，不适合一个大型企业。唯一的JavaScript代码是用于验证电子邮件地址格式是否正确。

我开始怀疑我的Mac可能被感染了，于是切换到iPhone（使用相同的Wi-Fi网络），尝试访问www.apple.com，结果看到的是同样的页面。这让我认为问题可能与DNS有关，因为两台设备同时被感染的可能性非常低。于是我检查了路由器的设置。

果然，在DNS设置中我发现了一些异常。我最初将DNS设置为使用Google的服务器（8.8.*.*）。但在当前设置中，我发现了以下IP地址：

- 主DNS: 185.183.96.174
- 辅助DNS: 8.8.8.8

我立刻意识到DNS设置已被篡改，主DNS应为8.8.4.4。除了我之外，没有人可以访问路由器的管理页面，并且我已经禁用了从外部网络访问路由器的功能。然而，我注意到外部访问功能现在被启用了，而在我初次设置时它是关闭的。

### 问题

1. **DNS是如何被更改的？**
2. **如何防止这种情况再次发生？**

### 补充信息

- 我尽量保持路由器固件的最新状态，尽管在这次事件发生时，我可能落后了一个版本。
- 在更改主DNS设置之前，我想了解更多关于这个钓鱼网站的信息，因此我运行了`ping apple.com`，发现其IP地址为185.82.200.152。
- 输入该IP地址后，我发现攻击者创建了多个站点以尝试捕获用户的登录信息。我怀疑他们位于美国，因为Walmart主要在美国运营（至少不在英国）。
- 我已经向迪拜的主机提供商报告了该IP地址，并等待他们的回复。

### 路由器详细信息

- 型号: Asus AC87U
- 固件版本: 3.0.0.4.380.7743（落后一个版本）
- 我没有使用默认密码

### 更新

- 主机提供商已暂停了该账户

### 分析

你的路由器的主要DNS条目被指向了一个恶意的DNS服务器，导致你网络中的设备解析apple.com和其他域名时跳转到了钓鱼网站。这可能是由于路由器固件中的未修补漏洞被利用所致。

#### 路由器固件更新

你的固件版本已经落后半年多。最新的固件版本3.0.0.4.382.50010（2018-01-25）包含了许多安全修复，包括一些可能导致远程代码执行（RCE）的漏洞。以下是部分修复内容：

- 修复KRACK漏洞
- 修复CVE-2017-14491: DNS - 2字节堆溢出
- 修复CVE-2017-14492: DHCP - 堆溢出
- 修复CVE-2017-14493: DHCP - 栈溢出
- 修复CVE-2017-14494: DHCP - 信息泄露
- 修复CVE-2017-14495: DNS - OOM DoS
- 修复CVE-2017-14496: DNS - 整数下溢DoS
- 修复CVE-2017-13704: Bug碰撞
- 修复可预测会话令牌（CVE-2017-15654）、日志用户IP验证（CVE-2017-15653）、登录信息泄露
- 修复Web GUI授权漏洞
- 修复AiCloud XSS漏洞
- 修复XSS漏洞
- 修复LAN RCE漏洞
- 修复远程代码执行漏洞
- 修复Smart Sync存储XSS漏洞
- 修复CVE-2018-5721: 栈缓冲区溢出

虽然Asus没有公布详细的漏洞信息，但攻击者可能已经独立发现了这些补丁中修复的一些漏洞。通过比较不同版本的固件来逆向工程找出哪些部分被修补是相对容易的。这种“一日漏洞”通常开发成本较低。

此外，这看起来是一次广泛攻击的一部分。三天前的一条推文描述了一起非常类似的事件：

- "我的Asus家庭路由器似乎被黑了，并且配置中添加了一个位于迪拜的恶意DNS服务器。它将像http://apple.com这样的网站重定向到一个钓鱼网站。幸好我在孩子们提供凭据之前发现了这个问题。检查你们的路由器吧！" (@harlanbarnes, 2018-03-09)

### 建议

1. **立即更新路由器固件**：确保你的固件是最新的，以防止利用已知漏洞的攻击。
2. **恢复出厂设置**：如果有必要，进行工厂重置以清除任何潜在的恶意配置。
3. **保护路由器管理界面**：即使管理界面仅在内网可见，也应设置强密码，并定期更改密码。
4. **监控网络活动**：定期检查DNS设置和其他关键配置，确保它们没有被篡改。
5. **启用双因素认证**：如果路由器支持，启用双因素认证以增加安全性。

通过这些措施，你可以大大降低类似事件再次发生的可能性。