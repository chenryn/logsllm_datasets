Marina Simakov
Yaron Zinar
ABOUT US
• Senior Security Researcher @Preempt
• M.Sc. in computer science, with several published articles, with a main area of 
expertise in graph theory
• Previously worked as a Security Researcher @Microsoft
• Spoke at various security conferences such as Black Hat, Blue Hat IL and DefCon
Marina Simakov (@simakov_marina)
• Senior Security Researcher Lead @Preempt
• M.Sc. in Computer Science with a focus on statistical analysis
• Spent over 12 years at leading companies such as Google and Microsoft
• Among his team latest finding are CVE-2017-8563, CVE-2018-0886, CVE-2019-
1040 and CVE-2019-1019
Yaron Zinar (@YaronZi)
AGENDA
1. Introduction:
§ Common attacks on Active 
Directory
§ NTLM
§ Design weaknesses
§ NTLM Relay
§ Offered mitigations
2. Known Vulnerabilities
§ LDAPS Relay
§ CVE-2015-0005
3. New vulnerabilities
§ Your session key is my session 
key
§ Drop the MIC
§ EPA bypass
§ Attacking AD FS
§ External lockout bypass
§ Reverse-Kerberoasting
4. Takeaways 
INTRODUCTION: ACTIVE DIRECTORY
§ Main secrets storage of the domain
§ Stores password hashes of all accounts
§ In charge of authenticating accounts against domain resources
§ Authentication protocols
§ LDAP
§ NTLM
§ Kerberos
§ Common attacks
§ Golden & Silver Ticket
§ Forged PAC
§ PTT
§ PTH
§ NTLM Relay
NTLM
Authentication is not bound to the session!
(1) NTLM Negotiate
(3) NTLM Authenticate
(2) NTLM Challenge
(4) NETLOGON
(5) Approve/Reject
Client Machine
Server
DC
NTLM RELAY
(1) NTLM Negotiate
(5) NTLM Authenticate
(4) NTLM Challenge
Client Machine
Server
Attacked
Target
DC
NTLM RELAY:
MITIGATIONS
NTLM RELAY: MITIGATIONS
§ Mitigations:
§ SMB Signing
§ LDAP Signing
§ EPA (Enhanced Protection for Authentication)
§ LDAPS channel binding
§ Server SPN target name validation
§ Hardened UNC Paths
NTLM RELAY: MITIGATIONS
§ SMB & LDAP signing
§ After the authentication, all communication between client and server will 
be signed
§ The signing key is derived from the authenticating account’s password hash
§ The client calculates the session key by itself
§ The server receives the session key from the DC in the NETLOGON 
response
§ An attacker with relay capabilities has no way of retrieving the session key
NTLM RELAY: MITIGATIONS
§ SMB & LDAP signing
(1) NTLM Negotiate
(5) NTLM Authenticate
(4) NTLM Challenge
Client 
Machine
DC
Server
Attacked 
Target
Packet not 
signed 
correctly
+Session Key 
(Hash Derived)
NTLM RELAY: MITIGATIONS
§ EPA (Enhanced Protection for Authentication)
§ RFC 5056
§ Binds the NTLM authentication to the secure channel over which the 
authentication occurs
§ The final NTLM authentication packet contains a hash of the target service’s 
certificate, signed with the user’s password hash
§ An attacker with relay capabilities is using a different certificate than the 
attacked target, hence the client will respond with an incompatible 
certificate hash value
NTLM RELAY: MITIGATIONS
§ EPA (Enhanced Protection for Authentication)
(2) NTLM Negotiate
Client 
Machine
DC
Server
Attacked 
Target
(5) NTLM Challenge
(6) NTLM Authenticate
User signs the Server’s 
certificate
Incorrect 
certificate hash!
(1) TLS Session
NTLM RELAY:
KNOWN VULNERABILITIES
NTLM: KNOWN VULNERABILITIES
§ LDAPS Relay (CVE-2017-8563)
§ Discovered by Preempt in 2017                                         
https://blog.preempt.com/new-ldap-rdp-relay-vulnerabilities-in-ntlm
§ Group Policy Object (GPO) - “Domain Controller: LDAP server signing 
requirements” 
§ Requires LDAP sessions to be signed OR
§ Requires session to be encrypted via TLS (LDAPS)
§ TLS does not protect from credential forwarding!
NTLM: KNOWN VULNERABILITIES
§ CVE-2015-0005
§ Discovered by Core Security (@agsolino)
§ DC didn’t verify target server identity
§ Allows NTLM Relay even when Signing is required
(1) NTLM Negotiate
(5) NTLM Authenticate
(4) NTLM Challenge
Client Machine
DC
Server
Attacked 
Target
(9) NETLOGON
(10) Approve + Session Key
+Session Key 
(Hash Derived)
NTLM: KNOWN VULNERABILITIES
§ CVE-2015-0005
§ NTLM Challenge message:
§ Contains identifying information about the target computer
NTLM: KNOWN VULNERABILITIES
§ CVE-2015-0005
§ NTLM Authenticate message:
§ User calculates HMAC_MD5 based on the challenge message using his NT Hash
NTLM: KNOWN VULNERABILITIES
§ CVE-2015-0005 – Fix:
§ Microsoft issued a fix in MS15-027
§ The fix validated that the computer 
which established the secure 
connection is the same as the target 
in the NTLM Authenticate request 
(1) NTLM Negotiate
(5) NTLM Authenticate
(4) NTLM Challenge
Client Machine
DC
Server
Attacked 
Target
(9) NETLOGON
(10) DENY!
+Session Key 
(Hash Derived)
Target hostname 
mismatch!
NTLM RELAY:
NEW VULNERABILITIES
NTLM: NEW VULNERABILITIES
§ Your session key is my session key
§ Retrieve the session key for any NTLM authentication
§ Bypasses the MS15-027 fix
§ Drop the MIC
§ Modify session requirements (such as signing) 
§ Overcome the MIC protection
§ EPA bypass
§ Relay authentication to servers which require EPA
§ Modify packets to bypass the EPA protection
§ Attacking AD-FS
§ External lockout policy bypass
§ Reverse-Kerberoasting
YOUR SESSION KEY IS MY 
SESSION KEY
NTLM: NEW VULNERABILITIES
§ Your session key is my session key
§ MS15-027 fix validates target NetBIOS name 
§ But what is the target NetBIOS name field is missing?
Original challenge:
Modified challenge:
NTLM: NEW VULNERABILITIES
§ Your session key is my session key
§ The client responds with an NTLM_AUTHENTICATE message with target 
NetBIOS field missing
§ The NETLOGON message is sent without this field
§ The domain controller responds with a session key!
NTLM: NEW VULNERABILITIES
§ Your session key is my session key
§ But what if the NTLM AUTHENTICATE message includes a MIC?
§ MIC: Message integrity for the NTLM NEGOTIATE, NTLM CHALLENGE, and 