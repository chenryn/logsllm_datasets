# 攻击检测之域权限维持
|
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 1.背景介绍
本文主要是对域环境下的权限维持手法进行攻击检测以及清理，攻击的方法不着重描述，检测的方法只针对终端日志（windows，sysmon）,权限维持的手法也只涉及域环境独有的，像普通终端也存在的启动项计划任务服务等不考虑在内，利用漏洞的也直接排除了直接打补丁就好了。
## 2.域持久化
###  1.黄金票据
**1.攻击手法介绍**
黄金票据（Golden Ticket)：它能在拥有普通域用户权限和krbtgt
hash的情况下，获取域管理员权限。krbtgt账户：每个域控制器都有一个”krbtgt”的用户账户，是KDC的服务账户，用来创建票据授予服务(TGS)加密的密钥。
图中我伪造了一个名为ceshi的账户,这里其实任何账户都行域里不存在账户也可以随便伪造（微软的MS-KILE解释：Kerberos
V5不提供对TGS请求的帐户撤销检查，只要TGT有效，即使该帐户已被删除，TGT更新和服务票据也可以发布。KILE提供了一个可以将利用时间限制在较短的时间内（20分内）。当TGT大于20分钟时，KILE
KDC需要在域中检查账户。  
）
**2.攻击检测**
windows4624记录了安全IDadministrator在10.43.120.26地址登陆，并且账户名与安全ID(500代表了域管账号)并不一致,安全ID其实就是SID，事件查看器会自动尝试解析
SID 并显示帐户名。 如果无法解析
SID，将在事件中看到源数据，正常来说账户名应该与安全ID对应，这里很明显ceshi账户是伪造的,但是攻击者只要伪造administrator名字来伪造票据就可以躲过了，但是administrator在非常用的IP地址段出现就是异常的了这里也可以检测一下。黄金票据攻击在终端日志侧不是很明显的能够检测，很难区分他是不是正常的，正常来说认证访服务的流程是先4768（TGT）-4769（TGS）-4624（logon），但是黄金票据攻击的话只会有4769-4624，因为TGT已经离线生成了。但是kerberos票据的有效期一般是4个小时（特殊组的用户）或者是10个小时，也就是说TGT在之前申请过了就可以保留4-10个小时之间那么这个时间触发攻击还是只有4769-4624，最好还是流量检测黄金票据攻击。
**3.防御清除**
如果通过告警已经确定了攻击者已经拿下了域控那么肯定会导出所有账号密码，黄金票据是肯定是存在的，这个时候就需要修改krbtgt账号的密码了，需要修改两次。（Active
Directory中对定期迭代的帐户防止密码重用，默认密码策略被设置为记住24个历史密码，而且至少也要迭代一次保存于电脑帐户。即使密码已更新,也会继续使用前面的密码散列进行身份验证）,如果不是很紧急的话最好不要连续修改2次密码，这样会引起域内工作不正常，最好是10个小时以后再修改第二次krbtgt的密码。官方有专门的重置密码的脚本https://github.com/microsoft/New-KrbtgtKeys.ps1,建议使用官方脚本进行重置，并且定期重置一次。
###  2.DCSYNC维持权限
**1.攻击手法介绍**
DCSync是mimikatz的一个功能，能够模拟域控制器并从域控制器导出帐户密码hash，如果我们在域内一台主机上获得了域管理员权限，可以使用如下命令直接导出域内所有用户的hash：默认情况下，只有Domain
Controllers和Enterprise Domain
Admins权限能够使用DCSync但我们可以对域内普通用户添加如下两条ACL实现普通用户调用DCSync导出域内所有用户的hash  
DS-Replication-GetChanges(GUID: 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)和DS-Replication-Get-Changes-All(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)  
可以使用powerview添加ACL：
我这里给win10用户添加了dcsync的权限，这样我在win10机器上也可以导出域内用户hash
**2.攻击检测**
从windows日志4662可以清楚的看到DS-Replication-GetChanges(GUID:
1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)和DS-Replication-Get-Changes-All(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)在win10终端与域控上都产生了两条特殊的acl被添加的信息
**3.防御清除**
使用zbang工具可以检测当前域环境是否已遭受dcsync攻击，还有一些工具也可以检测后面会提到
可以使用powerview脚本来清除acl  
Remove-DomainObjectAcl -TargetIdentity “DC=wlaq,DC=com” -PrincipalIdentity
win10 -Rights DCSync
###  3.白银票据
**1.攻击手法介绍**
白银票据就是伪造服务票据，为了创建或伪造白银票据，攻击者需要获得目标服务账号的密码hash值，并且此攻击与域控制器没有AS-REQ 和 AS-REP通信，也没有TGS-REQ / TGS-REP通信。任何事件日志都在目标服务器上
我这里伪造了一个叫(win7-win10)的用户去访问win10机器的cifs服务
攻击发生后可以在目标机器看到4624日志这里的异常点就是IP地址是否是常用地址以及用户名是否是存在的域账户，以及用户名是否是管理员账户（SID500是系统管理员的用户帐户。
每台计算机都有一个本地管理员帐户，每个域都有一个域管理员帐户）
这里我伪造了一个(win7-yukong)的用户去访问域控的cifs服务
可以看到利用白银票据同样可以攻击域控同时与黄金票据攻击在终端上产生的可以检测的日志信息是一样都是4624事件
**2.攻击检测**
检测白银票据比检测黄金票据更加困难流量特征也是存在误报的,如果目标机器不是域控那么也不会再域控机器产生任何日志来帮忙我们进行检测。从windows日志维度来看检测方法主要还是看4624的登陆IP地址是否异常登陆用户是否是真实存在的用户，用户是否跟sid能够匹配来检测。虽然这一步攻击很难检测但是攻击者入侵机器后肯定有后续的攻击行为我们根本后续的攻击行为来判断是否失陷。
**3.防御清除**
银票攻击一般使用的是机器账户的hash,默认情况下加入域的计算机机器帐户密码每30次自动更新一次，机器账户的密码也存在域控的数据库中，并且他跟krbtgt账户类似一旦攻击者窃取了密码，那么我们需要修改两次才能防止攻击者再次利用，不然他的上一次的密码hash同样有效。这30天也可以改成永久不修改密码的。只需要把下面注册表的值改为1就行了HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Netlogon\
Parameters\DisablePasswordChange。这个注册表键值的修改也是需要作为检测规则日常监控的，这是白银票据维持更长时间持久化的方式。
如果发现某个机器账户已经被窃取了，可以使用powershell脚本重置2次密码https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/reset-computermachinepassword?view=powershell-5.1。如果域控的机器账户hash被窃取并且被用于白银票据，我们重置域控的机器账户的话需要使用netdom命令来重置密码不然会影响域正常工作。
###  4.Skeleton Key
**1.攻击手法介绍**
Skeleton Key与Golden Ticket后门均不需要域控重启即能立即生效。Skeleton
Key一般在64位的域控服务器上使用,支持Windows Server2003到Windows Server2012 R2（对于Server 2012
R2以上系统版本，需要mimidrv.sys文件）,能够让所有域用户使用同一个万能密码（默认是mimikatz）进行登录，现有的所有域用户使用原密码仍能继续登录，注意并不能更改用户权限，这里需要注意的是重启将失效。被称为万能钥匙,是一种域控制器权限维持工具。它无须破解域用户的任何密码,进行此攻击时,需要运行在64位操作系统的域控制器中,并且拥有域管理员权限。  
我们在域控制器上运行mimikatz.exe,执行 misc::skeleton
命令,这会将Kerberos认证加密降级到RC4_HMAC_MD5,并以内存更新的方式将主密码修补到 lsass.exe 进程。
**2.攻击检测**
看了一下产生的sysmon日志或者windows日志仍只能看到4624日志无法准确的识别出该攻击。由于该攻击是对lsass进程进行了注入， 从Windows
8.1（和Server 2012
R2）开始，Microsoft引入了一项称为LSA保护的功能。此功能基于PPL技术，它是一种纵深防御的安全功能，旨在“防止非管理员非PPL进程通过打开进程之类的函数串改PPL进程的代码和数据”。防止对进程
lsass.exe 的代码注入，这样一来就无法使用 mimikatz 对 lsass.exe
进行注入，相关操作也会失败。在注册表HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa  
添加RunAsPPL=dword:00000001，重启就可以开启了PPL保护了。在windows2012上加载mimidrv.sys可以绕过这一保护，不过笔者在win2016上测试即使加载了mimidrv.sys仍然无法正常攻击。下图分别是2016跟2012域控上执行的攻击2016失败2012成功
笔者在win2016系统上利用mimidrv驱动无法关闭PPL保护，删除注册表键值重启后仍无法关闭保护，具体原因后面有时间看下是什么原因，2012系统上加载驱动后可以关闭PPL保护
无论是否可以攻击，加载驱动这一行为已经有明显的特征可以供我们进行检测。  
windows日志4697记录了mimidrv.sys驱动的安装
sysmon日志13可以很明显看到mimidrv服务以及对应的驱动程序
sysmon日志6可以看到驱动加载了并且是未签名的
**3.防御清除**
可以使用zBang 工具检测扫描网络中潜在的特权帐户威胁。  
（[https://github.com/cyberark/zBang）其中有5种检测项](https://github.com/cyberark/zBang%EF%BC%89%E5%85%B6%E4%B8%AD%E6%9C%895%E7%A7%8D%E6%A3%80%E6%B5%8B%E9%A1%B9)  
1.ACLight 扫描- 发现必须保护的最高特权帐户，包括可疑的影子管理员。  
2.Skeleton Key scan – 发现可能被 Skeleton Key 恶意软件感染的域控制器。  
3.SID 历史扫描- 发现具有辅助 SID（SID 历史属性）的域帐户中的隐藏权限。  
4.RiskySPNs 扫描- 发现可能导致域管理员凭据被盗的 SPN 的风险配置  
5.神秘扫描- 发现网络中存在风险的 Kerberos 委派配置  