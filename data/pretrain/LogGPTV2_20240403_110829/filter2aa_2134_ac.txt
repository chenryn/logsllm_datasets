\adaware antivirus\12.10.111.0
atc.sys
BitDefender Active Threat Control Filesystem Minifilter
C:\Windows\System32\Drivers\
gzflt.sys
Bit Defender Gonzales Filesystem Driver
C:\Windows\System32\Drivers\
In-memory modules present:
Name
Description
Path
N/A
N/A
N/A
Functions Hooked:
N/A
N/A
N/A
Minifilters Present:
Driver
Altitude
Type
gzflt.sys
320820
FSFilter Anti-Virus
Atc.sys
320781
FSFilter Anti-Virus
TRUFOS.SYS
320770
FSFilter Anti-Virus
31
Antivirus Artifacts III
Antivirus Driver
Request
TRUFOS.SYS
IRP_MJ_CREATE
TRUFOS.SYS
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
gzflt.sys
IRP_MJ_CREATE
gzflt.sys
IRP_MJ_CLEANUP
gzflt.sys
IRP_MJ_SET_INFORMATION
gzflt.sys
IRP_MJ_WRITE
gzflt.sys
IRP_MJ_FILE_SYSTEM_CONTROL
gzflt.sys
IRP_MJ_VOLUME_MOUNT
gzflt.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
atc.sys
IRP_MJ_CREATE
atc.sys
IRP_MJ_WRITE
atc.sys
IRP_MJ_CLEANUP
atc.sys
IRP_MJ_READ
atc.sys
IRP_MJ_SET_INFORMATION
atc.sys
IRP_MJ_QUERY_INFORMATION
atc.sys
IRP_MJ_DIRECTORY_CONTROL
atc.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
atc.sys
IRP_MJ_QUERY_EA
atc.sys
IRP_MJ_SET_EA
atc.sys
IRP_MJ_FILE_SYSTEM_CONTROL
Services:
Name
Description
Startup Type
Path
Adaware antivirus service
Helps protect users
from Malware &
other potentially
unwanted software
Automatic
adaware
antivirus\%ld\AdAwareServ
ice.exe
32
Antivirus Artifacts III
Avast
Parent Directory
C:\Program Files\AvastSoftware\Avast
Binaries present:
Name
Description
Sub directory
aswArPot.sys
Avast Anti Rootkit
C:\Windows\System32\Drivers\
aswbidsdriver.sys
Avast IDS Application Activity Monitor Driver.
C:\Windows\System32\Drivers\
aswbidsh.sys
Avast Application Activity Monitor Helper Driver
C:\Windows\System32\Drivers\
aswbuniv.sys
Avast Universal Driver
C:\Windows\System32\Drivers\
aswKbd.sys
Avast Keyboard Filter Driver
C:\Windows\System32\Drivers\
aswMonFlt.sys
Avast File System Filter
C:\Windows\System32\Drivers\
aswNetHub.sys
Avast Network Security Driver
C:\Windows\System32\Drivers\
aswRdr2.sys
Avast Antivirus
C:\Windows\System32\Drivers\
aswSnx.sys
Avast Antivirus
C:\Windows\System32\Drivers\
aswSP.sys
Avast Self Protection
C:\Windows\System32\Drivers\
aswStm.sys
Avast Stream Filter
C:\Windows\System32\Drivers\
aswVmm.sys
Avast VM Monitor
C:\Windows\System32\Drivers\
wsc_proxy.exe
Avast Remediation exe
/
AvastSvc.exe
Avast Service
/
aswEngSrv.exe
Avast Antivirus engine server
/
aswToolsSvc.exe
Avast Antivirus
/
aswidsagent.exe
Avast Software Analyzer
/
AvastUI.exe
Avast Antivirus
/
33
Antivirus Artifacts III
In-memory modules present:
Name
Description
Sub Directory
awshook.dll
Avast Hook Library
/x86
ashShell.dll
Avast Shell Extension
/
Functions Hooked:
ADVAPI32.DLL
CryptImportKey
LogonUserW
CryptGenKey
CryptDuplicateKey
LogonUserA
LogonUserExA
LogonUserExW
N/A
N/A
USER32.DLL
GetClipboardData
SetWindowsHookExA
SetWindowsHookExW
NTDLL.DLL
RtlQueryEnvironmentVariable
LdrLoadDll
NtQueryInformationProcess
NtMapViewOfSection
NtTerminateProcess
NtOpenSection
NtWriteVirtualMemory
NtOpenEvent
NtCreateEvent
NtCreateSection
NtProtectVirtualMemory
NtResumeThread
NtCreateMutant
NtCreateSemaphore
NtCreateUserProcess
NtOpenMutant
NtOpenSemaphore
NtOpenThread
NtSuspendProcess
RtlDecompressBuffer
N/A
Minifilters Present:
Driver
Altitude
Type
aswSP.sys
388401
FSFilter Activity Monitor
aswMonFlt.sys
320700
FSFilter Anti-Virus
aswSnx.sys
137600
FSFilter Virtualization
34
Antivirus Artifacts III
Antivirus Driver
Request
aswSP.sys
IRP_MJ_CREATE
aswSP.sys
IRP_MJ_CREATE_NAMED_PIPE
aswSP.sys
IRP_MJ_SET_INFORMATION
aswSP.sys
IRP_MJ_FILE_SYSTEM_CONTROL
aswSP.sys
IRP_MJ_LOCK_CONTROL
aswSP.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
aswSP.sys
IRP_MJ_SET_SECURITY
aswSP.sys
IRP_MJ_WRITE
aswSP.sys
IRP_MJ_CLOSE
aswMonFlt.sys
IRP_MJ_CREATE
aswMonFlt.sys
IRP_MJ_WRITE
aswMonFlt.sys
IRP_MJ_CLEANUP
aswMonFlt.sys
IRP_MJ_CLOSE
aswMonFlt.sys
IRP_MJ_SET_INFORMATION
aswMonFlt.sys
IRP_MJ_SET_SECURITY
aswMonFlt.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
aswMonFlt.sys
IRP_MJ_FILE_SYSTEM_CONTROL
aswSnx.sys
IRP_MJ_CREATE
aswSnx.sys
IRP_MJ_NETWORK_QUERY_OPEN
aswSnx.sys
IRP_MJ_WRITE
aswSnx.sys
IRP_MJ_DIRECTORY_CONTROL
aswSnx.sys
IRP_MJ_CLEANUP
aswSnx.sys
IRP_MJ_QUERY_INFORMATION
aswSnx.sys
IRP_MJ_SET_INFORMATION
aswSnx.sys
IRP_MJ_FILE_SYSTEM_CONTROL
aswSnx.sys
IRP_MJ_QUERY_VOLUME_INFORMATION
35
Antivirus Artifacts III
Web Traffic:
Protocol
Remote Address
Local Port
Remote Port
TCP
5.45.59.36
51910
80
TCP
5.62.54.29
51911
80
TCP
5.62.53.230
52459
443
TCP
5.62.53.230
52460
443
TCP
5.62.53.212
52461
443
TCP
5.62.53.212
52462
443
[continued below]
36
Antivirus Artifacts III
Services:
Name
Description
Startup Type
Path
Avast Antivirus
Manages &
implements Avast
Antivirus services for
this computer. This
includes real time
shields , the virus
chest & the
scheduler.
Automatic
\AvastSvc.exe
Avast Browser Update
Service
Keep your avast
software upto date.
Automatic
C:\Program Files
(x86)\AVAST
Software\Browser\Update\
AvastBrowserUpdate.exe
/svc
Avast Browser Update
Service
Keeps your avast
software upto date
Manual
C:\Program Files
(x86)\AVAST
Software\Browser\Update\
AvastBrowserUpdate.exe
/medsvc
Avast Secure Browser
Elevation Service
-
Manual
C:\Program Files
(x86)\AVAST
Software\Browser\Applicati
on\%ld\elevation_service.e
xe
Avast Tools
Manages &
implements avast
tools services for the
computer
Automatic
C:\Program Files\Avast
Software\Avast\aswToolsSv
c.exe /runassvc
AvastWsc Reporter
-
Automatic
C:\Program Files\Avast
Software\Avast\wsc_proxy.
exe /runassvc /rpcserver
37
Antivirus Artifacts III
Dr.Web
Parent Directory
C:\Program Files\DrWeb
Binaries present:
Name
Description
Sub directory
dwdg.sys
Dr.Web device Guard for Windows
C:\Windows\System32\Drivers\
spiderg3.sys
Dr.Web File System Monitor
C:\Windows\System32\Drivers\
A4B1FF85CA.sys
Dr.Web Protection for Windows
C:\program files\kmspico\temp
dwprot.sys
Dr.Web Protection for Windows
C:\Windows\System32\Drivers\
dwnetfilter.exe
Dr. Web Net Filtering Service
\
dwservice.exe
Dr. Web Control Service
\
dwantispam.exe
Dr. Web Anti Spam
\
dwarkdameon.exe
Dr. Web Anti-Rootkit Service
\
dwscanner.exe
Dr. Web Scanner SE
\
In-memory modules present:
Name
Description
Sub Directory
drwamsi64.dll
Dr. Web AMSI
/
Functions Hooked:
See remarks at bottom
N/A
N/A
Minifilters Present:
Driver
Altitude
Type
spider3g.sys
323600
FSFilter Anti-Virus
dwprot.sys
323610
FSFilter Anti-Virus
38
Antivirus Artifacts III
Antivirus Driver
Request
dwdg.sys
IRP_MJ_CREATE
dwprot.sys
IRP_MJ_CREATE
dwprot.sys
IRP_MJ_CLEANUP
dwprot.sys
IRP_MJ_CLOSE
dwprot.sys
IRP_MJ_READ
dwprot.sys
IRP_MJ_WRITE
dwprot.sys
IRP_MJ_SET_INFORMATION
dwprot.sys
IRP_MJ_DEVICE_CONTROL
dwprot.sys
IRP_MJ_FILE_SYSTEM_CONTROL
dwprot.sys
IRP_MJ_SET_EA
dwprot.sys
IRP_MJ_SET_SECURITY
dwprot.sys
IRP_MJ_SET_EA
dwprot.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
spiderg3.sys
IRP_MJ_CREATE
spiderg3.sys
IRP_MJ_FILE_SYSTEM_CONTROL
spiderg3.sys
IRP_MJ_WRITE
spiderg3.sys
IRP_MJ_CLEANUP
spiderg3.sys
IRP_MJ_CLOSE
spiderg3.sys
IRP_MJ_SET_INFORMATION
spiderg3.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
spiderg3.sys
IRP_MJ_RELEASE_FOR_SECTION_SYNCHRONIZATION
spiderg3.sys
IRP_MJ_SHUTDOWN
Web Traffic:
Protocol
Remote Address
Local Port
Remote Port
TCP
162.159.134.234
50183
443
39
Antivirus Artifacts III
Services:
Name
Description
Startup Type
Path
Dr.Web Control Service
Dr.Web Control
Service is an essential
part of Dr.Web
Anti-virus! Please do
not stop and do not
disable it
Automatic
C:\Program
Files\DrWeb\dwservice.exe
--logfile="C:\ProgramData\
Doctor
Web\Logs\dwservice.log
Dr.Web Net Filtering
Service
Dr.Web Net Filtering
Service checks
incoming and
outgoing traffic.
Manual
"C:\Program
Files\DrWeb\dwnetfilter.ex
e" --ats
Dr.Web Scanning Engine
Dr.Web Scanning
Engine checks your
files against viruses.
It is an essential part
of the Dr.Web
Anti-Virus! Please do
not stop and do not
disable it.
Manual
"C:\Program Files\Common
Files\Doctor Web\Scanning
Engine\dwengine.exe"
Note: Dr Web hooks functions. The functions are hooked using reflective DLL loading. Process
Explorer and Process Hacker do not detect the loaded / injected DLLs. Dr Web loads 3
additional DLLs including a modified NTDLL which has no header. The modified NTDLL
variant is locked from a kernel-side component. I have not inspected this further.
40
Antivirus Artifacts III
Kaspersky
Parent Directory
C:\Program Files(x86)\Kaspersky Lab
Binaries present:
Name
Description
Sub directory
klupd_klif_klark.sys
Kaspersky Lab Anti-Rootkit
C:\Windows\System32\Drivers\
klupd_klif_mark.sys
Kaspersky Lab Anti-Rootkit Memory Driver
C:\Windows\System32\Drivers\
klupd_klif_arkmon.sys
Kaspersky Lab Anti-Rootkit Monitor Driver
C:\ProgramData\Kaspersky Lab\AVP21.2\
avp.exe
Kaspersky Anti-Virus
\Kaspersky Security Cloud 21.2
avpui.exe
Kaspersky Anti-Virus
\Kaspersky Security Cloud 21.2
kpm.exe
Kaspersky Password Manager
\AVP21.2\Lab
ksdeui.exe
Kaspersky Secure Connection
\Kaspersky VPN 5.2
ksde.exe
Kaspersky Secure Connection
\Kaspersky VPN 5.2
kldisk.sys
Virtual Disk
C:\Windows\System32\Drivers\
klflt.sys
Filter Core
C:\Windows\System32\Drivers\
klgse.sys
Security Extender
C:\Windows\System32\Drivers\
klhk.sys
klhk
C:\Windows\System32\Drivers\
klids.sys
Network Processor
C:\Windows\System32\Drivers\
klif.sys
Core System Interceptors
C:\Windows\System32\Drivers\
klim6.sys
Packet Network Filter
C:\Windows\System32\Drivers\
klkbdflt2.sys
Light Keyboard Device Filter
C:\Windows\System32\Drivers\
klpd.sys
Format Recognizer
C:\Windows\System32\Drivers\
kltap.sys
TAP-Windows Virtual Network Driver
C:\Windows\System32\Drivers\
klupd_klif_kimul.sys
Kaspersky Lab Anti-Rootkit Monitor Driver
C:\Windows\System32\Drivers\
41
Antivirus Artifacts III
In-memory modules present:
Name
Description
Sub Directory
antimalware_provider.dll
Kaspersky AntiMalwareProvider Component
Kaspersky Total Security 21.2\x64
Functions Hooked:
N/A
N/A
N/A
Minifilters Present:
Driver
Altitude
Type
klif.sys
323600
FSFilter Anti-Virus
Antivirus Driver
Request
klif.sys
IRP_MJ_CREATE
klif.sys
IRP_MJ_CREATE_NAMED_PIPE
klif.sys
IRP_MJ_READ
klif.sys
IRP_MJ_WRITE
klif.sys
IRP_MJ_SET_INFORMATION
klif.sys
IRP_MJ_DIRECTORY_CONTROL
klif.sys
IRP_MJ_FILE_SYSTEM_CONTROL
klif.sys
IRP_MJ_DEVICE_CONTROL
klif.sys
IRP_MJ_SHUTDOWN
klif.sys
IRP_MJ_CLEANUP
klif.sys
IRP_MJ_SET_SECURITY
klif.sys
IRP_MJ_PNP
klif.sys
IRP_MJ_ACQUIRE_FOR_SECTION_SYNCHRONIZATION
klif.sys
IRP_MJ_VOLUME_MOUNT
42
Antivirus Artifacts III
Web Traffic:
Protocol
Remote Address
Local Port
Remote Port
TCP
80.239.170.149
50719
80
TCP
67.27.99.250
50800
443
TCP
67.27.99.250
50801
443
TCP
38.113.165.138
51881
443
TCP
66.110.49.116
51875
443
Services:
Name
Description
Startup Type
Path
Kaspersky Anti-Virus
Service 21.2
Provides computer
protection against
viruses and other
malware, network
attacks, Internet
fraud and spam.
Automatic
"C:\Program Files
(x86)\Kaspersky
Lab\Kaspersky Total
Security 21.2\avp.exe" -r
Kaspersky Volume
Shadow Copy Service
Bridge 21.2
Kaspersky Volume
Shadow Copy Service
Bridge
Manual
"C:\Program Files
(x86)\Kaspersky
Lab\Kaspersky Total
Security
21.2\x64\vssbridge64.exe"
Kaspersky VPN Secure
Connection Service 5.2
Protects confidential
data that the user
enters on websites
(such as banking card
numbers or
passwords for access
to online banking
services) and
prevents theft of
funds during online
transactions.
Automatic
"C:\Program Files
(x86)\Kaspersky
Lab\Kaspersky VPN
5.2\ksde.exe" -r
Note: Kaspersky also contains a Standard Filter for Keyboard I/O
43
Antivirus Artifacts III
Conclusion:
As this series has grown we are now starting to see anti-viruses use an array of different
technologies which can be difficult for malware authors to see. Although many rely on archaic
hooking techniques, and hook archaic functionality from well-known malware techniques,
many also come equipped with fairly robust file system minifilters to capture data which
escape the hooks. This is evident because in the original entry in the Antivirus Artifacts series
F-Secure was able to detect the keylogger placed on the machine despite not using any API
hooks and also being unfamiliar with the malicious binaries MD5 hash. This robust minifilter
system, coupled with static binary analysis implementations (something YARA rule-like),
could prove to be a challenging adversary for malware authors.
As a final note: in this series I was unable to test these anti-viruses against the ‘Undertaker’
malware written because after the release of Antivirus Artifacts 1 most antivirus companies
had flagged the file hash as malicious. The homebrew malware proof-of-concept can be viewed
on VirusTotal.
Previous paper proof-of-concept IOC:
2a419d2ddf31ee89a8deda913abf1b25d45bb0dc59a93c606756cfa66acb0791
44
Antivirus Artifacts III