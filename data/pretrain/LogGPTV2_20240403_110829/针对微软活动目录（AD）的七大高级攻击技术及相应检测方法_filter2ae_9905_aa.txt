# 针对微软活动目录（AD）的七大高级攻击技术及相应检测方法
|
##### 译文声明
本文是翻译文章，文章原作者 Positive Technologies，文章来源：blog.ptsecurity.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
## 一、概述
在过去的4年中，对微软活动目录（Microsoft Active Directory）的攻击一直都是Black
Hat和Defcon会议关注的一大重点。演讲者们不断讲解新的攻击角度，分享他们的发现，同时也提出检测方法和防御方案。根据这些已有的信息，我认为IT部门已经完全可以构建一个安全的基础架构，并且该架构可以由安全部门来进行监控。但是，如果想要进行高质量的监控，那么还需要有良好的工具。这其实就像是一个军事基地：只在其周围建起守卫塔还不够，还需要派一些战士在守卫塔上面持续监控。
## 二、六个不容忽视的攻击方式
###  2.1 哈希值传递
这种攻击方法受到NTLM架构的限制，NTLM是微软在20世纪90年代发布的一种身份验证协议。要登陆到远程主机，需要存储在计算机上的密码哈希值，用于身份验证过程。该哈希值可以从计算机上提取出来。
###  2.2 Mimikatz
为了实现这一目的，法国的研究者Benjamin Delpy在2014年开发了Mimikatz，该实用程序允许从计算机内存中转储明文密码和NTLM哈希值。
###  2.3 暴力破解
如果无法实现从主机提取凭据，那么攻击者也可以选择粗暴但是有效的密码猜测技术。
###  2.4 net user/domain
在进行攻击之前，攻击者实际上需要一个用户名字典。当任何域成员执行net user /domain命令之后，该命令就会返回AD域用户的完整列表。
###  2.5 Kerberoasting攻击
如果域使用了Kerberos作为身份验证协议，那么攻击者就可以尝试进行Kerberoasting攻击。在域上进行身份验证的任何用户，都可以请求Kerberos
Ticket，用于访问服务（票证授予服务Ticket Granting
Service）。TGS使用运行服务用户的密码哈希值进行加密。攻击者在请求TGS后，就可以对TGS进行离线的暴力破解，这一暴破过程不会受到任何阻止。如果成功，攻击者将获得运行服务账户的密码，而这一账户通常为特权账户。
###  2.6 PSEXEC
在攻击者获得所需凭据之后，下一步就是要远程命令执行。使用Sysinternals中的PsExec实用程序可以轻松实现，这个实用程序非常有效，受到广大IT管理员和广大黑客的青睐。
## 三、盘点七大高级攻击技术
现在，我们将盘点7种能够实现Active Direction完全控制的黑客攻击方法。下图展现了攻击的四个步骤，而其中的每一步都对应着一套方法。
让我们首先从侦查（Reconnaissance）开始。
###  3.1 PowerView
PowerView是PowerSploit中的一部分，PowerSploit是一个用于渗透测试的PowerShell框架。PowerView支持Bloodhound，这是一种在AD中能对连接对象进行图形展现的工具。
使用Bloodhound，可以实现以下内容：
1、查找所有域管理员账户；
2、查找登录到主机的域管理员；
3、使用域管理会话，查找从攻击者主机到目标主机的最短路径。
上面的第三条也说明，黑客需要对主机进行攻击，才能进入域管理员账户。这种方法显著减少了攻击者对域获得完全控制所需要的时间。
PowerView与允许在AD对象（例如net.exe）上获取数据的内置使用程序之间存在区别，其区别在于PowerView使用的是LDAP，而不是SAMR。要检测这一活动，我们可以借助域控制器事件1644。通过在注册表中添加相关值，可以启动该事件的记录：
    HKEY_LOCAL_MACHINESYSTEMCurrentControlSetServicesNTDSDiagnostic\15 Field Engineering = 5
请注意，可能存在多种此类事件。同时，还有另外的一种方法，就是分析流量。由于LDAP是一种明文协议，因此所有查询都在流量中有所体现。
该框架的另一个特性，是它仅使用PowerShell，并且不具有依赖关系。此外，PowerShell
v5版本包含了一个高级审计选项，在实际检测工作中非常有用。事件4104中包含脚本内容，可以在其中搜索特定于PowerView的函数名称。
###  3.2 SPN扫描
这个实用程序可以替代Nmap。在攻击者知道AD中存在哪些用户和哪些组之后，他还需要有关服务的信息，这样才能对攻击目标具有一个全面的了解。
通常，使用Nmap扫描端口可以得到这样的信息。但由于这些信息已经存储在AD中，所以攻击者直接从AD检索即可。查询结果如下所示：会返回包含服务类的服务主体名称SPN（该服务类针对每种服务类型是唯一的）、FQDN格式的主机名称和某些服务的端口。
有关SPN的完整列表，请参阅  。
要检测SPN扫描，可以使用LDAP事件审核。
SPN扫描具有明显优于Nmap的优点，也就是准确度较高。使用Nmap时，需要连接到每个主机，并且将数据包发送到指定范围的端口，而SPN列表只是一个查询的结果。
###  3.3 远程会话枚举
在横向移动阶段，有一个重要的任务，就是将用户与他们所登陆的计算机相匹配。攻击者这个时候已经拥有了用户凭据（哈希值或Kerberos
Ticket），同时已经搜索到受漏洞影响的主机或具有域管理员会话的主机。
在这两种情况下，攻击者的后续动作都会是：寻找可攻击目标 —> 对任意主机成功攻击 —> 上传Mimikatz —> 获得所需信息。
要检测此方案是否被使用，可以查询这两个事件：4624-成功登陆到远程系统（登录类型3）和命名管道为“srvsvc”的访问网络共享IPC$事件。
在左图中的红色标出部分，展示了SMB连接，随后连接到管道“srcsvc”。该管道允许通过服务器服务远程协议进行交互。终端主机从管道接收各种管理信息，例如，可以是NetSessEnum的请求。这一请求会返回使用其IP地址和名称登录到远程系统的完整用户列表。
通过MaxPatrol SIEM可以实现基于这两个事件与srvsvc相关性进行的检测。PT Network Attack
Discovery可以基于流量分析进行类似的检测。
###  3.4 Overpass-the-Hash