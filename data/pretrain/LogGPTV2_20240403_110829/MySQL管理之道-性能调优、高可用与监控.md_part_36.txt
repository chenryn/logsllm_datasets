#service rgmanager start
（5）配置集群
#chkconfigricci on
chkconfigrgmanageron
chkconfig cman on
chkconfigluci on
ReborRades Before Jong Cluster
，输人https:/192.168.8.101:8084，用户名和密码就是系统root的用户名和
CreateChuster
Enable Shared Storage Support
Create NewCluster
Add Another Node
Cluster Name
Download Packages
C
Please wait...
Cancel
HA_TEST
ferA
图7-6创建集群所需要安装的包
......
......
pOMsse
Nod
图7-5创建集群
192.168.8.102
由于这里是虚拟机，因此选择的是
0
1111
出现如图7-5所示的界面。
---
## Page 273
按照这个方法，再把192.168.8.102执行一次。
图7-13所示)。
192.168.8.101/102-AddFenceMethod，如图7-10所示。
4）添加失败域。执行Failover Domains→Add，
输人一个Fence设备域的名字fence_domain，单击Submit，出现图7-15所示的界面，
然后选择刚才创建的虚拟Fence设备virtual_fence（如图7-14所示）。
单击Submit，
然后取个名字，如图7-11所示。
3）把两个节点（192.168.8.101/102）加到Fence设备，单击Nodes选项卡，打开
5）创建资源。执行Resources→Add，出现如图7-18所示的界面。
创建成功后，会出现如图7-17所示的界面。
单击Submit，出现图7-9，代表创建完毕。
在这里，先创建一个虚拟VIP，如图7-19所示。
HA_TEST
AddrebootJonClasteLere Clutuulet
192.165.8102
Node Name
：出现图7-12所示的界面，然后再单击Method下的AddFence Instance(如
OAdd Olt
L
NocdesFence Devces
virtual_fence
Name
Name
FenceType
Fence virt (Hulticast Mode)
Add Fence Device (Instance)
Submit
NodeID
图7-8添加一个Fence设备
Cancel
Failover DomainsResourcesServiceGroupsConfigure
图7-9创建完毕
图7-7创建完毕
Fence xvm
xvmVirtual MachineFencing
virtualfence
FenceType
Votes
Cluser Member
，出现如图7-16所示的界面。
000.0212
00:00:02:10
第7章
目前流行的4种高可用架构·259
192:168.8.101
---
## Page 274
260
·第三部分高可用集群管理篇
1592.16,.8.10mbgr
Prooerties
AddRboetJoin Clutr
ailove
service
icci hos
Number ofvotes
Method
AddFence Method toNode
Devices
hod
192.168.8.102
Dornains
192.168.8.101
Fence
Node Name
Nameethod
FenceDevces
dd
instance
图7-10把两个节点加到Fence设备
图7-13选择虚拟Fence设备
图7-11这里随便起一个名字
Cancel
图7-12增加Fence实例
Fence Device
Lesva
Clutter
11111
192.168.8.101
区
Me
---
## Page 275
之后单击图7-20 中的 Submit。最后，创建一个MySQL启动脚本，如图7-21所示。
然后单击图7-19中的Submit，接着创建一个共享磁盘，如图7-20所示。
OAddODelete
Nodes
Name
Fence Devices
letho
口
Namelfailover_domain
AddFailoverDomain to Cluster
Fence
Create
192.168.8.102
192.168.8.101
Prioritized
AddFenc Instance
ertual_fence
Fallover Domains
NoFailback
Restricted
irtual_fonce（xvn Virtual Hachine Fencing)
Add Fence Device (Instance)
图7-15增加192.168.8.102机器到Fence失败域
Domain
Cancel
图7-14输人Fence 设备域的名字
Cancel
图7-17失败域创建成功
fence_domain
图7-16
Resources
Service can run only on nades specified
Order the nodes to which services failover
添加失败域
Service Groups
Member
Machine
Configure
Fencir
Priority
第7章目前流行的4种高可用架构·261
---
## Page 276
第三部分
高可用集群管理篇
Netmask Bits (optional)
IPAddress
IPAddress
IP Address
AddResourcetoCluster
MonitorLink
Submit
MountOotions
Filesystem
Flesystem ID (otional)
DeviceFSaerUD
Filesysten
AddResource toCluster
MountPoint
FilesystemType
Name
Submit
Updates to Static Routes
Add Resourceto Cluster
Cancel
CIFS Houn
ddress
Cancel
图7-20
图7-19输人VIP地址
图7-18
添加共享磁盘
添加VIP资源
192.168.8.100
---
## Page 277
然后单击Add Resource，如图7-23所示p
6）整合资源。单击Service Groups→Add，出现如图7-22所示的界面。
单击图7-21中的 Submit。
Add Resource
AddServiceGrouptoCluster
RecoveryPolicy
FailoverDomain
Run Exclusive
AutomaticallyStartThisService
Submit
ServiceName
Length of Time in Seconds After Which toForget a Res
Maximum Number of RestartFailures
Restart Options
Cancel
Full Path to Script File
Script
Script
AddResourcetoCluster
Name
Global Resources-
Add Resource toService
168.8.100/24
Resource Type
图7-21
图7-23
Before Relocati
图7-22创建服务组
添加MySQL启动脚本
依次添加到服务
sta
/etc/init.d/mysql
口
nysql
第7章
Restart
failover_domain
目前流行的4种高可用架构·263
---
## Page 278
264·第三部分高可用集群管理篇
所示)。
最后，按照顺序依次添加VIP、共享磁盘、MySQL启动脚本（如图7-24～图7-26
Non-CriticalResource
Independent Subtree
Reboot Host Nodeif Unmount Fails
UseQuickStatus Checks
Forcefsck
Filesystem ID(optional)
MountOptions
Device,FS Label, or UUID
MountPoint
FilesystemType
ilesystem
IP Address
IPAddress
Name
Non-Critical Rescurce
Independent Subtree
Number af Seconds to Sleep AfterRemoving an IPAddres
MonitorLink
Netmask Bits(ootional)
Restart Expire Time(seconds)
IndependentSubtree/Nor
MaximumNumberof Restarts
Failure ExpireTime (seconds)
Maximum Number of Failures
Addachildresource
Restart Expire Time (seconds)
MaximumNumber of Restarts
Failure Exoire Time (seconds)
MaxinumNumberofFailures
IndependentSubtree/Non-
-Critical
图7-25共享磁盘
Optio
图7-24VIP
3
19Z,168.8100
---
## Page 279
7.3.2
漂移过去，仍旧会停留在slave上面，这样避免了多次切换造成业务的两次中断。
掉，VIP就会漂移到 slave上，共享分区会自动挂载，等把原来的 master修复好，VIP不会
有些复杂，因为在Web 界面上有很多按钮要配置。
RHCS 集群的核心进程包括cman 和rgmanager，要启动集群，需依次在集群的每个节
到这里红帽RHCS 共享存储架构已经搭建完毕，
1.启动RHCS集群
Add SturtRestrtODiablDelete
出现这个界面，RHCS 集群就成功启动了。
之后，单击Submit，如图7-27所示。
NodesfenceDevicesFailoverDomainsResources
红帽RHCS集群的维护
Name
Submit
AddResource
Non-Critical Resource
ndependent Subtree
FullPath to Scriot File
Name
Addachild resource
IndependentSubtree/Non-Critical Option
MaximumNumber of Restarts
Failure Expire Time (seconds)
Maximum Number of Failures
Cancel
Running on192.168.8.101
Status
图7-26MySQL启动脚本
图7-27集群运行状态
Select an item to view details
ServiceGroups
。如果把master关机或者把MySQL停
，其安装、搭建过程相比于Keepalived
Configure
第7章目前流行的4种高可用架构·265
7
L
etc/nitd/msql
mysql
---
## Page 280
266·第三部分高可用集群管理篇
细信息。在服务资源MySQL 启动后，与服务相关的集群资源（如虚拟IP、应用程序服务脚
关闭、重启、切换集群中的应用服务。
就需要通过手工方式来启动。管理应用服务的命令是clusvcadm，通过这个命令可以启动、
闭后，再依次关闭每个节点的cman 服务，这样即可完成整个集群服务的关闭。
rgmanager。在集群所有节点成功启动cman 服务后，继续依次在每个节点启动 rgmanager
本）也会随之启动，可以通过clustat命令查看集群资源是否已经正常加载。
服务。
点执行如下命令：
（1）启动某个应用服务
集群系统启动后，默认是自动启动应用服务的，但是如果某个应用服务没有自动启动，
需要注意的是，执行这两个命令是有先后顺序的，首先需要启动cman，然后再启动
可以通过/var/log/messages和/var/log/cluster/rgmanager.log文件查看启动应用服务的详
3．管理应用服务
首先在集群的每个节点依次关闭rgmanager服务，等所有节点的 rgmanager服务成功关
2.关闭RHCS集群
service cman start
Member192.168.8.102stoppingservice:mysql...Success
例如，要关闭节点192.168.8.102上的MySQL服务，操作如下：
可以通过如下方式关闭某个节点的应用服务：
（2）关闭某个应用服务
例如，要启动节点192.168.8.102上的MySQL服务，操作如下：
口 Node：表示集群节点名称。
口 Service：表示集群中创建的应用服务名称。
可以通过如下方式启动某个节点的应用服务：
[root@node2~]# clusvcadm-smysql-m192.168.8.102
service:mysqlisnowrunningon192.168.8.102
Memberweb1tryingtoenableservice:mysql...Success
[root@node2~]# clusvcadm-emysql-m192.168.8.102
其中：
clusvcadm-e-m