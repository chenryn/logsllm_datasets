parent process ?
●
sshd
○
dropbear (ssh)
●
web serverice
○
httpd
○
lighttpd
Process Detection
Unexpected Process ?
●
SSH
●
TELNET
●
DDNS
●
VPN
Hardcoded key
●
Telnet password
●
Certifcate
●
AES Key
35
File Detection
openssl zlib -e %s | openssl
-e %s
openssl                                           
-d %s %s | openssl zlib -d
-e %s %s
-d %s %s                                          
-in %q
-k %q
-kfile /etc/secretkey
2EB38F7EC41D4B8E1422805BCD5F740BC3B95BE163
E39D67579EB344427F7836
360028C9064242F81074F4C127D299F6
-iv
crypt_used_openssl
enc_file
Weak Password
check your self by dictionary attack
●
/usr/share/wordlist
●
/usr/share/wfuzz/wordlist
●
/usr/share/golismero/wordlist
●
/usr/share/dirb/wordlist
root     xc3511
root     vizxv
root     admin
admin    admin
root     888888
root     xmhdipc
root     default
root     juantech
root     123456
root     54321
support  support
root     (none)
admin    password
root     root
root     12345
user     user
admin    (none)
root     pass
admin    admin1234
root     1111
admin    smcadmin
admin    1111
root     666666
36
File Detection
Persistence
Attacker can re-package the firmware with several malware
●
/etc/rc.d/
●
/etc/init.d/malware
●
crontab
●
nvram
37
File Detection
●
NVRAM / Flash
○
/dev/nvram
○
/proc/mtd
○
/dev/mtd*
NVRAM
38
NVRAM
Boot Loader
kernel
File System
MTD Partition
Firmware
mtd0: 0x00000000-0x00400000 : "ALL"
mtd1: 0x00000000-0x00030000 : "Bootloader"
mtd2: 0x00030000-0x00040000 : "Config"
mtd3: 0x00040000-0x00050000 : "Factory"
mtd4: 0x00050000-0x00360000 : "Kernel"
mtd5: 0x00360000-0x003b0000 : "DATA"
/proc/mtd
File Detection
Read NVRAM
url_filter_rule=rule_1,www.google.com
mac_filter_enable=1
mac_filter_max_num=24
mac_filter_mode=deny
mac_filter_rule=
mac_ipv6_filter_enable=1
telnetEnabled=0
WscCusPBCEnable=1
WscCusPINEnable=0
CusChannel=0
factory_mode=2
/dev/mtd2
39
NVRAM
Boot Loader
kernel
File System
MTD Partition
Firmware
File Detection
Payload in NVRAM
40
NVRAM
Boot Loader
kernel
File System
MTD Partition
Firmware
File Detection
url_filter_rule=rule_1,www.google.com$(telnet
d -l sh -p 1337 -b 0.0.0.0),
mac_filter_enable=1
mac_filter_max_num=24
mac_filter_mode=deny
mac_filter_rule=
mac_ipv6_filter_enable=1
telnetEnabled=0
WscCusPBCEnable=1
WscCusPINEnable=0
CusChannel=0
factory_mode=2
/dev/mtd2
Othres
●
Fake Binary
○
Diff with firmware
○
File Modification Date
●
logs
○
system logs - /jffs/syslog.log
41
File Detection
DNS Hijacking
42
Network Detection
resolve.conf
DHCP option
dnsmasq
/etc/resolv.conf
nameserver 192.168.7.1
nameserver 192.168.7.254
Sniffer
●
One of inode exist /proc/net/packet probably is Sniffer (SOCKS_RAW)
43
Network Detection
Suspicious Network
●
Iptables
●
HTTP Proxy
●
Port Forwarding
●
Reverse shell
●
Reverse VPN client
44
Network Detection
SOHO Router Security Solution
45
SOHO Router Security Solution
●
ASUS: AiProtection Classic (PRO) By Trend Micro
●
D-Link: D-Fend By McAfee
●
TP-Link: HomeCare By Trend Micro
●
NETGEAR: Armor By Bitdefender
46
Check
Security Configartion
47
48
ASUS: AiProtection Classic (PRO) By Trend Micro
/* PROTECTION EVENT */
{PROTECTION_INTO_MONITORMODE_EVENT           ,0
,"Intrusion Alert"
,"" },
{PROTECTION_VULNERABILITY_EVENT              ,0
,"Intrusion Prevention System Alert"
,"" },
{PROTECTION_CC_EVENT                         ,0
,"Infected Device Detected and Blocked"
,"" },
{PROTECTION_DOS_EVENT                        ,0
,"DoS Protection Alert"
,"" },
{PROTECTION_SAMBA_GUEST_ENABLE_EVENT         ,0
,"Securtiy Risk - Samba"
,"" },
{PROTECTION_FTP_GUEST_ENABLE_EVENT           ,0
,"Securtiy Risk - FTP "
,"" },
{PROTECTION_FIREWALL_DISABLE_EVENT           ,0
,"Securtiy Risk  - Firewall Disable"
,"" },
{PROTECTION_MALICIOUS_SITE_EVENT             ,0
,"Malicious Site Access Blocked"
,"" },
{PROTECTION_WEB_CROSS_SITE_EVENT             ,0
,"Security Event Notice - Web Cross-site Scripting!"
,"" },
{PROTECTION_IIS_VULNERABILITY_EVENT          ,0
,"Security Event Notice - Microsoft IIS Vulnerability!"
,"" },
{PROTECTION_DNS_AMPLIFICATION_ATTACK_EVENT   ,0
,"Security Event Notice - DNS Amplification Attack!"
,"" },
{PROTECTION_SUSPICIOUS_HTML_TAG_EVNET        ,0
,"Security Event Notice - Suspicious HTML Iframe tag!"
,"" },
{PROTECTION_BITCOIN_MINING_ACTIVITY_EVENT    ,0
,"Security Event Notice - Bitcoin Mining Activity!"
,"" },
{PROTECTION_MALWARE_RANSOM_THREAT_EVENT      ,0
,"Security Event Notice - Malware Ransomware Threat!"
,"" },
{PROTECTION_MALWARE_MIRAI_THREAT_EVENT       ,0
,"Security Event Notice - Malware Mirai Threat!"
,"" },
49
ASUS: AiProtection Classic (PRO) By Trend Micro
if ( v43 & 2 ) {
v6 = (int)&v91;
snprintf(
(char *)&v91,
0x3BFu,
"SELECT timestamp, type, src, dst FROM monitor WHERE type=3 AND (timestamp > 
%ld AND timestamp < %ld) ORDER"
" BY timestamp DESC",
(char *)v12 - 130,
v12);
printf("sql = \"%s\"\n", &v91);
sub_1750C(v71, &v91, "/jffs/.sys/AiProtectionMonitor/AiProtectionMonitorVPevent.txt");
}
After pentest 
nothing alert ?
50
SOHO Router Security Solution
●
Limited vender, limited model
●
Protect client device rather than router devices
●
Network-based Detection, does not provide protection against …
○
pentesting
○
evil payload 
○
disable protection
51
Improvement Router Security Mechanism
●
Package signing
●
Package encrypted
●
GCC Protection (SSP)
●
Separate users for processes
●
Procd jail
52
An Embedded System Detection and Response
53
SOHO Router Security Solution
●
Limited vender, limited model
●
Protect client device
●
Network-based Detection
54
SOHO Router Security Solution
●
Limited vender, limited model → Cross-Branding & Cross-Platform
●
Protect client device → Protect router itself
●
Network-based Detection → Behavior-based Detection
55
An Embedded System Detection and Response
56
●
Cross-Branding
○
ASUS / ROG / Synology / D-Link / TP-Link  / TOTOLINK / ...
●
Cross-Platform
○
i386 / amd64 / arm / arm64 / mips32 / mips64
●
Support Open Source IoC
●
Support MITRE ATT&CK
57
An Embedded System Detection and Response
An Embedded System Detection and Response
●
Focus on the Embedded System itself
○
Router, NAS, IPCam, RPi
●
Behavior-based Detection: Scans Process / File / Network / NVRAM
●
Automaticity identifying the APT & Botnet Threats
58
LEAYA Architecture
Web
Server
Client
Agents
59
LEAYA Features
●
IoC auto-update
●
Easy Setup & Update Agent
●
LEAYA + Raspberry pi
60
LEAYA Detections
●
Process
●
File
●
Network
●
NVRAM
62
63
64
CHECK PROCESS
65
66
67
68
69
70
CHECK FILE
71
72
73
CHECK NETWORK
74
75
76
CHECK NVRAM
77
78
79
●
APT uses various 1-day router exploits to compromise routers, the 
advances to attack endpoints of subnetwork
●
We research attack techniques and how to identify them
●
According to our researched, current security solution of routers on the 
market exist High Risk because the router didn’t protect itself
●
Discuss how to secure routers
●
We implemented a cross-platform EDR for Embedded Systems
Conclusion
80
Q&A
? ? ?
81