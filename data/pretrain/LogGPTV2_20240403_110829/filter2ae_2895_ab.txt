`schtasks.exe / CREATE / SC MINUTE / MO 5 / TN“ Adobe Update Task ” / TR
\”“％ProgramFiles（x86）％\ Adob​​e \ Acrobat Reader DC \ Reader \ Update \
armsvc.exe \”” [/ RL最高] / F [/ RU系统]`
在执行有效负载之前以及在主循环的每次迭代之前，该恶意软件都会使用以下列表对运行分析软件进行检查。如果找到任何具有匹配名称的进程，它将停止所有正在运行的组件并退出。
#### 防病毒规避
在初始化cryptominer组件之前，该恶意软件对`rootSecurityCenter2 \ AntiVirusProduct
WMI`对象的字符串avast，avg和eset进行不区分大小写的检查，如图8的反编译代码所示。如果检测到这些字符串中的任何一个，将不会安装cryptominer组件。
图8.清理了用于检查特定安全产品的函数的反编译代码。
每当恶意软件自行安装、更新或安装新组件时，通过发出以下命令，将使用的安装路径从Windows Defender自动扫描中排除：
`powershell -c “Add-MpPreference -ExclusionPath ‘'”`
它还会创建防火墙规则，以使用看起来无害的名称显式允许其组件的入站和出站流量。图9所示的函数还创建了一条规则，以阻止来自ESET内核服务（ekrn.exe）的出站流量。
图9.阻止来自Windows防火墙中的ekrn.exe的出站流量的功能。
#### Tor网络使用
KryptoCibule带来了tor.exe命令行工具，其伪装为ADelRCP.exe，以及一个配置文件（如图10所示）为libstringutils.dll。
 图10.最新版本的恶意软件使用的Tor配置文件。
这将在端口9050上设置一个SOCKS代理，恶意软件使用该代理通过Tor网络中继与C&C服务器的所有通信。这有两个好处：加密通信并使跟踪这些uri背后的实际服务器变得几乎不可能。
配置文件的第二部分在受害主机上设置洋葱服务。运营商可以通过Tor网络访问这些内容。首次启动这些服务时，Tor会自动为主机生成一个.onion
URI。然后，此唯一主机名将发送到`%C&C%/transferhost/`。我们将在接下来的部分中讨论如何使用这些洋葱服务。
恶意软件中包含两个C＆C服务器的洋葱URI。其中一个提供了REST API，恶意软件将其用于大多数通信，而另一个则用于下载文件。通过向`％C＆C％/
server`发出请求，可以一次获得一个附加的URI
。某些较旧版本的恶意软件使用这些恶意软件通过端口12461下载更新。我们相信这些URI指向其他受感染的主机。使用它们的恶意软件版本具有代码，可将其下载的更新放置在同一端口上的MiniWeb
HTTP Server服务的目录中。
我们能够在遥测数据中为文件服务器C＆C标识一个IP地址。
## 获取加密货币
KryptoCibule具有三个组件，这些组件利用受感染的主机来获取加密货币。
#### 密码挖掘
KryptoCibule的最新版本使用XMRig（一个使用CPU挖掘Monero的开源程序）和kawpowminer（另一个使用GPU挖掘以太坊的开源程序）。第二个仅在主机上找到专用GPU时使用。这两个程序都设置为通过Tor代理连接到操作员控制的挖掘服务器。
在主循环的每次迭代中，恶意软件都会检查电池电量以及自上次用户输入以来的时间。然后，它将基于此信息启动或停止矿工进程。如果主机在最近3分钟内未收到任何用户输入，并且电池电量至少为30％，则GPU和CPU矿机都将不受限制地运行。否则，GPU矿工将被挂起，并且CPU矿工被限制为一个线程。如果电池电量不足10％，则两个矿工都将停止。这样做是为了减少被受害者注意的可能性。
#### 剪贴板劫持
第二个组件伪装为SystemArchitectureTranslation.exe。它使用[AddClipboardFormatListener函数](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-addclipboardformatlistener
"AddClipboardFormatListener函数")来监视对剪贴板的更改，并将从`％C＆C％/
regexes`获得的替换规则应用于其内容。该侦听器的代码如图11所示。值0x31D对应于WM_CLIPBOARDUPDATE常量。
这些规则以`！`的形式匹配加密货币钱包地址的格式，并将其替换为由恶意软件操作员控制的钱包地址。这是尝试将受害者进行的交易重定向到运营商的钱包。每当settings.cfg文件更改时，此组件便使用[FileSystemWatcher](https://docs.microsoft.com/en-us/dotnet/api/system.io.filesystemwatcher?view=netcore-3.1
"FileSystemWatcher")重新加载替换规则。
图11.剪贴板挂钩使用的侦听器功能的反编译代码。
在撰写本文时，剪贴板劫持组件使用的钱包收到了略高于1800美元的比特币和以太坊。图12中显示了一个这样的钱包。通过将与相同交易中的来源的钱包相关联，我们能够发现至少四个可能属于KryptoCibule运营商的其他比特币钱包。
图12.剪贴板劫持组件使用的比特币钱包。
#### 文件渗透
第三个组件遍历每个可用驱动器的文件系统，并查找包含某些术语的文件名。我们在调查中获得的此类术语的列表如图13所示。
图13.要搜索的单词列表，取自GET％C＆C％/ settingsv5响应。
大多数术语指的是加密货币，钱包或矿工，但也存在一些更通用的术语，例如加密货币（多种语言），种子和密码。该列表包含捷克语和斯洛伐克语中的类似术语，例如heslo，hesla和banka（分别是“
password”，“ passwords”和“
bank”两个词）。一些术语也对应于路径或文件，这些路径或文件可以提供其他有趣的数据（Desktop，私有），包括私有密钥（.ssh和.aws）。它收集每个匹配文件的完整路径，并将列表发送到`%C&C%/found/`。
我们认为，这与在端口9187上作为洋葱服务运行的SFTP服务器协同工作有关系。此服务器为每个可用驱动器创建映射，并使用在恶意软件中硬编码的凭据使它们可用。因此，通过使攻击者控制的计算机通过SFTP从受感染的主机请求收集的路径，可以将其用于文件扩散。
KryptoCibule还会安装合法的Apache httpd服务器，该服务器配置为无限制地充当转发代理，并且可以作为端口9999上的洋葱服务访问。
## 结论
自2018年底以来，KryptoCibule恶意软件一直在泛滥，并且仍处于活动状态，但到目前为止似乎并没有引起太多关注。它使用合法的开放源代码工具以及广泛部署的反检测方法可能是造成此问题的原因。受害人数相对较少（数百人），而且他们大多局限于两个国家，这也可能是造成这种情况的原因。KryptoCibule在其生命周期中定期添加了新功能，并且仍在积极开发中。
据推测，恶意软件操作员通过窃取钱包和挖掘加密货币能够比在剪贴板劫持组件所使用的钱包中发现的收入更高。仅由该组件产生的收入似乎不足以证明所观察到的开发工作的合理性。
* * *