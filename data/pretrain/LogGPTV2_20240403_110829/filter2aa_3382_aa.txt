跟IE签约成为XSS少⼥吧
Make a contract with IE and become a XSS girl!
Yosuke HASEGAWA
http://utf-8.jp/
歉意 I'm sorry 谢罪
我从来没有看过动画作品
"魔法少⼥⼩圆☆魔⼒"
I've never watched the anime "Puella Magi 
Madoka Magica" 
“まどか☆マギカ”⾒てません
自我介绍 Who am I? 自己绍介
Yosuke HASEGAWA
• NetAgent Co.,Ltd. R&D dept.
• Secure Sky Technology Inc. technical adviser
• Microsoft MVP for Consumer Security Oct 2005 -
• http://utf-8.jp/
• 开发JavaScript的混淆工具
Writing obfuscated JavaScript
介绍：混淆JavaScript
Introduction of
obfuscated JavaScript
混淆JavaScript
javascript:$=~[];$={___:++$,$$$$:(![]+"")[$],__$:++$,$_$_:(![]+"")[$],_$_:++$,
$_$$:({}+"")[$],$$_$:($[$]+"")[$],_$$:++$,$$$_:(!""+"")[$],$__:++$,$_$:++$,$$_
_:({}+"")[$],$$_:++$,$$$:++$,$___:++$,$__$:++$};$.$_=($.$_=$+"")[$.$_$]+($._$=
$.$_[$.__$])+($.$$=($.$+"")[$.__$])+((!$)+"")[$._$$]+($.__=$.$_[$.$$_])+($.$=(
!""+"")[$.__$])+($._=(!""+"")[$._$_])+$.$_[$.$_$]+$.__+$._$+$.$;$.$$=$.$+(!""+
"")[$._$$]+$.__+$._+$.$+$.$$;$.$=($.___)[$.$_][$.$_];$.$($.$($.$$+"\""+$.$_$_+
(![]+"")[$._$_]+$.$$$_+"\\"+$.__$+$.$$_+$._$_+$.__+"(\\\"\\"+$.__$+$.__$+$.___
+$.$$$_+(![]+"")[$._$_]+(![]+"")[$._$_]+$._$+", 
\\"+$.__$+$.__$+$._$_+$.$_$_+"\\"+$.__$+$.$$_+$.$$_+$.$_$_+"\\"+$.__$+$._$_+$.
_$$+$.$$__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$$_+$.__
_+$.__+"\\\" )"+"\"")())();
javascript:alert("Hello, JavaScript")
jjencode - http://utf-8.jp/public/jjencode.html
还可以更人性化!
Need ｍore friendly!
表情符号JavaScript  JS with emoticon
ﾟωﾟﾉ= /｀ｍ´）ﾉ ~┻━┻   //*´∇｀*/ ['_']; o=(ﾟｰﾟ)  =_=3; c=(ﾟΘﾟ) =(ﾟｰﾟ)-(ﾟｰﾟ); (ﾟДﾟ) =(ﾟΘﾟ)= 
(o^_^o)/ (o^_^o);(ﾟДﾟ)={ﾟΘﾟ: '_' ,ﾟωﾟﾉ : ((ﾟωﾟﾉ==3) +'_') [ﾟΘﾟ] ,ﾟｰﾟﾉ :(ﾟωﾟﾉ+ '_')[o^_^o -
(ﾟΘﾟ)] ,ﾟДﾟﾉ:((ﾟｰﾟ==3) +'_')[ﾟｰﾟ] }; (ﾟДﾟ) [ﾟΘﾟ] =((ﾟωﾟﾉ==3) +'_') [c^_^o];(ﾟДﾟ) ['c'] = 
((ﾟДﾟ)+'_') [ (ﾟｰﾟ)+(ﾟｰﾟ)-(ﾟΘﾟ) ];(ﾟДﾟ) ['o'] = ((ﾟДﾟ)+'_') [ﾟΘﾟ];(ﾟoﾟ)=(ﾟДﾟ) ['c']+(ﾟДﾟ) 
['o']+(ﾟωﾟﾉ +'_')[ﾟΘﾟ]+ ((ﾟωﾟﾉ==3) +'_') [ﾟｰﾟ] + ((ﾟДﾟ) +'_') [(ﾟｰﾟ)+(ﾟｰﾟ)]+ ((ﾟｰﾟ==3) +'_') 
[ﾟΘﾟ]+((ﾟｰﾟ==3) +'_') [(ﾟｰﾟ) - (ﾟΘﾟ)]+(ﾟДﾟ) ['c']+((ﾟДﾟ)+'_') [(ﾟｰﾟ)+(ﾟｰﾟ)]+ (ﾟДﾟ) ['o']+
((ﾟｰﾟ==3) +'_') [ﾟΘﾟ];(ﾟДﾟ) ['_'] =(o^_^o) [ﾟoﾟ] [ﾟoﾟ];(ﾟεﾟ)=((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+ (ﾟДﾟ) .ﾟДﾟ
ﾉ+((ﾟДﾟ)+'_') [(ﾟｰﾟ) + (ﾟｰﾟ)]+((ﾟｰﾟ==3) +'_') [o^_^o -ﾟΘﾟ]+((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+ (ﾟωﾟﾉ +'_') 
[ﾟΘﾟ]; (ﾟｰﾟ)+=(ﾟΘﾟ); (ﾟДﾟ)[ﾟεﾟ]='\\'; (ﾟДﾟ).ﾟΘﾟﾉ=(ﾟДﾟ+ ﾟｰﾟ)[o^_^o -(ﾟΘﾟ)];(oﾟｰﾟo)=(ﾟωﾟﾉ
+'_')[c^_^o];(ﾟДﾟ) [ﾟoﾟ]='\"';(ﾟДﾟ) ['_'] ( (ﾟДﾟ) ['_'] (ﾟεﾟ+(ﾟДﾟ)[ﾟoﾟ]+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ 
(ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + 
(ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) 
+(o^_^o))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ 
(ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟΘﾟ)+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟ
Θﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ 
((ﾟｰﾟ) + (ﾟΘﾟ))+ ((ﾟｰﾟ) + (o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ 
(c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟΘﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ 
(ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ 
(ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (o^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (o^_^o)+ (ﾟДﾟ)[ﾟ
εﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟΘﾟ)+ 
(ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ (ﾟｰﾟ)+ 
(ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟoﾟ]) (ﾟΘﾟ)) 
('_');
aaencode - http://utf-8.jp/public/aaencode.html
今天的主题
Today's topic
今天的主题 Today's topic
• 浏览器的开发竞赛激烈，
已进化到几乎每天发布新版本
Heating up developing race of browsers, New version 
of browsers are released day by day.
ブラウザの开発竞争が过热し、
新バージョンのブラウザが毎
日のようにリリースされる
今天的主要话题
今天的主要话题
今天的主要话题
今天的主要话题 Today's topic
• 即使旧版本浏览器还在产品支援期间，
漏洞却依然长期被忽视
Vulnerabilities of old versions are neglected for a 
long time, although during the period of support.
サポート期间中であるにも関
わらず、古いバージョンの脆
弱性は⻑い间放置される。
今天的主要话题 Today's topic
• 尤其是微软在IE6-8浏览器的许多问题，导
致 XSS.
Especially Microsoft. There're many vulns on IE6-8 
that causes XSS.
特にMicrosoft。IE6-8はXSS
につながる问题がたくさん。
第1话 忽略 Content-Type Header
Episode 1: Ignoring Content-Type Header
忽略 Content-Type Header
Ignoring Content-Type Header
• IE 长久以来的坏习惯
Bad habit of IE from old days
• 提升非 HTML 为 HTML 导致 XSS
Elevating no-HTML to HTML causes XSS.
HTMLではないものが
HTMLに升格してXSS
昔からのIEの悪癖
忽略 Content-Type Header
Ignoring Content-Type Header
• IE 用好几个方法决定 FILE TYPE,
不只看 Content-Type.
IE decides FILE TYPE of the content by several factors, 
not only "Content-Type"
• 没有说明的复杂机制
Complicated mechanism, undocumented.
文书化されていない复雑なメカニズム
IEはContent-Typeだけでなく、様々な要因からファイル
タイプを决定
忽略 Content-Type Header
Ignoring Content-Type Header
FILE TYPE 决定因素
Factors for deciding
• "Content-Type" HTTP header 标头
• "X-Content-Type-Option" HTTP 标头
• Association information on Windows 登录机码
• IE configuration:"根据内容开启档案而不是根据副档
名" "Open files based on content, not file extension"
• URL itself
• Contents body itself
忽略 Content-Type Header
Ignoring Content-Type Header
FILE TYPE 决定因素
Factors for deciding
• "Content-Type" HTTP header 标头
• "X-Content-Type-Option" HTTP 标头
• Association information on Windows 登录机
• IE configuration:"根据内容开启档案而不是根据副档
名" "Open files based on content, not file extension"
• URL itself
• Contents body itself
忽略 Content-Type Header
Ignoring Content-Type Header
FILE TYPE 决定因素
Factors for deciding
• "Content-Type" HTTP header 标头
• "X-Content-Type-Option" HTTP 标头
• Association information on Windows 登录机
• IE configuration:"根据内容开启档案而不是根据副档
名" "Open files based on content, not file extension"
• URL itself
• Contents body itself
Y
N
Y
N
N
Y
Enabled
Disabled
Y
N
N
Y
Y
N
Y
N
Content-Type is registered in Registry?   [ HKEY_CLASSES_ROOT\MIME\Database\Content Type ]
determine tentative file-type
need external plugin/apps?
IE8+ && "X-Content-Type-Options:nosniff"?
sniff content and determine file-type
Extension of URL is ".cgi" or ".exe" or nothing( "/" ) ?    e.g. http://utf-8.jp/a.cgi?abcd
need external plugin/apps?
launch plugin or download
"Open files based on 
content, not file extension"  
use tentative file-type 
IE8+ && "X-Content-Type-Options:nosniff"?
use tentative file-type 
determine tentative file-type by 
QUERY_STRING
launch plugin or 
download
sniff content and 
determine file-type
sniff content and 
determine file-type
need external plugin/apps?
determine tentative file-type by 
extension of URL
download
launch plugin or 
download
IE确定文件类型的机制Mechanism to determine file type of IE
Yosuke HASEGAWA http://utf-8.jp/
In addition to these, there're some exceptions.