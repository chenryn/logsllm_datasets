NTLM AUTHENTICATE
§ MIC = HMAC_MD5(SessionKey, ConcatenationOf(
NTLM_NEGOTIATE, NTLM_CHALLENGE, NTLM_AUTHENTICATE))
NTLM: NEW VULNERABILITIES
§ Your session key is my session key
§ Overcoming the MIC problem:
§ By removing the target hostname we are able to retrieve the session key
§ We have all 3 NTLM messages
§ The client provides a MIC which is based on the modified NTLM_CHALLENGE 
message
§ We recalculate the MIC based on the original NTLM_CHALLENGE message
NTLM: NEW VULNERABILITIES
§ Your session key is my session key
(1) NTLM Negotiate
(5) NTLM Authenticate
(4) NTLM Challenge
remove target name
Client Machine
DC
Server
Attacked 
Target
(6) NETLOGON
(7) Approve + Session Key
+Session Key 
(Hash Derived)
NTLM: NEW VULNERABILITIES
§ Your session key is my session key – Fix: 
§ Windows servers deny requests which do not include a target
§ Issues:
§ NTLMv1
§ messages do not have av_pairs -> no target field
§ Such authentication requests remain vulnerable to the attack
§ Non-Windows targets are still vulnerable
§ Patching is not enough
DROP THE MIC
NTLM: NEW VULNERABILITIES
§ Drop the MIC
§ MIC = HMAC_MD5(SessionKey, ConcatenationOf(
NTLM_NEGOTIATE, NTLM_CHALLENGE, NTLM_AUTHENTICATE))
§ If client & server negotiate session privacy/integrity, attackers cannot take 
over the session
§ The MIC protects the NTLM negotiation from tampering 
NTLM: NEW VULNERABILITIES
§ Drop the MIC
§ SMB clients turn on the signing negotiation flag by default & use a MIC
§ It is not possible (or at least, not trivial) to relay SMB to another protocol which 
relies on this negotiation flag (in contrast to other protocols such as HTTP)
§ How can we overcome this obstacle?
§ MIC can be modified only if the session key is known
§ Otherwise, it can be simply removed J
§ [In order to remove the MIC, the version needs to be removed as well, as well as 
some negotiation flags]
§ Result: It is possible to tamper with any stage of the NTLM authentication flow 
when removing the MIC
NTLM: NEW VULNERABILITIES
§ Drop the MIC
(1) NTLM Negotiate
Signing supported
(5) NTLM Authenticate
Includes MIC
(4) NTLM Challenge
No signing negotiated
Client Machine
Server
Attacked
Target
DC
NTLM: NEW VULNERABILITIES
§ Drop the MIC - Problem
§ The MIC presence is notified in the msvAvFlags attribute in the NTLM 
authentication message 
§ msvAvFlags is signed with the user’s password hash
§ Even if the corresponding bit is set, the target server does not verify that the 
MIC is indeed present
NTLM: NEW VULNERABILITIES
§ MIC bypass - Fix:
§ If msvAvFlags indicate that a MIC is present, verify its presence.
§ Issues:
§ Some clients don’t add a MIC by default (Firefox on Linux or MacOS)
§ These clients are still vulnerable to NTLM session tampering
§ More serious issue: 
CVE-2019-1166 –
Drop The MIC 2 J
EPA BYPASS
NTLM: NEW VULNERABILITIES
§ EPA (Enhanced Protection for Authentication) bypass
§ EPA binds authentication 
packets to a secure TLS channel
§ Adds a Channel Bindings field 
to the NTLM_AUTHENTICATE 
message based on the target 
server certificate
§ Prevents attackers from relaying 
the authentication to another 
server
§ Modification requires 
knowledge of the user’s NT 
HASH
NTLM: NEW VULNERABILITIES
§ EPA (Enhanced Protection for Authentication) bypass
§ Servers protected by EPA:
§ AD-FS
§ OWA
§ LDAPS
§ Other HTTP servers (e.g. Sharepoint)
§ Unfortunately by default, EPA is disabled on all of the above servers
§ In most cases, these servers are vulnerable to much simpler attack vectors 
NTLM: NEW VULNERABILITIES
§ EPA (Enhanced Protection for Authentication) bypass
§ Modifying the Channel Bindings 
in the NTLM_AUTHENTICATE 
message is not possible
§ But what if we add a Channel 
Bindings field to the 
NTLM_CHALLENGE message 
before we send it to the client?
NTLM: NEW VULNERABILITIES
§ EPA (Enhanced Protection for Authentication) bypass
§ Client will add our crafted field 
to the NTLM_AUTHENTICATE 
message!
§ Additional fields would be 
added to the message, including 
a second Channel Binding
§ Server takes the first Channel 
Binding for verification
NTLM: NEW VULNERABILITIES
§ EPA (Enhanced Protection for Authentication) bypass
§ What if the NTLM_AUTHENTICATE message includes a MIC?
§ DROP THE MIC!
Original NTLM_AUTHENTICATE:
Modified NTLM_AUTHENTICATE:
NTLM: NEW VULNERABILITIES
§ EPA (Enhanced Protection for Authentication) bypass
(1) NTLM Negotiate
DC
Server
Attacked 
Target
(4) NTLM Challenge
Inject Channel Binding
(5) NTLM Authenticate
Rouge Channel Binding
MIC
Client Machine
NTLM: NEW VULNERABILITIES
§ EPA bypass - Fix:
§ Servers deny authentication requests which include more than one 
channel binding value
§ Issues:
§ Some clients don’t support EPA & don’t add a MIC (Firefox on Linux or 
MacOS)
§ These clients are still vulnerable to the EPA bypass 
§ One such client is enough to make the entire domain vulnerable
ATTACKING AD-FS
ATTACKING AD-FS
§ AD-FS Architecture
https://www.sherweb.com/blog/office-365/active-directory-federation-services/
ATTACKING AD-FS
§ AD-FS Proxy
§ Open to the internet
§ Easy target for brute-force/password spraying attacks
§ External Lockout Policy
§ Locks the user coming from the external network after exceeding the 
Extranet Lockout Threshold
§ Has effect when: Extranet Lockout Threshold 
ATTACKING AD-FS
§ WIA (Windows Integrated Authentication) 
§ Use Kerberos or NTLM SSO capabilities to authenticate to AD-FS
§ WIA authentications were accepted by the AD-FS proxy
§ NTLM relay against the AD-FS proxy from the external network
§ NTLM authentications target at the AD FS proxy allowed attackers to bypass 
the external lockout policy (CVE-2019-1126)
ATTACKING AD-FS
§ WIA (Windows Integrated Authentication) 
§ Kerberos authentications allowed attackers to brute-force the AD-FS service 
account’s password
§ Generate service tickets using different passwords and send to AD-FS proxy
§ If password is successfully guessed -> log into cloud resources using any 
desired privileges
§ No logs generated for unsuccessful attempts
§ Reverse-Kerberoasting!
TAKEAWAYS
TAKEAWAYS
§ Patch all vulnerable machines!
§ Restrict NTLM usage as much as possible 
§ NTLM authentication is susceptible to NTLM relay attacks
§ Always prefer Kerberos usage
§ Disable NTLMv1 in your environment
§ Configure the GPO ‘Network security: LAN Manager authentication level’ to:  
‘Send NTLMv2 response only. Refuse LM & NTLM’
§ https://docs.microsoft.com/en-us/windows/security/threat-protection/security-
policy-settings/network-security-lan-manager-authentication-level
§ Incorporate NTLM relay mitigations:
§ SMB & LDAP signing
§ LDAP channel binding
§ EPA 
CREDITS
§ The Preempt Research Team
§ Eyal Karni (@eyal_karni)
§ Sagi Sheinfeld
§ Alberto Solino (@agsolino)
§ Some of the vulnerabilities are merged into impacket!
§ https://github.com/SecureAuthCorp/impacket
THANK YOU!