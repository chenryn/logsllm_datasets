246.51.2x的MUA工作站（该工作站未命名，故from后的字段空白）通过网页（viaHTTP）
务器的事实，也是确定发件人身份最重要的一段信息。
6.0.3790.4675)。
F14.Snto.hotmail.com的邮件服务器，使用的软件是Microsoft SMTPSVC（内部版本号为
本段信息表示该邮件是在服务器时间2010年9月24日23:17:48被一个IP地址为122
yahoo.com（其IP地址为202.165.102.5x）的邮件服务器传送到域名为SNT0-MC3-
5）拨号者的上网IP地址就是他的互联网访问“身份证”。在十多年前，多数用户通过
请注意[122.246.51.2x］字节，方括号内的IP地址不是邮件发送人提供给服务器的，而
对于宽带用户使用PPPOE方式网上犯罪行为，电信运营商需要配合公安局进行罪犯的
下面举个例子。通常普通用户都是使用ADSL接入电信或联通网络，当你开始拨号获取
这个Received 字段，是邮件的“第一站”，可以用于证明邮件经编辑后发送到发件人服
第二个Received字段：
本字段表示该邮件是在服务器时间2010年9月24日23:17:50，被web15604.mail.cnb.
说明：
23:17:48CST
Received: from [122.246.51.2x] by web15604.mail.cnb.yahoo.com viaHTTP; Sat, 24 Sep 2010
第2章UNIX/Linux系统取证91
---
## Page 115
日
张坤还应该考虑检查所有的日志文件，这样才可能全面评估这次入侵造成的损失。
物理上断开后，就可以开始细致的检查，而不用担心黑客会再次通过代理服务器入侵。同时
但当他开始怀疑代理服务器的时候，他就从网络中断开了该服务器的物理连接。在服务器人
来说，合适的设置应该是下面这样：
d开放式代理服务器的最大问题是访问控制列表的不合适的配置。对于Squid代理服务器
并没有真正使用，所以应该及时与网络断开。
指明了代理服务器，但是因为服务器没有上线，所以没有引起张坤的注意。既然代理服务器
果你管理一个网络，最好对网络进行安全审计。前任IT 管理员留下的网络结构图中清楚地
预防措施
92
在这个案例中，张坤并没有意识到网络中存在这样一个代理服务器，这简直糟透了。如
UNIX/Linux 网络日志分析与流量监控
在这个案例中，张坤采取了适当的补救方法。尽管在开始的时候他的方法有些不得当，
81100208日80年810.
http_access deny all
http_access allowmynetwork
acl mynetwork src 192.168.1.0/255.255.255.0
代中重政个
图2-11拨号用户和RADIUS服务器交互过程
P
ATM/FastGB
新申的点银寄效效直不灯讯
电号
中国#区时下国
宽带接人服务器
拨号电话号码等
用户名
awobnw
昌
Radius认证服务器
高长最容业识督站校业普
hviosH
M
---
## Page 116
Syslog协议收集。
算机网络取证分析系统。
解析其中的内容，做相应的处理。常见的应用场景是网络安全管理系统、日志分析审计及计
的服务器。接收 Syslog的服务器可以对多个设备的Syslog日志消息进行统一的存储，然后
中，被Syslog协议接收的事件可以记录在不同的文件中，也可以通过网络发送到接收 Syslog
录系统中的任何事件。管理者可以通过查看系统记录，随时掌握系统状况。在UNIX系统
到指定日志文件中。
信息发送到安装了 Syslog 软件系统的日志服务器，Syslog日志服务器自动接收日志数据并写
情况及所发生的事件。Syslog 协议使用UDP作为传输协议，通过514端口通信。Syslog
事件（event）的一个后台程序，记录内容包括核心、系统程序及使用者自行开发程序的运行
藏在这些日志中的安全问题。本章将介绍日志采集中的各种协议及使用方法。
大数据时代的到来，需要对收集到的海量日志信息进行分析，再利用数据挖掘技术，发现隐
对日志进行有效分析。因此，日志分析系统首先应实现对多种日志协议的解析。其次，随着
3.1.1Syslog 协议
信息为系统进行排错，优化操作系统性能。
照某种规范表达出来。日志系统指收集网络设备事件信息的机制。我们可以使用日志记录的
络资源？如何迅速响应网络的故障告警？日志采集技术可以记录系统产生的所有行为，并按
络应用资源的使用情况？如何识别网络中的异常流量和性能瓶颈？如何有效地规划和部署网
环境呢？先看看系统管理员常常面临的问题一一如何监控用户的网络应用行为？如何跟踪网
以及sawmill这三款强大的日志分析系统的安装和使用。
网络边缘设备及核心设备的日志分析，以图文并茂的方式讲解了EventlogAnalyzer、Splunk
（1）常见日志收集方式
3.1
Syslog可用来记录各种设备的日志，包括服务器、路由器、交换机等网络设备，它会记
Syslog在UNIX系统中应用广泛，它是一种标准协议（RFC3164）。它是负责记录系统
在网络管理中采集日志的常用方式包括：文本方式采集、SNMPTrap方式采集以及
完善的日志分析系统应该能够通过多种协议（包括 Syslog、rsyslog 等）进行日志采集并
当企业网络的规模及应用系统不断增大时，如何确保一个稳定、安全、高效的网络运营
本章主要讲解UNIX平台下的 Syslog 协议以及增强的 Rsyslog 协议特点与应用，介绍了
日志采集基础
第3章建立日志分析系统
YG
使
---
## Page 117
条关于该网络设备的故障信息。目前越来越多的企业在利用SNMP方式收集日志。刚
等事件。在网络设备的故障日志中，通过对 SNMP数据报文中Trap值的解读就可以获得一
告网络状态的陷阱报文，比如设备的冷热启动，一些端口状态的不可用，以及用户登录失败
SNMPTrap方式来进行日志数据的采集。Trap指的是被管理设备向SNMP管理者发送的通
把Raw log经过预处理后再显示。
网络发展，但是分析原始日志的基本方法需要掌握。
利于阅读和分析。随着大数据时代的到来，日志的产量越来越大，这种方式已不适应今后的
集设备日志数据。这几种方式的共同点是主要以原始日志为主，不能对日志深入加工，也不
94UNIX/Linux 网络日志分析与流量监控
对于建立在SNMP（SimpleNetworkManagementProtocol）上的网络管理，可以通过
在图3-1中显示了 Squid代理服务器原始日志的格式，由于冗长不便阅读，人们通常会
3）Syslog方式
2）SNMPTrap方式
192.168.150.14192.168.150.201Unlemown
192.168.150.144192.168.150201Unknowm
sg oAx
格式化处理的日志相当规整，符合人们的阅读习惯，方便查找问题，如图3-2所示。
Recent Proxy Log Events
以文本方式采集日志数据主要是指通过SMB方式共享、邮件发送或者以FTP上传来收
1）文本方式
Davica
2884M
ng:1t25ofabout1000logs
125.31
RawLoga
Host
Use
htp
图3-2处理后的日志
图3-1原始日志格式
日
g-cache
cache
ache.oo
google
googie
hAAGMHoECCABxAyLUEC
08250 500
Coni
HIECCABBAyLCE
HECCABBA
10L2V2
---
## Page 118
程序预留使用，
多网络设备都会默认使用facility值“localuse7”来发送信息。
个 facility值，而没有被分配到 facility 值的进程则会使用“local use”的 facilities 值，比如很
“>”结尾。
符（有的PRI也有四个或者5个的情况），以“<”为起始符，然后紧跟一个数字，最后
须在1024字节之内。Syslog 消息并没有对最小长度有所定义，
Priority），第二部分是HEADER（报头），第三部分是 MSG（消息描述）。报文的总长度业
志进行介绍。Syslog的完整格式由三个可识别的部分所组成。第一部分是PRI（优先
WELF（WebTrendsEnhanced LogFormat，趋于增强型的日志格式），下面就对每种格式的
及处理。
式。例如同样是记录日志日期，有些系统的日志使用的是mm/dd/hr:mm:ss 格式，有些会使
形式进行保存。这样便于日志的集中管理，查询分析时也不需要登录多个设备。
Syslog 能够以远程的方式接受来自设备的日志记录，能够把来自多个设备的日志记录以文件
计算得出，这两个值的级别和含义见表3-1和表3-2。操作系统的后台监控程序会被分配-
事件和活动，管理员可以通过阅读 Syslog 记录，随时掌握该设备目前的运行状况。而且
式
用
编
代。标准化不仅限于时间格式的统一，而要将所有日志的格式尽可能统一，以便数据的查询
月24小时的记录方式。标准化就需要将这些设备各自的时间记录格式转化为统一的时间格
从Facility（设备）的分类能看出来 syslog的Facility 有一部分（序号16～23）是为其他
9
2
（2）日志的标准化
该协议在服务器、路由器以及交换机等网络设备中，Syslog 能够记录系统中发生的各种
6
8
4
m
目前主流网络设备所产生的日志格式主要有三种：Syslog，TrafficLog 和国际通行白
（3）主流日志格式介绍
由于不同厂家的网络设备所产生的日志格式不同，需要将不同格式的日志转化为统一格
中
Line printer subsystem（打印机日志消息）
在括号内的数字被称为 Priority（优先级），Priority 值由 facility 和 severity 两个值
FTPdaemon（FTP日志消息）
Security/authorization messages
Clock daemon（时钟进程）
Network news subsystem（新闻服务日志消息）
Security/authorizationmessages（安全管理日志消息）
Systemdaemons（系统守护进程消息）
Mail system（邮件系统日志消息）
User-levelmessages（用户日志消息）
Kernel Messages（内核日志消息）
，例如Cisco设备使用local4发送 PIX防火墙的 syslog日志。
Facility
表3-1
Facility级别及含义
编号
23
19
8
3
第3章建立日志分析系统95
Local user7
Local user6
Local user5
Local user4
Local user 3
Local user2
Localuserl
Local use0（系统保留）
Clockdaemon
Log alert
Log audit
NTP subsystem（NTP日志消息）
其中 PRI 部分必须有
Facility
3个字
工
---
## Page 119
句的作用。
3.1.3Syslog.conf配置文件详解
备的增减、系统核心参数的改变等。
管理等信息；还记录了包括用户登录、系统重启动、文件系统加载与卸载、主机的访问、设
3.1.2Syslog日志记录的事件
96UNIX/Linux网络日志分析与流量监控
下面以CentOS Linux的 syslog.conf（部分内容如图3-3所示）配置文件为例讲解各条语
Syslog 反映了系统底层的诸多信息，它记录的信息非常全面，包括主机系统安全、主机
Syslog记录的系统事件有：
用户开发程序使用SyslogAPI产生的日志。
用户写在/etc/services中的服务程序。
系统管理过程中产生的 Syslog。
第三方和应用系统，如Tripwire、
系统服务模块，如WWW、DNS、MAIL、Squid、各种防病毒软件。
各类系统daemon产生的0~7级，如SNMP模块。
设备驱动程序的0~7级。
高可用性部分产生的0~7级。
安全模块部分，如Iptable。
网络部分产生的0~7级。
系统内核产生的0~7级，
中
body gets emergency messages
on
li the mail messages in one place.
kehl
Error（错误事件）
Critical（关键事件）
Alert（必须马上采取措施）
Emergency（系统不可用）
sages also to boot.1og
Severity
包括相关的硬件问题。
表3-2
TCPWrapper、Snort、CheckPoint等。
Severity级别及含义
ISO
编
SNIAHH
中
/var/log/boot.1og
/var/log/cron
/var/1og/mai11og
/var/log/secure
/var/log/messages
/dev/console
Debug（调试信息）
Informational（有用事件）