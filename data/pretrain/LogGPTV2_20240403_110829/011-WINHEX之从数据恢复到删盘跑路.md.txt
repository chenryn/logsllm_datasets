2020/7/27 WINHEX之从数据恢复到删盘跑路
WINHEX之从数据恢复到删盘跑路
原创 队员编号010 酒仙桥六号部队 5⽉28⽇
这是 酒仙桥六号部队 的第 11 篇⽂章。
全⽂共计2216个字，预计阅读时⻓8分钟。
背景
话说平时部⻔⾥⾯的⽼哥们⼀个个都不声不响的，开了公众号后才发现⼀个个都是⼈
才，说话还好听，呜呼～～
⼩弟不才，简单讲解下我会的⼀项⼩技能，希望能帮到阅读⽂章的师傅们。
观前提示：
1. ⽆相关基础的⽼哥看到winhex⾃动数据恢复，基本就满⾜⼤部分需要了。后⾯可能
有点难理解，只会增加⼀些奇怪的知识。
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 1/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
2. 有⼀定基础的⽼哥可以尝试⼿⼯恢复，好久之前学习到的技能了，写的不好希望⼤佬
们轻喷（嘤嘤嘤）。
什么是WINHEX
WINHEX是⼀款⽤于查看和编辑底层⼗六进制数据的软件。我们可以利⽤这个软件修改
⽂件格式数据，从⽽达到数据恢复的效果。
当然，WINHEX也不仅仅⽤于数据恢复，也可以⽤于磁盘恢复，RAID重组，镜像转换，
CTF隐写杂项等等。
下载⽹址：
[https://www.x-ways.net/winhex/index-m.html]
WINHEX ⽀持中⽂，可在设置栏中进⾏修改。
WINHEX 基本界⾯如下，我们数据恢复⽤到的功能很少因此只介绍⼀部分。
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 2/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
在安装和了解WINHEX的基本结构后，我们就可以愉快的进⾏数（删）据（盘）恢
（跑）复（路）了。
winhex⾃动数据恢复
如同字⾯意思⼀样，⾃动恢复就是利⽤HINHEX⾃动在存储数据的扇区中搜索⽂件类型
（根据⽂件头进⾏判断），并⾃动进⾏查找数据进⾏恢复。
⾃动恢复不需要我们掌握技术原理，操作⽅式如下：
⾸先打开你错删⽂件存储的磁盘，我这⾥删除的是C盘的⽂件，因此需要打开的C盘：
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 3/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
然后选择⼯具 -> 磁盘⼯具 -> 按⽂件类型进⾏恢复。
这⾥要注意恢复的⽂件最好是在⼀个新的磁盘中，以免造成⽂件覆盖。
选中我们要恢复的数据类型（可以多选），选中输出⽬录，点击确定：
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 4/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
恢复速度和磁盘⼤⼩有关，耐⼼等待数据恢复就好：
恢复成功，不少⿊历史都被搞出来了emmmmmm........
虽然恢复出来了，但是问题还是有很多的：
按照⽂件类型恢复的数据量多⽽复杂（因为是⽆差别寻找），在其中查找我们想要的数
据也要花费不少时间；
按照⽂件类型恢复的数据名会丢失（因为在⽂件系统中，数据内容和数据名不是存放在
⼀个地⽅）。
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 5/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
因此，如果我们想完整的恢复特定的⽂件，还是需要进⾏⼿动操作恢复的。⽽在进⾏⼿
动恢复之前，我们需要了解以下基础知识。
什么是⽂件系统
就像电脑对应的操作系统⼀样，我们⽇常使⽤的移动介质中，也存在相应的⽂件系统，
每种⽂件系统有⾃⼰的存储⽅式（⼤同⼩异），⽽⽐较常⻅的⽂件系统如下：
1. FAT32/64 常⻅于U盘，内存卡等⽂件系统
2. NTFS WIN的⽂件系统
3. APFS MAC的⽂件系统
由于⽂章篇幅原因，这⾥我们只讲解最常⻅的NTFS⽂件系统，也就是使⽤WINHEX基
于WINDOWS的数据恢复。
既然我们知道数据是存储在NTFS系统中，那么我们就要了解下NTFS⽂件系统的存储规
则。
NTFS ⽂件存储规则
在使⽤WINHEX查看NTFS⽂件系统的时候，我们能看⻅⼀些以$开头的⽂件，这些⽂件
就是NTFS操作系统的元⽂件，元⽂件⽤于管理存储介质中的内容：
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 6/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
在NTFS⽂件系统的结构如下：
其中每个元⽂件的功能如下：
1. $MFT⼜叫主⽂件表，⽤于存储数据名和⽂件区间的索引（简单理解就是这⾥存放着
⽂件名信息在内的⽂件属性信息，是我们数据恢复重点关注的对象）。
2. $MFTMIRR 就是$MFT的备份⽂件（但是只备份⼀部分）
3. $BOOT 引导⽂件，记录了⽤于引导的数据
4. $DBR 备份⽂件 ，其中$DBR 源⽂件在0号扇区
$MFT 元⽂件结构
上⽂我们知道⽂件属性存储在$MFT，那么接下来我们需要了解部分数据属性具体在
$MFT中的存储状况：
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 7/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
$MFT 结构 ⽤途
10属性 ⽂件标准信息（创建/修改时间等等）
30属性 存储⽂件名属性（主要是⽂件名）
80属性 存储⽂件数据内容信息（数据过⼤会存储地址）
在WINHEX中表现如下：
其中⽂件名是存储在30属性中的，⽽⽂件内容是存储在80属性中，然⽽80属性的容量
⼀般⽆法存储⽂件所有的数据，因此，这⾥涉及到了⼀个"簇流运⾏"的概念。
什么是簇流运⾏
"簇流"是指存放数据的⼀块区域，⽽"簇流运⾏"就是指记录"簇流"⽂件具体在那个位置
的数据（这⾥涉及了80属性的⼀个"常驻属性"和"⾮常驻属性"的概念）。
简单说，"簇流运⾏"就是指⽂件存储位置的⼀段字节。
⽽"簇流运⾏"中存储数据有⾃⼰的⼀套规则。举个例⼦，某"簇流运⾏"结构如下：
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 8/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
这⾥可能有点难理解，我猜你的表情应该是下⾯这个样⼦：
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 9/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
删除⽂件后NTFS的变化
在我们彻底删除⼀个⽂件后，在NTFS中到底是有什么变化呢？
在彻底删除⼀个⽂件后，只是在$MFT中的10属性发⽣变化了，表示这个⽂件可以被写
⼊数据（这也是为什么我们不建议对要数据恢复的磁盘进⾏写⼊操作的原因，害怕会覆
盖掉我们要进⾏数据恢复的⽂件）。
但是数据和数据属性仍然存在。也就是数据恢复的基础。
了解NTFS⽂件的存储规律后，接下来数据恢复的思路就很明显了。
我们使⽤WINHEX定位到MFT或者MFTMIRR⽂件，再从MFT/MFTMIRR⽂件中找到
要恢复的⽂件属性和数据存储扇区，导出扇区中的数据进⾏数据恢复了。
可能听起来有点懵逼，所以我们接下来⼿动尝试⼀遍。
使⽤winhex⼿⼯数据恢复
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 10/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
⾸先，shift+delete彻底删除⼀张图⽚作为数据恢复的对象。
使⽤winhex 打开被删除⽂件的磁盘，定位到$MFT项⽬，使⽤winhex搜索⽂件名：
WechatIMG648.jpeg 转换为⼗六进制。
⽹上很多，这⾥随便列出⼀个：
[https://www.bejson.com/convert/ox2str/]
点击任务栏中的查找⼗六进制数值，搜索⼗六进制的⽂件名，选择向下搜索，点击确
定。
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 11/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
找到⽂件80属性，找到簇流运⾏的⽂件。
5DECCA（这⾥读取扇区是需要倒着顺序的）转换成⼗进制为6155466，使⽤winhex
跳转。
这⾥我们看到JFIF⽂件头就能判断是⽂件开头了，⽽⽂件⼤⼩是09，转换成⼗进制也是
09，这⾥我们⾸先右键，选择标记为⽂件起始块。
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 12/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
跳转到⽂件结尾（6155466+9），扇区，右键选择结尾。右键选择编辑，置⼊新⽂件,
保存。
接下来就能看⻅我们数据恢复出来的⽂件了～～
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 13/14
2020/7/27 WINHEX之从数据恢复到删盘跑路
https://mp.weixin.qq.com/s/Fw9zbUMt0qp5JMEpyfzxRg 14/14
|---|--|--|--|--|
| 0 |  |  |  |  |