tar xvf nmap_agent-1.0.2.0.tar.gz
chown -R rizhiyi.rizhiyi nmap_agent/
2、修改配置文件 conf/config.ini 中的server_addr和
target_network项，修改自带http server监听地址为本机IP：
![](media/image36.png){width="5.763888888888889in" height="1.8625in"}
3、添加crontab项，后续将由crontab负责检查进程状态：
添加命令为crontab -e，添加以下内容到crontab中：
\# nmap_agent
\*/1 \* \* \* \* /opt/rizhiyi/nmap_agent/run.sh
![](media/image37.png){width="5.763888888888889in" height="0.96875in"}
4、完成后，在资产管理-\>agent管理界面查看是否有agent出现。查看存在表示安装成功。
![](media/image38.png){width="5.763888888888889in"
height="1.1475109361329834in"}
## SIEM落地流程
日志易SIEM平台基于日志易数据搜索引擎，通过流批处理计算框架，对企业之日志、流量进行深度关联，并结合资产信息、漏洞信息，进行威胁自动化响应处置，兼具关联分析以及异常分析能力，是全面涵盖企业威胁类型（已知威胁、可疑威胁以及未知威胁）的**威胁检测、分析与响应平台**。
![](media/image39.png){width="5.763888888888889in"
height="3.1659722222222224in"}
围绕与功能相对应的威胁处置、调查分析、资产管理、漏洞中心和配置中心等功能模块，SIEM平台平台威胁、资产以及漏洞的基本处理逻辑如下：
![](media/image40.png){width="5.763888888888889in"
height="2.7483147419072615in"}
每个功能模块需要关注的重点内容有：
-   威胁处置：使用日志易平台的"监控"功能，或使用Flink配置的规则监控威胁事件，并对已经发生的威胁进行取证分析。
-   调查分析：调查分析，主要来自威胁处置页面的跳转，目的为分析安全事件之间的关联性，以期能找出威胁的横向移动痕迹。
-   资产管理：主要通过手动导入/导入 CSV、对接 CMDB
    获取资产信息，支持通过资产自动发现，对资产进行动态监控，最终为威胁与漏洞关联，提供资产信息。
-   漏洞中心：通过API对接漏洞扫描器的信息，与威胁信息、资产信息进行关联，实现对接。并对漏洞展示与管理。
从以上几个方面入手，SIEM场景具体使用方法详见下一章节。
# 使用场景
使用日志易SIEM首先需要进行安全事件监控，量通过**威胁处置**功能监控安全事件，对企业之日志、流量进行深度关联，并结合资产信息、漏洞信息，进行关联分析、异常分析及威胁自动化响应。资产信息在**资产管理**界面进行管理，漏洞信息在**漏洞中心**管理查看，关联分析则在**调查分析**界面进行查看。
这个四个模块的说明及使用过程如下：
## 威胁处置
威胁处置集中展示来自安全事件告警、威胁告警与资产信息、漏洞信息等情境的关联，同时提供了基于每一条威胁告警从网络层以及端点层两方面的取证能力，协助用户用尽量少的时间完成威胁告警的真实性及结果的判断，以便后续进一步开展响应处置。
### 威胁告警规则编写
安全场景规则为使用日志易平台的"监控"功能，通过SPL搜索语句，进行配置的（另一种方式为使用Flink进行规则的配置），则需遵照一定的格式规则进行编写，否则会影响威胁告警的输出。具体的"监控"功能使用，请先参照《日志易监控告警手册》。
#### 威胁告警规则步骤
威胁告警规则的编写，需先在"搜索"页面中进行验证，比如编写"WAF多向量攻击"规则，可以编写SPL进行查询验证。
![](media/image41.png){width="5.763888888888889in"
height="2.936111111111111in"}
再通过"新建监控"，编辑安全场景监控规则，如下图所示。
![](media/image42.png){width="5.629922353455818in" height="2.8075in"}
#### 威胁告警SPL规则格式要求
威胁告警SPL编写主要需要注意以下几点，如格式不对，可能会影响威胁告警输出到SIEM上。
##### 字段命名规范
在编辑好查询逻辑之后，需要在结尾规范字段命名；比如描述字段，将之命名为desc，如src_addr，实际上是将源地址与源端口合并成一个字段，但也可以只采用源地址，不一定要端口。这部分可以根据实际情况来进行配置。
##### 必有字段
在编辑好查询逻辑之后，需要补全必要字段，目前必要字段如下：
（1）描述字段，desc。
（2）源地址+源端口字段，src_addr。
（3）目的地址+目的端口字段，dst_addr。
（4）位置区域字段，area。
##### 威胁告警描述
对于字段的合并，再去查询字段长度，以判断该字段类型有多少种这种模式，使用split命令分隔的时候，不能使用逗号分隔，否则会影响SIEM威胁告警的描述分隔。
安全场景SPL编写，举例如下：
appname:waf  waf.cve_id:/.\*CVE.\*/
\| stats count() as cnt by
waf.event_name,waf.src_ip,waf.cve_id,waf.dst_ip
\|mvcombine sep=\",\" waf.cve_id
\|eval cve_split=split(waf.cve_id,";")
#注意，这里的分隔符不能用逗号，会影响威胁处置页面的展示
\|eval cve_cnt=len(cve_split)
\|where cve_cnt\>1
\|table waf.src_ip,waf.cve_id,waf.dst_ip,cve_split,cve_cnt
\|rename  waf.src_ip as src_ip,waf.cve_id as cve_id,waf.dst_ip as dst_ip
\|eval src_addr=src_ip＃必备字段,可以加上端口,如src_addr=src_ip+src_port
\|eval dst_addr=dst_ip＃必备字段,可以加上端口,如src_addr=dst_ip+dst_port
\|eval desc =
src_ip+"向"+dst_ip+"发起"+cve_id+"等漏洞利用攻击"＃必备字段，对应"威胁处置"中的威胁描述
\|eval area="互联网区"＃必备字段，对应"威胁处置"中的区域
其中不同的字段对应SIEM威胁处置页面展示位置主要如下图所示。
![](media/image43.png){width="5.763888888888889in"
height="3.073611111111111in"}
##### 威胁告警SPL规则固定值添加
编写威胁监测SPL后，需要在监控功能"高级配置"功能，实现固定字段的添加，主要需要添加威胁类型1、威胁类型2及威胁阶段三个字段，如下图所示。
![](media/image44.png){width="5.763888888888889in"
height="2.777083333333333in"}
说明：
-   威胁类型1以及威胁类型2的定义请参考《日志易SIEM安全威胁场景分类分级统计表》。
-   威胁阶段，主要分为信息探测、恶意投递、漏洞利用、命令与控制、横向扩展、实施攻击等六个阶段，需要结合具体场景进行配置。
##### 威胁告警转发
由于目前的威胁告警是存放在mysql的威胁表中，所以需要将告警转发至后台接收模块，再写入mysql中，转发配置的地址如，IP为yotta-siem模块所在地址。配置如下图。
![](media/image45.png){width="5.763888888888889in"
height="2.970833333333333in"}
### 威胁处置页面
威胁处置页面为SIEM的主要页面，全景展示如下图。
![](media/image46.png){width="5.763888888888889in"
height="3.120833333333333in"}
日志易SIEM威胁处置页面，主要分为查询区域、查看区域、状态变更区域、跳转区域。
#### 威胁查询区域
威胁告警的查询，主要分为，威胁告警级别、威胁告警状态、威胁告警ID、威胁名称、源地址:端口、目的地址:端口、威胁阶段以及时间聚合窗口等属性的查询。
![](media/image47.png){width="5.7630336832895885in"
height="2.3135662729658795in"}
查询条件说明如下：
1、威胁告警ID
可以确定唯一标识，以便于多部门开展协同。
2、威胁名称
可以通过关键字模糊查询对应的威胁告警；
3、源地址:端口
需注意合法输入范例，如：
192.\*.\*.\*
192.168.\*.\*
192.168.1.\*
192.168.1.10
192.\*.\*.\*:80
192.168.\*.\*:80
192.168.1.\*:80
192.168.1.10:80
\*:80
4、目的地址:端口