## 设置进程亲和 - numactl 或 taskset - retrieve or set a process's CPU affinity (affect SYSTEMTAP TIME)  
### 作者                        
digoal                        
### 日期                        
2013-11-26                       
### 标签                        
PostgreSQL , Linux , CPU亲和 , taskset , numactl    
----                        
## 背景           
在使用systemtap监控进程或者内核的运行状况时, 我们会发现使用systemtap和不使用systemtap时, 某些操作的运行时间差别会比较大. 这是因为systemtap本身带来的开销导致的, 那么如何减少这部分开销呢?  
可选的方法较多, 例如精简systemtap, 减少systemtap的触发事件的范围, 简化handler的逻辑等等.  
除此之外, 还有其他的方法, 例如设置CPU亲和, Linux进程使用哪个CPU资源是由内核进行调度的.  
被跟踪进程的亲和与stap运行的进程亲和分开, 可以有效的减少stap的影响吗. 实际上影响甚微, 但是有效果.    
其次发现CentOS 6.4 x64系统下面, 使用CPU 0的话, 性能会远远不如使用其他任何CPU. (可能与OS调度有关，软中断集中在CPU 0了)   
所以改亲和的话, 只要不使用0号CPU就可以了.  
例如 :   
服务器上有8个CPU  
```  
pg93@db-172-16-3-150-> numactl --show  
policy: default  
preferred node: current  
physcpubind: 0 1 2 3 4 5 6 7   
cpubind: 0   
nodebind: 0   
membind: 0   
pg93@db-172-16-3-150-> cat /proc/cpuinfo   
processor       : 0  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 1  
siblings        : 4  
core id         : 0  
cpu cores       : 4  
apicid          : 16  
initial apicid  : 16  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.98  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 1  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 0  
siblings        : 4  
core id         : 0  
cpu cores       : 4  
apicid          : 0  
initial apicid  : 0  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.50  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 2  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 1  
siblings        : 4  
core id         : 1  
cpu cores       : 4  
apicid          : 18  
initial apicid  : 18  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.98  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 3  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 0  
siblings        : 4  
core id         : 1  
cpu cores       : 4  
apicid          : 2  
initial apicid  : 2  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.50  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 4  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 1  
siblings        : 4  
core id         : 2  
cpu cores       : 4  
apicid          : 20  
initial apicid  : 20  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.98  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 5  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 0  
siblings        : 4  
core id         : 2  
cpu cores       : 4  
apicid          : 4  
initial apicid  : 4  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.50  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 6  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 1  
siblings        : 4  
core id         : 3  
cpu cores       : 4  
apicid          : 22  
initial apicid  : 22  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.98  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
processor       : 7  
vendor_id       : GenuineIntel  
cpu family      : 6  
model           : 26  
model name      : Intel(R) Xeon(R) CPU           E5504  @ 2.00GHz  
stepping        : 5  
cpu MHz         : 1595.992  
cache size      : 4096 KB  
physical id     : 0  
siblings        : 4  
core id         : 3  
cpu cores       : 4  
apicid          : 6  
initial apicid  : 6  
fpu             : yes  
fpu_exception   : yes  
cpuid level     : 11  
wp              : yes  
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid  
bogomips        : 3191.50  
clflush size    : 64  
cache_alignment : 64  
address sizes   : 40 bits physical, 48 bits virtual  
power management:  
```  
从以上CPUINFO可以看出, 这里有2个物理CPU, 0和1.  
使用dmidecode也可以看到这部分信息  
```  
[root@db-172-16-3-150 ~]# dmidecode -t processor  
# dmidecode 2.11  
SMBIOS 2.6 present.  
Handle 0x0400, DMI type 4, 40 bytes  
Processor Information  
        Socket Designation: CPU1  
        Type: Central Processor  
        Family: Xeon  
        Manufacturer: Intel  
        ID: A5 06 01 00 FF FB EB BF  
        Signature: Type 0, Family 6, Model 26, Stepping 5  