剖析 反序列化
xmlDecoder
安全脉搏
- SecPulse.COM |
“ 这是 酒仙桥六号部队 的第 130 篇⽂
章。
这是 酒仙桥六号部队 的第 130 篇⽂章。
全⽂共计 1727 个字，预计阅读时⻓ 6 分钟。
⼀直想写个代码审计的⽂章，和⼤腿们交流下思路，正好
翻 xxe 的时候看到⼀个 jdk ⾃带的 xmlDecoder 反序列
化，很具有代表性，就来写⼀下，顺带翻⼀下源码。
为什么选这个呢，因为 ta 让 weblogic 栽了俩跟头，其
他都是⼿写了⼏个洞，被⼈发现了，weblogic 是调⽤的
东⻄存在⼀些问题，有苦没处说啊，下⾯剖析下
xmlDecoder 是怎么反序列化的。
前期准备
这次使⽤的是 idea 来调试代码，下⾯是⽤到⼀些快捷
键：
Idea 中⽤到的 debug 快捷键：
F7 进⼊到代码，
进⼊到代码，
Alt+shift+F7 强制进⼊代码
Atl+F9 执⾏跳到下⼀个断点处
F8 下⼀步
代码中有提到 invoke(class, method) ⽅法：
拿例⼦说话：
methodName.invoke(owner,args)
其中 owner 为某个对象，methodName 为需要执⾏的⽅
法名称，Object[] args 执⾏⽅法参数列表。
楼主使⽤的 jdk 版本：
1.8.0_151
敲⿊板开始了
先整⼀个完整的 xml ⽂件，注意箭头的地⽅，后⾯会是
个⼩坑。
使⽤ java 代码解析 xml ⽂件。
重点在 Object s2 = xd.readObject(); 这⾏代码，打断点
跟⼀下源码。
Debug 模式启动：
进⼊⽅法，是个三⽬运算：
进⼊⽅法：
注：从这⾥开始，可以进⾏打断点，第⼀次跟不对的时
候，下次再 debug 的时间 alt+f9 快速跳到断点处。
打个断点，进⼊⽅法：
SAXParserImpl 中有⼀些配置，其中的 xmlReader 是前
⾯已经设置过了，是接⼝对象 new 的实现类，我们看的
是实现类，这⾥有 idea 可以⾃动进⾏跳⼊对应的实现类
的⽅法。
⽗类：
注：Super：调⽤⽗类的写法，有 super 的类必定继承
（extend）了其他类。
进⼊⽗类：
跟进：
继续跟进，跳到 XML11Configuration 的 parse（）⽅
法：
⼀些配置：
F7 继续跟进：会进⼊本类的 parse ⽅法。
进⼊ XMLDocumentFragmentScannerImpl 后，会看到
有⽅法中进⾏了 do{}while{} ⽅法，其中的 next ⽅法是
重点。
跟进，跳到 XMLDocumentScannerImpl 的 next()：
进⼊ next() ⽅法：
在 do{}while{} ⾥循环多次。
注：下⾯的显示台有变量的值，可以看到代码中变量值的
变化。
继续跟进：
可以看到解析 xml ⽂件的时候有解析到 calc 字符，继续
跟进。
ProcessBuilder 这个类在 xml ⽂件中有申明，然后到了
invoke，成功执⾏命令。
这⼀块代码建议亲⾃跟⼀下，会跟到很底层的东⻄，楼主
在这⼀块卡了好⻓时间。
这次是借助了 idea 进⾏了代码的跟踪，待到能⼿点⽅法
跟踪代码的那天就是楼主神功⼤成之⽇！嘎嘎嘎~
记得好多开发⼤⽜说过，想进步，多看看 jdk 源码，看
懂 ta，打遍天下⽆敌⼿！（后⾯⼀句我吹的）
代码审计的时候不⼀定能搭的起环境来，基本功还是很重
要的，看 jdk 源码就是⼀个很好的练习的⽅法。
⽤ jdk ⾃带的洞来练习代码审计的好处就是，可以使⽤
idea 帮助寻找跳转⽅法，不会有跟不下去的时候，⻔槛
会降低很多；再有 cms 会有很多奇奇怪怪的写法，出现
了洞的话最后还是⼀些基本的写法，楼主建议还是从基础
的洞来⼊⼿，没有那么⾼的复杂度。
编辑利⽤程序
写⼀个⽅法，将 xml ⽂件拼接起来，还记得开头提到的
⼩坑么
注：楼主最喜欢这种洞了，就像⽹站本身就给开了个后⻔
⼀样。
Main ⽅法调⽤，试试 ping 命令。
将⽅法中的代码放在 jsp ⽂件中，就可以接收请求参数
了，楼主已经在⽤了，各位⼤佬可以定制下。
更近⼀步
数据不回显？
1. dnslog 外带，这⾥有个坑，能带的字符串⻓度有
限制，中间不能有特殊符号，可以在命令中对数
据进⾏加密切割，分段传输。
防御⽅法：对 doslog 进⾏域名加⿊，在攻击者
探测阶段就失败。
绕过：⾃建 dns。
2. 在服务器开启 nc 监听，在⽬标服务器访问 nc 服
务器的端⼝，进⾏ nc 通信，将信息外带出来。
防御⽅法：在服务器监听新开启的通信。
3. 复写⽗类⽅法，使执⾏有输出（有难度）。
参考以上⽅法和冰蝎的⽅法可以编写定制化⼀个
webshell ⼯具。
结尾
想想类似的洞？嘿嘿嘿~
本⽂作者： 酒仙桥六号部队
本⽂为安全脉搏专栏作者发布，转载请注明：
https://www.secpulse.com/archives/149715.html
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明