兵家必争之地
Nanika
PDF created with pdfFactory Pro trial version www.pdffactory.com
• 在防毒与恶意软体间的一往一来就是一场
激烈的战争
• 在一黑一白对抗之中各有输赢
PDF created with pdfFactory Pro trial version www.pdffactory.com
• 安全需要对于任何风险都略懂
• 知彼知己，百战不殆；不知彼而知己，一
胜一负；不知彼，不知己，每战必殆
• 知识就是力量
PDF created with pdfFactory Pro trial version www.pdffactory.com
你懂入侵
你懂OS
懂WEB
PT?
PDF created with pdfFactory Pro trial version www.pdffactory.com
守方优劣势
• 先常驻在系统,掌握各个
关键关口,并且对于任何
变动都可以了若指掌,拥
有庞大的资源,发现新攻
击方式会使用各种技巧封
阻
• 以稳定度为核心并且不能
作太细腻的检查影响效能,
不能使用不稳定的先进技
术,守势地图直接摊在外
面让人研究
PDF created with pdfFactory Pro trial version www.pdffactory.com
掌握关键关口
恶意软体
哇靠! 早就
跟你说过要
走别条路
PDF created with pdfFactory Pro trial version www.pdffactory.com
守势地图公开
前线包括
Ring0防护
交通要道进
行多少Hook
重要据点
有多少人
防护
通信兵如
何通信
最后防
线
战略地图
PDF created with pdfFactory Pro trial version www.pdffactory.com
攻方优劣势
• 各种技巧不需要以稳定
为核心,需依照守势地图
找新计谋突破,当守势很
完备的时候则需要使用
些奇淫技巧
• 没办法准确的了解攻击
目标的环境,常常一公开
新技巧马上会被封阻,没
办法一劳永逸
PDF created with pdfFactory Pro trial version www.pdffactory.com
必争之地
FileFilter(最后防线)
NotifyCallBack(通信)
IAT EAT Inline(重要据点)
SystemCall(交通要道)
Ring0(前线)
PDF created with pdfFactory Pro trial version www.pdffactory.com
Ring0(突破前线)
• 替换REG
• 替换档案
• \Device\PhysicalMemory
• ZwLoadDriver
• ZwSystemDebugControl
• ZwSetSystemInformation
• Kernel Bug
• …….
PDF created with pdfFactory Pro trial version www.pdffactory.com
在这里等了半天
什么恶意软体都
没出现,系统应该
很安全吧
PDF created with pdfFactory Pro trial version www.pdffactory.com
恶意软体
嘿嘿 走后门
我最在行
PDF created with pdfFactory Pro trial version www.pdffactory.com
兵不厌诈
这是战争
PDF created with pdfFactory Pro trial version www.pdffactory.com
突破前线后要怎样进攻
• 正面突破
• 各个击破
PDF created with pdfFactory Pro trial version www.pdffactory.com
正面突破(MmUnloadSystemImage)
PDF created with pdfFactory Pro trial version www.pdffactory.com
各个击破
• 分析守势地图后精
准突破
PDF created with pdfFactory Pro trial version www.pdffactory.com
SystemCall(交通要道)
• SSDT (实做一整个Function)(还原)
• Inline Hook(实做一整个Function)(还原)
• 拦截与还原的无穷回圈
PDF created with pdfFactory Pro trial version www.pdffactory.com
PDF created with pdfFactory Pro trial version www.pdffactory.com
Origin
HOOK 
Function
Origin
实做一个相同的
Function
Origin 
Code
Origin
OriginADDRESS
FuncADDRESS
Inline JMP 
HOOK
PDF created with pdfFactory Pro trial version www.pdffactory.com
IAT EAT Inline(重要据点)
• MmGetSystemRoutineAddress
• IofCallDriver
• ObReferenceObjectbyName
• KeUserModeCallBack
• ………………………………….
• 实做一整个Function or 还原
• 各家有各家的喜好又是拦截与还原的无穷
回圈
PDF created with pdfFactory Pro trial version www.pdffactory.com
NotifyCallBack(通信)
• PsSetCreateProcessNotifyRoutine
• PsSetCreateThreadNotifyRoutine
• PsSetLoadImageNotifyRoutine
• CmRegisterCallback
• 中断通讯为战争必备攻势
PDF created with pdfFactory Pro trial version www.pdffactory.com
报告长官,侦测到
新的Process,快
进行扫描
PDF created with pdfFactory Pro trial version www.pdffactory.com
截断通信
•
PsSetCreateProcessNotifyRoutine(PCREATE_PROCESS_NOTIFY_ROU
TINE NotifyRoutine, BOOLEAN Remove)
•
PAGE:004EEE96                 mov
edi, edi
•
PAGE:004EEE98                 push    ebp
•
PAGE:004EEE99                 mov
ebp, esp
•
PAGE:004EEE9B                 push    ebx
•
PAGE:004EEE9C                 xor
ebx, ebx
•
PAGE:004EEE9E                 cmp
[ebp+Remove], bl
•
PAGE:004EEEA1                 push    esi
•
PAGE:004EEEA2                 push    edi
•
PAGE:004EEEA3                 jz
short loc_4EEF0A
•
PAGE:004EEEA5                 mov
edi, offset byte_483360
•
找出所有Routine 之后移除列表
PDF created with pdfFactory Pro trial version www.pdffactory.com
FileFilter(最后防线)
• FltRegisterFilter
• FSD Routine
• IoAttachDevice
• 最后防线突破等于攻下城池
PDF created with pdfFactory Pro trial version www.pdffactory.com
•
dt nt!_driver_object 816565e0
•
+0x000 Type             : 4
•
+0x002 Size             : 168
•
+0x004 DeviceObject
: 0x8147b030 _DEVICE_OBJECT
•
+0x008 Flags            : 0x12
•
+0x00c DriverStart
: 0xf8262000 
•
+0x010 DriverSize
: 0x58480
•
+0x014 DriverSection
: 0x816cc230 
•
+0x018 DriverExtension : 0x81656688 _DRIVER_EXTENSION
•
+0x01c DriverName
: _UNICODE_STRING "\Driver\Tcpip"
•
+0x024 HardwareDatabase : 0x80671b60 _UNICODE_STRING 
"\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM"
•
+0x028 FastIoDispatch : (null) 
•
+0x02c DriverInit
: 0xf82b2d23     long  tcpip!GsDriverEntry+0
•
+0x030 DriverStartIo
: (null) 
•
+0x034 DriverUnload
: 0xf8290a58     void  tcpip!ArpUnload+0
•
+0x038 MajorFunction
: [28] 0xf82684f9     long  
tcpip!TCPDispatch+0
PDF created with pdfFactory Pro trial version www.pdffactory.com
透过档案比对恢复FSD MajorFunction
•
+0x038 MajorFunction
: [0] 0xf82684f9     long  tcpip!TCPDispatch+0
•
+0x038 MajorFunction
: [1] 0xxxxxxxxx     long  tcpip!TCPDispatch+0
•
+0x038 MajorFunction
: [2] 0xxxxxxxxx     long  tcpip!TCPDispatch+0
•
+0x038 MajorFunction
: [3] 0xxxxxxxxx     long  tcpip!TCPDispatch+0
•
+0x038 MajorFunction
: [4] 0xxxxxxxxx     long  tcpip!TCPDispatch+0
DriverObject->MajorFunction[IRP_MJ_CREATE]         = KDispatchCreateClose;
DriverObject->MajorFunction[IRP_MJ_CLOSE]          = KDispatchCreateClose;
DriverObject->MajorFunction[IRP_MJ_DEVICE_CONTROL] = KDispatchIoctl;
PDF created with pdfFactory Pro trial version www.pdffactory.com
•
dt nt!_driver_object 816565e0
•
+0x000 Type             : 4
•
+0x002 Size             : 168
•
+0x004 DeviceObject
: 0x8147b030 _DEVICE_OBJECT
•
+0x008 Flags            : 0x12
•
+0x00c DriverStart
: 0xf8262000 
•
+0x010 DriverSize
: 0x58480
•
+0x014 DriverSection
: 0x816cc230 
•
+0x018 DriverExtension : 0x81656688 _DRIVER_EXTENSION
•
+0x01c DriverName
: _UNICODE_STRING "\Driver\Tcpip"
•
+0x024 HardwareDatabase : 0x80671b60 _UNICODE_STRING 
"\REGISTRY\MACHINE\HARDWARE\DESCRIPTION\SYSTEM"
•
+0x028 FastIoDispatch : (null) 
•
+0x02c DriverInit
: 0xf82b2d23     long  tcpip!GsDriverEntry+0
•
+0x030 DriverStartIo
: (null) 
•
+0x034 DriverUnload
: 0xf8290a58     void  tcpip!ArpUnload+0
•
+0x038 MajorFunction
: [28] 0xf82684f9     long  
tcpip!TCPDispatch+0
PDF created with pdfFactory Pro trial version www.pdffactory.com
• kd> dt nt!_device_object
0x8147b030
•
+0x000 Type             : 3
•
+0x002 Size             : 0xb8
•
+0x004 ReferenceCount : 2
•
+0x008 DriverObject
: 
0x816565e0 _DRIVER_OBJECT
•
+0x00c NextDevice
: 
0x81477030 _DEVICE_OBJECT
•
+0x010 AttachedDevice : 
0x81477510 _DEVICE_OBJECT
• kd> dt nt!_device_object
0x 81477030
•
+0x000 Type             : 3
•
+0x002 Size             : 0xb8
•
+0x004 ReferenceCount : 2
•
+0x008 DriverObject
: 
0x816565e0 _DRIVER_OBJECT
•
+0x00c NextDevice
: 
0x814e4030 _DEVICE_OBJECT
•
+0x010 AttachedDevice : 
0x81477618 _DEVICE_OBJECT
Null
Null
PDF created with pdfFactory Pro trial version www.pdffactory.com
眼花撩乱
PDF created with pdfFactory Pro trial version www.pdffactory.com
真真假假假假真真
• 守方若需要守的完备需要花
费大量的资源投入在相关的
路线规划上
• 攻方则需要更大量测试任何
天马行空的幻想
• 技术是一体两面的,可以拿
来防护,当然也可以知道怎
样攻击
PDF created with pdfFactory Pro trial version www.pdffactory.com
略懂!
来看一下
Demo
PDF created with pdfFactory Pro trial version www.pdffactory.com
有批技术很高档,有需要就寄这个mail
PI:EMAIL
PDF created with pdfFactory Pro trial version www.pdffactory.com
谢谢
PDF created with pdfFactory Pro trial version www.pdffactory.com
Reference
• http://hi.baidu.com/sudami
• http://hi.baidu.com/mj0011
• http://www.debugman.com/
• http://forum.eviloctal.com/archiver/tid-
33451.html
• 特别感谢我引用图片的作者
PDF created with pdfFactory Pro trial version www.pdffactory.com