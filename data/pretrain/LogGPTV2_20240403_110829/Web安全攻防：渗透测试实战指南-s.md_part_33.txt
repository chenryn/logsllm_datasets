### 6.3 使用Empire进行PowerShell攻击

#### 6.3.1 查看上线的主机
在Empire中，类似于Metasploit的会话（sessions）功能，可以查看已经上线的主机。如图6-73所示。

**图6-73：查看上线的主机**

此时，代理名称会随机生成，可以使用`rename`命令来修改。例如，输入`rename L9FPTXV6USA`，如图6-74所示。

**图6-74：更改主机名称**

#### 6.3.2 设置和运行launcher_vbs木马
要设置并运行`launcher_vbs`木马，请首先输入`usestager windows/launcher_vbs`，然后使用`info`命令查看详细参数，如图6-75所示。

**图6-75：查看详细参数**

使用以下命令设置监听器参数并运行：
```bash
set Listener shuteer
execute
```
默认情况下，会在`tmp`文件夹下生成`launcher.vbs`，如图6-76所示。

**图6-76：生成VBS木马**

最后，输入`back`命令回到监听器下开始监听。将生成的`launcher.vbs`在目标机上打开，即可获得该主机的权限。这里使用的虚拟机是Windows 10 64位旗舰版，安装有系统自带的Defender。运行后，`launcher_vbs`木马成功上线，Defender没有出现任何提示，如图6-77所示。

**图6-77：反弹成功**

如果需要生成PowerShell代码，在设置完监听器后直接输入`back`，然后输入`launcher powershell shuteer`即可，如图6-78所示。

**图6-78：执行PowerShell代码**

#### 6.3.3 设置和运行launcher_bat木马
要设置并运行`launcher_bat`木马，请首先输入`usestager windows/launcher_bat`，然后使用`info`命令查看详细参数，如图6-79所示。

**图6-79：查看详细参数**

使用以下命令设置监听器参数并运行：
```bash
set Listener shuteer
execute
```
默认情况下，会在`tmp`文件夹下生成`launcher.bat`，如图6-80所示。

**图6-80：生成BAT木马**

输入`back`命令回到监听器下开始监听。将生成的`launcher.bat`在目标机上打开，即可获得该主机的权限。可以看到，在虚拟机运行后，`BAT`木马已经成功上线，如图6-81所示。

**图6-81：反弹成功**

为了增加迷惑性，也可以将批处理文件插入一个Office文件中。单击“浏览”按钮，选择生成的批处理文件，勾选“显示为图标”，然后单击“更改图标”按钮来更改一个更具诱惑性的图标，如图6-82所示。

**图6-82：插入新对象**

在“更改图标”界面里，可以选择一个图标。建议使用微软的Excel、Word或PowerPoint图标。这里使用了Word图标，并更改文件名为“研究成果”，扩展名为`.doc`。单击“确定”按钮后，该对象就会插入Word文件中，如图6-83所示。

**图6-83：插入Word文件**

接着在监听器下监听，然后将该Word文件发给目标。一旦该Word文件在目标机上被打开并运行内嵌的批处理文件，即可获得该主机的权限。这里使用的虚拟机是Windows 10 64位旗舰版，安装有系统自带的Defender。Word文件运行后，`BAT`木马成功上线，Defender没有任何提示，但360安全卫士会报告发现宏病毒，如图6-84所示。

**图6-84：反弹成功**

#### 6.3.4 设置和运行Macro木马
要设置并运行`Macro`木马，请首先输入`usestager windows/macro`，然后使用`info`命令查看详细参数，如图6-85所示。

**图6-85：查看详细参数**

使用以下命令设置监听器参数并运行：
```bash
set Listener shuteer
execute
```
默认情况下，会生成一个宏并存储在`/tmp/macro`文件中，如图6-86所示。

**图6-86：生成Macro木马**

然后需要将生成的宏添加到一个Office文档里面。打开一个Word文件，单击“创建”按钮，如图6-88所示。

**图6-88：创建宏**

单击“创建”按钮后会弹出VB编辑界面，删除原来的代码并将生成的宏复制进去，另存为“Word97-2003文档（*.doc）”文件，如图6-89和图6-90所示。

**图6-89：复制宏代码**

**图6-90：另存为文档**

最后将这个修改过的Word文件拷贝到目标机上执行。打开后会提示一个安全警告，这里需要使用一些社会工程学策略诱导目标单击“启用内容”按钮，如图6-91所示。

**图6-91：Word的安全警告**

单击“启用内容”按钮后，可以在监听界面看到目标机已经顺利上线。在实际情况下，360安全卫士会报告发现宏病毒，如图6-92所示。

**图6-92：反弹成功**

#### 6.3.5 Ducky模块
Empire也支持Ducky模块，即我们常说的“小黄鸭”。输入`usestager windows/ducky`，然后使用`info`命令查看详细参数，如图6-94所示。

**图6-94：查看详细参数**

只需设置监听器参数即可生成用于烧制的代码，如图6-95所示。

**图6-95：生成代码**

将该代码烧录至“小黄鸭”中，插入目标用户的计算机，即可反弹回来。具体操作流程可参考这篇文章—《利用USBRUBBERDUCKY（USB橡皮鸭）在目标机器上启动Empire或Meterpreter会话》（http://www.freebuf.com/geek/141839.html）。

#### 6.3.6 连接主机及基本使用
目标主机反弹成功后，可以使用`agents`命令列出当前已连接的主机。带有（*）的是已提权成功的主机，如图6-96所示。

**图6-96：列出已连接的主机**

然后使用`interact`命令连接主机，可以使用Tab键补全主机名称。连接成功后输入`help`命令即可列出所有可用命令，如图6-97所示。

**图6-97：查看帮助**

可以看到主机的功能相当强大，基本可以与Metasploit媲美。更为强大的是兼容Windows、Linux和Metasploit的部分常用命令，使用起来非常方便，如图6-98所示。

**图6-98：使用Linux命令**

输入`helpagentcmds`可以查看可供使用的常用命令，如图6-99所示。

**图6-99：查看常用命令**

```bash
[*]Available opsec-safe agent commands:
ls, dir, mkdir, cd, mv, cp, rm, cat, type, ps, tasklist, getpid, getuid, whoami, hostname, reboot, restart, shutdown
```

通过以上步骤，您可以有效地使用Empire进行PowerShell攻击，并实现对目标主机的控制。