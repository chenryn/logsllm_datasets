Influxdb...........................................................................................................................336
9.7. 告警功能.........................................................................................................................336
告警规则修改功能.........................................................................................................337
告警插件管理功能.........................................................................................................337
日志监控告警功能.........................................................................................................338
URL监控告警功能.........................................................................................................339
5
日志学院
告警屏蔽功能.................................................................................................................340
9.8.MySQL工具.....................................................................................................................340
Mysql工具功能..............................................................................................................340
Mysql备份工具功能......................................................................................................341
9.9.Kafka工具功能................................................................................................................341
9.10. 故障排查.......................................................................................................................342
使用Manager定位系统故障.......................................................................................342
Manager自身故障定位................................................................................................345
9.11. 模块配置优化...............................................................................................................346
6
日志学院
1.日志采集
3.0版本产品部署我们在初级部分已经有所提及，其他版本产品部署按照《日志易安装手册》
的步骤执行即可。产品部署期间的注意点请参考初级培训材料产品部署章节。
产品部署完毕，且安装完Agent，就可以进行日志采集了。但在正式的生产环境中，日志采
集之前，还有一些问题我们需要考虑清楚：
1、客户对权限的要求是什么样的？是否不同部门之间权限隔离？
2、客户要接入的日志有什么特点？是否每条日志都有时间戳？如果客户没有明确要求，根
据客户日志的特点，我们应在日志采集时进行哪些处理？当接入的Agent数据较多时，
能否快捷的进行Agent的管理与升级？
3、除目录及文件外，客户是否还有安全设备、数据库等其他数据源需要接入？
4、日志数据是否需要备份？需要对那些系统的日志进行备份？能否有个比较快捷的备份
方式？
5、当接入的日志数据量较大时，对于那些需要特别关注的日志，是否能设置优先入库级
别？
6、是否还有更灵活的日志权限管理方式，不仅能适用于日志搜索权限的控制，还适用于仪
表盘、趋势图等权限管理？
3.0及其之前版本的日志易中，一般使用日志来源来标识不同业务系统的日志。在3.1及之
后版本中，“搜索权限”取代了日志来源的概念。
以3.2版本为例，对应以上五条问题，我们应该考虑的要点分别是：
1、划分日志搜索权限：一般与权限管理配合使用，使用户/用户组间的日志权限独立开来；
2、Agent接入的方法与技巧：多行合并、数据压缩、复杂目录处理、资源控制等。此外，
日志易还提供了分发的功能，以实现同类主机相同日志采集的快速配置；
3、其他数据源的接入：Syslog、数据库、其他数据等。
4、数据备份是如何备份？对某些系统进行备份还是全部备份？备份后的数据恢复方便
吗？
5、如何区分不同入库优先级别的日志？
6、如何通过数据集来实现数据集合的定义，细化查询颗粒度？
本章内容也将围绕上述五点进行讲述。
权限管理我们已经在初级材料第五章节详细讲解。项目实施中，统计客户要接入的日志系统，
划分数据集，将客户的权限要求与搜索权限相对应，再根据用户分组、角色、用户、搜索权
限的流程创建用户即可。
最后，面对资源紧张的用户，日志易还提供了入库优先级的配置，根据appname、tag可设
定不同的优先级来满足客户的需求。
1.1. 划分日志搜索权限
在企业环境进行实施时，需要针对接入的系统划分权限，这样就要求对不同系统的日志权限
进行分离，如A系统的管理员不能看到B系统接入的日志。
1-7
日志学院
3.0及其之前版本中，日志易可以通过划分日志来源实现不同用户数据查询分离。同时，用
户还可通过选择日志来源缩小检索范围。日志易是根据appname、tag、hostname来确定日
志来源的，可以三者都指定，也可以根据指定其中一种或两种。根据日志来源的三个属性，
可以限定用户查询日志的范围。
3.1及其之后版本中，日志易通过搜索权限来实现数据搜索权限的管理。与日志来源类似，
搜索权限可根据appname、tag、hostname来确定日志搜索范围。
搜索权限是一种特殊的资源，只有__admin__角色的域管理员权限可以新建/编辑/删除，普通
用户只能读取/授权。
普通用户必须要域管理员授权搜索权限，才能正常使用日志易搜索功能。如果用户的搜索权
限列表页为空，则该用户的所有搜索都没有结果。
数据上传以后，日志易可以为您提供搜索权限功能。搜索权限定义日志数据范围范围非常灵
活，可利用主机名（hostname）、应用程序（appname）、标签（tag）、过滤条件(queryFilter)
四项内容的任意组合，定义搜索范围和授权不同用户的日志访问范围。被限定范围的用户只
能在限定范围内查询。
日志易的用户可以使用搜索权限来区分研发，测试和生产等不同类型的日志的搜索范围。例
如您是运维人员，只关心在线生产环境的运维日志，但不关心研发和测试环境的日志。其他
用户如游戏公司，可以创建不同的搜索权限，区分不同的应用程序日志的搜索范围。
点击"权限-搜索权限"打开搜索权限列表页，可以在列表页查看当前用户的搜索权限。多行
搜索权限取并集。
当用户没有被赋予搜索权限或被授予的搜索权限过期后，搜索日志会出错。
1-8
日志学院
查看错误码，会看到相关提示信息。
新建搜索权限
搜索权限中主机名、应用名、标签三项内容包含在日志事件头部，通过日志易agent、rsyslog
或HTTP消息头部上传。日志易根据搜索权限配置中的appname/tag信息，在本地上传，字
段提取，备份策略，索引配置，入库优先级，agent管理页面对应的输入框给出填写提示。
假如appname填写通配符星，则提示通配符星。过滤条件则支持任意查询类的日志易检索
语法：
1-9
日志学院
搜索权限的授权
搜索权限的授权和普通资源一样，可以在列表页的操作中点击"授权"，也可以在角色授权页
面，勾选"读取"或"授权"。
当发生搜索权限变动操作，比如授予和取消，通过消息通知系统，给被操作角色的对应用户
发送提醒。内容为：
“您已被授权可访问xxx数据，有效期至yyyy，该授权不/可转授第三方”
提醒内容可点击，点击自动打开新窗口，定位到该搜索权限下的*搜索。
1-10
日志学院
搜索权限临时授权 tmp-share
日志易提供搜索权限临时分享功能，用户可以指定搜索权限可读权限分享给指定用户。见如
下界面：
点击’临时授权'，选择搜索权限名称，点击’授权'，填写临时授权信息。
选择’提权用户'，设置有效时长，则提权用户在有效时间内可以读取指定搜索权限的日志，
还可以设置是否可以查看敏感内容和下载搜索结果，二次授权：可禁止被临时授权的用户转
授这些搜索权限给第三方查看。
设置临时授权成功后，我们可以点击’临时授权管理'，进入临时授权管理页面，我们可以通
过授权管理页面来回收或延期这个分享。
1.2. 日志采集的方法与技巧
初级我们已经掌握了Agent安装、日志文件采集、日志目录采集等基础日志采集方式。但在
复杂的实施环境中，在日志采集时我们可能会遇到以下问题：
 客户业务日志及事务日志并不是每条日志都有时间戳；
 由于客户网络带宽有限，需要在日志采集过程中开启数据压缩；
 客户对日志易Agent占用的资源大小存有疑问；
1-11
日志学院
 客户环境中需要采集日志的主机较多，同一业务系统下的主机采集的日志相同，但需采
集的业务系统较多，如不批量采集则工作量巨大；
 实际采集过程中，遇到采集目录过深、日志打印过快、日志文件较小且数量多、日志文
件过大等现象，常规采集遇到问题；
 ……
在面临以上问题时，仅掌握基础的日志采集方式还不够。实施工程师了解一些方法和技巧，
有助于日志采集工作的展开。日志采集过程中的方法和技巧包括：
 多行合并：日志接入时，将同一事务的多行日志，按同一换行规则换行的多行日志（如
堆栈日志）合并为一条；
 数据压缩：日志采集过程中启用数据压缩；
 数据加密：日志采集过程中启用数据加密传输；
 Agent资源控制：对Agent所占用的资源进行查看或修改；
 复杂目录处理：复杂目录采集时的采集技巧，涉及技巧有软链接、排序分流、句柄配置
等；
 Agent配置分发：Agent采集配置如何批量分发；
 Agent分组采集：如果通过分组对Agent进行统一管理；
 Agent管理：Agent启停、升级、配置分发等管理。
具体说明如下。
多行合并
日志易支持的多行合并有两种：
1、日志接入时，根据换行符或时间戳进行合并；
2、根据事务流程进行事务合并；
日志接入时合并
在日志预览界面进行换行规则的设置，实际上就是自定义换行标识。
日志易可在日志接入时对日志进行预览，预览页面将展示文件从起始位置开始1MB大小的
内容，并使用这部分内容，自动推测其字符编码，事件换行规则和时间戳信息。
换行规则的自动推测，基于日志通常会优先输出时间戳这个业界通行的做法。日志易内置识
别多种格式的时间戳，并统计不同格式出现的频次。在出现多个时间戳格式时，采用频次最
高的那个作为换行基准。
基于相同的时间戳格式列表，日志易还可以猜测数据中的时间戳信息，并进行独立提取。对
于没有其他分析需求的数据，经过采集阶段的时间戳提取后，就不用再进行字段提取配置了。
自动识别基于局部数据，存在错误可能，或想进行个性化的自定义，可以手动调整。
自定义换行标识的步骤如下：
1-12
日志学院
1、点开换行设置，选择正则表达式，配置个性化的分行正则规则。 比如我们以\n(\d)作为
分行规则，即行首为数字的作为一行处理，点击预览，右边页面会显示分行效果。注意还需
要保留的内容需要用括号包裹。
日志原文：
接入时多行合并：
 自动识别
\n([\p{P}\p{S}]*(?:20\d\d|19\d\d)-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12]\d|3[01])
(?:2[0123]|[01]?[0-9]):(?:[0-5][0-9]):(?:[0-5]\d),\d\d\d)
 手动识别
\n(\d{4}-\d{2}-\d{2}\d{2}:\d{2}:\d{2}.\d{3})
1-13
日志学院
2、当时间戳是标准格式时，在日志采集时还需要进行时间戳格式的识别；
3、在预览左侧设置里，还提供了内容黑白名单设置，可以在这里输入正则表达式，完成多
行合并逻辑以后，如果某行日志的内容匹配上了黑名单，这行日志会在采集端直接抛弃，不
进行后续处理。白名单反之。输入表达式以后，可以点击预览查看过滤效果。
1-14
日志学院
事务合并
我们通常称每条日志为一个事件，在大多数情况下一个事件会被记录为一条日志，而这一个
事件通常在打印完程序运行的情况后完成它所做的使命。
但是在某些情况下（如业务分析场景），我们需要的是一个业务上的事件，这里我们称之为
“事务”，一个事务并不一定是单条日志，整个业务流程——包括业务开始、业务处理、业务
结束——为一个事务。示例如下：
[10:25:30.089][0010100657362]--[D][开始交易 NNBS888888:支付业务清算（bccp通讯）]
[10:25:30.089][0010100657362]--[D][调用内建函数 BAPC_Builtin_CheckRequest]
[10:25:30.097][0010100657362]--[D][节点功能 登记清算流水表]
[10:25:30.097][0010100657362]--[D][入参0={'trantyp':'0','crtrclracctno': ’
1234560000000011','ermkamt':'0','biztyp':'2','retcd':'NNBSI0000','currency':'01','refbizflowno':
'','clrsts':'0','netgrnd':'2','dbtrclrbkid':'123456020008','msgid':'NPSB051311072','dbtrclracctno':
'1234561100000011','retinfo':'交易成功!','clrctrlflg':'200','refbizdt':'','refnetgrnd':'','systm':
'20180731102530','bizdt':'20180731','bizflowno':'B012345628','trancd':
'NNBS304002','amount':'1340.00','crtrclrbkid':'123456009991'}]
[10:25:30.105][0010100657362]--[D][节点功能 开始]
[10:25:30.105][0010100657362]--[D][节点功能 错误委托]
[10:25:30.105][0010100657362]--[D][将默认异常委托到 TNNBS304002_STEP5_NODE5 节
点]
[10:25:30.107][0010100657362]--[D][节点功能 正常结束]
[10:25:30.107][0010100657362]--[D][调用内建函数 BAPC_Builtin_CheckResponse]
[10:25:30.107][0010100657362]--[D][结束交易 NNBS888888]
因为目前的程序都是并发处理，所以在同一时间会产生很多条事件，而产生的事件未必是同
一个事务产生。所以我们需要将一个事务中的产生的多个事件进行合并处理，形成一个事务
日志后再进行发送。
这么做的好处有很多：
 在Agent发送端进行事务合并，就可以在数据分析时省去很多不必要的日志处理过程；
 一个业务的所有事件归并成一个事务，更方便计算事务内的各个指标数据；
 能够更加直观看出一个业务的完成过程，对业务运维人员更加的友好。
但是也有一些问题存在：
 单条日志过大，后端处理系统压力较大；
 Agent发送日志时，需要等待一个事务发送完才能发送下一条日志，所以Agent发送效
率会降低，Agent对系统资源的消耗也会增加。
 因为需要从繁杂的事件中合并出同一个事务的所有事件，所以需要有一个可串联的标识，
此标识在一个事务中从始至终都存在，并且不会与其他事务中的标识重复。这对日志规
范性有一定要求。
最后一条往往不能实现。因为一个业务系统的不同模块由不同的小组成员开发，如果开发时
没有统一日志的输出规范，业务系统运行期间，日志的输出就会比较杂乱。这种情况会对后
面的分析造成很大的影响，而且后期进行日志改造也会有很大困难。因为业务系统的运行会
1-15
日志学院
经过一个很长的时间，当业务系统庞杂到一定程度，不得不进行日志改造时，原始的模块开
发维护人员可能早已离职，或因年代久远忘记了日志生成的逻辑。
在开发时做好日志输出规范，对于日志分析而言极为重要！
当用户日志为多线程交叉打印，且以某关键字开头，某关键字结尾，希望能将各个线程的这
种日志，按开头结尾合并，可在日志易Agent配置文件中进行配置：
###Other
[3_file_splitter]
type="RegexSplitter"
delimiter='\n(\d)'
delimiter_eol=false