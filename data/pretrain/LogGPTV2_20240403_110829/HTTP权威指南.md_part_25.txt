6-8），或者如果用户申请了过滤服务，还可以通过过滤代理来转发HTTP请求。
可以用自适应内容路由代理来构建很多有趣的服务。
• 转码器
代理服务器在将内容发送给客户端之前，可以修改内容的主体格式。在这些数据
代 理 ｜ 141
表示法之间进行的透明转换被称为转码（transcoding）。3
转码代理可以在传输GIF图片时，将其转换成JPEG图片，以减小尺寸。也可以
对图片进行压缩，或降低颜色的色彩饱和度以便在电视上观看。同样，可以对文
本文件进行压缩，并为能够使用因特网的呼机和智能手机生成小型的文本摘要
Web页面。代理甚至可以在传输文档的过程中将其转换成外语。
服务器A付费将内容分布到复制缓存上去，但服
务器B没有。
内容路由器将Luis导向复制缓存以获取A的页面，
但B的页面仍从原始服务器上获取。
内容路由器
R1
Luis
Sharon
内容
服务器B
路由器
Web代理缓存
R2
Rob
Sharon为性能付了费，因此内容
路由器会将其发送到附近的缓
服务器A
存上去。Rob没有付费，内容路
由器会将其送到原始服务器。
图6-8 代理应用程序实例：内容路由器
图6-9显示了一个转码代理，这个代理可以将英语文本转换成西班牙语文本，将
135 HTML页面重新格式化为较简单的文本，以便显示在手机的小屏幕上。
• 匿名者
匿名者代理会主动从HTTP报文中删除身份特性（比如客户端IP地址、From
首部、Referer首部、cookie、URI的会话ID），从而提供高度的私密性和匿
名性。4
注3： 有些人会对“转码”和“翻译”进行区分，将转码定义为对数据编码进行的相对简单的转换（比如无
损压缩），将翻译定义为更重要的、对数据的重新格式化或语义转换。我们用术语转码来表示所有在
中间实体上对内容进行的修改。
注4： 但是，由于删除了识别信息，用户浏览体验的质量可能会有所下降，有些Web站点可能会无法正常工作。
142 ｜ 第6章
Playeras de Verano
Obtendra muchas sonrisas
y guiñios cuando use nuestras
playeras de verano.
Summer Beach Shirts
Blanco You’ll get lots of smiles
使用西班牙 Negro and winks when you wear
语的客户端 Naranja amanecer our summer beach shirts.
White
Summer Beach Shirts Black
You ’ll get lots of smiles Sunrise orange
and winks when you wear 原始服务器
our. summer beach shirts.
转码代理
1) White
2) Black
能上网 3) Sunrise orange
的手机
图6-9 代理应用程序实例：内容转码器
在图6-10中，匿名代理会对用户报文进行下列修改以增加私密性。
 从User-Agent首部删除用户的计算机与OS类型。
 删除From首部以保护用户的E-mail地址。
 删除Referer首部来掩盖用户访问过的其他站点。
 删除Cookie首部以剔除概要信息和身份的数据。
GET /something/file.html HTTP/1.0 匿名报文中并不包含
Date: Sun, 01 Oct 2000 23:25:17 GMT
User-agent: Mozilla/4.75 (Win98; U) 常见的身份信息首部
From: PI:EMAIL
Referer: http://www.irs.gov/tax-audits.html GET /something/file.html HTTP/1.0
Cookie: profile="football,lite beer" Date: Sun, 01 Oct 2000 23:25:17 GMT
Cookie: income-bracket="30K-45K" User-agent: Mozilla/4.75
匿名代理
客户端 服务器
图6-10 代理应用程序实例：匿名者 136
6.3 代理会去往何处
前一小节解释了代理会做些什么。现在我们来看看在一个网络结构中部署代理的时
候，它会位于何处。本节会涵盖以下内容：
• 怎样将代理部署到网络中去；
代 理 ｜ 143
• 怎样将代理以层级方式连接在一起；
• 怎样先将网络流量直接导入代理服务器中。
6.3.1 代理服务器的部署
可以根据其目标用途，将代理放在任意位置。图6-11给出了部署代理服务器的几种
方式。
• 出口代理
可以将代理固定在本地网络的出口点，以便控制本地网络与大型因特网之间的流
量。可以在公司网络中使用出口代理（参见图6-11a），提供针对公司外部恶意黑
客的防火墙保护，或降低带宽费用，提高因特网流量的性能。小学可能会使用过
滤出口代理来防止早熟的学生浏览不恰当的内容。
• 访问（入口）代理
代理常被放在ISP访问点上，用以处理来自客户的聚合请求。ISP使用缓存代理
来存储常用文档的副本，以提高用户（尤其是高速连接用户）的下载速度，降低
因特网带宽耗费（参见图6-11b）。
• 反向代理
代理通常会被部署在网络边缘，在Web服务器之前，作为替代物（也常被称为
反向代理，参见图6-11c）使用，在那里它们可以处理所有传送给Web服务器
的请求，并只在必要时向Web服务器请求资源。替代物可以提高Web服务器的
安全特性，或者将快速的Web服务器缓存放在较慢的服务器之前，以提高性能。
反向代理通常会直接冒用Web服务器的名字和IP地址，这样所有的请求就会被
发送给代理而不是服务器了。
• 网络交换代理
可以将具有足够处理能力的代理放在网络之间的因特网对等交换点上，通过缓存
137 来减轻因特网节点的拥塞，并对流量进行监视，参见图6-11d。5
6.3.2 代理的层次结构
可以通过代理层次结构（proxy hierarchy）将代理级联起来。如图6-12所示，在代
理的层次结构中，会将报文从一个代理传给另一个代理，直到最终抵达原始服务器
为止（然后通过代理传回给客户端）。
注5： 核心代理通常被部署在因特网带宽很昂贵的地方（尤其是在欧洲）。有些国家（比如英国）还会出于
对国家安全的考虑，对有争议的代理部署进行评估，以监测因特网流量。
144 ｜ 第6章
（a）私有LAN的出口代理
客户端 本地
因特网
网络
代理
服务器
客户端
（b）ISP的访问代理
客户端
因特网
代理
服务器
客户端
（c）替代物
客户端 本地
因特网
网络
代理
服务器
客户端
（d）网络交换代理
网络1 网络2
路由器 路由器
客户端 代理 服务器
图6-11 可以根据其目标用途，以多种方式来部署代理
代理1 代理2 代理3
客户端
(代理2的 （代理3的下级代理，（代理2的 原始服务器
下级代理） 代理1的上级代理） 上级代理）
图6-12 三级的代理层次结构
代 理 ｜ 145
Proxy层次结构中的代理服务器被赋予了父（parent）和子（child）的关系。下一个
138 入口（inbound）代理（靠近服务器）被称为父代理，下一个出口（outbound）代理
（靠近客户端）被称为子代理。在图6-12中，代理1是代理2的子代理。同样，代
理2是代理3的子代理，代理3是代理2的父代理。
代理层次结构的内容路由
图6-12中的代理层次结构是静态的——代理1总是会将报文转发给代理2，代理2
总是会将报文转发给代理3。但是，层次不一定非得是静态的。代理服务器可以根
据众多因素，将报文转发给一个不断变化的代理服务器和原始服务器集。
比如，在图6-13中，访问代理会根据不同的情况将报文转发给父代理或原始服
务器。
• 如果所请求的对象属于一个付费使用内容分发服务的Web服务器，代理就会将
请求发送给附近的一个缓存服务器，这个服务器会返回已缓存对象，或者如果它
那儿没有的话，它会去取回内容。
• 如果请求的是特定类型的图片，访问代理会将请求转发给一个特定的压缩代理，
这个代理会去获取图片，然后对其进行压缩，这样通过到客户端的慢速Modem
下载时，速度会更快一些。
用于特定对象的
特定缓存服务器
代理缓存
客户端 访问代理
因特网
压缩器代理
全球范围内的Web服务器
139 图6-13 代理层次结构可以是动态的，随请求而变的
这里还有几个动态选择父代理的例子。
146 ｜ 第6章
• 负载均衡
子代理可能会根据当前父代理上的工作负载级别来决定如何选择一个父代理，以
均衡负载。
• 地理位置附近的路由
子代理可能会选择负责原始服务器所在物理区域的父代理。
• 协议/类型路由
子代理可能会根据URI将报文转发到不同的父代理和原始服务器上去。某些特
定类型的URI可能要通过一些特殊的代理服务器转发请求，以便进行特殊的协
议处理。
• 基于订购的路由
如果发布者为高性能服务额外付费了，它们的URI就会被转发到大型缓存或压
缩引擎上去，以提高性能。
在不同的产品中，动态父路由逻辑的实现方式各有不同，包括使用配置文件、脚
本语言和动态可执行插件等。
6.3.3 代理是如何获取流量的
客户端通常会直接与Web服务器进行通信，所以我们要解释清楚HTTP流量怎样才
能首先流向代理。有四种常见方式可以使客户端流量流向代理。
• 修改客户端
很多Web客户端，包括网景和微软的浏览器，都支持手工和自动的代理配置。
如果将客户端配置为使用代理服务器，客户端就会将HTTP请求有意地直接发送
给代理，而不是原始服务器（参见图6-14a）。
• 修改网络
网络基础设施可以通过若干种技术手段，在客户端不知道，或没有参与的情况
下，拦截网络流量并将其导入代理。这种拦截通常都依赖于监视HTTP流量的交
换设备及路由设备，在客户端毫不知情的情况下，对其进行拦截，并将流量导入
一个代理（参见图6-14b）。这种代理被称为拦截（intercepting）代理。6
注6： 拦截代理通常被称为“透明代理”，因为你会在不知情的情况下连接到这些代理上去。但HTTP规范
中已用“透明”来表示那些不会对语义进行修改的功能了，所以标准制定机构建议在流量捕获中使用
术语“拦截”。这里采纳了这一术语。
代 理 ｜ 147
• 修改DNS的命名空间
140 放在Web服务器之前的代理服务器——替代物，会直接假扮Web服务器的名
字和IP地址，这样，所有的请求就会发送给这些替代物，而不是服务器了（参
见图6-14c）。要实现这一点，可以手工编辑DNS名称列表，或者用特殊的动态
DNS服务器根据需要来确定适当的代理或服务器。有时在安装过程中，真实服
务器的IP地址和名称被修改了，替代物得到的会是之前的地址和名称。