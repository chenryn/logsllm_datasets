## Page 2301
不向终端用户收费，因此在网络上遍地开花。但是，广告的安全问
题也是普遍存在的，从推销流氓反间谍软件的恶意链接横幅广告到
点击欺诈软件、间谍软件和恶意广告软件，在线广告所存在的安全
问题是令人震惊的。
在过去的5年里，我发现过数百起在线广告诈骗事件，受害的用户多
达数千人，更不用说网络上那些深受其害的顶级商家了。本章对我
所发现的一些问题进行总结，并说明了用户和广告客户应该如何保
护自己。
6.1对用户的攻击
用户是在线广告攻击的最早受害者，一般也是最直接的受害者。从
欺骗性的弹出式广告到训练有素的浏览器漏洞攻击，用户所付出的
直接成本就是不得不使用清理工具。本节将观察一些对用户进行攻
击的罪魁祸首。
6.1.1充满漏洞的横幅广告
2004年3月，包装式间谍软件推广人SanfordWallace发现了一种在未
经许可的情况下在用户的计算机上安装软件的方法。Wallace利用安
全漏洞（Windows、InternetExplorer或用户计算机上的其他软件中的
缺陷），在未经用户许可的情况下控制用户计算机。早先的入侵者
必须诱使用户点击一个可执行文件或打开一个感染病毒的文档，这
些使俩是用户已经学会避开的。但是，Wallace的新方法可以在用户
仅仅浏览了一个网站（这是我们每天无数次所做的事情）的情况下
就完全接管用户计算机的控制权。
Wallace向一位合作者发送了一封电子邮件，汇报了这个成果：[1]
发件人：SanfordWallace,PI:EMAIL
收件人：PI:EMAIL
主题：我成功了
日期：2004年3月6日
2300
---
## Page 2302
我想出了一种方法，在不需要任何用户交互的情况下安装一个exe文
件。现在是我们随心所欲赚钱的时候了。
当Wallace利用这种漏洞攻击获得对用户计算机的控制之后，就可以
安装他所希望的任何软件。许多厂商花钱请Wallace在用户的计算机
上安装它们的软件。因此，Wallace在用户的PC上填满了用于跟踪用
户行为、显示弹出式广告的程序，使用户的浏览器由于挤满多余的
工具栏而混乱不堪。
但wallace仍然面临一个问题：为了利用安全漏洞接管用户的计算
机，Wallace首先需要让用户访问他的漏洞加载程序。怎么办？Jared
Lansky作出回答：他从横幅广告网络购买了广告。用户只要在一个
普通的网站上查看了一个广告，就有可能感染Wallace的不受欢迎软
件。
但是购买广告仍然存在很大的困难。很少有网站直接向广告客户出
售广告。反之，大多数网站通过广告网络公司来出售它们的广告空
间。一旦某个广告网络公司意识到发生了这种情况时，它可能会暴
跳如雷。总之，漏洞可能会摧毁一家广告网络公司在它的合作网站
中的声誉。
Wallace和Lansky提出了一个由两部分组成的计划来避免检测。首
程序：
发件人：SanfordWallace,PI:EMAIL
收件人：PI:EMAIL
主题：策略
我偷偷摸摸地实施自己的计划.....从今天到周日一在每个人不注
意的时候
其次，如果广告网络公司注意到了这种情况，Lansky就会声称对此
一无所知。例如，Lansky是这样回复BobRegular（广告网络公司
Cydoor的副总）的抱怨的：
发件人：PI:EMAIL
收件人：BobRegular,PI:EMAIL
2301
---
## Page 2303
主题：回复：请终止OptinTradeOnlinePharmacy违反协议
嗨！Bob，药品推广是一个使用了新的代码集的广告程序。在测试的
时候，它并不会产生弹出窗口也不会修改主页，因此我批准它在您
那儿运行。我也不清楚为什么会发生这种情况...
通过这种策略，Wallace和Lansky感染了数以千计的计算机，实际数
量可能远远不止（诉讼档案并没有显示细节）。但是联邦贸易委员
会（FTC）最终弄清了事实，立案并要求赔偿非法所得超过4百万美
元②。遗憾的是，Wallace和Lansky的策略只是冰山的一角。
2004年后期，英国IT新闻网站TheRegister[3]受到一个在用户计算机
上安装恶意软件的漏洞的攻击。这种恶意软件显示弹出窗口、跟踪
用户的详细行为、甚至把用户的计算机变成转发垃圾邮件的“肉
鸡”。我恰好对这个漏洞进行了测试，发现它至少安装在十几个不同
的程序中，涉及数百个文件和数千个注册项④。在2005和2006年所
出现的其他类似的漏洞攻击也使用了类似的策略，以降低越来越大
的负载回。
访问一个熟悉和受信任的网站可能导致用户的计算机变成肉鸡，用
厂。
利用漏洞所进行的软件安装并没有很好的防范手段：FTC多次禁止
未经审查的安装，消费者的集体诉讼证实了未经审查的安装是
“对私人财产的侵犯”，是对消费者使用自己的私有物品（在这里是
计算机）的干涉[口。因此，基于漏洞的安装怎么才能逍遥法外呢？
一种方法是继续采用Wwallace的只在周末钻空子的方法：我已经发现
漏洞攻击只在工作时间之外发生，或者只攻击特定区域的用户（一
般是远离广告网络公司可能进行调查和采取措施的地方）。
更常见的情况是，许多基于漏洞的安装程序使用了中间媒介试图逃
避责任。在Wallance与Lansky的伙伴关系的基础上，通过各种中间媒
介所构成的关系链常常包括很多公司、伙伴和附属机构。它们所采
取的手法很可能是由一位同谋者负责购买横幅广告，一位负责运行
漏洞攻击，另一位负责开发软件，还有一位则设法通过这个软件赚
钱。一旦暴露，它们便互相推。例如，购买横幅广告的公司声称
它并没有运行漏洞攻击，而开发软件的公司会出示一份合同，合同
上注明了软件的发行商承诺将会征得用户的许可。将焦点分散之
2302
---
## Page 2304
后，这些合谋者希望广告网络公司、监管机构或保护消费者权益的
律师无法找出罪魁祸首。
类似这样的攻击仍在继续，但已经显著减少了。为什么会发生这种
变化？WindowsXPServicePack2在基于漏洞的安装方面向用户提供
了更好的保护，尤其是在InternetExplorer上安装了SP2补丁的情况
下。另外，运行漏洞攻击的经济动力也开始枯竭：监管机构和消费
者起诉了一些向大量基于漏洞的安装程序提供赞助的“恶意广告软
件"商家，使这些广告客户开始犹豫是否值得通过这种不受欢迎的弹
出广告进行产品宣传。对于能力出众的用户，有可能自己发现这些
漏洞攻击。使用VMwareWorkstation创建一个新鲜的虚拟机，并安装
一个具有漏洞的操作系统（例如，未安装任何ServicePack的
WindowsXP）。浏览网页并观察不同寻常的磁盘或网络行为。最好
再运行一个包嘎探器（例如免费的Wireshark）以及一个或多个更改
跟踪器。（我喜欢用InCtrl进行完全扫描，用HijackThis进行快速分
析。）如果计算机遇到了一个漏洞攻击，可以检查包嘎探器的日
志，推断发生了什么情况并且知道它是怎么发生的。然后，联系网
站、广告网络公司和其他中间组织，帮助阻正漏洞攻击。我发现在
浏览娱乐网站（游戏、歌词、BitTorrent下载的链接）时更容易受到
漏洞攻击。但是，从原则上说，漏洞攻击可能发生在任何地方。总
之，当虚拟机受到感染之后，可以使用VMware的“恢复"功能把虚拟
机恢复为干净的感染前状态。
[1]这些邮件是在FTC诉讼时被发现的，被FTCv.Seismic
Entertainment,Inc.等所引用。No.04-377-JD，2004U.S.Dist.LEXIS
22788(D.N.H.2004)。
[2]FTC v.Seismic Entertainment,Inc.等。No.04-377-JD，2004
U.S.Dist.LEXIS 22788 (D.N.H.2004)。
[3] "Bofra Exploit Hits Our Ad Serving Supplier."The Register.November
21，2004。
[4]Edelman,Benjamin,"WhoProfits from Security Holes?"November
18, 2004。 http://www.benedelman.org/news/111804-1.html 。
[5] Edelman,Benjamin."Spyware Installation Methods"。
http:/www.benedelman.org/spyware/installations/。
[6]参见FTCv.SeismicEntertainment,Inc.等。另参见Matter of
Zango,Inc.f/k/a180Solutions,Inc.等。FTCFile No.0523130。另参见
Matter of DirectRevenue LLC,et al.FTC File No.052 3131。
[Z] Sotelo v.Direct Revenue.384 F.Supp.2d 1219 (N.D.1l1.2005)。
2303
---
## Page 2305
6.1.2恶意链接厂告
运气不好的用户有时候会遇到从网页弹出的横幅广告。从某些方面
看，这类广告看上去与弹出式广告相似，它在用户已经打并的浏览
器窗口之外又打开一个新的浏览器窗口。但这些所谓的“恶意链接”
弹出式广告并没有得到底层网页的授权。相反，网站一般倾向于销
售普通的横幅广告，而不是弹出式的横幅广告。而且，在这些恶意
链接弹出式广告从网页中弹出时一般会充满用户的整个屏幕，而标
准的弹出式广告通常要小得多。更糟的是，有时候这些恶意链接广
告会把用户的整个浏览器进行重定向，完全替换了用户所请求的页
面，使用户只能看到这些不请自来的广告。
如图6-1所示，恶意链接广告一般用于推销反间课软件，它们声称用
户的计算机已经感染了间谋软件，尽管它们并没有确切的证据表明
用户的计算机与正常的有何不同。例如，这张屏幕截图声称它正在
“扫描filevw80.ocx”，尽管在我的测试PC上并不存在这样的文件。事
实上，这种弹出式网页只是个网页而已，并不是货真价实的扫描程
序，根本扫描不出任何问题。而且，“正在扫描”框只是广告的一部
分，看上去逼真的按钮和图形只是障眼法而已。突然弹出的中断信
息加上逼真的用户界面，再加上过度渲染的感染“警告”，这些广告
就可以有效地吸引用户的注意力，并说服他们购买这种软件。
2304
---
## Page 2306
图6-1虚假的扫描广告
恶意链接广告想方设法避开网站和广告网络公司的检测。在无害状
态下查看一个恶意链接广告时，它看上去和普通的Flash广告并无不
同，就是一个横幅，或许还有有限的动画。但是，当时间吻合时，
这个恶意链接广告就使用FlashActionScript弹出恶意广告帧。它是怎
么做的呢？ActionScript常常使用混淆代码，它使用一个桩过程，通
过对一段令人费解的信息进行解码以获取命令。在Web服务器登记
的其他ActionScript程序可以查询用户的IP地址，并决定广告的行
为。这些系统甚至可以检测到使用远程代理从遥远的地址测试广告
行为的审查者。具体地说，ActionScript让一个广告根据用户PC的时
钟获取时间。如果用户PC显示了某一时间，但实际时间却是与用户
的表面IP地址相关联的另一个时间，广告服务器就可以推断出这个
“用户"是一个通过代理连接的测试者，这样广告服务器就可以恢复
到无害的横幅模式。
2305
---
## Page 2307
针对这些攻击的最佳防御是全面地保护客户的设备。以典型的横幅
广告为例，Flash被认为只显示图片和动画，偶尔显示视频。为什么
要允许区区一个广告使用如此丰富的代码？在默认情况下，广告所
具有的权限应该非常有限，但Flash倾向于向广告提供令人吃惊的自
由空间。遗憾的是，一种新的安全模型要求对Flash架构进行根本性
的改变，这意味着Adobe到目前为止所采取的动作显示了它对这类防
御的兴趣非常有限。
幸运的是，分散式的开发提供了两种可行的办法。首先，Flash