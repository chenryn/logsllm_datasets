作者：格蠹老雷  
来源：[公众号：格友](https://mp.weixin.qq.com/s/xN5PWk2dK8XmhYiQEmj6Dw "公众号格友")
最近有些忙，几个方面的事情需要做，不得不多任务模式工作，在几台电脑之间穿梭。但就在我焦急忙碌的时候，我的笔记本时不时会消极怠工，跟不上节奏。怠工的方式有多种，可能是打开程序很慢，可能是切换输入法不灵活，有时Copy&
Paste也会卡顿...... 观察CPU使用率，没有什么异常。根据经验，估计是磁盘I/O方面的问题，但是一直没有腾出时间深入分析。
#### 收集数据
今天有些空闲，于是想清查一番，来一次严打。哪里下手呢？本着不冤枉一个好人，也不漏掉一个坏人的思想，先收集证据吧。调出WPA（Windows
Performance
Recorder），选择“磁盘I/O、文件I/O、注册表I/O和网络I/O”，通过Windows系统的ETW机制从内核那里采集第一手资料。I/O专项整治开始。
一边记录，一边触发一些最近感觉缓慢的操作，持续了3分钟后，点击停止，保存事件，然后使用WPA打开分析。
#### 谁家孩子玩硬盘
展开左侧的File I/O子树，选择Activity by Process, Thread,
Type分析，按访问文件的字节数（Size）排名，立刻有惊人结果呈现。
各位看官睁大眼睛看上图，排名第一的进程名叫wwbizsrv.exe。在采样的几分钟时间里，它的文件I/O数据量是3个多G。稳居第一名，看起来相当于其后所有进程的总和。观察文件属性，文件说明里写着“旺旺亮灯服务模块”。亮灯服务？什么鬼？老雷的电脑不是选秀舞台，也不是征婚现场啊？！
观察版权描述，Alibaba Group，哇塞，看了这个名字，知道为啥如此嚣张了。又是阿里家的软件。几年前曾领教过他家的支付宝客端，疯狂触发Page
Fault，每秒钟数千次。这次不再是支付宝客户端了，而是旺旺。
WPA截图中显示的数据量是刚才采样期间的，只有几分钟的长度，调出任务管理器，选择I/O有关的计数器，想看一看开机以来的累计情况。
结果很快呈现在面前，按I/O读取字节排名，旺旺又是稳居头把交椅，总字节数大约1.6个TB。我的天啊，1.6TB什么概念，老雷电脑上的两块硬盘加起来的总容量也不到1.1TB，而整个维基百科的所有文本也只有大约1GB，所以1.6TB相当于把所有硬盘空间读一遍，把维基百科读1600多编。亲啊，看你的图标，一脸幼稚，懵懂无知的样子，可你这是干什么啊？闲着空了，无聊了，就玩硬盘，是吧？
在系统服务列表里，也可以找到这个程序，描述里堂而皇之的写着“为阿里旺旺客户端提供基础保障服务，一旦停止该服务，有可能影响您的阿里旺旺使用。”看来虽然图标低调，但其实身份不一般，高居系统服务之位，已经进了系统的管理高层。但这个更要求你行为检点，以身作则啊，不然，以低特权身份运行在浏览器里的插件们会增么想？各种广告件又怎么想呢？“论起资源消耗，我还愧不如阿里家的旺旺呢！”
#### 旺旺，你在读什么？
从上面的WPA截图来看，旺旺进程在大约3分钟的时间里，做了8801次文件操作，其中3634次都是读操作。于是，我很想知道，旺旺啊，你在读什么？在我的电脑上找照片看呢么？
开个玩笑，还是要继续以数据说话，在WPA里面选择更多列，特别是文件路径（File Path）。于是，旺旺刚才访问的文件列表就在我们眼前了。
都访问了哪些文件呢？一共3000多次，上面截图只是其中一部分。让老雷有点惊讶的是，访问的文件类型大多都是DLL，DLL者，动态链接库也。不是图片，也不是文档，DLL里面主要是程序，即资源和编译后的代码。
浏览这个列表，让老雷更吃惊地的是，旺旺读文件的方式很豪放，每一次读操作，不是读几个字节，也不是读几十个字节，也不是读几百个字节，......而是一次读大约1百万字节。1百万字节什么概念？老雷的《软件调试》那本大厚书一共100多万字。旺旺一次大约读那幺半本书（中文为双字节编码）。
另一个规律是，旺旺读的差不多都是自己的文件，有一说一，真的是这样。它没有读系统的，也没有读老雷的书稿。:-)
旺旺读的最多的一个文件，名叫aef.dll，在资源管理器找到这个文件后，首先我让我印象很深的是这个文件的块头，40多MB，其次是这个文件的说明和版权描述都为空白，不禁想起平凹前辈在《废都》里的名句：“此处省略xx字”。
除了DLL文件外， 旺旺读的较多的另一个文件名叫aef.pak，名字里也包含aef，一定和刚才aef.dll有关系，个头大约是8MB，也不算小。
PAK是什么呢？应该是源于英文的package，即打包的意思，很多游戏程序常常把零零碎碎的各种小文件打包成PAK。旺旺或许也使用这个技术来打包零碎的文件。直接浏览文件内容，前面一小部分是二进制的，后面是来自Chromium的脚本。Chromium是著名的浏览器项目，旺旺的界面看起来就像是web风格的。
再往后面有很多JavaScript代码。
看来旺旺读的文件，主要都是代码，有的是编译过的DLL代码，有的是脚本代码。如此说来，旺旺像是在孤芳自赏，闲下来，便打开自己家的程序文件，阅读里面的代码。可能是在欣赏代码里的优雅和智慧，也有可能是在使用达摩院里出来的最新最新的人工智能技术自动寻找瑕疵。也有可能.......
#### 上调试器
做了20多年的软件，看了旺旺所读文件后，老雷已经大约猜出了旺旺的心思。可能是怕自己的代码被人篡改，所以在检查。
空猜无凭，还是上调试器找数据吧。唤出WinDBG，附加到旺旺服务，失败，Access
Denied，哦，忘了它是系统服务，重新以管理员身份运行WinDBG，赋予它高特权！再次附加，成功。
`~*`列出所有线程，一共8个，不算多。`~*e .echo ***; ? @$tid;.ttime`列出每个线程的执行时间，寻找用时间最久的线程。
    0:008> ~*e .echo ***; ? @$tid;.ttime
    ***
    Evaluate expression: 13676 = 0000356c
    Created: Tue Jan 30 14:43:47.119 2018 (UTC + 8:00)
    Kernel:  0 days 0:00:00.015
    User:    0 days 0:00:00.062
    ***
    Evaluate expression: 22780 = 000058fc
    Created: Tue Jan 30 14:43:47.440 2018 (UTC + 8:00)
    Kernel:  0 days 0:00:00.203
    User:    0 days 0:00:00.046
    ***
    Evaluate expression: 23472 = 00005bb0
    Created: Tue Jan 30 14:43:47.782 2018 (UTC + 8:00)
    Kernel:  0 days 0:14:18.125
    User:    0 days 0:00:14.437
    ***
    Evaluate expression: 19608 = 00004c98
    Created: Tue Jan 30 14:43:47.784 2018 (UTC + 8:00)
    Kernel:  0 days 0:00:00.078
    User:    0 days 0:00:00.062
    ***
    Evaluate expression: 21896 = 00005588
    Created: Tue Jan 30 14:43:47.974 2018 (UTC + 8:00)
    Kernel:  0 days 0:00:02.781
    User:    0 days 0:00:01.281
    ***
    Evaluate expression: 11992 = 00002ed8
    Created: Thu Feb  8 10:37:43.331 2018 (UTC + 8:00)
    Kernel:  0 days 0:00:00.000
    User:    0 days 0:00:00.000
    ***
    Evaluate expression: 15592 = 00003ce8
    Created: Thu Feb  8 10:37:43.332 2018 (UTC + 8:00)
    Kernel:  0 days 0:00:00.000
    User:    0 days 0:00:00.000
    ***