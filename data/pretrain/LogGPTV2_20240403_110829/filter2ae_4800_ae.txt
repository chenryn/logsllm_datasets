### 使用反向连接方式及端口转发

如果必须使用反向连接方式，且存在防火墙限制只能出站，可以利用端口转发技术。具体来说，通过将边界机上监听反向连接的端口转发到本地端口，可以使二层内网机与边界机之间的通信直接等同于本地通信。

#### 二层内网渗透（使用frp工具进行反向连接）

**frp** 是一种常用的端口转发和内网穿透工具。在配置 **frp** 时，需要明确客户端和服务端的位置。参考 **frpc.ini** 和 **frps.ini** 文件进行配置。

例如，一个 **frpc.ini** 文件的内容如下：

```ini
[common]
server_addr = 172.16.12.2
server_port = 7100

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 5000
remote_port = 5000
```

此配置表示客户端将本机的5000端口数据以TCP协议转发到172.16.12.2的5000端口。服务端配置文件 **frps.ini** 如下：

```ini
[common]
bind_port = 7100
```

这样，连接服务端的5000端口就相当于连接客户端的5000端口。

#### frp端口转发与内网穿透

对于外网Kali访问内网机，有两种方法：
1. **端口转发**：将外网Kali的端口转发至边界机的端口，使得数据发到边界机的该端口即等于发到外网Kali。此时，**frps** 在边界机，**frpc** 在外网Kali。
2. **内网穿透**：将内网流量直接穿透到外网，使内网机能上网。此时，**frps** 在边界机，**frpc** 在内网机。

两种方法都涉及端口转发，但关键在于 **frps** 必须位于中间的机器上。理解这些逻辑有助于正确配置 **frp**。

### 二层代理

1. **Metasploit设置二层代理**：
   - 在已监听的shell中使用 `use auxiliary/server/socks5` 并运行。
   - 对之前ARP扫描的主机进行端口扫描，设置 `rhost` 参数。
   - 配置浏览器代理为SOCKS5，端口与SOCKS5脚本中的端口一致。
   - 访问三层内网机的80端口，准备三层内网渗透。

### 三层内网渗透

如果三层内网要出网经过二层内网，可以使用 **lcx** 或 **frp** 进行多次端口转发。将二层内网机的 **frp** 端口转发到边界机，再将三层内网机反向连接到二层的端口，从而实现多层主机端口串联。

### Termite工具

**Termite** 用于管理多层跳板，包含 `admin` 和 `agent` 两个文件。

1. 在第一个节点上传 `agent` 的对应版本并运行。
2. 在攻击机运行 `admin` 的对应版本连接边界机。
3. 在 `admin` 的shell中使用 `goto 1` 进入第一个节点，并启动监听。
4. 在二层机器上运行 `agent`，指定上一层IP和端口。

### 权限维持

权限维持不一定是高权限。常见的后门包括：

#### Windows后门

- **Shift后门**：将 `cmd.exe` 重命名为 `sethc.exe`，连续按下五次Shift键后会以System权限运行 `cmd.exe`。
- **映像劫持 (IFEO)**：通过注册表劫持程序执行路径。
- **计划任务后门**：使用 `at` 或 `schtasks` 命令创建计划任务。
- **注册表自启动后门**：在注册表中添加自启动项。
- **影子账户**：隐藏账户，只能通过注册表查看。

#### Linux后门

- **Crontab后门**：使用 `crontab` 定期执行命令。
- **SSH公钥免密登录**：将公钥写入目标服务器的 `~/.ssh/authorized_keys` 文件。
- **SSH软连接后门**：对 `sshd` 建立软连接，允许任意密码登录。
- **inetd/xinetd后门**：监听外部网络请求并在配置文件中指定处理程序。

通过这些方法，可以有效维持对目标系统的控制。