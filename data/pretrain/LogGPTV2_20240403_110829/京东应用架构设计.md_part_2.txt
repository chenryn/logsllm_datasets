4 数据读写分离
• 数据库有能力支撑时，尽量不
• 访问量大的数据库做读写分离
要引入缓存
• 数据量大的数据库做分库分表
• 合理利用缓存做容灾
• 不同业务域数据库做分区隔离
• 重要数据配置备库；
5 用Mysql数据库
• 除成本因素外，Mysql的数据
库扩展性和支持高并发的能力
较强，公司研发和运维在这方
面积累了大量经验
4 数据架构
数据架构
4 数据架构
数据架构实例：分布式索引系统
4 数据架构
数据架构实例：数据平台
目 录 CONTENTS
架构愿景
业务架构
应用架构
数据架构
技术架构
618经验
5 技术架构
基础架构
5 技术架构
系统运行时原则
2、应用可回滚，功能可降级
• 应用出现问题时，要求能回滚到
上一版本，或做功能开关或降级
1、可监控
• 服务的TPS和RT是否符合SLA
3、在线扩容
• 是否出现超预期流量
• 超预期流量时，应用系统可选
择在线水平扩展
运行时
6、可故障转移
4、安全保证
• 多机房部署，发生故障时，
• 确保系统的保密性和完整性
能即时切换
• 具有足够的防攻击能力
5、可容错
• 核心应用要求多活，避免单点
设计，并且自身有容错和修复
能力。故障时间TTR小
5 技术架构
系统部署原则
2 D-I-D原则
• 设计20倍的容量（Design）
• 实现 3 倍的容量（Implement）
• 部署1.5倍的容量（Deploy）
1 N+1原则
3 支持灰度发布
• 确保为故障多搭建一套系统，避免
• 系统新上线，要求支持“灰度”
单点问题。例如，多机房部署、应
发布，分步切流量，故障回滚
用系统集群、数据库主备等
• 功能开发与运维分开。系统开发完
成后，交给专业的运维团队管理和
系统部署
运营。
5 业务子网 4 虚拟化部署
• 机房部署以业务域划分：基本服务 • 虚机部署：二级系统、三级系统
和数据库，相同业务域的服务器部 采用虚拟机部署，节省资源和管
署在一起；不同业务域的服务器物 理成本
理隔离
• 虚拟化部署：一级系统应用服务
器，采用虚拟化部署
目 录 CONTENTS
架构愿景
业务架构
应用架构
数据架构
技术架构
618经验
6 618经验
618经验
618实战 前期准备
机房带宽/交换机扩容
分流
应用系统扩容
降级 流量控制 扩容
数据库扩容
限流
硬件监控
应用系统监控
0级系统预案评审
监控 预案
业务监控
线上演练
安全监控
应用系统
交易订单憋单泄洪
数据库
故障转移 线上压测
履约系统憋单
软负载
页面系统压测
DNS
6 618经验
流量控制
应用：集群，无状态，提高访问量
水平扩展 商品读库，商品写库
数据：读写分离，提高性能
应用：按业务域划分成不同子系统
业务分区 商品库、交易库
数据：数据分区
1. 分流
应用：不同业务类型分片 秒杀系统从交易系统中分
分片
数据：分库分表，提高数据容量 离；非核心业务分离
应用：分层，功能与非功能分开
动静分离 业务流程层、应用层
数据：冷热数据分离
无法缓解大流量
1. 动态页面降级到静态
Nginx前端限流
页面降级 2. 整 体降级到其他页面
京东研发的业务路由，
3. 页面部分内容
规则包括账户，IP，系统
调用逻辑等
1. 舍弃一些非关键业务，
业务功能降级
如购物车库存状态
2. 降级 3. 限流 应用系统限流
客户端限流
无法缓解
应用系统降级 1. 降级一些下游系统，如 大流量 服务端限流
一次拆分暂停
数据库限流
数据降级 1. 远程服务降机到本地
红线区，力保数据库
缓存，如运费
6 618经验
架构运行状态分析
目的：故障预测，故障隔离
功能：
• 显示应用之间的依赖关系
• 分析应用和服务的血缘和影响
• 根据依赖关系，分析应用的入出流量分配。
超预期流量时，方便定位问题
• 根据应用系统运行情况，计算应用风险值
• 根据服务sla、tps、rt和依赖关系，评估服
务风险值
• 全局风险评估，并动态更新，即时发现可
能的问题
6 618经验
风险评估
风险评估：利用应用之间的关系，评估每个应用可能
的风险大小。
计算方法：
一、风险指数：R = Rp * Rs * Ra
其中，Rp发生故障可能性， Rs故障影响严重程度，Ra发现
和解决故障的能力，初始值为3。
1、Rp计算：Rp = p0 + p(血缘关系)
其中，p0 = x0 * 10
p(血缘关系) = x1*w1 + x2*w2 + ... + xn*wn
x = f（mem，cpu，tps，rt）
2、Rs计算：Rs = s0 + s(影响关系)
其中，s0 = s0 * 10
s(影响关系) = y1*b1 + y2*b2 + ... + ym*bm
y = f（系统分级）
二、修正后的风险指数：C = Cp * Rs * Ca
Cp: 修正后发生故障可能性。根据618预案评估
Ca: 修正后发现和解决故障能力。根据618预案评估
三、根据修正值，迭代计算风险指数
6 618经验
容量规划
• 服务关系分析
• 容量指标选择
• SLA制定
• 压测
• 依赖治理
• 下单调用链分析：每
• 监测容量指标数 笔交易对应tps
据 • 单量预测：根据历史
数据，预测618单量
• 为扩容、降级、
• 根据调用链模型，估
降级提供依据
算各节点业务峰值
下单调用链
下单调用链模型
7 总结
架构总结
解耦/拆分 抽象 集成 复用 治理
1. 电商业务域
1. 跨业务域调用异步 1. 基础业务下沉，可 1. 厘清业务边界、
2. 核心、非核心业务
2. 非核心业务异步 复用 作用域
业务 3. 主流程、辅流程
4. 业务规则分离
1. 服务自治
1. 应用集群水平扩展 1. 服务抽象，服务 1. 易变依赖稳定 1.复用粒度是有业务逻
2. SLA
2. 按业务域分离应用 调用不依赖实现 2. 流程服务依赖基础服 辑的抽象服务
3. 可水平扩展
应用 3. 按功能分离应用 细节 务
4. 可限流
4. 按稳定性分离应用 2. 应用集群抽象， 3. 非核心应用依赖核心
5. 服务可降级
应用位置透明 应用
6. 容错设计
7. 服务白名单
1. 读写分离 1. 数据库抽象。应 1.数据库只能通过服务 1. 重要数据做主备
2. 按业务域分库 用只依赖逻辑数据 访问 2. 合理利用缓存容灾
数据 3. 分库分表 库 2. 统一的元数据管理 3. 双写要做补偿
4. 冷热数据分离 3. 统一的主数据管理
1. 功能开发与运维分离 1. 服务器资源抽象。 1. 同步调用时，设置超 1. 代码提共通，可复用 1. N+1设计
2. 业务子网 应用只依赖虚拟化 时和任务队列长度 2. 非功能性服务，可复 2. 灰度部署
技术
3. 分离功能、非功能型 资源 2. 利用回调异步化 用 3. 版本可回滚
需求 3. 利用MQ、缓存、中 3. 基础配置、基础软件 4. 可监控
间件异步化 复用 5. 可容灾