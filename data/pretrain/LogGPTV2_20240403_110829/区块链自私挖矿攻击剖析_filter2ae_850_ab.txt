## 0x05 Finite State Machine
A.稳态分析
在此制定一个有限状态机来描述私有链和公共链的演变。上图显示出了当私有链的最大长度为2（即N ＝
2）时的状态机。我们将状态定义为由Alice，Bob和Henry的长度组成的三元组。箭头表示相应的状态转换，关联的值表示转换概率。例如，所有向（0，0，0）的转换都意味着分叉的链会化为一致的公共链，并且新一轮的自私挖矿开始了。用
**P**
ijk表示（i，j，k）的稳态分布。用R1（或R2，Rh）表示由Alice（或Bob，Henry）挖掘的有效块的平均数量。使用标准方法，我们获得Ri如下：
当N很大（例如三个或四个）时，有限状态机变得更加复杂。由于篇幅所限，将仅给出N = 4的近似结果，如下。
注意在建模中不考虑N> 4的情况。除了它们的复杂性之外，过大的N可能会导致许多连续的孤立块，因此可以很容易地检测到自私挖矿。最后，模拟结果确认了在N =
4时获利阈值的收敛性，即N = 4与足够大的N之间的差很小。
B、瞬态分析
比特币系统的哈希率呈指数增长，有必要研究攻击的瞬时行为。在一个难度调整回合内进行建模，并探索回合数与攻击者的哈希率之间的关系。
为了更好地描述，我们定义了绝对收入和相对收入的概念。 首先，Alice，Bob和Henry的相对收入是其收入占总收入的比例，即
由于忽略了交易费和其他因素的影响，因此矿工只能从已发布的区块中获取收入。基于此将绝对收益定义为每单位时间获得的有效块数。在比特币系统中，我们以10分钟为单位时间。
通过状态机，在第i个调整间隔（例如难度调整回合）中，最长的公共链将出现ni个块，并且在一个攻击回合中完全挖掘出来mi个块（例如从阶段（0,0,0）回到阶段（0,0,0））。此外，使用Ti表示第i个调整间隔中花费的总时间。考虑到计算能力的变化，用Si表示整个系统的哈希率，mathi和ti分别表示在第i个调整间隔内开采一个块所花费的理论时间和实际时间。以Alice为例，我们可以得到以下方程式：
下式说明在第一个困难调整回合间，它的花费时间是T1。
在第一阶段之后，系统将调整难度以满足每十分钟开采一个区块的需求。可以在第i个周期中获得新的平均块生成时间。Alice的绝对收入可以表示为下式：
## 0x06 Result
**结论 A：** 当比特币系统中有多个攻击者时，攻击者的最低获利阈值会降低，系统安全性也会降低。
当系统中只有一个攻击者时，若γ1=γ2= 1/2，则攻击者的获利阈值为25％。以Alice为例，考虑γ1=γ2= 1/2，θ1=θ2=
1/3的情况。根据上式(10)，我们可以得出，当Alice的哈希率为16％时，Bob的获利阈值可以达到理论最小值：21.06％。当Alice的哈希率小于16％时，方程式(10)的导数大于0，这意味着Bob的阈值相对于Alice的哈希率会单调递减。当Alice的哈希率大于16％时，则方程式(10)的导数小于0，这意味着Bob的阈值相对于Alice的Hashrate呈单调递增。
下图蓝色曲线代表理论结果，红色点代表实验结果。三个红色点代表三种情况：N是2，3和4。我们可以观察到，当Alice的哈希率大约为16％时，Bob的阈值可以最小。通过计算和模拟，如果Alice和Bob拥有相同的哈希率，则当N为2、3和4时，攻击者的获利阈值分别为27％，23％和22％。它表明，当有两个攻击者时，他们可以采用策略来成功进行攻击，而攻击者的总哈希率不到25％。
**结论 B：** 以Bob为例，如果N不大于4，则Bob的最低获利阈值与N之间存在负相关，而他的收入与N正相关。
在比特币系统中，无论是一个攻击者还是两个攻击者，获利阈值将随着N的增长而收敛。如下图，当攻击者只有一个（situation
1）时，随着N的增加，阈值收敛到25％。当攻击者可以拥有5个以上的私有块时，收敛过程将趋于平稳。当系统中有两个攻击者时（situation
2），N和阈值之间的关系与一个攻击者一致，并且收敛过程也更快。当N为4时，达到收敛平衡，获利阈值为21.48％。当Alice拥有25％（situation
3）和30％（situation 4）的哈希率时，Bob的获利阈值也将是一个收敛过程。
这是因为在不破坏系统正常运行的情况下，Henry的哈希率占了多数。基于此前提，在现实世界中攻击者拥有多个私人区块并且始终处于领先地位的可能性很小。隐藏更多私人区块确实可以增加攻击者的收入吗，但是较长的私有链很容易暴露出攻击者的身份，因为较长的私有链可以使其在发布时更加容易与普通块区分开来。另一方面，如果不知道其他攻击者的存在，则若N越大，丢失所有私人区块的风险就会增加。为了保险起见，攻击者可能选择在一定程度上披露私有区块的数量，以获得相应的收入。此外，这种策略还可以排除双花的影响。
基于上述原因，最好在私有链的长度达到4时发布所有私有块，然后开始下一轮攻击。
有人提出如果设置区块的时效性可以有效地抵制自私挖矿攻击，但阈值的收敛性证明该方法在当前的比特币系统中无效，这是因为在当前系统中默认使用需要确认6个有效区块的交易，不幸的是阈值可能在六个区块之前达到收敛。
**结论 C：** 为了确保攻击能够正常进行，必须满足αh> max {α1，α2}。
作为反例，如果Alice的哈希率最高，并且对私有链的长度没有限制，则Alice可以尽可能长地隐藏其私有链。在攻击过程中的大多数情况下，她可以保持领先地位，这将导致Alice的私有链成为唯一有效链。在这种情况下，Bob和Henry将选择停止挖掘以减少损失。可以推测在这种情况下，Alice的收入可能接近100％，而她的攻击实际上变得毫无意义，这种攻击类似于51％的攻击。结果也证明了这一点，在下图中当Alice的哈希率是45％、Bob的哈希率是25％、Henry的哈希率是35％时得到了situation
1。当Alice的哈希率是45％、Bob的哈希率是35％、Henry的哈希率是25％时得到situation
2。这表明攻击者的私人链越长，他可以获得的利益就越大。只要一个攻击者的哈希率最高，就可能发生这种情况，而不管其他矿工拥有多少哈希率。
**结论 D：** 攻击者将在第一个难度调整回合中失败，无论攻击者的哈希率如何。但他可能会在几个回合后获利，这与攻击者哈希率有关。
假设两个攻击者具有相同的哈希率，如下图。在允许的误差范围内，相对收入和绝对收入相等。因此可以相信相对收入和绝对收入在代表利益方面起着相同的作用。
由方程式(15)得出，当Alice的哈希率更高时，她可以更早获得非法收入。当攻击者的哈希率较小时，要花很长时间才能获利，这意味着在实际系统中执行攻击有些困难。如果总哈希率有所增加，还可以使用此公式来计算何时停止攻击才能获得最大收益。
## 0x06 Conclution
本文研究了区块链系统中多矿池如何影响自私挖矿的获利能力。通过建立马尔可夫链模型来描述攻击者和诚实矿工的行为，可以获得实际最小获利阈值为21.48％。因为考虑到难度调整而对瞬态过程进行建模，发现获利时间与攻击者的挖矿能力之间的负相关关系。