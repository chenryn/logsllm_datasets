# CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ
|
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
## 0x00 å‰è¨€
å¤ç°è¿™ä¸ªæ¼æ´çš„è¿‡ç¨‹ä¸­è§‰å¾—å¾ˆæœ‰åˆ†æçš„å¿…è¦ï¼Œè€Œä½œè€…æºç ç»“åˆ log è°ƒè¯•åˆ†æçš„[è¿™ç¯‡æ–‡ç« ](https://firzen.de/building-a-poc-for-cve-2021-40438)å·²ç»å†™å¾—æ¯”è¾ƒè¯¦å°½äº†ï¼Œå°±æƒ³è‡ªå·±çº¯ä»å®¡è®¡çš„è§’åº¦å†™ä¸€ä¸‹åˆ†æå·©å›ºä¸€ä¸‹ã€‚
æ€»ä¹‹ï¼Œå¦‚æœ‰ä¸å½“ï¼Œçƒ¦è¯·è¯„è®ºæ‰è™«ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å“åº”å¹¶è¯„è®ºæç¤ºï¼Œè°¢è°¢ã€‚
## 0x01 ç®€ä»‹
###  æ¼æ´æˆå› 
å¯æ„é€  uri ä½¿ mod_proxy è¯·æ±‚è½¬å‘ç»™å†…éƒ¨æœåŠ¡å™¨é€ æˆ SSRF ã€‚
###  å½±å“ç‰ˆæœ¬
###  å®éªŒç¯å¢ƒ
ä»£å®¡ç¯èŠ‚ä¸ªäººå»ºè®®æ˜¯äº²æ‰‹ç¼–è¯‘è°ƒè¯• Apache è·Ÿè¿›ï¼Œå¯ä»¥å‚ç…§ P ç¥çš„æ•™ç¨‹ï¼š
[ç¼–è¯‘è°ƒè¯• Apache](https://wx.zsxq.com/dweb2/index/topic_detail/418885442584848)
[è°ƒè¯•è¡¥å……äº‹é¡¹](https://wx.zsxq.com/dweb2/index/topic_detail/218882521544551)
ä¸ä¸€å®šè¦ Ubantuï¼ŒKali ä¸Šç¬”è€…ä¹Ÿè°ƒè¯•æˆåŠŸäº†ï¼Œæœ€å¥½ç”¨ VSï¼Œå¦å¤–å¦‚æœä½ æƒ³å°è¯•ç”¨ CLionï¼Œå¯ä»¥å‚ç…§ä¸‹é¢çš„é“¾æ¥è¿›è¡Œ SSH
è¿œç¨‹è°ƒè¯•ï¼Œå…¶ä½™æ­¥éª¤éƒ½åŒä¸Šä¸€æ ·ï¼š
[Stay local, let your IDE do remote work for you! | The CLion Blog
(jetbrains.com)](https://blog.jetbrains.com/clion/2018/09/initial-remote-dev-support-clion/)
CLion è°ƒè¯•éœ€è¦æ³¨æ„æœ‰ cmake å’Œ gdb ç‰ˆæœ¬é™åˆ¶ï¼Œæœ€å¥½ä¸è¦ä¸‹è½½æœ€æ–°ç‰ˆæœ¬é¿å…è¿˜è¦ç”¨è½¯é“¾æ¥é‡æ–°ä¸‹è½½æŸä¸€æŒ‡å®šç‰ˆæœ¬ï¼Œæˆ–è€…æ›´æ–° CLion ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚
## 0x02 å‰ç½®å­¦ä¹ 
ä¸ºäº†ç†è§£æ¼æ´åŸç†ï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºæ˜¯éœ€è¦ Apache å’Œ PHP
ä¸€äº›å‰ç½®çŸ¥è¯†å­¦ä¹ çš„ï¼Œå°±ç®€å•æ¦‚æ‹¬äº†å¹¶ä½¿ä¹‹é€’è¿›åŠ æ·±ç†è§£ï¼Œå¾ˆå¤šç‚¹éƒ½ä¼šåœ¨åˆ†æè¿‡ç¨‹ä¸­ç”¨åˆ°ï¼Œè¡Œæ–‡ç»“åˆäº†è®¸å¤šå®˜æ–¹æ–‡æ¡£å’Œè‡ªèº«ç†è§£æ•´ç†ä»¥ç¡®ä¿å‡†ç¡®ï¼Œå¦‚æœ‰ç¼ºæ¼ä¸å½“ä¹‹å¤„ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚
###  Apache éƒ¨ç½² php
ä¼—æ‰€å‘¨çŸ¥ï¼Œphp æœ‰äº”ç§è¿è¡Œæ¨¡å¼ï¼Œå…¶ä¸­æœ€å¸¸è§çš„ä¸‰ç§ CGIã€FastCGIã€Module åŠ è½½æˆ–è€…è¯´ apache2handler æ›´ä¸ºæ°å½“ï¼ˆlinux
ä¸‹ï¼‰ã€‚
Module åŠ è½½è¿™ç§æ¨¡å¼ä¸€èˆ¬å¯¹äº Apache è€Œè¨€ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠ PHP ä½œä¸º Apache çš„ä¸€ä¸ªå­æ¨¡å—æ¥è¿è¡Œï¼Œç”¨ LoadModule
åŠ è½½æ¨¡å—ï¼Œæœ€ä¸»è¦çš„æ¨¡å—å°±æ˜¯ mod_phpï¼Œæ¼æ´å®éªŒç¯å¢ƒé…ç½®è°ƒè¯•ä¹Ÿæ˜¯ä»¥ LoadModule åŠ è½½ mod_proxy çš„ã€‚
è€Œ FastCGI è¿™ä¸ªæ¨¡å¼ä¸‹ä¼šç”¨åˆ° PHP-FPM è¿™ä¸ªè¿›ç¨‹ç®¡ç†å™¨è¿›è¡Œ FastCGI ç®¡ç†ï¼Œè€Œé CGI çš„ç”¨ Web æœåŠ¡å™¨ç®¡ç†ï¼Œå…¶ä¸­çš„å­è¿›ç¨‹å«åš
PHP-CGI ï¼Œ **è¿™æ¬¡æ¼æ´çš„çªç ´ç‚¹ mod_proxy å°±ä¸ PHP-FPM æœ‰å…³ï¼Œå®ƒä» PHP 5.3.3 å°±æˆä¸ºäº† PHP
çš„å†…ç½®ç®¡ç†å™¨ï¼Œæ‰€ä»¥é…åˆè¿™ä¸ªä» Apache httpd 2.4.x æ¨å‡ºäº†ä½¿ç”¨ mod_proxy çš„å­æ¨¡å— mod_proxy_fcgi å’Œ PHP-FPM éƒ¨ç½²æ›´é«˜æ€§èƒ½çš„ PHP è¿è¡Œç¯å¢ƒã€‚**
è™½ç„¶ç°åœ¨æ˜æ˜¾ç”¨ Nginx+PHP-FPM æ˜¯æ›´å¥½çš„é€‰æ‹© ğŸ™‚
###  mod_proxy åå‘ä»£ç†
é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ¨¡å—ä¸å…¶ç›¸å…³æ¨¡å—ä¸º Apache HTTP Server å®ç°ä»£ç† / ç½‘å…³ã€‚
å‰é¢æœ‰è¯´åˆ° High-performance PHP on apache httpd 2.4.x using mod_proxy_fcgi and php-fpm è¿™ç§æ–¹å¼ï¼Œæœ¬è´¨å°±æ˜¯ Apache ä½œä¸ºåä»£æœåŠ¡å™¨ç”¨ mod_proxy_fcgi è¿™ä¸ªå­æ¨¡å—è¯·æ±‚è½¬å‘ç»™ PHP-FPM ï¼Œè€Œ PHP-FPM
ç›‘å¬çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶ Apache è½¬è¿‡å»æ—¶å¤„ç† PHP çš„è¯·æ±‚çš„æ–¹å¼ï¼Œæœ‰ä¸¤ç§ï¼š
  1. TCP Socketï¼ˆip and portï¼‰ 
        ProxyPass / http://www.example.com:port
  2. UDS ï¼ˆUnix Domain Socketï¼‰ **åªåœ¨Apache 2.4.7 åŠæ›´é«˜ç‰ˆæœ¬ä¸­æ”¯æŒã€‚** å¯ä»¥é€šè¿‡ä½¿ç”¨ä½äº `unix:/path/app.sock|` å‰é¢çš„ç›®æ ‡æ¥æ”¯æŒä½¿ç”¨ UDS ã€‚ä¾‹å¦‚ï¼Œè¦ä»£ç† HTTP å¹¶å°† UDS å®šä½äº /home/www.socket ï¼Œåº”ä½¿ç”¨ `unix:/home/www.socket|http://localhost/whatever/` ã€‚ 
        ProxyPass / unix:/path/to/app.sock|http://example.com/app/name
å¯¹äºåå‘ä»£ç†è€Œè¨€ï¼Œ Apache è½¬å‘ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ Apache å‘é€è¯·æ±‚ç»™ PHP-FPM çš„æ–¹å¼æœ‰ä¸‰ç§ï¼Œå…¶ä¸­ä¸€ç§å« ProxyPass
ï¼Œè¿™æ˜¯æŒ‡ä»¤ï¼Œå…è®¸å°†è¿œç¨‹æœåŠ¡å™¨ Map åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼ˆåå‘ä»£ç† / ç½‘å…³ï¼‰çš„ç©ºé—´ï¼Œå¯¹äºä¸åŒç›‘å¬æ–¹å¼çš„æŒ‡ä»¤ä¾‹å­å¦‚ä¸Šæ‰€ç¤ºã€‚
###  Apache hook æœºåˆ¶
è¯´èµ· Apache Module ä¸èƒ½ä¸æèµ· Apache hookï¼Œæƒ³è¦å¤„ç†è¯·æ±‚ï¼Œè¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­åˆ›å»ºä¸€ä¸ª
hookï¼Œæ‰€æœ‰å¤„ç†ç¨‹åºï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„ mod_proxy
ï¼Œéƒ½ä¼šè¢«æŒ‚æ¥åˆ°è¯·æ±‚è¿‡ç¨‹çš„ç‰¹å®šéƒ¨åˆ†ã€‚æœåŠ¡å™¨æœ¬èº«æ˜¯ä¸çŸ¥é“å“ªä¸ªæ¨¡å—è´Ÿè´£å¤„ç†ç‰¹å®šè¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¼šè¯¢é—®æ¯ä¸ªæ¨¡å—æ˜¯å¦å¯¹ç»™å®šè¯·æ±‚æ„Ÿå…´è¶£ã€‚ç„¶åï¼Œç”±æ¯ä¸ªæ¨¡å—å†³å®šæ˜¯å¦åƒèº«ä»½éªŒè¯
/ æˆæƒæ¨¡å—é‚£æ ·æ‹’ç»æœåŠ¡è¯·æ±‚ï¼Œæ¥å—æœåŠ¡è¯·æ±‚æˆ–æ‹’ç»æœåŠ¡è¯·æ±‚ï¼Œå°±åƒä¸‹å›¾ä¸€æ ·ã€‚
ä¸ºäº†ä½¿è¯¸å¦‚ mod_example ä¹‹ç±»çš„å¤„ç†ç¨‹åºæ›´å®¹æ˜“çŸ¥é“ Client
ç«¯æ˜¯å¦åœ¨è¯·æ±‚æˆ‘ä»¬åº”å¤„ç†çš„å†…å®¹ï¼ŒæœåŠ¡å™¨å…·æœ‰ç”¨äºå‘æ¨¡å—æç¤ºæ˜¯å¦éœ€è¦å…¶ååŠ©çš„æŒ‡ä»¤ã€‚å…¶ä¸­ä¸¤ä¸ªæ˜¯
[AddHandler](https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_mime.html#addhandler) å’Œ
[SetHandler](https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-core.html#sethandler)ã€‚
ä¸ºæ­¤å¯ä»¥çœ‹ä¸€ä¸ªä¾‹å­ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³é€šè¿‡åˆ›å»ºåˆé€‚çš„ Handler ä¼ é€’ï¼Œå°†è¯·æ±‚å¼ºåˆ¶å¤„ç†ä¸ºåå‘ä»£ç†è¯·æ±‚ï¼š
        # Unix sockets require 2.4.7 or later
        SetHandler  "proxy:unix:/path/to/app.sock|fcgi://localhost/"
è¿™ä¸ªä¾‹å­æ˜¯ä½¿ç”¨åå‘ä»£ç†å°†å¯¹ PHP è„šæœ¬çš„æ‰€æœ‰è¯·æ±‚ä¼ é€’åˆ°æŒ‡å®šçš„ FastCGI æœåŠ¡å™¨ï¼Œæ˜¯ä¸æ˜¯å’Œä¹‹å‰ UDS çš„ä¾‹å­å¾ˆåƒï¼Ÿ
ä¸€ä¸ª Module é€šå¸¸æ˜¯åœ¨ Handler ä¸­åˆ›å»ºä¸€ä¸ª hookï¼Œä¾‹å¦‚ï¼š
    static void register_hooks(apr_pool_t *pool)
    {
        /* Create a hook in the request handler, so we get called when a request arrives */
        ap_hook_handler(example_handler, NULL, NULL, APR_HOOK_LAST);
    }
å¦‚ä¸Šï¼Œç»§è€Œå°±ä¼šåœ¨ example_handler è¿™ä¸ªå‡½æ•°ä¸­å¤„ç†è¯·æ±‚ï¼Œmod_proxy ä¹Ÿæœ‰è¿™æ ·çš„ Handler ã€‚
å¦å¤–è¿˜è¦æåˆ°çš„å°±æ˜¯ request_rec ç»“æ„ã€‚
ä»»ä½•è¯·æ±‚ä¸­æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ request record ã€‚åœ¨å¯¹å¤„ç†ç¨‹åºå‡½æ•°çš„è°ƒç”¨ä¸­ï¼Œè¿™ç”±ä¸è¿›è¡Œçš„æ¯æ¬¡è°ƒç”¨ä¸€èµ·ä¼ é€’çš„ `request_rec*`
ç»“æ„è¡¨ç¤ºã€‚è¯¥ç»“æ„åœ¨æ¨¡å—ä¸­é€šå¸¸ç®€ç§°ä¸º `r` ï¼ŒåŒ…å«æ¨¡å—å®Œå…¨å¤„ç†ä»»ä½• HTTP è¯·æ±‚å¹¶ç›¸åº”åšå‡ºå“åº”æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚
å…¶ä¸­è¿™ä¸ª `r->filename` è¿˜æœ‰å…¶ä»–å‡ ä¸ªæˆ‘ä»¬å°±ä¼šåœ¨åˆ†æè¿‡ç¨‹ä¸­æ¥è§¦åˆ°ã€‚
## 0x03 åˆ†æ
###  ä»£ç å®¡è®¡
ä»¥ Apache 2.4.48 æºä»£ç å®¡è®¡ï¼Œ **ä¸åŒç‰ˆæœ¬ä¼šæœ‰äº›å‡ºå…¥** ã€‚
**æ³¨æ„å®¡è®¡è¿™éƒ¨åˆ†ç€é‡çœ‹ä»£ç ä¸­çš„æ³¨é‡Šï¼Œç¬”è€…æ‰€å†™çš„æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†è§£é‡Šå’Œåˆ†æéƒ½åœ¨å…¶ä¸­ï¼Œä¿®å¤çš„éƒ¨åˆ†ä¼šæ ‡ * ï¼Œä¸€å®šè¦çœ‹æ³¨é‡Šé…åˆç†è§£ï¼**
[[Apache-SVN] Revision
1892814](https://svn.apache.org/viewvc?view=revision&revision=1892814)
ç›´æ¥æ¥çœ‹ä¿®å¤å‰åçš„å¯¹æ¯”åˆ†æç¼ºé™·åœ¨å“ªï¼Œè¿˜æœ‰æ¼æ´æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆé—®é¢˜ã€‚
å®˜æ–¹çš„å‡½æ•°è§£é‡Šçœ‹è¿™ä¸ªæ–‡æ¡£ï¼š
[Apache2: HTTP Daemon
Routine](https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#gaa6a7169f7d3801b11d3b113b27284dbd)
    --- httpd/httpd/trunk/modules/proxy/proxy_util.c    2021/09/02 12:33:49 1892813
    +++ httpd/httpd/trunk/modules/proxy/proxy_util.c    2021/09/02 12:37:02 1892814
    @@ -2274,8 +2274,8 @@ static void fix_uds_filename(request_rec *r, char **url){
         char *ptr, *ptr2;
         if (!r || !r->filename) return;
         // COND1ï¼šr->filename å‰ 6 ä¸ªå­—ç¬¦å¿…é¡»æ˜¯ proxy:
         if (!strncmp(r->filename, "proxy:", 6) &&
                 // COND2ï¼šr->filename å¿…é¡»æœ‰ unix: è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œä½†ä¸åŒºåˆ†å¤§å°å†™ï¼Œè¿™ä¸åŒäº strstr
    -            (ptr2 = ap_strcasestr(r->filename, "unix:")) &&
                 // COND3ï¼šCOND2 å¯¹ r->filename è¿›è¡Œäº†æˆªå–ï¼Œè¿™æ¡æ˜¯åˆ¤æ–­ unix: è¿™ä¸ªå­—ç¬¦ä¸²åçš„éƒ¨åˆ†æ˜¯å¦æœ‰ | 
    -            (ptr = ap_strchr(ptr2, '|'))) {
                  // *COND2ï¼šä¸åŒºåˆ†å¤§å°å†™å¯¹ä¸¤ä¸ªå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œ r->filename å¿…é¡»ä»¥ proxy:unix: å¼€å¤´
    +            !ap_cstr_casecmpn(r->filename + 6, "unix:", 5) &&
                 // *COND3ï¼šptr2 æŒ‡ proxy:unix: åçš„éƒ¨åˆ†ï¼Œè¿™é‡Œåˆ¤æ–­å­—ç¬¦ä¸²ä¸­é‚£ä¸ªæ˜¯å¦æœ‰ | ï¼Œä¸ COND3 è¦æ±‚ä¸€è‡´
    +            (ptr2 = r->filename + 6 + 5, ptr = ap_strchr(ptr2, '|'))) {
             apr_uri_t urisock;
             apr_status_t rv;
             *ptr = '\0';
             // ä¸¾ä¾‹ï¼šProxyPass / unix:/path/to/app.sock|http://example.com/app/name æˆ‘ä»¬æ¥çœ‹è¿™äº›å‚æ•°çš„å€¼
             // è¿™é‡Œè§£æç»™å®šçš„ uri ï¼Œå¡«å†™ apr_uri_t ç»“æ„çš„ä¸€äº›å­—æ®µï¼Œé¿å…é‡å¤æå–ä¸»æœºç«¯å£ã€è·¯å¾„è¿™äº›
             rv = apr_uri_parse(r->pool, ptr2, &urisock);
             // å¦‚æœè§£ææˆåŠŸï¼ˆapr_uri_parse Returns APR_SUCCESS for success or error codeï¼‰
             if (rv == APR_SUCCESS) {
                 // è¿™é‡Œ rurl å³ redirect url åœ¨ä¾‹å­ä¸­å°±æ˜¯ http://example.com/app/nameï¼Œéœ€è¦é‡å®šå‘åˆ°çš„åœ°å€
                 char *rurl = ptr+1;
                 // è¿”å›ç›¸å¯¹è·¯å¾„ï¼Œåœ¨ä¾‹å­ä¸­ uds_path å°±æ˜¯ /path/to/app.sock
                 char *sockpath = ap_runtime_dir_relative(r->pool, urisock.path);
                 // å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r->notes
                 apr_table_setn(r->notes, "uds_path", sockpath);
                 *url = apr_pstrdup(r->pool, rurl); /* so we get the scheme for the uds */
                 /* r->filename starts w/ "proxy:", so add after that */
                 memmove(r->filename+6, rurl, strlen(rurl)+1);
                 // è®°å½•ä¿¡æ¯
                 ap_log_rerror(APLOG_MARK, APLOG_TRACE2, 0, r,
                         "*: rewrite of url due to UDS(%s): %s (%s)",
                         sockpath, *url, r->filename);
             }
             else {
                 *ptr = '|';
             }
         }
    }
ç»“åˆæ³¨è§£ï¼Œå¯ä»¥çœ‹å‡º `fix_uds_filename` è¿™ä¸ªå‡½æ•°æœ¬èº«å°±æ˜¯ç”¨äºè§£æå¹¶å¡«å†™ uri ï¼Œæ–‡ä»¶åæ ‡è¯† UDS ï¼Œç„¶åé€šè¿‡ç®¡é“ç¬¦ `|`
åé¢çš„å†…å®¹é‡å®šå‘åˆ°å®ƒã€‚
å¯¹æ¯” COND2 å’Œ *COND2 ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¼æ´çš„ä¿®å¤å°±æ˜¯å•çº¯å¼ºåˆ¶è¦æ±‚ `proxy:unix:` å¼€å¤´ï¼ŒCOND2 æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºåªè¦æ˜¯æœ‰
`unix:` å­—æ ·è€Œä¸”ä¸è®ºå¤§å°å†™éƒ½èƒ½è¢«è§£æï¼Œæ˜¾ç„¶æ˜¯åˆ¤å®šå®½æ¾å‡ºäº†é—®é¢˜ï¼Œä¸ºäº†æ›´å¥½ç†è§£æˆ‘ä»¬å…ˆæ¥çœ‹ [remyğŸ€ åœ¨ Twitter:
â€œCVE-2021-40438 Apache SSRF as a one-liner./
Twitter](https://twitter.com/_mattata/status/1449020783989297167) ä¸Šçš„ä¸€ä¸ª poc ï¼š
å¯ä»¥çœ‹åˆ° `unix:` åå®ƒæ‹¼æ¥äº†å…± 7701 ä¸ªå­—ç¬¦çš„ A
ï¼Œå¯ä»¥çŒœæƒ³è¿™å…¶ä¸­ä¸€å®šæœ‰ç¼“å†²åŒºæˆ–è€…é”™è¯¯å¤„ç†çš„é—®é¢˜ï¼Œæ¥çœ‹ä¿®å¤å‰æ‹¼æ¥çš„æ•ˆæœï¼Œå‡è®¾æˆ‘ä»¬å‘é€çš„è¯·æ±‚å¦‚ä¸‹ï¼Œæ˜¾ç„¶æ˜¯è®©ä»£ç†ä¸€ä¸ª http è¯·æ±‚ï¼š
    http://localhost/?unix:$(python3 -c 'print("A"*7701, end="")')|http://backend_server1:8085/
ä»£ç†è¯·æ±‚æ‹¼æ¥åï¼š
    proxy:http://localhost/?unix:$(python3 -c 'print("A"*7701, end="")')|http://backend_server1:8085/
è¿™é‡Œå°±åˆå› ä¸ºåŒ…å« `unix:` ï¼Œæ»¡è¶³ COND2 ï¼Œ **å°±ä» http è¯·æ±‚å˜æˆäº†æœ‰æ•ˆçš„ UDS ä»£ç†é‡å®šå‘è¯·æ±‚ã€‚**
è§£é‡Šåˆ°è¿™ï¼Œæˆ‘ä»¬æ˜ç™½é—®é¢˜æœ¬è´¨åï¼Œå…ˆæ¥åˆ†æä»€ä¹ˆæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå†æ¥ä» UDS è§£æè¿‡ç¨‹ä¸Šåˆ†æä¸ºä»€ä¹ˆè¦æ‹¼æ¥å°† 7000 ä¸ªå­—ç¬¦æ‰èƒ½æ”»å‡»æˆåŠŸã€‚
####  å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ
ä¹‹å‰åœ¨å‰ç½®çŸ¥è¯†å­¦ä¹ ä¸­ï¼Œç¬”è€…æœ‰æåˆ°è¿‡ mod_proxy æœ‰å®ƒå¤„ç†è¯·æ±‚çš„
Handlerï¼Œæˆ‘ä»¬ä»è¿™ä¸ªå‡½æ•°æ¥çœ‹å“ªäº›æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå½“ç„¶ï¼Œè®¤çœŸçœ‹äº†ä¸Šéƒ¨åˆ†å†…å®¹çš„ä½ ï¼Œä¸€å®šçŸ¥é“ `r->filename` æ˜¯å…³é”®ã€‚
modules/proxy/mod_proxy_http.c
    static void ap_proxy_http_register_hook(apr_pool_t *p)
    {
        ap_hook_post_config(proxy_http_post_config, NULL, NULL, APR_HOOK_MIDDLE);
        proxy_hook_scheme_handler(proxy_http_handler, NULL, NULL, APR_HOOK_FIRST);
        proxy_hook_canon_handler(proxy_http_canon, NULL, NULL, APR_HOOK_FIRST);
        warn_rx = ap_pregcomp(p, "[0-9]{3}[ \t]+[^ \t]+[ \t]+\"[^\"]*\"([ \t]+\"([^\"]+)\")?", 0);
    }
å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª hookï¼Œæˆ‘ä»¬æ¥çœ‹ `proxy_http_canon` è¿™ä¸ª Handlerï¼Œæ˜¯ç”¨äºå¤„ç†åä»£è¯·æ±‚çš„ã€‚
    static int proxy_http_canon(request_rec *r, char *url)
    {
        ...
        // get_url_scheme æ˜¯æ£€æŸ¥è¯¥è¯·æ±‚æ˜¯å¦æ˜¯ï¼ˆh / H å¼€å¤´ï¼‰ å†åˆ¤æ–­æ˜¯å¦æ˜¯ http / httpsï¼Œä¹Ÿå°±æ˜¯è¯¥ä¸è¯¥ç”± mod_proxy_http å¤„ç†
        // schema pass
        scheme = get_url_scheme((const char **)&url, &is_ssl);
        if (!scheme) {
            return DECLINED;
        }