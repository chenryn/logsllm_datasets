PGCluster-II
Clustering system of PostgreSQL
using Shared Data
PGCon 2007
Atsushi MITANI
PGCon 2007
Agenda
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
As a background
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
Status of DB
BBrrookkeenn
Data would be lost. sorry...
SSttoopp
Out of service, but data is remained.
RRuunn
Perfect! You can read and write data.
BBeettwweeeenn RRuunn aanndd SSttoopp
Hey, it’s not working.
Huum, I can connect it.
PGCon 2007
What is DBA
NNoott ggoooodd DDBBAA
Break DB by wrong patch / restore wrong data
OOrrddiinnaarryy DDBBAA
monitors, patches, backups of DB
Stop DB before data broken
GGoooodd DDBBAA
Stop use such a funky DB
JJookkee ??
PGCon 2007
High Availability (HA)
WWhhaatt iiss rreeqquuiirreedd ??
Short down time as much as possible
Even if hardware failure, power down and DB
maintenance
WWhhyy iitt iiss rreeqquuiirreedd ??
Prevent data lost / service stop
WWhhoo nneeeeddss ??
Data owner
Service user
PGCon 2007
High Performance (HP)
WWhhaatt iiss rreeqquuiirreedd ??
Short response time as much as possible
WWhhyy iitt iiss rreeqquuiirreedd ??
User dislikes waiting
Many processing data is the value of system
WWhhoo nneeeeddss ??
Service user
PGCon 2007
At the beginning
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
Requirement
TTaarrggeett wwaass WWeebb aapppplliiccaattiioonn
HHiigghh AAvvaaiillaabbiilliittyy
Scheduled maintenance only
HHiigghh PPeerrffoorrmmaannccee
More than 200 accesses / sec
700,000/hr , 1,500,000/day
●
99.9% are data reading queries
PGCon 2007
As a solution
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
PGCluster(2002-)
SSyynncchhrroonnoouuss && MMuullttii­­mmaasstteerr RReepplliiccaattiioonn ssyysstteemm
Query based replication
DB node independent data can replicate
●
– now(),random()
No single point of failure
Multiplex load balancer, replication server and cluster DBs.
●
Automatic take over
Restore should do by manually
●
Add cluster DB and replication server on the fly.
Version upgrade as well
●
PGCon 2007
Structure of PGCLuster
clusterDB
Client
Load
session
balancer
replicator
clusterDB
Load
replicator
balancer
Client
session
clusterDB
PGCon 2007
Pros & Cons of PGCluster
EEnnoouugghh HHAA PPeerrffoorrmmaannccee iissssuuee
EEnnoouugghh ppeerrffoorrmmaannccee Very bad for data
writing load
for data reading load
MMaaiinntteennaannccee iissssuuee
CCoosstt
DDooccuummeenntt iissssuuee
Normal PC servers
BSD license SW
PGCon 2007
Demand changes with a time
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
Current requirement
HHiigghh AAvvaaiillaabbiilliittyy
24/7 non stop
HHiigghh PPeerrffoorrmmaannccee
Not only read but write
RReedduuccee ccoosstt
PGCon 2007
Coexistence of HA and HP
HHAA aanndd HHPP ccoonnfflliicctt eeaacchh ootthheerr
HHAA required redundancy
HP required quick response
PPeerrffoorrmmaannccee ppooiinntt ooff vviieeww
Replication scales for data reading (not writing)
Parallel query has effect in both
However it is not easy to add redundancy (HA).
●
Shared Data Clustering also scales for both
However, it is not suitable for large data.
●
Shared Disk needs redundancy.
●
PGCon 2007
Suitable solution for HA and HP
high
Synchronous
replication
Shared data availability
Asynchronous
clustering
replication
Parallel query
low
slow fast
performance
PGCon 2007
Assumption of the performance
write
Request
type
PGCLuster
read
pgpool
small Data instance size large
many Slony
Connection
PGCLuster-II
pgpool-II num
few
PGCon 2007
As a solution
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
What is the PGCluster-II
DDaattaa sshhaarreedd cclluusstteerriinngg ssyysstteemm
Storage data shared by shared disk
NFS,GFS,GPFS(AIX) etc.
●
NAS
●
Cache and lock status shared by Virtual IPC
Detail as following slides
●
PGCon 2007
Concept of Shared Data
Virtual shared IPC
Cluster Cluster Cluster
DB DB DB
Shared Disk
PGCon 2007
Inside of PGCluster-II
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
Virtual IPC
SShhaarree sseemmaapphhoorree aanndd sshhaarreedd mmeemmoorryy dduurriinngg
DDBB nnooddeess
Write it to remote nodes through cluster process
Read it from local node directory
SSiiggnnaall aanndd mmeessssaaggee qquueeuuee aarree oouutt ooff ssccooppee
PGCon 2007
Structure of PGCluster-II
DB node DB node