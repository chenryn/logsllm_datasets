告警记录经过映射和预处理策略处理后，进入去噪策略环节。在去噪环节中，cruxee 采用人工智能算法模型检测并清洗（是否清洗可配置）高频、周期型噪声记录，进一步根据窗口设置将记录收敛为告警。
image::images/cruxee-event-dedup.png[]
==== 高频周期识别模型训练
默认情况下，cruxee 自动使用在线处理的告警记录进行高频周期模型训练，默认训练周期为7天，训练完成后会自动开启高频周期检测功能。训练周期和是否自动开启检测可在 在线模型训练设置 中进行修改配置。
当告警记录已存在训练样本时，也可以使用离线样本数据进行训练，在 离线数据训练设置 中可使用CSV文件上传训练样本，或使用SPL语言从Beaver中搜索训练样本。训练结束后可查看模型训练结果并决定是否使用模型启动检测。
image::images/cruxee-event-dedup-model.png[]
可以点击"最近检测结果"和"训练样本"，在弹层中查看模型在训练和测试阶段识别出的噪声告警源及告警事件数趋势图。
==== 高频周期去噪设置
当高频周期噪声识别模型可用时，支持开启高频周期噪声检测及过滤功能。系统将提取记录中的收敛标识字段内容进行记录聚类，并依据模型检测的结果，将识别为高频周期型的记录去除，从而避免产生大量的低价值告警。高频和周期性敏感度用于调整检测灵敏度，用于对模型检测结果进行微调。
周期噪声支持多种周期粒度配置：
image::images/cruxee/seasonality-granularity.png[]
* 天：以天为粒度进行周期噪音计算，根据周期敏感度，比如一周几天出现
* 小时：以小时为粒度进行周期噪音计算，比如一周有几天的10-11点都出现了某类告警
* 30分钟：以30分钟为粒度进行周期噪声计算，比如一周有几天的10：00-10:30都出现了某类告警
* 15分钟：以15分钟为粒度进行周期噪声计算，比如一周有几天的10：00-10:15都出现了某类告警
==== 抖动告警
可以启动抖动告警识别，并对抖动频率进行配置，比如抖动3次/每小时或每15分钟，从而对告警进行抖动识别。
image::images/cruxee/jitter-alert.png[]
==== 噪声事件
针对高频周期噪声记录以及抖动噪声记录，cruxee支持生成独立的噪声事件。用户开启生成噪声事件时，可自定义配置噪声事件的名称、优先级和发送策略等内容。
image::images/cruxee-event-dedup-incident.png[]
==== 时间窗口收敛
对于原始记录或经过高频周期去噪处理后的记录，系统进一步通过时间窗口进行收敛。系统提取记录中的收敛标识字段内容为依据，为来自同一个告警源的记录选择或新建时间窗口，在时间窗口内的所有记录将只产生一条告警。旧的时间窗口在满足指定条件时自动关闭，新的时间窗口将由新记录触发产生一条新的告警。
此外，时间窗口内如果两条记录间隔过长，也会自动截断窗口，变成两条告警。
=== 合并策略
合并策略是告警alert合并到事件incident的过程。在cruxee中，从告警alert到事件incident合并的主要意义在于将相同根因的告警合并为一个事件，达到告警压降的效果，并提高告警处理的效率。
image::images/cruxee-incident-table.png[]
合并策略没有编号或优先级概念，每一个告警alert都需要尝试匹配每一个合并策略，如果命中某个合并策略，就将该告警加入到已存在的事件incident中或开启新的incident；如果命中多个合并策略，需要将告警添加到或开启新的命中的每一个incident中；如果未命中任何合并策略，则告警不被合并为事件。
新建合并策略可选择：
image::images/cruxee-incident-policy-new.png[]
==== 智能合并策略
智能合并策略可选择几种合并维度：
1）文本相似度
2）拓扑相似度
3）语义相似度
===== 智能合并策略基本配置
image::images/cruxee/incident-smart-merge-basic.png[]
合并策略的属性有：
* 名称：必填。
* 描述：可选。
* 是否启用：默认合并策略新建后立即启用。
* 应用条件：框内是and关系，框外是or关系。当应用条件未配置时，实际应用条件是*。
* 合并条件：可选择文本相似度、拓扑相似度、语义相似度;另外配置告警合并间隔。
** 文本相似度将对告警指定字段的值进行文本相似度计算，相似度达到配置阈值的告警被认为是相同根因告警，合并为同一个incident。如果需要完全字段值相等，可将相似度配置为 100%。
** 拓扑相似度需要在拓扑文件管理中上传拓扑文件，根据告警指定字段的取值识别告警在拓扑中的具体节点，并分析告警之间的相似度，达到阈值的告警被合并到同一个incident。告警之间的相似度，通过计算两个告警在拓扑中的距离计算，相同节点为100%相似，相隔1跳为90%相似，以此类推。
+
在拓扑文件管理页面上，上传或编辑拓扑文件。拓扑文件约定两列，列名分别为 Source 和 Target。
+
image::images/cruxee-incident-topo-upload.png[]
+
** 语义相似度会分析字段语义的相似度，达到阈值的告警被合并到同一个incident中，系统提供了一个简单内置模型，但用户最好对模型基于自己的数据进行模型更新，请参考配置章节中的语义模型。
* 停止条件：停止意味着incident不再接收的alert，新接收的alert进入新创建的incident，但仍可以对已停止的incident进行分配，处理，评论等操作。
** 未收到新告警的时间：在指定时间间隔未收到新的alert时闭合。可选择默认的静态时间窗口或动态时间窗口。当选择动态时间窗口时，如果在最后1/4时间窗口内有新的告警来，则窗口自动延长1/4时间长度（最长不超过原时间窗口长度的3倍）。
** 告警连续不断发送：持续发生超过指定分钟/小时时闭合，默认24小时。例：如需每小时接收到的alert合并为一个incident，则只需设置持续发生超过1小时即可。 
** 最后一条告警的字段：选择字段满足条件后闭合。例：名称中包含OK时闭合。
** 归并的告警数量：incident合并的告警超过输入值后闭合。
===== 事件属性配置
image::images/cruxee-incident-property.png[]
属性配置：可修改 Incident 主标题、副标题、优先级的默认行为。
* 主标题：默认采用 summary 字段值，可以修改为第一个alert或最新一个alert的指定字段值，也可以使用判定为根因的alert的指定字段值，还可以完全自定义成固定文本。
* 副标题：默认采用合并条件，可以修改为第一个alert或最新一个alert的指定字段值，也可以完全自定义成固定文本。
* 优先级：默认采用第一个alert的优先级，前文已经描述。可以修改为最新一个alert的优先级，也可以完全自定义成固定的某个优先级。
===== 自动规则
image::images/cruxee-incident-rule.png[]
当 Alert/Incident 触发自动规则条件时，可以自动进行一些 Incident 操作，而不用等待用户登录后手工操作。合并策略中支持配置多条自动规则。规则的判断条件可选项和闭合条件相同。规则的操作可选项如下：
* 将任务分配给：可选择日志易平台上某个用户账户作为任务的负责人。
* 添加评论内容：可填入一段文本作为任务的新评论。
* 运行事件操作插件：可选择事件操作类型的插件，并按需配置插件的参数项。参数值支持变量渲染。
* 修改状态为：可修改任务状态。注意：即使修改任务状态为'关闭'，依然可能因为未闭合且有新 Alert 进入而被再次打开。
* 修改优先级为：可修改任务优先级。
* 事件属性：可以基于事件属性进行自动规则执行
* 事件未分配： 可以对长时间未分配的事件进行自动规则执行
* 事件未解决/关闭：可以对长时间未解决/关闭的事件进行自动规则执行
注意：原来的关闭条件挪入自动规则中。
image::images/cruxee/cruxee-incident-rule-close.png[]
===== 发送策略
下拉框可选，需要用户先创建发送策略才可以选择。详情请见下一章《发送策略》。
==== 时序合并策略
image::images/cruxee/tempus-config.png[]
===== 时序合并策略基本配置
合并策略的属性有：
* 名称：必填。
* 描述：可选。
* 是否启用：默认合并策略新建后不启用。
* 应用条件：框内是and关系，框外是or关系。当应用条件未配置时，实际应用条件是*。
* 算法配置：
** 查询语句：通过spl语句从beaver搜出历史告警数据
** 更多算法配置
+
image::images/cruxee/tempus-more-config.png[]
*** 时间桶：将告警数据通过时间桶划分为多项集[{告警1、告警2、告警3}、{告警4、告警5}、{告警6}、、、、]
*** 支持度：过滤告警发生频数较低的告警，（告警发生频次较低不具有统计意义）
*** 步长：时间桶滑动步长，一般要小于时间桶，默认为时间桶1/3
*** 置信度：确定告警间是否存在关联关系
*** 社区划分：关闭可能会提高告警压缩率，但降低准确率
*** 语义模型：开启会对tempus合并失败的告警使用语义相似度尝试合并
*** 自动更新：是否对tempus模型进行自动更新
* 停止条件：停止意味着incident不再接收的alert，新接收的alert进入新创建的incident，但仍可以对已停止的incident进行分配，处理，评论等操作。
** 未收到新告警的时间：在指定时间间隔未收到新的alert时闭合。可选择默认的静态时间窗口或动态时间窗口。当选择动态时间窗口时，如果在最后1/4时间窗口内有新的告警来，则窗口自动延长1/4时间长度（最长不超过原时间窗口长度的3倍）。
** 告警连续不断发送：持续发生超过指定分钟/小时时闭合，默认24小时。例：如需每小时接收到的alert合并为一个incident，则只需设置持续发生超过1小时即可。
** 最后一条告警的字段：选择字段满足条件后闭合。例：名称中包含OK时闭合。
** 归并的告警数量：incident合并的告警超过输入值后闭合。