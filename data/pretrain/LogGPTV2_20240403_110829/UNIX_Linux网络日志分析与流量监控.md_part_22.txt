IP
克
---
## Page 126
要进行检查，下面分别以Cisco的PIX防火墙和ASA 为例，分析防火墙日志。
3.3.3防火墙日志分析
出现环路，导致广播风暴。
0029_d4d4_74a3。对于这种报警本书给出了具体查找案例。
兆端口GigabitEthernet1/0/1 下连客户机，发生了IP地址冲突，地址为0029_d4d6_7e08和
登录到名为Quidway_S6500BJ的交换机上，执行了 stp命令（预防环路出现）。
防火墙位于内外网之间的咽喉要道，所有流量都要通过防火墙，这样防火墙对每个包都
0OD0.D0C0.94B0 VLAN 2] From Port xgei_4/2 ToPort gei_6/19 sent by MEC li
例4：
例2：
这是一个MAC漂移的告警信息。
0OD0.D0C0.94B0 VLAN 2] From Port xgei_4/2 To Port gei_6/19 sent by NPC 5ge
例6：
这是中兴交换机上一条VLAN2中IP地址冲突产生的告警。
address 208.80.160.120 conflicts with our IP address of vlan2
例5：
反复出现这种日志，
port4/30
例3：
这条日志表示在Nov2320:30:182010，交换机Quidway_S6500_BJ属于VLAN70的千
detected,sourced by 0029_d4d6_7e08 on GigabitEthernet1/0/1 of VLAN70 and 0029_d4d4_74a3 on
这条日志记录表示一个用户在Nov2222:30:082010，从IP地址为192.168.0.10的设备
GigabitEthernet1/0/1ofVLAN70
command:stp
例1：
08:59:21 05/12/2010 UTC alarm 22780 occurred %MAC% [Module 70] [MAC Table] [MAC
      1 0    00
An alarm 19716 level 6 occurred at 10:16:50 09/01/2010 UTC sent by NPC 2 %ARP% The source IP
An alarm 18710 level 6 occurred at 10:21:10 05/12/2010 UTC sent by MEC 1 %IP% Interface up on
2010 May 12 13:15:41 %SYS-4-P2_WARN: 1/Host 00:50:fd:06:08:c0 is flapping between port 1/2 and
典型症状是CPU利用率非常高，转发几乎停滞，这是因为交换机
出
工
第3章建立日志分析系统103
志日的轴
GMA
G
---
## Page 127
Point防火墙）在受到这种攻击时会停止工作。PIX防火墙检测到这种攻击时记录日志如下：
当发现碎片重叠时产生一条teradroop系统日志：
作用。
了这个例子），所以必须用防火墙处理，用户可以使用 sysopt security fragguard 起到碎片防护
PIX，PIX就会产生如下日志信息：
址部分包含了非法字符，PIX会将非法字符用空格替代。
样一来防火墙可以限制到达邮件服务器的 SMTP 消息、隐藏 SMTP 标题等，如果某个邮件地
这条日志表示：当用户在防火墙上使用了fixupprotocol smtp时就开启了邮件防护功能，这
表示为：
104UNIX/Linux网络日志分析与流量监控
PIX日志是以一个百分号%开始，其后加一个格式化字符串，一条完整的日志信息可以
举例：
攻击者发送的IP数据包如果有很小的偏移或重叠碎片，那么就会绕过IDS（本书讲述
PIX 可以设置 ACL限制用户对任意端口的访问，当某个用户明确禁止的访问到达
2.登录验证失败日志0
接下来看几个例子。
Level：日志级别，说明该日志的严重程度，PIX 日志分为8个级别，从 0~7依次
ASA日志举例如下：
5.CiscoASA防火墙日志格式
LAND攻击是一种针对TCP三次握手漏洞发起的攻击，很多系统（本书列举了Check
4.LAND攻击时记录的日志
address,proto=protocol,id=number
当一个分段数大于12的IP 数据包被防火墙剔除时，PIX产生如下日志信息：
1．邮件防护日志
PIX：设备标识符，
注意：
%PIX 2_106017:DenyIP due toLandAttackfrom IP_address to IP_address
%PIX2_108002:SMTPreplaced string:out source_address in inside_address data:string
%PIXLevel Message_number:Message_text
%PIX_4_106023:Deny protocol src[interfacename:source address/sourceportJdst
，说明日志信息是PIX系列防火墙。
FU.OMSCAPO
TETOBONI
---
## Page 128
不做赘述。
功能来查出ARP病毒的源头，其示意图如图3-6所示。
的网站，但是外部网站可以访问，系统杀毒也无法解决问题。下面就利用路由器的日志记录
ARP 病毒袭击的系统，最常见的现象就是受影响主机上网时断时续，访问不了内部网络地址
3.3.4实战：通过日志发现ARP病毒
DMZLevel 为 50。从优先级低到优先级高的方向为 inbound，反之为outbound，所以数据从
防火墙eth1接口定义为 insdie 区，Security-Level:100，接 Switch 的上联口，中间的
日志格式同上
日志格式：时间--日志编号--连接发起端--协议类型--实际源地址--实际目标地址中
有不少网络运维人员都领教过APR病毒的厉害，目前ARP病毒已经历数十次变种。受
这里假设读者已经对ARP数据报文格式、特征和ARP 病毒的欺骗原理有所掌握，详情
通常Cisco 防火墙 ethO 接口定义为outside 区，Security-Level:0，接 Router FO/0;ASA
注意：
outside:117.18.82.7/123 (117.18.82.7/123) to inside:10.10.1.31/2693(192.168.100.9/59375)Built
“Built inboundTCPconnection"表示该连接是外部的。
注意：
Dec 22 2010 14:03:05:%ASA-6-302013:Built inbound TCP connection 698572247 for
rver
Switch
Gener
Server-2
图3-6Syslog报警示意
Server-3
1
1.发起攻击
2.发送报告
6.查看交换机MAC列
5.毒找对房在格确定作
第3章建立日志分析系统105
应表格确定
3.查看日志
DAM
---
## Page 129
式设定。
系统更新时间（不带日期)。为了便于对日志进行长期的统计和观察，所以选择 datetime 方
项设置：datetime和uptime，datetime是对日志记录采用日期+时间的格式，另一种是采用
是错误的时间，这样很难帮助我们准确判断日志当中记录的事件的具体发生时间。
的一个起始时间，需要手工设定为实际使用的系统时钟，否则系统日志所含的时间戳记录将
cache命令，然后用show arp命令进行查看）。
所以影响在一段时间仍然存在，此时要手动清理路由器的 ARP 列表（执行 arp clear arp-
快速传递数据包。找到这个端口之后就把它关闭，由于ARP列表要过一段时间才能更新，
候，交换机就会把该端口下的计算机MAC地址记录下来，形成MAC地址列表，这样可以
能够确定是这个MAC地址对应的电脑中毒。
告，所以要等到发现有许多报告出现，都是同一个MAC地址企图占用多个IP地址，这时才
告。注意在接收到报告时并不能立即判断这台电脑中毒，因为地址配置错误时也会有这种报
的缓存中有正确的ARP 条目，所以会产生 IP 地址冲突。这个时候路由器会发送一条错误报
管理计算机上安装syslog软件。病毒发作时就会向路由器发送伪造的ARP报文，由于之前
速减少病毒带来的危害。
目标：在网络中查找病毒的源头，封锁它的连接端口以防止它向外扩散，这样才能够快
106UNIX/Linux网络日志分析与流量监控
的。
确定发送病毒计算机的MAC地址之后，我们就要通过这个地址来查找计算机的所在地
路由器中有日志报警功能，我们将它设置为向某一台管理计算机发送报警信息，然后在
这里利用 Service timestamps log命令开启日志时间戳记录功能。命令后面有两种可选
我们需要先进入全局配置模式，打开系统日志时间戳记录功能，具体操作如下：
2）启用系统日志时间戳记录功能。
首先，我们需要设置准确的系统时间。路由器缺省的情况下，系统时间是来自出厂设定
注意：
1）查看路由器的系统时间，并手工设定正确的系统时间。
address 192.168.53.1 on Vlan53,sourced by 0023.8b25.0adf
ARP病毒暴发时的交换机部分日志如下所示：
这个时候我们要查找交换机端口上的 MAC 列表，每一台计算机在通过交换机上网的时
配置路由器步骤如下所示。
address192.168.53.1onVlan53,sourcedby0023.8b25.0adf
由于网络是按照VLAN分段管理，很容易知道出问题的IP网段是属于哪些交换机连接
路由器当中，系统日志的时间配置主要分以下几步：
20101212 083122192.168.254.1-232785:Dec 12 07:12:05:%IP-4-DUPADDR:Duplicate
Router(config)#service timestamps log datetime
20101212 083122192.168.254.1232784:Dec 12 07:12:03:%IP-4-DUPADDR:Duplicate
Enterconfiguration commands,oneperline.EndwithCNTL/Z.
Router#conft
---
## Page 130
各种日志记录。下面具体来设定一下：
Console、Monitor)。
来观察设备运行情况，建议选择一台UNIX服务器作为Syslog Server）。
配置参数：
T-IIV
这里主要设定 buffered，console 以及 monitor 参数，以便在 console 和 telnet 下能够查看
trap：设定日志服务器的日志记录级别。
source-interface：设定和日志服务器通信时的路由器源接口地址。
rate-limit：设定日志记录输出的速率，单位是记录数/s。
on：打开日志记录功能，并将日志输出到所配置的显示方式当中（如 Syslog 服务器、
monitor：设定日志在路由器监视台上的输出特性参数（利用Telnet终端访问路由器）。
history：设定历史日志记录表特性参数（如，历史记录Size，记录输出级别等）。
facility：设定日志对系统信息的记录参数（如，设定利用邮件转发日志、内核记录、
console：设定日志在路由器控制台上的输出特性参数（利用Console口访问路由器）。
buffered：设定路由器日志记录缓存大小。
hostname or..IP address：设定日志服务器地址或名称（如果需要长期记录设备的日志用
参数含义：
最后要设定系统日志记录功能，先进入全局配置模式。利用logging 命令查看日志设定
3）配置系统日志记录功能。
Router(config)#logging buffered?
warnings
notifications
informational
errors
emergencies
debugging
critical
alerts
trapSetsyslogserver logginglevel
source-interface
rate-limit
monitor
history
facility
console
buffered
Hostname or A.B.C.D IP address of the logging host
Router(config)#logging？
Specifyinterfaceforsource addressinlogging transactions
Setmessagespersecondlimit
Enableloggingtoall supporteddestinations
Set terminal line(monitor) logging level
Configure sysloghistory table
Facilityparameterforsyslogmessages
Setconsolelogginglevel
Set buffered logging parameters
告警级日志
注意级（正常但比较重要的消息）
通知级
错误级
致命级（代表系统会不可用）
调试级（调试信息）
关键级日志
警戒级（需要立即处理）
（缓冲区大小）
（日志安全等级）
（报告的一般消息）
第3章建立日志分析系统107
googn
单
080010
(severity=4)
(severity=5)
(severity=6)
(severity=3)
(severity=0)
(severity=7)
(severity=2)
(severity=1)
出
后
---
## Page 131
看，
网方案临时给领导办公室调试好网络，之后和搭档小张开始排查。
过大，并有丢包现象。这在一个千兆办公网络中是不应该发生的。小王用3G 无线WIFI上
确访问速度慢。之后，小王通过自己的终端电脑 Ping 该大楼的接入交换机地址，发现时延
应上网慢，领导的电话也打了过来，问为什么上网这么慢。小王自己也测试了一下，上网的
大，让用户分成多个压缩包上传。可最终还是超时发送失败。与此同时，多个用户打电话反
VLAN.
OA、门户网站、中间件等多种应用服务器，大楼与中心机房之间通过光纤连接，并划分
院的内部网络由一个中心机房和两栋相距90多米的大楼组成。中心机房内有核心交换机和
3.3.5实战：交换机环路故障解决案例
级别为4，命令操作如下：
2147483647，单位为 Bytes，默认值为 4096。这里我们分别配置 buffr 大小为 8192B，输出
依据。
择；默认值是4级。此外，我们可根据需要设定buffered 的大小，范围从 4096～
出的级别为7级，路由器将记录所有0～7级日志信息，具体的设定可根据实际需要来选
上所述，如果设定输出的级别为4级，路由器将记录0~4级的所有日志信息；如果设定输
108UNIX/Linux网络日志分析与流量监控
已经连续运行90多天，故小王首先怀疑为交换机负载太大所致。于是和小张商量在中
一天早上，同一大楼内设计部门的工程师反映上网发不了邮件。起初小王以为是附件过
前面章节介绍过，在Cisco路由器中，将各种日志信息分8个级别，每个级别的含义如
该栋大楼内使用了二十多台接入交换机，上线用户较多，从登录交换机查询工作事件
2.排查交换机）
小王是一家国企设计院的网络工程师，平日里负责维护企业内网的安全工作。这家设计