IE确定文件类型的机制
Mechanism to determine file type of IE
• Content-Type 注册在登录机码?
Content-Type is registered in Registry?
Content-Typeがレジストリに登录されているか
IE确定文件类型的机制
Mechanism to determine file type of IE
• 嗅探内容，并确定文件类型
Sniff content and determine file-type.
コンテンツの内容によってファイルタイプを决定
Content-Type: image/bmp
IE确定文件类型的机制
Mechanism to determine file type of IE
• 网址的副档名, QUERY_STRING
Extension of URL, QUERY_STRING
URLの拡张子, QUERY_STRING
http://example.jp/foo.cgi?param=abc&a.html
http://example.jp/foo.exe?param=abc&a.html
http://example.jp/foo?param=abc&a.html
http://example.jp/foo/?param=abc&a.html
http://example.jp/foo.php?param=abc&a.html
http://example.jp/foo.php/a.html?param=abc
filetype == html
filetype != html
filetype == html
IE确定文件类型的机制
Mechanism to determine file type of IE
• 总之很复杂!
Anyway, Complicated!
とにかく复雑
XSS案例
Case example
https://www.microsoft.com/en-us/homepage/
bimapping.js/a.html?v=&k...
HTTP/1.1 200 OK
Content-Type: text/javascript; charset=utf-8
Date: Wed, 22 Jun 2011 13:53:37 GMT
Content-Length: 2092
var ={"Webtrends":{"enabled":true,"sett
ings":{"interactiontype":{"0":true,"1":true,"2":true,"3":true,"4":t
rue,"5":true,"6":true,"7":true,"8":true,"9":true,"10":true,"11":tr
ue,"12":true,"13"....
"text/javascript" is not registered in Registry
XSS案例
Case example
https://www.microsoft.com/en-us/homepage/
bimapping.js/a.html?v=&k...
HTTP/1.1 200 OK
Content-Type: text/javascript; charset=utf-8
Date: Wed, 22 Jun 2011 13:53:37 GMT
Content-Length: 2092
var ={"Webtrends":{"enabled":true,"sett
ings":{"interactiontype":{"0":true,"1":true,"2":true,"3":true,"4":t
rue,"5":true,"6":true,"7":true,"8":true,"9":true,"10":true,"11":tr
ue,"12":true,"13"....
"text/javascript" is not registered in Registry
IE确定文件类型的机制
Mechanism to determine file type of IE
对策 Countermeasure
• Use "X-Content-Type- Options:nosniff" (only for IE8+)
• Use only well-known Content-Type.
don't use "text/javascript".
第2话 绕过Content-Disposition Header
Bypass 1: Ignoring Content-Type Header
绕过 Content-Disposition Header
Bypass Content-Dispositon Header
Content-Disposition: attachment
• 浏览器的下载指令
Download directive for browsers
ブラウザへのダウンロード指令
• 经常使用于防止 XSS
often uses for preventing for XSS 
XSSを防ぐために使用される。
绕过 Content-Disposition Header
Bypass Content-Dispositon Header
Content-Disposition: attachment
• 攻击者使用特制的JavaScript
绕过‘Content-Disposition: attachment’
Bypass 'Content-Disposition: attachment' with specially 
crafted JavaScript by attacker
攻撃者の细工したJavaScriptにより'Content-Disposition: attachment'を回
避可能
绕过 Content-Disposition Header
Bypass Content-Dispositon Header
攻击者创建的陷阱页面 Trap page by attacker
目标内容与 "Content-Disposition: attachment"
target content with "Content-Disposition: attachment"
绕过 Content-Disposition Header
Bypass Content-Dispositon Header
• 2007年7月在日本悄悄地发表
Published: Jul 2007 in Javap by stealth 
2007年7月に日本でひっそりと公开
• Affected: IE6 / IE7 / IE8
• 无法由伺服器端防止XSS。
No way to prevent XSS by server-side.
サーバ侧でXSSを防ぐ手段はない
第3话 MLang编码转换问题
Episode 3: MLang encode conversion issue
MLang编码转换问题
MLang encode conversion issue
• MLang: 为了支援多语言，包含文字编码转
换功能的DLL
MLang : DLL for multi language support including conversion 
of text encoding. 
MLangは文字エンコーディングの変换机能を含む、多言语サポートのた
めのDLL
– ConvertINetMultiByteToUnicode
– ConvertINetUnicodeToMultiByte
– ConvertINetString
MLang编码转换问题
MLang encode conversion issue
• IE使用MLang处理外部文本与转换Unicode
IE handles text as Unicode from outside with conversion by 
MLang. 
IEはMLangを使って外部からの文字列をUnicodeに変换して処理
Shift_JIS,
EUC-KR,
Big5 …
MLang
UTF-16LE
MLang编码转换问题
MLang encode conversion issue
• 给予已损坏的字节串时
也会尽量转为 Unicode
Converted to Unicode accordingly when given broken byte 
sequence. 
壊れたバイト列を渡したときも、それなりにUnicodeに変换される
• 会产出原字节串不存在的(“<>)
成为XSS可著手处
meta characters ("<>) which don't exist in original byte 
sequence are generated
もとのバイト列に存在しない“"<>”などが生成され、XSSにつながる
MLang编码转换问题
MLang encode conversion issue
...
“0xNN”是无效字节串的字符集 "XXXXX"
"NN" are invalid byte sequence for charset "XXXXX"
MLang编码转换问题
MLang encode conversion issue
• 从伺服器端防止 XSS 问题太麻烦
too hard to prevent XSS  for this issue by server-side. 
サーバ侧でこの问题に対処するのたいへん
• 验证所有字母/字节的字串编码
validate all letters/bytes as the charset encoding
文字エンコーディング として适切か全文字/全バイトを検证
MLang编码转换问题
MLang encode conversion issue
• 现在没有公布细节
Not published for details now. 
现状は详细は非公开
• Affected: IE6, IE7
IE8 : fixed
• 2007 年 10 月 已回报
Reported: Oct 2007
结论
Conclusion
结论 Conclusion
• 有许多方法针对 IE 浏览器实作 XSS
There're many ways to arise XSS only for IE 
IEのみでXSSを発生させる方法がたくさんある
• 特别是很久没有修补漏洞的 IE 6/7
Especially IE6/7. not fixed for a long time.
特にIE6/7。长い间修正されていない。
谢谢! Thanks!
• David Ross and MSRC for helpful suggestions.
• Google Translate for这翻译的文字 ^_^
• … and You!
Thank you for your attention.
任何问题? Question?
• Mail
– PI:EMAIL
– PI:EMAIL
• Twitter
– @hasegawayosuke
• Web site
– http://utf-8.jp/