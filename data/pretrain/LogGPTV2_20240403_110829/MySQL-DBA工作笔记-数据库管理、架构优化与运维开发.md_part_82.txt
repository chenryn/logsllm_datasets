---
## Page 562
540丨MySQLDBA工作笔记：数据库管理、架构优化与运维开发
参考：
或者反馈，通过比较友好的方式推送出去，或者做成打分系统，让这个过程更透明。
以继续改进。
包括审核建议，然后在一定的时间范围内做下对比和跟进，看看哪些建议还不够好，哪些可
据优先度来显示出来。
eror_code，我们可以根据这个error_code 来分级，然后把信息都归类到不同的类别里面，根
提交的字段都有注释，或者设置了默认值，但是我们可以作为改进和建议提出来。
有限等等，这些信息的意义更大，能够尽可能地杜绝潜在的问题。
点提示。
名大小写混合等等，字段名是关键字等。这一类信息就没有什么可商量的，要筛选出来，重
SQL审核规则配置管理
打分系统的使用对于业务来说更加友好，目前对于打分部分的设计有以下几个要点，供
新增规配置
在这个基础上，就可以考虑邮件甚至其他更好地推送方式了。我们可以做一些数据分析
这些信息怎么来映射，其实就和审核服务里的提示信息密切相关，审核服务里面有个
第三类信息是改进建议型信息，比如表字段的注释，可能我们没办法要求所有的开发都
第二类信息是潜在的问题，比如使用了不建议的数据类型（lob）、timestamp 类型的范围
·“必须改进”类型个数如果超过3个，则直接扣除40分；
·三种类型的权重值分数比例为40、30、30；
后期要做的就是我们可以根据审核的建议信息，把这个调用信息做到持久化，包括SQL，
所以我们对这些信息做了下图15-6 所示的配置化操作。
ERWRONG_SUB_KEY
ER_TOO_LONG_KEY
ER_WRONG_KEY_COLUMN
ER_NOT_SUPPORTED_KEY_TYPE
ER_TOO_MANY_KEYS
ER.WRONG_NAME_FOR_INDEX
ER_UDPATE_TOO_MUCH_ROWS
规则编码
指定键“%-.64"太长了最大密钥长度为%d字节。
使用的存储引擎无法索引例“%.192s"”
寿引腺睾不变特糖用过谢型糖分不是学符中,使用的长比素部分长,或者
不支持的key类型："%.64s”。
表“%64”中指定的索引太多，最多允许使用5个索引。
“001-%58S9%
更新行多于%d行。
规则明细
图15-6
销以改进
必质改进
改公10
溢在阿骤5 
在问吨5
规则等级
Search:
15
贝
奇潮
---
## Page 563
主要是意识的培养和习惯的养成。
外的工作量落到 DBA 这边，初期我们也经历了一些使用的落差，但是这段时间不会太长,
动处理，严格来说这是一种伪需求，因为这对提升规范来说没有直接效果，反而会把一些额
提交一个文本，我们自动实现审核，或者粘贴一大段SQL语句包含注释，希望审核程序来自
溃，可以给出通用的语法错误提示。
具本身的健壮性，比如业务同学提交了错误，不符合规范的语句，后端程序处理不能直接崩
这些信息会在审批时明确标识出来，如图15-8所示。
统，如果业务提交的变更打分不到60分，就无法正常提交单据，如果不规范还要强制提交，
的入口，但是实用效果还是有限，怎么把价值发挥出来呢？
15.1.6落地SQL 审核的正确姿势
另外的改进建议则可以根据实际情况来考虑。
我们实践中也碰到了一些意识和习惯使用的差异，很多业务同学希望实现一键审核，即
从目前来看，我们就可以不用关注审核工具的使用情况了，我们需要更关注的是审核工
我们需要把审核工具转正，把它纳入到正式的业务流程中。所以我们后续接入了工单系
要落地SQL审核，只靠我们的热情是不够的，还需要流程的接入。我们开放了自助审核
·如果分数低于50，最低置为50。
·如果为满分100，则扣除1分，提示“满分会怕你骄傲，
·“建议改进”类型个数如果超过8个，
·“潜在问题”类型个数如果超过5个，则直接扣除30分;
表datatype3中的列d_timestop'没有注释。（参考样例：fieldnamefled_typecomment添加注释）
国SQL审核建议-改进建议
列d_fimestart的默认值不合法。（参考样例：fieid_name fleld_typedefault合法的默认值）
表datatype3’中的列dtimestart没有注释。（参考样例：feid_name feld_typecomment添加注释：）
国SQL审核建议-潜在问题
为表datatype3设置一个主键。（参考样例：field_namefield_type primarykey）
SQL审核建议-必须遵守
国跑分结果-83分
图15-7
，则直接扣除30分；
：继续保持";
第15章运维自助化服务|541
开始审核
---
## Page 564
542|MySQL DBA工作笔记：数据库管理、架构优化与运维开发
随着时间的变化，SQL质量有了很大的提升。
效果，对于业务同学来说，通过审核熟悉了规范，同时也积累了SQL 开发经验，达到了双赢。
15.1.7
我们后端会记录下审核的建议信息，下图15-9 所示的结果是我们希望看到的，可以看到
SQL质量的后续跟踪是我们一直在做的事情，在逐步推行的过程中也看到了一些明显的
SQL审核的质量跟踪
授权数
申请原因：
2018-12-06 1208:04
2018-12-06 12:09:22
2018-12-061210:28
2018-12-06 1210:.42
2018-12-06 1212.46
2018-12-06 12.13:06
2018-12-06 121405
2018-12-0612:07:51
2018-12-6 12:144
2018-12-0612:15:47
提交时间
句请以结尾仅支持单条
据库名
提交人部门
创建表结构
语
可提
提交人所在组
图15-9
图15-8
CREATE TABLE
CREATETABLEfie
CREATETABLEles
CREATETABLEfes
CREATE TABLEfles
CREATETABLE'fles
CREATETABLEle
CREATETABLEfies
CREATETABLEprojec
SQL
打分：99分
分数
州
50
9
50
50
9
87
50
操作
---
## Page 565
以做的事情做了下细化，希望能够把一些前置的工作做好边界处理。
15.2.1
会主要根据这两种类型展开。
果做得更深入一些，直接做到自动化执行，那么这个复杂度和技术含量就高了一个等级。
点开页面，然后不断的点击处理。如此一来，整个事情的就没有什么技术含量了。而我们如
是最小的。如果业务同学提交的服务器信息无误，配置无误，那么我们处理的时候无非就是
能够判断这条SQL质量是不错的。如果这是一条create table语句，那么这条语句的影响范围
动化上线是一个持续规划和考量的过程，不能一而就。
同学提了9个问题，其中有4个问题都是和 SQL 自动化上线相关的。
15.2
家不要总是聊“后期如何如何”，而是要先说有没有。
迭代有两个主要结果，一个是从0到1，另外一个是从1到99。对于很多系统建设来说，大
初期来看实现会有难度，但是从源头上把问题解决掉，整个局面就打开了。
15.1.8SQL审核的后续规划
又是双赢的局面。
当然从我的理解来说，是不希望在业务初期就推行自动化上线的，
对于自动化上线来说，我们初期更关注 DDL 方向的 create 和 alter 语句，后续的讲解也
所以要达成一个目标，很多事情的实现不能一而就，要通过不断的迭代。简而言之，
对于自动化流程的梳理主要是从开发同学和运维两个视角来展开的，我们把各个层面可
自动化设计该怎么推行，基石就是SQL审核，如果一条SQL语句的打分在90分，基本
毫无疑问，SQL 自动化上线是开发同学很感兴趣的话题，记得在一次技术交流中，开发
·对接工单流程，通过工单中嵌入自动化审核，如果分数在60分以下警告，分数低
对于DBA来说，如果看到业务对于审核逐步重视，并且作为一种自助服务，彼此提高，
换句话来说，SQL审核的终极目标就是没有审核，一个对标方向就是SQL自动化上线，
·SQL优化工具。
·完善已有的资源：补充SQL开发规范和持续分享；
后续如果继续落地 SQL规范，基本有下面的一些思路：
通用查询；
自动化上线;
提供SQL审核质量分析和数据报告，提供定向建议；
需要标注原因，这样一来，工单的审批才会有理有据；
自动化上线流程设计
SQL自动化上线
，在特定阶段来落地自
第15章运维自助化服务|543
---
## Page 566
544丨MySQL DBA工作笔记：数据库管理、架构优化与运维开发
需求，是完全可以自行选择上线的。
量的落实。
试点，如果 SQL 打分超过 80分，是符合自动化上线要求的，可以通过这种方式督促 SQL 质
写的时候严格规范，我们需要做的就只有条件筛选了，我们可以对指定的SQL类型（create）
自动化上线处理，在处理完成后自动回单，对执行过程的日志进行记录和跟踪。
开发侧提供一些前置检查服务，比如元数据的有效性、SQL 质量、权限检查等。
层面：
通过后续的实践来看，80 分这条线算是保住了 SQL 质量的基线，如果业务同学有紧急
第一层是提交工单，
所以简化来看，
而在运维侧我们需要完善后端的逻辑完整性和处理效率，我们可以使用异步任务来完成
SQL 自动化上线的流程设计如下图15-10所示。对于图中的对象变更工单，
，我们的处理流程大体是下图 15-11 这样的步骤。整体变更主要涉及三个
能够填写好单据是自动化上线的基础，
对象变更工单
工单回执
工单执行
工单审批
图15-10
容错处理次数
执行调度器
L质量
有效性
，如果单据信息比较清晰，填
错误信息记录和提示
校验
检查权限
语句类型
我们可以对
---
## Page 567
度，这样可以把质量问题和效率挂钩起来了。
个效率逐步提升，基本都是秒级的响应，从业务的反馈中，他们可以更关注于自己的业务进
明显，例如，最近的一个需求处理，从任务发起到结束，整个过程持续时间13 秒，后续这
行，把执行结果持久化在表里，可以后续进行结果稽核和分析。整体来说，效率提升会比较
15.2.2
就是工单的自动化处理，则是通过任务调度的方式来触发。
则需要重试执行工单；对于工单自动执行后出现错误，可以通过日志的方式记录下来。另外
是一样的道理。
点的自动化审批，引入工单知晓的功能，把一些审批环节做得薄一些，就跟高速公路的ETC
高效率的，所以我们需要另辟蹊径。可以通过配置的方式来灵活控制权限，或者采用流程节
第三层是工单执行阶段，这里有几个点需要注意，
在完成了第一波自动化上线工作之后，我们采用了异步任务的方式来对接多条SQL的执
这样一来，整个过程都可以做到一个相对轻量级的调用方式，效率也自然就提上来了。
对于 DDL的自动化上线，其实是可行的，尤其是对于create 语句来说。
第二层是工单审批阶段，需要改进的就是审批的环节，传统的审批是无法量化和难以提
自动化上线策略设计
SQL审核
ALTER
CREATE
图15-11
第3步
一个是工单执行过程中如果执行失败，
异步任务
第15章运维自助化服务|545
---
## Page 568
546丨MySQL DBA工作笔记：数据库管理、架构优化与运维开发
实是一件难事，但是从体系设计来看，整体是可控可量化的，如图15-12所示。
加、
个维度：SQL 维度、数据维度和变更维度，通过这几个维度能够梳理出变更的策略。
用结构化思维来梳理，会梳理出一些针对性的变更方案。把整个流程能够串接起来，确
我们常见的 alter 操作的一个基本梳理如下：
（1）SQL维度
自动化上线的策略如何保证可行可控，
·备份表数据：对于数据的备份是应该考虑的，尤其是drop 类的操作；
·备份表结构：可以考虑做成在线或者离线文件的形式；
目前暂定了以下的几类操作方式：
（3）变更维度
●大型表：数据量在100万以上。
●中型表：数据量在10-100万；
●小表：小于10万数据：
目前暂定了下面三个方面，
（2）数据维度
修改、删除）
这些是我们工作中常见的变更 SQL,alter的复杂之处就在于它还包含有一些列的变更（增
alter-rename-col
·alter-rename-table
● alter-drop-col
● alter-change-col
· alter-modify-col
·alter-add-col
动变更。
工具介入变更：有些变更涉及的表比较大的时候，可以考虑使用 pt 工具来完成自
自动变更：自动变更是通用的需求，可以满足大部分的业务场景；
人工介入变更：有些操作我们还是需要人工来介入的，需要协调时间和影响范围：
alter-modify-index
 alter-drop-index
alter-add-index
是自动化上线成败的关键，为此我们需要考虑几
---
## Page 569
多问题，如果开发同学能够提早了解和介入，在问题的处理流程和改进上效果会好很多。
得业务同学不能理解我们在做的事情，包括巡检也是如此。其实恰恰不是，我们巡检后的很
式多于实质。
不重要，但是我们的报告反而把这些放在了最前面、最醒目的地方，最终导致的结果就是形
这种互动很不友好，而系统巡检方向的内容是更加底层的，有些信息对于业务同学来说压根
15.3.1
让别人也提高效率，我们的服务才更有价值。
变为更加主动的自助服务了。简而言之，目标就是让业务同学看得懂的巡检。
也能体现我们工作的深度和广度；这样一来，我们提供的就不是一个黑盒服务，而是可以转
说，难以体现最大价值，或者说得直白一些，业务同学会认为这是DBA 应该做的事情。
我们可以想到内核参数、系统配置、数据库参数配置等。这些巡检工作其实对于业务同学来
15.3业务自助巡检
从另外一个维度上来说，运维中的很多操作对于开发同学来说是一种黑盒的操作，会使
自助巡检设计的初衷就是基于这样的情况，如果换一个角度，在做好本职工作的前提下，
那么业务同学关心哪些指标，我们的巡检是不是也可以换个方式来做，既能服务于业务，
通常节假日之前，DBA 都会对MySQL做一些巡检工作，那么巡检工作该怎么做，当然
一般来说，运维巡检会提出来一些很抽象的报告和一大堆的数据。对于业务同学来说，
业务巡检应该关注什么
alter-change-col
-modiy-inde
lter-n
modify-co
SQL维度
变更维度
自动化上线-Alter思考
图15-12
策略
大型表数据量在100万以上
大型表数据量在100万以上
大型表。数据量在100万以上
中型表数据量在10-100万
第15章运维自助化服务|547
自动变更
备份表结构
人工介入变
工具介入变
自动变更
备份表结构
---