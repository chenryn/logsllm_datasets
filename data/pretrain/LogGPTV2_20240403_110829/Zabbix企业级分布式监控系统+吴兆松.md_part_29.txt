图9-47
Item
web_site_code_status:web.site.codeon {=SITESelectSelect prototype
Function
Last(most recent）Tvalue isNOTN
Last of (T)
uno
120Seconds
200
图9-48
Name
web.site.code{=SITENAME}isnot200
Expression
Add
Multiple PROBLEMevents generation
口
Description
URL
Severity
Not classified
AverageHigh[
Enabled
图9-49
233
---
## Page 250
Zabbix企业级分布式监控系统
设置多梯度告警检测，如图9-50和图9-51所示。
Nameweb.site.code(#SITENAME} is not 200
Add
(web_site_code_status:web.site.code[{=SITEN
AME)].last（(0)}#200
Expression constructor
Multiple PROBLEM events generation
Description
URL
Severity
NotclassifiedInformation
Enabled 
Save
Cancel
图9-50
SeverityName
图9-51
设置不同周期的告警：3分钟、10分钟、15分钟三种不同故障级别的告警，
如图9-52所示。
Severity
Expression
waming
{web site code status:web.site.codef(=S1TENAME)j.last(=3,600)}=200&
web.site.code#SITENAME> in 10 minute is not 200
{web site_codestatus-web.site.codef{=SITENAME)]last(o)}=200
{web site_code statu5web.site.cooef(=SITENAME)]last(=3,900)}=200&
Average
eb.site.code{=SITENAME>in 15minuteisnot200
{web site_code status:web.site.codel1.last(o)}=200
{web site_code status:web.site.code[{=SITENAME}Jlast(=3,120)}=200&
Information
Web.site.code#SITENAME> is not 200
{web sitecodestatus:web.site.code[{=SITENAMEl.last(o))=200
elertadlGnn
图9-52
添加图形，女
如图9-53所示。
Graphprototypes(o)
SeverityName 
Expression
(webodeb.last（=3.600))2008
Warning
{web site code statusweb.stexodel(=SITENAME]last（#3,900))=200&
web.site.code(=SITENAME) jn15 minute is not200
{web site code statusweb.site.codel(=STENAME>]last(o))=200
(web site code statusweb.site.codel[(#SITENAME)].last(=3,120))2008
Information web site.code#SITENAME)is not 200
(web site code stat/weh.ste.cOde[(=SITENAME)].last(O))=200
图9-53
234
---
## Page 251
第9章
Zabbix与自动化运维
单击图9-53 中的 Graph prototypes，出现如图9-54所示的界面。
GraphPreview
Name
web.site.code on(=SITENAME)
Width
Height
200
Graphtype
Normal
Showlegend
working time
Show tnggers
过
Percentile line (left)
Percentil line (nght)
Calculated]
Yaxis MAXvalueCalculated
Items
Nam
Drawstyle
Add
Addprototype
Save
图9-54
继续添加配置图形，如图9-55和图9-56所示。
Key
Name
website.code on(=SITENAME)
web.site.code on(=SITENAME)veb.site.c
Width
900
Height
200
Graphtype
Normal
Show legend
Showworkingtime
Showtriggers
Percentile line(Ieft)
口
Percentile line (nght)
eNIW sIXe
Calculated
YaXisMaXvalue
Calculated
Items
Save
图9-55
Name
web site
codeon =SITEN
width
900
Heght
200
Shiow legend
entile lne (left)
entile line (nght)
Caloulated
Calculated]
Items
Nevre
Function
Wstyle
Dashed ine]
CB0000
AddEdd prototype
图9-56
235
---
## Page 252
Zabbix企业级分布式监控系统
模板创建成功，如图9-57所示。
web site code status
Applications(1)Items(0)Triqgers（O)Graphs（0)
Screens(0)Discovery（1)
图9-57
单击图9-57中的Discover(1)，出现如图9-58的界面。
添加模板到主机，本例选择的主机是Zabbix-Server，如图9-59、图9-60所示。
CONFIGURATION UFUISCOVERY KUEES
Discoveryrules
Displaying 1to 1of 1 found
Name
Items
Triggers
Graphs
Key
web.site.discovery
Itemprototypes(1)
Irigger pratotypes (3)
Graph prototypes (1)
web.site.discovery
Enable selectedGo(o)
图9-58
ZADDIA
oftrioqerprototypes
onfiguration ofgraphsConfigura
Hosts
ng1to1offound
FR
Name
Applications
Items
Triggers
Graphs
Discovery.
Interface
Zabx serverAndications (11)Iems (70) Ingers(43)raphs (11) Discoverv (2) 127.0.0.t: 10050
图9-59
Groupweb_site
Solect
图9-60
查看模板，如图9-61所示，已经成功添加了该模板
HostlistHost:Zabbrx server MonitoredE Aoplicatons(11） 1tems (70)Inagers（
HostTemplatesrpHiMacrosHostinventory
Template App Zabbix ServerUnlink Unlink and cear
Template OS LinuxUnlink Unlink and clear
Unink
Add
Save
Clone
Full choneDelete Cancel
图9-61
236
---
## Page 253
第9章
Zabbix与自动化运维
大约等30秒后，就可以看到刚才添加的三个站点监控，如图9-62和图9-63
所示。
11
LD
storv:ConfigurationefgrachsLatestdataCenfiguraton of hostsCenfigurabon ofgraptsConhguratonfhots
URATION OF GRA
Graphs
Displaving1to14 of 14found
Hot
Host:Zabbix server
Aplicatin(12）Im3）Ies(52)Graphs(14)Divel(3）
Name
empteosun:cpuims
Temste O LCPU103d
Lenslate Os1 nuz: Ceu upizabon
Mounieutiesytemhigoyerr:Diskspaceusage/
Mootedhlettescoer：
ume O51oip:Swaousare
web.site
Neb_st.cliscblery:web.site.codeonwww.weibo.com
Lenpite ARakh Srel Zabbiyraheusane.% lree
LemoiteAppabbiSareer:Zabbixdataathenng proress.buey%
Temoiat=poabbi SererZabbxntemal process busv
图9-62
Graphweb.site.codeonwww.itnihao.com
D
not selected
2013 01 CPU jums
Disk spaceusage/b
Detworktrficonetho
Swapusage
websitecodeonwwwb
图9-63
查看图形数据，如图9-64所示。
graphs Dashbo3
qqeznog
Lorap
回
B201301:50AM
Nav1ath.201302:50AM
200200200200
图9-64
237
---
## Page 254
Zabbix企业级分布式监控系统
至此，前面的任务已经完成，如果我们对web.txt文件增加URL，新的URL
会自动添加到监控。举一反三，同样可以把URL存储到CMDB中，通过网络路
径获取需要监控的URL，只需对脚本进行简单修改即可。
关于Lowleveldiscovery的更多信息，请读者参考以下网址中的内容。
https://www.zabbix.com/documentation/2.2/manual/discovery/low_level_discovery
9.5Zabbix与自动化配置管理工具SaltStack
在实际的生产环境中，会对Zabbix进行大规模的部署、运维和管理，此时，
一套集中的配置管理工具是必需的。自动化部署软件包、管理配置文件等开源的工
具有Chef、Puppet、SaltStack等，本节只介绍SaltStack的安装和配置，其他工具与
之类似。
1.用SaltStack配置管理Zabbix
SaltStack是一个管理配置工具，其作用是为系统管理人员提供标准化的配置
管理和命令执行，架构为C/S（Master/Slave，服务器/客户端）或C/P/S
（Master/Poryx/Slave，服务器/代理/客户端），通信采用证书认证方式，开发语言为
Python，提供API，二次开发较容易，可以运行在多种平台上，其官方网址为
http://www.saltstack.com。中国SaltStack用户组由@绿小小肥建立，网址为
http://www.saltstack.cn。绿肥是SaltStack在中国地区的布道者，对推进SaltStack
在中国地区的发展和在企业中的自动化运维有极大的促进作用。
注意，一般采用自动化运维工具进行的配置管理，其软件安装都应该采用标
准化安装，如RPM包安装，需要有软件仓库。因此，前提是将Zabbix放于指定
的软件仓库中，定制RPM包，相关内容可参考第15章。
2.安装salt-master
#
pel-release-6-8.noarch.rpm
shell# yum install salt-master
安装所需的依赖包如图9-65所示。
alling:
2014.1.0-1.e16
tainfor deendencies:
X86-64
Tibyaml.
X86_64
zeromg3
图9-65
238
---
## Page 255
第9章Zabbix与自动化运维
启动服务
shell# servicesalt-masterstart
shell# chkconfig salt-master on
3.安装salt-minion
shell# yum install salt-minion
配置salt-minion
shell# vim/etc/salt/minion
master: salt-master.itnihao.com
#master的IP或域名
id:zabbix-agent.itnihao.com
#minion的标示
启动服务
shell# servicesalt-minion start
shell# chkconfig salt-minion _on
4.接收客户端密钥申请
在master中配置：查看客户端申请的Key请求，命令为 salt-key-L，如图9-66
所示。
cepted
[root@zabbix-master zabbix]#
图9-66
接受客户端的Key请求，如图9-67所示。
[rootazabbix-master zabbix]# salt-key-a zabbix-agent.itnihao.com
followind
iregoingtobeac
cepted:
ao.cmm
ptedKey
nt.itnihao.com
abbix
ted
图9-67
输入命令salt-key-a zabbix-agent.itnihao.com后按y键（如果是批量接受所有
Key 的请求，可以用命令 salt-key-A)。
5．状态同步文件
状态同步是指将定义好的配置信息同步到客户端主机中，使客户端的资源状
态达到目标状态。
在 salt-master中的配置语句如下。
239
---
## Page 256
Zabbix企业级分布式监控系统
shell#mkdir/srv/salt/#因salt安装好后无/srv/salt目录，所以建立此文件夹
shell# vim /srv/salt/top.sls
base:
I*.itnihao.com':
-zabbix
shell#mkdir/srv/salt/zabbix
shell# vim /srv/salt/zabbix/init.sls
zabbix-agent:
service:
-
-running
watch:
file: zabbix_agentd.conf
- file: zabbix agentd.conf.d
-pkg:zabbix-agentd
require:
-pkg:zabbix-agent
zabbix-agentd:
pkg.installed:
-name: zabbix-agent
-version:'2.2.2-0.el6.zbx
一
skip_verify:True
-skip_suggestions:True
fromrepo: zabbix
-refresh: True
zabbix_agentd.conf:
file.managed:
-name:/etc/zabbix/zabbix_agentd.conf
-source: salt://zabbix/conf/zabbix_agentd.conf
-mode:644
-user:zabbix
一
group: zabbix
template:jinja
zabbix_agentd.conf.d:
file.recurse:
-name: /etc/zabbix/zabbix_agentd.conf.d
source: salt://zabbix/conf/zabbix_agentd.conf.d
一
include_empty: True
-user: zabbix
-group:zabbix
一
dir_mode: 755
一
file mode: 644
scripts:
file.recurse:
-name:/etc/zabbix/scripts
source: salt://zabbix/scripts
include empty: True
-user:zabbix
group: zabbix
dir_mode: 755
- file_mode: 700
整个代码的结构目录如下。
240
---
## Page 257
第9章
Zabbix与自动化运维
/srv/salt/
top.sls
zabbix
conf
zabbix agentd.conf
#zabbix-agent的配置文件
zabbix_agentd.conf.d
#子配置文件
haproxy_host_status.conf
haproxy_main_status.conf
haproxy_status_discovery.conf
init.sls
#salt的状态配置文件
scripts
haproxy_host_status
haproxy_main_status
.0
haproxy_status_discovery
6.执行状态同步
shell# salt
state.highstate
执行结果如图9-68所示。
rsalt]# salt
I0: zabbix_agentd.conf
Function:
/etc/zabbix/zabbix_agentd.conf
Result:
ent: File /etc/zabbix/zabbix_agentd.conf is in the correct state
TruE
s
Funetion:
Resune:
anjn
The directory/erc/zabbix/zabbix_agentd.conf.d is in the correct state
ID: zabbix-ax