攻防演练之柳暗花明⼜⼀村 ⽹络安全
- FreeBuf
⾏业⻔户
某年的某个夏天，某单位需要做攻防演练。
“
某年的某个夏天，某单位需要做攻防演练，⽽且是全仿真的演练，只有客户名，没有任何资产信息。时间
紧，任务重，于是我们兵分两路，⼀波⼈在远程从外围突破，我和另⼀个⼩伙则踏上了旅途，准备从内部来
瓦解。
红蓝对抗中，最爽的事⼉是什么？当然是能直接连⼊⽬标的内⽹。我们进⼊单位后，⾸先就开始搜寻 wifi，
看是否有直接访问内⽹的可能。单位 wifi 应该是给客户临时⽤的，本身没有密码，使⽤⼿机号即可登录。
找了个⻆落，掏出电脑⼀番探测，结果发现访客 wifi 和内⽹完全不通。
没办法，我们只能另想出路。就像《我是谁：没有绝对安全的系统》说的⼀样：“⼈类才是最⼤的漏洞”。单
位这么⼤，⼀定会有⼀些漏⽹之⻥的。于是我们尝试去寻找私搭的 Wi-Fi，使⽤某 wifi 密码探测软件探测，
⾛了两层楼，都没有发现可破解的 wifi。到了三楼，终于发现⼀个提示可连接的。使⽤⼿机连接 wifi 后利⽤
wifi 分享功能得到 wifi 密码。密码强度还是很不错的，如果没有这个 wifi 密码探测软件，等破解出来我们的
项⽬应该已经结束了。
掏出电脑蹲在⻔⼝，开启探测，发现虽然直接获取的是 192 开头的 IP，但实际是能 ping 通内⽹的。刚开始
扫描，就有⾥边的⼯作⼈员出来问我们在⼲嘛，还好我们俩都⻓得⽐较⾯善，蒙混过关，但也不得不撤离
了。
发现不远处有个卫⽣间，但在卫⽣间内，连接的那个 wifi 信号不好，断断续续，只得暂时作罢。继续在楼⾥
搜寻了⼀圈，未发现更多可⽤的 Wi-Fi，决定还是从之前的那个 Wi-Fi ⼊⼿。多年的游戏经验告诉我，遇到
打不过的 boss，氪⾦升级装备可以使你变强。
返回酒店，找公司⼩姐姐请求硬件⽀援，⼩姐姐听了我的需求后，快⻢加鞭的给我邮寄了⼀个⼤型装备过
来，第⼆天收到货后重新返回现场，成功在卫⽣间连上了 wifi，氪⾦的感觉真爽。
有了装备的升级，顺利的连上 wifi 之后，重新扫描。同⼀⽹段的只有开⽹关的 pc，和⼀个看起来像⼿机的
设备。扫描发现，这台 pc 开了 445 和远程桌⾯。先⽤⼀个 top1000 的字典跑远程桌⾯，没成功。接着再
去尝试永恒之蓝漏洞，发现也未能成功，怀疑是打了补丁。
偶然发现那台计算机的名称是叫 **，猜测他的真名叫，然后直接⾕歌找到该单位官⽹，发现有个专家介绍，
由于计算机名是名字全拼，通过专家介绍确定有个叫 *** 的⼯作⼈员过程并没有花费很多时间。
该⼯作⼈员还挺有名，还有百度百科。
⼜经过了⼀番搜索，成功找到了他的⼿机号，之后利⽤他的⼿机号得到了邮箱和 SFZ 信息。通过我们收集到
的信息，组了个字典，再次去爆破远程桌⾯。
没想到竟然成功爆破进去了。看来⽣⽇相关的密码还真的是很多⼈的习惯。
登陆成功后，发现他的浏览器中保存了他们单位多个系统的密码，好⼏个系统都是⽤的他的电话号码或者和
电脑的密码相同。
同时还发现该 pc 安装了 TeamViewer，终于不需要再躲在厕所了，记下远程链接密码就回酒店去了。
凌晨 2 点左右，我直接连上了那台 pc 的 TeamViewer。
我后⾯的⼯作打算都在这台电脑上⾯完成。从他浏览器的⻚⾯发现，他们内⽹的业务系统都在 172.30.0.* 段
上⾯，所以我们开始对这个段做个详细的探测，通过信息收集，发现如下存活主机数量还挺多，同时各种服
务也有不少。
简单的漏洞扫描发现虽然有⼀些开着 445 端⼝的服务器，但都不存在 ms-17-010 漏洞，爆破也就发现⼏个
ftp 弱⼝令。
查看 ftp 没有发现太多有⽤的信息
接着对信息收集得到⼏个 web ⻚⾯进⾏渗透，发现电⼦病历查询系统中存在 SQL 注⼊，判断后得出该注⼊
权限过低，⽆法直接写 shell，放弃该系统。
收集的信息中有⼀个 oa 系统，发现可以爆破
通过爆破进⼊ oa 系统，没有找到可以直接拿到 webshell 的⽅式，但发现存在越权漏洞，可以直接访问到管
理员的配置⻚⾯。
其中⼀个⻚⾯泄露了敏感信息，可以直接显示出数据库和⽤户名
发现数据库都为 sa 权限，思考了⼀下，是否可以通过数据库提权，利⽤获取到的⽤户名和密码成功连接到
数据库，数据库中泄露了不少个⼈信息
通过 XP_CMDSHELL ⽤来执⾏ CMD 命令，使⽤以下命令把 xp_cmdshell 顺利打开，接下来就是执⾏ cmd
命令了
命令执⾏成功
来看看权限，是 mssqlserver 权限，很明显被降权了，查看了其他⼏个数据库也是⼀样的结果，所以这个点
也利⽤不了。
继续寻找突破⼝，在跳板 pc 上发现⼀个护理病历系统，并且发现是登录状态，猜测这个软件应该很多员⼯