志备
：并实现基本的元
在数据库建设
份三个层级，
---
## Page 484
462丨MySQLDBA工作笔记：数据库管理、
应用及推广
自助化服务
建设
监控系统对接和报警管理
数据库高可用和故障
SQL自动化上线模块
DBA工单管理模块
完成系统对接和数据流转，实现数据库流程化管理，自助化服务
数据库巡检模块
通用查询模块
任务调度模块
SQL审核模块
自愈模块
日志模块
完成元数据管理、基础运维模块和备价
架构优化与运维开发
完成相关系统推广
两周
两周
两周
两周
两周
两周
三周
两周
三周
周
享活动，推动技术产品的实践落地
置，实现初步的故障自愈
支持，对于查询结果在MIS中可以鉴权查看或分发
自动化上线
对报警信息优化和改进
对 SQL 审核机制进行完善，对于部分变更 SQL 进行
MIS
设
在 MIS 端接入部分通用功能，在公司内开展技术分
对数据库高可用部署、
对于应用查询需求进行自助化处理，通过 MIS 平台
运维平台和监控系统对接，实现信息统一化标准化，
对多业务工单的拆分和状态管理，进行工单数据分析
实现数据库自动化巡检，发现潜在问题，生成巡检报告
价
实现
恢复流程，
务
任务调度模块建设通过引入开源项目Celery 实现批
中
要涉及系统日志、数据库日志的抽取和可视化建
各的统一管理，通过自定义的调度算法优化已有的
及
SQL审核规范的定制和自助化SQL审核服务
份恢复模块的开发
MySQL
为后续的批量任务接入提供技术基础
慢查询的抽取和分析，集成对接至
、数据库高可用切换和统一配
续表
---
## Page 485
需要做的是一个体系化的管理工作。
方式，对于元数据的标准化和规范化在达成共识的前提下，我们的工作会方便很多。
力不从心。
条信息我们还可以通过手工方式管理，但是如果数据量在上千条以后，会发现管理起来
据是100%正确。
是延迟的，所以经常会发现某个配置的信息会不准确，所以我们从来不敢拍胸脯保证数
修改了我的配置”的情况。
会有大量的备注，但是这种备注别人很难看得懂，如果 Excel丢失基本就歇菜了。
就是Excel，或者在系统中存放一个文本文件。这在管理中勉强够用，但会存在一些缺点：
基础需求。
轮子则是任务调度，通过对接异步任务、定时任务来实现任务的批量下发和文件处理等
13.1
理就会陷入一片混乱。所以万地高楼平地起，元数据的建设是运维系统建设的基石，在
在数据库运维方向也是如此，我们明确了“蛮荒”阶段可能存在的管理混乱之后，
（2）系统中存放一个文本文件统一管理，如果涉及多人同时操作，经常会出现“谁
（3）数据的更新不及时，无论Excel还是统一的文本文件，我们对这些文件的更新都
（1）Excel是个人维护的版本，设计思路就是大一统，为了自己以后能看明白，通常
（5）无论是通过Excel还是文本文件，都存在一个使用的瓶颈，那就是对于几十上百
（4）如果配置变更频率较高，则人工维护的方式就很让人抓狂了。
很多同学可能在工作中已经在初步实践“元数据管理”了，我们大多数使用的方式
运维基础架构中，
有了门，我们可以出去；有了窗，我们可以不必出去。——钱钟书，《围城》
元数据建设
第13章MySQL运维基础架构设计
，元数据建设是重中之重，如果没有统一的标准，整个运维系统管
---
## Page 486
464丨MySQL DBA工作笔记：数据库管理、架构优化与运维开发
方式，这是一种具有行业共识的约定。通过实例维度的建设，
13.1.1
度的信息。
13-1所示。
业务现状进行调整。
13-1所示的几个维度，当然也可以根据自己的
其中各个维度的一些解释和小结如下表
把这些内容做更进一步地提炼，可以总结为下图13-2的所示的思维导图。
对元数据的设计维度，我们可以参考右图
对于这些元数据，如何完成体系化的管理，这是摆在我们面前的另外一个难题，我
相信到了这里，大家对于数据库元数据的维度设计应该有了一个初步的了解。
以上这些维度中需要优先完善的是实例维度，实例可理解为IP（域名）+端口的组合
户信息
元数据维度设计
应用编码管理应用
数据库对象
应用配置信息
维度设计
数据库对象
集群
实例
主机
应用
集群
包含实例的基本信息和中间件节点信息，还有单点实例（无备份，无从库）
元数据设计维度
用户信息、权限信息、数据库信息、数据库明细信息、表明细信息
包含一些服务器配置和信息信息，涉及虚拟环境和其他的主机类型
包含主从信息、高可用集群信息、分布式集群信息
图13-2
表13-1
应用配置信息，应用编码管理
实例
主机
维度解释
单点实例明细
实例明细信息
其他主机资源
宿主机信息
虚拟机信息
元数据设计维度
中间件节点信息
MySQL实例明细
DNS服务器，如consul server
内网测试机器
会不断地完善其他几个维
图13-1
包含负载均衡信息，如LVS
应用
主机
包含高可用VIP信息
数据库对象
实例
集群
---
## Page 487
织起来呢。这里需要引入一个功能：元数据通用查询。
发挥更大的价值。
式集群来说却不需要关联改动。
用集群，如果实例3发生了宕机，那么需要联动的是高可用集群2的信息，而对于分布
式集群和高可用集群的信息组合起来。假设分布式集群的每一组节点都具有独立的高可
含分布式集群和高可用集群的，它们的元数据信息是独立的，又彼此关联，我们把分布
其中的一个环节出现了变化，就会映射到整个元数据体系中。
这样元数据就不是孤立的，也不是单纯的上下游关系，而是一个完整的流程化管理，即
群 A，它所对应的元数据信息应该是下图13-3的关联关系。
例、集群、数据库等。，
13.1.2
一下元数据的关系。
们不妨换一个思路，
同理我们可以从关系图中找到更多的因果关系，通过这种方式把元数据组织起来
我们可以做一个略微复杂的关系图（如图13-4所示），比如集群信息部分，我们是包
如何有效地把几个维度组合起来呢。我们先来看一个元数据的关系，假设有一个集
梳理完了元数据的关系，我们再回到最初的问题，
其实在这个关系图中，我们的目标是根据任意一个维度都可以进行信息的前后关联
刚刚我们明确了元数据建设的重要性，元数据设计是分为了多个维度，有主机、实
元数据关系梳理
，假设数据都存储好了，但这些数据如何组织起来呢，我们先来梳理
图13-3
实例6
实例5
实例4
实例3
，如何有效地把这些元数据信息组
第13章MySQL运维基础架构设计|465
权限信息
数据库信息
用户信息
---
## Page 488
466丨MySQL DBA工作笔记：数据库管理、架构优化与运维开发
家有一个整体的认识。
较局限，因为我们很难去记住每个服务器的实例相关的端口。
关系映射到多个维度，如果使用实例维度，需要输入 IP 和端口，在查询使用中会显得比
把这几类信息都组合起来。通用查询的一个初版页面如下图13-5所示。
刻意做一些冗余设计，这种余设计就会带来数据不一致的潜在隐患。
入口都有具备增删改查的权限，信息管理是割裂的。
足的，每一个维度都有一个专门的入口，比如实例管理、主机管理、集群管理等。每个
维的转换也是不够便捷的。
见。同时因为功能的隔离导致大家在使用过程中会觉得需要在不同维度中切换，这种思
度的数据依赖较大，就会习惯性的只聚焦这个维度的数据，而对其他维度的数据视而不
13.1.3
考虑了诸多因素，最后决定使用主机IP作为查询的一个入口，这样可以通过元数据
至于元数据通用查询的逻辑，我们可以做一下的梳理工作，先给一个全景图，让大
“其次是数据余带来的数据问题，不同的维度中，为了避免数据反复引用，所以会
所以在这里，我的一种建议是化繁为简，只开放元数据通用查询功能，能够有效地
首先带来的问题是元数据的不一致。元数据能够录入，但是修改的时候流程化是不
为什么需要引入这个功能呢，主要是在实践的过程中发现，大家如果对于某一个维
布式集君
元数据通用查询设计
高可用群2
图13-4
实例4
实例6
实例5
主机3
主机2
主机1
#权限信息
表明细信息
数据库信息
---
## Page 489
些复杂度的，我设计了如下的流程图，如图13-6所示，供参考。
的集群信息，集群主要包括基于中间件的分布式集群。
案，则会显示出 MHA 的一些相关配置信息。
问题发生时也方便联系。
制关系。
以得到一个较为清晰的列表，实例基础信息和状态一目了然。
元数据通用查询
“（4）应用列表：根据实例信息得到对应业务的描述信息和业务相关负责人，这样在
（3）主从关系明细：实例间的主从复制关系，可以通过主库或者从库得到完整的复
主从关系明细
howing1to1of 1enties
MysaL
Show10entries
IP明细类型
@查询类型
（6）集群列表：得到实例相关的集群列表，这样可以通过一个节点来得到一个全貌
（5）高可用列表：根据实例信息得到高可用相关的信息，比如高可用使用了MHA方
生库IP
数据库类型
如上的信息是期望通过一个页面实现一站式查询提取，当然要实现这些逻辑还是有
（7）备份恢复列表：实例的备份状态信息，显示近期的备份情况。
（2）实例列表：根据IP信息得到所在服务器的实例列表，对于单机多实例来说，可
实例IP信息
（8）工单列表：显示近期实例相关的工单信息，在业务层面把数据打通。
（1）IP明细信息：服务器的默认IP，多网卡IP，VIP信息等。
通过这个功能我们期望得到如下几个维度的信息：
主库端口
IP地址
从库IP
Search:
从库端口
多网卡IP
图13-5
Showing1to1of1enties
2283
实例列表&管理
ID·
端口状态
应用名称
4306
第13章MySQL运维基础架构设计|467
应用信息
在线
Search:
角色操作
应用负责人
---
## Page 490
468
|MySQL DBA工作笔记：数据库管理、架构优化与运维开发
回虚拟机信息
虚拟机
得到MHA列表
得到实例列表
映射主从关系
得到Master信息
默认IP
Master
判断主机类型
得到主机信息
判断实例类型
返回宿主机信息
得到实例信息
和虚拟机信息
宿主机
得到分布式集群
多网卡IP
得到实例列表
映射主从关系
得到slave信息
列表
Slave
判断IP类型
输入IP信息
其他主机
图13-6
得到MHA信息
返回实例信息
通用业务关注模块
SingleDB
恢复配置
监控信息
应用信息
得到实例列表
得到分布式集群
中间件IP
Slave级联信息
返回Master和
信息
RelayDB
备份记录
工单记录
业务树
其他主机IP
---