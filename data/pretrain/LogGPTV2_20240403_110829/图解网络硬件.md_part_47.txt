3.3.3.254
服务器
网关
互联网
发送源
目的
发送源
目的
地址
地址
地址
地址
12.1.1.1192.168.10.1有效载荷
12.1.1.1
3.3.3.1
有效载荷
转换后的分组
原始分组
例：发送源地址3.3.3.1转换为192.168.10.1。
发送源地址3.3.3.2转换为192.168.10.2。
动态NAT
动态NAT的方式是首先给网关指定一个名为IP地址池（IPaddresspool）的IP地址范围，在
NAT所需会话建立时，地址池内的IP地址将会顺序分配成为转换后的IP地址。由于地址范围能
够由管理员通过设置进行更改，因此该方式应用于需要进行NAT的对象比较多的情况。
虽然和静态NAT类似，私有地址与全局地址存在1对1的映射关系，但是通过动态NAT转换
后的地址不是由管理员设置，而是动态分配的、在IP地址池内排序靠前的有效地址（图5-20）。
图5-20动态NAT的流程
NAT转换表
192.168.1.2-2.2.2.1
192.168.1.1→2.2.2.2
IP地址池
2.2.2.1~2.2.2.10
192.168.1.2
11.1.1.1
2.2.2.254
192.168.1.254
192.168.1.1
192.168.1.3
互联网
网关
客户端
例：将发送源IP地址通过范围是2.2.2.1~2.2.2.10的IP地址池进行转换。
①将第一个到达网关的分组的发送源IP地址192.168.1.2转换为2.2.2.1。
（由于该地址池中最多有10个地址，因此最多允许10个客户端连接到互联网）
---
## Page 278
264第5章防火墙功能与防范威胁的对策
发送源NAT
发送源NAT（SourceNAT）是指对发送源的IP地址进行NAT转换。
位于公司内部网络（私有网络）使用私有IP地址的客户端在作为发送源将数据发送至网关
时，必须将私有IP地址转换为全局地址才能访问外部互联网上的服务器。
与互联网上的服务器进行通信必须使用全局IP地址，但由于IPv4地址处于枯竭状态，因此
无法为互联网上的每台客户端都分配一个全局IP地址。而在大多数情况下，发送源NAT能够通
过动态NAT方式节约全局IP地址资源，因此通过在网关上设置地址池，或者在网关的网络接口
处使用NAPT（后文会介绍），也可以实现从私有网络访问互联网的功能。
由于从外部网络只能查询全局地址信息，因此发送源NAT还能够隐藏客户端实际分配到的
IP地址，从而降低直接受到外部网络攻击的风险。而且通常是由网关来完成NAT转换工作，因
此访问控制列表的管理也变得非常简单（图5-21）。
图5-21发送源NAT的流程
NAT转换表
192.168.1.1-2.2.2.1
192.168.1.2→2.2.2.2
11.1.1.1
192.168.1.1
2.2.2.254
192.168.1.254
互联网
网关
（客户端
发送源
目的
发送源
目的
地址
地址
地址
地址
2.2.2.111.1.1.1
有效载荷
192.168.1.1
11.1.1.1
有效载荷
转换后的分组
原始分组
目的地NAT
目的地NAT（DestinationNAT）是指对发送目的地的IP地址进行NAT转换。
位于互联网等公司外部网络的客户端，想要通过网关访问位于公司内部网络的服务器时，需
要进行目的地NAT。由于公司内部服务器一般使用分配好的内网地址，因此无法从互联网直接
路由到。这时，网关可以作为该内部服务器的代理，定义全局地址，并将来自外部网络的客户端
访问转移到该全局地址上。网关接收到目的地为全局地址的分组后，将该分组的目的地址再转换
为内部服务器所拥有的实际私有地址，从而完成路由。公司内部的服务器通常会放置在DMZ区
域中（图5-22）
---
## Page 279
05.07防火墙中搭载的各种功能|265
图5-22
目的地NAT的流程
NAT转换表
3.3.3.1192.168.10.1
3.3.3.2-192.168.10.2
12.1.1.1
192.168.10.1
192.168.10.254
3.3.3.254
互联网
网关
客户端
发送源
目的
发送源
目的
地址
地址
地址
地址
12.1.1.1192.168.10.1有效载荷
12.1.1.1
3.3.3.1
有效载荷
转换后的分组
原始分组
NAPT/IP伪装/PAT
当只能使用1个全局地址同外部网络进行通信，或者可用的全局地址少于内部网络的客户端
数量时，网关无法完成私有地址和全局地址的1对1分配。
这种情况下，网关需要结合使用TCP或UDP端口号，完成将多个私有地址映射成1个全局
地址的转换（图5-23）。
图5-23
NADT/IP伪装/PAT的流程
NAT转换表
X10001和10002表示发送源端口号
192.168.10.1→4.4.4.1:10001
192.168.10.24.4.4.1:10002
192.168.10.1
12.1.1.1
192.168.10.254
4.4.4.1
192.168.10.2
服务器
192.168.10.3
互联网
网关
发送源
发送源目的地
发送源
目的
目的发送源目的地
地址
地址
口
地址
地址
口
口
口
4.4.4.112.1.1.1
1000180有效载荷
192.168.10.1
4.4.4.13211180有效载荷
转换后的分组
原始分组
发送源
目的发送源目的地
发送源
目的发送源目的地
地址
地址
口
端口
地址
地址
口
端口
12.1.1.14.1.1.18010001
有效载荷
12.1.1.1192.168.10.18032111
有效载荷
返回的分组
原始分组
---
## Page 280
266第5章防火墙功能与防范威胁的对策
这种转换方式称为NAPT（NetworkAddressPortTranslation，网络地址端口转换），是动态
NAT的一中，在Linux中称为IP伪装（IPMasquerade），在一部分网络硬件中也称为PAT（Pori
AddressTranslation，端口地址转换）、NAT重载（NAToverloading）、单一地址NAT或端口级
NAT复用等。
■MIP与VIP
Juniper公司的ScreenOs中还使用了MIP（MappedInternetProtocol，映射网络协议）和VIP
（VirtualInternetProtocol，虚拟网络协议）两个NAT术语。
MIP是指将1个IP地址映射成另1个IP地址（1对1分配），同静态NAT类似，主要用于
目的地NAT转换。
VIP则是基于目的地端口号的静态NAT。
ScreenOS中动态NAT所使用的IP地址池称为DIP（DynamicIPPool，动态IP池）。
05.07.06.VPN
VPN（VirtualPrivateNetwork）的意思是虚拟私有网络?。所谓的私有网络是指使用私有
IP地址、位于组织内部的网络，即Intranet。而VPN则是使用公共互联网或者电信运营商提供的
公共网络，廉价构建Intranet的技术。
位于Intranet中的管理数据、人事信息、技术信息等对于外部而言属于机密的信息，必须在
建。但如果有类似于东京总部和大阪分部这类跨地理位置的分支机构时，就不得不在这些地理位
置不同的办公场所之间完成Intranet的构建与连接。对于这类情况，在上世纪90年代之前，是
通过签约、租用电信运营商提供的“专线”服务来完成Intranet构建的。顾名思义，这个“专线”
是属于租用方单独使用的线路，因此在专线内不会出现其他公司的数据，也无需担心第三方对
该专线中的数据进行窃听，通信质量也能得到保障。但是专线的月租费用很高，尤其是带宽为几
Mbit/s以上的广域网线路，租用费用更是不罪。
1995年左右，与互联网的连接开始通过使用廉价终端适配器的ISDN进行。2000年左右，
随着ADSL这种互联网接人服务的普及，使用广域网接人互联网的成本越来越低，利用互联网
来构建组织内部Intranet节点的做法也开始体现出很强的成本优势。
这一时期，路由器、防火墙、VPN专用装置都可以支持IPsec-VPN功能，在各个节点之间
使用这些设备创建IPsec隧道并进行连接，就可以完成VPN的构建（这一时期将支持IPsec-VPN
①或虚拟专有网。——译者注
---
## Page 281
05.07防火墙中搭载的各种功能|267
的设备统称为VPN装置）。
根据拓扑对VPN分类
·站点间VPN
站点间VPN（site-to-siteVPN）是在两个网络之间通过IPsec隧道进行连接的拓扑结构。在每
个网络的网关中都设有路由器或防火墙等VPN装置，二者之间也建有IPsec隧道。两个VPN装
置之间使用的是点对点的拓扑结构（图5-24）。
图5-24站点间VPN的组成
PC-A
PC-A
IPsec隧道
互联网
PC-X
PC-X
VPN装置
（路由器、专用设备等）
网络A
网络A
（SiteA：ex东京总部）
（SiteA：ex.名古屋分部）
这里提到的网络是指位于东京的总部网络或者位于名古屋分部的任意站点中的网络。因为是
站点（site）之间的连接，所以称为站点间VPN。
·中心辐射型VPN
中心辐射型VPN（hubandspokeVPN）是星形拓扑结构，即将1个中心站点的硬件同多个远
程站点的硬件连接而构成的结构（图5-25）。中心站点（centersite）放置总部的网络与数据中心，
成为整个组织的核心站点。该拓扑结构同自行车的飞轮和辐条组成的结构类似，因此命名为hub
andspokeVPN。该类型VPN一般用于服务供应商提供的VPN业务，以服务供应商的基础设施
为中心站点，通过VPN连接整个组织的其他站点。
---
## Page 282
268|第5章防火墙功能与防范威胁的对策
图5-25
中心辐射型VPN的组成
PC
PC
PC
PC
中心站点
VPN装置
ex.东京总部
IPsec隧道
IPsec隧道
互联网
VPN装置
VPN装置
PC
PC
PC
PC
远程站点A
远程站点B
ex.名古屋分部
ex.名古屋分部
·远程接入型VPN
用户使用个人计算机上的软件，在家中或在外出时经由互联网与公司的VPN装置建立IPsec
隧道，进而访问公司内部服务器的拓扑结构称为远程接入型VPN（图5-26）。
远程接入型的IPsec-VPN子类型需要实现中，个人计算机安装VPN客户端软件，而SSL-
VPN子类型则是通过Web浏览器使用SSL连接至公司的VPN，通过SSL（HTTPS）连接与公司
内部服务器进行交互。
---
## Page 283