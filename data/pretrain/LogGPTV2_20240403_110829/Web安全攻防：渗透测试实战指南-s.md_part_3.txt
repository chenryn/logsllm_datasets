.233
5.8.1操作系统后门
.233
5.8.2Web后门
..237
5.9内网攻击域渗透测试实例.
.242
5.9.1
介绍渗透环境
.242
5.9.2提升权限
.242
5.9.3信息收集
..245
5.9.4获取一台服务器的权限
.247
5.9.5
PowerShell寻找域管在线服务器
..251
5.9.6
获取域管权限
.252
5.9.7
登录域控制
..254
5.9.8
SMB爆破内网
..257
5.9.9清理日志
.259
第6章PowerShell攻击指南
... 261
6.1PowerShell 技术
..261
---
## Page 18
目录4XVII
6.1.1PowerShell 简介
.261
6.1.2PowerShell的基本概念
.263
6.1.3PowerShell的常用命令。
.264
6.2 PowerSploit...
.266
6.2.1PowerSploit 的安装
.266
6.2.2PowerSploit脚本攻击实战
.268
6.2.3PowerUp攻击模块讲解
.275
6.2.4PowerUp攻击模块实战演练
.284
6.3 Empire.
.291
6.3.1
Empire简介
..291
6.3.2
Empire的安装
.292
6.3.3
设置监听
.293
6.3.4
生成木马，
..296
6.3.5
连接主机及基本使用
.306
6.3.6
信息收集
..310
6.3.7
权限提升，
.319
6.3.8
横向渗透
..324
6.3.9后门..
330
6.3.10Empire 反弹回 Metasploit.
.333
6.4Nishang
.334
6.4.1 Nishang 简介
.334
6.4.2Nishang 模块攻击实战。
..338
6.4.3PowerShell隐藏通信遂道
.343
6.4.4
WebShell 后门.
.347
6.4.5
权限提升。
.348
第7章实例分析
364
7.1代码审计实例分析.
.364
7.1.1SQL注入漏洞
.364
---
## Page 19
XVIllWeb安全或防：渗透测试实战指南
7.1.2文件删除漏洞
.366
7.1.3文件上传漏洞，
.367
7.1.4添加管理员漏洞
.373
7.1.5竞争条件漏洞
.378
7.2渗透测试实例分析.
.380
7.2.1后台爆破
.380
7.2.2 SSRF+Redis 获得 WebShell
.383
7.2.3旁站攻击
.388
7.2.4重置密码
.391
7.2.5SQL注入
.393
---
## Page 20
第1章渗透测试之信息收集
进行渗透测试之前，最重要的一步就是信息收集，在这个阶段，我们要尽可能
地收集目标组织的信息。所谓“知己知彼，百战不殆”，我们越是了解测试目标，测
试的工作就越容易。在信息收集中，最主要的就是收集服务器的配置信息和网站的
敏感信息，其中包括域名及子域名信息、目标网站系统、CMS指纹、目标网站真实
IP、开放的端口等。换句话说，只要是与目标网站相关的信息，我们都应该去尽量搜
集。
1.1收集域名信息
知道目标的域名之后，我们要做的第一件事就是获取域名的注册信息，包括该
域名的DNS服务器信息和注册人的联系信息等。域名信息收集的常用方法有以下这
几种。
1.1.1Whois查询
Whois是一个标准的互联网协议，可用于收集网络注册信息，注册的域名、IP地
址等信息。简单来说，Whois就是一个用于查询域名是否已被注册以及注册域名的详
细信息的数据库（如域名所有人、域名注册商）。在Whois查询中，得到注册人的姓
名和邮箱信息通常对测试个人站点非常有用，因为我们可以通过搜索引擎和社交网
络挖掘出域名所有人的很多信息。对中小站点而言，域名所有人往往就是管理员。
在Kali系统中，Whois已经默认安装，只需输入要查询的域名即可，如图1-1所示。
---
## Page 21
Web安全攻防：渗透测试实战指南
WHOIS
et.cr
Creat1om Date:2015-11-30T08:45:51Z
Date:2017-11-30T08:45:51Z
IANAID:420
PI:EMAIL
Name Server:DNS9.HICHINA.COM
图1-1 Kali下的Whois查询
在线Whois查询的常用网站有爱站工具网（https:/whois.aizhan.com）、站长之家
（http:/whois.chinaz.com）和VirusTotal（https://www.virustotal.com），通过这些网站
可以查询域名的相关信息，如域名服务商、域名拥有者，以及他们的邮箱、电话、
地址等。
1.1.2备案信息查询
网站备案是根据国家法律法规规定，需要网站的所有者向国家有关部门申请的
备案，这是国家信息产业部对网站的一种管理，为了防止在网上从事非法的网站经
营活动的发生。主要针对国内网站，如果网站搭建在其他国家，则不需要进行备案。
常用的网站有以下这两个。
。ICP备案查询网：http://www.beianbeian.com。
天眼查：http://www.tianyancha.com。
1.2收集敏感信息
Google是世界上最强的搜索引擎之一，对一位渗透测试者而言，它可能是一款绝
佳的黑客工具。我们可以通过构造特殊的关键字语法来搜索互联网上的相关敏感信
息。下面列举了一些Google的常用语法及其说明，如表1-1所示。
---
## Page 22
第1章渗透测试之信息收集
表1-1Google的常用语法及其说明
关键字
明
Site
指定城名
Inurl
URL中存在关键字的网页
_Intext
网页正文中的关键字
Filetype
指定文件类型
Intitle
网页标题中的关键字
link
Iik:baidu.com即表示返回所有和baidu.com做了链接的URL
Info
查找指定站点的一些基本信息
cache
搜索Google里关于某些内容的缓存
举个例子，我们尝试搜索一些学校网站的后台，语法为“site:edu.cnintext:后台
管理”，意思是搜索网页正文中含有“后台管理”并且域名后级是edu.cn的网站，搜
索结果如图1-2所示。
Google
批 193,996 录H5R (R 0.40 6)
欢迎登录后台管理系线
网站管理后台
ftl: 010-61854321.
后台管建系统
欢迎登录后台管理系统，MCLab
欢迎登录后台管理系统
8. crm
图1-2搜索敏感信息
可以看到利用Google搜索，我们可以很轻松地得到想要的信息，还可以用它来收
集数据库文件、SQL注入、配置信息、源代码泄露、未授权访问和robots.txt等敏感信
息。
---
## Page 23
Web安金或防：渗遗测试实战指南
当然，不仅是Google搜索引擎，这种搜索思路还可以用在百度、雅虎、Bing、
Shodan等搜索引擎上，其语法也大同小异。
另外，通过Burp Suite的Repeater功能同样可以获取一些服务器的信息，如运行的
Server类型及版本、PHP的版本信息等。针对不同的Server，可以利用不同的漏洞进
行测试，如图1-3所示。
beeu
HsMeder
1
图1-3服务器的配置信息
除此之外，也可以尝试在GitHub上寻找相关敏感信息，如数据库连接信息、邮
箱密码、uc-key、阿里的osskey，有时还可以找到泄露的源代码等。
读者可以通过乌云漏洞表（https:/wooyun.shuimugan.com）查询历史漏洞信息。
1.3收集子域名信息
子域名也就是二级域名，是指顶级域名下的城名。假设我们的目标网络规模比
较大，直接从主域入手显然是很不理智的，因为对于这种规模的目标，一般其主域
都是重点防护区域，所以不如先进入目标的某个子域，然后再想办法迁回接近真正
的目标，这无疑是个比较好的选择。那么问题来了，怎样才能尽可能多地搜集目标
的高价值子域呢？常用的方法有以下这几种。
1.子域名检测工具
用于子域名检测的工具主要有Layer子域名挖掘机、K8、wydomain、Sublist3r
---
## Page 24
第1章渗透测试之信息收集
dnsmaper、subDomainsBrute、MaltegoCE等。笔者重点推荐Layer子域名挖掘机、
Sublist3r和lsubDomainsBrute.
Layer子域名挖掘机的使用方法比较简单，在域名对话框中直接输入域名就可以
进行扫描，它的显示界面比较细致，有域名、解析IP、CDN列表、Web服务器和网站
状态，如图1-4所示，这些对安全测试人员来说非常重要。
P LeyeFA29
Ma:i-tha
(80 40)
：9：全口
121 185 112.0.0.11.2 10.11.10.1.283.11.8.20.34
BEAR
10.10.131.3
imf.4.1
图1-4Layer子域名挖掘机
subDomainsBrute的特点是可以用小字典递归地发现三级域名、四级域名，甚至
五级域名等不容易被探测到的域名。执行该工具的命令如下所示。
python subDomainsbrute.py xoxx.con
Sublist3r也是一个比较常用的工具，它能列举多种资源，如在Google、Yahoo、
Bing、Baidu和Ask等搜索引擎中可查到的子域名，还可以列出Netcraft、VinusTotal、
ThreatCrowd、DNSdumpster和Reverse DNS查到的子域名，
2.搜索引等枚举
我们可以利用Google语法搜索子域名，例如要搜索百度旗下的子域名就可以使用
“site:baidu.com”语法，如图1-5所示。
---
## Page 25
Web安金政防：渗造测试实战指南
Google
百度际造：全国大中文重动尚售平台
球最大助中文壮区
全球量大的中文新用平台
西西科_全路大中文西科全书
图1-5用Google搜索子域名
3.第三方聚合应用枚举
很多第三方服务汇聚了大量DNS数据集，可通过它们检索某个给定域名的子域
名。只需在其搜索栏中输入域名，就可检索到相关的域名信息，如图1-6所示。
Sibling Domains 0
nhgooenbasde4r
9003449s00r
@do
agoe
Ap2s
图1-6查询百度的子城名
---
## Page 26
第1章渗透测试之信息收集7
读者也可以利用DNSdumpster网站（https://dnsdumpster.com/）、在线DNS侦查和
搜索的工具挖掘出指定域潜藏的大量子域。
4.证书透明度公开日志枚举
证书透明度（CertificateTransparency，CT）是证书授权机构（CA）的一个项目，
证书授权机构会将每个SSL/TLS证书发布到公共日志中。一个SSL/TLS证书通常包含
域名、子域名和邮件地址，这些也经常成为攻击者非常希望获得的有用信息。查找
某个域名所属证书的最简单的方法就是使用搜索引擎搜索一些公开的CT日志。
笔者推荐cert.sh：https://crt.sh和censys:https/censys.io这两个网站，下面展示了一
个crt.sh进行子域名枚举的例子，如图1-7所示。
00401813-041
图1-7子域名枚举
此外，读者还可以利用一些在线网站查询子域名，如子城名爆破网站
(https://phpinfo.me/domain），IP反查绑定城名网站（http://dns.aizhan.com）等。
1.4收集常用端口信息
在渗透测试的过程中，对端口信息的收集是一个很重要的过程，通过扫描服务
器开放的端口以及从该端口判断服务器上存在的服务，就可以对症下药，便于我们
渗透目标服务器。
所以在端口渗透信息的收集过程中，我们需要关注常见应用的默认端口和在端
口上运行的服务。最常见的扫描工具就是Nmap（具体的使用方法后续章节会详细介
绍），无状态端口扫描工具Masscan、ZMap和御剑高速TCP端口扫描工具，如图1-8