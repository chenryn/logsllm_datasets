Discover	
  Flash	
  Player	
  Zero-­‐day	
A4acks	
  In	
  The	
  Wild	
  From	
  Big	
  Data 
Peter	
  Pi	
@heisecode 
Agenda 
•  Who	
  am	
  I	
•  Background	
•  Discover	
  ﬂash	
  0-­‐day	
  a4acks	
  from	
  big	
  set	
samples	
•  Vector	
  Length	
  miGgaGon	
About	
  me 
•  Security	
  researcher	
•  APT	
  product	
  developer	
•  Interested	
  in	
  discovering	
  vulnerabiliGes	
  and	
wriGng	
  exploit.	
•  Focus	
  on	
  Flash	
  and	
  Android	
  recently. 
WAR3	
  &	
  Ping	
  Pong	
  Hobbyist 
Found	
  CVE-­‐2015-­‐0313	
  ﬂash	
  0-­‐day	
  a4ack 
CVE-­‐2015-­‐5122	
  &	
  5123	
  from	
  hacked	
  team 
Found	
  some	
  newly	
  patched	
  ﬂash	
  a4ack 
My	
  Blog	
  address 
•  h4p://blog.trendmicro.com/trendlabs-­‐
security-­‐intelligence/author/peterpi/	
•  Will	
  publish	
  some	
  Android	
  bugs	
  I	
  found.	
Agenda 
•  Who	
  am	
  I	
•  Background	
•  Discover	
  ﬂash	
  0-­‐day	
  a4acks	
  from	
  big	
  set	
samples	
•  Vector	
  Length	
  miGgaGon	
Flash	
  Year 
•  Because	
  of	
  browsers’	
  UAF	
  miGgaGons	
  and	
JAVA	
  pop-­‐up	
  window,	
  Flash	
  Player	
  became	
the	
  weakest	
  out	
  of	
  popular	
  targets	
  in	
  PC.	
Flash	
  Year 
•  Finally,	
  we	
  can	
  see	
  that	
  Zero-­‐day	
  a4acks’	
targets	
  are	
  mostly	
  Flash	
  Player	
  in	
  2015	
  >	
  CVE-­‐2015-­‐0310	
  >	
  CVE-­‐2015-­‐0311	
  >	
  CVE-­‐2015-­‐0313	
  >	
  CVE-­‐2015-­‐3043	
  >	
  CVE-­‐2015-­‐3113	
  >	
  CVE-­‐2015-­‐5119	
  >	
  CVE-­‐2015-­‐5122	
Flash	
  Year 
•  Newly	
  patched	
  N-­‐day	
  a4acks	
  in	
  Exploit	
  Kits	
this	
  year	
  almost	
  are	
  based	
  on	
  Flash	
  Player	
vulnerabiliGes.	
  >	
  CVE-­‐2014-­‐8439	
  >	
  CVE-­‐2014-­‐9163	
  &	
  CVE-­‐2014-­‐9162	
  >	
  CVE-­‐2015-­‐0336	
  >	
  CVE-­‐2015-­‐0359	
  >	
  CVE-­‐2015-­‐3090	
  ….	
  …. 
Flash	
  Year 
•  In	
  this	
  situaGon,	
  I	
  wanted	
  to	
  disclose	
  Flash	
  0-­‐
day	
  a4acks	
  when	
  tried	
  to	
  guess	
future	
  perspecGve	
  in	
  late	
  2014.	
•  Disclose	
  newly	
  patched	
  n-­‐day	
  a4acks	
  also	
  has	
value	
  to	
  users. 
Background 
•  Got	
  tens	
  of	
  millions	
  of	
  suspicious	
  SWFs	
  in	
  our	
Hadoop	
  server,	
  and	
  thousands	
  newly	
  added	
every	
  day.	
•  I	
  think	
  this	
  is	
  a	
  good	
  resource	
  to	
  ﬁnd	
  0-­‐day	
a4acks	
•  So,	
  this	
  topic	
  Gtle’s	
  big	
  data	
  is	
  a	
  trick,	
  and	
  not	
related	
  to	
  data	
  mining	
  or	
  machine	
  learning	
  J	
Agenda 
•  Who	
  am	
  I	
•  Background	
•  Discover	
  ﬂash	
  0-­‐day	
  a4acks	
  from	
  big	
  set	
samples	
•  Vector	
  Length	
  miGgaGon	
Problem	
  I	
  face 
•  Big	
  set	
  samples	
  to	
  handle.	
•  I	
  need	
  a	
  automaGon	
  process.	
•  It	
  can	
  achieve	
  very	
  low	
  False	
  Alert	
  rate,	
  fast	
processing	
  speed.	
•  Final	
  manual	
  check	
  only	
  needs	
  handle	
  li4le	
Flash	
  samples.	
Need	
  a	
  tool 
•  I	
  need	
  a	
  tool	
  to	
  help	
  me	
  idenGfy	
  a	
  SWF	
  ﬁle	
  can	
exploit	
  target	
  version	
  of	
  Flash	
  Player.	
  >	
  This	
  tool	
  must	
  have	
  very	
  low	
  False	
  Alert.	
  >	
  This	
  tool	
  must	
  have	
  logger	
  for	
  improving	
  automaGon.	
  >	
  This	
  tool	
  must	
  can	
  record	
  exploit	
  event	
  when	
  detect.	
  >	
  This	
  tool	
  must	
  can	
  stop	
  the	
  exploit. 
FlashExploitDetector(FED) 
•  FED	
  is	
  an	
  IE	
  BHO	
  wri4en	
  by	
  C++	
•  Dynamic	
  hook	
  Flash	
  OCX	
  when	
  Flash	
  Player	
loaded	
  to	
  IE	
  tab	
  process.	
•  Hook	
  IE	
  event	
  to	
  get	
  current	
  URL	
  name.	
•  Write	
  log	
  to	
  ﬁle	
  when	
  detect,	
  it	
  will	
  save	
  the	
Gme	
  and	
  the	
  SWF/URL	
  name.	
•  Inﬁnite	
  loop	
  when	
  detect	
  exploit,	
  waiGng	
  for	
automaGon	
  process	
  to	
  kill	
  IE	
  and	
  conGnue	
next	
  SWF	
  ﬁle.	
AutomaGon	
  Process 
•  Simple	
  Python	
  code.	
•  Register	
  FED	
  BHO	
  using	
  regsvr32.exe	
•  Every	
  Gme	
  load	
  a	
  HTML	
  contains	
  SWF	
  in	
  IE	
•  FED	
  will	
  hook	
  Flash	
  Player	
  OCX	
  to	
  detect	
exploit	
•  Kill	
  IE	
  processes	
  to	
  load	
  next	
  SWF	
  ﬁle	
  in	
  new	
  IE	
•  When	
  ﬁnished	
  all	
  SWF	
  ﬁles,	
  parse	
  log	
  ﬁle	
  and	
get	
  the	
  detected	
  SWF	
  ﬁles. 
Key	
  Point 
•  How	
  to	
  achieve	
  extremely	
  low	
  False	
  Alert	
rate?	
  There	
  are	
  match	
  points	
  in	
  the	
  ﬂow	
  of	
exploit.	
  1.	
  Match	
  vulnerability	
  triggers?	
  This	
  means	
  one	
  vulnerability	
one	
  rule,	
  no	
  use	
  here,	
  discard	
  2.	
  Match	
  Vector	
  Heap	
  Spray?	
  This	
  is	
  good,	
  but	
  FA	
  is	
  sGll	
  high	
for	
  this	
  special	
  problem,	
  for	
  example	
  old	
  samples	
  will	
  trigger	
vector	
  heap	
  spray	
  also.	
  And	
  0-­‐day	
  may	
  no	
  need	
  heap	
spray(CVE-­‐2015-­‐5119)	
  3.	
  Match	
  ROP	
  and	
  Shellcode	
  execuGon	
  stage?	
  It	
  is	
  like	
  EMET.	
But	
  EMET	
  is	
  hard	
  to	
  automaGon,	
  can’t	
  record	
  the	
  ﬁle	
  name,	
  0-­‐
day	
  may	
  bypass	
  EMET.	
  And	
  implement	
  your	
  EMET	
  with	
  a	
  logger	
is	
  big	
  eﬀort. 
Key	
  Point 
•  In	
  2014	
  and	
  2015,	
  Flash	
  Exploits	
  are	
  all	
  use	
  corrupt	
Vector	
  to	
  achieve	
  arbitrary	
  read	
  and	
  write	
  memory.	
•  By	
  achieved	
  arbitrary	
  read	
  and	
  write,	
  exploits	
  can	
bypass	
  DEP,	
  ALSR,	
  CFG	
  and	
  even	
  EMET.	
•  The	
  corrupt	
  Vector	
  need	
  huge	
  length	
  for	
  reading	
  and	
wriGng	
  big	
  memory	
  address	