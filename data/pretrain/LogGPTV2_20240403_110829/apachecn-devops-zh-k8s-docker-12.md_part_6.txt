### 优化后的文本

#### 图 12.13 - Kibana 索引模式定义
5. 单击**下一步**按钮继续。
6. 在配置设置中，点击下拉菜单并选择 **time**，然后点击 **创建索引模式** 以创建模式：
   ![图 12.14 – 创建索引](img/Fig_12.14_B15514.jpg)
   图 12.14–创建索引
7. 最后，通过单击最终屏幕右上角的星号，将索引设置为默认索引：
   ![图 12.15 – 设置默认索引](img/Fig_12.15_B15514.jpg)
   图 12.15–设置默认索引

至此，您的集群上已成功运行了一个完整的 Falco 日志记录系统。要开始查看数据，请单击 Kibana 屏幕左上角的**发现**按钮（![](img/Icon_2.png)），该按钮会带您进入 Kibana 主页，在那里您可以查看集群中的事件：
   ![图 12.16 – Kibana 主页](img/Fig_12.16_B15514.jpg)
   图 12.16–Kibana 主页

您可以通过在搜索栏中键入关键字来搜索事件。如果您正在查找特定类型的事件并且知道要搜索的值，这将非常有帮助。

像 Kibana 这样的日志记录系统的真正优势在于能够创建自定义仪表板，提供对多个事件的视图，并按计数、平均值等进行分组。在下一节中，我们将解释如何创建一个展示 Falco 事件集合的仪表板。

创建仪表板是一项需要发展的技能，了解如何对数据进行分组以及在仪表板中使用什么值需要时间。本节旨在为您提供开始创建仪表板所需的基本工具，如下所示：
   ![图 12.17 – 仪表板示例](img/Fig_12.17_B15514.jpg)
   图 12.17–仪表板示例

人们喜欢仪表板，Kibana 提供了创建系统动态且易于解释视图的工具。仪表板可以使用 Kibana 可访问的任何数据创建，包括 Falco 事件。在我们创建仪表板之前，让我们了解一下*可视化*的含义。

#### 可视化
可视化是数据的图形表示——在我们的上下文中，来自 Kibana 索引。Kibana 包含一组可视化功能，允许您将数据分组为表格、仪表、水平条、饼图、竖线等。

要创建新的可视化，请单击左侧栏上的可视化图标（![](img/Icon_3_new.png)），该图标看起来像一个小图形。这将显示新的可视化选择屏幕。然后，按照以下步骤操作：

1. 从列表中选择要创建的可视化类型。对于此可视化，我们使用常见的饼图：
   ![图 12.18 – Falco 可视化](img/Fig_12.18_B15514.jpg)
   图 12.18–Falco 可视化

2. 每个可视化都需要一个数据源。对于我们的示例，我们只有一个名为 `falco*` 的索引，因此选择它作为数据源：
   ![图 12.19 – 选择可视化源](img/Fig_12.19_B15514.jpg)
   图 12.19–选择可视化源

3. 下一步是选择一个度量和一个桶。度量定义了如何聚合桶中的结果。桶是您希望可视化的值。例如，我们希望饼图显示事件优先级的总数，范围从**错误**、**通知**和**警告**到**调试**。

4. 首先，将度量聚合值设置为 **Count**：
   ![图 12.20 – 可视化指标选项](img/Fig_12.20_B15514.jpg)
   图 12.20–可视化指标选项

5. 接下来，我们需要选择要聚合的字段。对于**聚合**，选择**Terms**，对于**字段**，选择**priority.keyword**：
   ![图 12.21 – 选择桶值](img/Fig_12.21_B15514.jpg)
   图 12.21–选择桶值

6. 在保存可视化之前，您可以通过单击度量框顶部的箭头按钮预览结果。结果将在右侧窗格中显示：
   ![图 12.22 – 可视化预览](img/Fig_12.22_B15514.jpg)
   图 12.22–可视化预览

7. 如果结果符合预期，可以通过单击主视图顶部的**保存**链接来保存可视化效果。输入可视化效果的名称，以便稍后在创建仪表板时可以找到它：
   ![图 12.23 – 保存新的可视化效果](img/Fig_12.23_B15514.jpg)
   图 12.23–保存新的可视化效果

保存可视化时，它将保留在屏幕上，但您应该会在右下角看到保存成功的确认。

要创建其他可视化效果，只需再次单击可视化按钮，并选择所需的类型来创建另一个可视化效果。使用我们在第一个可视化中看到的内容，创建两个使用以下参数的附加可视化：

- **可视化类型**: 水平条形图
  - **来源**: `falco*`
  - **度量**: 聚合: 计数
  - **桶**: X 轴，聚合: 术语，字段: `rule.keyword`
  - **度量**: 计数，大小: 5，自定义标签: 前 5 条 Falco 规则
  - **可视化名称**: 前 5 大 Falco 规则

- **可视化类型**: 数据表
  - **来源**: `falco*`
  - **度量**: 聚合: 计数
  - **桶**: 拆分行，聚合: 术语，字段: `output_fields.fd.name.keyword`，度量: 计数，大小: 5，自定义标签: 前 5 个修改文件
  - **可视化名称**: 前 5 名 Falco 修改文件

在下一节中，我们将创建一个显示您创建的可视化效果的仪表板。

#### 创建仪表板
仪表板允许您在一个集合中显示可视化效果，该集合易于阅读，信息每分钟更新一次：

1. 要创建仪表板，请单击侧边栏上的仪表板按钮（![](img/Icon_4.png)）。该按钮看起来像 4 个堆叠的块。

2. 这将显示**创建您的第一个仪表板**屏幕。单击**创建新仪表板**按钮以开始创建仪表板。
   屏幕上将出现一个空白仪表板，上面有一个按钮：
   ![图 12.24 – 创建新仪表板](img/Fig_12.24_B15514.jpg)
   图 12.24–创建新仪表板

3. 该按钮提供了使用现有可视化或创建新可视化的选择。因为我们已经创建了三个可视化效果，所以单击**添加现有**链接。选择后，所有现有的可视化效果将在仪表板右侧的**添加面板**框中列出：
   ![图 12.25 – 向仪表板添加面板](img/Fig_12.25_B15514.jpg)
   图 12.25–向仪表板添加面板

4. 我们希望添加我们创建的三个可视化效果：**Falco 优先级计数**、**前 5 名 Falco 修改文件**和**前 5 名 Falco 规则**。要添加每一个，请单击每个可视化**一次**。

5. 添加完所有可视化效果后，可以通过单击**添加面板**窗格右上角的**X**关闭该窗格。关闭后，您应该会看到带有所选可视化的仪表板：
   ![图 12.26 – 添加可视化后的仪表板视图](img/Fig_12.26_B15514.jpg)
   图 12.26–添加可视化后的仪表板视图

哎呀！看起来我们可能两次添加了前 5 名 Falco 规则可视化。在添加可视化的步骤中，我们强调了一个关键词：“要添加每个可视化，请单击每个可视化**一次**。”每次单击都会添加可视化效果。当我们添加 Falco 规则到仪表板时，我们双击了它。

如果您不小心双击了一个可视化，它将被添加到仪表板两次。如果不小心添加了两次可视化效果，只需单击可视化效果角落的齿轮，然后选择**从仪表板中删除**即可删除其中一个可视化效果：
   ![图 12.27 – 从仪表板中删除面板](img/Fig_12.27_B15514.jpg)
   图 12.27–从仪表板中删除面板

6. 删除重复的可视化后，可以通过单击浏览器窗口顶部的**保存**链接来保存仪表板。这将提示您保存仪表板，因此将其命名为`Falco Dashboard`并单击**保存**：
   ![图 12.28 – 保存仪表板](img/Fig_12.28_B15514.jpg)
   图 12.28–保存仪表板

一旦您保存了仪表板，它将通过 Kibana 主页左侧的仪表板按钮可用。这与您之前创建第一个仪表板时使用的按钮相同。

### 总结
本章讲述了如何为 Kubernetes 集群创建一个增强的审计系统。我们从介绍 Falco 开始这一章，Falco 是 Sysdig 捐赠给 CNCF 的一个审计插件。Falco 增加了 Kubernetes 不包括的审计级别，并与审计功能相结合，为从 API 访问到 pod 中的操作的所有内容提供了审计跟踪。

如果您不能将日志存储在日志记录系统中，日志就没有用了，该系统允许您将日志存储在持久存储上，并且通常提供一个管理界面来搜索日志和创建仪表板。我们在 KinD 集群上安装了通用的 EFK 栈，并创建了一个自定义仪表板来显示 Kibana 中的 Falco 事件。

通过本章中学习的主题，您应该对如何将 Falco 添加到集群并使用 EFK 存储日志以及在可视化和仪表板中呈现数据有了很好的基础知识。

虽然日志记录和审核很重要，但在发生灾难时，拥有恢复工作负载的流程也同样重要。在下一章中，我们将介绍来自 Heptio 的开源备份实用程序 Velero。

### 问题
1. 如果您需要编辑包含的 Falco 规则，应编辑哪个文件？
   A. `falco.yaml`
   B. `falco_rules.yaml`
   C. `falco_rules.changes.yaml`
   D. `falco_rules.local.yaml`

2. 以下哪项是 Kubernetes 常用的日志转发器？
   A. Cube Forwarder
   B. Fluentd
   C. Cargo Forwarder
   D. Kubernetes 不使用转发器

3. 当您部署 EFK 栈时，哪个产品提供了使用可视化和仪表板展示日志的功能？
   A. Fluentd
   B. Elasticsearch
   C. Kibana
   D. Splunk

4. 以下哪种工具仅将 Falco 日志转发到中央日志系统？
   A. Falcon
   B. Falcosidekick
   C. Velero API Server
   D. 所有产品都会转发每个日志，而不仅仅是 Falco 日志

5. Falco 中用于创建项目集合的对象叫什么？
   A. 列表
   B. 规则
   C. 数组
   D. 集合