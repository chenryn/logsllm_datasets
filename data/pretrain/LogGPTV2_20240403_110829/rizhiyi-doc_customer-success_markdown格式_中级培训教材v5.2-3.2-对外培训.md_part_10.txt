"script":
"source[\"name\"]=\"liukang\";source[\"aget\"]=18;
if(source[\"name\"]==\"liukang_\"){source[\"alias\"]=\"rizhiyi\";}
elseif(source[\"age\"]==18){source[\"info\"]=\"tooyoung\";}
else{source[\"other\"]=\"Nosuchuser\";}
"
}
#3.0.0.21 后
{
"script":
"source[\"name\"]=\"liukang\";source[\"aget\"]=18;
if(source[\"name\"]==\"liukang_\")source[\"alias\"]=\"rizhiyi\";
elseif(source[\"age\"]==18)source[\"info\"]=\"too young\";
elsesource[\"other\"]=\"Nosuchuser\";
"
}
2-102
日志学院
还有两个循环， for/while 。因为目前没有遇到情况，所以没有进行太多的研究，二者使用
的格式如下：
for:
var={0:1,2:3,4:5,6:7,8:9};count=0;for(kinvar){count=count+k;}count;
while:
i=0;sum=0;while(i<10){sum=sum+i;i=i+1;}sum;
2、计算耗时
日志样例：startime:2019-11-2812:23:12:567endtime=:2019-11-2812:23:12:943
解析出 starttime、endtime，使用script计算耗时。
在spl中进行计算耗时，可以使用parsedate将utc时间解析为时间戳，然后相减；在script
中用法也是一样的。
{
"script":"source[\"timeCost\"]=parsedate(source[\"endtime\"],\"yyyy-MM-dd
HH:mm:ss.SSS\")-parsedate(source[\"starttime\"],\"yyyy-MM-ddHH:mm:ss.SSS\")"
}
3、字段重命名
如何将字段名前面的“info.”去掉？(将下图中的info.age格式改为age格式)
2-103
日志学院
使用script自定义解析如下：
注：3.0.0.21后的logriver做了语法更改 for(ainlist) 改为 for(a:list)。
2.3. 规则管理
本小节包括以下三方面的内容：
1、算子的条件控制：当某一日志中，同时存在多种类型的日志，或根据pid的不同，日志
格式变化较大时，可以采用条件控制对算子进行控制；
2、规则的验证：如何验证规则书写是正确的呢？我们可以从解析状况直观预览到；
3、规则运行状况查看：可以查看当前解析规则解析日志的状况，从而对解析规则作出优化；
4、规则管理：对解析规则进行分组、复制、删除等操作；
5、导入APP实现标准日志解析。
算子的条件控制
在诸如CiscoSyslog、WindowsEventlog等常见日志场景中，message部分的格式会根据ID
不同而有较大变化。单纯使用正则表达式来兼容这些变化非常繁琐而且可读性较差。日志易
提供一种条件判断定义，可以给字段提取中的每个解析规则都单独配置一个可选的生效条件，
简化了解析规则的书写难度。
如下图所示：
2-104
日志学院
图中展示了一个采用syslog记录nginx访问日志的场景。在完成syslog格式解析以后，就可
以单独设置programname字段值等于nginx的条件下，对msg采用访问日志的正则解析了。
规则验证
现实中日志格式通常较为复杂，一个字段提取规则内部会含有多个解析算子和条件控制。这
时，解析验证未必会用到全部算子。日志易提供算子验证状态功能，对每个算子在该日志样
例下的运行状态和耗时一目了然。
目前，日志易提供成功、失败、未命中、异常四种状态。
2-105
日志学院
正则表达式提示
上图中，我们看到正则解析算子的状态提示中，除了结果状态和耗时以外，还提供了steps
匹配步数，作为评估正则表达式性能的一个参照指标。
除此以外，对于部分预编译期就可以发现的正则表达式书写错误，日志易提供了单独的提示：
目前，日志易提供如下6种正则错误提示：
• 捕获组中包含重名字段
• 使用了未定义的Grok
• 编译错误
• 不完整的正则分组，缺少括号
• 非法的Grok类型
• 非法的Grok命名
批量验证
完成所有解析算子配置后，可以点击“使用检索日志验证”，页面底部的事件表格左侧将出现
成功/失败标记，以及每条样例日志的解析耗时：
点击“字段”标签，下拉框选择字段名，可以查看在最近100条日志中，该解析规则提取出来
的字段值统计排行。
2-106
日志学院
可以通过“全部日志，解析成功，解析失败”下拉框过滤被验证的事件。并在解析失败的事件
集上重新点击“选为日志样例”，替换之前的“日志样例”文本框：
完成规则配置，点击“下一步”，进入规则运用界面。在这里填写“appname”和“tag”，tag内容
可选择填写，表示该appname里，带有这个tag的日志，在进入日志易系统时，会运用该
解析规则进行日志解析：
可以添加多个appname。表示多个appname都使用这个解析规则。
2-107
日志学院
页面下方显示该规则的概要。 点击“完成”。返回查看”字段提取”列表，出现新规则和对应的
appname/tag。
规则运行状况查看
日志易提供对字段提取规则运行时的性能统计查看，包括界面交互和单机 HTTP 接口两种
形式。
界面查看运行性能
字段提取模块的运行性能指标长期存储在 rzy_internal 索引中，为了方便用户快速了解运行
状态，在规则列表页直接展示了最近一天的每小时数据处理量和平均耗时趋势：
虽然展示的是每小时的统计值，实际汇报的数据粒度远高于此。用户可以通过日志易
Manager 中 logriver 的配置项 parser_stat_report_interval 来调整汇报间隔，默认是 1 分钟。
2-108
日志学院
临时统计解析算子运行性能详情
日志易同样支持对每个解析算子的运行性能进行统计记录，考虑到细粒度统计对运行效率本
身可能造成一定的影响，默认并不开启。想要长期统计的用户，可以修改日志易 Manager 中
logriver 的配置项 parser_stat_report_level 为 high，默认为 low。
即使默认 low 的情况，在需要排查问题时，用户也可以在字段提取界面上点击开启"运行统
计"，系统将默认记录之后 30 分钟内的解析算子运行性能详情，30 分钟之后自动关闭。如
果需要修改时间范围的，可以通过日志易 Manager中logriver.cfg文件模板中的
parser_stat_report_level_reset_duration=30m修改。
查看具体某个规则的算子运行详情，在列表右侧对应行点击"详情"，弹层查看结果如下:
检索查询性能历史
如果需要查看最近一天以前的历史数据，或者进行界面上未提供的其他复杂统计，可以直接
利用日志易检索功能。
查询全部结果，可以使用index=rzy_internalappname:logriver_stat语句。其中规则性能和算
子性能分别以 logtype:parser_stat 和 logtype:parser_rule_stat为标记。
比如: 统计一段时间内的抽取规则解析结果用的 spl 是:
index=rzy_internallogtype:parser_stat
|evalparser_id=parser_stat.id
|buckettimestampspan=1hasts
|statssum(parser_stat.total)astotal,sum(parser_stat.success)assuccess,
sum(parser_stat.cost_us)ascost_usbyparser_id,ts
|evalavg_cost_us =cost_us/total
统计一段时间内规则统计用的 spl 是(parser_id 可以在对应的编辑页面的URL上复制):
index=rzy_internallogtype:parser_rule_statAND
parser_rule_stat.parser_id:3 |evalrule_id=
parser_rule_stat.rule_index|buckettimestampspan=1hasts|stats
sum(parser_rule_stat.total)astotal,sum(parser_rule_stat.success)as
success,sum(parser_rule_stat.skip)asskip,sum(parser_rule_stat.fail)
asfail,sum(parser_rule_stat.error)aserror,
sum(parser_rule_stat.cost_us)ascost_usbyrule_id,ts|eval
avg_cost_us =cost_us/total
2-109
日志学院
规则管理
主要包括以下几类：
复制已有规则
在字段提取规则列表中，找到想要复制的规则，点击“复制”。
然后点击进入“配置规则”页，页面展示原解析规则内容，但是“规则名称”采用了后缀加(1)的
方式，推荐您在这里修改成新的规则名称。logtype 则按需修改，可保留重名。
其余流程与创建规则相同。
编辑已有规则
点击已有规则的“编辑”按钮，进入“配置规则”页。修改“解析规则”，点击“下一步”，进入“运用”
页。点击“完成”。
将已有规则运用到其他 appname/tag
点击已有规则的“编辑”按钮，进入“配置规则”页。点击“下一步”，进入“运用”页。修改运用的
appname/tag。点击“完成”。
禁用已有规则
在字段提取规则列表中，找到想要禁用的规则，点击行首位置的“禁用”开关。
由于内置规则需要逐一匹配，对程序运行性能影响较大，在可确认的前提下，用户可以主动
禁用部分内置规则提高运行性能。
本章习题：
1、针对下面的日志样例，请解析出：时间戳、日志级别、开始时间、结束时间四个字段。
1）2017-7-5 下午02时35分10秒 CSTINFO12:23:45.320|12:23:34:233
2）2019-11-04 12:23:45.593INFO12:23:45.320|12:23:34:233
2、对上面的日志进行解析时，根据开始时间和结束时间求耗时，写出求耗时过程（需要说
明使用哪种解析规则）
3、某日志中有身份证号，身份证号有18位，如 id=0123456789012345678, 也有15位的，
如 id=0123456789012345 ，需要对身份证号前3和后3位之外的其他内容替换成******，
应如何设置？
4、解析日志时，如解析出来的字段需要再次解析，但原本的字段也需要保留，如何设置解
析规则让原本字段和再次解析字段都保留？
如：对下面的日志进行解析：
2014-05-1423:24:4715752[Note]128rollbacksegment(s)areactivesystem:InnoDB
要求从日志中要匹配出timestamp、pid、loglevel、system、brief字段，要求这些字段分
别对应的字段值如下：
brief:"InnoDB"
loglevel:"Note"
pid:"15752"
system:"system:InnoDB"
timestamp:"2014-05-1423:24:47"
2-110
日志学院
这里需要同时保留brief和system字段，解析规则该如何设立？
思考：
某企业的日志中有工号字段，没有姓名字段，如何在日志中添加某工号对应的员工姓名？你
能想到几种方式？
2-111
日志学院
3.SPL
初级产品学习过程中，我们已经能使用统计菜单视图点选生成简单的统计视图，并且能够使
用SPL语句进行简单的日志分析。
本章我们将学习：
1、SPL常用的分析绘图场景及所用函数；
2、日志易可通过SPL绘制的图形，以及这些图形主要用于何种数据展现。
3.1. SPL
该部分旨在通过案例介绍 SPL常用命令，同时帮助SPL学习者理解相关命令。该部分适合
用于日志易产品培训或初识日志易SPL语言且希望通过日志易产品对数据进行处理分析的
相关人员学习。
你可以参照Excel的数据处理逻辑理解日志分析流程。在使用Excel处理数据时，我们需要
先收集数据，将数据按照行列填入表格后，才能使用数据处理函数对数据进行下一步的处理
分析。
原始日志数据就相当于分散在各处的数据，通过日志采集将这些数据收集到一处，然后使用
日志解析规则对数据进行处理，这样我们就得到了结构化后的日志。结构化后的日志类似一
个Excel数据表格，行列数据分明。基于这样的数据，我们就可以对数据进行下一步处理。
与Excel的VLOOKUP类数据处理函数类似，日志易使用SPL搜索分析语句对结构化的日志
进行数据运算或可视化处理。
初识 SPL
很高兴您参与日志易SPL入门学习。
日志易系统支持Lucene系的全文检索语法。全文检索语句会被解析成一系列的单词和操作
符。这里说的单词，可以是一个真正的英文单词，比如error；也可以是一段由双引号包裹
起来的短语，比如"userlogin"。系统会按照相同的次序，在分词后的索引中，搜索短语内的
每个英文单词。除了最基础的单词检索以外，您还可以使用操作符组合更复杂的全文检索语
法。
日志易SPL集合了所有的检索命令、函数、参数和从句。检索命令告诉日志易系统对索引
中的数据应该做什么操作。比如，你可以使用检索命令来过滤不必要的信息、提取更精确的
信息、评估新的字段、计算统计指标、排序结果，甚至创建一个图表。如果您对日志易产品
还不太熟悉，推荐您首先阅读《日志易使用手册》及《日志易数据接入手册》等文档。
3-112
日志学院
在完成数据接入工作后，您应该会迫不急地想要开始使用SPL进行对数据金矿的探索发现工
作。通常来说，这个探索的最终目标可以分为如下两类：
 故障排查： 您期望从索引数据中找到故障根源，或者至少提供给你明确的排
查方向提示；
 统计可视化：您期望以一种巡检报表的形式，获取对索引数据的多维度统计分
析结果，最好是恰当的可视化仪表盘。
对于这两个不同的目的，SPL的用法上，也有着明显不同的分类：
 原文检索：主要通过关键字、唯一标识符等低频词元，利用索引中倒排表的高