Secure Boot Image Authentication API
•
APIs expect to be called from Secure mode
•
•
Implementations access secure addresses
Image Authentication API requires 
Secure/Privileged mode
•
Entrypoints discovered via tables located inside ROM
BREAKING TRUSTZONE-M
OXIDE
Plan of Attack
•
•
•
•
Find ROM API used by secure code
Use ROM Patch Controller to inject code into that ROM API
Wait for secure code to invoke that API
Profit!
BREAKING TRUSTZONE-M
TrustedFirmware-M
OXIDE
BREAKING TRUSTZONE-M
OXIDE
TrustedFirmware-M
•
•
•
•
Reference implementation of ARM’s Platform Security Architecture (PSA)
PSA defines API for common secure services offered to non-secure apps
Designed to allow different vendors for secure and non-secure code
Core services
•
•
•
•
Cryptography
Initial Attestation
Internal Trusted Storage (ITS)
RoT Lifecycle
•
Upstream has support for LPC55S69
HTTPS://WWW.TRUSTEDFIRMWARE.ORG/PROJECTS/TF-M/
BREAKING TRUSTZONE-M
OXIDE
TrustedFirmware-M
•
•
•
•
Reference implementation of ARM’s Platform Security Architecture (PSA)
PSA defines API for common secure services offered to non-secure apps
Designed to allow different vendors for secure and non-secure code
Core services
•
•
Cryptography
Initial Attestation
•
Upstream has support for LPC55S69
•
Internal Trusted Storage (ITS)
•
RoT Lifecycle
HTTPS://WWW.TRUSTEDFIRMWARE.ORG/PROJECTS/TF-M/
BREAKING TRUSTZONE-M
OXIDE
Internal Trusted Storage (ITS)
•
•
•
•
API callable from Non-Secure
Required to be implemented in Secure
Will interact with flash
Does it use ROM Flash API? Yup
“This API is designed to provide confidentiality and integrity protection of 
limited storage of persistent data against physical and logical attacks.
Implementations of the PSA Firmware Framework that provide isolation levels 
2 or 3 must implement the PSA Internal Trusted Storage Service within the 
PSA RoT and isolated from Application Root of Trust clients.”
BREAKING TRUSTZONE-M
Building a PoC
OXIDE
BREAKING TRUSTZONE-M
OXIDE
PoC Plan of Attack
•
•
Build unmodified TF-M v1.2 Secure image
Build Non-secure app
•
•
•
•
•
Write payload that fits in ~24 bytes
Use ROM Patch Controller to copy payload into empty space in ROM
Use ROM Patch Controller to patch Flash_Write ROM API to call payload
Use ITS API to write something
Verify payload was run
BREAKING TRUSTZONE-M
OXIDE
TF-M Flash Layout 
w/o Bootloader
BREAKING TRUSTZONE-M
OXIDE
SAU and MPC 
Configuration
•
•
•
Debug boot spew from TF-M Secure
Excluded in normal builds
Reported configuration doesn’t change
BREAKING TRUSTZONE-M
OXIDE
SAU and MPC 
Configuration
NON-SECURE CANNOT
ACCESS SECURE FLASH
•
•
•
Debug boot spew from TF-M Secure
Excluded in normal builds
Reported configuration doesn’t change
BREAKING TRUSTZONE-M
OXIDE
Patch Flash_Write ROM API
BREAKING TRUSTZONE-M
OXIDE
PoC Payload in 20 bytes
ROM PATCH
NON-SECURE APP
BREAKING TRUSTZONE-M
OXIDE
Verifying Compromise
START OF SECURE FLASH
BREAKING TRUSTZONE-M
OXIDE
Verified
BREAKING TRUSTZONE-M
Disclosure
OXIDE
BREAKING TRUSTZONE-M
OXIDE
Responsible Disclosure Process
•
•
•
•
Write up our findings
Disclose findings to vendor
Wait up to 90 days for response
Coordinate on fixes and public disclosure
BREAKING TRUSTZONE-M
OXIDE
Write up our findings
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
Where do I find contact info for security?
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
Where do I find contact info for security?
Support?
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
Where do I find contact info for security?
Support?  Nope
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
Where do I find contact info for security?
Support?  Nope
Company?
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
Footer?
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
Footer? Nope
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
Footer? Nope
Contact Us?
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
Footer? Nope
Contact Us? Nope
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
•
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
Footer? Nope
Contact Us? Nope
Contact Support?
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
•
•
•
•
•
Where do I find contact info for security?
Support?  Nope
Company? Nope
Footer? Nope
Contact Us? Nope
Contact Support? Finally!
BREAKING TRUSTZONE-M
OXIDE
Disclose Findings to Vendor
BREAKING TRUSTZONE-M
OXIDE
Wait Up to 90 Days For Response
BREAKING TRUSTZONE-M
OXIDE
Wait Up to 90 Days For Response...
BREAKING TRUSTZONE-M
OXIDE
Wait Up to 90 Days For Response
Hi Rick,
Thank you for your follow up and apologize for the delay.  The product team has confirmed Laura's findings and are investigating possible mitigations.  
The team will propose possible mitigations to address this vulnerability shortly, by restricting access to the ROM patch controller.
NXP would like to thank you and Laura for your responsible disclosure.
Kind Regards,
Asim
NXP PSIRT
BREAKING TRUSTZONE-M
OXIDE
Coordinate on Fixes and Public Disclosure
DRAMATIZATION
BREAKING TRUSTZONE-M
OXIDE
Coordinate on Fixes and Public Disclosure
ODDLY ENOUGH, SHARED WITH NXP'S PERMISSION
BREAKING TRUSTZONE-M
OXIDE
Coordinate on Fixes and Public Disclosure
DRAMATIZATION
BREAKING TRUSTZONE-M
OXIDE
Disclosure Timeline
Initial disclosure
2020-12-16
Oxide requests confirmation of vulnerability
2020-01-11
NXP provides confirmation and is working on mitigations
2020-01-12
Oxide requests update on disclosure timeline
2020-02-03
NXP proposes that scope is narrower than originally indicated
2020-02-08
Oxide provides TrustedFirmware-M-based PoC illustrating original scope
2020-02-24
NXP requests an extension to disclosure timeline
2020-03-05
Oxide agrees to extension with conditions
2020-03-10
NXP provides some answers under NDA, mostly dodged questions
2020-03-26
Public Disclosure
2020-04-30
BREAKING TRUSTZONE-M
OXIDE
BREAKING TRUSTZONE-M
Public Disclosure
•
•
•
•
Oxide
CVE-2021-31532
Blog post
Tweets
DEFCON Talk
•
•
NXP
Security Bulletin 04/2021 emailed to select 
customers
Updated User Manuals
TL;DR
OXIDE
BREAKING TRUSTZONE-M
OXIDE
Affected Devices
•
•
All LPC55S6x variants affected
LPC552x
•
•
•
Includes ROM Patch Controller
Lacks TrustZone-M
Escalation from unprivileged to privileged mode still 
possible
•
LPC553x
•
•
Includes ability to lock ROM Patch Controller 
configuration
ROM intentionally does not do so before starting 
user code
•
Many other LPC and i.MX RT products 
also include ROM Patch Controller
•
NXP has not provided a full list of devices
BREAKING TRUSTZONE-M
OXIDE
Takeaways
•
TrustZone-M is hard to configure correctly
•
•
Starts from secure/privileged mode with everything enabled
User code needs to drop permissions
•
SoCs contain undocumented hardware
•
•
Can’t drop a peripheral’s privileges if you don’t know it exists
NXP doesn’t see anything wrong with this
•
Reference implementations often lack secure defaults
•
TF-M and NXP examples both leave many security controls disabled
•
Keeping ROM source secret doesn’t improve security
BREAKING TRUSTZONE-M