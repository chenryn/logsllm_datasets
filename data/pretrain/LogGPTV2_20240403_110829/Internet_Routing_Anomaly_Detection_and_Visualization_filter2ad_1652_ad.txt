one of its customers. The event rate is too low for most tools
to detect the problem, but Stemming had no trouble ﬁnding
it and TAMP animation is able to clearly illustrate it. Figure
7 shows a snapshot of the animation. This customer of ISP-
Anon has a direct connection via next hop 1.0.0.1 but the
associated BGP peering would not stay up – it was dropped
and re-established every minute on the average. The cus-
tomer also has a backup link via a NAP that is connected
to all the other Tier-1 ISPs so when the one-hop direct path
goes away things immediately fail over to a three-hop alter-
nate via some other Tier-1. Figure 7 shows when direct path
between ISP-Anon and customer is stable, i.e.
the (pop1-
1.0.0.1-custAS-customer) (green) is preferred. All other
routes (gray) are suppressed. Since each pop peers with dif-
ferent Tier-1s and each makes an independent decision, lots
Figure 6. A snapshot of TAMP animation showing leaked routes from CalREN’s peers.
continuously for more than 1.5 months. The timeline in
Figure 7 only show a few minutes out of the 1.5 months of
ﬂapping.
5 Additional Data Sources
A single type of data source is sometimes not enough
information to decipher a complex network and its routing.
In this section, we describe the integration of information
from router conﬁguration ﬁles, trafﬁc ﬂows and IGP routing
data into our techniques to combat the drawbacks of using
BGP events alone in Internet routing anomaly diagnosis.
5.1 Integration with Internal Routing Policies
BGP routing policies local to an AS are deﬁned through
conﬁguring routers, and are stored in conﬁguration ﬁles at
the routers. Policies affect routing decisions, but are not
present in BGP events and are considered private to an AS.
There are many types of routing policies. A router can de-
ﬁne access lists to ﬁlter out routes from certain routers. An
AS can conﬁgure its border routers to only advertise lo-
cally originated routes (e.g. routes with empty AS path at-
tributes) to prevent becoming transit to other ASs. A router
can choose to always prefer routes from a particular peer.
The BGP community attribute in particular is used heavily
to dynamically inﬂuence routing decisions.
It is important to understand the interactions between in-
tended policies and actual routing behaviors. Note that this
is a step beyond automatically generating and validating
conﬁguration ﬁles for routers: even if each router is con-
ﬁgured as intended, an unexpected change anywhere can
put routing into an exceptional state, which when combined
with policies can lead to suboptimal or even unacceptable
behaviors. Section 4.4 describes how while policies tied to
the BGP community attribute is powerful when everything
is functioning as anticipated, during instability the com-
pounded interactions with the policies can lead to disastrous
results.
Figure 7. A snapshot of TAMP animation
showing continuous customer route ﬂapping.
of different alternate paths are announced. The convergence
details vary slightly event to event (depending on the rela-
tive timing of each core route reﬂector’s updates from the
access routers peering with the various downstream ISPs)
but it takes about 20 seconds for everything to converge and
generates about 200 BGP events per customer ﬂap. The an-
imation itself shows interesting intermediate states of route
preferences coming into effect. This oscillation went on
We have deduced part of Berkeley’s routing policies by
studying its BGP events. However, without looking at the
content of conﬁguration ﬁles, it is difﬁcult to know all of
the complex policies deﬁned internally in a network. We
are working on automatically correlating routing changes
with routing policies. One can imagine retrieving router
conﬁguration ﬁles from the two Berkeley BGP peers in
question, and then correlate their policies with BGP events
in real-time. What would their conﬁguration ﬁles tell us?
For router 128.32.1.3, the one on the rate-limiting path, it
would have a command to assign a LOCALPREF value of
80 to ISP routes tagged with 11423:65350 from CalREN.
On router 128.32.1.200, the one on the non-rate-limiting
path, it would give a lower LOCALPREF of 70 to those ISP
routes, and a default value of 100 to non ISP routes tagged
with 11423:65300 (Internet2, CalREN members, etc). Re-
cent work [5] presents a methodology for reverse engineer-
ing the design of a network through static analysis of router
conﬁguration ﬁles. We can use similar parsing techniques to
extract out the above route preference policies. The results
from Stemming can be matched with these policies. Stem-
ming picks out the most strongly correlated component in
the BGP events, which in this case, composes of route with-
drawals tagged with 11423:65350 from 128.32.1.3 and an-
nouncements tagged with 11423:65300 from 128.32.1.200.
Correlating the tags with the local preferences, we can pin-
point this costly policy interaction within Berkeley and give
hints to network operations on how to handle the situation.
5.2 Integration with Trafﬁc
Internet trafﬁc display the “elephant and mice phe-
nomenon” [7], in which a small percentage of preﬁxes, the
elephants, accounts for majority of the trafﬁc volume, and
the rest of the preﬁxes, the mice, use only very little band-
width. For example, 10% of the preﬁxes can be associated
with 90% of the trafﬁc, and 90% of the preﬁxes are tied to
only 10% of the trafﬁc. The techniques in this paper use
preﬁx counts and event counts as metrics, and weigh each
preﬁx equally. Though useful on their own, the techniques
would provide additional capabilities if combined with traf-
ﬁc data as well.
In Section 4 we discuss a “Load Balancing Unbalanced”
incident at Berkeley: Berkeley’s intention was to employ
a simple scheme of splitting the preﬁx space evenly across
two paths to load balance trafﬁc onto the two rate limiters,
but a misconﬁguration resulted in one path carrying four
times more preﬁxes than the other. However, because of
the elephant and mice phenomenon, this incident can be
more (or less) severe than the discrepancy in preﬁx counts
depending on the trafﬁc volume linked to the two sets of
preﬁxes. Turning on Cisco Netﬂow on the outbound inter-
faces to the two rate limiters is one method to collect traf-
ﬁc ﬂows information. This would tell us the unbalance in
terms of bandwidth consumed on the links which is a more
meaningful measure in Berkeley’s case. However, to arrive
at an effective load balancing situation would require a se-
quence of trial-and-error steps. A common practice with a
setup like Berkeley’s would be to adjust the preﬁx splits,
wait some time to see how the trafﬁc ﬂows on the two links
change, and readjust until the desired effect is achieved. A
better way is to correlate routing and trafﬁc data and com-
pute trafﬁc volume for each routing preﬁx, and recompute
the volume as routing and trafﬁc changes. This would al-
low us to compute a more effective, ﬁne-grained preﬁx load
balancing without affecting the network with trial-and-error
steps. We are in the process of integrating trafﬁc data into
our techniques. In TAMP visualization, instead of weighing
each preﬁx equally, edge weights would be computed based
on trafﬁc volume on the edges inferred by routing data com-
bined with Netﬂow trafﬁc ﬂow records collected at selected
border routers of a network.
5.3 Integration with IGP
The BGP route selection process works with IGP to com-
pute the best route for a preﬁx. It considers reachability and
IGP cost to the NEXTHOP attribute in a BGP route. A
change in IGP, such as link metric, can cause a router to
reselect a different BGP best route. In this work, we feed
only BGP events to the Stemming algorithm. We then use
REX, which temporally synchronizes BGP and IGP rout-
ing messages from a network, to manually drill-down and
determine whether IGP is part of the root-cause of an in-
cident. The volume of IGP routing messages (e.g. LSAs
in OSPF) is multiple orders of magnitude lower than BGP.
This makes it convenient to correlate LSAs with a BGP in-
cident after the incident is discovered. We are working on
automating this process as part of Stemming.
6 Related Work
In this section, we discuss work most related to ours. The
list here is by no means exhaustive.
Most network operators we have talked to use “home-
grown” tools to monitor the routing state of their networks.
Researchers at U.C. Davis’s Elisha project [10] have devel-
oped a suite of visualization techniques, including modules
to browse the timing and stability of BGP messages, and
for observing router, link and peer changes, to improve un-
derstanding of Internet routing dynamics. The BGPlay Java
plugin [1] from RIPE NCC visualizes BGP routing activ-
ity for a single preﬁx within a time interval. The TAMP
techniques presented in this paper can animate any set of
preﬁxes.
A number of researchers are investigating the problem
of BGP root-cause analysis. Caesar et al [2] and Feldmann
et al [3] both have developed algorithms that try to pinpoint
the root causes of Internet routing dynamics. Using BGP
data from multiple vantage points, their algorithms can dis-
tinguish among incidents that are correlated across time and
preﬁxes. Teixeira and Rexford [9] point out the limitations
of using BGP data from a single vantage point in identi-
fying location and cause of routing changes, in which the
results can be incomplete, and propose techniques to deal
with them.
The above papers advocate global coordination among
ASs, which would allow one AS to peek into another’s
network when diagnosing routing problems. Although a
laudable goal, this inter-AS framework would require much
commercial incentives to deploy since most ISPs guard their
internal network data as secrets. Our work focuses on what
is currently possible with commonly deployed inter-domain
routing practices within a network’s scope of administrative
control. Through real-life observations, we show that the
operationally oriented information our techniques provide
is a useful ﬁrst step in diagnosing routing problems in the
Internet.
7 Status and Conclusions
We ﬁrst presented this work at the North America Net-
work Operators Group 30th meeting and it was very well-
received. The TAMP visualization and Stemming analysis
techniques have since been adopted by the Packet Design
Route Explorer (REX) product as part of its BGP diagnos-
tics and analytics solution. REX consolidates data from
multiple routing protocols—currently it supports OSPF,
ISIS, EIGRP, BGP and MPLS/VPNs—and computes a real-
time, network-wide routing map. It allows an user to mon-
itor the overall routing topology of a network as it changes,
as well as providing a historical view. It also has a num-
ber of features for drilling down to show details of routing
state. We have installed REX with our extensions at large
universities, enterprises, public providers, and major Tier-
1 ISPs. Preliminary reactions from these installation sites
have been very positive. As they use TAMP and Stemming
to detect and diagnose BGP misbehavior, we hope to gather
feedback from them and further improve our techniques.
In this paper, we have presented challenges in under-
standing the inter-domain routing system of today’s Inter-
net. It is important to be able to diagnose routing problems,
especially the subtle ones, quickly and accurately because
they can cause harm to the Internet in many ways. This has
motivated us to develop the visualization and analysis tech-
niques presented in this paper. Our results from applying
the techniques to both a Tier-1 ISP and a large university
network show that the techniques can help diagnose a wide
range of routing anomalies. We also discovered unexpected
interactions between intended routing policy and actual be-
havior through the tools, which would otherwise be next
to impossible to detect in an operational environment. The
tools have been incorporated in a commercial product as
part of a BGP diagnostics solution. There are installations
of this products in a variety of network settings and have
been well-received by the customers.
8 Acknowledgments
We thank Ken Lindahl and Darrell Newcomb for their
insightful feedback and educating us on the common best
practice of providers. We are indebted to Berkeley, CENIC
and ISP-Anon for generously allowing us to collect, study,
interact, and present their data. We also thank the partici-
pants of the NANOG30 meeting for their comments. Last
but not least, we acknowledge our shepherd for DSN, Elias
P. Duarte Jr., for his guidance and feedback.
References
[1] Bgplay – graphical visualisation of bgp updates. RIPE NCC.
[2] M. Caesar, L.Subramanian, and R. H. Katz. Root cause anal-
ysis of internet routing dynamics. Technical report, U.C.
Berkeley, November 2003.
[3] A. Feldmann, O. Maennel, Z. M. Mao, A. Berger, and
B. Maggs. Locating internet routing instabilities. In Pro-
ceedings of Sigcomm, Portland, OR, September 2004.
[4] ATT’s
graphviz
library.
http://www.research.att.com/sw/tools/graphviz/.
[5] D. Maltz, G. Xie, J. Zhan, H. Zhang, G. Hjalmtysson, and
A. Greenberg. Routing design in operational networks: A
look from the inside. In Proceedings of Sigcomm, Portland,
OR, September 2004.
[6] Packet Design, Inc.: Making Sense of BGP Animations.
http://www.packetdesign.com/technology/presentations/nanog-
30/index.htm.
[7] K. Papagiannaki, N. Taft, S. Bhattacharyya, P. Thiran,
K. Salamatian, and C. Diot. A Pragmatic Deﬁnition of Ele-
phants in Internet Backbone Trafﬁc. In SIGCOMM Internet
Measurement Workshop, Marseilles, France, Nov. 2002.
[8] Y. Rekhter, T. Li, and E. Susan Hares.
A bor-
Internet Draft
der gateway protocol (bgp-4), 10 2002.
(work in progress). Available at http://www.ietf.org/internet-
drafts/draft-ietf-idr-bgp4-22.txt.
[9] R. Teixeira and J. Rexford. A measurement framework for
pinpointing routing changes. In Proceedings of NetTs Work-
shop, Portland, OR, September 2004.
[10] S. T. Teoh, K.-L. Ma, and S. F. Wu. A visual exploration
process for the analysis of internet routing data. In Proceed-
ings of 14th IEEE Visualization Conference, Seattle, WA,
October 2003.