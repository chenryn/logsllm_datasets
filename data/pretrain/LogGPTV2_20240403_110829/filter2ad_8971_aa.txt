作者：[安天安全研究与应急处理中心（Antiy
CERT）](http://www.antiy.com/response/EQUATIONS/EQUATIONS.html)
> — 方程式组织系列分析报告之四
>
> 安天安全研究与应急处理中心（Antiy CERT）
  * 报告初稿完成时间：2017年1月13日 16时00分
  * 首次发布时间：2017年1月16日 10时00分
  * 本版本更新时间：2017年1月17日 8时30分
[PDF报告下载](http://www.antiy.com/response/EQUATION_DRUG/EQUATION_DRUG.pdf)
## 1 本版本更新小语
安天在此前发布的报告版本的基础上，增加了一个方程式组织主机作业的模块积木图。这个积木图初步展示了一个将主机情报作业按照 **"原子化"拆分**
的模块组合的拼装，在本版本中安天CERT也细化了对部分模块的分析，尽管目前的分析只覆盖这些模块的一少部分。
在数天前，安天CERT把这份暂时称为"提纲"的未完成分析结果发布出来，这并非因为我们期望"速战速决"，而草率地发布一点粗浅的进展，而是我们需要获得更多的建议和批判。所幸的是，在上一版本发布后，获得了业内专家中肯而尖锐的批评，让安天认识到，在面对这组2007~2008年的攻击模块集合时，分析小组再次出现了和当年分析"火焰"时一样的迷茫（尽管安天曾经一度以为自己比那时更清晰）。这些庞杂的模块展开了一组拼图碎片，每一张图上都是有意义的图案，但如果逐一跟进进去，这些图案就会组成一个巨大的迷宫。迷宫之所以让人迷惑，不在于其处处是死路，而在于其看起来处处有出口，但所有的砖块都不能给进入者以足够的提示。此时，最大的期待，不只是有一只笔，可以在走过的地方做出标记，而是插上双翼凌空飞起，俯瞰迷宫的全貌。当然这是一种提升分析方法论的自我期待，我辈当下虽身无双翼，但或可练就一点灵犀。
目前安天的积木还原工作还刚刚起步，对于能够在中国的传统节日春节前，发布出分析报告的新版本，安天还是有些许欣慰的。网络安全注定是一个需要永远保持警惕和勤奋的行业，我们的分析工作会持续进行下去，即使是在焰火升腾，鞭炮响起的时刻，依然需要有紧盯反汇编代码和威胁态势的眼睛。
感谢业内专家同仁对安天的关注和支持，感谢安天客户对安天产品与服务的信任，祝大家新春快乐！
## 2 背景
对于方程式组织，在过去的两年中，安天已经连续发布了三篇分析报告：在《修改硬盘固件的木马--探索方程式（EQUATION）组织的攻击组件》[1]
中，安天对多个模块进行了分析，并对其写入硬盘固件的机理进行了分析验证；在《方程式（EQUATION）部分组件中的加密技巧分析》[2]报告中，对攻击组件中使用的加密方式实现了破解；在《从"方程式"到"方程组"
--EQUATION攻击组织高级恶意代码的全平台能力解析》[3]报告中，安天独家提供了方程式在Linux和Solaris系统的样本分析，这也是业内首次正式证实这些"恶灵"真实存在的公开分析。
APT的分析成果，与研发反APT产品一样，都要基于充分的基础积累，而不可能"一夜之间建成罗马"。对于方程式这样大至无形的超级攻击组织来说，安天过去所做的具体的分析工作都是盲人摸象的过程，一旦飘忽的线索落入安天已经摸索过的范围之内，就可以迅速发布储备成果，而如果面对的是一个未曾充分探查的区域，则需要更长的时间展开分析工作，因此与安天此前已经发布的三篇方程式的长篇报告相比，本篇报告目前的版本依然是比较仓促的，因此安天会坚持称之为"提纲"，旨在能抛砖引玉，邀请更多兄弟团队共同加入分析工作，以便进一步呈现出其全貌。
本篇展现的分析工作是围绕2017年1月12日"影子经纪人"放出Equation Group 组件中的61个文件[4]
而展开的。经分析，在本次放出的61个文件中，其中含有Equation Group
组件和DanderSpritZ（RAT）工具中的一些插件。DanderSpritZ是NSA（National Security
Agency）的间谍工具之一，在1月7号"影子经纪人"放出的Windows攻击工具[5]中也包含了大量DanderSpritZ的插件名称。
组件EquationDrug是一个很复杂的模块，其存活时间有近10年，后来被GrayFish升级替代。从EquationDrug到GrayFish是攻击平台级别的恶意代码体系，具有安装与卸载插件功能。在本次"影子经纪人"放出的文件中，安天CERT看到了更多的EquationDrug组件中的插件。通过分析比对发现，这些插件比之前安天分析过的插件版本低，但其中包含了一些此前未曾被业内捕获到的模块。
## 3 方程式线索曝光和分析成果时间链梳理
从2013年起，安天从样本分析中，逐步发现存在一个拥有全平台载荷攻击能力的攻击组织，并逐步关联分析了其多个平台的样本。在这个过程中，安天感到一个大至无形的超级攻击组织的存在，但并未找到其攻击背景。
2015年2月，卡巴斯基实验室曝光了一个名为方程式（Equation
Group）[6]的攻击组织，引发了全球关注，卡巴斯基认为该组织已活跃近20年，可能是目前世界上存在的最复杂的APT攻击组织之一，并认为该组织是震网（Stuxnet）和火焰（Flame）病毒幕后的操纵者。经过线索比对，安天发现这正是此前一直跟踪的超级攻击组织，决定通过报告公开其针对硬盘固件作业的原理[1]和已破解的其部分加密算法[2]，形成了安天对于方程式系列分析的前两篇报告。
2015年3月，卡巴斯基实验室发布了基于Equation Drug组件或平台的剖析[7]，Equation
Drug是方程式组织所用的主要间谍组件或平台之一，最早可追溯到2001年，并且一直沿用至今。该组件或平台的架构类似于一个具有内核模式和用户模式的微型操作系统，通过自定义接口进行交互。该组件或平台包括驱动程序、平台内核（协调器）和若干插件，其中一些插件配备独特的ID和版本号，用于定义相关功能等。
2016年8月，一个自称"影子经纪人"（The Shadow
Brokers）的个人（或组织）声称入侵了网络间谍组织方程式（Equation）[8]，并以100万比特币（当时约价值为5.6亿美元）的价格，公开"拍卖"所掌握的方程式组织的攻击工具，方程式组织被认为与NSA存在联系。为证明成功入侵的真实性，"影子经纪人"于当月13日在开源项目托管平台GitHub加密发布了这些攻击工具，并有意将其中的少量攻击工具以明文形式发布。
2016年8月，卡巴斯基实验室通过对方程式组织与"影子经纪人"曝光的数据进行对比验证[9]，确认了曝光的数据与方程式组织有关。2016年10月，"影子经纪人"对攻击工具再度发起拍卖[10]，并称在GitHub发布的方程式攻击工具只占其掌握的60%。
2016年11月，"影子经纪人"公开了一份遭受入侵的服务器清单[11]，并称攻击方与NSA有关。清单的日期显示，各系统遭受入侵的时间是在2000年到2010年之间，受控IP及域名分布在49个国家，主要集中在亚太地区，受影响的国家包括中国、日本、韩国、西班牙、德国、印度等。
安天将这些数据导入到安天态势感知和预警平台，形成了下图的可视化展现。
在"影子经纪人"的爆料中，提及的相关服务器可能是Linux、FreeBSD和Solaris。而在2016年上半年的两次技术会议中，安天则明确说明，方程式有针对多个系统平台的样本，其中包括Linux和Solaris。安天最终于2016年11月5日公开了方程式组织针对Linux和Solaris的部分样本载荷的分析报告（安天方程式系列报告之三）[3]。
图 3 - 1 安天态势感知与监控预警平台："方程式"组织对全球互联网节点的入侵可视化复现
安天分析团队小组对方程式的上述信息进行了梳理，整理出方程式事件曝光和相关分析的时间链。
图 3 - 2 方程式事件相关信息曝光和厂商分析的时间链
## 4 DanderSpritz攻击平台
安天通过对本次泄露的文件以及对以往方程式资料的分析发现，方程式组织的"EquationDrug"平台与泄露文件中提到的"DanderSpritz"具有一定内在联系：
1\.
本次泄露的msgkd.ex_、msgki.ex_、msgks.ex_、msgku.ex_为GROK插件，是"DanderSpritz"的插件或模块，该插件在"EquationDrug"平台中也曾出现，通过分析发现本次泄露的GROK为低版本GROK插件。
2\.
本次曝光的各类DLL插件中的一处数据为插件ID，插件ID都是以0x79开头，如：0x79A4、0x79D8，同样，"EquationDrug"平台的插件也设有内置ID，"EquationDrug"平台的插件ID为0x80开头，且两个平台的插件导出函数参数的数据结构也存在相似之处。
因此，基本可以认为方程式组织使用的"EquationDrug"攻击平台与"DanderSpritz"使用了相同的架构设计，两者可能是不同的版本代号，或至少来自同一开发团队或资源高度共享的团队。
图 4 - 1 方程式组织的DanderSpritz攻击平台
图 4 - 2 "影子经纪人"泄露的"DanderSpritz"攻击平台截图
本次"影子经纪人"所曝光的文件中多数为"DanderSpritz"平台的攻击插件，一是文件列表，二是61个部分插件实体文件。从放出的文件列表HASH和截图来看，攻击工具和插件非常丰富且标准化，具体包括远控、漏洞利用、后门、插件等。DanderSpritz_All_Find.txt文件内容多达7千余行，其中插件有数百个之多。对泄露出来的61个文件进行分析梳理，根据样本中的一些信息推断，这61个样本应该属于两类：测试版本与发布版本。测试版本中含有一些明文信息，并没有进行加密处理，使用了常规的函数调用方式，而在发布版本中这些信息并不存在，函数调用方式也改为动态调用，更加隐蔽。从时间戳上来看，测试版本的生成时间比发布版本要早5秒左右。测试版本是不应用于实际攻击中的，从侧面也再次证实了这些文件是被从开发和保管场景窃取出来的，而不是在攻击中捕获到的。
表 4 - 1 泄露实体文件的部分插件功能列表
**测试版本** ****
        发布版本
        功能
        DoubleFeatureDll.dll.unfinalized
        该模块用于创建线程执行函数，地址由调用者传入。同时，内部还有SHA256、AES、CRC32等算法。
        DuplicateToken_Lp.dll
        DuplicateToken_Implant.dll
        该模块用于获取Token，并执行操作。
        DXGHLP16.SYS
        该模块用于网络嗅探 监测以太网和VPN的流量 ，用于Windows 9x系统。
        EventLogEdit_Lp.dll
        EventLogEdit_Implant.dll
        该模块可对事件日志文件进行编辑。
        GetAdmin_Lp.dll
        GetAdmin_Implant.dll
        该模块用于获取管理员权限，并执行操作。
        kill_Implant.dll
        该模块功能是结束进程，传入参数中有要结束进程的ID，该功能的实现使用了常规的系统函数，如：OpenProcess、TerminateProcess。
        kill_Implant9x.dll
        该模块功能与kill_Implant.dll相同，是针对64位系统的版本。
        LSADUMP_Lp.dll
        LSADUMP_Implant.dll
        该模块可用来读取LSA 凭据，根据传入参数的不同执行不同的操作。
        modifyAudit_Lp.dll
        modifyAudit_Implant.dll
        该模块用于修改审核配置。
        modifyAuthentication_Lp.dll
        modifyAuthentication_Implant.dll
        该模块用于修改权限认证。
        ModifyGroup_Lp.dll
        ModifyGroup_Implant.dll
        该模块用于修改用户组权限。
        ModifyPrivilege_Lp.dll
        ModifyPrivilege_Implant.dll
        该模块用于修改用户权限。
        msgkd.ex_
        释放GROK键盘/剪贴板记录器驱动。
        msgki.ex_
        msgks.ex_
        msgku.ex_
        mstcp32.sys
        该模块用于网络嗅探 监测以太网和VPN的流量 。