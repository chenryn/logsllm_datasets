6
S
4
13
0
130810 00:00:15 mysqld_safe mysqld from pid file
130810 0:00:15 [Note] /usr/libexec/mysqld: Shutdown complete
set
130810
130810
130810
130810
130810
130810
InnoDB:
InnoDB:
130810
130810
130810
InnoDB:
InnoDB:
InnoDB:
InnoDB:
InnoDB:
InnoDB:
InnoDB:
InnoDB:
InnoDB:
0rows affected (0.01 sec)
global
0:00:15
0:00:10
0:00:10[ERROR] Aborting
0:00:10 [ERROR] Can't start server: Bind on TCP/IP port: Address
0:00:09
0:00:09 InnoDB:Setting file
0:00:10
Foreign key constraint system tables created
0:00:10
anew
The first
Doublewrite buffer created
Setting
general
database to be
InnoDB: Shutdown completed;log sequence number 0 44233
log file
InnoDB:
InnoDB: Log file ./ib_logfilel did not exist: new to be
InnoDB:
specified data file./ibdatal did not exist:
Log=on;
: Starting shutdown.
not found:
writes
the
eolt
creating new
./ibdatal size
size to
5MB
to10MB
---
## Page 183
下所示。
果没有指定文件名，默认hostname-slow.log作为文件名，并存放在数据目录中。示例配置如
句日志，对于SQL审核和开发者发现性能问题及时进行应用程序的优化具有重要意义。
with:
中。文件记录内容如【示例6-58】所示。
/data/s1ave/dbdata/MySQL_192_168 19 230.1og
。如需启用该日志可以在配置文件中设置“slow_query_log”用来指定是否开启慢查询。如
【示例6-58】
如果没有指定[file-name]，则默认为主机名(hostname)做为文件名，默认存放在数据目录
慢查询日志是记录了执行时间超过参数long_query_time（单位是秒）所设定值的SQL语
4.慢查询日志
上述日志记录了所有客户端的操作，系统管理员可根据此日志发现异常信息以便及时处理。
mysgl>
关闭该日志
2 rows in set (0.00 sec)
general
general log
I Variable name
1513080918:45:05
12
7
613080918:44:31
1/usr/libexec/mysqld, Version: 5.1.7i-log (Source distribution). started
6
130809 18:45:00
13080918:44:33
13080918:44:32
13080918:44:24
130809 18:43:20
Time
set global general
Value
1111111
S
6Query
5 Query
Field List
Query
Init DB
5Query
5 Query
Id Command
5Quit
Query
select
show tables
testDBI
update users_myisam
SELECT DATABASE()
show variables like '&general log%'
root@localhost on
Argument
users myisam
第6章搭建LAMP服务
set name="xxx"where
Limit
171
---
## Page 184
6.5.3MySQL备份与恢复
CentOS7系统管理与运维实战
172
备份出的文件可能损坏无法使用，不推荐直接使用此方法。另外一种可以实时备份的开源工具
直接备份数据库文件适用于MyISAM和InnoDB存储引擎，由于备份时数据库表正在读写，
的备份方式可以通过直接备份数据文件或使用mysqldump命令将数据库数据导出到文本文件。
应用程序等等。
参数
询的情况，常用参数如表6.4所示。
-S
data/master/dbdata/MysQL192_168_19_101-s1ow.1og
为防止数据库数据丢失或被非法篡改时恢复数据，数据库的备份是非常重要的。MySQL
用此工具就可以分析系统中哪些 SQL 是性能的瓶颈，以便进行优化，比如加索引、优化
MySQL提供了慢查询日志分析的工具 mysqldumpslow，可以按时间或出现次数统计慢查
#Time1308110:11:41
1r00t@MySQL192_16819101~1#
log-slow-queries=/usr/local/mysql/data/slow.log #定义慢查询日志路径。
long_query_time=1 #定义超过1秒的查询计数到变量 Slow_queries。
SET timestamp=1376151101;
slow query log
【示例6-59】
说明：
og-slow-queries = /usr/local/mysgl/data/slow.1og
mysqld]
query time
3306
只显示指定的行数
at:平均查询时间
ar：平均返回记录数
al:平均锁定时间
排序参数，可选的有：
说明
Unix
Ⅱ
Id Command
Version:5.1.71-log(Source distribution)
Lock time:0.000000 Rows_sent:
J e localhost 
表6.4mysqldumpslow参数说明
#
Argument
WL
---
## Page 185
mysqldump”
可以导出成SQL语句或文本文件，常用的使用方法如【示例6-60】所示。
为 xtrabackup，本节主要介绍这两种备份工具的使用。
-W
--tables
-t
-n
-X
--default-character-set
--add-locks
--add-drop-table
--add-drop-database
-B
-A
参数
以上给出了mysqldump常用参数说明，更多的参数含义说明可参考系统帮助“man
mysqldump支持丰富的选项，mysqldump部分选项说明如表6.5所示。
mysql> source /root/test.sql
#只导出数据库表结构
[root@Centos ~1# mysqldump -u root
#导出整个数据库
【示例6-60】
mysqldump是MySQL提供的数据导出工具，适用于大多数需要备份数据的场景。表数据
[root@Centos ~]#mysql-uroottest
#恢复数据的另外一种方法
[root@centos ~]# mysql -uroottesttest.TBL_2.sql
#导出一个表
1.使用mysqldump进行MySQL备份与恢复
等同于一WHERE，只导出给定的WHERE条件选择的记录
此参数会覆盖--databases（-B）参数，指定需要导出的表名
等同于--no-data，不导出任何数据，只导出数据库表结构
等同于--no-create-info，只导出数据，而不添加CREATETABLE 语句
等同于--no-create-db，只导出数据，而不添加CREATEDATABASE语句
等同于-lock-tables，开始导出前，锁定所有表
等同于--lock-all-ables，提交请求锁定所有数据库中的所有表，以保证数据的一致性
设置默认字符集
等同于--databases，
等同于--complete-insert，导出时使用完整的insert语句
用状态
在每个表导出之前增加LOCKTABLES并且之后UNLOCKTABLE，默认为启
每个数据表创建之前添加drop表语句，默认为启用状态
每个数据库创建之前添加drop语句
等同于-all-databases，导出全部数据库
说明
表6.5mysqldump部分选项说明
-u root
导出多个数据库
-d--add-drop-table test>test.sql
test>test.sgl
第6章搭建LAMP服务
173
---
## Page 186
CentOS7系统管理与运维实战
174
XtraDB5.5
XtraDB 5.1
为例说明Xtrabackup的使用方法，如【示例6-61】所示。
RPM安装，源码编译方式，以及二进制版本安装，本节以源码安装percona-xtrabackup-2.0.7
xtrabackup是一款高效的备份工具，备份时并不会影响原数据库的正常更新，最新的版本可以
份和恢复时间可以接受，如果数据量较大，mysqldump恢复的时间会很长而难以接受。
-socket-/data/mysql_data/m
130822 12:13:10 innobackupex: Starting mysql with options:
部分结果省略
ysql.sock
编译针对MySQL
查看编译帮助信
[root@centos soft]# tar xvf percona-xtrabackup-2.0.7.tar.gz
【示例6-61】
使用 mysqldump 进行数据库或表的备份非常方便，操作简单使用灵活，在小数据量时备
[root@Centos 5.1]#cp
[root@Centos 5.1]# cd /data/xtrabackup/5.1
2.使用Xtrabackup在线备份
rootecentos
rooteCentos
xtradb55
xtradb51
innodb56
innodb51_builtin/5.1
innodb50
innodb55
innodb51
--user=root--password=123456
5.1]# export PATH=pwd$PATH:
5.11#
5.1版本的二进制文件
15.0
cp/data/soft/percona-xtrabackup-2.0.7/innobackupex
mariadb52,mariadb53
xtradb,mariadb51
mariadb100
/plugin
galera55,mariadb55
build against InnoDB in MySQL 5.5
build agsinst InnoDB plugin in MySQL 5
   # 
build against built-in InnoDB in MySQL
./utils/build.sh
--slave-info /data/backup/
Percona Server with
innodb5l_builtin
with
5.6
but
---
## Page 187
(pid=42688)
(pid=41953)
--socket=/data/mysql _data/mysql.sock'--unbuffered--
(revision id:undefined)
-suspend-at-end
-defaults-file='/etc/my.cnf'
its affiliates.
-defaults-file=/etc/my.cnf'--password=xxxxxxx--user='root'
innobackupex: Waiting for ibbackup (pid=42935) to suspend
13082212:13:18
13082212:13:18
13082212:13:16
innobackupex: Using mysql server version Copyright (c) 2000, 2010, Oracle and/or
IMPORTANT: Please check that the backup run completes successfully.
13082212:13:16
130822 12:13:10
130822 12:13:19 innobackupex: Starting mysql with options:
(680 0) 0 dn pauus 60 <<
xtrabackup:
xtrabackup:
xtrabackup:
xtrabackup:
xtrabackup: cd to /data/mysgl_data
xtrabackup: uses posix _fadvise()
innobackupex: Using mysql Ver
130822
[01]
[01] Copying./ibdata1to/data/backup/2015-08-22_12-13-16/ibdata1
nnobackupex:
12:13:19
At the end of a successful backup run innobackupex
Target instance is assumed
innodb 1og_file size=5242880
innodb data file_path
innodb data home dir =
--target-dir=/data/backup/2015-08-22_12-13-16--tmpdir=/tmp
innobackupex: Connection to database server closed
innobackupex: Connected to database with mysql child process
 innobackupex:
innobackupex:
innobackupex: Starting mysql with options:
innobackupex:
"-password=xxxxxxxx --user='root'
-defaults-group="mysqld" --backup
14.14 Distrib 5.1.49, for unknown-linux-gnu
Continuing after ibbackup has suspended
= ibdatal:10M:autoextend
--unbuffered--
as
/data/backup/2015-08-22_12-13-16
N
followings.
第6章搭建LAMP服务
175
S
---
## Page 188
OK!”时说明备份成功。文件的位置位于/data/backup/2015-08-22_12-13-16目录下。
CentOS7系统管理与运维实战
176
可以指定--slave-info参数，用于记录备份完成时同步的位置。当出现“innobackupex:completed
份文件，脚本执行时指定了MySQL实例的配置文件和登录方式，如该备份程序从库上运行，
src目录下，复制到指定位置。
定目录，执行编译，编译时可以指定MySQL5.1和MySQL5.5，编译完成后二进制文件位于
的MySQL源码，比如mysql-5.1.59.tar.gz，源码可以从MySQL官方网站下载，然后复制到指