fmt.Println("Couldn't send msg " + err.Error())
}
os.Exit(0)
}
func checkError(err error) {
if err != nil {
fmt.Println("Fatal error ", err.Error())
os.Exit(1)
}
}
A server which receives this and just prints information to the console
is
服务器端接收到该文档后将里面的信息打印到终端
/* PersonServerXML
*/
package main
import (
"code.google.com/p/go.net/websocket"
"fmt"
"net/http"
"os"
"xmlcodec"
)
type Person struct {
Name string
Emails []string
}
func ReceivePerson(ws *websocket.Conn) {
var person Person
err := xmlcodec.XMLCodec.Receive(ws, &person)
if err != nil {
fmt.Println("Can't receive")
} else {
fmt.Println("Name: " + person.Name)
for _, e := range person.Emails {
fmt.Println("An email: " + e)
}
}
}
func main() {
http.Handle("/", websocket.Handler(ReceivePerson))
err := http.ListenAndServe(":12345", nil)
checkError(err)
}
func checkError(err error) {
if err != nil {
fmt.Println("Fatal error ", err.Error())
os.Exit(1)
}
}
15.6 Web sockets over TLS
A web socket can be built above a secure TLS socket. We discussed in Chapter
8: HTTP how to use a TLS socket using the certificates from Chapter 7:
Security. That is used unchanged for web sockets. that is, we
use http.ListenAndServeTLS instead of http.ListenAndServe.
web socket 可以建立在安全的 TLS 套接字上。在章节 8: HTTP 里，我们讨论了如果通
过使用章节 7: Security 里的证书来使用 TLS 套接字。这同样适用于 web socket。也
就是说，我们将使用 http.ListenAndServeTLS 而不是 http.ListenAndServe。
Here is the echo server using TLS
这里是一个使用了 TLS 的 echo 服务器
/* EchoServer
*/
package main
import (
"code.google.com/p/go.net/websocket"
"fmt"
"net/http"
"os"
)
func Echo(ws *websocket.Conn) {
fmt.Println("Echoing")
for n := 0; n < 10; n++ {
msg := "Hello " + string(n+48)
fmt.Println("Sending to client: " + msg)
err := websocket.Message.Send(ws, msg)
if err != nil {
fmt.Println("Can't send")
break
}
var reply string
err = websocket.Message.Receive(ws, &reply)
if err != nil {
fmt.Println("Can't receive")
break
}
fmt.Println("Received back from client: " + reply)
}
}
func main() {
http.Handle("/", websocket.Handler(Echo))
err := http.ListenAndServeTLS(":12345", "jan.newmarch.name.pem",
"private.pem", nil)
checkError(err)
}
func checkError(err error) {
if err != nil {
fmt.Println("Fatal error ", err.Error())
os.Exit(1)
}
}
The client is the same echo client as before. All that changes is the url,
which uses the "wss" scheme instead of the "ws" scheme:
客户端仍然是前面的 echo 客户端，所做的改变仅仅是将 url 里的"ws"模式替换成"wss"
模式。
EchoClient wss://localhost:12345/
15.7 Conclusion 结论
The web sockets standard is nearing completion and no major changes are
anticipated. This will allow HTTP user agents and servers to set up
bi-directional socket connections and should make certain interaction
styles much easier. Go has nearly complete support for web sockets.
web sockets 标准已接近完成，预计也不会有较大的改动。它允许 HTTP 客户代理和服务
器建立一个双向的套接字连接，从而易化了某些交互方式。Go 对 web sockets 有近乎完
整的支持。
Copyright © Jan Newmarch, PI:EMAIL
If you like this book, please contribute using Flattr
or donate using PayPal
目录
《Network programming with Go》..................................................................................................................................1
Contents 目录.....................................................................................................................................................................2
Chapter 1 第一章..............................................................................................................................................................3
1.1 Introduction 前言...........................................................................................................................................3
1.2 Protocol Layers 协议层................................................................................................................................3
ISO OSI Protocol...................................................................................................................................................4
OSI layers................................................................................................................................................................4
TCP/IP Protocol.....................................................................................................................................................5
Some Alternative Protocols.............................................................................................................................5
1.3 Networking 网络...............................................................................................................................................6
1.4 Gateways 网关....................................................................................................................................................7
1.5 Packet encapsulation 数据包封装.............................................................................................................7
1.6 Connection Models 连接模型........................................................................................................................8
Connection oriented............................................................................................................................................9
Connectionless.......................................................................................................................................................9
Message passing.....................................................................................................................................................9
Remote procedure call......................................................................................................................................10
1.8 Distributed Computing Models 分布式计算模型.................................................................................12
1.9 Client/Server System 客户端/服务器系统.............................................................................................13
1.10 Client/Server Application 客户端/服务器应用...............................................................................14
1.11 Server Distribution 服务器分布...........................................................................................................14
1.12 Component Distribution 组件分布........................................................................................................15
Gartner Classification....................................................................................................................................16
Example: Distributed Database....................................................................................................................16
Example: Network File Service....................................................................................................................17
Example: Web..........................................................................................................................................................17
Example: Terminal Emulation........................................................................................................................18
Example: Expect...................................................................................................................................................18
Example: X Window System...............................................................................................................................19
Three Tier Models...............................................................................................................................................19
Fat vs thin............................................................................................................................................................20
1.13 Middleware model 中间件模型......................................................................................................................21
1.14 Middleware 中间件...........................................................................................................................................21
Middleware examples..........................................................................................................................................21
Middleware functions........................................................................................................................................22
1.15 Continuum of Processing 连续处理......................................................................................................23
1.16 Points of Failure 故障点.......................................................................................................................23
1.17 Acceptance Factors 接受因素.................................................................................................................24
1.18 Transparency 透明度..................................................................................................................................24
1.19 Eight fallacies of distributed computing 分布式计算的八个误区........................................25
Chapter 2 第二章............................................................................................................................................................27
2.1 Introduction 介绍.........................................................................................................................................27
Chapter 3 第三章............................................................................................................................................................28
3.1 Introduction 介绍.........................................................................................................................................28
3.2 The TCP/IP stack TCP/IP协议栈.............................................................................................................29
IP datagrams..........................................................................................................................................................30
UDP..............................................................................................................................................................................30
TCP..............................................................................................................................................................................31
3.3 Internet addresses 互联网地址...............................................................................................................31
IPv4 addresses.....................................................................................................................................................31
IPv6 addresses.....................................................................................................................................................33
3.4 IP address type IP地址类型..................................................................................................................33
The type IP IP类型......................................................................................................................................33
The type IPmask...................................................................................................................................................35
The type IPAddr...................................................................................................................................................37
Host lookup............................................................................................................................................................38
3.5 Services 服务..................................................................................................................................................40
Ports.........................................................................................................................................................................40
The type TCPAddr.................................................................................................................................................41
3.6 TCP Sockets TCP套接字...............................................................................................................................42
TCP client..............................................................................................................................................................43
A Daytime server.................................................................................................................................................46
Multi-threaded server......................................................................................................................................49
3.7 Controlling TCP connections 控制TCP连接.......................................................................................52
Timeout.....................................................................................................................................................................52
Staying alive.......................................................................................................................................................52
3.8 UDP Datagrams UDP数据报...........................................................................................................................53
3.9 Server listening on multiple sockets 服务器侦听多个套接字...................................................55
3.10 The types Conn, PacketConn and Listener Conn，PacketConn和Listener类型...............56
3.11 Raw sockets and the type IPConn 原始套接字和IPConn类型.....................................................60
3.12 Conclusion 结论...........................................................................................................................................63
Chapter 4 第四章............................................................................................................................................................64
4.1 Introduction 简介.........................................................................................................................................64
4.2 Mutual agreement 交互协议........................................................................................................................66
4.3 Self-describing data 自描述数据...........................................................................................................68
4.4 ASN.1 抽象语法表示法....................................................................................................................................68
ASN.1 daytime client and server................................................................................................................75
4.5 JSON JSON..........................................................................................................................................................78
A client and server..........................................................................................................................................83
4.6 The gob package gob包..............................................................................................................................86
A client and server..........................................................................................................................................90
4.7 Encoding binary data as strings 将二进制数据编码为字符串......................................................94
Chapter 5 第五章............................................................................................................................................................97
5.1 Introduction 介绍.........................................................................................................................................97
5.2 Protocol Design 协议设计..........................................................................................................................97
5.3 Version control 版本控制..........................................................................................................................98
The Web.....................................................................................................................................................................99
Web协议.....................................................................................................................................................................99
5.4 Message Format 消息格式..........................................................................................................................100
5.5 Data Format 数据格式.................................................................................................................................101
Byte format..........................................................................................................................................................101
Character Format...............................................................................................................................................102
5.6 Simple Example 简单的例子......................................................................................................................104
Alternative presentation aspects...........................................................................................................106
Protocol - informal........................................................................................................................................107
Text protocol.....................................................................................................................................................107
Server code..........................................................................................................................................................109
服务器代码..............................................................................................................................................................109
Client code..........................................................................................................................................................111
5.7 State 状态......................................................................................................................................................113
Application State Transition Diagram..................................................................................................115
Client state transition diagrams...........................................................................................................116
Server state transition diagrams...........................................................................................................117
服务器状态转换图..................................................................................................................................................117
Server pseudocode.............................................................................................................................................117
5.8 Summary 总结..................................................................................................................................................118
Chapter 6 第六章..........................................................................................................................................................119
6.1 Introduction 引言.......................................................................................................................................119
6.2 Definitions 定义.........................................................................................................................................120
Character..............................................................................................................................................................121
Character repertoire/character set.......................................................................................................121
Character code...................................................................................................................................................122
Character encoding..........................................................................................................................................122
Transport encoding..........................................................................................................................................123
6.3 ASCII ASCII编码..........................................................................................................................................124
6.4 ISO 8859 ISO 8859字符集.........................................................................................................................127
6.5 Unicode Unicode编码.................................................................................................................................128
6.6 UTF-8, Go and runes UTF-8, Go语言和runes..................................................................................129
UTF-8 client and server...............................................................................................................................131
ASCII client and server...............................................................................................................................131
6.7 UTF-16 and Go Go语言和utf-16.............................................................................................................131
Little-endian and big-endian....................................................................................................................132
UTF-16 client and server.............................................................................................................................133
6.8 Unicode gotcha's Unicode的疑难杂症.................................................................................................138
6.9 ISO 8859 and Go ISO 8859 编码和Go语言..........................................................................................138
6.10 Other character sets and Go 其他字符集和Go语言....................................................................141
6.11 Conclusion 总结.........................................................................................................................................142
Chapter 7 第七章..........................................................................................................................................................143
Security 安全.................................................................................................................................................................143
7.1 Introduction 简介.......................................................................................................................................143
7.2 ISO security architecture ISO 安全架构.........................................................................................143
Functions and levels......................................................................................................................................144
Mechanisms............................................................................................................................................................145
7.3 Data integrity 数据完整性......................................................................................................................147
7.4 Symmetric key encryption key对称加密............................................................................................149
7.5 Public key encryption 公钥加密...........................................................................................................150
7.6 X.509 certificates X.509 证书............................................................................................................153
7.7 TLS TLS............................................................................................................................................................156
7.8 Conclusion 结论...........................................................................................................................................159
Chapter 8 第八章..........................................................................................................................................................160
8.1 Introduction 简介.......................................................................................................................................160
8.2 Overview of HTTP HTTP概述....................................................................................................................160
URLs and resources..........................................................................................................................................160
HTTP characteristics......................................................................................................................................161
Versions.................................................................................................................................................................161
HTTP 0.9.................................................................................................................................................................162
HTTP 1.0.................................................................................................................................................................162
HTTP 1.1.................................................................................................................................................................165
8.3 Simple user-agents 简单用户代理.........................................................................................................166
8.4 Configuring HTTP requests 设置HTTP请求.......................................................................................170
8.5 The Client object 客户端对象...............................................................................................................173
8.6 Proxy handling 代理处理..........................................................................................................................175
Simple proxy........................................................................................................................................................175
Authenticating proxy......................................................................................................................................178
8.7 HTTPS connections by clients 客户端发起HTTPS连接..................................................................180
8.8 Servers 服务器..............................................................................................................................................180
File server..........................................................................................................................................................180
Handler functions.............................................................................................................................................182
Bypassing the default multiplexer.........................................................................................................183
Chapter 9 第九章..........................................................................................................................................................185
9.1 Introduction 介绍.......................................................................................................................................185
9.2 Inserting object values 插入对象值..................................................................................................186
9.3 Using templates 使用模板........................................................................................................................187
9.4 Pipelines 管道.............................................................................................................................................190
9.5 Defining functions 定义方法.................................................................................................................191
9.6 Variables 变量.............................................................................................................................................194
9.7 Conditional statements 条件语句........................................................................................................196
9.8 Conclusion 结论...........................................................................................................................................202
Chapter 10 第十章........................................................................................................................................................203
10.1 Introduction 说明....................................................................................................................................203
10.2 Static pages 静态文件............................................................................................................................204
10.3 Templates 模板...........................................................................................................................................204
10.4 The Chinese Dictionary 中文词典......................................................................................................205
The Dictionary type........................................................................................................................................209
字典类型..................................................................................................................................................................210
10.5 Flash cards Flash cards......................................................................................................................214
10.6 The Complete Server 完整的服务器.....................................................................................................215
10.7 Other Bits: JavaScript and CSS 其他: JavaScript 和 CSS...................................................221
Chapter 11 第十一章....................................................................................................................................................225
11.1 Introduction 介绍....................................................................................................................................225
11.2 Conclusion 结论.........................................................................................................................................226
Chapter 12 第十二章....................................................................................................................................................227
12.1 Introduction 介绍....................................................................................................................................227
12.2 Parsing XML 解析XML...............................................................................................................................228
12.3 Unmarshalling XML 反编排XML..............................................................................................................233
12.4 Marshalling XML 编组 XML.....................................................................................................................238
12.5 XHTML XHTML.................................................................................................................................................238
12.6 HTML......................................................................................................................................................................238
12.7 Conclusion 结论.........................................................................................................................................239
Chapter 13 第十三章....................................................................................................................................................240
13.1 Introduction 介绍....................................................................................................................................240
13.2 Go RPC..................................................................................................................................................................245
HTTP RPC Server.................................................................................................................................................248
HTTP RPC 服务器..................................................................................................................................................248
HTTP RPC client.................................................................................................................................................250
TCP RPC server TCP RPC 服务端.............................................................................................................251
TCP RPC client TCP RPC 客户端.............................................................................................................253
Matching values.................................................................................................................................................254
13.3 JSON......................................................................................................................................................................256
JSON RPC client.................................................................................................................................................256
JSON RPC server.................................................................................................................................................257
13.4 Conclusion 总结.........................................................................................................................................259
Chapter 14 第十四章....................................................................................................................................................261
14.1 Introduction 简介...................................................................................................................................261
14.2 Channel server 服务器端Channel.......................................................................................................264
14.3 Channel client 客户端Channel...........................................................................................................266
14.4 Handling Timeouts 处理超时.................................................................................................................268
14.5 Channels of channels 传递channel的channel.............................................................................269
14.6 Conclusion 总结.........................................................................................................................................272
Chapter 15 第十五章....................................................................................................................................................274
15.1 Introduction 介绍....................................................................................................................................274
15.2 Web socket server Web socket服务器端..........................................................................................278
15.3 The Message object Message对象.......................................................................................................280
15.4 The JSON object JSON对象....................................................................................................................284
15.5 The Codec type Codec 类型...................................................................................................................286
15.6 Web sockets over TLS...................................................................................................................................290
15.7 Conclusion 结论.........................................................................................................................................292