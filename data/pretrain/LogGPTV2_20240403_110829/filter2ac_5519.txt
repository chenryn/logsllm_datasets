### Title: Black Hat US-22: Trust Dies in Darkness: Shedding Light on Samsung's TrustZone Keymaster Design

ARM-based Android smartphones leverage TrustZone hardware support to create a Trusted Execution Environment (TEE) for implementing security-sensitive functions. The TEE runs a separate, isolated TrustZone Operating System (TZOS) in parallel with Android. The cryptographic functions within the TZOS are implemented by device vendors, often using proprietary and undocumented designs.

In this study, we reveal the cryptographic design and implementation of Android's Hardware-Backed Keystore in Samsung's flagship devices: Galaxy S8, S9, S10, S20, and S21. Through reverse engineering, we provide a detailed description of the cryptographic design and code structure, uncovering several severe design flaws. Specifically, we present an IV reuse attack on AES-GCM that allows an attacker to extract hardware-protected key material. Additionally, we describe a downgrade attack that makes even the latest Samsung devices vulnerable to the IV reuse attack. We demonstrate successful key extraction attacks on the most recent devices.

We also explore the implications of these attacks on two higher-level cryptographic protocols between the TrustZone and a remote server. We show how our attacks can be used to bypass FIDO2 WebAuthn login and compromise Google's Secure Key Import. Furthermore, we discuss multiple flaws in the design flow of TrustZone-based protocols.

While our specific attacks target approximately 100 million Samsung devices, they highlight the broader need for open and proven standards in critical cryptographic and security designs.