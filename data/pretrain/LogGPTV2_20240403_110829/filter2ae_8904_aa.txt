**作者：Tangerine  
本文为作者投稿，Seebug Paper 期待你的分享，凡经采用即有礼品相送！ 投稿邮箱：PI:EMAIL**
> 引言与架构：
>
>
> 自动驾驶即来，移动设备、视频流量、云服务的不断扩展，带宽需求也随之快速增长，网络环境也变得复杂，数据安全和隐私问题非常重要，其中对数据安全和隐私要求高的机构不能忽视局域网数据安全。
>
> 交换机作为构建局域网最基本的设备，企业交换机的部署需要更合适的安全协议，可以更有效的规避数据风险，保护企业的局域网安全，MACsec
> 是致力于下一代高速加密的企业、政府或服务提供商新的选择，如果有这样的需求，MACsec
> 安全协议数据链路层为企业提供更安全的选择，这篇文章来简单分析二者的联系。
## 1.MACsec协议是什么？
MACsec，英文全称 **Media Access Control security** ，中文为 **媒体访问控制安全协议**
，是基于802.1AE和802.1X协议的局域网上的安全通信方法，它拥有身份认证、数据加密、完整性校验、重播保护等功能保证 **以太网数据帧**
的安全，从更底层防止设备处理有安全威胁的报文，MACsec加密比任何其他更高层加密方法（如IPsec和SSL）的优先级更高。
因为在很多情况下，绝大部分的数据不像广域网中使用多种加密算法，在局域网链路中传输形式是明文传输的，由此引发许多安全隐患，在诸如银行金融领域，军事单位中帐户的信息被窃取、篡改，遭受恶意网络攻击后会引发严重的网络安全事件。
> MACsec可以保护所有以太网链路中流量（注意不是所有互联网流量，而是强调协议之间的 **互操作性** 和 **互补性**
> ），包括拒绝服务、入侵、中间人、伪装、被动窃听和重放攻击，可以将 MACsec 与其他安全协议（如 IP 安全 （IPsec） 和安全套接字层
> （SSL） 结合使用，以提供端到端网络安全。
网络中部署MACsec后，可对传输的以太网数据帧进行保护，降低信息泄露和遭受恶意网络攻击的风险。数据和报文仅在PC和交换机之间的链路上加密（点对点加密）。
交换机收到的数据包将解密并通过未加密的上行链路发送，为了加密交换机之间的传输，建议使用交换机 — 交换机加密。
### 1.1 MACsec的数据控制和数据处理：
> **控制部分** 遵从的是IEEE802.1x（802.10,802.11...WIFI也属于这个协议），只有认证的双方能够建立链接， **数据部分**
> 遵从的是IEEE802.AE，对以太网报文基于AES-GCM进行加密。
  1. 当MACsec被使用时，只有认证双方可以连接网络
  2. 所有期望“欺骗”交换机/路由将网络数据重定向到攻击者机器的行为都不能成功
  3. MACsec是WiFi中WPA2的有线等效
  4. 应用不会感知MACsec的存在
### 1.2 MACsec应用场景一：交换机点对点
交换机之间部署双向的MACsec对数据进行安全保护，实现通信安全。
### 1.3 MACsec应用场景二：含中间交换机
当中间包含多个交换机时，可以使用数据链路层的二层协议透明传输功能，实现通信安全。
## 2.如何应用MACsec在互联网安全中？
在两台设备之间实现MACsec时，MACsec协议的工作过程可以分为四个主要阶段，包括 **身份认证、会话协商** 、 **安全通信** 和
**会话终止** 。
  * **身份认证** 阶段
在客户端和接入设备之间建立安全会话前，客户端首先需要在接入设备的端口上进行802.1X认证。客户端通过认证后， **RADIUS**
服务器会把生成的CAK分发给客户端和接入设备。
  * **会话协商** 阶段
使用配置的预共享密钥 (PSK) 作为 CAK（连接关联密钥），通过 EAPOL-MKA（LAN-MACsec协议上的可扩展身份验证协议）消息在设备之间协商会话。设备间优先级高的端口会被选举为Key
Server，负责生成和分发SAKs（安全关联密钥），设备之间相互通知自己的能力和建立会话所需的各种参数（如优先级，是否需要加密会话等）通过 MKA 协议。
CAK作用：生成用于MACsec的所有其他密钥的长期主密钥。
SAK作用：是路由器/终端设备用于加密给定会话流量的密钥。
  * **安全通信** 阶段
会话协商完成后，客户端和接入设备有了可用的SAK，并使用SAK加密数据报文，开始加密通信。
  * **会话终止** 阶段
当接入设备收到802.1X客户端的下线请求消息后，立即清除该用户对应的安全会话，避免一个未认证的客户端使用端口上前一个已认证客户端建立的安全会话接入网络。
此外，MKA协议里定义了一个会话保活定时器，如果在超时时间内（6秒），本端没有收到对端的MKA协议报文，则在定时器超时后，本端将清除建立的安全会话。
  * **名词解释：**
缩写 | 名称 | 指代对象  
---|---|---  
**MKA** | MACsec密钥协议 | 在IEEE 802.1X REV-2010中定义为用于发现MACsec对等体和协商密钥的关键协议协议  
**CAK** | 连接关联密钥 | 用于生成用于MACsec的所有其他密钥的长期主密钥。 LAN实施从MSK派生此信息（在EAP交换期间生成）  
**PMK** | 成对主密钥 | 用于派生用于加密流量的会话密钥的组件之一。手动配置或从802.1X派生  
**CKN** | CAK密钥名称 | 用于配置密钥值或CAK。仅允许偶数个十六进制字符（最多64个字符）。  
**SAK** | 安全关联密钥 | 由从CAK选出的密钥服务器派生，是路由器/终端设备用于加密给定会话流量的密钥。  
**ICV** | 完整性检查值键 | 从CAK派生，并在每个数据/控制帧中标记，以证明该帧来自授权对等体。8-16个字节，具体取决于密码套件  
**KEK** | 密钥加密密钥 | 派生自CAK（预共享密钥），用于保护MacSec密钥  
**SCI** | 安全通道标识符 | 每个虚拟端口接收一个唯一的安全通道标识符(SCI)，该标识符基于与16位端口ID连接的物理接口的MAC地址  
## 3.MACsec协议的格式
**控制帧(EAPOL-MKA)** 协议格式：
  * EAPOL目标MAC = 01:80:C2:00:00:03将数据包组播到多个目标
  * EAPOL以太网类型= 0x888E
**数据帧** 协议格式：
MACSec会在数据帧上插入两个额外标签，最大开销 **为32字** 节（最少16字节）。
  * **SecTag** = 8到16字节（8字节SCI是可选的）
  * **ICV** = 8到16个字节，基于密码套件(AES128/256)
> 数据包编号和重放保护：
> 在每个安全关联中，可以通过对照本堆存储的分组号检查SecTAG报头的分组号字段来执行重放保护。每个MCsC分组具有唯一的顺序分组号，并且每
> 个分组号在给定的安全关联中只能使用一次。
## 4.自动驾驶汽车的汽车网络和系统架构攻击
无论是数据交换和数据通信，又或者是家庭网络安全和企业园区网络安全，涉及两个远距离数据中心网络之间使用光纤互联，光纤穿越的地方属于公共区域，该区域
内的数据暴露风险较大。为了防止数据在中间传输过程中被窃取或修改，可在两个网络边缘设备出 端口上采用 MACsec 对数据传输进行安全保护。
### 4.1 以太网链路窃听攻击实现：
在通常的以太网连接中，没有在数据链路层部署MACsec协议，也没有入侵者进行攻击，获取新数据，接下来查看两种情况，分别是遭受图像监控和数据破坏攻击在没有部署和部署MACsec协议的协议执行流程。
黑客可以通过私密加装中间设备，以偷取数据，监控屏幕，终端无法得知系统是否处于危险状态，也无法得知是否有人窃听网络。
启用MACsec协议，保密传输帧时，成功阻止入侵者获取信息，保证数据的正常显示。
> 处理数据和控制流量：
> 所有流量都在一个活动的MACsec端口上进行控制，在该端口上，数据被加密，或其完整性受到保护。如果MACsec会话无法得到保护，所有数据和控制流量都会被丢弃，当MACsecseC在某个端口上处于活动状态时，该端口会阻止数据流量的流动，在MACsecsec会话安全之前，端口不会转发数据流量。
>
> 如果正在进行的会话被打断，端口上的流量将再次被传输，直到建立新的安全会话。
### 4.2 以太网链路DoS攻击实现：
入侵者可以在中间数据链路层中破坏数据流的传输，导致Camera无法起作用，但并不是Camera出现问题，难以准确定位问题所在。
当部署MACsec协议后，检测入侵者的接收设备并没有得到认证（如RADIUS），所以为了保护正常显示，会在交换设备出阻止入侵连接，进入正常用户数据帧接收处，导致防护成功。
> 数据控制：
>
>
> 在MACsec会话得到保护之前，活动MACsec端口不会传输控制流量（如STP、LACP）。建立会话时，只有8O2.1X协议数据包从端口传输。建立安全会话后，控制流量会正常通过端口。
汽车企业和制造商可可以使用MACsec在最大程度上保护汽车，以免暴露在外界特别容易受到以太网链路攻击，MACsec可以比作汽车安全工具箱中的性价比很高的安全工具，并且MACsec支持系统工程师将其与其他安全措施结合使用（IPSec和TLS）这样的工具。
## 5.路由器Cisco安全MACsec协议配置过程和相关验证
### 步骤1.验证链路两端的配置
显示当前设备的运行配置信息，并只显示与密钥链相关的配置信息，方便管理员查看和管理设备上的密钥链配置。
    C9500#sh run | sec key chain
    key chain KEY macsec
     key 01
     cryptographic-algorithm aes-256-cmac
     key-string 7
    101C0B1A0343475954532E2E767B3233214105150555030A0004500B514B175F5B05515153005E0E5E505C5256400702
    5859040C27181B5141521317595F052C28
     lifetime local 00:00:00 Aug 21 2019 infinite <-- use NTP to sync the time for key chains
    mka policy MKA
    key-server priority 200
    macsec-cipher-suite gcm-aes-256
    confidentiality-offset 0 
显示交换机接口te1/1/3的运行配置信息，包括地理位置、组态信息和特定的协议配置等，可以通过这个命令查看和修改交换机接口的配置信息。
    C9300#sh run interface te1/1/3
    interface te1/1/3
    macsec network-link
    mka policy MKA
    mka pre-shared-key key-chain KEY
### 步骤 2 验证MACsec已启用，且所有参数/计数器都正确
显示MACsec加密的摘要信息
  * Interface：交换机的接口名称。
  * Transmit SC：此接口上MACsec加密所用的下行（即传输数据）Secure Channel ID（SC）计数器的值。
  * Receive SC：此接口上MACsec加密所用的上行（即接收数据）Secure Channel ID（SC）计数器的值。
FortyGigabitEthernet1/0/1 接口使用的MACsec加密。"Transmit SC"和 "Receive SC" 列都有值1。
    C9500#sh macsec summary
    Interface Transmit SC Receive SC
    FortyGigabitEthernet1/0/1 1 1
查看指定接口的MACsec加密的具体配置信息，包括其状态、操作模式、加密策略。
    C9500#sh macsec interface fortyGigabitEthernet 1/0/1
    MACsec is enabled
    Replay protect : enabled
    Replay window : 0
    Include SCI : yes
    Use ES Enable : no
    Use SCB Enable : no
    Admin Pt2Pt MAC : forceTrue(1)
    Pt2Pt MAC Operational : no
    Cipher : GCM-AES-256
    Confidentiality Offset : 0
网络设备的功能列表或能力列表，包括硬件和软件上的功能。
        Capabilities
    ICV length : 16
    Data length change supported: yes
    Max. Rx SA : 16
    Max. Tx SA : 16
    Max. Rx SC : 8
    Max. Tx SC : 8
    Validate Frames : strict
    PN threshold notification support : Yes
    Ciphers supported : GCM-AES-128
    GCM-AES-256
    GCM-AES-XPN-128
    GCM-AES-XPN-256
"Transmit Secure Channels"是指在使用MACsec加密的网络连接中，发送（即传输数据）数据流的安全通道（Secure
Channel）的数量，每个接口可以有多个Transmit Secure Channels，以提供更多的安全通道、更好的容错能力和更高的性能。
    Transmit Secure Channels
    SCI : 0CD0F8DCDC010008
    SC state : notInUse(2)
    Elapsed time : 00:24:38