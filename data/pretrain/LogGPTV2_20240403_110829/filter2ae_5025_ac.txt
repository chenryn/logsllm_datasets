a） 将新用户添加到“远程桌面用户”组
首先，该木马会调用`fn_Base64`自定义函数，解码出后续需要添加的账户名和密码。并设定`Software\Microsoft\Windows
NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist`注册表值为 0 来隐藏新创建的账户。
添加并隐藏创建的新账户
接着，该木马将上文解码出的账户名和密码作为新用户加入到 administor 用户组中。这样便可使用非管理员用户来进行远程桌面登录。
将新账户加入管理员组中
b） 更改远程桌面设置
该木马会修改注册表信息，实现打开远程桌面、多用户支持、更改用户登录和注销方式、使用快速登录切换、以及设置远程“终端服务”的使用名为“RDPClip”等等操作。具体细节如下图所示（仅截取了部分步骤）：
通过分析我们发现，此 RAT 的远程桌面功能是通过特制的 VNC 模块来实现的。并且在后续的更新版本中，还增加了 HRDP 模块来实现隐藏远控桌面。该
HRDP 模块使用了 Github 上的 rdpwrap 项目，不仅可以在后台登录远程计算机，并且创建的 Windows 账户还会自动隐藏。
**权限升级（UAC绕过）**
该木马的权限提升是利用了自动提升权限的合法应用程序“pkgmgr.exe”来执行DISP模块。其功能代码实现是采用了 Bypass-UAC
框架，该框架可以通过调用 IFileOpertion COM 对象所提供的方法来实现自动提权。 该木马先将嵌入在资源数据中的PE文件在内存中加载并运行。而此
PE 文件实际上是一个加载器，其所做的事情则是将资源中的另一个 PE 伪造为“dismcore.dll”，然后将此dll 复制到 System32
目录下，最后使用“pkgmgr.exe”执行伪造的恶意DLL。由于“pkgmgr.exe”是一个 UAC 白名单程序，所以它默认具有管理员权限，且不会弹出
UAC 提示框。部分代码如下图所示：
此恶意DLL 的主要功能是获取注册表中的“Install”安装信息(Dropper的路径)并重新启动具有管理员权限的 Dropper 新进程。
**未知测试**
该木马尝试与远程服务器进行通信，当连接成功时则会向服务器发送“AVE_MARIA”字串作为暗号。然后等待接收服务器返回数据，大小为4个字节。如果接收成功，则开启新线程。
在新线程中，根据远程服务器发送的指令，与新指定的 C&C 进行连接。
由于接收数据无法获取，所以目前我们无法确定其准确用途，暂将其命名为未知测试。
### 4.2 最新攻击样本
我们在2019年3月26日捕获到了最新的关联文档 “Michelle Flores - Curriculum
Actualizado.doc”，其同样通过恶意宏启动攻击。文档首先通过Powershell脚本下载并执行PE文件“massive.exe”(C#编写并加入了大量混淆)。之后包含了两个阶段，第一阶段“massive.exe”会从资源中解密出PE文件“DUMP1.exe”(C#编写)并加载。第二阶段则是“DUMP1.exe”释放自身并通过计划任务设置自启动，最后从资源中提取出
Remcos RAT并以傀儡进程的方式加载运行，核心过程如下图：
**阶段一：**
“massive.exe”从资源中提取并解码出加密字符流，之后通过`StrReverse`函数将该字符流逆序排列，再经`FromBase64String`函数解码，最后通过自定义的解密函数`method_0`解密得到PE文件“DUMP1.exe”。
解密函数method_0如下图所示：
在经过逆序排列和 Base64 解码后的字符串（byte_0）中，前16位为解密密钥`0x28 0x49 0xf7 0x30 0xec 0x8d 0x50
0x80 0x94 0xaf 0x85 0xaa 0xa8 0xe7 0xc0
0x41`,之后为待解密密文。函数以16位为循环,将密钥同密文依次进行按位异或，最终解密得到“DUMP1”文件并通过CallByName函数加载执行。
**阶段二：**
“DUMP1”文件同样采用C#编写，程序首先会睡眠50秒以躲避沙箱检查，之后会检测调试器并将自身释放至`%ApplicationData%\riNpmWOoxxCY.exe`，接着创建“schtasks.exe”进程并添加计划任务“Updates\riNpmWOoxxCY”，从而实现在登录账户时自启动，相关命令如下：
    C:\Windows\System32\schtasks.exe /Create /TN Updates\riNpmWOoxxCY /XML C:\Users\super\AppData\Local\Temp\tmp925C.tmp
之后，程序会从自身资源内解密出PE文件“DUMP2”，通过 CreateProcess、WriteProcessMemory 和
SetThreadContext 等函数，以挂起的方式加载一个新的进程，并最终以傀儡进程的方式写入并加载“DUMP2”。
经过分析，我们在“DUMP2”中发现了一些可疑字符串如：“Remcos”、“Remcos_Mutex_Inj”、“2.3.0 Pro”。
通过大量可疑信息我们确认此木马为Remcos RAT的客户端，且其使用的版本为2.3.0 Pro。以Remcos
RAT免费版V2.4.3为例，服务端如图所示：
其免费版仅可添加一个 C2 连接服务器，专业版则没有数量限制。此次攻击中植入的木马是通过专业版生成且连接至多个恶意 C2 ，包含的 C2 地址提取如下：
  * casillas.hicam.net 
  * casillasmx.chickenkiller.com 
  * casillas.libfoobar.so 
  * du4alr0ute.sendsmtp.com 
  * settings.wifizone.org 
  * wifi.con-ip.com 
  * rsaupdatr.jumpingcrab.com 
  * activate.office-on-the.net 
Remcos RAT
自2016年下半年开始在其官网和黑客论坛售卖，部分厂商曾对其进行过详细的技术分析，在此不做赘述，但这款木马的发现为我们寻找“Curriculum Vitae
Actualizado Jaime Arias.doc”植入的未知木马来源提供了很好的溯源线索。
## 0x05 恶意代码溯源与关联
### 5.1 恶意代码溯源追踪
前文曾提到，“Curriculum Vitae Actualizado Jaime
Arias.doc”植入的木马中包含了“AVE_MARIA”特征字符串，且自2018年12月开始，“AVE_MARIA”类恶意样本在twitter、virustotal等平台越来越多的被发现。但多篇相关研究文章均未指出其真实来源，杀毒厂商也广泛的将其命名为“AVE_MARIA”，这引起了我们浓厚的兴趣。
我们尝试从多种角度去溯源木马以寻找线索，包括域名、IP、关联样本等等。其中在对关联样本“Michelle Flores - Curriculum
Actualizado.doc”的分析中成功溯源到了商用软件 Remcos RAT
。我们分析了该软件的发布渠道，发现其不仅在官网进行销售，还在诸多黑客论坛如 Hackforums
上大量售卖。由此，我们猜测攻击人员很可能活跃在相关论坛并购买过多款商用软件，同时也将溯源重点转向黑客论坛和暗网市场。
我们收集并分析了大量“AVE_MARIA”类恶意样本，发现大部分样本均通过`warzonedns.com`子域名进行恶意连接和下载，追溯发现其实质为黑客提供的
DDNS 服务。结合攻击人员的活动线索，我们成功追踪到 Hackforums 论坛上的可疑用户Solmyr。
Solmyr 在论坛中提供了 warzonedns.com 域名的免费 DDNS 服务（IP动态绑定至子域名），使得用户可以轻易的将服务器IP绑定解析至
warzonedns.com 下的任意子域名，使用示例如下：
这无疑给黑客提供了很好的藏身之所，与此同时我们发现 Solmyr 的另一个身份是 WARZONE RAT
的发布者，该软件由于控制手段丰富、技术功能强大、迭代更新迅速，目前在Hackforums论坛中非常受欢迎。
至此，我们有理由怀疑攻击者使用过该款商用远程管理工具。由于该软件闭源且不提供免费版本，我们追溯到了 WARZONE RAT
流出的破解版本（V1.31），并将其与“Curriculum Vitae Actualizado Jaime
Arias.doc”植入的木马样本进行同源性分析,以确定二者间的关联。
### 5.2 同源性分析
首先，我们在两种样本中均发现了特征字符串“AVE_MARIA”，并且针对两类样本的代码结构进行了比对，发现相似度极高。
其次，我们通过 Bindiff 进行了更为精确的对比，在去除部分 API 干扰并比较分析了可信度高的函数后，发现大量函数完全相同，占比达到
80.16%，其余函数则可能因为版本原因略有差别，这也印证了二者间的强关联性。
另外,从传播时间的角度分析,“AVE_MARIA”关联样本最初出现的时间(2018年12月2日)略晚于WarzoneRAT在论坛的发布时间(2018年10月22日)，这也符合恶意代码传播的时间逻辑。
依据以上几点分析，我们认为两者具有高度的一致性。从目前已知的情况看，WARZONE 被杀毒厂商广泛的识别为
AVE_MARIA，而在深入比对分析后，我们判定黑客组织使用的远控木马正是 WARZONE
RAT。因此可以将此类包含“AVE_MARIA”字符串的恶意样本家族命名更新为“WARZONE”。
### 5.3 域名关联
我们观察到目前与 DDNS 服务 warzonedns.com 相关联的子域名总数共101个，部分截图如下：
这批域名均为 warzonedns.com 提供的免费子域名，且大部分关联至恶意样本，这表明大量黑客正在滥用此类服务进行恶意攻击。
可以判断，Solmyr 团伙作为 WARZONE
类恶意软件产业链的上游供应商，提供了包括免费域名服务、收费恶意软件及其它恶意利用技术等一系列服务，打包售卖给下游黑客使用。此次事件的攻击组织也为其下游客户，通过购买其部分服务，与自身的恶意代码组合利用来达到更佳的攻击效果，同时也能更好的隐藏自己的身份。
## 0x06 总结
本文对本次攻击活动的攻击流程、相关的恶意代码、黑客背景等做了深入的分析和研究，从上文的分析中我们可以看出该黑客组织目前的攻击活动十分谨慎，既没有大规模的攻击，也没有采用高成本的0day漏洞，同时，攻击活动时间也非常短。这表明该攻击活动还处于初期，并对目标进行了一些试探性、针对性的攻击，也为后续的攻击做好准备。此外通过对攻击活动的溯源，我们确定了该次活动背后的黑客组织，并根据该黑客组织的活动历史，发现其民族主义色彩强烈，因此政治目的意图也较为明显。
当前利用宏进行网络攻击已经成为一种成本较低的攻击方式，因此也被大量的黑客组织所使用。黑客常常利用目标的一些薄弱环节来进行此类攻击，具有一定的成功率，通过诱饵文档可以看出，本次活动针对的是政府机构的招聘部门，此类人群具有相对较弱的安全意识，且由于工作中需要翻阅的简历量较多(如财政部门的简历量通常较大)，使得相关人员无法分辨伪装得较好的恶意简历文件。再加上多阶段在线下载恶意代码的策略、无文件技术和打包加密技术的使用，从而大大提高了攻击的成功率。因而此类攻击需要相关部门提高警惕，加强体系架构中的短板防范。
**IOC**
* * *
**启明星辰积极防御实验室（ADLab）**
ADLab成立于1999年，是中国安全行业最早成立的攻防技术研究实验室之一，微软MAPP计划核心成员，“黑雀攻击”概念首推者。截止目前，ADLab已通过CVE累计发布安全漏洞近1000个，通过
CNVD/CNNVD累计发布安全漏洞近500个，持续保持国际网络安全领域一流水准。实验室研究方向涵盖操作系统与应用系统安全研究、移动智能终端安全研究、物联网智能设备安全研究、Web安全研究、工控系统安全研究、云安全研究。研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。
* * *