出攻击特征来进行
Step3.绕过主机入侵检测： 宏观检测。例如免
恶意文件调用底层函数进内核，或是使用偏僻语言的小众工具，在 杀的Office宏病毒、
主机入侵检测的盲区内进行运行。欺诈用户点击精钓邮件的URL 远程模板加载等新 海通证券安全团队对恶意附件所做分类
86 87
行
业 构建邮件纵深安全体系，提升互联网重要入口安全运营水平
专
刊
攻击的方式：通过运行Word后会从攻击者建立的VPS上加载模 2.2.2文本
板，进而携带返回免杀宏病毒，这对于传统沙箱使用静态查杀的检 ◆ 诈骗文本
测的机制便可以成功绕过。同时并不是只有Word文件有宏病毒， 诈骗文本通常是定向发送给安全意识较为薄弱的企业员工。目前阶
Excel也是爆出过CVE-2018-0802、CVE-2017-11882等多个CVE。 段最需要引起重视的诈骗就是BEC（商业欺诈邮件），此种攻击
方式通常会冒充企业高管或是合作金融单位，向财务人员发送需要
挪用资金或者向供应商打款的邮件文本。
◆ 勒索文本
攻击者通过描绘模
糊性事件或是获取
Office宏病毒绕过检测的方式 收件人一定的信息
后进行扩展捏造，
此时需要防护设备可以从攻击特征、攻击行为等方面来多维度检测 使得收件人似是而
附件。 非的认为攻击者掌
握了确实可以要挟
◆ 加密附件 自己的信息，慌乱
加密压缩包却是最常见的APT攻击手法之一，通过将威胁附件进行 和害怕中被敲诈成
压缩加密，并将解压密码写进正文的方式来绕过常规网关、沙箱等邮 功。 勒 索 文 本 在
一封真实的比特币勒索邮件
件防护设备。面对这种攻击，就需要安全人员对这些重点邮件多进行 WannaCry病毒爆
关注，配合网关将所有的加密压缩包邮件单独提取出来进行检测。 出的那段时间内非常流行，很多时候企业因为无法快速理自身到底
是否存在机器沦陷，从而在危急情绪下了接受了勒索团队的要挟。
……………………………………………
◆ 广告垃圾
各大邮件服务商都会引入DNSBL技术，使得垃圾邮件都会被打上
SPAM标签被拒收，所以广告之类的垃圾邮件现阶段对安全的威
胁性较小。
一封真实绕过网关的攻击邮件
88 89
行
业 构建邮件纵深安全体系，提升互联网重要入口安全运营水平
专
刊
2.2.3链接 ◆ 撞库
◆ 伪造的URL链接 很多邮箱使用者在使用不同网站或不同账号时使用的是相同的密
伪造URL一般都会结合诈骗文本使用，在邮件中的URL是可以编 码，因此攻击者可以通过社工库先获取邮箱使用者在他处使用的密
辑的，从而使得邮件真正的跳转URL和文本中显示的URL不一致。 码，进而对邮件系统进行撞库攻击，这类将大部分人使用密码习惯
融入攻击的手法成功率往往不低。
◆ 短链接跳转
短链接是攻击者为了绕过URL检测的一种新思路，毕竟正常的邮 ◆ 劫持嗅探
件中很少会出现短链接。但是没那么优秀的网关就会把这些威胁 该种攻击方式适用于获取相关网络设备的权限后进行，如果邮件发
URL放过，导致企业邮件防护阵线出现安全隐患。 送或收取时使用未进行加密成SMTPs和POP3s/IMAPs，而是单
纯通过base64编码或直接明文发送，攻击者便可以直接利用劫持
2.2.4图片 的网络流量，从中提取出对应的邮箱账号及密码等信息。
攻击者把恶意的内容制成图片放到正文中来绕过安全设备的检测。
又或是把钓鱼链接或由其他恶意链接生成二维码插入到邮件正文
当中，利用收件者会拿出手机扫描二维码的习惯来绕过安全防护措
施中的检测机制。
2.3邮件账号安全
大多数邮件运维人员通常将更多精力放在能否从邮件接受层面来
防御邮件攻击，通过识别邮箱载体是否存在威胁进行防护。然而，
攻击者早已经转换了攻击思路，通过从邮箱账号层面进行更深入有 SMTP中的base64加密流量
效的攻击。
2.3.1获取邮箱账号权限
◆ 爆破
攻击者测试通过web界面以及SMTP、POP3、IMAP登录的方式，
判断是否存在爆破的可能性，此类手法的判断主要看输入错误时提
示是否有“用户名不存在”还是“输入密码错误”之类的有效信息
返回。 pop3中明文流量
90 91
行
业 构建邮件纵深安全体系，提升互联网重要入口安全运营水平
专
刊
2.3.2权限维持 三、构建邮件纵深安全体系
攻击者通过撞库或者社工等方式拿到某一个账号的密码时可以设
置代收接管这个账号的所有邮件。 海通证券通过不断的对抗总结与运营反馈，针对邮件纵深安全体系
总结出了一些应对经验和问题排查技巧。
有两种方式来长期获取目标邮件,pop3收取和邮件转发。
3.1邮件服务器基本核查
◆ pop3收取 1)…注意邮件客户端或者是邮件服务器自身的漏洞，及时的更新服
如果是公开邮件服务，通过此方式基本可以无痕的收取所有目标账 务器版本和客户端版本是非常重要的，同时安全管理人员需要
号上的邮件。 时刻的关注有没有最新的0day信息，做好第一时间处理事件的
准备；
◆ 邮件转发
2)…关闭外部通过SMTP、POP3、IMAP直接登录的功能。很多企
业邮件服务器25端口是直接暴露在外的，直接telnet连接就可
以对内伪造发邮件了；
3)…限制同IP和同账号一定时间的登陆频率；
4)…如果条件允许，内对内的邮件使用独立的邮件系统，外到内和
内到外使用另一套独立系统。这样一旦出网的邮件系统发生了
账号失陷问题，对内无法横向移动，进而可以缩小影响；
5)…尽量不对公网开放web端登录邮件系统的功能，如果有移动办
公的需求应该使用企业自身的邮件终端。
3.2邮件服务器安全协议
攻击者利用这种方式的话，海通证券邮件系统运维人员可通过邮件 ● 使用邮件三大安全协议：
系统的网页客户端发现痕迹，而且在NTA检测设备上会发现有大 对于邮件伪造引起的安全问题，SPF、DKIM、DMARC三大策略
量邮件外发流量。 如果都配置正确，基本可以完全杜绝伪造发件人，其中尤其需要注
…
92 93
行
业 构建邮件纵深安全体系，提升互联网重要入口安全运营水平
专
刊
意的是SPF的配置过程中~all(软拒绝)和-all(硬拒绝)的区别。 账号都应该限制最大收件人数量。
通常默认是软拒绝，这样不能完全保证安全。
● 配置单用户发件上限：
同时查询SPF记录的过程中同样会暴露服务器的真实IP，也需要 为了确保在某一账号失陷后能造成的影响最小化，应该把单用户的
对这些资产做安全性排查。 发件上限设置一个合理的阈值。
3.3邮件资产安全防护
● 二次认证：
登录的时候尽量避免直接使用密码，可以通过密码+短信验证码/
令牌的二次认证码等方式来解决。
● 限制登陆口：
某度的SPF配置 限制外部IP通过telnet…25端口连接邮件服务器，很多情况下攻击
者可以直接通过命令SMTP来实现邮件内对内伪造发件人发送。
● 使用RMX协议：
RMX类似于RDNS…，一个MX服务器收到了邮件之后，会去反向 ● 禁用web端：
查询发件IP地址是否有对应的MX记录解析。 公网web端收取邮件始终是存在风险的，如果不是刚需的情况，
建议企业内使用移动端配合客户端的方式来收取邮件。
● 开启SSL/TSL：