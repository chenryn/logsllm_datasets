BTB
ind. branch
User
space
Kernel
space
BHI Capabilities
35
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
PRIV
TAG
TARGET
kernel
TAG_A
valid_target_a
user
TAG_B
user_func
kernel
TAG_C
valid_target_b
kernel
TAG_D
other_target_1
kernel
TAG_E
other_target_2
BTB
call f_a
syscall
ind. branch
call f_b
call ...
call f_y
User
space
Kernel
space
call f_z
BHI Capabilities
35
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
PRIV
TAG
TARGET
kernel
TAG_A
valid_target_a
user
TAG_B
user_func
kernel
TAG_C
valid_target_b
kernel
TAG_D
other_target_1
kernel
TAG_E
other_target_2
BTB
call f_a
syscall
ind. branch
call f_b
call ...
call f_y
User
space
Kernel
space
call f_z
BHI Capabilities
35
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
PRIV
TAG
TARGET
kernel
TAG_A
valid_target_a
user
TAG_B
user_func
kernel
TAG_C
valid_target_b
kernel
TAG_D
other_target_1
kernel
TAG_E
other_target_2
BTB
call f_a
syscall
ind. branch
call f_b
call ...
call f_y
User
space
Kernel
space
Attacker can mistrain to any
indirect branch target
call f_z
BHI Capabilities
35
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
PRIV
TAG
TARGET
kernel
TAG_A
valid_target_a
user
TAG_B
user_func
kernel
TAG_C
valid_target_b
kernel
TAG_D
other_target_1
kernel
TAG_E
other_target_2
BTB
call f_a
syscall
ind. branch
call f_b
call ...
call f_y
User
space
Kernel
space
Attacker can mistrain to any
indirect branch target
call f_z
Latest 67 
branches 
define context
BHI Capabilities
35
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
PRIV
TAG
TARGET
kernel
TAG_A
valid_target_a
user
TAG_B
user_func
kernel
TAG_C
valid_target_b
kernel
TAG_D
other_target_1
kernel
TAG_E
other_target_2
BTB
call f_a
syscall
ind. branch
call f_b
call ...
call f_y
User
space
Kernel
space
AEacker can mistrain to any
indirect branch target
call f_z
We need to 
control 8 
branches
Exploitation
36
Exploitation â€“ The Plan
37
TAG
PRIV
TARGET
BTB
Exploitation â€“ The Plan
37
TAG
PRIV
TARGET
BTB
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
Exploitation â€“ The Plan
37
BTB
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
TAG
PRIV
TARGET
1337
kernel
leak_gadget
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2
BPU
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2
BPU
2B04
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
BPU
2B04
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
Exploitation â€“ The Plan
37
f_39ca7e94 ()
â””â–º ...
â””â–º f_26a2be2()
â””â–º syscall(getpid)
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
Exploitation â€“ The Plan
37
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
f_d2550282 ()
â””â–º ...
â””â–º f_6c6d0c06()
â””â–º syscall(getpid)
Exploitation â€“ The Plan
37
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
BPU
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
f_d2550282 ()
â””â–º ...
â””â–º f_6c6d0c06()
â””â–º syscall(getpid)
5F33
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
5F33
kernel
sys_getpid
Exploitation â€“ The Plan
37
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
f_1554b7b2 ()
â””â–º ...
â””â–º f_c10573ce()
â””â–º syscall(getpid)
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
5F33
kernel
sys_getpid
Exploitation â€“ The Plan
37
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
BPU
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
f_1554b7b2 ()
â””â–º ...
â””â–º f_c10573ce()
â””â–º syscall(getpid)
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
5F33
kernel
sys_getpid
1337
Exploitation â€“ The Plan
37
sys_call_table[NR_getpid](regs)
â””â–º ???
BTB
User space
Kernel space
1
Kernel space
trigger_leak_gadget()
User space
leak_gadget()
2
BPU
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
f_1554b7b2 ()
â””â–º ...
â””â–º f_c10573ce()
â””â–º syscall(getpid)
TAG
PRIV
TARGET
1337
kernel
leak_gadget
2B04
kernel
sys_getpid
5F33
kernel
sys_getpid
1337
==
predict leak_gadget
Exploitation â€“ Victim Branch
â€¢
Syscall handler is a good victim:
â—‹
We can easily trigger it with any syscall
38
Exploitation â€“ Victim Branch
â€¢
Syscall handler is a good victim:
â—‹
We can easily trigger it with any syscall
â—‹
RDI points to user-space saved 
registers
38
Exploitation â€“ Leak Gadget
â€¢
We need to find a leak gadget in the kernel code
â€¢
Why donâ€™t we JIT it with unprivileged eBPF ?
(Yep, there is a JIT engine in the Linux kernel)
39
Exploitation â€“ Leak Gadget
â€¢
We need to find a leak gadget in the kernel code
â€¢
Why donâ€™t we JIT it with unprivileged eBPF ?
(Yep, there is a JIT engine in the Linux kernel)
39
JIT
Exploitation â€“ Transient Type Confusion
40
Architectural:
x = skb->sk->mark
fr_buf[(x&0xff)sk->mark
fr_buf[(x&0xff)sk->mark
fr_buf[(x&0xff)sk->mark
fr_buf[(x&0xff)<<12]
Speculative:
x = *pt_regs.r12
fr_buf[(x&0xff)<<12]
Transient Type Confusion 
bypasses Spectre mitigations
Exploitation â€“ Covert Channel
â€¢
eBPF is so kind to offer a nano-second precise timer!
Perfect for our FLUSH+RELOAD covert channel
41
LIVE DEMO
42
Vendor response &
Mitigations
43
Affected Processors
â€¢
Intel
â—‹
Branch History Injection (BHI) CVE-2022-0001
â– 
Every CPU since 10th generation included
â€¢
Arm
â—‹
Spectre-BHB CVE-2022-23960
â– 
Cortex-{R7,R8}
â– 
Cortex-{A57,A65,A72,A73,A75,A76,A77,A78,A710}
â– 
Neoverse-{E1,N1,V1,N2}
â– 
Cortex-{X1,X2}
44
Mitigations
â€¢
Intel
â—‹
Disable unprivileged eBPF and keep eIBRS enabled
â—‹
Additional hardening options:
â– 
[SW]  Retpoline / Software BHB-clearing sequence
â– 
[HW] Future Processors may mitigate BHI in Hardware
â€¢
Arm
â—‹
[SW] BHB-clearing sequence / New clearbhb instruction / Trusted firmware workaround 3
â—‹
[HW] CSV2.3 / Exception Clears Branch History Buffer
â€¢
AMD
â—‹
Not affected
45
Mitigations
â€¢
Intel
â—‹
Disable unprivileged eBPF and keep eIBRS enabled
â—‹
Additional hardening options:
â– 
[SW]  Retpoline / Software BHB-clearing sequence
â– 
[HW] Future Processors may mitigate BHI in Hardware
â€¢
Arm
â—‹
[SW] BHB-clearing sequence / New clearbhb instruction / Trusted firmware workaround 3
â—‹
[HW] CSV2.3 / Exception Clears Branch History Buffer
â€¢
AMD
â—‹
Not affected
45
,  kinda
Conclusion
â€¢
Spectreâ€™s attack surface is too wide to define
â€¢
Disabling unprivileged eBPF is another stopgap defense
â€¢
Speculative execution attacks are becoming harder and harder ðŸ‘
46
@b4rbito  @pit_frg
@nSinusR
@vu5ec
47
https://vusec.net/projects/bhi-spectre-bhb