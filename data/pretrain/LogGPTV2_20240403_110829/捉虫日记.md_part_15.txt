temsonaine0
Aignment
（1e.0ato）
图5-9用IDAPro的默认栈顿显示来确定栈缓冲区SubKey的大小
代码清单5-4有漏洞的sprintf()调用，C语言伪代码
[..]
int
Sub_1000B37D(DWORD cbData，LPBYTE 1pData,int val1，int val2，int val3)
{
char SubKey[260];
sprintf(&SubKey，"SOFTWARE\\Webex\\UCF\\Components\\%s\\%s\\Insta11",
"Authoring"，cbData);
[..]
库函数sprintf()从cbData复制用户控制数据、Authoring字符串（9字节）
和格式字符串（39字节）到SubKey。如果cbData填充了最大长度的用户控制数
据（256字节），总共将有304字节的数据被复制到栈缓冲区中。SubKey只能存放
260字节的数据，而sprintf()不做任何长度检查。因此，如图5-10所示，用户控
制数据可能写到Subkey之外，这将会导致栈缓冲区溢出（见A.1节）。
---
## Page 96
5.2漏洞利用81
溢出前的栈
溢出后的栈
".InstalP*
用户控制的教据
保存的返回地址
写的方向
SubKey
Subkey ( 260B )
(260B)
SOFTWARE\Webex\
UCF\Comp
Authoring\..
ents\
图5-10一个过长的字符串传递给NewObject（）时发生的栈缓冲区溢出示意图
5.2漏洞利用
找到这个漏洞之后，利用它是非常简单的。我只需微调传递给NewObject(）
的字符串参数的长度，使得栈缓冲区溢出，然后控制当前栈帧的返回地址。
如图5-9所示，从Subkey缓冲区到栈上保存返回地址的位置有272字节（保
存返回地址的偏移（+00000004）减去SubKey的偏移（-0000010C）：0x4－-0x10c=
0x110(272)）。还要考虑字符串Authoring以及部分格式字符串将被复制到Subkey
中正好位于用户控制数据之前的位置（见图5-10）。总而言之，我必须从SubKey
到保存的返回地址的间距中减去40字节（SOFTWARE\Webex\UCF\Components\
Authoring\）（272-40=232）。因此我要提供232字节的伪数据（dummydata）
来填充栈，直到栈上保存的返回地址处。然后紧接着的4字节用户控制数据将覆
写栈上保存的返回地址值。
因此我改变了webex_pocl.html第6行提供的字符数，并把文件重命名为
webex_poc2.html（见代码清单5-5）。
代码清单5-5传递一个过长的字符串给NewObject（)方法的HTML文件
(webex_poc2.html)
01
02WebExPoC2
03
04
---
## Page 97
82|第5章浏览即遭劫持
05
06
arg=String(232,"A")+String(4，“B")
07
obj.NewObject arg
08
60
10 
然后调整那个简单的PythonWeb服务器以伺服这个新的HTML文件。
原来的wwwserv.py如下。
09
f = open(curdir + sep +“webex_poc1.html")
调整后的wwwserv.py如下。
09
f= open(curdir + sep+"webex_poc2.html")
重启Web服务器，在WinDbg里加载IE，再次导向http://www.webex.com/。
如图5-11所示，现在我完全控制了EIP。使用著名的堆喷射（heapspraying）
技术，这个bug很容易利用，用来实现任意代码执行攻击。
C:ProgamFilsntereExporerlxlore.xeWibg:6.11.0001.404x86
FleEdtWiw DebugWicHp
回口口口
0000099
609
DDDO
UINDON
6f2
VINDOUS
systen32DsnaPDdd
6fe
76f
000
INDONS
odL
le5
D1e690D0
32
odL
cd000
Prograh
odT
60B
760e500
1247
05796000
FilesVebExVebExB24atres
33000007336a000
ten32^vbscript.dl1
78.3bc)
rst
This
0000690009200
Q:000
nCooSysO
000178003
图5-11IE的EIP控制
照例，德国法律不允许我提供一个完整的、可工作的漏洞利用程序，如果你
有兴趣，可以到本书的网站上看看我录制的一个演示实际漏洞利用程序的视频
片段。[9]
---
## Page 98
5.5补充83
之前提到过，如果用COMRaider来模糊测试这个ActiveX控件，而不是读汇
编代码，我能更快地找出这个bug。但是，嗨，读汇编代码比模糊测试酷多了，
不是吗？
5.3漏洞修正
2008年8月14日，星期四
在第2章到第4章里，我把安全bug直接通知了受害软件的开发商，并帮助
他们打好补丁。这个bug我选择另外一种披露过程。这一次我没有直接通知开发
商，而是把这个bug出售给一个漏洞经纪人（VerisigniDefenseLabs的“VCP计
划”），之后由他们和思科协作（见2.3节）。
2008年4月8日，我联系了iDefense。他们接受了我的提交，并把这个问题
通知了思科。在思科正开发新版的ActiveX控件时，另一位安全研究员ElazarBroad
在2008年6月重现了这个bug。他也通知了思科，但随后以完全披露的方式公开了
这个bug。2008年8月14日，思科发布了WebEx会议管理软件的一个修复版本
以及一份安全报告。总之乱作一团，但最终Elazar和我还是让互联网更安全了一些。
5.4经验和教训
口在广泛部署的（企业）软件产品中仍有明显的、容易利用的bug。
口跨站点脚本攻击破坏ActiveX的域限制。对微软的SiteLock而言也是这样[]。
口从捉虫人的观点来看，ActiveX控件是有前途、有价值的目标。
口漏洞会被重复发现（太经常了）
5.5补充
2008年9月17日，星期三
因为这个漏洞已修复，WebEx会议管理软件的新版本也已经可以获得，所以
今天我在自已的网站上发布了一份详细的安全报告l2。这个bug的编号是
CVE-2008-3558。图5-12显示这个漏洞修复的时间表。
---
## Page 99
84第5章浏览即遭劫持
iDefenseVCP收到漏洞通知
Elazar Broad公布漏同（完全披霞）
发现漏洞
漏洞复现
会议管理软件新版发布我公开安全报告
1
04.06.200804.08.200806.20.2008
08.06.2008
08.14.200809.17.2008
图5-12从发现WebEx会议管理软件的这个漏洞到发布其安全报告的时
间表
附注
[1]iDefense的COMRaider是列举和模糊测试COM对象接口的强大工具。见
http:/labs.idefense.com/software/download/?downloadID-23（短址为http:/bit.ly/yEG097）。
Scripting for ActiveX Controls)"”，网t址：http://msdn.microsoft.com/en-us/library/aa751977
(VS.85).aspx（短址为http://bit.ly/ACfHmv）。
[3]见“Not safe = not dangerous? How to tell if ActiveX vulnerabilities are exploitable in Internet
Explorer（不安全=不危险？如何判断ActiveX漏洞在IE中是可利用的）”，网址：
http://blogs.technet.com/srd/archive/2008/02/03/activex-controls.aspx(短l为http://bit.ly/xJDqOA）
[4]关于跨站脚本攻击的更多信息，参考：https://www.owasp.org/index.php/Cross-site_Scripting_
(XSS）（短址为http://bit.ly/yV7cWM）。
[6]见 http://msdn.microsoff.com/en-us/library/9a16d4e4-a03d-459d-a2ec-3258499f6932(VS.85)(短址
为http://bit.ly/yWw0R9)
[7]WinDbg是Microsof“官方的”Windows调试器，作为免费的“Windows调试工具（Debugging
ToolsforWindows）”组件的一部分发布，可从以下网址得到：http://www.microsof.com/
whdc/DevTools/Debugging/default.mspx（短址为http://bit.ly/Akd3nd）。
[9]见http://www.trapkit.de/books/bhd/（短址为http:/bit.ly/yZX6td）。
[11]关于MicrosoftSiteLock的更多信息，见http://msdn.microsoft.com/en-us/library/bb250471%
28VS.85%29.aspx（短址为http://bit.ly/xd5rul）。
[12]关于WebEx会议管理软件这个漏洞的细节，我的安全报告可从以下网址得到：http://www
trapkit.de/advisories/TKADV2008-009.txt（短址为http://bit.ly/wOUVRk）。
---
## Page 100
android与iphone及ipad开发书辖
持续不断更新中
OEFoxit PDF Editor ±a/4-
cc++、c语言pdf书精及vip频数程cc++、c、c-持续不新更新中
20OAOUEAAE
dephi《书》及《机频》教程
持续不断更新中
都网易语言系列培训数程（100集全），集中营易语言学习视额（80集）
E网情深VIP系列现频数程黑客破解票岛修链班，VB编程学习班，仿站学习培训，免条培训，个人系统攻防系列
案据系列vip视额数程ghost运控控制源码讲解数程，套接字编程，DLL程序编写，键盘监驱动程序编写，驱
数程，服务器搭建学习班，PHOTOSHOP平面设计班，基础制作论坛（论坛网站搭建），网赚系列数程，网站建设数
动基础数程，AsyncSelect模型QQ程序数程，C++语言入门基，NB5.5源码分析数程
程，同站混润基础，远程控制数程，软件破解班，脚本漏润提权班
游戏开发pd书籍
持续不断更新中。
IT9网络学院VIP系列规频数程免杀培训班，VMware虚拟机，零基础学习C语言，同糖外挂开发癌是系列语音
炒级投资pdf书等及视频数程短线高手系列，短线天王系列，操盘论道系列，翻倍黑马，看盘快速入门，庄家手
数程[外挂数程学才必备研修31课全），VB语言数程30课全，Delphi编程到精通，远程控制软件，加密解密班，同格
法大吸光等等。
网址：VLSAM168.488GB.COM
安全与黑客玖防培训，从入门到桶通完整系统化学习C++摘程，具入门到精退零基础学习汇调，wordpress教程（个人
热门小说集中营做世九重天，网游之三国时代，武动坤
博客系统49提全），外行人做易语言盗号和约鱼程序语音数程
网址：ULSAM168.400GB.COM
甲壳虫VIP数程全集asp教程，Delphi培训班，FLASH海训旺，Java培调班，Inux培训班，PHP培训班，遵
Java节籍
持续不断更新中
码免杀班，甲壳虫C++，瞬本功防班，免杀班初、中、高级旺，碳解班，源码免条班，脱壳班，易语言培训班，无特征
photoshop、CorelDRAW、AutocAD等图像处理书静及vip视数程
码免杀，网站构增训班，外挂高级班，外挂初磁班第1、2部
特续不断更新中
powerbuilder书链大全
玻解、免杀、入侵、脱壳、攻防及调润分析系列VIP规频数程（80多部）天草、黑客功画吧等等…-持续不
Visual Basi语言vip视频数程及pd书籍
持续不断更新中
断更新中...
网站建设相关的pdf书籍及各种vip视频数程
windowsInux系统开发、系统封装等pd书辐及VIP须数程
一拼续不断更新中。
特续不断更新中
网摄、淘宝系列vip机频数程同30天新人魔鬼训练，屠龙网睡团队vip课程，站长大学网赚视频（50课全），
《30S Maxd书籍
正展因队日硬1000元竞价行销数程，展龙团队润宝室贝卖疯系列，站群网廉系列，淘宝开店视频，红星挂机日硬10
汇编语言》、《反汇衡》及《南pd书排及vip机数程
持续不断更新中....
元，百万流量系列，源流圣手全目动挂机引，贴吧邮件定向营销病狂成交量月入万元
《电子书、电子书、还是电子书》pd专题率编程开发，家居美食，儿童益智，人物传记，增强记亿，快速阅读
英语学习资料百科大全不斯更新。
信息系统项目管理师、网络工程师、系统分析师等软考类书籍
饭客论坛系列VIP机频数程解本入侵班，黑客之免杀撤程，易语言数程，无线网络功防数程，入侵数程，
华中红客系列vip视频数程聊本攻防培训旺，遵码免承培训班，Css语言培训班，C语言，Dreamweaver网页
delphi系列撤程，需客基础入门
设计，html网页设计培训旺，PC安金班，php期本语言培训旺，VMWare虚拟机专题，webshel提权培训班，防站
黑客书籍有关黑客、安全、加解密技术等等
持续不断更新中
数程，零基免杀培训班，刷钻速成班，脱亮破解班，外挂编写班，网络赚钱培训班，网站入侵培训班
黑手安全网VIP系列规频数程DIV+CSS网页相局，Dreamweaver数程，lsah动画数程，photoshop数
外挂、驱动、逆及封包机频数程郁金香、独立团、夜猫论坛、天都吧、看流星论坛、一切从零开始等等
程，限我一起学C++课程，抓璃
安全中国系列vip视额数程易语宫款件编短培训班，ASPnet网站开发项目实战培训班
果厘、黑基、黑防、黑后vip系列频数程破解提离班66误全，SQL注入，ASP注入数程，完完全全学会抓肉
我的收案
鸡，脱亮破解数程50课全，提权班，C语言特训班26满全，黑客御本特训班，黑客工具特训班，dedecms仿站数程，
按键精灵及TC解本开发软伴机频数程
持续不断更新中
VC演写远控30课全，网页美工特训班，本马免杀特训班，驱动开发技术VIP培训班，外挂碳解等等。
全当前位置：/《电子书、电子书、还是电子书》pd专题库4
[电脑世界的通关密语：电胞编程基础](杉浦资）数永红扫描质.pdf
文件名
PDF电子书专题库，内容详尽，每天不新更
新！
[程序语言的奥妙：算法解读[四色全彩）].（杉浦质）李克秋、扫措版.pdf
办公类软件使用指南
学
[差结：软件错误的致命影响](帕的斯）字恒等扫描版.pdf
历史人物传记
[其法之道（第2版）]邹恒明扫描版.pdf
暂学宗数
[O'Reil：深入学习MongoDB](霍多罗夫）.巨成等扫描版.pdf
外语资料（除英语外）（除英语外）
官场小说
[深入选出WPF]刘肤猛扫描版.pdf
建筑工程类
持续不斯更
数程及书籍仅用于学
编
[Go语言云动力（云计其时代的新型缤程语言）]类虹剑，扫描板.pdf
黄愚生活类小说
美自负！
政治军事
[精通NET互作：P/Invoke、C++Interop和COMInterop]黄际洲等扫描版.pdf
数育学习科普大全
网址：WLSAM168.400GB.C0M
[编程的奥秘：NET软件技术学习与实践】金相亮，扫描板.pdf
文学理论
[O'Reily：学习OpenCV（中文版）]（布拉德斯基等）于仕琪等，扫猫版.pdf
智力开发、增强记忆、快速阅读技巧大全
[Go语言编程]许式伟等扫描板.pdf
社会生活
网址：VLSAM168.480GB.C0M
科学技术
[MySQL技术内幂：SQL编程]美承凳扫掘板.pdf
程序编程类
[Tomcat威指南（第2版）]（布里泰恩等）吴豪等扫描版.pdf
经济管理
网络安全及管理
[Ex江湖]大穷秋.扫描版.pdf
网系列
[IT名人堂·OradleDBA突击：帮你嘉得一份DBA职位]张明扫描版.pdf
美食小吃烹饪煲访大全
课外读物
Total:77
123456
HTTP:/WLSAM168.400GB.COM
---
## Page 101
6
一个内核统治一切
2008年3月8日．星期六
花了些时间检查开源内核，发现几个有趣的bug之后，我想知道自己是否能
发现微软Windows操作系统驱动程序中的bug。Windows有很多现成的第三方驱
动，想挑出几个好利用的不太容易。最后我选择了几款防病毒产品，因为它们通
常是有希望捉虫的目标"。我访问了VirusTotal网站，从列表中选择我所知道的
第一款防病毒产品：ALWILSoftware的avast!3]。
2010年6月1日，ALWIL
事实证明，这个偶然的决定带来了意外的发现。
Software更名为AVAST Software.
6.1发现漏洞
中章介绍的这个漏洞影
发现这个漏洞的步骤如下。
响avast！专业版4.7支持的所
口第一步：为内核调试准备一个VMware客
有微软windows平台.本章里
户机。
我用的平台是32位windows
口第二步：生成一个avast!创建的驱动和设备
XPSP3的默认安装.
对象列表。
---
## Page 102
86第6章一个内核统治一切
口第三步：检查设备的安全设置。
口第四步：列出IOCTL。
口第五步：找出用户控制的输人数据。
口第六步：逆向工程IOCTL处理程序。
6.1.1第一步：为内核调试准备一个VMware客户机
首先，我创建了一个WindowsXPVMware客户机系统，使用WinDbg配置
远程内核调试[。B.3节介绍了必要的步骤。
6.1.2第二步：生成一个avast!创建的驱动和设备对象列表
在VMware客户机系统中下载安装avast!专业版的最新版本之后，用
DriverView生成一个avast!加载的驱动程序列表。
DriverView的好处之一是它让识别第三方驱动变得容易了。如图6-1所示，
生成这个驱动程序的设备对象列表。