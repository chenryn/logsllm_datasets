o
r
P
a
t
o
t
_
d
l
s
e
i
r
t
n
E
e
h
c
a
c
s
n
d
_
n
l
t
n
u
o
C
s
C
e
c
v
e
d
_
r
i
i
i
s
n
a
m
o
D
e
k
o
o
C
e
u
q
n
u
i
Fig. 2: The difference of the distributions of a given artifact’s values between real user systems and sandboxes, based on the
Mann-Whitney U test. An effect size above 0.3 (highlighted with light yellow) can be interpreted as a medium difference, while
an effect size above 0.5 (highlighted with red) corresponds to a high difference between the two distributions.
Features
(cid:20)
(cid:85)(cid:72)(cid:74)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:71)(cid:72)(cid:89)(cid:76)(cid:70)(cid:72)(cid:38)(cid:79)(cid:86)(cid:38)(cid:82)(cid:88)(cid:81)(cid:87)
≤ (cid:23)(cid:21)
> (cid:23)(cid:21)
(cid:21)
(cid:70)(cid:82)(cid:82)(cid:78)(cid:76)(cid:72)(cid:39)(cid:76)(cid:73)(cid:73)(cid:39)(cid:68)(cid:92)(cid:86)
≤ (cid:28)(cid:26)(cid:20)
> (cid:28)(cid:26)(cid:20)
(cid:22)
(cid:85)(cid:72)(cid:74)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:68)(cid:88)(cid:87)(cid:82)(cid:53)(cid:88)(cid:81)(cid:38)(cid:82)(cid:88)(cid:81)(cid:87)
≤ (cid:21)
> (cid:21)
(cid:24)
(cid:81)(cid:72)(cid:87)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:87)(cid:70)(cid:83)(cid:38)(cid:82)(cid:81)(cid:81)(cid:72)(cid:70)(cid:87)(cid:76)(cid:82)(cid:81)(cid:86)
≤ (cid:20)(cid:26)
> (cid:20)(cid:26)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:25)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:27)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:23)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:22)(cid:20)(cid:12)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:20) (cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:26)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:21)(cid:25)(cid:12)
(cid:20) (cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:27)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:20)(cid:12)
(cid:20) (cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:28)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:26)(cid:25)(cid:12)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)(cid:17)(cid:21)
(cid:19)(cid:17)(cid:21)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:19)
(cid:19)
(cid:19)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:85)(cid:72)(cid:74)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:68)(cid:88)(cid:87)(cid:82)(cid:53)(cid:88)(cid:81)(cid:38)(cid:82)(cid:88)(cid:81)(cid:87)
≤ (cid:23)
> (cid:23)
(cid:21)
(cid:71)(cid:76)(cid:86)(cid:78)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:87)(cid:82)(cid:87)(cid:68)(cid:79)(cid:51)(cid:85)(cid:82)(cid:70)(cid:72)(cid:86)(cid:86)(cid:72)(cid:86)
≤ (cid:27)(cid:20)
> (cid:27)(cid:20)
(cid:20)
(cid:72)(cid:89)(cid:87)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:86)(cid:92)(cid:86)(cid:86)(cid:85)(cid:70)
≤ (cid:25)(cid:20)
> (cid:25)(cid:20)
(cid:21)
(cid:71)(cid:76)(cid:86)(cid:78)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:87)(cid:82)(cid:87)(cid:68)(cid:79)(cid:51)(cid:85)(cid:82)(cid:70)(cid:72)(cid:86)(cid:86)(cid:72)(cid:86)
≤ (cid:27)(cid:20)
> (cid:27)(cid:20)
(cid:22)
(cid:85)(cid:72)(cid:74)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:88)(cid:86)(cid:85)(cid:68)(cid:86)(cid:86)(cid:76)(cid:86)(cid:87)(cid:38)(cid:82)(cid:88)(cid:81)(cid:87)
≤ (cid:27)(cid:22)
> (cid:27)(cid:22)
(cid:22)
(cid:81)(cid:72)(cid:87)(cid:68)(cid:85)(cid:87)(cid:76)(cid:73)(cid:68)(cid:70)(cid:87)(cid:86)(cid:66)(cid:70)(cid:72)(cid:85)(cid:87)(cid:56)(cid:87)(cid:76)(cid:79)(cid:40)(cid:81)(cid:87)(cid:85)(cid:76)(cid:72)(cid:86)
≤ (cid:22)(cid:25)(cid:26)
> (cid:22)(cid:25)(cid:26)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:23)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:22)(cid:27)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:24)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:23)(cid:19)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:25)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:24)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:26)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:24)(cid:28)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:23)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:26)(cid:19)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:24)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:26)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:25)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:24)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
(cid:49)(cid:82)(cid:71)(cid:72)(cid:3)(cid:26)(cid:3)(cid:11)(cid:81)(cid:3)(cid:32)(cid:3)(cid:25)(cid:19)(cid:12)
(cid:72)
(cid:86)
(cid:68)
(cid:37)
(cid:85)
(cid:72)
(cid:86)
(cid:56)
(cid:20)
(cid:19)(cid:17)(cid:27)
(cid:19)(cid:17)(cid:25)
(cid:19)(cid:17)(cid:23)
(cid:19)(cid:17)(cid:21)
(cid:19)
Fig. 3: Trees 1, 3, and 5, calculated by the C5.0 decision tree algorithm with adaptive boosting and a custom cost matrix that
favors false positives over false negatives.
sampled, training and testing datasets using the splits described
earlier, and training and testing the new classiﬁer. Speciﬁcally,
we remove the feature that was the most used by the previous
model, i.e., the most important one. For example, the ﬁrst
feature that we removed was the number of entries in a system’s
DNS cache, as it was the most commonly used feature of our
ﬁrst classiﬁer according to Table V. Through this process we
aim to quantify an attacker’s ability of distinguishing sandboxes
from real users, in the face of dedicated sandbox operators
who can try to mimic a real user system by populating our
identiﬁed wear-and-tear artifacts with realistic values.
We argue that this setup captures the worst-case scenario
for an attacker, because not only are there fewer and fewer
features to train on, but also because the remaining features are
of lower discriminatory power than the removed ones. Figure 4
shows how the accuracy, false positive rate, and false negative
rate vary, as we keep on removing features from our dataset.
As one can notice, the overall accuracy of the classiﬁer remains
high (greater than 90%) even if we remove as many as 20
discriminatory features.
Similarly, we see that, guided by our custom cost matrix, the
classiﬁer constantly prefers to err on the side of false positives
instead of false negatives. We even observe that for the ﬁrst
eight features, the accuracy increases and the FPR/FNR rates
decrease. This shows that some pattern that was learned by the
training data concerning the removed features did not appear in
the testing data, and thus removing these features, in fact, made
the classiﬁer more accurate. The average accuracy of the ﬁrst
30 classiﬁers (removing from 0 to 29 features) is 91.5% with a
FPR of 9.05% and a FNR of 7.96%. When the 30th feature is
removed (out of 33 in total), the decision tree algorithm fails
to train a model with accuracy greater than random chance,
and quits.
To better understand how each type of artifact affects the
accuracy of our classiﬁer, we retrained our model using only
one type of artifacts at a time. Table VI shows the number of
artifacts per category and the performance of each classiﬁer on
1018
Authorized licensed use limited to: IEEE Xplore. Downloaded on March 18,2021 at 12:22:37 UTC from IEEE Xplore.  Restrictions apply. 
●● (cid:36)(cid:70)(cid:70)(cid:88)(cid:85)(cid:68)(cid:70)(cid:92)
(cid:41)(cid:68)(cid:79)(cid:86)(cid:72)(cid:3)(cid:49)(cid:72)(cid:74)(cid:68)(cid:87)(cid:76)(cid:89)(cid:72)(cid:3)(cid:53)(cid:68)(cid:87)(cid:72)
(cid:41)(cid:68)(cid:79)(cid:86)(cid:72)(cid:3)(cid:51)(cid:82)(cid:86)(cid:76)(cid:87)(cid:76)(cid:89)(cid:72)(cid:3)(cid:53)(cid:68)(cid:87)(cid:72)
●
●●
●
●●
● ● ●
● ● ●
●●
●
● ● ● ● ●●
● ● ● ● ●
● ● ● ●
● ● ● ●
● ● ● ●
● ● ● ●
●
●●
●●●●● ●●
● ●
●
●
●
●●
●
●
● ●
●●
●
●
●
●
●
(cid:28)(cid:19)
(cid:25)(cid:19)
(cid:22)(cid:19)
(cid:87)
(cid:72)
(cid:74)
(cid:68)
(cid:81)
(cid:72)
(cid:70)
(cid:85)
(cid:72)
(cid:51)
(cid:19)
(cid:20)(cid:19)
(cid:21)(cid:19)
(cid:49)(cid:88)(cid:80)(cid:69)(cid:72)(cid:85)(cid:3)(cid:82)(cid:73)(cid:3)(cid:85)(cid:72)(cid:80)(cid:82)(cid:89)(cid:72)(cid:71)(cid:3)(cid:73)(cid:72)(cid:68)(cid:87)(cid:88)(cid:85)(cid:72)(cid:86)
(cid:22)(cid:19)
Fig. 4: Variance of accuracy, false negative rate, and false
positive rate of our boosted classiﬁer as we keep removing
the topmost features. Even after removing tens of the features
with the highest discriminatory capacity, the accuracy of the
classiﬁer drops only slightly.
the unseen testing dataset. We can observe that, even though
the classiﬁer based on registry artifacts had the most features
available to it, it performed worse than the Network-based
and Disk-based classiﬁers. This indicates that certain classes
of artifacts have higher discriminatory power than the rest.
At the same time, all classiﬁers achieve fairly high accuracy
(some even have a 0% FNR), which suggests that malware
authors can choose which category of artifacts they can focus
on, without compromising the evasion capabilities of their
malware. As such, malware authors who, for example, know
that their samples will be analyzed by a sandbox that considers
registry-related activity suspicious, can use the other types
of wear-and-tear artifacts for both detecting the sandbox and
avoiding raising suspicion.
Our results demonstrate that, not only is it possible to
differentiate between real systems and sandboxes based on
non-intrusive, sandbox-agnostic wear-and-tear artifacts, but that
incremental patching approaches where one or two artifacts
are made to look similar to those in real systems will not be
sufﬁcient to prevent sandbox evasion.
VI. ESTIMATING ACTUAL SYSTEM AGE
In the previous section, we showed that wear-and-tear
artifacts can be used to accurately differentiate between
machines belonging to real users and sandbox environments.
The underlying intuition is that sandbox environments do not
“age” either at all, or clearly not in the same way as user
environments. Based on this observation, in this section, we
explore the possibility of predicting the age of a system based
on the values of its wear-and-tear artifacts. This possibility
would allow malware to assess whether a machine exhibits a
realistic wear and tear that matches its reported age. At the
same time, it would also enable researchers to artiﬁcially age
malware sandboxes to match a desired age.
TABLE V: Features that the adaptive boosting decision trees
rely on, and the percentage of trees utilizing them.
Category
Network
System
System
Registry
Registry
Browser
Disk
Browser
Registry
Network
System
Browser
Network
System
Registry
Network
Feature
dnscacheEntries
sysevt
syssrc
deviceClsCount
autoRunCount
uniqueURLs
totalProcesses
cookieDiffDays
usrassistCount
certUtilEntries
appevt
uniqueCookieDomains
tcpConnections
winupdt
MUICacheEntries
ARPCacheEntries
% of trees
100.00%
100.00%
100.00%
100.00%
100.00%
100.00%
66.90%
59.86%
54.93%
54.23%
54.23%
52.82%
50.00%
16.90%
11.27%
4.93%
TABLE VI: Classiﬁer performance when trained only on a
single type of artifacts (FNR = False Negative Rate, FPR =
False Positive Rate).
Artifact Type
Network
Disk
System
Registry
Browser
#Artifacts
4
5
5
11
7
Accuracy
FPR
FNR
6.12%
95.92% 2.04%
8.16%
95.92% 0.00%
92.86% 0.00% 14.29%
93.88% 4.08%
8.16%
92.86% 2.04% 12.24%
A. Correlation Between Age and Artifacts
We begin this process by ﬁrst investigating the self-reported
age of sandboxes and real user machines. Figure 5 shows the
cumulative distribution function of the age of user systems and
malware sandboxes. We can clearly see that, on average, user
systems are much “newer” than sandboxes. Half of the users
have systems less than a year old, yet 50% of sandboxes are
less than two years old. This makes intuitive sense since most
users update their hardware on a regular basis, while many
sandboxes were setup once and are just reused over and over
for a long period of time. At the same time, we see that the
two distributions meet at the top, meaning that there some
users have systems that are as old (or even older) than the
oldest available sandboxes.
Having established their age, we can now investigate the
extent to which each individual wear-and-tear artifact can
potentially be used to predict an environment’s age. Figure 6
shows the Pearson correlation between the reported age and
each wear-and-tear artifact for real user systems. We argue that
changing the age reported by the OS is not only something
that everyday users cannot do, but that they do not have any
interest of doing. As such, we assume that the reported ages
collected from real user systems are accurate.
1019
Authorized licensed use limited to: IEEE Xplore. Downloaded on March 18,2021 at 12:22:37 UTC from IEEE Xplore.  Restrictions apply. 
1.00
0.75
s
m
e
t
s
y
s
f
o
n
o
i
t
c
a
r
F
0.50
0.25
Users Sandboxes
0.00
0
4
System age
8
12
Fig. 5: CDF of the reported ages for sandboxes and real user
machines.
We see that many artifacts that were very successful in
differentiating real machines from sandboxes do not, in fact,
correlate with a machine’s age. By focusing on the artifacts that
appear towards the middle of Figure 6 (having a correlation
coefﬁcient close to zero), one can notice that these artifacts may
be characteristic of user activity but they are also under a user’s
control. Users can delete their cookies, visit more or fewer
URLs than other users, delete downloaded ﬁles, and, in general,
affect the values of these artifacts in unpredictable ways that
prevent them from being indicative of system’s age. Similarly,
there are other artifacts, such as the number of cached wireless
networks, TCP connections, and ﬁrewall rules, which are not
under the direct control of users, clearly do not correlate with
age, yet vary sufﬁciently between sandboxes and real machines
to be of use for differentiation.
Towards the right end of Figure 6 we see the artifacts that
appear to positively correlate with system age, such as the
number of previously connected USBs, the number of install
applications, and the elapsed time since the ﬁrst user event.
These artifacts are either “proxies” of age (e.g., the longer
a machine is used, the more applications are installed on it),
or are direct sources of age information which, unlike HTTP
cookies, are buried deeper in an OS’s internals, and are thus
unlikely to be modiﬁed or deleted by users.
B. Regression
Having established that some artifacts positively correlate
with age, we now attempt to identify the appropriate way of