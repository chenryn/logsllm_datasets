# X-Day威胁分析与对战技巧
## 目录
[TOC]
## 流行APT手法分析与APT29档案解密
### solarwinds 供应链分析
- 3月，Prodaft（瑞士安全公司）对solarwinds进行事件分析溯源
- 供应链攻击流程
  - msbuild注入
  - 感染后，会进行目标监听，判断高价值目标
- 谷歌整理的供应链攻击流程分析图
  - developer-source-build-package-dependency-use
### 关于APT29
#### 组织能力
- 钻石模型
  - 攻击者
    - 毛熊背景
  - 受害者
  - 基础设施
    - 攻击者攻陷（毛熊特点）——私有资产——第三方平台
  - 能力
- 金字塔模型（描述能力等级）
#### 攻击事件
- 经典攻击事件
  - 2016 对DNC机构的攻击
  - 2020 对疫苗研制机构的攻击
- 非常规事件
  - 2014Tor网络出口节点劫持
  - 2015 黑产类的大规模鱼叉邮件攻击
    - 黑产团伙，大规模进行钓鱼邮件攻击，来收割机肉鸡
#### 组织结构划分
- The Dukes
- WillMess
- Nobelium
### APT29归因分析
- APT命名是为了便于划分某一类具有相似之处的黑客组织
  - 并不严格代表团伙和人员的边界，有一个服务多个的情况
- 事件归因是基于**当前积累和理解**向已知组织作出的合理挂靠
#### The Dukes归因
- 特点
  - 组件中包含推特
  - 使用隐写技术写入图片
- 第一步：受害者分析
  - 时间线上的攻击活动调查
  - 目标：以美国为主的北约成员国相关
- 第二步：特马编译时间时区
  - 对比编译时间和正常工作时间的时区
- 第三步：查看美国情报机构的线索
  - 是否有与事件相关的IP地址等IOC
#### WellMes归因
- 攻击流程（与国内红队相似）
  - 单点渗透
  - 横向
  - 投递特马
---
- 第一步：SeaDuke&Wellmess（流量分析）
  - Cookie中包含SeaDuke&Wellmess的加密特征
- 第二步：Subburst&Kazaur（特马分析，卡巴斯基）
  - 木马上线延时-休眠时间算法
  - API Hash摘要
  - PC UID标识序列生成算法
  ---
  - 通过已有的海量恶意样本库，满足上述算法指纹的进行归因
- 第三步：Prodaft——SilverFish调查报告
  - 从FireEye披露的资产出发
  - 攻击阶段的DNS解析
  - 发现DNS服务器上，有2304有PowerMTA服务
  - 基于上述特征，对全球IP进行测绘，过滤无关站点
  - 发现特定IP后， 进行同C段主机排查
  - 发现另IP上存在意思木马主控端后台的登入页面（**与黑产的资产类型有相同之处**）
  - 爆破登入木马主控端后台
- 第四步：CC后台源代码中的携带的开发者CID
  - 进行OSINT搜集，发现与毛熊的地下技术交流论坛有关联
- 第五步：发现后台中存在俄语俚语和常用语的字符片段
- 第六步：在后台中源代码中发现流量重定向的代码过滤
  - 过滤毛熊联邦相关的
  - 重点关注枫叶国、美丽国
- 第七步：CC后台操作行为活跃的事件区段
  - 分析日志信息的时间段，对应正常工作时间段的时区
---
- 注意点：
  - 对IOC调查，会发现存在不同团伙使用相同IOC的情况
  - 要保持质疑的态度
---
- 理论与现实
  - 指导理论
    - Killchain
    - 钻石模型
    - TTPs
    - ATT&CK
- 实际情况
  - ATT&CK半自动化落地问题
  - 攻击上下文数据缺失
  - TTPs关联的论证
    - 用TTPs关联时，一定要是独一无二的
  - 以人为主导的组织关联局限性
---
- 组织关联分析总结
    - 受害者分析
      - 国家地域
      - 特定行业
      - 时政分析
    - 攻击资产
      - 武器库
        - 特马
      - 攻击样本溯源
      - 网络资产
        - 私有资产
        - 第三方资产
    - TTPs
      - 攻击战术偏好
      - 载荷执行流程
      - **单点指纹**
        - 要有足够的特殊性
        - e.g. 图拉的加密算法会分层，每一步骤不同
        - e.g. 特马对真实环境的判断，会对不同的检查点给分，在一定阈值或者水平线上进行判断
    - 反制溯源
  ![image-20210725201820674](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/image-20210725201820674.png)
  图：组织关联分析图
---
- 数据拓线
  - 失陷现场
    - 上机取证
    - 同环境排查
  - 样本层
    - 样本属性
      - 签名
      - 元素据
      - 特殊事件
    - 代码指纹
  - 网络层
    - 传输数据加密协议
    - Domain特征
      - e.g. 频繁出现的某些特定字段
    - IP特征
      - 判断是否为私有资产，如果是，则关联的域名等也大概率归攻击者
    - URL特征
    - Web页面服务特征
    - Web页面资源特征
图：数据拓线
## 流行勒索病毒特性研究与分享
### 勒索软件概述
#### 概述
- RaaS勒索即服务的模式
  - 谁都可以买，谁都可以卖，类似于买卖枪支的模式
#### 特点
- 双重勒索已成常态
  - 加密数据
  - 窃取数据
- 三重勒索（DDOS）
- 四重勒索（受害者合作伙伴）
#### 趋势
从广撒网到针对性，趋向于APT形式
#### 勒索流程
以Kaseya VSA供应链攻击为例
- 对VSA服务器进行多个漏洞利用
  - 凭证泄漏和业务逻辑咯浦东
  - VSA身份验证绕过漏洞
  - VSA文件上传漏洞