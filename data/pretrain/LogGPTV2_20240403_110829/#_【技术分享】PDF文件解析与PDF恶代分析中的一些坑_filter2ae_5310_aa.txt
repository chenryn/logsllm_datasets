# 【技术分享】PDF文件解析与恶意代码分析中的一些陷阱

##### 译文声明
本文是翻译文章，原文来源：安全客。译文仅供参考，具体内容表达及含义以原文为准。
作者：[redpain](http://bobao.360.cn/member/contribute?uid=2723660229)
预估稿费：400RMB
投稿方式：发送邮件至linwei#360.cn 或登录网页版在线投稿。

**简介**
最近在进行文档类恶意代码检测的工作，本文将对PDF文档格式及其在恶意代码分析中的注意事项进行总结，并推荐一些实用工具，希望能为从事相关工作的读者提供帮助。后续还将更新其他文档格式的解析和恶意代码分析内容，欢迎持续关注。

**文章结构**
- PDF文件格式介绍
- 二进制文本解析PDF文档结构
- PDF文件混淆
- 关键字
- 流的提取
- 一些陷阱
- 常用分析工具推荐
- 参考资料

## PDF文件格式介绍
PDF（便携式文档格式，Portable Document Format）由Adobe Systems于1993年开发，旨在实现文件交换。鉴于Adobe公司历史上存在大量已知漏洞，学习PDF文件格式对于研究和分析这些漏洞具有重要意义。尽管PDF格式较为复杂，但本文主要从漏洞研究的角度出发，探讨如何识别并分析其中可能存在的恶意代码，而不是深入解析所有细节，请读者注意。

### PDF的文件结构
PDF文件由四个主要部分组成：
- **文件头**：指示了PDF遵循的版本号，位于文件的第一行。
- **文件体**：也称为对象集合，是PDF的主要部分，由一系列对象构成。
- **交叉引用表**：用于随机访问对象地址的索引表（实际存储方式为偏移量+索引）。
- **文件尾**：指定了交叉引用表的位置、根对象（Catalog），以及加密等安全信息。

### PDF的逻辑结构
PDF文档由多个被称为“对象”的模块构成。每个对象都有一个数字编号以便被其他对象引用。这些对象不必按顺序出现在文档中；唯一的好处是提高可读性。对象的信息通过偏移量+索引的形式保存在交叉引用表中。

文件尾部标识了根对象（即目录对象Catalog）的位置，该目录包含文档的大纲（书签树）和页面组对象（Pages）。页面组对象又进一步指向各个页面对象(Page)。

页面对象是PDF中最关键的部分之一，包含了关于页面显示的所有信息如字体、内容（文本、图像等）、页面尺寸等。这些信息通常封装在一个名为流（Stream）的对象内，其长度必须明确给出或指向另一个表示长度的对象。

## 二进制文本解析PDF文档结构
PDF是一种文本与二进制混合格式，虽然可以当作纯文本处理，但更常被视为二进制文件。因此，可以直接使用十六进制编辑器打开查看。下面展示了一个简单的PDF示例片段：

```plaintext
%PDF-1.6  # 文件头部 + 版本号
%çóÏÓ
2 0 obj  # 对象定义，2为对象序号，0为版本号
>
[/ICCBased 3 0 R]
>>
Endobj
...
Xref  # 交叉引用表开始
0 14  # 表示有14个条目
0000000000 65536 f
0000003195 00000 n
...
Trailer  # 文件尾部
>
startxref
8980
%%EOF
```

## PDF文件混淆
某些PDF文件可能会被混淆以隐藏恶意内容。例如：
```plaintext
%PDF-1.5
1 0 obj
>
endobj
```
这里`>`之间的内容经过了编码或加密，需要先解码才能继续分析。

## 关键字
在解析PDF时需要注意的关键字包括但不限于：
- `obj` 和 `endobj` 标记对象边界。
- `stream` 和 `endstream` 指示流数据区域。
- `xref` 开始交叉引用表。
- `trailer` 文件尾信息。
- `/Page`, `/Encrypt`, `/ObjStm`, `/JS`, `/JavaScript`, `/AA`, `/OpenAction`, `/AcroForm`, `/URI`, `/Filter`, `/RichMedia`, `/Launch` 等特定关键字有助于识别潜在的恶意行为或功能。

以上是对PDF文件格式及恶意代码分析的基本概述。希望这能帮助您更好地理解和应对相关挑战。