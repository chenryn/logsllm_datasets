记⼀次内⽹失陷的应急响
应 酒仙桥六号部队
_ -
MdEditor
“ 记⼀次内⽹失陷的应急响应
1
前⾔
某⽇正在等待愉快的下班，突然被拉到某个群⾥，客户昨
晚上架了⼀台态势感知设备，然后发现内⽹⼗⼏台服务器
存在异常，有反弹 shell，有被上传 webshell 的。需快
速展开应急。
看来⼜是⼀个不眠夜，在前往客户现场的途中，建议了客
户隔离受害主机、封禁恶意 IP、限制 webshell 访问权限
等操作，来阻⽌危害进⼀步扩⼤。
2
现场应急
到达现场，⾸先看了看反弹 shell 的 172.x.x.172 服务
器。分析⽹络连接，在查找对应进程，看到是定时任务反
弹 shell。
既然是定时任务反弹，那么查看定时任务⽇志，先确认下
⼊侵时间，看到最早的反弹⽇志是 7 ⽉ 2 ⽇ 2 点 35
分。
⼀般来说都是通过 ssh 或者部署的应⽤⼊侵 linux 服务
器，⾸先看了 secure ⽇志，没发现问题。那么看看应
⽤，发现部署了 jboss，版本为 4.0.5.GA，该版本存在
如 CVE-2017-7504 等反序列化漏洞。
看了部署的 war 包的时间，基本确认是通过 jboss ⼊侵
的。7 ⽉ 2 ⽇ 2 时 24 分上传的。
与运维⼈员确认服务器不出⽹，那么攻击者在内⽹肯定有
跳板，但发现 Jboss 默认不开启 access ⽇志，那么上
⼀跳的线索这⾥就断了。
看看 history 吧，也许有下⼀跳的线索。很遗憾，除了反
弹 shell, 只进⾏了密码搜集。
上下跳的线索都断了，只能从头开始排查其他服务器。
⻢上转战了告警存在 webshell 的 tomact 的服务器，。
看了下访问⽇志，⼤量访问登录⽇志，应该是爆破进的
tomact 后台，但发现都是 172.x.x.20。前⾯有台
nginx，不过幸好 nginx 开启了 access ⽇志。获取了访
问 webshell 的 IP 172.x.x.160。然后确认了 172.x.x.160
是主域控。
⻢上登录上主域控进⾏排查，查看杀毒告警看到了 frpc
的名字。没错就是那个内⽹穿透⼯具, 查看相应⽂件⽬录
下的 frpc.ini。看到服务器配置的 IP 为 47.x.x.119。
另⼀个隔离⽂件 help[1].xls, 看了⼀下，⼀个 shellcode
的加载器，代码逻辑和 powersct.sct 基本⼀致。发给后
端的同学详细看了，加载的是 CS 的 shellcode，CS
server 是 47.x.x.119。
（中间的 base64 就省略了）
在杀软信任区还看到了 mimi.exe，⽂件不在了，但通过
名字推测应该就是 mimikatz。
由于安全⽇志被删了，最终在远程登录⽇志，发现攻击者
是直接通过远程桌⾯进来的，登录 IP 172.x.x.115，登录
时间 7 了⽉ 1 ⽇ 23 点 04。
与运维⼈员确认 172.x.x.115 是堡垒机，同样堡垒机并不
出⽹。接下来通过分析堡垒机的登录⽇志及操作录屏，确
认了攻击者的攻击范围，以及可疑的登录⽤户，及登录时
间。
可疑⽤户：XX，登录 IP:172.x.x.159。
IP:172.x.x.159 为 VPN 服务器，排查 XX 登录记录，发
现该⽤户在 7 ⽉ 1 ⽇ 17 时 49 分确实存在可疑的登录记
录。但是是 1 次登录成功的，并没有密码修改或被爆破
的现象，那么不是 VPN 有漏洞, 就是密码被泄漏了。
查看了 VPN 的详细版本，没有发现已公开的漏洞，感觉
密码泄漏的可能性⽐遭遇 0day 要⼤很多。先排查密码泄
漏吧。
对⽤户进⾏了访谈，⽤户说最近领导收到了可疑邮件，让
他看看来着，会不会那封邮件呢？
去⽤户办公主机上⾃⼰排查，⾸先在桌⾯就看到了密码
本. txt。
可疑邮件的附件为公司资质. zip, 拷⻉出来进⾏分析。压
缩包⾥⾯的⽂件为：
这⾥攻击者利⽤了 Windows 默认的设置是隐藏已知⽂件
类型的扩展名的特性，如果没有进⾏设置，⽤户看到的名
称是 “公司资质. doc”。
放到沙箱⾥跑了⼀下，会释放恶意 DLL3[1].DLL ⽂件，
并运⾏回连 CS Server 43.x.x250:53535
因为会释放⽂件，到⽤户的办公机相应的⽬录下看下是否
存在相应的⽂件，以判断是否运⾏。果然还是运⾏了，⽂
件创建时间 7 ⽉ 1 ⽇ 17:27。
⾄此攻击路径基本溯源完成，⼀起通过钓⻥邮件打穿内⽹
的典型案例。
3
后续
当准备分析攻击 IP, 进⾏溯源时。客户说他们总部最近在
攻防演练，那两个 IP 是攻击队的 IP, 且此时攻防演练已
经结束，不⽤溯源了。但⼜发现 3 封钓⻥邮件，让帮忙
分析下。
第⼀封是在排查过程的发现，但没有反馈给我。看了⼀下
附件内容。
经典的⽩加⿊，最早被发现应⽤在海莲花的攻击⼿段中，
经典的⽩加⿊，最早被发现应⽤在海莲花的攻击⼿段中，
通过劫持 word 的 wwlib.dll，加载恶意 shellcode。菜鸡
的我不会动态调试，让实验室⼤佬看了下，⼜是加载 CS
的 shellcode。
其他两封应该是攻防演练结束后，总部对于⼈员安全意识
的提醒。
⼀封的附件是带有宏的 “⽹络安全基础知识应知应会⼤
全. doc”，运⾏会释放 pfish.exe, 将运⾏后的⽤户主机信
息上传到 C&C 的 mysql 中。
本来想秀波反制，但发现攻击队的⼤佬权限设的⽐较死就
放弃了。。。
然后发现还是有⼏个⽤户中招了，看来只要社⼯技术好，
总有⻥⼉会上钩。
另⼀封则是说证书更新的邮件，钓⻥⻚⾯克隆了客户的某
个应⽤。反汇编下，看到⼤量 Py 开头的函数，应该是
python 打包的 exe, ⽤ uncompyle6 反汇编，得到了源
⽂件。通过访问 C&C 的端⼝，获取运⾏钓⻥邮件的主机
⽤户名。
⾄此本次应急响应结束。
4
加固建议
1、 提⾼⼯作⼈员⽹络安全意识 ，任何邮件中可疑附
件，做到不双击、不运⾏、不解压、不信任态度。
2、 使⽤邮件⽹关对钓⻥邮件、垃圾邮件进⾏拦截，对邮
件附件、病毒邮件进⾏ 检测拦截。
3、 修改相关弱⼝令以及已泄漏的⼝令。
4、 WEB 应⽤配置访问⽇志，以便进⾏ WEB 漏洞利⽤
等类型攻击的分析溯源。
5、 VPN 及堡垒机添加动态⼆次验证，如⼿机验证码验
证等。
6、 对存在漏洞的应⽤进⾏升级加固。
全⽂完
本⽂由 简悦 SimpRead (http://ksria.com/simpread) 优化，⽤以
提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看
(http://ksria.com/simpread/docs/#/词法分析引擎)详细说明