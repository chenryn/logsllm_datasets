2020/7/27 攻守道—流量分析的⼑光剑影（上）
攻守道—流量分析的⼑光剑影（上）
原创 队员编号023 酒仙桥六号部队 6⽉22⽇
这是 酒仙桥六号部队 的第 23 篇⽂章。
全⽂共计3915个字，预计阅读时⻓12分钟。
前⾔
⼜到了⼀年⼀度的HW时刻，各家都在为HW积极筹备着，⼀些⼚商也在做着攻防演练的
⼯作，此时，有些真正的攻击者也在利⽤这个档⼝对⼀些⽹站进⾏攻击，浑⽔摸⻥，这
样，对于防守队员来说，分析流量做应急的⼯作就会变得更加困难。
这不，某公司内⽹⽹络被⿊客渗透，接下来，我们就借助wireshark来对流量包进⾏分
析，来还原查找⿊客留下的蛛丝⻢迹，还原攻击的现场。
wireshark作为流量分析神器，在开始之前，先来简单科普⼀下它的⼀些常⽤的过滤命
令。
过滤查看包含某字符串的http数据包：http contains “string”（tcp同理）
过 滤 查 看 请 求 某 ⼀ url 的 流 量 ： http.request.uri == “path” 或
http.request.uri contains “path”
过滤出某⼀ip的流量：ip.addr == ip 或 ip.src == ip 或 ip.dst == ip
跟踪显示http请求包与返回包可以Fllow HTTP Stream
第⼀问 扫描器
⾸先来看第⼀个：⿊客⽤什么扫描器进⾏的扫描？
在开始这个问题之前，我们先来说⼀说在应急、流量分析的时候，如何快速发现是不是
有扫描器扫描的痕迹。
https://mp.weixin.qq.com/s/w6nvyYFsTaZqE2AcoTvEIA 1/16
2020/7/27 攻守道—流量分析的⼑光剑影（上）
⼀ 般 最 常 ⽤ 到 的 扫 描 器 有 WVS 、 nessus 、 APPscan 、 绿 盟 极 光 、 sqlmap 、
dirsearch等等，所以我们就要了解这些扫描器本身的⼀些特征。
WVS 扫 描 器 通 常 默 认 情 况 下 ， 会 在 请 求 的 数 据 包 中 带 有 wvs 、
acunetix_wvs_security_test、acunetix、acunetix_wvs等字样。
Nessus扫描器默认情况下会包含nessus字样。
APPscan默认情况下会包含APPscan字样。
绿盟极光扫描器⼀般会包含nsfocus、Rsas字样。
sqlmap⼤多情况下也会包含有sqlmap字样。
以上情况均为⼀般、默认情况，但是⼤多数情况下攻击者都会对⾃⼰的⾏为进⾏隐藏，
如果⼈家对⾃⼰使⽤的⼯具做了修改，就为了隐藏让你不好分析，那你就只能另辟蹊径
了。
https://mp.weixin.qq.com/s/w6nvyYFsTaZqE2AcoTvEIA 2/16
2020/7/27 攻守道—流量分析的⼑光剑影（上）
好了，了解了⼀般情况下扫描器的特征，我们就来找找看，⼀共⼀个多G的pacp包，⼀
个请求⼀个请求的来找，怕是找到⿊⼈抬你的时候都找不完，这时就要⽤到wireshark
的命令了，通常情况下，扫描器扫描web应⽤的流量都是http流量，筛选过滤⾛起，先
来找找看有没有wvs的扫描流量，过滤命令：
1 http contains wvs
很明显⽤了WVS，再搜⼀搜其他扫描器的特征字符，并没有搜到，看来这个⿊阔只⽤了
wvs来扫描。从这个流量中也能确定使⽤扫描器的攻击者的ip地址，可以先将此ip记录
下来，再看看还有没有其他的扫描IP，⽤到的命令：
1 http contains wvs and not ip.addr==192.168.94.59
可以看到过滤之后没有其他的数据包，可以确定只有这⼀个ip在发起攻击，明确了攻击
ip，之后的分析就会轻松⼀些。
第⼆问 后台
⿊客扫描到的⽹站后台是什么？
从这个问题出发，我们先确定三个要素：⿊客、扫描、后台。从前⾯我们已经确定了⿊
客的攻击IP，也确定了扫描器是使⽤的wvs，那么我们只需要找到后台就可以，我们先
假设⼀些可能的后台关键字：admin、login、administrator。
https://mp.weixin.qq.com/s/w6nvyYFsTaZqE2AcoTvEIA 3/16
2020/7/27 攻守道—流量分析的⼑光剑影（上）
在实际情况中，真正攻击者会隐藏⾃⼰的攻击⾏为，所以不必要过于在意是不是使⽤的
扫描器，只要是这个IP发出的请求，我们都认为他是攻击⾏为，这样可以尽可能的减少
我们分析过程中出现的遗漏。
我们先过滤数据包，来看看攻击者访问的登录地址有哪些。这⾥我们⽤到的命令：
1 http contains login and ip.addr==192.168.94.59
从筛选出来的数据包中，能够看到⼀个/admin/login.php的请求，我们来跟踪看⼀
下。
从前边⼩箭头的关系就能看出来第⼀个数据包是request数据包，下边的是response数
据包，该请求的请求地址是/admin/login.php，返回状态是200。从这⾥难道就能确
定⿊客找到的后台就是它吗？不能直接确定，万⼀是⽹站做了统⼀错误⻚⾯呢，也可能
是返回状态200，但请求⽂件不存在。所以我们只能看⼀下这个数据包具体的内容了。
来Fllow HTTP Stream看⼀下。
https://mp.weixin.qq.com/s/w6nvyYFsTaZqE2AcoTvEIA 4/16
2020/7/27 攻守道—流量分析的⼑光剑影（上）
看到这个返回包的内容，我们可以肯定了，这个地址是存在的，并且可以确定是后台登
录地址了。你以为到这⾥就结束了吗？并没有，我们还需要看看其他的数据包，看看是
不是还有其他的后台。通过筛选分析，没有发现有其他存在的后台地址，所以确定⿊客
攻击的后台地址为/admin/login.php。
第三问 账号
攻击者使⽤什么账号登录了后台？
上⼀问中，我们知道了⽹站的后台地址，现在，我们可以先通过该后台地址了解⼀下这
个⽹站登录成功的特征。先筛选POST提交账号密码的数据包。这⾥看到有⼀个登录数
据包，跟踪这个流量来看⼀下。
可以看到这个⽹站正常登陆后会返回302数据包跳转到/admin/index.php⻚⾯，应该
就是登录成功了。这个会是攻击者登录的吗？本着不信任任何数据包的信念，把这个登
录者的⾏为来分析⼀下。先看看他发起了多少次登录请求。
https://mp.weixin.qq.com/s/w6nvyYFsTaZqE2AcoTvEIA 5/16
2020/7/27 攻守道—流量分析的⼑光剑影（上）
登录请求只有三次，⽽且每次使⽤的账号密码都相同，如果是攻击者，那么他在发起攻
击之前就已经获得了此后台的账号。再来看看除此之外他还有哪些请求。
筛选这个ip的请求发现他请求了⼀个backup.php⽂件，看看关于这个backup⽂件还
有哪些操作。
https://mp.weixin.qq.com/s/w6nvyYFsTaZqE2AcoTvEIA 6/16
2020/7/27 攻守道—流量分析的⼑光剑影（上）
这 ⾥ 有 个 对 backup ⽂ 件 的 POST 请 求 ， 从 请 求 的 内 容 中 分 析 可 以 看 出 来 这 个
backup.php⽂件的功能是进⾏数据库备份，再返回来看看这个登录者执⾏备份操作后
还有什么后续的⾏为。寻遍所有的请求，都只有正常的操作请求，⼀点点的恶意攻击操
作都没有，看来这个ip是正常的员⼯登录使⽤。