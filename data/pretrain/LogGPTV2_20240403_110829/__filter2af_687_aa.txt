# 【技术分享】目标韩国！黑客组织利用云服务攻击
|
##### 译文声明
本文是翻译文章，文章来源：fortinet.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
译者：[兴趣使然的小胃](http://bobao.360.cn/member/contribute?uid=2819002922)
预估稿费：200RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**一、前言**
九月月初时，FortiGuard实验室研究人员发布了一篇文章，介绍了某个恶意软件组织对[
**PowerPoint漏洞**](http://blog.fortinet.com/2017/09/01/powerpoint-file-armed-with-cve-2017-0199-and-uac-bypass)
的利用过程。网络犯罪分子们在漏洞利用方面都半斤八两，因此，最近我们又发现了另一个目标明确的恶意软件组织，这个组织使用了另一个文档漏洞。在这次事件中，攻击者以
**HWP** （Hangul Word Processor）文档为载体，利用已知的 **CVE-2015-2545** EPS（Encapsulated
PostScript）漏洞发起攻击。
在韩国，特别是在韩国政府机构中，HWP非常流行，是微软Office的替代产品。因此，攻击者经常使用HWP文档作为载体来传播钓鱼文档，攻击以韩语为母语的目标人士。本文所分析的这个攻击组织使用了与韩国某些政治问题有关的文档来开展攻击。对于公共机构而言，这种恶意软件攻击手段并不罕见。
抛开这个组织的动机，最吸引我们注意的是该组织使用了pCloud这个免费云服务作为数据存储及通信平台。虽然其他恶意软件组织也用过这类技术，但目前该技术还没有被广泛使用。此外，根据我们收集到的样本，我们还发现该组织所使用的恶意软件（我们称之为CloudTap）已经活跃了一年以上。
**  
**
**二、使用JPEG图像隐藏载荷**
我们收集到这个组织所使用的两份文档，这两份文档的内容都是关于韩国核电和劳工政策问题的文章摘录。
图1. 有关抗议韩国核政策的恶意文档
在文档中，攻击者嵌入了一个封装的PostScript文件，普通用户如果没有经过培训，很难发现这个细节。与HWP文档中的其他对象一样，我们需要使用zlib解压这个脚本，才能看到真正的shellcode代码，这个shellcode的作用是从“http://price365[dot]co[dot]kr/abbi/head0.jpg”地址下载可执行文件。
该文件执行后，就会下载包含JPEG图像头数据的另一个文件。
图2. 解压后的shellcode中包含URL下载地址
与我们预期的一样，这个图像中嵌入了一个可执行文件，可执行文件使用简单的单字节异或（xor）密钥进行加密。为了优化服务性能，某些反恶意软件系统会把待扫描及待沙箱运行文件限制在可执行文件范围，因此，这个攻击组织试图使用这种混淆技术来躲避这类反恶意软件系统。
图3. 图像中的可执行载荷经部分解密后的结果
根据该恶意软件使用的云服务技术，FortiGuard将其标记为CloudTap。
此外，我们还捕捉到这个恶意软件的早期样本，其中某个样本为debug版本，编译时间为2016年初，这表明恶意软件已经活跃了一年有余。
图4. 早期样本的编译时间
**  
**
**三、确定攻击目标**
恶意软件操作者带有明确的攻击目标，通常会先整体调查一下系统，查找感兴趣的信息，然后再决定下一阶段的操作，比如，是进一步入侵网络还是简单识别系统中有价值的资源。在这个攻击场景中，攻击者利用载荷来搜索文档，尝试提取浏览器中存储的凭据信息。
除了对某些关键字符串进行混淆之外，攻击载荷会直达主题执行攻击动作，没有使用其他反分析技术。
**  
**
**四、枚举进程及包含特定扩展名的文档**
恶意软件会枚举系统中正在运行的进程，其目的可能是检查受害者使用的某些应用程序，或者是检测系统使用哪种反病毒产品。
随后，恶意软件开始查找包含特定扩展名的文档，这些扩展名包括“.hwp”、“.doc”、“.docx”、“.pdf”、“.ppt”以及“.pptx”。恶意软件会搜索系统中除根驱动器之外的所有固定存储介质以及可移动存储介质上的所有目录。
图5. 搜索特定文档的代码片段
搜索根驱动器时，恶意软件只会搜索文件经常保存的那些目录，即：我的文档、文档、桌面、最近文档等目录。这次搜索过程不再受文件扩展名限制。
图6. 恶意软件搜索根驱动器特定目录中的所有文件
目前仅凭文档路径信息，我们很难知道恶意软件作者感兴趣的是什么信息。有可能攻击者想寻找可能包含凭据信息的文档，或者只是想利用这些文档来继续执行钓鱼攻击。
**  
**
**五、使用各种方法提取凭据信息**
恶意软件使用多种技术来提取Windows以及特定浏览器中存储的凭据信息。
为了提取IE浏览器中保存的登录凭据，恶意软件使用CredEnumerateW
API来枚举凭据信息，过滤枚举结果，只关心开头为“Microsoft_WinInet_”的那些条目。然后，恶意软件使用CryptUnprotectData以及“abe2869f-9b47-4cd9-a358-c22904dba7f7”这个GUID来解密凭据信息。
恶意软件还会通过注册表来提取凭据信息，IE浏览器会使用“SoftwareMicrosoftInternet
ExplorerIntelliFormsStorage2”这个注册表项来存储自动填充的凭据。
SecurityXploded网站详细介绍了这两种技术，读者可以参考[此处链接](http://securityxploded.com/iepasswordsecrets.php)了解具体内容。
继续处理下一个浏览器之前，恶意软件会尝试从Windows Vault中提取凭据，这也是微软内置的另一个凭据存储位置。恶意软件使用Vault Client
Access库（vaultcli.dll）完成这个过程。
最后，恶意软件会提取Chrome浏览器存储的凭据，具体路径为“Users\AppdataLocalGoogleChromeUser
DataDefault”。
**  
**
**六、使用免费的pCloud云服务作为C &C服务器**
前面提到过，攻击者使用了由瑞士IT企业pCloud
AG开发的pCloud云存储服务来开展攻击。pCloud自2013年起开始提供服务，使用起来非常方便，无需验证邮件地址即可注册，注册后就能享受10GB的免费存储空间。
图7. pCloud账户主界面
恶意软件获取目标数据后，会使用AES算法加密这些数据，将加密结果保存到文件中，然后使用“.dat”文件名上传到云端。此外，攻击者不仅利用云服务来存储被盗数据，也会利用云服务来引导恶意软件从某些URL地址中下载文件，后面我们会给出分析过程。
把云服务作为C&C服务器有几大优点。首先，C2服务器搭建起来更加便捷，并且互联网上有许多免费云存储服务，提供的功能足以应付这种场景。因此，攻击者不再需要设置自己的Web服务器或者攻破他人的服务器，并且云服务可以确保始终在线、始终可用。此外，这种情况下安全取证更加困难，因为只有极少数信息可用。与攻破第三方站点做对比的话，这种情况下没有真实的主机或者管理员可作为安全取证对象，因此难以跟踪恶意软件的行为轨迹。最后，这类服务所属的账户受隐私策略保护，如果我们想获取特定用户的信息就会非常困难。
这个攻击组织使用了某些邮箱地址来注册pCloud账户，某些邮箱为一次性邮箱。自首次发现以来，我们收集到如下邮箱地址，这些地址可能会随着时间增长不断修改：
[PI:EMAIL](mailto:PI:EMAIL)
[PI:EMAIL](mailto:PI:EMAIL)