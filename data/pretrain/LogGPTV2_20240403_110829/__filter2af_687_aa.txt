# 【技术分享】目标韩国：黑客组织利用云服务发起攻击

##### 译文声明
本文为翻译文章，原文来源：[fortinet.com](https://www.fortinet.com)。具体内容及含义以原文为准。
译者：[兴趣使然的小胃](http://bobao.360.cn/member/contribute?uid=2819002922)
预估稿费：200 RMB
投稿方式：发送邮件至 linwei#360.cn 或通过网页版在线投稿。

## 一、前言
FortiGuard实验室的研究人员在九月初发布了一篇文章，详细介绍了某个恶意软件组织如何利用PowerPoint漏洞（[CVE-2017-0199](http://blog.fortinet.com/2017/09/01/powerpoint-file-armed-with-cve-2017-0199-and-uac-bypass)）进行攻击。近期，我们又发现了一个新的针对性攻击组织，该组织使用了另一种文档漏洞——HWP（Hangul Word Processor）文件中的CVE-2015-2545 EPS（Encapsulated PostScript）漏洞。

在韩国，特别是在政府机构中，HWP作为微软Office的替代产品非常流行。因此，攻击者经常利用HWP文档传播钓鱼文件，针对讲韩语的目标人群。本次分析的攻击组织使用了与韩国某些政治问题相关的文档来实施攻击。这种攻击手段对于公共机构来说并不罕见。

尽管这个组织的具体动机尚不清楚，但其使用免费云服务pCloud作为数据存储和通信平台引起了我们的注意。虽然其他恶意软件组织也采用了类似的技术，但目前这种做法尚未广泛普及。根据收集到的样本，我们发现该组织使用的恶意软件（称为CloudTap）已经活跃了一年以上。

## 二、利用JPEG图像隐藏载荷
我们获取了两份该组织使用的文档，内容涉及韩国核电政策和劳工政策的文章摘录。

**图1. 关于抗议韩国核政策的恶意文档**

在这些文档中，攻击者嵌入了一个封装的PostScript文件，普通用户很难察觉这一细节。与其他HWP对象一样，我们需要使用zlib解压缩脚本才能看到真正的shellcode代码，该代码从“http://price365[dot]co[dot]kr/abbi/head0.jpg”下载可执行文件。

文件执行后，会下载另一个包含JPEG图像头数据的文件。

**图2. 解压后的shellcode中包含URL下载地址**

正如预期的那样，该图像中嵌入了一个使用简单单字节异或（XOR）密钥加密的可执行文件。这种混淆技术旨在绕过一些反恶意软件系统，因为这些系统通常只扫描和运行可执行文件。

**图3. 图像中的部分解密后的可执行载荷**

由于该恶意软件使用了云服务技术，FortiGuard将其标记为CloudTap。此外，我们还捕获到了早期版本的恶意软件样本，其中一个调试版本的编译时间可以追溯到2016年初，表明该恶意软件已活跃超过一年。

**图4. 早期样本的编译时间**

## 三、确定攻击目标
攻击者具有明确的目标，通常会在全面调查系统并找到感兴趣的信息后，决定下一步行动，如进一步入侵网络或识别有价值的资源。在这个案例中，攻击者利用载荷搜索文档，并尝试提取浏览器中存储的凭据信息。

除了对关键字符串进行混淆外，攻击载荷直接执行攻击动作，未使用其他反分析技术。

## 四、枚举进程及特定扩展名的文档
恶意软件会枚举系统中正在运行的进程，可能是为了检查受害者使用的应用程序或检测系统中的反病毒产品。

随后，恶意软件开始查找包含特定扩展名（如.hwp、.doc、.docx、.pdf、.ppt和.pptx）的文档。它会搜索除根驱动器外的所有固定存储介质和可移动存储介质上的所有目录。

**图5. 搜索特定文档的代码片段**

在搜索根驱动器时，恶意软件仅搜索常见的文件保存目录，如“我的文档”、“文档”、“桌面”和“最近文档”。这次搜索不受文件扩展名限制。

**图6. 恶意软件搜索根驱动器特定目录中的所有文件**

目前，仅凭文档路径信息难以确定恶意软件作者的具体意图。可能他们试图寻找包含凭据信息的文档，或者只是想利用这些文档继续进行钓鱼攻击。

## 五、多种方法提取凭据信息
恶意软件使用多种技术来提取Windows和特定浏览器中存储的凭据信息。

### 提取IE浏览器凭据
为了提取IE浏览器中保存的登录凭据，恶意软件使用CredEnumerateW API枚举凭据信息，过滤出以“Microsoft_WinInet_”开头的条目。然后，使用CryptUnprotectData和GUID“abe2869f-9b47-4cd9-a358-c22904dba7f7”解密凭据信息。

### 提取注册表凭据
恶意软件还会通过注册表项“SoftwareMicrosoftInternet ExplorerIntelliFormsStorage2”提取自动填充的凭据。更多详情请参考[SecurityXploded网站](http://securityxploded.com/iepasswordsecrets.php)。

### 提取Windows Vault凭据
在处理下一个浏览器之前，恶意软件会尝试从Windows Vault（微软内置的另一凭据存储位置）提取凭据，使用Vault Client Access库（vaultcli.dll）完成这一过程。

### 提取Chrome浏览器凭据
最后，恶意软件会提取Chrome浏览器存储的凭据，具体路径为“Users\AppdataLocalGoogleChromeUser DataDefault”。

## 六、使用免费的pCloud云服务作为C&C服务器
攻击者使用由瑞士IT企业pCloud AG开发的pCloud云存储服务进行攻击。自2013年起，pCloud提供便捷的服务，无需验证电子邮件地址即可注册，注册后即可享受10GB的免费存储空间。

**图7. pCloud账户主界面**

恶意软件获取目标数据后，使用AES算法加密并将结果保存为“.dat”文件上传到云端。此外，攻击者不仅利用云服务存储被盗数据，还利用其引导恶意软件从特定URL下载文件。

将云服务用作C&C服务器有以下优点：
1. C&C服务器搭建更便捷，互联网上有很多免费云存储服务，功能足以满足需求。
2. 攻击者无需设置自己的Web服务器或攻破他人的服务器，且云服务确保始终在线、始终可用。
3. 安全取证更加困难，因为只有极少信息可用。与攻破第三方站点相比，没有真实的主机或管理员可供取证，难以追踪恶意软件的行为轨迹。
4. 这类服务所属账户受隐私策略保护，获取特定用户信息非常困难。

自首次发现以来，我们收集到以下用于注册pCloud账户的邮箱地址，这些地址可能会随时间不断变化：
- [PI:EMAIL](mailto:PI:EMAIL)
- [PI:EMAIL](mailto:PI:EMAIL)

以上是优化后的文本，希望对你有所帮助。