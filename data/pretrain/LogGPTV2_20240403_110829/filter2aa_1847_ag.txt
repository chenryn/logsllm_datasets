7 Name the address group.
8 Enter 10.221.41.33 to the address range to indicate the customer’s address.
9 Click OK.
10 Select your newly created address group.
11 Select “Apple File Service” in the right pane to enable file access.
12 Click Save.
Important:  Set up very specific address ranges in filters you create to block incoming 
SMTP mail. For example, if you set a filter on port 25 to deny mail from all addresses, 
you’ll prevent any mail from being delivered to your users.
LL2351.Book  Page 58  Monday, September 8, 2003  2:47 PM
Chapter 3    IP Firewall Service
59
Common Network Administration Tasks That Use 
Firewall Service
Your firewall is the first line of defense against unauthorized network intruders, 
malicious users, and network virus attacks. There are many ways that such attacks can 
harm your data or use your network resources. This section lists a few of the common 
uses of firewall service in network administration.
Preventing Denial-of-Service (DoS) Attacks
When the server receives a TCP connection request from a client to whom access is 
denied, by default it sends a reply rejecting the connection. This stops the denied client 
from resending over and over again. However, a malicious user can generate a series of 
TCP connection requests from a denied IP address and force the server to keep 
replying, locking out others trying to connect to the server. This is one type of Denial-
of-Service attack.
To prevent ping denial-of-service attacks:
1 In Server Admin, choose Firewall from the Computers & Services list.
2 Click Settings.
3 Select the General tab.
4 Select the Any address group.
5 Deselect “ICMP Echo (ping) reply.”
6 Click Save.
Controlling or Enabling Peer-to-Peer Network Usage
Sometimes network administrators need to control the use of Peer-to-Peer (P2P) file 
sharing applications. Such applications might use network bandwidth and resources 
inappropriately or disproportionately. P2P file sharing might also pose a security or 
intellectual property risk for a business.
You can cut off P2P networking by blocking all traffic incoming and outgoing on the 
port number used by the P2P application. You’ll have to determine the port used for 
each P2P network in question. By default, Mac OS X Server’s firewall blocks all ports not 
specifically opened.
You can choose to limit P2P network usage to IP addresses behind the firewall. To do 
so, you’ll need to open the P2P port for your LAN interface, but continue to block the 
port on the interface connected to the Internet (WAN interface). To learn how to make 
a firewall filter, see “Creating an Advanced IP Filter for TCP ports” on page 51.
Important:  Denial-of-Service attacks are somewhat rare, so make these settings only 
if you think your server may be vulnerable to an attack. If you deny ICMP echo replies, 
services that use ping to locate network services will be unable to detect your server.
LL2351.Book  Page 59  Monday, September 8, 2003  2:47 PM
60
Chapter 3    IP Firewall Service
Controlling or Enabling Network Game Usage
Sometimes network administrators need to control the use of network games. The 
games might use network bandwidth and resources inappropriately or 
disproportionately. 
You can cut off network gaming by blocking all traffic incoming and outgoing on the 
port number used by the game. You’ll have to determine the port used for each 
network game in question. By default, Mac OS X Server’s firewall blocks all ports not 
specifically opened.
You can choose to limit network game usage to IP addresses behind the firewall. To do 
so, you’ll need to open the appropriate port on your LAN interface, but continue to 
block the port on the interface connected to the Internet (WAN interface). Some games 
require a connection to a gaming service for play, so this may not be effective. To learn 
how to make a firewall filter, see “Creating an Advanced IP Filter for TCP ports” on 
page 51.
You can open the firewall to certain games, allowing network games to connect to 
other players and game services outside the firewall. To do this, you’ll need to open up 
the appropriate port on your LAN and WAN interface. Some games require more than 
one port to be open. Consult the game’s documentation for networking details. To 
learn how to make a firewall filter, see “Creating an Advanced IP Filter for TCP ports” on 
page 51.
Advanced Configuration
You might prefer to use a command-line interface and conventional configuration file 
to configure Mac OS X Server’s firewall service. For example, you might have an existing 
ipfw configuration file that you want to migrate to a new Mac OS X Server installation. 
Alternately, you might need greater control of the firewall for troubleshooting or 
intrusion detection.
Background
When you click the Save button in Server Admin, all the old rules are flushed and new 
rules are loaded and apply immediately. This happens whether the IP firewall service is 
started or stopped. If the IP firewall service is running, it is stopped long enough to 
reload the rules, and it automatically restarts. The new rules are loaded from three 
sources:
• The rules from both the General and the Advanced panels (stored in /etc/ipfilter/
ip_address_groups.plist).
• The manually configured ipfw rules, if any (stored in /etc/ipfilter/ipfw.conf).
• The NAT divert rule, if the NAT service is running.
LL2351.Book  Page 60  Monday, September 8, 2003  2:47 PM
Chapter 3    IP Firewall Service
61
If you want to put your own rules in the ipfw.conf file, you can use a template that is 
installed at /etc/ipfilter/ipfw.conf.default. Duplicate the file, rename it, and edit it as 
indicated in the template’s comments.
Precautions
By using the Advanced panel or creating your own rules, you can put the server in a 
state that is completely cut off from network access. This might require a reboot in 
single-user-mode to restore network access. To avoid this, consider adding a cron job to 
disable the firewall periodically while you are testing rules. Be sure to disable this cron 
job when the machine is put into production.
The following command disables the firewall:
sudo sysctl -w net.inet.ip.fw.enable=0
And this enables it:
sudo sysctl -w net.inet.ip.fw.enable=1
Neither of these operations change the rules loaded into the firewall, they just 
determine whether those rules are applied.
Creating IP Filter Rules Using ipfw
You can use the ipfw command in conjunction with the firewall module of Server 
Admin when you want to:
• Display rules created by the firewall module. Each filter translates into one or more 
rules.
• Create filters with characteristics that can’t be defined using the firewall module. For 
example, you may want to use rules specific to a particular kind of IP protocol. Or you 
may want to filter or block outgoing packets.
• Count the number of times rules are applied.
If you use ipfw, make sure you don’t modify rules created using the firewall module. 
Changes you make to firewall module rules are not permanent. Firewall service 
recreates any rules defined using the firewall module whenever the service is restarted. 
Here is a summary of how the firewall module assigns rule numbers: 
Rule number
Used by firewall module for
10
Loop back.
20
Discarding any packet from or to 127.0.0.0/8 (broadcast).
30
Discarding any packet from 224.0.0.0/3 (broadcast).
40
Discarding TCP packets to 224.0.0.0/3 (broadcast).
100–64000
User-defined port-specific filters.
63200
Denying access for icmp echo reply. Created when “Deny ICMP 
echo reply” is selected in the Advanced pane of the Configure 
Firewall window.
LL2351.Book  Page 61  Monday, September 8, 2003  2:47 PM
62
Chapter 3    IP Firewall Service
Reviewing IP Filter Rules
To review the rules currently defined for your server, use the Terminal application to 
submit the ipfw show command. The show command displays four columns of 
information: 
When you type:
ipfw show
You will see information similar to this:
0010 260
32688
allow log ip from any to any via lo*
0020 0
0
deny log ip from 127.0.0.0/8 to any in 
0020 0
0
deny log ip from any to 127.0.0.0/8 in
0030 0
0
deny log ip from 224.0.0.0/3 to any in
0040 0
0
deny log tcp from any to 224.0.0.0/3 in
001001
52
allow log tcp from 111.222.33.3 to 111.222.31.3 660 
in
...
Creating IP Filter Rules
To create new rules, use the ipfw add command. The following example defines rule 
200, a filter that prevents TCP packets from a client with IP address 10.123.123.123 from 
accessing port 80 of the system with IP address 17.123.123.123:
ipfw add 200 deny tcp from 10.123.123.123 to 17.123.123.123 80
63300
Denying access for igmp. Created when Deny IGMP is selected in 
the Advanced pane of the Configure Firewall window.
63400
Allowing any TCP or UDP packet to access port 111 (needed by 
NetInfo). Created when a shared NetInfo domain is found on the 
server.
63500
Allowing user-specified TCP and UDP packets to access ports 
needed for NetInfo shared domains. You can configure NetInfo to 
use a static port or to dynamically select a port from 600 through 
1023. Then use the Configure Firewall window to allow all or 
specific clients to access those ports.
64000–65000
User-defined filters for Default.
Rule number
Used by firewall module for
Column
Information
1
The rule number. The lower the number, the higher the priority of 
the rule.
2
The number of times the filter has been applied since it was 
defined.
3
The number of bytes to which the filter has been applied.
4
A description of the rule.
LL2351.Book  Page 62  Monday, September 8, 2003  2:47 PM
Chapter 3    IP Firewall Service
63
Deleting IP Filter Rules
To delete a rule, use the ipfw delete command. This example deletes rule 200:
ipfw delete 200
For more information, consult the man pages for ipfw.
Port Reference
The following tables show the TCP and UDP port numbers commonly used by 
Mac OS X computers and Mac OS X Servers. These ports can be used when you’re 
setting up your IP filters. See the website www.faqs.org/rfcs to view the RFCs 
referenced in the tables.
TCP port
Used for
Reference
7
echo
RFC 792
20
FTP data
RFC 959
21
FTP control
RFC 959
22
ssh (secure shell)
23
Telnet
RFC 854
25
SMTP (email)
RFC 821
53
DNS
RFC 1034
79
Finger
RFC 1288
80
HTTP (Web)
RFC 2068
88
Kerberos
RFC 1510
106
Open Directory Password Server 
(along with 3659)
110
POP3 (email)
RFC 1081
111
Remote Procedure Call (RPC)
RFC 1057
113
AUTH
RFC 931
115
sftp
119
NNTP (news)
RFC 977
123
Network Time Server 
synchronization (NTP)
RFC 1305
137
Windows Names
138
Windows Browser
139
Windows file and print (SMB)
RFC 100
143
IMAP (email access)
RFC 2060
LL2351.Book  Page 63  Monday, September 8, 2003  2:47 PM
64
Chapter 3    IP Firewall Service
311
AppleShare IP remote Web 
administration, Server Monitor, 
Server Admin (servermgrd), 
Workgroup Manager 
(DirectoryService)
389
LDAP (directory)
Sherlock 2 LDAP search
RFC 2251
427
SLP (service location)
443
SSL (HTTPS)
514
shell
515
LPR (printing)
RFC 1179
532
netnews
548
AFP (AppleShare)
554
Real-Time Streaming Protocol 
(QTSS)
RFC 2326
600–1023
Mac OS X RPC-based services 
(for example, NetInfo)
625
Remote Directory Access
626
IMAP Administration (Mac OS X 
mail service and AppleShare IP 
6.x mail)
636
LDAP SSL
660
Server Settings, Server Manager
687
AppleShare IP Shared Users and 
Groups, Server Monitor, Server 
Admin (servermgrd)
749
Kerberos administration using 
the kadmind command-line tool
1220
QTSS Admin
1694
IP Failover
1723
PPTP VPN
RFC 2637
2049
NFS
2236
Macintosh Manager
3031
Program Linking
3659
Open Directory Password Server 
(along with 106)
7070
Real-Time Streaming Protocol 
(QTSS)
TCP port
Used for
Reference
LL2351.Book  Page 64  Monday, September 8, 2003  2:47 PM
Chapter 3    IP Firewall Service
65
8000–8999
Web service
16080
Web service with performance 
cache
UDP port
Used for