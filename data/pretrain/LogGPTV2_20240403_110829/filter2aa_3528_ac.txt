Free
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Exploit
●
Now let’s try to overwrite the Totalsize of mRecvBuf 
○
e1000_overflow_write_size_0xa0(0x130)
Free
DnD 
Buffer
Free
Packet
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Exploit
●
Now let’s try to overwrite the Totalsize of mRecvBuf 
○
e1000_overflow_write_size_0xa0(0x130)
Free
DnD 
Buffer
Free
Packet
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Out-of-bound 
write
Free
Free
Exploit
●
Now let’s try to overwrite the Totalsize of mRecvBuf 
○
e1000_overflow_write_size_0xa0(0x130)
○
The packet will be free after sending
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Exploit
●
Now let’s try to overwrite the Totalsize of mRecvBuf 
○
Try e1000_overflow_write_size_0xa0(0x130) many times
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Exploit
●
Now let’s try to overwrite the Totalsize of mRecvBuf 
○
Try e1000_overflow_write_size_0xa0(0x130) many times
○
Once the packet locates just before DnD v3
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Packet
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
totalSize=0x00a0
Before out-of-bound write
Free
Free
Exploit
●
Now let’s try to overwrite the Totalsize of mRecvBuf
○
Try e1000_overflow_write_size_0xa0(0x130) many times
○
Once the packet locates just before DnD v3 
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Packet
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
totalSize=0xff9f
After out-of-bound write
Free
Free
Exploit
●
Now we can overwrite continuous heap memory
●
But we still need to defeat ASLR
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
After out-of-bound write
totalSize=0xff9f
Exploit
●
To defeat ASLR
○
Padding heap with info-set
■
info-set guestinfo.XXX A*0xa0 
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Exploit
●
To defeat ASLR
○
Padding heap with info-set
■
info-set guestinfo.XXX A*0xa0 
Free
DnD 
Buffer
Free
AAAAA...
Free
AAAAA...
Free
Free
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
Free
Free
Exploit
●
To defeat ASLR
○
Overwrite heap memory after DnD Buffer
Free
DnD 
Buffer
Free
AAAAA...
Free
AAAAA...
Free
Free
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
Free
Free
Exploit
●
To defeat ASLR
○
Overwrite heap memory after DnD Buffer
Free
DnD 
Buffer
BBBBB...
AAAAA...
Free
AAAAA...
Free
Free
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
Free
Free
Exploit
●
To defeat ASLR
○
Overwrite heap memory after DnD Buffer
○
Check if overflow the heap we use by “info-get guestinfo.XXX”
Free
DnD 
Buffer
BBBBB...
AAAAA...
Free
AAAAA...
Free
Free
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
Free
Free
Exploit
●
To defeat ASLR
○
Once we overwrite the heap we use, we can confirm which heap will leak
Free
DnD 
Buffer
BBBBB...
Free
AAAAA...
Free
Free
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
The leak heap 
BBBAA...
Free
Free
Exploit
●
To defeat ASLR
○
Now，overwrite the heap until we can leak the vtable of DnDv3
Free
DnD 
Buffer
BBBBB...
Free
AAAAA...
Free
Free
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
The leak heap 
BBBAA...
Free
Free
Exploit
●
To defeat ASLR
○
Now，overwrite the heap until we can leak the vtable of DnDv3
Free
DnD 
Buffer
BBBBB...
BBBBB...
BBBBB...
BBBBB...
BBBBB...
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
The leak heap 
BBBBB...
Free
Free
Exploit
●
To defeat ASLR
○
Now，overwrite the heap until we can leak the vtable of DnDv3
Free
DnD 
Buffer
BBBBB...
BBBBB...
BBBBB...
BBBBB...
BBBBB...
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
The leak heap 
BBBBB...
struct DnD_V3{
void * vtable;
. . . 
Free
Free
Exploit
●
Arbitrary Address Write
○
We can overwrite the mRecvbuffer in DnD v3 to do Arbitrary Address Write.
Free
DnD 
Buffer
BBBBB...
BBBBB...
BBBBB...
BBBBB...
BBBBB...
DnD v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
The leak heap 
BBBBB...
struct DnDTransportBuffer{
. . . 
buffer = xxxxxxx 
totalSize=0xffxx
. . .
Free
Free
Exploit
●
Arbitrary Address Write
○
We can overwrite the mRecvbuffer in DnD v3 to do Arbitrary Address Write.
Free
DnD 
Buffer
BBBBB...
BBBBB...
BBBBB...
BBBBB...
BBBBB...
Fake DnD 
v3
Free
Free
Free
AAAAA...
AAAAA...
Free
Free
Free
Free
Free
AAAAA...
Free
Free
The leak heap 
BBBBB...
struct DnDTransportBuffer{
. . . 
buffer = 0x41414141 
totalSize=0x1000
. . .
Free
Free
Problem
●
We will fail in some situations
○
If DnD Buffer locate behind structures. 
Free
Free
Free
Free
Free
Free
Free
Free
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
DnD 
Buffer
Free
Free
Free
Free
Free
Problem
●
We will fail in some situations
○
if chunk before DnD v3 has been allocated 
Free
Free
Free
Free
Free
Free
Free
Allocated
DnD v3
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Problem
●
We will fail in some situations
○
if there is no leak chunk between DnD v3 buffer and DnD v3 structrue
Free
Free
AAAAA...
Free
Free
Free
Free
DnD 
Buffer
DnD v3
Free
AAAAA...
Free
Free
AAAAA...
Free
Free
Free
Free
Free
Free
Free
Free
Free
Free
Demo
Conclusion
●
Low-quality vulnerabilities can also be exploited by utilizing sophisticated heap 
manipulation techniques 
●
It will be harder and harder to crack VMware’s virtual machine
○
Shallow and high-quality bugs are killing by VMware and research community
○
VMware is removing exploitation-friendly objects continuously
○
Exploiting low-quality bugs requires us to dive into the internal mechanisms
Thanks!
@f1yYY__