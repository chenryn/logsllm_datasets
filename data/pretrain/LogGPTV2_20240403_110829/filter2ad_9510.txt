# 分享一次最近的应急溯源经历

## 译文声明
本文为翻译文章，具体内容和含义以原文为准。
作者：天启@涂鸦智能安全实验室

## 0x01 前言
某日，我接到一个朋友的求助电话。他告诉我他的客户中了病毒，现在客户非常恐慌，他也感到很无助。他希望我能协助进行攻击路径的溯源分析。考虑到当时是中午，我决定帮助他进行这次溯源分析。

首先，我向他询问了一些基本信息以便进一步排查，并提前准备好相应的工具。由于他们不是专业的安全人员，对细节可能不太敏感。因此，最有效的方法还是亲自查看中毒机器的情况。同时，稳定受害者的情绪并保护好现场也非常重要。尽可能在我们开始溯源前保持现场原状，这样可以帮助我们快速定位问题并找到解决方案。

然而，这次的情况并不理想。由于事态紧急，客户在慌乱中删除了所有异常文件和相关信息，这给溯源工作带来了很大的困扰。尽管如此，我还是硬着头皮开始了这项任务。

## 0x02 开始溯源分析

### 机器中毒常见情况
在开始之前，先介绍一下常见的两种机器中毒状况：
1. **勒索病毒**：重要文件被加密，并留下勒索者的联系方式及付款方式。
2. **挖矿病毒**：CPU占用异常高，机器运行非常卡顿。

对于第一种情况，从技术角度来看，解密被加密的文件几乎是不可能的。这是因为勒索病毒使用的加密算法与支付宝、微信支付所用的加密算法相似，而这些算法目前被认为是安全且不可破解的。虽然市面上有一些厂商声称提供解密工具或平台，但实际上它们通常是通过收集到的解密密钥来实现的。

相比之下，第二种情况稍微好一些。只需找到并终止异常进程，清除相关定时任务即可。

根据上述总结以及我们目前掌握的信息，可以初步判断此次中毒事件是由挖矿病毒引起的。因为其特征非常明显，即CPU占用非常高。根据截图信息，我们可以推测出该挖矿病毒的攻击路径：`python3脚本 -> javav.exe -> 开始挖矿`。当然，这只是基于现有信息的合理推测，具体的攻击路径还需要通过实际操作来确认。

### 具体分析过程
到了中午，我通过“向日葵”远程连接到了受害机器。当我登录到实际机器上时，我在思考如果我是黑客，该如何入侵这台机器并放置挖矿脚本？我的第一个想法是利用系统上的漏洞进行入侵。

#### 系统层面检查
- **操作系统**：Windows Server 2012 R2
- **功能**：简单的服务器，没有其他特殊功能
- **系统漏洞**：未发现直接可利用的系统漏洞

既然系统层面没有明显的漏洞，那么接下来的重点就是检查安装在系统上的应用程序是否存在漏洞。经过检查，我发现了一些可能存在漏洞的服务，如WebSphere、yongyou和activeMQ等。

#### 应用程序层面检查
- **activeMQ**：版本存在漏洞，但日志和文件夹中未发现入侵痕迹
- **WebSphere**：版本8.5.0.1，暴露在公网，可以直接进入管理后台（无需输入密码）

在WebSphere的运行文件夹中，我发现了两个可疑文件 `a.bat` 和 `c.exe`。通过下载并分析这些文件，我确认它们确实是用于挖矿的脚本。此外，我还验证了 `javav.exe` 会调用 `python3` 来执行挖矿任务。

至此，攻击链路已经清晰：黑客通过WebSphere入侵了该机器，然后下载了挖矿脚本进行挖矿。

### 结果反馈
我将这个结果告知了我的朋友，并建议他告诉客户，这台机器上的应用都是过时版本，需要立即进行全面检查和升级，以防止类似事件再次发生。

## 0x03 简单总结
虽然这次挖矿溯源分析成功了，但仍有必要进行总结。以下是一些个人经验，供参考：
1. **工具准备**：提前准备好所有可能用到的工具，最好是免安装版。
2. **安抚客户**：稳定客户情绪，对受害机器进行断网处理，尽量不要破坏现场。
3. **初步判断**：根据现有信息判断中毒类型，是勒索病毒还是挖矿病毒。
4. **排查方向**：从系统本身和安装的应用程序两个方向进行排查。

## 0x04 后记
笔者能力有限，文中难免有纰漏，望各位大佬海涵！如有交流需求，欢迎添加我的微信：5ed0c42e63c9c2145990351ccaec4da5（可解密）。

### 漏洞悬赏计划
涂鸦智能安全响应中心（[https://src.tuya.com）](https://src.tuya.com%EF%BC%89) 欢迎白帽子来探索。

### 招聘内推计划
涵盖安全开发、安全测试、代码审计、安全合规等所有方面的岗位，简历投递至 sec#tuya.com，请注明来源。