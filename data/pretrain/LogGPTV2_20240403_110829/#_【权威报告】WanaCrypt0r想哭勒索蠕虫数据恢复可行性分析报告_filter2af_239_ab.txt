队列优先级：
i. 对type2（满足后缀列表1）进行加密（小于0x400的文件会降低优先级）
ii. 对type3（满足后缀列表2）进行加密（小于0x400的文件会降低优先级）
iii. 处理剩下的文件（小于0x400的文件），或者其他一些文件
**4\. 加密逻辑**
加密过程采用RSA+AES的方式完成，其中RSA加密过程使用了微软的CryptoAPI，AES代码则静态编译到DLL中。加密流程如下图所示：
使用的密钥概述：
加密后的文件格式示意：
值得注意的是，在加密过程中，程序会随机选取一部分文件使用内置的RSA公钥来进行加密，这里的目的是解密程序提供的免费解密部分文件功能。
能免费解密的文件路径在文件f.wnry中，如下：
**5\. 随机数填充**
在完成加密之后，WanaCrypt0r会对其认为重要的文件进行随机数填充，然后将文件移动到指定的临时文件夹目录然后删除。此举用于对抗文件恢复类软件，同时兼顾加密文件的速度。
被随机数填充的文件需要满足以下几点：
在特殊目录（桌面，我的文档，用户文件夹）
文件小于200M
文件后缀在type列表1
填充的逻辑：
如果文件小于0x400,直接覆盖对应长度的随机数。
如果文件大于0x400,对文件距离末尾0x400处进行覆盖。
再次重定位文件指针到文件头，以0x40000大小的缓冲区为单位向写随机数直到文件末尾。
**6\. 文件删除操作**
WanaCrypt0r首先尝试将样本移动到临时文件夹，生成一个临时文件，然后再尝试多种方法删除文件。
当采用遍历磁盘的方式加密文件的时候，会在当前盘符生成“$RECYCLE”+ 全局自增量+”.WNCYRT”(eg：
"D:\$RECYCLE\1.WNCRYT")的临时文件。特别的，当盘符为系统盘（eg：C）时，使用的是系统的临时目录（%temp%）。
之后进程以固定时间间隔启动taskdl.exe来删除临时文件夹下的文件。
**第三章 数据恢复可行性分析**
根据对WannaCry蠕虫的执行逻辑进行分析，该蠕虫在加密线程中会对满足条件的文件用随机数或0x55进行覆写，从而彻底破坏文件的结构并防止数据被恢复，但是只限定于特定的文件夹和特定的后缀名。也就是说该蠕虫只对满足条件的文件进行了写覆写操作，受害者机器上仍然有很多的文件未被覆写，这就为数据恢复提供了可能。
在删除线程中，蠕虫是先将源文件通过MoveFileEx函数移动到其创建的临时文件夹下，最后统一进行删除。在这个过程中源文件的文件名会发生改变，常规数据恢复软件不知道这个文件操作逻辑，导致大部分文件无法恢复，只能恢复小部分文件，恢复数据效果极差。
另一方面，因为删除操作和加密操作在不同的线程中，受用户环境的影响，线程间的条件竞争可能存在问题，从而导致移动源文件的操作失败，使得文件在当前位置被直接删除，在这种情况下被加密的文件有很大概率可以进行直接恢复。但是满足这种情形的文件毕竟是少数，如果采用常规数据恢复软件则只能恢复少量此类文件。
根据以上分析，我们发现了除系统盘外的文件，用我们精细化处理的方法进行数据恢复，被加密的文件其实是有很大概率可以完全恢复的。据此360开发了专门的恢复工具2.0版，以期帮助在此次攻击中广大的受害者恢复加密数据：
继14日凌晨360全球首家发布恢复工具，为病毒受害者抢救了部分文件后。此次更新发布2.0版工具进一步挖掘病毒加密逻辑漏洞，清除病毒防止二次感染，并利用多重算法深度关联出可恢复文件并对受害者的文件进行免费解密，一站式解决蠕虫勒索软件带来的破坏，最大程度低保护了用户的数据安全，成功率遥遥领先于其他数据恢复类产品！
**第四章 总结**
WannaCry蠕虫的大规模爆发得益于其利用了MS-17-010漏洞，使得其在传统的勒索病毒的基础上具备了自我复制、主动传播的特性。在除去攻击荷载的情况下，勒索病毒最重要的是其勒索技术框架。勒索文件加密技术是使用非对称加密算法RSA-2048加密AES密钥，然后每个文件使用一个随机AES-128对称加密算法加密，在没有私钥和密钥的前提下要穷尽或破解RSA-2048和AES-128加密算法，按目前的计算能力和技术是不可破解的。但是作者在处理文件加密过程中的一些疏漏，大大增加了我们恢复文件的可能性，如果第一时间及时抢救，用户是能够恢复大部分数据的。
另外由于勒索赎金交付技术是使用的比特币，比特币具有匿名性，比特币地址的生成无需实名认证，通过地址不能对应出真实身份，比特币地址的同一拥有者的不同账号之间也没有关联。所以基于加密算法的不可破解特性和比特币的匿名特性，勒索病毒这类趋利明显的恶意攻击仍然会长时间流行，大家仍需要提高警惕。
**360追日团队（Helios Team）**
360 追日团队（Helios
Team）是360公司高级威胁研究团队，从事APT攻击发现与追踪、互联网安全事件应急响应、黑客产业链挖掘和研究等工作。团队成立于2014年12月，通过整合360公司海量安全大数据，实现了威胁情报快速关联溯源，独家首次发现并追踪了三十余个APT组织及黑客团伙，大大拓宽了国内关于黑客产业的研究视野，填补了国内APT研究的空白，并为大量企业和政府机构提供安全威胁评估及解决方案输出。
**已公开APT相关研究成果**
**联系方式**
**邮箱：PI:EMAIL**
微信公众号：360追日团队
扫描下方二维码关注微信公众号