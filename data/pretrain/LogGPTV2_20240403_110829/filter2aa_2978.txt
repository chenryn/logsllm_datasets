# 勿忘初心 - Ch1ng's Blog

## 思考与行动
- [首页](#)
- [链接](#)
- [关于我](#)
- [RSS订阅](#)

### 记一次 Tomcat 部署 WAR 包拦截绕过的深入研究

**作者**: admin  
**时间**: 2022-05-25  
**分类**: 开发, 技巧分享

#### 项目中遇到的有趣技巧

##### 0x01 引言
在某个项目中，当尝试通过 Tomcat 后台部署一个 WAR 包时遇到了拦截问题。这促使我们进行了一系列源码审计来探究背后的原因。

##### 0x02 分析过程
- **现象发现**：当我们向 `filename` 参数添加反斜杠（`\`）字符时，WAR 包成功地被部署，并且绕过了 Web 应用防火墙 (WAF) 的拦截。理论上，这样的文件名应被视为无效。
- **定位问题**：
  - 经过调查，我们发现是 Tomcat 的 `HTMLManagerServlet` 负责处理上传的应用包。
  - 在这个 Servlet 内部调用了 `upload` 方法来接收并解析上传的文件。
  - 文件名是通过 `getSubmittedFileName` 函数获取的，在此过程中使用了 `HttpParser.unquote` 对文件名进行了特殊字符转义处理。
- **根本原因**：
  - 经过调试得知，如果文件名中包含 `\` 字符，则 `unquote` 函数会忽略该符号，并继续读取下一个字符作为有效部分。
  - 因此，原本名为 `fu2.\war` 的文件实际上被识别为 `fu2.war`。
  - 由于 `fu2.\war` 不符合 WAF 中定义的危险后缀格式，故未触发拦截机制。
  - 类似地，使用如 `\f\u\2\.w\a\r` 或者 `demo.w\\\\\\ar` 等变形也可以达到相同效果。

---

**标签**: 无

* * *

**评论区**

- **新评论** [支持 Markdown 语法]
- **登录身份**: admin. [退出 »]

请在此处输入您的评论...

- **验证码**
- **提交评论**

* * *

**相关文章**
- [上一篇]: 解决 Cobalt Strike HTTPS Listener 无法在 Win7 运行问题
- [下一篇]: 暂无

---

&copy; 2022 勿忘初心 - Ch1ng's Blog. 由 Typecho 强力驱动.