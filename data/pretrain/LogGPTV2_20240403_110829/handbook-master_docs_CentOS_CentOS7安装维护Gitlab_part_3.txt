å®‰è£…å®Œæˆè®°å¾—å°†æ‰€æœ‰æœåŠ¡å¯èµ·æ¥å“¦
```bash
gitlab-ctl start # å¯åŠ¨æ‰€æœ‰æ•°æ®åº“
# postgresql æ•°æ®åº“å¦‚æœå¯åŠ¨ä¸äº†ï¼Œé€šè¿‡é‡å¯å¯åŠ¨
gitlab-ctl restart postgresql
```
å®‰è£…è¿‡å¦‚æœæŠ¥é”™ï¼ŒæŸ¥çœ‹æç¤ºæ ¹æ®æç¤ºæ“ä½œï¼Œç‰ˆæœ¬è·¨åº¦å¤ªå¤§ä¼šæŠ¥é”™å“¦ã€‚
```
gitlab preinstall: Automatically backing up only the GitLab SQL database (excluding everything else!)
Dumping database ...
Dumping PostgreSQL database gitlabhq_production ... pg_dump: [archiver (db)] connection to database "gitlabhq_production" failed: could not connect to server: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•
    Is the server running locally and accepting
    connections on Unix domain socket "/var/opt/gitlab/postgresql/.s.PGSQL.5432"?
Backup failed
[FAILED]
gitlab preinstall:
gitlab preinstall: Backup failed! If you want to skip this backup, run the following command and
gitlab preinstall: try again:
gitlab preinstall:
gitlab preinstall:   sudo touch /etc/gitlab/skip-auto-migrations
gitlab preinstall:
error: %pre(gitlab-ce-8.15.2-ce.0.el6.x86_64) scriptlet failed, exit status 1
Error in PREIN scriptlet in rpm package gitlab-ce-8.15.2-ce.0.el6.x86_64
error:   install: %pre scriptlet failed (2), skipping gitlab-ce-8.15.2-ce.0.el6
gitlab-ce-8.11.5-ce.0.el6.x86_64 was supposed to be removed but is not!
  Verifying  : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             1/2
  Verifying  : gitlab-ce-8.15.2-ce.0.el6.x86_64                                                                                                                                                             2/2
Failed:
  gitlab-ce.x86_64 0:8.11.5-ce.0.el6
```
çœ‹ä¸Šé¢ä¸€å †é”™è¯¯ï¼Œç¬é—´å°±æ‡µé€¼äº†ï¼Œçœ‹åˆ°ä¸€æ¡æ•‘æ˜Ÿå‘½ä»¤è®©æˆ‘å°è¯•è¿è¡Œ `sudo touch /etc/gitlab/skip-auto-migrations` äºæ˜¯æˆ‘äºŒé€¼çš„é‡æ–°`yum install gitlab-ce`è¿è¡Œäº†ï¼Œç»“æœçœŸçš„å®‰è£…æˆåŠŸäº†ï¼ŒğŸ˜„ã€‚
```bash
# é‡æ–°å®‰è£…å‘½ä»¤
yum reinstall gitlab-ce
# or
yum install gitlab-ce
```
```
...
gitlab: Thank you for installing GitLab!
gitlab: To configure and start GitLab, RUN THE FOLLOWING COMMAND:
sudo gitlab-ctl reconfigure
gitlab: GitLab should be reachable at http://114.55.148.71:8081
gitlab: Otherwise configure GitLab for your system by editing /etc/gitlab/gitlab.rb file
gitlab: And running reconfigure again.
gitlab:
gitlab: For a comprehensive list of configuration options please see the Omnibus GitLab readme
gitlab: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md
gitlab:
gitlab: GitLab now ships with a newer version of PostgreSQL (9.6.1), and will be used
gitlab: as the default in the next major relase. To upgrade, RUN THE FOLLOWING COMMANDS:
sudo gitlab-ctl pg-upgrade
gitlab: For more details, please see:
gitlab: https://docs.gitlab.com/omnibus/settings/database.html#upgrade-packaged-postgresql-server
gitlab:
  æ¸…ç†       : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             2/2
Found /etc/gitlab/skip-auto-migrations, exiting...
  Verifying  : gitlab-ce-8.15.2-ce.0.el6.x86_64                                                                                                                                                             1/2
  Verifying  : gitlab-ce-8.11.5-ce.0.el6.x86_64                                                                                                                                                             2/2
æ›´æ–°å®Œæ¯•:
  gitlab-ce.x86_64 0:8.15.2-ce.0.el6
å®Œæ¯•ï¼
```
é‡å¯é…ç½®ï¼Œå¯ä»¥è§£å†³å¤§éƒ¨åˆ†`502`é”™è¯¯ã€‚
```bash
gitlab-ctl reconfigure
```
## ä¼˜åŒ–å†…å­˜ä½¿ç”¨
ä¿®æ”¹é…ç½®æ–‡ä»¶ `/etc/gitlab/gitlab.rb`
```bash
# å‡å°‘ postgresql æ•°æ®åº“ç¼“å­˜
postgresql['shared_buffers'] = "256MB"
# å‡å°‘sidekiqçš„å¹¶å‘æ•°
sidekiq['concurrency'] = 1
# workerè¿›ç¨‹æ•°
postgresql['max_worker_processes'] = 4
unicorn['worker_processes'] = 2  ## workerè¿›ç¨‹æ•°
unicorn['worker_memory_limit_min'] = "400 * 1  `admin` => `Settings` => `Outbound requests`
### æœåŠ¡æ— æ³•å¯åŠ¨
```
[root@localhost gitlab]# gitlab-ctl status
fail: alertmanager: runsv not running
fail: gitaly: runsv not running
fail: gitlab-monitor: runsv not running
fail: gitlab-workhorse: runsv not running
fail: logrotate: runsv not running
fail: nginx: runsv not running
fail: node-exporter: runsv not running
fail: postgres-exporter: runsv not running
fail: postgresql: runsv not running
fail: prometheus: runsv not running
fail: redis: runsv not running
fail: redis-exporter: runsv not running
fail: sidekiq: runsv not running
fail: unicorn: runsv not running
```
[](https://confluence.jaytaala.com/pages/viewpage.action?pageId=9666568)
[Omnibus gitlab do not restart on CentOS7](https://gitlab.com/gitlab-org/omnibus-gitlab/issues/272)
å¼€æœºè‡ªåŠ¨å¯åŠ¨æœåŠ¡
```
[root@localhost ~]# systemctl status gitlab-runsvdir.service -l
â— gitlab-runsvdir.service - GitLab Runit supervision process
   Loaded: loaded (/usr/lib/systemd/system/gitlab-runsvdir.service; enabled; vendor preset: disabled)
   Active: inactive (dead)
```
å¦‚æœ `gitlab-runsvdir.service` æœåŠ¡æ²¡æœ‰å“åº”ï¼Œä½ å¯èƒ½è¦çœ‹ä¸€ä¸‹å†…å­˜æ˜¯å¦æ»¡äº†ï¼Œéœ€è¦é‡Šæ”¾å†…å­˜ï¼Œè€çš„ç‰ˆæœ¬éœ€è¦ 2G å†…å­˜ï¼Œæ–°ç‰ˆæœ¬éœ€è¦è‡³å°‘ 4G å†…å­˜ã€‚
### å…¶å®ƒé”™è¯¯
```bash
Error executing action `run` on resource 'bash[migrate gitlab-rails database]'
```
ä¸Šé¢é”™è¯¯æ˜¯æ•°æ®åº“æ²¡æœ‰å¯åŠ¨ï¼Œæˆ‘ä¸çŸ¥é“å¦‚ä½•å¯åŠ¨ï¼Œæˆ‘é‡å¯äº†æœåŠ¡å™¨ï¼Œç„¶åå¥½çƒäº†ã€‚ğŸ˜† 
https://gitlab.com/gitlab-org/gitlab-ce/issues/2052#note_1667899
```bash
NameError: uninitialized constant Devise::Async
```
```
Processing by RootController#index as HTML
Completed 401 Unauthorized in 17ms (ActiveRecord: 2.7ms)
```
```
/var/log/gitlab/nginx/gitlab_access.log <==
114.55.148.71 - - [04/Jan/2017:17:20:24 +0800] "GET /favicon.ico HTTP/1.0" 502 2662 "http://git.xxxxx.cn/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36"
```
## å‚è€ƒèµ„æ–™
- [gitlab/gitlab-ce](https://packages.gitlab.com/gitlab/gitlab-ce)
- [å®˜ç½‘ä¸‹è½½](https://www.gitlab.cc/downloads)
- [å®˜ç½‘å®‰è£…è¯´æ˜](https://doc.gitlab.cc/ce/install/requirements.html)
- [å¼€æºç‰ˆæœ¬å’Œä¼ä¸šç‰ˆæœ¬å¯¹æ¯”](https://www.gitlab.cc/features/#enterprise)
- [å®˜æ–¹å‡çº§Gitlabæ•™ç¨‹](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/8.14-to-8.15.md)
- [å®˜æ–¹Centoså®‰è£…Gitlabæ•™ç¨‹](https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/install/centos)
- [Gitlabå‡çº§è®°å½•](http://opjasee.com/2016/01/28/gitlab-upgrade.html)
- [ä¿®æ”¹gitlabä½¿ç”¨ç°æœ‰nginxæœåŠ¡åŠ502é—®é¢˜è§£å†³](http://www.yuzhewo.com/2015/11/03/%E4%BF%AE%E6%94%B9gitlab%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89nginx%E6%9C%8D%E5%8A%A1%E5%8F%8A502%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/)
- [æˆ‘æ‰€é‡åˆ°çš„GitLab 502é—®é¢˜çš„è§£å†³](http://blog.csdn.net/wangxicoding/article/details/43738137)