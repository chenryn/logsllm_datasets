# 【恶意软件】勒索软件Sage 2.2新变种将魔爪伸向更多国家
|
##### 译文声明
本文是翻译文章，文章来源：fortinet.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
译者：[shan66](http://bobao.360.cn/member/contribute?uid=2522399780)
预估稿费：200RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**简介**
****
在去年2月份的时候，我们发表了关于[Sage 2.0](https://blog.fortinet.com/2017/02/02/a-closer-look-at-sage-2-0-ransomware-along-with-wise-mitigations)的文章，并在3月发现了2.2版，但从此之后，FortiGuard实验室团队已经有6个多月没有发现这种恶意软件的重大活动踪迹了。因此，Sage勒索软件的变种好像已经淡出恶意软件的江湖了。
然而，我们最近又发现了Sage的新样本，虽然该样本看上去仍然是Sage
2.2，但现在已经增加了专门用于对抗分析和提权等功能。在本文中，我们将分享这些最新的发现。
通过Kadena威胁情报系统，我们已经确认该恶意软件是通过垃圾邮件来传播的，这些邮件带有恶意的JavaScript附件，之后，这些代码会下载新型的Sage
2.2变种。
图1 Sage 2.2新变种攻击矢量的KTIS视图
同时，有些样本是通过 **植入了恶意的VB宏下载器代码** 的文档进行扩散的，我们认为这些文档也是作为垃圾邮件的附件进行传播的。
根据Kadena威胁情报系统的数据，用于下载这个新版本的Sage的URL是由.info和.top顶级域名（TLD）以及路径的编号共同组成的。
真正有趣的是，我们发现Sage这个版本的文件竟然与Locky勒索软件的文件共享同一个下载服务器。
图2 托管Locky和Sage 2.2新变种的一些服务器
图3 下载URL示例
**没有发生变化的部分**
****
与Sage勒索软件的早期版本相比， **这个新版本的许多功能代码并没有变化**
，对于这一部分，我们这里不会详细介绍，但是对于一些重要的细节，还是有必要强调一下的。
与早期版本一样， **此版本也包含了各种加密算法。它使用与**[ **Sage
2.0**](https://blog.fortinet.com/2017/02/02/a-closer-look-at-sage-2-0-ransomware-along-with-wise-mitigations)
**（即ChaCha20）相同的加密算法来加密文件。加密文件的名称仍然使用扩展名.sage。**
同时，它还还会通过下面给出的特定国家的键盘布局来避免感染某些国家/地区的机器：
白俄罗斯、哈萨克、乌兹别克、俄罗斯、乌克兰、萨哈、拉脱维亚 。
这次发现的新变种仍然使用与Sage早期版本相同的消息来设置桌面壁纸。
图4 Sage勒索软件的桌面壁纸
**代码混淆**
****
在考察该恶意软件的新变种时，我们观察到了一个有趣的变化，那就是 **大多数字符串已被加密，以掩盖其恶意内容。** 事实证明，这些字符串使用的是
**Chacha20密码算法** 。每个加密后的字符串都有自己硬编码的解密密钥。
图5 字符串解密函数
**分析对抗、沙箱对抗和虚拟机对抗功能**
****
除了加密的字符串之外，该恶意软件的新变种还实现了一些新功能，来探测自己是否正在被分析，或者是否将被加载到沙箱或虚拟机中。如果检测到这些情形，它将立即自动终止，以避免被分析。
以下是该恶意软件进行的各种对抗性的检查：
**进程名称检查**
****
Sage的这个变种会枚举机器的所有活动进程，并使用Murmurhash3计算哈希值，然后根据硬编码的哈希值列表进行比对。表1列出了一些列入黑名单的进程名称及其相应的Murmurhash3哈希值。
表1 列入黑名单的进程名称
**文件名检查**
****
它还在恶意软件执行的路径全称中查找以下名称。
**sample**
**malw**
**sampel**
**virus**
**{sample’s MD5}**
**{samples’s SHA1}**
这些名称通常用作分析恶意软件样本的文件名或目录名。由此看来，如果这些名称中的任何一个出现在相应的完整路径中，Sage就会假定自己正在被分析。由于这里使用的函数是StrStrI()，所以比较时不区分大小写。
图6 文件全路径检查
**计算机名称和用户名检查**
****
该恶意软件可以通过多种方式来检测自己是否被加载到了AV沙箱中。其中一种方式是检查在沙箱环境中是否使用了已知计算机或用户名。这个恶意软件的变种中包含了硬编码的计算机名和用户名列表，这些也是通过Murmurhash3计算哈希值的。
到目前为止，我们只从这些列表中确定出了一个名称，就是计算机名“abc-win7”。
除了哈希列表外，它还包含加密的计算机名称和用户名字符串。下面是解码后的字符串列表：
Wilbert
Customer
Administrator
Miller
user
CUCKOO-
TEST-
DESKTOP-
WORKSTATION
JOHN-PC
ABC-PC
SARA-PC
PC
D4AE52FE38
**CPUID检查**
****
这个恶意软件还使用x86指令CPUID来获取处理器的详细信息，如处理器品牌字符串等。然后，检查该品牌字符串是否位于通常用于虚拟化环境的CPU ID黑名单中：
**KVM**
**Xeon**
**QEMU**
**AMD Opteron 2386**
图7 检查CPU ID
**防病毒服务名称和MAC地址检查**
****
最后，它还会检查计算机上是否正在运行防病毒软件，并检查MAC地址是否被列入了黑名单中。该恶意软件通过枚举在服务控制管理器下运行的服务来检查是否有防病毒软件运行，并通过Murmurhash3对这些服务名称进行相应的处理，然后根据其硬编码的哈希列表进行检查。表2和表3分别列出了黑名单中的一些防病毒服务名称和MAC地址。
表2 列入黑名单的服务名称
表3 列入黑名单的MAC地址
**深入分析Sage的提权机制**
****
恶意软件通常会设法获得高于提供给普通用户帐户的特权级别，因为更高的权限级别允许他们获得对系统的完全控制，然后就可以在受感染的系统上为所欲为了。这对于加密型的勒索软件来说尤为重要，因为它们需要更高的权限级别来确保能够对受害者的所有文件进行加密，尤其是存储在受保护文件夹中的那些珍贵文件。在最近的分析中，我们还发现，Sage已经能够通过利用已修补的Windows内核漏洞或用户帐户控制（UAC）功能来提升其权限了。