是在OpenID Connect协议中对各个参数的深刻理解上，针对流程和处理
逻辑的攻击行为，需要引起安全设计人员的重视。只有深刻理解了协议
和流程，才能分析可能存在的风险，以在设计中弥补此类缺陷。
除了上述常见问题外，在OpenID 
Connect协议的核心规范文档
中，也给出了常规的安全建议，从各个层面给出了具体保护措施，举
例如下。
■ request或request_uri的端到端加密通信。
■ 使用密钥或加密JWT对服务器端进行身份验证。
■ 使用短有效期的令牌或一次性令牌。
7.4 业界最佳实践
前文介绍的API身份认证技术在不同的业务场景中可以被单独使
用，而更多的场景下，考虑到业务流程的不同交互，往往融入多种API
身份认证技术，以提高系统的安全性。下面将结合微软Azure和支付宝
第三方应用来进一步讨论API身份认证技术的使用。
7.4.1 案例之微软Azure云API身份认证
Azure云是微软对外提供的公有云服务，其平台面向企业用户和个
人用户提供数据库、云服务、云存储、人工智能互联网、CDN等高效、
稳定、可扩展的云端服务。这些服务大多数都提供API形式的管理方
式，当大量的企业级应用程序部署在云端时，为了保障平台的稳定，如
何使用API管理并将API安全地发布给外部客户、合作伙伴、员工、开
发者，是Azure云在API安全方面需要深入探究的问题。Azure官方网站
向使用者详细地介绍了各种不同的身份认证技术在Azure云中的使用方
式，比如基于OAuth 2.0和OpenID Connect协议、基于SAML 2.0协议、
基于WS联合身份认证、基于ID令牌等，如图7-15所示。
●图7-15 Azure云支持的身份认证方式
1.适用API身份认证的应用程序类型
在这里，仅从API身份认证的角度分析Azure云是如何使用客户端证
书的身份认证来保护API的。在Azure云基础组件微软标识平台
（Microsoft 
identity 
platform）中，基于行业标准协议OAuth 
2.0和
OpenID Connect进行技术实现，支持多种不同类型的应用程序身份认证
方案。微软标识平台将应用程序划分为单页应用、Web应用、Web
API、移动应用、桌面应用、后台应用63个类型，并根据不同的应用程
序类型推荐不同的身份认证方式。
2.不同类型应用程序API身份认证方式
针对这63种不同的应用程序类型，微软标识平台推荐使用不同的身
份认证方式获取令牌，以调用受保护的API。
（1）单页应用
单页应用是随着前端技术兴起而逐渐流行的，主要由JavaScript框架
编写，常用的框架还有Angular、React或Vue等。单页应用通常在浏览
器中运行，其身份认证特征不同于传统的Web应用程序，Azure推荐使
用OpenID Connect中的简化授权码认证方式，如图7-16所示。
●图7-16 单页应用认证方式
（2）Web应用
Web应用在这里是指传统的Web应用，通常包含用户登录和未登录
两种情况，对于此类应用的API身份认证，Azure推荐使用OpenID
Connect中的授权码认证方式，如图7-17所示。
●图7-17 Web应用认证方式
（3）Web API
Web 
API是指不同API之间的通信，通常是服务到服务的身份认
证，Azure推荐使用OpenID Connect中的授权码认证方式，Web API通过
与后台应用程序类似的客户端共享机密信息或证书访问API端点A获取
API端点B的access_token，如图7-18所示。
●图7-18 Web API认证方式
（4）移动应用
考虑到不同移动端设备的兼容性，针对移动应用的身份认证开发了
独立的微软认证组件（Microsoft Authenticator），通过此组件完成移动
应用的身份认证，如图7-19所示。
●图7-19 移动应用认证方式
（5）桌面应用
对于桌面应用程序调用API，Azure推荐使用Microsoft身份验证库
（MSAL）来完成身份认证，如图7-20所示。
●图7-20 桌面应用认证方式
除此之外，对于不支持浏览器的桌面应用，推荐使用用户名/密
码、OAuth 
2.0的双重令牌缓存序列化或自定义令牌缓存序列化方式完
成身份认证。
（6）后台应用
后台应用主要指服务器端应用程序或后端守护进程类程序，对于此
类应用程序，Azure推荐使用客户端凭据来进行身份认证和获取令牌。
客户端凭据通常是应用程序密码、证书或客户端机密信息等，比如客户
端应用程序在应用门户注册时生成的client_id值、client_secret值，注册
时上传的客户端证书，服务器端通过对此类机密信息的认证来完成身份
认证并返回access_token，如图7-21所示。
●图7-21 后台应用认证方式
7.4.2 案例之支付宝第三方应用API身份认证
支付宝开放平台是一个将支付宝的支付、营销、数据能力通过API
接口等形式对外开放，给第三方合作伙伴使用的平台。通过接入支付宝
平台，第三方合作伙伴可以快速完成电子商务生态中支付、营销、数据
分析等多种能力的构建，开发出更具有自己业务特征的、更符合市场节
奏的应用程序。
针对对外开放的各种API接口，平台提供了文档、源码demo、社区
问答等多种形式的开发者赋能。下面就从第三方应用的角度，分析一下
应用入驻过程中API身份认证的相关技术。
支付宝开放平台第三方应用的入驻流程如图7-22所示。
●图7-22 支付宝开发平台第三方应用入驻流程
在图73-22的63个步骤中，其中配置应用环境步骤与后续的接口调
用相关，主要是接口加签方式的设置，此项为必填项，如果设置错误，
则无法调用接口，如图7-23所示。
●图7-23 支付宝开发平台第三方应用接口加签配置信息
在整个接口调用过程中，设置接口加签方式的目的是为了配置接口
调用所需要的密钥，因为第三方应用程序调用支付宝接口前，先要生成
RSA密钥，生成密钥后上传到支付宝开放平台，在开发者中心进行密钥
配置，从而获取支付宝公钥（ALIPAY_PUBLIC_KEY）。第三方应用
程序再通过RSA密钥中包含的应用私钥（APP_PRIVATE_KEY）、应用
公钥（APP_PUBLIC_KEY）以及支付宝公钥
（ALIPAY_PUBLIC_KEY）才能调用支付宝接口。这个过程中，成为
第三方服务开放者保证了开发者身份的正确性，密钥配置和接口调用时
密钥的使用保证了API调用者身份认证的正确性。这三种密钥的用途分
别如下。
■ 应用私钥（APP_PRIVATE_KEY）由开发者自己保存，需填写
到代码中供接口调用时对请求内容进行签名时使用。
■ 应用公钥（APP_PUBLIC_KEY）上传到支付宝开放平台，成功
后即可获得支付宝公钥证书。
■ 支付宝公钥（ALIPAY_PUBLIC_KEY）配置在代码中对请求内
容进行签名，并对支付宝返回的内容进行验签。
这些密钥与应用创建完成后平台生成的APPID具有唯一性的绑定关
系，在接口调用时作为重要参数使用。客户端和服务器端之间，通过双
向验签的过程，保证通信双方的身份可信。客户端和服务器端之间一次
完成的通信过程如图7-24所示。
●图7-24 支付宝开发平台第三方应用API身份认证流程
图73-24中的交互过程是从客户端构造请求参数开始，到接收并处
理服务器端消息结束，在整个过程中，客户端和服务器端双方均对请求
的对象进行了验签，从而保证了双方身份的真实性和可靠性。
7.5 小结
对于API身份认证技术，目前主要是以OAuth 2.0协议为基础Token
系列认证为主，在OAuth 2.0协议的API授权优势之上，也为开发者提供
了一整套体系化的技术解决方案，将客户端认证技术中的密钥认证、证
书认证、HTTP Basic基本认证等认证方式包含其中，在保证了身份认证
信息准确性的同时也保证了通信过程的完整性和机密性。最后，结合微
软Azure云中不同应用形态的推荐身份认证方式和支付宝开放平台接口
调用过程，为读者讲述了API身份认证相关技术细节，希望对读者能有
所帮助。
第8章 API授权与访问控制
前一章介绍了API身份认证的相关技术，在一般的业务流程中，身
份认证与授权是紧密相连的两个部分，身份认证解决“你是谁”的问题，
授权解决知道“你是谁”之后的“你能干什么”的问题。身份认证是基础，
确保通信双方的真实、可信，如果身份可信，接下来就需要考虑对访问
者的授权与访问控制。本章的内容将从授权与访问控制的基本概念开
始，介绍API授权与访问控制相关技术及业界最佳实践。
8.1 授权与访问控制的基本概念
授权和访问控制是安全技术领域无法绕过的话题，在技术落地上，
很多安全策略的制定都是围绕这两个方面去考量的，通过授权和访问控
制技术，能保证资源被合理利用，减少被非法访问和泄露的风险。
8.1.1 授权的含义
在计算机领域，授权是指为了满足用户执行任务时需要操作的功能
所授予的权限，对应到现实生活中是指不同的人分管不同的领域，做
不同的事情，需要不同的权限。比如在一所学校中班主任老师这个角
色所拥有的权限是管理他所在班级及班级学生的相关信息，而其他班级
的信息这位班主任老师是无权限管理的。这个学校的校长可以管理所有
班级的信息。这对应到计算机信息系统中就是授权的范围的不同和拥有
权限的不同。
计算机信息系统中对于授权的管理通常分为两大类.
■ 功能级权限管理。
■ 数据级权限管理。
功能级权限管理的含义是针对信息系统中的功能进行权限管理，这
里的功能是指信息系统中的模块、菜单、按钮、链接。对不同的用户授
予不同的模块、菜单、链接、按钮的操作权限。而数据级权限管理是
指针对同一功能不同用户拥有不同的操作数据的权限，这里的操作数据
的权限是指数据的范围和数据的增加、修改、删除等操作。
在API安全技术领域，功能级权限管理是指不同的用户或不同的角
色对不同的API端点具备的权限的管理。数据级权限管理是指不同的用
户或不同的角色对不同的API端点中涉及的数据、图片、视频等资源，
对于可操作资源的范围、范围内资源的增删改查的操作权限管理。
授权管理中很重要的一个设计原则是最小特权原则，即对用户和
API端点授权时，在满足功能的前提下仅授予最小的权限，同时，不同
的用户或角色，授权之间相互独立，否则会出现权限过大或违背业务独
立性的要求。授权不合理是导致出现OWASP API安全问题中失效的对
象级授权、失效的功能级授权两类问题的重要原因。
8.1.2 访问控制的含义
访问控制是在授权正确的前提下，通过访问控制机制，保证用户或
角色所访问的内容和资源与所授权范围一致。设想有这样一个场景：一
栋楼房有多个不同的房间，有普通办公间也有资料室。普通办公间对于
普通员工来说是可以进入的，而资料室只有经理级以上员工才可以进