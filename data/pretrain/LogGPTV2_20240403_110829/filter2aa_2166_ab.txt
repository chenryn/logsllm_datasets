### 利用EVFS并加载额外的内核模式驱动程序

#### 阶段 5
- **主要的有效载荷和数据文件**

### 商业军火带来的问题：我们面对怎样的对手？

#### 文件类型及描述
| 编号 | 文件类型 | 描述 |
| --- | --- | --- |
| 0003 | SYS | 驱动程序 |
| C433 | SYS | Rootkit |
| C42B | SYS | PE加载程序 |
| C42D | SYS | DLL注入 |
| C3C3 | SYS | 类似WinPcap的网络数据包过滤器驱动程序（协议过滤器版本3.5），用于设置TCP和UDP穿透过滤器和绕过防火墙。执行BPF（Berkeley包过滤器）字节码，存储在阶段5的数据文件里。 |
| CE69 | SYS | 网络端口屏蔽器 |
| C363 | DLL | 网络数据包捕获 |
| 4E3B | DLL | 通过注册表或配置文件（如prefs.js, refs.js等）检索网页浏览器（IE浏览器，网景，火狐等）的代理信息。枚举会话和用户账户。 |
| 290B | DLL | 密码窃取器：<br>• Windows资源管理器凭据<br>• Windows资源管理器受保护存储记录<br>• IE合法设置<br>• 名为“cryptpp”登陆通知数据包的数据 |
| C375 | DLL | C&C HTTP/cookies |
| C383 | DLL | SSL通信 |
| C361 | DLL | 支持加密功能 |
| 001B | DLL | ICMP反向信道 |
| C399 | DLL | ApplicationLog.Evt记录创建程序 |
| C39F | DLL | 进程文件：%Temp%\~b3y7f.tmp |
| C36B | DLL | UI操纵：<br>• 截屏<br>• 记录键盘操作<br>• 锁定工作站/输入Ctrl-Alt-Del<br>• 点击功能 (通过三条指令：去、点击并释放、返回原始位置)<br>• 结束进程 |
| C351 | DLL | 文件系统探索元和包括原始NTFS解析器的取证水平探索：<br>• 获取其他文件信息和属性<br>• 浏览记录<br>• 读写文件<br>• 移动和复制文件<br>• 读取并修复部分或全部被删除的文件<br>• 计算文件哈希 |
| 2B5D | DLL | 进程和模块操作：<br>• 读取进程和模块<br>• 进程运行的时间、限制和权限<br>• 扫描时，跳过俄语或英语的微软文件<br>• 检测过去两天里新引进的PE文件 |
| C3CD | DLL | 枚举 %System%\CurrentControlSet\Services\Tcpip\Linkage\bind里的TCP/IP接口 |
| C38F | DLL | TCPDump 功能 |
| C3C5 | DLL | Libnet 二进制文件 |
| 27E9 | DLL | IIS 网页浏览器日志窃取，通过COM对象枚举发现IIS日志。检索部分或全部日志信息。<br>• 部分：日志类型、上一个日志、较早日志的时间戳<br>• 全部：被发掘的全部日志记录 |

### 方程式组织（Equation Group）

- **卡巴斯基安全实验室**于2015年2月16日起发布系列报告披露了“可能是目前世界上存在的最复杂的网络攻击组织”——“方程式”组织。该组织使用的C&C早在1996年就被注册，暗示其可能已经活跃了20年之久。多年来，他们因总能比其他组织早发现漏洞而具有绝对优势。

#### 组件名称及说明
| 组件名称 | 说明 | 时间 |
| --- | --- | --- |
| EquationLaser | 方程式组织早期使用的植入程序，大约在2001至2004年间被使用。兼容Windows 95/98系统。 | 2001-2003 |
| Fanny | 创建于2008年的利用USB设备进行传播的蠕虫，可攻击物理隔离网络并回传收集到的信息。Fanny被用于收集位于中东和亚洲的目标的信息。一些受害主机似乎已被升级到DoubleFantasy，然后又升级为EQUATIONDRUG。Fanny利用了两个后来被应用到Stuxnet中的0day漏洞。 | 2008-2011 |
| EquationDrug | 该组织使用的一个非常复杂的攻击组件，用于支持能够被攻击者动态上传和卸载的模块插件系统。怀疑是EquationLaser的升级版。 | 2003-2013 |
| DoubleFantasy | 一个验证式的木马，旨在确定目标为预期目标。如果目标被确认，那么已植入恶意代码会升级到一个更为复杂的平台，如EQUATIONDRUG或GRAYFISH。 | 2004-2012 |
| TripleFantasy | 全功能的后门程序，有时用于配合GRAYFISH使用。看起来像是DOUBLEFANTASY的升级版，可能是更新的验证式插件。 | 2012-至今 |
| GrayFish | 方程式组织中最复杂的攻击组件，完全驻留在注册表中，依靠bootkit在操作系统启动时执行。 | 2008-至今 |
| nls_933w.dll | 修改硬盘固件的超级插件 | 2010-至今 |

### 不同水平的攻击者

- **共性**：
  - 预算有限，威胁无穷
  - 多处受敌，被动防御
  - 安全业务，互为制约
- **区别**：
  - 只能忍受，无力反抗

### 可以采取的应对策略

#### 纵深防御
- **核心思路**：
  - 层层设防，消耗敌人
  - 有效响应，不断完善

#### 检测攻击源头
- **检测文档格式漏洞攻击**
- **深度分析PE样本行为**
- **有效发现0DAY**
- **预警未知恶意代码**
- **本地化海量规则**
- **动态沙箱检测**

#### 安天在可信计算方面的探索
- **安天追影威胁分析系统（可信载体版）**：
  - 格式文档攻击检测、PE样本深度行为分析，有效发现0DAY，预警未知恶意代码。
  - 本地化海量规则和动态沙箱检测，不依赖云端能力，构建专属分析环境。
  - 标准联动接口，改善安全网关、企业级安全防护产品的检测能力纵深。
- **浪潮可信计算平台**：
  - 系统启动引导自验证安全保护
  - 数据存储自验证安全保护
  - 虚拟系统环境安全保护

#### 主场优势
- **部署蜜罐，及时预警**
- **真假难辩，迷惑对手**
- **设置陷阱，追踪溯源**

### 参考书目

### 联系方式
- 微博: weibo.com/libaisong75
- 邮箱: PI:EMAIL