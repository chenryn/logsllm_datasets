利用EVFS并加载额外的内
核模式驱动程序，包括有
效载荷。
阶段 5
主要的有效载荷和数据文
件
28
商业军火带来的问题
我们面对怎样的对手
文件类型
编号
描述
SYS
0003
驱动程序
SYS
C433
Rootkit
SYS
C42B
PE加载程序
SYS
C42D
DLL注入
SYS
C3C3
类似WinPcap的网络数据包过滤器驱动程序（协议过滤器版本3.5）
用于设置TCP和UDP穿透过滤器和绕过防火墙。
执行BPF（Berkeley包过滤器）字节码，存储在阶段5的数据文件
里。
SYS
CE69
网络端口屏蔽器
DLL
C363
网络数据包捕获
DLL
4E3B
通过注册表或配置文件（如prefs.js, refs.js等）检索网页浏览器
（IE浏览器，网景，火狐等）的代理信息。枚举会话和用户账户。
DLL
290B
密码窃取器：
• Windows资源管理器凭据
• Windows资源管理器受保护存储记录
• IE合法设置
• 名为“cryptpp”登陆通知数据包的数据
DLL
C375
C&C HTTP/cookies
DLL
C383
SSL通信
DLL
C361
支持加密功能
DLL
001B
ICMP反向信道
DLL
C399
ApplicationLog.Evt记录创建程序
DLL
C39F
进程文件：%Temp%\~b3y7f.tmp
DLL
C36B
UI manipulation
•
截屏
•
记录键盘操作
•
锁定工作站/输入Ctrl-Alt-Del
•
点击功能 (通过三条指令：去、点击并释放、
返回原始位置)
•
结束进程
DLL
C351
文件系统探索元和包括原始NTFS解析器的取证水平探索：
•
获取其他文件信息和属性
•
浏览记录
•
读写文件
•
移动和复制文件
•
读取并修复部分或全部被删除的文件
•
计算文件哈希
DLL
2B5D
进程和模块操作：
•
读取进程和模块
• 
进程运行的时间、限制和权限
•
扫描时，跳过俄语或英语的微软文件
•
检测过去两天里新引进的PE文件
DLL
C3CD
枚举 %System%\CurrentControlSet\Services\Tcpip\Linkage\bind里
的TCP/IP接口
DLL
C38F
TCPDump 功能
DLL
C3C5
Libnet 二进制文件
DLL
27E9
IIS 网页浏览器日志窃取
通过COM对象枚举发现IIS日志。检索部分或全部日志信息。
•
部分：日志类型、上一个日志、较早日志的时
间戳 
•
全部：被发掘的全部日志记录 
部分功能插件功能
29
商业军火带来的问题
我们面对怎样的对手
• 卡巴斯基安全实验室在2015年2月16日
起发布系列报告披露了一个“可能是目前
世界上存在的最复杂的网络攻击组
织”——“方程式”组织（Equation 
Group）。据卡巴斯基实验室称，该组
织使用的C&C早在1996年就被注册，
这暗示了该组织可能已经活跃了20年之
久。多年以来，他们因总能比其他组织
早发现漏洞，从而具有绝对的优势。
30
商业军火带来的问题
我们面对怎样的对手
31
商业军火带来的问题
我们面对怎样的对手
组件名称
说明
时间
EquationLaser
Equation组织早期使用的植入程序，大约在2001至2004年间被
使用。兼容Windows 95/98系统。
2001-2003
Fanny
创建于2008年的利用USB设备进行传播的蠕虫，可攻击物理隔
离网络并回传收集到的信息。Fanny被用于收集位于中东和亚洲
的目标的信息。一些受害主机似乎已被升级到DoubleFantasy，
然后又升级为EQUATIONDRUG。Fanny利用了两个后来被应
用到Stuxnet中的0day漏洞。
2008-2011
EquationDrug
该组织使用的一个非常复杂的攻击组件，用于支持能够被攻击
者动态上传和卸载的模块插件系统。怀疑是EquationLaser的升
级版。
2003-2013
DoubleFantasy
一个验证式的木马，旨在确定目标为预期目标。如果目标被确
认，那么已植入恶意代码会升级到一个更为复杂的平台，如
EQUATIONDRUG或GRAYFISH。
2004-2012
TripleFantasy
全功能的后门程序，有时用于配合GRAYFISH使用。看起来像
是DOUBLEFANTASY的升级版，可能是更新的验证式插件。
2012-至今
GrayFish
Equation组织中最复杂的攻击组件，完全驻留在注册表中，依
靠bootkit在操作系统启动时执行。
2008-至今
nls_933w.dll
修改硬盘固件的超级插件
2010-至今
32
商业军火带来的问题
我们面对怎样的对手
33
商业军火带来的问题
不同水平的攻击者
34
商业军火带来的问题
不同水平的攻击者
35
商业军火带来的问题
不同水平的攻击者
36
商业军火带来的问题
商业化攻击平台造成的影响
37
可以采取的应对策略
企业面临的窘境
共性：
•
预算有限，威胁无穷
•
多处受敌，被动防御
•
安全业务，互为制约
区别：
•
只能忍受，无力反抗
核心
技术
财务
数据
标书
合同
客户
数据
38
可以采取的应对策略
纵深防御
核心思路：
•
层层设防，消耗敌人
•
有效响应，不断完善
核心
技术
财务
数据
标书
合同
客户
数据
39
可以采取的应对策略
检测攻击源头
•
检测文档格式漏洞攻击
•
深度分析PE样本行为
•
有效发现0DAY
•
预警未知恶意代码
•
本地化海量规则
•
动态沙箱检测
Aurora
Night 
Dragon
RSA
NASDAQ
HBGary 
Federal
Stuxnet
duqu
Flame
Gauss
……
“极光行动”
“夜龙”
RSA入侵
纳斯达克
“震网”
HBGary 
Federal
“火焰”
“duqu”
“高斯”
其它……
40
可以采取的应对策略
安天在可信计算方面的探索
安天追影威胁分析系统（可信载体版）
 格式文档攻击检测、PE样本深度行为分析，
有效发现0DAY，预警未知恶意代码。
 本地化海量规则和动态沙箱检测，不依赖
云端能力，构建专属分析环境。
 标准联动接口，改善安全网关、企业级安
全防护产品的检测能力纵深。
浪潮可信计算平台
系统启动引导自验证安全保护
数据存储自验证安全保护
虚拟系统环境安全保护
41
可以采取的应对策略
主场优势
•
部署蜜罐，及时预警
•
真假难辩，迷惑对手
•
设置陷阱，追踪溯源
42
可以采取的应对策略
参考书目
43
谢谢！
weibo.com/libaisong75
PI:EMAIL