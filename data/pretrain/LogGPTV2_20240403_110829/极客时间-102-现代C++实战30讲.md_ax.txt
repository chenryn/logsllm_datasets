# 22 \| å¤„ç†æ•°æ®ç±»å‹å˜åŒ–å’Œé”™è¯¯ï¼šoptionalã€variantã€expectedå’ŒHerbceptionä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚æˆ‘ä»¬ä¹‹å‰å·²ç»è®¨è®ºäº†å¼‚å¸¸æ˜¯æ¨èçš„ C++ é”™è¯¯å¤„ç†æ–¹å¼ã€‚ä¸è¿‡ï¼ŒC++é‡Œæœ‰å¦å¤–ä¸€äº›ç»“æ„ä¹Ÿå¾ˆé€‚åˆè¿›è¡Œé”™è¯¯å¤„ç†ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥è®¨è®ºä¸€ä¸‹ã€‚optionalåœ¨é¢å‘å¯¹è±¡ï¼ˆå¼•ç”¨è¯­ä¹‰ï¼‰çš„è¯­è¨€é‡Œï¼Œæˆ‘ä»¬æœ‰æ—¶å€™ä¼šä½¿ç”¨ç©ºå€¼ nullè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°éœ€è¦çš„å¯¹è±¡ã€‚ä¹Ÿæœ‰äººæ¨èä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ç©ºå¯¹è±¡ï¼Œæ¥é¿å…ç©ºå€¼å¸¦æ¥çš„ä¸€äº›é—®é¢˜\[1\ã€‚å¯ä¸ç®¡æ˜¯ç©ºå€¼ï¼Œè¿˜æ˜¯ç©ºå¯¹è±¡ï¼Œå¯¹äºä¸€ä¸ªè¿”å›æ™®é€šå¯¹è±¡ï¼ˆå€¼è¯­ä¹‰ï¼‰çš„C++ å‡½æ•°éƒ½æ˜¯ä¸é€‚ç”¨çš„------ç©ºå€¼å’Œç©ºå¯¹è±¡åªèƒ½ç”¨åœ¨è¿”å›å¼•ç”¨ /æŒ‡é’ˆçš„åœºåˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦å †å†…å­˜åˆ†é…ï¼Œåœ¨ C++é‡Œä¼šå¼•è‡´é¢å¤–çš„å¼€é”€ã€‚C++17 å¼•å…¥çš„ `optional` æ¨¡æ¿ \[2\å¯ä»¥ï¼ˆéƒ¨åˆ†ï¼‰è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¯­ä¹‰ä¸Šæ¥è¯´ï¼Œ`optional`ä»£è¡¨ä¸€ä¸ª"ä¹Ÿè®¸æœ‰æ•ˆ""å¯é€‰"çš„å¯¹è±¡ã€‚è¯­æ³•ä¸Šæ¥è¯´ï¼Œä¸€ä¸ª `optional`å¯¹è±¡æœ‰ç‚¹åƒä¸€ä¸ªæŒ‡é’ˆï¼Œä½†å®ƒæ‰€ç®¡ç†çš„å¯¹è±¡æ˜¯ç›´æ¥æ”¾åœ¨ `optional`é‡Œçš„ï¼Œæ²¡æœ‰é¢å¤–çš„å†…å­˜åˆ†é…ã€‚æ„é€ ä¸€ä¸ª `optional`å¯¹è±¡æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š1.       ä¸ä¼ é€’ä»»ä½•å‚æ•°ï¼Œæˆ–è€…ä½¿ç”¨ç‰¹æ®Šå‚æ•°           `std::nullopt`ï¼ˆå¯ä»¥å’Œ        `nullptr`    ç±»æ¯”ï¼‰ï¼Œå¯ä»¥æ„é€ ä¸€ä¸ª"ç©º"çš„         `optional`    å¯¹è±¡ï¼Œé‡Œé¢ä¸åŒ…å«æœ‰æ•ˆå€¼ã€‚        2.       ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯         `std::in_place`ï¼Œåé¢è·Ÿæ„é€         `T`    æ‰€éœ€çš„å‚æ•°ï¼Œå¯ä»¥åœ¨         `optional` å¯¹è±¡ä¸Šç›´æ¥æ„é€ å‡º        `T`    çš„æœ‰æ•ˆå€¼ã€‚        3.       å¦‚æœ         `T` ç±»å‹æ”¯æŒæ‹·è´æ„é€ æˆ–è€…ç§»åŠ¨æ„é€ çš„è¯ï¼Œé‚£åœ¨æ„é€            `optional` æ—¶ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ª        `T`    çš„å·¦å€¼æˆ–å³å€¼æ¥å°†         `T` å¯¹è±¡æ‹·è´æˆ–ç§»åŠ¨åˆ°        `optional`    ä¸­ã€‚    å¯¹äºä¸Šé¢çš„ç¬¬ 1 ç§æƒ…å†µï¼Œ`optional` å¯¹è±¡é‡Œæ˜¯æ²¡æœ‰å€¼çš„ï¼Œåœ¨å¸ƒå°”å€¼ä¸Šä¸‹æ–‡é‡Œï¼Œä¼šå¾—åˆ°`false`ï¼ˆç±»ä¼¼äºç©ºæŒ‡é’ˆçš„è¡Œä¸ºï¼‰ã€‚å¯¹äºä¸Šé¢çš„ç¬¬ 2ã€3ä¸¤ç§æƒ…å†µï¼Œ `optional`å¯¹è±¡é‡Œæ˜¯æœ‰å€¼çš„ï¼Œåœ¨å¸ƒå°”å€¼ä¸Šä¸‹æ–‡é‡Œï¼Œä¼šå¾—åˆ°`true`ï¼ˆç±»ä¼¼äºæœ‰æ•ˆæŒ‡é’ˆçš„è¡Œä¸ºï¼‰ã€‚ç±»ä¼¼çš„ï¼Œåœ¨ `optional`å¯¹è±¡æœ‰å€¼çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç”¨ `*` å’Œ `->`è¿ç®—ç¬¦å»è§£å¼•ç”¨ï¼ˆæ²¡å€¼çš„æƒ…å†µä¸‹ï¼Œç»“æœæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼‰ã€‚è™½ç„¶  `optional` æ˜¯C++17 æ‰æ ‡å‡†åŒ–çš„ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªç”¨æ³•æ›´æ—©å°±é€šè¡Œäº†ã€‚å› ä¸º `optional`çš„å®ç°ä¸ç®—å¤æ‚ï¼Œæœ‰äº›åº“é‡Œå°±è‡ªå·±å®ç°äº†ä¸€ä¸ªç‰ˆæœ¬ã€‚æ¯”å¦‚ cpptoml\[3\å°±ç»™å‡ºäº†ä¸‹é¢è¿™æ ·çš„ç¤ºä¾‹ï¼ˆè¿›è¡Œäº†ç¿»è¯‘å’Œé‡æ’ç‰ˆï¼‰ï¼Œç”¨æ³•è·Ÿæ ‡å‡†çš„ `optional`å®Œå…¨å»åˆï¼š     auto val = config->      get_as("my-int");    // val  æ˜¯  cpptoml::option    if (val) {      // *val  æ˜¯  "my-int"  é”®ä¸‹çš„æ•´æ•°å€¼    } else {      // "my-int"  ä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•´æ•°    }cpptoml é‡Œåªæ˜¯ä¸ªç¼©å¾®ç‰ˆçš„ `optional`ï¼Œå®ç°åªæœ‰å‡ åè¡Œï¼Œä¹Ÿä¸æ”¯æŒæˆ‘ä»¬ä¸Šé¢è¯´çš„æ‰€æœ‰æ„é€ æ–¹å¼ã€‚æ ‡å‡†åº“çš„ `optional`ä¸ºäº†æ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨ï¼Œé™¤äº†æˆ‘ç›®å‰æè¿°çš„åŠŸèƒ½ï¼Œè¿˜æ”¯æŒä¸‹é¢çš„æ“ä½œï¼š1.  å®‰å…¨çš„ææ„è¡Œä¸º        2.  æ˜¾å¼çš„         `has_value` æˆå‘˜å‡½æ•°ï¼Œåˆ¤æ–­        `optional`    æ˜¯å¦æœ‰å€¼        3.  `value` æˆå‘˜å‡½æ•°ï¼Œè¡Œä¸ºç±»ä¼¼äº        `*`ï¼Œä½†åœ¨        `optional`    å¯¹è±¡æ— å€¼æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸         `std::bad_optional_access`4.  `value_or` æˆå‘˜å‡½æ•°ï¼Œåœ¨         `optional`    å¯¹è±¡æ— å€¼æ—¶è¿”å›ä¼ å…¥çš„å‚æ•°        5.  `swap` æˆå‘˜å‡½æ•°ï¼Œå’Œå¦å¤–ä¸€ä¸ª        `optional`    å¯¹è±¡è¿›è¡Œäº¤æ¢        6.  `reset` æˆå‘˜å‡½æ•°ï¼Œæ¸…é™¤         `optional`    å¯¹è±¡åŒ…å«çš„å€¼        7.  `emplace` æˆå‘˜å‡½æ•°ï¼Œåœ¨         `optional`    å¯¹è±¡ä¸Šæ„é€ ä¸€ä¸ªæ–°çš„å€¼ï¼ˆä¸ç®¡æˆåŠŸä¸å¦ï¼ŒåŸå€¼ä¼šè¢«ä¸¢å¼ƒï¼‰        8.  `make_optional` å…¨å±€å‡½æ•°ï¼Œäº§ç”Ÿä¸€ä¸ª        `optional`    å¯¹è±¡ï¼ˆç±»ä¼¼         `make_pair`ã€        `make_unique`    ç­‰ï¼‰    9.  å…¨å±€æ¯”è¾ƒæ“ä½œ        10. ç­‰ç­‰    å¦‚æœæˆ‘ä»¬è®¤ä¸ºæ— å€¼å°±æ˜¯æ•°æ®æ— æ•ˆï¼Œåº”å½“è·³è¿‡å‰©ä¸‹çš„å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸‹é¢è¿™æ ·çš„é«˜é˜¶å‡½æ•°ï¼š    template     constexpr bool has_value(      const optional& x) noexcept    {        return x.has_value();    }    template     constexpr bool has_value(      const optional& first,      const optional&... other) noexcept    {      return first.has_value() &&             has_value(other...);    }    template     auto lift_optional(F&& f)    {      return [f = forward(f)](               auto&&... args) {        typedef decay_t(args)            .value()...))>          result_type;        if (has_value(args...)) {          return optional(            f(forward(                args)                .value()...));        } else {          return optional();        }      };    }`has_value` æ¯”è¾ƒç®€å•ï¼Œå®ƒå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª `optional`å‚æ•°ï¼Œå¹¶åœ¨æ‰€æœ‰å‚æ•°éƒ½æœ‰å€¼æ—¶è¿”å›çœŸï¼Œå¦åˆ™è¿”å›å‡ã€‚`lift_optional`ç¨å¤æ‚äº›ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›å¦å¤–ä¸€ä¸ªå‡½æ•°ã€‚åœ¨è¿”å›çš„å‡½æ•°é‡Œï¼Œå‚æ•°æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª `optional`ç±»å‹ï¼Œ `result_type`æ˜¯ç”¨å‚æ•°çš„å€¼ï¼ˆ`value()`ï¼‰å»è°ƒç”¨åŸå…ˆå‡½æ•°æ—¶çš„è¿”å›å€¼ç±»å‹ï¼Œæœ€åè¿”å›çš„åˆ™æ˜¯ `result_type` çš„ `optional`å°è£…ã€‚å‡½æ•°å†…éƒ¨ä¼šæ£€æŸ¥æ‰€æœ‰çš„å‚æ•°æ˜¯å¦éƒ½æœ‰å€¼ï¼ˆé€šè¿‡è°ƒç”¨`has_value`ï¼‰ï¼šæœ‰å€¼æ—¶ä¼šå»æ‹¿å‚æ•°çš„å€¼å»è°ƒç”¨åŸå…ˆçš„å‡½æ•°ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºçš„ `optional`å¯¹è±¡ã€‚ è¿™ä¸ªå‡½æ•°èƒ½æŠŠä¸€ä¸ªåŸæœ¬è¦æ±‚å‚æ•°å…¨éƒ¨æœ‰æ•ˆçš„å‡½æ•°æŠ¬å‡ï¼ˆliftï¼‰æˆä¸€ä¸ªæ¥å—å’Œè¿”å› `optional`å‚æ•°çš„å‡½æ•°ï¼Œå¹¶ä¸”ï¼Œåªåœ¨å‚æ•°å…¨éƒ¨æœ‰æ•ˆæ—¶å»è°ƒç”¨åŸæ¥çš„å‡½æ•°ã€‚è¿™æ˜¯ä¸€ç§éå¸¸å‡½æ•°å¼çš„ç¼–ç¨‹æ–¹å¼ã€‚ä½¿ç”¨ä¸Šé¢å‡½æ•°çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š    #include     #include     #include     #include     #include     using namespace std;    //  éœ€åŒ…å«  lift_optional  çš„å®šä¹‰    constexpr int increase(int n)    {        return n + 1;    }    //  æ ‡å‡†åº“æ²¡æœ‰æä¾›  optional  çš„è¾“å‡º    ostream&    operator(x))    {      if (x) {        os ());      cout ())           ())             > `(Nothing)`>>>  > `(42)`>>>  > `(Nothing)`>>>  > `(42)`>variant`optional`æ˜¯ä¸€ä¸ªéå¸¸ç®€å•è€Œåˆå¥½ç”¨çš„æ¨¡æ¿ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œä½¿ç”¨å®ƒå°±è¶³å¤Ÿè§£å†³é—®é¢˜äº†ã€‚åœ¨æŸç§æ„ä¹‰ä¸Šï¼Œå¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯å…è®¸æœ‰ä¸¤ç§æ•°å€¼çš„å¯¹è±¡ï¼šè¦ä¹ˆæ˜¯ä½ æƒ³æ”¾è¿›å»çš„å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯`nullopt`ï¼ˆå†æ¬¡æé†’ï¼Œè”æƒ³`nullptr`ï¼‰ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›é™¤äº†æˆ‘ä»¬æƒ³æ”¾è¿›å»çš„å¯¹è±¡ï¼Œè¿˜å¯ä»¥æ˜¯ `nullopt`ä¹‹å¤–çš„å¯¹è±¡æ€ä¹ˆåŠå‘¢ï¼ˆæ¯”å¦‚ï¼ŒæŸç§å‡ºé”™çš„çŠ¶æ€ï¼‰ï¼Ÿåˆæ¯”å¦‚ï¼Œå¦‚æœæˆ‘å¸Œæœ›æœ‰ä¸‰ç§æˆ–æ›´å¤šä¸åŒçš„ç±»å‹å‘¢ï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œ`variant` \[4\å¯èƒ½å°±æ˜¯ä¸€ä¸ªåˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æ²¡æœ‰  `variant`ç±»å‹ä¹‹å‰ï¼Œä½ è¦è¾¾åˆ°ç±»ä¼¼çš„ç›®çš„ï¼Œææ€•ä¼šä½¿ç”¨ä¸€ç§å«åšå¸¦æ ‡ç­¾çš„è”åˆï¼ˆtaggedunionï¼‰çš„æ•°æ®ç»“æ„ã€‚æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªå¯èƒ½çš„æ•°æ®ç»“æ„å®šä¹‰ï¼š    struct FloatIntChar {      enum {        Float,        Int,        Char      } type;      union {        float float_value;        int int_value;        char char_value;      };    };è¿™ä¸ªæ•°æ®ç»“æ„çš„æœ€å¤§é—®é¢˜ï¼Œå°±æ˜¯å®ƒå®é™…ä¸Šæœ‰å¾ˆå¤šå¤æ‚æƒ…å†µéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚å¯¹äºæˆ‘ä»¬ä¸Šé¢ä¾‹å­é‡Œçš„POD ç±»å‹ï¼Œè¿™ä¹ˆå†™å°±å¯ä»¥äº†ï¼ˆä½†æˆ‘ä»¬ä»éœ€å°å¿ƒä¿è¯æˆ‘ä»¬è®¾ç½®çš„ `type`å’Œå®é™…ä½¿ç”¨çš„ç±»å‹ä¸€è‡´ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æŠŠå…¶ä¸­ä¸€ä¸ªç±»å‹æ¢æˆé PODç±»å‹ï¼Œå°±ä¼šæœ‰å¤æ‚é—®é¢˜å‡ºç°ã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ä»£ç æ˜¯ä¸èƒ½å·¥ä½œçš„ï¼š    struct StringIntChar {      enum {        String,        Int,        Char      } type;      union {        string string_value;        int int_value;        char char_value;      };    };ç¼–è¯‘å™¨ä¼šå¾ˆåˆç†åœ°çœ‹åˆ°åœ¨ union é‡Œä½¿ç”¨ `string`ç±»å‹ä¼šå¸¦æ¥æ„é€ å’Œææ„ä¸Šçš„é—®é¢˜ï¼Œæ‰€ä»¥ä¼šæ‹’ç»å·¥ä½œã€‚è¦è®©è¿™ä¸ªä»£ç å·¥ä½œï¼Œæˆ‘ä»¬å¾—æ‰‹å·¥åŠ ä¸Šææ„å‡½æ•°ï¼Œå¹¶ä¸”ï¼Œåœ¨ææ„å‡½æ•°é‡Œå¾—å°å¿ƒåœ°åˆ¤æ–­å­˜å‚¨çš„æ˜¯ä»€ä¹ˆæ•°å€¼ï¼Œæ¥å†³å®šæ˜¯å¦åº”è¯¥ææ„ï¼ˆå¦åˆ™ï¼Œé»˜è®¤ä¸è°ƒç”¨ä»»ä½•unioné‡Œçš„ææ„å‡½æ•°ï¼Œä»è€Œå¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼ï¼‰ï¼š      ~StringIntChar()      {        if (type == String) {          string_value.~string();        }      }è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½å®‰å…¨åœ°ä½¿ç”¨å®ƒï¼ˆè¿˜æ˜¯å¾ˆéº»çƒ¦ï¼‰ï¼š    StringIntChar obj{      .type = StringIntChar::String,      .string_value = "Hello world"};    cout  obj{      "Hello world"};    cout (obj)     #undef _LIBCPP_AVAILABILITY_BAD_OPTIONAL_ACCESS    #undef _LIBCPP_AVAILABILITY_BAD_VARIANT_ACCESS    #define _LIBCPP_AVAILABILITY_BAD_OPTIONAL_ACCESS    #define _LIBCPP_AVAILABILITY_BAD_VARIANT_ACCESS    #endifåŸå› æ˜¯è‹¹æœåœ¨å¤´æ–‡ä»¶é‡ŒæŠŠ `optional` å’Œ `variant` åœ¨æ—©æœŸç‰ˆæœ¬çš„ macOSä¸Šç¦æ‰äº†ï¼Œè€Œä¸Šé¢çš„ä»£ç å»æ‰äº†è¿™å‡ ä¸ªå®é‡Œå¯¹ä½¿ç”¨`bad_optional_access` å’Œ`bad_variant_access`çš„å¹³å°é™åˆ¶ã€‚æˆ‘çœŸçœ‹ä¸å‡ºä½¿ç”¨è¿™ä¸¤ä¸ªå¤´æ–‡ä»¶è·Ÿ macOSçš„ç‰ˆæœ¬æœ‰å•¥å…³ç³»ã€‚ğŸ˜expectedå’Œå‰é¢ä»‹ç»çš„ä¸¤ä¸ªæ¨¡æ¿ä¸åŒï¼Œ`expected` ä¸æ˜¯ C++æ ‡å‡†é‡Œçš„ç±»å‹ã€‚ä½†æ¦‚å¿µä¸Šè¿™ä¸‰è€…æœ‰ç›¸å…³æ€§ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿæ”¾åœ¨ä¸€èµ·è®²ä¸€ä¸‹ã€‚æˆ‘å‰é¢å·²ç»æåˆ°ï¼Œ`optional`å¯ä»¥ä½œä¸ºä¸€ç§ä»£æ›¿å¼‚å¸¸çš„æ–¹å¼ï¼šåœ¨åŸæœ¬è¯¥æŠ›å¼‚å¸¸çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹è€Œè¿”å›ä¸€ä¸ªç©ºçš„ `optional`å¯¹è±¡ã€‚å½“ç„¶ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±åªçŸ¥é“æ²¡æœ‰è¿”å›ä¸€ä¸ªåˆæ³•çš„å¯¹è±¡ï¼Œè€Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰è¿”å›åˆæ³•å¯¹è±¡äº†ã€‚æˆ‘ä»¬å¯ä»¥è€ƒè™‘æ”¹ç”¨ä¸€ä¸ª`variant`ï¼Œä½†æˆ‘ä»¬æ­¤æ—¶éœ€è¦ç»™é”™è¯¯ç±»å‹ä¸€ä¸ªç‹¬ç‰¹çš„ç±»å‹æ‰è¡Œï¼Œå› ä¸ºè¿™æ˜¯ `variant`æ¨¡æ¿çš„è¦æ±‚ã€‚æ¯”å¦‚ï¼š    enum class error_code {      success,      operation_failure,      object_not_found,      â€¦    };    variant      get_object(â€¦);è¿™å½“ç„¶æ˜¯ä¸€ç§å¯è¡Œçš„é”™è¯¯å¤„ç†æ–¹å¼ï¼šæˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿”å›å€¼çš„`index()`ï¼Œæ¥å†³å®šæ˜¯å¦å‘ç”Ÿäº†é”™è¯¯ã€‚ä½†è¿™ç§æ–¹å¼ä¸é‚£ä¹ˆç›´æˆªäº†å½“ï¼Œä¹Ÿè¦æ±‚å®ç°å¯¹å…è®¸çš„é”™è¯¯ç±»å‹ä½œå‡ºè§„å®šã€‚AndreiAlexandrescu åœ¨ 2012 å¹´é¦–å…ˆæå‡ºçš„ Expected æ¨¡æ¿\[6\ï¼Œæä¾›äº†å¦å¤–ä¸€ç§é”™è¯¯å¤„ç†æ–¹å¼ã€‚ä»–çš„æ–¹æ³•çš„è¦ç‚¹åœ¨äºï¼ŒæŠŠå®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯æ”¾åœ¨è¿”å›å€¼ï¼Œå¹¶åœ¨å¿…è¦çš„æ—¶å€™ï¼Œå¯ä»¥"é‡æ”¾"å‡ºæ¥ï¼Œæˆ–è€…æ‰‹å·¥æ£€æŸ¥æ˜¯ä¸æ˜¯æŸç§ç±»å‹çš„å¼‚å¸¸ã€‚ä»–çš„æ¦‚å¿µå¹¶æ²¡æœ‰è¢«å¹¿æ³›æ¨å¹¿ï¼Œæœ€ä¸»è¦çš„åŸå› å¯èƒ½æ˜¯æ€§èƒ½ã€‚å¼‚å¸¸æœ€è¢«äººè¯Ÿç—…çš„åœ°æ–¹æ˜¯æ€§èƒ½ï¼Œè€Œä»–çš„æ–¹å¼å¯¹æ€§èƒ½å®Œå…¨æ²¡æœ‰å¸®åŠ©ã€‚ä¸è¿‡ï¼Œåé¢çš„ç±»ä¼¼æ¨¡æ¿éƒ½æ±²å–äº†ä»–çš„éƒ¨åˆ†æ€æƒ³ï¼Œè‡³å°‘ä¼šç”¨ä¸€ç§æ˜¾å¼çš„æ–¹å¼æ¥æ˜ç¡®è¯´æ˜å½“å‰æ˜¯å¼‚å¸¸æƒ…å†µè¿˜æ˜¯æ­£å¸¸æƒ…å†µã€‚åœ¨ç›®å‰çš„expected çš„æ ‡å‡†ææ¡ˆ \[7\ é‡Œï¼Œç”¨æ³•æœ‰ç‚¹æ˜¯ `optional` å’Œ `variant` çš„æŸç§æ··åˆï¼šæ¨¡æ¿çš„å£°æ˜å½¢å¼åƒ`variant`ï¼Œä½¿ç”¨æ­£å¸¸è¿”å›å€¼åƒ`optional`ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ä¸€ä¸ª expected å®ç°\[8\ çš„åŸºæœ¬ç”¨æ³•ã€‚    #include     #include     #include     #include     using namespace std;    using tl::expected;    using tl::unexpected;    //  è¿”å›  expected  çš„å®‰å…¨é™¤æ³•    expected    safe_divide(int i, int j)    {      if (j == 0)        return unexpected(          "divide by zero"s);      if (i == INT_MIN && j == -1)        return unexpected(          "integer divide overflows"s);      if (i % j != 0)        return unexpected(          "not integer division"s);      else        return i / j;    }    //  ä¸€ä¸ªæµ‹è¯•å‡½æ•°    expected    caller(int i, int j, int k)    {      auto q = safe_divide(j, k);      if (q)        return i + *q;      else        return q;    }    //  æ”¯æŒ  expected  çš„è¾“å‡ºå‡½æ•°    template     ostream& operator& exp)    {      if (exp) {        os   > `unexpected: divide by zero: Are you serious?`>>>  > `unexpected: not integer division`>>>  > `42: Ha, I got you!`>ä¸€ä¸ª  `expected`å·®ä¸å¤šå¯ä»¥çœ‹ä½œæ˜¯ `T` å’Œ `unexpected` çš„`variant`ã€‚åœ¨å­¦è¿‡ä¸Šé¢çš„ `variant`ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¾ˆå®¹æ˜“çœ‹æ˜ç™½ä¸Šé¢çš„ç¨‹åºäº†ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªéœ€è¦æ³¨æ„ä¸€ä¸‹çš„åœ°æ–¹ï¼š1.  å¦‚æœä¸€ä¸ªå‡½æ•°è¦æ­£å¸¸è¿”å›æ•°æ®ï¼Œä»£ç æ— éœ€ä»»ä½•ç‰¹æ®Šå†™æ³•ï¼›å¦‚æœå®ƒè¦è¡¨ç¤ºå‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™å¯ä»¥è¿”å›ä¸€ä¸ª        `unexpected`    å¯¹è±¡ã€‚    2.  è¿™ä¸ªè¿”å›å€¼å¯ä»¥ç”¨æ¥å’Œä¸€ä¸ªæ­£å¸¸å€¼æˆ– unexpected    å¯¹è±¡æ¯”è¾ƒï¼Œå¯ä»¥åœ¨å¸ƒå°”å€¼ä¸Šä¸‹æ–‡é‡Œæ£€æŸ¥æ˜¯å¦æœ‰æ­£å¸¸å€¼ï¼Œä¹Ÿå¯ä»¥ç”¨        `*`    è¿ç®—ç¬¦æ¥å–å¾—å…¶ä¸­çš„æ­£å¸¸å€¼------ä¸        `optional`    ç±»ä¼¼ï¼Œåœ¨æ²¡æœ‰æ­£å¸¸å€¼çš„æƒ…å†µä¸‹ä½¿ç”¨        `*`    æ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚        3.  å¯ä»¥ç”¨         `value` æˆå‘˜å‡½æ•°æ¥å–å¾—å…¶ä¸­çš„æ­£å¸¸å€¼ï¼Œæˆ–ä½¿ç”¨        `error`    æˆå‘˜å‡½æ•°æ¥å–å¾—å…¶ä¸­çš„é”™è¯¯å€¼------ä¸        `variant`    ç±»ä¼¼ï¼Œåœ¨         `expected` ä¸­æ²¡æœ‰å¯¹åº”çš„å€¼æ—¶äº§ç”Ÿå¼‚å¸¸           `bad_expected_access`ã€‚        4.  è¿”å›é”™è¯¯è·ŸæŠ›å‡ºå¼‚å¸¸æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ£€æŸ¥æ˜¯å¦å‘ç”Ÿé”™è¯¯çš„ä»£ç è¿˜æ˜¯è¦æ¯”å¼‚å¸¸å¤„ç†å•°å—¦ã€‚        Herbceptionä¸Šé¢çš„ç”¨æ³•åˆçœ‹è¿˜è¡Œï¼Œä½†çœŸæ­£ç”¨èµ·æ¥ï¼Œä½ ä¼šå‘ç°ä»ç„¶æ²¡æœ‰ä½¿ç”¨å¼‚å¸¸æ–¹ä¾¿ã€‚è¿™åªæ˜¯ä¸ºäº†è§£å†³å¼‚å¸¸åœ¨é”™è¯¯å¤„ç†æ€§èƒ½é—®é¢˜ä¸Šçš„æ— å¥ˆä¹‹ä¸¾ã€‚å¤§éƒ¨åˆ†è¯•å›¾æ›¿æ¢C++ å¼‚å¸¸çš„æ–¹æ³•éƒ½æ˜¯ç‰ºç‰²ç¼–ç¨‹æ–¹ä¾¿æ€§ï¼Œæ¥æ¢å–æ€§èƒ½ã€‚åªæœ‰ Herb Sutteræå‡ºäº†ä¸€ä¸ªåŸºæœ¬å…¼å®¹å½“å‰ C++ å¼‚å¸¸å¤„ç†æ–¹å¼çš„é”™è¯¯å¤„ç†æ–¹å¼\[9\ï¼Œè¢«æˆç§°ä¸ºHerbceptionã€‚ä¸Šé¢ä½¿ç”¨ expected çš„ç¤ºä¾‹ä»£ç ï¼Œå¦‚æœæ”¹ç”¨ Herbceptionçš„è¯ï¼Œå¯ä»¥å¤§è‡´å¦‚ä¸‹æ”¹é€ ï¼ˆç¤ºæ„ï¼Œå°šæ— æ³•ç¼–è¯‘ï¼‰ï¼š    int safe_divide(int i, int j) throws    {      if (j == 0)        throw arithmetic_errc::          divide_by_zero;      if (i == INT_MIN && j == -1)        throw arithmetic_errc::          integer_divide_overflows;      if (i % j != 0)        throw arithmetic_errc::          not_integer_division;      else        return i / j;    }    int caller(int i, int j,               int k) throws    {      return i + safe_divide(j, k);    }    #define CHECK(expr)               \      try {                           \        int result = (expr);          \        cout     #include     #include     using namespace std;    int main()    {      //  ä»£è¡¨ä½ç½®çš„å‘é‡      arma::vec pos{1.0, 0.0};      //  æ—‹è½¬çŸ©é˜µ      auto& pi = arma::datum::pi;      double angle = pi / 2;      arma::mat rot = {        {cos(angle), -sin(angle)},        {sin(angle), cos(angle)}};      cout ` å’Œ           `Mat`    çš„ç¼©å†™åˆ«åã€‚        4.  Armadillo æ”¯æŒä½¿ç”¨ C++11    çš„åˆ—è¡¨åˆå§‹åŒ–è¯­æ³•æ¥åˆå§‹åŒ–å¯¹è±¡ã€‚        5.  Armadillo    æ”¯æŒä½¿ç”¨æµæ¥è¾“å‡ºå¯¹è±¡ã€‚        ä¸Šé¢ä»£ç çš„è¾“å‡ºä¸ºï¼š>  > `Current position:`>>>  > `1.0000`>>>  > `0`>>>  > `Rotating 90 deg`>>>  > `New position:`>>>  > `6.1232e-17`>>>  > `1.0000e+00`>è¾“å‡ºé‡Œé¢çš„ `6.1232e-17` æ˜¯æµ®ç‚¹æ•°è¡¨ç¤ºä¸ç²¾ç¡®çš„åæœï¼ŒæŠŠå®ƒç†è§£æˆ 0å°±å¯¹äº†ã€‚ æˆ‘ä»¬ä¸Šé¢å·²ç»æåˆ°äº† `vec` å®é™…ä¸Šæ˜¯ `Col`ï¼ŒåŒç²¾åº¦æµ®ç‚¹æ•°ç±»å‹çš„åˆ—çŸ¢é‡ã€‚è‡ªç„¶ï¼ŒArmadilloä¹Ÿæœ‰è¡ŒçŸ¢é‡  `rowvec`ï¼ˆå³`Row`ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„æ•°å­—ç±»å‹ï¼Œå¦‚ `int`ã€ `float` å’Œ`complex`ã€‚æ­¤å¤–ï¼Œé™¤äº†å¤§å°ä¸ç¡®å®šçš„çº¿æ€§ä»£æ•°å¯¹è±¡ä¹‹å¤–ï¼ŒArmadilloä¹Ÿæä¾›äº†å›ºå®šå¤§å°çš„å­ç±»å‹ï¼Œå¦‚ `vec::fixed` å’Œ`mat::fixed`ï¼›ä¸ºæ–¹ä¾¿ä½¿ç”¨ï¼Œè¿˜æä¾›äº†ä¸å°‘åˆ«åï¼Œå¦‚ `imat22` ä»£è¡¨`Mat::fixed`ç­‰ã€‚å›ºå®šå¤§å°çš„å¯¹è±¡ä¸éœ€è¦åŠ¨æ€å†…å­˜åˆ†é…ï¼Œä½¿ç”¨ä¸Šæœ‰ä¸€å®šçš„æ€§èƒ½ä¼˜åŠ¿ã€‚Armadillo æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„åº“ï¼Œå®ƒçš„å¤´æ–‡ä»¶æ•°é‡è¶…è¿‡äº† 500ä¸ªã€‚æˆ‘ä»¬ä»Šå¤©ä¸å¯èƒ½ã€ä¹Ÿä¸å¿…è¦æè¿°å®ƒçš„æ‰€æœ‰åŠŸèƒ½ï¼Œåªèƒ½ç¨ç¨éƒ¨åˆ†åˆ—ä¸¾ä¸€ä¸‹ï¼š1.  é™¤äº†ç›®å‰æåˆ°çš„åˆ—çŸ¢é‡ã€è¡ŒçŸ¢é‡å’ŒçŸ©é˜µå¤–ï¼ŒArmadillo    ä¹Ÿæ”¯æŒä¸‰ç»´çš„æ•°æ®ç«‹æ–¹ä½“ï¼Œ        `Cube` æ¨¡æ¿ã€‚        2.  Armadillo æ”¯æŒç¨€ç–çŸ©é˜µï¼Œ        `SpMat`    æ¨¡æ¿ã€‚    3.  é™¤äº†æ•°å­¦ä¸Šçš„åŠ ã€å‡ã€ä¹˜è¿ç®—ï¼ŒArmadillo    æ”¯æŒæŒ‰å…ƒç´ çš„ä¹˜æ³•ã€é™¤æ³•ã€ç›¸ç­‰ã€ä¸ç­‰ã€å°äºæ¯”è¾ƒç­‰ï¼ˆä½¿ç”¨           `%`ã€        `/`ã€        `==`ã€        `!=`ã€        `ï¼‰ï¼š    cout   > `New position:`>>>  > `0.0000`>>>  > `1.0000`>è®°å¾—æˆ‘ä»¬è¯´è¿‡ `vec` æ˜¯ `Col`çš„åˆ«åï¼Œå› æ­¤è¾“å‡ºæ˜¯å¤šè¡Œçš„ã€‚æˆ‘ä»¬è¦è¾“å‡ºæˆå•è¡Œçš„è¯ï¼Œè½¬ç½®ï¼ˆtransposeï¼‰ä¸€ä¸‹å°±å¯ä»¥äº†ï¼š    cout   > `New position:`>>>  > `0.0000 1.0000`>è¡¨è¾¾å¼æ¨¡æ¿å¦‚æœä½ å¥‡æ€ªå‰é¢ `dgemv_` ä¸ºä»€ä¹ˆæœ‰ 11ä¸ªå‚æ•°ï¼Œè¿™é‡Œæœ‰ä¸ªæˆ‘æ²¡æœ‰æçš„ç»†èŠ‚æ˜¯ï¼Œå®ƒæ‰§è¡Œçš„å®é™…ä¸Šæ˜¯ä¸ªå¤åˆæ“ä½œï¼š  .ps} {slate-type="block-katex" ]{.strutstyle="height:0.63888em;vertical-align:-0.19444em;"}[[y]{.mord .mathbfstyle="margin-right:0.01597em;"}]{.mord}[]{.mspacestyle="margin-right:0.2777777777777778em;"}[â†]{.mrel}[]{.mspacestyle="margin-right:0.2777777777777778em;"}]{.base}[[]{.strutstyle="height:0.68611em;vertical-align:0em;"}[Î±]{.mord .mathdefaultstyle="margin-right:0.0037em;"}[[A]{.mord .mathbf}]{.mord}[]{.mspacestyle="margin-right:0.2222222222222222em;"}[â‹…]{.mbin}[]{.mspacestyle="margin-right:0.2222222222222222em;"}]{.base}[[]{.strutstyle="height:0.66666em;vertical-align:-0.08333em;"}[[x]{.mord.mathbf}]{.mord}[]{.mspacestyle="margin-right:0.2222222222222222em;"}[+]{.mbin}[]{.mspacestyle="margin-right:0.2222222222222222em;"}]{.base}[[]{.strutstyle="height:0.8888799999999999em;vertical-align:-0.19444em;"}[Î²]{.mord.mathdefault style="margin-right:0.05278em;"}[[y]{.mord .mathbfstyle="margin-right:0.01597em;"}]{.mord}]{.base}]{.katex-htmlaria-hidden="true"}]{.katex}]{.katex-display} {.ps__rail-x style="left: 0px; bottom: 0px;"} {.ps__thumb-x tabindex="0" style="left: 0px; width: 0px;"} {.ps__rail-y style="top: 0px; right: 0px;"} {.ps__thumb-y tabindex="0" style="top: 0px; height: 0px;"}å¦‚æœä½ åªæ˜¯ç®€å•åœ°åšä¹˜æ³•çš„è¯ï¼Œå°±ç›¸å½“äº [[[]{.strutstyle="height:0.43056em;vertical-align:0em;"}[Î±]{.mord .mathdefaultstyle="margin-right:0.0037em;"}]{.base}]{.katex-htmlaria-hidden="true"}]{.katexslate-string="true"}]}slate-type="inline-katex"  ä¸º1ã€ [[[]{.strutstyle="height:0.8888799999999999em;vertical-align:-0.19444em;"}[Î²]{.mord.mathdefault style="margin-right:0.05278em;"}]{.base}]{.katex-htmlaria-hidden="true"}]{.katexslate-string="true"}]}slate-type="inline-katex"  ä¸º 0çš„ç‰¹æ®Šæƒ…å†µã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœä½ çœŸçš„å†™äº†ç±»ä¼¼äºä¸Šé¢è¿™æ ·çš„å…¬å¼çš„è¯ï¼Œç¼–è¯‘å™¨å’Œçº¿æ€§ä»£æ•°åº“èƒ½ä¸èƒ½è½¬æˆåˆé€‚çš„è°ƒç”¨ã€è€Œæ²¡æœ‰é¢å¤–çš„å¼€é”€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œè‡³å°‘åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯å¯ä»¥çš„ã€‚ç§˜è¯€å°±æ˜¯è¡¨è¾¾å¼æ¨¡æ¿ï¼ˆexpressiontemplateï¼‰\[8\ã€‚é‚£ä»€ä¹ˆæ˜¯è¡¨è¾¾å¼æ¨¡æ¿å‘¢ï¼Ÿæˆ‘ä»¬å…ˆå›è¿‡å»çœ‹æˆ‘ä¸Šé¢çš„ä¾‹å­ã€‚æœ‰æ²¡æœ‰æ³¨æ„åˆ°æˆ‘å†™çš„æ˜¯ï¼š    arma::vec new_pos = rot * pos;è€Œæ²¡æœ‰ä½¿ç”¨ `auto` æ¥å£°æ˜ï¼Ÿå…¶ä¸­éƒ¨åˆ†çš„åŸå› æ˜¯ï¼Œ`rot * pos` çš„ç±»å‹å¹¶ä¸æ˜¯`vec`ï¼Œè€Œæ˜¯ï¼š    const Glue, Col, glue_times>æ¢å¥è¯è¯´ï¼Œç»“æœæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè€Œå¹¶æ²¡æœ‰å®é™…è¿›è¡Œè®¡ç®—ã€‚å¦‚æœæˆ‘ç”¨ `auto`çš„è¯ï¼Œè¡Œä¸ºä¸Šä¼¼ä¹ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œä½†æˆ‘æ¯æ¬¡è¾“å‡ºè¿™ä¸ªç»“æœæ—¶ï¼Œéƒ½ä¼šé‡æ–°è¿›è¡Œä¸€æ¬¡çŸ©é˜µçš„ä¹˜æ³•ï¼è€Œæˆ‘ç”¨ `arma::vec`æ¥æ”¶çš„è¯ï¼Œæ„é€ æ—¶å°±ç›´æ¥è¿›è¡Œäº†è®¡ç®—ï¼Œå­˜å‚¨äº†è¡¨è¾¾å¼çš„ç»“æœã€‚ä¸Šé¢çš„ç®€å•ä¾‹å­ä¸èƒ½å®é™…è§¦å‘å¯¹ `dgemv_`çš„è°ƒç”¨ï¼Œæˆ‘ç”¨ä¸‹é¢çš„ä»£ç å®é™…éªŒè¯å‡ºäº†è¡¨è¾¾å¼æ¨¡æ¿äº§ç”Ÿçš„ä¼˜åŒ–ï¼ˆ`fill::randu`è¡¨ç¤ºå¯¹çŸ¢é‡å’ŒçŸ©é˜µçš„å†…å®¹è¿›è¡Œéšæœºå¡«å……ï¼‰ï¼š    #include     #include     using namespace std;    using namespace arma;    int main()    {      vec x(8, fill::randu);      mat r(8, 8, fill::randu);      vec result = 2.5 * r * x;      cout ,                   eop_scalar_times>,               Col, glue_times>å½“ä½¿ç”¨è¿™ä¸ªè¡¨è¾¾å¼æ„é€  `vec` æ—¶ï¼Œå°±ä¼šå®é™…å‘ç”Ÿå¯¹ `dgemv_`çš„è°ƒç”¨ã€‚æˆ‘ä¹Ÿç¡®å®è·Ÿè¸ªåˆ°äº†ï¼Œåœ¨å°†è¦è°ƒç”¨ `dgemv_`æ—¶ï¼Œæ ‡é‡å€¼ 2.5 ç¡®å®åœ¨å‚æ•° `alpha`æŒ‡å‘çš„ä½ç½®ä¸Šï¼ˆè¿™ä¸ªæ¥å£çš„å‚æ•°éƒ½æ˜¯æŒ‡é’ˆï¼‰ã€‚ä»ä¸Šé¢çš„æè¿°å¯ä»¥çœ‹åˆ°ï¼Œè¡¨è¾¾å¼æ¨¡æ¿æ˜¯æŠŠåŒåˆƒå‰‘ï¼šæ—¢å¯ä»¥æé«˜ä»£ç çš„æ€§èƒ½ï¼Œåˆèƒ½å¢åŠ ä»£ç è¢«è¯¯ç”¨çš„å¯èƒ½æ€§ã€‚åœ¨å¯èƒ½ç”¨åˆ°è¡¨è¾¾å¼æ¨¡æ¿çš„åœ°æ–¹ï¼Œä½ éœ€è¦æ³¨æ„è¿™äº›é—®é¢˜ã€‚å¹³å°ç»†èŠ‚Armadillo çš„æ–‡æ¡£é‡Œè¯´æ˜äº†å¦‚ä½•ä»æºä»£ç è¿›è¡Œå®‰è£…ï¼Œä½†åœ¨ Linux å’Œ macOSä¸‹é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…å¯èƒ½æ˜¯æ›´å¿«çš„æ–¹å¼ã€‚åœ¨ CentOS ä¸‹å¯ä½¿ç”¨`sudo yum install armadillo-devel`ï¼Œåœ¨ macOS ä¸‹å¯ä½¿ç”¨`brew install armadillo`ã€‚ä½¿ç”¨åŒ…ç®¡ç†å™¨ä¸€èˆ¬ä¹Ÿä¼šåŒæ—¶å®‰è£…å¸¸è§çš„ä¾èµ–è½¯ä»¶ï¼Œå¦‚ARPACK å’Œ OpenBLASã€‚åœ¨ Windows ä¸Šï¼ŒArmadillo çš„å®‰è£…åŒ…é‡Œè‡ªå¸¦äº†ä¸€ä¸ªåŸºæœ¬ç‰ˆæœ¬çš„ 64 ä½ BLAS å’ŒLAPACK åº“ã€‚å¦‚æœéœ€è¦æ›´é«˜æ€§èƒ½æˆ– 32ä½ç‰ˆæœ¬çš„è¯ï¼Œå°±éœ€è¦è‡ªå·±å¦å¤–å»å®‰è£…äº†ã€‚é™¤éä½ åªæ˜¯åšä¸€äº›éå¸¸ç®€å•çš„çº¿æ€§ä»£æ•°è®¡ç®—ï¼ˆå°±åƒæˆ‘ä»Šå¤©çš„ä¾‹å­ï¼‰ï¼Œé‚£ç›´æ¥å‘Šè¯‰Armadilloä¸è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ä¹Ÿè¡Œã€‚>  > `cl /EHsc /DARMA_DONT_USE_BLAS /DARMA_DONT_USE_LAPACK â€¦`>Boost.Multiprecisionä¼—æ‰€å‘¨çŸ¥ï¼ŒC å’ŒC++ï¼ˆç”šè‡³æ¨è€Œå¹¿ä¹‹åˆ°å¤§éƒ¨åˆ†çš„å¸¸ç”¨ç¼–ç¨‹è¯­è¨€ï¼‰é‡Œçš„æ•°å€¼ç±»å‹æ˜¯æœ‰ç²¾åº¦é™åˆ¶çš„ã€‚æ¯”å¦‚ï¼Œä¸Šä¸€è®²çš„ä»£ç é‡Œæˆ‘ä»¬å°±ç”¨åˆ°äº†`INT_MIN`ï¼Œæœ€å°çš„æ•´æ•°ã€‚å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä½¿ç”¨ç›®å‰è¿™äº›ç±»å‹æ˜¯å¤Ÿç”¨çš„ï¼ˆæœ€é«˜ä¸€èˆ¬æ˜¯64 ä½æ•´æ•°å’Œ 80ä½æµ®ç‚¹æ•°ï¼‰ã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤šæƒ…å†µï¼Œè¿™äº›æ ‡å‡†çš„ç±»å‹è¿œè¿œä¸èƒ½æ»¡è¶³éœ€è¦ã€‚è¿™æ—¶ä½ å°±éœ€è¦ä¸€ä¸ªé«˜ç²¾åº¦çš„æ•°å€¼ç±»å‹äº†ã€‚æœ‰ä¸€æ¬¡æˆ‘éœ€è¦æ‰¾ä¸€ä¸ªé«˜ç²¾åº¦æ•´æ•°ç±»å‹å’Œè®¡ç®—åº“ï¼Œæœ€åæ‰¾åˆ°çš„å°±æ˜¯Boost.Multiprecision \[9\ã€‚å®ƒåŸºæœ¬æ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼Œä»¥åŠä¸€èˆ¬æ„ä¹‰ä¸Šå¯¹åº“çš„æœŸæœ›ï¼š1.  æ­£ç¡®å®ç°æˆ‘éœ€è¦çš„åŠŸèƒ½        2.  æ¥å£ç¬¦åˆç›´è§‰ã€æ˜“ç”¨        3.  æœ‰è‰¯å¥½çš„æ€§èƒ½        æ­£ç¡®å®ç°åŠŸèƒ½è¿™ç‚¹æˆ‘å°±ä¸å¤šè®²äº†ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬å‡ºå‘ç‚¹ï¼Œæ²¡æœ‰å¤ªå¤šå¯è®¨è®ºçš„åœ°æ–¹ã€‚åœ¨æˆ‘ä¸Šæ¬¡çš„éœ€æ±‚é‡Œï¼Œå¯¹æ€§èƒ½å…¶å®ä¹Ÿæ²¡æœ‰å¾ˆé«˜çš„è¦æ±‚ã€‚è®©æˆ‘å¯¹Boost.Multiprecisionæ»¡æ„çš„ä¸»è¦åŸå› ï¼Œå°±æ˜¯å®ƒçš„æ¥å£äº†ã€‚æ¥å£æ˜“ç”¨æ€§æˆ‘åœ¨  [\[ç¬¬ 12è®²\]  æåˆ°äº† CLNã€‚å®ƒå¯¹æˆ‘æ¥è®²å°±æ˜¯ä¸ªåé¢æ•™æã€‚å®ƒçš„æ•´æ•°ç±»å‹ä¸ä»…ä¸æä¾› `%`è¿ç®—ç¬¦ï¼Œå±…ç„¶è¿˜ä¸æä¾› `/`è¿ç®—ç¬¦ï¼å®ƒå¼ºè¿«ç”¨æˆ·åœ¨ä¸‹é¢ä¸¤ä¸ªæ–¹æ¡ˆä¸­åšå‡ºé€‰æ‹©ï¼š1.  ä½¿ç”¨         `truncate2`    å‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªå•†æ•°å’Œä½™æ•°        2.  ä½¿ç”¨         `exquo`    å‡½æ•°ï¼Œå½“ä¸”ä»…å½“å¯ä»¥æ•´é™¤çš„æ—¶å€™        ä¸ç®¡ä½œè€…çš„è®¾è®¡åŸåˆ™æ˜¯ä»€ä¹ˆï¼Œè¿™ç®€ç›´å°±æ˜¯æ˜“ç”¨æ€§æ–¹é¢çš„ç¾éš¾äº†------ä¸ä»…è¿™äº›å‡½æ•°è¦æŸ¥æ–‡æ¡£æ‰èƒ½çŸ¥æ™“ï¼Œè€Œä¸”æœ‰çš„åœ°æ–¹æˆ‘çœŸçš„åªéœ€è¦ç®€å•çš„é™¤æ³•å‘€......å“¦ï¼Œå¯¹äº†ï¼Œå®ƒåœ¨ Windows ç¼–è¯‘è¿˜å¾ˆä¸æ–¹ä¾¿ï¼Œè€Œæˆ‘é‚£æ—¶ç”¨çš„æ­£æ˜¯Windowsã€‚ Boost.Multiprecisionçš„æƒ…å†µåˆ™æ°æ°ç›¸åï¼Œè®©æˆ‘å½“å³å¤§ä¸ºæ»¡æ„ï¼š1.  ä½¿ç”¨åŸºæœ¬çš„         `cpp_int` å¯¹è±¡ä¸éœ€è¦é¢„å…ˆç¼–è¯‘åº“ï¼Œåªéœ€è¦ Boost    çš„å¤´æ–‡ä»¶å’Œä¸€ä¸ªå¥½çš„ç¼–è¯‘å™¨ã€‚        2.  å¸¸ç”¨è¿ç®—ç¬¦         `+`ã€        `-`ã€        `*`ã€        `/`ã€        `%`    ä¸€ä¸ªä¸ç¼ºï¼Œå…¨éƒ¨éƒ½æœ‰ã€‚        3.  å¯ä»¥è‡ªç„¶åœ°é€šè¿‡æ•´æ•°å’Œå­—ç¬¦ä¸²æ¥è¿›è¡Œæ„é€ ã€‚        4.  æä¾›äº†ç”¨æˆ·è‡ªå®šä¹‰å­—é¢é‡æ¥é«˜æ•ˆåœ°è¿›è¡Œåˆå§‹åŒ–ã€‚        5.  åœ¨ä½¿ç”¨ IO æµæ—¶ï¼Œè¾“å…¥è¾“å‡ºæ—¢å¯ä»¥ä½¿ç”¨åè¿›åˆ¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡        `hex`    æ¥åˆ‡æ¢åˆ°åå…­è¿›åˆ¶ã€‚        ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å®ƒçš„åŸºæœ¬åŠŸèƒ½ï¼š    #include     #include     #include     using namespace std;    int main()    {      using namespace boost::        multiprecision::literals;      using boost::multiprecision::        cpp_int;      cpp_int a =        0x123456789abcdef0_cppi;      cpp_int b = 16;      cpp_int c{"0400"};      cpp_int result = a * b / c;      cout   > `123456789abcdef`>>>  > `81985529216486895`>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`cpp_int` å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å­—é¢é‡ï¼ˆåç¼€`_cppi`ï¼›åªèƒ½åå…­è¿›åˆ¶ï¼‰æ¥åˆå§‹åŒ–ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªæ™®é€šæ•´æ•°æ¥åˆå§‹åŒ–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å­—ç¬¦ä¸²æ¥åˆå§‹åŒ–ï¼ˆå¹¶å¯ä»¥ä½¿ç”¨ `0x` å’Œ `0`å‰ç¼€æ¥é€‰æ‹©åå…­è¿›åˆ¶å’Œå…«è¿›åˆ¶ï¼‰ã€‚æ‹¿å®ƒå¯ä»¥æ­£å¸¸åœ°è¿›è¡ŒåŠ å‡ä¹˜é™¤æ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡IO æµæ¥è¾“å…¥è¾“å‡ºã€‚æ€§èƒ½Boost.Multiprecision ä½¿ç”¨äº†è¡¨è¾¾å¼æ¨¡æ¿å’Œ C++11çš„ç§»åŠ¨æ¥é¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚åè€…å½“ç„¶æ˜¯ä»¶å¥½äº‹ï¼Œè€Œå‰è€…æ›¾ç»å‘äº†æˆ‘ä¸€ä¸‹------æˆ‘ç¬¬ä¸€æ¬¡ä½¿ç”¨Boost.Multiprecision æ—¶éå¸¸å›°æƒ‘ä¸ºä»€ä¹ˆæˆ‘ä½¿ç”¨ `half(n - 1)`è°ƒç”¨ä¸‹é¢çš„ç®€å•å‡½æ•°å±…ç„¶ä¼šç¼–è¯‘ä¸è¿‡ï¼š    template     inline N half(N n)    {      return n / 2;    }æˆ‘çš„æ„å›¾å½“ç„¶æ˜¯ `N` åº”å½“è¢«æ¨å¯¼ä¸º `cpp_int`ï¼Œ`half` çš„ç»“æœä¹Ÿæ˜¯`cpp_int`ã€‚å¯å®é™…ä¸Šï¼Œ`n - 1` çš„ç»“æœè·Ÿä¸Šé¢çš„ Armadilloå±•ç¤ºçš„æƒ…å†µç±»ä¼¼ï¼Œæ˜¯å¦å¤–ä¸€ä¸ªå•ç‹¬çš„ç±»å‹ã€‚æˆ‘éœ€è¦æŠŠ `half(n - 1)`æ”¹å†™æˆ  `half(N(n - 1))`æ‰èƒ½å¾—åˆ°æœŸæœ›çš„ç»“æœã€‚æˆ‘åšçš„è®¡ç®—æŒºç®€å•ï¼Œå¹¶ä¸è§‰å¾—è¡¨è¾¾å¼æ¨¡æ¿å¯¹æˆ‘çš„è®¡ç®—æœ‰å•¥å¸®åŠ©ï¼Œæ‰€ä»¥æˆ‘æœ€åæ˜¯ç¦ç”¨äº†è¡¨è¾¾å¼æ¨¡æ¿ï¼š    typedef boost::multiprecision::      number,        boost::multiprecision::et_off>        int_type;ç±»ä¼¼äº Armadillo å¯ä»¥æ¢ä¸åŒçš„ BLAS å’Œ LAPACKå®ç°ï¼ŒBoost.Multiprecision ä¹Ÿå¯ä»¥æ”¹æ¢ä¸åŒçš„åç«¯ã€‚æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æ‰“ç®—ä½¿ç”¨GMP \[10\ çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦åŒ…å«åˆ©ç”¨ GMP çš„å¤´æ–‡ä»¶ï¼Œå¹¶æŠŠä¸Šé¢çš„ `int_type`çš„å®šä¹‰ä¿®æ­£ä¸€ä¸‹ï¼š    #include     typedef boost::multiprecision::      number        int_type;æ³¨æ„ï¼Œæˆ‘å¹¶ä¸æ˜¯æ¨èä½ æ¢ç”¨GMPã€‚å¦‚æœä½ çœŸçš„å¯¹æ€§èƒ½éå¸¸æ¸´æ±‚çš„è¯ï¼Œåº”å½“è¿›è¡Œæµ‹è¯•æ¥é€‰æ‹©åˆé€‚çš„åç«¯ã€‚å¦åˆ™ç¼ºçœçš„åç«¯æ˜“ç”¨æ€§æœ€å¥½------æ¯”å¦‚ï¼Œä½¿ç”¨GMPåç«¯å°±ä¸èƒ½ä½¿ç”¨è‡ªå®šä¹‰å­—é¢é‡äº†ã€‚æˆ‘å½“æ—¶å¯»æ‰¾é«˜ç²¾åº¦ç®—æœ¯åº“æ˜¯ä¸ºäº†åš RSAåŠ è§£å¯†ã€‚è®¡ç®—æœ¬èº«ä¸å¤æ‚ï¼Œå±äºç¼–ç¨‹å‡ å°æ—¶ã€è¿è¡Œå‡ æ¯«ç§’çš„æƒ…å†µã€‚å¦‚æœä½ æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘é‚£æ—¶çš„æŒ‘é€‰è¿‡ç¨‹å’Œæœ€ç»ˆä»£ç \[11\ã€‚Boost é‡Œå¥½ä¸œè¥¿å¾ˆå¤šï¼Œè¿œè¿œä¸æ­¢è¿™ä¸€æ ·ã€‚ä¸‹ä¸€è®²æˆ‘ä»¬å°±æ¥ä¸“é—¨èŠèŠBoostã€‚ å†…å®¹å°ç»“æœ¬è®²æˆ‘ä»¬è®¨è®ºäº†ä¸¤ä¸ªè¿›è¡Œè®¡ç®—çš„æ¨¡æ¿åº“ï¼ŒArmadillo å’ŒBoost.Multiprecisionï¼Œå¹¶è®¨è®ºäº†å®ƒä»¬ç”¨åˆ°çš„è¡¨è¾¾å¼æ¨¡æ¿æŠ€å·§å’Œç›¸å…³çš„è®¡ç®—åº“ï¼Œå¦‚BLASã€LAPACK å’Œ GMPã€‚å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ C++ä½ å¯ä»¥ç«™åˆ°å·¨äººè‚©ä¸Šï¼Œè½»æ¾å†™å‡ºé«˜æ€§èƒ½çš„è®¡ç®—ä»£ç ã€‚è¯¾åæ€è€ƒæ€§èƒ½å’Œæ˜“ç”¨æ€§å¾€å¾€æ˜¯æœ‰çŸ›ç›¾çš„ã€‚ä½ å¯¹æ€§èƒ½å’Œæ˜“ç”¨æ€§æœ‰ä»€ä¹ˆæ ·çš„åå¥½å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€ä¸æˆ‘åˆ†äº«ã€‚å‚è€ƒèµ„æ–™\[1\] Wikipedia, "Basic Linear Algebra Subprograms".https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprogramsslate-object="mark"} \[2\] Wikipedia, "LAPACK". slate-object="mark"}https://en.wikipedia.org/wiki/LAPACKslate-object="mark"} \[3\] Wikipedia, "ARPACK". slate-object="mark"}https://en.wikipedia.org/wiki/ARPACKslate-object="mark"} \[4\] Zhang Xianyi et al., OpenBLAS.https://github.com/xianyi/OpenBLASslate-object="mark"} \[5\] Intel, Math Kernel Library.https://software.intel.com/mklslate-object="mark"} \[6\] Ilya Yaroshenko, mir-glas.https://github.com/libmir/mir-glasslate-object="mark"} \[7\] Conrad Sanderson and Ryan Curtin, "Armadillo: C++ library forlinear algebra & scientific computing".http://arma.sourceforge.net/slate-object="mark"} \[8\] Wikipedia, "Expression templates".https://en.wikipedia.org/wiki/Expression_templatesslate-object="mark"} \[9\] John Maddock, Boost.Multiprecision.https://www.boost.org/doc/libs/release/libs/multiprecision/doc/html/index.htmlslate-object="mark"} \[10\] The GNU MP bignum library.https://gmplib.org/slate-object="mark"} \[11\] å´å’ç‚œ, "Choosing a multi-precision library for C++---acritique". https://yongweiwu.wordpress.com/2016/06/04/choosing-a-multi-precision-library-for-c-a-critique/slate-object="mark"} 