179
怎么样，是不是很简单？我们继续看下一题。
第2题：请查询出分数在50分以上的男生的人数比分数在50分
以上的女生的人数多的班级。
这次，两个条件都可以用特征函数来描述。
SELBCT class
FROM TestResult8
GROUP BY class
HAVING SUM(CASE MHEN SCoEe >= 50 AND Bex = +男
THEN 1
ELSE 0 END
> SUM(CASE MHEN score >= 50 AND Bex = 1女1
THEN 1
ELSE 0 END)
■执行结果
class
B
好了，接下来是最后一题。这个间题有些地方有点棘手，大家知道是
哪里吗？
第3题：请查询出女生平均分比男生平均分高的班级。
按照和前两题一样的思路，像下面这样写的人应该不少吧。
-比较男生和女生平均分的SQL语句[1）：对空集使用AVG后返团0
SELECT class
FROM TestResulta
GROUP BY class
HAVING AVG(CASE HHEN Sex =*男
ELSE 0 END
82038 NEH
 0
col列全是正数或全是负数
MIN(col) * MAX(col)  0
col 列的最大值是正数。最小值是负数
MIN(ABS(coll) = 0
col列最少有一个是0
MIN|col -常量}= MAX(col -常量1col 列的最大值和最小值与指定常量等距
上面的1、4和5我们在本节中已经练习过了，2和3在14节中也使
用过了（4是将3一般化而得到的）。不仅限于这些简单的条件，如果使用
CASE表达式来生成特征函数，那么无论多么复杂且通用的条件，我们都
可以描述，在这里就不再详细解释了。
下面是本节要点。
1.在SQL中指定搜索条件时，最重要的是搞清楚搜索的实体是集合
还是集合的元素。
2.如果一个实体对应着一行数据→那么就是元素，所以使用WHERE
子句。
3.如果一个实体对应着多行数据→那么就是集合，所以使用HAVING
子句。
4.HAVING子句可以通过聚合函数（特别是极值函数）针对集合指定
各种条件。
5.如果通过CASE表达式生成特征函数，那么无论多么复杂的条件都
可以描述。
6.HAVING子句很强大。
---
## Page 196
10HAVING子句又国来了—18.3
下面是参考资料。
1.JceCelko，《SQL解惑（第2版）》（人民邮电出版杜，2008年）
关于数列缺失编号的检查，请参考“谜题57间隔—版本1".JoeCelko
在求缺失的最小编号时采用了NOTIN，但是为了解决NULL的间题并且
改善性能，本书中的例子改用了NOT EXISTS。还有，关于使用CASE表
达式生成特征函数的相关技术，可以参考“谜题11工作顺序”。
2. Joe Celko, Thinking in Aggregates ( DBAzine.com, 2005 年)
(http:/www.dbazine.com/ofinterest/oi-articles/celko18)
这篇文章是主张通过HAVING子句来理解SQL的面向集合思想的名作，
笔者也从中受到了不少启发。前面提到的一些用于调查集合性质的常用
条件都摘自这篇文章，笔者只是做了一些修改。本节开头引用的Joe
Celko的话也摘自这篇文章。
(http:/hooktail.sub.jp/algebra/Klassierung/)
物理学的卷尾猫是一个致力于以易懂的语言介绍物理学相关知识的项
目。这篇文章介绍了集合中划分和划分操作的一些概念，极力避免了使
用复杂的数学公式，非常容易理解。
练习题
练习题1-10-1：单重集合与多重集合的一般化
在“单重集合与多重集合”部分，我们只针对material一个字段检查
了集合中是否存在重复值。这次我们考虑一下推而广之，针对多个字段检
查是否存在重复。
我们在原来的表中加上“原产国”这样一个字段，作为测试数据。
请从表中查出材料和原产国两个字段都重复的生产地。答案只有（锌，
泰国）重复了的东京。对于名古屋，如果只看材料，那么“钢”有重复，
但是因为产地分别是智利和阿根廷，所以应该被排除在外。
提示：不用想得很深。
---
## Page 197
184-
第1章神奇的SQL
Materials2
cenler[生产地]
recaive_daba ( 入库目期]
mal
a材料）
orglan（原产国）
东京
20070401
锅
智利
东京
20070412
锌
泰国
东京
20070517
铝
巴西
东京
20070520
锌
泰国
大阪
20070420
铜
澳大利亚
大阪
20070422
镍
南非
大阪
20070429
铅
印度
名古屋
20070315
钛
玻利维亚
名古屋
20070401
钢
智利
名古屋
20070424
钢
阿根廷
名古屋
20070502
镁
智利
名古屋
20070510
钛
泰国
福冈
20070510
锌
美国
福冈
20070528
俄罗斯
●练习题1-10-2：多个条件的特征函数
接下来再练习一下CASE表达式的特征函数和HAVING子句组合使用
的技巧。做个稍微难点儿的题吧。
我们使用下面这样一张存储了测试成绩的表作为测试数据。这张表我
们在1-8节中也用过。
TestScores
Suden id ( 学号 ID]
Subjecl（科目）
score（分数
100
数学
100
100
语文
80
100
理科
80
200
数学
B0
200
语文
95
300
数学
40
300
语文
90
300
社会
55
400
数学
B0
---
## Page 198
10HAVING子句又国来了 -
185
这张表中每个学生存储了多门学科的成绩。在1-8节中，我们使用谓
词逻辑的方法思考了查询满足下面条件的学生的SQL语句。
1.数学的分数在80分以上。
2.语文的分数在50分以上。
答案是学号为100和200的学生。这次我们排除掉没有语文成绩的学
号为400的学生。
---
## Page 199
186
第1章神奇的SOL
让SQL飞起来