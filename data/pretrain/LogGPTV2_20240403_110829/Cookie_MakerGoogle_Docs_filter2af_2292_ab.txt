在测试不同的IP及UA字段时，我们得到了十几个不同的样本，这些样本针对的都是Windows平台。在这部分内容中，我们将讨论攻击者为了规避反病毒服务所使用的各种技巧。
###  可修改的内部结构
尽管所有样本都具有相同的行为，但这些样本具备各种不同的（有时候是相互矛盾的）内部结构。比如，某个样本的FileDescription字段的值为MODJO
Internet Security。有趣的是，这个样本还带有manifest数据，其中description字段的值为Installs Adobe
Flash Player。
图5. Description字段内容
为了进一步增强复杂度，这个样本还使用了与VK.com（这是俄语国家流行的一个社交网络）非常类似的一个图标。
图6. 恶意样本图标（左图）以及VK.com社交网络logo（右图）
至于MODJO Internet Security，我们发现最后一个字母会经常改变。我们发现有些样本会使用如下名称：
    MODJO Internet Security
    MODJA Internet Security
    MODJB Internet Security
不同样本之间还有另一个区别：.RSRC数据。样本会在这个区域中插入各种.png图像来实现样本的多样性。尽管用户看不到这些图像，但不同样本中这些图像的数量和大小存在显著差异。
图7. 两个样本.RSRC区中封装的PNG文件
那么为何这些样本会在那么多地方存在不同？我们无法给出确切的回答，但猜测攻击者会尽可能混乱地更改样本的所有区域，以降低被检测的可能性。
###  行为分析
虽然这些样本具有不同的内部结构，但行为完全相同。 恶意样本与C2服务器之间的通信如下图所示。
我们可以看到该样本正在向C2服务器发送POST请求。C2服务器同样托管在your-server.de主机上，类似我们前面研究过的某个重定向节点，然而C2服务器和重定向节点使用的是不同的IP。
key字段如下图所示：
图8. 恶意样本网络请求
我们分析的每个Windows样本都对应同一个key（如上图所示），但这可能是因为我们使用的是同一个Google文档。
收到服务器响应数据后，样本会尝试下载并执行GetGo Download
Manager，这是一个合法的第三方应用程序。成功执行后（或者经过多次失败尝试后），样本会执行自删除操作。
我们认为攻击者之所以采用这种方式，是想滥用合法应用的推广机制。当牵扯到推广机制时，通常会有一个推荐字段来区分不同实体。然而攻击活动中并不满足这种场景：请求中并没有使用推广字段，并且用户所使用的Getgosoft页面URL地址中也没有包含特征字段。
查询中包含一个明显的特征，即User-Agent字段：
     User-Agent: Medunja Solodunnja 6.0.0
请注意其中使用的字符串，回头我们会提到这一点。
图9. 恶意样本生成的请求
###  实时编译及签名
此次攻击活动中还有一个显著的特点：样本会“动态”编译及签名。我们对比了样本PE头部中的TimeStamp字段与实际的下载时间，发现两者的差异不超过5分钟。此外，每个样本在下载的时候都使用相同的、有效的数字签名进行签名。
我们分析了用来生成签名的证书，这些证书都由COMODO RSA Code Signing CA颁发。我们在分析过程中见到过的证书如下所示：
    00 ce fe 4e ae e4 c0 cf 51 e9 5b 30 cf 02 80 b7 94            RICK, SKY LIMITED
    00 b1 ab f8 ab e0 ab 1f c2 36 ed be 9f fc 4f 66 cb            UR-IN, LIMITED
    00 9b ea 5b a5 5f 1b 91 61 c1 be 05 93 00 3b 3f a1            MIR CORPORATION – LIMITED
我们并不知道攻击者如何获得这些证书，但证书中的组织名称看上去非常奇怪：字符串中间包含逗号和短横线。很有可能这些证书并不是被盗证书，而是由攻击者直接申请的证书。如果是这种情况，那么大家很可能会有所疑惑，现在证书颁发机构究竟是遵循何种流程来确保证书申请者为合法的公司？
## 六、签名时间问题
当我们分析此次攻击活动所使用的样本时，我们还发现使用微软的Sigcheck工具时会得到一些有趣的结果。由于某些原因，该工具（2.7最新版）在分析本文恶意样本时会认为样本的签名时间为当前系统时间，而不是正确的签名时间。
使用VirusTotal服务同样会得到奇怪的结果。比如，如下图所示，我们可以看到对样本的最后一次分析时间为2018-11-14 14:05:19
GMT，而根据VT的分析结果，该样本的签名时间为2018-11-14 15:05:00（比真正的GMT时间还要快1个小时）。
图10.
Sigcheck（左图）及VirusTotal（右图）对样本（SHA256：b84d9c08fc35c3a160b4ee1f4061035a4bb9781e5f64e623ec988b8447b2c667）的分析结果
FortiGuard实验室已经将这个问题反馈给VirusTotal以及Sysinternals团队。Mark
Russinovich已经准备发布新版的Sigcheck工具，而VirusTotal表明他们在处理样本时使用的正是Sigcheck工具，目前正等待最新版工具。
## 七、幕后黑手
现在总结一下我们在分析过程中发现的一些信息：
1、恶意文档常用的两种语言为英语及俄语。如果仔细观察图3，大家可能会注意到第二行用到了俄语文字；
2、攻击者滥用了thimbleprojects[.]org服务，所使用的项目名为dedzsumkoi。Dedzsumkoi是俄语单词Дед с
сумкой的音译词，翻译过来就是“带着袋子的爷爷”；
3、攻击者使用了VK.com的logon，而VK.com是俄语国家非常流行的一个社交网络服务；
4、攻击者所使用的User-Agent为Medunja Solodunnja 6.0.0。Medunja Solodunnja是俄语单词Медуня-солодуня的音译词，这是位于乌克兰利沃夫附近的一家饼干制造商。
图11. Медуня-солодуня位于利沃夫乌克兰附近
总而言之，我们认为此次攻击活动中的攻击者精通俄语，他们可能非常熟悉位于乌克兰利沃夫附近的当地饼干制造商，这是关于攻击者地理区域的一个重要线索。
当我们分析攻击者所使用域名的注册信息时，我们发现基本上所有域名注册数据都在类似WhoisGuard等服务的保护之下。4requests[.]org域名也不例外，目前该域名所有数据都处于隐藏状态。然而，当我们检查该域名的whois历史记录时，我们发现该域名最早注册地址位于乌克兰利沃夫区域。
图12. 4requests[.]org域名的whois历史记录
我们无法验证这个注册信息是否正确，但这个信息与我们得出的其他线索一致。我们检查了使用egonow999[@]gmail.com邮箱注册的其他域名，总共找到了321个域名。这些域名大多数在最近一段时间注册，并且域名看上去不像是正常域名。
图13. 使用egonow999[@]gmail.com邮箱注册的域名
## 八、总结
FortiGuard实验室发现了包含数百个恶意文档的大规模Google Docs攻击活动，每个恶意文档都会根据受害者的User-Agent及IP地址来生成不同的重定向链。
我们分析了此次恶意网络中使用的许多重定向链，也分析了下载的几个样本。我们认为该网络当前的目标是滥用其他应用的合作伙伴计划，但他们的攻击目标随时都可能改变。
此外，我们还分析追踪溯源方面信息，提出了关于这些攻击幕后黑手的一些想法，至少也给出了这些攻击活动源自何处的一些线索。Android和MacOS示例将在即将发表的文章中讨论。
FortiGuard Labs将继续监控新注册的域名是否存在恶意活动。
我们会在后续分析文章中讨论Android和MacOS样本。FortiGuard实验室将继续监控新注册的、用于恶意活动的域名。
## 九、解决方案
FortiGuard Web Filter能够阻止本文分析过的URL和域名，并将其标记为恶意攻击。
AV解决方案可以成功检测本文分析的所有样本，检测标识为W32/Kryptik.GLKH!tr。
可以使用IPS规则ICLoader.Botnet来阻止恶意User-Agent请求。
## 十、IOC
攻击者使用的证书（全部由COMODO RSA Code Signing CA发布）：
    00 ce fe 4e ae e4 c0 cf 51 e9 5b 30 cf 02 80 b7 94 RICK, SKY LIMITED
    ‎00 b1 ab f8 ab e0 ab 1f c2 36 ed be 9f fc 4f 66 cb UR-IN, LIMITED
    ‎00 9b ea 5b a5 5f 1b 91 61 c1 be 05 93 00 3b 3f a1 MIR CORPORATION – LIMITED
恶意样本
    05cfdf3f05a41a711991f819fcbc56b05172be9ea3d2c5750d5fd42e73eb1403 - W32/Kryptik.GLKH!tr
    0a0b7edd15995bb5cb59f3a10d5b24f1ca4e5091aff31200cee637fcddaf2316 - W32/Kryptik.GLKH!tr
    19b8e784cd8306d55d8281675215f4343daa6cc50b72d7a449ee7fab7de5252c - W32/Kryptik.GLKH!tr