### 优化后的文本

在测试不同的IP和UA字段时，我们收集了十几个针对Windows平台的样本。本部分内容将探讨攻击者为规避反病毒服务所采用的各种技巧。

#### 可修改的内部结构
尽管所有样本表现出相同的行为模式，但它们具有各种不同的（有时甚至是相互矛盾的）内部结构。例如，其中一个样本的`FileDescription`字段值为“MODJO Internet Security”。有趣的是，该样本还带有manifest数据，其中`description`字段值为“Installs Adobe Flash Player”。

**图5. Description字段内容**

为了进一步增加复杂性，这个样本使用了一个与VK.com（俄语国家流行的社交网络）非常相似的图标。

**图6. 恶意样本图标（左图）及VK.com社交网络logo（右图）**

关于“MODJO Internet Security”，我们发现最后一个字母经常变化。一些样本使用以下名称：
- MODJO Internet Security
- MODJA Internet Security
- MODJB Internet Security

不同样本之间的另一个显著差异在于`.RSRC`数据区域。样本在此区域中插入各种.png图像以实现多样性。尽管用户无法看到这些图像，但在不同样本中，这些图像的数量和大小存在显著差异。

**图7. 两个样本.RSRC区中封装的PNG文件**

为什么这些样本在多个地方存在差异？虽然我们不能给出确切答案，但我们推测攻击者试图通过尽可能混乱地更改样本的所有区域来降低被检测的风险。

#### 行为分析
尽管这些样本具有不同的内部结构，但它们的行为完全一致。恶意样本与C2服务器之间的通信如下所示：

**图8. 恶意样本网络请求**

每个Windows样本都向C2服务器发送POST请求，C2服务器托管在`your-server.de`主机上，类似于我们之前研究过的某个重定向节点。然而，C2服务器和重定向节点使用的是不同的IP地址。

我们分析的每个Windows样本都对应同一个key（如图所示），但这可能是因为我们使用的是同一个Google文档。

收到服务器响应后，样本会尝试下载并执行GetGo Download Manager，这是一个合法的第三方应用程序。成功执行后（或经过多次失败尝试后），样本会进行自删除操作。

我们认为攻击者采取这种方式是为了滥用合法应用的推广机制。然而，在这种攻击活动中，并没有使用推广字段，用户访问的Getgosoft页面URL中也没有特征字段。

请求中的User-Agent字段包含一个明显的特征：
```
User-Agent: Medunja Solodunnja 6.0.0
```

请注意其中使用的字符串，我们将在后续讨论中提及这一点。

**图9. 恶意样本生成的请求**

#### 实时编译及签名
此次攻击活动的一个显著特点是样本会“动态”编译及签名。我们对比了样本PE头部中的`TimeStamp`字段与实际下载时间，发现两者的差异不超过5分钟。此外，每个样本在下载时都使用相同的、有效的数字签名进行签名。

我们分析了用于生成签名的证书，这些证书均由COMODO RSA Code Signing CA颁发。我们在分析过程中见到的证书如下：
- `00 ce fe 4e ae e4 c0 cf 51 e9 5b 30 cf 02 80 b7 94` - RICK, SKY LIMITED
- `00 b1 ab f8 ab e0 ab 1f c2 36 ed be 9f fc 4f 66 cb` - UR-IN, LIMITED
- `00 9b ea 5b a5 5f 1b 91 61 c1 be 05 93 00 3b 3f a1` - MIR CORPORATION – LIMITED

我们不清楚攻击者如何获得这些证书，但证书中的组织名称显得非常奇怪：字符串中间包含逗号和短横线。这表明这些证书可能是由攻击者直接申请的，而不是被盗用的。如果是这种情况，那么我们对证书颁发机构的确保申请者为合法公司的流程提出了质疑。

#### 签名时间问题
在分析此次攻击活动所使用的样本时，我们还发现了一些有趣的结果。使用微软的Sigcheck工具（版本2.7）时，该工具会认为样本的签名时间为当前系统时间，而不是正确的签名时间。

VirusTotal服务也给出了奇怪的结果。例如，下图显示了对样本的最后一次分析时间为2018-11-14 14:05:19 GMT，而根据VT的分析结果，该样本的签名时间为2018-11-14 15:05:00（比实际GMT时间快1个小时）。

**图10. Sigcheck（左图）及VirusTotal（右图）对样本（SHA256：b84d9c08fc35c3a160b4ee1f4061035a4bb9781e5f64e623ec988b8447b2c667）的分析结果**

FortiGuard实验室已将此问题反馈给VirusTotal和Sysinternals团队。Mark Russinovich表示将发布新版Sigcheck工具，而VirusTotal则表示他们在处理样本时使用的就是Sigcheck工具，正在等待最新版工具。

#### 幕后黑手
总结我们在分析过程中发现的一些信息：
1. 恶意文档常用的两种语言是英语和俄语。如果仔细观察图3，可以看到第二行使用了俄语文本。
2. 攻击者滥用了thimbleprojects[.]org服务，项目名为dedzsumkoi。Dedzsumkoi是俄语单词Дед с сумкой的音译词，翻译过来就是“带着袋子的爷爷”。
3. 攻击者使用了VK.com的图标，而VK.com是俄语国家非常流行的一个社交网络服务。
4. 攻击者使用的User-Agent为“Medunja Solodunnja 6.0.0”。Medunja Solodunnja是俄语单词Медуня-солодуня的音译词，这是位于乌克兰利沃夫附近的一家饼干制造商。

**图11. Медуня-солодуня位于利沃夫乌克兰附近**

综上所述，我们认为此次攻击活动中的攻击者精通俄语，并且可能非常熟悉位于乌克兰利沃夫附近的当地饼干制造商，这是关于攻击者地理区域的重要线索。

当我们分析攻击者所使用域名的注册信息时，发现几乎所有域名的注册数据都在类似WhoisGuard等服务的保护之下。4requests[.]org域名也不例外，目前该域名的所有数据都处于隐藏状态。然而，当我们检查该域名的whois历史记录时，发现该域名最早注册地址位于乌克兰利沃夫区域。

**图12. 4requests[.]org域名的whois历史记录**

我们无法验证这个注册信息是否正确，但这个信息与我们得出的其他线索一致。我们检查了使用egonow999[@]gmail.com邮箱注册的其他域名，共找到了321个域名。这些域名大多数在最近一段时间注册，并且域名看上去不像是正常域名。

**图13. 使用egonow999[@]gmail.com邮箱注册的域名**

#### 总结
FortiGuard实验室发现了大规模的Google Docs攻击活动，涉及数百个恶意文档，每个恶意文档都会根据受害者的User-Agent及IP地址生成不同的重定向链。

我们分析了此次恶意网络中使用的许多重定向链，以及下载的几个样本。我们认为该网络当前的目标是滥用其他应用的合作伙伴计划，但其攻击目标随时可能改变。

此外，我们还分析了追踪溯源方面的信息，提出了关于这些攻击幕后黑手的一些想法，至少也给出了这些攻击活动源自何处的一些线索。Android和MacOS示例将在即将发表的文章中讨论。

FortiGuard实验室将继续监控新注册的域名是否存在恶意活动。

我们会在后续分析文章中讨论Android和MacOS样本。FortiGuard实验室将继续监控新注册的、用于恶意活动的域名。

#### 解决方案
- FortiGuard Web Filter能够阻止本文分析过的URL和域名，并将其标记为恶意攻击。
- AV解决方案可以成功检测本文分析的所有样本，检测标识为W32/Kryptik.GLKH!tr。
- 可以使用IPS规则ICLoader.Botnet来阻止恶意User-Agent请求。

#### IOC
**攻击者使用的证书（全部由COMODO RSA Code Signing CA发布）：**
- `00 ce fe 4e ae e4 c0 cf 51 e9 5b 30 cf 02 80 b7 94` - RICK, SKY LIMITED
- `00 b1 ab f8 ab e0 ab 1f c2 36 ed be 9f fc 4f 66 cb` - UR-IN, LIMITED
- `00 9b ea 5b a5 5f 1b 91 61 c1 be 05 93 00 3b 3f a1` - MIR CORPORATION – LIMITED

**恶意样本：**
- `05cfdf3f05a41a711991f819fcbc56b05172be9ea3d2c5750d5fd42e73eb1403` - W32/Kryptik.GLKH!tr
- `0a0b7edd15995bb5cb59f3a10d5b24f1ca4e5091aff31200cee637fcddaf2316` - W32/Kryptik.GLKH!tr
- `19b8e784cd8306d55d8281675215f4343daa6cc50b72d7a449ee7fab7de5252c` - W32/Kryptik.GLKH!tr