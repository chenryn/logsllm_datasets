411: A Framework for 
Managing Security Alerts
Kai Zhong
@sixhundredns
Ken Lee
@kennysan
411: A Framework for 
Managing Security Alerts
Kai Zhong
@sixhundredns
Ken Lee
@kennysan
OPEN SOURCE!
Who Are We?
KZER
Kai Zhong
Product Security Engineer @ Etsy
I wear many hats
Twitter: @sixhundredns
KLEE
Ken Lee
Senior Product Security Engineer @ Etsy
Spoke at Defcon 21 about Content Security Policy
Loves funny cat gifs
Twitter: @Kennysan
What is Etsy?
What Are We Covering?
History
The Problem(s)
Our Solution
Alert Management
@ Etsy
More Examples
Demo
But First, 
Some Terminology
Logs
The ELK Stack
Logstash
Data processor and log shipper
Logstash
Data processor and log shipper
Allows you to break out your log data into separate fields
Logstash
Data processor and log shipper
Allows you to break out your log data into separate fields
We use it to ship logs into Elasticsearch!
Elasticsearch
Distributed, real-time search engine
Elasticsearch
Distributed, real-time search engine
Allows storing complex, nested documents
Elasticsearch
Distributed, real-time search engine
Allows storing complex, nested documents
Allows generating statistics over your data
Elasticsearch
Distributed, real-time search engine
Allows storing complex, nested documents
Allows generating statistics over your data
We use it for analyzing logs!
Kibana
Data visualization frontend for Elasticsearch
Kibana
Data visualization frontend for Elasticsearch
Log discovery
Kibana
Data visualization frontend for Elasticsearch
Log discovery
Visualizations!
History
Switching to ELK
Work started in mid 2014
Switching to ELK
Work started in mid 2014
Finished in mid 2015
Switching to ELK
Work started in mid 2014
Finished in mid 2015
We learned a lot from the migration
Switching to ELK
Work started in mid 2014
Finished in mid 2015
We learned a lot from the migration
And got a bunch of great tools out of it
It Was A Bumpy Road
Hiccups are expected when moving to a new technology
It Was A Bumpy Road
Hiccups are expected when moving to a new technology
Had to deal with annoying, performance-impacting bugs
It Was A Bumpy Road
Hiccups are expected when moving to a new technology
Had to deal with annoying, performance-impacting bugs
Security was concerned about the usability of ELK
It Was A Bumpy Road
Hiccups are expected when moving to a new technology
Had to deal with annoying, performance-impacting bugs
Security was concerned about the usability of ELK
ELK didn’t have functionality to help us monitor attacks in real time
The Problem(s)
Search scheduling?
No Search Scheduling
Security heavily relied on Splunk scheduled searches for alerting
No Search Scheduling
Security heavily relied on Splunk scheduled searches for alerting
No equivalent for ES at the time
No Search Scheduling
Security heavily relied on Splunk scheduled searches for alerting
No equivalent for ES at the time
No web UI for managing searches
An Unfamiliar Query Language
Our alerts were complex SPL (Splunk Processing Language) queries
An Unfamiliar Query Language
Our alerts were complex SPL (Splunk Processing Language) queries
ES’s query language is less robust
An Unfamiliar Query Language
Our alerts were complex SPL (Splunk Processing Language) queries
ES’s query language is less robust
Some things were non-obvious coming from SPL
The Road to ELK Integration
The Road to ELK Integration
We needed a query language for building complex queries without code
The Road to ELK Integration
We needed a query language for building complex queries without code
We needed a mechanism to run and manage these queries
The Road to ELK Integration
We needed a query language for building complex queries without code
We needed a mechanism to run and manage these queries
Preferably before we turned off Splunk ; )
ESQuery
Features
Superset of the standard Lucene syntax
Features
Superset of the standard Lucene syntax
Syntactically similar to SPL!
Features
Superset of the standard Lucene syntax
Syntactically similar to SPL!
Supports all the functionality we need!!!
Syntax
Command
Syntax
Inline params
$size:20 $sort:user_id $fields:[a,b,c]
Joins
* | join source:src_ip target:dst_ip
Aggregations
* | agg:terms field:src_ip
  | agg:terms field:user_id
Variable 
substitution
src_ip:@internal_ips
SPL
source="/data/syslog/current/web/info.log" log_namespace="login"
reason="wrong password" response=403 | top 10 remote_host
{  "query": {
    "filtered": {
      "query": {
        "bool": {
          "minimum_number_should_match": 1,
          "should": [
            {
              "query_string": {
                "query": "type:web_info_log log_namespace:login logdata.reason:\"wrong password\" response:403 ",
                "default_operator": "AND",
                "lowercase_expanded_terms": false,
                "allow_leading_wildcard": false
      }}]}},
      "filter": {
        "bool": {
          "must": [
            {
              "range": {
                "event_timestamp": {
                  "from": 1468294422783,
                  "to": 1468295322783
  }}}]}}}},
  "size": 0,
  "sort": [
    {
      "event_timestamp": {
        "order": "desc",
        "ignore_unmapped": true
    }},
    {
      "event_timestamp": {
        "order": "desc",
        "ignore_unmapped": true
  }}],
  "aggs": {
    "terms_bucket": {
      "terms": {
        "field": "logdata.remote_host",
        "size": 10
}}}}
ESQuery
type:web_info_log log_namespace:login
logdata.reason:"wrong password" -response:403 |
agg:terms field:logdata.remote_host size:10
411
Alert Management
Write queries to be automatically executed
Alert Management
Write queries to be automatically executed
Receive email alerts whenever there are results
Alert Management
Write queries to be automatically executed
Receive email alerts whenever there are results
Manage alerts through the web interface
Scheduling
Under the Hood
Search
Alerts
Targets
Filters
Search Job
Under the Hood
Scheduler
Search Jobs
Workers
Dashboard
Managing queries
Configuring a query
Managing alerts
Reviewing an alert
Alert Management
@ Etsy
How We Respond to an Alert
Incident Response
High sensitivity alerts
Incident Response
High sensitivity alerts
Low alerts don’t generate notification e-mails
Incident Response
High sensitivity alerts
Low alerts don’t generate notification e-mails
Medium/High alerts generate alerts
Incident Response
High sensitivity alerts
Low alerts don’t generate notification e-mails
Medium/High alerts generate alerts
Attackers often generate a lot of noise -- can result in numerous alerts firing!
Responding to an Alert
Is this an alert that can wait till morning?
Responding to an Alert
Is this an alert that can wait till morning?
How many other related alerts went off during this time period?
Alert Maintenance
Sometimes certain queries are no longer useful
Alert Maintenance
Sometimes certain queries are no longer useful
Review noisy alerts
Alert Maintenance
Sometimes certain queries are no longer useful
Review noisy alerts
Add in other useful fields
What Deserves an Alert?
Potential error conditions
What Deserves an Alert?
Potential error conditions
Volume of traffic/Thresholds being hit
What Deserves an Alert?
Potential error conditions
Volume of traffic/Thresholds being hit
Deprecating old code
Instances
Sec411
Instances
Sec411
Netsec411
Instances
Sec411
Netsec411
Sox411
More Examples
Better Queries with Lists
Better Queries with Lists
Beyond ELK
Graphite
A way to store and graph time series data
Graphite
A way to store and graph time series data
Best for simple threshold alerting
Graphite
A way to store and graph time series data
Best for simple threshold alerting
All of Graphite’s data transforms are available
HTTP
Detect when a HTTP endpoint returns an unexpected response
HTTP
Detect when a HTTP endpoint returns an unexpected response
Useful for web services
HTTP
Detect when a HTTP endpoint returns an unexpected response
Useful for web services
Similar in functionality to Nagios
Demo
Questions?
Check out 411 here:
https://fouroneone.io
Kai
@sixhundredns
PI:EMAIL
Ken Lee
@kennysan
PI:EMAIL