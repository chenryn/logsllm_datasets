    1.  ## 日志规范说明
日志规范以研发工作为主，推动阻力比较大，需要自上而下推动。日志改造一般有两种方式：
-   利用开源组件，入门快，可扩展性就比较差；
-   代码改造，前期投入比较大，后续，可扩展性比较强，并且自主可控。
> 日志规范的具体说明如下：
### 日志格式
全链路日志应为Json 格式，建议最多2层，分别为：
1.  第一层，关键信息：链路信息、时间信息、粒度信息、业务状态信息；
2.  第二层，可扩展信息：业务关联信息、预留扩展字段。
> 样例如下：
>
> {\"traceid\":\"XXX\",\"spanid\":\"YYY\",.........,\"extend:{\"seqNo\":\"ZZZ\",\...\...}}
>
> 日志要求：
-   各系统记录日志，每笔交易（请求与应答），记录成一条或者两条，建议一条。
-   如果为一条，需要包括 starttime、endtime。
-   如果为两条，其中每条必须包括相同traceid与spanid，记录格式类JSON，按照上述字段顺序生成。
    1.  #### 关键字段
链路日志应包括链路字段、时间信息、深度/粒度字段、业务字段等信息：
![](media/image20.png){width="5.7043471128608925in"
height="2.7805555555555554in"}
各应用系统日志需要包含19项内容，且日志记录字段须严格区分大小写、拼写详情如下：
> 1\. traceid（必填）;
>
> 2\. spanid（必填）；
>
> 3\. parentspanid（必填）;
>
> 4\. starttime（span开始时间，必填，精确到毫秒级,格式:
> "yyyyMMddHHmmssSSS"）；
>
> 5\. endtime（span结束时间，必填，精确到毫秒级,格式:
> "yyyyMMddHHmmssSSS"）；
>
> 6\. errorcode（错误码，必填）；
>
> 7\. errormessage（错误信息，必填，错误码对应中文名称）；
>
> 8\.
> errortype（错误类型，必填，0：正常；1：自身；2：非自身；3：超时，可根据实际情况定义)；
>
> 9\.
> service（必填，用于判断同一个系统内部的不同服务，如果service为多个，则在新通讯规范6位系统标识后面增加自定义英文标识)；
>
> 10\. servicename（必填，service对应中文名称）
>
> 11\.
> interface（必填，用于判断同一系统同一服务下，不同（接口/子服务），名称由各系统自定义，纯英文，确保服务内唯一性)；
>
> 12.interfacename（必填，interface对应中文名称）；
>
> 13\.
> function（选填，用于判断同一系统同一服务下，不同（方法/程序等），名称由各系统自定义，纯英文，确保服务内唯一性）；
>
> 14\. busitype（业务标识，必填）；
>
> 15\. productNoname（产品码对应中文名称，选填，发起端必填）；
>
> 16\. eventNo（事件码，选填，发起端必填）；
>
> 17\. eventNoname（事件码对应中文名称，选填，发起端必填）；
>
> 18\. attribute（业务属性摘要，选填）；
>
> 19\.
> extend（自定义，选填，各系统也可自己定义为多个字段，该值目的为可与原有业务日志进行关联，如交易流水）。
其中，tracid、spanid的设计应包含系统标识信息及业务标识码，设计样例可参考：
![](media/image21.png){width="5.763888888888889in"
height="2.8097222222222222in"}
#### 传递关系
> 链路日志中关键字段间的生成及传递关系如下：
>
> Traceid
-   表示当前请求为请求链路中的某请求，在首次请求时确认
-   获取为空：根据格式规范生成
-   获取不非空：日志打印和向下传递。
> Spanid
-   全新生成：根据格式规范生成
-   向下传递：会成为下游的 parentspanid
> Parentspanid
-   首次请求为空
-   非首次请求，从上游传递的spanid中获取
-   分析时需要甄别是否为空
> 链路日志中节点间的生成及传递关系如下：
>
> 最上游节点：
>
> 1、生成 Traceid
>
> 2、生成 Spanid
>
> 3、传递 Traceid、Spanid
>
> 中间环节节点：
>
> 1、获取 Traceid、Spanid A
>
> 2、把获取到的 Spanid A 赋值给 Parentspanid
>
> 3、生成 Spanid B
>
> 4、向下传递 Traceid、Spanid B
>
> 最后端：
>
> 1、获取 Traceid、Spanid A
>
> 2、把获取到的 Spanid A 赋值给 Parentspanid
>
> 3、生成 Spanid B
>
> 4、无需向下传递 Traceid、Spanid
### 注意事项
在调用链日志的设计过程中，还需要注意调用链日志中业务信息生成与透传的关系：
> 1、调用链日志中的透传必要性
-   接口对接口之间相互调用需要区分业务进行，需要通过业务标识字段分组区分；
-   基于接口统计业务字段，可以获知该接口服务范围，进而直接确定影响范围。
> 2、业务标识信息传递方式
>
> 业务标识信息在最前端记录，包括在透传信息中进行下游传递。
>
> 传递方式有两种：
-   业务标识在 traceid 中占位，然后随 traceid 进行透传；
-   业务标识单独作为一个字段，如命名为 busitype 然后进行透传。
> 3、业务标识信息字段约束
-   字段长度约定，务必保证可扩展性。
-   字段名称统一：如 busitype 字段。
可参考样例：业务字段14位，前 3 位为 subSystemId，后
11位用于记录业务标识。
除此之外，还应注意：
1.  链路日志与业务日志分开打印；
2.  日志异步写入，避免堵塞业务线程；
3.  日志输出性能控制（如缓存大小、控制每秒写日志条数、次数）；
4.  链路日志全局开关；
5.  稳定性测试，特别是使用开源组件的场景。避免稳定性、性能测试不充分导致大规模业务系统受影响（建议自行改造日志：自有代码可控、影响范围小）；
6.  扩展性，约定字段传递方式及获取方式，支持扩展字段。随后续业务需要，存在增减字段的场景，只需修订服务发起端即可，变化字段信息全局传递。避免后续业务系统全部需要再次改造；
7.  研发改造、优选2-3条业务链路进行改造，小步迭代，优化中前进、成果推动。
    1.  ### 日志样例
> 样例1：
>
> {
>
> \"traceid\":\"MBL0010050568D7164C10FDD0D2017587AAF2F\",
>
> \"spanid\":\"MBL0010050568D7164C10FDD0D2017587AAF2F\",
>
> \"parentspanid\":\"\",
>
> \"service\":\"MBL001A\",
>
> \"servicename\":\"手机银行前端\",
>
> \"starttime\":\"20190927154324903\",
>
> \"endtime\":\"20190927154325927\",
>
> \"errorcode\":\"0000\",
>
> \"errormessage\":\"正常\",
>
> \"errortype\":\"0\",
>
> \"interface\":\"web_loan\",
>
> \"interfacename\":\"消费贷\",
>
> \"function\":\"\",
>
> \"productNo\":\"web_loan\",
>
> \"productNoname\":\"消费贷\",
>
> \"eventNo\":\"wl0006\",
>
> \"eventNoname\":\"线上消费贷额度申请\",
>
> \"attribute\":\"MB10867431\",
>
> \"extend\":\"\"
>
> }
>
> 样例2：
>
> {
>
> \"traceid\":\"\"MBL0010050568D7164C10FDD0D2017587AAF2F\"\",
>
> \"spanid\":\"\"MBL0014db9ac6a4883307036c7b6d0b62c1db7\"\",
>
> \"parentspanid\":\"\"MBL0010050568D7164C10FDD0D2017587AAF2F\"\",
>
> \"starttime\":\"\"20190927101309665\"\",
>
> \"endtime\":\"\"20190927101313593\"\",
>
> \"errorcode\":\"\"0000\"\",
>
> \"errormessage\":\"\"手机银行正常返回\"\",
>
> \"errortype\":\"0\",
>
> \"service\":\"\"MBL001B\"\",
>
> \"servicename\":\"\"手机银行后台\"\",
>
> \"interface\":\"\"MB2319\"\",
>
> \"interfacename\":\"\"消费贷额度申请\"\",
>
> \"function\":\"\",
>
> \"productNo\":\"\",
>
> \"productNoname\":\"\",
>
> \"eventNo\":\"\"MB2319\"\",
>
> \"eventNoname\":\"\"消费贷额度申请\"\",
>
> \"attribute\":\"\",
>
> \"extend\":\"\"
>
> }
>
> 样例3：
>
> {
>
> \"traceid\":\"MBL0010050568D7164C10FDD0D2017587AAF2F\",
>
> \"spanid\":\"MBL001254ef517932040ac9f4bbd8b472b9aa7\",
>
> \"parentspanid\":\"MBL0014db9ac6a4883307036c7b6d0b62c1db7\",
>
> \"starttime\":\"20190927154030030\",
>
> \"endtime\":\"20190927154030950\",
>
> \"errorcode\":\"0000\",
>
> \"errormessage\":\"XXXX\",
>
> \"errortype\":\"\",