**作者：[TSRC & 腾讯蓝军] Mark4z5(小五)  
公众号：**
### 一. 高悬的达摩克利斯之剑
2017年4月，黑客组织Shadow
Brokers公布一批美国国家安全局（NSA）的网络漏洞军火库。背靠国家，NSA拥有强大的通杀型0day漏洞挖掘和利用能力，这批漏洞库指哪打哪，堪称军火库中的核武器，其中就包含Windows永恒之蓝漏洞利用工具。军火库的泄露也造成了核武器平民化，被黑产利用来传播勒索蠕虫病毒。还记得WannaCry肆虐的景象吗？全球数百万台电脑包括大型企业、政府机构都受攻击，威力可见一斑。
而这只是无数攻击案例中的一个。
人们在享受网络技术发展带来的便利时，鲜少能意识到头上高悬的达摩克利斯之剑——安全。层出不穷的漏洞越发多样化，这把剑高悬在我们头顶摇摇欲坠，没有什么防护手段可以一劳永逸一招制敌，任何疏忽大意都可能给黑客提供可乘之机。
然而具体到单个企业层面，自身安全事故却相对低频，且在业务层面极少有直接感知。尚未发生事故，或者说攻击没有直接造成损失，很可能会给人带来安全防护足够完善、业务数据足够安全的错觉，甚至导致防护手段逐渐落后，安全流程越发陈旧，人员意识日益懈怠。
等到那把剑真的掉落之时，一切都将为时太晚。
### 二. 从大到强的试炼之路
这也解释了为什么近年来全球安全事故频发，国内外都极为重视网络安全。正如国家提出， **没有网络安全就没有国家安全。**
网络安全和信息化是事关国家安全和国家发展、事关广大人民群众工作生活的重大战略问题，是把我国从网络大国建设为网络强国的关键。
但并不是所有漏洞都能通过自动化工具检测发现。因此，国内外都在如火如荼地开展国家网络安全实战演练。中国公安部组织的护网行动集结全国优秀渗透测试工程师开展风险可控的攻击演习，美国国土安全部组织的Cyber
Storm也每两年开展一次网络安全实战演练。
从大到强，网络安全实战演练必不可少。它是网络安全建设的试金石和助燃器，是检验企业安全防护水平的试炼之地。只有持续暴露网络安全防护、监测和应急处置的缺陷并优化改进，才能抵挡黑客不断变换的猛烈攻击。
那么问题来了，谁来引领这条“试炼之路”呢？
对于腾讯这样体量庞大，业务繁多，拥有海量数据资产公司而言，需要一支既了解公司业务，又能够以黑客视角持续渗透公司资产的内部攻击队伍，这样才会更容易意识到公司各项安全隐患，把风险消弭于萌芽之前。
腾讯蓝军，就此应运而生。
### 三. 当我们谈蓝军时，我们在谈些什么
蓝军这个概念，其实军事领域早已有之。
国内蓝军扮演假想敌（即敌方部队），与红军（我方正面部队）开展实战演习，帮助红军查缺补漏，提升作战能力。网络安全红蓝对抗的概念也源自于此，通过开展APT高级持续性威胁攻击演习来全方位检验企业的安全稳健性和威胁监测及响应能力。
红军作为企业防守方，通过安全加固、攻击监测、应急处置等手段来保障企业安全，而蓝军作为攻击方，以发现安全漏洞，获取业务权限或数据为目标，利用各种攻击手段，试图绕过红军层层防护，达成既定目标。需要注意，欧美采用红队（Red
Team）代表攻击方，蓝队（Blue Team）代表防守方，颜色代表正好相反，常常容易让大家搞混。
企业网络蓝军工作内容主要包括 **"渗透测试（Penetration Testing）"和"红蓝对抗（Red Teaming）"**
，其实所使用的攻击技术大同小异，主要区别在侧重点不同。渗透测试侧重尽量用较短的时间去挖掘尽可能多的安全漏洞，一般不太关注攻击行为是否被监测发现，即便被发现也不会立刻遭拦截，
**目的是帮助业务系统暴露和收敛更多风险**
。红蓝对抗相反，通常采用背靠背方式贴近真实攻击，侧重绕过防御体系，毫无声息达成获取业务权限或数据的目标，不求发现全部风险点，因为攻击动作越多被发现的概率越大，一旦被发现，红军就会把蓝军踢出战场，
**目的是检验在真实攻击中纵深防御能力、告警运营质量、应急处置能力** ，当然这过程中也会发现业务系统安全漏洞。
腾讯蓝军（Tencent
Force）由腾讯TEG安全平台部于2006年组建。彼时自动化漏洞检测能力还比较弱，更多的安全漏洞得靠人肉发现，在这个背景下，腾讯蓝军正式成立，从此捷报频传，十余年专注于前沿安全攻防技术研究、实战演练、渗透测试、安全评估、培训赋能等，采用攻击者视角在真实网络环境开展实战演习，检验安全防护策略、响应机制的充分性与有效性，并推动优化提升。
**可见，当我们谈蓝军时，我们在谈的绝不仅仅只是单纯的模拟黑客，而是环环相扣的周密筹划，缜密侦查、精心设计，以及针对性的防守建议等等。**
### 四. 环环相扣：浅析网络攻击杀伤链
想要了解蓝军的整个攻击生命周期，可以通过网络攻击杀伤链来进行：首先通过多种手段获取立足点，在此基础上通过权限提升、信息发现和横向移动扩大控制权，最后达成数据收集、窃取和篡改破坏等目的。
![
](https://images.seebug.org/content/images/2019/03/4822251b-8af4-4e9f-ab0a-ed50ac72102b.png-w331s)
**下面结合腾讯蓝军十多年的攻防实战演练经验，试对各个阶段的攻击手法与技术简要分析如下：**
#### 第一阶段：获取立足点
**目标侦查：**
利用一系列侦查手段获取目标的资产、人员、环境等信息，为实施攻击提供基础信息支持，信息的全面性和准确性很大程度确定攻击的路径、战果和效率。比如通过DNS域传送漏洞、域名注册信息反查、域名枚举等手段获取域名资产信息，通过域名解析、网段扫描等手段获取IP资产信息，通过网站扫描、端口探测等手段获取程序指纹信息，通过在搜索引擎、社交网站、网盘、Github等平台检索以及社工欺骗等手段获取组织架构、员工信息、源代码、账户密码、常用软件、常上网站、安全防护策略、外包服务供应商等信息，通过实地考察获取职场和机房的网络、门禁、办公等环境信息。
**武器构建：**
根据前期收集到的信息，针对性制作攻击代码。如果尝试对HR进行攻击，那么可以设计植入木马的简历文档，如果计划从线上服务入手，可以通过自动化扫描、人工测试等手段对目标资产进行漏洞探测，发现可利用的0day漏洞。在目前公开的APT案例中，至少有80%是从攻击员工办公电脑入手，因为人是系统最大的漏洞，利用社会工程学的攻击成功率高，同时攻陷员工电脑后更容易摸清内部网络及扩大控制范围。
**攻击投放：**
利用各种手段将攻击载荷投递到目标。比如利用命令注入、文件上传、SQL注入、SSRF、XSS、溢出等漏洞直接远程攻击线上服务，利用邮件钓鱼、U盘摆渡攻击、水坑攻击、软硬件供应链攻击、网络劫持等方式入侵服务器、员工电脑、网络设备。
**执行利用：**
不同环境采用不同的执行方式，在受限环境可利用系统组件或合法程序执行加载恶意代码，从而突破系统限制或隐藏自身，达到木马顺利运行的目的。比如在Windows环境使用系统内置程序PowerShell执行脚本，恶意代码仅存在于内存中，文件不落地，类似可使用的执行方式非常多。
**命令控制：** 建立具有各种隐蔽级别的通道来操控目标设备或进入目标内网。比如通过WebShell（如Caidao、Weevely）、Reverse
Shell（如Bash/Python/PowerShell）、远控木马RAT（如Cobalt Strike/Metasploit