# Active Directory 证书服务(一)
## 0x00 前言
specterops发布了一篇关于Active Directory 证书服务相关漏洞的白皮书
Directory 证书服务的攻击第一次系统的进入我们的视野。
我在白皮书的基础上学习了Active Directory 证书服务相关的漏洞，作为学习成果，用两篇文章来介绍Active Directory
证书服务相关的基础以及相关的漏洞利用。截止这篇文章发布为止，有些漏洞利用相关的工具并没有发布出来，在文章里面我会用其他的方式来演示。
白皮书里面，最核心的点在于证书服务发布的部分证书可用于kerberos认证，并且在返回的PAC里面能拿到NTLM hash。这就是可以做很多事了，比如
1、拿到用户的凭据，能不能用用户的凭据来申请一个证书，这个证书用于kerberos认证，后面就算用户的密码改了，只要证书在手，就能用证书随时拿回NTLM。
2、能不能在用户的电脑上找到证书，以后拿着这个证书去做认证。
3、什么样的证书能用于kerberos认证。
4、拿到CA服务器证书之后，能不能给任何用户颁发证书，再用这个证书做认证，跟黄金票据一样。
5、CA服务器上有没有一些配置，能让一个用户申请别人的证书，然后拿到这个证书做认证。
6、CA证书申请有个界面是http的，http默认不开签名，我们能不能通过Ntlm_Relay将请求relay到这里，申请用以进行kerberos认证的证书。
关于这些，都会在这两篇文章里面讨论。在写完之后，由于内容过长，我将文章拆分为两篇，第一篇是介绍一些基础部分，以及三个相关的利用
1、窃取证书
2、通过凭据申请可用以Kerberos认证的证书
3、通过证书窃取用户凭据
在第二篇主要介绍一些其他的利用，包括
1、证书服务中的Ntlm_Relay
2、证书模板配置错误
3、黄金证书
3、PKI 设计缺陷
4、防御指南
整体的思路如下图
## 0x01 Active Directory 证书服务安装
在开始讲解证书服务之前，我们先装个证书服务，方便起见，直接在域控上安装就行。
下一步下一步比较简单。
## 0x02 Active Directory 证书服务概述
### 0x0201 企业 PKI
​
PKI是一个术语，有些地方会采用中文的表述——公钥基本结构，用来实现证书的产生、管理、存储、分发和撤销等功能。我们可以把他理解成是一套解决方案，这套解决方案里面需要有证书颁发机构，有证书发布，证书撤掉等功能。
​ 微软的Active Directory 证书服务(我们可以简称AD
CS)就是对这套解决方案的实现。ADCS能够跟现有的ADDS服务进行结合，可以用以加密文件系统，数字签名，以及身份验证。下面详细介绍下AD
CS中比较重要的的证书颁发机构以及证书模板。
### 0x0202 证书颁发机构
证书颁发机构 (CA) 接受证书申请，根据 CA 的策略验证申请者的信息，然后使用其私钥将其数字签名应用于证书。然后 CA
将证书颁发给证书的使用者。此外，CA 还负责吊销证书和发布证书吊销列表 (CRL)。
ADCS里面的CA分为企业CA和独立CA，最主要的区别在于企业CA与ADDS服务结合，他的信息存储在ADDS数据库里面(就是LDAP上)。企业CA也支持基于证书模板和自动注册证书，这也是我们比较关心的东西，如果没有特指，文章里面提到的CA默认就是企业CA。
举个例子，我们有个有个域名`daiker.com`，如果要做https，我们就需要找证书颁发机构申请证书，比如说沃通CA。
我们也可以自己搭建一个证书颁发机构。
但是使用自建的证书发布服务之后,浏览器还是不信任我们证书，我们经常可以看到
自行签名的根证书。之所以出现这个是因为电脑本身并不相信我们的CA证书。以下证书是windows内置的CA证书。如果我们能够把我们的CA证书放在这个列表里面，我们的证书就能得到信任。
对于企业来说，如果使用ADCS服务，想让员工的计算机信任我们企业自己的CA证书，有以下几种方式
1、安装企业根CA时，它使用组策略将其证书传播到域中所有用户和计算机的“受信任的根证书颁发机构”证书存储
2、如果计算机不在域内，可以手动导入CA证书
另外AD CS支持可缩放的分层 CA 模型，在此模型中，子从属 CA 由其父 CA 颁发的证书认证。层次结构顶部的 CA 称为根 CA。根 CA 的子 CA
称为从属 CA。
以上图为例子，每个企业仅有一个根CA，他由自己颁发，在大多数组织中，它们只用于颁发从属
CA，不直接颁发证书。而具体的证书由从属CA颁发，比如网站的证书，LDAPS的证书，这样做方便管理，在机器比较多的域内还能起到负载均衡的作用。当然，AD
CS支持分层的CA模型不代表一定要分层，对于比较小的公司，一般都只有一个根CA，所有的证书由这个根CA进行颁发。
### 0x0203 证书模板
证书模板是证书策略的重要元素，是用于证书注册、使用和管理的一组规则和格式。这些规则是指谁可以注册证书。证书的主题名是什么。比如要注册一个web证书，那可以在`Web服务器`这个默认的证书模板里面定义谁可以注册证书，证书的有效时间是多久，证书用于干啥，证书的主题名是什么，是由申请者提交，还是由证书模板指定。
我们可以使用`certtmpl.msc`打开证书模板控制台
这些都是系统默认的证书模板。
如果需要发布一个新的模板的话，可以右键复制模板，然后自己定义这些规则。
我们关心以下规则
  * **常规设置：** 交付证书的有效期，默认是一年
  * **请求处理：** 证书的目的和导出私钥的能力(虽然设置了证书不可被导出，但是mimikatz依旧能导出，我们后面会详细说)
  * **加密：** 要使用的加密服务提供程序 (CSP) 和最小密钥大小
  * **Subject name** ，它指示如何构建证书的专有名称：来自请求中用户提供的值，或来自请求证书的域主体的身份。这个需要注意的是，默认勾选了`在使用者名称中说那个电子邮件名`，当用户去申请的时候，如果用户的LDAP属性没有mail就会申请失败。
  * **颁发要求** ：CA证书经理程序批准
这个值得注意，就算用户有注册权限(在ACL里面体现)，但是证书模板勾选了这个，也得得到证书管理的批准才能申请证书，如果没有勾选这个，那有权限就可以直接申请证书了。
  * **安全描述符** ：证书模板的 ACL，包括具有注册到模板所需的扩展权限的主体的身份。关于这个的内容看证书注册那节的证书注册权限里面。
  * **扩展：** 要包含在证书中的 X509v3 扩展列表及其重要性（包括`KeyUsage`和`ExtendedKeyUsages`）
​ 这里我们要特别注意的是扩展权限里面的应用程序模板，
这个扩展决定了这个模板的用途，比如说文档加密，文档签名，智能卡登陆等等。
经过测试与研究，spectorops的工程师发现包含以下扩展的证书可以使用证书进行kerberos认证。
1、客户端认证
2、PKINIT 客户端身份验证
3、智能卡登录
4、任何目的
5、子CA
其中PKINIT不是默认存在的，需要我们手动创建，点击新建，名称自定义，对象标识符为`1.3.6.1.5.2.3.4`
## 0x03 证书注册
### 0x00301 证书注册流程
1、客户端生成一个证书申请文件，这一步可以使用openssl生成,比如
    openssl req -new -SHA256 -newkey rsa:4096 -nodes -keyout www.netstarsec.com.key -out www.netstarsec.com.csr -subj "/C=CN/ST=Beijing/L=Beijing/O=netstarsec/OU=sec/CN=www.netstarsec.com"
或者直接找个在线的网站
2、客户端把证书申请文件发送给CA，然后选择一个证书模板。
这一步可以申请的方式比较多，上面这种是通过访问证书注册界面进行注册的。ADCS请求注册证书的方式在下一小节具体说明。
3、CA证书会判断模板是否存在，根据模板的信息判断请求的用户是否有权限申请证书。证书模板会决定证书的主题名是什么，证书的有效时间是多久，证书用于干啥。是不是需要证书管理员批准。
4、CA会使用自己的私钥来签署证书。签署完的证书可以在颁发列表里面看到。
### 0x00302 证书注册接口
1、访问证书注册网页界面
要使用此功能，ADCS 服务器需要安装证书颁发机构 Web 注册角色。我们可以在添加角色和功能向导>AD证书颁发机构Web注册服务里面开启。
开启完就访问 访问证书注册网页界面
2、域内机器可以通过启动 certmgr.msc (用于用户证书)或 certlm.msc (用于计算机证书)来使用 GUI 请求证书
3、域内机器可以通过命令行`certreq.exe`和Powershell`Get-Certificate`来申请证书
4、使用`MS-WCCE`,`MS-ICPR`这俩RPC，具体交互流程得去看文档
5、使用CES，需要安装证书注册WEB服务，soap的格式，具体的交互流程得看`MS-WS-TEP`和`MS-XCEP`
6、使用网络设备注册服务，得安装网络设备注册服务
### 0x0303 证书注册权限
知道了证书注册的流程，注册的接口，接下来我们关注的就是证书注册的权限。跟证书注册相关的权限主要有两块，一块体现在CA证书上，一块体现在证书模板上。
我们可以运行`certsrv.msc`之后右键证书颁发机构，右键属性，安全查看权限。
对于CA证书的权限，我们比较关注的是请求证书的权限。默认情况下，所有认证用户都有请求权限。如果有请求的权限，CA就去判断请求的模板是否存在，如果存在，就交给证书模板去管理权限。
证书模板的权限，可以运行`certtmpl.msc`之后选择特定的证书模板，右键属性，安全查看权限
我们比较关注以下权限
  * 注册权限(Enroll)
拥有这个权限的用户拥有注册权限
  * 自动注册的权限(AutoEnrollment)
在配置证书自动注册的时候需要证书模板开启这个权限，关于证书自动注册的更多细节，在下一小节会详细说明。
  * AllExtendedRights/Full Control
AllExtendedRights 包括所有的扩展权限，就包括了注册权限和自动注册权限。
Full Control包括所有权限，也包括有的扩展权限
我们关心完CA的权限以及证书模板的权限之外，还得注意一个配置`CA证书管理程序批准`
如果证书模板没有勾选这个，那么有ca的证书请求权限，证书模板的注册权限，就可以申请下证书。但是如果勾选了这个选项，那么就算有注册权限，那也得得到证书管理员的批准才能注册证书。
### 0x0304 证书自动化注册
相较于注册，自动化注册顾名思义就是自动化，不需要用户手动注册。有些软件需要用户证书去访问，让每个用户自己手动申请证书又不太现实，这个时候自动化注册证书的优势就体现出来了。
接下来演示下怎么配置证书自动化注册。
1、配置一个证书模板
选择一个已有的模板，右键复制模板
名字改成用户自动化注册
去掉以下两个勾，因为有些用户可能没有配置邮箱，自动化申请证书的时候就会失败。
给这个证书模板赋予任何`Domain Users`有注册和自动化注册的权限
然后下发一个组策略
新建一个组策略，命名为`自动注册证书`
然后打开用户配置>策略>安全设置>公钥策略,配置下图圈出来的三个
然后等组策略生效，域内的每个用户登录的时候都会自动申请一个证书，不用人为申请证书。