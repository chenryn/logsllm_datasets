图10-9查看无线信号
一些企业对IT投入逐步增大，部署了各种安全产品
of APa
Cients
TypeEncryption TypeCloaked
0.0
None
WEP
None
None
WEP
PWPA
12
1-32
No
No
No
2012-07-12
201207-12
201207-12
20120712
20120712
1atSeon
Hide old oe
20120-12
201207-12
2012.07-12
012-07-12
Last
8-8
85
0->8
国
---
## Page 304
火墙正在截取那些攻击包。新的包数据取样如下所示：
（10.1.0.1）进行攻击。小许的日志比较工具显示了外部和内部NIDS日志的差异，这表明防
0x10]代表这是IP数据包内的服务类型[TOS]字段。
长度，当一个连接建立时，连接双方都需要通告各自的MSS，在上面抓包过程中出现的[tos
下所示：
防火墙的规则设置，以此截断来自发起攻击的子网的所有流量。
tcpdump开始进行定制分析。下面是抓取的20个TCP报文信息：
测器检测到了一些试探性的攻击，其中包括一台内部计算机频繁的TCP端口扫描。
自动产生了记录和电子邮件告警。为了安全起见，他不厌其烦地比较各种日志。外部探
IP地址显示，攻击者来自国外。小许的报警器已经响起，警告有外来的攻击。防火墙
这20个TCP报文段包含TCP首部，但没有任何数据，对于TCP段每个输出行格式如
最初的端口扫描可能是攻击者对内部网络进行入侵的前奏。小许选择的唯一方案是调整
接下来的日志数据是进入NIDS的原始包格式数据的副本。随后，小许利用抓包软件
这时在网络前端好像没有任何异常。NIDS计算机已经停止发送告警，但这并不能让小
几分钟后，新的过滤器开始工作，随后报警器报告有人试图尝试从一个新的IP地址
凌晨3点，好像有人正对一台Linux服务器RH1（192.168.120.1）进行攻击，根据
上面的MSS（最大报文长度）选项设置为1460，代表了TCP传输另一端的最大数据块
03:06:07.904068 10.1.0.1.44004>192.168.120.1.6000 F 0:0(0) win 3072
03:06:07.904011 10.1.0.1.44004>192.168.120.1.ssh:F 0:0(0) win 3072
03:06:07.58364510.1.0.1.44003>192.168.120.1.6000 :F 0:0(0) win 3072
03:06:07.583585 10.1.0.1.44003 >192.168.120.1.ssh:F 0:0(0) win 3072
03:06:07.263675 10.1.0.1.44004 >192.168.120.1.ssh:F 0:0 (0) win 3072
03:06:06.26362110.1.0.1.44004>192.168.120.1.6000:F 0:0(0)win3072
03:06:06.928599 10.1.0.1.44003 >192.168.120.1.telnet:F 0:0(0) win 3072
03:06:06.928530 10.1.0.1.44003 >192.168.120.1.ssh:F 0:0(0) win 3072
03:06:06.928393 10.1.0.1.44003 >192.168.120.1.www:F 0:0(0) win 3072
03:06:06.928333 10.1.0.1.44003 >192.168.120.1.6000: F 0:0 (0) win 3072
源地址>目的地址：标志位（例如S、F、R、P）
0.0.
168.
8
168
2
2win
第10章Snort系统部署及应用案例281
6060
p5827e
265521>（DF）[tos0x10]
70L
---
## Page 305
的端口扫描如下所示：
自没有检测到的另
那些正流入NIDS
示了比较高的平均负荷：
在最佳负荷（平均负荷在1前后变化）。然而，一台Linux系统RHAS（192.168.120.2）却显
许放下心来。随后他快速地检查了系统负荷，发现有些不一对劲。通常所有的计算机都运行
282
从上面结果可以看出有人通过Nmap成功执行了TCPSYN扫描。
因
他用top命令进行了检查，并没有发现什么非法的进程。
UNIX/Linux网络日志分析与流量监控
:10:
以下是tcpdump监明
1为是深夜，
top- 19:00:01 up 200 days, 5:00 ,2 users, load average:7.01,3.4,2.4
88
004160
999
000
22
0.
5
另
5
2
，没有其他人连接系统，并且得知有异常的进程存在，因此小许随即切断了
00000
10-20121
一个地址（10.2.0.1）。因此，系统没有发出任何报警。出现在日志记录中
系统的原始数据。在该数据库中，发现了另外一个攻击企图，这次攻击来
N
2.0
听结果：
0.1X
used,
16
t>10.
2
品
2
0000000000000000000
fra
P.I
fr
cag 54769:4@16)
中
49052:R
49052:
000000000000000000000
24040:4
6@0+
0+
4@16)
ack
40532387win0
ND
10.000
00:00:10
00-20120
qbq
B00
CIDIO
正
---
## Page 306
但这还不算完，要想真正弄清攻击的真相，只有仔细分析数据包。
可能是由内部邮件服务器造成的。他移去了内部电子邮件服务器，这种攻击也就随之停止。
包，其中包含了通过检查电子邮件的输出所得到的防火墙配置信息。这时小许可以确认攻击
办？不一会儿，解决办法逐步浮现在脑海中，小许认为，每一次攻击都企图产生一个数据
上画出了网络拓扑图，并继续查找着日志信息，以便挖掘出攻击真相，如图10-11所示。
子网发起攻击。这时小许已经困得不行了，去喝了杯咖啡。他脑子里一直没闲着，随手在纸
许又查看NIDS日志，原来攻击者并没有察觉到防火墙上的改变，依然试图从现在被禁止的
行了取证分析，遗憾的是在替换下来的电子邮件服务器上没有找到任何入侵的证据。随后小
小许重新安装配置了一台电子邮件服务器上线，应该就没问题了。随后小许对故障计算机进
自攻击者网段的数据包。现在假定攻击者以某种方式控制了电子邮件服务器，在这种前提下
并且在收到电子邮件之后两分钟紧接着出现扫描，而且非常有规律。
算机发送的大量消息。小许留意到，大部分消息是在头一次攻击发生之后两分钟内收到的，
件服务器。在行动之前，小许决定先停止公司内邮件客户端并备份了在受攻击期间NIDS计
中的一种来确定防火墙和NIDS系统的工作情况，小许心想，最有可能出问题的就是电子邮
件流量和内部子网授权请求流量外，没有任何其他流量是活跃的。攻击者正是利用这些流量
以往的经验表明，晚上这个时候正常流量是最小的，除了少量Web浏览流量、电子邮
故障处理
随后，小许临时关闭了公司的电子邮件服务器，并重新配置了防火墙规则来拒绝所有来
发生在半夜的非法攻击记录已完全淹没在大量合法连接的日志中了。太难找了，怎么
DNS服务器
交换机
图10-11网络简易拓扑
外部NIDS
14
firewall
第10章Snort系统部署及应用案例283
44
Y29OT
008802028
内部NIDS
---
## Page 307
了初始化通信的数据包）。这个数据包探测受害主机是否运行着一个邮件传输代理程序，例
标准服务？接着看下面的日志记录：
的。从这些包中解码的基本信息如下：
数据包解码
284UNIX/Linux网络日志分析与流量监控
原貌。
下面小许将继续研究可疑日志，并尽力拼凑看似没有关联的线索，以便还原这次攻击的
这是一次TCP连接端口扫描吗？这些数据包从10.0.0.1发出会连接受害者系统上的哪些
这条记录表明，攻击者发出了一个TCPSYN数据包（S表示对受害主机上的服务发送
1460,sackOK,timestamp65519[tcp]>(DF)
以下是获取的第一段日志：
TCP标志S：代表TCPSYN同步标志
目的TCP端口：Telnet23
源TCP端口：2570
源IP地址：10.0.0.1
到达时间：03:02:30.169272
这个数据包中含有如下有用的信息：
·TCP的序列号和确认符：这些包的次序是什么？
·TCP标志：这次通信是刚刚开始，还是正在结束，或者是在进行？
●源和目的IP地址：是什么系统产生了这些包？
●包：到达运行 tcpdump 系统的时间。
在后面所出现的日志中，每条记录是在网络上捕获的单独的包。这些包是tcpdump 捕获
1.第一个包的日志
序列号/确认号：350598809/350598809
目的IP地址：192.168.120.1
1460,sackOK,timestamp65519[tcp]>(DF)
03:02:30.169502 10.0.0.1.2573 >192.168.120.1.smtp:S 346774169:346774169(0) win 32120 （DF)
---
## Page 308
工具来解码研究（例如 Wireshark、Tcpshow等工具）。
六进制的形式打印到屏幕，一般在实际中我们会用-w参数将其保存为文件，然后通过其他
没有任何数据包从内部网络返回给攻击者。养鸿氢
Telnet、SSH、SMTP、www 和X-Window服务。看来小许将防火墙规则改变是对的，这样
更加隐蔽的网络动作。攻击者试图进行二次端口扫描，目标系统的端口号表明这些包针对
了系统上运行这种服务，也就知道了一个潜在漏洞的存在。
端口（即X-Window服务端口）发出，送到远程主机。这个包的产生和接收使得攻击者知道
统上的一个图形会话。数据包B是TCP 握手的一个标准响应。TCP SYN/ACK 包，从 6000
发现TCPSYN/ACK数据包。
是
是一个标准的UNIX/Linux服务，提供远程X-Window连接。这项服务允许远程用户访问系
日志中输出的 tcpdump 结果对截获数据并没有彻底解码，它的包内大部分内容都是以十
这些包和以往的端口扫描不同。这种攻击方法，被称为“TCPFIN 端口扫描”，是一种
2.第二个包日志
但是，日志显示抓取了一对很可疑的数据包，显示受害主机上运行着某种服务：
下面是对这些包的分析：
更多有关第二个包的内容如下：
●TCP标志F：标识TCPFin标志，通信流的终止数据包序列号/确认号0:0
●到达时间：03:06:06928333
从单个数据包提取出的数据包含如下信息：
我们再次从单个数据包中提取一些有用的信息：
数据包A和我们刚才看的数据包极为类似。但这次探测的服务运行在6000端口上，
16060(DF)
1460,sackOK,timestamp65519[tcp]>(DF)
目标TCP端口：6000（X-window服务）
目标IP地址：192.168.120.1
源TCP端口：44003
源IP地址：10.0.0.1
03:02:30.169423 10.0.0.1.2572 >192.168.120.1.6000:S 346081831:346081831(0) win 32120192.168.120.1.6000 : F 0:0(0) win 3072
0302:30.169738192.168.120.1.6000 >10.0.0.1.2572: S 354267619:354267619(0) ack 346081832 win
03:06:07.583585 10.1.0.1.44003 >192.168.120.1.ssh: F 0:0(0) win 3072
03:06:07.263675 10.1.0.1.44004 >192.168.120.1.ssh:F 0:0 (0) win 3072
03:06:06.263621 10.1.0.1.44004 >192.168.120.1.6000: F 0:0(0) win 3072
03:06:06.928599 10.1.0.1.44003 >192.168.120.1.telnet:F 0:0(0) win 3072
03:06:06.928530 10.1.0.1.44003 >192.168.120.1.ssh:F 0:0(0) win 3072
03:06:06.928460 10.1.0.1.44003>192.168.120.1.smtp:F 0:0(0) win 3072
03:06:06.92839310.1.0.1.44003 >192.168.120.1.www:F 0:0(0) win 3072
第10章Snort系统部署及应用案例285
它
---