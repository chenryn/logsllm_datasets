When you open a case with IBM, you can include additional IBM MQ troubleshooting information
(MustGather data) that you have collected to help with investigating the problem. In addition to the
information described in this section, IBM Support might request further information on a case by case
basis.
Recovering after failure
Follow a set of procedures to recover after a serious problem.
About this task
Use the recovery methods described here if you cannot resolve the underlying problem by using the
diagnostic techniques described throughout the Troubleshooting and support section. If your problem
cannot be resolved by using these recovery techniques, contact your IBM Support Center.
Procedure
See the following links for instructions on how to recover from different types of failures:
• “Disk drive failures” on page 476
• “Damaged queue manager object” on page 477
• “Damaged single object” on page 477
• “Automatic media recovery failure” on page 477
See the following links for instructions on how to recover from different types of failures on IBM MQ for
z/OS:
•
“Shared queue problems” on page 479
•
“Active log problems” on page 479
•
“Archive log problems” on page 485
•
“BSDS problems” on page 487
IBM MQ troubleshooting and support 475
•
“Page set problems” on page 494
•
“Coupling facility and Db2 problems” on page 495
•
“Problems with long-running units of work” on page 498
•
“IMS-related problems” on page 499
•
“Hardware problems” on page 500
Related tasks
“Contacting IBM Support” on page 301
If you need help with a problem that you are having with IBM MQ, you can contact IBM Support through
the IBM Support Site. You can also subscribe to notifications about IBM MQ fixes, troubleshooting, and
other news.
“IBM MQ troubleshooting and support” on page 5
If you are having problems with your queue manager network or IBM MQ applications, you can use the
techniques that are described in this information to help you diagnose and solve the problems. If you
need help with a problem, you can contact IBM Support through the IBM Support Site.
“Making initial checks” on page 6
There are some initial checks that you can make that may provide answers to common problems that you
might have.
Backing up and restoring IBM MQ
Planning for backup and recovery on z/OS
Disk drive failures
You might have problems with a disk drive containing either the queue manager data, the log, or both.
Problems can include data loss or corruption. The three cases differ only in the part of the data that
survives, if any.
In all cases first check the directory structure for any damage and, if necessary, repair such damage. If
you lose queue manager data, the queue manager directory structure might have been damaged. If so,
re-create the directory tree manually before you restart the queue manager.
If damage has occurred to the queue manager data files, but not to the queue manager log files, then the
queue manager will normally be able to restart. If any damage has occurred to the queue manager log
files, then it is likely that the queue manager will not be able to restart.
Having checked for structural damage, there are a number of things you can do, depending on the type of
logging that you use.
• Where there is major damage to the directory structure or any damage to the log, remove all the
old files back to the QMgrName level, including the configuration files, the log, and the queue manager
directory, restore the last backup, and restart the queue manager.
• For linear logging with media recovery, ensure that the directory structure is intact and restart
the queue manager. If the queue manager restarts, check, using MQSC commands such as DISPLAY
QUEUE, whether any other objects have been damaged. Recover those you find, using the rcrmqobj
command. For example:
rcrmqobj -m QMgrName -t all *
476 Troubleshooting and Support for IBM MQ
where QMgrName is the queue manager being recovered. -t all * indicates that all damaged objects
of any type are to be recovered. If only one or two objects have been reported as damaged, you can
specify those objects by name and type here.
• For linear logging with media recovery and with an undamaged log, you might be able to restore a
backup of the queue manager data leaving the existing log files and log control file unchanged. Starting
the queue manager applies the changes from the log to bring the queue manager back to its state when
the failure occurred.
This method relies on two things:
1.You must restore the checkpoint file as part of the queue manager data. This file contains the
information determining how much of the data in the log must be applied to give a consistent queue
manager.
2.You must have the oldest log file required to start the queue manager at the time of the backup, and
all subsequent log files, available in the log file directory.
If this is not possible, restore a backup of both the queue manager data and the log, both of which were
taken at the same time. This causes message integrity to be lost.
• For circular logging, if the queue manager log files are damaged, restore the queue manager from the
latest backup that you have. Once you have restored the backup, restart the queue manager and check
for damaged objects. However, because you do not have media recovery, you must find other ways of
re-creating the damaged objects.
If the queue manager log files are not damaged, the queue manager will normally be able to restart.
Following the restart you must identify all damaged objects, then delete and redefine them.
Damaged queue manager object
If a queue manager object is itself damaged, the queue manager performs a preemptive shut down.
There are two ways of recovering in these circumstances, depending on the type of logging you use:
• For linear logging, restart the queue manager. Media recovery of the damaged queue manager object is
automatic.
• For circular logging, restore the last backup of the queue manager data and log, and restart the queue
manager.
Damaged single object
If a single object is reported as damaged during normal operation, for linear logging and replicated logging
you can re-create the object from its media image. However, for circular logging you cannot re-create a
single object.
There is a further option if you are using circular logging. For a damaged queue, or other object, delete the
object and define the object again. In the case of a queue, this option does not allow you to recover any
data on the queue.
Note: Restoring from backup is likely to be out of date, due to the fact that you must have your queue
manager shut down in order to get a clean backup of the queue files.
For information on recovery from a media image, see Recovering damaged objects.
Automatic media recovery failure
If a local queue required for queue manager startup with a linear log is damaged, and the automatic
media recovery fails, restore the last backup of the queue manager data and log and restart the queue
manager.
IBM MQ troubleshooting and support 477
Example recovery procedures on z/OS
Use this topic as a reference for various recovery procedures.
This topic describes procedures for recovering IBM MQ after various error conditions. These error
conditions are grouped in the following categories:
Table 35. Example recovery procedures
Problem category Problem Where to look next
Shared queue Conflicting definitions for both private and shared “Shared queue problems” on
problems queues. page 479
Active log problems • Dual logging is lost. “Active log problems” on
page 479
• Active log has stopped.
• One or both copies of the active log data set are
damaged.
• Write errors on active log data set.
• Active log is becoming full or is full.
• Read errors on active log data set.
Archive log problems • Insufficient DASD space to complete offloading “Archive log problems” on
active log data sets. page 485
• Offload task has terminated abnormally.
• Archive data set allocation problem. 1
• Read I/O errors on the archive data set during
restart.
BSDS problems • Error opening BSDS. “BSDS problems” on page
487
• Log content does not correspond with BSDS
information.
• Both copies of the BSDS are damaged.
• Unequal time stamps.
• Dual BSDS data sets are out of synchronization.
• I/O error on BSDS.
Page set problems • Page set full. “Page set problems” on page
494
• A page set has an I/O error.
coupling facility and • Storage medium full. “Coupling facility and Db2
Db2 problems problems” on page 495
• Db2 system fails.
• Db2 data-sharing group fails.
• Db2 and the coupling facility fail.
Unit of work problems A long-running unit of work is encountered. “Problems with long-running
units of work” on page 498
IMS problems • An IMS application terminates abnormally. “IMS-related problems” on
page 499
• The IMS adapter cannot connect to IBM MQ.
• IMS not operational.
478 Troubleshooting and Support for IBM MQ
Table 35. Example recovery procedures (continued)
Problem category Problem Where to look next
Hardware problems Media recovery procedures “Hardware problems” on
page 500
Shared queue problems
Problems occur if IBM MQ discovers that a page set based queue, and a shared queue of the same name
are defined.
Symptoms
IBM MQ issues the following message:
CSQI063E +CSQ1 QUEUE queue-name IS BOTH PRIVATE AND SHARED
During queue manager restart, IBM MQ discovered that a page set based queue and a shared queue
of the same name coexist.
System action
Once restart processing has completed, any MQOPEN request to that queue name fails, indicating the
coexistence problem.
System programmer action
None.
Operator action
Delete one version of the queue to allow processing of that queue name. If there are messages on the
queue that must be kept, you can use the MOVE QLOCAL command to move them to the other queue.
Active log problems
Use this topic to resolve different problems with the active logs.
This topic covers the following active log problems:
• “Dual logging is lost” on page 479
• “Active log stopped” on page 480
• “One or both copies of the active log data set are damaged” on page 480
• “Write I/O errors on an active log data set” on page 481
• “I/O errors occur while reading the active log” on page 482
• “Active log is becoming full” on page 483
• Active log is full
Dual logging is lost
Symptoms
IBM MQ issues the following message:
CSQJ004I +CSQ1 ACTIVE LOG COPY n INACTIVE, LOG IN SINGLE MODE,
ENDRBA=...
Having completed one active log data set, IBM MQ found that the subsequent (COPY n) data sets were
not offloaded or were marked stopped.
IBM MQ troubleshooting and support 479
System action
IBM MQ continues in single mode until offloading has been completed, then returns to dual mode.
System programmer action
None.
Operator action
Check that the offload process is proceeding and is not waiting for a tape mount. You might need to
run the print log map utility to determine the state of all data sets. You might also need to define
additional data sets.
Active log stopped
Symptoms
IBM MQ issues the following message:
CSQJ030E +CSQ1 RBA RANGE startrba TO endrba NOT AVAILABLE IN ACTIVE
LOG DATA SETS
System action
The active log data sets that contain the RBA range reported in message CSQJ030E are unavailable
to IBM MQ. The status of these logs is STOPPED in the BSDS. The queue manager terminates with a
dump.
System programmer action
You must resolve this problem before restarting the queue manager. The log RBA range must be
available for IBM MQ to be recoverable. An active log that is marked as STOPPED in the BSDS will
never be reused or archived and this creates a hole in the log.
Look for messages that indicate why the log data set has stopped, and follow the instructions for
those messages.
Modify the BSDS active log inventory to reset the STOPPED status. To do this, follow this procedure
after the queue manager has terminated:
1.Use the print log utility (CSQJU004) to obtain a copy of the BSDS log inventory. This shows the
status of the log data sets.
2.Use the DELETE function of the change log inventory utility (CSQJU003) to delete the active log
data sets that are marked as STOPPED.
3.Use the NEWLOG function of CSQJU003 to add the active logs back into the BSDS inventory. The
starting and ending RBA for each active log data set must be specified on the NEWLOG statement.
(The correct values to use can be found from the print log utility report obtained in Step 1.)
4.Rerun CSQJU004. The active log data sets that were marked as STOPPED are now shown as NEW
and NOT REUSABLE. These active logs will be archived in due course.
5.Restart the queue manager.
Note: If your queue manager is running in dual BSDS mode, you must update both BSDS inventories.
One or both copies of the active log data set are damaged
Symptoms
IBM MQ issues the following messages:
480 Troubleshooting and Support for IBM MQ
CSQJ102E +CSQ1 LOG RBA CONTENT OF LOG DATA SET DSNAME=...,
STARTRBA=..., ENDRBA=...,
DOES NOT AGREE WITH BSDS INFORMATION
CSQJ232E +CSQ1 OUTPUT DATA SET CONTROL INITIALIZATION PROCESS FAILED
System action
Queue manager startup processing is terminated.
System programmer action
If one copy of the data set is damaged, carry out these steps:
1.Rename the damaged active log data set and define a replacement data set.
2.Copy the undamaged data set to the replacement data set.
3.Use the change log inventory utility to:
• Remove information relating to the damaged data set from the BSDS.
• Add information relating to the replacement data set to the BSDS.
4.Restart the queue manager.
If both copies of the active log data sets are damaged, the current page sets are available, and the
queue manager shut down cleanly, carry out these steps:
1.Rename the damaged active log data sets and define replacement data sets.
2.Use the change log records utility to:
• Remove information relating to the damaged data set from the BSDS.
• Add information relating to the replacement data set to the BSDS.
3.Rename the current page sets and define replacement page sets.
4.Use CSQUTIL (FORMAT and RESETPAGE) to format the replacement page sets and copy the
renamed page sets to them. The RESETPAGE function also resets the log information in the
replacement page sets.
If the queue manager did not shut down cleanly, you must either restore your system from a previous
known point of consistency, or perform a cold start (described in Reinitializing a queue manager ).
Operator action
None.
Write I/O errors on an active log data set
Symptoms
IBM MQ issues the following message:
CSQJ105E +CSQ1 csect-name LOG WRITE ERROR DSNAME=...,
LOGRBA=..., ERROR STATUS=ccccffss
System action
IBM MQ carries out these steps:
1.Marks the log data set that has the error as TRUNCATED in the BSDS.
2.Goes on to the next available data set.
3.If dual active logging is used, truncates the other copy at the same point.
The data in the truncated data set is offloaded later, as usual.
The data set will be reused on the next cycle.
IBM MQ troubleshooting and support 481
System programmer action
None.
Operator action
If errors on this data set still exist, shut down the queue manager after the next offload process. Then
use Access Method Services (AMS) and the change log inventory utility to add a replacement. (For
instructions, see Changing the BSDS.)
I/O errors occur while reading the active log
Symptoms
IBM MQ issues the following message:
CSQJ106E +CSQ1 LOG READ ERROR DSNAME=..., LOGRBA=...,
ERROR STATUS=ccccffss