主机（如果不是全部的话）。但是，除了前面所描述的基于网络分
析的局限性之外，还存在进一步的限制：网络警告无法提示系统是
如何受到攻击影响的。例如，账户是否被成功地创建或访问？文件
是否被修改或下载？关键的服务是不是失败？
主机可以利用3项关键技术，通过日志提供对安全事件的洞察力。这
3项技术分别是操作系统、服务器应用程序和安全技术。在理论上，
利用操作系统日志的概念听起来很重要，但遗憾的是，这些日志本
身的价值非常有限。日志一般是有局限性的，系统中的大多数日志
用于记录一组有限的活动以及预期的条件和错误。考虑到大多数漏
洞会显式地绕过操作系统内部的一些控制，我们可以合理地预计它
的日志记录肯定是不完整的，甚至根本就没有被记录。
反之，有些服务器的应用程序，尤其是像数据库和Web服务器这样
基于网络的应用程序，倾向于记录所有来自网络和主机的请求。它
们可以捕捉被传递的详细参数以及被执行的命令，并提供丰富的上
下文信息，有助于发现安全事件。服务器应用程序日志的困难在于
如何高效率地从企业内部收集所有主机的日志。在那些由许多不同
操作系统组成的大型企业网络中，从中心开始收集应用程序日志是
件很困难的工作，在很多情况下并不会被当做优先完成的任务。
在网络中，还存在一些专门设计用于保护主机免受恶意代码和入侵
攻击以及检测所有攻击尝试的安全技术。最全面的技术组合了反病
毒、个人防火墙、反间谋软件、反垃圾邮件和主机IPS功能。一般情
况下，这些技术首先把注意力集中在预防上，然后才是检测。因
2460
---
## Page 2462
此，虽然日志中确实有更多的价值，但它们在攻击期间哪些将被记
录哪些将不被记录方面还是存在一些局限，并且不同的生产商所提
供的功能可能各不相同。由于大多数企业已经部署了反病毒软件并
且有许多企业主动更新到更统一的终端安全解决方案，因此在分析
时收集和包含这些日志具有确定的价值。它们不仅可以提供更准确
的分析，而且填充了IDP基础设施内部由于网络位置而存在的检测空
隙。
因此，有了额外的主机日志后，是不是打算得到100%呢？也许不
能，但它比本章之初所说的32%显然要高得多。
创建富有弹性的检测模型
即使是最优秀的安全从业人员也很容易陷入一个陷阱，就是在检测
安全事件时过于依赖一种技术或一种日志来源。在我们对全球数白
家大型公司的安全管理经历中，我们与无数的安全官员有过谈话。
我们发现有许多官员对他们的安全监控没有实现预想的结果而倍感
挫折，但他们的监控计划仅限于在整个企业内部部署IDP传感器。我
们发现许多安全队伍在他们的系统被入侵时浑然不觉，这是由于安
全体系结构的不完整，被大量的假阳性警报所灌没，没有办法强调
真正的攻击。如前所述，只使用IDP技术进行监测的方法当然可以产
生积极结果，但它很可能只捕捉32%的事件。对于有些公司而言，
由于预算的限制或者它们的信息资产的性质并不是任务关键的，因
此只找到三分之一的安全事件的风险是它们愿意接受的。但是，对
于大多数公司而言，如果它们的事件检测功能只能检测出数量非常
有限的攻击，这是不可接受的，尤其是在它们的网络包含了员工或
顾客的敏感数据的情况下。
宽对网络上所发生事件的洞察力。利用前面所描述的部分或全部技
巧，可以为事件检测打下一个坚实的基础。这些技巧都非常有效地
强调了一些关键的攻击特征，例如无法解释的流量、连接到已知的
恶意地址或者表示人侵的明显签名。但是，如果孤立地使用每种技
巧，可能无法实现有效的检测。通过结合检测不同来源的日志，可
以提供一个事件的不同视角，极大地增强检测真正事件的能力。例
如，让我们重新回顾与主机入侵相关联的攻击提示（见图14-1）。
2461
---
## Page 2463
图14-1入侵的证据
图中所显示的提示包括：
1）IDP根据已知签名检测到来自Internet的攻击尝试。由于IDP的警告
并没有提供足够的细节提示攻击是否成功，因此这个提示只表示试
图发起攻击。
2）防火墙记录了返回到发起攻击的主机的一个FTP会话的回应流
量。这个额外的上下文信息非常可信地证实了第一次攻击是成功
的。
3）主机的日志显示了大约在同时，注册表键
HKEYLOCALMACHINE\SoftwareMicrosoftWindows\CurrentVersion
Rum的字符事值被添加。它导致了恶意代码在系统启动时被执行。
由于注册表键的修改是极为频繁的，因此修改的时机是极为关键
2462
---
## Page 2464
的。与提示1和提示2同时发生的注册表键修改能够提示攻击是成功
的。
4）被劫持的主机连接到其他系统文件的共享，进行恶意代码的扩散
或搜索信用卡信息。这些连接尝试只被防火墙日志所记录。对主机
的历史进行快速检查可以显示主机存在异常情况，因此这是另一个
高度可信的提示，表示系统已经被劫持。
5）带外攻击尝试肯定不会是预期的或正常的主机行为。这是第3个
高度可信的提示，表示系统已经被劫持。
6）与已知的命令和控制服务器通过高端口的UDP连接也相当有力地
证明了系统已经被劫持。
7）取决于流量的规模，电子商业站点本身的流量过多并不表示恶
意，但是当它与前面的提示相关联时，很可能提示系统正参与一次
分布式拒绝服务攻击。
通过结合这些不同片段的证据，毫无疑问可以断定主机已经被成功
入侵。在这个例子中，当我们从不同的角度进行分析时，可以从这
个事件所展现的各方面的可疑活动中得出结论，但我们并不总是能
够得到这样的机会。虽然有些攻击将会触发每个完整性检查工具，
但有些攻击在设计时就注重了隐蔽性，但用一种检测技巧很可能无
法发现。如果图14-1的漏洞攻击由于不存在可用的签名而没有被IDP
所检测出来，那么情况又会怎么样呢？提示1和提示5将没有效果。
另外，提示2在第1次攻击尝试时增加了上下文信息，此时它也无法
发挥作用。即使在攻击完成了一半时，仍然由于签名不到位而无法
发现攻击的痕迹。但是，我们还是拥有足够的信息来证实这次攻
击。
通过利用一组范围极广的检测技巧，我们创建了一个富有高度弹性
的事件检测模型。在这里，我们使用“弹性"这个词描述了能够发现
针对我们的环境所发起的绝大多数攻击的事件检测模型。如果有一
次攻击没有被一种技巧检测出来，它很可能会被其他一个或几个技
巧成功检测出来。弹性的概念虽然很简单，但令人吃惊的是，它是
一个被许多安全从业人员在设计检测功能时所忽略的特性。事件检
测模型缺乏弹性所存在的危险是常常会无意识地忽略有些事件，而
往往在自己的信息资产受到真正的损害之后才会发现检测的覆盖率
上的空隙。下面是一些真实的事件例子，它们可以测试出安全从业
人员在事件检测模型上的弹性：
2463
---
## Page 2465
攻击者通过一种新的还不存在匹配签名的攻击或其变种对主机发起
攻击。
签名常常触发假阳性。
由于最近的一次网络变化，以前能够监视带内和带外流量的IDP现
在只能监测带外流量。
网络管理员不小心关闭了端口映射，使IDP对所有的网络流量都熟
视无睹。
用于记录防火墙流量日志的服务器对于网络不再可用。
由于防火墙的性能限制，带外防火墙被配置为不记录日志。
·已知恶意IP地址的监视列表已经过期。
所有这些潜在的空隙都会影响我们观察被攻击的完整图像。事实
上，我们应该假设在绝大多数时间内只能看到攻击的部分痕迹。看
到攻击痕迹的不同部分的能力越全面，发现事件的可能性也就越
大，即使是在不太理想的情况下。
除了把各种检测功能结合为一个整体事件之外，许多企业还发现把
受影响主机的资产信息与事件结合起来分析也是非常有效的。让我
们回顾一个例子，这次攻击的痕迹要比以前所描述的攻击不明显得
多（见图14-2）。
2464
---
## Page 2466
图14-2更微妙的入侵证据
在图14-2中，攻击痕迹不太明显，因为3个提示可能导致我们作出2
个截然不同的结论：可能是一台主机试图扩散恶意代码，也可能是
一台邮件服务器执行预期的操作。让我们详细观察每个攻击提示：
1）IDP对多个签名发出警告。这取决于哪个IDP被触发，邮件服务器
触发各种不同的，可信度不高的签名从而产生假阳性的情况并不少
见。对于这个例子而言，我们假设这些签名觉得它是可疑的，但不
足以将它确认为一个事件。
2）这个提示强调了主机试图通过25/tcp端口（SMTP）与多个其他主
机进行连接。实际的目标主机序列可以提示真相。如果这台主机按
递增顺序连接到不同的IP地址，这很可能是恶意代码在搜索其他邮
件服务器，因为它一般并不是通过这种方式连接到其他服务器。试
图连接到看上去随机的IP地址的邮件服务器是非确定性的，因为它
可能是正常邮件操作的结果，也可能是由于恶意代码随机地连接到
2465
---
## Page 2467
主机所致。因此，这个提示可能非常有价值，也可能毫无用处。我
们假设它试图进行随机连接，因此它是一个可信度不高的提示。
3）最后一个提示是在25/tcp端口（SMTP）的增长流量。虽然这个行
为很可疑，但邮件服务器的负载变化幅度可能非常大。除非观察到
的流量显著地超过了正常的基线，否则分析师很难根据这个提示断
定它是一个需要付诸行动的事件。
在这种情况下，临界点并不在于系统正在做什么，而是系统是什
么，即它是数据库服务器还是邮件服务器。如果与信息资产的属性
进行结合，那么可信度不高的提示也会变成可信度很高的提示。
有许多不同的信息资产属性对于检测安全事件具有类似的作用。有
些实用的信息资产属性的例子包括：
主机的操作系统
它可以从当前的配置管理数据库或者通过最近的漏洞扫描获取。例
如，假设服务器是基于Unix的，如果它被基于Microsoft漏洞的攻击
所瞄准，那么入侵成功的机会为零。
主机上所展现的漏洞
为了让攻击获得成功，系统必须没有针对这个漏洞攻击打上补了，
因此存在漏洞。漏洞信息提供了良好的上下文环境，但是只有在最
近执行了漏洞扫描后才具有价值，因为陈旧的信息可能导致虚假的
结论。另外，漏洞扫描本身也可能出现假阳性和假阴性，这可能会
使分析复杂化，甚至带来误导。
主机的业务或网络功能
网络管理服务器将会发送和接收大量的SNMP流量，邮件服务器将在
SMTP上进行通讯。这些信息不仅对于理解预期的网络流量减少假阳
性率是极为关键的，而且可以帮助业务管理人员理解与关键的业务
功能相关联的系统。
主机上所存储的数据类型
主机是否包含信用卡信息、社会保障卡号码、病人健康信息、知识
产权或者日常的工作文件和电子邮件对于开发安全架构和保护策略
是极为重要的。虽然对于事件检测并不是特别关键，但这些关键性
2466
---
## Page 2468