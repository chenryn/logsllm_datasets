== 定时任务
为方便用户实现半自动化日志分析功能，日志易提供定时任务选项，设定一次搜索即可实现定时数据查询。
另，日志易系统提供自定义定时任务过期时间。通过 manager 修改 splserver 配置项 `schedule.saved_schedule_result.keep_time`, 默认是 7d。
定时任务刷新状态操作的间隔时间是5s。
=== 操作步骤
定时任务的创建过程非常简单。一般情况下，在搜索页 SPL 搜索完成后，点击 “保存为->定时任务”即可。 
例如搜索语句如下：
[source,bash]
* | stats max(apache.resp_len)
统计视图界面如下：
image::images/schedule-from-search.png[]
点击后弹出“保存定时任务”窗口，填写任务名称“max-resp_len”。
image::images/schedule-new.png[]
您也可以在统计菜单视图中，同样操作，选择“保存为定时任务”：
image::images/schedule-new-from-visualize.png[]
可以看到，日志易会自动将统计菜单视图转换为高级搜索语法：
image::images/schedule-new-from-visualize-detail.png[]
和报表一样，任务的执行计划可采用定时间隔，也可以采用crontab式语法，填写完成后，可以点击"解析"预览最新 10 次的计划时间。
对 SPL 比较熟悉的用户，也可以直接在定时任务列表页点击"新建"，从空白表单开始创建定时任务。
在任务栏中可以看到当前的定时任务列表。可以在任务列表中，禁用暂时不需要运行的定时任务，或者复制一个新的定时任务，也可以看到每个定时任务最近的运行状态是否成功：
image::images/schedule-list.png[]
点击相应的名称可以看到该定时任务的详情以及不同触发时间的结果：
image::images/schedule-readonly.png[]
点击右侧的查看操作，可以跳转到搜索页，查看定时任务数据。
=== 修改定时任务
在定时任务列表，点击编辑，进入编辑页面如下：
image::images/schedule-edit.png[]
可对“搜索内容”、“高基模式”、“搜索条数”、“时间范围”、“在交易日执行”、“执行计划”等数据配置，“名称”、“描述”、“标签”等资源配置进行修改。修改完成后点击“保存”完成操作。
=== 推送任务结果
日志易支持将定时任务运行的结果数据保存到特定索引或第三方数据库。
image::images/schedule-output.png[]
==== 定时任务数据保存到索引
默认情况下，定时任务数据会保存到 schedule 索引。
有需要的时候，您可以删除配置，或选择其他索引。例如，借用 outputlookup 指令定时更新字典表的任务，无需额外保存到索引。
删除配置后，定时任务运行历史列表上，将无法提供"查看"数据的链接入口。但依然可以查看执行异常时的错误记录。
选择其他索引后，您可以点击"测试运行"按钮，系统会立刻运行一次临时任务，运行完成后，可以点击"查看"预览测试运行的结果。
选择其他索引时，您只能选择有编辑权限的索引。
==== 定时任务数据保存到JDBC
默认情况下，定时任务数据不会保存到 JDBC。
为了保证 JDBC 推送的成功，在配置定时任务之前，请务必提前创建好数据库输出。在数据库配置页面中，系统会强制您验证数据库连接和数据库表结构，然后才可以配置日志易查询结果的字段名称与数据库表结构的映射关系。
然后，回到定时任务配置页面中，添加 JDBC，选择对应的数据库输出名称。您可以点击"测试运行"按钮，系统会立刻运行一次临时任务，将数据通过 JDBC 方式推送到对应的数据库表中。运行完成后，你可以通过 dbxquery 指令，或者直接访问对应的数据库表，验证写入的数据是否满足期望。
=== 定时任务数据回填[[schedule-complement]]
定时任务数据除了在详情页展示以外，还可以通过schedule索引二次检索统计。
比如上例的数据，我们就可以通过如下SPL再次查询：
[source,bash]
index=schedule schedule_name:"事件计数_column"
如果担心有定时任务名称重复的情况，可以在定时任务列表页展开对应详情，复制资源 ID，采用 ID 搜索：
[source,bash]
index=schedule schedule_id:98
但是当系统出现一些不可控因素，例如网络抖动时，定时任务的数据会出现偏差、延迟的情况。这时候，可以按需回填定时任务的数据，以保证后续的二次查询统计结果最终是正确的。
此外，还有另一种常见情况，可以使用数据回填功能。当新建一个用来统计比较长的一个时间段的指标的定时任务时，比如这个定时任务是想算最近一周的结果统计，由于是今天刚刚建立的，所以需要等待一周后才能得出统计指标。但是可以用定时任务填充命令行工具补齐前面六天的定时任务结果，马上可以看到统计的指标，而不用等一周。当然前提是日志易系统中有足够长（前六天）的数据结果。
我们可以通过web页面创建补采/回填任务。
==== 回填任务界面管理
点击'定时任务补采详情'，进入补采任务管理页面：
image::images/DSRW-bucai-btn.png[]
点击'创建补采任务'，选择定时任务名称一个或多个，时间范围，是否覆盖已存在的定时任务结果，保存即可创建成功。
image::images/DSRW-new-bucai.png[]
如图所示，补采任务包括四种状态：准备执行、运行中、停止、完成。并提供三种任务操作：执行，暂停，删除。
image::images/DSRW-bucai-manage.png[]
<<<