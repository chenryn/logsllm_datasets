### 优化后的文本

#### 内部通信问题
以 Cloudflare 的 1.1.1.1 为例，该服务曾被包括 Cisco 和 AT&T 在内的多家厂商设备使用 [15, 31]。Cloudflare 的一项研究表明，超过 10% 的全球客户端在查询 1.1.1.1 时遇到可达性问题 [74]。

#### 审查
在受审查的网络中，常用的方法包括 IP 封锁、域名欺骗和连接重置，以阻止用户访问敏感内容。DNS 查询常常因此被操纵 [27, 66]。

#### TLS 拦截
中间盒和反病毒软件越来越多地拦截 TLS 连接并检查流量 [41]。如果加密的 DNS 流量被拦截，查询将不再受到保护，因为它们会暴露给拦截者。

### 发现 2.1
与传统 DNS 相比，大型的 DNS-over-Encryption 服务受路径设备的影响较小，具有 99% 的全球可达性。从我们的全球数据集中，我们发现 DNS-over-Encryption 解析器的整体可达性非常有前景：超过 99% 的全球客户端可以正常使用。以 Cloudflare 为例，超过 16% 的客户端无法使用其明文 DNS，这与之前的结果一致 [74]。相比之下，Cloudflare DoT 的失败率降至 1.1%，表明客户端可以在明文 DNS 失败时切换到 DNS-over-Encryption。受影响的客户端中有超过 60% 位于印度尼西亚、越南和印度。

| 平台类型 | 正确 | 错误 | 失败 |
| --- | --- | --- | --- |
| DNS | 83.46% | 0.08% | 16.46% |
| DoT | 98.84% | 0.02% | 1.14% |
| DoH | 99.91% | 0.04% | 0.05% |

表 4: 公共解析器的可达性测试结果

### 发现 2.2
在中国，审查机制阻止了用户访问 Google DoH。在我们的全国数据集中，99.99% 的客户端无法查询 Google DoH。与使用 8.8.8.8 的明文 DNS 不同，Google DoH 使用 dns.google.com 指向其他地址（例如 216.58.192.*）。这些地址还承载了其他 Google 服务，因此被中国用户屏蔽。

### 发现 2.3
虽然尚未普遍存在，但 TLS 拦截破坏了机会性的 DoT。TLS 拦截使 DNS 查询暴露于中间人攻击，并消除了加密的好处。在全球数据集中，我们发现了 17 个（共 29,622 个）客户端的查询被拦截。在这些情况下，所有解析器证书都被一个不受信任的 CA 重新签名，而其他字段保持不变（见表 6），因此无法通过严格验证。除了 3 个仅监听端口 443 的情况外，DoT 和 DoH 流量都被拦截。

对于机会性的 DoT 测试，由于它不需要严格的认证，所有被拦截的客户端都会继续进行 DNS 查找并成功获取答案。从我们的权威服务器上，我们发现中间人设备代理了 TLS 会话，并将查询转发到原始解析器。因此，客户端的查询对拦截者可见（例如表 6 中的 DPI 设备）。

相反，由于 DoH 严格认证服务器，它会报告证书错误并终止 TLS 握手。结果是，拦截者无法看到 DoH 查询，但客户端会经历查询失败。

### 发现 2.4
Quad9 DoH 的配置问题可能导致不必要的查询失败。我们发现 Quad9 DoH 的客户端以显著较高的比率（约 13%）收到 SERVFAIL 响应。仔细检查响应后，我们发现 Quad9 将所有 DoH 查询转发到其自己的 DNS/UDP 端口 53，并设置 2 秒超时等待响应。然而，由于网络繁忙或名称服务器距离较远，这个超时时间可能太短，从而导致 DNS 客户端不必要的错误。

在向 Quad9 DNS 团队报告该问题后，我们在 24 小时内收到了他们的回复，确认并认可了我们的问题。

### 性能测试结果
| 位置 | DNS/TCP | DoT (额外延迟) | DoH (额外延迟) |
| --- | --- | --- | --- |
| US | 0.272 | 0.349 (77ms) | 0.361 (89ms) |
| NL | 0.449 | 0.707 (258ms) | 0.712 (263ms) |
| AU | 0.569 | 0.955 (386ms) | 0.968 (399ms) |
| HK | 0.636 | 1.106 (470ms) | 1.169 (533ms) |

* 表中的值是每个观察点 200 次测试的中位数。

### 发现 3.2
不同国家的 DNS-over-Encryption 服务性能波动较大。如图 9 所示，虽然全球性能开销很小，但我们发现在某些国家，DNS-over-Encryption 的额外延迟高于平均水平。例如，我们在印度尼西亚的 504 个客户端在使用 Cloudflare 的 DoT 时，平均/中位数额外延迟为 25ms/42ms。相比之下，对于某些客户端，DNS-over-Encryption 甚至比传统 DNS 更快。例如，我们在印度的 282 个客户端在使用 Cloudflare DoH 时，相比其明文 DNS，获得了平均/中位数 99ms/96ms 的性能提升。尽管令人惊讶，但这一现象确实存在。