ternal communication, to name a few. Taking Cloudflare’s 1.1.1.1
as an example, it has been formerly used by devices of vendors
including Cisco and AT&T [15, 31]. A study by Cloudflare shows
that more than 10% global clients have reachability problems
querying 1.1.1.1 [74].
● Censorship. In censored networks, approaches including IP block-
● TLS interception. Middleboxes and anti-virus software are increas-
ing, domain spoofing and connection reset are used to block users
from sensitive contents. DNS queries are oftentimes manipulated
as a result [27, 66].
ingly intercepting TLS connections and inspecting traffic [41].
If encrypted DNS traffic is intercepted, queries are no longer
protected, as they are exposed to interceptors.
Finding 2.1: Compared to traditional DNS, large DNS-over-
Encryption services are less affected by in-path devices, with
99% global reachability. From our global dataset, we find that the
overall reachability of DNS-over-Encryption resolvers is promising:
they can be normally used by over 99% of global clients. Taking
Cloudflare as an example, over 16% clients fail to use its clear-text
DNS4, which is similar to previous results [74]. By contrast, the
failure rate of Cloudflare DoT drops to 1.1%, suggesting clients can
4Over 60% affected clients are located in Indonesia, Vietnam and India.
An End-to-End, Large-Scale Measurement of DNS-over-Encryption: How Far Have We Come?
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
Platform Type
Correct
83.46%
DNS
98.84%
DoT
DoH 99.91%
84.86%
DNS
84.90%
DoT
DoH 99.74%
ProxyRack
(Global)
Zhima
(Censored,
China)
Table 4: Reachability test results of public resolvers
Cloudflare
Incorrect
0.08%
0.02%
0.04%
0.00%
0.00%
0.00%
Failed
16.46%
1.14%
0.05%
15.14%
15.10%
0.25%
Correct
84.12%
n/a2
99.85%
98.91%
n/a
0.01%
Google
Incorrect
0.08%
n/a
0.00%
0.01%
n/a
0.00%
Failed
15.80%
n/a
0.15%
1.08%
n/a
99.99%
Correct
99.78%
99.78%
85.99%
99.76%
99.47%
99.25%
Quad9
Incorrect
0.11%
0.06%
13.09%
0.01%
0.02%
0.15%
Failed
0.11%
0.15%
0.92%
0.23%
0.51%
0.60%
Correct
99.90%
99.90%
99.93%
99.90%
99.81%
99.92%
Self-built
Incorrect
0.06%
0.05%
0.02%
0.05%
0.02%
0.00%
Failed
0.04%
0.05%
0.05%
0.05%
0.18%
0.08%
1 Failed: clients receive no DNS response packets. Incorrect: we only see SERVFAIL responses and responses with 0 answers.
2 At the time of experiment, Google DoT was not announced.
Table 5: Ports open on the address 1.1.1.1, probed from global
clients which fail to use Cloudflare DoT.
# Client
Example Client AS
Port
None
22 (SSH)
23 (Telnet)
53 (DNS)
67 (DHCP)
80 (HTTP)
123 (NTP)
139 (SMB)
161 (SNMPv2)
155
28
40
79
7
131
5
3
10
23
93
AS44725 Sinam LLC
AS17488 Hathway IP Over Cable Internet
AS24835 Vodafone Data
AS4713 NTT Communications Corporation
AS52532 Speednet Telecomunicacoes Ldta
AS27699 Telefnica Brazil S.A
AS23693 PT Telekomunikasi Selular
AS23693 PT Telekomunikasi Selular
AS9870 Dong-eui University
AS3269 Telecom Italia S.p.a
AS27699 Telefnica Brazil S.A
179 (BGP)
443 (HTTPS)
* Cloudflare’s 1.1.1.1 opens port 53, 80 and 443. Others indicate IP conflict.
switch to DNS-over-Encryption if clear-text DNS fails. We suppose
the difference is caused by filtering policies on a particular port (i.e.,
port 53), as supported by devices like [67]. Port 443 (DoH) and 853
(DoT) may currently be ignored by the policies, resulting in better
reachability. Also when blocking, the devices appear to focus on the
most prominent service addresses, as the failure rate of Cloudflare
and Google DNS are higher.
However, compared to other DNS-over-Encryption servers, the
failure rate of Cloudflare DoT is higher (over 1.1%). By port scan
and checking webpages of 1.1.1.1, we find devices that are conflict-
ing this address, resulting in inability to use. As shown in Table 5,
most destinations do not have any of our probed port open, so
we presume that they are used for internal routing or blackhol-
ing [74]. By their webpages, we find routers (e.g., MikroTik Router
in AS17974), modems (e.g., Powerbox Gvt Modem in AS27699) and
authentication systems which use 1.1.1.1 for other purposes.
Moreover, security issues can rise when devices conflicting the
resolver addresses are compromised. Among our clients which
cannot reach the Cloudflare resolver, 12 are connected to crypto-
hijacked MikroTik routers [53]. The webpages on their 1.1.1.1 are
injected with coin-mining codes to abuse computing resource.
Finding 2.2: Censorship blocks users in China from Google
DoH. In our China-wide dataset, 99.99% clients fail to query Google
DoH. Instead of 8.8.8.8 for its clear-text DNS, dns.google.com
for Google DoH points to other addresses (e.g., 216.58.192.*). The
addresses also carry other Google services, therefore are blocked
from Chinese users.
Table 6: Example clients affected by TLS interception
Client IP
Country
202.123.177.*
98.186.202.*
177.133.9.*
5.18.250.*
60.48.98.*
LA
US
BR
RU
MY
Common Name of
untrusted CA
SonicWall Firewall DPI-SSL
“None”
Sample CA 2
NThmYzgyYT 2
c41618c762bf890f 2
Port
443
✓
✓
✓
✓
✓
Port
853
✓
✓
✓
✓
For maximum usability, we suggest DNS-over-Encryption ser-
vices be hosted on addresses with a clean history, or cloud platforms
and CDNs which are less likely to have reachability problems. In
fact, recently Google is already migrating its DoH to anycast ad-
dresses (e.g., 8.8.8.8) [40].
Finding 2.3: While not pervasive yet, TLS interception breaks
opportunistic DoT. TLS interception exposes DNS queries to Man-
in-the-Middle (MITM) attackers, and eliminates the benefits of en-
cryption. In our global dataset, we find 17 clients (of 29,622) with
intercepted queries. In these cases, all resolver certificates are re-
signed by an untrusted CA, while other fields remain unchanged
(examples given in Table 6), therefore cannot pass strict verification.
Except for 3 cases which only listen on port 443, both DoT and DoH
traffic are intercepted.
For opportunistic DoT in our test, as it does not require strict
authentication, all intercepted clients proceed with the DNS lookup
and successfully get an answer. From our authoritative server, we
find that the MITM devices proxy the TLS sessions, and forward the
queries to the original resolvers. As a result, queries from clients are
visible to the interceptors (e.g., DPI devices in table 6).
On the contrary, as DoH strictly authenticate the servers, it
reports a certificate error and terminates the TLS handshake. Con-
sequently, interceptors cannot see the DoH queries, but clients
experience query failures.
Finding 2.4: A configuration issue of Quad9 DoH potentially
causes unnecessary query failures for their clients. We find
that from Quad9 DoH, our clients are getting SERVFAIL at a signifi-
cantly high rate (about 13%). A close inspection at the responses
shows that Quad9 forwards all DoH queries to its own DNS/UDP
on port 53, and sets a 2-second timeout waiting for responses. How-
ever, this timeout can be small due to busy networks or faraway
nameservers, and therefore causes unnecessary errors for DNS
clients.
After reporting the issue to the Quad9 DNS team, we quickly get
their response in 24 hours, which acknowledges and confirms our
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
Chaoyi Lu et al.
Figure 9: Query performance per country. The countries are selected by having most of our clients.
Table 7: Performance test results w/o connection reuse
Vantage DNS/TCP DoT (overhead) DoH (overhead)
US
NL
AU
HK
0.272
0.449
0.569
0.636
0.349 (77ms)
0.707 (258ms)
0.955 (386ms)
1.106 (470ms)
0.361 (89ms)
0.712 (263ms)
0.968 (399ms)
1.169 (533ms)
* The values are medians of 200 tests on each vantage.
Finding 3.2: Performance of DNS-over-Encryption services
fluctuates in different countries. As shown in Figure 9, while
the global performance overhead is minor, we find countries where
the extra latency of DNS-over-Encryption is above average. Our
504 clients in Indonesia, for example, witness an average/median
overhead of 25ms/42ms when using Cloudflare’s DoT. By contrast,
DNS-over-Encryption can be even faster than traditional DNS for
some clients. For instance, our 282 clients in India, gain an aver-
age/median of 99ms/96ms performance improvement when using
Cloudflare DoH, compared to its clear-text DNS. Though surpris-