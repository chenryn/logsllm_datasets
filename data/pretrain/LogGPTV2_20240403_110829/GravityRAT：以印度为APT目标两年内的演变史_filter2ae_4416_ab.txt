该样本在资源区中包含一个诱导图片：
###  G3版本
2017年8月，GravityRAT的作者使用了一款新的变种：G3版本，该变种的PDB路径为：
    F:Projectsg3G3 Version 4.0G3G3objReleaseIntel Core.pdb
该变种使用了与G2相同的方法，并且在资源区中包含了一个合法的库。开发者同时为这个库添加了额外的语言支持，包括如下语言：
    German
    Spanish
    French
    Italian
    Chinese
作者在这个变种中修改了后端的C2服务器，URI也发生了改变，对应的GravityRAT变量名如下所示：
印度CERT同样在8月份向潜在的受害者发布公告，称GravityRAT已经被用于有针对性的攻击活动中。由于这款恶意软件一直在持续演进中，因此这意味着下一个版本的变种已呼之欲出。
###  GX版本
GravityRAT的最新变种于2017年12月创建，名为GX。PDB路径如下：
    C:UsersThe InvincibleDesktopgxgx-current-programLSASSobjReleaseLSASS.pdb
这款变种是迄今为止最为高级的GravityRAT变种。在整个演变过程中，我们发现这款恶意软件会嵌入开源、合法的.NET库（用于计划任务、压缩、加密以及.NET加载）。该变种包含名为“important”的一个资源，该资源其实是带有密码保护的一个压缩文档。
这款变种包含与之前变种相同的功能，但添加了一些新的功能：
1、运行`netstat`命令收集受害者主机上的开放端口信息。
2、列出正在运行的所有进程。
3、列出系统上可用的服务。
4、除了G1变种中涉及的文档格式外，该变种还会提取`.ptt`以及`.pptx`文件。
5、如果系统中连入了一个USB设备，则该恶意软件会根据扩展名列表窃取其中的文件。
6、支持文件加密功能（采用AES算法，密钥为“lolomycin2017”）。
7、收集账户信息（账户类型、描述、域名、全名、SID以及状态）。
8、通过几种技术检查当前系统是否为虚拟机环境。
为了检查目标系统是否为虚拟机环境，恶意软件开发者总共使用了7种技术。
第1种技术主要原理是检查注册表键值，查找hypervisor在系统上安装的一些额外工具：
第2种技术使用了WMI请求来获得BIOS版本信息（`Win32-BIOS`）。如果返回的信息包含“VMware”、“Virtual”、“XEN”或者“A M
I”，则认为当前系统为虚拟机环境。此外，恶意软件会检查BIOS的序列号以及具体版本。
第3种技术使用了WMI中的`Win32_Computer`，检查生产商是否包含“VIRTUAL”、“VMWARE”或者“VirtualBox”字样。
第4种技术会检查系统的处理器ID信息。
第5种技术会统计目标系统种的CPU核心数（恶意软件作者希望系统不止一个核心）。
第6种技术会检查系统当前的CPU温度（`MSAcpi_ThermalZoneTemperature`条目）。事实上某些hypervisors（VMWare、VirtualBox以及Hyper-V）并不支持温度检查功能。WMI请求只会简单地回复“不支持”字样。这种逻辑可以用来检测目标系统是否为真实的主机环境。
最后一种技术用到了目标系统的MAC地址信息。如果MAC地址以某些常见的十六进制数字开头，则将目标系统识别为虚拟机。
与之前的变种一样，该变种使用HTTP协议与C2服务器通信。URI地址种用到了GX变种的版本信息。我们可以看到该变种与之前的变种共享C2服务器：
## 四、幕后肇事者
接下来我们与大家分享关于幕后攻击者以及恶意软件的一些证据。追踪溯源一直是一项非常复杂的工作，恶意软件开发者可以使用代理或者VPN来伪造样本的来源。即便如此，我们还是会简单地介绍关于此次攻击幕后黑手的一些事实。
恶意软件开发者至少使用了两个不同的用户名：“The
Invincible”以及“TheMartian”。在最早版本的GravityRAT中，PDB路径中包含“Adeel’s
Laptop”字样，很有可能攻击者泄露了他的真实名字：“Adeel”。此外，所有的恶意Office文档，特别是提交到VirusTotal上用来测试反病毒软件检测效果的文档都来自巴基斯坦。在下文的IOC中，4个PE文件中有1个也来源于巴基斯坦。
2017年8月，印度国家CERT发布了针对性恶意攻击活动的[安全公告](https://nic-cert.nic.in/NIC_CERT/pdf/13-Advisory%20for%20Malicious%20Targeted%20Attack%20Campaign.pdf)。这份安全公告中提到了GravityRAT所使用的C2服务器基础架构，这表明GravityRAT作者很有可能针对的是印度的实体/组织。利用Cisco
Umbrella并使用调查工具后，我们发现，在所有的C2域名列表中有来自印度的大量流量。根据印度国家CERT提供的证据，对C2域名的所有请求中至少有50%的请求来自于印度的IP地址。在研究过程中，非印度归属地的IP地址可能掺杂我们自己的IP地址。
## 五、总结
这个攻击者可能并不是我们见过的最厉害的攻击者，但自2016年以来，他或者她成功地将自身隐藏在公众的眼皮底下。他们能够研发恶意代码，制作了至少4个变种。每个新的变种都会包含新的功能。开发者一直在使用同样的C2架构，由于开发者非常聪明，因此可以保证这些C2架构的安全，不会被安全供应商列入黑名单。攻击者花了一些精力来确保恶意软件不会运行在虚拟环境中，以避免被分析。然而，他们并没有花时间专门去混淆.NET代码。这些代码逆向分析起来非常简单，因此我们使用静态分析方法就足以应付这款恶意软件。
在安全公告中，印度CERT认为此次攻击活动针对的是印度的实体及组织。
开发者在样本以及VirusTotal平台上泄露了一些信息（比如Adeel）。基于这些信息，我们能够理解开发者如何测试恶意文档，以减少多个常见杀毒引擎对其的检测率。在测试过程中，提交至VirusTotal的所有样本都来自于巴基斯坦。
## 六、IOC
**恶意文档**
恶意宏
    0beb2eb1214d4fd78e1e92db579e24d12e875be553002a778fb38a225cadb703
    70dc2a4d9da2b3338dd0fbd0719e8dc39bc9d8e3e959000b8c8bb04c931aff82
    835e759735438cd3ad8f4c6dd8b035a3a07d6ce5ce48aedff1bcad962def1aa4
    C14f859eed0f4540ab41362d963388518a232deef8ecc63eb072d5477e151719
    ed0eadd8e8e82e7d3829d71ab0926c409a23bf2e7a4ff6ea5b533c5defba4f2a
    f4806c5e4449a6f0fe5e93321561811e520f738cfe8d1cf198ef12672ff06136
其他恶意文档（DDE）
    911269e72cd6ed4835040483c4860294d26bfb3b351df718afd367267cd9024f
    fb7aa28a9d8fcfcabacd7f390cee5a5ed67734602f6dfa599bff63466694d210
    ef4769606adcd4f623eea29561596e5c0c628cb3932b30428c38cfe852aa8301
    cd140cf5a9030177316a15bef19745b0bebb4eb453ddb4038b5f15dacfaeb3a2
    07682c1626c80fa1bb33d7368f6539edf8867faeea4b94fedf2afd4565b91105
**GravityRAT**
G1
    9f30163c0fe99825022649c5a066a4c972b76210368531d0cfa4c1736c32fb3a
G2
    1993f8d2606c83e22a262ac93cc9f69f972c04460831115b57b3f6244ac128bc
G3
    99dd67915566c0951b78d323bb066eb5b130cc7ebd6355ec0338469876503f90
GX
    1c0ea462f0bbd7acfdf4c6daf3cb8ce09e1375b766fbd3ff89f40c0aa3f4fc96
**C2服务器**
    hxxp://cone[.]msoftupdates.com:46769
    hxxp://ctwo[.]msoftupdates.com:46769
    hxxp://cthree[.]msoftupdates.com:46769
    hxxp://eone[.]msoftupdates.eu:46769
    hxxp://etwo[.]msoftupdates.eu:46769
    hxxp://msupdates[.]mylogisoft.com:46769
    hxxp://coreupdate[.]msoftupdates.com:46769
    hxxp://updateserver[.]msoftupdates.eu:46769
    msoftupdates[.]com
    msoftupdates[.]eu
    mylogisoft[.]com
URI：
    /Gvty@/1ns3rt_39291384.php
    /Gvty@/newIns3rt.php
    /Gvty@/payloads
    /Gvty@/ip.php
    /G3/ServerSide/G3.php
    /G3/Payload/
    /GX/GX-Server.php
    /GetActiveDomains.php