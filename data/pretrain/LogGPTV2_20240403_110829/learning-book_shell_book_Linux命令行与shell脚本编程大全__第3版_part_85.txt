you wlsh to delete from the syatem? [y/n]
Ia Consultant the user account
Please ansver the question.
you wlsh to Gelete Erom the syatem? [y/n] 
Ie Consultant the user account
I found thls record:
Consu1 tant :x: 504 :506: : /home/Consu1tant : /b1n/baah
Is this the correct User Account? [y/n] yes
Step #2 - Find process on syaten belonging to user account
Consultant haa the followlng processea running:
PID PTY
TIME CMD
5443 pts/0
00 :00 : 00 bash
5444 pts/0
00 : 00 : 00 s1eep
Hould you 1lke me to ki1l the process (eal? [y/n] 董e@
K1lling off process [es) ...
Procesa (eal ki1led.
Step 3 - Pind f1les on syaten belonging to user account
Creating a report of all flles owned by Consultant.
and then do one of cvo thinga:
It ia reconnended that you backcup/archive these files,
1) Delete the f1les
2) Change the files* ounerahip to a current user account.
Please wait. This may take a while...
Report La conplete.
:2xodex108ek
Congultant_P11ea_140902 xpt
Locatlon of report: /hone/Chrlatine
Step #4 - Remove usex account
Remove Conzultant*a account fron syates? [y/n] 
User account, Consultant, has been removed
---
## Page 552
24.3监测磁盘空间
537
Consultant_11ea_140902.rpt
S 1s Consultant*.xpt
S cat Consultant_Fi1es_140902.rpt
home /Consultant
/home /Consu1t.ant./Pro7ect_393/393_reviα1on0 -py
home /Consultant/Pxoect_393
Ad*teutac6c/t6cso(oxg/ueansoo/so/
 - - . ]
/vax/apoo1 /ma11 /Conault.ant
home /Consultant/ -bashxc
S gzep Consultant /etc/passvd
脚本运行良好！注意，我们是使用sudo来运行脚本的，因为期除账户需要超级用户权限
另外还通过延迟回答下列问题测试了read的超时功能。
you wish to delete [rom the syaten? [y/n]
Is Consultant the user account
Please anawer the question.
我们在不同的向题中使用了不同形式的yes进行回答，以确保case语句的测试功正常。最后，
脚本找出了用户Consultant所有的文件，并将其写入报告文件中，然后删除了该用户。
现在你已经拥有了一个在删除用户账户时能够辅助你的脚本实用工具。更妙的是你还可以修
改它来满足组织的需要！
24.3监测磁盘空间
对多用户Limux系统来说，最大的一个问题就是可用磁盘空间的总量。在有些情况下，比如
在文件共享服务器上，磁盘空间很可能会因为一个租心的用户而被立刻用完。
24
空间被填满。应该考虑使用磁盘配额。如果已经安装了quota软件包，可以在shell提示符
下输入man-kquota获得有关磁盘限额管理的更多信息。如果没有安装这个软件包，可
以使用任何你喜欢的报索引学获取进一步的信息。
以日期命名的报告，使得磁盘空间使用量可以监测。
24.3.1需要的功能
你要用到的第一个工具是du命令（参见第4章）。该命令能够显示出单个文件和目录的磁盘使
用情况。-s选项用来总结目录一级的整体使用状况。这在计算单个用户使用的总体磁盘空间时很
---
## Page 553
538
第24章编写简单的脚本实用工具
方便。下面的例子是使用au命令总结/home目录下每个用户的SHOME目录的磁盘占用情况。
$ sudo da -s /hone/*
4204
[sudo] passuord for Christine1
/home/Christine
52
5 6
/home/Development
/home/Consultant
96
/home/NoSuchUser
36
/hone/Sanantha
1.024
/hone/user1
/home/Tinot.hy
$
-s选项能够很好地处理用户的SHOME目录，但如果我们要查看系统目录（比如/var/log）的
磁盘使用情况呢？
$ sudo du -s /var/log/*
/var/1og/anaconda. ifcfg. log
2 0
/var/1og/anaconda. 1og
32
/var/1og/anaconda,progran. 1og
1.08
/var/1og/anaconda. at.orage. 1og
56
4 0
/var/1og/anaconda. ays1og
1.16
/var/1og/anaconda.yum Log
/var/1og/anaconda.x1og
4392
/var/1og/audit
/var/1og/boot 1og
[.-. ]
这个列表很快就变得过于碎。这里，-S（大写的S）选项能更适合我们的目的，它为每个
目录和子目录分别提供了总计信息。这样你就能快速地定位问题的根源。
$ sudo du -8 /var/1og/
/var/1og/ppp
3020
4
/var/1og/sssd
/var/1og/sa
80
/var/1og/samba/old
/var/1og/pre1ink
4
/var/1og/samba
/var/1og/ntpstat8
4
/var/1og/cups
4392
/var/1og/audit
420
/var/1og/gdm
152
4
/var/1og/ConsoleKit
pdu/oT/reA/
2976
/var/1og/
$
由于我们感兴趣的是占用磁盘空间最多的目录，所以需要使用sort命令对au产生的输出进
行排序（参见第4章）。
sudo du -s /var/log/ 1 sort -rn
3020
26
/var/1og/audit
/var/1og/8a
---
## Page 554
24.3监测磁盘空间
539
2976
/vax/1og/
420
152
/var /1og/ConsoleKt
/var /1og/gdn
08
/var/1og/pre1ink
/var/1og/sanba/o1d
/var /1og/sssd
/var/1og/sanba
/var/1og/ppp
/var/1og/ntpat.at.a
/var/1og/httpd
/var/1og/cupa
n选项允许按数字排序。-r选项会先列出最大数字（逆序）。这对于找出占用磁盘空间最多
的用户很有用。
sed编辑器可以让这个列表更容易读懂。我们要关注的是磁盘用量的前10名用户，所以当到
了第11行时，sed会删除列表的剩余部分。下一步是给列表中的每行加一个行号。第19章演示过
如何使用sea的等号命令（-）来加人行号。要让行号和磁盘空间文本位于同一行，可以用n命令
将文本行合并在一起，跟我们在第21章中的处理方法一样。所需的sed命令如下。
sed ′ (11, $D; =) ′1
sed ·N; s/n/ /* |
现在可以用gawk命令清理输出了（参见第22章）。sed编辑器的输出会通过管道输出到gawk
命令，然后用printf函数打印出来。
.(u。 c$ .3。2$ -3\。 .。 [s 1auTxd) 。xne6
在行号后面，我们加了一个冒号（：），还给输出的每行文本的字段间放了一个制表符。这样
就能得到一个格式精致的磁盘空间用量前10名的用户列表。
1/Bot/aea/ g- np opns S
> sed (11,$D; =)′ ↑
> sort -rn |
>gawx *(pxintr $1 *:**\t* $2 ")t* $3 *\a*)*
> sed 'B; s/\n/ /' I
24
[sudo] password for Chriatlne:
1 :
4396
3024
/vax/1og/audLt
2 :
/vax/1og/sa
3 :
2976
420
/vax/1og/
1.52
/vax/1og/Conso1eK1t
/vax/1og/gdn
5 :
6
80
/vax/1og/pxe11nk
7 :
4
/vax/1og/sanba/01d
/vax/1og/sssd
8:
9 :
4
/vax/1og/ppp
/vax/1og/aanba
10 :
现在你已经上手啦！下一步就是用这些信息创建脚本。
---
## Page 555
540
第24章编写简单的脚本实用工具
24.3.2创建脚本
为了节省时间和精力，这个脚本会为多个指定目录创建报告。我们用一个叫作
CHECK_DIRECTORIES的变量来完成这一任务。出于演示的目的，该变量只设置为包含两个目录。
CHECK_DIRECToRIES=* /vax/1og /hone*
脚本使用for循环来对变量中列出的每个目录执行du命令。这个方法用来读取和处理列表中
的值（参见第13章）。每次for循环都会遍历变量CHECK_DIRECTORIES中的值列表，它会将列表
中的下一个值赋给DIR_CHECK变量。
for DIR_CHECK In $CHECK_DIRECTORIES
[.-.]
XoIoS s- np
[·- · ]
Gone
为了方便识别，我们用date命令给报告的文件名加个日期藏。脚本用exec命令（参见第15
章）将它的输出重定问到加带日期截的报告文件中。
DATE=S (Gate +finlid&y*)
exec > diak_space_SDATE,rpt
为了生成格式精致的报告，这个脚本会用echo命令来输出一些报告标题。
,ofesa aoedg xeta uat dou. ogos
现在让我们看一下将这个脚本的各部分组合在一起会是什么样子。
#1/bin/bash
Paranetera for Scxipt
CHECK_DIRECToRIES=* /var/1og /hone* #DLrectorlea to check
##**###*#** ain Script ####*#####*#*###*#*####*####
DATE=S IGate *+lntdly )
Date for report Cile
exec > dlsk_apace_sDwTg,xpt
#Make report flle STDOUT
echo *7op Ten DLak Space Usage*
xepeau 1zodeg#
fox DIR_CHECK in SCHECK_DIRECTORIESLoop to du dlrectoriea
do
echo **
 Create a llating of top ten dlak space usera In this dir
---
## Page 556
24.3监测磁盘空间
541
du -S $DIB_CHECK 2>/dev/nu11 1
1 ,(= fαs), pes
soxt -rn I
[u. ES 1. z$ a). <+. [$ aua) . xxef
sed 'N; a/(n/ /* |
done
#End of loop
#
exlt
现在你已经得到完整的脚本了。这个简单的shell脚本会为你选择的每个目录创建一个包含日
期截的磁盘空间用量前10名的用户报告。
24.3.3运行脚本
在让Big_Users脚本自动运行之前，你会想手动测试几次，以保证它如你期望的那样运行。
如你所知，在测试前必须为脚本文件设置适合的权限。不过在这里我们使用了bash命令，chmcd
u+x就不需要了。
S 1s -1 Big_Users.sh
rv-r--r--, 1 Chrlatine Chxiatine 910 Sep 3 08:43 Big_Usera.sh
S sudo bash Big_Users .sh
[sudo] passuord for Christine:
S 1s Giak_apace*,xpt
dl.sk_space_090314.rpt
S cat disk_apace_090314.rpt
Top Ten Diak Space Usage
Cor
/vax/log /hone Directorles
The /var/log Directory:
1 :
4496
3056
/vax/1og/audLt
2 :
3032
/vax/1og
3 :
/vax/1og/sa
24
4 :