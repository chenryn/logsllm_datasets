如果DNS发送一些非递归请求，
2.配置错误测试
更加详细的信息可以到 DNSenum 目录下查看 output_log 日志文件。和 DNSenum 具有
注意：
#dnstracerwww.test.com
mx1.test.com
Mail (MX) Servers:
Host's addresses:
DNSenum.pI VERSION:1.2.2
#/dnsenum.pl-f dns_1log -dnsserver 202.108.22.222 test.com -o output_log
ns2.test.com
DNS.test.com
NameServer:
test.com
test.com
Netcraft Services
Resultsfor netcraft.com
Explore1,871,692
SearchWebby Domain
4.searchdns.nete
2.upie.etraft.com
Found12sites
86400
86400
600IN
600IN
图4-2Web诊断方式
，如果域名服务器知道，
INA61.135.160.xx
A
.com
ntains
sites
A
61.135.160.xx
220.181.114.xx
220.181.111.xx
202.108.22.xx
ple
netcra.com
助
?
august2004
may2003
june2004
First seen
Metbo
etcralt
，那么它会返回请求数据。如果
746036netrat
15hMarch2013
Binux
品
---
## Page 168
缓存。
数处理的查询，使服务器后台程序退出，造成事实上的拒绝服务。
例，可以得到如下结果：
包括DNS服务器软件的漏洞。从中可以检索出BIND中普遍存在的漏洞。以BIND9.4.0为
4.3.2BIND漏洞
UDP Flood、TCPFlood 、Flood、ScriptFlood 等。
源。因此，拒绝服务攻击又称为“洪泛式”攻击。常见的DDoS攻击手段包括SYNFlood、
向受害主机，从而把合法用户的网络包淹没，导致合法用户无法正常访问服务器的网络资
务攻击（DDoS）的危害最为严重。DoS/DDoS攻击一旦实施，攻击网络包就会如洪水般涌
效的IP地址，攻击者可以获取对网络的访问权，并毁坏数据或执行其他攻击。贝主到百
IP地址，使得这些数据包看起来像是来自网络中的有效IP，这通常也称为IP欺骗。通过有
率将达到最大值，DNS服务器的服务将变得不可用。
务器充满递归查询，而拒绝提供网络服务的情况。当DNS服务器塞满查询时，其CPU使用
一旦有客户查询，DNS服务器将会直接返回缓存中的记录。
常见的Linux下DNS服务器攻击主要有以下几种方式：
的DNS服务瘫痪，整个网络的域名解析将受到严重影响，给网络用户访问网站带来麻烦
Server）三种。Linux下的 DNS 服务器在网络中往往担当着极其重要的角色。一旦 Linux下
服务器（Cache-onlyServer）、主服务器（PrimaryNameServer）和辅助服务器（SecondName
4.3.1Linux下DNS面临的威胁
事件，也表明了DNS的重要性。接下来详细介绍一下Linux系统下应对DNS 攻击的策略。
在UNIX/Linux系统里提供DNS服务的是DNS服务器。DNS服务器可以分为高速缓存
网事件，就是由于“DNSPod”遭到网络攻击造成的。8个月后，2010年1月12日百度被黑
全在CVE（CommonVulnerabilities andExposures）中存储着已知的信息安全漏洞，其中也
（3）数据修改（或IP欺骗）。数据修改是指攻击者使用自己创建的IP数据包中的有效
工域名系统被设计为开放式协议，因此很容易受到攻击。例如2009年5月19日的六省断
（2）拒绝服务攻击（DoS）。拒绝服务攻击是指攻击者试图使网络中一个或多个DNS服
4.3DNS Flood Detector 让 DNS 更安全
（3）CVE-2007-2926。使用弱的随机数生成器生成DNS序列号，攻击者容易猜测下一个
（2）CVE-2007-2925。默认情况下，BIND9.4.0开放递归，允许攻击者递归查询和查询
（4）CVE-2008-0122。在inet_network函数中存在差一错误（offby one error）。攻击者通
（1）DNS欺骗。在DNS 缓存还没有过期之前，对于在DNS缓存中已经存在的记录
（4）重定向。攻击者能够将DNS名称查询重定向到攻击者控制的服务器，实施攻击。
在DNS服务器面临的几类威胁中，针对DNS的拒绝服务攻击（DoS）和分布式拒绝服
第4章DNS系统故障分析145
---
## Page 169
就拥有SYNFlood“免疫力”的基于DNS解析的负载均衡。基于DNS解析的负载均衡能将
4.3.4应对DNSFlood攻击
息系统完全正常的情况下面对危险而束手无策。8
不均衡、地区时间差、缺少理性沟通机制等诸多因素，都可能导致国内互联网站点在自身信
击，因为攻击点位于域名所有者可控范围之外，而由于DNS 体系的特点、DNS管理权利的
从实际情况来看，利用管理漏洞进行的攻击无疑是具有全局威胁、难以响应防范的一种攻
性，以及DNS 缓存攻击、拒绝服务攻击的威胁，而对域名业务体系的安全性关注不够。而
中这次攻击事件给予人们很多警示。过去安全业界仅是更多地关注根域名服务器的安全
这些域名的访问全部被误导到其他站点。
篡改权威域名服务器地址记录，使其指向攻击者控制的服务器。
服务商，以及双方联系人的电子邮箱。近
事故原因是域名注册服务商中的百度域名信息被篡改。推测攻击者的攻击过程如下：（）
况，百度主页、二级页面访问都出现异常，在较长的时间全部被解析到其他主机。分析认为
2010年1月12日上午7时起，中国大部分地区和欧美部分地区出现百度无法正常访问的情
一近年来，国内外发生了一系列域名注册攻击事件，其中比较有名的是百度域名被劫持。
或者潜在地影响DNS系统的有效运行，降低系统的可用性。
DNS系统上存在大量的管理和配置错误。这些漏洞或者被攻击者利用直接进行DNS攻击，
对一般管理员来说，要想完全正确配置DNS这样复杂的分布式系统并不容易。因此，
4.3.3DNS管理
求端。
已经存在的域名，攻击者可以通过伪造NXDOMAIN响应并在其中添加已认证标志来欺骗请
记录时，该响应不会被正确地处理，附加段中伪造的记录会被添加到缓存中。）
求，攻击者伪造响应并在附加段中注入精心构造的数据。当服务器正在等待一个DNSSEC
更新消息中添加一个ANY类型的记录可以引起服务器拒绝服务。
的确认。日
返回的结果，攻击者可以通过一个对DSA和ECDSA密钥的畸形SSL/TLS签名绕过认证链
过发送精心制作的引起内存紊乱的查询，能够进行拒绝服务攻击或者在服务器端执行任意
代码。
146UNIX/Linux网络日志分析与流量监控
网络中的单一DNS 服务器往往难以应对 DNS 的“洪泛式”攻击，因此，可以采用本身
（2）攻击者破解百度联系人的邮箱，修改邮箱密码，取得完全控制权。
超（1）攻击者获取目标域名注册信息。访问WHOIS数据库，得到baidu.com域名的注册
！（4）攻击者在自己控制的服务器上任意伪造百度域管理下的域名的IP地址。客户端对
（3）攻击者通过该邮箱向域名注册服务器商发送邮件，修改百度域名注册信息，主要是
。（6）CVE-2009-0696。当服务器配置成一个主域名服务器时，攻击者通过在伪造的动态
（8）CVE-2010-0097。BIND9.4.0无法正确验证DNSSEC中的NSEC3记录，对于一个
（7）CVE-2009-4022。开启DNSSEC验证的情况下，攻击者诱导服务器发出递归查询请
（5）CVE-2008-5077。OpenSSL0.9.8及更早的版本不会正确验证EVP_VerifyFinal函数
---
## Page 170
网络数据包捕获函数，大多数网络监控软件都以它为基础。
可以从http://www.adotout.com/dnsflood-1.20.tgz下载，最新版本为1.20。
4.3.5
bindsnap模式则可以得到几乎实时的查询状态。
bindsnap 模式两种。其中，daemon 模式会通过 syslog 发出警告（/var/log/messages）;
Detctor会监控网络中DNS服务器查询名称解析的数量，它的工作模式包括daemon模式和
式”攻击，并及时地向系统管理员发出警报，或者将异常情况记录到日志文件中。
下侦测网络中对DNS服务器的请求流量，从流量异常中判断DNS服务器是否遭受到“洪泛
使用DNS查询功能的情况。DNSFloodDetector的工作原理是，利用libpcap在非混杂模式
必要的措施。
能够使网络管理员更好地对DNS服务器进行有效保护，及时发现“洪泛式”攻击，并采取
询请求异常对系统管理员来说十分重要。在单一的 DNS 服务器中部署DNS FloodDetector
采用基于DNS 解析的负载均衡技术成本很高。对于小型网络来说，如何更快地发现 DNS 查
迹，因为 DNS 请求不同于 SYN 攻击，是需要返回数据的，所以很难进行 IP 伪装。然而，
增加了攻击者的成本，另一方面，过多的DNS请求可以帮助管理员追查攻击者的真正踪
攻击者能够不断进行DNS请求，从而打破这种“退让”策略，但是，一方面，这样的做法
用户的请求分配到不同IP的服务器主机上，攻击者攻击的永远只是其中一台服务器。虽然
DNSFloodDetector是针对DNS服务Flood攻击的侦测工具，主要用来侦测网络中恶意
DNS FloodDetector 主要监控网络中DNS服务器查询名称解析的数量。DNSFlood
范例1：
-h显示帮助。
-v显示详细的输出信息，如果使用--v参数，将会获得更多信息。
-b以前台模式执行。
-m N 每隔N 秒显示所有状态。
-xN创建N个bucket。
-wN每隔N秒显示的状态
-aN经过N秒后重置警示。
-tN当每秒查询数量超过N值时发出警告。
-iIFNAME监听某一指定的界面（接口）。
DNS Flood Detector的基本用法如下：
2.应用DNSFloodDetector
DNS Flood Detector可应用在Linux、MacOS X、Solaris9和FreeBSD 等操作系统中。
-d以背景模式执行。
其中，参数（option）具体描述如下：
1.获得DNSFlood Detector
DNS Flood Detector保安全
#./dns_flood_detector [option]
第4章DNS系统故障分析147
---
## Page 171
及时对系统管理员提出警报。
对 DNS 服务器的请求流量，从流量异常中判断 DNS 服务器是否遭受到了“洪泛”攻击，并
中恶意的 DNS 查询功能，它的工作原理主要是利用了 libpcap 在非混杂模式下，侦测网络中
PTR（指针）和MX（邮件交换）记录等。运行结果如下：
148UNIX/Linux网络日志分析与流量监控
中国计算机应急响应中心：http://www.cert.org.cn。
互联网系统咨询协会公告：http://www.isc.org/。
美国计算机应急响应组：http://www.kb.cert.org/vuls/。
下面是DNS系统管理员必须浏览的三个关于DNS 漏洞的网站：
以上详细介绍了 DNS FloodDetector这款侦测工具的使用，
以前台模式执行，每隔 20s 显示所有状态。运行结果如下：
以前台模式执行，记录每秒超过10次查询的记录，显示最多信息，包括A（地址）、
#./dns flood detector-b-m20
#dns_flood _detector-b-m20
[15:15:16]source [10.32.1.45] -0 qps tcp:23 qps udp [7 qps A] [15 qps PTR]
[15:14:56]source[10.32.1.45] -0 qps tcp:24 qps udp [8 qps A] [16 qps PTR]
#./dnsflooddetector-v-v-b-t10
#dns_flood_detector-v-v-b-t10
[1:00:10]totals -0 qps tcp:12qps udp
[10:59:50jtotals-0 qps tcp:15qps udp
[10:59:30]totals-0qps tcp:1qps udp
[10:58:50]totals -0 qps tcp:8 qps udp
[15:14:56]source [10.0.24.2] -0 qps tcp:15 qps udp [15 qps A]
，了解到它主要用来侦测网络
中
15效
---
## Page 172
期间，经规整化处理的路由器日志。
可疑的记录。
墙日志和路由器日志。打印出了那台服务器出问题时的记录，并过滤掉正常的流量，保留下
线索。这时，部门经理告诉小杨，他已经接到客户的投诉电话，说无法访问他们的网站。
收到了邮件报警，可以判断服务器出现了状况。
习惯性地检查了Web服务器。Web服务器的流量监控系统显示下行的红色曲线，与此同时
日，走
事件背景
攻击进行积极防御的过程。
日志，并配合已有的流量监控系统数据，调查经过伪装的IP地址，通过多种手段对DDoS
据包由于不能被服务器接收而丢弃。下面的案例就属于这两种情况。
源。带宽耗尽主要指攻击者发送的大量数据包淹没服务器，堵塞服务器网络接口，使正常的数
法对外提供正常服务。DoS攻击对服务器端的危害主要表现为耗尽服务器的带宽资源和计算资
网站、在线交易网站、企业门户和电子政务系统等重要系统发出大量的数据包，使目标主机无
算机停止提供服务的攻击，都是拒绝服务攻击。攻击者通过对互联网上的网站、各类信息门户
5.1
他在路由器日志上做了同样的工作并打印出看上去异常的记录。表5-1是网站遭受攻击
在Web服务器的日志文件中没有发现任何可疑之处，因此接下来小杨仔细查看了防火
根据上述问题，小杨马上开始核查Web服务器的日志，尝试发现一些关于引起中断的
难度系数：★★★
本案例描述了某网站受到拒绝服务攻击后，管理员小杨对比防火墙正常/异常状态下的
春节长假刚过完，小杨公司的Web服务器就出了故障。下午1点，吃完饭回来，小杨
春节长假对于IT人员来说是个短暂的休整时期，可IT系统却一刻也不能停，越是节假
拒绝服务攻击（Denial ofService）是攻击者经常采用的一种重要攻击形式，凡是使目标计
越可能出大问题。
故事人物：小杨（网管）
关键日志：防火墙日志、
10.18.18.18
172.16.45.2
源IP地址
案例四：网站遭遇DoS攻击
第5章 DoS防御分析
，下面要讲述的就是一起遭受DoS攻击的案例。
192.168.0.175
192.168.0.175
目的IP地址
路由器日志
表5-1防火墙日志统计
源端口号
7843
6
目的端口号
议
---
## Page 173
所示：
150
为了得到参考基准，
为了获取更多信息，小杨接着查看了路由器中NetFlow 交换的综合统计信息。详情如下
UNIX/Linux 网络日志分析与流量监控
Active flovs