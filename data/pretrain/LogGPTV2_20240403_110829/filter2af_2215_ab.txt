可以在background.js中调用chrome.webRequest.onBeforeRequest和chrome.webRequest.onBeforeSendHeaders来抓取chrome的网络请求。(具体做法可以参考  
)
这里需要注意的是任何函数在background.js只要被调用，就会一直常驻在chrome后台。所以在用户点击停止任务之后，客户端一定要移除监听器。content-script.js和background.js之间的通行可以通过chrome.runtime.sendMessage函数。
## RESTful API
客户端将捕获到的网络请求封装之后会发送到RESTful
API服务端，服务端会解析请求并判断请求中的待检测接口是否属于合法白名单范围(例如白名单为测试环境网段，防止向生产环境写入脏数据)。在通过白名单检测之后，会推送到rabbitmq中等待分析引擎节点消费。
## 分析检测引擎
在每次新建任务时，客户端会向RESTful
API发送一条包含新建任务标识和正则匹配规则的消息。同理在每次结束任务时也会发送一条带有结束任务标识的消息。分析检测引擎在消费到结束任务标识之后会通过邮件等方式通知相关人员。
因为SQL注入检测和XSS检测相对需要较久的时间，所以决定通过Fanout
Exchange模式绑定到单独的queue。通用类的漏洞（大型CVE、服务弱口令等）检测往往不需要太久的时间，可以直接放入到一个queue。整个扫描引擎是采用POC插件形式，在后续漏洞检测拓展方面比较灵活。网上关于此类的文章很多，这里不做展开。我将会重点讲下检测存储型XSS方面的思路。
## 存储型xss的检测
反射型/DOM 型XSS检测可以利用后端的chrome headless进行检测。检测xss的思路为:
  1. 监听页面的弹窗事件
  2. 查看页面中是否有新建立的标签
具体的实现由于篇幅较长，网上也有很多资料，故这里不打算展开。猪猪侠在先知白帽大会分享的web2.0启发式爬虫实战详细地提到过检测反射/DOM
xss检测原理。
反射型XSS的输入和输出在同一个网页中，可以直接构造检测。但是对于存储型XSS(这种输入和输出位置分开的情况)直接检测并不一帆风顺，难点在于XSS检测引擎并不知道具体的输出位置。可以利用客户端是浏览器插件这一特性，让其具备检测XSS的能力。
客户端(浏览器插件)除了具有捕获网络请求并发送到服务端RESTful
API的功能，还有另外一个功能就是检测当前网页中是否触发了XSS。客户端会去分析质量测试工程师打开的网页中是否触发已经提前构造的(由后端的chrome
headless 检测时插入的污染字符)payload。客户端在检测到payload之后会向RESTful
API发送一条检测到XSS的消息，其中包含具体的输入位置(payload中包含输入请求的requestid)。
通过chrome headless后端检测反射性/DOM型XSS，客户端检测存储型XSS这两种方式可以基本覆盖到所有XSS类型的漏洞检测。
既然客户端是基于浏览器插件开发而成，那么将赋予了我们更多的想象力和可能性。这里脑洞开一下，比如在检测到漏洞之后利用插件自动截图或者生成小视频并发送到服务端进行保存，以便后续更加方便的复盘、查阅。
## 使用实践
在每次新建任务的时候，用户需要配置正则抓取规则、抄送邮件、任务名称。
配置完成之后，质量测试工程师进行正常的接口测试即可。在每次扫描结束之后，用户可以自行登录hunter后台进行查看历史扫描记录。如果质量测试同学对漏洞信息感兴趣，可以单独查看每一条漏洞详细信息。
Hunter现已开发完成并在公司内部推广使用，同时发现质量测试工程师在检测出漏洞之后会表现出前所未有的亢奋(阴险脸)。
# 五.总结和展望
目前hunter能够发现除越权漏洞之外的所有常见web漏洞(关于越权检测我们团队有一些想法正在实践，如果您有兴趣的话可以投简历，加入我们团队和我们一起探讨哦！)。未来的工作是不断增加扫描插件、加强线上运营、结合内部权限系统进行越权漏洞方面的检测。希望能够通过多种维度的扫描和检测尽可能将安全风险在上线之前扼杀。很多质量测试同事在使用hunter发现漏洞之后对信息安全兴趣高涨，我们也会挑选经典的案例整理成wiki提供给感兴趣的同事查阅。未来我们计划将hunter系统开源，希望能够帮助到更多的企业。
# 六.参考资料
Chrome extensions 开发文档  
WEB2.0启发式爬虫实战  
# 关于中通安全团队
中通信息安全团队是一个年轻、向上、踏实以及为梦想而奋斗的大家庭，我们的目标是构建一个基于海量数据的全自动信息安全智能感知响应系统及管理运营平台。我们致力于支撑中通快递集团生态链全线业务（快递、快运、电商、传媒、金融、航空等）的安全发展。我们的技术栈紧跟业界发展，前有
React、Vue，后到 Golang、Hadoop、Spark、TiDB、AI
等。全球日均件量最大快递公司的数据规模也将是一个非常大的挑战。我们关注的方向除了国内一线互联网公司外，也关注 Google、Facebook、Amazon
等在基础安全、数据安全等方面的实践。
# 加入我们
如果您对我们的团队或者我们做的事有兴趣，也希望在工程技术领域有所成就，非常欢迎加入我们，我们需要信息安全、分布式平台开发、大数据、风控、产品、运营等方面的人才，Base上海，工作地点任选虹桥万科中心及中通总部。简历投递地址：PI:EMAIL。  
[具体职位信息点击参考](https://c.eqxiu.com/s/4JKQw0La?share_level=3&from_user=a670e749-b090-4965-8cc1-068b60f228ae&from_id=eb32ff18-ce5a-4a0a-b949-45565a922bca&share_time=1535512020427&from=timeline&isappinstalled=0
"具体职位信息点击参考")