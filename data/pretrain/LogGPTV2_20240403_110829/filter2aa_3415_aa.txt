1
BRING YOUR OWN PRINT DRIVER VULNERABILITY
Jacob Baines
7 August 2021
2
AGENDA
Background
Research
Print Driver 
Installation
BYOPD 
Exploitation
Detection & 
Mitigations
3
SLIDES & CODE AVAILABLE
https://github.com/jacob-baines/concealed_position
4
SPEAKER INTRODUCTION
Jacob Baines
Vulnerability Researcher
     @Junior_Baines
   jacob-baines
5
BACKGROUND: PREVIOUS PRINTER VULNERABILITIES
6
BACKGROUND RESEARCH
RICOH PRINT DRIVER VULNERABILITY
• CVE-2019-19363
• Full disclosure by Pentagrid
• Metasploit module by Shelby Pace
• Privilege escalation to SYSTEM via %PROGRAMDATA% DLL 
overwrite during printer install.
• Driver must be installed on the system.
7
BACKGROUND RESEARCH
PRINTDEMON
• CVE-2020-1048
• Technical write up by Yarden Shafir and Alex Ionescu
• Metasploit module by Brendan Watters
• Arbitrary file write as SYSTEM by printing to a printer 
with attacker controlled file port
8
BACKGROUND RESEARCH
PRINTDEMON PATCH BYPASS
• CVE-2020-1337
• Technical writeup by Voidsec
• Metasploit module by Brendan Watters
• Bypasses the patch by altering the file port to use a 
junction after permissions have been checked
https://attackerkb.com/topics/mEEwlfrTK3/cve-2020-1337
9
BACKGROUND RESEARCH
EVIL PRINTER
• CVE-2020-1300
• Presented at DEF CON 28 by Zhipheng Huo and 
Chuanda Ding.
• Technical writeup of CAB parsing  by ZDI (no PoC)
• Local privilege escalation.
• Path Traversal in CAB file. Delivered by a remote printer 
or local admin
https://twitter.com/steventseeley/status/1323694078022848512
10
EXECUTING EVIL PRINTER
11
EVIL PRINTER
ATTACK OVERVIEW
1.
Add Printer
2. Send malicious CAB file
3. Unpack CAB
12
EVIL PRINTER
PRINTER SIDE: CREATING THE CAB
> echo “ualapi.dll” “../../ualapi.dll” > files.txt
> makecab /f files.txt
> move disk1/1.cab exploit.cab
ualapi.dll reference: https://enigma0x3.net/2019/07/24/cve-2019-13382-privilege-escalation-in-snagit/
13
EVIL PRINTER
PRINTER SIDE: DLL SOURCE
https://github.com/jacob-baines/concealed_position/blob/main/src/cp_payload/dllmain.cpp
14
EVIL PRINTER
PRINTER SIDE: BECOMING A PRINTER
1. Install CutePDF Writer
2. Set the CutePDF Writer as a shared printer
3. Turn off password protected sharing (Advanced Sharing)
4. Turn on printer sharing (Advanced Sharing)
5. Modify the following registry values in 
HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Print\Environments\Windows\x64\Dri
vers\Version3\CutePDF Writer v4.0
a. PrinterDriverAttributes = 1
b. InfPath = C:\exploit\exploit.inf
6. Create an empty file at C:\exploit\exploit.inf
7. Copy exploit.cab to C:\Windows\System32\spool\drivers\x64\PCC\
8. Reboot
15
EVIL PRINTER
CLIENT SIDE
16
EVIL PRINTER
CLIENT SIDE FILE DROPPED
17
EVIL PRINTER
CLIENT SIDE EXPLOITED
18
EVIL PRINTER
TRY YOURSELF!
19
EVIL PRINTER
STILL USEFUL?
https://twitter.com/R3dF09/status/1271485928989528064
20
INSTALLING A PRINT DRIVER
21
INSTALLING A PRINT DRIVER
REVISITING RICOH
• Reminder: CVE-2019-19363
• Race condition when 
AddPrinter is called.
• DLL are dropped into a directory 
in ProgramData.
• A low privileged user can 
overwrite the DLL.
• If timed correctly, 
PrinterIsolationHost.exe will 
load the attacker DLL as SYSTEM.
22
INSTALLING A PRINT DRIVER
RICOH DRIVER ONLY USEFUL WHEN AVAILABLE
23
INSTALLING A PRINT DRIVER
RICOH DRIVER ONLY USEFUL WHEN AVAILABLE
24
INSTALLING A PRINT DRIVER
NOT SO USEFUL WHEN UNAVAILABLE
25
INSTALLING A PRINT DRIVER
CAN IT BE INSTALLED?
• Obviously, can’t exploit a driver not on the system.
• But can a low privileged user install the vulnerable 
Ricoh print driver?
• How?
• Ricoh installer?
• Add printer UI?
• Powershell?
• printui.dll?
• prndrvr.vbs?
• WinAPI?
26
INSTALLING A PRINT DRIVER
USING THE RICOH INSTALLER?
27
INSTALLING A PRINT DRIVER
USING THE ADD PRINTER UI? 
28
INSTALLING A PRINT DRIVER
USING POWERSHELL?
Add-PrinterDriver -Name “PCL6 Driver for Universal Print” -InfPath
“C:\Users\lowlevel\Downloads\disk1\oemsetup.inf”
https://docs.microsoft.com/en-us/powershell/module/printmanagement/add-printerdriver?view=windowsserver2019-ps
29
INSTALLING A PRINT DRIVER
USING PRINTUI.DLL?
rundll32 printui.dll PrintUIEntry /ia /m “PCL6 Driver for Universal Print” /r 
“lpt1:” /f C:\Users\lowlevel\Downloads\disk1\oemsetup.inf
30
INSTALLING A PRINT DRIVER
USING PRNDRVR.VBS?
cscript.exe C:\Windows\System32\Printing_Admin_Scripts\en-US\prndrvr.vbs -a -m “PCL6 Driver for Universal Print” -v 3 
-e “Windows x64” -i C:\Users\lowlevel\Downloads\disk1\oemsetup.inf
31
INSTALLING A PRINT DRIVER
USING THE WINAPI?
https://docs.microsoft.com/en-us/windows/win32/printdocs/installprinterdriverfrompackage
32
INSTALLING A PRINT DRIVER
AS A LOW LEVEL USER
How do we get a print driver 
into the driver store?!
33
STAGING A PRINT DRIVER
34
STAGING A PRINT DRIVER
WHAT IS THE DRIVER STORE?
• From Microsoft’s Drive Store documentation:
Starting with Windows Vista, the driver store is a trusted collection of 
inbox and third-party driver packages. The operating system maintains this 
collection in a secure location on the local hard disk.
...
Before a driver package is copied to the driver store, the operating system 
first verifies that the digital signature is correct.
• The trusted location is C:\Windows\System32\DriverStore
• Copying a driver into Driver Store is called staging
35
STAGING A PRINT DRIVER
WHO CAN STAGE DRIVERS?
• Administrators
• pnputil.exe often the tool of choice.
36
STAGING A PRINT DRIVER
STANDARD USER CAN NOW USE THE DRIVER
Add-Printer -Name “lol” -DriverName “PCL6 Driver For Universal Print” -PortName “lpt1:”
37
STAGING A PRINT DRIVER
CAN SOMEONE ELSE STAGE DRIVERS?
38
STAGING A PRINT DRIVER
CAN SOMEONE ELSE STAGE DRIVERS?
From Microsoft’s Point and Print with Driver Packages 
documentation:
A print client that is connected to a print server can use point and print 
to copy an entire driver package for installation.
...
Driver signing and driver integrity are checked on the print client.
...
Driver package installation requires a driver store, which is not available 
on versions of Windows earlier than Windows Vista. 
39
STAGING A PRINT DRIVER
CAN SOMEONE ELSE STAGE DRIVERS?
An evil printer can stage a print driver!
1.
GetPrinterDriver
2. Send a packaged 
driver (CAB)
3. Add to Driver Store
40
STAGING A PRINT DRIVER
POC || GTFO
An evil printer can stage a print driver!
1.
GetPrinterDriver
2. Send a packaged 
driver (CAB)
3. Add to Driver Store
41
STAGING A PRINT DRIVER
CREATING A RICOH CAB
> dir /s /b /a-d > ../files.txt
> makecab /D MaxDiskSize=268435456 /d “CabinetName1=oemsetup.cab” /f ../files.txt
42
STAGING A PRINT DRIVER
CREATING A RICOH CAB
> dir /s /b /a-d > ../files.txt
> makecab /D MaxDiskSize=268435456 /d “CabinetName1=oemsetup.cab” /f ../files.txt
43
STAGING A PRINT DRIVER
RICOH CAB INTEGRITY
44
STAGING A PRINT DRIVER
CONFIGURE EVIL PRINTER WITH THE RICOH CAB
• Exactly like the CVE-2020-1300 attack
• To configure evil printer:
• Refer back to earlier slides for set up
OR
• Use the tool we’ll talk about shortly
45
STAGING A PRINT DRIVER
USING EVIL PRINTER TO STAGE
46
STAGING A PRINT DRIVER
USING EVIL PRINTER TO STAGE
47
STAGING A PRINT DRIVER
RICOH DRIVER IS STAGED
48