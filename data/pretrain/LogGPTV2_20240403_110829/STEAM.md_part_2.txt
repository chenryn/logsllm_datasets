Objective. Tomaximizebothcoverageandentropy,weformulate
ferentwithoutthelabeleddata[11,46,51].Intuitively,ittriesto
theproblemasfollows:selectasubsetoftracesfromthefullsetso
bringsimilargraphsclosetoeachotherandpushdissimilaronesto
thateachtraceinthesubsetexhibitsmaximumdissimilaritywith
befarapartintherepresentationspace.TypicallyinGCL,wefirst
constructtwographs𝑔 1,𝑔 2viarandommanipulation(e.g.,addor others.Inotherwords,eachsampledtraceshouldbeas"unique"
aspossible.Intuitively,iftracesinthesampledsubsetaremore
removeedges,dropnodes,andmaskfeatures)oftheinputgraph
𝑔.Thetwographsaresupposedtobesimilar,namely,positivein- dissimilar,theyshouldbelongtomoredistincttypes,leadingto
stances.Wethenselectanothergraphℎ fromthedatasetasthe highercoverageandentropy.However,therearetwoprimarychal-
negativeinstance,whichisassumedtobedifferentfromthegraph𝑔 lengestoaddress:1)Howcanthesimilaritybetweentwotracesbe
anditsvariants𝑔 1,𝑔 2.Thelearningobjectiveistominimizethedis- measured,giventhatmultipleperspectivesinthetracedataneedto
tancebetweensimilargraphs(𝑔 1and𝑔 2)andmaximizethedistance beevaluatedcollectively?2)Howcanasubsetoftracesbeselected
betweendissimilargraphs(𝑔 1andℎ).Inthisway,thegraphneural suchthateachtraceishighly"unique"withinthesubset?
networkaftertrainingcanrepresentgraphswithdiscrimination.
4 STEAMOVERVIEW
WepresentthedesignofSTEAMinthissection.Weimplemented
3 OBSERVABILITY-PRESERVINGTRACE
STEAMintoOpenTelemetrycollector[33],oneofthemostpopular
SAMPLING
tracingframeworks2,forreal-timetracesampling.Generallyin
We propose the observability-preserving trace sampling to keep productionsystems,therearemanyinstancesofcollectorstogether
asmuchinformationaspossibleaftersampling.Twometricsare consumingthetracingworkload.AsFig.2(bottom)shows,each
proposedtoquantitativelymeasurethesamplingeffectiveness. tracecollectorcomprisesthreecomponents:receiver,processor,
Coverage:Let’stakethetracefromtheperspectiveofoperation andexporter.Thereceiverreceivestracesfromtheunderlyingdis-
asanexample.Supposethereare𝑇 differenttypesofoperations tributedsystemandforwardsthemtotheprocessorfornecessary
in the original traces (before sampling) and𝑡 different types of manipulationsandsampling.Theresultedtracesarethenforwarded
operationsinthesampledtraces,thecoveragedenoteshowmuch tobackendssuchasElasticsearchintheexporter.Inthiswork,we
𝑡
percentageoftracetypesarekeptaftersampling,i.e.,𝑇.Thehigher mainlyfocusontheprocessorcomponent.AsFig.2shows,STEAM
coverageweobtain,themoreobservabilitythesamplingwould hastwophases:offlinetrainingandonlinesampling.
achieve.However,whendecidingwhetheratraceshouldbesam-
pled,therearemanyperspectivestoconsider,includingthetrace 2STEAMisgenericandcanalsobeintegratedintoothertracingframeworkssuchas
operation,structure,latency,statuscode,etc.Ideally,thecoverage JaegerandZipkin
1752
ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA ShilinHe,BotaoFeng,LiqunLi,XuZhang,YuKang,QingweiLin,SaravanRajmohan,andDongmeiZhang
Inofflinetraining (theblueboxarea),themainpurposeisto
prepareamodelwhichcanembedthetraceasarepresentation
vector.Weleveragethegraphneuralnetwork(GNN,seeSec.4.1)
andtrainthemodelbyincorporatingthedomainknowledgeof
comparingtraces.Thedomainknowledgeisformallydenotedby
logicclauses(Sec.4.2),whichcanalsobecustomizedbyusersif
needed.Byapplyingthelogicclausestothetracedata,wegener-
atethetracetripletsasthetrainingdata.Themodelarethenbe
trainedanddistributedautomaticallytoeachprocessor instance
foronlinesampling.Toavoidthepossibledatadriftissueduring
systemevolvement,wesupportthedynamicmodelupdate,i.e., Figure3:TheoverviewoftrainingtheGNNmodelwithtrace
automaticallycachethelatesttracesandthenretrainthemodel. knolwedgeincorporated.
Intheonlinesamplingphase(theorangeboxarea),tracesfrom
receiversareorganizedasbatchesinastreamingway.Thesam-
plerfirstconsumesabatchoftracesandgeneratestherepresenta- B(theupperone),whiletraceC(thebottomone)hasadifferent
tionvectorforeachtracebasedonthetrainedGNNmodel.Given structure.Hence,traceAismoresimilartotraceBthantraceC.
thetracerepresentation,thecoresamplingcomponentfastDPP Wenamethecombinationofthreetracesthatsatisfiestherelative
(Sec.4.3)thensamplesasubsetoftracesthatareasdissimilaras relation𝑆 𝐴−𝐵 > 𝑆 𝐴−𝐶 asatracetriplet,denotedby(A,B,C).By
possible.Thesamplingcomponentisbuiltontopofthedetermin- learningtheirrelativesimilarity,theGNNmodelshouldprecisely
isticpointprocess(DPP)whileitsefficiencyissueisaddressedby representthetracewithsimilarityinformationencoded.
ourdesignedfastDPPalgorithm.Atlast,thesampledtracesare Wetrainthemodelwiththetripletloss[3]byminimizingthe
forwardedtotheexporterforsubsequentpersistence. distancebetween𝐺 𝐴 withthepositiverepresentation𝐺 𝐵 while
maximizingthedistancewiththenegativeone𝐺 𝐶:
𝐿(𝐴,𝐵,𝐶)=𝑚𝑎𝑥{𝑑(𝐺 𝐴,𝐺 𝐵)−𝑑(𝐺 𝐴,𝐺 𝐶)+𝑚𝑎𝑟𝑔𝑖𝑛,0}
4.1 Graph-basedTraceRepresentation
where𝑑isthedistancemeasurementbasedonthecosine-similarity
Inthissection,weaimtoencodeeachtraceasarepresentationvec-
fortworepresentation(seebelow)and𝑚𝑎𝑟𝑔𝑖𝑛isafixedvalueto
torbasedonwhichwecandirectlycomputethesimilaritybetween
two traces. We propose to leverage the Graph Neural Network controlthegapoftwodistances.
(GNN)[44]modeltojointlyincorporatetherichtracestructureand 𝑑(x,y)=1− x·y
theabundantattributesinformationofeveryspannode,including ∥x∥∥y∥
servicename,operationname,status,latency,URLandIPaddress.
Byminimizingthetripletlosswithbackpropagation,themodel
Therepresentationvectoristhegraphembeddingcomputedby
notonlyincorporatestherichstructureandabundantattributes
aggregating(i.e.,weightedsum)informationfromallnodes.Specif-
informationbutalsolearnswhichtwotracesaremoresimilarin
ically,weleveragedthegraphisomorphismnetwork[45],aspecific
thetracetriplets.
GNN model that is powerful in distinguishing different graphs
basedontherepresentation.Sincetracesfromdifferenttracing 4.2 IncorporatingDomainKnowledge
frameworksusuallyfollowthesameW3Cstandards[41],wedo
WehavesofarintroducedhowtotraintheGNNmodel.Aremaining
notneedmuchfeatureengineeringeffortforseparatescenarios.
questionishowtopreparetracetripletsformodeltrainingwhile
AstandardwayoftrainingGNNisgraphcontrastivelearning
incorporatingthedomainknowledgeabouttracesimilarity.Inthis
(seeSec.2)whichtargetsatpushingclosesimilargraphswhile
section,wepresentalightweightandflexiblewaytoproducealarge
pushingawaydissimilargraphs.Itrequiresmanipulatingtheinput
numberoftracetriplets.Thecoreideaistoformallydefineaset
trace(e.g.,randomlyremovingnodesormaskingattributes),which
of“abstractrules”thatcanbeappliedtothetracedatatogenerate
howeveroftencreatestracesthatdonotevenexistintherealworld.
manytracetriplets.Therulesshoulddescribehowtocomparethe
Besides,themethoddoesnotconsidertheuniquecharacteristicsof
similarityamongthreetraces.Forexample,onemayconsider1)
tracedataincomparingtwotraces,e.g.,statuscodescouldbemore
“traceAandBsharethesamestructurewhileAandCdonot,so
importantthanlatencyvalues.Itisbecausethetwotracesshould
AismoresimilartoBthanC”or2)“A,B,andCsharethesame
belesssimilariftheirstatuscodesaredifferent(e.g.,200vs.404)
structure.ButthelatencyofAandthatofBarecloserthanAand
comparedwiththelatencydifference(e.g.,200msvs.400ms).
C,soAismoresimilartoBthanC”.
Toaddresstheseissues,weproposetotraintheGNNbasedon
Inspiredbylogicprogramming[25],weformallyexpressthe
realtracesandincorporatethetrace-specificdomainknowledge
domainknowledgewithlogicclauses.Alogicclausedefinesarule
(seeSec.4.2).Fig.3showsanoverviewofhowwetraintheGNN
thatcoulddeducetherelativerelationoftracetripletsifcertain
model.Theinputarethreetraces,andthetargetistopredicttheir
conditionsaresatisfied.Formally,alogicclauseiswrittenas:
relativerelation.Atfirst,theGNNmodel(parameterssharedby
alltraces)encodesthetraceA,B,andCasrepresentations𝐺 𝐴,𝐺 𝐵, 𝐻 ←𝑃 1∧𝑃 2∧...∧𝑃 𝑛
and𝐺 𝐶 separately.Thesimilarityforapairoftraces(e.g.,trace
anditslogicalimplicationis:
AandB)isthencomputedas𝑆 𝐴−𝐵 withcosinesimilarity.Inthis
example,traceA(themiddleone)hasthesamestructureastrace 𝐻𝑖𝑓 𝑃 1𝑎𝑛𝑑𝑃 2𝑎𝑛𝑑...𝑎𝑛𝑑𝑃 𝑛
1753
STEAM:Observability-PreservingTraceSampling ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA
where𝐻 istheconclusionandtheconjunction𝑃 1∧𝑃 2∧...∧𝑃 𝑛 LatencyDiff and redesign the logic clauses accordingly. Such a
isthebody oftheclause.Specifically,𝑃 𝑖 isthe𝑖-thpredicate(or designavoidsthepossibleconflictbetweendifferentlogicclauses
condition)thatcomparestwotracesintermsofaspecifictrace andenablesthefeasibilitytocustomizethelogicclausesforvarious
property,e.g.,whethertwotraceshaveexactlythesamestructure. scenariosanddemands.NotethatTable1providessomesamples
TakingFig.3asanexample,“traceAandtraceBhavethesame basedongeneraldomainknowledgeofcomparingtraces.Wealso
structure”canbeapredicate;similarly,“traceAandtraceChave allowtheeasyincorporationofotherknowledgebycustomizing
differentstructures”isanotherpredicate.Hence,theconclusionin thelogicclausesordefiningnewdifferencefunctions.
thislogicclauseis“AisclosertoBthanC”,denotedas(A,B,C). TrainingDataConstruction:Basedonthelogicclauses,we
ThelogicclauseispresentedasthefirstrowinTable1. canproducemassivetracetripletsasthemodeltrainingdata.The
Usually,atracecanbedescribedasatreestructure,whereeach workflowisasfollows:givenasetoftraces,werandomlypick
nodedenotesaspanwithattributessuchasservicename,span outthreetracesA,B,andCwithreplacementandthenapplythe
nameandlatency.Thecaller-calleerelationbetweentwospans logicclausestocheckwhethertheconclusionholdsonthethree
canbedenotedasapairofparent-childnodes.Forcomplextrace traces.Ifanylogicclauseholds,weobtainatracetripletof(A,B,
structure,itisnon-trivialandoftenad-hoctoexpressthe“abstract C);otherwise,thethreetracesareregardedinvalid.Wewillrepeat
rules”intermsofpredicates.Therefore,wedefineasetofdifference theprocessuntilsufficienttracetripletsareobtained.Atlast,we
functionsforsimplificationandeasyreuse.Adifferencefunction obtainthetracetripletsafterremovingtheduplicates.
specifiestowhatextenttwotracesaredifferentbasedonaspecific Theoretically,thereareupto𝑁3combinationsoftracetriplets
traceproperty.Theinputistwotraces,andtheoutputistheirdif- foragivensetof𝑁 traces.Itisintractabletolistallpossiblecom-
ferencevalue.Somepredefineddifferencefunctionsareasfollows: binations.Hence,wepickonlysomeofthetracestoassemblethe
tracetriplets.Toavoidthecasethatarandomlypickedsetoftraces
• StructureDiff: It measures whether two traces have the same
aremostlythesame(duetothelong-taildistribution),weadopt
structureornot(output:TrueorFalse).Thesamestructuremeans
aheuristicstrategy.Indetail,webucketizethetracesbyahash
thatforeverynodepositionintwotraces,thespannameand
functionproposedin[11]andfetchtracesfromeachbucketwithan
caller-calleerelationshouldbeexactlythesame.
inversedocumentprobability[40].Intuitively,themoretracesthat
• LatencyDiff: It measures the latency difference of two traces,
existinthebucket,thelowerchanceeachtracewouldbeselected
wherethetracelatencyistheend-to-endrequestduration.
intothetracetriplets.ThehashfunctioncomputesahashIDbyit-
• StatusDiff:Itmeasuresifthestatuscodesofthetwotracesare
eratingallspansofthetreestructurewithaDFSandincrementally
thesameornot.
hashingtheservicenameandspanname.
• LevelDiff:Wheniteratingspansfromtheroottotheleaflevelby
level(rootspanhaslevel0),sincewhichleveltwotracesbecome
different.Iftwotracesaredifferentatleveld,thendistheoutput. 4.3 RepresentativeSampling
• SpanNameDiff:Thisfunctionmeasuresthedifferencebetween
Basedontheobtainedtracerepresentation,thefollow-upstepisto
twotraceswithrespecttothespannames.Atlevel-d,wedenote
sampleasubsetoftracesthataremutuallydissimilar.Toachieveso,
thespannamesoftraceAasaset𝑆𝑆 𝐴 andthatoftraceBas
weresorttoDeterministicPointProcess(DPP)[4,19]samplingand