Objective. Tomaximizebothcoverageandentropy,weformulate
ferentwithoutthelabeleddata[11,46,51].Intuitively,ittriesto
theproblemasfollows:selectasubsetoftracesfromthefullsetso
bringsimilargraphsclosetoeachotherandpushdissimilaronesto
thateachtraceinthesubsetexhibitsmaximumdissimilaritywith
befarapartintherepresentationspace.TypicallyinGCL,wefirst
constructtwographsğ‘” 1,ğ‘” 2viarandommanipulation(e.g.,addor others.Inotherwords,eachsampledtraceshouldbeas"unique"
aspossible.Intuitively,iftracesinthesampledsubsetaremore
removeedges,dropnodes,andmaskfeatures)oftheinputgraph
ğ‘”.Thetwographsaresupposedtobesimilar,namely,positivein- dissimilar,theyshouldbelongtomoredistincttypes,leadingto
stances.Wethenselectanothergraphâ„ fromthedatasetasthe highercoverageandentropy.However,therearetwoprimarychal-
negativeinstance,whichisassumedtobedifferentfromthegraphğ‘” lengestoaddress:1)Howcanthesimilaritybetweentwotracesbe
anditsvariantsğ‘” 1,ğ‘” 2.Thelearningobjectiveistominimizethedis- measured,giventhatmultipleperspectivesinthetracedataneedto
tancebetweensimilargraphs(ğ‘” 1andğ‘” 2)andmaximizethedistance beevaluatedcollectively?2)Howcanasubsetoftracesbeselected
betweendissimilargraphs(ğ‘” 1andâ„).Inthisway,thegraphneural suchthateachtraceishighly"unique"withinthesubset?
networkaftertrainingcanrepresentgraphswithdiscrimination.
4 STEAMOVERVIEW
WepresentthedesignofSTEAMinthissection.Weimplemented
3 OBSERVABILITY-PRESERVINGTRACE
STEAMintoOpenTelemetrycollector[33],oneofthemostpopular
SAMPLING
tracingframeworks2,forreal-timetracesampling.Generallyin
We propose the observability-preserving trace sampling to keep productionsystems,therearemanyinstancesofcollectorstogether
asmuchinformationaspossibleaftersampling.Twometricsare consumingthetracingworkload.AsFig.2(bottom)shows,each
proposedtoquantitativelymeasurethesamplingeffectiveness. tracecollectorcomprisesthreecomponents:receiver,processor,
Coverage:Letâ€™stakethetracefromtheperspectiveofoperation andexporter.Thereceiverreceivestracesfromtheunderlyingdis-
asanexample.Supposethereareğ‘‡ differenttypesofoperations tributedsystemandforwardsthemtotheprocessorfornecessary
in the original traces (before sampling) andğ‘¡ different types of manipulationsandsampling.Theresultedtracesarethenforwarded
operationsinthesampledtraces,thecoveragedenoteshowmuch tobackendssuchasElasticsearchintheexporter.Inthiswork,we
ğ‘¡
percentageoftracetypesarekeptaftersampling,i.e.,ğ‘‡.Thehigher mainlyfocusontheprocessorcomponent.AsFig.2shows,STEAM
coverageweobtain,themoreobservabilitythesamplingwould hastwophases:offlinetrainingandonlinesampling.
achieve.However,whendecidingwhetheratraceshouldbesam-
pled,therearemanyperspectivestoconsider,includingthetrace 2STEAMisgenericandcanalsobeintegratedintoothertracingframeworkssuchas
operation,structure,latency,statuscode,etc.Ideally,thecoverage JaegerandZipkin
1752
ESEC/FSEâ€™23,December3â€“9,2023,SanFrancisco,CA,USA ShilinHe,BotaoFeng,LiqunLi,XuZhang,YuKang,QingweiLin,SaravanRajmohan,andDongmeiZhang
Inofflinetraining (theblueboxarea),themainpurposeisto
prepareamodelwhichcanembedthetraceasarepresentation
vector.Weleveragethegraphneuralnetwork(GNN,seeSec.4.1)
andtrainthemodelbyincorporatingthedomainknowledgeof
comparingtraces.Thedomainknowledgeisformallydenotedby
logicclauses(Sec.4.2),whichcanalsobecustomizedbyusersif
needed.Byapplyingthelogicclausestothetracedata,wegener-
atethetracetripletsasthetrainingdata.Themodelarethenbe
trainedanddistributedautomaticallytoeachprocessor instance
foronlinesampling.Toavoidthepossibledatadriftissueduring
systemevolvement,wesupportthedynamicmodelupdate,i.e., Figure3:TheoverviewoftrainingtheGNNmodelwithtrace
automaticallycachethelatesttracesandthenretrainthemodel. knolwedgeincorporated.
Intheonlinesamplingphase(theorangeboxarea),tracesfrom
receiversareorganizedasbatchesinastreamingway.Thesam-
plerfirstconsumesabatchoftracesandgeneratestherepresenta- B(theupperone),whiletraceC(thebottomone)hasadifferent
tionvectorforeachtracebasedonthetrainedGNNmodel.Given structure.Hence,traceAismoresimilartotraceBthantraceC.
thetracerepresentation,thecoresamplingcomponentfastDPP Wenamethecombinationofthreetracesthatsatisfiestherelative
(Sec.4.3)thensamplesasubsetoftracesthatareasdissimilaras relationğ‘† ğ´âˆ’ğµ > ğ‘† ğ´âˆ’ğ¶ asatracetriplet,denotedby(A,B,C).By
possible.Thesamplingcomponentisbuiltontopofthedetermin- learningtheirrelativesimilarity,theGNNmodelshouldprecisely
isticpointprocess(DPP)whileitsefficiencyissueisaddressedby representthetracewithsimilarityinformationencoded.
ourdesignedfastDPPalgorithm.Atlast,thesampledtracesare Wetrainthemodelwiththetripletloss[3]byminimizingthe
forwardedtotheexporterforsubsequentpersistence. distancebetweenğº ğ´ withthepositiverepresentationğº ğµ while
maximizingthedistancewiththenegativeoneğº ğ¶:
ğ¿(ğ´,ğµ,ğ¶)=ğ‘šğ‘ğ‘¥{ğ‘‘(ğº ğ´,ğº ğµ)âˆ’ğ‘‘(ğº ğ´,ğº ğ¶)+ğ‘šğ‘ğ‘Ÿğ‘”ğ‘–ğ‘›,0}
4.1 Graph-basedTraceRepresentation
whereğ‘‘isthedistancemeasurementbasedonthecosine-similarity
Inthissection,weaimtoencodeeachtraceasarepresentationvec-
fortworepresentation(seebelow)andğ‘šğ‘ğ‘Ÿğ‘”ğ‘–ğ‘›isafixedvalueto
torbasedonwhichwecandirectlycomputethesimilaritybetween
two traces. We propose to leverage the Graph Neural Network controlthegapoftwodistances.
(GNN)[44]modeltojointlyincorporatetherichtracestructureand ğ‘‘(x,y)=1âˆ’ xÂ·y
theabundantattributesinformationofeveryspannode,including âˆ¥xâˆ¥âˆ¥yâˆ¥
servicename,operationname,status,latency,URLandIPaddress.
Byminimizingthetripletlosswithbackpropagation,themodel
Therepresentationvectoristhegraphembeddingcomputedby
notonlyincorporatestherichstructureandabundantattributes
aggregating(i.e.,weightedsum)informationfromallnodes.Specif-
informationbutalsolearnswhichtwotracesaremoresimilarin
ically,weleveragedthegraphisomorphismnetwork[45],aspecific
thetracetriplets.
GNN model that is powerful in distinguishing different graphs
basedontherepresentation.Sincetracesfromdifferenttracing 4.2 IncorporatingDomainKnowledge
frameworksusuallyfollowthesameW3Cstandards[41],wedo
WehavesofarintroducedhowtotraintheGNNmodel.Aremaining
notneedmuchfeatureengineeringeffortforseparatescenarios.
questionishowtopreparetracetripletsformodeltrainingwhile
AstandardwayoftrainingGNNisgraphcontrastivelearning
incorporatingthedomainknowledgeabouttracesimilarity.Inthis
(seeSec.2)whichtargetsatpushingclosesimilargraphswhile
section,wepresentalightweightandflexiblewaytoproducealarge
pushingawaydissimilargraphs.Itrequiresmanipulatingtheinput
numberoftracetriplets.Thecoreideaistoformallydefineaset
trace(e.g.,randomlyremovingnodesormaskingattributes),which
ofâ€œabstractrulesâ€thatcanbeappliedtothetracedatatogenerate
howeveroftencreatestracesthatdonotevenexistintherealworld.
manytracetriplets.Therulesshoulddescribehowtocomparethe
Besides,themethoddoesnotconsidertheuniquecharacteristicsof
similarityamongthreetraces.Forexample,onemayconsider1)
tracedataincomparingtwotraces,e.g.,statuscodescouldbemore
â€œtraceAandBsharethesamestructurewhileAandCdonot,so
importantthanlatencyvalues.Itisbecausethetwotracesshould
AismoresimilartoBthanCâ€or2)â€œA,B,andCsharethesame
belesssimilariftheirstatuscodesaredifferent(e.g.,200vs.404)
structure.ButthelatencyofAandthatofBarecloserthanAand
comparedwiththelatencydifference(e.g.,200msvs.400ms).
C,soAismoresimilartoBthanCâ€.
Toaddresstheseissues,weproposetotraintheGNNbasedon
Inspiredbylogicprogramming[25],weformallyexpressthe
realtracesandincorporatethetrace-specificdomainknowledge
domainknowledgewithlogicclauses.Alogicclausedefinesarule
(seeSec.4.2).Fig.3showsanoverviewofhowwetraintheGNN
thatcoulddeducetherelativerelationoftracetripletsifcertain
model.Theinputarethreetraces,andthetargetistopredicttheir
conditionsaresatisfied.Formally,alogicclauseiswrittenas:
relativerelation.Atfirst,theGNNmodel(parameterssharedby
alltraces)encodesthetraceA,B,andCasrepresentationsğº ğ´,ğº ğµ, ğ» â†ğ‘ƒ 1âˆ§ğ‘ƒ 2âˆ§...âˆ§ğ‘ƒ ğ‘›
andğº ğ¶ separately.Thesimilarityforapairoftraces(e.g.,trace
anditslogicalimplicationis:
AandB)isthencomputedasğ‘† ğ´âˆ’ğµ withcosinesimilarity.Inthis
example,traceA(themiddleone)hasthesamestructureastrace ğ»ğ‘–ğ‘“ ğ‘ƒ 1ğ‘ğ‘›ğ‘‘ğ‘ƒ 2ğ‘ğ‘›ğ‘‘...ğ‘ğ‘›ğ‘‘ğ‘ƒ ğ‘›
1753
STEAM:Observability-PreservingTraceSampling ESEC/FSEâ€™23,December3â€“9,2023,SanFrancisco,CA,USA
whereğ» istheconclusionandtheconjunctionğ‘ƒ 1âˆ§ğ‘ƒ 2âˆ§...âˆ§ğ‘ƒ ğ‘› LatencyDiff and redesign the logic clauses accordingly. Such a
isthebody oftheclause.Specifically,ğ‘ƒ ğ‘– istheğ‘–-thpredicate(or designavoidsthepossibleconflictbetweendifferentlogicclauses
condition)thatcomparestwotracesintermsofaspecifictrace andenablesthefeasibilitytocustomizethelogicclausesforvarious
property,e.g.,whethertwotraceshaveexactlythesamestructure. scenariosanddemands.NotethatTable1providessomesamples
TakingFig.3asanexample,â€œtraceAandtraceBhavethesame basedongeneraldomainknowledgeofcomparingtraces.Wealso
structureâ€canbeapredicate;similarly,â€œtraceAandtraceChave allowtheeasyincorporationofotherknowledgebycustomizing
differentstructuresâ€isanotherpredicate.Hence,theconclusionin thelogicclausesordefiningnewdifferencefunctions.
thislogicclauseisâ€œAisclosertoBthanCâ€,denotedas(A,B,C). TrainingDataConstruction:Basedonthelogicclauses,we
ThelogicclauseispresentedasthefirstrowinTable1. canproducemassivetracetripletsasthemodeltrainingdata.The
Usually,atracecanbedescribedasatreestructure,whereeach workflowisasfollows:givenasetoftraces,werandomlypick
nodedenotesaspanwithattributessuchasservicename,span outthreetracesA,B,andCwithreplacementandthenapplythe
nameandlatency.Thecaller-calleerelationbetweentwospans logicclausestocheckwhethertheconclusionholdsonthethree
canbedenotedasapairofparent-childnodes.Forcomplextrace traces.Ifanylogicclauseholds,weobtainatracetripletof(A,B,
structure,itisnon-trivialandoftenad-hoctoexpresstheâ€œabstract C);otherwise,thethreetracesareregardedinvalid.Wewillrepeat
rulesâ€intermsofpredicates.Therefore,wedefineasetofdifference theprocessuntilsufficienttracetripletsareobtained.Atlast,we
functionsforsimplificationandeasyreuse.Adifferencefunction obtainthetracetripletsafterremovingtheduplicates.
specifiestowhatextenttwotracesaredifferentbasedonaspecific Theoretically,thereareuptoğ‘3combinationsoftracetriplets
traceproperty.Theinputistwotraces,andtheoutputistheirdif- foragivensetofğ‘ traces.Itisintractabletolistallpossiblecom-
ferencevalue.Somepredefineddifferencefunctionsareasfollows: binations.Hence,wepickonlysomeofthetracestoassemblethe
tracetriplets.Toavoidthecasethatarandomlypickedsetoftraces
â€¢ StructureDiff: It measures whether two traces have the same
aremostlythesame(duetothelong-taildistribution),weadopt
structureornot(output:TrueorFalse).Thesamestructuremeans
aheuristicstrategy.Indetail,webucketizethetracesbyahash
thatforeverynodepositionintwotraces,thespannameand
functionproposedin[11]andfetchtracesfromeachbucketwithan
caller-calleerelationshouldbeexactlythesame.
inversedocumentprobability[40].Intuitively,themoretracesthat
â€¢ LatencyDiff: It measures the latency difference of two traces,
existinthebucket,thelowerchanceeachtracewouldbeselected
wherethetracelatencyistheend-to-endrequestduration.
intothetracetriplets.ThehashfunctioncomputesahashIDbyit-
â€¢ StatusDiff:Itmeasuresifthestatuscodesofthetwotracesare
eratingallspansofthetreestructurewithaDFSandincrementally
thesameornot.
hashingtheservicenameandspanname.
â€¢ LevelDiff:Wheniteratingspansfromtheroottotheleaflevelby
level(rootspanhaslevel0),sincewhichleveltwotracesbecome
different.Iftwotracesaredifferentatleveld,thendistheoutput. 4.3 RepresentativeSampling
â€¢ SpanNameDiff:Thisfunctionmeasuresthedifferencebetween
Basedontheobtainedtracerepresentation,thefollow-upstepisto
twotraceswithrespecttothespannames.Atlevel-d,wedenote
sampleasubsetoftracesthataremutuallydissimilar.Toachieveso,
thespannamesoftraceAasasetğ‘†ğ‘† ğ´ andthatoftraceBas
weresorttoDeterministicPointProcess(DPP)[4,19]samplingand