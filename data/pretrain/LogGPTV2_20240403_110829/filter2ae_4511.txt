# 从CPU到内核/用户态全景分析异常分发机制——硬件基础及Hook

## 译文声明
本文为翻译文章，仅供参考。具体内容和含义以原文为准。

## 引言
直接查看最后一张图（关于硬件HOOK），你可能会对其感兴趣。许多书籍在讲解中断或异常时往往只是简单提及，而没有深入探讨。要彻底理解这个问题，必须从硬件层面入手。很多教授C++的老师通常只讲解`try-catch-throw`，而不涉及更复杂的全局展开和异常分发。这个系列将从异常/中断的起源开始，详细解释你的程序如何接管异常，每个细节都不会遗漏。

本系列涵盖的知识点包括：
1. CPU异常与中断的概念及区别；
2. Intel架构中的IDT表与ISR；
3. Windows内核中的内核异常分发；
4. Windows内核中的用户态异常分发；
5. 在调试器中查看PIC中断和APIC中断；
6. 硬件HOOK的另类实现

## 1、基础知识
在继续阅读之前，请先思考以下几个问题。如果你已经非常熟悉这些问题，可以直接跳过这一节：
1. 异常和中断的本质区别是什么？
2. 是谁首先发现了异常和中断？
3. 异常和中断是如何管理的？
4. CPU是如何将异常转交给操作系统的？

如果这些问题你不能完全回答，那么接下来我们一起探讨。

### 异常
异常是指CPU在运行过程中遇到无法处理的情况，例如无法识别的指令、缺页、硬件错误或除零等。在这种情况下，CPU会将异常传递给操作系统进行处理。

### 中断
中断是外部设备与CPU通信的一种方式。当外部设备需要通知CPU时，它会通过中断向CPU发送信号。例如，网卡接收到数据、串口接收到数据、RTC定时时间到了、键盘或鼠标被按下等情况。这些外部设备通过中断控制器（如8259芯片）向CPU发送中断请求。

### 8259芯片
下图展示了通过两片8259芯片级联的方式来接收外部中断的方式。每块8259芯片可以单独使用，但通过级联可以支持更多的外设。

![8259芯片级联](path_to_image)

#### 解释
- 每块8259芯片有8个中断源（IR0-IR7）。
- 通过级联两块8259芯片，可以支持15个外设。
- 一块称为Master，另一块称为Slave。
- 如果多个外设同时触发中断，8259会根据优先级依次报告给CPU。
- CPU会根据当前处理状态和中断优先级来决定处理哪个中断。

### Intel CPU预定义的异常
Intel CPU预定义了许多异常，以下是一些常见的例子：
- **除零异常**：当CPU检测到被除数为0时，会报告此异常。
- **断点异常**：在调试过程中常用，当CPU执行到`0xCC`指令时，会报告此异常。

### 关键点总结
1. 中断是由外设通过中断控制器（如PIC）报告给CPU的。
2. 异常是CPU在运行过程中发现错误后自行报告的。
3. 中断是异步的，而异常是同步的。

## 2、PIC与CPU的通信
### 问题解答
1. **没有PIC的话，CPU能否与外设通信？**
   - 当然可以，但效率较低。一种方法是轮询外设，另一种方法是为每个外设分配一个IO引脚。

2. **PIC如何将中断号告诉CPU？**
   - PIC通过特定的引脚和寄存器将中断号传递给CPU。

### 示例
以下是Windbg中查看PIC状态的命令：
```windbg
0: kd> !pic
----- IRQ Number ----- 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
Physically in service: . . . . . . . . . . . . . . . .
Physically masked: Y Y Y Y Y Y Y Y Y Y Y Y Y Y Y Y
Physically requested: Y . . . . . . . Y Y . . Y . . .
Level Triggered: . . . . . . . Y . Y Y Y . . . . . .
```

- `Physically in service`：表示当前CPU正在处理的外设。
- `Physically masked`：表示屏蔽掉哪些外设。
- `Physically requested`：表示当前有哪些外设正在请求中断处理。

### 外设IO端口
通过Windbg读取外设IO端口的操作如下：
```windbg
0: kd> db 0x0040 0x004F
```

## 3、时代在发展，PIC的替代者——APIC
随着技术的发展，15个外设显然不够用。Intel推出了高级可编程中断控制器（APIC），支持更多的中断源。

### APIC中断分配
从IRQ0到IRQ23的中断分配如下表所示：

| IRQ | 描述 |
|-----|------|
| 0   | 保留 |
| 1   | 键盘 |
| 2   | 级联 |
| ... | ...  |

### APIC配置
具体的配置和寄存器信息请参考Intel白皮书。

## 4、关于硬件HOOK的一些安全相关思考
（待续）

希望以上内容对你有所帮助。如果有任何问题或需要进一步讨论，请随时联系。