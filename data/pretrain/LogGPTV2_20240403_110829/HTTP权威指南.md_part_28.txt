HTTP/1.0 200 OK
Date: Sun, 11 Nov 2001 21:01:59 GMT
Via: FTP/1.0 proxy.irenes-isp.net (Traffic-Server/5.0.1-17882 [cMsf])
Last-modified: Sun, 11 Nov 2001 21:05:24 GMT
Content-type: text/plain
Hi there. This is an FTP server.
图6-22 HTTP/FTP网关生成了Via首部，用于记录所收到的协议（FTP）
4. Server和Via首部
Server响应首部字段对原始服务器使用的软件进行了描述。这里有几个例子：
Server: Apache/1.3.14 (Unix) PHP/4.0.4
Server: Netscape-Enterprise/4.1
Server: Microsoft-IIS/5.0
代 理 ｜ 161
如果响应报文是通过代理转发的，一定要确保代理没有修改Server首部。Server
首部是用于原始服务器的。代理应该添加的是Via条目。
5. Via的隐私和安全问题
有时候，我们并不希望在Via字符串中使用确切的主机名。总地来说，除非显式地
允许了这种行为，否则，当代理服务器作为网络防火墙的一部分使用时，是不应该
转发防火墙后面那些主机的名字和端口号的，因为防火墙后面的网络结构信息可能
154 会被恶意群体利用。14
如果不允许进行Via节点名转发，作为安全防线的一部分使用的代理就应该用适当
的假名来取代那台主机的名字。一般来说，即使隐藏了真实名称，代理也应该尝试
着为每台代理服务器保留一个Via路标条目。
对那些有着非常强烈的隐私要求，需要隐藏内部网络设计和拓扑结构的组织来说，
代理应该将一个（接收协议值相同的）有序Via路标条目序列合并成一个联合条
目。比如，可以将：
Via: 1.0 foo, 1.1 devirus.company.com, 1.1 access-logger.company.com
压缩成：
Via: 1.0 foo, 1.1 concealed-stuff
除非这些条目都在同一个组织的控制之下，而且已经用假名取代了主机名，否则就
不能将其合并起来。同样，接收协议值不同的条目也不能合并起来。
6.6.2 TRACE方法
代理服务器可以在转发报文时对其进行修改。可以添加、修改或删除首部，也可以将
主体部分转换成不同的格式。代理变得越来越复杂，开发代理产品的厂商也越来越多，
互操作性问题也开始逐渐显现。为了便于对代理网络进行诊断，我们需要有一种便捷
的方式来观察在通过HTTP 代理网络逐跳转发报文的过程中，报文是怎样变化的。
通过HTTP/1.1的TRACE方法，用户可以跟踪经代理链传输的请求报文，观察报文
经过了哪些代理，以及每个代理是如何对请求报文进行修改的。TRACE对代理流
的调试非常有用。15
注14： 恶意用户可以通过计算机名字和版本号来了解安全防线之后的网络结构。这类信息可能有助于进行
安全攻击。而且，计算机名还可能泄露一个组织内部私有项目的线索。
注15： 但是，它还没有得到广泛的实现。
162 ｜ 第6章
当TRACE请求到达目的服务器时，16整条请求报文都会被封装在一条HTTP响应
的主体中回送给发送端（参见图6-23）。当TRACE响应到达时，客户端可以检查
服务器收到的确切报文，以及它所经过的代理列表（在Via首部）。TRACE响应的
Content-Type为message/http，状态为200 OK。
TRACE请求
TRACE /index.html HTTP/1.1
Host: www.joes-hardware.com
Accept: text/html
客户端 代理1 代理2 代理3 服务器
(proxy.irenes-isp.net) (p1127.att.net)(cache.joes-hardware.com)(www.joes-hardware.com)
HTTP/1.1 200 OK
Content-Type: message/http
Content-Length: 269
Via: 1.1 cache.joes-hardware.com, 1.1 p1127.att.net, 1.1 proxy.irenes-isp.net
收到的请求
TRACE /index.html HTTP/1.1
Host: www.joes-hardware.com
Accept: text/html
Via: 1.1 proxy.irenes-isp.net, 1.1 p1127.att.net, 1.1 cache.joes-hardware.com
X-Magic-CDN-Thingy: 134-AF-0003
Cookie: access-isp="Irene's ISP, California"
Client-ip: 209.134.49.32
TRACE响应
图6-23 TRACE响应回送了收到的请求报文
Max-Forwards
通常，不管中间插入了多少代理，TRACE报文都会沿着整条路径传到目的服务器
上。可以使用Max-Forwards（最大转发次数）首部来限制TRACE和OPTIONS 155
请求所经过的代理跳数，在测试代理链是否是在无限循环中转发报文，或者查看链
中特定代理服务器的效果时，它是很有用的。Max-Forwards也可以限制OPTIONS
报文的转发（参见6.8节）。
Max-Forwards请求首部字段包含了一个整数，用来说明这条请求报文还可以被转
发的次数（参见图6-24）。如果Max-Forwards的值为零（Max-Forwards:0），那
么即使接收者不是原始服务器，它也必须将TRACE报文回送给客户端，而不应该
继续转发。
注16： 最后的接收者可以是原始服务器，也可以是第一个收到了Max-Forwards值为零的请求的代理或
网关。
代 理 ｜ 163
如果收到的 Max-Forwards值大于零，转发的报文中就必须包含一个更新了
的 Max-Forwards字段，其值会被减一。所有的代理和网关都应该支持 Max-
Forwards。可以用Max-Forwards来查看在代理链的任意一跳上接收到的请求。
TRACE请求
TRACE /index.html HTTP/1.1
Host: www.joes-hardware.com
Max-Forwards: 2 Max-Forwards=1 Max-Forwards=0
Accept: text/html
客户端 代理1 代理2 代理3 服务器
(proxy.irenes-isp.net) (p1127.att.net)(cache.joes-hardware.com)(www.joes-hardware.com)
HTTP/1.1 200 OK
Content-Type: message/http
Content-Length: 269
Via: 1.1 p1127.att.net, 1.1 proxy.irenes-isp.net
收到的请求
TRACE /index.html HTTP/1.1
Host: www.joes-hardware.com
Accept: text/html
Via: 1.1 proxy.irenes-isp.net, 1.1 p1127.att.net
X-Magic-CDN-Thingy: 134-AF-0003
Cookie: access-isp="Irene's ISP, California"
Client-ip: 209.134.49.32
TRACE响应
图6-24 可以用Max-Forwards首部字段来限制转发跳数
6.7 代理认证
代理可以作为访问控制设备使用。HTTP 定义了一种名为代理认证（proxy
authentication）的机制，这种机制可以阻止对内容的请求，直到用户向代理提供了
有效的访问权限证书为止。
• 对受限内容的请求到达一台代理服务器时，代理服务器可以返回一个要求使用访
问证书的407 Proxy Authorization Required状态码，以及一个用于描述怎样提供
这些证书的Proxy-Authenticate首部字段（参见图6-25b）。
156 • 客户端收到407响应时，会尝试着从本地数据库中，或者通过提示用户来搜集所
需要的证书。
• 只要获得了证书，客户端就会重新发送请求，在Proxy-Authorization首部
字段中提供所要求的证书。
• 如果证书有效，代理就会将原始请求沿着传输链路向下传送（参见图6-25c）；否则，
就发送另一条407应答。
164 ｜ 第6章
若传输链路中有多个代理，且每个代理都要进行认证时，代理认证通常无法很好地
工作。人们建议，应该对HTTP进行升级，将认证证书与代理链中特定的路标联系
起来，但这些升级措施并没有得到广泛实现。
有关HTTP认证机制的详细解释请参见第12章。
(a)
GET http://server.com/secret.jpg HTTP/1.0
客户端 访问控制代理 服务器
(b)
HTTP/1.0 407 Proxy Authorization Required
Proxy-Authenticate: Basic realm="Secure Stuff"
访问控制代理
客户端 服务器
(c)
GET http://server.com/secret.jpg HTTP/1.0
Proxy-Authorization: Basic YnJpOmZvbw==
访问控制代理
客户端 服务器
(d)
HTTP/1.0 200 OK
Content-type: image/jpeg
......
访问控制代理
需要严格 客户端 服务器
保密的图
片
图6-25 代理可以实现认证机制以控制对内容的访问
6.8 代理的互操作性
客户端、服务器和代理是由不同厂商构建的，实现的是不同版本的HTTP规范。它
们支持的特性各不相同，也存在着不同的问题。代理服务器位于客户端和服务器设
备之间，这些设备实现的协议可能有所不同，可能存在着很棘手的问题。
157
代 理 ｜ 165
6.8.1 处理代理不支持的首部和方法
代理服务器可能无法理解所有经其传输的首部字段。有些首部可能比代理自身还要
新；其他首部可能是特定应用程序独有的定制首部。代理必须对不认识的首部字段
进行转发，而且必须维持同名首部字段的相对顺序。17类似地，如果代理不熟悉某
个方法，那么只要可能，就应该尝试着将报文转发到下一跳节点上去。
在当今的大部分网络中，如果代理不能转发它不支持的方法，可能就无法生存下去
158 了，因为通过微软的Outlook进行Hotmail访问就大量地使用了HTTP扩展方法。
6.8.2 OPTIONS：发现对可选特性的支持
通过HTTP OPTIONS方法，客户端（或代理）可以发现Web服务器或者其上某
个特定资源所支持的功能（比如，它们所支持的方法）（参见图6-26）。通过使用
OPTIONS，客户端可以在与服务器进行交互之前，确定服务器的能力，这样它就可
以更方便地与具备不同特性的代理和服务器进行互操作了。
OPTIONS * HTTP/1.1
代理
客户端 服务器
HTTP/1.1 200 OK
Allow: GET,PUT,POST,HEAD,TRACE,OPTIONS
图6-26 用OPTIONS来判定服务器支持的方法
如果OPTIONS请求的URI是个星号（*），请求的就是整个服务器所支持的功能。
比如：
OPTIONS * HTTP/1.1
如果URI是个实际资源地址，OPTIONS请求就是在查询那个特定资源的可用特性：
OPTIONS http://www.joes-hardware.com/index.html HTTP/1.1
注17： 报文中可能会出现多个报文首部字段具有相同字段名的情况，如果存在这种情况的话，就要将其等
价地合并为一个由逗号分隔的列表。因此，要对合并后的字段值进行解释，具有相同字段名的首部
字段的接收顺序就变得非常重要了，因此，代理在转发报文时，就不能修改这些同名字段值的相对
顺序。
166 ｜ 第6章
如果成功，OPTIONS方法就会返回一个包含了各种首部字段的200 OK响应，这些
字段描述了服务器所支持的，或资源可用的各种可选特性。HTTP/1.1在响应中唯一
指定的首部字段是Allow首部，这个首部用于描述服务器所支持的各种方法（或者
服务器上的特定资源）。18OPTIONS允许在可选的响应主体中包含更多的信息，但
并没有对这种用法进行定义。
6.8.3 Allow首部
Allow实体首部字段列出了请求URI标识的资源所支持的方法列表，如果请求URI
为*的话，列出的就是整个服务器所支持的方法列表。例如：
Allow: GET, HEAD, PUT
可以将Allow首部作为请求首部，建议在新的资源上支持某些方法。并不要求服务
器支持这些方法，但应该在相应的响应中包含一个Allow首部，列出它实际支持的 159
方法。
因为客户端可能已经通过其他途径与原始服务器进行了交流，所以即使代理无法理
解指定的所有方法，也不能对Allow首部字段进行修改。
6.9 更多信息
更多信息，请参见以下资源。
• http://www.w3.org/Protocols/rfc2616/rfc2616.txt
RFC 2616，R. Fielding、J. Gettys、J. Mogul、H. Frystyk、L. Mastinter、P. Leach
和T. Berners-Lee编写的“Hypertext Transfer Protocol”。
• http://www.ietf.org/rfc/rfc3040.txt
RFC 3040，“Internet Web Replication and Caching Taxonomy”（“因特网Web复
制和缓存分类”）。
• Web Proxy Servers
Ari Luotonen著，Prentice Hall出版的计算机图书。
• http://www.ietf.org/rfc/rfc3143.txt
RFC 3143，“Known HTTP Proxy/Caching Problems”（“已知的HTTP 代理/缓存
问题”）。