的设备。简单地说，用户在一个有着99%可靠性的智能手机上是不能分辨出99.99%和
异，因为用户体验主要是受较不可靠的组件主导，例如手机移动网络或者他们正在使用
功能的数量。此外，用户通常不会注意到一项服务在高可靠性和极端可靠性之间的差
给用户的速度，并且很大程度地增加了成本，这反过来又减少了一个团队可以提供的新
可靠性会带来成本的大幅提升：过分追求稳定性限制了新功能的开发速度和将产品交付
再提高可靠性对于一项服务（和它的用户）来说，结果可能会更差而不是更好！极端的
你可能认为Google会试图构建一个百分之百可靠的服务。事实证明，超过一定值后，
通过投入余设备，我们可以进行常规的系统离线或其他预料之外的维护性操作。
编辑：KavitaGuliani
作者：MarcAlvidrez
拥抱风险
第3章
28
25
26
---
## Page 66
于系统正常运行时间比例的计算得出的（参考公式3-1）。
都对应一个向100%可用性的数量级上的提高。对于服务系统而言，这个指标通常是基
提供的“9”系列的数字来体现，比如可用性为99.9%、99.99%或99.999%。每个额外的“9”
的可接受水平。计划外停机时间是由服务预期的可用性水平所体现的，通常我们愿意用
对于大多数服务而言，最直接的能够代表风险承受能力的指标就是对于计划外停机时间
因素中的一部分很难被合理地度量。为了使这个问题在我们运行的各种类型的系统中易
直接或者间接的收入损失；品牌以及口碑上的影响；不良的新闻报道等。很明显，这些
决的事情。服务故障可能会有很多潜在的影响，包括用户的不满、伤害，或丧失信任；
务风险而言，将所有的潜在因素缩减为一个单一的性能指标，可能不是一件能够立刻解
个目标，我们可客观地评价目前的系统表现以及追踪一段时间内的改进和退步。对于服
Google标准做法是通过一个客观的指标来体现一个待优化的系统属性。通过设立这样一
度量服务的风险
的主要优势在于它可以促使团队进行明确的、深思熟虑的风险讨论。
会。从某种意义上来说，我们把可用性目标同时看作风险的上限和下限。这种表达方式
也不会超过太多，否则会浪费为系统增加新功能、清理技术债务或者降低运营成本的机
的可靠性。也就是说，当设定了一个可用性目标为99.99%时，我们即使要超过这个目标，
风险与业务风险对应起来。我们会努力提高一项服务的可靠性，但不会超过该服务需要
或者Photos应该置于风险连续体上（非线性）的哪一点？我们的目标是：明确地将运维
我们要给予同等关注。这样我们可以进行成本/收益分析。例如，Search、Ads、Gmail
风险作为一个连续体来认知的。对于提高Google系统的可靠性和对服务故障的耐受水平，
在SRE团队中，我们管理服务的可靠性很大程度上是通过管理风险来进行的。我们是将
机会成本
于处理，并且保持一致，我们选择主要关注计划外停机这个指标。
公式3-1：基于时间的可用性
这类成本由某一个组织承担。当该组织分配工程资源来构建减少风险的系统或功能，
可用性=系统正常运行时间／（系统正常运行时间+停机时间）
用户设计新功能和新产品的工作。
而非那些用户直接可用的功能时需要承担这些成本。这些工程师不能再从事为终端
保证。
又或者可以利用一些空间来存储奇偶校验码块，以此来提供一定程度的数据持久性
第3章拥抱风险
---
## Page 67
如何辨别服务的风险容忍度？在一个正式的环境或安全关键的系统中，服务的风险容忍
服务的风险容忍度
标。详情参见第4章。
们通过寻找、跟踪和调整重要的、不可避免的偏差来使服务达到一个高层次的可用性目
通常，我们会为一项服务设定季度性的可用性目标，每周甚至每天对性能进行跟踪。我
是持续运行的。
定义请求成功率，我们能计算出一个有效的可用性指标，尽管事实上该批处理系统并不
数据仓库中，以便进行定期的进一步分析。通过使用某条记录处理成功和处理不成功来
型系统。
是有关消费者类型和基础设施服务类型的系统，但是同样的原则也基本上适用于非服务
对成功和非成功的工作单元有明确的定义。事实上，虽然在本章中讨论的系统基本上都
系统中使用。大多数非服务性的系统（比如，批处理、流水线、存储服务以及交易系统等）
使用请求成功率指标量化计划外停机时间使得这种指标更适合在不直接服务终端用户的
看，通过计算全部请求成功率是一个对于计划外停机时间的合理估计。
后台调用的新邮件的轮询请求失败是不同的。然而在许多情况下，从终端用户的角度来
在一个典型的应用中，不是所有的请求都是平等的：一个新的用户注册请求失败和一个
于250个错误即可达到预计的可用性目标。
例如，一个每天可用性目标为99.99%的系统，一天要接受2.5M个请求。它每天出现少
个基于产量的指标是怎样通过滚动窗口计算出来的（比如，一天内成功请求的比率）。
是部分“在线”的）。因此，我们通过请求成功率来定义服务可用性。公式3-2体现了这
何地方对于一个给定的服务，总是可以处理一定的用户流量。（也就是说，我们随时都
范围内的分布式服务。Google所采用的故障隔离手段使得我们能够保证在任何时候、任
然而，在Google内部，基于时间的可用性通常是毫无意义的。因为我们需要着眼全球
以达到预计的可用性目标；详情参见附录A。
目标。举例来说，一个可用性目标为99.99%的系统最多在一年中停机52.56分钟，就可
使用这个公式，我们可以计算出一年内可接受的停机时间，从而可以使可用性达到预期
例如，
可用性=成功请求数／总的请求数
公式3-2：合计可用性
一个批处理进程通过提取、转换，并将客户数据库中的一位客户的数据内容插入
服务的风险容忍度
25
<28
---
## Page 68
2
断不仅会影响Google 本身，也会影响到那些在业务上非常依赖于我们的企业。对于这
Drive和Docs）让员工进行日常工作。另一方面，
企业。这些企业依靠Google应用程序提供的办公类型的服务（例如 Gmail、Calendar、
例如GoogleAppsforWork，这个服务的主要用户是企业类用户，包括大型企业和中小
务在市场上是如何定位的。下面列出了要考虑的一些问题：
对于某个Google服务而言，服务的可用性目标通常取决于它提供的功能，以及这项服
可用性目标
评价服务风险容忍度时，有许多需要考虑的因素。如下所示
程师们经常在知情或不知情的情况下扮演了这个角色。
过这个团队来讨论服务的可靠性要求。在没有专门的产品团队的情况下，建立系统的工
负责了解用户和业务，在市场上塑造产品的定位。存在产品团队时，我们能够更好地通
Search、Google Maps和GoogleDocs，它们每一个都有自己的产品经理。这些产品经理
我们的消费者服务通常会有一个对应的产品团队，是该服务的商业所有者。比如说，
辨别消费者服务的风险容忍度
系统或者通用的HTTP缓存层）。接下来，我们会分别讨论消费者服务和基础设施服务。
责人，而对于基础设施服务来说，拥有类似的产品所有权结构是很少见的（例如，存储
在实践中，这种转化说起来比做起来容易得多。消费者类型的服务往往有明确的产品负
明确的可以实现的工程目标。这些商业目标会直接影响所提供服务的性能和可靠性目标。
为了辨别服务的风险容忍度，SRE必须与产品负责人一起努力，将一组商业目标转化为
往定义得没有那么清楚。
度通常是直接根据基本产品或服务的定义建立的。在Google内部，服务风险容忍度往
·用户期望的服务水平是什么？
·有哪些其他重要的服务指标需要考虑？
·需要的可用性水平是什么？
这项服务是针对消费者还是企业的？
我们如何使用服务成本来帮助在风险曲线上定位这个服务？
如果市场上有竞争对手，那些竞争对手提供的服务水平如何？
这是一个有偿服务，还是免费服务？
这项服务是否直接关系到收入（我们的收入或我们的客户的收入）？
不同类型的失败对服务有不同的影响吗？
第3章
拥抱风险
一个GoogleAppsforWork服务的中
---
## Page 69
每一项服务确定可用性目标时，可以考虑如下的问题：
广告服务就能很好地体现出这种取舍，因为成功与失败直接通过赢利和亏损体现。在为
看作计划内停机时间，而不是计划外停机时间。
监控他们的广告活动的服务。因为这项工作大部分发生在正常工作时间内，我们认为维
Ads前端曾经就是这样的一种服务。它是广告商和网站创建者用来建立、配置、运行和
对于Google提供的其他服务，有时候，我们可以接受计划内的常规的服务中断。几年前
糕？这两种类型的故障可能会导致绝对数量上完全相同的错误被返回，但可能对于业务
对于一项给定的服务的故障预期是另一个需要重点考虑的因素。我们的业务对于服务的
且当时处于一个与Google非常不同的企业生命周期阶段。尽管当时YouTube已经有了
YouTube则需要截然不同的考虑。当Google收购YouTube后，我们需要为该网站提供
高的内部可用性目标，以及签署一份如果我们未能达到外部目标的处罚性协议。
类服务，我们可能会设置季度性的外部可用性目标为99.9%。同时，我们会设置一个更
决定一
成本
修窗口中发生的偶然的、正常的、计划之中的故障是可以接受的，并且我们把这些故障
数据清理时，完全停止该服务更加恰当。
数据的风险可能会破坏基本的用户信任。因此，在第二种情况下，在进行调试和事后的
糕的用户体验，SRE会努力去快速地解决这个问题。然而，在第二种情况下，暴露私人
另一种情况是将A用户的私人联系列表显示给B用户的故障。第一种情况显然是一个糟
别。假设有一个联系人管理应用程序，一种情况是导致用户头像显示失败的间歇性故障，
下面这个例子说明了一个提供私人信息的系统中自然发生的完全和部分服务中断的区
的影响相差很大。
停机时间的容忍程度有多高？持续的低故障率或者偶尔发生的全网中断哪一个会更糟
故障的类型
一个相比我们企业的产品更低的可用性目标，因为快速发展更加重要。
一个很出色的产品，但它仍然在不断变化和快速发展着。因此，我们为YouTube设定了
一个更恰当的可用性目标。2006年，YouTube比当时的Google更加专注于消费者，并
●额外的收入是否能够抵消为了达到这一可靠性水平所付出的成本？
·构建和运维可用性再多一个“9”的系统，收益会增加多少？
一项服务的合理可用性目标时，成本是很重要的考虑因素。
服务的风险容忍度
<30
---
## Page 70
vs.IPv6），但是我们测算的ISP的背景误差率基本在0.01%和1%之间。
网链路的噪声当中。虽然ISP和各种应用协议之间差距很大（比如，TCPvs.UDP、IPv4
障，那么让服务的误差率低于背景误差率就是可能的。这些误差将归入给定用户的互联
在互联网中ISP的背景误差率可能是个不错的实用策略。如果从最终用户的角度测算故
当我们无法简单地解释可靠性和收入的关系时，可能会更难设置这些目标。这时，考虑
如果成本超过900美元，那么成本将超过预计增加的收入。
在这种情况下，如果可用性提高一个“9”的成本不到900美元，这就是合理的投资。但是，
成本与收益：
为了使这个权衡等式更精确，假设一项业务中每一个请求的价值是一样的，考虑如下的
28
构建和运维基础设施组件的要求在许多方面是不同于消费者服务的。一个根本的区别是，
基础设施服务的风险容忍度
AdSense服务，使得我们能够通过合并需求较少的地理区域来降低运营开销。
服务资源的数量和位置），这能够帮我们节省大量成本。换句话说，相对延迟不敏感的
这种宽松的服务延迟要求允许我们在构建系统时做出一些明智的权衡（例如，使用的
AdSense的广告一般可以比AdWords的广告慢数百毫秒。
到第三方页面。这个特定的延迟目标依赖于给定的发布者的页面呈现速度。这意味着
常不同的延迟目标。对于AdSense而言，延迟的目标是避免在插入上下文广告时影响
AdSense，允许出版商将JavaScript代码插入到自己的网站中的上下文广告，有一个非
不变的目标。
统的一个关键要求就是广告不能拖慢用户的搜索体验。这是每一代AdWords系统的一个
的一个很关键的特点就是速度快。AdWords是将广告显示在搜索结果旁边的系统。该系
Google广告系统的服务延迟是一个典型的例子。当Google发布Web搜索服务时，服务
些指标是不重要的，可以为我们在讨论风险承受能力时提供帮助。
除了可用性，其他指标也可以用来确定服务的风险容忍度。了解哪些指标是重要的，哪
其他服务指标
改进可用性后的价值：100万美元×0.0009=900美元
服务收入：100万美元