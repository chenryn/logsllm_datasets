](https://images.seebug.org/content/images/2018/09/6478f14f-a4b3-4a76-9a49-92f1c109fe6d.png-w331s)
由于Ddostf家族的后门问题非常严重，螳螂黑客往往会在去除小马后门时暗自窃喜，放松警惕，殊不知一个更大的陷阱在等待着自己——黑雀在控制端同样隐藏了黑雀攻击接口，且只会在监听端口后开始建立连接。将二者绑定在一起不仅可以迷惑使用沙箱的分析人员，还可以在防火墙拦截网络通信时迷惑用户。这种针对控制端攻击的危害性无疑数倍于针对木马样本的攻击。由于控制端为Windows平台，僵尸制造者为了隐藏自身进行黑雀攻击的恶意目的，也为了防止其控制端被其它黑客逆向工程，自V8版本后加入了虚拟机保护壳Safengine
Shielden进行加壳保护（据说专业版保护强度甚至强于VMP）。由于脱壳成本极大，我们寻找到了旧版本V7进行逆向分析和比对，发现程序在监听端口后会主动连接黑雀的另一后门域名host.ter.tf。针对v8版本，虽然SE壳抹去了堆栈信息且无法对程序代码下断，但我们在尝试对网络系统函数下断后，经过调试和解密发现了与V7版本相同的黑雀域名。
![
](https://images.seebug.org/content/images/2018/09/c08b6a5e-bde6-47cc-95aa-3dff832eea80.png-w331s)
如域名解析生效，V7版本控制端首先会发送上线包(天罚端)，上线包相关格式如下所示：
![
](https://images.seebug.org/content/images/2018/09/92d86fa7-a186-451c-a9ba-8c1d63e6cb5e.png-w331s)
成功建立连接后控制端程序会等待接收黑雀指令，指令共分三种控制类型，其中当类型为case 7时，程序会通过指令发送的URL地址实现任意下载执行。如下图所示：
![
](https://images.seebug.org/content/images/2018/09/a5ae8470-48dd-45aa-9f10-174b1702c86b.png-w331s)
如此一来，黑雀就可以轻易控制螳螂黑客执行任意文件，不仅可以进行版本的更新，还可以加载任意恶意软件，危害极大。通过域名解析查询我们了解到，目前黑雀始终未对该域名进行IP解析，也就是说未曾发起过针对控制端的攻击。但不排除黑雀是在下一盘大棋，只待时机成熟进行大范围收割。综上，我们有理由怀疑黑雀在未来可能借此发动更大规模的攻击，需要引起高度警惕。
### 七、毒上加毒
在分析样本的过程中我们还发现了一些有趣的现象，部分Windows平台样本的大小明显同模板样本偏差较大，且会建立3个以上的C&C连接。通过进一步分析我们发现此类样本遭到了野生黑雀攻击，代码入口点被更改后加载了自定义Loader，且病毒代码隐藏在新增的rmnet区段中。
![
](https://images.seebug.org/content/images/2018/09/8564eeff-f998-4ea6-8625-cf048a055640.png-w331s)
![
](https://images.seebug.org/content/images/2018/09/e5d51031-9496-4fb6-b2cf-f0c04b0bd9ed.png-w331s)
通过分析发现，这类野生黑雀攻击实为Ramnit蠕虫病毒所为，该蠕虫以各种小工具的形式在互联网上广泛传播并形成了庞大的僵尸网络。其首次出现于2010年，触发后会感染本地和移动硬盘上的EXE、DLL、HTM和HTML文件，可以窃取被感染主机的银行凭证、密码、cookie和个人文件等等。
被攻击程序首先会执行rmnet段，运行后会生成并执行srv.exe(upx加壳)同时跳转回原程序入口执行被感染进程逻辑。通过调用CreateProcess启动srv.exe后会释放自身到Program
Files\Microsoft\DesktopLayer.exe，运行DesktopLayer.exe后程序会从文件中提取DLL。
![
](https://images.seebug.org/content/images/2018/09/5ebe4398-7479-448d-938c-7605c2c72a0a.png-w331s)
之后进程通过InlineHook调用ZwWriteVirtualMemory函数将DLL文件注入到IE和Google
Chrome进程中，从而实现文件不落地，防止杀软查杀。最后通过被注入的浏览器进程进行文件感染、远控连接、注册表自启动等行为。这里我们主要关心其对僵尸程序进行感染的攻击过程。
分析过程中涉及多次脱壳和DUMP，最终可以提取到注入进程的DLL，DLL中会进行真正的病毒行为。感染攻击的实质是添加loader来加载自定义恶意代码的过程。首先将目标PE文件映射到内存中，判断其是否含有rmnet区段，不包含则在尾部增加区段写入恶意代码，修改区段属性为可执行，然后将恶意代码末尾指向程序原入口点，而程序原入口点指向恶意代码的起始位置。
![
](https://images.seebug.org/content/images/2018/09/7eddc496-f481-4982-868a-f73e22fc5ff8.png-w331s)
解密后可以得到其控制端域名fget-career.com，该域名自2013年以来多次变更解析IP，虽然其服务器多次遭到刑警组织打击，但目前仍保持活跃，危害极大。因为受到Ramnit僵尸网络感染的螳螂众多，我们判断其与螳螂黑客并无利益关联，而是黑客在不知情下被Ramnit攻击后继续扩散样本。由于Ddostf
bot自身受到二级黑客控制，样本在被野生黑雀攻击后即受到三级黑客控制，同时具备了DDoS、远控、窃密等多种攻击方式，随着黑客技术的不断迭代更新，这种“毒上加毒”的攻击方式很有可能被更多黑客利用，此类样本一旦扩散无疑会对网络造成更为强大的破坏和危害。
### 八、黑雀画像
通过域名注册历史，我们观察到域名v8.ter.tf采用了隐私保护无法得知具体信息，其中最近的域名注册记录显示其有效时间从2018年4月20日至2022年4月20日，同时通过溯源发现其共存在9次有效解析记录，相关IP解析记录如下:
![
](https://images.seebug.org/content/images/2018/09/befa236a-0b15-4342-a88b-712b1f19e051.png-w331s)
可以观察到，黑雀长期使用监管宽松的服务器IP，间隔1-3个月即更换一次。同时我们通过监测发现，该黑雀通常只在准备攻击前进行解析IP操作，经过一段时间的积累，当上线肉鸡量达到需求后即发动DDoS攻击，结束后迅速取消域名解析(如取消或删除A记录/CNAME)，销声匿迹。可以判断出黑雀非常在意自身的隐匿安全性，灵活运用了打一枪换一炮的战术，在一定程度上增加了研究人员的追踪难度。
黑雀自2017年5月28日开始活跃，我们观察到其C&C (104.223.0.95)在2017年4月11日至5月30日关联在域名myss.ter.tf
(V8版本黑雀C&C)下，而后关联至域名v8.ter.tf(V8.1版本黑雀C&C)下,这与V8.1版本样本的编译和散播时间基本吻合。而从2017年8月29日起至2018年6月17日黑雀则较为低调，将域名持续解析至127.0.0.1。在2018年6月17日后黑雀域名共4次解析IP，通过IP关联分析并没有发现足够多的样本，主要原因是黑雀在攻击后往往会迅速取消域名解析，导致大量的提交样本在沙箱扫描时无法正常DNS解析。
监测发现9月以来该黑雀活动较为频繁，2次现身发动攻击。
我们在前文提到，通过对这批样本的分析，该黑雀至少掌控着184个独立螳螂僵尸网络，也即至少掌控着这184个C&C服务器所控制的所有肉鸡。而这只是黑雀的一部分资源，相对于螳螂来说，黑雀掌握的肉鸡资源几乎高出单个螳螂僵尸网络两个数据量级，所构成的攻击流量也会呈数量级增加，破坏力极大。
依据我们目前对黑雀的掌握和溯源分析，绘制黑雀名片如下:
![
](https://images.seebug.org/content/images/2018/09/3dec570c-b331-4a2f-8d0d-d72b253deedc.png-w331s)
### 九、总结
随着物联网僵尸网络的爆发式增长，越来越多的黑雀将目光从传统平台转向物联网领域，大大增加了攻击面，Ddostf僵尸的幕后黑雀也借此积极扩张。通过我们长期对Ddostf僵尸生态的研究分析发现，尽管部分黑客尝试去掉其小马后门并重新传播，但绝大多数的Ddostf僵尸样本依然留存有此类后门，且黑雀“狡猾”的在控制端也暗藏黑雀攻击接口，在添加强壳后难以发现和去除，用即中招。所以综合判断该黑雀僵尸资源丰富，实力非常强悍。本文重点对Ddostf僵尸网络中的这种现象进行了分析披露，并对典型僵尸样本进行了分析。此类黑雀利用普通黑客的攻击资源来发展自己的肉鸡，不动而坐收渔利。同时也要留意像Ramnit这类野生黑雀的加入，通过攻击病毒，借助“毒上毒”的方式依附传播。这些高效的黑吃黑手段给黑客产业链带来了越来越多的复杂性，也让网络秩序变得越发不安全，需要引起我们的高度警惕。
* * *