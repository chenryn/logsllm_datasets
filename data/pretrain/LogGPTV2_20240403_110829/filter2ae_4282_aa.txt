# 《透视APT》
## 网络空间中的对抗
### APT的典型事件之——“震网病毒”
  * 目标系统：工控系统
  * 潜伏渗透：感染了伊朗境内60%的PC
  * 突破物理隔离：U盘(病毒检测到宿主机插上U盘则主动向U盘感染病毒)
  * 技术水平：同时利用多个0day(微软和西门子工控系统)，体现了APT的高级性
  * 攻击者：极有可能是敌对关系的政治势力
  * 攻击持续性：C2服务器2005.11就完成注册,可能长达6~7年
### APT攻击的概念
  * 起源
    * 由美国一名空军上校2006年提出
  * 何时引起关注、高潮
    * 2010伊朗震网病毒、2013美国"棱镜门"事件
  * 定义
    * 知名第三方机构
      * 维基百科、Mandiant、赛门铁克、Damballa、TechTarget
        * 1.特性：高级、持续、威胁、针对。  
2.目标动机：政治、情报、数据、经济利益  
3.APT目标：国防、制造业、金融、科研
    * 奇安信威胁情报中心
      * 不是一个纯粹的技术概念，泛指有组织，有计划针对特定目标的一系列攻击
      * 组织
        * 国家或者政府(精神支持和物质基础)
        * 情报机构、网络间谍活动的攻击组织
        * 经济实体、犯罪组织、恐怖主义组织
      * 能力：攻击不计成本(技术成本,比如系统0day)
      * 技术特点：针对性、高度隐藏(潜伏渗透周期长)、不以经济利益为直接目的、掌握0day
      * 重大安全事件不一定是APT
        * 重大损失的，也不一定是APT
          * 2016年美国东部互联网瘫痪  
2018年Facebook数据泄露  
国内酒店大量住户信息泄露
        * 影响范围大的，也不一定是APT
          * 2017年WannaCry勒索病毒
        * 针对性强的，也不一定是APT
          * 2008年8月俄罗斯对格鲁吉亚的军事行动
    * APT 与威胁情报
      * 威胁情报：安全机构所掌握的、针对特定组织机构的各种网络威胁信息，而该组织机构自身可能并不知道相关威胁的存在或细节
        * 威胁情报的主要方面
          * 源头、目标、动机、工具、指标、表象、影响、方案
### 相关研究
  * 在全球范围内，APT研究美国和俄罗斯两国属世界一流，中国属全球第二梯队的排头兵
  * 行业领域：军队与国防、政府、金融、外交、能源、科研、医疗、传媒、电信
  * 目标地域：全球绝大部分的国家和地区。韩国、中东、美国、俄罗斯、巴基斯坦等国家APT最为活跃
## APT攻击的对象
### 工控系统
  * 乌克兰圣诞大停电事件
    * 核心攻击方式：BlackEnergy 后门程序、攻击者可远程访问并操控电力控制系统
  * 沙特阿拉伯大赦之夜攻击事件
    * 核心攻击方式：Shamoon(Disttrack)，能够导致目标网络完全瘫痪(通过当前的权限来访问活动目录、相同域及局域网其他主机进行横向移动)
      * 投放器(Dropper)
      * 通信组件(Communications)
      * 擦除组件(Wiper)
  * 美国电网承包商攻击事件
    * 核心攻击方式：渗透网站，向网站上传恶意程序，利用恶意程序跟踪网站访问者，获得相关人员的账号密码，利用该账号发送大量钓鱼邮件
### 金融系统
  * 多国银行被盗事件
    * 核心攻击方式：  
获得银行SWIFT权限，利用SWIFI向其他银行发送转账指令、篡改MT9XX报文清除证据
  * ATM 机盗窃事件
    * 核心攻击方式：  
1.针对性入侵金融机构员工的计算机或银行网络，进行视频监控，查看和记录负责转账系统的银行员工屏幕。获取足够的信息后，模仿银行员工的行为进行恶意操作。  
2.插入特别制造的芯片(EMV)卡，植入恶意程序，吐钞的同时让计算机断网  
3.入侵其他资产，通过资产内代理进行授权交易  
4.入侵内部网络、获得ATM控制权限  
5.通过光驱、USB接口等直接对ATM机进行操作
  * 黄金眼(国内APT组织)行动事件
    * 核心攻击方式：以合法软件开发公司伪装，以不当盈利作为目的，长期从事敏感金融交易信息窃取活动。（该组织攻击水平和反侦察能力均达到国际水平)
### 地缘政治
  * DNC邮件泄露、美国大选
    * 希拉里邮件门事件，利用私人电子邮件向家里私人服务器发送大量涉及国家机密的绝密邮件，大约6万封。
    * 相关细节：希拉里竞选团队主席被钓鱼攻击上钩，泄露邮箱密码，从而获取邮箱中的邮件，同样的攻击方法在团队其他成员中也相继成功。钓鱼邮件使用了(Bitly)短链接技术来进行伪装。
  * 法国总统大选
    * 攻击组织：APT-28  
文档:Trump's_Attack_On_Syria_English.docx  
核心攻击技术：  
CVE-2017-0262(Word远程代码执行)  
CVE-2017-0263(Windows本地权限升级)
### 教育、科研系统
  * 国内顶尖大学、研究院
  * 国内海事、电信、能源、国防、军工业
## APT攻击的技术手段
### APT攻击的目标
  * 敏感情报信息
    * PC敏感文件扩展名
      * doc,docx,ppt,pptx,xls,xlsx,rtf,wps,et,dps,pdf,txt,dwg,rar,zip,7z,exe,eml
    * 移动端敏感文件
      * 音频、照片、通话录音、录像、通话记录、通讯录、短信、手机基本信息、地理位置信息
    * 敏感情报信息窃取方式
      * 核心思想：选择性窃取（攻击者如果活动太频繁，木马与C&C服务器的通信次数越多越容易暴露）。故APT组织一般只收集特定目录下的文件或者有特殊文件名的文件。
      * 文件直接回传、Socket通信、 电子邮件
  * 敏感文件
  * 经济利益
  * 持续监控
  * 破坏
  * 攻击目标平台
    * Windows、Android、MacOS、iOS
    * 跨平台的水坑攻击
      * 带有恶意程序的伪造Flash升级包
### APT攻击的武器搭载系统
  * 鱼叉攻击(Spear Phishing)
    * 目的：不通过授权访问机密数据
    * 手段：最常见的方式是通过电子邮件发送给特定的攻击目标，诱使目标打开附件，这种方式就是鱼叉邮件。
      * 钓鱼邮件：这个概念和鱼叉邮件类似。不过，钓鱼多是针对普通人的攻击，针对性较弱，精确度较低。
    * 实施过程：前期准备->邮件制作->邮件投放->情报回收
    * 防护方法：稍微有点安全意识即可，认真查看邮件来源，附件扩展名，病毒扫描，虚拟机，沙箱等。
  * 水坑攻击(Water Holing)
    * 攻击概述：攻击者通过分析攻击目标的网络活动规律，寻找攻击目标经常访问的网站的弱点，先攻下该站点并植入攻击程序，在攻击目标访问该站点时实施攻击
    * 以海莲花APT组织的水坑攻击举例
      * A方式
        * 替换目标网站的可信程序(捆绑即时通、证书驱动)
        * 对目标网站插入恶意JavaScript程序(伪装成Adobe Flash更新程序)
      * B方式
        * 替换目标网站站点指定链接
  * PC跳板
  * 第三方平台
    * APT组织通过社交网络来下发C&C指令，APT组织的专用木马会读取文章中的程序指令来完成指定的攻击操作
    * 微博、Twitter、Facebook、…
  * 恶意硬件中间人劫持
    * 在目标网络环境中部署物理硬件设备，通过中间人方式劫持用户网络流量，替换更新包等软件
      * 输入法软件、聊天软件、下载软件、影音软件、安全软件、微软系统软件
    * 例子：火焰病毒
### APT攻击的武器装备
  * 专用木马
    * 开机自启动
      * 修改快捷方式
      * DLL(动态链接库)劫持
      * 修改注册表、服务、计划任务
      * APT组织为何放弃开机自启动？
        * 特定场景下需要一次性攻击
          * 火力侦察判断目标是否为真实目标时、目标防护能力很强时（都是为了隐藏自己的攻击
        * 依赖原始母体文件运行
        * 用其他方法启动木马
          * 注入到其他进程、或者捆绑到其他软件
          * 利用漏洞劫持篡改网络流量
    * 加密与自加密
    * 木马升级换代
  * 1day \ nday
    * 出于攻击技术成本考虑、目标系统存在大量已知漏洞但未修复
    * 相关例子
      * CVE-2012-0158
        * 微软Office漏洞(非常稳定)，远程攻击者诱使目标打开一个经过特殊构造的RTF文件，在符合漏洞条件下，即可在目标机器上执行任意指令。
      * CVE-2015-0097
        * 微软Office的一个逻辑漏洞，可导致目标通过HTA文件下载恶意程序到本机并执行
      * Android 漏洞
  * 0day
    * Office 文档漏洞
    * Windows 提权漏洞
    * Flash 漏洞
    * 其他0day
  * APT组织武器使用成本原则(0day、或者技术成本较高的攻击手段)
    * 攻击目标具有足够的攻击价值
    * 一般的专用木马攻击无效或者无法达到预期目的
    * 利用1day、nday攻击依然无法达到目的或者无效
  * APT武器研发趋势
    * 特别关注点：RAT(Remote Access Trojan)文件,远程访问木马的文件格式、文件形态、功能形态、恶意程序寄宿位置的变化
    * 相关武器研发趋势
      * 从PE到非PE，从有实体到无实体
      * 小众编程语言日渐流行(Delphi\GCC\NSIS\AutoIt
      * 模块互动，云控技术渐成主流
      * 恶意程序寄宿位置越藏越深：从常见的系统目录到难以追踪的MBR, VBR, 磁盘固件, EFI, BIOS, 移动存储设备的隐藏分区
      * 独立研发与委托定制成主流
        * 使用公开的RAT，目的是自我隐藏和嫁祸他人
        * 绝大部分的APT组织都是在相对独立的环境下完成攻击代码的开发工作
        * 不排除委托第三方组成协助定制开发的可能性
### APT攻击的 C&C(Command and Control)
  * 主要作用：  
1.向感染了目标机的木马程序发送控制命令，提供下载资源(新木马，木马模块，配置文件等)  
2.回收木马程序收集到的情报信息，包括文件、邮件等
  * 地域分布
    * 美国最多、其次中国、俄罗斯，西班牙，德国并列第三(2015年)
      * 一个APT组织可能拥有数十个，或者几个分布于不同地域的C&C服务器
  * 注册机构
    * 国内外APT组织均使用或部分使用境外服务商动态域名，ChangIP,DynDNS,No-IP,Afraid(FreeDNS),dnsExit