端口）、信息对象地址（IOA）的范围、以及IOA指定范围的开始和结束值。IOA 是一个数字，用于标识设备中一个特定的数据元素。
进程的名字被指定在配置文件中，该名字属于运行在受害者机器上的应用程序。该应用程序通过串行连接和 RTU通信。101 payload
试图终止指定的进程，并且开始使用 CreateFile、WriteFile 和 ReadFile 这些Windows API
函数和指定的设备通信。配置文件中的第一个 COM 口用于实际通信，另外两个端口用于防止其他进程访问。这样，101 组件能够接管和维护 RTU 设备的控制。
这个组件遍历所有被定义的 IOA
范围内的IOA。对于每一个IOA，构造两个“选择和执行”包，一个单命令（C_SC_NA_1）一个双命令（C_DC_NA_1），并且将它们发送到RTU设备。组件的主要目标是改变单命令类型IOA的开/关状态和双命令类型的IOA的开/关状态。具体来说，101
payload有三个阶段：在第一阶段，这个组件试图将IOA切换到它们的Off状态；第二阶段试图将IOA转换为On；最后阶段再将IOA状态切换回Off。
###### 2\. 61850 模块
与 101 和 104 payload 不同的是，61850 payload 是一个独立的恶意工具。它包含一个名字为 61850.exe
的可执行文件和一个名字为 DLL 61850.dll 的动态链接库。它们以 IEC 61850
标准来命名。该标准描述了用于实现变电站自动化系统保护、自动化测量、监控和控制的设备之间的多厂商通信协议。该协议非常复杂和健壮，而61850只是使用了该协议中一小部分来产生破坏性影响。
一旦被执行，61850 payload DLL 就会尝试读取配置文件，该配置文件路径由启动器组件提供。独立版本默认从 fromi.ini
文件读取它的配置文件。该配置文件包含一组设备的IP地址列表，这些设备通过IEC 61850描述的协议进行通信。
如果配置文件不存在，该组件枚举所有的网络适配器来确定它们的 TCP/IP 子网掩码。然后，61850
payload枚举每一个子网掩码下所有可能的IP地址，接着尝试连接每一 IP 地址的 102 端口。因此，该组件有能力在网络中自动发现相关设备。
相反，如果配置文件存在，并包含目标IP地址，该组件会连接该IP地址的102端口。并且这些IP地址也是被自动发现的。
一旦该组件连接到目标主机，它就会使用面向连接的传输协议发送连接请求包，如果目标设备有效回应，61850使用制造消息规范（MMS）发送初始请求包。如果收到预期的回应，则继续发送一个MMS名称列表请求。因此该组件在虚拟制造设备（VMD）中编译对象名称列表。接下来，该组件枚举了前面步骤中发现的对象，用每一对象名发送设备特定域对象列表请求，在一个特定域中枚举命名变量。
之后，从 61850 payload 这些请求的响应数据中搜索 包含以下字符串组合的变量：
  * CSW, CF, Pos, and Model 
  * CSW, ST, Pos, and stVal 
  * CSW, CO, Pos, Oper, but not $T 
  * CSW, CO, Pos, SBO, but not $T
字符串“CSW”是用于控制断路器和开关的逻辑节点的名称。
61850 payload为一些包含“Model“或”stVal“字符串的变量发送额外的MMS读取请求。该组件还可以发出一个可以改变其状态的MMS写请求。
61850 payload产生一个日志文件，它的操作包含IP地址、MMS域、命名变量和目标节点的状态（打开或关闭）。
###### 3\. OPC DA payload 组件
OPC DA payload 组件为 OPC 数据协议实现了客户端。访问规范 OPC（进程控制OLE）是一种基于微软技术的软件标准和规范。例如
OLE、COM和DCOM 。OPC 规范中的数据访问（DA）部分允许基于客户端-服务器模型的分布式组件之间的实时数据交换。该组件为独立的恶意工具，包含
OPC.exeh 和一个 DLL 。该组件同时实现了 61850 和 OPC DA payload 功能。该DLL在PE的导出表中被命名为
OPCClientDemo.dll ，表面该组件的代码可能是基于开源项目 OPC 客户端。
一旦被攻击者执行，OPC DA payload不需要任何配置文件。它会用 ICatInformation 枚举所有的 OPC 服务器。接下来该组件使用
IOPCBrowseServerAddressSpace 接口来枚举服务器上的所有 OPC 项目。特别是寻找包含下列字符串的项。
  * ctlSelOn
  * ctlOperOn
  * ctlSelOff
  * ctlOperOff
  * \Pos and stVal
这些项目的名称表明攻击者对属于 ABB 解决方案的 OPC 服务器提供的 OPC 项非常感兴趣。攻击者在添加新的OPC组时使用字符串
“Abdul”，可能这个字符串被攻击者用作俚语，指的是 ABB 解决方案。
在最后一步，OPC DA payload 尝试使用 IOPCSyncIO 接口，写两次 ox01 值来改变已发现 OPC 项的状态。
该组件写 OPC 服务器名称、OPC 项状态、质量码和值到日志文件。日志值被下面的头所分割：
  * [*ServerName: %SERVERNAME%] [State: Before]
  * [*ServerName: %SERVERNAME%] [State: After ON]
  * [*ServerName: %SERVERNAME%] [State: After OFF]
###### 4\. 辅助后门组件
ESET 还发现另外一个具有后门功能的恶意组件，这个恶意组件提供了另一种持久性机制，允许攻击者重新访问目标网络，以防主后门被检测到/或禁用。这个后门是一个
Windows
记事本应用的木马版本，它拥有记事本的完整功能。但是，恶意软件的作者已经插入了恶意代码，每次记事本启动，恶意代码都有被执行。一旦攻击者获得管理员权限，他们就会手动替换掉合法的记事本。
插入的恶意代码被严重混淆，但是，一旦代码解密，它连接到一个远程 C&C 服务器（这个服务器不同于主后门所连接的），下载一个 payload ，这个
payload 是一个 shellcode 形式的恶意代码，它直接被加载到内存执行。此外，插入的代码解密存储在文件末尾的原始 Windows
记事本，然后再执行该记事本，这样记事本程序就像预期那样工作。
###### 5\. 端口扫描器
攻击者的武器库包含一个端口扫描器，其可以被用来在网络中找到攻击相关的计算机。有趣的是，攻击者并没有使用外部软件，而是使用自己编写的端口扫描工具，攻击者可以定义用于扫描工具扫描的一系列
IP 地址和端口。
###### 6\. DoS工具
攻击者武器库中的另一工具是拒绝服务（DoS）工具，可以用来对付西门子 SIPROTEC 设备，该工具利用了 CVE-2015-5374
漏洞，目标是使设备无法响应。一旦漏洞被成功利用，目标机器将会停止任何命令响应，直到手动重启。
为了利用这个漏洞，攻击者将设备 IP 地址硬编码到该工具中。一旦工具被执行，就会使用 UDP 协议发送特定的精心设计的数据包到目标 IP 地址的 50000
端口。该 UDP 数据包包含18字节。
**参考文章：**  
1\. [WIN32/INDUSTROYER A new threat for industrial control systerms Anton
Cherepanov, ESET Version 2017-06-12](https://www.welivesecurity.com/wp-content/uploads/2017/06/Win32_Industroyer.pdf)
2.[CRASHOVERRIDE Analysis of the Threat to Electric Grid Operations DRAGOS INC
version 2.2017061](https://dragos.com/blog/crashoverride/CrashOverride-01.pdf)
3.IEC870-05-104-传输规约-国电
* * *
**启明星辰积极防御实验室（ADLab）**
ADLab成立于1999年，是中国安全行业最早成立的攻防技术研究实验室之一，微软MAPP计划核心成员。截止目前，ADLab通过CVE发布Windows、Linux、Unix等操作系统安全或软件漏洞近300个，持续保持亚洲领先并确立了其在国际网络安全领域的核心地位。实验室研究方向涵盖操作系统与应用系统安全研究、移动智能终端安全研究、物联网智能设备安全研究、Web安全研究、工控系统安全研究、云安全研究。研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。
* * *