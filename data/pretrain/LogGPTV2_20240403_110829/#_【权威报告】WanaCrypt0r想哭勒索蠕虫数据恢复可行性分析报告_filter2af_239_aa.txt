# 【权威报告】WanaCrypt0r（“想哭”勒索蠕虫）数据恢复可行性分析报告

## 译文声明
本文为翻译文章，原文来源于安全客。译文仅供参考，具体内容及含义请以原文为准。

**360追日团队官网：** [http://zhuiri.360.cn/](http://zhuiri.360.cn/)

## 第一章 前言

近日，360互联网安全中心发现全球多个国家和地区遭受了一款新型勒索软件的攻击，并于5月12日在国内率先发布紧急预警。该勒索软件在短时间内迅速蔓延，据不完全统计，在爆发后的几个小时内已攻击了99个国家的近万台设备，影响了大量企业和个人用户。国外媒体和多家安全公司将此恶意软件命名为“WanaCrypt0r”，直译为“想哭勒索蠕虫”。

通常情况下，勒索病毒是一种以盈利为目的的恶意程序，它通过非对称加密算法加密受害者电脑中的重要文件，以此进行勒索并要求支付赎金。除非支付赎金，否则被加密的文件无法恢复。而此次出现的“想哭勒索蠕虫”尤为致命，因为它利用了从美国国家安全局窃取的黑客工具EternalBlue（“永恒之蓝”），实现了在全球范围内的快速传播，在短时间内造成了巨大损失。自5月12日WanaCrypt0r全球攻击爆发以来，360核心安全部门一直对该勒索蠕虫保持高度关注。各团队紧密协作，发布了针对该蠕虫的一系列查杀、免疫及文件恢复解决方案。

360核心安全部门的追日团队深入研究了该病毒的工作原理，发现了最有效的数据恢复技术。基于这项技术，360在全球范围内独家发布了“想哭勒索蠕虫数据恢复工具”，帮助受害者恢复被加密的文件，达到目前最全面、最快的数据恢复效果。我们希望通过这篇技术报告，让大家了解该蠕虫的核心技术原理，并进一步探讨恢复被加密数据的可能性。

## 第二章 加密文件核心流程分析

### 1. 加密入口
- **动态加载加密模块**：蠕虫将一个加密模块释放到内存中，并直接在内存中加载该DLL。DLL导出一个名为TaskStart的函数，用于启动整个加密过程。
- **动态获取API函数**：程序动态获取与文件系统和加密相关的API函数，以规避静态查杀。

### 2. 文件遍历
- **获取路径**：调用SHGetFolderPathW函数获取桌面和文档文件夹的路径，然后调用10004A40函数获取非当前用户的桌面和文档文件夹路径。
- **遍历盘符**：从Z盘倒序遍历至C盘，遍历两次。第一次遍历本地盘符（跳过光驱），第二次遍历移动盘符，分别调用EncryptFolder函数对文件夹进行加密操作。

### 3. 文件处理队列
- **递归遍历文件夹**：EncryptFolder是一个递归函数，按照特定规则遍历文件夹并收集文件信息。
- **排除路径**：在遍历过程中，排除以下路径或文件夹名称：
  - \Intel
  - \ProgramData
  - \WINDOWS
  - \Program Files
  - \Program Files (x86)
  - \AppData\Local\Temp
  - \Local Settings\Temp
  - Temporary Internet Files
  - This folder protects against ransomware. Modifying it will reduce protection
  - Content.IE5

其中，“This folder protects against ransomware. Modifying it will reduce protection”是国外一款名为ransomfree的勒索防御软件创建的防御目录。

### 4. 文件分类
- **文件分类规则**：根据文件后缀名，将文件分为两类：
  - **类型列表1**：包括常见的办公文档和图片格式，如.doc, .docx, .xls, .xlsx, .ppt, .pptx, .jpeg, .jpg等。
  - **类型列表2**：包括更多的文件格式，如.docb, .docm, .dot, .dotm, .pdf, .dwg, .zip, .rar, .mp4, .avi, .mp3, .php, .jsp, .sql, .sqlite3等。

### 5. 优先级队列
- **设计复杂的优先级队列**：WanaCrypt0r为了尽快加密其认为重要的用户文件，设计了一套复杂的优先级队列机制。

通过以上分析，我们可以更清晰地了解WanaCrypt0r的工作原理，并为进一步的数据恢复提供理论依据和技术支持。