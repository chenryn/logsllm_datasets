# 【权威报告】WanaCrypt0r想哭勒索蠕虫数据恢复可行性分析报告
|
##### 译文声明
本文是翻译文章，文章来源：安全客
译文仅供参考，具体内容表达以及含义原文为准。
****
**360追日团队官网：**[ **http://zhuiri.360.cn/**](http://zhuiri.360.cn/) ****
**  
**
**第一章 前言**
近日，360互联网安全中心发现全球多个国家和地区的机构及个人电脑遭受到了一款新型勒索软件攻击，并于5月12日国内率先发布紧急预警。该款勒索软件在短时间内在全球范围内爆发了广泛的攻击活动，据不完全统计，它在爆发后的几个小时内就迅速攻击了99个国家的近万台设备，并在大量企业组织和个人间蔓延。外媒和多家安全公司将其命名为“WanaCrypt0r”（直译：“想哭勒索蠕虫”）。
通常，常规的勒索病毒是一种趋利明显的恶意程序，它会使用非对称加密算法加密受害者电脑内的重要文件并以此来进行勒索，向受害者索要赎金，除非受害者交出勒索赎金，否则被加密的文件无法被恢复。而新型勒索软件的“想哭勒索蠕虫”尤其致命，它利用了窃取自美国国家安全局的黑客工具EternalBlue（直译：“永恒之蓝”）实现了全球范围内的快速传播，在短时间内造成了巨大损失。继5月12日WanaCrypt0r全球攻击爆发以来，360核心安全部门对该勒索蠕虫保持了高度关注，部门各团队紧密协作，首家发布了一系列针对该蠕虫的查杀、免疫和文件恢复解决方案。
**360核心安全部门追日团队深入分析病毒原理，发现了其加密数据最精准的恢复技术，使用此技术360在全球独家发布了“想哭勒索蠕虫数据恢复工具”帮助病毒受害者恢复被蠕虫加密文件，可以达到目前最全最快的数据恢复效果，我们希望本篇技术报告可以帮助大家了解该蠕虫的核心技术原理，并对恢复被加密数据的可行性做进一步探讨。**
**第二章 加密文件核心流程分析**
蠕虫释放一个加密模块到内存，直接在内存加载该DLL。DLL导出一个函数TaskStart用于启动整个加密的流程。
程序动态获取文件系统和加密相关的API函数，以此来躲避静态查杀。
**1\. 加密入口**
调用SHGetFolderPathW获取了桌面和文档文件夹的路径，调用10004A40函数获得非当前用户的桌面和文档文件夹，分别调用EncryptFolder对文件夹进行加密操作
从Z倒序遍历盘符直到C，遍历两次，第一次遍历本地盘符（跳过光驱），第二次遍历移动盘符，分别调用EncryptFolder对文件夹进行加密操作
**2\. 文件遍历**
EncryptFolder函数是一个递归函数，递归遍历文件夹，按照下图的描述搜集文件信息：
遍历过程中排除的路径或者文件夹名称：
去除路径中盘符或主机名后进行比较
\Intel
\ProgramData
\WINDOWS
\Program Files
\Program Files (x86)
\AppData\Local\Temp
\Local Settings\Temp
文件夹名称（完全相等）
Temporary Internet Files
This folder protects against ransomware. Modifying it will reduce protection
Content.IE5
其中有一个很有意思的目录名“ This folder protects against ransomware. Modifying it will
reduce protection”，通过Google查询，发现其是国外的一款名为ransomfree的勒索防御软件创建的防御目录。
在遍历文件的过程中，会获取文件信息（大小等），并且根据后缀名使用下表的规则对文件进行分类（type）：
type列表1：
    ".doc",".docx",".xls",".xlsx",".ppt",".pptx",".pst",".ost",".msg",".eml",".vsd",".vsdx",".txt",".csv",".rtf",".123",".wks",".wk1",".pdf",".dwg",".onetoc2",".snt",".jpeg",".jpg"
type列表2：
    ".docb",".docm",".dot",".dotm",".dotx",".xlsm",".xlsb",".xlw",".xlt",".xlm",".xlc",".xltx",".xltm",".pptm",".pot",".pps",".ppsm",".ppsx",".ppam",".potx",".potm",".edb",".hwp",".602",".sxi",".sti",".sldx",".sldm",".sldm",".vdi",".vmdk",".vmx",".gpg",".aes",".ARC",".PAQ",".bz2",".tbk",".bak",".tar",".tgz",".gz",".7z",".rar",".zip",".backup",".iso",".vcd",".bmp",".png",".gif",".raw",".cgm",".tif",".tiff",".nef",".psd",".ai",".svg",".djvu",".m4u",".m3u",".mid",".wma",".flv",".3g2",".mkv",".3gp",".mp4",".mov",".avi",".asf",".mpeg",".vob",".mpg",".wmv",".fla",".swf",".wav",".mp3",".sh",".class",".jar",".java",".rb",".asp",".php",".jsp",".brd",".sch",".dch",".dip",".pl",".vb",".vbs",".ps1",".bat",".cmd",".js",".asm",".h",".pas",".cpp",".c",".cs",".suo",".sln",".ldf",".mdf",".ibd",".myi",".myd",".frm",".odb",".dbf",".db",".mdb",".accdb",".sql",".sqlitedb",".sqlite3",".asc",".lay6",".lay",".mml",".sxm",".otg",".odg",".uop",".std",".sxd",".otp",".odp",".wb2",".slk",".dif",".stc",".sxc",".ots",".ods",".3dm",".max",".3ds",".uot",".stw",".sxw",".ott",".odt",".pem",".p12",".csr",".crt",".key",".pfx",".der"
**3\. 文件处理队列**
WanaCrypt0r为了能尽快的加密其认为重要的用户文件，设计了一套复杂的优先级队列。