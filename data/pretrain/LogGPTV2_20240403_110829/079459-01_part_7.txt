KMS(Key Management Service，密钥管理服务)密钥允许在组织内自动激活新服务器，而不需要新服务器通过Internet
进行通信。这很重要，因为大多数组织不允许服务器与Internet通信。表1.2描述了使用KMS密钥的激活方法。
表1.2 使用KMS密钥的激活方法
方 法 说 明
可将Windows Server 2016配置为KMS主机。然后就可将KMS密钥添加到KMS主机。向KMS主机添加
KMS密钥时，Microsoft会激活它。但是，新服务器通过联系KMS主机来激活。
KMS主机
KMS主机具有最小的激活阈值。对于服务器操作系统，激活阈值为5。如果使用KMS主机进行激活的服务
器少于5台，激活就不会成功。这使KMS主机很难用于较小的组织或远程站点
基于 Active 在实现基于Active Directory的激活时，激活信息存储在Active Directory中，而不是存储在KMS主机上。
Directory 的 因为新服务器与Active Directory通信，所以没有激活的单点故障。此外，对于基于Active Directory的激活，
激活 没有最低的激活阈值。这是支持它的软件的首选激活方法
要配置KMS主机或基于Active Directory激活，可在Windows Server 2016中安装Volume Activation Services服
务器角色。安装此服务器角色后，运行Volume Activation Tools，该工具允许选择启用基于KMS或Active Directory
的激活和管理密钥。
GVLK
使用KMS或基于Active Directory的激活时，不需要在Windows Server 2016中手动安装许可密钥。默认情况下，
Windows Server 2016包含一个GVLK(Generic Volume License Key，通用批量许可密钥)，可以是KMS激活或基于
Active Directory的激活。
极少数情况下，由于有人无意中更改了密钥，批量激活会失败。可将密钥改回正确的GVLK。
有关GVLK的列表，请参阅网址https://technet.microsoft.com/en- us/library/jj612867(v = ws.11).aspx。
8 精通Windows Server 2016(第6版)
有关批量激活的详细信息，请参见Planning for Volume Activation，网址是https://technet.microsoft.com/en-us/library/
dd996589.aspx。
1.3 自动安装 Windows Server 2016
为简化Windows Server 2016在大型组织中的安装，应该自动完成这个过程。自动化部署过程减少了部署新服
务器所需的管理工作。因此，不必花费30～60分钟执行安装，而可启动自动化流程，然后走开，直到完成安装。
自动化部署也提供了一致的结果。可以定义要安装的功能集合。例如，可自动启用BitLocker来加密本地硬盘。
在手动安装时，需要在部署服务器后将BitLocker作为一个单独的进程启用。
Windows Server 2016部署可以通过几种不同的方式实现自动化。有些选项没有额外成本，而另一些选项则使用
需要购买的工具。如果环境是虚拟化的，就将有额外选项。
1.3.1 Sysprep和Imaging
Imaging 是取一台准备好的计算机并复制其配置的过程。准备好的计算机的映像存储在一个文件中，该映像可
应用于其他物理计算机或虚拟机。
安装Windows Server 2016时，会配置特定于系统的信息，如计算机名称、硬件信息和本地机器内部安全标识
符(SID)。这些特定于系统的配置项需要作为映像过程的一部分删除。删除这些项时，映像可应用于运行不同硬件
的计算机上。
Sysprep(System Preparation)实用程序包含在Windows Server 2016中，用于为映像准备操作系统。Sysprep删除
计算机名称、硬件信息和SID。然后，当映像应用到新计算机上时，将重新创建这些项。
Sysprep选项
Sysprep.exe存储在C:\Windows\System32\Sysprep中。运行带有图形界面的Sysprep时，需要选择一个系统清理
操作，如图1.7所示。系统清理操作控制Sysprep运行和操作系统重启后发生的事情。
图1.7 Sysprep图形界面
两个系统清理操作是：
◆ Enter System Out-of-Box Experience (OOBE)。此选项使Windows运行安装Windows期间发生的OOBE过程。
在OOBE过程中，会生成一个新的计算机名称，提示输入新的管理员密码。
◆ Enter System Audit Mode (进入系统审计模式)。此选项用于映像的维护。操作系统启动后，可执行诸如添加
驱动程序和更新的任务，而不是运行 OOBE。修改映像后，可再次将其放入审计模式或 OOBE 中，为部
署做好准备。
为部署准备映像时，应该选择Generalize选项。此选项删除计算机的特定信息，如计算机名称、SID和硬件驱
动程序。
三个关闭选项如下。
◆ Quit：Sysprep退出，操作系统继续运行。需要关闭操作系统来捕获映像。
◆ Reboot：计算机重新启动，并进入系统清理操作定义的模式。如果要捕获映像，选择该选项是不合适的。
第1章 Windows Server 2016的安装与管理 9
◆ Shutdown：Sysprep完成后，计算机将关闭。这是在捕获映像之前应该使用的选项。
为虚拟化运行Sysprep
我们正在为部署创建一个新的Windows Server 2016映像。在以前的部署中，使用Sysprep之后遇到的一个问题
是，新映像要花很长时间才能检测到硬件。当部署许多服务器时，这会显著减慢部署过程。
要加快每个VM的初始配置，可以在运行Sysprep时使用/mode:vm选项。这将防止后续的部署删除硬件驱动程
序。保留硬件驱动程序，会显著加快新虚拟机的部署过程。
使用/mode:vm时，映像将特定于监控程序。因此，从Hyper-V虚拟机创建的映像不适合在VMware监控程序
上使用。
DISM
许多工具都可用来执行映像。其中一些工具允许捕获磁盘上的所有分区，而有些工具一次只处理一个分区。
Windows Server 2016中的部署映像服务和管理(Deployment Image Servicing and Management，DISM)工具一次映像
一个分区的内容，并将映像存储在.wim文件中。它是一个基于文件的映像工具。
DISM使用的.wim格式可以在一个文件中存储多个映像。在.wim文件中存储多个映像时，使用重复数据删除。
如果同一文件有多个副本，则.wim中只存储一个副本，但该副本对文件中包含的每个映像都可用。
当多个映像存储在单个.wim 文件中时，需要引用文件中映像的索引号或名称。索引号基于映像添加到文件的
顺序。当每个映像添加到文件中时，指定其名称。
要使用DISM捕获操作系统映像，必须关闭操作系统，以确保没有打开的文件。要运行DISM，需要使用另一
种操作系统来引导计算机。Microsoft提供Windows PE作为Windows评估和部署工具包(Assessment and Deployment
Kit，ADK)的一部分。可以配置Windows PE从USB驱动器或其他引导介质中引导。
有关Windows ADK和创建Windows PE引导介质的更多信息，请参见Download WinPE(Windows PE)，网址是
https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/download-winpe--windows-pe。
从Windows PE介质中引导时，可运行DISM来捕获或应用映像。通常，映像存储在网络驱动器上，它们也可
存储在本地介质上，比如USB驱动器。
如果将本地C:驱动器捕获到网络驱动器Z:上的.wim文件，就使用以下语法：
Dism /Capture-Image /ImageFile:Z:\Win2016.wim /CaptureDir:C: /Name:Win2016Image
要将映像应用到本地C:驱动器上，需要使用以下语法：
Dism /Apply-Image /ImageFile:Z:\Win2016.wim /Name:Win2016Image /ApplyDir:C:\
除了捕获和部署映像之外，还可以使用 DISM 来挂载和修改存储在.wim 文件中的映像。可进行简单的修改，
如添加、删除或编辑文件。还可对映像应用Windows Updates或安装新驱动程序。
1.3.2 Windows系统映像管理器
自动化安装Windows Server 2016的一种方法是使用answer文件。answer文件向Windows Server 2016安装过程
提供信息，修改默认的安装选项。例如，可创建一个 answer 文件，该文件定义在安装期间创建的磁盘分区、安装
语言和本地管理员密码，以避免在部署期间与安装程序交互。
用于创建answer文件的工具是Windows系统映像管理器(System Image Manager，SIM)，它包含在Windows
ADT中。
除了创建简单的answer文件之外，Windows SIM还创建了一个用于部署的分发共享文件(见图1.8)。在分发共
享文件中，可存储用于安装的.wim文件(从安装介质复制或自定义)、部署期间要添加的驱动程序和部署期间要添加
的更新。注意，在部署期间添加驱动程序和更新，可以避免更新.wim文件中的映像。
Windows Server 2016的安装过程有多个配置阶段。在安装过程的特定阶段，可应用无人值守的安装设置。添加
一个设置时，系统可能提供多个配置阶段选项，可将其添加到这些选项中。需要确保将设置添加到场景使用的配置
阶段。配置阶段参见表1.3。
10 精通Windows Server 2016(第6版)
图1.8 Windows SIM
表1.3 配置阶段
配 置 阶 段 说 明
这些设置是在运行setup.exe时、安装Windows操作系统之前实现的。可以包括setup.exe所需的设置，
Windows PE
例如语言和键盘设置。还可以包括磁盘分区信息。在使用Sysprep准备好映像后，不会使用这些设置
这个配置阶段复制并应用驱动程序和Windows更新。对于Windows Server 2016不包含的存储驱动器等
offlineServicing
专用硬件，可能需要添加驱动程序。在使用Sysprep准备好映像后，不会使用这些设置
Generalize 在Sysprep中选择Generalize选项时，应用这些设置。运行setup.exe时不使用这些设置
Specialize 这些设置是在Windows检测到新的硬件、生成 SID之后应用的
AuditSystem 这些设置仅在运行Sysprep后进入审计模式时应用
AuditUser 这些设置仅在运行Sysprep后进入审计模式时应用
oobeSystem 这是提示用户登录前的最后一个配置阶段
有关Windows配置阶段和使用answer文件的详细信息，请参见Windows Setup Configuration Passes，网址是
https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-setup-configuration-passes。
1.3.3 Windows部署服务
Windows部署服务(Windows Deployment Services，WDS)是Windows Server 2016中包含的一个服务器角色，用
于在网络上部署操作系统映像。可使用WDS在新服务器或新虚拟机上安装Windows Server 2016。其他一些部署方
法也使用WDS作为构建的基础特性集。
预引导执行环境(Preboot Execution Environment，PXE)是一个允许所有新计算机直接从网络上启动的系统。PXE
启动程序通过网络下载操作系统。WDS使用PXE下载一个小型操作系统映像，并应用或捕获映像。表1.4列出了