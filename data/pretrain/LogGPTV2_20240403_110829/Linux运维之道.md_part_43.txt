## Page 333
define
#调用templates.cfg文件中定义的loal-service，
define service
#调用templates.cfg文件中定义的linux-server，主要定义检查周期、频率以及通知时间段
define host{
[root@nagios~]# vim/usr/local/nagios/etc/objects/localhost.cfg
修改监控本机配置文件（localhost.cfg），该文件用于设置如何监控本机服务器资源。
#定义报警时间为7×24小时
define timeperiod(
[root@nagios ~]#vim/usr/local/nagios/etc/objects/timeperiods.cfg
修改时间定义配置文件，文件名为timeperiods.cfg，用于定义报警时间周期。
.其余部分省略.
..其余部分省略.
.其余部分省略
notifications_enabled
check_command
service_description
hostname
use
service{
check_command
service_description
host_name
use
address
alias
host_name
use
Saturday
Friday
Thursday
Wednesday
Tuesday
Monday
Sunday
alias
00:00-24:00
00:00-24:00
24 Hours A Day,7 Days A Week
00:00-24:00
00:00-24:00
00:00-24:00
00:00-24:00
00:00-24:00
check_http
HTTP
localhost
local-service
check_ping!100.0,20%!500.0,60%
PING
localhost
local-service
127.0.0.1
localhost
localhost
linux-server
主要定义检查周期、频率以及通知时间段
第5章
317
系统监控
---
## Page 334
al1owed hosts=127.0.0.1,192.168.0.10
#NRPE远程监控所需的具体监控指令
配置文件中定义的命令发送邮件报警）、报警选项（具体报警选项的含义见表5-4）。
表
Linux运维之道
5-4
318
[root@nagios ~]#vim /usr/local/nagios/etc/nrpe.cfg
修改NRPE配置文件（nrpe.cfg)，创建用于监控远程主机所需要的命令。
其余部分省略
define host{
define contact{
#]
修改模板配置文件（templates.cfg），
notification_period
register
选
retain_nonstatus_information
retain_status_information
process_perf_data
flap_detection_enabled
eventhandler
notifications_enabled
name
register
service_notification_commands
host_notification_options
service_notification_options
host_notification_period
service_notification_period
name
项
：
enabled
Down宕机
Recover恢复
Critical严重
Unknown未知
Warning警告
该文件主要定义一些其他配置文件需要调用的定义，
generic-host
generic-contact
24x7
notify-host-by-email
notify-service-by-email
d,u,r,f,s
W,u,c,r,f,s
24x7
24x7
一
功能描述
---
## Page 335
来)。
需要根据webl.cfg 的内容修改主机名称、IP地址以及主机组名称即可，这里就不再单独编写出
件需要手动创建，
..其余部分省略
notifications
define
define
define host{
创建远程监控配置文件webl.cfg与web2.cfg，用户监控远程服务器系统资源与服务，该文
check
define
notifications_enabled
check
define
notificat
check
[root@nagios ~]#vim/usr/local/nagios/etc/objects/web1.cfg
command
host_name
use
service
service_description
host_name
use
service{
service_description
host_name
use
service
members
alias
hostgroup_name
hostgroupt
address
alias
host name
use
ations_enabled
，可以用localhost.cfg 作为参考模板。下面为webl.cfg文件全文（web2.cfg仅
enabled
check_nrpe!check_users
Current Users
web1
generic-service
check_nrpe!check_load
Sys_Load
webl
generic-service
check_ping!100.0,20%!500.0,60%
PING
webl
generic-service
web1
Linux
一
webs
192.168.0.104
webl.example.com
webl
linux-server
Servers
第5章
319
系统监控
Z
---
## Page 336
nagios-plugin与nrpe软件包。下面仅以web1主机为例（web2做相同的操作即可）。
nagios -v/usr/local/nagios/etc/nagios.cfg。
动的情况,此时利用 Nagios 提供的一个检查排错工具可以快速定位问题点：/usr/local/nagios/bin/
提示
Linux运维之道
320
将下面这些操作步骤分别应用于web1和web2两台主机，远程监控时需要被监控端安装
因为 Nagios 的配置文件比较多，所以经常会出现当修改完配置文件后，Nagios 服务无法启
[PI:EMAIL]#chown
>/nagiosplug/nagios-plugins-1.4.16.tar.gz
[root@webl
3
[root@webl
[root@webl
[root@webl
[root@webl
[root@webl
[root@webl
[root@nagios nagios]# /etc/init.d/nagios restart
notifications_enabled
check command
define
check_command
define
notifications_enabled
check command
define
[root@webl
安装被监控主机软件（web1、web2所需软件包）
use
service_description
use
service_description
host
hostname
host_name
use
servicef
service
service
name
nagios-plugins-1.4.16]#make
nagios-plugins-1.4.16]#make
~]# cd /usr/src/nagios-plugins-1.4.16/
~]#
~]# wget http://prdownloads.sourceforge.net/sourceforge\
~]#useradd -g nagios -s /sbin/nologin nagios
~]
~]# yum -y install openssl openssl-devel
#
tar -xzf nagios-plugins-1.4.16.tar.gz -C/usr/src/
groupadd nagios
check_http
HTTP
webl
generic-service
check_ssh
SSH
webl
generic-service
check_nrpe!check_total_procs
Total Processes
webl
generic-service
-Rnagios.nagios/usr/local/nagios
install
#重新加载所有的配置
---
## Page 337
查看监控状态。客户端访问监控服务器的Web 服务效果如图5-18和图5-19所示。
example.com/nagios（需要DNS域名解析），访问监控服务器的Web页面，进行监控管理与
check_nrpe命令可以检测被监控端的NRPE版本号。
如果NRPE完全没有问题了，此时管理员可以通过客户端浏览器访问：http://nagios.
[root@web1 ~]# /usr/local/nagios/libexec/check_nrpe -H 192.168.0.104
管理员在 Nagios 主机上通过check_nrpe 检测被监控端相关的性能参数，单独使用
5.验收
[root@web1~]#netstat-nutlplgrep 5666
/soo#]
[root@web1 ~]#/usr/local/nagios/bin/nrpe -c /usr/local/nagios/etc/nrpe.cfg -d
..其余部分省略
command[check_disk]=/usr/local/nagios/libexec/check_disk -w 20%-c 10%
command[check_total_procs]=/usr/local/nagios/libexec/check_procs -w 150-c 200
command[check_zombie_procs]=/usr/local/nagios/libexec/check_procs-w5-c10-s
command[check_hda1]=/usr/local/nagios/1ibexec/check_disk-w20%-c10%-p/dev/sda
command[check_1oad]=/usr/1oca1/nagios/1ibexec/check_1oad -w 15,10,5 -c 30,25,20
command[check_users]=/usr/local/nagios/libexec/check_users -w 5 -c 10
#allowed_hosts设置允许哪台主机可监控本机
allowed_hosts=127.0.0.1,192.168.0.10
#NRPE远程监控所需的具体监控指令
[root@webl ~]#vim /usr/local/nagios/etc/nrpe.cfg
4.修改客户端NRPE配置文件
[root@webl ~]# service iptables save
[root@web1 nrpe-2.14]#make
[root@webl
[PI:EMAIL]#make
[root@web1 ~]# tar -xzf nrpe-2.14.tar.gz -C /usr/src/
>/nagios/nrpe-2.x/nrpe-2.14/nrpe-2.14.tar.gz
root@webl
root@webl
[root@webl ~]#wget http://jaist.dl.sourceforge.net/project\
nrpe-2.14]#make
nrpe-2.14]#
nrpe-2.14]#./configure
make all
install-daemon
install-plugin
第5章系
?
321
系统监控
Z
---
## Page 338
Linux运维之道
Nagios'
图5-19
---
## Page 339
第6章
过滤规则，iptables默认维护着四个表和五个链，所有的防火墙策略规则都将被分别写入这些表
修改内核，此时就需要一个像iptables这样的命令行工具，使用iptables可以添加、删除具体的
到系统内核中。而 iptables 是用户工具，由于netfilter 在内核空间中，用户通常无法接触内核和
部分。具体地说，netfilter是Linux内核内部的一系列钩子，这些钩子允许数据表过滤函数挂载
防火墙系统包括两部分：netfilte和iptables。netfilter位于内核空间，目前是Linux内核的组成
防火墙系统。
问控制工具的使用是至关重要的，而netfilter/iptables是集成在Linux2.4.X版本内核中的包过滤
握扎实的安全理论基础知识以及专业工具的使用技巧。要防止遭受网络攻击，掌握一种网络访
盗号、欺诈等活动。对于IT运维人员而言，如何防止自己的服务器免受攻击？这需要管理员掌
的环境也给我们带来了一些不便，在开放的同时，网络中还伴有大量的攻击、发送垃圾邮件、
络环境中，用户可以获得大量的资讯信息，也可以更加轻松地进行社交、学习等。但这个开放
6.1iptables防火墙
网络安全
netfilter/iptables框架可以实现数据包过滤、网络地址转换以及数据包管理功能。Linux中的
现代的计算机环境是一个网络的环境，而且是一个非常开放的网络环境，在这个开放的网
---
## Page 340
法
数据将经过PREROUTING链、FORWARD链以及POSTROUTING链。
机，数据将会经过OUTPUT链与POSTROUTING链：如果防火墙作为路由负责转发数据，则
墙本机，数据将会经过PREROUTING链与INPUT链；如果是防火墙本机发送数据包到外部主
图6-1展示了Linux防火墙的过滤框架，从图中可以看出，如果是外部主机发送数据包给防火
由前过滤）和POSTROUTING（路由后过滤），防火墙规则需要写入到这些具体的数据链中。
站数据过滤）、OUTPUT（出站数据过滤）、FORWARD（转发数据过滤）、PREROUTING（路
改数据标记位规则表）、raW（跟踪数据表规则表）。每个规则表中包含多个数据链：INPUT（入
下，当需要某个模块功能时，可以通过modprobe加载该模块功能。
CentOS6.3系统中防火墙模块存放在/lib/modules/2.6.32-279.el6.x86_64/kermel/net/netfilter目录
的Linux防火墙更加快捷、高效。
与链中。Linux 防火墙因为已经集成在内核中，所以相对于应用层防火墙产品而言，基于内核
Linux运维之道
6.1.1
管理员需要使用iptables 命令添加、删除防火墙规则，下面我们看看iptables 命令的具体用
默认的iptables规则表有：fileter表（过滤规则表）、nat表（地址转换规则表）、mangle（修
用法：iptables [-t 表名]{-A|-D|-I-D}-F|-L-Z|-P}链名 rule-specification
命令描述：netfilter防火墙规则管理工具。
iptables 有很好的可扩展性，也就是说，内核架构与 iptables 工具都可以添加扩展功能，
选项：-t
iptables防火墙语法格式
指定需要维护的防火墙规则表，不使用-t时，则默认操作对象为 filter 表。
INPUT
图6-1
Local Process
FOR
WARD
POSTROUTIN
OUTPUT
---