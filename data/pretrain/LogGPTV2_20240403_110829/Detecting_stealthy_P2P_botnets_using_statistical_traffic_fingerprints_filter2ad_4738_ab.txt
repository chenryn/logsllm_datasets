Gnutella&Bittorrent
Table I: P2P Applications
notation
ğ‘‡ğ‘2ğ‘
ğ‘ğ‘“
No-DNS Peers
ğ‘ğ‘ğ‘™ğ‘¢ğ‘ ğ‘¡
ğ‘ğ‘ğ‘”ğ‘
Ë†ğ‘‡ğ‘2ğ‘
Description
the active time of P2P application
the number of failed connections per hour
the percentage of ï¬‚ows associated with no domain names
the number of clusters left by enforcing Î˜ğ‘ğ‘”ğ‘ and Î˜ğ‘2ğ‘
the largest number of unique bgp preï¬xes in one cluster
the estimated active time for P2P application
Table II: Notations and Descriptions
high-level steps reported below:
nications.
1) Identify the set H of all hosts engaged in P2P commu-
2) Identify the subset P âŠ† H of P2P clients whose active
time is similar to the active time of the underlying
systems.
3) Identify the subset B âŠ† P which exhibit similar P2P
communication patterns, and a signiï¬cant overlap of
the set of contacted peers. We classify the hosts in set
B as P2P bots.
To illustrate the statistical features and motivate the re-
lated thresholds used by our system, we used ï¬ve popular
P2P applications (see Table I) for 24 hours to collect
their trafï¬c traces. For the Bittorrent application, we gen-
erated two separate 24-hour traces (T-Bittorrent and
T-Bittorrent-2). In this section we report a number
of measurements on the obtained trafï¬c traces to better
motivate some of our design choices. Table III reports the
feature values measured on the collected trafï¬c traces. The
notation used for our statistical features is summarized in
Table II.
We now describe the components of our detection system
in more details.
A. Trafï¬c Volume Reduction
As a ï¬rst step, we want
to ï¬lter out network trafï¬c
(and their sources) that is unlikely to be related to P2P
communications. This is accomplished in part by passively
analyzing DNS trafï¬c, and identifying network ï¬‚ows whose
destination IP address was previously resolved in a DNS
response. The reason is that P2P clients usually contact their
peers directly, by looking up IPs from a routing table for
the overlay network, rather than resolving a domain name
(a possible exception may be when a peer bootstraps into
a P2P network by looking up domain names that resolve
to stable super-nodes). This observation is supported by
Table III (No-DNS Peers), which illustrates the percentage
of ï¬‚ows whose destination IP was not resolved from a
domain name. It conï¬rms that the vast majority of ï¬‚ows
generated by P2P applications do not have destination IPs
resolved from domain names. The remaining small fraction
of ï¬‚ows are either related to bootstrapping (e.g., in the
Trace
ğ‘‡ğ‘2ğ‘
ğ‘ğ‘“
No-DNS Peers
ğ‘ğ‘ğ‘™ğ‘¢ğ‘ ğ‘¡
T-Bittorrent
T-Emule
T-Limewire
T-Skype
T-Ares
1602
318
1278
81
489
24hr
24hr
24hr
24hr
24hr
Table III: Measurement of Features
96.85%
99.99%
99.97%
99.93%
99.99%
ğ‘ğ‘ğ‘”ğ‘
12857
1133
5661
12806
1596
Ë†ğ‘‡ğ‘2ğ‘
24hr
24hr
24hr
24hr
24hr
17
8
36
12
16
case of bittorrent.com and skype.com) or for downloading
advertisement content from popular websites. Since most
non-P2P applications (e.g., browsers, email clients, etc.)
often connect to a destination address resulting from domain
name resolution,
this simple ï¬lter can eliminate a very
large percentage of non-P2P trafï¬c (see Section IV) while
retaining the vast majority of P2P communications.
B. Identifying P2P Clients
After trafï¬c volume reduction we consider the remaining
trafï¬c, and for each host â„ within the monitored network
we identify three ï¬‚ow sets (we call â€œoutgoingâ€ those ï¬‚ows
that have been initiated by â„):
1) ğ‘†ğ‘¡ğ‘ğ‘(â„): ï¬‚ows related to successful outgoing TCP con-
nections.
2) ğ‘†ğ‘¢ğ‘‘ğ‘(â„): ï¬‚ows related to successful outgoing UDP
(virtual) connections.
3) ğ‘†ğ‘œ(â„): ï¬‚ows related to failed outgoing TCP/UDP con-
nections.
We consider as successful those TCP connections with
a completed SYN, SYN/ACK, ACK handshake, and those
UDP (virtual) connections for which there was at least one
â€œrequestâ€ packet and a consequent response packet.
P2P applications act as both clients and servers. A node in
a P2P network can initiate (TCP or UDP virtual) connections
to its peers and accept connections initiated by other peers.
In client-mode, P2P nodes periodically probe their peers
with ping/pong messages to maintain a view of the
overlay network (usually for routing purposes), or search
for content. A consequence of this behavior is the fact that
P2P nodes will often generate a large number of failed
outgoing ï¬‚ows. The reason is that P2P networks are usually
characterized by a signiï¬cant node churn [4], due to previous
nodes that leave the network and new nodes that join it (the
churn is intuitively correlated with users that turn on or off
their P2P applications or machines). Therefore, a node that
sends a ping message to a known peer will often discover
that the peer is not up anymore (no pong is received, thus
causing a failed connection).
At this point, we retain all hosts that generated at least
a successful outgoing TCP or UDP connection, and that
generated more than a predeï¬ned number Î˜ğ‘œ of outgoing
failed TCP/UDP connections. Namely, we retain a host â„ if
âˆ£ğ‘†ğ‘¡ğ‘ğ‘(â„)âˆ£ + âˆ£ğ‘†ğ‘¢ğ‘‘ğ‘(â„)âˆ£ > 0 AND ğ‘†ğ‘œ(â„) > Î˜ğ‘œ, and discard
all other hosts (it is worth noting that here we are only
considering those ï¬‚ows that passed the DNS-based trafï¬c
volume reduction ï¬lter described in Section III-A). Table III,
reports the number ğ‘ğ‘“ of failed outgoing connections per
Authorized licensed use limited to: Tsinghua University. Downloaded on March 18,2021 at 14:47:04 UTC from IEEE Xplore.  Restrictions apply. 
124Tâˆ’Bittorrent
(1,1,145,319,UDP)
(5,3,346,170,TCP)
1
0.8
0.6
0.4
F
D
C
0.2
1
0.8
0.6
0.4
0.2
0
Tâˆ’Bittorrentâˆ’2
(1,1,145,319,UDP)
(5,3,346,170,TCP)
(1,1,145,310,UDP)
TCP
UDP
0
550
450
Flow Size (Bytesent + Byterecv)
500
(1,1,145,310,UDP)
TCP
UDP
550
450
Flow Size (Bytesent + Byterecv)
500
Figure 2: CDF of Flow Size
hour for different P2P applications. We can see that P2P
applications typically generate a large number (from several
tens up to thousands) of failed connection attempts with
other peers. Therefore, we conservatively set Î˜ğ‘œ = 10.
What we just described is a coarse-grained ï¬lter that
allows us to focus on candidate P2P nodes. We further apply
a more ï¬ne-grained analysis to prune away hosts that are
not actual P2P nodes. For example, we want to eliminate
hosts that made it into the list of candidate P2P nodes by
chance (e.g., because of scanning behavior). To this end,
we ï¬rst consider the fact that each node of a P2P network
frequently exchanges a number of control messages (e.g.,
ping/pong messages) with other peers. Also, we notice that
the characteristics of these messages, such as the size and
frequency of the exchanged packets, are similar for nodes
in the same P2P network, and vary depending on the P2P
protocol and network in use. In addition, we notice that a
node will often exchange control messages with a relatively
large number of peers distributed in many different networks,
where each network can be represented by its BGP preï¬x.
Figure 2 describes the distribution of ï¬‚ow sizes for two
Bittorrent traces, where a large number of ï¬‚ows share
similar sizes.
To identify ï¬‚ows corresponding to P2P control mes-
sages, we ï¬rst apply a ï¬‚ow clustering process intended
to group together similar ï¬‚ows for each candidate P2P
node â„. Given sets of ï¬‚ows ğ‘†ğ‘¡ğ‘ğ‘(â„) and ğ‘†ğ‘¢ğ‘‘ğ‘(â„), we
describe each ï¬‚ow as a vector of statistical features ğ‘£(â„) =
[ğ‘ƒ ğ‘˜ğ‘¡ğ‘ , ğ‘ƒ ğ‘˜ğ‘¡ğ‘Ÿ, ğµğ‘¦ğ‘¡ğ‘’ğ‘ , ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ], in which ğ‘ƒ ğ‘˜ğ‘¡ğ‘  and ğ‘ƒ ğ‘˜ğ‘¡ğ‘Ÿ rep-
resent the number of packets sent and received, and ğµğ‘¦ğ‘¡ğ‘’ğ‘ 
and ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ represent
the number of bytes sent and re-
ceived, respectively. We then apply an agglomerative hier-
archical clustering algorithm (described in detailed in the
following paragraphs) to partition the set of vectors (i.e.,
of ï¬‚ows) ğ‘‰ğ‘¡ğ‘ğ‘(â„) ={ğ‘£ (â„)ğ‘–}ğ‘–=1..âˆ£ğ‘†ğ‘¡ğ‘ğ‘(â„)âˆ£ and ğ‘‰ğ‘¢ğ‘‘ğ‘(â„) =
{ğ‘£(â„)ğ‘–}ğ‘–=1..âˆ£ğ‘†ğ‘¢ğ‘‘ğ‘(â„)âˆ£ into a number of clusters. Each of the
obtained clusters of ï¬‚ows, ğ¶ğ‘—(â„), represents a group of ï¬‚ows
with similar size. For each ğ¶ğ‘—(â„) (notice that each vector
can be mapped back to the ï¬‚ow it describes), we consider
the set of destination IP addresses related to the ï¬‚ows in
the clusters, and for each of these IPs we consider its BGP
preï¬x (using BGP preï¬x announcements). Finally, we count
the number of distinct BGP preï¬xes related to destination
IPs in a cluster ğ‘ğ‘”ğ‘ğ‘— = ğµğºğ‘ƒ (ğ¶ğ‘—(â„)), and discard those
clusters of ï¬‚ows for which ğ‘ğ‘”ğ‘ğ‘— < Î˜ğ‘ğ‘”ğ‘.
Host P2P
App
s
y
s
T
P
2
P
T
PING/PONG
Peer Discovery
Ë†
TP 2P = max(T (F C1), T (F C2))
Fingerprint Cluster 1
(FC1)
......
T(FC1)
Clustering
Two-level
(Birch + 
Hierarchical)
......
T(FC2)
Network 
Flows
Fingerprint Cluster 2
(FC2)
Figure 3: Example of Flow Clustering to Identify P2P Hosts
We call ï¬ngerprint clusters the remaining cluster of ï¬‚ows.
Therefore, each host â„ can now be described by a set of
ï¬ngerprint clusters ğ¹ ğ¶(â„) = {ğ¹ ğ¶1, .., ğ¹ ğ¶ğ‘˜}. We label â„
as P2P node if ğ¹ ğ¶(â„) âˆ•= âˆ…, namely if â„ generated at least
one ï¬ngerprint cluster.
The clustering algorithm for discovering clusters of sim-
ilar ï¬‚ows may affect the system efï¬ciency. For example,
a direct usage of hierarchical clustering algorithm (with
ğ‘‚(ğ‘›2) time complexity where ğ‘› is the number of ï¬‚ows) will
introduce prohibitive time consumption when processing a
large number of ï¬‚ows generated by a P2P node. Therefore,
we design a two-level clustering scheme to improve its
performance. First, given a pre-deï¬ned parameter ğ¶ğ‘›ğ‘¡ğ‘ğ‘–ğ‘Ÿğ‘â„,
we use BIRCH [23], a streaming clustering algorithm
with time complexity ğ‘‚(ğ‘›), to efï¬ciently identify at most
ğ¶ğ‘›ğ‘¡ğ‘ğ‘–ğ‘Ÿğ‘â„ sub-clusters from the sets of TCP and UDP ï¬‚ows
respectively, where the distance of two ï¬‚ows is deï¬ned
as the Euclidean distance of [ğ‘ƒ ğ‘˜ğ‘¡ğ‘ , ğ‘ƒ ğ‘˜ğ‘¡ğ‘Ÿ, ğµğ‘¦ğ‘¡ğ‘’ğ‘ , ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ].
Then, for each sub-cluster, we aggregate ï¬‚ows in it and
represent it using a vector, where this vector describes the
average value of each feature [ğ‘ƒ ğ‘˜ğ‘¡ğ‘ , ğ‘ƒ ğ‘˜ğ‘¡ğ‘Ÿ, ğµğ‘¦ğ‘¡ğ‘’ğ‘ , ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ]
of ï¬‚ows in this sub-cluster. We further apply hierarchical
clustering with DaviesBouldin validation index [7] on top
of the vectors (sub-clusters), and ï¬nd clusters of vectors,
where each cluster represents a set of similar vectors (sub-
clusters). For all the sub-clusters belonging to a cluster, we
ï¬nally group the ï¬‚ows in these sub-clusters to the same
cluster of ï¬‚ows. For this two-level clustering scheme, the
time complexity to process the ï¬‚ows of one P2P node is
mainly bounded by ğ‘‚(ğ¶ğ‘›ğ‘¡2
ğ‘ğ‘–ğ‘Ÿğ‘â„). Currently we conï¬gure
ğ¶ğ‘›ğ‘¡ğ‘ğ‘–ğ‘Ÿğ‘â„ = 4000 (the evaluation of system performance
over ğ¶ğ‘›ğ‘¡ğ‘ğ‘–ğ‘Ÿğ‘â„ is presented in Section IV-C5).
We applied this two-level clustering algorithm to the
sample traces of 5 P2P clients. ğ‘ğ‘ğ‘”ğ‘ in Table III presents
the maximum number of distinct BGP preï¬xes of destination
IPs in a ï¬ngerprint cluster. We therefore conservatively set
the threshold Î˜ğ‘ğ‘”ğ‘ = 50, which is much smaller than the
measured ğ‘ğ‘ğ‘”ğ‘.
Figure 3 illustrates an example of the ï¬‚ow clustering pro-
cess for a P2P node. Flows corresponding to ping/pong
and peer-discovery share similar sizes respectively,
and therefore they are grouped into two clusters (ğ¹ ğ¶1
and ğ¹ ğ¶2). Since the number of destination BGP preï¬xes
Authorized licensed use limited to: Tsinghua University. Downloaded on March 18,2021 at 14:47:04 UTC from IEEE Xplore.  Restrictions apply. 
125involved in each cluster is larger than Î˜ğ‘ğ‘”ğ‘, we takeğ¹ ğ¶ 1
and ğ¹ ğ¶2 as its ï¬ngerprint clusters. A ï¬ngerprint cluster
summary, (ğ‘ƒ ğ‘˜ğ‘¡ğ‘ , ğ‘ƒ ğ‘˜ğ‘¡ğ‘Ÿ, ğµğ‘¦ğ‘¡ğ‘’ğ‘ , ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ, proto), presents the
protocol and the average number of sent/received pack-
ets/bytes for all the ï¬‚ows in this ï¬ngerprint cluster. Examples
of ï¬ngerprint cluster summaries for two Bittorrent
traces (T-Bittorrent and T-Bittorrent-2) and one
Skype trace, are illustrated in Table IV. â€œ(1 1 145 319,
UDP)â€ and â€œ(1 1 109 100, UDP)â€ are shared by both
Bittorrent sample traces. The payload of ï¬‚ows cor-
responding to these two ï¬ngerprint clusters are illustrated
in Table V. It reveals that the ï¬ngerprint cluster of â€œ(1 1
145 319, UDP)â€ represents the ï¬‚ows for node discovery,
and that of â€œ(1 1 109 100, UDP)â€ contains the ï¬‚ows for
ping/pong.
C. Identifying Persistent P2P Clients
As we mentioned at the beginning of Section III, P2P bots
make themselves persistent into the compromised system,
and run for as long as the system is powered on. Based
on this observation, we aim to identify P2P clients that are
active for a time ğ‘‡ğ‘ƒ 2ğ‘ƒ close to the active time ğ‘‡ğ‘ ğ‘¦ğ‘  of the
underlying system they are running on. While this behavior
is not unique of P2P bots and may be representative of other
P2P applications (e.g., Skype clients that run for as long as
a machine is on), identifying persistent P2P clients takes us
one step closer to identifying P2P bots.
To estimate ğ‘‡ğ‘ ğ‘¦ğ‘  we proceed as follows. For each host
â„ âˆˆ H that we identiï¬ed as P2P clients according to
Section III-B, we consider the timestamp ğ‘¡ğ‘ ğ‘¡ğ‘ğ‘Ÿğ‘¡(â„) of the
ï¬rst network ï¬‚ow we observed from â„ and the timestamp
ğ‘¡ğ‘’ğ‘›ğ‘‘(â„) related to the last ï¬‚ow we have seen from â„. After-
wards, we divide the time ğ‘¡ğ‘’ğ‘›ğ‘‘(â„)âˆ’ ğ‘¡ğ‘ ğ‘¡ğ‘ğ‘Ÿğ‘¡(â„) into ğ‘¤ epochs
(e.g., of one hour each), denoted as ğ‘‡ = [ğ‘¡1, ..ğ‘¡ğ‘–, .., ğ‘¡ğ‘¤].
We further compute a vector ğ´(â„, ğ‘‡ ) = [ğ‘1, ..ğ‘ğ‘–, .., ğ‘ğ‘¤]
where ğ‘ğ‘– is equal to 1 if â„ generated any network trafï¬c
between ğ‘¡ğ‘–âˆ’1 and ğ‘¡ğ‘–. We then estimate the active time of â„
as ğ‘‡ğ‘ ğ‘¦ğ‘  =
âˆ‘ğ‘¤
ğ‘–=1 ğ‘ğ‘–.
The challenge is how to accurately estimate the active time
of a P2P application. Since a P2P application periodically
exchanges network control (e.g., ping/pong) messages with
other peers as long as the P2P application is active, we
can leverage the active time of a ï¬ngerprint cluster, which
represents ï¬‚ows of control messages, in order to estimate
the active time of the corresponding P2P application. For
each host â„ (again, we consider only the hosts in H, which
we previously identiï¬ed as P2P clients) we consider the set
of its ï¬ngerprint clusters ğ¹ ğ¶(â„) ={ğ¹ ğ¶ 1, ..ğ¹ ğ¶ğ‘—.., ğ¹ ğ¶ğ‘˜}
(see Section III), and for each ï¬ngerprint cluster ğ¹ ğ¶ğ‘— we
compute a vector ğ´(ğ¹ ğ¶ğ‘—, ğ‘‡ ) = [ğ‘ğ‘—
ğ‘¤] where an
element ğ‘ğ‘—
is equal to 1 if the ï¬ngerprint cluster ğ¹ ğ¶ğ‘—
ğ‘–
contains a ï¬‚ow between ğ‘¡ğ‘–âˆ’1 and ğ‘¡ğ‘–, otherwise ğ‘ğ‘—
ğ‘– =
0. We compute the active time of a ï¬ngerprint cluster
ğ¹ ğ¶ğ‘— as ğ‘‡ (ğ¹ ğ¶ğ‘—) =
ğ‘– . Finally, we estimate the
ğ‘– , .., ğ‘ğ‘—
âˆ‘ğ‘¤
1, ..ğ‘ğ‘—
ğ‘–=1 ğ‘ğ‘—
Trace
T-Bittorrent