中人（
交换机型号
禁客候章以最本主
JAME
表7-1思科交换机CAM值
310
>131072
55000
32768
12000
>12000
8192
>10000
16000
8000
CAM数值
明（&o9）
DAM
PRA.IV
cnaham
星
---
## Page 250
号及信用卡号等….….为了让你相信，下面是你的几个账户信息。
找你，刚收到这封电子邮件，你看看邮件内容。”
总是让他神经紧张。
产部门，所以不受重视；可是一旦系统出现问题，还会被“打板子”。系统维护的巨大压力
威胁邮件。本案中主要遇到的问题是服务器受到了SQL注入攻击。
案例背景
CISSP)
的漏洞。他们是如何在日志中发现入侵行为的呢？
是如何被入侵的呢？为了查清此事，技术人员紧密协作，在分析了大量日志之后找到了系统
件实现监控SQL注入攻击。
止SQL注入攻击的责任。本章最后讲解如何通过OSSIM系统和VisualLogParser这两款软
可执行的SQL语句，那样后果是非常严重的。所以每个开发应用的程序员都应该肩负起防
程师设置的铜墙铁壁，绕过系统工程师的各种应用防护最终到达企业的数据中并自动重组为
工程师等运维人员的事情，因为如果程序有漏洞的话，那些有攻击性的字符串会穿过网络工
它实在太难防治。本章通过两个案例说明，防治SQL注入攻击已不仅是系统管理员或网络
本案例详细描述了某公司的后台服务器被入侵，黑客从中获取了大量游戏币账号并发送
8.1案例十三：后台数据库遭遇SQL注入
小丁是公司运维部网管，他技术好，人缘也不错。运维部门平常任务繁重，但不属于生
网络管理员收到一封邮件，阅读之后才恍然大悟，原来系统遭到黑客入侵。系统数据库
User1-5111111111111111
我发现你的网站有一个安全问题。我这里有你们公司XX系统所有用户的记录和游戏账
以下是邮件内容：
一天，小丁像往常一样，正在忙碌着，他的上司董经理突然对他说道：“小丁，我有事
故事人物：小丁（网管）、小贾（网管）、董大伟（部门经理）、高德（前任工程师
关键日志：防火墙日志及规则、IS日志
难度系数：★★★★
如今SQL注入问题在网站管理员眼里变得非常重要，甚至到了谈虎色变的地步，因为
User3-5555511111111111
User2-4111111111111111
第8章 SQL注入防护案例分析
---
## Page 251
构图。
计。他怀疑小丁改动了网络结构和相应的配置文件。这时，小丁拿着一叠资料走进会议室。
司的时候，设计的网络体系结构。他记得当时所有严格的防火墙规则和几乎完美的DMZ区设
了。小丁和高德找了一个会议室，迅速开始工作。小丁告诉了高德有关细节。高德说：“我
（董经理为了不让事情扩大，没有选择报警，而是让小丁赶紧找高德，他曾是公司唯一的
接替他的工作。
多大影响呢？简直无法估量！
确定那些用户账号和密码的真实性，经核实结果完全真实。这时，小丁非常紧张，这会造成
击了防火墙，进入数据库获得了这些账号。为了查明原因，小丁迅速与公司的DBA联系以
228UNIX/Linux网络日志分析与流量监控
楚他是怎么入侵的。”应
需要最新的网络拓扑、防火墙规则，还有那份电子邮件所有信头的信息。看我们是否能搞清
工高德接到小丁的求助后，下班之后立刻赶了过去。当他到了现场，已经是晚上8点多
CISSP.
“这是所有的数据，老高。”高德在桌子上展开了这些文件。图8-1是公司的网络结
小丁跑去收集高德需要的数据。高德坐在椅子上，整理着思路。高德回忆起他当年在公
在网络安全方面以前是系统架构师高德负责，自从他离开公司后，公司并没有安排新人
看了这些信息，小丁有些疑惑，难道是诈骗邮件？如果是真的，那么很显然有人已经攻
图8-1典型的双防火墙结构
Router
数据库PIX防火墙
192.15024
WEBPIX防
火墙
me-
-
内量
家水
T小
12815
---
## Page 252
边说边递过来iPad，上面清楚地显示如下代码：
时，网管小贾冲进门来说道：
日志）中丝毫没有找到线索，这时他们完全被海量日志淹没了，高德看得眼晴直发胀。这
些天谁看了Web服务器的日志？”
补丁。”
德问。
哪有时间作改动啊！系统配置应该还和以前都一样。”
下。”
“哦，老高，你来啦。我只是看一些奇怪的错误，也不太明白，我还拍了张照片。”小贾
“小丁，快过来，我有事找你。昨天晚上 SQL 服务器发生了奇怪的事情，你最好来看
“我很肯定负责市场的小贾看过。”小丁说。
“好吧，看起来唯一能进入的通道就是Web服务器。咱们从那里着手。”
“所有的Windows Server 2003服务器都运行了最新的补丁，我很肯定 SQL 服务器打了
“怎么啦，小贾？”高德迫不及待追问道。
“我现在真的没有时间。”小丁说道。
高德开始反复查阅小丁获得的日志记录，但是在这些日志（包括交换机防火墙及IDS的
“这是你要的所有日志。”
“好的。我需要最近4周的日志。”
高德从他的黑色双肩背包里抽出笔记本电脑。“我准备扫描一下Web 服务器的漏洞，这
“没有啊，老大。自从你走后，我一直忙着“救火”（实际上是维护PC 的琐碎工作)，
小丁走出门，开始一点一点收集文档。他拿回来一大堆设备归档日志，摆在高德面前
高德认真检查了网络图和防火墙规则。“我走后你改动了什么吗，小丁？”
下面是高德从小丁那里得到的黑客邮件的头信息：
如下是公司的数据库防火墙规则：
公司的Web防火墙规则：
Conten-Type:text/html;charset=us-ascii
at
Conduit permit tcp host 192.150.52.4 eq 1443 host 192.168.50.5
Conduit permit tcphost192.150.50.5eq443any
Conduit permit tcp host 192.150.50.5 eq www any
red:
Har
201011:54:30
2.131.2/8.13.2m
-0700
-ID:
withcsm(pe
(PDT)
8543
第8章SQL注入防护案例分析229
02
dMet,13
.com>;lon,13
---
## Page 253
送电子邮件的IP地址恰好匹配。”
了什么，但是这种请求恰恰吻合了SQL 错误的次数。我的依据是POST 请求的 IP 地址和发
个ASP页面的连续请求？这非常可疑。因为这是POST 请求，我们看不到攻击者究竟访问
个 web应用问题。查看Web 服务器日志帮助我证实了这一点。你们是否注意到了针对同-
是我不能完全肯定。然后小贾把SQL服务器的错误送了过来，这很凑巧——它看起来像-
记得当初我配置它们时，安全度相当高，所以应该不是Web服务器自身的漏洞引起的，但
Web 服务器为目标，因为它是向因特网开放的唯一的服务。首先检查Web 服务器本身。我
“怎么会这样呢？”小丁和小贾他们一头雾水。想目单
可以访问任何应用能够访问到的数据，包括SQL Server数据库。”
志会和数据库有关联吗？继续看看他们师徒二人的对话。
网络设备防护如此严密的公司还是遭到入侵，大家一定想知道到底发生了什么。这些日
分析过程
互动问答
找到第一个SQL服务器错误的时间记录：
光盘上打开ⅡIS服务器的日志文件，开始逐页地仔细查看，直到下面这条记录闪过眼前，他
230
高德解释了这一过程：“我们先看看防火墙的规则，很容易就可以知道任何攻击都会以
“都不是，这叫 SQL 注入。这家伙正在通过你的 Web 应用远程运行 SQL 查询指令。他
“什么？这属于什么攻击？是蠕虫还是DDoS？”小丁疑惑地问。
“我知道系统里发生了什么。有入侵者正在试图进入应用系统。高德说。
5.你知道哪些数据库评估工具？
1．网络拓扑图和防火墙规则对确定可能的入侵途径有什么帮助？
“我找到突破口啦！”高德兴奋地叫起来。
这时高德眼前一亮，直觉告诉他这段日志很关键，他几乎能断定出了什么状况。他又从
UNIX/Linux网络日志分析与流量监控
这封电子邮件是否还提供了其他线索？
什么样的攻击方法产生了电子邮件中的数据？
日志中是否显示了发现侵入方法的细节？
5:32
A
TOS
800404
00401
Mi
Micx
DB
FOOS
15V798
Driver
AuthenticateCustome
---
## Page 254
器的错误联系起来。
访问的时间。本例中，这两种信息有助于缩小嫌疑的范围，并且将 POST 请求和 SQL 服务
肯定有问题了，但是访问流量通常都是正常的。我们可以从 IS 日志得到访问者的 IP 地址和
法得到可以下定论的详细信息。如果有人持续地向同一个页面发送POST请求，则可以推断
因为防火墙也可能失效，所以这种假设不一定总能成立，但是在调查期间可以作这样的假设。
用的Web 服务器端口 80和443来访问Web服务器。高德作了一个假设，假设防火墙没有漏洞。
工1．网络结构图和防火墙规则帮助高德缩小了侵入网络可能的入口。防火墙规则只允许通过常
疑难解答
另一个开发人员提议。
JavaScript。”高德回答道。
输入的所有撇号（"）和引号（")。”他说。
惊，以至于问不出问题。高德继续解释为了降低风险需要怎做：“我们需要做的是过滤用户
建议小丁遵循Microsoft发布的IIS安全指南。Adi
这有助于攻击者获得SQL数据库的位置，并且有助于他快速设计出正确的查询语句。高德
装过，但是没有遵循好的安全实践——特别是ODBC出错的详细信息被返回给了客户端，
作用不大，但是它至少可以使黑客的攻击多了一道障碍，让他知道我们公司已经注意到了他。
工作。我给我们的律师打电话”。董经理说道。
重的网络问题。他需要迅速报告公司CEO并开始修补行动。些一不匠受
2.IIS日志在本例中的作用有限。Web服务器不能记录POST请求的细节，所以我们无
高德和小丁回到手头上的工作。小丁对ⅡIS服务器设置做最后的检测，而高德去和应用
高德和小丁的下一步工作是重新配置IS服务器。高德离开公司后，Web服务器重新安
国高德开始在防火墙和IS服务器处屏蔽黑客的IP地址。高德知道这对阻挡进一步的攻击
“我想我们能够写一个通用的分析器，将它包含进我们与数据库进行交互的所有页面。
高德迅速向开发人员讲解了一下，以便加快问题的解决速度。大部分开发人员非常震
“高德，我需要你提出一个计划以保护我们的网络。你们是搭档，小丁，你配合高德的
高德将案情的查询经过都解释给董大伟经理。董大伟明白了最终的结论：公司面临最严
“谢谢，老弟！”
“太好了！谢谢，伙计。”高德站起来离开了房间。
“是的，这是一个好的开始，但是我们还是需要将它构建进入ASP 的网页。可以绕过
“我们能够很容易地将它们加到JavaScript 的过滤器中。”
“好吧，大伟。我们能够修复服务器上的许多BUG，”高德说道。
如果我们能够修复这个问题，那么黑客会知难而退的。”
“这下好了，至少可以暂时挡住他了。”高德自嘲地说。善击丸这
“只要能修复这个问题，怎么都行，高德。”董大伟说完走出了房间。
“问题是黑客极有可能已经获得了他要的数据。我们应该修补漏洞，亡羊补牢。”未
小丁追问：“我们现在应该做什么？”102
繁益第8章SQL注入防护案例分析231
一个开发人员提议。
四十案
d
C8
---
## Page 255
事件背景
防护极为严格的网络环境下发生的SQL注入案例。
8.2 案例十四：大意的程序员之 SQL 注入
露。要考虑的最后一个重要步骤是删除无用的数据。这会有效限制数据泄密造成的影响。
能够起到重要作用。对于数据库敏感信息（例如用户名、密码）的加密能够进一步保护它免于泄
Web应用使用一个账号来访问数据库。应该尽可能地给予这个账号最少量的特权。加密数据库也
和禁用 xp_cmdshell。
议关闭或限制访问权限。 可以使用外围应用配置器工具，以及通过执行 sp_configure 来启用
在数据库端，数据库管理员（DBA）应该删除所有不必要的存储过程，例如Microsoft SQL
SQL注入，但是它禁止了将有用信息返回给攻击者。没有这些信息，入侵就变得极其困难。
预防与补救措施
当5.大家可以在 BT 工具箱中找到 MySQL、Oracle 的评估分析工具，位置在 Application→
据库访问的范围。
息，攻击者十分清楚他能够以某种方式访问数据库。这使得调查者将搜索范围缩小到涉及数
邮件发送者和攻击者紧紧联系起来。第二条线索是用户数据中包含的信息。通过包含这些信
人员能够获得关于这个电子邮件发送者的许多信息。在这个例子中，攻击者每次都使用同一
在http://www.owasp.org/asac/input_validation/sql.shtml找到。
据受到威胁，不过有时也对一些平台的底层操作系统产生威胁。对这个问题的全面介绍可以
注入到这样的一个查询中，而绕过应用程序的正常操作。这种类型的攻击最常见的结果是数
陷：未经检查的用户提供的数据直接用于SQL查询中。攻击者能够将自己设计的SQL指令
232UNIX/Linux网络日志分析与流量监控
BackTrack→VulnerabilityAssessment→DatabaseAssessment路径下。
个系统发送电子邮件攻击Web服务器。这使得调查人员可以找准问题的原因，并且将电子
在Web服务器层所能做的最重要的改变是关闭ODBC返回的详细信息。这虽不能防止
即使在严格的防火墙策略下，含有漏洞的程序代码也会让入侵者得逞。接下来讲述了在
在创建数据库用户时，数据库管理员应该赋予用户账号以完成他们工作的最小权限。大部分
 xp_cmdshell 中运行系统命令行的系统存储过程，一般在安全级别较高的服务器上，
小陈是某公司信息中心维护组的管理员，
4．电子邮件提供了一些可能的线索。特别是电子邮件的头信息。利用这一信息，调查
故事人物：小陈（系统管理员）、小万（程序员）
关键日志：IS日志
难度系数：★★★★
提示：