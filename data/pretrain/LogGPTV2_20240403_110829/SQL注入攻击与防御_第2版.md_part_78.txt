只有识别出与攻击有效载荷关联的事务，才可以执行回滚。Lilupophilupop端虫就是一
个投送静态有效载荷的端虫，它搜索表，寻找适当的列以容纳恶意代码，最终将恶意
代码写入到找到的列中。下面是一个示例查询，它搜索Microsoft SQLServer事务日志，
寻找运送了Lilupophilupop端虫所投送载荷的事务：
select proname as "OBJECT_NAME*, '' as *OBJECT_SCHEMA*, 'PROCEDURE′ as
"OBJECT_TYPE* from P9_Proc UNION ALL select tgname, *', *TRIGGER
from pg_trigger
UNION ALL select tablename, schemaname, *TABLE' from Pg_tables UNION
ALL select usename, *', 'usER' from pg_user
在上面的查询中，将基于十六进制的事务日志的值转换为字符格式，并将其与端虫载荷的
片段进行比较。下面的结果显示了端虫执行的事务，端虫将它的载荷写入到数据库的表中。查
询示例的结果如图10-8所示。可以使用前面的信息来标识需要恢复的事务。既可以手工创建
undo事务的脚本，也可以使用日志读取工具创建undo事务的脚本，比如用于Microsoft SQL
Server 和其他数据库产品的ApexSQL，以及Oracle 发布的用于回滚Oracle 事务的免费工具
380
---
## Page 395
第10章确认并从SQL注入攻击中恢复
Logminer.
transaction_id
operation
table
page
record_d
record_offset
0000:000003oce
LOP_MODIFY_ROW
dbo.Employee
0001:0000004
13
0000:000003ce
LOP_MO0IFY_ROW
dbo.Emplkyee
0001:0000004
13
0000:000003ce
LOP_MO0IFY_ROW
dbo.Empleyee
0001:0000004
13
0000:000003oe
LOP_MO0IFY_ROW
dbo.Empleyee
0001:0000004
3
13
0000:000003ce
LOP_MO0IFY_ROW
dbo.Enpkoyee
dbo.Employee
0001:0000004
13
0000:000003oe
LOP_MO0IFY_ROW
0001:000000#
5
13
0000:000003ce
LOP_MODIFY_ROW
dbo.Engkoyee
dbo.Empleyee
0001:0000004
6
13
0000:000003ce
LOP_MODIFY_ROW
doo.Engkoyee
0001:0000004
7
13
0000:000003oe
LOP_MODIFY_ROW
0001:0000004
0000:00030eLOP_MOOIFY_ROWd
8
13
dbo.Employee0001:000004
6
13
图 10-8包含 Lilupophilupop 螺虫所执行的 Microsoft SQL Server 事务的查询结果示例
图10-9是使用 Oracle Logminer浏览事务的屏幕截图。在该页面i中单击Flashback Transaction
按钮，将无缝地回滚Oracle1lg或更高版本中的事务。更详细的信息可以参考OracleFlash的网
(http://oracleflash.com/28/Oracle-11g-Using-LogMiner-to-analyze-redo-log-files. tml)
ORACLE Enterprise Manager M1g 
Database.lnstanct_gtalLa,hemt.com >
Logged in As SYS
Transaction Details
Flashback TransationPrevicus Transartion)Nent TrantactinOK)
Transacion ID 02000000A7020000
Commit SCN 83833
tEar NOS wNS
Commit Time Jun 20, 2010 10:50:34 AM
Staet Time Jun 20, 2010 10:50:31 AM
Machine Name
SCNOperation Schema Table
SQLRedo
883831 START
883831 INSERT
SCOTT
TEST_LOGMNRinse into“SCOTTTEST_LOGMNR”values ID*= 1.*NAME*='AAA"
883833 COMMT
commit
Flashback TransactionPrevtous Transaction)
Net TransactionOK
Database I Sehz I Prelerences 1I Hesp I L2ggst
图10-9使用Oracle Logminer 浏览事务的屏募截图
(2）检验数据库服务器配置：如果静态有效载荷带有频繁针对RDBMS特性的攻击，或者
解除服务器的安全配置以实现进一步的攻击，那么应该将数据库服务器的配置恢复到已知的良
好状态。无论是从备份中恢复受损害的数据库，还是手工回滚事务，在攻击期间对服务器范围
内任何配置设置的改变都将保留下来，直到明确地识别配置的改变并恢复设置。应该对服务器
配置的设置进行审计，确保它们与预期的配置保持一致。
(3）识别并修复SQL注入漏洞：确保对整个代码库进行一次应用程序安全评估，以识别可
被利用的漏洞和其他可能存在的情况。
(4）在线恢复系统并恢复Web服务。
3.从携带动态有效载荷的攻击中恢复
携带动态有效载荷的攻击恢复起来非常困难，因为攻击者的行为会随着每一种损害而发生
381
---
## Page 396
SQL注入攻击与防御（第2版）
较大的变化。如果SQL注入攻击是通过HTTPPOST请求发起的，那么绝大多数Web服务器
都没有配置为可以在日志中记录这种活动。如果在受到攻击损害与调查取证之间，间隔了较长
的时间段，那么执行计划和其他证据可能已经被覆写了（overwritten）。还存在其他方面的复杂
性，比如攻击者可疑脱离了数据库的上下文进入操作系统，建立到受攻击服务器的带外连接，
并旁路(bypass)数据库以继续利用漏润进行攻击。对于携带动态有效载荷的成功攻击，强烈建
议聘请数据库取证专家进行调查取证。虽然网上有很多学习数据库取证的优秀资源，但都无法
代替专家的经验。安全专家可以很快缩小审查的范围并从安全事件中恢复。我们可以遵循下列
步骤：
(1）恢复数据库状态：对于动态有效载荷的SQL注入攻击，建议将RDBMS和操作系统都
恢复到受损害之前的状态。请注意，这可能会丢失从已知良好状态到递制安全事件这段时间内
的事务。也可以选择不按照推荐的方法恢复数据库和操作系统。在这种情况下，可以遵循静态
有效载荷攻击的恢复步骤来恢复数据库。笔者必须事先提出警告，攻击与调查取证之间存在一
定的时间间隔，攻击的痕迹可能已经被部分覆盖，很可能无法准确地捕获攻击者在系统上执行
过的所有操作和活动。因此，静态有效载荷攻击的恢复步骤，并不能将数据库服务器完全恢复
到清洁的状态，在恢复之后攻击者可能依然维护持服务器或网络设备的控制。对于这样的风险
必须格外小心。
(2）识别脱离数据库的活动：在之前收集好的恶意查询清单中，应该标识出那些允许攻击
者脱离数据库服务器、进入底层操作系统的文件系统或注册表的语句。如果发现针对操作系统
的活动，就应该执行下列操作：
·查找创建了带外通信的任何方法，比如创建操作系统用户账号的方法，攻击者可以使
用创建的账号进一步攻击数据库的外部。
·查找对操作系统文件的引用，或者攻击者读取、创建或加载到数据库中的注册表键值
(key)。确保从法律取证角度保护文件或注册表键值，然后查阅副本，搞清楚攻击者执
行了哪些操作。这种分析还可能识别出其他带外连接的方法，比如通过SQL注入漏洞
将恶意文件上传到某个表中，然后输出恶意文件并在受害系统上重新构建。
·查看网络日志，标识从数据库服务器到其他联网机器的通信。如果发现可疑的活动，
应该调查有关的主机是否有受攻击。
(3）检验数据库服务器的配置：一旦攻击者获得对数据库服务器的访问之后，他就会解除
存在的安全设置，以便进一步在服务器上实施攻击。将受损害的数据库恢复到已知的良好状态，
并不能消除攻击者可能已经创建好的后门，比如攻击者创建的RDBMS登录账号。应该对服务
器执行一次审计，以确保现在的服务器设置依然保持在正常状态。
（4）识别并修复SQL注入漏洞：确保对整个代码库进行一次应用程序安全评估，以识别可
被利用的漏洞和其他可能存在的情况。
(5）在线恢复系统并恢复Web服务。
10.4小结
dictionary.com将防御定义为“抵抗危险、攻击或伤害”。SQL注入的传统防御方法，比如
安全编码实践、Web应用程序防火墙和漏洞评估程序都是有效的防御措施，这些措施可以减少
382
---
## Page 397
第10章确认并从SQL注入攻击中恢复
组织机构遭到与SQL注入攻击有关的损害，信息安全就是猫和老鼠的游戏，安全专家不断地
防御攻击，而黑客则不断变化，想方设法进行攻击以突破防御。攻击与防御的游戏周而复始不
断上演，具有基于Web的应用程序的组织机构，都不可避免地面临对SQL注入攻击进行调查
取证的问题。
当重新审视对防御的定义时，请记住：组织机构也可能面对危险、攻击或伤害。这样的组
织机构常常无法高效地响应安全事件，无法判伪一次可疑的SQL注入攻击，或者无法从一次
成功的SQL注入攻击中恢复，从而不能将遭受攻击造成的业务影响降低到最小。
利用本章介绍的调查取证、遂制SQL注入攻击和恢复实践，可以增强传统的防御措施，
创建全盘SQL注入防御策略。只要有了这种整体性的策略，就可以在攻击前、攻击时和遭到
攻击之后保护组织机构。
10.5快速解决方案
1.调查可疑的SQL注入攻击
·只能由计算机安全事件响应人员和组织机构中已授权执行调查的取证专家，来执行SQL
注入攻击的调查取证工作。
2.合理的调查取证实践要求
·在调查取证期间，应该对收集到的所有文件真正做到bit-for-bit复制。
·应该为复制的每一个文件生成哈希值，并与源文件的哈希值进行比较，以验证bit-for-bit
复制的完整性。
·将调查取证期间执行的所有操作记录在文档中，包括对RDBMS执行的所有查询和返
回的查询结果。
·确保将所有收集到的文件写入洁净的存储介质中，并保存在一个安全的地方。
·为所有收集到的证据维护监管链。
3.分析数字化痕迹
·数字化痕迹就是相关数据的集合。
·对于SQL注入攻击的调查取证，下列痕迹非常有用：Web服务器的日志文件、数据库
执行计划、事务日志和数据库对象的时间数。
4.识别SQL注入攻击活动
·对Web服务器的日志文件执行一次广泛的分析，查找异常偏高的Web请求数量出现
的日期，或者Web服务器与客户端计算机之间带宽利用率异常偏高的日期。
·检查数据库执行计划和相关日志，查找恶意查询。
·检查事务日志，寻找在攻击时间段内出现的可疑活动，重点关注已执行的INSERT、
UPDATE 和 DELETE 语句。
·检查数据库对象的时间截，以识别用户账号的创建、权限提升和表的创建操作。
383
---
## Page 398
SQL注入攻击与防御（第2版）
5.确认SQL注入攻击是否成功
·如果发现下列情况，就可以确认一次SQL注入攻击已经成功：
》在数据库的执行计划或相关数据库日志中捕获了SQL注入的活动。
》在未经授权的情况下，创建或修改了事务或对象。
6.遇制安全事件
·拔除受损害数据库和相应Web服务器的网线。
7.评估涉及的数据
·必须对数据进行评估，以确保组织机构确定适当的监管和法律要求。
8.通知正确的人员
·应该由受损害组织机构的高级管理人员和法律顾问对损害通报进行管控。
9.确定攻击者在系统上执行的操作
·可以通过对数据库进行取证，确定攻击者在攻击期间执行的具体操作。
10.确定攻击的有效载荷
·备份受损害的数据库。
·提取恶意的SQL注入查询。
·检查并理解恶意查询的逻辑，从而理解攻击载荷企图实现什么目的，
·搜索对恶意查询的引用。
·确定已识别的恶意查询是否属于静态或动态攻击载荷的一部分。
·查找多种漏洞。