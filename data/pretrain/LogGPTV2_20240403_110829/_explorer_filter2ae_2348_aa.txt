# 安全研究 | 关于explorer一键挖矿病毒的分析研究

##### 译文声明
本文是翻译文章。译文仅供参考，具体内容和含义以原文为准。

近期，我们的海青安全研究实验室捕获了一个新的挖矿木马样本，目前网络上尚未见到关于它的详细分析。与以往的木马相比，这个样本在隐蔽性和清除难度上都有了显著提升。我们对其进行了全面分析，希望为行业内提供新的认识，并发掘更有效的防护措施。

## 一、木马简介
适用环境：Powershell v3及以上版本（v1/v2未测试）

## 二、木马特点
1. **纯Powershell编写**：挖矿前置脚本完全使用Powershell编写，而非简单的批处理脚本，通过一系列持久化机制确保其挖矿功能。
2. **探测机制**：能够探测防火墙、虚拟机及反木马软件，并根据探测结果采取相应行为。
3. **配置修改**：修改防火墙和反木马软件的配置和策略，避免被扫描和阻断挖矿链接。
4. **缓存认证密码**：可选增加用户等机制，提高安全性。
5. **代理中转**：每个被感染的设备都作为代理服务器，增加了追踪溯源的难度。
6. **更新维护**：具有自动更新维护机制，若不清除干净，会频繁复发。
7. **隐藏文件**：将文件存放在系统隐藏目录中，难以清除。
8. **排除竞争对手**：清除其他挖矿进程，确保自身利益最大化。
9. **技术复杂**：涉及多方面的技术手段。

### 执行流程
- 对应文件功能
- 网络代理方式

## 三、Powershell木马代码审计
木马Powershell脚本开头定义了参数集，默认使用`Setup`参数集。脚本初始化时，给基本变量赋值，包括脚本名、脚本路径和服务名等，并输出木马版本为2017-12-10。

### 自定义函数
```powershell
$argv0 = Get-Item $MyInvocation.MyCommand.Definition // 获取当前运行目录
```

#### 默认执行流程
1. **获取系统类型架构**
2. **比较安装目录与执行目录脚本时间差**：判断是否需要更新服务。
3. **创建服务运行机制**：`$source`变量保存服务主函数，之后将其编译成二进制程序`cspsvc.exe`（程序名随编译的脚本名改变而改变）。
   - 功能：注册服务后，`cspsvc.exe`带参数`-SCMStart`启动`cspsvc.ps1`脚本，重新以管理员权限运行`cspsvc.ps1`脚本。
4. **配置服务运行账户**：默认为`LocalSystem`。
5. **读取配置文件**：尝试从`c:\windows\fonts\arial\config.xml`或`c:\windows\SoftwareDistribution\config.xml`中读取配置，若不存在，则使用预设地址配置挖矿账户和矿池。
6. **初始化探测**：反木马软件、防火墙等配置。
7. **本地后门文件隐藏**：如果不存在特定文件和隐藏文件夹，则创建并隐藏。
8. **设置读取矿机WEBUI内配置信息**：解析格式供后续使用。
9. **修改注册表**：修改计算机注册表`HKEY_LOCAL_MACHINE\SYSTEM\Software\Microsoft\Drivers\Path`。

#### 服务模式运行
从第三个步骤开始进入服务模式运行，即`-SCM`参数启动脚本。服务段代码被加密，将代码中的`iex`改为`echo`，解密后分析其执行结构。

1. **判断机器类型**：通过BIOS信息判断是否为虚拟机。
2. **排除竞争对手**：干掉带有关键字`xmr`、`miner`、`programdatanew`、`programdatawin`、`programdataWindow`、`programdataWindows`等的进程。
3. **域名检测**：检测特定域名，如`csd`、`CSP`、`SERVER-BI`等，并进行相应的操作。
4. **请求DNS**：请求`msupdate.info`，若无响应则连接到指定服务器。
5. **删除计划任务**：删除特定计划任务。
6. **查找路径**：查找并处理特定路径。
7. **停止进程**：停止特定进程如`JavaCu`。
8. **删除服务**：删除特定服务如`sc_nmap`。
9. **查看防火墙规则**：查看并删除相关防火墙规则。
10. **终止Windows更新进程**：终止特定的Windows更新进程。
11. **创建计划任务**：创建新的计划任务以运行服务。
12. **复制配置文件**：复制配置文件到特定目录。
13. **设定矿机路径**：设定矿机路径并检查域内后门。
14. **防火墙设置**：设置防火墙规则并开启特定端口。
15. **账户管理**：提供账户选项并添加用户。
16. **代理转发**：设置代理转发端口。
17. **更新矿机**：定期更新矿机。

通过以上分析，我们可以看到该木马具备高度的隐蔽性和复杂性，需要综合多种防护措施来应对。