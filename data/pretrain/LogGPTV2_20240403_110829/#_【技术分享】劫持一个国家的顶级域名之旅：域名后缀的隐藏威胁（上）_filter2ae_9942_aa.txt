# 【技术分享】劫持一个国家顶级域名之旅：域名后缀的隐藏威胁（上）

## 译文声明
本文是翻译文章，原文来源为 thehackerblog.com。具体表达及含义请以原文为准。
- 翻译者：[WisFree](http://bobao.360.cn/member/contribute?uid=2606963099)
- 预估稿费：200RMB
- 投稿方式：发送邮件至 linwei#360.cn 或登录网页版在线投稿

## 引言
域名不仅是互联网的基础架构之一，也极大地方便了用户访问网络资源。尽管很多人日常使用各种域名，但鲜少有人真正理解其背后的运作机制。在多层抽象和多种Web服务的支持下，用户可以轻松购买并管理域名，而无需深入了解DNS、域名注册商或WHOIS等知识。这种抽象化虽然对终端用户有利，但也掩盖了一些关键信息。例如，许多域名注册商会积极推荐.io域名，但有多少用户清楚背后真正持有并管理这些.io域名的人是谁呢？

本文并不旨在讨论“大多数域名持有者不了解其域名背后的运行机制”，而是聚焦于域名后缀（Domain Extension）的安全问题。

## DNS结构简介
### 注：如果您已熟悉DNS的工作原理及其委派机制，可直接跳过此部分。

当您购买一个域名时，实际上是在购买一些NS（域名服务器）记录，这些记录托管在域名后缀的域名服务器上，不包括诸如WHOIS、域名注册商服务以及ICANN服务等辅助性服务。在研究过程中，我发现可视化是一种很好的学习DNS工作原理的方法，因此我开发了一款名为TrustTrees的工具，它可以生成一个域名的委托路径图。为了更好地理解域名后缀在整个DNS执行链中的位置，让我们看一下example.com的委托链示意图。

如图所示，委托链始于根节点DNS服务器，并通过一系列节点之间的传递最终找到目标域名解析服务器。客户端发送的DNS查询请求同样始于根节点DNS服务器。客户端会向其中一个根域名解析服务器发送DNS查询请求，但该服务器最初并不知道如何响应这一请求，因此它会将查询请求委托给TLD（顶级域名），而TLD则负责将请求发送到正确的域名解析服务器，最终客户端会接收到由正确域名解析服务器返回的权威应答。上图显示了所有可能的委托路径（蓝色代表权威应答）。存在多条路径的原因在于DNS响应中包含了一个随机排序的应答列表，这是为了均衡查询负载而设计的技术，称为Round Robin DNS。根据返回结果的不同顺序，处理查询请求的域名解析服务器也会有所不同，因此它们可能会提供不同的查询结果，上图中也展示了不同的排序及域名解析服务器之间的关系。

购买example.com后，.com会在其DNS空间中添加一些NS记录，这些记录负责将有关example.com的DNS查询请求委托给您提供的域名解析服务器。这种方式不仅允许您控制自己的域名，还可以创建example.com的任意子域名及DNS记录。如果.com从其域名空间数据库中移除了指向您域名解析服务器的NS记录，则任何人都无法再访问您的域名解析服务器，从而使example.com失去意义。

实际上，在上图所示的链图中，TLD和域名后缀的工作机制非常相似。TLD之所以能够存在并运行，是因为根域名解析服务器将查询请求委托给了TLD的域名解析服务器。如果根域名解析服务器突然从其域名空间数据库中删除了.com的NS记录，那么全球所有的.com域名都将无法正常访问。

与普通域名一样，域名后缀同样容易受到域名解析服务器漏洞的影响。

## 域名后缀的安全风险
我们现在了解到，TLD和域名后缀与普通域名一样都拥有域名解析服务器。那么问题来了，“这是否意味着TLD和域名后缀也像普通域名一样容易受到DNS安全问题的影响？”答案是肯定的。如果您阅读过我们之前发布的一些文章，就会知道我们有多种方法来劫持域名解析服务器。不仅如此，我们还介绍了如何利用过期域名劫持域名解析服务器【参考资料一】以及如何在未经认证的情况下获取域名空间的完整控制权【参考资料二】。有了这些知识储备，我们将尝试实现一个更具挑战性的目标：接管整个域名后缀。

## 接管域名后缀-攻击计划
与恶意攻击者不同，我不打算走捷径来实现这个目标，即劫持一个域名后缀。我将按照研究方法一步步进行操作。然而，我发现许多域名后缀/TLD域名解析服务器处于非常不安全的状态，因此利用漏洞并获得域名后缀的控制权比想象中要简单得多。虽然讨论如何在域名解析服务器/记录上实现远程代码执行有些超出范围，但我还是要提到这部分内容，因为这也是实现我们目标的一种方法。

通常，攻击者会采用以下几种方法来入侵TLD或域名后缀：
1. 利用DNS服务器（托管特定域名后缀）中的漏洞，或利用域名后缀的域名解析服务器中其他服务的漏洞。更新域名空间的操作也属于此类。
2. 查找并注册一个过期或拼写错误的域名解析服务器域，从而提供针对域名后缀/TLD的权威应答。
3. 通过创建一个DNS空间来劫持域名后缀。
4. 查找TLD的WHOIS联系信息，并劫持其电子邮箱地址。

接下来，我们将逐一讨论这些方法，并逐步实现我们的目标。

### 许多TLD和域名后缀的域名解析服务器存在安全漏洞
在研究第一种攻击方法之前，我决定对所有TLD的域名解析服务器进行一次简单的端口扫描。通常情况下，服务器会开启端口53来监听UDP/TCP连接，而其他端口则保持关闭状态。鉴于这些域名解析服务器的重要性和功能，管理员们会尽可能地缩小服务器与外界的接触范围，暴露任何多余的服务（如HTTP、SSH或SMTP等）都会为攻击者提供更多入侵途径。

#### Finger协议
- 203.119.60.105 (e.dns-server.vn)：越南顶级域名.vn的权威域名解析服务器
- 202.29.151.3 (munnari.oz.au)：波斯尼亚和黑塞哥维那顶级域名.ba的权威域名解析服务器

Finger协议由Les Earnest于1971年设计，允许用户检查远程计算机中某个用户的状态。这是一个非常古老的协议，现代系统几乎不再使用。该协议的核心思想可以回答如下问题：“嗨，Dave现在正在使用他的设备吗？他忙吗？”通过Finger协议，您可以检测远程用户的登录名、真实姓名、终端名称、空闲时间、登录时间、办公地点及办公电话等。接下来，我们将利用Finger协议检查上述波斯尼亚的权威域名解析服务器，查看root用户的情况：

```bash
bash-3.2$ finger -l root@202.29.151.3
[202.29.151.3]
Login: root                       Name: Charlie Root
Directory: /root                        Shell: /bin/sh
Last login Sat Dec 14 16:41 2013 (ICT) on console
No Mail.
No Plan.
```

看来这个服务器的root用户已经很久没有上线了。接下来，我们来看看越南的那个域名解析服务器：

```bash
bash-3.2$ finger -l PI:EMAIL
[203.119.60.105]
Login name: nobody                In real life: NFS Anonymous Access User
Directory: /
Never logged in.
No unread mail
```

这两个示例表明，许多TLD和域名后缀的域名解析服务器可能存在严重的安全漏洞。