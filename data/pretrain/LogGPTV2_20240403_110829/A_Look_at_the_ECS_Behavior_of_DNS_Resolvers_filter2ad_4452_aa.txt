title:A Look at the ECS Behavior of DNS Resolvers
author:Rami Al-Dalky and
Michael Rabinovich and
Kyle Schomp
A Look at the ECS Behavior of DNS Resolvers
Rami Al-Dalky
PI:EMAIL
Case Western Reserve University
Michael Rabinovich
PI:EMAIL
Case Western Reserve University
Kyle Schomp
PI:EMAIL
Akamai Technologies
ABSTRACT
Content delivery networks (CDNs) commonly use DNS to map
end-users to the best edge servers. A recently proposed EDNS0-
Client-Subnet (ECS) extension allows recursive resolvers to include
end-user subnet information in DNS queries, so that authoritative
DNS servers, especially those belonging to CDNs, could use this
information to improve user mapping. In this paper, we study the
ECS behavior of ECS-enabled recursive resolvers from the perspec-
tives of the opposite sides of a DNS interaction, the authoritative
DNS servers of a major CDN and a busy DNS resolution service.
We find a range of erroneous (i.e., deviating from the protocol spec-
ification) and detrimental (even if compliant) behaviors that may
unnecessarily erode client privacy, reduce the effectiveness of DNS
caching, diminish ECS benefits, and in some cases turn ECS from
facilitator into an obstacle to authoritative DNS servers’ ability to
optimize user-to-edge-server mappings.
CCS CONCEPTS
• Networks → Application layer protocols; Network mea-
surement; Naming and addressing.
ACM Reference Format:
Rami Al-Dalky, Michael Rabinovich, and Kyle Schomp. 2019. A Look at
the ECS Behavior of DNS Resolvers. In Internet Measurement Conference
(IMC ’19), October 21–23, 2019, Amsterdam, Netherlands. ACM, New York,
NY, USA, 14 pages. https://doi.org/10.1145/3355369.3355586
1 INTRODUCTION
Aside from resolving hostnames to IP addresses, the domain name
system (DNS) has been widely used by major content delivery
networks (CDNs) [2, 7, 17] for assigning end-users to the nearest
edge servers. Since the only topological information available to
authoritative nameservers in a basic DNS query is the source IP
address (which belongs to the recursive DNS resolver rather than
the end-user), many CDNs utilize the resolver IP address to select
an edge server for a given query, using the resolver as a proxy for
the end-user location. However, the increasing number of public
DNS services in the last few years that are less likely to be a good
approximation for end-user location compared to ISP-provided
resolvers results in an increase in suboptimal user-to-edge server
mapping [1, 6, 19].
Permission to make digital or hard copies of all or part of this work for personal or
classroom use is granted without fee provided that copies are not made or distributed
for profit or commercial advantage and that copies bear this notice and the full citation
on the first page. Copyrights for components of this work owned by others than ACM
must be honored. Abstracting with credit is permitted. To copy otherwise, or republish,
to post on servers or to redistribute to lists, requires prior specific permission and/or a
fee. Request permissions from permissions@acm.org.
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
© 2019 Association for Computing Machinery.
ACM ISBN 978-1-4503-6948-0/19/10...$15.00
https://doi.org/10.1145/3355369.3355586
116
To combat this issue, an extension to the DNS has been pro-
posed called EDNS-Client-Subnet (ECS) [9] which allows recursive
resolvers to convey to authoritative nameservers a prefix of the
IP address of the client (loosely referred to as the client’s subnet)
requesting resolution service from the recursive resolver. Thus,
instead of using the recursive resolver’s IP address, the authorita-
tive DNS server can use the client subnet information to provide
edge server selection tailored to the ultimate client rather than the
recursive resolver.
Recursive resolvers add the ECS option to DNS queries filling
in a prefix of the client’s address (the RFC recommends 24-bits
for IPv4) and setting the source prefix length field to the number
of bits added. When the authoritative nameserver that supports
ECS receives a query with an ECS option, it can optionally use
the client subnet information to tailor a response. Since the source
prefix length may not be at the appropriate granularity level, the
authoritative nameserver returns the scope prefix length in an ECS
option included in the DNS response, indicating the range of client
IP addresses for which this answer is appropriate. For example, if a
recursive resolver sends queries with source prefix length 24 but
the authoritative answer is appropriate for all clients within the
encompassing /16 prefix, the authoritative nameserver will set the
scope prefix length to 16. The recursive resolver upon receiving a
response with the ECS option, caches the records and should return
them for the duration of the TTL to any clients covered by the
prefix at the scope prefix length number of bits.
ECS was proposed in 2012 and standardized in 2016 [9], yet little
is known about its adoption by recursive resolvers. At the same
time, while ECS adoption may appear low in absolute numbers (as
projected in the RFC and seen from the numbers in this paper), this
is an important technology enabling third-party DNS resolution
services to interact efficiently with CDNs and other distributed
content delivery platforms, already in use by many prominent
DNS and CDN providers. In this work, we investigate the ECS-
related behavior of recursive resolvers and make the following
contributions:
• We analyze ECS deployment by recursive resolvers via passive
observations from a large CDN perspective and “in the wild”,
i.e., among resolvers found through active scans. Passive ob-
servation discovers many more ECS resolvers while actively
discovered resolvers allow a closer study of their behavior.
• We study probing strategies used by recursive resolvers to de-
cide whether to include the ECS option in their queries. We
observe some probing behaviors that lead to unnecessary pri-
vacy leakage and some causing suboptimal CDN edge server
selections. We offer a recommendation that would fulfill the
probing purpose without these drawbacks.
• We consider the caching behavior of recursive resolvers that
support ECS. We find various deviations from the expected
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
Rami Al-Dalky, Michael Rabinovich, and Kyle Schomp
caching behavior, ranging from not following the RFC recom-
mendation on exposing no more that 24 bits of the client subnet
information to completely ignoring the scope restrictions when
reusing cached DNS responses.
• We study the impact of ECS on DNS caching. Namely, the
amount of cached state at the resolver and the cache hit rate.
Since ECS limits reuse of cached records across client subnets,
one can expect some negative impact on cache size and hit rate.
However, we find these effects can be quite significant. We show
that the cache size needed by the resolvers to store results of
queries to a CDN can increase by an order of magnitude, and a
busy resolver may need around 4 times the cache size to store
responses in all interactions that involve ECS, while its cache
hit rates for these interactions declines to less than half of what
it would be without ECS.
• We offer several cautionary tales of real-life setups that may
not just diminish or even negate the ECS benefits but turn ECS
into an obstacle to effective user-to-edge-server mappings.
• Tangentially, we are, to our knowledge, the first to discover
and provide an initial glimpse into hidden resolvers between
forwarders and recursive resolvers [20, 22, 27], so called be-
cause they were previously believed to be unobservable. We
find that some hidden resolvers are far away from the clients,
and in fact not infrequently (in 8% of the cases we observe)
are farther away from the clients than the recursive resolvers.
Since many resolvers derive ECS prefixes from the IP address of
the immediate source of the queries received, hidden resolvers
are one example of a setup where ECS may be detrimental for
user-to-edge-server mapping by CDNs.
The rest of the paper is organized as follows. We briefly discuss
related work in Section 2, the terminology we use in Section 3, and
our datasets that we use in this work in Section 4. Then, we expand
on each aforementioned contribution in Sections 5 - 8. Finally, we
offer concluding thoughts in Section 10.
2 RELATED WORK
Several studies have investigated ECS from different perspectives.
In [4, 30], the authors show how ECS can be used from a single
vantage point as a measurement tool to study the deployment of
ECS adopters (such as Google). In our work, we look at the ECS-
related behavior of recursive resolvers and some ECS implications
for DNS caching. Chen et al. [6] study the impact of enabling ECS
on mapping end-users to edge-server from Akamai’s perspective.
The authors show that ECS deployment has improved the laten-
cies between end-users that use public resolvers and their edge
servers by 50%, at the cost of 8 times increase in the number of DNS
queries their authoritative DNS servers receive from those public
resolvers. In our work, we consider another ECS overhead, namely,
the recursive resolvers’ cache size, and identify situations where
ECS can lead to suboptimal mapping. Calder et al.[5] study ECS
adoption by recursive resolvers from a cloud provider perspective,
while our study focuses on the ECS behavior by those recursive re-
solvers that did adopt ECS. Kintis et al. [21] discuss the privacy and
security of ECS including the erosion of privacy for Internet users
and facilitation of running selective cache-poisoning attacks to
target specific subnets/regions. Vries et al. [12] use 2.5 years of pas-
sive ECS-enabled queries to study Google Public DNS. The authors
show that DNS traffic to Google Public DNS is frequently routed to
datacenters outside the country even though a local datacenter is
available in country. Moreover, they uncover a new privacy risk of
ECS when mail servers are configured to use Google Public DNS,
involving mail servers revealing the domains of their email senders
through Google to authoritative DNS servers. While some privacy
leakage is an inherent cost of ECS, we show that some resolvers
erode user privacy unnecessarily via probing strategies they use to
detect ECS-enabled authoritative nameservers.
3 TERMINOLOGY
In this paper, we refer to DNS queries that include an ECS option
as “ECS queries”, and to DNS responses with an ECS option as
“ECS responses”. We call resolvers that directly interact with the
authoritative nameservers “egress resolvers” or simply “recursive
resolvers”. The resolvers that receive queries directly from user de-
vices and end hosts are called “ingress resolvers”. Ingress resolves
often act as forwarders: they take a query from an end host and
forward it to an egress resolver, then forward a response from the
egress resolver back to the end host. There are also many ingress
resolvers that act as egress resolvers as well, i.e., they both take
queries from the end hosts and interact with authoritative name-
servers directly. Further, in some deployments an ingress resolver
routes its queries to an egress resolver through (a chain of) inter-
mediaries called “hidden resolvers”.
4 DATASETS
In this study, we consider four datasets: (i) one day of DNS traffic
logs from a major CDN’s authoritative DNS servers (CDN dataset),
(ii) queries arriving at our own experimental authoritative name-
server as the result of a full DNS scan of the IPv4 address space with
DNS queries for names within our own DNS zone (Scan dataset),
(iii) traces of traffic from a major public DNS service to a major
CDN’s authoritative nameservers (Public Resolver/CDN dataset),
and (iv) logs of all DNS traffic to/from a single busy recursive
resolver (All-Names Resolver dataset).
CDN Dataset: The CDN dataset is derived from aggregated DNS
query logs from all authoritative nameservers of a major CDN. The
CDN uses whitelisting in handling ECS queries, which means that
the CDN only considers the ECS option in queries from, and in-
cludes the ECS option in its responses to, pre-approved (“whitelisted”)
resolvers. Queries from non-whitelisted resolvers are handled as
if the CDN did not adopt ECS: ECS options in these queries are
silently ignored and responses provide no indication that ECS is
supported. Whitelisting a resolver involves human negotiation and
business agreement between the resolver’s operator and the CDN.
We collect one day of logs, November 6 2018, which contain DNS
queries from 3,741,983 resolvers. Of these over 3.7M resolvers, only
7737 resolvers may be ECS-enabled (i.e., send at least one ECS
query during that day), including 3590 whitelisted and 4147 non-
whitelisted resolvers. For the purpose of this study, we extract the
DNS interactions involving ECS-enabled non-whitelisted resolvers.
The resulting dataset contains 1.5B queries, including 847M with
an ECS option. The 4147 different IP addresses (4002 IPv4 and 145
117
A Look at the ECS Behavior of DNS Resolvers
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
IPv6) belong to 83 different ASes. 3067 IP addresses belong to a
single AS, which we refer to as the “dominant AS” below.
Scan Dataset: We collect this dataset by scanning the IPv4 address
space with DNS queries for hostnames from our own domain and
record the queries that arrive at our experimental authoritative
nameserver. Following a technique from [10], we use hostnames
that encode the IPv4 address being probed, which allows our au-
thoritative nameserver to associate the discovered ingress resolvers
with the egress resolvers they employ. We use queries without
an ECS option because most of the open DNS resolvers are home
wifi-routers [27] with simplified DNS functionality and may be un-
able to handle, or blindly forward, an unknown option. Either case
would lead to inaccurate detection of ECS support. We configure
our authoritative nameserver to respond to queries carrying an ECS
option with scope length L = S −4, where S is the ECS source prefix
length from the query. Responses to non-ECS queries carry no ECS
option (per the RFC). We reiterate that, while this scan leverages
open ingress resolvers, most of these resolvers are actually simple
forwarders that send incoming queries to their recursive resolvers
for processing, often the default ISP-provided resolvers, which are
typically closed to external queries. These closed resolvers are in-
cluded in our analysis.
The scan was conducted from a machine on our campus network
using a Python script that issued 25K DNS queries per second (the
rate restriction imposed by the university’s network administrators).
We also ran the PF_RING variant of tcpdump on both the scanning
machine and the authoritative nameserver to capture the DNS
queries and responses. The scan ran from Feb 22 to Feb 23, 2019
and took 42 hours to complete. We identified 2.743M open ingress
resolvers in our scan, which is roughly in line with the number
reported in [28]1. Of this number, the queries from 1.53M open
ingress resolvers arrived at our authoritative nameserver with an
ECS option added, indicating they use ECS-enabled egress resolvers.
These 1.53M ingress resolvers are spread across 7.9K autonomous
systems (ASes) and 195 countries, and employ 1534 egress resolver
IP addresses that support ECS. Google Public DNS is the largest
contributor of recursive resolvers accounting for 1256 IP addresses.
The remaining 278 recursive resolver IP addresses belong to 45 ASes,
with Chinese ISPs being the largest contributor responsible for 19
ASes. The dataset is available on request. Although the apparent
skew in ECS-enabled egress resolvers toward Google and China
might give an impression of a bias in the dataset, this is not the case
here. We note that the dominant AS from the CDN dataset is also
Chinese. Because of the global reach of the major CDN that delivers
a large portion of all Web traffic, we are confident that what we
observe in both the CDN and Scan datasets is that two operators
– Google and one Chinese operator – dominate the ECS-adopting
recursive resolvers. In other words, this is the state of ECS adoption,
not a skew in either dataset. The apparent skew in ECS-enabled
egress resolvers toward China confirms the similar finding in [5].
Public Resolver/CDN Dataset: This dataset contains DNS traffic
logs from a major CDN’s authoritative nameservers for ECS queries
arriving from a major public DNS service that is whitelisted for ECS
1The number of open resolvers on the Internet is decreasing. The openresolverproject.
org used to show a longitudinal graph but the site is no longer up. Still, we note that
[27] found over 30M open resolvers in 2012, vs. around 10M observed by [3] in 2016,
vs. only 2.74M we observe now.
support by the CDN. The dataset covers 3 hours during the busy
time of the day in the Americas, between 00:00:00 - 03:00:00 UTC
on March 1, 2019, and includes 3.8B A/AAAA queries from 2370
different resolver IP addresses. All queries carry the ECS option
and all responses include a non-zero scope prefix length.
All-Names Resolver Dataset: This dataset is DNS traffic collected
from a busy recursive resolver instance of an anycast DNS resolu-
tion service. The service accepts client queries at anycasted front-
ends, which forward these queries to the egress resolvers while