From	
  0	
  to	
  Secure	
  in	
  1	
  Minute
DEFCON	
  23
Nir Valtman &	
  Moshe	
  Ferber
About	
  Us
Nir	
  Valtman
Moshe	
  Ferber
ü CISO	
  Retail	
  in	
  NCR	
  Corporation.
§
We	
  own	
  a	
  private	
  cloud	
  &	
  offering	
  SaaS
§
Yes…	
  we	
  do	
  security!
ü Instructor	
  for	
  Cloud	
  Security	
  (CCSK)	
  –
that’s	
  what	
  I	
  really	
  like	
  doing
Passionate	
  about	
  information	
  security
Involved	
  in	
  numerous	
  startups	
  and	
  initiatives	
  – sometimes	
  with	
  success,	
  sometimes	
  not…
Industry	
  speakers	
  and	
  lecturers	
  – that’s	
  why	
  we	
  are	
  here
I	
  like	
  non-­‐
sweating	
sports!
I	
  don’t	
  like	
sport!
About	
  the	
  talk
Cloud	
  security	
  challenges	
  and	
  benefits
And	
  more	
  specifically,	
  using	
  IaaS automation	
  and	
  orchestration	
  features	
  for	
  increasing	
  the	
  security
Dashboard
Billing
API
Orchestration
Hypervisor
Controller
Abstraction
Physical
Servers
Network
Storage
About	
  the	
  talk
Cloud	
Attack	
Vectors
Provider	
administration
Management	
console
Multi	
  tenancy	
&	
virtualization
Automation	
&	
  API
Chain	
  of	
supply
Side	
  channel	
attack
Insecure	
instances
Anatomy	
  of	
  a	
  cloud	
  hack
Anatomy	
  of	
  a	
  cloud	
  hack	
  – the	
  BrowserStack story
Shell	
  shock	
vulnerability	
on	
  unused	
server
Found	
  API	
key	
  on	
hacked	
server
Using	
  API	
key	
  opened	
a	
  firewall	
rule	
  and	
launch	
  an	
instance
Attached	
  a	
backup	
volume	
  to	
the	
  instance
Found	
database	
credential	
on	
  backup	
device
Connected	
to	
  DB
SOURCE:	
  https://www.browserstack.com/attack-­‐and-­‐downtime-­‐on-­‐9-­‐November
Do	
  we	
  have	
  the	
  right	
  tools?
Source:	
  http://ifail.info/wp-­‐content/uploads/2010/04/street_dentist_thumb.jpg?98bbf9
About	
  the	
  talk
Micro-­‐Services	
  Architecture	
DEV
OPS
Continuous
Delivery
1	
  hour
10	
  min
1	
  min	
Architecture	
  &	
Deployments	
  is	
  changing	
The	
  billing	
  cycle	
  is	
reducing
Google	
  slashes	
cloud	
  platform	
price	
  again
Microsoft	
  will	
  offer	
Azure	
  by	
  the	
  minute	
  to	
take	
  on	
  Amazon’s	
  cloud
Microsoft	
  follows	
  Google	
with	
  by-­‐the-­‐minute	
  cloud	
blending
AUTO	
  SCALING
About	
  the	
  talk
How	
  to	
  do	
  security	
  when	
  servers	
  alive	
  for	
  10	
  minutes?
Patch	
  management
Maintenance	
windows
Periodic	
  vulnerability	
scanning
Hardening
The image 
T
DON’T	
  LET	
  SECURITY	
  HOLD	
  YOU	
  DOWN
Source:	
  www.avon-­‐barrier.co.uk
About	
  the	
  talk
Introducing
SOURCE:	
  http://www.cloudefigo.org/
Based	
  on	
  the	
  work	
  made	
  by	
  Rich	
  Mogull from	
  Securosis
https://github.com/securosis
Cloudefigo Lifecycle
Server	
  launch
1
Server	
  loads	
security	
configuration
Server	
  encrypts	
disk	
  volumes
Server	
  scanned	
  for	
vulnerabilities	
Server	
  moves	
  to	
production
S3
2
3
4
5
Components
Object	
Storage
Vulnerability	
Scanner
Cloud-­‐Init
Configuration	
Management
IAM	
  Roles
Volume	
Encryption
Instant	
  Lifecycle
Launch
Update
Control
Scan
Production
Terminate
LAUNCH
Prepare
Cloudinit
ü Each	
  machine	
  manage	
  its	
  own	
  attributes
§
Encryption	
  keys	
§
Remediation	
  vs production	
  groups
ü Management	
  of	
  these	
  attributes	
  require	
  permissions
ü Permissions	
  during	
  launch	
  >	
  production
ü Thus,	
  a	
  dynamic	
  IAM	
  role	
  is	
  required
LAUNCH
Prepare
Cloudinit
LAUNCH
Prepare
Cloudinit
ü Executed	
  in	
  root	
  permissions	
  when	
  image	
  is	
launching.
ü Responsible	
  for	
  building	
  the	
  infrastructure	
  for	
  the	
following	
  steps.
LAUNCH
Prepare
Cloudinit
UPDATE
OS	
  update
Pre-­‐requisites
ü CloudInit to	
  update	
  &	
  upgrade	
  software	
  packages
ü Primary	
  goal	
  is	
  to	
  make	
  sure	
  the	
  cloud	
  instance	
  is	
secure	
  once	
  upgraded
UPDATE
OS	
  update
Pre-­‐requisites
ü CloudInit to	
  install	
  the	
  software	
  packages	
  required	
to	
  operate:	
§
Python	
  +	
  pip	
  +	
  wheel
§
AWS	
  SDK	
  (Boto)
§
Chef	
  Client	
  +	
  Chef	
  SDK	
  (PyChef)
ü Download	
  configurations	
  and	
  scripts	
  from	
  S3:
§
Cloudefigo script
§
Chef	
  client	
  initialization	
  files
ü Cloudinit to	
  create	
  and	
  attach	
  a	
  volume	
  for	
application	
  files	
  and	
  data.	
UPDATE
OS	
  update
Pre-­‐requisites
CONTROL
Chef	
Registration	
Encrypt
ü The	
  Chef	
  clients	
  register	
  to	
  the	
  Chef	
  Management	
server	
  using	
  the	
  initialization	
  files	
  loaded	
  from	
  S3.
ü Once	
  the	
  client	
  is	
  registered,	
  a	
  policy	
  is	
  loaded	
  and	
enforced	
  on	
  the	
  instance.	
CONTROL
Chef	
Registration	
Encrypt
Where	
  should	
  you	
  keep	
  your	
  keys?	
Cloud	
  Provider
On	
  Premise
3rd Party
Protected
Snapshots	
  and	
backups
Snapshots,	
  backups,
subpoena	
  and	
malicious	
  insiders
Snapshots,	
  backups	
and	
  cloud	
  provider’s	
malicious	
  insiders
Vulnerable
Malicious insider	
attacks and	
subpoena
Key exchange	
  attacks
Key	
  exchange	
  attacks	
and	
  subpoena	
(partial)
CONTROL
Chef	
Registration	
Encrypt
ü The	
  volume	
  to	
  be	
  encrypted	
  using	
  randomly	
generated	
  key.
§
The	
  key	
  is	
  stored	
  on	
  S3	
  for	
  later	
  use.
ü The	
  application	
  database	
  to	
  be	
  installed	
  in	
  the	
encrypted	
  volume.
Instance	
  1
Instance	
  2
Instance	
  3
Bucket	
  2f3g
Bucket	
  5dw4
Bucket	
  8H7g
Key	
  ID	
  5dw4
Key	
  ID	
  8H7g
Key	
  ID	
  2f3g
Key	
  1#Fd3
Key	
  vFS3=
Key	
  Bs$a
CONTROL
Chef	
Registration	
Encrypt
ü Dynamic	
  S3	
  policy:	
  access	
  to	
  key	
  require	
  a	
referrer	
  header that	
  is	
  generated	
  based	
  on	
attributes	
  from	
  the	
  instance.
CONTROL
Chef	
Registration	
Encrypt
SCAN
Automatic	
Scan
Analyze
ü A	
  vulnerability	
  scan	
  to	
  be	
  launched	
  automatically	
by	
  CloudInit script.
ü The	
  deeper	
  the	
  scan,	
  the	
  longer	
  it	
  takes	
  to	
  move	
to	
  production.	
SCAN
Automatic
Scan
Analyze
ü The	
  results	
  of	
  the	
  scan	
  are	
  analyzed	
  by	
  the	
Cloudefigo script.
ü Based	
  on	
  scan	
  results	
  – the	
  instance	
  to	
  move	
  to	
production	
  or	
  remain	
  in	
  the	
  remediation	
  group.
ü The	
  lowest	
  security	
  risk	
  severity	
  can	
  be	
  defined.
SCAN
Automatic
Scan
Analyze
PRODUCTION
Least	
  privileged	
role
Manage
ü Reminder:	
  Permissions	
  in	
  launch	
  >	
  production
ü IAM	
  role	
  permissions	
  reduced	
  dynamically	
  -­‐
contains	
  read	
  only	
  access
PRODUCTION
Least	
  privileged	
role
Manage
ü For	
  the	
  ongoing	
  operations	
  – a	
  compensating	
controls	
  are	
  required.	
ü Cloudefigo management	
  script	
  lists	
  cloud	
instances	
  and	
  validates	
  they	
  are	
  managed	
  by	
  Chef
ü Cloudefigo will	
  set	
  alert	
  when	
  someone	
  will	
  try	
  to	
use	
  access	
  keys.	
PRODUCTION
Least	
  privileged	
role
Manage
Setting	
  a	
  CloudWatch alarm
PRODUCTION
Least	
  privileged	
role
Manage
TERMINATE
Instance
Encryption
Keys
ü The	
  life	
  cycle	
  ends	
  once	
  a	
  server	
  is	
  terminated	
along	
  with:
§
Attached	
  volumes
§
IAM	
  role
TERMINATE
Instance
Encryption
Keys
ü The	
  instance	
  data	
  still	
  exist	
  in	
  backups/snapshots	
or	
  provider	
  storage
ü Encryption	
  keys	
  to	
  be	
  deleted	
  with	
  instance	
  in	
order	
  to	
  make	
  sure	
  the	
  backup	
  data	
  remain	
inaccessible	
  (not	
  implemented	
  in	
  this	
  version)
Wrapping	
  Up
The	
  new	
  software	
  architecture	
  and	
  applications	
  delivery	
  in	
  cloud	
module	
  disrupts	
  traditional	
  correctives	
  controls	
We	
  need	
  to	
  adopt	
  new	
  thinking	
  to	
automate	
  security	
Think	
  how	
  security	
  automation	
  can	
  help	
  you	
  in	
  moving	
  your	
infrastructure	
  forward.	
  Faster.
Questions
Moshe	
  Ferber
@: moshe (at)	
  onlinecloudsec.com
w:	
  www.onlinecloudsec.com
in:	
  www.linkedin.com/in/MosheFerber
t:	
  @FerberMoshe
Nir	
  Valtman
@: nir.valtman (at)	
  ncr.com	
w:	
  www.ncr.com	
  |	
  www.valtman.org
in:	
  www.linkedin.com/in/valtmanir
t:	
  @ValtmaNir
www.cloudefigo.org