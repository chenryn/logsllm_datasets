uaf_str
{
i 0 eq
{
snapshot restore
}
/i i 1 add def
} forall
/i 0 def
/snapshot save def
/uaf_array 80 array def
uaf_array
{
i 0 eq
{
snapshot restore
}
/i i 1 add def
} forall
2017年年Office威胁分析与回顾
• CVE-2017-0262
/dumb_array 80 array def
dumb_array 16#888888 forall
2017年年Office威胁分析与回顾
• 2017-04 微软禁⽤用了了EPS… 
2017年年Office威胁分析与回顾
• Case study 5： CVE-2017-11826 类型混淆漏漏洞洞
• 样本⾸首现时间：2017-09-28
• 攻击跨度时间：2017-09-28 ～ ⾄至今
• 攻击事件信息披露露：《 最新Office 0day漏漏洞洞(CVE-2017-11826)在野攻击通告 》By 奇⻁虎
360公司, 2017-10-11
2017年年Office威胁分析与回顾
• Case study 5：CVE-2017-11826 
2017年年Office威胁分析与回顾
• Case study 5：CVE-2017-11826
index
elements
6
5
o:xxx
4
w:font
3
o:OLEObject
2
w:shapeDefaults
1
w:body
0
w:document
; size: 0x5c bytes
+0x44 TAG_OBJ *obj;
+0x48 FARPROC DeleteObj;
; OleObject size: 0x4c bytes
+0x44 OleComObject
2017年年Office威胁分析与回顾
• Case study 5：CVE-2017-11826
index
elements
6
5
o:xxx
4
w:font
3
o:OLEObject
2
w:shapeDefaults
1
w:body
0
w:document
; size: 0x5c bytes
+0x44 TAG_OBJ *obj;
+0x48 FARPROC DeleteObj;
; FontObject size: 0x100 
bytes
+0x28 wchar_t name[N]
2017年年Office威胁分析与回顾
• Case study 5： CVE-2017-11826
2017年年Office威胁分析与回顾
• Case study 5：CVE-2017-11882 EQNEDT32.EXE栈溢出漏漏洞洞
• 样本⾸首现时间：2017-08-03
• 攻击跨度时间：2017-12 ～ ⾄至今
• 漏漏洞洞信息披露露：《 SKELETON IN THE CLOSET: MS Office vulnerability you didn’t 
know about 》By Embedi, 2017-11-14
2017年年Office威胁分析与回顾
• Case study 5：CVE-2017-11882 EQNEDT32.EXE栈溢出漏漏洞洞
• 栈溢出
• 没有任何防御ASLR, DEP, GS cookies, SafeSEH…
• Microsoft Security Development Lifecycle之前的产品,边界检查,攻击者为了了成功利利⽤用,不不
得不不努⼒力力避开其它的坑
2017年年Office威胁分析与回顾
• Case study 6：DDE(Dynamic Data Exchange) 攻击
• 样本再现时间：2017-10-09 
• 攻击跨度时间：2017-10 ～ ⾄至今
• 漏漏洞洞信息披露露：《 Macro-less Code Exec in MSWord》By sensepost, 2017-10-09
2017年年Office威胁分析与回顾
• Case study 6：DDE(Dynamic Data Exchange) 攻击
• 样本再现时间：2017-10-09 
• 攻击跨度时间：2017-10 ～ ⾄至今
• 漏漏洞洞信息披露露：《 Macro-less Code Exec in MSWord》By sensepost, 2017-10-09
2017年年Office威胁分析与回顾
如何建⽴立终端Office威胁防护机制
• 我们从3个层⾯面来考虑，如何去应对的Office威胁技术
• 内存层⾯面防护(低级别:通⽤用防护)
• 逻辑漏漏洞洞层⾯面防护（中级别:针对性防护）
• 宏利利⽤用⽅方⾯面防护（⾼高级别:响应性防护）
如何建⽴立终端Office威胁防护机制
• 内存层⾯面防护
Office进程内存层面
Mscomctl.ocx
Wwlib.dll
Dll
…
Office进程外组件
EQNEDT32.exe
Odserv.exe
FLTLDR.EXE
…
1 DEP
2 ASLR
3 Anti-HeapSpary
4 Anti-Loadlib
5 Anti-Rop
6 Anti-Read/Write Primitives
…
如何建⽴立终端Office威胁防护机制
• 内存层⾯面防护
• CVE-2017-0261: Office EPS Remote Code Execution Vulnerability
如何建⽴立终端Office威胁防护机制
• 内存层⾯面防护
• CVE-2017-11826: Microsoft Office Memory Corruption Vulnerability
rtf->
word->
document.xml
如何建⽴立终端Office威胁防护机制
• 内存层⾯面防护
• CVE-2017-11882: Microsoft Office Memory Corruption Vulnerability
rtf->
word->
embeddings->
oleobject1.bin
如何建⽴立终端Office威胁防护机制
• 逻辑漏漏洞洞防护：
• 需要有⼀一只能够跟踪新技术，快速分析出漏漏洞洞成因的安全研究团队。
• 逻辑漏漏洞洞是偏功能性的，并不不⼀一定具有技术上的相似性，很难设计出通⽤用的检测⽅方案
• Case-By-Case的处理理
• CVE-2017-0199/8570：Hook OleGetAutoConvert
• HRESULT OleGetAutoConvert(  
• _In_  REFCLSID clsidOld,  
• _Out_ LPCLSID  pClsidNew);
Application\hta object --- > KILL
If return REGDB_E_KEYMISSING；
Modify the return value S_OK;
如何建⽴立终端Office威胁防护机制
• 逻辑漏漏洞洞防护：
• CVE-2017-0199/8570：
BOOL HookingShellExecuteEx(
_Inout_ SHELLEXECUTEINFO *pExecInfo);
Mshta.exe / powershell.exe …
http://127.0.0.1:8080/cmd.hta /???
Esp-4
如何建⽴立终端Office威胁防护机制
• 宏利利⽤用⽅方⾯面防护：
• 安全培训，⻛风险意识
• 必要的技术⼿手段，限制某⼀一类的宏利利⽤用（OLE-SWF,DDE…）
如何建⽴立终端Office威胁防护机制
• EMET
• Windows Defender Exploit Guard
2017年年Office ITW 0day原因分析
• Edge Browser
- Mitigations: ASLR, DEP, ACG, CIG, WDAG…
2017年年Office ITW 0day原因分析
• Office
- 历史悠久…
- 足够复杂, 攻击面广…
- 成本更低…
2018年年Office威胁趋势预测
• 基于宏攻击会继续泛滥
• 还有更更多的漏漏洞洞
谢谢
Q & A