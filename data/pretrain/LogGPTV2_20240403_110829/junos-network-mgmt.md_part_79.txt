user@host> show analytics collector
Address Port Transport Stream format State Sent
10.94.184.25 50013 udp gpb n/a 484
10.94.198.11 50001 tcp gpb In progress 0
Meaning
The output displays the collector configuration.
NOTE: The connection state of a port configured with the udp transport protocol is always
displayed as n/a.
Release History Table
Release Description
13.2X51-D15 In Junos OS Release 13.2X51-D15, the network analytics feature was enhanced, and extensive
changes were made to the CLI statements and hierarchies.
13.2X51-D15 Beginning in Junos OS Release 13.2X51-D15, the network analytics feature provides the following
enhancements:
13.2X51-D15 Beginning in Junos OS Release 13.2X51-D15, enhancements to the network analytics feature
result in changes in the CLI when you configure the feature.
13.2X51-D15 Starting in Junos OS Release 13.2X51-D15, network analytics supports the following streaming
data formats and output:
13.2X51-D15 Beginning in Junos OS Release 13.2X51-D15, the traffic and queue monitoring statistics can be
stored locally in a single file.
13.2X51-D15 The procedure to configure queue monitoring on a QFX Series standalone switch requires Junos
OS Release 13.2X51-D15 or later to be installed on your device.
13.2X51-D15 The procedure to configure a local file for storing queue and traffic monitoring statistics requires
Junos OS Release 13.2X51-D15 or later to be installed on your device.
982
13.2X51-D15 The procedure to configure a collector for receiving streamed analytics data requires Junos OS
Release 13.2X51-D15 or later to be installed on your device.
9
PART
Port Mirroring
Port Mirroring and Analyzers | 984
984
CHAPTER 12
Port Mirroring and Analyzers
IN THIS CHAPTER
Port Mirroring and Analyzers | 984
Configuring Port Mirroring and Analyzers | 1018
Configuring Port Mirroring Instances | 1124
Configuring Port Mirroring on Physical Interfaces | 1135
Configuring Port Mirroring on Logical Interfaces | 1150
Configuring Port Mirroring for Multiple Destinations | 1185
Configuring Port Mirroring for Remote Destinations | 1197
Configuring Port Mirroring Local and Remote Analysis | 1210
1:N Port Mirroring to Multiple Destinations on Switches | 1234
Monitoring Port Mirroring | 1238
Configure Packet Mirroring with Layer 2 Headers for Layer 3 Forwarded Traffic | 1239
Troubleshooting Port Mirroring | 1248
Port Mirroring and Analyzers
SUMMARY IN THIS SECTION
This section describes how port mirroring sends Understanding Port Mirroring and
network traffic to analyzer applications. Analyzers | 985
Port Mirroring on EX2300, EX3400, and
EX4300 Switches | 1000
985
Port Mirroring on ACX7024, ACX7100,
ACX7509, EX2200, EX3200, EX3300,
EX4200, EX4500, EX4550, EX6200, and
EX8200 Series Switches | 1005
Port Mirroring on SRX Series
Firewalls | 1011
Understanding Layer 2 Port Mirroring | 1012
Layer 2 Port Mirroring Properties | 1013
Application of Layer 2 Port Mirroring
Types | 1014
Restrictions on Layer 2 Port Mirroring | 1017
Understanding Port Mirroring and Analyzers
IN THIS SECTION
Port Mirroring and Analyzer Terms and Definitions | 987
Instance Types | 991
Port Mirroring and STP | 992
Constraints and Limitations | 993
Port Mirroring on QFX10000 Series Switches | 997
Port Mirroring on QFabric | 998
Port Mirroring on OCX Series Switches | 1000
Port mirroring and analyzers send network traffic to devices running analyzer applications. A port mirror
copies Layer 3 IP traffic to an interface. An analyzer copies bridged (Layer 2) packets to an interface.
Mirrored traffic can be sourced from single or multiple interfaces. You can use a device attached to a
mirror output interface running an analyzer application to perform tasks such as monitoring compliance,
enforcing policies, detecting intrusions, monitoring network performance, correlating events, and other
problems on the network.
On routers containing an Internet Processor II application-specific integrated circuit (ASIC) or T Series
Internet Processor, port mirroring copies Unicast packets entering or exiting a port or entering a VLAN
and sends those copies to a local interface for local monitoring or to a VLAN for remote monitoring. The
mirrored traffic is received by applications that help you analyze that traffic.
986
Port mirroring is different from traffic sampling. In traffic sampling, a sampling key based on the IPv4
header is sent to the Routing Engine, where a key is placed in a file or cflowd. Packets based on that key
are sent to a cflowd server. In port mirroring, the entire packet is copied and sent out through the
specified interface where it can be captured and analyzed in detail.
Use port mirroring to send traffic to devices that analyze traffic for purposes such as monitoring
compliance, enforcing policies, detecting intrusions, monitoring and predicting traffic patterns,
correlating events, and so on. Port mirroring is needed when you want to perform traffic analysis
because a switch normally sends packets only to the port to which the destination device is connected.
You probably do not want to send the original packets for analysis before they are forwarded because of
the delay that this would cause, so the common alternative is to configure port mirroring to send copies
of unicast traffic to another interface and run an analyzer application on a device connected to that
interface. .
To configure port mirroring, configure a port-mirroring instance. but don't specify an input for it. Instead,
create a firewall filter that specifies the required traffic, and directs it to the instance. Use the port-mirror
action in a then term of the filter for this. The firewall filter must be configured as family inet.
Keep performance in mind when configuring port mirroring. Configuring the firewall filter to mirror only
the necessary packets reduces the possibility of a performance impact.
You can configure an analyzer statement to define both the input traffic and output traffic in the same
analyzer configuration. The traffic to be analyzed can be traffic that enters or exits an interface, or traffic
that enters a VLAN. The analyzer configuration enables you to send this traffic to an output interface,
instance, or VLAN. You can configure an analyzer at the [edit forwarding-options analyzer] hierarchy.
NOTE: On EX Series switches, when you disable any interface in a remote port mirroring VLAN,
you will need to re-enable the disabled interface and reconfigure the analyzer session to resume
port mirroring.
You can use port mirroring to copy:
• All of the packets entering or exiting an interface in any combination. Copies of packets entering
some interfaces and packets exiting other interfaces can be sent to the same local interface or VLAN.
If you configure port mirroring to copy packets exiting an interface, traffic that originates on that
switch or Node device (in a QFabric system) is not copied when it egresses. Only switched traffic is
copied on egress. (See the limitation on egress mirroring below.)
• Any or all packets entering a VLAN. You cannot use port mirroring to copy packets exiting a VLAN.
• A firewall-filtered sample of packets entering a port or VLAN.
• Firewall filters are not supported on egress ports; that is, you cannot specify policy-based sampling of
packets exiting an interface
987
• In VXLAN environments, firewall-filter based port-mirroring is not supported on core- or spine-facing
interfaces.
You can configure both traffic sampling and port mirroring, setting an independent sampling rate and
run-length for port-mirrored packets. However, if a packet is selected for both traffic sampling and port
mirroring, only port mirroring is executed, as it takes precedence. In other words, if you configure an
interface to traffic sample every packet input to the interface and port mirroring also selects that packet
to be copied and sent to the destination port, only the port mirroring process is executed. Traffic
sampled packets that are not selected for port mirroring continue to be sampled and forwarded to the
cflowd server.
Port Mirroring and Analyzer Terms and Definitions
The following tables provide terms and definitions for the port mirroring and analyzer documentation.
Table 116: Terminology
Term Definition
Analyzer For EX2300, EX3400, or EX4300 switches, in a mirroring configuration (analyzer)
on an the analyzer includes:
• The name of the analyzer
• Source (input) ports or VLAN (optional)
Analyzer instance Port-mirroring configuration that includes a name, source interfaces or source
VLAN, and a destination for mirrored packets (either a local interface or a VLAN).
988
Analyzer output interface Interface to which mirrored traffic is sent and to which a protocol analyzer
(also known as monitor port) application is connected.
For EX2300, EX3400, and EX4300 Switches, Interfaces used as output for an
analyzer must be configured as family ethernet-switching. In addition, the
following limitations for analyzer output interfaces apply:
• Cannot also be a source port.
• Cannot be used for switching.
• Do not participate in Layer 2 protocols, such as Spanning Tree Protocol (STP),
when part of a port mirroring configuration.
• If the bandwidth of the analyzer output interface is not sufficient to handle
the traffic from the source ports, overflow packets are dropped.
Analyzer VLAN (also known VLAN to which mirrored traffic is sent. The mirrored traffic can be used by a
as monitor VLAN) protocol analyzer application. The member interfaces in the monitor VLAN are
spread across the switches in your network.
Bridge-domain-based An analyzer session configured to use bridge domains for input, output or both.
analyzer
Default analyzer An analyzer with default mirroring parameters. By default, the mirroring rate is 1
and the maximum packet length is the length of the complete packet.
Global port mirror A port mirroring configuration that does not have an instance name. The firewall
filter action port-mirror will be the action for the firewall filter configuration.
Input interface (also known An interface that copies traffic to the mirror interface. This traffic can be
as mirrored or monitored entering or exiting (ingress or egress) the interface.
interface)
A mirrored input interface cannot be used as an output interface to the analyzer
device.
LAG-based analyzer An analyzer that has a link aggregation group (LAG) specified as the input
(ingress) interface in the analyzer configuration.
Local port mirroring A port-mirroring configuration where the mirrored packets are copied to an
interface on the same switch.
Monitoring station A computer running a protocol analyzer application.
989
Next-hop based analyzer An analyzer configuration that uses the next-hop group as the output to an
analyzer.
Native analyzer session An analyzer session that has both input and output definitions in its analyzer
configuration.
Policy-based mirroring Mirroring of packets that match a firewall filter term. The action analyzer
analyzer-name is used in the firewall filter to send specified packets to the
analyzer.
Port-based analyzer An analyzer session whose configuration defines interfaces for both input and
output.
Port mirroring instance A port-mirroring configuration that does not specify an input source; it specifies
only an output destination. A firewall filter configuration must be defined for the
input source. A firewall filter configuration must be defined to mirror packets
that match the match conditions defined in the firewall filter term. The action
item port-mirror-instance instance-name in the firewall filter configuration is
used to send packets to the analyzer and these packets form the input source.
Use the port-mirror-instance instance-name action in the firewall filter
configuration to send packets to the port mirror.
NOTE: Port mirroring instance is not supported on NFX150 devices.
Protocol analyzer application An application used to examine packets transmitted across a network segment.
Also commonly called network analyzer, packet sniffer, or probe.
990
Output interface (also known The interface to where the copies of packets are sent and to which a device
as the monitor interface) running an analyzer is connected.
The following limitations apply to an output interface (the target mirror
interface):
• Cannot also be a source port.
• Cannot be used for switching.
• Cannot be an aggregated Ethernet interface (LAG).
• Cannot participate in Layer 2 protocols, such as Spanning Tree Protocol
(STP).
• Existing VLAN associations are lost when port mirroring is applied to the
interface.
• Packets are dropped if the capacity of the output interface is insufficient to
handle the traffic from the mirrored source ports.
Output IP address IP address of the device running an analyzer application. The device can be on a
remote network.
When you use this feature:
• Mirrored packets are GRE-encapsulated. The analyzer application must be
able to de-encapsulate GRE-encapsulated packets or the GRE-encapsulated
packets must be de-encapsulated before reaching the analyzer application.
(You can use a network sniffer to de-encapsulate the packets.)
• The output IP address cannot be in the same subnetwork as any of the
switch management interfaces.
• If you create virtual routing instances and an analyzer configuration that
includes an output IP address, the output IP address belongs to the default
virtual routing instance (inet.0 routing table).
991
Output VLAN (also known as VLAN to where copies of the packets are sent and to where a device running an
monitor or analyzer VLAN) analyzer is connected. The analyzer VLAN can span multiple switches.
The following limitations apply to an output VLAN:
• Cannot be a private VLAN or VLAN range.
• Cannot be shared by multiple analyzer statements.
• Cannot be a member of any other VLAN.
• Cannot be an aggregated Ethernet interface (LAG).
• On some switches, only one interface can be a member of the analyzer
VLAN. This limitation does not apply on the QFX10000 switch. When
ingress traffic is mirrored, multiple QFX10000 interfaces can belong to the
output VLAN and traffic is mirrored from all of those interfaces. If egress
traffic is mirrored on a QFX10000 switch, only one interface can be a
member of the analyzer VLAN.
Remote port mirroring Functions the same as local port mirroring, except that the mirrored traffic is not
copied to a local analyzer port but is flooded to an analyzer VLAN that you
create specifically for the purpose of receiving mirrored traffic.
You cannot send mirrored packets to a remote IP address on a QFabric system.
VLAN-based analyzer An analyzer session whose configuration uses VLANs for both input and output
or for either input or output.
SEE ALSO
Port Mirroring and Analyzers | 984
Instance Types
To configure port mirroring, configure an instance of one of the following types:
• Analyzer instance—Specify the input and output for the instance. This instance type is useful for
ensuring that all traffic transiting an interface or entering a VLAN is mirrored and sent to the
analyzer.
992
• Port-mirroring instance—You create a firewall filter that identifies the desired traffic and copies it to
the mirror port. You do not specify an input for this instance type. This instance type is useful for
controlling the types of traffic that are mirrored. You can direct traffic to it in the following ways:
• Specify the name of the port-mirroring instance in the firewall filter by using the port-mirror-
instance instance-name action when there are multiple port-mirroring instances defined.
• Send the mirrored packets to the output interface defined in the instance by using the port-mirror
action when there is only one port-mirroring instance defined.
For QFX5100, QFX5110, QFX5120, QFX5200, QFX5210, EX4600 and EX4650 switches, the following
port mirroring guidelines apply:
• A maximum of four port mirroring instances, or four analyzer sessions, can be configured at the same
time. In other words, you cannot configure four port mirroring instances and four analyzer sessions
together.
• If there are no port mirroring instances, (that is, only analyzer sessions are configured), then you can
enable up to three analyzer sessions for ingress and egress mirroring. The remaining analyzer session
must be used for ingress mirroring only.
• If you have only one port mirroring instance configured, then of the remaining instances, you can
configure up to three analyzers for ingress mirroring, and two analyzers for egress mirroring.
• If you have two port mirroring instance configured, then of the remaining instances, you can
configure up to two analyzers for ingress mirroring, and one analyzer for egress mirroring.
• If you have three port mirroring instance configured, then the remaining instance can only be
configured as an analyzer (for either ingress or egress mirroring),
Port Mirroring and STP
The behavior of STP in a port-mirroring configuration depends on the version of Junos OS you are using:
• Junos OS 13.2X50, Junos OS 13.2X51-D25 or earlier, Junos OS 13.2X52: When STP is enabled, port
mirroring might not succeed because STP might block the mirrored packets.
• Junos OS 13.2X51-D30, Junos OS 14.1X53: STP is disabled for mirrored traffic. You must ensure
that your topology prevents loops of this traffic.
993
Constraints and Limitations
IN THIS SECTION
Constraints and Limitations for QFX5100 and QFX5200 Switches | 996
The following constraints and limitations apply to port mirroring:
Mirroring only the packets required for analysis reduces the possibility of reducing overall performance.
If you mirror traffic from multiple ports, the mirrored traffic might exceed the capacity of the output
interface. The overflow packets are dropped. We recommend that you limit the amount of mirrored
traffic by selecting specific interfaces and avoid using the all keyword. You can also limit the amount of
mirrored traffic by using a firewall filter to send specific traffic to the port mirroring instance.
• You can create a total of four port-mirroring configurations.
• On EX9200 switches, port mirroring is not supported on EX9200-15C line cards.
• Each Node group in a QFabric system is subject to the following constraints:
• Up to four of the configurations can be used for local port mirroring.
• Up to three of the configurations can be used for remote port mirroring.
• Regardless of whether you are configuring a standalone switch or a Node group:
• There can be no more than two configurations that mirror ingress traffic. If you configure a
firewall filter to send mirrored traffic to a port, this counts as an ingress mirroring configuration for
the switch or Node group to which the filter is applied.
• There can be no more than two configurations that mirror egress traffic.
• On QFabric systems, there is no system-wide limit on the total number of mirror sessions.
• You can configure only one type of output in one port-mirroring configuration to complete a set
analyzer name output statement:
• interface
• ip-address
• vlan
• Configure mirroring in an analyzer (with set forwarding-options analyzer) on only one logical interface
for the same physical interface. If you try to configure mirroring on multiple logical interfaces
994
configured on a physical interface, only the first logical interface is successfully configured; the
remaining logical interfaces return configuration errors.
• If you mirror egress packets, do not configure more than 2000 VLANs on a standalone switch or
QFabric system. If you do, some VLAN packets might contain incorrect VLAN IDs. This applies to any
VLAN packets, not just the mirrored copies.
• The ratio and loss-priority options are not supported.
• Packets with physical layer errors are not sent to the output port or VLAN.
• If you use sFlow monitoring to sample traffic, it does not sample the mirror copies when they exit the
output interface.
• You cannot mirror packets exiting or entering the following ports:
• Dedicated Virtual Chassis interfaces
• Management interfaces (me0 or vme0)
• Fibre Channel interfaces
• Integrated routing and bridging (IRB) interfaces (also known as routed VLAN interfaces or RVIs)
• In a port-mirroring instance, you cannot configure an inet or inet6 interface as the output interface.
The following switches do not support the set forwarding-options port-mirroring instance 
family inet output interface  configuration:
Table 117: Switches Not Supporting family inet/inet6 as Output Interface
EX Switches QFX Switches
EX2300 QFX3500
EX3400 QFX5100
EX4100 QFX5110
EX4300 QFX5120
EX4400 QFX5130
995
Table 117: Switches Not Supporting family inet/inet6 as Output Interface (Continued)
EX Switches QFX Switches
EX4600 QFX5200
EX4650 QFX5210
QFX5220
QFX5700
• An aggregated Ethernet interface cannot be an output interface if the input is a VLAN or if traffic is
sent to the analyzer by using a firewall filter.
• When mirrored packets are sent out of an output interface, they are not modified for any changes
that might be applied to the original packets on egress, such as CoS rewriting.
• An interface can be the input interface for only one mirroring configuration. Do not use the same
interface as the input interface for multiple mirroring configurations.
• CPU-generated packets (such as ARP, ICMP, BPDU, and LACP packets) cannot be mirrored on egress.
• VLAN-based mirroring is not supported for STP traffic.
• (QFabric systems only) If you configure a QFabric analyzer to mirror egress traffic and the input and
output interfaces are on different Node devices, the mirrored copies will have incorrect VLAN IDs.
This limitation does not apply if you configure a QFabric analyzer to mirror egress traffic and the
input and output interfaces are on the same Node device. In this case the mirrored copies will have
the correct VLAN IDs (as long as you do not configure more than 2000 VLANs on the QFabric
system).
• True egress mirroring is defined as mirroring the exact number of copies and the exact packet
modifications that went out the egress port. Because the processors on QFX5100 and EX4600
switches implement egress mirroring in the ingress pipeline, those switches do not provide accurate
egress packet modifications, so egress mirrored traffic can carry incorrect VLAN tags that differ from
the tags in the original traffic.
• If you configure a port-mirroring instance to mirror traffic exiting an interface that performs VLAN
encapsulation, the source and destination MAC addresses of the mirrored packets are not the same
as those of the original packets.
996
• Mirroring on member interfaces of a LAG is not supported.
• Egress VLAN mirroring is not supported.
The following constraints and limitations apply to remote port mirroring:
• If you configure an output IP address, that address cannot be in the same subnetwork as any of the
switch management interfaces.
• If you create virtual routing instances and you create an analyzer configuration that includes an
output IP address, the output IP address belongs to the default virtual routing instance (inet.0 routing
table).
• An output VLAN cannot be a private VLAN or VLAN range.
• An output VLAN cannot be shared by multiple analyzer sessions or port-mirror instances.
• An output VLAN interface cannot be a member of any other VLAN.