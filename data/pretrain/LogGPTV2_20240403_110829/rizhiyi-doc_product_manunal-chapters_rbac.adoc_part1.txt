== 权限管理
日志易采用RBAC(基于角色的访问控制)式的权限管理设计，能够为您提供非常细粒度的访问控制。您默认登录使用的admin账户，具有系统最高权限，可以完成一切操作。在后续的团队协作使用中，则需要对不同团队设置不同的数据访问、资源共享、功能使用权限。
=== 概念简介
使用日志易权限管理系统，必须先了解一下基础概念：
* 用户：即可登录日志易系统的用户。
* 用户分组：用户与用户分组之间是多对多的关系，一个用户可以属于多个用户分组，一个用户分组可以包含多个用户。
* 角色：角色持有一组权限：
** 可以通过角色授权界面对一个角色持有的对应权限进行编辑。
** 角色和用户之间是多对多的关系。用户可以直接拥有角色。每个用户创建/删除时都会同时创建/删除关联的角色。
** 角色和用户分组之间是多对多的关系。用户分组可以拥有角色。每个用户分组创建/删除时都会同时创建/删除关联的角色。
* 内置角色：系统内置\__admin__和\__user__角色，同时也给每个用户和用户分组内置对应的专属角色。
** \__admin__是租户创建完毕后，默认内置的角色，拥有最高权限，可以看到所有类型资源和所有功能。\__admin__不可以查看/编辑/授权/删除。只有\__admin__角色才拥有下述权限：
*** 可删除用户
*** 可解锁用户
*** 可禁用/启用用户
*** 可查看未分配资源
*** 可查看所有日志
*** 系统配置system/custom/
*** 可以新建/编辑/删除搜索权限
*** 可以新建，复制，删除角色
*** 可以修改用户分组管理员和角色
*** 可以修改用户的角色和可管理角色
*** 可以新建/更新告警插件
** \__user__是租户创建完毕后，默认内置的角色，只拥有登录和查看个人信息的权限，可以手动授权，不能编辑或删除。所有用户默认都授予\__user__角色。
** 用户关联角色，命名规则为\__user_[用户名称]__，有如下特征：
*** 新建用户时，默认同时创建该用户的同名角色。
*** 删除用户时，该关联角色也同时删除。
*** 所有用户对自己同名角色只有授权权限，不能手动编辑，删除。
** 用户分组关联的默认角色，命名规则为\__group_default_[用户分组名称]__有如下特征：
*** 新建用户分组时，默认同时创建该用户分组的同名角色。
*** 删除用户分组时，该关联角色也同时删除。
** 用户分组关联的管理员角色，命名规则为\__group_admin_[用户分组名称]，__有如下特征：
*** 新建用户分组时，默认同时创建该用户分组的同名角色。
*** 删除用户分组时，该关联角色也同时删除。
*** 用户分组的管理员默认授予该角色，拥有该角色的用户对本组关联角色\__group_default_[用户分组名称]__有编辑授权权限，不能删除。
* 权限：对一个具体操作（与操作目标）的许可称为一个权限。比如下述列出：
** 可读取名为dashdemo的仪表盘：操作是读取仪表盘dashdemo，操作目标是仪表盘列表页可以看到该仪表盘，前提是该用户拥有这个角色。
** 可编辑名为dashdemo的仪表盘：操作是编辑仪表盘dashdemo，操作目标是编辑该仪表盘的属性：名称，标签，仪表盘的Tab页等。
** 可转授资源：转授即二次授权，用户a分享某资源给用户b，且赋予b可以转授权限，则b可以把该资源分享给其他用户；如果a没有给b赋予转授该资源的权限，则b不能把资源分享给其他用户。
* 资源：权限可操作的目标被称为资源。包括：趋势图，定时任务，告警，仪表盘等。
* 功能类权限：是在"角色权限授权"页面上的“功能”分类下的权限。特点是不与某种“资源”有关，只表明一种功能。
* 应用访问权限：在授权页面"应用权限"分类下的权限。标明用户可以在应用列表里访问、更新和删除哪些应用。
=== 角色权限
==== 新建角色
在"权限"菜单上点击"角色权限"打开角色列表页，页面右上角点击“新建”按钮，即可创建一个新角色：
image::images/role-new.png[]
填写角色名称和相应的描述，比如叫“只读”。角色授权过程中，勾选或反选操作无需点击保存，在翻页时会自动提交保存。
==== 基础配置授权[[search-permission]]
日志易可以对拥有该角色的用户的检索查询请求进行权限控制，这也是角色权限最基础的部分。如果一个用户所拥有的所有角色都没有被授予至少一个索引读取和至少一个搜索权限时，这个用户将无法搜索任何数据。目前支持的基础配置授权包括：索引、搜索权限、主题、搜索时长、默认索引等。
===== 索引权限
该权限在索引标签中设置，用来限定用户可搜索的索引查询范围。对无可读权限的索引，即使在 SPL 中指明 `index=xxx *` 也无法获取结果。对无可写权限的索引，即使有可使用 collect 指令的权限，也无法成功写入。详细说明参见数据管理-索引配置章节。
image::images/rbac-search.png[]
===== 搜索权限
该权限在搜索权限标签中设置，用来限定用户可搜索的数据查询范围。与索引权限相比，搜索权限可以基于 SPL querystring 语句进行更细粒度的数据查询范围划分和权限管理。只有 \__admin__ 角色可以新建、编辑和删除搜索权限，其他用户只能被授予读取和转授的权限。详细说明参见数据管理-搜索权限章节。
===== 主题
该权限在主题标签中设置，用来限定用户可读写的主题。详细说明参见数据管理-主题配置章节。
===== 最大搜索时长
该权限在授权配置标签中设置，用来限定用户搜索的时间范围长度。默认不开启该控制。在集群资源比较紧张的情况下，通常管理员会偏好限定普通用户的最大搜索时长为一天/一周等。如果一个用户被分配多个搜索时长，则取多个搜索时长的最大值。
例外配置：部分索引，如 schedule、monitor 等，存储数据量较小，允许搜索时间范围较大，可以通过例外配置来单独定义这部分索引的最大搜索时长。
===== 默认索引配置授权
默认索引是指当SPL中不包含索引名称（如SPL为'*'）时，使用的索引。管理员可以在manager->splserver服务->query.default_index中配置默认索引，作用于所有用户：
image::images/manager-default-index.png[]
也可以使用基于角色的默认索引，只作用于拥有此权限的用户，以便实现更小粒度的权限控制。当两者同时配置时，基于角色的默认索引生效。用户给角色授权默认索引前，需要至少先授权以下权限中一项：
* 可以读取所有内部索引，内部索引包括：
** 标准版本内置索引
*** yotta
*** schedule
*** monitor
*** cruxee
*** machinelearning_showcase
*** _internal
*** 下划线开头的索引名
** 异常检测内置索引
*** kpi_monitor
*** kpi_tmp
*** _log_anomaly
** siem内置索引
*** siem_threat
*** siem_intelligence
** 观察易内置索引
*** _o11y_metrics
*** _o11y_trace
*** _o11y_topology
* 可以读取所有非内部索引
** 内部索引以外的所有索引
* 可以读取指定索引
===== 首页路径配置授权[[custom-homepage-permission]]
在基础权限配置中，还可以设置拥有该角色的用户的默认主页。
image::images/rabc-custom-homepage.png[]
如果用户拥有多个角色时，首页路径的最终取值遵循如下规则：
* 用户登录时，首先查找自己同名角色\__user_[用户名称]__是否配置首页路径，如果有，则以该首页路径为准。
* 如果用户同名角色没有配置首页路径，则查找用户拥有的其他角色。如果有多个角色配置首页路径，则将这些角色按照名称字母正序排列，以第一个角色配置的首页路径为准。
* 如果多个角色都没有配置首页路径，则以系统设置中的首页路径为准，默认的系统设置首页路径为 `/homepage/`。
+ 
image::images/system-setting-homepage.png[]
[NOTE]
====
日志易内部相对路径是以/开头，以/结尾的字符串，如果写成/dashboard会报404错误。
====
检索配置对定时任务等同样有效，日志易只能在界面编辑时主动校验输入是否合法，如果变更检索配置权限导致已有任务超限失败，您将在运行历史里看到对应的错误提示。
==== 功能授权
除了数据检索权限以外，访问日志易页面还需要基础的功能类权限。功能类权限只限定到功能本身的访问，并不关联具体的资源。一般而言，普通用户只需要授予搜索和资源类的功能权限即可。
image::images/rbac-functions.png[]
日志易平台目前提供搜索、资源、数据、应用、系统、用户与验证功能的权限管控。
===== 搜索功能权限管控
搜索功能权限管控包括：
可查看搜索页::
    是否可以使用搜索页
    * 是否可以下载搜索结果(download 指令)
    * 是否可查看统计菜单
    * 是否可以查看敏感内容
    * 是否可以使用模式学习
    * 是否可以使用离线任务
    * 是否可以使用事件操作
    * 是否可以使用collect指令
    * 是否可以使用delete指令
===== 资源功能权限管控
资源功能权限管控包括：
可查看仪表盘::
    是否可以使用仪表盘
    * 是否可以新建仪表盘
可查看监控::
    是否可以使用监控
    * 是否可以新建监控    
可查看告警插件::
    是否拥有可查看告警插件的权限
可查看定时任务::
    是否可以使用定时任务
    * 是否可以新建定时任务
可查看报表::
    是否可以使用报表
    * 是否可以新建报表
可查看趋势图::
    是否可以使用趋势图
    * 是否可以新建趋势图
可查看数据集::
    是否可以使用数据集
    * 是否可以新建数据集
可查看已存搜索::
    是否可以查看已存搜索
    * 是否可以新建已存搜索
可使用搜索宏::
    是否可以使用搜索宏
    * 是否可以新建宏
可查看字段提取::
    是否可以使用字段提取
    * 是否可以新建字段提取    
可查看字典管理::
    是否可以使用字典管理
    * 是否可以新建字典
可查看KV字典::
    是否可以查看KV字典
    * 是否可以创建KV字典
可查看拓扑图::
    是否可以使用拓扑图
    * 是否可以新建拓扑图
可查看全链路::
    是否可以查看全链路
    * 新建全链路      
可查看知识库::
    是否可以使用知识库
    * 是否可以新建知识
可查看资源列表::
    是否可以查看资源列表
    * 是否可以使用资源包导入导出
可查看指令配置::
    是否可以查看指令配置
    * 是否可以新建指令配置