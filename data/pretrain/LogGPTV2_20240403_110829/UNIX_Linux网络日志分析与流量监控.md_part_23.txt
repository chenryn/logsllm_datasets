1.事件背景
可以看到，每条日志记录都记录了时间戳，这为我们正确分析、处理各种故障提供了
可通过Show logging查看配置以及日志记录情况：i
接下来我们配置console和monitor 参数，全部设定为4级：
Mar 18 11:14:30: %SYS-5-CONFIG_I: Configured from console by console
Mar 18 11:13:54: %SYS-5-CONFIG_I: Configured from console by console
Consolelogging:levelwarnings,13messages logged
Syslog logging: enabled (0 messages dropped, 1 flushes, 0 overruns)
Router#show logging
Router(config)#logging monitor 4
Router(config)#logging console 4
Router(config)#logging buffered 81924
raplogging:disabled
Bufferlogging:leveldebugging,2messageslogged
Monitorlogging:levelwarnings0messageslogged
出
0单
率的出球志日宝
盗用设
ve ge gin
TotnoM
1ill-sio
rolivom
amprl
vilfaG
10105009
反
---
## Page 132
控，结果都相同：对数据泄漏攻击并没有马上采取补救措施。
数据泄漏事故在实际事故发生前就能找到蛛丝马迹，不管具体使用的是何种类型的事件监
应该是很多企业调查日志管理工作的首要原因。《2012年数据泄漏调查报告》显示，85%的
序监控、系统故障排除和审计等，良好的日志管理解决方案能帮助加强企业安全。安全审计
和分析计算机和设备日志在很多方面都发挥着重要作用，包括信息安全、操作管理、应用程
良，于是想当然地将该网线插到了交换机上空余的一个端口上，结果造成了此次故障。
小王询问机房值班员得知，前两天在例行设备检查时他发现“脱落”的网线，以为是接触不
现了一条多余网线。将它拔掉后，该大楼的网络恢复正常。但是为什么会出现这种情况呢？
了日志，信息如下：
通过观察发现，该栋楼所使用的两台Cisco4006端口的指示灯闪动频率很快。小王立刻调取
神为之一振。
会引起数据风暴，从而阻塞网络。那么，大楼内是不是存在网络环路呢？想到这里，小王精
推断不是由于病毒所致。
低，通过网络流量监视软件MRTG发现，整个内网的数据包发送数量远远低于平时，他们
动，开始利用SnifferPro网络抓包，结果发现网络带宽并没有被大量占用，而且利用率很
网内爆发病毒，因为以前就出过蠕虫病毒和ARP 病毒造成网络拥塞的情况。他们分头行
了一中午，重启所有的交换机，并做了些调试，可网络拥塞依旧。随后他们一合计，怀疑是
午休息时间，重新启动交换机，期望能够解决问题。然而事与愿违：他们顾不上吃饭，忙碌
3.4
既不是交换机问题，也不是网络病毒，那么问题在哪里呢？如果网络中出现环路，同样
一般来说，
日志管理是所有企业都应该部署的技术，但只有很少的企业部署了日志管理系统。收集
通过以上信息他可以立即断定故障是由于环路所致。这时，小张在一旁对照跳线表，发
port3/13
port1/2
port3/47
port3/47
port3/45
port1/1
一
2011May 1812:55:39 %SYS-4-P2_WARN:1/Host 00:11:25:19:c3:b2 is flapping between port 1/2 and
2011May 1812:55:34 %SYS-4-P2_WARN:1/Host 00:00:0c:07:ab:01 is flapping between port 1/2 and
2011May1812:55:32%SYS-4-P2_WARN:1/Host00:04:de:17:2c:20isflapping between port 1/2and
选择日志管理系统的十大问题
2011 May 18 12:55:35 %SYS-4-P2_WARN: 1/Host 00:05:9a:20:76:20 is flapping between port 1/2 and
，如果出现网络环路，那么出现环路的交换机上所有端口的指示灯就会狂闪。
第3章建立日志分析系统109
---
## Page 133
情况下几乎所有数据、图形或者警报都可以显示。OSSIM仪表盘如图3-7所示。
性能，以及一些重要事件的通知。OSSIM还允许用户自己定义仪表盘显示信息。在大多数
系统本身和所监测事件的关键实时统计数据。大多数仪表盘都会报告事件消息数、本地CPU
出的日志格式是厂家的专有格式还是原始日志格式，这取决于司法取证的需要。
间利用率的角度看，适合采用RAID5 技术。另外要注意日志存储的数据格式，要搞清楚输
磁盘阵列，那么适合选择RAIDO+1。如果将压缩好的日志文件归档到磁盘阵列，从磁盘空
大家在选择日志系统时候应注意日志管理系统要跟上最新操作系统的更新步伐。nm
插件它们能支持Windows7和WindowsServer2008提供的100多个内置审核日志。所以
其他日志管理工具收集。在开源的日志管理工具中支持比较好的为OSSIM、Splunk。通
能够包罗万象。例如微软最新的操作系统Windows Server2012 中内置的审查日志就不能被
管理节点，则要确保查询和报告可以在多个节点间执行搜索并产生报告。
到实时数据分析、打印报告和历史日志的索引分析。如果你的解决方案涉及两个以上的日志
味着你有一个日志管理层可以转发数据到集中日志管理层。很多产品都可以转发事件到其他
度提高系统环境的性能。本章涉及的每个日志分析产品都可以作为存储和转发收集器，这意
作量分配无疑是非常重要的。应该与供应商合作来解决日志管理工作量分配问题，以最大限
保操作系统本身不会有安全漏洞存在，其次才是日志分析系统的功能问题。
操作系统本身漏洞的制约，需要管理员配置好基本操作系统（例如Linux/Windows 等），确
全，但设备本身和随机配的分析软件的授权相当昂贵。而纯软件的日志分析软件又受到通用
UNIX系统，因为能接触到的人比较少，相对漏洞发现的也不多，这种产品使用起来比较安
这是摆在管理员面前的问题。一些国外大厂家的硬件日志收集分析系统，所采用的是类
110UNIX/Linux网络日志分析与流量监控
以一般
产
段：酉
首先是日志系统的性能问题，性能的高低不仅对避免网络拥堵问题有实际意义，也关系
品，特别是那些支持Syslog和 SNMP的产品。
从上千台计算机（包括设备）发送日志信息到一个日志管理器会导致网络瘫痪，可见工
本在选择日志管理系统时，是选择功能强大而全面的硬件设备，还是小而专的软件产品，
2.日志系统的负载问题到
多数产品都允许管理员（admin用户，拥有完全权限）来设置更多受限角色。例如，
7.角色管理问题
目前能够进行可视化管理的日志管理产品都有管理控制台和仪表盘，显示关于日志管理
6.日志的可视化
磁盘阵列的 RAID 技术也是值得注意的，如果用 Syslog 将小而多的 RAW日志直接写到
般都会配合磁盘阵列作为存储设备。
企业日志每天都会产生大量日志，仅凭服务器上的磁盘无法承载如此之多的日志量，所
5.日志存储问题
很多供应商声称他们的产品适用于任何类型的环境，其实根据笔者的经验没有哪个产品
3.性能问题
1.功能问题
配置、收集、索引、存储、警报和报告。以下是日志管理系统面临的十大问题。
作为网管，你不但需要了解日志收集方法，而且需要理解日志管理生命周期的几个阶
过
品
---
## Page 134
每个角色来定义。
么屏幕，如图3-8所示。其他产品允许更多的角色定义，屏幕上的每个属性和域都可以根据
OSSIM日志系统就只允许定义一个超级管理员，以防权限滥用。还允许管理员定义显示什
图3-8OSSIM中的角色定义
Ask to change passwors at next iogin
Make ths useragtbaann
Re-enteruserpassword"
Main
Enter userpaxswond
图3-7OSSIM仪表盘
Risk Maps
Department
User name
Userlogi
pany
日
CYesNO
CYesNO
第3章建立日志分析系统111
Yok
---
## Page 135
报和报告，如图3-9所示。
称。设备组然后可以作为单一实体被监测，这样当试图监测某特定类型设备时更容易实现警
个或多个既定组名的受监测客户端，根据某种属性来分组，例如设备类型、IP地址或者名
力。第14章的HIDSAgent就属于代理（Agent）模式。
以后的检索。客户端代理通常能够提供传输压缩。经过以上处理可减小发送日志带来的网络压
到中央服务器，代理可以仅发送关键事件，并且如果需要的话，还可以本地存储事件信息以备
文，从而导致网络拥塞。而且SNMP也不支持分布式管理，所以网管工作站的处理能力可能
的不足之处，它使用轮询采集数据，而在大型网络中使用轮询方式将产生巨大的网络管理报
SNMP 收集。如果涉及防火墙的话，这些方法都需要必要的规则修改。SNMP也有一些明显
3.5.3节介绍过的Eventlog Analyzer 软件就使用无代理模式。大多数产品使用Syslog 转发或
个配置选择，允许管理员决定收集哪些事件，以及如何收集。例如，不需要发送每条日志信息
成为收集日志的瓶颈。
112UNIX/Linux网络日志分析与流量监控
被监测的客户端可以逐个添加，或批量导入。部分产品允许创建“设备组”，来收集一
尺有所短，寸有所长，Agent 模式具有无代理收集方法不具备的优势。大多数代理都有多
无代理模式意味着管理员不需要为每个客户端分配、安装和配置额外软件，例如在本章
（1）无代理模式（Agentless）
日志管理工具的主要功能就是从各个被检测客户端收集日志信息。日志管理工具分为两种。
8.日志收集问题
图3-9搜索网络中的设备
---
## Page 136
持多种类型的报警方式。例如传统的电子邮件报警、短信息报警。
显示的强大功能。
示你感兴趣的特定消息前面和后面的多个事件。在图3-11中展示了OSSIM系统自定义日志
Splunk日志查询过程中的一幅截图。
同的Server上完成搜索查询，也起到了分流的作用，极大地提高了查询速度。图3-10就是
并发搜索数据，在不同的SplunkServer上的indexer上同时进行索引并加载，这样可以在不
戳）进行索引，当日志量增大到一定程度时，我们可以采用分布式的索引，这时当有多用户
询，而是基于索引的查询机制，它对从本地或远程收集来的日志数据（这些日志中带有时间
环境，笔者认为Splunk能够胜任，主要原因是Splunk不像其他日志分析软件采用数据库查
行搜索。但自己部署的一些日志管理系统总不能让人十分满意，如果是一个日志产量很大的
分析系统的重要标志之一。我们希望日志管理系统的过滤搜索能够快速从非常大量数据中进
操作系统版本进行细致的分析。
报警是日志管理非常重要的功能，对于 SIEM也是至关重要的功能。供应商应该能够支
10.输出报警/报告
另外，拥有很多内置、预定义搜索过滤器也很不错。例如 OSSIM 或 Splunk 等产品会显
splunk
根据感兴趣类型和事件来搜索存储数据同样是日志管理重要的功能，也是一款优秀日志
专业的日志系统都有内置式报告，例如本书介绍的Eventlog Analyzer、Splunk及OSSIM
（1）报警
9.搜索存储的数据问题
大多数产品都声称拥有 Windows 事件日志收集代理。然而，很多产品并不能对最新的
注意：
37事全
P
0上5Ap5：333fc
10-43上年1125:1.0
图3-10Splunk日志查询
加图3一15起
0468:to<sp
量第3章建立日志分析系统113
splunkit.com
Delay
日用
2.E
---
## Page 137
对各服务器进行分散管理。另一种方法则是使用日志主机系统集中管理日志。
理通常采用两种方法。一种方法是不同服务器的日志信息都存放在各自系统内，系统管理员
的作用。本节就和大家探讨如何利用Linux日志系统使管理系统更轻松。对于日志信息的管
3.5利用日志管理工具更轻松
Reports
例，其输出的报告种类比较全面，如图3-12所示。
CSV、HTML、XLS、TXT 和PDF 等。拥有越多的内置报告越有帮助。以OSSIM 系统为
外收费的）涉及特定安全，如PCI、SOX、FISMA等。报告通常能够以不同格式存储，如
等，并允许报告进行自定义功能。我们希望拥有数量众多的内置报告（无论是免费的还是额
114UNIX/Linux网络日志分析与流量监控
X
有效利用日志信息并对其进行分析与实时的监控管理，对于系统的安全性具有极为重要
Deployment
Intelligence
Assets
Analysis
Avallability Report
AssetReport
Alarms
图3-12OSSIM系统中的各种输出格式
Report
图3-11OSSIM自定义日志显示内容
Secaihost
View Rkeport
---
## Page 138
com/tag-evtsys.html。解开后得到两个文件：evtsys.ext 和 evtsys.dll。m
依上述方法将其他系统日志信息（如/var/log/secure）导入到日志主机上。
安装：
志主机的/var/log/message文件里，对各服务器的日志信息进行统一的管理。
/var/log/message即Sysolg存放系统日志的绝对路径，将此值替换为日志主机名即可，示例如下：
conf，其默认配置为（仅以/var/log/message日志为例）：
放514端口，以iptables为例，对特定网段开放514端口：
“-r”选项使syslog接收客户端的远程日志信息。
配置其作为服务器端，需对此配置文件相应部分改为如下所示：
用Linux平台上的Syslog。
各主机系统相当于客户端，将日志信息实时传送到日志主机中。
3.5.1
将这两个文件放到C:IWINDOWS\system32目录下，在命令行状态下运行如下命令进行
Syslog 在服务器端，并且支持远程的日志收集。其配置文件为/etc/sysconfig/syslog，要
日志主机系统包括日志主机及各主机系统两个部分，其中日志主机相当于服务器端，而
在Windows平台下采用软件evtsys 进行客户端的部署，其下载链接为 http://down.5/cto.
2）Windows平台下客户端的部署
使用如下命令重启Syslog服务，使配置生效：
依上述配置，当Syslog重启使配置生效后，客户端服务器的日志信息会实时传送到日
在Linux 平台下依然选择Syslog 作为客户端进行部署，此时配置文件为/etc/syslog.
1）Linux平台下客户端的部署
Syslog采用514端口监听来自各客户端的日志信息，
重启 Syslog服务器端使配置生效：
（2）客户端的部署
（1）日志主机的部署
日志主机系统的部署
#service syslogd restart