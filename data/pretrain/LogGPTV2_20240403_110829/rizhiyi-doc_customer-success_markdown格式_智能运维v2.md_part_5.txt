-   周期性指标适用算法：CVAE
-   非周期性指标、离散型指标适用算分：KDE、IF、MA
-   特殊性指标适用算法：KDE
对于每个场景，用户可以根据算法具体表现配置可调节参数和敏感度。
![图片 1](media/image57.png){width="5.768055555555556in"
height="2.907283464566929in"}
### 日志异常检测模型
日志模式异常检测的思路是采用**层次聚类（Hierarchical
Clustering）**对日志模式进行收敛。日志模式异常识别基于日志聚类算法进行自动学习模式和识别异常，通过抽取关键字构成字段树模式，然后对模式和参数做时序检测。
日志易lynxee的日志模式异常识别将**模式异常、参数异常、占比异常**融合在一起来做日志模式聚类分析。
![图片 5](media/image58.png){width="5.768055555555556in"
height="2.4340277777777777in"}
日志异常检测主要功能有：
-   参数检测：检查日志的某些位置是否出现异常，例如响应时间。
-   占比检测：检查训练结果中的各个模式在每个检测时间段内对应的日志占比是否出现激增或者骤降。
-   敏感度：检查模式异常的敏感度，由左向右敏感度由低到高，也就是检测由松到严。
-   敏感度调试预览：上传自己的测试数据，可以根据模拟检测结果调整敏感度。
-   间隔时间：每间隔多久对最近的一段时间内的数据进行对应的检测。
-   异常数量告警阈值：日志异常数量超过阈值发出告警。
![](media/image59.png){width="5.706078302712161in"
height="1.8767705599300089in"}
日志异常检测相关模块：
-   mongodb存储日志异常检测模块的训练模型、任务配置、检测结果等数据；
-   loganalyzer 主要负责数据采集、模型训练等工作。
    1.  ### 服务健康度模型
服务健康度是基于KPI指标异常检测构建的多层级服务的健康度检测模型，通过不同服务的优先级和指标数据的重要程度，拟合出来一个服务的健康度，不同的服务相互存在逻辑上的依赖关系，可根据服务和指标的重要性来自定义健康度的重要程度，让用户对系统状态一目了然。
系统根据每个监控项的监控结果，计算得出一个 \[0-100\]
之间的数值，这个值，就是服务的健康度分值。
服务健康度分值由归属服务的监控项和所依赖的服务的健康度共同计算得出，默认情况下服务的监控项的权重为5，服务的所依赖服务权重为10，健康度设计分为4个危急程度，正常、低危、中危和高危，健康度分值对应85-100（正常）、60-85（一般）、30-60（严重）、0-30（非常严重），颜色分别对应蓝绿黄红，还有一种灰色状态表示最近10分钟无最新数据。
通过健康度管理实现业务管理模型，从业务、应用和物理资源等维度的实际值与期望值的对比并进行分析计算，以此实现对业务运营健康状态的综合评价，建立业务系统健康度视图。
![图片 9](media/image60.png){width="5.6347233158355206in"
height="3.929515529308836in"}
![\\\\VBOXSVR\\rzy-zbf\\Downloads\\行为指标考核流程图.png](media/image61.png){width="5.633575021872266in"
height="2.6565430883639545in"}
数据处理顺序为：智能运维指标数据(处理完成的数据-)日志易kafka
topic/lynxee_kpis(可配置） kpimonitor（消费者influxConsumer）
influxdb(数据库lynxee)
为了得到满足符合要求的数据格式，目前一般有两种方法：
1、直接通过脚本把数据处理好，写入kafka topic。
2、通过数据工厂的方式进行数据处理，写入kafka topic。
## 指标和服务健康度异常检测
围绕三类使用场景，使用智能运维的顺序大致如下：
1.  根据数据要点及分析方向，导入指标数据，并接入设备及服务信息。根据数据所在集群内设备/服务分布情况，lynxee会生成服务场景模型；
2.  选择合适的算法，进行指标训练；
3.  配置指标自动监控；
4.  产品使用及维护。
为便于理解，该小节首先会对服务场景模型进行说明，然后分别介绍指标数据、设备和服务信息的接入，之后是配置指标自动监控的流程，接下来是服务健康度异常告警相关配置，最后是指标健康度异常告警相关配置。
### 服务场景模型
日志易集群业务系统，使用的场景为集群模式部署，在多台主机部署各类分布式和高可用服务模块，主机实例的OS性能指标为一类服务，如日志易CDN集群.OS和日志易CDN集群.KAFKA.OS，服务模块的整体性能指标为一类服务，如日志易CDN集群.COLLECTOR、日志易CDN集群.KAFKA。
进入智能运维首页是服务场景总览，可以看到当前已接入的所有服务和指标项，不同的颜色代表不同的健康度状态，以下蓝色为正常状态，黄色表示系统不健康。
![](media/image62.png){width="5.768055555555556in"
height="1.9041666666666666in"}
![](media/image63.png){width="5.770138888888889in"
height="2.7784722222222222in"}
服务健康度和指标监控项的状态总览：（图中为服务总览卡片视图，服务视图的数值为当前健康度最新的健康度原始数值，服务的趋势线是1分钟间隔健康度平均值，监控项视图的数值为该性能指标的当前最新原始值，监控项的趋势线是1分钟间隔的健康度平均值）
![](media/image64.png){width="5.768055555555556in"
height="3.2444444444444445in"}
### 指标数据接入
日志易集群的指标数据存储在influxdb时序数据库的db数据库中，每个性能指标都有一个独立的表，共有723个指标，涉及主机OS和服务模块性能指标共21种，筛选需要的主机OS性能指标和服务性能指标实时接入智能运维所用的Kafka队列lynxee_kpis。
这里根据不同指标在influxdb中的查询方式，将接入指标划分成3种类型，分别是单机性能指标、单机可选类型性能指标和服务性能指标，所有指标均为间隔1分钟采集1次。
日志易集群的3种性能指标数据类型：
1.  单机性能指标，如os.cpu.used
2.  单机可选类型性能指标，如os.disk.size.percent，根据key/分区和/data分区
3.  服务整体性能指标，又分为sum、avg汇总统计方式，如kafka.topic.in_speed.raw_message、logriver.income_events.rate
单机性能指标实时数据在influxdb的查询示例：
select \* from \"os.cpu.used\",\"os.mem.availablePerent\" where time \>=
now() - 1m
单机可选类型性能指标实时数据在influxdb的查询示例：
select \* from \"os.disk.size.percent\" where \"key\"=\'/data\' AND time
\>= now() - 1m
服务整体性能指标实时数据在influxdb的查询示例：
select sum(value) as value from \"kafka.topic.lag.raw_message\" where
time \>= now() - 1m group by time(1m) fill(none)
接入智能运维的日志易集群性能指标：
os.mem.availablePercent //主机可用内存比例
os.cpu.used //主机CPU总占用率
os.disk.size.percent //主机/data文件系统磁盘使用率
kafka.topic.in_speed.raw_message //raw_message原始消息队列消息增长速度
kafka.topic.out_speed.raw_message //raw_message原始消息队列消息处理速度
kafka.topic.lag.raw_message //raw_message原始消息队列未处理的数量
collector.source.AcceptEventCountSpeed //collector接收日志条数速率
性能指标数据接入流程：
-   历史指标数据采集：
![](media/image65.png){width="5.768055555555556in"
height="1.5395833333333333in"}
-   实时指标数据采集：
![](media/image66.png){width="5.768055555555556in"
height="2.0993055555555555in"}
历史指标一次性采集指定的某一天到当天的最近一小时以内，通常采集最近7天就可以。实时指标通常采集1分钟间隔数据，可以使用数据工厂从API采集实时性能指标，这用使用的是系统定时任务脚本，输出每个时间间隔的性能指标到本地目录的文本文件，一个性能指标写入一个文本文件，本地目录通过NFS挂载到数据工厂所在的主机，在数据工厂新建Pipeline，使用File
Tail数据源组件实时获取每个指标数据文本写入到智能运维topic。
已接入的指标预览：
![](media/image67.png){width="5.770138888888889in"
height="1.9180555555555556in"}
![](media/image68.png){width="5.770138888888889in"
height="1.9159722222222222in"}
![](media/image69.png){width="5.770138888888889in"
height="1.9090277777777778in"}
![](media/image70.png){width="5.770138888888889in"
height="1.9159722222222222in"}
### 设备和服务导入
导入单个设备或设备的流程如下：
1.  配置菜单页，添加服务，内部ID对应监测数据中的service，通过\`.\`串联多层次组织，服务可以根据监控项或依赖服务设计健康度；
2.  添加设备，选择关联服务，索引字段值可选endpoint、tag，一种设备可以拥有多个指标；
3.  附加信息可以添加中文分组，设备监控页面中的分组方式就是索引字段组和附加信息；
4.  设备监控页的默认指标，对应的配置参数在yottaweb的lynxee.custom_device_filter，必须配置。
![](media/image71.png){width="5.768055555555556in"
height="4.198611111111111in"}
![](media/image72.png){width="5.701278433945757in"
height="3.452492344706912in"}
集群主机数较多时，可采用csv文件导入的方式批量添加设备。csv文件首行包括几个由逗号分隔符隔开的字段名，其中第一列为设备名称的关联字段，第二行为索引字段值的关联字段，第三列为所属服务的关联字段，附加信息为可选字段，所属服务填写的是服务的内部ID，多个所属服务使用/反斜杠分隔。
导入的设备CSV文件示例：
name,endpoint,service
192.168.10.1,192.168.10.1,rizhiyi.cluster.os/rizhiyi.cluster.kafka
192.168.10.2,192.168.10.2,rizhiyi.cluster.os/rizhiyi.cluster.collector
192.168.10.3,192.168.10.3,rizhiyi.cluster.os/rizhiyi.cluster.kafka
192.168.10.4,192.168.10.4,rizhiyi.cluster.os
kafka,kafka,rizhiyi.cluster.kafka
collector,collector,rizhiyi.cluster.collector