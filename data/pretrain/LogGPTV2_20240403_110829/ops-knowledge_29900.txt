User:  How to use iptables for port forwarding and NAT configuration under Linux system?
Assistant: 1. Confirm whether the iptables module is enabled In most Linux systems, the iptables firewall module is enabled by default. You can use the following command to confirm whether the iptables module is enabled: ```bash sudo lsmod | grep ip_tables ``` If the returned result contains "ip_tables", it means the iptables module has been enabled. 2. Port forwarding Use iptables for port forwarding, which can forward a request from a certain port in the network to another port to realize port mapping. For example, forward the request of port 80 in the external network to port 8080 in the internal network. ```bash sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080 ``` Among them, the "-t" parameter specifies to use the nat table, and the "-A" parameter indicates to Add rules at the end of the specified chain (PREROUTING), the "-p" parameter specifies the protocol as TCP, the "--dport" parameter specifies the destination port as 80, the "-j" parameter specifies the forwarding strategy as "REDIRECT", "--to- The port" parameter specifies that the forwarding target port is 8080. 3. NAT Configuration Network Address Translation (NAT) is a technology that converts a private IP address into a public IP address so that the internal network can communicate with the external network. NAT configuration can be performed using iptables to convert private IP addresses to public IP addresses. ```bash sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE ``` Among them, the "-t" parameter specifies to use the nat table, and the "-A" parameter indicates adding rules to the end of the specified chain (POSTROUTING), The "-o" parameter specifies the output interface as eth0, and the "-j" parameter specifies the NAT policy as "MASQUERADE". The above configuration is only temporary and will be invalid after restarting. To take effect permanently, the configuration needs to be written into the iptables configuration file. On most Linux systems, the iptables configuration file location is /etc/iptables/rules.v4. You can directly modify this file and reload the iptables configuration to make it take effect. ```bash sudo nano /etc/iptables/rules.v4 ``` Then write the port forwarding and NAT configuration information into the file. 4. Save the iptables rules To ensure that the iptables rules can take effect automatically after restarting, you can use the following command to save the current iptables rules to a file. ```bash sudo /sbin/iptables-save > /etc/iptables/rules.v4 ``` Taking Ubuntu as an example, we can add the following content to the /etc/network/interfaces file so that each time the network interface starts Automatically load iptables rules. ```bash pre-up iptables-restore < /etc/iptables/rules.v4 ```