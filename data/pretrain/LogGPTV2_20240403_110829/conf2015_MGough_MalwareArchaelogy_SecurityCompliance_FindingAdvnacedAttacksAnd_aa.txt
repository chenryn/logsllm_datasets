Copyright 
  © 
  2015 
  Splunk 
  Inc. 
Finding 
  Advanced 
AFacks 
  and 
  Malware 
With 
  Only 
  6 
  Windows 
EventID’s 
Michael 
  Gough 
Malware 
  Archaeologist, 
MalwareArchaeology.com 
@HackerHurricane 
Disclaimer 
The 
  informaOon 
  in 
  this 
  presentaOon 
  and 
  opinions 
  are 
mine 
  alone 
  and 
  do 
  not 
  reflect 
  those 
  of 
  my 
  current 
  or 
pastof 
  my 
  current 
  or 
past 
  employers. 
2 
Disclaimer 
During 
  the 
  course 
  of 
  this 
  presentaOon, 
  we 
  may 
  make 
  forward 
  looking 
  statements 
  regarding 
  future events 
  or 
  the 
  expected 
  performance 
  of 
  the 
  company. 
  We 
  cauOon 
  you 
  that 
  such 
  statements 
  reflect 
  our current 
  expectaOons 
  and 
  esOmates 
  based 
  onand 
  esOmates 
  based 
  on 
  factors 
  currently 
  known 
  to 
  us 
  and 
  that 
  actual 
  events 
  or results 
  could 
  differ 
  materially. 
  For 
  important 
  factors 
  that 
  may 
  cause 
  actual 
  results 
  to 
  differ 
  from 
  those contained 
  in 
  our 
  forward-­‐looking 
  statements, 
  please 
  review 
  our 
  filings 
  with 
  the 
  SEC. 
  Thewith 
  the 
  SEC. 
  The 
  forward-­‐looking 
  statements 
  made 
  in 
  the 
  this 
  presentaOon 
  are 
  being 
  made 
  as 
  of 
  the 
  Ome 
  and 
  date 
  of 
  its 
  live presentaOon. 
  If 
  reviewed 
  aWer 
  its 
  live 
  presentaOon, 
  this 
  presentaOon 
  may 
  not 
  contain 
  current 
  or accurate 
  informaOon. 
  We 
  do 
  not 
  assume 
  any 
  obligaOonnot 
  assume 
  any 
  obligaOon 
  to 
  update 
  any 
  forward 
  looking 
  statements 
  we may 
  make. 
In 
  addiOon, 
  any 
  informaOon 
  about 
  our 
  roadmap 
  outlines 
  our 
  general 
  product 
  direcOon 
  and 
  is 
  subject 
  to change 
  at 
  any 
  Ome 
  without 
  noOce. 
  It 
  is 
  for 
  informaOonal 
  purposes 
  only 
  and 
  shall 
  not, 
  beonly 
  and 
  shall 
  not, 
  be 
  incorporated into 
  any 
  contract 
  or 
  other 
  commitment. 
  Splunk 
  undertakes 
  no 
  obligaOon 
  either 
  to 
  develop 
  the 
  features or 
  funcOonality 
  described 
  or 
  to 
  include 
  any 
  such 
  feature 
  or 
  funcOonality 
  in 
  a 
  future 
  release. 
3 
Agenda 
 IntroducOon 
Real 
  hacks 
  caught 
  inReal 
  hacks 
  caught 
  in 
  acOon, 
  with 
  logs! 
What 
  can 
  we 
  do 
  with 
  logs? 
–	Take 
  away 
  #1 
The 
  6 
  Event 
  ID’s 
  everyone 
  must 
  monitor 
  and 
  alert 
  on –	Take 
  away 
  #2 
  Enable 
  command 
  line 
  logging 
–	Take 
  away 
  #3 
Sample 
  queries 
–	Take 
  away 
  #4 
Resources 
–	Take 
  away 
  #5 
QuesOons 
4 
IntroducOon 
PersonalQuesOons 
4 
IntroducOon 
Personal 
  IntroducOon 
| 
 | Michael 
  Gough, 
  Malware 
  Archaeology 
Blue 
  Team 
  Ninja, 
  AcOve 
  Defense, 
  Splunk 
  Fu  |  |
|---|---|---||         |Consultant,    Training,    Incident    Response  –Malware    Discovery    Training    Oct    5-­‐6,    AusOn,    TX.    (SecureIdeas) –Malware    Discovery    Training    Oct    14,    Houston,    TX.    (HouSecCon) –Windows    Logging    Training    Oct    16,    Washington    DC.    (BSidesDC)  Blog  –HackerHurricane.com  TwiFer    -­‐    @HackerHurricane  Creator    of    the    “Malware    Management    Framework”  Creator    of    the    “Windows    Logging    Cheat    Sheet”  Co-­‐Creator    of    Log-­‐MD  –Log    harvesOng    tool    for    malware    analysis    &    incident    response  |Consultant,    Training,    Incident    Response  –Malware    Discovery    Training    Oct    5-­‐6,    AusOn,    TX.    (SecureIdeas) –Malware    Discovery    Training    Oct    14,    Houston,    TX.    (HouSecCon) –Windows    Logging    Training    Oct    16,    Washington    DC.    (BSidesDC)  Blog  –HackerHurricane.com  TwiFer    -­‐    @HackerHurricane  Creator    of    the    “Malware    Management    Framework”  Creator    of    the    “Windows    Logging    Cheat    Sheet”  Co-­‐Creator    of    Log-­‐MD  –Log    harvesOng    tool    for    malware    analysis    &    incident    response  |6 
Hackers, 
  Malware 
  and 
  Logs 
 I 
  am 
  a 
  Logoholic 
I 
  love 
  malware, 
  malware 
  discovery, 
  and 
  malware 
  management But 
  once 
  I 
  find 
  an 
  infected 
  system, 
  what 
  happened 
  before 
  I 
  found 
  it? Was 
  there 
  more 
  than 
  one 
  system 
  involved? 
Did 
  the 
  Malwarian 
  do 
  more? 
What 
  behavior 
  did 
  the 
  systembehavior 
  did 
  the 
  system 
  or 
  systems 
  have 
  aWer 
  the iniOal 
  infecOon? 
Logs 
  are 
  the 
  perfect 
  partner 
  to 
  malware! 
Improving 
  Security 
  with 
  Endpoint 
  Data 
 Endpoint 
  data 
  can 
  help 
  catch 
  the 
  hackers 
  as 
  they 
  exploit 
  a 
  system or 
  laterally 
  move 
  around 
  your 
  environment 
Endpoint 
  data 
  can 
  dramaOcEndpoint 
  data 
  can 
  dramaOc 
  improve 
  informaOon 
  security 
  program if 
  enabled 
  and 
  configured 
  of 
  collecOon 
Endpoint 
  data 
  can 
  help 
  detect 
  campaigns 
  like 
  WINNTI 
  or lateral 
  movement 
8 
So 
  What 
  is 
  the 
  Problem We 
  are 
  Trying 
  to 
  Solve? 
9 
1000+ 
  Businesses 
145 
  Million 
 990,000 	4.5 
  Million 
	You’re 
  NextMillion 
	You’re 
  Next 	
97,000 	
395 
  Stores 
?????? 
40+70 
  Million 
~ 
  $758 
  Mil 
3 
  Million 
56 
  Mil 
40 
  Million 
60,000 
  alerts 
105k 
  trans 	
550,000 
76 
  Mil 
  + 
  8 
  Mil 	TBD 
76,000 
25,000 
35,000 	
4.9 
  Million 
650k 
  -­‐ 
  2010 
Ci#group, 
  E*Trade 
  Financial 
  Corp., 
Regions 
  Financial 
  Crop, 
  HSBC 
670,000 
20,000Crop, 
  HSBC 
670,000 
20,000 
33 
  locaOons 	
4.03 
  Million 	1900 
  locaOons 
Holdings 
  and 
  ADP 
So 
  Why 
  Listen 
  to 
  Me? 
| 
 | I 
  have 
  been 
  there 
In 
  the 
  worst 
  way 
Found 
  malware 
  quickly  |  |
|---|---|---||        |Discovered    10    months    before    the    Kaspersky    report  Need    more…    Who,    What,    Where,    When    and    How  Found    logs    were    not    fully    enabled    or    configured    and    couldn’t    get    the    data we    needed  Once    the    logs    from    endpoints    were    enabled    and    configured,    we    saw    all kinds    of    cool    stuff,    it    showed    the    How    that    we    ALL    NEED  –“The    Windows    Logging    Cheat    Sheet”  |Discovered    10    months    before    the    Kaspersky    report  Need    more…    Who,    What,    Where,    When    and    How  Found    logs    were    not    fully    enabled    or    configured    and    couldn’t    get    the    data we    needed  Once    the    logs    from    endpoints    were    enabled    and    configured,    we    saw    all kinds    of    cool    stuff,    it    showed    the    How    that    we    ALL    NEED  –“The    Windows    Logging    Cheat    Sheet”  |Real 
  Hacks 
  Caught 
In 
  AcOon 
Commodity 
  Malware 
  in 
  the 
  Raw 
  Logs 
13 
Catch 
  PowerShell 
  Logging 
  bypass 
14 
You 
  Could 
  Catch 
  CryptoLocker 
• Walk 
  Through 
  of 
  WinNTI 
  – 
  What 
  it 
  Did 
1st 
  Slide 
–	Launch 
  part 
  of 
  the 
  malware(s)
–	Hide 
  malware 
  payload 
  in 
  the 
  Registry
–	Modify 
  an 
  exisOngRegistry
–	Modify 
  an 
  exisOng 
  service 
  to 
  call 
  malware
2nd 
  Slide 
–	Check 
  the 
  service
–	Modify 
  permissions 
  of 
  the 
  malware
–	Push 
  out 
  malware 
  Using 
  CMD 
  Shell 
  and 
  Cscript 
3rd 
  Slide 
–	UpdaOng 
  registry 
  seungs
–	Push 
  out 
  the 
  registry 
  changes
–	Change 
  permissions 
  on 
  changed 
  files
4th 
  Slide 
–	A 
  liFlefiles
4th 
  Slide 
–	A 
  liFle 
  Recon
–	Push 
  malware 
  to 
  terminal 
  services
–	Query 
  the 
  users
5th 
  Slide 
–	Capture 
  THEIR 
  credenOals
16 
1 
  – 
  Malware 
  InfecOon 
	Malware 
  Launch 
Hide 
  malware 
  in 
  Registry 
 Modify 
  Service 
17 
2 
  – 
  Escalate 
  Permission 
  – 