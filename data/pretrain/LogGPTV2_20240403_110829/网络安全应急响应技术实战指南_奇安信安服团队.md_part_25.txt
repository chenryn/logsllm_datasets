219
网络安全应急响应技术实战指南
2．Linux系统排查
Linux 系统日志一般位于/var/log 目录下，几乎保存了系统所有的操作记录，
包括用户认证时产生的日志、系统定期执行任务计划时产生的日志、系统某些守
护进程产生的日志、系统邮件日志、内核信息等。表6.4.10为Webshell应急响应
常见的系统日志。
表6.4.10 Webshell应急响应常见的系统日志
系 统 日 志 描 述
boot.log 记录系统在引导过程中发生的事件，即Linux系统在开机自检过程中显示的信息
messages 记录Linux系统常见的系统和服务错误信息
secure Linux系统安全日志，记录用户和工作组变化情况、用户登录认证情况
lastlog 记录最后一次用户成功登录的时间、登录IP地址等信息
btmp 记录Linux系统登录失败的用户、时间及远程IP地址
wtmp 永久记录每个用户登录、注销及系统启动、停机的事件，使用last查看
maillog 记录系统中运行的邮件服务器的日志信息
bash_history 记录之前使用过的shell命令
3．数据库日志排查
数据库日志同样在Webshell应急响应中较少使用，以下进行简要介绍。
1）MySQL日志
在 Windows 系统中，MySQL 的默认配置路径为 C:\Windows\my.ini、
C:\Windows\mysql\my.ini。在 Linux 系统中，MySQL 的默认配置路径为
/etc/mysql/my.cnf。查看是否开启日志审计，若开启，则将显示日志路径。常规
MySQL日志记录配置见表6.4.11。
6.4.11 常规MySQL日志记录配置
操 作 系 统 配 置 信 息
log-error="E:/PROGRA~1/EASYPH~1.0B1/mysql/logs/error.log"
log="E:/PROGRA~1/EASYPH~1.0B1/mysql/logs/mysql.log"
Windows
long_query_time=2
log-slow-queries= "E:/PROGRA~1/EASYPH~1.0B1/mysql/logs/slowquery.log"
log-error=/usr/local/mysql/log/error.log
log=/usr/local/mysql/log/mysql.log
Linux
long_query_time=2
log-slow-queries= /usr/local/mysql/log/slowquery.log
220
第6章
Webshell网络安全应急响应
MySQL常见的日志记录格式如图6.4.52所示。
图6.4.52 MySQL常见的日志记录格式
查看Webshell当前的用户，若是MySQL，则很可能是通过MySQL漏洞攻击
进来的；若是httpd，则说明可能是通过Web攻击进来的。
2）SQL Server日志
可以直接利用日志文件查看器分析SQL Server日志，如图6.4.53所示。
图6.4.53 分析SQL Server日志
6.4.6 网络流量排查
网络流量排查主要利用现场部署的网络安全设备，通过网络流量排查分析以
下内容：服务器高危行为、Webshell连接行为、数据库危险操作、邮件违规行为、
非法外连行为、异常账户登录行为等，为有效溯源提供强有力的支撑。排查发现
的告警文件help.jsp如图6.4.54所示。
221
网络安全应急响应技术实战指南
图6.4.54 排查发现的告警文件help.jsp
在缺少流量分析设备时，Windows 系统可以借助抓包工具 Wireshark 辅助分
析，具体操作方法可参考2.7节。
需要注意的是，若数据包中带有 z0、eval、base64_decode，则该数据包很可
能是中国菜刀客户端连接一句话木马时产生的，如图6.4.55所示。
图6.4.55 数据包
若数据包中带有特殊的 Referer、Accept-Language，则一般是攻击者利用
Weevely Webshell工具连接产生的，如图6.4.56所示。
222
第6章
Webshell网络安全应急响应
图6.4.56 数据包
如果攻击者在攻击成功后利用 msf 中的 reverse_tcp 上线，那么在 Wireshark
数据包中一般会有PSH标志位，如图6.4.57所示。
图6.4.57 PSH标志位
6.4.7 清除加固
清除加固的方法如下：
（1）处置时先断网，清理发现的Webshell；
（2）如果网站被挂黑链或者被篡改首页，那么应删除篡改内容，同时务必审
计源码，保证源码中不存在恶意添加的内容；
（3）在系统排查后，及时清理系统中隐藏的后门及攻击者操作的内容，若发
223
网络安全应急响应技术实战指南
现存在rootkit类后门，则建议重装系统；
（4）对排查过程中发现的漏洞利用点进行修补，切断攻击路径，必要时可以
做黑盒渗透测试，全面发现应用漏洞；
（5）待上述操作处置完成，重新恢复网站运行。
6.5 典型处置案例
6.5.1 网站后台登录页面被篡改
1．事件背景
在2018年11月29日4时47分，某网站管理员发现网站后台登录页面被篡
改，“中招”服务器为Windows系统，应用采用Java语言开发，所使用的中间件
为Tomcat。
2．事件处置
1）Webshell排查
利用D盾对网站目录进行扫描，发现Webshell痕迹，如图6.5.1所示。
图6.5.1 D盾扫描Webshell
查看对应的文件内容，确认为Webshell，如图6.5.2所示。
通过 D 盾的扫描结果定位 Webshell 文件位于网站 root 根目录
（\root\indexweb4.jsp），文件的创建时间为2018年11月23日5时55分，如图6.5.3
所示。
2）Web日志分析
进一步分析 Web 日志。Web 应用运行在 Tomcat 中间件上，查看 Tomcat 的
配置文件server.xml，发现其中的日志配置项被注释，即未启用日志，因此导致无
224
第6章
Webshell网络安全应急响应
Web日志记录，如图6.5.4所示。
图6.5.2 文件内容
图6.5.3 文件路径及创建时间
图6.5.4 Tomcat的配置文件
225
网络安全应急响应技术实战指南
对系统后台进行人工排查，发现系统对互联网开放，且管理员与其他角色用
户均使用相同弱密码“asd123”。系统显示攻击者在2018年11月29日4时47分
左右通过网站管理后台对登录界面Logo进行了篡改。
同时，经排查发现 Tomcat 中间件使用了弱密码“tomcat”，攻击者可以轻易
登录probe监控系统，如图6.5.5所示。
图6.5.5 弱密码“tomcat”
3）系统排查
查看服务器上的安全软件告警发现存在多次恶意进程执行记录，并请求恶意
域名下载恶意程序。最早在2018年11月23日0时44分，该恶意程序就已在服
务器上运行，如图6.5.6所示。
图6.5.6 查看服务器上的安全软件告警
逆向分析病毒文件，查看此恶意程序攻击行为，可基本确定其对应挖矿木马
特征，可见攻击者不仅篡改网页，同时还植入挖矿程序进行挖矿，如图6.5.7所示。
226
第6章
Webshell网络安全应急响应
图6.5.7 逆向分析病毒文件
4）系统日志分析
通过事件查看器筛选分析安全日志（security.evtx），发现36979条审核记录，
如图6.5.8所示。
图6.5.8 筛选分析安全日志
分析系统登录日志发现，自2018年11月2日起至网页篡改发现时，存在大
量 RDP 远程桌面暴力破解攻击行为与 IPC 暴力破解攻击行为，且存在多个异常
227
网络安全应急响应技术实战指南
RDP远程桌面登录记录，涉及的源IP有125.68.10.14（四川德阳）、104.222.32.79
（美国）、77.77.98.81（伊朗），说明此前已存在攻击者通过暴力破解 RDP 服务登
录到服务器的情况，如图6.5.9所示。
图6.5.9 远程桌面登录记录（部分）
5）问题总结
综上，对发现的线索梳理如下：
（1）服务器于2018年11月23日被上传了Webshell网页木马文件；
（2）Web应用后台存在弱密码；
（3）中间件后台存在弱密码；
（4）服务器未开启Web日志记录功能；
（5）服务器于2018年11月23日就存在挖矿木马的恶意程序；
（6）服务器于2018年11月2日就被RDP暴力破解并被远程登录。
综上分析，由于页面是通过后台 Logo 上传功能进行篡改的，因此推测攻击
者在2018年11月29日通过后台弱密码登录系统并执行了篡改Logo操作。但在
此前系统已经被入侵控制，甚至在2018年11月2日就已经被RDP暴力破解并被
远程登录。由于服务器未开启Web日志记录功能，且存在较多漏洞，因此给溯源
定位带来困难。
3．根除及恢复
（1）暂停相关业务服务，对遗留网页木马（Webshell）和攻击者工具进行移除；
（2）对服务器启用的服务进行安全加固，关闭不用的端口和服务，减小攻击面；
（3）当前启用的服务器因未开启Web访问日志记录给溯源带来一定困难，后
续应开启Web访问日志记录；
228
第6章
Webshell网络安全应急响应
（4）避免使用弱密码，并定期对服务器进行病毒查杀，减小攻击面，提升服
务器的安全防护能力。
6.5.2 Linux系统网站服务器被植入 Webshell
1．事件背景
2018 年 7 月 23 日，某公司网站发现流量监测设备告警，提示存在 Webshell
连接，请求数据包内容如图6.5.10所示。目标URL对应的服务器系统为Linux，
Web应用开发语言为Java。
图6.5.10 请求数据包内容
2．事件处置
1）Webshell排查
通过告警定位到告警文件，查看文件内容，确认为Webshell后门，如图6.5.11
所示。
2）Webshell日志排查
通过日志排查发现最早访问该Webshell的时间为2018年7月23日14时16
分56秒，如图6.5.12所示。
229
网络安全应急响应技术实战指南
图6.5.11 查看文件内容
图6.5.12 日志排查