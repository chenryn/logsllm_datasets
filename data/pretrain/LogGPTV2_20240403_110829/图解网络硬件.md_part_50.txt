即使防火墙丢弃了SYN分组，只要ACK分组能够通过防火墙，
同样能够根据返回的RST分组来判断端口是否打开
发送方
接收方
SYN
ACK
RST
根据RST的窗口尺寸来判断
端口是否打开
05.07.08防范基于分组的攻击
防火墙同样能够防范使用非法分组这类基于分组的DoS攻击和非法人侵。表5-29汇总了防
火墙能够防范的非法分组攻击的主要类型。
---
## Page 296
282|第5章防火墙功能与防范威胁的对策
表5-29基于分组的攻击
攻击类型
内容
IP地址欺骗（IPSpoofing）
为了突破限制访问的防火墙过滤器以及避免被监控日志记录，伪造IP首部中发送源IP地
址的攻击方式。在DoS攻击以及非法入侵中也会使用
碎片分组
碎片的IP分组由于安全性较为脆弱，容易被用于攻击，因此防火墙中通常会设置拦截碎
片分组功能。但如果分组与通信链路MTU大小一致，则不会发生碎片，该功能也不会影
响正常的通信
ICMP碎片
同IP碎片分组类似，防火墙也设置了拦截ICMP分组碎片的功能
巨型ICMP分组
通过设置防火墙拦截一定大小以上的ICMP分组，从而避免PingofDeath攻击
ICMP分组按类控制
根据ICMP首部中的类型以及代码值，对ICMP分组进行区别处理。对于在接收到的消
息中发现消息首部出现了未预定义值或未被支持客户端等情况时，需要进行额外的异常
处理。此时希望通过防火墙对这类非法的ICMP分组予以拦截
SYN以外的TCP分组控制
TCP会话开始前，必会发送SYN分组。如果在尚未确认的TCP会话中收到了除SYN以
外的标志位为1的TCP分组，很有可能就是端口扫描等攻击，这时就需要通过防火墙拦
截该类分组
IPv6多播/单播发送源地址
IPv6尚未完全普及，也可能存在安全漏洞。一般来说，会有目的地址为IPv6多播或单播
地址的通信，但如果出现发送源为该类型地址时，则有可能是经过伪装的分组发起的攻
击。为了防止意外泄露网络中存在使用IPv6主机现象发生时，可以通过防火墙拦截发送
源地址为IPv6单播或多播的分组
05.07.09基于内容的扫描
2004年左右，各个厂商发布了配有多个基于内容扫描功能的UTM防火墙产品。基于内容是
指以应用程序数据作为防火墙的监控对象（文件或命令）。
DIDS/IPS
IDS（IntrusionDetectionSystem）即入侵检测系统，IPS（IntrusionPreventionSystem）即人侵
防御系统，二者合称为IDS/IPS。二者共同的Intrusion是指怀有恶意的用户通过网络或终端进行
的非法人侵行为。
IDS系统负责检测非法入侵并告知系统管理员，而IPS系统则通过设置对非法人侵所使用的
办议以及应用程序进行拦截。
二者还能够对路由器访问控制列表和防火墙无法防范的伪装性正常访问予以阻止。
IDS/IPS能够检测出下列威胁。
·DoS攻击
·P2P造成的信息泄露
·运行蠕虫、特洛伊木马、键盘记录器等恶意软件
---
## Page 297
05.07防火墙中搭载的各种功能|283
·人侵Intranet与入侵侦查行为
另外，当IDS/IPS检测到人侵行为后，会做如下处理。
·通知管理员（通过电子邮件或SNMP等方式）
·记录日志
·拦截通信（向攻击方发送TCPRST消息）
DeepInspection
ScreenOs带有名为ALG的DeepInspection功能。
防火墙的DeepInspection功能能够针对表5-30中列出的应用层协议，重组（assemble）应用
程序数据流中的TCP数据段，检测其中是否包含了非法应用程序参数。
在FTP中，还能够通过允许/拒绝策略来控制GET以及PUT等命令级别的操作。
对于由SIP或H.323这类多协议以及数据流组成的应用程序通信，DeepInspection功能同
样可以识别允许通过的数据流并动态生成防火墙针孔（pinhole），即防火墙上允许数据流通过
的小孔（在安全策略允许的前提下）。以SIP协议为例，IP电话的语音数据通过RTP（Real-time
TransportProtocol）协议的哪个端口号来完成通话终端之间的信息交互，是在SIP会话控制中协
商的。这时防火墙即使没有设置允许RTP使用的端口，但只要设置了允许SIP端口，就会在语
音数据开始传输时自动打开RTP端口供用户使用。
在能够基于应用程序识别的新一代防火墙中都能完成上述的类似处理。
表5-30实施DeepInspection功能的协议清单
DNS
PPTP
APPLEICHAT
FTP
REAL
SIP
H.323
RSH
SQL
HTTP
RTSP
SUNRPC
MGCP
SCCP
TALK
MSRPC
SCTP
TFTP
XING
IDS/IPS以及DeepInspection均能够检测并拦截表5-31所列出的攻击类型。
表5-31
IDS/IPS能够检测的攻击范例
脆弱性攻击类型
说明
信息泄露
攻击者利用带有恶意脚本的邮件或附带恶意软件的URL地址发起的攻击。攻击成功的话，能
够获取受攻击方的机密信息
---
## Page 298
284|第5章防火墙功能与防范威胁的对策
（续）
脆弱性攻击类型
说明
执行代码
向服务器发送非法数据，使得被攻击的服务器接受并执行位于远程地理位置的代码
DoS攻击
通过发送大量分组使被攻击服务器CPU、内存负担上升，妨碍服务器（或程序）正常提供服务
的攻击
缓存溢出
通过恶意程序诱导被攻击服务器运行内存超过上限，导致缓存溢出的攻击
(Buffer Overflow）
SQL注入
针对Web应用程序，使用数据库SQL语言对数据库进行非法操作的攻击
暴力破解
也称为循环攻击，使用密码字典等工具反复尝试管理员口令的攻击手法。为了防止该类攻击，
(BruteForceAttack)
需要执行类似于口令3次输错则切断会话的策略
跨站脚本攻击
简称为CSS或XSS。利用Web应用程序的脆弱性，在提交页面表单时，通过服务器执行携带
(Cross-site Scripting )
HTML标签的脚本，从而达到劫持会话或钓鱼的目的
exploit攻击
利用软件脆弱性发起的攻击中使用的程序或脚本
浏览器劫持
通过操纵携带恶意软件的浏览器，在用户浏览Web页面时篡改显示的页面形式和内容。一般
会导致持续弹出广告栏、自动添加URL连接以及跳转其他网页失败的情况
钓鱼
使用携带伪造官方网站站点URL链接的邮件或网站，骗取用户的个人信用卡以及银行账户信息
僵尸网络
通过僵户程序感染多台个人计算机，并根据攻击方命令同时发送垃圾邮件和实施DoS等攻击。
主要通过使用IRC（InternetRelayChat）对僵户下达进攻命令
·CVE
CVE（CommonVulnerabilitiesandExposures，通用脆弱性标识）是由美国政府支持的非盈利
机构MITRE公司采用的识别标识。该机构会为软件以及设备产品发现的安全脆弱性问题分配一
个CVE识别编号（CVE-ID），当安全厂商提供多个脆弱性防范对策时，通过使用该标识告知用
户某对策针对的是哪个安全脆弱性问题。CVE标识编号如表5-32所示，以“CVE-（公元纪年）-
（4字符编号）”的格式记录，表明使用该编号的安全脆弱性问题已广为人知。
表5-32CVE识别编号范例
CVE识别编号
内容
CVE-2006-0900
FreeBSDnfsdNFSMountRequestDenialofService
CVE-2007-2881
SunJavaWebProxyServerBufferOverflowVulnerability
CVE-2009-1923
MicrosoftWindowsWINSServiceHeapOverflowVulnerability
反病毒
反病毒也称为防病毒对策，通过在个人计算机和服务器上安装防病毒软件来保护计算机免
遭病毒侵袭。
---
## Page 299
05.07防火墙中搭载的各种功能|285
在终端安装防病毒软件的方式称为主机型防病毒。
而通过设置位于互联网网关的防火墙以及专用设备，对网络上所有传输的通信数据进行扫描
的方式则称为“网关型防病毒”。使用网关型防病毒，能有效防正Intranet中病毒的蔓延以及作为
跳板攻击网络的发生。
确认是否存在病毒的处理操作称为扫描（scan）或病毒扫描。主机型防病毒的扫描在计算机
内进行，而网关型防病毒的扫描在通信流量中完成。二者的比较结果如表5-33和表5-44所示。
表5-33）网关型防病毒的优点与主机型防病毒的缺点
网关型防病毒的优点
主机型防病毒的缺点
能够对所有客户端实施相同的策略
客户机PC以及虚拟PC无法采用相同的安全策略
针对客户机PC以及虚拟PC的对策
不依赖客户端的操作系统
很难应用于停止支持或不支持的操作系统
即使操作系统停止支持，也不影响扫描的进行
节省了为客户端安装软件以及升级软件的麻烦
所有的客户端都需要安装软件，耗费精力
用户无法主观停止扫描过程
用户可以主观停止扫描或升级
能够防止来自内部客户端的病毒
虽然能够扫描外部流入数据，但对于已经感染的文件通信
则无法检测
能够通过网关设备对日志、报告等实施统一化管理
日志等保存在各台PC上，统一化管理需要其他系统支持
表5-34
主机型防病毒的优点与网关型防病毒的缺点
主机型防病毒的优点
网关型防病毒的缺点
不依赖于具体的通信协议
不支持所有的通信协议
→PaloAuto公司产品支持FTP、HTTP、IMAP、POP3
SMB、STMP协议的解码
→其他厂商仅支持FTP、HTTP以及电子邮件协议
能够对所有接收的文件进行扫描
无法对所有文件进行扫描
→例如附带密码的压缩文件等
能够对具体安装的操作系统进行定制扫描
防病毒软件扫描通过防毒引擎（engine）程序完成，防毒引擎使用名为“特征签名”（signature）
或“病毒定义文件”的数据库，判断在扫描对象中是否存在已经被注册过的病毒等。表5-35列
出了防毒软件所能检测的病毒（恶意软件）类型。
表5-35防毒软件能够检测的恶意软件类型
恶意软件
说明
病毒（计算机病毒）
通过Web站点以及电子邮件附件等入侵计算机系统，趁用户未察觉之际，修改计算机运
行方式的程序。病毒入侵计算机称为“感染”，会造成显示画面异常以及磁盘文件损坏等
现象。病毒程序能够自我运行，自我复制（繁殖）
---
## Page 300
286|第5章防火墙功能与防范威胁的对策
（续）
恶意软件
说明
蠕虫
反复自我繁殖并破坏数据的程序。病毒只感染程序文件，而蠕虫则能够存在于Word
Excel文档的内部，并能通过发送附带感染文档的电子邮件来进行繁殖
特洛伊木马
伪装成合法文档的破坏程序。利用互联网上可免费下载的共享软件诱导用户下载带有木
马的应用程序。同病毒不同的是，木马程序自身不会繁殖。如果运行了含有木马的恶意
程序，则会造成数据损失或被盗用的严重后果
间课软件
指将用户个人计算机内部信息以及Web浏览器访问的历史记录在没有得到用户许可的前
提下，擅自向第三方发送的程序。通过间谍软件盗取的用户信息，可能会用于在线广告
以及调查统计等领域
广告软件
在用户画面中强制弹出广告的程序。英文为adware，ad表示广告（advertisement）。有
时仅仅是普通的广告，有时则是可以使用的免费软件
恶意软件
病毒、蠕虫、特洛伊木马、间谍软件、广告软件这类带有“恶意”的程序（软件）总称。
英语为malware，mal前缀表示怀有恶意的意思。软件以及硬件如果带有“恶意软件防
范”的宣传字样则表示能够防范恶意软件带来的损害。也可以称为不良软件（badware）
犯罪软件
以犯罪为目的编写并使用的软件
键盘记录软件
用于记录键盘输入内容的软件。原本该类软件在Telnet等用于确认发送命令，但后来也
被用于盗取用户信用卡账号、密码等不良用途。一般隐蔽安装在网吧等不特定多人使用
的计算机中记录信息并生成报告
屏幕记录软件
一定时间间隔内，定期捕获屏幕画面（screenshot）的软件。该类软件还会将捕获的画面
以电子邮件的形式发送，常用于盗取网络银行密码等
后门软件（rootkit）
入侵服务器等系统的破解者在实施恶意操作时使用的工具的集合。对于恶意软件不时针
对“安全漏洞”发起的进攻，希望用户能够及时安装最新补丁来予以避免
·基于文件和基于数据流的网关型防病毒
网关型防病毒可以分为两类，一类是基于文件（代理）型，另一类是基于数据流型（flow）。
基于文件型会将作为扫描对象的文件数据存在缓存中，等待扫描对象全部传输完毕才会自动
开启扫描。
基于数据流型是新型防病毒方式，无需等待文件整体接收完毕，而是接收到文件开头部分的
分组时便能立刻开启扫描。扫描结束后转发文件时，也同样无需等待文件整体扫描结束，而是直
接将完成扫描的分组直接转发即可。该类型同基于文件型扫描相比，等待时间大幅缩短，实现的
延迟很低（图5-31）。
---
## Page 301
05.07防火墙中搭载的各种功能|287
图5-31基于数据流型同基于文件型的延迟比较
接收有效载荷
扫描有效载荷
发送有效载荷
延迟
基于数据流型
接收有效载荷
扫描有效载荷
发送有效载荷
延迟
基于文件型
表5-36）基于数据流型的优点与基于文件型的缺点
基于数据流型的优点
基于文件型的缺点
·能够进行高速扫描
·扫描耗费时间
高吞吐率、低延迟
·低吞吐率、高延迟
·扫描能够不受文件大小限制