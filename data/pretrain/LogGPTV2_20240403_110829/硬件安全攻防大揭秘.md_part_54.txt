MR21619A)
的工立连男者无线位用壳说计,
P ( F 70r
12 个量8 DMA IO事5
全速 USB 促量cB人式生机
12 C ADC
2H8A0PA9 2:41
AES 129 性0浆
·是星生 (40 至 +125 )
图9-142Atmel SAM R21系列单片机的性能特点
除了这些集成USB接口的芯片，还有很多芯片可供选择，例如FSL的MKW01Z128芯
片，如图9-143所示，虽然没有USB接口，但作为Sub-1G单片机，性能远超CC1110。
Core
Systen
Sub-1 GHz Tt
M0
DMA
126K8Panh
Intem
16KFAM
PHL
(AES)
Tmers
Clodks
2xC
3x UART
Lososer
tx SP1
GPIDS
Fouoh
图9-143NXP MKW01Z128功能框图
类似的还有图9-144所示的TICC1310，以及如图9-145所示的TICC2630，它们的性能
都很强，只是缺少USB接口。
442
---
## Page 455
第9章打造专属硬件工具
损述
特性
图9-144TI CC1310介绍
图9-145T1 CC2650个绍
RFCat 基于TI CC1111单片机，用的是 8051内核，性能不强。MouseJack 基于 Nordic
nRF24LU1，用的也是8051内核，同样不强，但效用高。
用这些芯片方案做出来的大黄鸭，硬件层面没得说。如果不会设计，官方都有Demo板
和参考设计，照着做就行。如果想偷懒，直接用官方的USB Dongle 也可以，例如 CC2531芯
片方案的ZigBeeDongle，如图9-146所示，最多就是以飞线或者扩展板形式接TF卡面已。
CC2531 USB Dongke
图9-146 CC2531 ZigBee Dongle
443
---
## Page 456
9.5.3设计方法及FAE的重要性
从零开始完全自主设计一个硬件工具可能有点难度，但如果有参照电路在手就没那么困
难了。射频部分可以参照官方电路，其他地方正常走线即可。
以TICC2538为例，官方提供了CC2538EM开发板的参考设计，如图9-147所示，也就
是Demo板，官方地址htp:/www.ti.com.cn/tool/cn/cc2538em-rd。打开后可以看到官方提供了
所有的设计文件（如图9-148所示）、原理图（如图9-149所示）、设计指南、Gerber
（如图9-150所示）、BOM等，不想买官方的板子自己打样也完全没有问题。
图9-147TICC2538EM开发板
原理图/方柜
设计指南
设计文件
16888
18869
物科清单（BOM）
6 OM
图9-148TICC2538EM的设计资料
444
---
## Page 457
图9-149T1CC2538EM的原理图
图9-150TI CC2538EM的Gerber
基本所有芯片厂商都会提供Demo板用于测试芯片，而这些Demo板也基本都会开放设
计资料（当然，有的方案的设计资料是保密的，需要签署NDA或者只对大客户开放），用户
445
---
## Page 458
硬件安全攻防大揭税
可以依据这些Demo 板做出自己的设计。如果遇到问题，就该原厂或者代理商的FAE出马了，
FAE会远程或者直接到现场进行分析解决问题。
所以，前面讲方案选型时一再提到技术支持，在没有遇到技术问题时，技术支持无所谓，
但一旦遇到问题，凭借个人力量往往很难解决，或者需要花费大量的时间精力，面原厂FAE
因为能拿到芯片的底层资料或者文档，面且经验丰富，支持那么多客户，在见识上面远超用
户，大多数问题都能很快解决。
如果你是潜力巨大的客户，甚至有时原厂FAE会直接依据你的需求帮你设计方案，他们
的方案不一定是成本最低的，但性能和可靠性基本是最优的，作者就曾体验过TI的FAE帮
忙设计的方案，他在电源方面的造谐是国内排得上号的专家，真的是一流的方案。
很多电子专业的学生毕业后选择进入芯片公司做FAE，这个行业的，门楼非常高，技术
方面、沟通方面不给力的都没资格进入、即使进去了，一开始世是参加各种培训，然后给经
股丰富的FAE打杂，全国各地出差到处题，给客户假支持，非常予否。在这里作者建议读者，
如果自己所在公司需要FAE支持时，还是以平和的心态和FAE讨论交流，真正能帮得上忙的
都是这些一线的FAE，和他们打好交道总没错。
9.5.4难点和重点
具体的硬件设计，这里不做详细讲述。
硬件设计是一种方法，不是模仿学，掌握了方法后要多练。
大黄鸭的真正价值在于软件，在于USBHID协议的理解与使用，这就需要代码功底了，也
就是单片机编程能力。哪怡Arduino一类的编程很熟练，真正到底层的单片机平台时就傻眼了。
单片机开发说难好像很难，说简单其实也很简单。首先要理解硬件，知道时钟、寄存器、
总线这些配置方法，能够看得懂DataShcet，再学单片机开发软件，那些IDE都大同小异，特
别是到了ARM级别的单片机，基本上Keil和IAR两分天下，其他的 GCC都是小众，开发语
言通常都是C和C++，有这两门编程语言功底的人，再经过简单易用的硬件“Arduino”的重
陶，有硬件概念之后，再看纯粹的单片机教程，比如51、AVR、STM32，学起来应该很快，
也不会有太多难点。
自学单片机最主要的就是多练，自己给白已立项，比如做个单片机小车、小船或者小四
轴，硬件可以在网上找原理图自己设计，在网上买现成的开发板或者Demo板也可以。参考
别人的代码例程时，别看一行抄一行，这样很难有进步。正常情况下，一两个月最多半年，
学会两到三种单片机的用法没问题，之后基本就可以举一反三，学会了方法，基本哪种单片
机章过来都能很快上手。
446
---
## Page 459
第9章打造专属硬件工具
安全研究人员掌握了硬件设计单片机开发的能力，就诞生了HackRF、ProXmark3
Ubertooth One、RFCat 这些经典的硬件安全研究工具。
起加油吧！也许，你就是下个MichaelOssmann
9.6超级大菠萝
便携硬件，包含Wi-Fi模块，可以用它便捷地进行Wi-Fi安全评估。
9.6.1方案规划
先想想“菠萝”可以改进的地方。我们的需求是：制作一个安全人员能够用来给企业进
行W-F安全评估和安全审计的便携式集成化工其，
（1）“菠萝”的基础系统是OpenWrt，局限性大。
（2）“菠萝”还得外部供电，要挂个移动电源，很麻烦。
（3）“菠萝”外观太显眼，虽然新的体积小了很多，但还是很卷眼。
（4）“菠萝”的交互设计做得太差，用户体验不好。
那么我们怎么做呢？
（1）Linux系统，比如Kali，内部集成了各种安全工具，使用非常方便！
（2）内置聚合物锂电池，顺便还能当移动电源用。
（3）伪装成铅笔盒、移动电源或者3G路由，至少一眼看过去不显眼。
（4）来个OLED液品屏。或者通过蓝牙和手机交互。
当然，如果读者有更多的奇思妙想，可以补充。
9.6.2实施方案
规划完成后，就要开始实施了。
首先，我们运行Linux，可以考虑的芯片方案挺多的，比如TIAM335x、全志A20、FSL
i.MX6都可以，或者三星的 S3C6410、S3C2440、S5PV210等。
这些芯片方案都有现成的核心板可以用，根据自己的喜好选用就行，比如TI的AM335x
447
---
## Page 460
硬件安全政防大揭税
方案，兼容 BeagleBone，系统兼容性好，稳定性也很棒。运行Ubuntu、Debian、Arch、Kali、
Fedora等系统都可以，遇到未知问题的概率很小。
作者在网上随便选了一家公司的核心板（如图9-151所示），以及配底板的开发板（如
图9-152和图9-153所示），可以按需求购买作为Demo板测试使用，按照卖家提供的资料比
如“COM335X底板设计指导”（如图9-154所示）微基本没问题。用核心板的优势就是资
料齐全。
图9-151AM335x的核心板
图9-152使用AM335x核心板的Demo开发板（1]
图9-153使用AM335x核心板的Demo开发板（2）
图9-154COM335X底板设计指导
448
---
## Page 461
第9章打造专属硬件工具
电源供电可以采用和小米移动电源同方案的T1BQ24195芯片方案，如图9-155和图9-156所
图9-155小米移动电源PCB
图9-156TIBQ24195方案
在TI官方的BQ24195DataSheet（如图9-157所示）中可以看到，这颗电池管理芯片性能
参数很不错，可以大电流充电，最大到4.5A，自带最大2.1A升压，对于移动电源来说基本够
用，驱动AM335x绰绰有余。官方提供Demo板（如图9-158所示），Demo板的原理图也都
开放（如图9-159所示），照着原理图画即可。
TESETS
在电波为1A/2.1A时分期具存5.1V同步后压运行由
入
WAELR
XHAH usR26 * ua0
eneee
图9-157T1 BQ24195 DataSheet
449
---
## Page 462
硬件安全欢大揭秘
BQ2419X评估模块
mrbe lefiz
特性
图9-158TIBQ2419XEVM的开发板
图9-159T1BQ2419XEVM开发板原理图
当然，也可以使用BQ24195方案相近的TIBQ2409x芯片方案，电池管理芯片的自由度
很高，读者可以自行评估选择。
电池可以不用18650电芯，太沉了面且外观受限。如果电池要接线的话需要用点焊机，
用聚合物锂电池比较合适，多种体积外观可选，定制性高。
450
---
## Page 463
第9章打造专属硬件工具
小贴士：电池不能加热，很容易爆炸！普通的5号、7号电池或者18650
电池，如果要焊线请找商家使用电池点焊机！不能用烙铁自行焊接，如果焊功
不到位，加热时间稍长，电池就会爆炸！这里给个小诀窍，在网上有小体积不
同规格的物扶硼磁铁，如图9-160所示，在格铁头上多上一些焊锡，然后将导
线焊接在磁铁侧面，注意，只能有一两秒的接触时间，不然会导致磁铁消磁！
将导线焊接到磁铁上之后，可以将磁铁吸附到电池的正极或者负极，效果和电
池上直接焊线差不多
29, 5mX/,2
¥0.14
0.14
 0.14
图9-160不同规格的锁铁棚磁铁
在网上有很多OLED，PC接口或者SPI接口都可以，0.96寸大小合适，如图9-161所示。
蓝牙用TICC2540、T1CC2640或者其他的CSR串口蓝牙都没问题，这些模块用起来都很简
单，卖家都提供了丰富的例程和参考电路设计，照着做就可以。
图9-161OLED模块
451
---
## Page 464
使件安全攻防大揭
无线网卡、3G/4G模块、NFC都是同样的原理，直接找模块即可。如果觉得USB口不够，
加个 SMSC USB2514B的 4 口Hub 芯片，原理图网上有很多，作者设计的一个原理图如图9-164
所示。
图9-162SMSC USB2514B 4OUSB Hub原理图
最后将这些组合到一起，再用3D打印机打一个外壳，或者从网上买一个移动电源外壳，
就成了一个隐蔽性很高的“黑武器”。
至于软件部分，可以参照FruityWi-Fi无线安全套件。当然，对安全研究人员来说，这些
都是小菜一碟，自己DIY的系统远比这个更豪华。
9.6.3小结
出于安全考虑，具体的原理图设计和PCB设计不做详细讲述，更多是传达设计思路和想
法，真正的操作各位读者发挥自己的动手能力，难度不大。例如，图9-163所示的“移动电
源”，就是用前面讲的方案做出来的，效果就像是一个小米移动电源。表面看起来是一个小
米移动电源，其实内部藏了一块嵌入式Linux电路板，当手机插上这个“移动电源”的USB
口，你的数据就可能被窃走，这就是曾经很出名的“黑寡妇”移动电源。除了用AM335X方
案，还可以用AR9331方案，运行的OpenWrt 也是一个间割版的Linux，模块体积更小还带有
Wi-Fi，这些都是可以轻松做到的。
452
---
## Page 465
美0室打造专属硬件工具
安全建议：不要随意用别人提供的移动电源和充电宝，也别随意用机场、车站的充电桩，
一不小心，你的数据就被复制走了。当然，你可以自己做一个SecUSB，如图9-164所示。原
理很简单，就是直接短接D+和D-，屏蔽数据连接，原理图和PCB图如图9-165和图9-166
所示。
图9-164SecUSB
图9-165SecUSB的原理图
图9-166SecUSB PCB图
最后，当DIY成功以后，如果想产品化，再依据实施方案去模块化，将整个板子整合到
一起，搭配特定的固件代码、包装，就是一个Geek产品了！
记住，法不容情！请做合法公民，别做违法的事情！