2. 
WMI 内 部 包 含 了 很 多 专 门 用 于 调 试 的 类 ， 包 括 用 于 对 各 种 操 作 计 数 的
Msft_WmiProvider_Counters 类，专门用于产生调试事件的 MSFT_WmiSelfEvent 类和
它的数十个派生类。 
3. 
尽管 WMI 自身的基础模块和类很多，而且微软的文档中没有介绍这些内部类，但是
借助调试符号，我们还是可以比较容易的理解出每个类的作用，各个类之间的关系等。
从函数和属性的名称也基本可以推测出它的含义，从而可以设置断点或跟踪执行。这
为追踪某些复杂的 WMI 问题提供了条件。 
下面我们对 1 和 2 两点进行详细介绍。 
31.6.1  WMI 日志文件 
默认情况下，WMI 的日志文件被保存在%windir%\system32\wbem\logs 目录下。因为
不同功能的 WMI 模块会使用不同的的日志文件，所以在以上目录中，通常可以看到十几
个文件，表 31-10 列出了这些文件的名称和用途。 
表 31-10  WMI 日志文件的名称和简要介绍 
文件名 
描述 
Dsprovider.log 
Trace information and error messages for the Directory Services Provider. 
Framework.log 
Trace information and error messages for the provider framework and the 
Win32 Provider. 
Mofcomp.log 
Compilation details from the MOF compiler. 
Ntevt.log 
Trace messages from the Event Log Provider.  
Setup.log 
Report on those MOF files that failed to load during the setup process. 
However, the error that caused the failure is not reported. You must review the 
Mofcomp.log file to determine the reason for the failure. After the error has 
been corrected, you can recompile the MOF file (using mofcomp) with the 
-autorecover switch. 
Viewprovider.log 
Trace information from the View Provider. This provider requires that you set 
a bit value for the following registry key.  
HKEY_LOCAL_MACHINE \SOFTWARE\Microsoft\WBEM\ 
     PROVIDERS\Logging\ViewProvider\Level 
Wbemcore.log 
Wide spectrum of trace messages. 
Wbemess.log 
Log entries related to events. 
Wbemprox.log 
Trace information for the WMI proxy server. 
《软件调试》补编 
- 105 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
Winmgmt.log 
Trace information that is typically not used for diagnostics. 
Wmiadap.log 
Error messages related to the AutoDiscoveryAutoPurge (ADAP) process. 
Wmiprov.log 
Management data and events from WMI-enabled Windows Driver Model 
(WDM) drivers. 
WMI 的日志功能是可以配置的，WMI 核心模块的日志选项保存在如下注册表表键下： 
HKEY_LOCAL_MACHINE \SOFTWARE\Microsoft\WBEM\CIMOM\ 
可以配置的选项如表 31-11 所示。 
表 31-11  WMI 核心模块的日志选项 
键值名称 
类型 
功能和默认值 
Logging 
REG_SZ 
记录级别，可以为 0（不记录），1（仅记录错误），2（详
细记录）三个级别。默认为 2。 
Logging Directory 
REG_SZ 
日志文件路径，默认为%windir%\system32\wbem\logs。 
Log File Max Size 
REG_SZ 
日志文件最大长度（字节数），默认为 65536 字节。 
各个 WMI 提供器的日志选项保存在 PROVIDERS\Logging 子键下的以提供器名称命
名的表键下，比如 NTEVT 提供器的日志配置选项存储在如下位置： 
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WBEM\PROVIDERS\Logging\NTEVT 
对于提供器，可以设置表 31-12 所列出的 4 种选项。 
表 31-12  WMI 提供器的配置选项 
键值名称 
类型 
功能 
File 
REG_SZ 
日 志 文 件 的 完 整 路 径 和 文 件 名 。 比 如
C:\WINDOWS\system32\WBEM\Logs\\NTEVT.log 
Level 
REG_DWORD 
用来定义调试信息输出的 32 位的掩码（bit mask），与
提供器的实现有关。 
MaxFileSize 
REG_DWORD 
日志文件最大长度（字节数），默认为 65536 字节。 
Type 
REG_SZ 
日志输出的类型，可以设为“File”（写到文件）和
“Debugger”（输出到调试器）两种。 
31.6.2  WMI 的计数器类 
WMI 内部专门设计了一些类用来收集状态和调试信息，我们先来看一下用于对各种
操作计数的 Msft_WmiProvider_Counters 类 
Msft_WmiProvider_Counters 类的作用是对各种常见的函数调用进行计数。这个类没有
方法，只有 24 个属性，全都是 64 位的无符号整数（uint64），用作计数器（Counter）。表
31-13 列出了这些属性的名称和它们各自要记录的操作（函数调用）。 
表 31-13  WMI 的计数器（Msft_WmiProvider_Counters 类的成员） 
属性 
记录的调用 
ProviderOperation_AccessCheck 
IWbemEventProviderSecurity::AccessCheck 
ProviderOperation_CancelQuery 
IWbemEventProviderQuerySink::CancelQuery 
ProviderOperation_CreateClassEnumAsync 
IWbemServices::CreateClassEnumAsync 
ProviderOperation_CreateInstanceEnumAsync 
IWbemServices::CreateInstanceEnumAsync 
ProviderOperation_CreateRefreshableEnum 
IWbemHiPerfProvider::CreateRefreshableEnum 
ProviderOperation_CreateRefreshableObject 
IWbemHiPerfProvider::CreateRefreshableObject 
ProviderOperation_CreateRefresher 
IWbemHiPerfProvider::CreateRefresher 
ProviderOperation_DeleteClassAsync 
IWbemServices::DeleteClassAsync 
ProviderOperation_DeleteInstanceAsync 
IWbemServices::DeleteInstanceAsync 
ProviderOperation_ExecMethodAsync 
IWbemServices::ExecMethodAsync 
《软件调试》补编 
- 106 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
属性 
记录的调用 
ProviderOperation_ExecQueryAsync 
IWbemServices::ExecQueryAsync 
ProviderOperation_FindConsumer 
IWbemEventConsumerProvider::FindConsumer 
ProviderOperation_GetObjectAsync 
IWbemServices::GetObjectAsync 
ProviderOperation_GetObjects 
IWbemHiPerfProvider::GetObjects 
ProviderOperation_GetProperty 
IWbemPropertyProvider::GetProperty 
ProviderOperation_NewQuery 
IWbemEventProviderQuerySink::NewQuery 
ProviderOperation_ProvideEvents 
IWbemEventProvider::ProvideEvents 
ProviderOperation_PutClassAsync 
TIWbemServices::PutClassAsync 
ProviderOperation_PutInstanceAsync 
IWbemServices::PutInstanceAsync 
ProviderOperation_PutProperty 
IWbemPropertyProvider::PutProperty 
ProviderOperation_QueryInstances 
IWbemHiPerfProvider::QueryInstances 
ProviderOperation_SetRegistrationObject 
未实现 
ProviderOperation_StopRefreshing 
TIWbemHiPerfProvider::StopRefreshing 
ProviderOperation_ValidateSubscription 
IWbemEventProviderSecurity::AccessCheck 
WMI 已经为 Msft_WmiProvider_Counters 类定义了一个实例，位于\root\CIMV2 命名
空间中，因此只要使用清单 31-15 所示的 VBScript 就可以得到各个计数器的值了。 
清单 31-15 列出所有 WMI 计数器值的脚本 
strComputer = "."  
Set objWMIService = GetObject("winmgmts:\\" & strComputer & "\root\CIMV2")  
Set colItems = objWMIService.ExecQuery( _ 
    "SELECT * FROM Msft_WmiProvider_Counters",,48)  
For Each objItem in colItems  
    Wscript.Echo "-----------------------------------" 
    Wscript.Echo "Msft_WmiProvider_Counters instance" 
    Wscript.Echo "-----------------------------------" 
Wscript.Echo "ProviderOperation_AccessCheck: " & 
objItem.ProviderOperation_AccessCheck 
‘ 排版时省略多行，完整脚本位于 chap31\script\counters.vbs 
Next 
31.6.3  WMI 的故障诊断类 
WMI 定义了很多用于汇报重要 WMI 事件的事件类，供调试和故障诊断使用。这些类
被统称为故障诊断类（troubleshooting class），它们都派生自一个共同的基类——
MSFT_WmiSelfEvent 类。根据事件来源，这些类被划分为三个组，分别被称为 WMI 服务
事件诊断类、提供器事件诊断类和事件消耗器提供器诊断类。 
WMI 服务事件诊断类
服务事件诊断类
服务事件诊断类
服务事件诊断类 
WMI 服务事件诊断类用于报告 WMI 内部服务模块中的发生的重要事件，比如创建线
程池（MSFT_WmiThreadPoolCreated）、激活和解除事件过滤器（MSFT_WmiFilterActivated
和
MSFT_WmiFilterDeactivated
） 、
订
阅
事
件
和
取
消
订
阅
（MSFT_WmiRegisterNotificationEvent 和 MSFT_WmiCancelNotificationSink）等等。所有
服务事件诊断类都派生自 MSFT_WmiEssEvent 类，ESS 的含义是事件子系统（Event 
Sub-system）。因此可以通过订阅 MSFT_WmiEssEvent 类来接受所有服务诊断类事件。 
提供器事件诊断类
提供器事件诊断类
提供器事件诊断类
提供器事件诊断类 
WMI 调试的最常见任务就是调试 WMI 提供器，很多 WMI 故障都与某个（些）提供
器有关。因此 WMI 内建了 30 几个事件类来报告各种与提供器有关的操作，包括安全检查、
《软件调试》补编 
- 107 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
执行和取消查询、加载 COM 服务器、存取对象等等。而且对于大多数操作，都设计了两
个事件类，分别报告该操作执行前和执行后的状态，如对于取消查询操作，就有两个事件
类，MSFT_WmiProvider_CancelQuery_Pre 和 MSFT_WmiProvider_CancelQuery_Post。前
者会在提供器的 IWbemEventProviderQuerySink::CancelQuery 被调用前报告，后者在提供
器的方法被执行后报告。 
因为篇幅有限，我们无法一一介绍每个提供器事件类，大家在使用时可以参阅 SDK
文档。喯届下面我们通过一个试验来介绍 MSFT_WmiProvider_LoadOperationFailure- Event
类。 
MSFT_WmiProvider_LoadOperationFailureEvent 类定义了激活或初始化提供器失败事
件。我们可以使用清单 31-16 所示的脚本订阅并监听此事件。 
清单 31-16 订阅并监听此加载提供器失败事件（LoadFailure.vbs） 
strComputer = "."  
Set objWMIService = GetObject("winmgmts:\\" & strComputer & "\root\CIMV2")  
Set objEvents = objWMIService.ExecNotificationQuery _ 
("SELECT * FROM Msft_WmiProvider_LoadOperationFailureEvent") 
Wscript.Echo "Waiting for events ..." 
Do While(True) 
    Set objReceivedEvent = objEvents.NextEvent 
    'report an event 
    Wscript.Echo "-----------------------------------------------------------" 
    Wscript.Echo "Msft_WmiProvider_LoadOperationFailureEvent event has occurred." 
    Wscript.Echo "ServerName: " & objReceivedEvent.ServerName  
    Wscript.Echo "InProcServer: " & objReceivedEvent.InProcServer 
    Wscript.Echo "InProcServerPath: " & objReceivedEvent.InProcServerPath 
    Wscript.Echo "ThreadingModel: " & objReceivedEvent.ThreadingModel 
《软件调试》补编 
- 108 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
    Wscript.Echo "ResultCode: " & objReceivedEvent.ResultCode 