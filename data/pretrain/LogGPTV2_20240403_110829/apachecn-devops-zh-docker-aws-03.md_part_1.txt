# 三、AWS 入门
在前一章中，我们讨论了将容器应用部署到 AWS 的各种选项，现在是开始使用弹性容器服务(ECS)、Fargate、Elastic Kubernetes 服务(EKS)、Elastic Beanstalk 和 Docker Swarm 实现实用解决方案的时候了。在我们涵盖所有这些令人兴奋的材料之前，您需要建立一个 AWS 帐户，了解如何为您的帐户设置访问权限，并确保您牢固掌握我们将在本书中用于与 AWS 交互的各种工具。
开始使用 AWS 非常容易—AWS 提供了一套免费的服务，使您能够在 12 个月内免费测试和试用许多 AWS 服务，或者在某些情况下无限期试用。当然，有一些限制会确保您不能免费设置自己的比特币挖掘服务，但在大多数情况下，您可以利用这些免费的分层服务来测试大量场景，包括我们将在本书中研究的几乎所有材料。因此，这一章将从建立一个新的 AWS 账户开始，这将要求你有一个有效的信用卡，以防你真的完成了这个伟大的新比特币采矿项目。
一旦您有了一个帐户，下一步就是设置对您的帐户的管理访问。默认情况下，所有 AWS 帐户都是使用具有最高级别帐户权限的根用户创建的，但是 AWS 不建议将根帐户用于日常管理用途。因此，我们将配置 AWS 身份访问和管理(IAM)服务，创建 IAM 用户和组，并学习如何使用多因素认证(MFA)实现增强的安全性。
建立对您的 AWS 帐户的访问后，我们将重点关注您可以用来与 AWS 交互的各种工具，包括提供基于网络的管理界面的 AWS 控制台，您可以通过网络浏览器访问该控制台，以及用于通过命令行与 AWS 交互的 AWS 命令行界面工具。
最后，我们将介绍一个名为 AWS CloudFormation 的管理服务和工具集，它提供了一个基础架构作为定义您的 AWS 基础架构和服务的代码方法。CloudFormation 允许您定义模板，使您能够通过单击一个按钮来构建完整的环境，并以可重复和一致的方式来这样做。我们将在本书中广泛使用云信息，因为在实践中，大多数部署基于 Docker 的应用的组织都采用基础架构作为代码工具，如云信息、Ansible 或 Terraform，以自动部署他们的 Docker 应用和支持基础架构。您将学习如何创建一个简单的云信息模板，然后使用 AWS 控制台和 AWS 命令行界面部署该模板。
本章将涵盖以下主题:
*   设置 AWS 帐户
*   以根帐户登录
*   创建 IAM 用户、组和角色
*   创建 EC2 密钥对
*   安装 AWS 命令行界面
*   在 AWS 命令行界面中配置凭据和配置文件
*   使用自动气象站命令行界面与自动气象站交互
*   介绍 AWS 云信息
*   定义一个简单的 AWS 云信息模板
*   部署 AWS 云信息栈
*   删除 AWS 云信息栈
# 技术要求
本章的技术要求如下:
*   按照第 1 章*容器和 Docker 基础*中的说明安装必备软件
*   在本章中，创建免费 AWS 帐户需要有效的信用卡
以下 GitHub URL 包含本章使用的代码示例:[https://GitHub . com/docker-in-AWS/docker-in-AWS/tree/master/CH3](https://github.com/docker-in-aws/docker-in-aws/tree/master/ch14)[。](https://github.com/docker-in-aws/docker-in-aws/tree/master/ch3)
查看以下视频，了解《行动守则》:
[http://bit.ly/2N1nzJc](http://bit.ly/2N1nzJc)
# 设置 AWS 帐户
您的 AWS 之旅的第一步是建立一个 AWS 帐户，这是 AWS 的一个基本构建块，它定义了管理您所使用的 AWS 服务和资源的安全和管理上下文。为了鼓励采用 AWS 并确保用户第一次有机会免费试用 AWS，AWS 提供了一个免费层，允许您免费访问一些 AWS 服务(在使用方面有一些限制)。你可以在[https://aws.amazon.com/free/](https://aws.amazon.com/free/)找到更多关于免费层和提供什么服务的信息。确保你很好地理解你可以免费使用和不可以免费使用的东西，以避免不必要的账单冲击。
在本书中，我们将使用一些免费的分层服务，每月使用限额如下:
| **服务** | **极限** |
| EC2 | 750 小时的 Linux t2.micro(单个 vCPU，1 GB 内存)实例 |
| 弹性块存储 | 30 GB 块级存储(固态硬盘或传统旋转磁盘) |
| 无线电数据系统 | 750 小时的 db.t2.micro(单个 vCPU，1 GB 内存)MySQL 实例 |
| 弹性容器登记处 | 500 兆存储空间 |
| 弹性负载平衡 | 750 小时的经典或应用负载平衡器 |
| S3 | 5gb S3 存储 |
| 希腊字母的第 11 个 | 1，000，000 次请求 |
| CloudWatch | 10 个定制指标 |
| 社交网站（Social Network Site 的缩写） | 1，000，000 份出版物 |
| 代码构建 | 100 分钟构建 |
| 代码管道 | 1 条活动管道 |
| x 光 | 100，000 条轨迹 |
| 密钥管理服务 | 20，000 次请求 |
| 机密经理 | 30 天免费试用期，每个机密/月 0.40 美元 |
如您所见，假设您遵守上表中描述的使用限制，我们将在本书中介绍许多 AWS 服务，并且几乎所有这些服务都是免费的。事实上，我们将在本书中使用的唯一不是免费的服务是 AWS Fargate 服务，所以当您通读 Farget 一章时，请记住这一点，如果您担心成本，请尽量减少您的使用。
要注册免费等级访问，请点击[https://aws.amazon.com/free/](https://aws.amazon.com/free/)的**创建免费账户**按钮:
![](img/de4a4e51-dad1-4756-ad13-ce2d6089757a.png)
Creating a free account
系统将提示您输入电子邮件地址、密码和 AWS 帐户名。请务必理解，您在此输入的电子邮件地址和密码被称为您的 AWS 帐户的根帐户，它对您的帐户具有最高级别的访问权限。对于 AWS 帐户名，您可以输入任何您喜欢的名称，但是它在所有其他 AWS 帐户中必须是唯一的，因此至少您将无法使用我选择的帐户名，即`docker-in-aws`。此帐户名在您登录时使用，比您的 AWS 帐号更容易记住，它是一个 12 位数字。
注册过程的其余部分是不言自明的，因此我不会用这里的细节来烦你，但请理解，你将被要求提供信用卡详细信息，并将对超过免费层使用限制的任何费用负责。您还需要在注册过程中验证您指定的电话号码，这涉及到对您的号码的自动电话呼叫，因此请确保在注册过程中输入有效的电话号码。
# 安装谷歌认证器
本节中描述的步骤完全是可选的，但是，作为安全最佳实践，您应该始终在根帐户上启用多因素认证(MFA)。事实上，您应该为所有基于用户的对您的 AWS 帐户的访问启用此功能，而不管所需的访问级别如何。对于许多使用 AWS 的组织来说，启用 MFA 越来越成为一项强制性要求，因此在涉及 MFA 时，习惯于使用 AWS 非常重要。因此，我们将在整本书中使用 MFA。
在使用 MFA 之前，您需要有一个 MFA 设备，它可以是硬件或虚拟 MFA 设备。虚拟 MFA 设备通常以应用的形式安装在您的智能手机上，完成了您知道的东西(密码)和您拥有的东西(手机)的多因素范例。
安卓和 iOS 都有的一个流行的 MFA 应用是谷歌认证器应用，你可以从谷歌 Play 或苹果应用商店下载。安装应用后，您可以继续登录到根帐户并设置 MFA 访问。
# 以根帐户登录
设置并激活您的帐户后，您应该可以登录 AWS 控制台，您可以在[https://console.aws.amazon.com/console/home](https://console.aws.amazon.com/console/home)访问该控制台。
使用根凭据登录后，您应该做的第一件事是立即启用 MFA 访问。这提供了额外的安全级别，确保如果您的用户名和密码被泄露，攻击者在不拥有您的 MFA 设备的情况下无法访问您的帐户(在我们的示例中，这意味着您的智能手机上的谷歌认证器应用)。
要为您的根帐户启用 MFA，请选择指定您的帐户名的下拉列表(在我的情况下，这是**AWS docker-in-AWS**)并选择**我的安全凭证**:
![](img/bd93b230-35b0-4d24-b1dd-a148d744fe77.png)
Accessing My Security Credentials
在下一个提示中，点击**继续安全凭证**按钮，在**您的安全凭证**页面上展开**多因素认证(MFA)** 选项，点击**激活 MFA** 按钮:
![](img/b554b605-ddd9-4bce-a62c-1c6a6a7be323.png)
The Your Security Credentials screen
在管理 MFA 设备屏幕中，单击**虚拟 MFA 设备**选项，然后单击**下一步**两次，此时将向您显示二维码:
![](img/56ca8281-9403-47b8-82c7-5c2b96e94fe3.png)
Obtaining a QR code
您可以使用智能手机上的谷歌认证器应用扫描该代码，方法是单击添加按钮，选择**扫描条形码**，并在 AWS 控制台中扫描二维码:
![](img/6ab37fc0-9b86-4ee4-9c57-b186a02ddb6b.jpg) ![](img/0a255dd8-9ba8-4e15-b55d-2d7e10bfc436.png)
![](img/5c785b9d-3b72-40db-9f65-dcbb2a5b3343.png)
Registering an MFA device
扫描后，您需要输入在**管理 MFA 设备**屏幕中输入的**验证码 1** 中显示的六位数代码。
代码旋转后，在**验证码 2** 输入中输入下一个代码值，点击**激活虚拟 MFA** 按钮，完成您的 MFA 设备注册:
![](img/e399192a-aa4e-43d0-a977-2e8ba4107479.png)
Your Security Credentials with the MFA device
# 创建 IAM 用户、组和角色
使用 MFA 保护您的根帐户后，接下来应该立即在您的帐户中创建身份访问和管理(IAM)用户、组和角色，以便进行日常访问。IAM 是日常管理和访问您的 AWS 帐户的推荐方法，您应该仅出于计费或紧急目的限制根帐户访问。在继续之前，您需要知道您的 AWS 帐户标识，您可以在前面的屏幕截图中看到，在您的 MFA 设备的序列号中(请注意，这将是一个与所示不同的号码)。记下这个帐号，因为它是您配置各种 IAM 资源时所必需的。
# 创建 IAM 角色
创建 IAM 资源的标准做法是创建给定用户可以承担的*角色*，这将在有限的时间内(通常长达 1 小时)授予用户提升的权限。默认情况下，您至少需要创建一个 IAM 角色:
*   **管理员**:该角色授予对账户的完全管理控制权，计费信息除外
要创建管理员角色，请从 AWS 控制台选择**服务** | **IAM** ，从左侧菜单选择**角色**，然后单击**创建角色**按钮。在**选择受信任实体类型**屏幕中，选择**另一个 AWS 帐户**选项，并在**帐户标识**字段中配置您的帐户标识:
![](img/9ebc3797-e018-48e0-80a1-d81b577a1dc2.png)
Selecting a trusted entity for admin role
单击**下一步:权限**按钮后，选择**管理员访问**策略，该策略授予角色管理访问权限:
![](img/5d5dadb4-76a0-43fe-b957-d3a0ed3250f0.png)
Attaching a policy to an IAM role
最后，指定**管理员**的角色名称，然后点击**创建角色**完成管理员角色的创建:
![](img/75f3e14e-ff1a-42e4-8893-9f67a1fdfcec.png)
Creating an IAM role
这将创建管理员 IAM 角色。如果您单击新创建的角色，请记下该角色的角色 ARN(亚马逊资源名称)，因为稍后您将需要该值:
![](img/945a886e-13aa-4153-894a-9e969d65f0e8.png)
The admin role