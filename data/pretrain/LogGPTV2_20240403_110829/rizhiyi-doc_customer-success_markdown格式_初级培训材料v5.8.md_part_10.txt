99
日志学院
百分位等级
百分位等级查询常用于SLA考核场景。您可以选择某个数值型字段后，输入查询数值，点
击查询，即可获得查询结果。例如，您希望查询有多少百分比的请求长度在25以内。输
入25，获得的查询结果为7.03%，如下图所示：
多级统计
多级统计可以满足您针对某一字段的多重统计需求。多级统计最多支持三级。每次统计结
果出现后都可以选择进行下一步统计或展现统计图。展现统计图是对当前生成数据表的可
视化展现。例如您可以在step1中选择字段“apache.clientip”,“top5”，点击“生成”，可以看
到统计结果，如下图所示：
100
日志学院
勾选需要进一步统计的 ip 地址，点击“下一步”按钮。需要注意的是，当您准备做计数统
计(count)时，一次只能选定一个值，否则屏幕会出现报错信息：
例如勾选第一个ip“113.86.100.136”，点击“下一步统计”，可以看到出现“step2”，
继续选择字段，选择“apache.status”，统计方式选择“计数”，点击生成:
101
日志学院
选择值“405”点击“下一步”，字段选择“apache.request_query”,统计方式选择“计
数”，点击生成，可以看到统计结果：
点击“统计图”，展现方式选择“饼图”，点击“生成”:
102
日志学院
在完成每一步操作后，您可以直接更改上一步的操作，系统会自动展现新的步骤，但并不
会保存您之前所做的操作。
地理分布
地理分布统计功能为您展示日志中的ip地址分布情况。日志易默认根据颜色深浅标识ip
地址在世界地图的分布情况————左下方您能看到详细注释:
在某区域上方悬停鼠标将会展示该区域的具体事件数，点击区域将进一步展示该区域的分
布情况，日志易的区域统计精确到市。在市级地图点击将会返回上一层地图。
比如在世界地图上点击中国，会出现中国地图展示：
103
日志学院
然后点击广东，会出现广东省地图，展示各市区统计结果：
8.2 SPL 初识
除统计菜单视图点选外，日志易还可通过在搜索框中编程的形式实现日志搜索。
在4.2小节，我们已经简单了解了日志易搜索功能的简单用法。而实际上，日志易搜索框
能实现的日志搜索还不止这么简单。
上一章节末尾，我们已经接入了Nginx日志。Nginx日志中有大量字段，通过统计菜单视
图对这些字段进行统计较为有限，日志易提供了SPL（Search Processing Language）语
句，以便能做出实现更多的分析场景。
本章我们将学习SPL常用的分析绘图场景及所用函数。
学习路线
日志易系统支持Lucene系的全文检索语法，这在4.2.3小节我们就已提及。全文检索语句
会被解析成一系列的单词和操作符。这里说的单词，可以是一个真正的英文单词，比如
error；也可以是一段由双引号包裹起来的短语，比如"user login"。系统会按照相同的次
序，在分词后的索引中，搜索短语内的每个英文单词。除了最基础的单词检索以外，您还
可以使用操作符组合更复杂的全文检索语法。
相比全文搜索，日志易SPL集合了所有的检索命令、函数、参数和从句。检索命令告诉日
志易系统对索引中的数据应该做什么操作。比如，你可以使用检索命令来过滤不必要的信
息、提取更精确的信息、评估新的字段、计算统计指标、排序结果，甚至创建一个图表。
104
日志学院
如果您对日志易产品还不太熟悉，推荐您首先阅读《日志易使用手册》及《日志易数据接
入手册》等文档。
在完成数据接入工作后，您应该会迫不急地想要开始使用SPL进行对数据金矿的探索发现
工作。通常来说，这个探索的最终目标可以分为如下两类：
l 故障排查：您期望从索引数据中找到故障根源，或者至少提供给你明确的排查方
向提示；
l 统计可视化：您期望以一种巡检报表的形式，获取对索引数据的多维度统计分析
结果，最好是恰当的可视化仪表盘。
对于这两个不同的目的，搜索用法也有着明显不同的分类：
l 原文检索：主要通过关键字、唯一标识符等低频词元，利用索引中倒排表的高性
能查找特性，快速定位和读取原始日志内容。常见场景有：查找错误代码、关联
跟踪特定订单或客户访问在多模块之间的流动情况、分析异常堆栈等等。此种场
景常使用4.2.3的关键字、逻辑运算符、Lucense系全文搜索语法。
l 统计变换: 对检索数据集进行一系列指标运算，得到二维表格式的变换结果。常
见场景有: 错误事件数的时间趋势、特定用户登录行为的排行和分布、访问响应
时间的百分比统计、KPI指标的平滑预测等等。此种场景常使用SPL语句。
由于解析后的日志是各个字段与对应的字段值的形式，又可以借助表格来理解SPL数据处
理的逻辑。
总体来说，本小节SPL的学习将按以下顺序进行：
105
日志学院
小试牛刀
学习环境准备
为了帮助您快速体验日志易SPL学习，我们建议您先部署一套日志易企业版测试环境。部
署过程可以参考《日志易安装手册》或在日志易工程师辅导下完成，部署好日志易环境
后，请导入基础规则，以满足基本实验环境需要。
导入方法请参阅下文正则规则导入。
同时我们为您准备了一份常规的Nginx访问日志样例。您可以参考下文样例日志导入。
日志导入完毕后，可以正式进入SPL的学习。
正则规则导入
本文附件为您准备了一份名为“Nginx日志解析规则.tar”压缩包，请先将该压缩包导入到
部署好的日志易环境中。该压缩包会自动提取本文中样例日志的关键信息。后面会陆续讲
解。
操作步骤图例：
登录日志易主界面左侧菜单à选择设置à资源分组。
在资源分组中选择“导入/导出”按钮à本地上传à分配角色à确定，即可。规则导入完
成。如果存在相同资源会提示是否替换。此时谨慎处理。
106
日志学院
样例日志导入
本文附件中为您准备了一份Nginx样例日志名为“access.log.10.gz”，您可以先做解压然
后根据图示进行数据导入。操作步骤为：
登录日志易主界面左侧菜单à选择设置à本地上传à输入appname与tag（如图）à本地
上传（选择文件路径）à上传。
注意：本地上传仅作为快速功能体验使用。大量数据建议使用日志易Agent自动采集。
107
日志学院
样例日志说明
原始日志：
220.181.108.183 - - [04/Jun/2017:06:26:52 +0800] "GET / HTTP/1.1" 200 6474 "-"
"Mozilla/5.0 (Linux;u;Android 4.2.2;zh-cn;) AppleWebKit/534.46 (KHTML,like Gecko)
Version/5.1 Mobile Safari/10600.6.3 (compatible; Baiduspider/2.0;
+http://www.baidu.com/search/spider.html)" "-" 0.014 -
36.110.219.130 - - [04/Jun/2017:06:27:34 +0800] "POST /report HTTP/1.1" 200 37 "-"
"Apache-HttpClient/4.2.5 (java 1.5)" "-" 0.001 0.001
日志样例导入日志易后效果：
223.74.215.215 - - [31/May/2018:00:00:01 +0800] "POST
/bulk/f02a65bae0594d01afeb3ffd7a2c32a4/tag/userLogin/appname/chess HTTP/1.1" 200 64
"http://zm.tongjiyuehui.com/" "Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X)
AppleWebKit/604.1.38 (KHTML, like Gecko) Mobile/15A372 MicroMessenger/6.6.6 NetType/WIFI
Language/zh_CN" "-" 0.001 0.001
108
日志学院
客户端IP：223.74.215.215
时间戳：[20/Apr/2018:20:25:43 +0800]
方法：POST
访问页面：/bulk/f02a65bae0594d01afeb3ffd7a2c32a4/tag/userLogin/appname/chess
访问协议：HTTP/1.0
访问状态：200
请求长度：64
上一跳：http://zm.tongjiyuehui.com/
UA：Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38
(KHTML, like Gecko) Mobile/15A372 MicroMessenger/6.6.6 NetType/WIFI
Language/zh_CN
整个请求时间和upstream响应时间: 0.001 0.001
登录日志易平台 à 打开搜索 à 输入“appname:niginx” à 在时间处根据日志样例时
间戳选择时间段。如图：
109
日志学院
案例1：基本查询与统计
某网站想统计分析当日有多少iphone 客户端访问相关数据。当日总体流量和每十分钟进
行一次分时汇总。
SPL：模糊查询
appname:nginx AND iphone
结果如图：
110
日志学院
SPL说明：
l “appname:nginx” 为日志范围的检索，字段名称appname,字段值为nginx 。字段
与值中间用“:”分割。
l AND为逻辑运算符号。日志易SPL检索语法中，多个单词或短语之间，默认为AND
的关系，且AND优先级高于OR。在有需要时，您可以显式的使用小括号()来指明分
组优先级
l iphone 关键字查询。
常用搜索功能：
全文检索 : 113.66.199.117 GET
短语查询 : "/api/v0/search/action/ HTTP/1.1"
通配符 : * , ?
逻辑运算符 : AND, OR, NOT, ( )
字段值完全匹配 : apache.method:"get"
正则或通配符 : hostname:10-6-24*
字段数值范围 : apache.status:[400 TO 500] 或 apache.status:>400
SPL：stats 统计命令
appname:nginx | stats count()
结果如图：
111
日志学院
SPL说明：
l 通过S2-SPL命令我们可以获得当日网站访总访问量。
l “appname:nginx |” 第一个管道符号“|”前为query。
l 管道符号“|”作用与Linux shell 中作用相同。即：将前一个命令的结果输出给后一
个命令做为输入。
l “stats count()”，stats 为SPL统计命令，该命令下属函数列表如下：
函数 描述 示例
此函数返回字段X的平均值 以下示例会返回平均响应时间:
avg(X)
avg(response_time)
此函数返回X的出现次数 以下函数返回status的个数:
count(X)
count(status)
distinct_count(X) 此函数返回字段X唯一值的 以下示例返回clientip的uniq值的个数:
| dc(X) 技术 dc(clientip)
此函数返回字段X的最大值 以下示例返回响应时间的最大值:
max(X)
max(response_time)
此函数返回字段X的最小值 以下示例返回响应时间的最小值:
min(X) min(response_time)
此函数返回字段X的值的和 以下示例返回响应长度的和:
sum(X)
sum(response_len)
此函数返回X字段的值排序 以下字段返回响应时长，50%，75%, 95%分位的值
后，百分位Y1, Y2所对应的 pct(response_time, 50, 75, 95)
字段值，由于pct会返回多个 将返回三个字段:
pct(X, Y1, Y2…) 值，字段命名方式如下，Y1 _pct.response_time.50,
对应的字段为_pct.X.Y1, Y2对 _pct.response_time.75,
应的字段为_pct.X.Y2，以此类 _pct.response_time.95
推
pct_ranks(X, Y1, 此函数接收任意个参数，其中 以下示例返回100， 200， 500在
Y2…) X为数值类型字段，Y1，Y2 response_time字段中对应的百分位
112
日志学院
为X字段对应的值，该函数 pct_ranks(response_time, 100, 200, 500)
将返回Y1，Y2所对应的百分 返回字段集合
位，由于pct_ranks会返回多 _pct_ranks.response_time.100
个值，字段命名方式如下， _pct_ranks.response_time.200
_pct_ranks.X.Y1, _pct_ranks.response_time.500
_pct_ranks.X.Y2
以此类推
返回字段es的扩展统计，将 以下示例resp_len字段的es统计值
返回如下字段(X为字段名) es(resp_len)
_es.X.count 返回的字段集合
_es.X.min _es.resp_len.count
_es.X.max _es.resp_len.min
_es.X.avg _es.resp_len.max
es(X)
_es.X.sum _es.resp_len.avg