Red vs. Blue: 
Modern Active Directory 
Attacks & Defense
Sean Metcalf
CTO
DAn Solutions
sean [@] dansolutions . com 
http://DAnSolutions.com
http://www.ADSecurity.org
Photo by Ed Speir IV. 
All Rights Reserved. Used with Permission.
ABOUT
Chief Technology Officer - DAn Solutions
Microsoft Certified Master (MCM) Directory Services
Security Researcher / Purple Team
Security Info -> ADSecurity.org
AGENDA
Red Team (Recon, Escalate, Persist)
Blue Team (Detect, Mitigate, Prevent)
Kerberos TGT Ticket
Kerberos Overview
Kerberos Key Points
NTLM password used for Kerberos RC4 encryption.
Logon Ticket (TGT) proves prior user auth to DC.
Kerberos policy only checked at TGT creation
DC only validates user account when TGT > 20 mins.
Service Ticket (TGS) PAC validation is optional & rare.
Red Team (Offense)
“SPN Scanning” Service Discovery
SQL servers, instances, ports, etc. 
MSSQLSvc/adsmsSQLAP01.adsecurity.org:1433
Exchange Client Access Servers
exchangeMDB/adsmsEXCAS01.adsecurity.org
RDP
TERMSERV/adsmsEXCAS01.adsecurity.org
Going from N/A to DA (Domain Admin)
Poor Service Account Passwords
Passwords in SYSVOL
Credential Theft 
Misconfiguration / Incorrect Perms
Exploit Vulnerability
SPN Scanning for Service Accounts with Find-PSServiceAccounts
SPN Directory:  
http://adsecurity.org/?page_id=183
Cracking Service Account Passwords (Kerberoast)
Request/Save TGS service tickets & crack offline.
“Kerberoast” python-based TGS password cracker.
No elevated rights required.
No traffic sent to target.
Kerberoast: Request TGS Service Ticket
Kerberoast: Save & Crack TGS Service Ticket
Exploiting Group Policy Preferences
\\\SYSVOL\\Policies\
Mimikatz: The Credential Multi-tool
Dump credentials 
Windows protected memory (LSASS). *
Active Directory Domain Controller database . *
Dump Kerberos tickets 
for all users. *
for current user. 
Credential Injection
Password hash (pass-the-hash) 
Kerberos ticket (pass-the-ticket) 
Generate Silver and/or Golden tickets 
And so much more!
Dump Credentials with Mimikatz
User
Service Account
Dumping AD Domain Credentials
Dump credentials on DC (local or remote).
Run Mimikatz (WCE, etc) on DC.
Invoke-Mimikatz on DC via PS Remoting.
Get access to the NTDS.dit file & extract data.
Copy AD database from remote DC.
Grab AD database copy from backup.
Get Virtual DC data.
Dump AD Credentials with Mimikatz
Dump LSASS Process Memory
Remotely Grab the DIT!
Instead of VSS, why not leverage NTDSUtil?
Finding NTDS.dit on the Network
Are your DC backups properly secured?
Who administers the virtual server hosting the DCs?
Are your VMWare/Hyper-V host admins considered 
Domain Admins?
Hint: They should be.
Dump Password Hashes from NTDS.dit
Pass The… Credential
Pass the Hash
Pass the Ticket
Over Pass the Hash
Over Pass the Hash
MS14-068: (Microsoft) Kerberos Vulnerability
MS14-068 (CVE-2014-6324) Patch released 11/18/2014
Domain Controller Kerberos Service (KDC) didn’t correctly validate the PAC 
checksum.
Effectively re-write user ticket to be a Domain Admin.
Own AD in 5 minutes
http://adsecurity.org/?tag=ms14068
MS14-068 (PyKEK 12/5/2014)
MS14-068 Kekeo Exploit
MS14-068 Kekeo Exploit – Packet Capture
User to Admin in 5 Minutes?
Sneaky AD Persistence Tricks
(Attacker has DA access for 5 minutes)
DSRM 
SSP 
Skeleton Key
SID History
Kerberos Ticket Forging
Local Policy
Logon Scripts
Group Policy
Scheduled Tasks
WMI
Output | SYSVOL
DSRM? What’s DSRM?
•Directory Services Restore Mode 
•“Break glass” access to DC
•DSRM password set when DC is promoted
•Rarely changed.
DSRM = DC Local Administrator Account
Using DSRM Creds
•Reboot to DSRM
•Access DSRM without Rebooting (2k8+)
•DsrmAdminLogonBehavior = 1
•Stop Active Directory (ntds) service
•Console logon (not RDP)
Using DSRM Creds
•Access DSRM without Rebooting (2k8+)
•DsrmAdminLogonBehavior = 2
•Stop Active Directory (ntds) service
•Console logon (not RDP) 
Using DSRM Creds Over the Network
•Console logon
• VMWare Remote Console 
• (TCP 903)
• Hyper-V VM Connection
• (TCP 5900)
• Network KVM
Malicious Security Service Provider (SSP)
•Mimikatz supports registry & in-memory updating
Malicious Security Service Provider (SSP)
Malicious Security Service Provider (SSP)
Malicious Security Service Provider (SSP)
Malicious Security Service Provider (SSP)
Skeleton Key
• Memory resident LSASS patch - “master key” for all accounts
Skeleton Key
• Account authentication success! With 2 different passwords?
SID History
• User account attribute supporting migration.
• Mimikatz enables SID History injection to any user account.
SID History
SID History -> Domain Exploitation
Forging Kerberos Golden/Silver Tickets
Requires KRBTGT pw hash / service account pw hash.
Forged TGT (Golden Ticket) bypasses all user restrictions.
Create anywhere & use from any computer on the network.
No elevated rights required to create/use. 
User password changes have no impact on forged ticket!
KRBTGT: The Kerberos Service Account
KRBTGT account: disabled and hidden by default.
Sign/encrypt AD Kerberos tickets.
Pwd set when domain created & (almost) never changes
Password changes when DFL -> 2008 (or newer).
Current & Previous Password valid for Kerberos tickets
KRBTGT password exposed? Requires changing twice!
Microsoft KRBTGT password change script on TechNet
RODC Kerberos Account: KRBTGT_######.
KRBTGT: The Kerberos Service Account
The Golden Ticket (Forged TGT)
Encrypted/Signed by KRBTGT (RID 502).
Bypasses Smart Card authentication requirement 
Golden Ticket options:
Impersonate existing Domain Admin
Create Fictitious user
Spoof access by adding groups to the ticket
Impersonate C-level executive access
Limited to Domain it’s created in *
Where are the crown jewels?
Golden Ticket (Forged TGT) Communication
Forging a Golden Ticket: KRBTGT NTLM Hash
Golden Ticket Limitation
Admin rights limited to current domain.
Doesn’t work across trusts unless in EA domain.
Golden Ticket – Now More GOLDEN!
Mimikatz now supports SID History in Golden Tickets
The Silver Ticket (Forged TGS)
Service account configured for Kerberos auth (SPN).
Encrypted with the service account private key:
Service account NLTM password hash
AD computer account NLTM password hash
Service opens TGS ticket to validate.
Golden Ticket equivalent access to service.
No associated TGT exists, so no comm with a DC 
Silver Ticket (Forged TGS) Communication
Silver Ticket: Domain Controller Exploitation
• Attacker dumped AD & has all domain creds.
• Corp IT changed all user, admin, and service account passwords 
(and KRBTGT pw 2x).
• Attacker still has Domain Controller computer account password 
hashes.
What is possible with these?
Silver Ticket: Domain Controller Exploitation
Silver Ticket: Domain Controller Exploitation
Silver Ticket: Domain Controller Exploitation
Silver Ticket: Domain Controller Exploitation