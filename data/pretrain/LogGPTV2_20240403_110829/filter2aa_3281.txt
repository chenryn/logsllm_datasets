# 顶级域攻击与接管指南

## 关于我
- **ztz @360高级攻防实验室**
- 专注领域：攻防对抗研究、漏洞挖掘、武器开发
- 荣誉：Google Hall of Fame
- 技能：Golang, Ruby, Homebrew

## 主要内容
1. DNS 协议介绍
2. 云 DNS 场景劫持探讨
3. 顶级域 DNS 场景劫持探讨

## DNS 协议
- **起源与发展**：DNS 协议诞生于 1983 年，经过不断更新发展至今。
- **功能**：实现主机名与 IP 地址之间的转换，被誉为“互联网电话簿”。
- **管理机构**：ICANN 负责域名系统的维护和运作。

## 域名组成
- **子域 (sub.domain.tld.)**
- **权威域 (domain)**
- **顶级域 (tld)**
- **根域 (.)**

### 根域
- **定义**：根域是域名系统中最高级别的解析域。
- **根域服务器**：提供到顶级域服务器的映射，其地址硬编码在递归 DNS 服务器中。

### 顶级域（TLD）
- **定义**：顶级域位于根域之下，由 IANA 管理，并分发给托管商负责。
- **服务**：托管商提供某一顶级域下所属域名的解析服务。
- **参考**：[IANA TLD 列表](https://data.iana.org/TLD/tlds-alpha-by-domain.txt)

### 权威域
- **注册**：域名注册商面向市场提供权威域购买和注册服务。
- **管理**：实际购买者负责管理和维护其权威域。

## 注册域名时实际在注册什么
- **用户**：通过注册商购买域名。
- **注册商**：将域名信息提交至顶级域服务器。
- **顶级域服务器**：记录并更新域名的 NS 记录。

### 示例
- 用户购买 `a.com` 后，注册商会将 `a.com` 的 NS 记录指向特定的 DNS 服务器，如 `ns.a.co`。

## 权威域 DNS 的位置
- **默认设置**：域名注册商通常提供权威域 DNS 解析服务，默认使用注册商的 DNS 托管。
- **第三方服务**：用户也可以选择使用独立的 DNS 解析服务提供商，如 Cloudflare 或各类云解析 DNS。

## 云解析 DNS 管理权限交接
- **过程**：
  1. 更换 DNS 托管商时，旧托管商通过 EPP 协议请求顶级域 Zone 文件更新。
  2. 修改域名的 NS 指向新托管商。
  3. 顶级域 Zone 文件更新后，权威域 DNS 解析服务器完成指向更新。
  4. 新托管商验证 NS 指向成功后，用户获得控制台管理权。

## 云解析 DNS 接管风险
- **验证与管理**：先验证，后管理。
- **孤儿域名**：已绑定但未修改 NS 指向的域名。
- **接管风险**：攻击者可以通过添加孤儿域名来接管域名控制权。

### 风险示例
- **云 DNS 架构升级**：老 DNS 服务器成为孤儿域名。
- **攻击者接管**：攻击者注册老 DNS 服务器，接管云 DNS。

## 顶级域 DNS 接管风险
- **类似问题**：顶级域 DNS 是否存在类似的风险？

### 顶级域接管尝试
- **国外安全研究员**：@IAmMandatory 曾经通过接管过期的 .io 顶级域 NS 服务器来控制所有 .io 域名。
- **当前状况**：目前顶级域 NS 是否存在类似问题？@fate0 进行了研究。

#### 研究结果
- **第一次尝试**：寻找未注册或过期的顶级域 NS。
- **发现**：大部分域名均已注册，只是暂未设置 DNS 解析。
- **NS 同步**：NS 主从之间通过 AXFR 或 IXFR 域传送同步解析记录。
- **不一致现象**：5k+ 条 TLD NS 记录中，部分 NS 存在解析不一致且可注册，意味着存在接管风险。

## 总结
- **DNS 协议**：古老且庞大。
- **攻击面**：老协议结合新业务场景导致新的攻击面。

感谢观看！
KCon 汇聚黑客的智慧