顶级域攻击与接管指南
>  ABOUT ME
0 1
•
ztz @360高级攻防实验室
•
专注攻防对抗研究、漏洞挖掘、武器开发
•
// Google Hall of Fame
•
// Golang
•
// Ruby
•
// Homebrew
>  主要内容
0 2
•
DNS Protocol 介绍
•
云 DNS 场景劫持探讨
•
顶级域 DNS 场景劫持探讨
>  DNS 协议
0 3
•
诞生于 1983 年，不断更新到现在
•
实现主机与 IP 地址转化的“互联网电话簿”
•
ICANN 负责域名系统的维护和运作
>  DNS 协议
0 4
>  域名组成
0 5
sub.domain.tld.
子域
权威域
顶级域
根域
>  根域
0 6 
•
根域是域名系统中最高级别解析域
•
根域服务器是 DNS 中最高级别的域名
服务器，提供到顶级域服务器的映射
•
根域服务器地址硬编码在递归 DNS 服
务器中
>  顶级域（TLD）
0 7
•
顶级域是互联网域名系统的等级中，
位于根域空间的最高级域名，由
IANA 管理，分发托管商负责
•
托管商提供某一顶级域下所属域名解
析服务
•
https://data.iana.org/TLD/tlds-alpha-by-
domain.txt
>  权威域
0 8
•
域名注册商面向市场提供权威域购买
和注册服务
•
权威域由实际购买者负责管理和维护
>  域名组成
0 9
Root$DNS$
Server
TLD$DNS$Server
Authoritative$
DNS$Server
>  注册域名时实际在注册什么
1 0
用户
注册商
a.co
a.com
TLD Server
>  注册域名时实际在注册什么
1 1
用户
注册商
a.co
a.com
NS
ns.a.co
TLD Server
>  注册域名时实际在注册什么
1 2
用户
ns.a.co
Where.is.www.a.com
x.x.x.x
Authoritative$ DNS$
Server
>  权威域 DNS 到底在哪里
1 3
•
域名注册商通常提供权威域 DNS 解析服务，域名购买后默
认使用域名注册商 DNS 托管解析
•
单独 DNS 解析服务提供商：Cloudflare、各类云解析 DNS
>  云解析 DNS 管理权限交接
1 4
•
权限交接发生在更换 DNS 托管商时
•
老 DNS 托管商使用 EPP 协议请求顶级域 Zone file 更新，
修改该域名 NS 指向到新 DNS 托管商
•
顶级域 Zone file 更新，权威域 DNS 解析服务器完成指
向更新
•
云解析 DNS 验证 NS 指向成功，用户获得控制台管理
权
>  云解析 DNS 接管风险
1 5
•
先验证，后管理
a.com IN  NS  ns1.xxyun.com
TLD Zone
xxyun DNS
用户账户
>  云解析 DNS 接管风险
1 6
•
孤儿域名：已绑定域名被解绑，NS 指向未修改
a.com IN  NS  ns1.xxyun.com
TLD Zone
xxyun DNS
用户账户
>  云解析 DNS 接管风险
1 7
•
孤儿域名接管：攻击者在控制台添加孤儿域名，完成域名接管
a.com IN  NS  ns1.xxyun.com
TLD Zone
xxyun DNS
攻击者
>  云解析 DNS 接管风险
1 9
>  云解析 DNS 接管风险
2 0
孤儿域名 + 云 DNS = 云 DNS 域名接管
•
孤儿域名接管获得域名控制权
•
云 DNS 解析服务器域名通常托管于该云 DNS 中
>  云解析 DNS 接管风险
2 1
•
举例说明
•
某云 DNS 解析服务器 ns1.xxcloud.cn
•
大量用户域名通过 ns1.xxcloud.com 托管
云 DNS
ns1.xxcloud.com
用户
>  云解析 DNS 接管风险
2 2
•
某云进行架构升级，在老 DNS 和用户之间加入一层新 DNS
云 DNS
ns1.xxcloud.com
用户
云 DNS
ns1.dns-xxcloud.com
>  云解析 DNS 接管风险
2 3
•
因缘巧合，此时老 DNS 服务器成为孤儿域名
云 DNS
ns1.xxcloud.com
用户
云 DNS
ns1.dns-xxcloud.com
>  云解析 DNS 接管风险
2 4
•
攻击者控制台注册老 DNS 服务器，接管云 DNS
云 DNS
ns1.xxcloud.com
用户
云 DNS
ns1.dns-xxcloud.com
>  云解析 DNS 接管风险
2 5
>  顶级域 DNS 接管风险
2 6
•
同样的道理，顶级域 DNS 是否存在类似问题？
>  DNS 解析流程
2 7
Recursive DNS Server
Root DNS Server
TLD DNS Server
Authoritative DNS
Server
Client
Stub
1..Where.is.www.a.com?
2..Where.is..com?
3..Where.is.a.com?
4..Where.is.www.a.com?
>  DNS 解析流程
2 8
Recursive DNS Server
Root DNS Server
TLD DNS Server
Authoritative DNS
Server
Client
Stub
1..Where.is.www.a.com?
2..Where.is..com?
3..Where.is.a.com?
4..Where.is.www.a.com?
>  DNS 解析流程
2 9
Root DNS Server
Root Zone file
Where is .com?
com. 86400 IN NS m.gtld-servers.net.
com. 86400 IN NS c.gtld-servers.net.
com. 86400 IN NS e.gtld-servers.net.
com. 86400 IN NS l.gtld-servers.net.
>  顶级域接管
3 0
•
国外安全研究员 @IAmMandatory
•
The .io Error – Taking Control of All .io 
Domains With a Targeted Registration -
@IAmMandatory
•
接管过期的 .io 顶级域 NS 服务器
•
目前顶级域 NS 是否存在该问题？@fate0
> 顶级域接管
3 1
> 顶级域接管
3 2
> 顶级域接管
3 3
>  顶级域接管
3 4
•
第一次尝试，寻找未注册或过期的顶级域 NS
>  顶级域接管
3 5
>  顶级域接管
3 6
>  顶级域接管
3 7
•
意料之中：域名均已注册，只是暂未设置 DNS 解析
>  顶级域接管
3 8
•
NS 主从之间通过 AXFR 或
IXFR 域传送同步解析记录
•
TLD 主从 NS 之间是否存在不一
致现象？
>  顶级域接管
3 9
•
开始 TLD 主从 NS 之间不一致现象
研究
•
5k+ 条 TLD NS 记录，逐个分析 NS
之间的不一致现象
>  顶级域接管
4 0
•
一定数量 NS 失效：
•
(46) ns-tld1.charlestonroadregistry.com
•
(21) *.zdnscloud.com
>  顶级域接管
4 1
•
部分 NS 存在解析不一致，且不一致的解析记录可注册
•
意味着存在接管风险
>  总结
4 5
•
DNS 协议族古老、臃肿庞大
•
老协议 + 新业务新场景 = 攻击面
M        A        N        O        E        U        V        R        E
感谢观看！
KCon 汇聚黑客的智慧