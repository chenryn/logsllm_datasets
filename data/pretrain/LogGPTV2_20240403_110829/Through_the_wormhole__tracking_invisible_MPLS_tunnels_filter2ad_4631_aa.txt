title:Through the wormhole: tracking invisible MPLS tunnels
author:Yves Vanaubel and
Pascal M&apos;erindol and
Jean-Jacques Pansiot and
Benoit Donnet
Through the Wormhole: Tracking Invisible MPLS Tunnels
Yves Vanaubel∗, Pascal Mérindol‡, Jean-Jacques Pansiot‡, Benoit Donnet∗
∗ Monteﬁore Institute, Université de Liège – Belgium
‡ Icube, Université de Strasbourg – France
ABSTRACT
1 INTRODUCTION
For years, Internet topology research has been conducted through
active measurement. For instance, Caida builds router level topolo-
gies on top of IP level traces obtained with traceroute. The result-
ing graphs contain a signiﬁcant amount of nodes with a very large
degree, often exceeding the actual number of interfaces of a router.
Although this property may result from inaccurate alias resolution,
we believe that opaque MPLS clouds made of invisible tunnels are
the main cause. Using Layer-2 technologies such as MPLS, routers
can be conﬁgured to hide internal IP hops from traceroute. Con-
sequently, an entry point of an MPLS network appears as the neigh-
bor of all exit points and the whole Layer-3 network turns into a
dense mesh of high degree nodes.
This paper tackles three problems: the revelation of IP hops hid-
den by MPLS tunnels, the MPLS deployment underestimation, and
the overestimation of high degree nodes. We develop new mea-
surement techniques able to reveal the presence and content of
invisible MPLS tunnels. We assess them through emulation and
cross-validation and perform a large-scale measurement campaign
targeting suspicious networks on which we apply statistical analy-
sis. Finally, based on our dataset, we look at basic graph properties
impacted by invisible tunnels.
CCS CONCEPTS
• Networks → Network measurement; Topology analysis
and generation;
KEYWORDS
network discovery; MPLS; traceroute; ﬁngerprinting; Internet
modeling
ACM Reference Format:
Yves Vanaubel∗, Pascal Mérindol‡, Jean-Jacques Pansiot‡, Benoit Donnet∗
∗ Monteﬁore Institute, Université de Liège – Belgium ‡ Icube, Université
de Strasbourg – France . 2017. Through the Wormhole: Tracking Invisible
MPLS Tunnels. In Proceedings of IMC ’17, London, United Kingdom, Novem-
ber 1–3, 2017, 14 pages.
https://doi.org/10.1145/3131365.3131378
x
Permission to make digital or hard copies of all or part of this work for personal or
classroom use is granted without fee provided that copies are not made or distributed
for proﬁt or commercial advantage and that copies bear this notice and the full cita-
tion on the ﬁrst page. Copyrights for components of this work owned by others than
ACM must be honored. Abstracting with credit is permitted. To copy otherwise, or re-
publish, to post on servers or to redistribute to lists, requires prior speciﬁc permission
and/or a fee. Request permissions from permissions@acm.org.
IMC ’17, November 1–3, 2017, London, United Kingdom
© 2017 Association for Computing Machinery.
ACM ISBN 978-1-4503-5118-8/17/11. . . $15.00
https://doi.org/10.1145/3131365.3131378
Since the end of the nineties, the Internet topology discovery
has been extensively investigated. Indeed, numerous analyses [18,
26] have been proposed to describe various types of connectivity
structures and representations of the Internet architecture. In par-
ticular, inferring the router level topology of IP networks is an im-
portant concern, notably to study routing characteristics. These
router level maps are obtained by grouping together IP addresses
collected with traceroute: this process is called alias resolution.
Inferring the architecture of an Autonomous System (AS) is also
crucial for analyzing the performance of routing protocols. Using
random graph models rather than realistic networking topologies
may result in biased or even wrong conclusions. For example, the
performance of fast-rerouting schemes or multipath transport pro-
tocols strongly depend on the underlying topology.
Typically, router level topologies are undirected graphs built
upon IP level traces obtained from traceroute; then, they can be
statistically analyzed [33]. In particular, the node degree distribu-
tion fascinates the research community, specially since the Falout-
sos et al. [21] seminal paper highlighting the power-law shape of
this distribution. However, one may observe a signiﬁcant amount
of nodes with a very large degree, often exceeding the actual num-
ber of interfaces of a router. For instance, Fig. 1 illustrates the de-
gree distribution of nodes in the Caida ITDK dataset [10] where
we observe a large amount of nodes having a very large degree.
This large amount of high degree nodes might be explained by
several factors. A traceroute campaign conducted from a lim-
ited number of vantage points can tend to induce a subgraph in
which the inferred node degree distribution does follow a power
law even if this is not the actual distribution [28]. Clauset and
Moore [16] have since demonstrated analytically that such a phe-
nomenon is to be expected for the speciﬁc case of the Erdös-Rényi
random graphs [20]. Second, others [31] have stated that high de-
gree nodes can emerge from Layer-2 (L2) clouds (such as Ethernet
switches). L2 devices interconnect a large number of Layer-3 (L3)
routers, themselves being also involved in multiple L2 interconnec-
tions. Such a situation induces nodes with very high degrees when
analyzing the L3 graph with traceroute probing.
In this paper, we investigate another reason for HDNs in the In-
ternet graph: opaque MPLS clouds hiding their content to trace-
route probing [19]. MultiProtocol Label Switching (MPLS) [35] is
a technology that has been designed to speedup forwarding deci-
sions (through exact label matching instead of longest preﬁx match-
ing on IP addresses) but is nowadays mainly deployed for provid-
ing IGP/BGP scalability, virtual private network (VPN) services [32],
and traﬃc engineering capability [37, 41]. It has been shown that
MPLS is largely deployed by operators [19, 36, 38, 39] thanks to
dedicated measures making use of MPLS transparency features:
IMC ’17, November 1–3, 2017, London, United Kingdom
Y. Vanaubel et al.
100
10−1
10−2
10−3
10−4
10−5
F
D
P
10−6
100
101
102
103
104
Degree
Figure 1: Node degree distribution in Caida ITDK dataset.
(i) the ability of MPLS routers to generate ICMP time-exceeded
packets with MPLS label information [9] and, (ii), the ability of
the TTL to be decremented (and thus making probing packets ex-
piring) within the MPLS tunnel [1]. This MPLS popularity is also
conﬁrmed by a survey we made between August 28th, 2017 and
September 12th, 2017. In the data collected (50 answers, from Stub
ISPs to Tier-1) through direct contacts with operators or the Nanog
community, it shows up that 87% of the surveyed operators deploy
MPLS. It has also been demonstrated that MPLS tunnels may have
an impact on Internet topology discovery tools [2, 6, 22].
Unfortunately, ISPs may want to hide, or, at least, not provide in
details the structure and the conﬁguration of their internal MPLS
networks. For VPN services, provider networks generally prefer to
simplify the routing view of their customers: they just see provider
equipment directly connecting their diﬀerent customer sites in-
stead of viewing all the provider internal architecture details. To
achieve this, they may restrict the deployment of MPLS transparen-
cy features, leading so to invisible MPLS tunnels [19] (i.e., the con-
tent of the tunnel is hidden to traceroute probes). Doing so, they
can avoid competitor networks to imitate their ﬁnely tuned cali-
bration and also avoid attackers to get knowledge of their internal
organization [24].
Consequently, the data obtained by researchers from traceroute
measurements is incomplete and the resulting Internet maps are
potentially biased. Indeed, as the content of the tunnel is hidden,
a direct, but false, link between the entry and exit points of the
tunnel is inferred. Further, an entry point of a MPLS network ap-
pears as the direct neighbor of all exit points. The whole L3 net-
work turns, then, into a dense mesh of high degree nodes [42].
It means that (i) current basic traceroute campaigns cause false
router-level links to be inferred (between two edge routers sepa-
rated by an invisible tunnel), that (ii) MPLS deployment in the In-
ternet may be underestimated (missing internal IP links), and that
(iii) node degree distribution, and other graph properties such as
density or clustering coeﬃcient, may be shifted to higher values.
Another reason for identifying invisible MPLS tunnel is to better
capture network delay anomalies [23]. Indeed, as the content of
the tunnel is hidden to traceroute, the delay between the entry
and exit point of the tunnel might appear as being artiﬁcially high,
possibly leading to wrong conclusion when tracking connectivity
issues.
In this paper, our aim is to ﬁx those issues by proposing new
probing mechanisms and analyses when exploiting IP level traces.
In particular, our contributions are threefold. First, we develop and
validate new active measurement techniques based on traceroute
and TTL estimation that are able to, at worst (and as long as the
UHP feature1 is not enabled), reveal the presence of invisible tun-
nels and to, at best, expose their content in standard conﬁguration
cases. All proposed techniques have been assessed through emu-
lation testbeds with GNS3, an emulator running actual IOS in a
virtualized router2 and through cross-validation. In particular, we
show that our algorithms are eﬃcient in roughly 86% of the cases.
Second, with our speciﬁc dataset collected with our measurement
mechanisms and its analysis, we are therefore able to improve the
MPLS knowledge of the research community and provide an in-
sight on ISPs standard and common practices. Finally, and as an
illustration of our contribution purpose, we show how to improve
classical Internet topology models by correcting the biases in terms
of node degree, route length distributions, and graph density. Our
dataset and GNS3 conﬁguration scripts are freely available.3
The remainder of the paper is organized as follows: Sec. 2 pro-
vides the required background for this paper. Sec. 3 is the heart of
the paper as it presents and validates our measurement techniques
to reveal the content of invisible MPLS tunnels. Sec. 4 explains
how we deploy our measurement techniques in the wild, while
Sec. 5 presents the results. Sec. 6 discusses, based on the data we
collected, the ISPs standard practices in deploying MPLS tunnels.
Sec. 7 reviews a few basic Internet modeling features based on re-
vealed invisible MPLS tunnels. Finally, Sec. 8 concludes this paper
by summarizing its main achievements.
2 BACKGROUND
2.1 MPLS
MPLS routers, i.e., Label Switching Routers (LSRs), exchange la-
beled packets over Label Switched Paths (LSPs). In practice, those
packets are tagged with one or more label stack entries (LSE) in-
serted between the frame header (data-link layer) and the IP packet
(network layer). Each LSE is made of four ﬁelds: an MPLS label
used for forwarding the packet to the next router, a Traﬃc Class
ﬁeld for quality of service, priority, and Explicit Congestion Noti-
ﬁcation [3], a bottom of stack ﬂag bit (to indicate whether the cur-
rent LSE is the last in the stack [34]), and a time-to-live (LSE-TTL)
ﬁeld having the same purpose as the IP-TTL ﬁeld [1] (i.e., avoiding
routing loops).
The ﬁrst MPLS router (the Ingress Label Edge Router, or Ingress
LER, i.e., the tunnel entry point) adds the label stack, while the
last MPLS router (Egress Label Edge Router, or Egress LER, i.e., the
tunnel exit point) removes the label stack (Ultimate Hop Popping,
UHP, where the Egress LER advertises an explicit null label – label
value of 0 [34]). In practice, and in most cases (at least this is the
default conﬁguration), the top LSE is removed by the penultimate
LSR, that we call the Last Hop (LH). This operation is called Penul-
timate Hop Popping (PHP) and is activated by the Egress LER when
it advertises an implicit null label (label value of 3 [34]). Since the
top LSE has been removed by the Last Hop, the Egress LER per-
forms then only a classic IP lookup to forward the traﬃc. It allows
1See Sec.2 for MPLS technical details about Penultimate Hop Popping (PHP) and Ul-
timate Hop Popping (UHP).
2See https://gns3.com/
3See http://www.monteﬁore.ulg.ac.be/~bdonnet/mpls
Through the Wormhole: Tracking Invisible MPLS Tunnels
IMC ’17, November 1–3, 2017, London, United Kingdom
FORWARD
Figure 2: GNS3 topology. AS2 is a transit AS with MPLS enabled (labels distributed with LDP). PE1 acts as Ingress LER, PE2 as
Egress LER, and Pi are LSRs. CE2 is the traceroute destination. Notation Pi .left refers to left interface of router Pi (the same
applies for CEj and PEk ). PHP is applied by P3.
thus to reduce the load on the Egress LER, especially if it is the
root of a large LSP-tree. This means that, when using PHP, the
last MPLS operation (i.e., popping) is performed one hop before
the Egress LER, on the Last Hop. On the contrary, UHP is gener-
ally used only when the operator implements sophisticated traﬃc
engineering operations. This is conﬁrmed by our survey as UHP
is only deployed by 10% of the operators. Fig. 2 illustrates, among
others, the main vocabulary associated to MPLS tunnels.
Labels may be allocated through the Label Distribution Protocol
(LDP) [4]. Each LSR announces to its neighbors the association be-
tween a preﬁx in its routing table and a label it has chosen. There-
fore, labels are allocated from downstream and, for a given preﬁx, a
router advertises the same label to all its neighbors. Depending on
the implementation, LDP may advertise a label for all preﬁxes in its
IGP routing table (default case for Cisco routers [17, Chap. 4], [8])
or only for loopback addresses (default case for Juniper routers [8]).
LDP is mainly used for scalability reasons (e.g., to limit BGP-IGP in-
teractions to edge routers) as deployed tunnels are congruent with
the IGP. Labels can also be distributed through RSVP-TE [7], when
MPLS is used for Traﬃc Engineering (TE) purposes. In practice,
most operators consider the use of RSVP-TE in addition to the use
of LDP. This is conﬁrmed by our survey. While LDP-only is used
by 50% of the operators, RSVP-TE is used alone by only 8% of the
operators. RSVP-TE and LDP are used in conjunction by 42% of
the operators. Note that only a single operator considers another
labeling protocol.4
2.2 Measuring MPLS Tunnels
LSRs may send ICMP time-exceeded messages when the LSE-
TTL expires. If the LSR implements RFC 4950 [9] (as it should be
the case for all recent OSes), it simply quotes the MPLS LSE stack
of the received packet in the ICMP time-exceeded message.
If the Ingress LER copies the IP-TTL value to the LSE-TTL ﬁeld
rather than setting the LSE-TTL to an arbitrary value such as 255,
LSRs along the LSP will reveal themselves via ICMP messages, even
if they do not implement RFC4950 (in such a case they do not quote
the LSE but just reveal their incoming IP address). Operators can
conﬁgure this transparency operation using the ttl-propagate
option provided by the router manufacturer [1] (while, to the best
of our knowledge, RFC4950 compliance is just a matter of imple-
mentation, and cannot be deactivated on recent OSes supporting
4Probably for Segment Routing as LDP or RSVP-TE are not required to distribute
labels in this case [14, Chap. 1, pg. 2].
Router Signature Router Brand and OS
Cisco (IOS, IOS XR)
Juniper (Junos)
Juniper (JunosE)
Brocade, Alcatel, Linux
Table 1: Summary of main router signature, the ﬁrst initial
TTL of the pair corresponds to ICMP time-exceeded, while
the second is for ICMP echo-reply.
it). Donnet et al. [19] have discussed in detail the impact of those
two features (i.e., RFC4950 and ttl-propagate) on MPLS tunnel
discovery based on traceroute.
In this paper, we focus on invisible MPLS tunnels, i.e., tunnels
that are completely obscured from traceroute: the Ingress LER
does not enable the ttl-propagate option, and the last hop does
not send back an ICMP time-exceeded message (that may embed
a MPLS LSE). Due to the PHP feature (with UHP the tunnel is even
more invisible than with PHP), the last hop is the LSR in charge of
converting the MPLS data packet into a standard IP one. It does not
send back neither a RFC4950 nor a standard ICMP error message,
because it does not decrement the IP-TTL. As a matter of fact, the
last hop considers now this transit packet as an IP one, and simply
pushes it to the Egress LER that will decrement the IP-TTL. Hence,
all IP hops inside the tunnel are hidden, and the topology informa-
tion is missing from traceroute exploration, providing so a biased
view of the network. This is illustrated in Fig. 2 and Fig. 4d (for the
Paris traceroute [5] output) when performing a traceroute from
the Vantage Point towards the target, CE2 in AS3. In our survey,
a surprising large share of 48% of the operators make use of the
no-ttl-propagate option.
2.3 Network Fingerprinting
Vanaubel et al. [40] have presented a router ﬁngerprinting tech-
nique that classiﬁes networking devices based on their hardware
and OS. This method infers initial TTL values used by a router
when generating its diﬀerent kinds of reply packets. It then builds
the router signature, i.e., the n-tuple of n initial TTLs. A basic pair-