==== 多表关联
选择"多表关联"，进入数据透视流程第一步。
在页面左侧选择具体的某个数据集节点，拖拽到右侧"请拖入数据集"区域内，释放鼠标，该数据集将作为关联查询的主查询。
然后在页面左侧选择准备作为子查询的另一个数据集节点，拖拽到右侧主查询节点的方框上，释放鼠标，系统会自动将两个数据集关联起来。
最后，需要点击两个数据集连线上的小图标，进行关联关系配置，包括关联字段和关联方式。目前日志易支持左关联和内关联，关联字段可以设置一到多个。
image::images/pivot-join.png[]
如上图所示，关联关系可以并行，也可以串行。所以您可以拖入多个数据集，组成复杂的关联网络。
如果需要删除某个关联数据集，在页面左侧再次点击该数据集，就可以直接反选删除。
多表关联方式同样支持过滤设置。但过滤设置是基于每个数据集的，所以您必须具体选择画布上某个数据集节点以后，再针对性的配置过滤条件。
完成配置以后，同样可以在页面右上角点击查看 SPL。也可以点击"数据概览"，查看多表关联以后的 SPL 查询结果。如果不满意，您可以点击"数据集操作"返回拖拽画布进行修改。
image::images/pivot-join-preview.png[]
如果关联数据以后还会经常使用，您可以点击"保存为数据集"，将这段 JOIN 语句单独保存为一个新的数据集，后续可以直接基于这个新的数据集直接进行查询和图表配置。
点击下一步进入图表配置，该步骤和基于单个数据集的操作完全一致，请参见上一节。
==== 追加合并
选择"追加合并"，进入数据透视流程第一步。
在页面左侧选择具体的某个数据集节点，拖拽到右侧"拖入数据集到此加入表格"区域内，释放鼠标，该数据集将作为追加合并的主查询。数据集的字段列表自动成为表格的表头。
然后在页面左侧选择准备作为子查询的另一个数据集节点，继续拖拽到右侧"拖入数据集到此加入表格"区域内，释放鼠标，该数据集将自动追加到主查询的后面。
当两个数据集的字段列表中存在同名字段时，这两个字段会自动成为表格中的同一列，否则，子查询的新字段名会成为表格的新一列。
image::images/pivot-append.png[]
如上图所示，系统支持追加合并多个数据集节点。所以您可以拖入多个数据集，组成复杂的合并表格。
您可以拖动表格中的单元格，进行列的拆分和合并。当您要拆分一列时，您可以拖拽单元格到表格最后的虚线区域释放，但必须重新给新的一列取一个字段名，表格不允许存在两列同名字段：
image::images/pivot-append-new-col.png[]
当您要合并一列时，您可以拖拽单元格到本行目标列的位置释放，但前提是该位置目前并没有其他字段占据。释放以后，同一列的不同单元格内字段名称不一致，默认将继续使用之前的表头名称，您可以点击表头，进行修改。
追加合并方式同样支持过滤设置。和关联查询一样，过滤设置是基于每个数据集的，所以您必须在表格第一列选中某个数据集节点后，再针对性的配置过滤条件。
数据概览、保存为数据集、图表配置等功能，和关联查询方式一致，请参见上一节。
=== 单个透视表的外嵌
成功创建的透视表，除了用于系统内部的仪表盘，报表等，还可以用于外部嵌入。具有该透视表的可转授权限的用户，可以在操作列里看到"展示趋势图"，点击此按钮，则趋势图在新的标签页展示，URL可以嵌入在第三方软件。
image::images/pivot-url-embed.png[]
系统还支持在URL中自定义部分展示参数，下面这些参数全部选填：
* username：用户名
* password：密码，进行md5加密后的结果
* sign：用户名+加密后密码进行md5加密的结果（username，password，sign这三个参数任何一个不填，会取session里的用户信息，如果填了验证失败，会报403错误）
* title：标题（无默认值，无标题时下面三个参数不生效）
** fontSize：标题字体大小（默认14，无单位）
** fontColor：标题字体颜色，jsonArray，非jsonArray取默认值，颜色无效取默认值，默认为 `{ day:'#4a4a4a', night:'#fff' }`
** fontPadding：标题字体间隔（有单位，默认12px，可填8px 16px 8px 12px代表上右下左的padding）
* width：图的宽度（默认100%，可填如500px）
* height：图的高度（默认100%，可填如500px）
* padding：页面padding大小（有单位，默认16px，可填8px 16px 8px 12px代表上右下左的padding）
* color：背景颜色，jsonArray，非jsonArray取默认值，颜色无效取默认值，默认为 `{ day:'#fff', night:'#4a4a4a' }`
* placeholder：无数据时页面文字，默认值为"暂无数据"；有页面文字时，可以通过下面参数自定义展示效果
** placeholderColor：placeholder字体颜色，jsonArray，非jsonArray取默认值，颜色无效取默认值，默认为 `{ day:'#4a4a4a', night:'#fff' }`
** placeholderSize：placeholder字体大小（默认14，无单位）
** placeholderMargin：placeholder间隔（有单位，默认0 16px，可填8px 16px 8px 12px代表上右下左的margin）
* dayNightMode: 选填'day'或'night'
=== 趋势图自动加速
由搜索统计或透视表创建的趋势图，后续可以在仪表盘、报表中重复使用。如果这个趋势图覆盖的查询范围较广，查询完成时间较长，查询频率又较高，日志易提供自动加速功能，帮助趋势图在后续查询时，以更快速度完成统计。
趋势图开启加速后，日志易后台程序会自动拆解趋势图查询语句，在引擎层自动调度，按不同时间粒度构建查询的预聚合结果。后续再访问该趋势图时，引擎会直接从预聚合结果中提取数据，而不用重新读取原始索引数据，最终达到加速效果。
==== 趋势图加速限制
为了较好的利用预聚合加速，而不是反向增加引擎读写负担，日志易对趋势图加速功能做了一定的限制：
. 趋势图查询语句必须是统计类型。即包含 stats、top、chart、timechart 指令。
. 在上述统计指令之前如果有其他 SPL 指令，必须是分布式流式类型，如 eval、parse、where 等。注意：统计指令之后的 SPL 指令类型不限。
. 搜索配置不可设置为高基模式，不可配置分片取样数。
. 目前仅限于 `_admin_` 角色用户，有权开启趋势图加速功能。
此外，对一些 id 类的高基数字段做分组统计，从语法层面可以加速，但加速效果不佳，也不建议用户使用。
==== 开启趋势图加速
完成透视表趋势图配置时，在查询语句满足限制条件的情况下，可以点击“趋势图加速”按钮开启加速。对已经配置完毕，或来自搜索页 SPL 统计可视化保存的趋势图，可以在趋势图列表页，点击右侧“更多”菜单，选择“趋势图加速”项，开启加速。
image::images/open-trend-acceleration.png[]
按需配置加速时间范围，点击保存即可。
===== 加速范围粒度拆分
日志易目前支持的加速时间范围包括：所有时间，一年，3个月，1个月，7天，1天。
引擎将自动拆分所选的时间范围，做更细粒度的预聚合结果存储，并自动每 10 分钟更新/淘汰一次。对应的粒度拆分说明如下：
* 所有时间：每个月
* 一年：每一天（365份数据）
* 3个月：每一天（90份数据）
* 1个月：每半天（60份数据）
* 7天：每小时（168份数据）
* 1天：每十分钟（144份数据）
后续搜索时，引擎将自动圆整和对齐查询范围，能命中预聚合结果的，直接使用加速速度，未能命中预聚合结果的，依然查询原始数据。
例如，针对 `* | stats count()` 设定了加速范围 1 天并构建完成。当天中午 12:23 分，用户查询最近 2 天的 `* | stats count()`，引擎将自动拆分为三部分：
. now-2d, 昨天12:20：超出加速范围，查询原始数据
. 昨天12:20, 12:20：命中加速范围，使用加速数据
. 12:20,now：尚未构建，查询原始数据
最后，将三部分的结果合并处理，返回给用户。
==== 管理加速任务
趋势图加速任务需要额外占用一部分引擎计算资源和存储空间，并且受相关资源配置变更影响，还会触发额外的数据重新构建。因此，系统管理员们需要密切关注加速任务的状态，即时回收不必要的资源耗用。在趋势图列表页右上角，点击打开加速任务管理页面。
image::images/trend-acceleration-list.png[]
由于趋势图加速功能在搜索引擎存储节点上完成，统计指令后的二次处理并不影响加速数据，所以不同趋势图的查询，可能复用同一份加速任务和加速数据。在管理列表上，用户可以查看加速任务对应了具体哪些趋势图。
此外，管理列表上还展示了加速数据被访问的次数，最近一次访问加速数据的仪表盘或报表资源名称，及其访问时间。注意：周报月报本身执行间隔较大，不要仅依据最后访问时间来简单判定加速性价比。
管理列表上单独展示了加速任务的构建状态和构建耗时占比。为了保护系统资源，日志易默认在每个数据节点上，仅启用一个独立线程负责运行加速任务。如果某个加速任务在较长时间内一直无法达到 100% 构建完成状态，有可能是总体资源受限，请考虑调整 `report_disk_thresh_per_conf_index_mb`、`report_result_memory_threshold_mb` 配置，或删除不必要的加速任务释放资源。构建耗时占比计算单次构建耗时与构建间隔的比例。比如，每 10 分钟构建一次，每次耗时 1 秒，则占比为1/600。一个加速任务的构建耗时占比越高，则其他任务的可用耗时越少。
点击加速任务 ID，可以查看加速任务详情，并进行删除操作。除列表上已有信息外，还包括有加速数据的实际磁盘占用大小：
image::images/trend-acceleration-detail.png[]
===== 加速重构建
除了正常的数据更新以外，还有一些情况，会导致加速任务放弃原来的全部数据，重新开始构建：
* 趋势图语句发生变化
* 趋势图语句关联的数据集发生变化(增减数据集和语句变化)
* 趋势图语句引用的搜索宏语句发生变化
* 趋势图归属应用关联的自动提取规则发生变化
* 相关索引数据被执行了 delete 指令
* 集群扩缩容导致数据分片重均衡到其他设备上
建议用户在系统场景相对稳定的前提下，再规划和使用趋势图加速。
<<<