④车机启动后向服务器发HTTP
ET请求获取命令数图
服务器返团开门命令数型给车机
车机执行开门电令
图8-10利用手机应用开启车门的工作流程
比较令人惊讶的是汽车与后台的通信数据可以轻易地通过DieterSpaar搭建的测
试基站环境获取，没有任何问题，这辆车发送了一个简单的HTTP请求，传输中并
不存在SSL或TLS加密。
为了弄清楚Combox需要从服务器获得什么信息才能打开车门，首先通过手机应
用发送开门指令，这样服务器就会将汽车需要的开锁指令数据准备好以便汽车收到
短信后去请求，然后进行短信的重放攻击。经过测试这样可以打开车门。
从服务器请求的数据也是加密的，采用的协议还是NGTP，但是采用了与之前短
信不同的加密和签名算法。加密采用了AES128而不是DES，消息签名（实际上是
消息认证码MessageAuthenticationCode）采用了HMAC-SHA256而不是DES
CBC-MAC，所使用的密码池（或者叫密码表）还是相同的。
经过以上分析，现在已经掌握了足够的信息伪造开门的所有环节。DieterSpaar
只需要通过一台笔记本和一个基站就可以伪造短信和服务器开门，即通过基站发送
短信，然后使用笔记本伪造成宝马后台服务器在汽车请求开锁数据时将数据发给汽
车，如图8-11所示。
现在最重要的问题是在实验车辆的通信模块中提取出的密钥是否能够用于其他
车辆，经过对其他汽车进行测试发现的确可以。在研究过程中还有另外一些发现，
即如果汽车的ConnectedDrive远程控制功能未激活，则远程开门无法实现，但可以
通过测试蜂窝网环境（即基站）来激活远程控制功能，从面进一步实现远程开门等
攻击。
171
---
## Page 182
智能汽车安全攻防大揭秘
假的基站
假的服务器
1.发送短售
4.开启车门
图8-11攻击场景
8.4
激活远程控制功能
激活远程控制功能的流程和前面开门的流程类似，开通ConncctedDrive远程控
制功能的流程如图8-12所示。
1.用户在网站申调
1
2.服务器发远服务开
开通服务
3.汽车向服务器请求
通短信
配置文件
2
服务器返回配置文
3
图8-12开通ConnectedDrive远程控制功能的流程
（1）首先，用户在宝马的网站上注册并申请开通远程控制服务。
（2）服务器给汽车发送激活短信。
（3）汽车HTTP-GET向服务器请求配置文件，配置文件是很容易理解的XML
格式并且没有加密或者签名，也就是说配置文件完全没有防募改机制。
（4）汽车根据配置文件进行配置。
（5）服务开通成功。
172
---
## Page 183
第8章宝马ConnectedDrive漏润分析
机智的读者可能已经看出来了，由于XML格式的配置文件没有加密或者签名，
可以通过像之前伪造开门命令一样的方式伪造。所以，针对没有开通ConnectedDrive
远程控制的汽车可以先通过这种方式开通远程控制功能，然后打开车门，
车辆对每条发送至自己的消息都通过VIN（汽车的唯一识别码）进行了目的地
址验证（即验证这个消息是否为发送给自己的）。如果消息里的VIN没有匹配自己的
VIN，就不会执行命令。这个验证对攻击者来说并没有什么阻碍，因为Combox在收
到包含错误的VID的消息后会返回一个包含自己正确VID的错误消息，如图8-13
所示。
图8-13信息通信模块
在研究中，最新款的宝马车型中一些车型的Combox已被其他控制设备取代。多
媒体和免提功能都已经被整合到车机中，而且基站通信由远程信息通信盒（TCB，
TelematicsCommunication Box）负责。TCB除了支持GPRS/EDGE连接之外，还支
持UMTS.TCB忽略包含错误VIN的信息，也就是说，在收到包含错误VIN的信息
后不做任何动作，即不会像Combox那样在错误消息里发送正确的VIN，但通信的
加密依然使用所有的车辆都相同的已知密钥，所以攻击之前得想办法得到正确的
VIN.
8.5实际漏润利用场景
伪造基站网络来解锁所需设备只需要一个背包能装入。伪造的基站（即IMSI
Catcher）的覆盖范围可达到100米以上，即使在市中心也是如此。IMSICatcher在这
个区域中会提供比实际移动网络更强的信号，导致手机会优先选择接入伪造网络。
IMSICatcher并不需要知道目标车辆的电话号码（即通信模块的号码），它使用的是
TMSI（临时移动用户识别码），这是在汽车接入伪造网络时由它分配的。如果目标车
173
---
## Page 184
智能汽车安全攻防大揭秘
辆使用了TCB模块，攻击者不得不屏蔽该区域现有的UMTS（即所谓的3G）信号来
使TCB降级使用GSM（即所谓的2G）。
因为不是只有具有ConnectedDrive功能的车辆会加入伪造的网络，所以有必要
通过IMEI（Intermational Mobile Equipment Identity，移动设备国际身份码）码过滤目
标，IMEI是分配给所有的移动设备（包括蜂窝网通信模块）的唯一序列号。IMEI
的前八个字符是TAC（TypeAllocationCode），TAC表明了设备的型号。通过TAC
攻击者可以区别Combox或TCB。
知道某辆车有Combox后可以通过前面讲的方式进行攻击，但是如果是TCB，
由于TCB不会返回错误信息（同时返回正确的VIN），所以要攻击需要先想办法拿
到VIN，如图8-14所示。
VIN
图8-14VIN 的位置
VIN一般可以透过挡风玻璃看到，或者出现在车门框上，这样可以在有人下车
时拍到。通过这种方式打开车门并不会留下任何痕迹并且即使在街道上也完全不会
引起其他人的注意。
8.6改进措施
由于漏洞的根本原因是密钥的分发和保存问题，要想修复问题就需要针对这两
个问题来解决。
针对密钥分发问题，同样的密码列表被不同的汽车采用，在其中一辆汽车中提
取出来的密钥可以用于解密其他车辆的通信数据，这是非常不安全的，所以要针对
每辆汽车设置不同的密码表，这样的实现难度是非常高的。
密钥保存问题、硬件破解意向是非常难以防护的问题，同时也是非常难以修复
的，因为硬件不像软件那样容易升级，面且就算可以升级其成本也非常高。本案例
174
---
## Page 185
第8章宝马ConnectedDrive漏润分析
中攻击者通过读取Flash芯片内的内容得到了固件，为了防止这种情况发生可以采取
一些硬件安全措施（比如对固件进行加密），在机器启动时再进行解密。
漏润修复措施是汽车与厂家服务器之间采用的通信采用了htps对通信双方进行
了身份认证并对通信数据进行了加密。
8.7漏洞总结
车辆厂家已经通过网络对车辆进行了升级，加入了对服务器证书的检查。
总结整个研究过程，ConnectedDrive一共出现了6个漏洞。
（1）宝马在所有车型中使用了相同的对称密钥。
（2）有些服务没有对车辆与宝马后端服务器之间传输的信息进行加密。
（3）ConnectedDrive配置数据没有采用防墓改机制。
（4）Combox通过NGTP错误信息暴露了正确VIN。
（5）通过短信发送的NGTP数据采用了不安全的DES算法进行加密。
（6）Combox没有针对重放攻击采取防护措施。
这些问题本来可以轻易避免。例如，本来有加密机制却只在某些ConnectedDrive
服务上使用。再例如，既然厂家可以为每辆汽车设置不同的VIN（例如烧写在固件
里），就同样可以为每辆汽车设置不同的密钥。
宝马研发中心的KlausBottner博士曾表示，宝马公司对远程控制服务的安全及
授权访问格外重视。他指出，宝马所有的远程控制服务都部署在自已的安全后端。
此外，车辆即使在授权的情况下也仅执行一些预设的动作。这些说法在理论上都没
有问题，但问题往往出在细节上。
8.8可行的防御措施
以下是作者根据每个漏润给出的可行的防御建议。
中（）
解决方法：可以为每辆汽车设置不同密钥。
（2）有些服务没有对车辆与宝马后端服务器之间传输的信息进行加密。
解决方法：加密。
175
---
## Page 186
智能汽车安全攻防大揭秘
（3）ConnectedDrive配置数据没有采用防募改机制。
解决方法：对配置数据进行数字签名。
（4）Combox通过NGTP错误信息暴露了正确VIN。
解决方法：不要返回像VIN这种重要的信息。
（5）通过短信发送的NGTP数据采用了不安全的DES算法进行加密。
解决方法：升级加密算法，采用安全的加密算法。
（6）Combox没有针对重放攻击的防护措施。
解决方法：对数据加入序列号并签名。
其实，以上问题可以通过完整的加密来解决，最好的办法是在服务器端和客户
端都通过证书建立安全信道。
8.9本章参考资料
[1]  http://www.heise.de/ct/artikel/Beemer-Open-Thyself-Security-vulnerabilities-in-
BMW-s-ConnectedDrive-2540957.html
[2] https:/en.wikipedia.org/wiki/Type_Allocation_Code
[3] http://wenku.baidu.com/view/eb1a5c1014791711cc79170a.html
[4] https://en.wikipedia.org/wiki/Data_Encryption_Standard
[5]  http:/f10.5post.com/forums/showthread.php?t=613734
[6]  http://f30.bimmerpost.com/forums/showthread.php?t=921688&page=14
[7] http://www.6post.com/forums/showthread.php?t=954040
[8]  http://5series.net/forums/e60-parts-accessories-mods-22/balbs'-cic-retrofit-w%5
Ccombox-6nr-pnp-123560/
[10] https://www.engadget.com/2015/01/31/bmw-connected-drive-patch/
176
---
## Page 187
第9章特斯拉安全性分析
9.1背景
特斯拉汽车一直受到黑客的关注，很多安全研究人员都尝试过挖掘特斯拉汽车
的漏洞，主要原因是特斯拉是纯电动汽车并且有网络连接，可以通过网络对汽车进
行控制，而且特斯拉本身也非常依赖电子控制系统。本节就来分析特斯拉已经出现
过的问题。此漏洞已经修复，在本章进行分析只是为了让读者了解漏洞原理以便应
用到工作中，使汽车变得更安全。
一直以来特斯拉被认为比其他具有网络连接功能的汽车更安全，可以作为联网
汽车的楷模，尽管特斯拉时不时被爆出一些小BUG。例如，2015年8月的黑客大会
DEFCON上，安全研究人员MarcRogers和KevinMahaffy分享了他们对特斯拉
ModelS的研究成果，他们在研究过程中找到了6个问题，通过这些小BUG可以以
物理入侵（不是远程入侵）的方式控制汽车。接下来，我们就介绍他们这项研究的
过程。
9.2系统架构
图9-1所示为特斯拉ModelS的信息娱乐系统架构。
177
---
## Page 188
智能汽车安全攻防大揭秘
图9-1特斯拉Model S倍息娱乐系统架构（图片来源lookouL.com）
ModelS的娱乐及信息系统和控制器CAN网络是隔离的，娱乐信息系统的各个
模块之间通过一个局域网进行通信，而汽车的各个控制器（如动力刹车等）通过CAN
通信，娱乐系统与CAN之间通过网关连接。
首先来看看ModelS信息娱乐系统的几个模块，分别是仪表板、中央信息显示和
网关，其中仪表板和中央信息显示两个模块都运行版本比较老的Ubuntu操作系统，
网关运行开源的实时操作系统FrceRTOS。
（1）仪表系统又叫仪表盘IC（InstrumentCluster），是位于方向盘正前方的一个
8英寸的屏幕，运行UbuntuLinux操作系统，处理器是NVIDIATegra3，如图9-2所示。
图9-2被拆下来的仪表
178
---
## Page 189
第9章特斯拉安全性分析
（2）中央信息显示模块CID（CentralInformationDisplay），就是汽车中央的17
英寸大屏，运行UbuntuLinux操作系统，处理器是NVIDIATegra4，如图9-3和图
9-4所示
图9-3CID内部
图9-4CID背面
（3）网关（Gateway）：连接信息娱乐系统与控制器网络，与CID集成在一起，
运行FreeRTOS操作系统。图9-5所示为ModelS整个网络的架构。
WiFL
C+
网络接日
内网
系统
Perrot
Gsierre
中控板
仅表
网关
汽车控制器
Vehiele
hYDIA Tg
s.NnSA Tgo
诊断接口
ServicePort
Etheraet Switch
CANBus
以太网网关
CAN总线
图9-5ModelS的网络架构
这种将汽车的控制器网络与娱乐信息系统进行隔离的网络架构是非常优秀的设
计，因为娱乐信息系统有丰富的网络连接，当黑客入侵娱乐系统后还需要通过网关
才能控制汽车的关键部件[例如，行驶安全相关的部件（如电动转向、电子刹车等）]。
179