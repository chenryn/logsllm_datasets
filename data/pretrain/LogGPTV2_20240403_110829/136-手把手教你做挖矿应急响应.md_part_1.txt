手把手教你做挖矿应急响应
原创先锋情报站 酒仙桥六号部队
2020-12-25原文
这是 酒仙桥六号部队 的第 136 篇文章。
全文共计4995个字，预计阅读时长15分钟。
前言
攻防之道，攻是矛，防是盾。应急响应就是防守中最重要的一环，
思路清晰的应急响应可以使你事半功倍，抓住攻击者的小尾巴！
本文主要面向无应急基础人员入门引导，大佬轻喷！！！
文中会引用几次我经历过的真实挖矿事件案例，如有侵权请及时联
系我们。
开篇
CPU占用高？电脑卡的要命？又被挖矿了？我人傻了！
来跟我一起看看被挖矿了如果处置吧。
不想看文字的大佬请看下图：挖矿木马处置流程一览图
接下来废话不多说，详细的流程在下给各位看官准备好了，请看！
一、询问攻击情况范围
事件发生时的状况或安全设备告警等，能帮助应急处置人员快速分
析确定事件类型，方便前期准备。
1、了解现状
询问客户或销售事件发生时状况，举个栗子~
客户发现安全设备告警存在挖矿网站访问情况，像这个样子.
初步判断是有机器被植入挖矿病毒了，此处可以根据外部连接地址
收集相关情报，如果有相关分析文章会轻松许多。
2、了解事件发生时间节点
出现问题时间、发现问题时间、处置问题时间，确定这三个时间节
点后，可通过时间相关性推算挖矿病毒产生大致时间，有助于后续
挖矿病毒发现及清理。
3、临时抑制挖矿
到达客户现场前：
在不影响主业务运行的情况下，对受害机器：拔网线啊！拔网线啊
！拔网线啊！
绝大部分实际情况与预期并不一致，在没到达客户现场前，及时切
断网络连接是最简单有效的抑制手段。
并且，切断网络连接可使挖矿现场尽量保持完整，有助于接下来的
溯源工作顺利开展。
当然，对于情况较清晰的挖矿场景，已知挖矿外连地址及域名等信
息，可采用防火墙建立策略封禁双向通信的方式抑制挖矿运行。
4、获取网络构架
网络构架一般来讲是要拓补图，虽然一般没有（有拓扑的也不想给
），但一定要委婉的要拓补图！要拓补图！要拓补图！
详细的拓扑图可以协助还原攻击流程时，准确定位网络连接方向。
二、攻击痕迹挖掘
挖矿攻击者为了达到不被发现的目的，各种手段层出不穷，溯源的
过程就是和挖矿攻击者博弈的战争。
可以大致从以下几个方面入手：可疑进程、开放的端口、计划任务
、服务项、可疑的用户、内存空间还有最明显的特征：CPU占用高
1、CPU占用
CPU占用高是挖矿时常见的状态，因为挖矿需要占用大量CPU调用挖
矿进程，虽然近些年挖矿有偏向于GPU的趋势，但挖矿木马中还是主
要以CPU挖矿为主，毕竟不是专门做渲染的服务器GPU一般很低。
Windows中查看CPU可以直接通过任务管理器中查看利用率。
Linux可使用top命令获取实时CPU占比情况：
关于查看CPU这里提一个之前遇到过的有意思的挖矿守护机制：
某次挖矿应急中，习惯性打开任务管理器查看CPU占用情况，发现占
用本身很高，但一会就降下来了。开始还以为是任务管理器开启导
致的，之后分析病毒样本的时候才发现是一种守护方式。
判断开启任务管理器等调试工具时，会把挖矿进程杀死，然后等待1
80秒后强制关闭调试工具再进行挖矿。所以通过dos命令查看Windo
ws系统CPU占用率：
Windows 可 使 用 wmic 方 式 获 取 CPU 占 用 ： wmic cpu get
LoadPercentage /value
Windows命令方式查看CPU占用
2、可疑进程
Windows中有多种进程分析工具，可辅助快速定位异常进程。这里
简单举例几种分析进程工具：Autoruns、PCHunter、ProcessDum
p、processhacker、ProcessExplorer、火绒剑等等，各有优劣
，此处不再赘述，各位师傅自行体会。
大概样子长这样：
使用进程分析工具查看可疑进程
若无法上传工具时，可以通过CPU占比高的进程PID进行相关检索。
Linux中的可以通过top命令获取到高占用进程PID及文件路径，也
可使用：
ps -aux --sort=-%cpu|head -10--显示cpu占比前10的进程
其他CPU占比不高的进程可以通过：
ps -auxf--用树形结构显示进程相关性
通过外连情况排查进程：
lsof -i--查看所有网络连接进程
通过PID查看文件位置
ls -la /proc/[ 进 程 PID]/exe--
替换“进程PID”查看进程可执行程序位置
lsof -c [进程名]--进程正在使用的文件和网络连接
通过以上命令，若发现CPU高占用或者非正常外连进程，则可能为恶
意进程。
3、开放的端口
Windows 和 Linux 均 可 使 用 netstat -
ano查看一下端口情况，是否开启高危端口，存在可能被利用风险。
有时攻击者使用端口转发将流量转发出内网，可以在此处看到有可
疑的对外监听端口。
查看端口占用情况
4、计划任务及启动项
挖矿病毒为了使挖矿进程一直运行，会做出各种各样的守护方式，
计划任务就是最普遍的守护方式之一。
Windows7使用at命令；Windows10使用schtasks命令查看计划任
务列表。
开始--所有程序--启动目录中存在的文件也不能放过。
Linux 系 统 使 用 crontab -
l命令查看计划任务，但还是建议直接查看/etc/crontab文件，也
可在/var/log/cron下查看计划任务的日志。
某次Linux挖矿事件计划任务日志
其他可能存在定时任务需要排查的路径
/var/spool/cron/*
/var/spool/anacron/*
/etc/crontab
其他可能存在定时任务需要排查的路径
/etc/anacrontab
/etc/cron.*
/etc/anacrontab
/etc/rc.d/init.d/
5、服务项
同上，服务也是挖矿病毒常见的守护方式之一，将注册表中服务启
动方式写为挖矿病毒主程序，从而达到守护进程目的。
Windows系统中使用：开始--运行--输入services.msc
Linux 系 统 中 使 用 ： systemctl list-unit-files --type
service |grep enabled
某次Windows挖矿事件利用服务守护挖矿进程方式
6、可疑的用户
攻击者有时会创建自己的账户，用来隐藏自己的恶意行为。
Windows中创建用户后，利用账户进行一系列隐藏操作，创建影子