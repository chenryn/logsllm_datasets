S  U  B  O  R  N  E  R 
A Windows Bribery for Invisible Persistence
Sebastián Castro
@r4wd3r
R 4 W S E C . C O M 
Singapore
August 25 - 26, 
2022
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W H O A M I
Username
r4wd3r
Full User name
Sebastián Castro
Comment
Infosec nerd, stuff breaker ~10y
User’s comment
Terrible at MS Paint :(
First logon
1993/05/03  23:56
User profile
Ph. D. CSE Student  UCSC
PSO R&D Co-op  AMD
Presenter  BlackHat, BSides, 
Derbycon, Romhack, SEC-T…
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
I, Sebastian Castro, solely and exclusively own the property rights of the
research “Suborner: A Windows Bribery for Invisible Persistence”. I hereby do
not concede any property rights to my previous, current and future employers
unless I voluntarily choose to transfer such property, in total, or in part.
The opinions expressed here are my own and not necessarily those of my
employers.
D I S C L A I M E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C K N O W L E D G E M E N T
This is only possible thanks to:
∙ Family and friends 
∙ Research done before by great minds (Mimikatz, Impacket, etc.) 
∙ Microsoft Team
∙ Stack Overflow & Infosec community. You all rock!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A G E N D A
Why?
How?
What’s 
next?
What?
Show
me!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A G E N D A
Why?
How?
What’s 
next?
What?
Show 
me!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
how to create invisible user windows 
B A C K    I N    T H E    D A Y . . .
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
how to create invisible user windows 
I wasn’t lucky :(
B A C K    I N    T H E    D A Y . . .
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
H O W    A B O U T    N O W ?
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W H A T    A B O U T    A T T A C K E R S ?
Identity
Manipulation
External
Implants
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
Reference: https://attack.mitre.org/
Account Manipulation
Create Account
Valid accounts
19 persistence techniques
Identity
Manipulation
External
Implants
BITS Jobs
Hijack Execution Flow
Boot or Logon Autostart Execution Implant Internal Image
Boot or Initialization Scripts
Modify Authentication Process
Browser Extensions
Office Application Startup
Compromise Client Software Binary Pre-OS Boot
Create or Modify System Process
Scheduled Task/Job
Event Triggered Execution
Server Software Components
External Remote Services
Traffic Signaling
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
Reference: https://attack.mitre.org/
Account Manipulation
Create Account
Valid accounts
19 persistence techniques
Identity
Manipulation
External
Implants
BITS Jobs
Hijack Execution Flow
Boot or Logon Autostart Execution Implant Internal Image
Boot or Initialization Scripts
Modify Authentication Process
Browser Extensions
Office Application Startup
Compromise Client Software Binary Pre-OS Boot
Create or Modify System Process
Scheduled Task/Job
Event Triggered Execution
Server Software Components
External Remote Services
Traffic Signaling
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
Reference: https://attack.mitre.org/
Account Manipulation
Create Account
Valid accounts
63 of the 85 unique procedures for 
persistence leverage Identity 
Manipulation
Identity
Manipulation
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A G E N D A
Why?
How?
What’s 
next?
What?
Show 
me!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
T H E    S U B O R N E R    W A Y
Suborner is a new persistence attack to stealthily forge custom invisible
accounts which can impersonate any identity on all Windows NT machines.
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
T H E    S U B O R N E R    W A Y
∙ Only who created the suborner account will
easily know the username and password
∙ After authenticated, the suborner account will
impersonate any existent (enabled/disabled)
account
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
B R I B I N G    W I N D O W S
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
B R I B I N G    W I N D O W S
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
G E T T I N G    U S    A C C E S S
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
G E T T I N G    U S    A C C E S S
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
G E T T I N G    U S    A C C E S S
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W A I T    A     M I N U T E !
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
B E F O R E . . . 
Attacker
Admin
Victim 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C C O U N T    C R E A T I O N    S C E N A R I O S
∙ Scenario 1: Add user
∙ Scenario 2: Add user with $
∙ Scenario 3: Add machine account (netapi32)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C C O U N T    C R E A T I O N    S C E N A R I O S
∙ Scenario 1: Add user
∙ Scenario 2: Add user with $
∙ Scenario 3: Add machine account (netapi32)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 1 :  A D D
U S E R 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 1 :  A D D
U S E R 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
4720!
S C E N A R I O    # 1 :  A D D
U S E R 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 1 :  A D D
U S E R 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
DEL!
S C E N A R I O    # 1 :  A D D
U S E R 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C C O U N T    C R E A T I O N    S C E N A R I O S
∙ Scenario 1: Add user FAIL!
∙ Scenario 2: Add user with $
∙ Scenario 3: Add machine account (netapi32)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C C O U N T    C R E A T I O N    S C E N A R I O S
∙ Scenario 1: Add user FAIL!
∙ Scenario 2: Add user with $
∙ Scenario 3: Add machine account (netapi32)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 2 :  A D D
U S E R    $
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
4720!
S C E N A R I O    # 2 :  A D D
U S E R    $
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 2 :  A D D
U S E R    $
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 2 :  A D D
U S E R    $
4720
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
DEL!
S C E N A R I O    # 2 :  A D D
U S E R    $
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C C O U N T    C R E A T I O N    S C E N A R I O S
∙ Scenario 1: Add user FAIL!
∙ Scenario 2: Add user with $
FAIL!
∙ Scenario 3: Add machine account (netapi32)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A C C O U N T    C R E A T I O N    S C E N A R I O S
∙ Scenario 1: Add user FAIL!
∙ Scenario 2: Add user with $
FAIL!
∙ Scenario 3: Add machine account (netapi32)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 3 :  N E T A P I 3 2 
USER_INFO_1 baddieInfo {
usri1_name = baddie$
…
usri1_priv = 1
usr1_flags = 0x1000
}
netapi32::NetUserAdd(baddieInfo)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
4741!
S C E N A R I O    # 3 :  N E T A P I 3 2 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S C E N A R I O    # 3 :  N E T A P I 3 2 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
4741
S C E N A R I O    # 3 :  N E T A P I 3 2 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
DEL!
S C E N A R I O    # 3 :  N E T A P I 3 2 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
∙ The baddie account is detected:
∙ When created (Windows Events, API Call Sequence Analysis)
∙ After its creation (User Management Applications)
W H A T    I S    W R O N G ?
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
∙ The baddie account is detected:
∙ When created (Windows Events, API Call Sequence)
∙ After its creation (User Management Applications)
∙ The
account
needs
to
be
added
to
an
administrative
group
(e.g.
Administrators)
W H A T    I S    W R O N G ?
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
∙ The baddie account is detected:
∙ When created (Windows Events, API Call Sequence)
∙ After its creation (User Management Applications)
∙ The
account
needs
to
be
added
to
an
administrative
group
(e.g.
Administrators)
∙ The Win32 API impedes to modify all account attributes freely
W H A T    I S    W R O N G ?
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W H A T    C A N    W E    D O ?
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
B R I B E    I T !
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
Create!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
Done!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
I D E A !  
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W R I T E    T H E    S A M    D I R E C T L Y !
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N O    L O G !
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S U B O R N I N G ?    H O W ?
∙ Dynamically crafts a suborner account without calling the Win32 API
functions designed to do so (e.g., netapi32::netuseradd)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S U B O R N I N G ?    H O W ?
∙ Dynamically crafts a suborner account without calling the Win32 API
functions designed to do so (e.g., netapi32::netuseradd)
∙ Adds extra stealth to the suborner appending the dollar sign to its username
($)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S U B O R N I N G ?    H O W ?
∙ Dynamically crafts a suborner account without calling the Win32 API
functions designed to do so (e.g., netapi32::netuseradd)
∙ Adds extra stealth to the suborner appending the dollar sign to its username
($)
∙ Configures the account as a machine account through its Account Control
Bits (ACB).
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A G E N D A
Why?
How?
What’s 
next?
What?
Show
me!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
G O A L S
∙ Understand authentication/authorization for local accounts
∙ Create a local account writing directly to the SAM
∙ Make it invisible!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
G O A L S
∙ Understand authentication/authorization for local accounts
∙ Create a local account writing directly to the SAM
∙ Make it invisible!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
LSASS
Event 
Logger
LSA 
Policy
Creds 
Mgmt
NetUserAdd
API
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
Executive
User mode
Kernel mode
Security Reference Monitor (SRM)
ALPC
Event 
Logger
LSA
Service
lsasrv.dll
SAM 
Service
samsrv.dll
Local Security Subsystem (LSASS)
MSV1_0.dll
kerberos.dll
LSA 
Policy
Others
AD 
Services
ntdsa.dll
AD DB
KDC
Kdcsvc.dll
RPC
Credential Management
WINLOGON
netapi32.dll
userenv.dll
Others
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
Executive
User mode
Kernel mode
Security Reference Monitor (SRM)
ALPC
Event 
Logger
LSA
Service
lsasrv.dll
SAM 
Service
samsrv.dll
Local Security Subsystem (LSASS)
MSV1_0.dll
kerberos.dll
LSA 
Policy
Others
AD 
Services
ntdsa.dll
AD DB
KDC
Kdcsvc.dll
RPC
Credential Management
WINLOGON
netapi32.dll
userenv.dll
Others
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
Executive
User mode
Kernel mode
Security Reference Monitor (SRM)
ALPC
Event 
Logger
LSA
Service
lsasrv.dll
SAM 
Service
samsrv.dll
Local Security Subsystem (LSASS)
MSV1_0.dll
LSA 
Policy
RPC
Credential Management
WINLOGON
A U T H E N T I C A T I O N 
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
Security 
Log
Executive
User mode
Kernel mode
Security Reference Monitor (SRM)
ALPC