100.
96104
4096
pec
00
87101
Sep
793:05
S0:EE
Sicense.pdt
T00t
100
100.
Sep
Sep
00
113224
1865
See
See
00
7 03:05 third-party
7 03:05
87Sep
03:05
pdate
图9-7查看当前文件权限
接着，输人如下命令，为TeamServer和CobaltStrike赋予执行权限，如图9-8所示。
chmod +x teamserver cobaltstrike
:kali:~/Desktop/cobaltstrike# chnod +x cobaltstrike teanserver
图9-8赋予权限
再次输人“ls-I”命令，查看当前TeamServer和 Cobalt Strike的权限。TeamServer和Cobalt
Strike已经获得了执行权限，如图9-9所示。
---
## Page 390
第9章CobaltStrike377
root@kali /Desktapflcotaltstrike
e(V)
搜索()
此瑞()帮助(H)
22136
oot
961
ropt
Sep
root
 23 16:17
data
sbaltstr)ke.ster
90!
oet
001
Pec
36
sep
sep
7 03:85
141 Sep
readne.txt
seclon
03:85
rootroo
87 5ep
701:05
03:05
ipdate.
图9-9再次查看权限
cobaltstrike文件夹中有多个文件和文件夹，其功能如下。
·agscript：拓展应用的脚本。
·c2lint：用于检查profile的错误和异常。
·teamserver：团队服务器程序。
·cobaltstrike和cobaltstrike.jar：客户端程序。因为 teamserver文件是通过Java来调用Cobalt
Strike的，所以直接在命令行环境中输人第一个文件的内容也能启动CobaltStrike客户端
（主要是为了方便操作）。
·logs：日志，包括Web日志、Beacon日志、截图日志、下载日志、键盘记录日志等。
·update 和 update.jar：用于更新 Cobalt Strike。
·data：用于保存当前TeamServer的一些数据。
最后，运行团队服务器。在这里，需要设置当前主机的IP地址和团队服务器的密码。输人如
下命令，如图9-10所示。
./teamserver 192.168.233.4 test123456
If yos purc
2015/10/14/the-cobalt-strike-trials-evi1-bit/ (This is a trial version 1imitatie
[$] Aded EECAR string to Malleable C2 prof:1e. ITkis is a triat versisn 1inita
2da84ea15c40886
图9-10运行团队服务器
---
## Page 391
378内网安全攻防：渗透测试实战指南
如果要将CobaltStrike的TeamServer 部署在公网上，需要使用强口令，以防止TeamServer被
破解。
现在，CobaltStrike团队服务器准备就绪。接下来，我们就可以启动Cobalt Strike客户端来连
接团队服务器了。
9.2启动CobaltStrike
9.2.1启动cobaltstrike.jar
启动cobaltstrike.jar，如图9-11所示。
root:kali:-/Desktop/cobaltstrikea ls
2lint
cobaltstrike.store
eanserver
update-jar
date
图 9-11启动 cobaltstrike.jar
填写团队服务器的IP地址、端口号、用户名、密码，如图9-12所示。在这里，登录的用户名
可以任意输人，但要保证当前该用户名没有被用来登录CobaltStrike服务器。
Connect
127.0 0.1
Thsistheconetdalgushulusetconet
to a Cebalt Strike (Aggressor) team server.
Host:
92.168.233.
Pert:
50050
User:
neo
Password: ****
Connecteip
图9-12填写团队服务器的相关信息
单击“Connect”按钮，会出现指纹校验对话框，如图9-13所示。指纹校验的主要作用是防纂
改，且每次创建CobaltStrike团队服务器时生成的指纹都不一样。
VertyFingerprint
?
The beam server'sfingerprint is
170ce15Bb21bB81066210a4f3edc9b72598792d7775a0n
vhenthetear
图9-13指纹校验
---
## Page 392
第9章Cobalt Strike379
在客户端向服务端成功获取相关信息后，即可打开Cobalt Strike主界面，如图9-14所示。
CobaltStrike主界面主要分为菜单栏、快捷功能区、目标列表区、控制台命令输出区、控制台命令
输入区。
·菜单栏：集成了Cobalt Strike的所有功能。
·快捷功能区：列出常用的功能。
·目标列表：根据不同的显示模式，显示已获取权限的主机及目标主机。
·控制台命令输出区：输出命令的执行结果。
·控制台命令输人区：输人命令。
Cobelt Strike (Trial)
。@。
日界列表
图9-14Cobalt Strike 主界面
9.2.2利用CobaltStrike获取第一个Beacon
1.建立Listener
可以通过菜单栏的第一个选项“CobaltStrike”进人“Listeners”面板，也可以通过快捷功能
区进人“Listeners”面板，如图9-15和图9-16所示。
单击“Add”按钮，新建一个监听器，如图9-17所示。输入名称、监听器类型、团队服务器
IP地址、监听的端口，然后单击“Save”按钮保存设置，如图9-18所示。第一个监听器（Listener）
创建成功，如图9-19所示。
---
## Page 393
380内网安全攻防：渗透测试实战指南
户
YPNInterl
Lsteners
三四口
图9-15通过莱单栏打开“Listeners”面板
图9-16通过快捷功能区打开“Listeners”面板
paylgad
hest
图9-17新建一个监听器
vin
192.160.233.4
图9-18设置相关参数
Started Listene
Logx
1X
192.168.293.4
host
rse_http
图9-19创建第一个监听器
---
## Page 394
第9章Cobalt Strike381
2.使用WebDelivery执行Payload
单击“Attacks”菜单，选择“WebDrive-by”→“ScriptedWeb Delivery”选项，或者通过快捷
功能区，打开“ScriptedWeb Delivery”窗口，如图9-20和图9-21所示。
attacksbapoting lp
ebDe-bynage
Clone Site
Het File
Scrigtedyeb Deivery
Signedl Applet Altacl
Smart Applet Atack
System Brofler
图9-20通过莱单栏打开“Scripted Web Delivery”窗口
图9-21通过快捷功能区打开“ScriptedWeb Delivery”窗口
保持默认配置，选择已经创建的监听器，设置类型为PowerShell，然后单击“Launch”按钮，
如图9-22所示。最后，将Cobalt Strike生成的Payload完整地复制下来，如图9-23所示。
ScriptedWebDeivery
This attack hosts an atfacthat delvers a Cobat Strike
paylead.The previded ene-linerwi alowyoutoquichlyget
URPath:
LocalHost:
192.160.233.4
tet
Ad
Succe
Type:
powerhel
Started service: Scripted web Delivery
Copy and paste this URLto access it
SSL:
图9-22设置Scripted Web Delivery 参数
图9-23复制生成的Payload
3.执行Payload
执行Payload，Cobalt Strike会收到一个Beacon，如图9-24所示。
---
## Page 395
382内网安全攻防：渗透测试实战指南
Meus 11  6.1.7681
atin保留所有权利
图9-24执行 Payload
如果一切顺利，就可以在CobaltStrike的日志界面看到一条日志，如图9-25所示。
Event Log XLinteners ×
ne help
tV.166./13.4:20/
evrnts
图9-25日志
在Cobalt Strike的主界面中可以看到一台机器上线（包含内网IP地址、外网IP地址、用户
名、机器名、是否拥有特权、Beacon进程的PID、心跳时间等信息），如图9-26所示。
192.1802333192.160233.3hackHACxITPC
egnduos
niete
图9-26上线
4.与目标主机进行交互操作
单击右键，在弹出的快捷菜单中选中需要操作的Beacon，然后单击“Interact”选项，进人主
机交互模式，如图9-27所示。
现在就可以输人一些命令来执行相关操作了。如图9-28所示，输人“shell whoami”命令，查
看当前用户，在心跳时间后就会执行该命令。在执行命令时，需要在命令前添加“shell"。Beacon
的每次回连时间默认为60秒。
回连后，执行命令的任务将被下发，并成功回显命令的执行结果，如图9-29所示。
---
## Page 396
第9章Cobalt Strike383
12.168-239.3192168.2333H9
×0eacon 192.168.233.3@1528 ×
CKIT-PC1hackit/1528
图9-27进入主机交互模式
图9-28执行whoami 命令
17 bytes
ckit-pchexkit
图9-29成功执行whoami命令
---
## Page 397
384内网安全攻防：渗透测试实战指南
9.3CobaltStrike模块详解
9.3.1Cobalt Strike模块
CobaltStrike模块的功能选项，如图9-30所示。
Cobat strikeow
SewCornection
Dvelerences
Visualization
yPNnterfaces
Listeners
Script Manager
Close
图9-30 Cobalt Strike模块
·NewConnection：打开一个新的“Connect”窗口。在当前窗口中新建一个连接，即可同时
连接不同的团队服务器（便于团队之间的协作）。
·Preferences：偏好设置，首选项，用于设置CobaltStrike主界面、控制台、TeamServer连接
记录、报告的样式。
·Visualization：将主机以不同的权限展示出来（主要以输出结果的形式展示）。
·VPN Interfaces：设置VPN接口。
·Listeners：创建监听器。
·Script Manager：查看和加载CNA脚本。
·Close：关闭当前与TeamServer的连接。
9.3.2View模块
View模块的功能选项，如图9-31所示。
yiewBtakaR
Applictions
Credentials
Qownloads
[vent Log
Keystrokes
Proxy Pivets