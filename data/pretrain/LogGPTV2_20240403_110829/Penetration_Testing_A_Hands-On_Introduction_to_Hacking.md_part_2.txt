ARP Basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 161
IP Forwarding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163
ARP Cache Poisoning with Arpspoof . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 164
Using ARP Cache Poisoning to Impersonate the Default Gateway  .  .  .  .  .  .  .  .  . 165
DNS Cache Poisoning  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 167
Getting Started . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 168
Using Dnsspoof . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 169
SSL Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 170
SSL Basics  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 170
Using Ettercap for SSL Man-in-the-Middle Attacks  . . . . . . . . . . . . . . . . . . . . 171
SSL Stripping . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 173
Using SSLstrip . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 174
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 175
Part III
attacks
8
ExPloItatIon 179
Revisiting MS08-067  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180
Metasploit Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180
Meterpreter  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181
Exploiting WebDAV Default Credentials . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182
Running a Script on the Target Web Server  . . . . . . . . . . . . . . . . . . . . . . . . 183
Uploading a Msfvenom Payload . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183
Exploiting Open phpMyAdmin  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 186
Downloading a File with TFTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 187
Downloading Sensitive Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188
Downloading a Configuration File . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188
Downloading the Windows SAM  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189
Exploiting a Buffer Overflow in Third-Party Software . . . . . . . . . . . . . . . . . . . . . . . . . 190
Exploiting Third-Party Web Applications . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191
Exploiting a Compromised Service . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193
Exploiting Open NFS Shares . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 194
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 196
9
Password attacks 197
Password Management . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197
Online Password Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 198
Wordlists . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 199
Guessing Usernames and Passwords with Hydra  . . . . . . . . . . . . . . . . . . . . 202
Offline Password Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203
Recovering Password Hashes from a Windows SAM File . . . . . . . . . . . . . . . 204
Dumping Password Hashes with Physical Access . . . . . . . . . . . . . . . . . . . . . 206
LM vs . NTLM Hashing Algorithms  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 208
The Trouble with LM Password Hashes . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
Contents in Detail xiii
John the Ripper . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 210
Cracking Linux Passwords  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 212
Cracking Configuration File Passwords  . . . . . . . . . . . . . . . . . . . . . . . . . . . 212
Rainbow Tables  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213
Online Password-Cracking Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213
Dumping Plaintext Passwords from Memory with Windows Credential Editor  . . . . . . . 213
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 214
10
CLient-side exPLoitation 215
Bypassing Filters with Metasploit Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216
All Ports . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216
HTTP and HTTPS Payloads  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217
Client-Side Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218
Browser Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 219
PDF Exploits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 225
Java Exploits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230
browser_autopwn . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235
Winamp  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 237
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 240
11
soCiaL engineering 243
The Social-Engineer Toolkit  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 244
Spear-Phishing Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 245
Choosing a Payload  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246
Setting Options . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247
Naming Your File  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247
Single or Mass Email . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247
Creating the Template  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 248
Setting the Target  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 248
Setting Up a Listener  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 249
Web Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250
Mass Email Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 253
Multipronged Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255
12
BYPassing antiVirus aPPLiCations 257
Trojans . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258
Msfvenom  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258
How Antivirus Applications Work  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 260
Microsoft Security Essentials  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261
VirusTotal  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262
Getting Past an Antivirus Program  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263
Encoding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263
Custom Cross Compiling  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 266
Encrypting Executables with Hyperion . . . . . . . . . . . . . . . . . . . . . . . . . . . . 269
Evading Antivirus with Veil-Evasion  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 270
xiv Contents in Detail
Hiding in Plain Sight . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274
13
Post exPLoitation 277
Meterpreter . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 278
Using the upload Command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279
getuid  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279
Other Meterpreter Commands  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 280
Meterpreter Scripts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 280
Metasploit Post-Exploitation Modules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281
Railgun . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283
Local Privilege Escalation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283
getsystem on Windows  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283
Local Escalation Module for Windows . . . . . . . . . . . . . . . . . . . . . . . . . . . . 284
Bypassing UAC on Windows . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 285
Udev Privilege Escalation on Linux . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 287
Local Information Gathering  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 291
Searching for Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 291
Keylogging  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292
Gathering Credentials . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 292
net Commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 294
Another Way In  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 295
Checking Bash History . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 295
Lateral Movement . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296
PSExec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296
Pass the Hash  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 298
SSHExec  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 299
Token Impersonation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 300
Incognito  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301
SMB Capture  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 302
Pivoting  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 304
Adding a Route in Metasploit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 305
Metasploit Port Scanners  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 306
Running an Exploit through a Pivot  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 306
Socks4a and ProxyChains  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 307
Persistence  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 309
Adding a User  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 309
Metasploit Persistence  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 310
Creating a Linux cron Job . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311
14
weB aPPLiCation testing 313
Using Burp Proxy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 314
SQL Injection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 319
Testing for SQL Injection Vulnerabilities  . . . . . . . . . . . . . . . . . . . . . . . . . . . 320
Exploiting SQL Injection Vulnerabilities  . . . . . . . . . . . . . . . . . . . . . . . . . . . 321
Using SQLMap . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 321
XPath Injection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 323
Contents in Detail xv
Local File Inclusion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 324
Remote File Inclusion  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327
Command Execution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327
Cross-Site Scripting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 329
Checking for a Reflected XSS Vulnerability . . . . . . . . . . . . . . . . . . . . . . . . . 330
Leveraging XSS with the Browser Exploitation Framework  . . . . . . . . . . . . . . 331
Cross-Site Request Forgery  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 335
Web Application Scanning with w3af  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 335
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 337
15
wireLess attaCks 339
Setting Up . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 339
Viewing Available Wireless Interfaces . . . . . . . . . . . . . . . . . . . . . . . . . . . . 340
Scan for Access Points . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341
Monitor Mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341
Capturing Packets  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 342
Open Wireless  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 343
Wired Equivalent Privacy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 343
WEP Weaknesses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 346
Cracking WEP Keys with Aircrack-ng  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 347
Wi-Fi Protected Access  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 350
WPA2  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351
The Enterprise Connection Process  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351
The Personal Connection Process  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351
The Four-Way Handshake  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 352
Cracking WPA/WPA2 Keys  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 353
Wi-Fi Protected Setup . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 356
Problems with WPS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 356
Cracking WPS with Bully . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 357
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 357
Part iV
exPLoit deVeLoPment
16
a staCk-Based BuFFer oVerFLow in Linux 361
Memory Theory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 362
Linux Buffer Overflow . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 364
A Vulnerable Program  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 365
Causing a Crash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 366
Running GDB  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 367
Crashing the Program in GDB  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 372
xvi Contents in Detail
Controlling EIP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 373
Hijacking Execution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 375
Endianness . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 376
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 378
17
a staCk-Based BuFFer oVerFLow in windows 379
Searching for a Known Vulnerability in War-FTP  . . . . . . . . . . . . . . . . . . . . . . . . . . . 380
Causing a Crash  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 382
Locating EIP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 384
Generating a Cyclical Pattern to Determine Offset . . . . . . . . . . . . . . . . . . . . 385
Verifying Offsets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 388
Hijacking Execution  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 390
Getting a Shell . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 395
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 400
18
struCtured exCePtion handLer oVerwrites 401
SEH Overwrite Exploits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 403
Passing Control to SEH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 407
Finding the Attack String in Memory  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 408
POP POP RET  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 411
SafeSEH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 412
Using a Short Jump  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 416
Choosing a Payload . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 418
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 419
19
Fuzzing, Porting exPLoits, and metasPLoit moduLes 421
Fuzzing Programs  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 421
Finding Bugs with Code Review  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 422
Fuzzing a Trivial FTP Server  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 422
Attempting a Crash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 424
Porting Public Exploits to Meet Your Needs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 427
Finding a Return Address . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 429
Replacing Shellcode  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 430
Editing the Exploit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 430
Writing Metasploit Modules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 432
A Similar Exploit String Module  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 435
Porting Our Exploit Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 435
Exploitation Mitigation Techniques . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 439
Stack Cookies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 440
Address Space Layout Randomization  . . . . . . . . . . . . . . . . . . . . . . . . . . . 440
Data Execution Prevention  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 441
Mandatory Code Signing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 441
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 442
Contents in Detail xvii
Part V
Mobile Hacking
20
Using tHe sMartPHone Pentest FraMework 445
Mobile Attack Vectors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 446
Text Messages  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 446
Near Field Communication . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 446
QR Codes  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447
The Smartphone Pentest Framework  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447
Setting Up SPF  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 447
Android Emulators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449
Attaching a Mobile Modem  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449
Building the Android App  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449
Deploying the App  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 450
Attaching the SPF Server and App . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 452
Remote Attacks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 453
Default iPhone SSH Login  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 453
Client-Side Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 454
Client-Side Shell  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 454
USSD Remote Control  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 456
Malicious Apps  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 458
Creating Malicious SPF Agents . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 459
Mobile Post Exploitation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 464
Information Gathering . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 464
Remote Control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 465
Pivoting Through Mobile Devices  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 466
Privilege Escalation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 471
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 472
resoUrces 473
index 477
xviii Contents in Detail
fore worD
I met Georgia Weidman at a conference almost two
years ago. Intrigued by what she was doing in the
mobile device security field, I started following her
work. At nearly every conference I’ve attended since
then, I’ve run into Georgia and found her passion-
ately sharing knowledge and ideas about mobile
device security and her Smartphone Pentesting
Framework.
In fact, mobile device security is only one of the things Georgia does.
Georgia performs penetration tests for a living; travels the world to deliver
training on pentesting, the Metasploit Framework, and mobile device secu-
rity; and presents novel and innovative ideas on how to assess the security of
mobile devices at conferences.
Georgia spares no effort in diving deeper into more advanced top-
ics and working hard to learn new things. She is a former student of my
(rather challenging) Exploit Development Bootcamp, and I can attest to
the fact that she did very well throughout the entire class. Georgia is a true
hacker—always willing to share her findings and knowledge with our great
infosec community—and when she asked me to write the foreword to this
book, I felt very privileged and honored.
As a chief information security officer, a significant part of my job
revolves around designing, implementing, and managing an information
security program. Risk management is a very important aspect of the pro-
gram because it allows a company to measure and better understand its
current position in terms of risk. It also allows a company to define priori-
ties and implement measures to decrease risk to an acceptable level, based