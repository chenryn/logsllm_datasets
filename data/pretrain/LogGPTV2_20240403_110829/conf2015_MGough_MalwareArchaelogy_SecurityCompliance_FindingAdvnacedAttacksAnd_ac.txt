以下是优化后的文本，使其更加清晰、连贯和专业：

---

### 配置步骤

1. **修改默认的 `profile.ps1` 文件**：
   - 在您的 `profile.ps1` 文件中添加以下行：
     ```powershell
     $LogCommandHealthEvent = $true
     $LogCommandLifecycleEvent = $true
     ```

2. **配置 Splunk 输入**：
   - 编辑 `inputs.conf` 文件，以启用特定于 Windows PowerShell 的输入处理器。
   - 添加或修改以下内容：
     ```ini
     [WinEventLog://Windows PowerShell]
     disabled = 0
     ```

3. **升级 PowerShell**：
   - 将 PowerShell 升级到版本 3 或 4。

### 调查 PowerShell 攻击 (DefCon & Blackhat 2014)

- **演讲者**：
  - Ryan Kazanciyan, 技术总监, Mandiant
  - Matt Hastings, 顾问, Mandiant

### 使用 Splunk 进行日志分析

#### 可用日志
有许多可用的日志比您想象的要多。以下是一些关键日志及其位置：

- **Windows PowerShell 日志**：
  - 位于“应用程序和服务日志”文件夹下。
- **TaskScheduler/Operational**：
  - 位于“应用程序和服务日志/Microsoft/Windows”文件夹下。
- **Windows 防火墙（带高级安全）**：
  - 位于“应用程序和服务日志/Microsoft/Windows”文件夹下。
- **AppLocker**：
  - 位于“应用程序和服务日志/Microsoft/Windows”文件夹下。

#### 排除或白名单
目标是减少正常的噪声。这需要一些时间，但系统在正常行为方面通常相似。您可以在查询中直接进行排除，或者使用查找命令。

- **使用查找列表**：
  - 示例：排除已知可信 IP 地址的 OWA 和 VPN 登录。
    ```spl
    | where NOT [ | inputlookup trusted_ips_for_OWA_VPN_logins.csv | fields + IPAddress ]
    ```
  - 查找文件的内容：
    ```spl
    | inputlookup trusted_ips_for_OWA_VPN_logins.csv | fields + IPAddress
    ```
  - 填充查找文件：
    ```spl
    | outputcsv trusted_ips_for_OWA_VPN_logins.csv
    ```

#### 最佳实践
- **减少或排除事件**（节省许可证成本）：
  - 事件 ID 4688 和 4689（新进程启动/停止）以及 5156 和 5158（Windows 防火墙）将是数量最多的前四个事件。
  - 不要通过 EventID 排除想要保留的事件，而是通过消息中的具体内容来排除。
  - 示例：我想保留 4688 事件，但不包括 `splunk*.exe` 或 `googleupdate.exe`，因此可以通过 `New_Process_Name` 来排除这些噪声。
  - 示例：我想保留 5156 事件，但不包括正常执行的项目，因此可以通过 `Application_Name` 来排除这些噪声。

### 查询示例

1. **查询 1 - 4688 (新进程启动)**：
   ```spl
   index=windows source="WinEventLog:Security" (EventCode=4688) 
   NOT (Account_Name=*$)
   (at.exe OR bcdedit.exe OR chcp.exe OR cmd.exe OR cscript.exe OR ipconfig.exe OR mimikatz.exe OR nbtstat.exe OR nc.exe OR netcat.exe OR netstat.exe OR nmap OR nslookup.exe OR bcp.exe OR sqlcmd.exe OR OSQL.exe OR ping.exe OR powershell.exe OR powercat.ps1 OR psexec.exe OR psexecsvc.exe OR psLoggedOn.exe OR procdump.exe OR rar.exe OR reg.exe OR route.exe OR runas.exe OR sc.exe OR schtasks.exe OR sethc.exe OR ssh.exe OR sysprep.exe OR systeminfo.exe OR system32\\net.exe OR tracert.exe OR vssadmin.exe OR whoami.exe OR winrar.exe OR wscript.exe OR winrm.* OR winrs.* OR wmic.exe OR wsmprovhost.exe)
   | eval Message=split(Message,".")
   | eval Short_Message=mvindex(Message,0)
   | table _time, host, Account_Name, Process_Name, Process_ID, Process_Command_Line, New_Process_Name, New_Process_ID, Creator_Process_ID, Short_Message
   ```

2. **查询 2 - 4624 (登录成功)**：
   ```spl
   index=windows LogName=Security EventCode=4624 
   NOT (host="DC1" OR host="DC2" OR host="DC…")
   NOT (Account_Name="*$" OR Account_Name="ANONYMOUS LOGON" OR Account_Name="Service_Account")
   | eval Account_Domain=(mvindex(Account_Domain,1))
   | eval Account_Name=if(Account_Name=="-", (mvindex(Account_Name,1)), Account_Name)
   | eval Account_Name=if(Account_Name=="*$", (mvindex(Account_Name,1)), Account_Name)
   | eval Time=strftime(_time,"%Y/%m/%d %T")
   | stats count values(Account_Domain) AS Domain, values(host) AS Host, dc(host) AS Host_Count, values(Logon_Type) AS
   ```

---

希望这些改进能帮助您更清晰地理解和使用这些配置和查询。