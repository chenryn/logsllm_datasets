  to 
  your 
  default 
  profile.ps1to 
  your 
  default 
  profile.ps1 
  file –$LogCommandHealthEvent 
  = 
  $true –$LogCommandLifecycleEvent 
  = 
  $true 
3.Splunk 
  -­‐ 
  Inputs.confindows 
  plazorm 
  specific 
  input 
  processor –[WinEventLog://Windows 
  PowerShell] 
–disabled 
  = 
  0 
4.Upgrade 
  PowerShell 
  to 
  ver 
  3 
  or 
  ver 
  4 | 2.Add 
  these 
  to 
  your 
  default 
  profile.ps1to 
  your 
  default 
  profile.ps1 
  file –$LogCommandHealthEvent 
  = 
  $true –$LogCommandLifecycleEvent 
  = 
  $true 
3.Splunk 
  -­‐ 
  Inputs.confindows 
  plazorm 
  specific 
  input 
  processor –[WinEventLog://Windows 
  PowerShell] 
–disabled 
  = 
  0 
4.Upgrade 
  PowerShell 
  to 
  ver 
  3 
  or 
  ver 
  4 |  |
|---|---|---|---|or 
  ver 
  4 |  |
|---|---|---|---|
|  |InvesOgaOng    PowerShell    AFacks    (DefCon    &    Blackhat    2014)  |InvesOgaOng    PowerShell    AFacks    (DefCon    &    Blackhat    2014)  | |
| – |– |Ryan    Kazanciyan    TECHNICAL    DIRECTOR,    MANDIANT  | |
| – |– |MaF    HasOngs    CONSULTANT,    MANDIANT  | |
So 
  Let’s 
  See 
  What 
  We 
Can 
  do 
  With 
  Splunk 
|Can 
  do 
  With 
  Splunk 
| 
 | Which 
  Logs? 
There 
  are 
  more 
  logs 
  than 
  you 
  think 
“Windows 
  PowerShell” 
–Logs 
  – 
  Under 
  “ApplicaOon 
  and 
  Services 
  Logs” 
  folder 
TaskScheduler/OperaOonal 
–Under 
  “ApplicaOon 
  and 
  Services 
  Logs/MicrosoW 
  /Windows” 
  folder 
“Windows 
  Firewall 
  With 
  Advanced 
  Security” 
–Under 
  “ApplicaOonSecurity” 
–Under 
  “ApplicaOon 
  and 
  Services 
  Logs/MicrosoW 
  /Windows” 
  folder  | Which 
  Logs? 
There 
  are 
  more 
  logs 
  than 
  you 
  think 
“Windows 
  PowerShell” 
–Logs 
  – 
  Under 
  “ApplicaOon 
  and 
  Services 
  Logs” 
  folder 
TaskScheduler/OperaOonal 
–Under 
  “ApplicaOon 
  and 
  Services 
  Logs/MicrosoW 
  /Windows” 
  folder 
“Windows 
  Firewallfolder 
“Windows 
  Firewall 
  With 
  Advanced 
  Security” 
–Under 
  “ApplicaOon 
  and 
  Services 
  Logs/MicrosoW 
  /Windows” 
  folder  |  |
|---|---|---|---|
|       |AppLocker  –Under    “ApplicaOon    and    Services    Logs/MicrosoW    /Windows”    folder  |AppLocker  –Under    “ApplicaOon    and    Services    Logs/MicrosoW    /Windows”    folder  |AppLocker  –Under    “ApplicaOon    and    Services    Logs/MicrosoW    /Windows”    folder  ||       |Others    if    you    want    to    play  |  |  |
36 
Excluding 
  or 
  WhitelisOng The 
  goal 
  is 
  to 
  reduce 
  normal 
  noise 
 This 
  is 
  the 
  one 
  thing 
  that 
  will 
  take 
  some 
  Ome, 
  not 
  a 
  lot, 
  systems 
  are preFy 
  similar 
  in 
  “normal” 
  behavior 
You 
  can 
  do 
  in 
  right 
  in 
  the 
  query, 
  or 
  use 
  the 
  lookupquery, 
  or 
  use 
  the 
  lookup 
  command 
If 
  you 
  use 
  lookup, 
  you 
  need 
  a 
  query 
  to 
  create 
  or 
  update 
  the 
  list 
  and 
run 
  as 
  needed 
  once 
  you 
  or 
  InfoSec 
  validates 
  the 
  items 
  are 
  good 
  and could 
  be 
  whitelisted 
37 
Using 
  Lookup 
  Lists 
 Exclude 
–| 
  where 
  NOT 
  [| 
  inputlookup 
  trusted_ips_for_OWA_VPN_logins.csvtrusted_ips_for_OWA_VPN_logins.csv 
  | 
  fields 
  + 	IPAddress] 
What 
  is 
  in 
  the 
  lookup 
  file 
–search 
  = 
  |inputlookup 
  trusted_ips_for_OWA_VPN_logins.csv 
  | 
  fields 
  + 	IPAddress 
Populate 
  a 
  lookup 
  file 
–| 
  outputcsv 
  trusted_ips_for_OWA_VPN_logins.csv 
38 
Do’s 
  and 
  Don’t’s 
Reducing 
  or 
  excluding 
  events 
  (save 
  on 
  license)events 
  (save 
  on 
  license) 
 Event 
  ID’s 
  4688 
  & 
  4689 
  (New 
  Process 
  Start/Stop) 
  and 
  5156 
  & 
  5158 (Windows 
  Firewall) 
  will 
  be 
  the 
  Top 
  4 
  Events 
  in 
  quanOty! 
–Storage 
  and 
  License 
  required 
–4689 
  and 
  5158 
  CAN 
  be 
  excluded 
  as 
  least 
  valuable 
Do 
  NOT 
  exclude 
  by 
  EventID’s 
  that 
  you 
  want,EventID’s 
  that 
  you 
  want, 
  exclude 
  them 
  by 
  the Message 
  within 
  the 
  EventID 
I 
  want 
  4688, 
  but 
  not 
  splunk*.exe 
  or 
  googleupdate.exe, 
  so 
  exclude 
  by New_Process_Name 
  to 
  reduce 
  normal 
  noise 
I 
  want 
  5156, 
  but 
  not 
  things 
  that 
  are 
  normal 
  to 
  execute, 
  so 
  exclude by 
  Applica:on_Name 
39 
Walk 
  Through39 
Walk 
  Through 
  of 
  a 
  Query 
1. 
2. 
3. 
4. 
5. 
6. 
7. Index 
  name 
LogName 
  (source) 
Event 
  ID 
Exclusions 
  -­‐ 
  NOT 
  (“item1” 
  OR 
  “item2”) Inclusions 
  -­‐ 
  (“itemA” 
  OR 
  “itemB”) 
Lookup 
  lists 
  – 
  “inputlookup” 
  for 
  larger 
  lists Output 
  – 
  “table” 
  or 
  “stats 
  count 
  by 
  XYZ” 
40 
Query 
  1 
  – 
  4688 
  (New 
  Process1 
  – 
  4688 
  (New 
  Process 
  Started) 
You 
  can 
  add 
  any 
  or 
  all 
  Windows 
  Admin 
  UOliOes 
  in 
  \System32 
 index=windows 
  source="WinEventLog:Security" 
  (EventCode=4688) 
  NOT 
  (Account_Name=*$) (at.exe 
  OR 
  bcdedit.exe 
  OR 
  chcp.exe 
  OR 
  cmd.exe 
  OR 
  cscript.exe 
  OR 
  ipconfig.exe 
  OR 
mimikatz.exe 
  OR 
  nbtstat.exe 
  OR 
  nc.exeOR 
  nbtstat.exe 
  OR 
  nc.exe 
  OR 
  netcat.exe 
  OR 
  netstat.exe 
  OR 
  nmap 
  OR 
nslookup.exe 
  OR 
  bcp.exe 
  OR 
  sqlcmd.exe 
  OR 
  OSQL.exe 
  OR 
  ping.exe 
  OR 
  powershell.exe 
  OR powercat.ps1 
  OR 
  psexec.exe 
  OR 
  psexecsvc.exe 
  OR 
  psLoggedOn.exe 
  OR 
  procdump.exe 
  OR 
rar.exe 
  OR 
  reg.exe 
  OR 
  route.exe 
  OR 
  runas.exe 
  OR 
  sc.exeOR 
  runas.exe 
  OR 
  sc.exe 
  OR 
  schtasks.exe 
  OR 
  sethc.exe 
  OR ssh.exe 
  OR 
  sysprep.exe 
  OR 
  systeminfo.exe 
  OR 
  system32\\net.exe 
  OR 
  tracert.exe 
  OR vssadmin.exe 
  OR 
  whoami.exe 
  OR 
  winrar.exe 
  OR 
  wscript.exe 
  OR 
  winrm.* 
  OR 
  winrs.* 
  OR wmic.exe 
  OR 
  wsmprovhost.exe) 
  | 
  eval 
  Message=split(Message,".") 
  | 
  eval| 
  eval 
Short_Message=mvindex(Message,0) 
  | 
  table 
  _Ome, 
  host, 
  Account_Name, 
  Process_Name, Process_ID, 
  Process_Command_Line, 
  New_Process_Name, 
  New_Process_ID, 
Creator_Process_ID, 
  Short_Message 
41 
New 
  Process 
  InformaOon 
  in 
  Splunk 
  -­‐ 
  Normal 
42 
New 
  Process 
  to 
  Catch 
  the 
  PowerShell 
  Bypass 
 index=windows 
  source="WinEventLog:Security"source="WinEventLog:Security" 
  (EventCode=4688) (powershell* 
  AND 
  -­‐ExecuOonPolicy) 
  OR 
  (powershell* 
  AND 
  bypass) OR 
  (powershell* 
  AND 
  -­‐noprofile) 
  | 
  eval 
  Message=split(Message,".") 
| 
  eval 
  Short_Message=mvindex(Message,0) 
  | 
  table 
  _Ome, 
  host, Account_Name, 
  Process_Name, 
  Process_ID, 
Process_Command_Line, 
  New_Process_Name,New_Process_Name, 
  New_Process_ID, Creator_Process_ID, 
  Short_Message 
 CRITICAL 
  ALERT 
  !!! 
43 
4688 
  (PowerShell 
  Bypass) 
  Results 
  in 
  Splunk 
44 
Query 
  2 
  – 
  4624 
  (Login 
  Success) 
Detect 
  account 
  crawling 
  > 
  2 
  hosts 
  (no 
  domain 
  controllers) 
 index=windows 
  LogName=Security 
  EventCode=4624 
  NOT 
  (host=“DC1" 
  OR 
  host=“DC2"(host=“DC1" 
  OR 
  host=“DC2" 
  OR host=“DC…”) 
  NOT 
  (Account_Name="*$" 
  OR 
  Account_Name="ANONYMOUS 
  LOGON") 
  NOT (Account_Name=“Service_Account") 
  | 
  eval 
  Account_Domain=(mvindex(Account_Domain,1)) 
  | eval 
  Account_Name=if(Account_Name="-­‐",(mvindex(Account_Name,1)), 
  Account_Name) 
  | eval 
  Account_Name=if(Account_Name="*$",(mvindex(Account_Name,1)), 
  Account_Name)Account_Name) 
  | 
eval 
  Time=strWime(_Ome,"%Y/%m/%d 
  %T") 
  | 
  stats 
  count 
  values(Account_Domain) 
  AS Domain, 
  values(host) 
  AS 
  Host, 
  dc(host) 
  AS 
  Host_Count, 
  values(Logon_Type) 
  AS 