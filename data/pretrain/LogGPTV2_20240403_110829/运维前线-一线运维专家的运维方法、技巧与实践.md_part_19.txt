foriincat/tmp/ip.txt
1.基于Linux的上传
EOF
do
#！
/bin/bash
，安装LFTP 包，将涉及Linux节点的IP 保存为
"%%iin(d:\windows-script\ip.txt)
---
## Page 103
大家分享。在此感谢李彬厚和齐特两位同事对我的大力支持。
应用，就可以将看似不可能完成的任务变为可能，同时达到事半功倍的效果。以上经验仅供
3.4小结
系只能有一行。同时也要防止同一个旧 IP 对应多个新 IP 的情况。
家可以根据实际情况添加判断语句以适应 RHEL 较新的7版本或其他Linux版本。另外也可
地方。由于未包含操作系统判别语句，目前仅在RHEL5和RHEL6系列上测试通过，因此大
仍然是以原始 IP命名的。
名称后，在vCenter管理界面看到的是改名为目标 IP 的虚拟机名称。但存储底层的数据文件
3.3.5
完善逻辑语句使得脚本更加严谨可靠。
内的虚拟机文件名在存储迁移的同时就能自动调整为新IP的文件名了。
字典文件 ipcheck.txt 中的 IP 对应关系，需要确保 IP 地址的唯一，相同的新旧 IP 对应关
作为一名IT运维人员，在日常的运维中，只要熟练掌握基本工具并融会贯通加以灵活
为防止给以后的运维留下后患，需要对虚拟机进行一次存储VMotion的操作，这样存储
以上的脚本是利用Shell脚本简化Linux逻辑节点的搬迁，在实际运行中还有不完善的
浏览存储底层所看到的文件情况，如图3-25所示。
由于是通过存储底层复制技术进行的逻辑迁移，因此在目标端完成注册，并调整虚拟机
搬迁期间的注意事项
文件夹|搜索|
数据存储浏览器一
日
图3-25数据存储内部虚拟机的文件结构
第3章数据中心搬迁中的x86自动化运维87
00
2.vmso
41,943,040.00K
524,288,000.00
203.47KB
192.64KB
119.05KB
197.74 KB
126.08KB
0.26KB
147.84KB
0.00KB
3.19KB
大小
虚拟机
虚拟机日志文件
虚拟机日志文件
虚拟机日志文件
非易失性内存
虚拟磁盘
虚拟磁盘
虚拟机日志文件
虚拟磁盘
类型
虚拟机日志文件
艾
虚拟机日志文件
---
## Page 104
厌倦工作的情绪，这个时候使用集中配置管理工具Puppet 则能很轻松地解决这些问题，这也
万台时就会变得非常复杂。重复性的劳动还会让人觉得疲惫和乏味，久而久之可能还会产生
事，就算到了100台也有轻量级的Fabric自动化运维工具，但是如果上升到1000台甚至上
完成时，便需要一些自动化工具来帮忙了。
洞等工作，是不是觉得很繁琐？尤其当我们负责部署和维护大量服务器，凭借一已之力无法
控→检查，等网站或系统正式上线后，后续可能还会有添加服务→配置变更→打补丁修复漏
还需要更彻底地应用自动化运维工具。
统管理员已经开始做一些局部的自动化工作。但只有这些还远远不够，为了满足运维需求，
配置软件、添加某个服务的时代。为了提高效率、避免重复劳动、减少错误、积累知识，系
再是系统管理员疲于安装操作系统、对系统参数进行逐一配置与优化、打补丁、安装软件、
验。精通负载均衡高可用和自动化运维技术，擅长高并发高流量网站系统架构设计。
及高并发高流量网站架构设计等方面进行了深入的研究，在大量一线实践中积累了丰富的经
版版主。从事云计算和电子商务网站运维工作十多年，在Linux集群、自动化运维、云计算
《Linux集群和自动化运维》作者，ChinaUnix论坛“集群和高可用”、“监控及自动化运维”
常见的运维工作流程包括：安装系统→优化系统与配置→安装软件→配置软件→添加监
layteea
系统运维工作面临的各种不确定性更让人头疼，在10台机器上变更应用还是很简单的
大数据时代高伸缩性、容错性、分布式的特点给系统运维提出了更高的要求，现在已不
余洪春（抚琴煮酒），运维架构师、资深系统管理员，《构建高可用Linux服务器》
作者简介
集中配置管理工具Puppet
第4章
---
## Page 105
机器client.cn7788.com举例说明)：
进行操作，内容如下所示（这里为了实验方便，请提前用 yum安装好下面的服务)：
4.1
ntpdate 做好时间的精准对时，不然 puppet-client 在连接时会报错，连接不上。
是现在 Puppet 越来越流行的原因之一
Puppet 客户端顺利连接上服务器端后，正常显示结果应该如下所示（完成需求，以节点
实现步骤其实并不复杂，我们还是在服务器端的/etc/puppet/manifests 的 site.pp文件上
口关闭 vsftpd 服务。
如何同步 puppet-agent 端（也称为Puppet 客户端）上的几个常用服务，要求如下：
我们清理好前面的环境，清空/etc/puppet/manifests/里的 site.pp 文件的内容，并且利用
httpd (pid 9603)is running..
我们可在Puppet客户端下面输入命令来验证下实验结果，具体命令如下所示：
Info: Applying configuration version'1446608434'
Info:Retrieving pluginfacts
ensure =>
口开启 httpd服务和 postfix服务。
client.cn7788.com 192.168.1.206
fabric.cn7788.com
server.cn7788.com 192.168.1.205
这里的操作环境按照前面的操作已经搭建完毕，具体如下所示：
下面将介绍 Puppet 的进阶操作。
servicehttpdstatus
master (pid 10028) is running...
service postfix status
Notice: Finished catalog run in 1.60 seconds
Service[postfix]
Info: /Stage[main]/Main/Service[postfix]: Unscheduling refresh on
running'
Info:Caching catalog for client.cn7788.com
Info:Retrieving plugin
ensure=>
'vsftpd":
["httpd",
service{
,"postfix"]:
stopped;
running;
192.168.1.204
puppet-client
puppet-client
puppet-master
第4章集中配置管理工具Puppet
89
---
## Page 106
应的目录/etc/yum.repos.d/下面去，那么这个该如何实现呢？
4.3如何自动同步puppet-agent 端的yum源
器client.cn7788.com举例说明）：
4.2
90运维前线：一线运维专家的运维方法、技巧与实践
path /etc/yum.repos.d/
如果想通过Puppet 将这些文件都推送到与client.cn7788.com 和 fabric.cn7788.com 相对
（2）客户端顺利连接上服务器端后，正常显示结果应该如下所示（完成需求，以节点机
[files]
-rw-r--r--.
total24
命令显示结果如下所示：
ls 1l /etc/yum.repos.d/
通过以下命令我们可以观察到 puppet-master 端机器上更新了 yum 源:
Notice: Finished catalog run in 15.03 seconds
Notice: /Stage[main]/Main/Package[sysstat] /ensure: created
Info: Applying configuration version'1446608680'
Info: Caching catalog for client.cn7788.com
Info:Retrieving plugin
Info: Retrieving pluginfacts
-rw-r--r--.
-rw-r--r--
package{
在 Puppet 客户端自动安装 screen、ntp 和 sysstat 包，具体步骤如下所示。
rw-r--
-rw-r--r--.
vsftpd is stopped
service vsftpd status
rw-r--
如何在puppet-agent 端上自动安装常用的软件包
ensure =>"installed";
["screen","ntp","sysstat"]:
-r-
1root root 1250Apr
root
root root 1926 Feb 25
root
root
root
root
3664
957
Feb
Feb
Feb
12
403:46 nginx.repo
2013 puppetlabs.repo
2013 Cent0S-Base.repo
2013
2013 Centos-Media.repo
3Centos-Vault.repo
epel.repo
---
## Page 107
client 端推送文件，我们分别在两台节点机器上输入如下命令：
Puppet 客户端正确连接到 Puppet 服务器端后，大家会发现，puppet-server 会向 puppet-
（2）修改/etc/puppet/manifests/site.pp 文件，内容如下所示：
Info:
Info:FileBucket gota duplicate file {md5}d41d8cd98f00b204e9800998ecf8427e
Info:Computing checksum on file/etc/yum.repos.d/test/cc
repos.d/test/dd topuppet with sum d41d8cd98f00b204e9800998ecf8427e
Info:/Stage[main]/Main/File[/etc/yum.repos.d/test]:Filebucketed /etc/yum
Info:/Stage[main]/Main/File[/etc/yum.repos.d/softlist]:Filebucketed /etc/yum
Info:
noarch.rpm
Info:
Info:Retrievingpluginfacts
两台机器的结果是一样的，输入命令的反馈结果如下所示：
台
Info:
台
Info:
purge => true
force => true,
台
recurse => true,
mode=>644，
owner => root,
group=>root，
source => "puppet://server.cn7788.com/files/",
("/etc/yum.repos.d/":
file
allow
ilebucket
5
afo:Computing checksum on file/etc/yum.repos.d/test/dd
nfo:/Stage[main]/Main/File[/etc/yum.repos.d/test]:Recursively backing up to
otice:/Stage[main]/Main/File[/etc/yum.repos.d/softlist]/ensure:removed
epos.d/soft1ist topuppet with sum 36fe51e7e690fe7d65046e9868ed2fa4
tice:
pm]/ensure:removed
otice:/Stage[main]/Main/File[/etc/yum.repos.d/puppetlabs-release-6-7.noarch
thsum2aa0affe57ade441bfb9dcd6126a6cd6
efinedcontent as'{md5}8b95e819eeea42849932309b5be5533d'
otice:
efinedcontentas'{md5}14d68f86efb69e928d626c7ea8a974b3
otice:
nfo:Applying configurationversion'1446619419'
/Stage[main]/Main/File[/etc/yum.repos.d/test]: Filebucketed /etc/yum
/Stage[main]/Main/File[/etc/yum.repos.d/puppetlabs-release-6-7.noarch
Caching catalog for client.cn7788.com
Retrieving plugin
:/Stage[main]/Main/File[/etc/yum.repos.d/Centos-Debuginfo.repo]/ensure:
/Stage[main]/Main/File[/etc/yum.repos.d/Centos-Base.repo]/ensure:
/Stage[main]/Main/File[/etc/yum.repos.d/puppetlabs.repo]/ensure
第4章集中配置管理工具Puppet
6
---
## Page 108
候，就会自动接入并处理 node.pp 文件了。
puppet/modules下面建立名为pushfle的模块，操作如下所示：
应用就编写成一个模块，例如我们定义的 pushfile模块。
Puppet 生态系统中的核心部分，我们一般通过资源的定义告诉Puppet 应该做什么，一般一个
服务器端的/etc/puppet/modules/下，在它下面我们会定义一个名为 pushfile的模块。模块是
conf文件，这个应该如何实现呢？
cn7788.com的客户端推送/etc/hosts 文件，向名为nginx.cn7788.com的客户端推送/etc/resolv.
4.4如何根据不同名字的节点机器推送不同的文件
etc/yum.repos.d目录下的文件同步过来了，完成此工作需求，检查结果如下：
92运维前线：一线运维专家的运维方法、技巧与实践
这里的需求比较复杂，我们可以通过Puppet 模块来实现需求，模块文件一般是存放在
Puppet服务器端向名为client.cn7788.com的客户端推送/etc/crontab文件，向名为 fabric.
而 site.pp 文件的内容如下：
import"node.pp"
total24
同样，我们在 Puppet 客户端用Ⅱl命令进行观察，将会发现已经将 puppet-server 端的/
-rw-r--r--
-rw-r--r--
-rw-r--r--
-rw-r--r--
-rw-r--r--
Notice:
defined
Notice:
Notice:
defined
Notice:
content
Notice:
Notice:/Stage[main]/Main/File[/etc/yum.repos.d/test]/ensure:removed
repos.d/test/cc to puppet with sum d41d8cd98f00b204e9800998ecf8427e
Finished catalog run in 0.75 seconds
contentas'{md5}62b394965682a15877a36357fe55689d'
as'{md5}e8950030d9c72cf3e7a6469e8c1404ca'
content as'{md5}db3010a594efc3043651a78741ac02ff'