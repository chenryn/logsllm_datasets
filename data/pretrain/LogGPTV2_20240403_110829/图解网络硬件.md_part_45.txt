服务器
SYN
会话信息在
SYN+ACK
这里生成
ACK
Telnet
命令
Telnet响应
会话生存时间
1小时内没有进行任何通信
会话消息在这里删除
Telnet
丢弃非SYN消息的TCP数据段
SYN
必须重新完成3次握
ACK
SYN+ACK
手过程以便再次建立
Telnet
Telnet会话
命令
会话终止处理
TCP连接一般通过下面的步骤终止会话。
①客户端在完成收发数据后，会发送FIN标志位设置为On的TCP数据段（FIN）。
②服务器接收到FIN消息后，会在回复消息中将FIN与ACK标志位设置为On，并将Ack
编号设置为“接收的Seq编号+1”
③客户端同样在回复的TCP消息中将ACK标志位设为On，将Ack编号设置为“接收的
Seq编号+1”，连接就此结束。
---
## Page 266
2521第5章防火墙功能与防范威胁的对策
④这时，客户端会进人TIME_WAIT的TCP状态。一定时间后本次连接所使用的TCP端
口号（来自客户端的通信发送源端口号）将会禁用。这一时间段称为2MSL（Maximum
SegmentLifetime，MSL的2倍），根据实现的不同，大约在1分钟到几分钟之间不等。
如果客户端或服务器在确认连接建立时发生了故障，那么将只有能够通信的一方进入侦听
状态，这种情形称为半侦听或是半关闭。如果这时通信的故障方从故障中恢复，并接收到故障前
交互的TCP数据段，便会向通信对方回复一条TCP响应数据段，该数据段中RST标志位设为
ON，通过这条响应消息强制终止TCP连接。
终止连接有时会通过FIN和RST两个标志位来完成，不过当防火墙接收到来自通信方
的FIN或RST时，还可以启动另一个30秒左右的定时器。如果在该时间段内FIN一FIN-
ACK一ACK的终止过程仍未完成，防火墙中的会话表项会被强制删除（图5-13）。
图5-13在接收SYN、FIN消息时强制删除会话信息的时机
客户端
防火墙
服务器
根据SYN信息生成会话信息
SYN
5秒内如果仍未完成3次握
手结束则删除会话信息
SYN+ACK
ACK
FIN
收到FIN消息后的30秒内如果
没有收到FIN+ACK消息则删
除会话信息
FIN+ACK
表5-12
与会话相关的定时器种类（以PaloAltoNetwork公司的PA系列产品为例）
与会话相关的定时器种类
默认值
会话生存时间
TCP：3600秒
UDP:30秒
IP:30秒
ICMP：6秒
接收SYN后到3次握手结束之前的会话超时
5秒
接收到FIN或RST后到会话结束之前的会话超时
30秒
---
## Page 267
05.07防火墙中搭载的各种功能|253
UDP数据流的管理
在UDP中没有像TCP这样的3次握手过程，客户端和服务器之间直接使用带有应用程序分
组的UDP分组进行交互。
UDP数据流是指发送源IP地址、发送源端口号、目的地IP地址和目的地端口号这4个参数
都相同的一系列UDP分组（图5-14）。
图5-14DNS通信示例
客户端
服务器
DNS查询
1个会话
query响应
发送源地址：10.1.1.1
发送源地址：10.1.1.236
目的地址：10.1.1.236
目的地址：10.1.1.1
发送源端口：23455
发送源端口：53
目的地端口：53
目的地端口：23455
c2s（clienttoserver）的数据流
s2c（servertoclient）的数据流
从10.1.1.1地址向10.1.1.236地址的53号端
从10.1.1.236地址向10.1.1.1地址发送DNS
口发送DNS请求（开始数据流）。在该请求
响应消息，由于使用既存的会话信息进行
得到安全策略允许的前提下，当首个分组达
响应，因此该消息无需经过安全策略检测
到服务器时，防火墙便开始生成会话信息
即可通过防火墙
进行音频和视频数据交互的RTP（RealTimeProtocol），则需要通过多个由流数据（streaming
data）构成的UDP分组来完成1个数据流。
管理ICMP和IP数据流
在进行ICMP和TCP/UDP以外的IP通信时，由于不存在端口号这个概念，因此需要直接根
据IP首部的协议号来生成会话信息。
如ICMP中的Echo消息对应EchoReply消息那样，防火墙需要自动识别不同的请求消息和
与之对应响应消息，并综合判断这些消息序列是否属于同一个会话（图5-15）。
---
## Page 268
254|第5章防火墙功能与防范威胁的对策
图5-15
ICMP数据流与会话
客户端
服务器
Echo
Echo
1个会话
reply
DNS查询
query
1个会话
响应
发送源地址：10.1.1.1
发送源地址：10.1.1.236
目的地址：10.1.1.236
目的地址：10.1.1.1
发送源端口：23455
发送源端口：53
目的地端口：53
目的地端口：23455
c2s（clienttoserver）的数据流
s2c（servertoclient）的数据流
会话同步
支持会话同步功能的防火墙能够对余结构中（HA结构?）主设备和副设备之间的会话信息
进行同步。为了准确地同步会话信息，需要使用专用的HA链路将两台防火墙连接，然后在该链
路上完成会话信息的交互。
在采用了主备方式的余结构中，活跃设备负责建立用户通信的会话，并将会话信息记录在
会话表中，同时还会将信息通过HA专用链路转发到备用设备中。
利用会话数目受限的特性
有的防火墙产品拥有限制通过防火墙会话数目的功能，也有些产品将该功能作为DoS防御
功能的一部分提供给用户。
防火墙可以以TCPSYN、UDP、ICMP以及其他IP等协议为单位，通过指定发送源与目的
地的组合来限制该类会话的数目。当指定的发送源为ANY、指定的目的地址为某特定地址时，
就能够限制该服务器上的会话数目，这样做不仅可以控制服务器的负载，还可以防范DoS攻击。
另外，限制会话的数目就相当于限制了防火墙内会话表中会话记录的数目，这也能够在一定
程度上提高防火墙的性能。
05.07.02分组结构解析
为了防止非法分组的流入和流出，防火墙会对分组的首部和有效载荷进行结构解析，解析的
主要项目如下所示。
①指高可用性（HighAvailability）结构。——译者注
---
## Page 269
05.07防火墙中搭载的各种功能255
IP首部解析
IPv4首部格式如图5-16所示，其中成为防火墙解析对象的部分如表5-13所示。
图5-16
IPv4首部
0
34
78
1516
31
版本
首部长度
服务类型（TOS）
数据总长度
ID
标志位
分片偏移
TTL
协议号
首部校验和
发送源IP地址
目的地IP地址
可选部分（32bit、长度可变、最小为0byte）
后续部分为用户数据
：
表5-13以太网数据帧和IPv4首部的解析内容
以太网类型与IP版本
确认以太网数据帧首部上的Type域为0x0800时表示IPv4，此时IP首部上的版
本信息也为4。该域为0x86DD则表示IPv6，IP首部上的版本信息也为6
IP首部
确认必备数据域是否完整，并验证其中的分组长度是否与实际长度一致
IP协议号、TTL
验证该字段是否为0，如果为0则丢弃该分组
发送源地址、目的地址
确认是否存在Land攻击
总数据长度
确定是否存在PingofDeath攻击
标志位、分片偏移
丢弃无法进行分片的分组。
可选数据域
丢弃存在无用可选数据域的分组。
TCP首部解析
TCP首部格式如图5-17所示，其中成为防火墙解析对象的部分如表5-14所示。
①一种使用相同的发送源、目的主机和端口发送分组到某台机器的攻击，会使存在漏洞的机器崩溃。———译者注
②一种拒绝服务的攻击，具体做法是攻击者故意发送大于65535字节的IP分组给接收方。—译者注
---
## Page 270
256第5章防火墙功能与防范威胁的对策
图5-17
TCP首部
0
1516
31
发送源端口号
目的地端口号
序列号
ACK（Acknowledge）编号
数据偏移
（保留域）
窗口尺寸
校验和
紧急指针
可选+填充部分（32bit、长度可变、最小为0byte）
后续部分为用户数据（长度可变、最小Obyte
表5-14
TCP首部的解析内容
TCP首部
确认必备数据域是否完整、是否被中途截断
数据偏移
确认表示TCP首部长度的DataOffset数据域的值是否为5以下（TCP首部长度最小
为5字符=20字节）
校验和
确认是否有校验和错误
端口号
确认发送源的端口号以及目的地端口号是否为0
TCP标志位
检查SYN、ACK等TCP首部内的标志位是否存在组合不正确的情况
UDP首部解析
UDP首部解析的对象如表5-15所示。
表5-15
UDP首部的解析内容
UDP首部
确认必备数据域是否完整、是否被中途截断
校验和
确认是否有校验和错误
05.07.03
安全区域
大多数的防火墙中都有安全区域（SecurityZone，简称为区域）的概念，即将防火墙上物理
接口以及逻辑接口分配至不同的区域中，也就是将与防火墙连接的网段分别划分到不同的区域
中。其中，一个网络接口不能属于多个区域（图5-18）。
在同一区域内可以自由进行基本通信，但跨区域的通信必须符合安全策略才能完成。防火墙
---
## Page 271
05.07防火墙中搭载的各种功能|257
也能够通过安全策略设置发送源或发送目的地等条件，根据是否符合这些条件来判断位于同一区
域内的通信是否可行。
图5-18
区域划分示例
Sales区域
销售群组的网络
Untrust区域
Ethernet1/3
内部网络
互联网
Ethernet1/1
Ethernet1/2
tunnel1
loopback1
Ethernet1/5
客户端
Trust区域
公开服务器
DMZ区域
区域名称
所分配的网络接口（举例）
说明
Trust
Ethernet1/1、tunnel1、loopback1