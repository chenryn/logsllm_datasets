98
97
6
---
## Page 50
3.IP层转发分组的过程
3.IP层转发分组的过程
链路1
所有别达网络14513.00
10.0.0.4
20.0.0.7
链路 2
20.0.0.9
145.13.21.23
子网
30.0.0.2
1145.13.21.0
145.13.3.
145
链路 3
30.0.0.1
13
VN
145.13.7.
45
40.0.0.4
3
3.1基于终点的转发
3.1基于终点的转发
：链路 4
6
---
## Page 51
口最长前缀匹配(longest-prefix matching)原则：
口使用CIDR 时，在查找转发表时可能会得到不止一个匹配结果。
3.IP层转发分组的过程
3.IP层转发分组的过程
■网络前缀越长，其地址块就越小，因而路由就越具体。
■选择前缀最长的一个作为匹配的前缀。
1283机2H13
■
把前缀最长的排在转发表的第1行。
口
口
R2
128.30.33.1 0
8.30.33.130
128.30.36.2
128.30.33.129
口
目2的3机31.38
子网2：网133528
30.33.128
的路由表（未给出默认路由器）
口
255.255.255.128
8.30.36
3.1基于终点的转发
3.2最长前缀匹配
一跳
102
101
5
---
## Page 52
3.IP层转发分组的过程
口转发表中的 2 种特殊的路由
3.IP层转发分组的过程
■默认路由：
■特定主机路由：
口默认路由在主机发送IP数据报时往往更能显示出它的好处。
口采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间。这种转发方
口采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可
口是为特定的目的主机指明一个路由。
口
口
式在-
在需要考虑某种安全问题时采用这种特定主机路由。
只要目的网络不是Net-1，Net-2，Net-3，就选择使用默认路由。
那么在这种情况下使用默认路由是非常合适的。
一个网络只有很少的对外连接时是很有用的。
0.0.0.0/0接口fo
网络前缀
Net-3
Net
R-0路由表
R-O
联网
，而这个网络只用一个路由器和因特网连接，
下一跳
R-3
let-
3.2最长前缀匹配
3.2最长前缀匹配
104
103
2
---
## Page 53
3.IP层转发分组的过程
分组转发算法
④
③
②若
①从数据报的首部提取目的主机的IP地址D,得出目的网络地址为N。
报告转发分组出错。
若路由表中有到达网络N的路由，
指明的下一跳路由器；否则，执行④。
若路由表中有目的地址为D的特定主机路由，
接交付，执行③。
若网络N与此路由器直接相连，
提取目的地址IP地址 D
查找转发表
路由器分组转发算法
则把数据报传送给
，则把数据报直接交付目的主机D；否则是间
则把数据报传送给路由表指明的下一跳路
找到默认路由？
最长D能？
特机的？
丢弃分组
否
否”
否
一
则把数据报传送给路由表中所
品
田
转发分组到下一跳路由器
表中所指明的默认路由
3.2最长前缀匹配
105
3
---
## Page 54
口二叉线索(binary trie):：
3.IP层转发分组的过程
■为简化二叉线索的结构，可以用唯一前缀(unique prefix)来构造二叉线索。
■
■从二叉线索的根节点自顶向下的深度最多有32 层，每一层对应于IP地址中
■一种特殊结构的树，可以快速在转发表中找到匹配的叶节点。
规则：
为了提高二叉线索的查找速度，广泛使用了各种压缩技术。
的一位。
10111011 00001010 00000000 00000000
10110000000000100000000000000000
01010110000000000000000000000000
01000110 000000000000000000000000
然后再检查地址的第二位，构造出第二层的节点。依此类推，直到唯一前缀的最后一位。每个
先检查 IP 地址左边的第一位，如为O，则第一层的节点就在根节点的左下方；如为1，则在右
32位的IP地址
由
15个唯一
前缀构成的二叉线索
唯一前缀
10111
10110
011
0101
0100
3.3使用二叉线索查找转发表
107
8
---
## Page 55
查找方法：
查找方法：
查到第三个字符〇时，在二叉线索中找不到匹配的。说明这个地址不在这个二叉线索中。
若匹配，
10011011 01111010 00000000 00000000
，就按下一跳的接口转发该分组。否则，就丢弃该分组。
01010110011110100000000000000000
一个叶节点。
32位的IP地址
32位的IP地址
在二叉线索中查找IP地址
二叉线索中查找IP地址
5
---
## Page 56
4.网际控制报文协议ICMP
口ICMP是IPv4协议簇中的一个子协议，用于在IP主机、路由器之间传递控
为了提高IP数据报交付成功的机会，在网际层使用了网际控制报文协议
4.网际控制报文协议ICMP
■控制消息虽然并不传送用户数据，但是对于用户数据的传递起着重要的作用。
■控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息
制消息。
CM
ICMP就如同地图中的路况
4.1ICMP报文的种类
4.1ICMP报文的种类
112
111
---
## Page 57
口在下列情况中，通常自动发送ICMP 消息：
ICMP 报告无法传送的数据报的错误，并帮助对这些错误进行疑难解答。
4.网际控制报文协议ICMP
口ICMP一般不用来在端系统之间传送数据，不被用户网络程序直接使用。
口ICMP 协议与 ARP 协议不同，ICMP 依靠IP 协议来完成任务，所以
口ICMP 不是高层协议，而是IP层的协议。
口ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。
4.网际控制报文协议ICMP
■IP数据报无法访问目标。
■例如，
ICMP 报文中要封装IP 头部，组成IP 数据报发送出去。
■IP路由器将发送主机重定向为使用到达目标的更佳路由。
■IP 路由器（网关）无法按当前的传输速率转发数据报。
■端系统中，Ping 和 Traceroute 等诊断网络的工具才会直接使用 ICMP 协议。
ICMP就会向主机发送ICMP的"无法到达目标"的消息。
如果IPv4不能够将数据报传送到目标主机，则路由器或目标主机上的
4.1ICMP报文的种类
4.1ICMP报文的种类
 114
113
---
## Page 58
4.网际控制报文协议ICMP
4.网际控制报文协议ICMP
前4个字节相同
首部
类型
ICMP 的数据部分 (长度取决于类型)
(这4个字节取决于ICMP 报文的类型)
IP数据报
代码
数据部分
ICMP报文
检验和
4.1ICMP报文的种类
4.1ICMP报文的种类
116
115
88
---
## Page 59
口ICMP 报文种类有两种：ICMP 差错报告报文和ICMP 询问报文。
4.网际控制报文协议ICMP
4.网际控制报文协议ICMP
■ICMP 报文的前4个字节是统一的格式，共有三个字段：即类型、代码和检验
和。接着的 4 个字节的内容与ICMP 的类型有关。
差错报告报文
ICMP 报文种类
询问报文
13或14
08
类型的值
几种常用的ICMP报文类型
5
（选项数援）
目的IP地址
源IP地址
IP数据包
ICMP报文
时间戳（Timestamp）请求或回答
回送(Echo)请求或回答
改变路由(Redirect)
ICMP报文的类型
终点不可达
检验和
参数问题
时间超过
ICM
型义段相纹
4.1ICMP报文的种类
4.1ICMP报文的种类
118
117
6
---
## Page 60
口ICMP差错报告报文共有5种：
4.网际控制报文协议ICMP
·改变路由(重定向）(Redirect)
■参数问题
■时间超过
■源点抑制(Source quench)
■终点不可达
4.1ICMP报文的种类
120
9
---
## Page 61
口不应发送ICMP差错报告报文的几种情况：
4.网际控制报文协议ICMP
4.网际控制报文协议ICMP
■对具有多播地址的数据报都不发送ICMP差错报告报文。
■对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。
■对ICMP差错报告报文不再发送ICMP差错报告报文。
文
对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报
收到的IP数据报
首部
[EM学的
IP数据报
ICMP 差错报告报文
ICMP差错报告报文的数据字段的内容
IP 数据报首部
IP 数据报首部
←
字节
装入 ICMP 报文的IP 数据报
ICMP差错报告报文
IP数据报的数据字段
4.1ICMP报文的种类
4.1ICMP报文的种类
122
121
9
---
## Page 62
Traceroute
 PING (Packet InterNet Groper)
4.网际控制报文协议ICMP
口ICMP 询问报文有两种:
4.网际控制报文协议ICMP
■用来跟踪一个分组从源点到终点的路径。
■这是UNIX操作系统中名字。在 Windows 操作系统中这个命令是tracert。
■是应用层直接使用网络层ICMP的例子，
■使用了ICMP回送请求与回送回答报文。
■用来测试两个主机之间的连通性。
■时间戳请求和回答
■回送请求和回答
不可达差错报告报文实现对从源点到终点的路径的跟踪。
它利用IP 数据报中的 TL字段、ICMP 时间超过差错报告报文和ICMP 终点
口时间戳请求与回答可用于时钟同步和时间测量。
口时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日
口请某台主机或路由器回答当前的日期和时间。
口这种询问报文用来测试目的站是否可达，以及了解其有关状态。
口收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。
口由主机或路由器向一个特定的目的主机发出的询问。
起到当前时刻一共有多少秒。
，没有通过运输层的TCP 或 UDP。
4.2ICMP的应用举例
4.1ICMP报文的种类
124
123
23
---
## Page 63
口根本解决措施：
口IPv4地址耗尽问题：
口IP 是互联网的核心协议。
5. IPv6
4.网际控制报文协议ICMP
■采用具有更大地址空间的新版本的IP，即IPv6。
■我国在 2014－2015 年也逐步停止了向新用户和应用分配IPv4 地址。
■
■到2011年2月，IANAIPv4的32位地址已经耗尽。
各地区互联网地址分配机构也相继宣布地址耗尽。
使用Traceroute工具进行网络性能分析
使用PING工具进行网络连通性测试
4.2ICMP的应用举例
125
83
---
## Page 64
口 IPv6 的主要变化:
5. IPv6
口IPv6 的主要变化:
口IPv6 仍支持无连接的传送，但将协议数据单元 PDU 称为分组。
5. IPv6
口首部长度必须是8字节的整数倍，IPV4 首部是4 字节对齐。
IPv6 首部改为 8 字节对齐。
 允许协议继续扩充。
口 IPv6 将地址从 IPv4 的 32位增大到了 128 位。
更大的地址空间。
 IPv6 支持实时视像等要求，
支持资源的预分配。
IPv6 不需要使用 DHCP。
支持即插即用（即自动配置）
口IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。
改进的选项。
口 IPv6 定义了许多可选的扩展首部。
What Is IPv6?
灵活的首部格式。
扩展的地址层次结构。
https://info.
保证一定的带宽和时延的应用。
Vinfofi
inde
教学中尽量按照PDU描述，偶然会延续使用数据报这一名词。
lopedia/
5.1 IPv6 的基本首部
5.1IPv6的基本首部
128
127
9
---
## Page 65
口 IPv6 数据报由两大部分组成：
5. IPv6
口IPv6 数据报由两大部分组成：
5. IPv6
■把首部中不必要的功能取消了，使得IPv6 首部的字段数减少到只有8个。
■IPv6 将首部长度变为固定的 40 字节，称为基本首部。
■有效载荷 (payload)。
■基本首部 (base header)
■
IPv6 对首部中的某些字段进行了如下的更改：
口有效载荷允许有零个或多个扩展首部(extension header），再后面是数据部分。
口有效载荷也称为净负荷。
长度字段；
取消了总长度字段，改用有效载荷
取消了服务类型字段；
度是固定的40字节；
取消了首部长度字段，因为首部长
发送在前<
40字节
具有多个可选扩展首部的IPv6数据报的-
选项