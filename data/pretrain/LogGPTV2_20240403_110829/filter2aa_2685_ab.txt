and even use the same dropper in a separated 
collected .xls sample.	
6/25/11 
Case Summary (2) 
•  The agenda.doc is just packed with UPX. 
•  Dumping user credentials  
•  Using XOR instead of complicated encryption 
routine to encode/decode traffic to prevent from 
IPS/IDS detection.	
•  Download payload in different stages and each 
payload/executable is responsible for a single 
action. 
•  Use/Dependent on built-in Windows libraries 
•  With proper sequence number set up by CnC 
server to manage the victim, 
Case Summary (3) 
•  Same	
  Generator	
  -­‐	
  The	
  disassembled	
  structure	
  in	
agenda.doc	
  matches	
  the	
  one	
  in	
  diﬀerent	
  APT	
  sample	
(.exe)	
  zipped	
  inside	
  a	
  .chm	
  ﬁle	
Case Summary (4) 
•  This detailed case analysis is supplementary to 
reports published from: 
•  Tracking Ghostnet 
http://www.infowar-monitor.net/2009/09/tracking-
ghostnet-investigating-a-cyber-espionage-network/ 
•  Madiant
http://www.princeton.edu/~yctwo/files/readings/M-
Trends.pdf   
•  Feel free to reach me for the sample if you 
like. 
•  Meanwhile, do we still need to bother to do 
same analysis for various samples if they may 
come from the APT generator/taskforce? It 
drives our research indeed.	
Case 2: 
Calling from Mr. X  Again 
•  Mr.	
  X	
  get	
  many	
  mails	
  with	
  suspicious	
  aFachment	
on	
  or	
  before	
  4	
  June,	
  1	
  July	
  and	
  LEGCO	
  elecCon	
and	
  conCnue	
  to	
  make	
  enquiry	
  from	
  me.	
•  The	
  sender	
  seems	
  to	
  be	
  a	
  staﬀ	
  in	
  LEGCO	
  council	
•  AnC-­‐virus	
  engine	
  engaged	
  by	
  Gmail	
  has	
  not	
detected	
  any	
  issues.	
•  Filename	
  wriFen	
  in	
  Chinese	
  is	
  about	
  “Oﬃcial	
Reporters’	
  List	
  for	
  LEGCO	
  Council	
  News”	
Hong Kong APT: Open it, man!
公义 Justice  
http://en.wikipedia.org/wiki/Guan_Yu 
“All that is necessary for the triumph 
of evil is that good men do nothing” – 
Edmund Burkle 
Let me take shout: “Grass Root Horse”! 
等我向他说声”草泥马”! 
Automated Clustering:  
It is from Group-C
Malware of APT Group C
Malware Attack Graph
Malware Fix Suggestion
C&C Location of APT Group C
6/25/11 
A Chinese Poem from Cao Zhi (曹植-七步成诗)  
•  煮豆燃豆萁	
•  Cooking beans on a fire kindled with bean 
stalks,	
•  豆在釜中泣。	
•  The beans weep in the pot.	
•  本是同根生	
•  Originally born from the selfsame roots,	
•  相煎何太急！	
•  Why so eager to torture each other! 
Special Thanks 
•  Special thanks to Ran2 and DDL to analyze 
those APT samples with me. 
•  Especially Ran2 has worked on the analysis 
with me and got a lot juicy stuff from time to 
time  
6/25/11 
Part 2: 
Research Methodology 
Research Direction (1/2)
•  We	
  are	
  not	
  just	
  focusing	
  on	
  a	
  single	
  one-­‐oﬀ	
aFack,	
  we	
  tend	
  to	
  observe	
  the	
  enIre	
  APT	
  aFack	
plan	
  and	
  trend	
–  TradiConally,	
  we	
  just	
  focus	
  on	
  malware	
  forensics	
  or	
analyze	
  a	
  single	
  vicCm’s	
  machine.	
  We	
  cannot	
understand	
  the	
  APT	
  aFack	
  plan	
  and	
  its	
  trend	
  indeed.	
Research Direction (2/2)
•  Analyze	
  and	
  extract	
  features	
  and	
characterisIcs	
  of	
  APT	
  taskforce	
  via:	
–  Malware	
  features	
–  Exploit	
–  C&C	
  Network	
–  Speared	
  Email	
–  VicCm’s	
  background	
–  Time	
  of	
  aFack
APT File Analysis and Grouping
  TheoreCcally,	
  in	
  an	
  informaCon	
  system	
  (i.e.	
  malware	
  analysis	
system),	
  if	
  we	
  could	
  collect	
  all	
  the	
  aFributes/properCes	
  of	
  our	
malicious	
  sample	
  sets,	
  we	
  could	
  idenCfy	
  whether	
  the	
  executable/
document/sample	
  is	
  malicious.	
  However,	
  the	
  research	
  issues	
  are	
  insuﬃcient	
  collecCon	
  in	
  aFributes/
characterisCcs	
  (for	
  example,	
  the	
  malware	
  has	
  been	
  packed	
  and	
engage	
  various	
  anC-­‐debugging	
  capabiliCes),	
  so	
  that	
  we	
  get	
  the	
indiscernibility	
  relaCon	
Standard Analysis Method
 StaCc	
  Approach	
  Extract	
  signature/features	
  from	
  ﬁle	
  format	
  Reversing	
 Dynamic	
  Approach	
  Execute	
  it	
  under	
  controlled	
  environment	
  and	
  capture/log	
all	
  the	
  behaviors	
  Analyze	
  networking	
  traﬃc	
•  Challenge	
  of	
  Dynamic	
  Analysis
EncrypIon,	
ObfuscaIon
AnI-­‐VM/
Sandbox
Dormant	
FuncIonality
Side-­‐Eﬀect	
  of	
Master/Bot	
interacIon
We prefer using static analysis to prevent from Anti-VM, dormant 
functionality and side effect of master/bot interaction.
What APT Attributes we focused?
• 
We	
  work	
  on	
  the	
  analysis	
  on	
  mulC-­‐vector	
  basis.	
• 
Throughout	
  staCc	
  analysis:	
– 
Extract	
  and	
  review	
  executable,	
  Shellcode	
  and	
  PE	
  header	
– 
Objects	
  and	
  abnormal	
  structure	
  in	
  ﬁle	
• 
Throughout	
  dynamic	
  analysis:	
– 
Install	
  the	
  system	
  into	
  Windows	
• 
Scan	
  Process	
  Memory	
  to	
  detect	
  abnormal	
  structure	
• 
Code-­‐InjecCon,	
  API	
  Hooking	
  …	
– 
Detect	
  any	
  known	
  Code	
  Snippet	
• 
Rootkit,	
  KeyLogger,	
  Password	
  Collector,	
  AnC-­‐AV…	
– 
Suspicious	
  strings:	
  email	
  address,	
  domain,	
  IP,	
  URL
Extract Attributes from APT File
CVE
CVE-2009-3129
Shellcode
Code=90903CFDEF 
CAPO=E2FE9071 
PUCA=002191CB
Entropy
6.821483
Network
140.128.115.*** 
smtp.126.com 
test.3322.org.cn
Structure
JS=A103FE426E214CE 
JS=90C0C0C0C
AS=32EF90183227
Malware 1
PE=EF024788 
Entry=000B7324 
Code=D7B5A0120987FE 
Code=83D2325AB5 
Code=20BDCE 
Autorun=STARTUP_FOLDER 
Behavior=DLL-Injection, 
Password Collector
Malware 2
PE=EF93461A 
Entry=0003CAC0 
Code=AC23109B 
Code=19EFAC21 
Behavior=API-Hooking
DiscreIzaIon
Static 
Analysis
Dynamic 
Analysis
Clustering !
Clustering 
Exploit Concept
Shellcode
Malware Concept
Code Snippet
Xecure Engine
Behavior
Exploit CVE
PE Information
Network Concept
C&C IP/Domain
Protocol
SC.5D5819EE 
SC.D810C601 
PE.EBD5880B 
PE.5A05A491 
CD.FC7939E2 
CD.102C752B 
CD.2AFB773A 
ML.47E1B4C6 
NT.549535DD 
CC.656C20E1 
CC.77DEB444 
……
Save to DB 
Extract Fingerprints 
6/25/11 
Part 3: 
Analysis and Result 
Experiment
  Mila's	
  provided	
  APT	
  sample	
archives	
  are	
  conﬁrmed	
  to	
malicious	
  Those	
  archives	
  are	
  open	
  to	
  public	
for	
  downloading	
  and	
  analysis	
(CollecCon1,	
  242	
  APT	
  ﬁles)	
  The	
  sample	
  archives	
  are	
  used	
  by	
many	
  researchers	
  We	
  highly	
  credit	
  to	
  Mila’s	
  samples	
hFp://contagiodump.blogspot.com/	
Detection Rate
 Xecure	
  Inspector	
 94.6	
  %	
  (229	
  /	
  242	
  )	
 DeﬁniCon	
  updated	
  to	
  2011/6/11	
 MicrosoX	
  Security	
  EssenIals	
  21.4	
  %	
  (52	
  /	
  242)	
 Sophos	
  35.9	
  %	
  (87/242)	
 AnIVir	
  56.6	
  %	
  (137/242)
There are 8 major APT-Taskforce Groups
Group A
Group B
Group C
Group D
Group E
Group F
Group G
Group H
Groups of Mila Sample Set Collection1
2011
2010
2009
2008
other
Top 3 APT Taskforce Groups
Active
2009-0923 ~ 2011-0420 
Number
40 
CVE
CVE-2009-4841, CVE-2009-0927, CVE-2009-3129, 
CVE-2009-4324, CVE-2010-0188, CVE-2010-2833, 
CVE-2011-0611, CVE-2011-0609 
Malware
APT00010
C&C
IP:23, Domain: 5
Active
2008-0414 ~ 2011-0211
Number
26
CVE
CVE-2006-6456, CVE-2008-0081, CVE-2009-1129, 
CVE-2009-4324, CVE-2010-0188, CVE-2010-2883, 
CVE-2010-3333
Malware
APT000A0
C&C
IP:23, Domain:4
Active 
2008-0904 ~ 2011-0413
Number
21
CVE
CVE-2007-5659, CVE-2008-4841, CVE-2009-1862, 
CVE-2009-3129, CVE-2009-4324, CVE-2009-0658, 
CVE-2009-0927,  
Malware
APT00200
C&C
IP:5, Domain:11
Malware of APT Group A
Malware Attack Graph
Malware Fix Suggestion
C&C Location of APT Group A
48.1%	
  C&C	
  IP	
  located	
  in	
Taiwan
Malware of APT Group B
Malware Attack Graph
Malware Fix Suggestion
C&C Location of APT Group B
16%	
  C&C	
  IP	
  located	
  in	
Taiwan
Malware of Group E
Group-­‐E	
Language	
  =	
  Korean	
All (A,B,C)
Findings from Mila Sample Set (1/2)
Findings from Mila Sample Set (2/2)
  APT-­‐Deezer	
  provides	
  a	
  free	
  online	
service	
  to	
  check	
  whether	
  your	
submiFed	
  sample	
  whether	
  it	
  is	
  an	
  APT	
sample	
We	
  tak	
  Mila	
  sample	
  set	
  as	
  the	
  base	
  training	
set	
IdenCfy	
  Exploit	
  CVE	
  and	
  Malware	
  family	
Zero-­‐Day	
  Exploit	
  detecCon	
  and	
  analysis	
APT	
  Malware	
  sample	
  DNA	
  analysis	
  and	
comparison	
APT	
  sample	
  clustering	
  and	
  grouping	
Support	
  ﬁle	
  formats	
  including	
DOC,PPT,XLS,PDF,RTF	
  URL:	
  hFp://aptdeezer.xecure-­‐lab.com
Case Study (1/3)  
Target Attack Mail has been signed !?
又看到COMODO !
(2/3)  Identify the APT Taskforce Group
(3/3) Identify the APT Taskforce Group
•  But	
  Malware	
  is	
  a	
  known	
  family,	
  it	
  is	
  same	
  as	
APT-­‐Group-­‐B	
  !
Thank you for your listening 
•  Xecure Lab (http://www.xecure-lab.com) 
•  We keep collecting samples for analysis. 
•  Enhance the capability to analyze and observe APT 
DNA family in more accurate manner. 
•  It is an incremental efforts made to the Malware 
Analysis community. 
•  Together, we make homeland secured. 
Special Thanks 
•  Every members in Xecure Research Team and Mila 
as well as everyone has contributed ideas to us. 
•  Our family and fellows 
Finally 
Blackhat review board members, 
are you convinced yet? 