### Case Summary (June 25, 2011)

#### Key Findings
- The `agenda.doc` file is packed with UPX.
- User credentials are being dumped.
- XOR encryption is used instead of more complex methods to encode/decode traffic, helping to evade IPS/IDS detection.
- Payloads are downloaded in stages, with each payload/executable responsible for a single action.
- The malware leverages built-in Windows libraries.
- The CnC server manages the victim using proper sequence numbers.

#### Analysis of APT Generator
- The disassembled structure in `agenda.doc` matches that found in other APT samples (e.g., `.exe` files zipped inside a `.chm` file).

#### Supplementary Information
- This detailed case analysis complements reports from:
  - **Tracking Ghostnet**: [Link](http://www.infowar-monitor.net/2009/09/tracking-ghostnet-investigating-a-cyber-espionage-network/)
  - **Mandiant**: [Link](http://www.princeton.edu/~yctwo/files/readings/M-Trends.pdf)
- If you need the sample, feel free to contact me.
- Given the similarity in samples generated by the APT generator/taskforce, it may not be necessary to perform the same level of analysis on each sample. However, this drives our research forward.

### Case 2: Mr. X's Incident

- **Incident Details**:
  - Mr. X received multiple suspicious emails on or before June 4, July 1, and during the LEGCO election.
  - The sender appears to be a staff member of the LEGCO council.
  - Gmail’s antivirus engine did not detect any issues.
  - The filename in Chinese translates to “Official Reporters’ List for LEGCO Council News.”

### Hong Kong APT: Open it, Man!

- **Quote**:
  - "All that is necessary for the triumph of evil is that good men do nothing." – Edmund Burke
  - "Let me take a shout: 'Grass Root Horse'!" 
  - 等我向他说声”草泥马”!

- **Automated Clustering**:
  - The malware is identified as belonging to Group-C.
  - **Malware Attack Graph**
  - **Malware Fix Suggestion**
  - **C&C Location of APT Group C**

### A Chinese Poem from Cao Zhi (曹植-七步成诗)

- **Poem**:
  - 煮豆燃豆萁
  - Cooking beans on a fire kindled with bean stalks,
  - 豆在釜中泣。
  - The beans weep in the pot.
  - 本是同根生
  - Originally born from the selfsame roots,
  - 相煎何太急！
  - Why so eager to torture each other!

### Special Thanks

- Special thanks to Ran2 and DDL for their collaboration in analyzing these APT samples.
- Ran2 has been instrumental in providing valuable insights throughout the analysis.

### Research Methodology

#### Research Direction
- Our focus is not just on individual attacks but on observing the entire APT attack plan and trends.
- Traditional approaches often focus on malware forensics or a single victim's machine, which limits our understanding of the APT attack plan and its trends.

#### Analyzing APT Taskforce
- We analyze and extract features and characteristics of APT taskforces through:
  - Malware features
  - Exploits
  - C&C Network
  - Spear-phishing emails
  - Victim background
  - Time of attack

#### APT File Analysis and Grouping
- Theoretically, in an information system (i.e., malware analysis system), if we can collect all attributes/properties of our malicious sample sets, we can identify whether the executable/document/sample is malicious.
- Challenges include insufficient collection of attributes/characteristics, such as packed malware and anti-debugging capabilities, leading to indiscernibility relations.

#### Standard Analysis Methods
- **Static Approach**:
  - Extract signatures/features from file formats
  - Reverse engineering
- **Dynamic Approach**:
  - Execute under a controlled environment and capture/log behaviors
  - Analyze networking traffic
- **Challenges in Dynamic Analysis**:
  - Encryption
  - Obfuscation
  - Anti-VM/Sandbox
  - Dormant functionality
  - Side effects of master/bot interaction
- We prefer static analysis to avoid issues with anti-VM, dormant functionality, and side effects of master/bot interaction.

#### APT Attributes Focused On
- **Static Analysis**:
  - Extract and review executables, shellcode, and PE headers
  - Identify objects and abnormal structures in files
- **Dynamic Analysis**:
  - Install the system into Windows
  - Scan process memory to detect abnormal structures
  - Code injection, API hooking, and known code snippets
  - Suspicious strings: email addresses, domains, IPs, URLs

### Extracted Attributes from APT Files

- **CVE**: CVE-2009-3129
- **Shellcode**: Code=90903CFDEF, CAPO=E2FE9071, PUCA=002191CB
- **Entropy**: 6.821483
- **Network**: 140.128.115.***, smtp.126.com, test.3322.org.cn
- **Structure**: JS=A103FE426E214CE, JS=90C0C0C0C, AS=32EF90183227
- **Malware 1**:
  - PE=EF024788, Entry=000B7324, Code=D7B5A0120987FE, Code=83D2325AB5, Code=20BDCE
  - Autorun=STARTUP_FOLDER, Behavior=DLL-Injection, Password Collector
- **Malware 2**:
  - PE=EF93461A, Entry=0003CAC0, Code=AC23109B, Code=19EFAC21
  - Behavior=API-Hooking

### Clustering and Analysis

- **Clustering**:
  - Exploit Concept
  - Shellcode
  - Malware Concept
  - Code Snippet
  - Xecure Engine
  - Behavior
  - Exploit CVE
  - PE Information
  - Network Concept
  - C&C IP/Domain
  - Protocol

- **Fingerprints**:
  - SC.5D5819EE, SC.D810C601, PE.EBD5880B, PE.5A05A491, CD.FC7939E2, CD.102C752B, CD.2AFB773A, ML.47E1B4C6, NT.549535DD, CC.656C20E1, CC.77DEB444, ...

- **Save to Database**:
  - Extract fingerprints

### Analysis and Results

#### Experiment
- Mila's provided APT sample archives are confirmed to be malicious.
- These archives are publicly available for downloading and analysis (Collection 1, 242 APT files).
- Many researchers use these samples, and we highly credit Mila’s contributions: [Link](http://contagiodump.blogspot.com/)

#### Detection Rate
- **Xecure Inspector**: 94.6% (229/242)
- **Microsoft Security Essentials**: 21.4% (52/242)
- **Sophos**: 35.9% (87/242)
- **AntiVir**: 56.6% (137/242)

#### APT Taskforce Groups
- There are 8 major APT taskforce groups (A, B, C, D, E, F, G, H).

#### Top 3 APT Taskforce Groups
- **Group A**:
  - Active: 2009-09-23 ~ 2011-04-20
  - Number: 40
  - CVEs: CVE-2009-4841, CVE-2009-0927, CVE-2009-3129, CVE-2009-4324, CVE-2010-0188, CVE-2010-2833, CVE-2011-0611, CVE-2011-0609
  - Malware: APT00010
  - C&C: IP:23, Domain:5
- **Group B**:
  - Active: 2008-04-14 ~ 2011-02-11
  - Number: 26
  - CVEs: CVE-2006-6456, CVE-2008-0081, CVE-2009-1129, CVE-2009-4324, CVE-2010-0188, CVE-2010-2883, CVE-2010-3333
  - Malware: APT000A0
  - C&C: IP:23, Domain:4
- **Group C**:
  - Active: 2008-09-04 ~ 2011-04-13
  - Number: 21
  - CVEs: CVE-2007-5659, CVE-2008-4841, CVE-2009-1862, CVE-2009-3129, CVE-2009-4324, CVE-2009-0658, CVE-2009-0927
  - Malware: APT00200
  - C&C: IP:5, Domain:11

#### Malware and C&C Locations
- **Group A**:
  - 48.1% of C&C IPs located in Taiwan
- **Group B**:
  - 16% of C&C IPs located in Taiwan
- **Group E**:
  - Language: Korean

### Findings from Mila Sample Set

- **APT-Deezer**:
  - Provides a free online service to check if your submitted sample is an APT sample.
  - Uses Mila’s sample set as the base training set.
  - Identifies exploit CVEs and malware families.
  - Detects and analyzes zero-day exploits.
  - Performs APT malware sample DNA analysis and comparison.
  - Supports file formats including DOC, PPT, XLS, PDF, RTF.
  - URL: [Link](http://aptdeezer.xecure-lab.com)

### Case Study

- **Target Attack Mail**:
  - Another COMODO incident!
  - Identified as APT-Group-B.

### Conclusion

- **Xecure Lab**: [Link](http://www.xecure-lab.com)
- We continuously collect samples for analysis and enhance our capability to analyze and observe APT DNA families more accurately.
- This is an incremental effort contributing to the malware analysis community.
- Together, we make our homeland more secure.

### Special Thanks

- Every member of the Xecure Research Team, Mila, and everyone who contributed ideas.
- Our families and colleagues.

### Final Note

- Blackhat review board members, are you convinced yet?