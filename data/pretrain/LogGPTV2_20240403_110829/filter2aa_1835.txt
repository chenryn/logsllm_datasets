Finding useful and 
embarrassing information 
with Maltego 
ANDREW MACPHERSON 
ROELOF TEMMINGH 
2017 
© WAVESTONE 
2 
Dealing the Perfect hand  
Shuffling memory blocks on z/OS 
CICSPwn: tool to pentest CICS middleware on a Mainframe (Remote code 
execution, access control bypass, etc.) 
ELV.APF : script for escalating privileges using APF libraries on z/OS 
(Mainframe) 
ELV.SVC : script for looking for « magic » syscalls and abusing them to 
achieve root (Mainframe) 
Ayoub ELAASSAL 
@ayoul3__ 
Github.com/ayoul3 
Agenda 
u  Intro 
u  Footprinting - the good the bad and the machines 
u  Section One: 
u  Hunting ICS devices online in novel ways 
u  Section Two: 
u  Hunting interesting organisations with Databreaches from their networks 
u  Section Three: 
u  Identifying individuals at interesting locations 
u  Questions! 
u  Beer. 
Who am I? 
u  Andrew MacPherson 
u  @AndrewMohawk 
u  10 yrs at Paterva! 
u  PI:EMAIL 
u  Employee number: 00000001 
u  Tech support -> Webdev -> Win (@Paterva) 
u  B.Information Science degree (2006) 
u  With friends like mine…. #draco malfoy #worstfriends #shamecon 
u  Something about someone with a Maltego hammer 
Who was RT? 
u  Roelof Temmingh 
u  PI:EMAIL 
u  (co)Founder SensePost (2000) 
u  Testing pens for 7 years 
u  Building tools, writing books, doing talks 
u  Founder Paterva (2007) 
u  Managing director 
u  High level design 
u  New features 
u  14 x  BlackHat, 5 x Defcon. Bluehat, Ekoparty, Cansecwest, Ruxcon, etc. 
u  DCC, UE, FIRST, GovCERT 
What is Maltego? 
u Tons of tutorials 
u Videos too! 
HERE BE DEMOS! 
u  Demo’s rely on: 
u  Internet connection 
u  Code working 
u  Remote API’s working 
u  Nothing to have changed 
u  Sacrifices have been made but if you could keep your fingers, 
toes and tongues crossed that would help! 
u Or you are just gonna get pictures and interpretive dance  
Foot printing  
101 
Domain'
DNS'Name'
MX'
Website'
NS'
IP'Address'
Netblock'
AS'Number'
Sharing'MX'
9'methods'for'ﬁnding'
DNS'names'
Sharing'NS'
TLD'expand'
Mirror'
Resolve'IP'
Reverse'DNS'
Historic'DNS'
DNS'Name''
to'Domain'
Block'in''
reverse'DNS'
SPF'records'
Co-hosted'on'IP'
Netblock'to'AS'
AS'to'Netblock'
3'methods'to'take'
IP'to'Netblock'
Expand'Netblock''
to'IPs'
Foot printing 
with code 
Foot printing 
with Buttons 
Footprinting 
u  Gives us: 
u  Domains 
u  DNS Names  
u  IP Addresses 
u  Netblocks 
u  AS 
u  Basic information for targeting 
Example 
u  Energy companies in Las Vegas 
u  Nevada Energy seems to be the biggest 
u  NVEnergy.com footprint :) 
TLDR; Maltego is awesome for footprinting 
ICS devices 
u  Industrial Control Systems 
u  Used to operate / automate industrial processes 
u  Things like: 
u  Power 
u  Water  
u  Manufacturing 
u  Treatment 
u  Etc 
u  Systems you don’t want to break/fall over 
Hacking ICS devices  
u  Not for this talk 
u  Many talks /  Tweets / youtubez 
u  Targeting  
u  Devices 
u  Firewalls 
u  Protocol 
u  Etc 
u  Mostly deal with having access to the 
device 
u  But what if you need to find it first? 
ICS Devices … on the Internet? 
u  They have networking 
u  Most advise to keep them in an 
airgapped lan / offline 
u  Major Protocols: 
u  Modbus 
u  S7 
u  (Niagara) Fox 
u  BACnet 
u  But hopefully there are none 
online …right? 
Finding ICS devices on shodan 
u  Google Hacking-esque 
u  Multiple search strings 
u  “port: 9600 response code” 
u  “port:2404 asdu address” 
u  Results give 
u  IP Addresses 
u  Types ( CPU / Model / etc) 
u  “Locations” 
Hunting ICS Devices 
u  Find all ICS devices 
u  Try and do attribution 
u  Is it our target? Yes/No 
u  This doesn’t really work 
u  So many different devices/types 
u  None of them say “NVEnergy main powerplant” 
Hunting ICS devices with Maltego and Shodan 
u  There are many types of ICS 
u  Instead of doing one lets do all of them at once 
u  Build “super transform” to find them all 
u  ? + Search strings   
u  Domain 
u  Netblock (net: cidr) 
u  +whatever shodan keywords 
Hunting ICS Devices 
u  Instead of finding all, lets feed inputs: 
u  Domain/Netblock/IP 
u  Woohoo! Footprinting! 
u  This doesn’t really work either! 
u  Nothing in NVEnergy? 
u  Sometimes you do find it: 
u  Princeton.edu 
u  Usc.edu 
Hunting ICS Devices 
u  Okay so footprinting is out, what about 
other inputs: 
u  Geo-location? 
u  GPS near target->ICS 
u  Example: Las Vegas! 
u  Better results 
u  Manual 
u  Lucky 
Hunting ICS Devices 
u  Manually finding it is a pain in dense areas 
u  Isolated area? 
u  50.754101, 17.881712 
u  3km 
Hunting ICS Devices 
u  One power plant/GPS works okay 
u  What if we want all of them? 
u  How do we find their locations? 
u  GEONAMES! 
u  Can find places (and their co-ordinates) 
based on categories like: 
u  Power 
u  Water 
u  …you see where this is going 
Demo: Hunting ICS devices 
automatically 
u  Category (eg “Power”, “Water”,etc) 
u  Gives us locations on a country level 
u  Gives us ICS devices for a country! 
Hunting ICS Devices  
u  This relies on how good our GEO2IP is 
u  Is it good? 
u  “Sometimes” 
u  Denser Areas 
u  Better GEO->IP 
u  Less populated areas 
u  Worse, but is that okay? 
Breaches 
u  Footprinting ICS devices lets us find interesting infrastructure to target 
u  But what about people? 
u  What about people who work at interesting places 
Breaches 
u  Breaches Happen. 
u  Breaches are often used to do basic audits of companies 
u  How many employee’s (based on our domain) 
u  How many company cards 
u  Etc etc 
u  Plenty of work is done on this already via the usual sources ( blogs / 
“Big Data” white papers, etc ) 
u  AshMad as an example -> 
AshMad? Maltego MDS 
u  Free Beta at the moment 
u  I cant speak forever! 
u  Just one way you could get data in, others: 
u  Public TDS ( free! ) 
u  Local Transforms ( free! ) 
u  Import Graph from Table ( beer! ) 
u  Requires: 
u  Datasource ( MySQL / Splunk / MSSQL / etc) 
u  Query 
u  Mapping 
u  Takes each row returned and maps to entities 
Fixing Ashley Madison dump 
u  Ashley Madison dump is great for doing 
email->profile 
u  But its not really good for doing: 
u  Domain -> profiles 
u  Slow, needs a new col referencing the 
domain 
u  Limits subdomains ( you’d need to know 
em) 
u  IP Address -> profiles 
u  ‘signupip’ field has lots of entries like 
‘196.25.1.1,8’ 
u  Cant use like %% as its too slow 
u  Netblock -> profiles 
u  IP addresses are stored as strings 
u  Need to convert to long 
u  68.171.1.1 – 68.171.255.255 
u  1152057601 - 1152122879 
Ashley Madison dump 
u  We can interact with it as a “forward” 
method via 
u  Domain -> profile 
u  Email Address -> profile 
u  Alias -> profile 
u  Users don’t register work email 
accounts 
u  (you’d think hey.. State.gov?) 
Breaches for interesting targets 
u  But even if they do.. They definitely 
wouldn’t use these sites from work 
computers right? 
u  Footprinting now becomes super 
interesting 
u  Exit Nodes -> 
u  Wiki Edits -> 
u  Breach Data -> 
u  (and the reverse!) 
An Example 
u  CIA.gov  
Verification 
Shit happens… 
But… 
u  Profile seems too easy 
u  User / Pass 
u  Profiles 
u  etc 
u  Honeypot? Could be.. 
Other breaches?  
u  Friends at SocialLinks 
u  Many databases 
u  Lets see what that looks like with our current example… 
Other breaches?  
u  Leaked databases/mail? 
u  Confirm our footprints! 
More People! 
u  We found ICS devices via GPS 
u  Found people via footprinting + breaches 
u  What about people who work at interesting locations? (see 1.) 
More People 
3 Steps: 
1. 
Find “interesting” places, the same way we did with ICS 
u  Geonames + country 
2. 
Use twitter to search for GPS  
u  Geo/search 
3. 
??? 
4. 
Profit 
Conclusions 
u  ICS devices 
u  Difficult to attribute 
u  Usually not on the corp network / not visible to Internet 
u  Easier to find on GPS, but this runs the risk of collateral (which might be okay) 
u  Breach Data 
u  Gives a lot more then user details 
u  Private email addresses (outside org) -> other social networks 
u  Good for targeting people? 
u  Exit nodes 
u  Good for targeting infrastructure as they are likely to have both internal and external 
access 
Thanks && Questions 
u  @AndrewMohawk 
u  PI:EMAIL