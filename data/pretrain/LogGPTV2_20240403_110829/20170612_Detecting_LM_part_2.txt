Event ID: 5140 (A network share object was accessed)
- Confirmable Information
- Account Used for Connection: Subject -> Security ID and Account Name
- Source Host: Network Information -> Source Address and Source Port
- Connected Share: "\\*\IPC$" (administrative share)
Event ID: 5145 (A network share object was checked to see whether client can be granted desired access)
*The Event ID is recorded several times.
- Confirmable Information
- Account Used for Connection: Subject -> Security ID and Account Name
- Source Host Machine: Network Information -> Source Address and Source Port
- Targeted Share: Share Information -> Share Path
*The share path contains "PSEXESVC" and
"\\??\C:\Windows".
11
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4656 (A handle to an object was requested)
4660 (An object was deleted)
Event Log 4658 (The handle to an object was closed)
- Process Information -> Process ID: "0x4" (SYSTEM)
-
Security Required
- Confirmable Information
(Continued from the
- Targeted File: Object -> Object Name ("C:\Windows\PSEXESVC.exe")
previous entry)"
- Handle ID: Object -> Handle ID *This is used for association with other logs.
- Process Details: Access Request Information -> Access ("DELETE", "ReadAttributes")
- Success or Failure: Keywords ("Audit Success")
OS: Windows
user
Event ID: 1 (Process Create)
↓
Destination Host 5 (Process Terminated)
OS: Windows
(Continued from the - Image: "C:\Windows\PSEXESVC.exe"
administrator
previous entry) - User: "SYSTEM"
(Continued from
the previous - Confirmed Information
entry) - Date and Time PSEXESVC.exe was Executed: Log Date
Event Log
- Required
Sysmon Event ID: 1 (Process Create)
5 (Process Terminated)
- Confirmable Information
- Remotely Executed Process: Image
- Argument: CommandLine
- Process Start/End Date and Time (UTC): UtcTime *The date and time after the start of PSEXESVC.exe and before its end
- Account Used for Remote Execution: User
Remarks
Additional Event Logs That Can Be Output Information related to the process execution using PsExec may be recorded to the "Destination host".
12
3.2.2. WMIC (Windows Management Instrumentation Command Line)
Basic Information
Tool Name WMIC (Windows Management Instrumentation Command Line) Legend
Category Command execution -Acquirable
Tool Overview A tool used for Windows system management Information
Tool -Event ID/Item Name
Example of The tool is believed to be used to acquire information on the remote system or to execute a command with WMI.
-Field Name
Presumed Tool Use - Source host: wmic command execution source
-"Field Value"
During an Attack - Destination host: The host accessed by the wmic command
Authority Standard user *Depending on the command executed on the remote side, administrator privileges may be required.
Targeted OS Windows
Operating Domain Not required
Condition Communication
135/tcp, 445/tcp, a randomly selected TCP port 1024 or higher
Protocol
Service Windows Management Instrumentation, Remote Procedure Call (RPC)
Information Standard Settings - Execution history (Prefetch)
Acquired from Additional Settings - Process execution details (the argument to wmic) and execution success or failure (the return value) (Sysmon and audit policy)
If the following logs that have the same log time are found at "source host" and "destination host", it is possible that a remote connection was made.
- Source host: If the following log is in the event log:
Evidence That Can Be Confirmed
- The event ID 4689 (A process has exited) of WMIC.exe was recorded in the event log "Security" with the execution result (return value) of "0x0".
When Execution is Successful
- Destination host: If the following log is in Sysmon:
- It is recorded in the event log "Sysmon" that WmiPrvSE.exe was executed with the event IDs 1 and 5.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\wbem\WMIC.exe"
Event Log
- Confirmable Information
- Required
- Process Start/End Time and Date: Log Date
Security
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 1 (Process Create)
5 (Process Terminated)
Source Host
- Image: "C:\Windows\System32\wbem\WMIC.exe"
Event Log
- Confirmable Information
- Required
OS: Windows - Process Start/End Time and Date (UTC): UtcTime
Sysmon
user - Process Command Line: CommandLine *Based on the wmic.exe argument, the remote host and executed command can be
↓
confirmed.
OS: Windows - Executing user Name: User
administrator - Process ID: ProcessId
File Name:
Execution History C:\Windows\Prefetch\WMIC.EXE-98223A30.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Executed Time
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\wbem\WmiPrvSE.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine ("C:\Windows\System32\wmiprvse.exe -secured -Embedding")
Destination Host - User Name: User ("NT AUTHORITY\NETWORK SERVICE")
- Process ID: ProcessId
File Name:
Execution History C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
Remarks
- Depending on the process called by wmic, the process-specific logs may be recorded.
Additional Event Logs That Can Be Output - If the user exists on the Active Directory, the authentication request may be recorded in the Domain Controller.
However, it is not possible to determine whether such an authentication request was made by wmic or others.
13
3.2.3. PowerShell (Remote Command Execution)
Basic Information
Tool Name PowerShell (Remote Command Execution)
Category Command Execution Legend
A command line tool that can be used for Windows management and settings (it is available by default in Windows 7 or later) - Acquirable
Tool Overview
In addition to the host that executes PowerShell, this tool enables commands to be executed on other hosts via a network. Information
- Event ID/Item Name
Example of The tool may be used to change settings to enable the Domain Controller and other hosts on the network to perform operations requiring administrator rights.
- Field Name
Tool Presumed Tool Use - Source host: PowerShell command execution source
- "Field Value"
During an Attack - Destination host: The destination logged in by the PowerShell command
Execution Example Execute the following commands *The Windows Remote Management (WS-Management) service needs to be started at the destination host.
(with commands > Enable-PSRemoting -force
used for > Set-Item WSMan:\localhost\Client\TrustedHosts -Value *
verification) > Enter-PSSession "[Destination Host]" -Credential Administrator
Authority PowerShell can be used by standard users. *To execute a script for changing settings, appropriate rights are needed on the host to change settings.
Targeted OS Windows
Operating
Domain Not required
Condition
Communication Protocol Not required to manage within local machines. *To manage other hosts, use 80/tcp or 5985/tcp for HTTP and 443/tcp or 5986/tcp for HTTPS.
Service Destination host: Windows Remote Management (WS-Management)
Information Standard Settings Execution history (Prefetch)
Acquired from Execution history (Sysmon, audit policy) *The end event of PowerShell allows execution results to be confirmed.
Additional Settings
Log With audit policy, it is possible to confirm the occurence of communication from the source host to the destination host 5985/tcp (HTTP) or 5986/tcp (HTTPS).
If the following logs that have the same log time are found, it is possible that a remote command was executed. *This also applies to Prefetch.
- Source host: If the following log is in the event log:
Evidence That Can Be Confirmed
- The event ID 4689 (A process has exited) of PowerShell was recorded in the event log "Security" with the execution result (return value) of "0x0".
When Execution is Successful
- Destination host: If the following log is in the event log:
- The event ID 4689 (A process has exited) of wsmprovhost.exe was recorded in the event log "Security" with the execution result (return value) of "0x0".
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\Windows PowerShell\v1.0\powershell.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event Log
- Event ID: 5156 (The Windows Filtering Platform has allowed a connection) Required
Security - Process Name: "\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe"
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "::1"
- Network Information -> Destination Port / Protocol: "47001" / "6" (TCP)
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Process Name: "\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe"
Source Host
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Destination Host]"
・Network Information -> Destination Port / Protocol: "5985"(HTTP) or "5986"(HTTPS) / "6"(TCP)
*A port number can be changed by specifying it on the destination host side.
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\Windows PowerShell\v1.0\powershell.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine: "C:\Windows\System32\Windows
- User Name: User
- Process ID: ProcessId
File Name:
Execution History C:\Windows\Prefetch\POWERSHELL.EXE-920BBA2A.pf
- -
OS: Windows - Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
user - Last Execution Time and Date: Last Execution Time
↓
OS: Windows
administrator Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Process ID: "4"
- Application Name: "System"
- Network Information -> Direction: "Inbound"
Required
- Confirmed Information
- Source Host: Network Information -> Source Address
- Incoming Call Port: Network Information -> Source Port ("5985" for HTTP, "5986" for HTTPS)
- Protocol: Network Information -> Protocol ("6")
Event Log
Event ID: 4624 (An account was successfully logged on)
-
- Logon Type: "3"
Security
- Confirmable Information
- Date and Time of Successful Logon: Log Date
*The date immediately after the wsmprovhost.exe process was created (Event ID 4688) and before it ended (Event ID 4689).
- Name of Account That Executed the Process on the Destination Host: New Logon -> Security ID / Account Name -
Destination Host Event ID: 4634 (An account was logged off)
- Confirmable Information
- Date and Time of Logoff: Log Date *The date after the end of the wsmprovhost.exe process (Event ID 4689) at the source host.
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\at.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine: "C:\Windows\System32\wsmprovhost.exe -Embedding"
- User Name: User
- Process ID: ProcessId
File Name:
Execution History C:\Windows\Prefetch\WSMPROVHOST.EXE-EF06207C.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
14
Remarks
Additional Event Logs That Can Be Output Depending on the command that is executed, logs output by the command may be recorded at the destination host.
15
3.2.4. wmiexec.vbs
Basic Information
Tool Name wmiexec.vbs Legend
Category Command Execution -Acquirable
Tool Overview A tool used for Windows system management Information
Tool -Event ID/Item Name
Example of This tool executes a script for other hosts.
-Field Name
Presumed Tool Use - Source host: The source that executes wmiexec.vbs
-"Field Value"
During an Attack - Destination host: The machine accessed by the wmiexec.vbs
Authority Standard user
Targeted OS Windows
Operating
Domain Not required
Condition
Communication Protocol 135/tcp, 445/tcp
Service -
Information Standard Settings - Execution history (Prefetch)
Acquired from - File creation/delete history (Audit policy)
Additional Settings
Log - Execution history (Sysmon)
Evidence That Can Be Confirmed
Destination host: The "WMI_SHARE" share has been created and deleted.
When Execution is Successful
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\cscript.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
Event Log - Domain of User Who Executed the Process: Subject -> Account Domain
- - Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type Required
Security - Process Return Value: Process Information -> Exit Status
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Process Name: "\device\harddiskvolume2\windows\system32\cscript.exe"
- Confirmable Information
- Source Port: Network Information -> Destination Port *A port number can be changed by specifying it on the destination.
Source Host
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\cscript.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
File Name:
Execution History C:\Windows\Prefetch\CSCRIPT.EXE-D1EF4768.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Object -> Object Name: "(C:\Windows\Temp\wmi.dll)"
- Access Request Information -> Access / Reason for Access: ("WriteData (or AddFile)", "AppendData (or AddSubdirectory or
CreatePipeInstance)")
- Confirmable Information
- Process Name: "C:\Windows\System32\cmd.exe"
- Handle ID: Object -> Handle ID *This is used for association with other logs.
OS: Windows
user
↓
Event ID: 5142 (A network share object was added.)
OS: Windows
user - Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Share Name: Share Information -> Share Name: ("\\*\WMI_SHARE")
- Share Path: Share Information -> Share Path: ("C:\Windows\Temp")
Event ID: 5145 (A network share object was checked to see whether the client can be granted the desired access)
Event Log
- - Confirmable Information Required
Security - Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Share Name: Share Information -> Share Name "\\*\WMI_SHARE"
( )
- Share Path: Share Information -> Share Path "\??\C:\windows\temp"
( )
Destination Host - Share Path: Share Information -> Relative Target Name: ("wmi.dll")
Event ID: 4656 (A handle to an object was requested)
4660 (An object was deleted)
4658 (The handle to an object was closed)
- Object -> Object Name: "(C:\Windows\Temp\wmi.dll)"
- Access Request Information -> Access/Reason for Access: "DELETE"
- Confirmable Information
- Process Name: "(C:\Windows\System32\cmd.exe)"
Event ID: 5144 (A network share object was deleted.)
- Confirmable Information
- Share Name: Share Information -> Share Name ("\\*\WMI_SHARE")
- Share Path: Share Information -> Share Path: ("C:\Windows\Temp")
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\wbem\WmiPrvSE.exe"
"C:\Windows\System32\cmd.exe"
Event Log
- Required
- Confirmable Information