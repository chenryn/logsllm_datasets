## Page 569
554
第25章创建与数据库、Web及电子邮件相关的脚本
当然，并不是只能从数据表中提取数据。你可以在脚本中使用任何类型的SQL命令，比如
INSERT语句。
$ cat mtest3
 send data to the table in the MySQL database
1/bin/bash.
HYaQL=$ (vhich. nysq1)
if [ $# -ne 4 ]
then
Aretea ausuqarrg aueuet prdua casagu 1aes. ouoa
else
statement=*INSERT INTO enployees VALUES ($1,*$2', *$3', $4)*
$MYSQL mytest -u test 
T = ptduo arag saatodua uo1g ￥ qootae, a- x- qsaq n- qsa/a [ba/u s
EOM>
1
n
25000
field name=*firstname*>Richc/field>
通过使用XML，你能够轻松标识出每条记录以及记录中的各个字段值。然后你就可以使用
标准的Linux字符串处理功能来提取需要的数据。
25
25.2使用Web
通常在考虑shell脚本编程时，最不可能考虑到的就是互联网了。命令行世界看起来往往跟丰
富多彩的互联网世界格格不人。但你可以在shell脚本中非常方便的利用一些工具访问Web以及其
他网络设备中的数据内容。
作为一款于1992年由堪萨斯大学的学生编写的基于文本的浏览器，Lynx程序的历史几乎和互
联网一样悠久。因为该浏览器是基于文本的，所以它允许你直接从终端会话中访问网站，只不过
---
## Page 571
556第25章创建与数据库、Web及电子邮件相关的脚本
Web页面上的那些漂亮图片被替换成了HTML文本标签。这样你就可以在几乎所有类型的Linux
终端上浏览互联网了。图25-2展示了Lynx的界面。
  rich@rich-Parallels-Virtual-Platferm: 
File Edit View Search Terminal Help
Lynx source distribution ad potpourri
eabewthay brese;vall
图25-2使用Lynx浏览Web页面
Lynx使用标准键盘按键浏览网页。链接会在Web页面上以高亮文本的形式出现。使用向右方
向键可以跟随一个链接到下一个Web页面。
你可能想知道如何在shell脚本中使用图形化文本程序。Lynx程序还提供了一个功能，允许你
将Web页面的文本内容转储到sTDOUT中。这个功能非常适合用来挖据Web页面中包含的数据。本
节将会介绍如何在shell脚本中用Lynx程序提取网站中的数据。
25.2.1安装Lynx
尽管Lynx程序有点古老，但它的开发仍然很活跃。在本书写作时，Lynx的最新版本是2010
年6月发布的2.8.8，新版本正在研发中。鉴于它在shell脚本程序员中十分流行，许多Linux发行版
都将它作为默认程序安装。
如果你正在用一个不带Lynx程序的Linux系统，请检查一下该发行版的安装包。大多数情况
下，你都能在那里找到Lynx包并轻松地安装好
如果发行版没有提供Lynx包，或者你想用最新版的，可以从lynx.isc.org网站上下载源码并编
译（假定你已经在Linux系统上安装了C开发库）。参考第9章获取有关如何编译并安装源码包的相
关信息。
---
## Page 572
25.2使用Web
557
说明Lynx程序使用了Linux中的curses文本图形库。大多数发行版会殿认安装这个库。如果你
的发行版没有安装，在尝试编译Lynx前先参考你的发行版的安装指南来安装curses库。
下一节将会介绍如何在命令行上使用1ynx命令。
25.2.21ynx命令行
lynx命令行命令极其擅长从远程网站上提取信息。当用浏览器查看Web页面时，你只是看到
了传送到浏览器中信息的一部分。Web页面由三种类型的数据组成：
 HTTP买部
 cookie
HTML内容
HTTP头部提供了连接中传送的数据类型、发送数据的服务器以及采用的连接安全类型的相
关信息。如果你发送的是特殊类型的数据，比如视频或音频剪辑，服务器会将其在HTTP头部中
标示出来。Lynx程序允许你查看Web页面会话中发送的所有HTTP头部。
如果你浏览过Web页面，对Web页面cookie一定不会陌生。网站用cookie存储有关网站的访间
数据，以供将来使用。每个站点都能存储信息，但只能访问它自已设置的信息。1ynx命令提供
了一些选项来查看Web服务器发送的cookie，还可以接受或拒绝服务器发过来的特定cookie。
Lynx程序支持三种不同的格式来查看Web页面实际的HTML内容：
口在终端会话中利用curses图形库显示文本图形；
口文本文件，文件内容是从Web页面中转储的原始数据；
口文本文件，文件内容是从Web页面中转储的原始HTML源码。
对于shell脚本，原始数据或HTML源码可是一座金山。一旦你获得了从网站上检索到的信息，
就能轻松地从中提取每一条信息。
如你所见，Lynx程序将它的本职工作发挥到了极致。但随之而来的是复杂性，尤其是对命令
行参数来说。Lynx程序是你在Linux世界中遇到的较复杂的程序之一。
lynx命令的基本格式如下。
lynx opt.ona URL
25
其中URL是你要连接的HTTP或HTTPS地址，options则是一个或多个选项。这些选项可以
在Lynx与远程网站交互时改变它的行为。许多命令行参数定义了Lynx的行为，可以用来控制全屏
模式下的Lynx，允许在浏览Web页面时对其进行定制。
在正常的浏览环境中，你通常会发现有几组命令行参数非常有用。你不用每次使用Lynx时都
在命令行上将这些参数输人一遍，Lynx提供了一个通用配置文件来定义Lynx的基本行为。我们将
在下一节中讨论这个配置文件。
---
## Page 573
558第25章创建与数据库、Web及电子邮件相关的脚本
25.2.3Lynx配置文件
lynx命令会从配置文件中读取大量的参数设置。默认情况下，这个文件位于
usr/local/lib/lynx.cfg，不过有许多Linux发行版将其改放到了/etc目录下（/etc/lynx.cfg）（Ubuntu
发行版将lynx.cfg故到了/etc/lynx-curl目录中）。
lynx.cfg配置文件将相关的参数分组到不同的区域中，这样更容易找到参数。配置文件中条
目的格式为：
PARANETER: va7ue
其中PARAMETER是参数的全名（通常都是用大写字母，但也不总是如此），vaIue是跟参数
关联的值。
浏览一下这个文件，你会发现许多参数都跟命令行参数类似，比如ACCEPT_ALL_COOKIES
参数就等同于设置了-accept_all_cookies命令行参数。
还有一些配置参数功能类似，但名称不同。FORCE_SSL_COOKIES_SECURE配置文件参数设
置可以用-force_secure命令行参数给覆盖掉。
你还会发现少数配置参数并没有对应的命令行参数。这些值只能在配置文件中设定。
最常见的你不能在命令行上设置的配置参数是代理服务器。有些网络（尤其是公司网络）使
用代理服务器作为客户端浏览器和目标网站的桥梁。客户端浏览器不能直接向远程Web服务器发
送HTTP请求，而是必须将它们的请求发到代理服务器上，然后由代理服务器将请求转发给远程
Web服务器，获取结果，再将结果回传给客户端浏览器。
虽然这看起来像在浪费时间，但它是保护客户端不受互联网上危险侵害的重要功能。代理服
务器可以过滤不良内容和恶意代码，甚至可以发现钓鱼网站（为了获取用户数据，假扮他人的流
氓服务器）。代理服务器还可以帮助降低网络带宽的使用，因为它缓存了经常浏览的Web页面并
将其直接返回给客户端，而不用再从原始地址处下载页面。
用来定义代理服务器的配置参数有：
http_proxy :http:/ /sone ,sexver, don:port/
httpa_pxoxy :ht.tp : / /some , server , dom:port. )
ftp_pxoxy :http : //some , server , dom:port. /
gophex_proxy :http1//eome,aervex dom:port /
news_proxy :http: / /sone ,sexver , don:port,
neusreply_proxy :http=/ /sone sexver , dom:poxt /
newspost_proxy :http: //some , servex, don: port /
snews_pxoxy :ht.tp : / /some , server , dom:port. )
snewexeply_proxy :http : //some , servex, don:port./
snewspost_proxy :htt.p:/ /sone sexver , dom:poxt /
nntp_proxy :http:/ /sose sexver , don:port/
va1s_proxy :htt.p: / /sone sexver , Gom:port /
fingex_proxy :http: //some. servex, don: port/
cso_pxoxy :http : //some, server, dom:port. /
no_proxy :hoat donain.don
你可以为任何Lynx支持的网路协议定义不同的代理服务器。NO_PROXY参数是逗号分隔的网
---
## Page 574
25.2使用Web
559
站列表。对于列表中的这些网站，不希望使用代理服务器直接访问。这些通常都是不需要过滤的
内部网站。
25.2.4从Lynx中获取数据
在shell脚本中使用Lynx时，大多数情况下你只是要提取Web页面中的某条（或某几条）特定
信息。完成这个任务的方法称作屏幕抓取（scrcen scraping）。在屏幕抓取过程中，你要尝试通过
编程寻找图形化屏幕上某个特定位置的数据，这样你才能获取它并在脚本中使用。
用1ynx进行屏幕抓取的最简单办法是用-dump选项。这个选项不会在终端屏幕上显示Web
页面。相反，它会将Web页面文本数据直接显示在STDOUT上。
$ lynx -dunp http1 //localhost /RecipeCent.er/
The Recipe Center
*Just like mon used to nake*
Melcone
[1]Hone
[3]Regieter for free login
[2]Login to post
[4]Post a new recipe
每个链接都由一个标号标定，Lynx在Web页面数据后显示了所有标号所指向的地址。
在从Web页面中获得了所有文本数据之后，你可能已经知道我们会从工具箱中取出什么工具
来提取数据了。没错，就是我们的老朋友sed编辑器和gawk程序（参见第19章）。
首先，让我们找一些有意思的数据来收集。Yahoo!天气页面是找出全世界任何地区当前气候
的不错来源。每个位置都用一个单独的URL来显示该城市的天气信息（你可以在浏览器中打开该
站点并输人你的城市信息来获取所在地的特定URL）。查看伊利诺伊州芝加哥市的天气情况的
Lynx命令如下:
lynx -dump http1//veather -yahoo.com./united-states/i11inois/chicago2379574/
这条命令会从页面中转储出很多的数据。第一步是找到你需要的准确信息。要做到这点，需
将1ynx命令的输出重定向到一个文件中，然后在文件中查找数据。执行了前面的命令后，我们
在输出文件中找到了这段文本。
25
Current conditions as of 1:54 pn EDT
Mostly Cloudy
Feels Like1
32op
Baroneter1
30.13 in and rising
Humidity1
508
---
## Page 575
560
第25章创建与数据库、Web及电子邮件相关的脚本
Vigibillty:
TW 0T
Devpoint :
15 °F
Wind:
 10 nph
这都是你需要的关于当前天气的所有信息。但这段输出中有个小问题。你会注意到，数字都
是在标题下面一行的。只提取单独的数字有些困难。第19章讨论过如何处理这样的问题。
解决这一问题的关键是先写一个能查找数据标题的sed脚本。找到之后，你就可以到正确的
行中提取数据了。很幸运，这个例子中我们所需要的数据就是那些文本行。这里应该只用sed脚
本就能解决了。如果在同一行中还有其他文本，就需要使用gawk工具来过滤出我们需要的数据。
首先，你需要创建一个sed脚本来查找表示地点的文本，然后跳到下一行来获取描述当前天
气状况的文本并打印出来。输出芝加哥天气的脚本如下。
$ cat sedcond
/IL, Unlted States/
P
1
S
地址指明了要查找的行。如果sec命令找到了，n命令就会跳到下一行，然后p命令会打印当
前行的内容，也就是描述该城市当前天气状况的文本。
下一步，你需要一段sed脚本来查找文本FeelsLike，并打印出下一行的温度。
$ cat sedtenp
/Feelα Like/ [
P
$
漂亮极了。现在你可以在shell脚本中用这两个sed脚本。首先将Web页面的1ynx输出放人一
个临时文件中，然后对Web页面数据使用这两个sed脚本，提取所需的数据。下面的例子演示了具
体的做法。
$ cat veatbex
extract che current veather Cor Chicago, IL
#1/bIn/bash
URL=*bttp ://veat.her yaboo, com/un.ited=atate8/111inols/chlcago23795T4 /*
TMPPILE=$ (nktenp tnpxXxxXXx)
LYNX=$ (vb1ch lynx)
3TIadKLS<THNS dmp-XXATS
tenp=s Icat $TMPPILE I sed -n -f sedtenp I avk *(print $4)|
condit.iong=S (cat STMPFILE 1 sed -n -f sedcond)
echo *Current conditions: $conditions*
XTI&4NI$ - UX
---
## Page 576
25.3使用电子邮件
561
echo The cuxrent tenp outalde ls: Stemp
-/weather
The cuxrent tenp outalde is: 32 oF
Current conditlons: Xostly Cloudy