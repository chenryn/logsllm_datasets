M A N N I N G
Neil Madden
API security
Authorization
Audit logging
Authentication
Encryption
Rate-limiting
Passwords
Token-based
Cookies
Macaroons
JWTs
Certiﬁcates
End-to-end
Identity-based
ACLs
Roles
ABAC
Capabilities
OAuth2
Security mechanisms
Mechanism
Chapter
Audit logging
3
Rate-limiting
3
Passwords
3
Cookies
4
Token-based auth
5
Macaroons
JSON web tokens (JWTs)
6
Mechanism
Chapter
Access control lists (ACL)
3
Roles
Attribute-based access
control (ABAC)
8
Capabilities
Oauth2
Encryption
6
End-to-end authentication
13
11
Certiﬁcates
7
8
9
9
API Security
in Action
NEIL MADDEN
M A N N I N G
SHELTER ISLAND
For online information and ordering of this and other Manning books, please visit
www.manning.com. The publisher offers discounts on this book when ordered in quantity. 
For more information, please contact
Special Sales Department
Manning Publications Co.
20 Baldwin Road
PO Box 761
Shelter Island, NY 11964
Email: PI:EMAIL
©2020 by Manning Publications Co. All rights reserved.
No part of this publication may be reproduced, stored in a retrieval system, or transmitted, in 
any form or by means electronic, mechanical, photocopying, or otherwise, without prior written 
permission of the publisher.
Many of the designations used by manufacturers and sellers to distinguish their products are 
claimed as trademarks. Where those designations appear in the book, and Manning Publications 
was aware of a trademark claim, the designations have been printed in initial caps or all caps.
Recognizing the importance of preserving what has been written, it is Manning’s policy to have 
the books we publish printed on acid-free paper, and we exert our best efforts to that end. 
Recognizing also our responsibility to conserve the resources of our planet, Manning books
are printed on paper that is at least 15 percent recycled and processed without the use of 
elemental chlorine.
Development editor: Toni Arritola
Technical development editor: Joshua White
Manning Publications Co.
Review editor: Ivan Martinovic´
20 Baldwin Road
Production editor: Deirdre S. Hiam
PO Box 761
Copy editor: Katie Petito
Shelter Island, NY 11964
Proofreader: Keri Hales
Technical proofreader: Ubaldo Pescatore
Typesetter: Dennis Dalinnik
Cover designer: Marija Tudor
ISBN: 9781617296024
Printed in the United States of America
 In memory of Susan Elizabeth Madden, 1950–2018.
v
contents
preface
xi
acknowledgments
xiii
about this book
xv
about the author
xix
about the cover illustration
xx
PART 1
FOUNDATIONS ....................................................1
1 
What is API security?
3
1.1
An analogy: Taking your driving test
4
1.2
What is an API?
6
API styles
7
1.3
API security in context
8
A typical API deployment
10
1.4
Elements of API security
12
Assets
13
■ Security goals
14
■ Environments and 
threat models
16
1.5
Security mechanisms
19
Encryption
20
■ Identification and authentication
21
Access control and authorization
22
■ Audit logging
23
Rate-limiting
24
CONTENTS
vi
2 
Secure API development
27
2.1
The Natter API
27
Overview of the Natter API
28
■ Implementation overview
29
Setting up the project
30
■ Initializing the database
32
2.2
Developing the REST API
34
Creating a new space
34
2.3
Wiring up the REST endpoints
36
Trying it out
38
2.4
Injection attacks
39
Preventing injection attacks
43
■ Mitigating SQL injection 
with permissions
45
2.5
Input validation
47
2.6
Producing safe output
53
Exploiting XSS Attacks
54
■ Preventing XSS
57
Implementing the protections
58
3 
Securing the Natter API
62
3.1
Addressing threats with security controls
63
3.2
Rate-limiting for availability
64
Rate-limiting with Guava
66
3.3
Authentication to prevent spoofing
70
HTTP Basic authentication
71
■ Secure password storage with 
Scrypt
72
■ Creating the password database
72
■ Registering 
users in the Natter API
74
■ Authenticating users
75
3.4
Using encryption to keep data private
78
Enabling HTTPS
80
■ Strict transport security
82
3.5
Audit logging for accountability
82
3.6
Access control
87
Enforcing authentication
89
■ Access control lists
90
Enforcing access control in Natter
92
■ Adding new members to 
a Natter space
94
■ Avoiding privilege escalation attacks
95
PART 2
TOKEN-BASED AUTHENTICATION........................99
4 
Session cookie authentication
101
4.1
Authentication in web browsers
102
Calling the Natter API from JavaScript
102
■ Intercepting form 
submission
104
■ Serving the HTML from the same origin
105
Drawbacks of HTTP authentication
108
CONTENTS
vii
4.2
Token-based authentication
109
A token store abstraction
111
■ Implementing token-based 
login
112
4.3
Session cookies
115
Avoiding session fixation attacks
119
■ Cookie security 
attributes
121
■ Validating session cookies
123
4.4
Preventing Cross-Site Request Forgery attacks
125
SameSite cookies
127
■ Hash-based double-submit cookies
129
Double-submit cookies for the Natter API
133
4.5
Building the Natter login UI
138
Calling the login API from JavaScript
140
4.6
Implementing logout
143
5 
Modern token-based authentication
146
5.1
Allowing cross-domain requests with CORS
147
Preflight requests
148
■ CORS headers
150
■ Adding CORS 
headers to the Natter API
151
5.2
Tokens without cookies
154
Storing token state in a database
155
■ The Bearer authentication 
scheme
160
■ Deleting expired tokens
162
■ Storing tokens in 
Web Storage
163
■ Updating the CORS filter
166
■ XSS 
attacks on Web Storage
167
5.3
Hardening database token storage
170
Hashing database tokens
170
■ Authenticating tokens with 
HMAC
172
■ Protecting sensitive attributes
177
6 
Self-contained tokens and JWTs
181
6.1
Storing token state on the client
182
Protecting JSON tokens with HMAC
183
6.2
JSON Web Tokens
185
The standard JWT claims
187
■ The JOSE header
188
Generating standard JWTs
190
■ Validating a signed JWT
193
6.3
Encrypting sensitive attributes
195
Authenticated encryption
197
■ Authenticated encryption with 
NaCl
198
■ Encrypted JWTs
200
■ Using a JWT library
203
6.4
Using types for secure API design
206
6.5
Handling token revocation
209
Implementing hybrid tokens
210
CONTENTS
viii
PART 3
AUTHORIZATION.............................................215
7 
OAuth2 and OpenID Connect
217