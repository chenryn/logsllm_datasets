13/04/2018 Page 10 of 283
14. HBASE ............................................................................................................................................ 183
14.1.1. 概念 ............................................................................................................................................ 183
14.1.2. 列式存储 .................................................................................................................................... 183
14.1.3. Hbase核心概念 ........................................................................................................................ 184
14.1.3.1. Column Family列族 ....................................................................................................................... 184
14.1.3.2. Rowkey（Rowkey查询，Rowkey范围扫描，全表扫描） ....................................................... 184
14.1.3.3. Region分区 ...................................................................................................................................... 184
14.1.3.4. TimeStamp多版本 .......................................................................................................................... 184
14.1.4. Hbase核心架构 ........................................................................................................................ 184
14.1.4.1. Client： ............................................................................................................................................. 185
14.1.4.2. Zookeeper：.................................................................................................................................... 185
14.1.4.3. Hmaster ............................................................................................................................................ 185
14.1.4.4. HregionServer ................................................................................................................................. 185
14.1.4.5. Region寻址方式（通过zookeeper .META） ............................................................................ 186
14.1.4.6. HDFS ................................................................................................................................................. 186
14.1.5. Hbase的写逻辑 ........................................................................................................................ 187
14.1.5.1. Hbase的写入流程 ........................................................................................................................... 187
获取RegionServer ............................................................................................................................................ 187
请求写Hlog ........................................................................................................................................................ 187
请求写MemStore .............................................................................................................................................. 187
14.1.5.2. MemStore刷盘 ............................................................................................................................... 187
全局内存控制 ...................................................................................................................................................... 188
MemStore达到上限........................................................................................................................................... 188
RegionServer的Hlog数量达到上限 ............................................................................................................... 188
手工触发 .............................................................................................................................................................. 188
关闭RegionServer触发 .................................................................................................................................... 188
Region使用HLOG恢复完数据后触发............................................................................................................ 188
14.1.6. HBase vs Cassandra ............................................................................................................... 188
15. MONGODB ..................................................................................................................................... 190
15.1.1. 概念 ............................................................................................................................................ 190
15.1.2. 特点 ............................................................................................................................................ 190
16. CASSANDRA ................................................................................................................................. 192
16.1.1. 概念 ............................................................................................................................................ 192
16.1.2. 数据模型 .................................................................................................................................... 192
Key Space（对应SQL数据库中的database） ................................................................................................ 192
Key（对应SQL数据库中的主键） ...................................................................................................................... 192
column（对应SQL数据库中的列） .................................................................................................................... 192
super column（SQL数据库不支持） .................................................................................................................. 192
Standard Column Family（相对应SQL数据库中的table） ............................................................................ 192
Super Column Family（SQL数据库不支持） ................................................................................................... 192
16.1.3. Cassandra一致Hash和虚拟节点 ......................................................................................... 192
一致性Hash（多米诺down机） ......................................................................................................................... 192
虚拟节点（down机多节点托管） ........................................................................................................................ 193
16.1.4. Gossip协议 ............................................................................................................................... 193
Gossip节点的通信方式及收敛性 ......................................................................................................................... 194
Gossip两个节点（A、B）之间存在三种通信方式（push、pull、push&pull） ........................................ 194
gossip的协议和seed list（防止集群分列） .................................................................................................. 194
16.1.5. 数据复制 .................................................................................................................................... 194
Partitioners（计算primary key token的hash函数） ....................................................................................... 194
两种可用的复制策略： .......................................................................................................................................... 194
SimpleStrategy：仅用于单数据中心， ........................................................................................................... 194
将第一个replica放在由partitioner确定的节点中，其余的replicas放在上述节点顺时针方向的后续节
点中。 .................................................................................................................................................................. 194
13/04/2018 Page 11 of 283
NetworkTopologyStrategy：可用于较复杂的多数据中心。 ......................................................................... 194
可以指定在每个数据中心分别存储多少份replicas。 ................................................................................... 194
16.1.6. 数据写请求和协调者 ................................................................................................................ 195
协调者(coordinator) ................................................................................................................................................ 195
16.1.7. 数据读请求和后台修复 ............................................................................................................ 195
16.1.8. 数据存储（CommitLog、MemTable、SSTable） ........................................................... 196
SSTable文件构成（BloomFilter、index、data、static） ................................................................................ 196
16.1.9. 二级索引（对要索引的value摘要，生成RowKey）.......................................................... 196
16.1.10. 数据读写 ................................................................................................................................ 197
数据写入和更新（数据追加） .............................................................................................................................. 197
数据的写和删除效率极高 .................................................................................................................................. 197
错误恢复简单 ...................................................................................................................................................... 197
读的复杂度高 ...................................................................................................................................................... 197
数据删除（column 的墓碑） ................................................................................................................................ 197
墓碑...................................................................................................................................................................... 198
垃圾回收compaction ........................................................................................................................................ 198
数据读取（memtable+SStables） ................................................................................................................ 198
行缓存和键缓存请求流程图 .................................................................................................................................. 199
Row Cache（SSTables中频繁被访问的数据） ............................................................................................ 199
Bloom Filter（查找数据可能对应的SSTable） ............................................................................................. 200
Partition Key Cache（查找数据可能对应的Partition key） ........................................................................ 200
Partition Summary（内存中存储一些partition index的样本） ................................................................... 200
Partition Index（磁盘中） ................................................................................................................................ 200
Compression offset map（磁盘中） ............................................................................................................... 200
17. 设计模式 .......................................................................................................................................... 201
17.1.1. 设计原则 .................................................................................................................................... 201
17.1.2. 工厂方法模式 ............................................................................................................................ 201
17.1.3. 抽象工厂模式 ............................................................................................................................ 201
17.1.4. 单例模式 .................................................................................................................................... 201
17.1.5. 建造者模式 ................................................................................................................................ 201
17.1.6. 原型模式 .................................................................................................................................... 201
17.1.7. 适配器模式 ................................................................................................................................ 201
17.1.8. 装饰器模式 ................................................................................................................................ 201
17.1.9. 代理模式 .................................................................................................................................... 201
17.1.10. 外观模式 ................................................................................................................................ 201
17.1.11. 桥接模式 ................................................................................................................................ 201
17.1.12. 组合模式 ................................................................................................................................ 201
17.1.13. 享元模式 ................................................................................................................................ 201
17.1.14. 策略模式 ................................................................................................................................ 201
17.1.15. 模板方法模式 ........................................................................................................................ 201
17.1.16. 观察者模式 ............................................................................................................................ 201
17.1.17. 迭代子模式 ............................................................................................................................ 201
17.1.18. 责任链模式 ............................................................................................................................ 201
17.1.19. 命令模式 ................................................................................................................................ 201
17.1.20. 备忘录模式 ............................................................................................................................ 201
17.1.21. 状态模式 ................................................................................................................................ 202
17.1.22. 访问者模式 ............................................................................................................................ 202
17.1.23. 中介者模式 ............................................................................................................................ 202
17.1.24. 解释器模式 ............................................................................................................................ 202
18. 负载均衡 .......................................................................................................................................... 203
18.1.1. 四层负载均衡 vs 七层负载均衡 .............................................................................................. 203
18.1.1.1. 四层负载均衡（目标地址和端口交换） ......................................................................................... 203
F5：硬件负载均衡器，功能很好，但是成本很高。 ...................................................................................... 203
lvs：重量级的四层负载软件。 ......................................................................................................................... 203
nginx：轻量级的四层负载软件，带缓存功能，正则表达式较灵活。 ......................................................... 203
13/04/2018 Page 12 of 283
haproxy：模拟四层转发，较灵活。 ................................................................................................................ 203
18.1.1.2. 七层负载均衡（内容交换） ............................................................................................................ 203
haproxy：天生负载均衡技能，全面支持七层代理，会话保持，标记，路径转移； ................................. 204
nginx：只在http协议和mail协议上功能比较好，性能与haproxy差不多； ............................................ 204
apache：功能较差 ............................................................................................................................................. 204
Mysql proxy：功能尚可。 ................................................................................................................................. 204
18.1.2. 负载均衡算法/策略 ................................................................................................................... 204
18.1.2.1. 轮循均衡（Round Robin） ........................................................................................................... 204
18.1.2.2. 权重轮循均衡（Weighted Round Robin） ................................................................................ 204
18.1.2.3. 随机均衡（Random） .................................................................................................................... 204
18.1.2.4. 权重随机均衡（Weighted Random） ......................................................................................... 204
18.1.2.5. 响应速度均衡（Response Time探测时间） ............................................................................... 204
18.1.2.6. 最少连接数均衡（Least Connection） ........................................................................................ 205
18.1.2.7. 处理能力均衡（CPU、内存） ........................................................................................................ 205
18.1.2.8. DNS响应均衡（Flash DNS） ....................................................................................................... 205
18.1.2.9. 哈希算法 ............................................................................................................................................ 205
18.1.2.10. IP地址散列（保证客户端服务器对应关系稳定） ........................................................................ 205
18.1.2.11. URL散列 ........................................................................................................................................... 205
18.1.3. LVS ............................................................................................................................................. 206
18.1.3.1. LVS原理 ............................................................................................................................................ 206
IPVS .................................................................................................................................................................... 206
18.1.3.1. LVS NAT 模式 .................................................................................................................................. 207
18.1.3.2. LVS DR 模式（局域网改写mac地址） ........................................................................................ 208
18.1.3.3. LVS TUN 模式（IP封装、跨网段） .............................................................................................. 209
18.1.3.4. LVS FULLNAT模式 ......................................................................................................................... 210
18.1.4. Keepalive ................................................................................................................................... 211
18.1.5. Nginx反向代理负载均衡 ......................................................................................................... 211
18.1.5.1. upstream_module和健康检测 ........................................................................................................ 212
18.1.5.1. proxy_pass请求转发 ....................................................................................................................... 212
18.1.6. HAProxy .................................................................................................................................... 213
19. 数据库 ............................................................................................................................................. 214
19.1.1. 存储引擎 .................................................................................................................................... 214
19.1.1.1. 概念 .................................................................................................................................................... 214
19.1.1.2. InnoDB（B+树） ............................................................................................................................. 214
19.1.1.3. TokuDB（Fractal Tree-节点带数据） .......................................................................................... 215
19.1.1.4. MyIASM ............................................................................................................................................. 215
19.1.1.5. Memory .............................................................................................................................................. 215
19.1.2. 索引 ............................................................................................................................................ 215
19.1.2.1. 常见索引原则有 ................................................................................................................................ 216
1.选择唯一性索引 .............................................................................................................................................. 216
2.为经常需要排序、分组和联合操作的字段建立索引： ............................................................................... 216
3．为常作为查询条件的字段建立索引。 ........................................................................................................ 216
4．限制索引的数目： ........................................................................................................................................ 216
尽量使用数据量少的索引 .................................................................................................................................. 216
尽量使用前缀来索引 .......................................................................................................................................... 216
7．删除不再使用或者很少使用的索引 ............................................................................................................ 216
8 . 最左前缀匹配原则，非常重要的原则。 ..................................................................................................... 216
10 . 尽量选择区分度高的列作为索引 .............................................................................................................. 216
11 .索引列不能参与计算，保持列“干净”：带函数的查询不参与索引。 ................................................ 216
12 .尽量的扩展索引，不要新建索引。 ............................................................................................................ 216
19.1.3. 数据库三范式 ............................................................................................................................ 216
19.1.3.1. 第一范式(1st NF －列都是不可再分) ............................................................................................. 216
19.1.3.2. 第二范式(2nd NF－每个表只描述一件事情) ................................................................................. 216
19.1.3.3. 第三范式(3rd NF－ 不存在对非主键列的传递依赖) ..................................................................... 217
19.1.4. 数据库是事务 ............................................................................................................................ 217
13/04/2018 Page 13 of 283
原子性（Atomicity） .......................................................................................................................................... 217
一致性（Consistency） .................................................................................................................................... 217
隔离性（Isolation） ........................................................................................................................................... 218
永久性（Durability） ......................................................................................................................................... 218
19.1.5. 存储过程(特定功能的SQL 语句集) ........................................................................................ 218
存储过程优化思路： .............................................................................................................................................. 218
19.1.6. 触发器(一段能自动执行的程序) .............................................................................................. 218
19.1.7. 数据库并发策略 ........................................................................................................................ 218
19.1.7.1. 乐观锁 ................................................................................................................................................ 218
19.1.7.2. 悲观锁 ................................................................................................................................................ 219
19.1.7.3. 时间戳 ................................................................................................................................................ 219
19.1.8. 数据库锁 .................................................................................................................................... 219
19.1.8.1. 行级锁 ................................................................................................................................................ 219
19.1.8.2. 表级锁 ................................................................................................................................................ 219
19.1.8.1. 页级锁 ................................................................................................................................................ 219
19.1.9. 基于Redis分布式锁 ................................................................................................................ 219
19.1.10. 分区分表 ................................................................................................................................ 220