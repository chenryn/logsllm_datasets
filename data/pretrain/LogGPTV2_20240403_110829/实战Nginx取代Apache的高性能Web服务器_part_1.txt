# OCR Output
## Page 1
也比其他 Web 服务器要高。
常丰富，虽在速度、性能上不及其他轻量级 Web 服务器，但是属于重量级产品，所消耗的内存
在几乎所有的 Unix、Windows、Linux 系统平台上），以及其可移植性等。Apache 的模块支持非
的用户，它的优势主要在于源代码开放、有一支开放的开发队伍、支持跨平台的应用（可以运行
于此服务器的补丁,这也是 Apache 名称的由来(pache 补丁)。世界上很多著名的网站都是 Apache
服务器，在NCSAWWW服务器项目停止后，那些使用NCSAWWW服务器的人们开始交换用
1.1.1Apache 服务器
司的 IS（Internet Information Server）。
供网上信息浏览服务。
1.1常用的Web服务器简介
Apache 仍然是世界上用得最多的 Web 服务器，市场占有率达 60%左右。它源于 NCSAhttpd
Unix 和 Linux 平台下的常用 Web 服务器有 Apache、Nginx、Lightpd、Tomcat、IBM WebSphere 
Web 服务器也称为WWW（WORLD WIDEWEB）服务器、HTTP服务器，其主要功能是提
官方网站：http://httpd.apache.org/。
Www.TopSage.c雄Nginx：取代 Apache 的高性能 Web 服务器
Nginx简介
第
章
---
## Page 2
实战 Nginx:取代 Apache 的高性能 Web 属氧N.TopSage.com
监视配置和控制Intermet 服务。
是建立在 IIS 平台上的。IIS 提供了一个图形界面的管理工具，称为 Intermet 服务管理器，可用于
或Internet上发布信息的Web 服务器。它是目前最流行的Web 服务器产品，很多著名的网站都
1.1.5
于其他流行的 Web 服务器而言，应用的数量很少。
高级，直到企业级。据 IBM 官方网站介绍，有10 000 多个企业正在使用 IBM WebSphere，相对
用程序。这一整套产品目前已进行了扩展，以适应Web 应用程序服务器的需要，范围从简单到
商务计划的核心部分，它基于 Java 的应用环境，建立、部署和管理 Internet 和 Intranet Web 应
1.1.4IBM WebSphere服务器
发的处理比较弱。
Apache-Jakarta 规范，且比绝大多数商业应用软件服务器要好。但是，Tomcat 对静态文件、高并
器。Tomcat Server 是根据 servlet 和 JSP 规范执行的，因此也可以说 Tomcat Server 实行了
1.1.3Tomcat服务器
等重要功能。Lighttpd 跟 Nginx一样，也是一款轻量级 Web 服务器，是Nginx 的竞争对手之一。
模块丰富等特点。支持 FastCGI、CGI、Auth、输出压缩（output compress）、URL重写及 Alias
速、兼容性好并且灵活的 Web Server 环境。它具有内存开销低、CPU占用率低、效能好，以及
1.1.2 
Microsoft 的 Web 服务器产品为 Intermet Information Server（IIS），IS 是允许在公共 Intranet
WebSphere Application Server 是一种功能完善、开放的 Web 应用程序服务器，是 IBM 电子
IS 是一种Web 服务组件，其中包括Web 服务器、FTP服务器、NNTP 服务器和 SMTP 服务
官方网站：http://www.ibm.com/developerworks/cn/websphere/.
官方网站：http://tomcat.apache.org。
Tomcat 是--个开放源代码、运行 servlet 和JSP Web应用软件的基于Java的Web 应用软件容
官方网站：http://www.lighttpd.net/。
Lighttpd 是由一个德国人写的开源软件，其目标是提供一个专门针对高性能网站，安全、快
Microsoft IIS
Lighttpd 服务器
第1章Nginx简介
---
## Page 3
向代理服务器。
社区、豆瓣、YUPOO 相册、海内 SNS、迅雷在线等多家网站使用Nginx作为Web服务器或反
时间，同时俄罗斯超过20%的虚拟主机平台采用Nginx作为反向代理服务器。
低，运行非常稳定。
的替代品，它能够支持高达50000个并发连接数的响应，而内存、CPU等系统资源消耗却非常
eventport（Solaris 10）作为网络I/O模型，在高连接并发的情况下，Nginx是Apache服务器不错
HTTP和反向代理服务器。Nginx能够选择高效的epoll（Linux2.6内核）、kqueue（FreeBSD）、
Server操作系统。
功能的编程接口；同时，它还提供一个Intermet数据库连接器，可以实现对数据库的查询和更新。
1.2
40%
80%
IIS只能运行在Microsoft Windows平台、Linux/Unix平台上，因此须要购买商业的Windows
图1-1是Netcraft公司统计的从1995年8月至2009年1月各Web服务器的市场占有率曲线图。
在国内，已经有新浪博客、新浪播客、网易新闻、六间房、56.com、Discuz!官方论坛、水木
Nginx已经在俄罗斯最大的门户网站—Rambler Media（www.rambler.ru）上运行了3年
Nginx（“enginex”）是俄罗斯人Igor Sysoev（伊戈尔·塞索耶夫）编写的一款高性能的
2Nginx的发展
0ct1995
Apr1996
Oct1996
Apr1997
0ct1997
Apr1998
Oct1998
Apr1999
图1-1Web服务器的市场占有率曲线图
Oct1999
Apr2000
0ct2000
www.TopSage宅6nyginx：取代Apache的高性能Web服务器
Apr2001
1.2Nginx的发展
0ct2001
Apr2002
0ct2002
Apr2003
0ct2003
Apr2004
0ct2004
Oct2005
Apr2006
0ct2006
Oct2007
Apr2008
Jat2888
Othe
Googl
nginx
-Microsoft
Apache
Sun
com
5
---
## Page 4
实战 Nginx：取代 Apache 的高性能 Web 服务器.TopSage.com
epoll、kqueue 等系统调用管理事件机制）的一张测试结果图，对 select、epol、kqueue 等作了清
率为70%～90%，迁移后平均系统负载为1～4，CPU使用率为20%～40%，见图1-2。
一个日均2 500万 PV 的分类信息网站，迁移前每台服务器的平均系统负载为 50～60、CPU 使用
所消耗的 CPU 等服务器资源要比 Nginx 高得多。
使用的则是传统的 select 模型，其比较稳定的 Prefork 模式为多进程模式，需要经常派生子进程,
得益于 Nginx 使用了最新的 epoll（Linux 2.6 内核）和 kqueue（freebsd）网络 IO 模型，而 Apache
1.3.1
Lighttpd，位居第三，详见表1-1。
使用的 GWS、GFE 服务器外，排在前两位的分别是 Apache、Microsoft IIS，而 Nginx 已经超过
1.3
官方测试Nginx 能够支撑5 万并发连接，在实际生产环境中可支撑 2～4万并发连接数。这
Microsoft IIS
Web服务器
笔者曾完成6台 Web Server 从 Apache 到 Nginx 服务器的迁移（这6台 Web Server 搭建的是
2009 年1月，对185 497213个网站进行了抽样调查，发现除去Google 自己开发的仅供自己
Libevent（一个事件触发的网络库，适用于Windows、Linux、bsd 等多种平台，内部使用 select、
由此可见，处理大量连接的读写，Apache 所采用的 select 网络 IVO 模型非常低效。
选择Nginx 有如下一些理由。
Lighttpd
Nginx
Google
Apache
选择 Nginx 的理由
Swap:
它可以高并发连接
2031608k total,
300
2008年12月
图1-2迁移到Nginx后的系统负载与CPU使用率图
tetal,
3 046 333
3354 329
10 455 103
63 126 940
95 678 052
表 1-1Nginx的市场占有率排名
rine,
508k used,
8:10,
第1章Nginx简介
1.80%
5.60%
33.81%
51.24%
1.63%
占有率
3 users,
2031100k free.
2009年1月
2989 416
3462 551
9868 819
61 038 371
96 947 298
1755208k cached
0.1% hi,
5.32%
32.91%
1.87%
52.26%
占有率
1.61%
ombie
0.7% 51
占有率变化
-0.02%
0.07%
-0.28%
-0.90%
1.02%
---
## Page 5
25 个 php-cgi 进程，这样 php-cgi 消耗的总内存数才 500MB。用 Webbench 做压力测试，在3万
存（15MB×10=150MB），开启的64个 php-cgi进程消耗1280MB 内存（20MB×64=1280MB），
晰的对比，结果自然是epll（Linux 2.6内核）和 kqueue（freebsd）胜出，见图 1-3。
加上系统自身消耗的内存，总共消耗不到 2GB 的内存。如果服务器内存较小，完全可以只开启
1.3.2
Nginx+PHP（FastCGI）服务器在3万并发连接下，开启的 10个 Nginx进程消耗150MB 内
图 1-4 显示了在实际的生产环境中，Nginx支撑高达 28 000的活动并发连接数。
内存消耗少
Time in microseconds
10k
20k
30k
Vriting
Waiting
ea
图 1-3epoll、kqueue、select 等网络 I/O 模型性能测试对比图
1000
10000
100
图1-4生产环境下的Nginx活动并发连接数据统计图
5000
Www.TopSage.密链rNginx：取代 Apache 的高性能 Web 服务器
1.3选择 Nginx 的理由
Libevent Benchmark
QneActiveConnection
15000
20000
1
odg
25000
---
## Page 6
实战Nginx：取代Apache的高性能Web服条.TopSage.com
内存）。
×24=60480000）的访问量，而服务器的系统负载也不算高（见图1-6）。
序的能力已经超过“700次请求/秒”（见图1-5），相当于每天可以承受6000万（700×60×60
动态程序，从Nginx的日志可以统计出，单台Nginx+PHP5（FastCGI）服务器处理PHP动态程
内存）。
并发连接下，访问Nginx+PHP（FastCGI）服务器的PHP程序，运行速度仍然飞快。
8
服务器②：DELLPowerEdge1950（一个Intel（R）Xeon（R）双核PI:EMAIL，4GB
在实际的生产环境下，两台Nginx+PHP5（FastCGI）服务器运行多个复杂性一般的纯PHP
服务器①：DELLPowerEdge1950（两个Intel(R)Xeon(R）双核PI:EMAIL，4GB
以下是这两台服务器的配置清单及运行的程序说明：
29247
9246
2827
2681
15:04:42up 55 days,18:30，
图1-6生产环境下的Nginx+PHP系统负载与CPU使用率图
4149156k
图1-5生产环境下的Nginx+PHP动态程序处理速度统计图
次/秒
uS.
total,
5
035352
013084
85340
第1章Nginx简介
28256
8280
8268
0
10m
6380
844
6372
638
6379
844
1user,
2.6
load average:3.93,4.40,4.37
0.2
一
0.
2
0:00.20
0:
0:01.09
一服务器②rea/s
68
服务器①req/s
42620kbuffers
0.0%hi
ngire
php-czi
php-cgi
php-cgi
nza
zombie
0.0%s1
弘网
om
---
## Page 7
支持Rewrite重写规则
配置文件非常简单
制这些第三方的代码，在必要的时候可以修改或二次开发。
很友好的协议。很多的公司、企业在选用开源产品的时候都会首选 BSD 协议，因为可以完全控
布代码，也允许使用或在 BSD 代码上开发商业软件，并进行发布和销售，因此它是对商业集成
码中的 BSD 协议。
1.3.4
个条件——“不可以用开源代码的作者/机构名字和原来产品的名字做市场推广”
协议代码为基础做二次开发时，须满足三个条件：
以将修改后的代码作为开源或专有软件再发布。当你发布使用了 BSD 协议的代码，或者以 BSD
为开源软件，采用的是 2-clause BSD-like 协议，可以免费使用，并且可用于商业用途。
1.3.3成本低廉
unix-domain socket, with XCache).
 网络跟程序一样通俗易懂，即使非专业系统管理员也能看懂。
Nginx 所采用的 2-clause BSD-like license 衍生自 BSD 协议，也就是删掉了 BSD 协议的第 3
BSD 代码鼓励代码共享，但须尊重代码作者的著作权。BSD 由于允许使用者修改和重新发
BSD 开源协议是一个给使用者很大自由的协议。协议指出可以自由使用、修改源代码，也可
能够根据域名、URL 的不同，将 HTTP 请求分到不同的后端服务器群组。
PHP 程序内容：大量 Memcached 读写操作，少量MySQL 读操作，大量文件队列写操作。
Web 服务器: CentOS Linux 4.4 + Nginx 0.5.35 + PHP 5.2.6RC2 （300 FastCGI Procees,
（3）不可以用开源代码的作者/机构名字和原来产品的名字做市场推广。
（2）如果再发布的是二进制类库/软件，则需要在类库/软件的文档和版权声明中包含原来代
同等硬件环境下，Nginx 的处理能力相当于 Apache 的5～10 倍。
请求数统计方式：从 Nginx 访问日志中，统计每分钟的第15 秒共有多少条日志记录。
（1）如果再发布的产品中包含源代码，则源代码中必须带有原来代码中的 BSD 协议。
其他理由
www.TopSage.c锚Nginx：取代 Apache 的高性能 Web 服务器
1.3选择 Nginx 的理由
---
## Page 8
实战 Nginx：取代 Apache 的高性能 Web 般氧.TopSage.com
提升。
等方面，表现出了很强的优势，选用 Nginx 取代传统的 Apache 服务器，将会获得多方面的性能
行数个月也不需要重新启动。你还能够在不间断服务的情况下，对软件版本进行升级。
支持热部署
稳定性高
1.4 
节省带宽
内置的健康检查功能
Nginx支持热部署。它的启动特别容易，并且几乎可以7天×24 小时不间断地运行，即使运
通过表 1-2 可以看出，Nginx 在反向代理、Rewrite 规则、稳定性、静态文件处理、内存消耗
表 1-2是Nginx与 Apache、Lighttpd 的综合对比情况。
用于反向代理，
支持GZIP压缩，
如果 Nginx Proxy 后端的某台 Web 服务器宕机了，不会影响前端访问。
静态文件处理
系统压力比较
Nginx 与 Apache、Lighttpd 的综合对比
Rewrite规则
Web服务器