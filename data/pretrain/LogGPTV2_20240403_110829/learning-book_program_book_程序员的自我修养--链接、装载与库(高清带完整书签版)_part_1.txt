# OCR Output
## Page 1
Broacview
程序员的自我修养
链接、装载与库
俞甲子石凡潘爱民荠
电子王业出版社
---
## Page 2
程序员的自我修养
链接、装载与库
俞甲子石凡潘爱民著
电子工业出版社
Publishing House of Electronics Industry
北京·BEIING
---
## Page 3
内容简介
本书主要介绍系统软件的运行机制和原理，涉及在Windows和Linux两个系统平台上，一个应用程
序在编译、链接和运行时刻所发生的各种事项，包括：代码指令是如何保存的，库文件如何与应用程序
代码静态链接。应用程序如何被装我到内存中并开始运行，动态链接如何实现。C/C+运行库的工作原
理，以及操作系统提供的系统服务是如何被调用的。每个技术专题都配备了大量图、表和代码实例，力
求将复杂的机制以简洁的形式表达出来。本书最后还提供了一个小巧且跨平台的C/C++运行库MinCRT，
综合展示了与运行库相关的各种技术。
本书对装载、链接和库进行了深入浅出的剖析，并且辅以大量的例子和围表，可以作为计算机软件
专业和其他相关专业大学本科高年级学生深入学习系统软件的参考书，同时，还可作为各行业从事软件
开发的工程师、研究人员及其他对系统软件实现机制和技术感兴趣者的自学教材。
未经许可，不得以任何方式复制或抄装本书之部分或全部内容。
版权所有，侵权必究。
图书在版编目（CIP）数据
程序员的自我修养：链接、装载与库/俞甲子，石凡，爱民著—北京：电子工业出版社，2009.4
ISBN 978-7-121-08511-6
L程1.①俞②石③潘1.程序设计IV.TP311.1
中国版本图书馆CIP数据核字（2009）第038410号
责任编辑：陈元玉
印刷：北京智力达印刷有限公司
装
订：北京中新伟业印刷有限公司
出版发行：电子工业出版社
北京市海淀区万寿路173信箱邮编100036
开本：787×9801/16印张：30.75字数：550千字
印次：2009年4月第1次印刷
印数：4000册
定价：65.00元
凡所购买电子工业出版社图书有缺损问题，请向购买书店调换，若书店售缺，请与本社发行部联系，
联系及邮购电话：（010）88254888。
质量投诉请发邮件至PI:EMAIL，盗版侵权举报请发邮件至PI:EMAIL
服务热线：（010）88258888。
---
## Page 4
作者访谈录
针对俞甲子、石凡和潘爱民三位的新书《程序
员的自我修养—链接、装载与库》的出版，
博文视点对俞甲子进行了专访，现将博文的编
辑与俞甲子的访读对话整理成文，以维读者。
博文编辑
甲子，你好！能否向读者介绍你是如何对操作系统的底层机制和运行原理产生兴趣的？
俞甲子
很大程度上是因为性格决定的吧，因为我是一个喜欢对技术问题寻根究底的人，不满足于仅
仅了解一个技术的表面，而是希望能通过层层深入地挖握，找出它背后最关键最核心的机理。
我相信很多计算机技术都是相通的，它们的核心思想相对是稳定不变的，经常听很多人谈起，
IT技术日新月异，其实真正核心的东西数十年都没怎么变化，变化的仪仅是它们外在的表
现，大体也是换汤不换药吧。
为了了解操作系统内核及装载、链接等这些关键的技术，我曾经白己从头写了一个很小的内
核、装载器及一个简单的运行库，它们组成了一个可以完整运行在PC上的支持多进程、多
线程的操作系统环境，井且支持虚拟存储、简单的文件系统、网络、鼠标键盘等，前后加起
来花了两年多时间，大约有数万行代码，编译器和链接器使用的是GCC和LD。当然，如
果继续写下去，可以让它的功能变得更加完整，但是我停止了对它的继续维护，因为我认为
通过这个维形系统，我已经了解了其背后的机理，如果再继续写下去更多的只是重复性的I
作。因为现在已经有了很多很优秀的内核、装载和链接的相关软件和标准。
虽然我在这个系统上花费了很多时间和精力，却没有获得什么直接的收益，也没有让我跟
上最新的技术潮流，但是它带给我的间接收获却是无法言表的，它使我在后来学习其他技
程序员的自我修养一链接、装载与库
---
## Page 5
作者访谈录
术的时候能够很快地触类旁通、白下而上地去理解整个系统，往往能够理解得更加深刻更
加透彻。
博文编辑
介绍链接、装载与库原理的资料非常少，你在自己钻研的过程中，遇到的最大困难是什么？
俞甲子V
当然相关资料很少会给我们带来很多的困难和挑战，而且相关的源代码在经过多年的发展和
锤炼后，变得非常注重性能和效率，面很少考虑可读性，这使得通过挖掘源代码理解机制变
得更为困难。这些代码很多都是相关领域的黑客高手写的，他们对系统机制的了解已经到了
很深刻的地步，一小段代码会用尽系统的各种机制和方法，经常让人看得不知所云。比如系
统库在不同的链接和装载方式下对C++全局对象的构造和析构，就异常复杂，整个流程来回
曲折，加上有些代码已经遗弃，还会造成误解。Gibc这种支持数十种平台的系统还要考虑
到各个系统的通性和个性，更使整个过程雪上加霜。其实理解还不是最大的洲难，最大的困
难是理解了这个复杂面又晦涩的机制和过程，如何将它们尽量地简化，从中取舍，槟弃所有
不必要的内容，再将它剥离出来后组织成尽量深入浅出层层引导的文字和图表，这才是最大
的挑战。
博文编辑
在自学的过程中，一定有许多令你得意或开心的事，可不可以分享一二？
俞甲子
在这个过程中，最烦恼的事莫过于一个困扰了你很久的问题，通过各种办法，包括阅读源代
码等还是无法理解或无法解释某个程序现象。忽然有一天某个灵感突现，回头再仔细阅读代
码，紧接着马上试验一下，果真如此！大有拨云见日、然开朗的感觉，这应该是最开心的
事吧。
程序员的自我修养一链接、装载与库
---
## Page 6
作者访谈录
博文编辑
你现在从事的工作和系统底层结合紧密吗？在系统运行机制上的积累对国前的工作有帮助吗？
俞甲子
我目前从事的工作跟系统底层关系不是很大，现在最常用的都是Web前端、MySQL数据库
等这些应用层面的系统。虽然不是直接与系统底层打交道，但是之前的积累无时无刻不在帮
助我去深入理解应用开发。比如MySQL系统的内存和文件系统的优化，如果对操作系统的
虚拟存储和文件系统机制没有深入了解，那么可能只能在配置参数上做一些“猜测”性质的
调整，不断地尝试各种参数，或者参考网络上别人提供的配置参数，但不一定适合白己的应
用情况。了解虚存如何运作，进程地址空间的分布等，将会对应用的优化甚至是构架设计上
都会有更高层次的俯视。
博文编辑
对知识的渴求，对未知世界的好奇是人类的天性，但这种天性也需要引导，小心保护、否
则就可能会丧失，读书是一种很好的保护途径、可不可以向读者推荐几本对你个人成长影
响最大的书？
俞甲子
如果是推荐非技术类的书籍，我应该不是很在行，在这里向大家推荐几本我读过的，并且跟
本书主题相关的书籍吧。
《Linkers and Loaders 》，John R.Levine。这本书基本上是链接和装载方面最为完整和权威
的理论著作了，但是内容有些偏旧，并且有些毒涩。
(Intel? 64 and IA-32 Architectures Software Developer’s Manuals}, Intel 官 方的 x64 ·和
x86CPU的技术手册，总共分3卷，另外还有几本优化手册，这些手册不适合通读，但强烈
建议阅读其中的介绍性章节，并且手边能够常备一份，以便需要时查阅，查阅网址
http://wro.intel.com/products/processor/maruals/-
《Linux内核源代码情景分析》，毛德操，胡希明。这部书分为上下两卷，总共近2000页，
虽然出版年份较早（2001年出版），而且是基于Linux 2.4内核的，但是它对很多细节的描
程序员的自我修养—链接、装载与库
---
## Page 7
Vi
作者访谈录
述非常到位，比很多Linux 内核的书籍要详细，值得看。
《深入理解计算机系统》（Computer Systems A Programmer’s Perspective.Randal E. Bryant
和 DavidO'Hallaron著）。这本书对整个计算机软硬件体系结构进行了深入浅出的介绍，是
理解系统底层不可多得的好书，强烈推荐！
《深入解析Windows 操作系统，第4版—Microsoft Windows Server 2003/Windows
XP/Windows 2000 技术内幕》,Mark E.Russinovich(著）,潘爱民（译）.这本书是理解 Windows
内核最好的选择，至少我没有看到任何一本描述关于Windows内核的书能与它相媲美。
《Advanced Programming in the UNIX Environment,Second Edition>, W.Richard Stevens,
Stephen A.Rago。这本书被誉为UNIX程字设计的“圣经”也是了解*NIX系统内核，运行
库和执行环境的很好选择。
程序员的自我修养一链接、装载与库
---
## Page 8
两年前，甲子跟我提起，他在考忠写一本讲述计算机程序基本工作原理的书，由于代码背
后的许多细节现在难以找到完整面又实用的资料，因此，系统性地讲述这些技术要素一定非常
有意义。这是我非常感兴趣的话题，因为最近几年来，我每次给学生讲课或作技术报告时，经
常会提到程序背后的一些细节知识，面当有人请我推荐一些参考资料时，我很难想得出有恰当
的参考书可供学习。我自己也赞想过要写一点这方面的书，只是一直下不了决心做这件事情。
甲子的提议让我意识到，写这样一本书的机会来了，于是，我们认真规划了书的选题。按我的
建议，这应该是三卷本的书，每卷独立，合起来成一体系。第一卷是基础篇，介绍程序的基本
运行过程，即是您现在看到的这本书，其他两卷还需要时日和机缘。
在过去两年中，我曾经以“Inside Windows Programs”为题在多所高校作过报告，旨在介绍
Windows程序背后的一些支撑技术。对于正在学习计算机或软件专业的学生，或者正在从事软
件开发的工程师们，我认为理解这些支撑技术是很有必要的。试想，即使一个简单的“Hello
World!”程序，也依赖于背后的输入输出库（或流库）及系统提供的模块，这种依赖性已经成为
现代软件在操作系统环境下运行的一个必要条件。然面，有关这些支撑技术的系统性资料却少
而又少，虽然Intemet上并不缺乏任何一方面的细节信息，但是，能将程序的编译和运行过程所
涉及的各种技术全面地串连起来介绍的，却尚未有先例。
甲子曾经在2006年夏天跟我实习过两个月，他帮我搭建了一个在Windows已有体系结构下
将交换空间重定向到远程机器物理内存的原型系统，完成这一系统并非易事，而且甲子事前并
无Windows内核编程经验，但是，他凭借扎实的计算机系统软件功底，成功地打通了从页面错
误（pagefault）异常例程到远程机器内存管理器之间的数据通路。在这一段实习经历中，我不仅
看到了他驾驭代码和系统的能力，也感受到他做事认真负责的态度、因此，当他提出要写一本
介绍程序基础的书时，我认为他是非常合适的人选。考虑到写书的跟巨性，他推荐石凡同学加
入进来，这才有了我们三个人的组合，我原先担心写作的进度，毕竞写这样一本书需要大量的
时间投入。幸运的是，在甲子和石凡的不懈努力下，这本书终于面市了。
本书讲解的内容，涉及在Windows和Linux两个系统平台上，一个应用程序在编译、链接和
运行时刻所发生的各种事项，包括：代码指令是如何保存的，库文件如何与应用程序代码静态
链接，应用程序如何被装载到内存中并开始运行，动态链接如何实现，C/C++运行库如何工作，
以及操作系统提供的系统服务是如何被调用的，每个技术专题都配备了大量图示和代码实例，
力求将复杂的机制以简洁的形式表达出来。本书最后还提供了一个小巧且跨平台的C/C++运行库
MiniCRT，综合展示了与运行库相关的各种技术。
关于写作这本书的功劳，我不敢掠美。在创作之初，包括拟定提纲及甄选内容方面，我跟
程序员的自我修养一链接、装载与库
---
## Page 9
!
序言一
甲子有过认真而细致的讨论：在写作过程中，我对甲子和石凡的初稿提出过一些建议，尤其在
表述方面，同时我也协助他们与编辑进行了沟通和交流，对于正文的内容，我井无实质性的贡
献，但基于我对甲子和石凡两位年轻人的了解，我相信他们自身的技术实践功底，以及足够的
技术阐释能力。我期待这本书能够真正地提升程序员的自我修养，让程序员总是生活在“知其
然，更知其所以然”的代码曼妙中。
最后，我要感谢这本书的四位编辑，他们是何艳、方舟、刘铁锋和陈元玉，谢谢他们为这本
书付出的努力。还要感谢博文视点团队的负责人周筠女士，谢谢她给予两位年轻作者的扶持和
关爱。
潘爱民
2009年2月于北京
程序员的自我修养一链接、装载与库
---
## Page 10
两年前，我在浙江大学的一著名BBS的C++板块上担任版主，面俞甲子则是板上的资深版友
（以及前版主）。那时候我对链接装载、运行库等内容比较感兴题，自己摸索着在博客上写了一
篇关于链接的入门文章，面这就是一切的开始。
我猜想俞甲子可能对写这么一本书早有想法，看到我的文章正好找到了同路人。他找到了
我和潘爱民老师，我们一拍即合，就开始了这长达两年的写作历程、考虑到当时俞甲子已经在
链接部分有了相当的积累，因此我不得不放弃最有兴趣的一部分转面在运行环境上做文章。我
把glibc和msvcrt的源代码翻了个底朝天，了解到了许多平时不可能接触到的内募和技术细节。事
实上，这基本是一个现学现卖的过程，我一边学习着新的知识，一边把新知识组织整理写成文
字。读者在看某些章节的时候，会发现这些章节的讲解过程就是一个源代码的挖掘过程，这实
际上也就是我的学习过程。学习研究他人的代码是枯燥面耗时的，我很高兴能够做这样一个先
行者，将我的经验写进书里，让读者能够避免重复劳动，直接获得其中的经验和关健技术。
本书所讲的内容不是活跃在当今T舞台上的高新技术，也不是雄踞计算机某个领域的王牌
霸主，而是默默服务于所有计算机应用的扫地借，也许阅读本书不能够直接在平时学习工作中
的生产力上得到体现，但了解计算机的台前幕后会对读者产生潜移默化的影响。当你的程序无
法启动的时候，你可能会在脑海里多设想一种可能性：当你的代码链接失败的时候，你可能会
更快地意识到问题的所在：当你的程序发生非法操作的时候，你可能不至于面对微软的错误报
告毫无头绪，有人总爱用“时效性”评价当今的T技术，仿佛一项技术的生存期就只有儿年。
我不能说这样的想法是错误的，如今的技术的确在飞速地更替和发展。但是本书所讲的技术，
大多是成型在十年前，乃至二十年前，它们是整个计算机行业技术的根本，也凡乎是现在所有
计算机应用的基础，在当今的计算机技术发生根本性变革之前，这些技术还将继续存在并保持
活力。
我很荣幸能够有机会和读者分享这些技术，但写作水平有限（我在语文课上历来不是个好学
生），最终在文字和结构上颜有缺憾，只能在这里说一声抱款。在这里要感谢我小学、初中和高
中的语文老师，谢谢你们当初对我的教导，尽管最终可能辜负了你们的希望。感谢老师、博
文视点的编辑及所有支持我们的朋友们，谢谢你们的帮助。最后要感谢我的父母，没有你们。
我水远不可能走到今天这一步。
石凡
2009年2月于杭州
程序员的自我修养一链接、装载与库
---
## Page 11
CPU体系结构、汇编、C语言（包括C++）和操作系统、水远都是编程大师们的护身法室，
就如同少林事的《易筋经》，是最为上乘的武功；学会了《易筋经》、你将无所不统、任你制造