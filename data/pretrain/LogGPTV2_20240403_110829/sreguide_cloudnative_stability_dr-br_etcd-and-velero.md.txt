---
isOriginal: true
category: äº‘åŽŸç”Ÿ
tag:
  - Kubernetes
---

# K8s æ— å¤‡ä»½ï¼Œä¸è¿ç»´

å‡ºæ•…éšœæ—¶ï¼Œå°±çŸ¥é“æ˜¯è°åœ¨è£¸æ³³ ðŸ™ƒ

K8s æŠ•äº§ä½¿ç”¨ï¼Œå¤‡ä»½æ˜¯ä¿å‘½æ‰‹æ®µï¼Œå¿…é¡»è¦ä¸Šï¼Œå»ºè®®åšä¸€ä¸ª checklistï¼Œå·¡æ£€é€šè¿‡ï¼Œé›†ç¾¤æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ¯”å¦‚ï¼Œè¿™æ ·ðŸ‘‡

 ![image-20240320195757171](https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240320195757171.png)



## å¤‡ä»½æ–¹æ¡ˆåˆ¶å®š

1. ç‰©ç†å¤‡ä»½ï¼šetcd å¤‡ä»½ï¼Œä¿å­˜æŸä¸€ä¸ªæ—¶åˆ»çš„å¿«ç…§ï¼Œå¿«æ·æ–¹ä¾¿ã€‚
2. é€»è¾‘å¤‡ä»½ï¼švelero å¤‡ä»½ ï¼Œå…è®¸ç”¨æˆ·è‡ªå·±é€‰æ‹©å¤‡ä»½çš„å†…å®¹ï¼Œæ¯”å¦‚å•ä¸ª namespaceã€æŒ‡å®šèµ„æºç±»åž‹ç­‰ã€‚

ç‰©ç†å¤‡ä»½çš„ä¼˜ç‚¹æ˜¯é€Ÿåº¦å¿«ï¼Œæ— è®ºæ˜¯å¤‡ä»½è¿˜æ˜¯å›žæ¢å¤ï¼Œä½†ç¼ºç‚¹æ˜¯å…ƒæ•°æ®ä¸å¯è¯»ï¼Œåªèƒ½å…¨éƒ¨æ¢å¤ã€‚è€Œé€»è¾‘å¤‡ä»½æ­£å¥½ç›¸åï¼Œå› æ­¤ä¸¤è€…å¯ä»¥ç»“åˆä½¿ç”¨ï¼Œæ—¢èƒ½å¿«ï¼Œåˆèƒ½æœ‰ç»†ç²’åº¦æŽ§åˆ¶çš„èƒ½åŠ›ã€‚

## Etcd å¤‡ä»½

1ã€åˆ›å»ºå¤‡ä»½è„šæœ¬`/opt/etcd_backup.sh`

```bash
#!/usr/bin/env bash
#
# Etcd backup
 
set -e
 
ETCD_CA_CERT="/etc/kubernetes/pki/etcd/ca.crt"
ETCD_CERT="/etc/kubernetes/pki/etcd/server.crt"
ETCD_KEY="/etc/kubernetes/pki/etcd/server.key"
BACKUP_DIR="/var/lib/docker/etcd_backup"
DT=$(date +%Y%m%d.%H%M%S)
 
[[ ! -d ${BACKUP_DIR} ]] && mkdir -p ${BACKUP_DIR}
find ${BACKUP_DIR} -name "*.db" -mtime +7 -exec rm -f {} \;
 
ETCDCTL_API=3 /usr/local/bin/etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert="${ETCD_CA_CERT}" --cert="${ETCD_CERT}" --key="${ETCD_KEY}" \
  snapshot save "${BACKUP_DIR}/etcd-snapshot-${DT}.db"
 
echo "Etcd backup success, backup file: ${BACKUP_DIR}/etcd-snapshot-${DT}.db, \
  file size: $(du -sh ${BACKUP_DIR}/etcd-snapshot-${DT}.db |awk '{print $1}')"
echo
```

2ã€æ·»åŠ cronå®šæ—¶ä»»åŠ¡ `crontab -e`

> åªéœ€è¦å¤‡ä»½ä¸€ä¸ªetcdå°±è¡Œï¼Œæ¢å¤æ—¶ï¼Œæ‹¿åŒä¸€ä»½å¤‡ä»½æ•°æ®æ¢å¤

```bash
0 */1 * * * /bin/bash /opt/etcd_backup.sh >>/opt/log-backup-etcd.log 2>&1
```

## velero å¤‡ä»½

1ã€å®‰è£…é…ç½® velero

```bash
# ä¸‹è½½ç‰ˆæœ¬ï¼šhttps://github.com/vmware-tanzu/velero/releases æœ€æ–°ç¨³å®šç‰ˆï¼Œæ³¨æ„k8sç‰ˆæœ¬å…¼å®¹æ€§ï¼Œ1.8.1ç‰ˆæœ¬è¦æ±‚k8sç‰ˆæœ¬è‡³å°‘1.16
wget https://github.com/vmware-tanzu/velero/releases/download/v1.8.1/velero-v1.8.1-linux-amd64.tar.gz
# è§£åŽ‹
tar -xvf velero-v1.8.1-linux-amd64.tar.gz
# åŠ å…¥çŽ¯å¢ƒå˜é‡
cp velero-v1.8.1-linux-amd64/velero /usr/bin/
# è®¾ç½®è¡¥å…¨å‘½ä»¤
velero completion bash > /etc/bash_completion.d/velero.sh
source /etc/bash_completion.d/velero.sh
# åˆ›å»ºå‡­è¯æ–‡ä»¶ cat credentials-velero
aws_access_key_id=xxx
aws_secret_access_key=xxx
# å®‰è£…
velero install  --provider aws --plugins velero/velero-plugin-for-aws:v1.1.0 --bucket  velero-xxx --secret-file ./credentials-velero --use-volume-snapshots=false --use-restic --default-volumes-to-restic --backup-location-config region=ap-shanghai,s3ForcePathStyle="true",s3Url=https://cos.ap-shanghai.myqcloud.com --restic-pod-cpu-request=1000m --restic-pod-cpu-limit=2000m --restic-pod-mem-request=1024Mi --restic-pod-mem-limit=4096Mi  --velero-pod-cpu-request=1000m --velero-pod-cpu-limit=2000m --velero-pod-mem-request=1024Mi --velero-pod-mem-limit=4096Mi
# æŸ¥çœ‹é…ç½®çš„å­˜å‚¨ä½ç½®æ˜¯å¦å¯ç”¨
velero backup-location get
```

2ã€æ ¹æ®å®žé™…æƒ…å†µå¤‡ä»½æŒ‡å®š namespace æˆ– æŒ‡å®šèµ„æºç±»åž‹

```bash
velero create schedule xxx --schedule="0 1 * * *" --include-namespaces=prod --snapshot-volumes=false --default-volumes-to-restic=false --ttl=168h
```



## Etcd æ¢å¤

1ã€åˆ›å»ºå¤‡ä»½ç›®å½•

```bash
mkdir -p /opt/k8s_manifests_backup
```

2ã€åœæ­¢æ‰€æœ‰ Master ä¸Š kube-apiserver æœåŠ¡

```bash
mv /etc/kubernetes/manifests/kube-apiserver.yaml /opt/k8s_manifests_backup/
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²åœæ­¢
kubectl get pod -n kube-system | grep kube-apiserver
```

3ã€åœæ­¢é›†ç¾¤ä¸­æ‰€æœ‰ etcd æœåŠ¡

```bash
# è®°å½• etcd --nameã€--initial-advertise-peer-urlsã€--data-dir å€¼
ps -ef | grep etcd
# åœæ­¢æœåŠ¡
mv /etc/kubernetes/manifests/etcd.yaml /opt/k8s_manifests_backup/
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²åœæ­¢
docker ps | grep etcd
```

4ã€ç§»é™¤æ‰€æœ‰ etcd å­˜å‚¨ç›®å½•ä¸‹æ•°æ®ï¼Œä¸åŒçŽ¯å¢ƒä¸‹ï¼Œå­˜å‚¨ç›®å½•å¯èƒ½ä¸ä¸€æ ·ï¼Œæ ·ä¾‹å­˜å‚¨ç›®å½•ä¸º `/data/etcd`

```bash
mv /data/etcd{,.bak}
```

5ã€æ‹·è´è¦æ¢å¤çš„å¿«ç…§åˆ°æ‰€æœ‰ etcd èŠ‚ç‚¹ï¼Œè¿›è¡Œå¿«ç…§æ¢å¤
æ‰€æœ‰ etcd èŠ‚ç‚¹æ“ä½œï¼Œä¸åŒèŠ‚ç‚¹ï¼Œä¼ å…¥ä¸åŒçš„ `--nameã€--initial-advertise-peer-urlsã€--data-dir`å€¼

```bash
ETCDCTL_API=3 /usr/local/bin/etcdctl snapshot restore /tmp/xxx.db \
  --name hostname1 \
  --initial-cluster "hostname1=https://ip1:2380,hostname2=https://ip2:2380,hostname3=https://ip3:2380" \
  --initial-cluster-token k8s_etcd \
  --initial-advertise-peer-urls https://ip1:2380 \
  --data-dir=/data/etcd
```

6ã€å¯åŠ¨é›†ç¾¤ä¸­æ‰€æœ‰ etcd

```bash
mv /opt/k8s_manifests_backup/etcd.yaml /etc/kubernetes/manifests/
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
ETCDCTL_API=3 /usr/local/bin/etcdctl  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  --endpoints=https://ip1:2379,https://ip2:2379,https://ip3:2379 \
  endpoint health
```

7ã€å¯åŠ¨æ‰€æœ‰ Master ä¸Š kube-apiserver æœåŠ¡

```bash
mv /opt/k8s_manifests_backup/kube-apiserver.yaml /etc/kubernetes/manifests/
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get pod -n kube-system | grep kube-apiserver
```

8ã€æ£€æŸ¥æ˜¯å¦å¦‚æœŸæ¢å¤

**æ€»ç»“**

Kubernetes é›†ç¾¤å¤‡ä»½ä¸»è¦æ˜¯å¤‡ä»½etcdé›†ç¾¤ã€‚è€Œæ¢å¤æ—¶ï¼Œä¸»è¦è€ƒè™‘æ¢å¤æ•´ä¸ªé¡ºåºï¼š

åœæ­¢Kube-apiserver -->  åœæ­¢etcd -->  æ¢å¤æ•°æ® -->  å¯åŠ¨etcd -->  å¯åŠ¨kube-apiserver

## velero æ¢å¤

```bash
# æŸ¥è¯¢å¤‡ä»½ä¿¡æ¯
velero backup get
# æŒ‰éœ€ä¸‹è½½å¤‡ä»½æ–‡ä»¶
velero backup download filename
# è§£åŽ‹
tar -xvf xxx.tar.gz
# æ ¹æ®éœ€è¦è¿›è¡Œ yaml æ–‡ä»¶æ¢å¤
kubectl apply -f filename/dirname
```



ä¸Šçº¿å‰ï¼Œé™¤äº†è¦åšå¥½å¿…è¦çš„å¤‡ä»½å¤–ï¼Œè¿˜æœ‰åšå¥½ å®¹é‡è§„åˆ’ã€ç½‘ç»œè§„åˆ’ã€æž¶æž„è§„åˆ’ã€ç»„ä»¶åŸºå‡†æµ‹è¯•ç­‰ï¼ŒåŽç»­ç»§ç»­åˆ†äº«~


---



>



<img src="https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/weixin.png" alt="weixin" style="zoom: 50%;" />
