请求搭载到 RRC Connection complete 并发送给 MME。收到此消息后，(5) MME 通过使用从 HSS 生成的认证向量回复来自 UE
的 NAS 认证请求来启动认证和密钥协商 (AKA) 过程。
UE然后通过NAS认证请求中的内容对MME进行认证，并通过向MME发送NAS认证响应进行回复。在这个阶段，UE和MME都是相互认证的。接下来，在密钥协商方面，
(6) MME 选择要使用的加密和完整性保护算法，并向 UE 发送 NAS 安全模式命令以告知其所选算法。收到此消息后，UE 为 NAS
层生成安全密钥。同样，(7) eNB 继续执行 RRC 安全模式命令以通知 RRC
层和用户平面数据安全的安全算法。在这些步骤之后，所有应根据标准保护的控制平面消息都使用协商的安全算法进行加密和完整性保护。最后，在NAS和RRC层交换可选配置后，（8）MME分配一个全球唯一临时标识（GUTI）来代替永久标识（LTE中的IMSI），并通过传输一个Attach
accept发送GUTI和其它连接信息给 UE。当UE向MME发送Attach complete消息时，Attach过程最终完成。  
2） **UE移动性管理：** 每个MME管理自己的跟踪区（TA），每个跟踪区（TAC）由跟踪区码（TAC）标识。每个 TA 包含多个 eNB，这些 eNB
操作多个小区以根据运营商的操作策略有效地覆盖地理区域而没有信号干扰。当传入的服务请求到达特定的 UE 时，MME 首先检查 UE 是 RRC
CONNECTED 还是 RRC IDLE。如果 UE 处于 RRC IDLE 状态，MME 必须唤醒 UE 以进行 RRC
连接和数据流量的其他无线电承载。此过程在 LTE 术语中称为寻呼。由于 MME 只有关于先前服务于 UE 的 TA 的信息，因此 Paging
消息被广播到该 TA 中的所有 eNB。如果在特定的 TA 中没有找到 UE，MME 可以向其他 TA 广播 Paging。请注意，根据分配给 QoS
的相对优先级、信令负载和其他操作问题，用于查找 UE 的特定寻呼策略可能因运营商而异。
## 0x03 The Proposed approach
本节介绍 LTEFuzz，这是一种以半自动方式在运营的 LTE 网络中系统地进行动态安全分析的建议方法。 LTEFuzz 包括三个主要步骤（如下图所示）：
1） **提取安全属性：**
首先，我们从安全方面来广泛分析控制平面过程的LTE标准。根据分析，我们创建了网络和移动设备需要遵循的三个安全属性，以确保它们免受未知的安全威胁。专注于安全方面。根据分析，我们创建了网络和移动设备需要遵循的三个安全属性，以确保它们免受未知的安全威胁。  
(2) **生成测试用例：**
接下来，我们生成测试用例来识别目标控制平面组件违反安全属性的情况。测试用例是根据目标协议消息的指定规则及其每个属性的字段生成的。  
(3) **问题行为分类：**
在执行测试用例时，我们需要确定UE侧的哪些响应和状态变化被认为是问题行为。为此，我们构建了一个简单的决策树逻辑来对有问题的案例进行分类。我们的模型仅在执行测试用例时考虑
UE 侧的控制平面日志和状态。因此，该模型使 LTEFuzz 能够以自动方式识别有问题的用例。本节的其余部分将考虑这些步骤中的每一个。
###  A. 从标准中提取安全属性
对有关控制平面程序和安全要求的规范的彻底分析使我们能够根据运营商的实施和配置策略识别可能导致控制平面程序的机密性和完整性保护被规避的潜在安全漏洞。第一，能够窃听和操纵
LTE
信号的攻击者可能会利用建立安全上下文之前的初始流程。第二，存在相当多的例外情况，其中接收实体会接受没有完整性保护的控制平面消息。第三，虽然规范为控制平面协议（如NAS和RRC）采用了计数器，但它指定了在验证消息完整性时在接收的消息中使用序列号（计数器的部分位）。因此存在消息重放的可能性。根据这些观察，我们创建了下表中列出的三个基本安全属性，每个属性都侧重于描述实体正确响应攻击者恶意行为的能力。我们假设攻击者具有最小特权：攻击者既不拥有向
LTE 网络注册的有效密钥，也没有其他合法用户密钥的信息。此外，由于每个属性侧重于不同的安全方面（即对未受保护程序的错误处理、无效的安全保护消息和强制性
AKA 程序），测试场景和特定目标消息的规则因属性而异。请注意，在考虑安全属性时，我们仅针对各种控制平面协议中的 NAS 和 RRC
协议，因为（1）这些协议用于执行 UE 和网络之间的关键控制平面过程（例如，UE 连接程序、移动性管理和身份验证），(2) 我们能够在 UE
处捕获和分析这些过程，以及 (3) 这些协议中已识别的漏洞直接影响 UE 和网络。
1) **属性 1：** 当攻击者在初始过程中发送精心设计的明文消息时，它确认接收实体（上行链路的 eNB 或 MME 和下行链路的
UE）是否适当地处理非预期输入。为了验证这个属性，我们在选择目标消息时考虑两种情况：（1）可以在安全激活之前发送的精心制作的明文消息，以及（2）根据标准，在安全激活之后不应在未受保护的情况下发送的消息。对于第一种情况，我们主要检查初始明文消息的潜在威胁，这些消息无法受到
LTE
对称密钥加密的性质的保护。对于这些未受保护的消息，很难区分接收到的消息是来自攻击者还是合法用户。另一方面，第二种情况的目的是检查部署的蜂窝组件是否正确实现以拒绝或丢弃不符合标准的无效明文消息。安全激活后传输的消息通常遵循安全关键程序。因此，如果接收实体错误地处理这些受安全保护的消息，攻击者可能会影响
UE 的连接状态或暴露 UE 的私人信息。这里我们假设攻击者既没有订阅特定的移动电话服务，也没有其他 UE
的安全密钥。因此，攻击者将能够创建和发送具有任意内容的明文消息，但这些消息是无效的。在测试过程中，攻击者在调查 eNB 和
MME（上行方向）的行为时充当恶意 UE，在调查 UE 行为（下行方向）时充当恶意 LTE 网络。  
 **示例案例。** 代表第一种情况的消息示例是 RRC 连接请求。由于初始 RRC 连接过程不受设计保护，因此攻击者可以在建立 RRC
连接时伪造任何内容。没有适当安全措施的受害者 eNB 会接受这些伪造的消息。第二种情况的例子可能是一个普通的 NAS Attach 请求，它被受害者的
GUTI 欺骗了。在正常情况下，当 UE 尝试使用其先前的加密密钥信息（在 3GPP 中称为安全上下文）和 GUTI 执行重新注册时，会发送完整性保护的
NAS 附加请求。收到消息后，MME 允许 UE 注册而不执行 AKA 过程，因为 UE 已经通过其有效的完整性保护消息进行了身份验证。因此，如果 MME
没有正确检查接收到的消息是否必须受到安全保护，攻击者可能会通过发送一个用受害者的 GUTI 欺骗的 NAS Attach
request来断开受害者的现有连接。  
2) **属性 2：** 验证接收方是否正确处理了错误地封装了一个安全头的非预期消息。根据规范，除了一些消息，如Attach 请求、TAU
请求和安全模式命令，所有这些仅进行完整性保护的消息，在AKA 过程之后的所有NAS 消息都应该被加密和完整性保护。为此，当 UE 在 AKA 过程之后发送
NAS 消息时，它首先对纯 NAS 消息进行加密，然后计算用于完整性保护的消息验证码
(MAC)（如下图所示）。我们通过研究两种特定情况来确定接收实体是否适当地验证了 (1) 受安全保护消息的完整性和 (2) 序列号，它由 32
位计数器值的八个最低有效位组成，以此来证明此属性在发送和接收实体之间同步。直观地说，如果接收实体不验证消息的完整性，攻击者就可以伪造任何未加密的消息。此外，如果序列号没有得到彻底验证，攻击者可以使用先前从受害者
UE 捕获的安全保护消息发起重放攻击。与属性 1 类似，由于攻击者没有任何密钥来生成有效消息，因此他们在与 eNB
建立连接后发送无效消息。每种情况的目标消息构成了在安全激活之后应该受到保护的每个可能的消息。
**示例案例。** 与第一种情况相关的示例是 NAS 上行链路 NAS 传输，它用于通过 NAS 提供 SMS 的运营商内的 SMS。如果 MME
没有正确验证此消息的完整性，攻击者可以通过伪造 NAS 上行链路 NAS 传输消息的内容来利用它进行 SMS 网络钓鱼攻击。代表第二种情况的另一个示例是
NAS PDN 断开请求。该消息的目的是释放已建立的分组数据网络（PDN）连接。特别是，当用户关闭他们的设备或关闭数据服务时，攻击者可以通过伪装成受害者
UE 向网络发送此消息，如果网络没有正确验证消息中指定的序列号，则网络将接受此重播消息。这可能会导致对合法用户的选择性拒绝服务。  
3） **属性3：** 确认3GPP标准中规定的安全过程是否可以被恶意UE或网络绕过。 LTE 标准采用 EPS-AKA 进行 UE
和网络之间的相互认证，以保护控制面和数据面。这包括基于挑战应答机制的 NAS 认证过程和 RRC 和 NAS
层中的安全模式命令，它们是用于控制面和数据面机密性和完整性的会话密钥协商过程。可以使用三种方法来检查是否可以绕过这些安全过程。首先是对LTE标准中采用的密码算法进行安全分析。但是，这种情况超出了本文的范围。其次，可以考虑攻击者操纵在
RRC/NAS 安全模式命令中选择的加密和完整性保护算法以及 NAS 保护消息中的安全标头类型的情况。作者之前对此进行了研究
但仅在一个商用调制解调器中发现了漏洞。最后一种情况涉及省略部分强制性安全程序。如果设备允许这种情况发生，没有合法设备的加密密钥的恶意 LTE
网络甚至可以提供没有机密性和完整性保护的受操纵服务。尽管这些情况如果被利用可能会造成严重威胁，但后果尚未得到调查和公开披露。因此，我们限制此安全属性的范围以验证
UE 是否正确处理恶意 LTE 网络在 RRC 和 NAS 层中忽略强制安全程序（例如身份验证请求和安全模式命令）的情况。  
 **示例案例。** 一个例子可能是忽略 NAS 身份验证请求，使攻击者能够在没有身份验证和密钥协商的情况下继续遵循服务程序，这两者都是强制性程序。
###  B. 为每个属性生成测试用例
尽管我们为每个属性选择了目标消息，但如果我们考虑每个消息中所有可能字段值的输入，则会存在多个测试用例。例如，为验证安全属性 1 的无效纯 NAS
Attach request生成测试用例必须考虑它有 24 个字段，包括一个可选字段，并且此消息中的可用长度可能至少为 16
个字节。显然，测试所有这些可能性是昂贵的。为了减少测试用例的数量，同时执行足够数量的测试来调查目标实体的行为，LTEFuzz
使用商用控制平面消息日志。在这方面，我们通过发送 AT
命令来触发基带芯片组中的许多功能来收集各种控制平面消息。然后我们使用这个日志来构建一个数据库，在其中存储由运营商分隔的每个字段收集的日志中的所有值。因此，当生成器为运营商
A 创建测试用例时，它选择标记为运营商 A 的可能值之一。 当生成测试用例以检查序列号验证（属性 2
中的第二种情况）时，我们通过捕获生成所有测试用例受害UE一侧的数据包。在为初始明文消息（属性 1）和具有无效 MAC 的消息（属性 2
中的第一种情况）生成测试用例时，仅考虑必填字段，因为它们对正确的 LTE
操作至关重要。需要注意的是，当测试用例消息中包含UE的identity字段时，会包含UE的当前标识，例如GUTI或IMSI，以检查接收实体是否改变了受害UE的状态。
###  C. 对问题行为进行分类