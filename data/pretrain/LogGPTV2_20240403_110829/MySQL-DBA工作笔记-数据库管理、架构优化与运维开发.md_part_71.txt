数信息进行校验，而是先做持久化，从接收端来说，能够很清晰地得到数据参数结构和
图（图12-7）中的第1步，使用 RESTfulAPI 对接；对于接口的初步对接，不需要对参
这种对接的成本，我们可以使用迭代的方式来完成，这种迭代是一种缓存策略，就是下
12.3.5
题，使得规则的落地不浮于表面。
后经过流程化处理推送合理的建议。
第4 步是工单分解器，通过分解器可以根据工单类型和工单场景把工单拆分为多种/
SQL自助审核服务
在第3步会完成流转的工作，比如是权限工单，就流转到权限的页面；如果是对
工单的概要信息是记录从源端推送的最粗粒度的工单信息，粒度为工单类型和单号，
，不至于形成对于源端的过度依赖，流程图如下图12-8所示。
工单初期的接入是一种模糊状态，对接参数和对接标准不够统一，为了尽可能降低
对于 SQL 审核项目的建设，需要持续的同业务部门进行反馈和改进，不断的完善后续问
目前采用了如下图12-7所示的处理逻辑，前端推送的 SQL 语句会经过多个环节，最
前端
工单处理引擎
数据模型
SQL审核
9.返回结果至前端
.审核信息持久化
发起请求
8.审核信息分级，暂定严重，警告，建议三级一
调用SQL审核服务
API服务
SQL审核
2.查看服务器集群信息
图12-7
4.返回从库只读服务器信息
审核服务端
中控服务器
CMDB
6.连接至从库，
第12章自动化运维架构设计和规划”455
匹配集群信息
发起审核需求从库
7.返回审核结果
数据库服务器
数据库服务器
主库
---
## Page 478
456丨MySQL DBA工作笔记：数据库管理、架构优化与运维开发
平滑。工单的业务流程如下图12-9 所示。
方补充这个角色，实现配置化的工单拆解。
务的接入，原来的逻辑会变得很臃肿，很多逻辑是写成了硬编码的方式，
第7步：工单回调完成
第5步
第5步：
整体的思路来说，如果要接入另外一个工单，
而在第一个工单的接入中，
最后可以约定好工单回调接口，确认整个工单流程结束。
一
单状态回
第6步：工单状态回传
数
据库权限明细
DBA权限工
工单分解器-
第4步：
第4步：
工单分解
工单分解
第1步：RESTfUl AP
图12-8
一
直
工
第3步：根据场景流转
运维平台入口
第2步：
处于模糊地
则整个工单流程的设计也会变得更加
数据映射
带
所以随着多
数据库对象2变更明细
数据库对象1变更明细
DBA对象变更工单
DBA对象变更工单
DBA对
外部系统入口
DBA对象
运维平台入口
分解工单状态
运维平台入口
变
可以在这个地
多种数据库业
单
单
---
## Page 479
但是对于系统的建设来说，却起到了重要作用，比如今天属于创新的技术，一年后可能
12.4
在运维系统建设过程中，需要融入更多的创新元素，创新的概念其实是相对模糊的，
通过业务流程对接，可以平滑对接工单系统的工单到运维系统，并实现信息联动。
业务同学/需求方
画龙点睛：创新设计
单统计
审批不通过，偏息稽核/调整
查看工单池数据
转换失败，核查问题
工单时长分析
提交工单
接口
方式推送工单明细
数据库业务处理
数据库运维平
工单派发/抢单
图12-9
转换成功
MIS系统
工单历史/明细查询
推送子
第12章自动化运维架构设计和规划|457
---
## Page 480
458丨MySQLDBA工作笔记：数据库管理、架构优化与运维开发
并对脚本的参数和格式做统一管理，这些可以不在脚本中刻意维护，在API层维护即可。
本接入只需要对接脚本内容，规划脚本路径即可，这样就是一个相对完善的流水线，
确的定义；第三需要提供一个初步的原型，后续接入逻辑层的只需要对接接口即可，脚
第二需要提供脚本，脚本的内容需要符合一定的规范，比如输入参数和输出结果要有明
12-10所示。
通过前后端分离的设计模式，来提高运维系统的功能迭代和业务对接能力。
的技术进行评估、选型、论证，为了提高团队和跨团队协作的效率，可以通过分期迭代,
12.4.1
就是主流了，所以我们所谈的创新，不在新，而是在创。
了持续的需求，也可以逐步的迭代。
其中 RESTful API层的设计不是简单的脚本对接，而是在接口的基础上集线业务逻辑，
实现前后端分离的敏捷开发模式，可以提高开发效率。前后端设计的流程图如下图
至于和前端的边界问题，比如要输出10条数据，是否要根据某个列来排序，这些需
比如运维同学要接入平台，需要准备三件事情，第一需要要有明确的业务场景需求：
从系统分工、体系结构及数据流转等方面讨论数据库运维管理系统，对系统中使用
前后端分离开发模式
初步原型
明确输入输出
脚本开发
运维需求
脚本接入
工具层
后端
图12-10
逻辑接入
本地前端和数据对接
本地化前端
原型
前端
+
平台前端和数据对接
专业前端团队
平台化前端
有
---
## Page 481
调度系统的架构设计如下图12-11所示。
12.4.2
跨团队的沟通效率就会大为提高。
中，本地前端的磨合成本相对更低一些。
求初期是模糊的，而如果直接和专业前端对接，是需要提前明确的，在这个磨合的过程
而经过迭代的原型再接入到平台前端，就会更加平滑，提前把边界问题划分清楚，
第一类是任务调度，任务调度是对任务的并发调度，比如有100个任务，我们可以
对于任务的调度方式，采用了如下的两类策略，可以处理大部分的业务需求。
对此可以通过任务调度系统来承接，
·任务间的依赖没法直接控制。
·如果系统出问题，任务可能没法执行；
·没法监控任务的执行情况；
·任务管理太臃肿；
·任务的时间精度不够；
任务执行中通常会有如下的问题：
没有调度功能；
没法设置任务的截止时间;
任务调度系统
celery worker 2
celery worker 1
任务系统访问入口
celery beat
图12-11
目前主要存在异步任务和定时任务两类，任务
celery worker 4
celery worker 3
第12章自动化运维架构设计和规划”459
---
## Page 482
460丨MySQL DBA工作笔记：数据库管理、架构优化与运维开发
备份恢复流程，为后续的批量任务接入提供技术基础。
撑业务切换和服务配置。
规范，并对部分审核逻辑进行深度定制。
平台降低运维成本，优化用户体验。
管理及资源管理，为用户提供精细的数据授权及灵活的存储、计算资源管控机制，帮助
价值，所以我们要形成详尽可行的计划，步步为营。
是：是否想明白了。
很多未知的问题，因此很难保证进度和结果。所以很多时候我们判断的一个目标基本就
望实现的功能，但是时间是有限的，投入的精力也是有限的，而且具体实现时还要面对
12.5
那么我们可以使用20+5的时间点来完成上面的两个备份任务，基本保证是串行的状态。
到一个资源相对使用充分的时间调度策略。比如任务1用了 20分钟，任务2用了5 分钟，
密结合起来的，所以切分的粒度会更加细致。
把任务做切分，根据备份时间或者数据量来切分为多组，这种切分维度是和业务场景紧
12.5.2
12.5.1
（8）任务调度模块：实现批量任务的统一管理，通过自定义的调度算法优化已有的
第二类是时间调度，时间调度就是提出一个时间范围，比如1:00~3:00，据此来计算，得
数据库管理系统的主要功能：
数据库管理系统通过对现有组件的合理配置及新服务的引入，实现用户管理、权限
“想明白”这个单纯说很难界定，空中花园，最终不落地，脱离了实际，也就脱离了
对于运维系统的建设，有了一个整体的共识之后，要落地需要的是一个可行的规划，
（7）高可用模块：完善已有的高可用体系建设，将数据库高可用模块接入平台，支
（6）日志模块：主要涉及系统日志、数据库日志的抽取和可视化建设，集成对接至MIS中。
（1）元数据模块：包括主机、实例、集群、业务等4个维度。
自动化运维的设计我们可以做得很高大上，期望通过这样一个平台实现很多我们渴
（5）SQL 审核模块：对于 SQL审核模块的建设，使得审核信息更加符合公司的开发
（4）工单接入及流程：实现和工单系统的对接，实现部分业务自动化处理流程。
（3）数据库备份恢复模块：实现批量的 MySQL、Redis 数据库备份操作。
（2）基础运维功能：包括实例部署、权限开通、服务启停。
切实可行的实施规划
设身处地的功能设计
落地生花：自动化运维该如何落地
---
## Page 483
理
方面是从基础运维到运维管理然后到自动化，而系统建设方面是从元数据管理，脚本管
以逐步向自动化的方向来建设了。
这是建立在充分的调研或者技术沉淀之上的，
序号
工具管理，自助化服务到自动化服务建设，
整个系统的建设分为了5个阶段，
下表13-1是我对于运维系统方向从无到有的一个规划，
份恢复建设
基础运维和备
系统设计及
项目群名称
技术预研
需求调研
MySQL数据库备份恢复
运维平台功能设计和规划
DBA权限处理协作单
服务启停及权限管理
元数据管理（CMDB)
DBA 权限工单流程
系统基础功能建设
运维平台架构设计
运维平台需求调研
数据库一键部署
运维系统重构
闭环对接
项目名称
完成运维平台的架构选型和功能
完成平台需求调研，生成需求调研报告
项目周期
其中第3、
两周
一周
一周
三周
两周
两周
三周
两周
两周
周
表12-1
不能一而就。
地
以在运维平台完成工单回调
SQL
完成
数
理，实例管理
能设计，
前端和平台前或
系统前后端分高
实现工单数据自动流转到运维平台，工单处理后，可
搭建数据库从库，
MySQL
开通数据库权限，
系统检查
据分析功能
实现元数
实现基础的系统管理，用户管理和权限控制
运维平台功能模块划分和接口设计
确定运维平台的体系结构，
收集、整理目前的数据库业务需求和痛点
两者是相辅相成的。
、4阶段的工作比例最大，
MySQL
回
查
并生成设计文核
全量
能
据
数据库权限开
数据库实例部署，
居的标准化管理
个离，后端逻辑采用API来对接，实现本
备
集群
端
份、
在打好一些基础之后，就可
第12章自动化运维架构设计和规划”461
自动完成主从关系的配置
系统防火墙，完成批量开通的任务，
增
理等基础功能，
管理，实现元数据看板，主机管
档
（全库恢复，增量恢复）和
备注
备
通
份和日
功能
技术选型和技术方案
实现 MySQL 多版本部