PRESENTED BY: 
© Mandiant, A FireEye Company. All rights reserved. 
Investigating  
PowerShell Attacks 
DefCon 22 2014 
August 8, 2014 
Ryan Kazanciyan, Matt Hastings 
© Mandiant, A FireEye Company. All rights reserved. 
Background Case Study 
2 
Attacker  
Client  
Victim 
VPN 
WinRM, 
SMB, 
NetBIOS 
Victim workstations, 
servers 
§  Fortune 100 organization 
§  Compromised for > 3 years 
§  Active Directory 
§  Authenticated access to 
corporate VPN 
§  Command-and-control via 
§  Scheduled tasks 
§  Local execution of 
PowerShell scripts 
§  PowerShell Remoting 
© Mandiant, A FireEye Company. All rights reserved. 
Why PowerShell? 
3 
Execute commands 
Reflectively load / inject code 
Download files from the internet 
Enumerate files 
Interact with the registry 
Interact with services 
Examine processes 
Retrieve event logs 
Access .NET framework 
Interface with Win32 API 
It can do almost anything… 
© Mandiant, A FireEye Company. All rights reserved. 
§  PowerSploit 
§  Reconnaissance 
§  Code execution 
§  DLL injection 
§  Credential harvesting 
§  Reverse engineering 
§  Nishang 
§  Posh-SecMod 
§  Veil-PowerView 
§  Metasploit 
§  More to come… 
PowerShell Attack Tools 
4 
© Mandiant, A FireEye Company. All rights reserved. 
PowerShell Malware in the Wild 
5 
© Mandiant, A FireEye Company. All rights reserved. 
Investigation Methodology 
6 
evil.ps1 
Local PowerShell script 
backdoor.ps1 
Persistent PowerShell 
Registry 
File System 
Event Logs 
Memory 
Network 
Traffic 
Sources of Evidence 
WinRM 
PowerShell Remoting 
© Mandiant, A FireEye Company. All rights reserved. 
§  Has admin (local or domain) on target system 
§  Has network access to needed ports on target system 
§  Can use other remote command execution methods to: 
§  Enable execution of unsigned PS scripts 
§  Enable PS remoting 
Attacker Assumptions 
7 
© Mandiant, A FireEye Company. All rights reserved. 
Version Reference 
8 
2.0 
3.0 
4.0 
Default 
Default (R2) 
Default 
Default 
Default (SP1) 
Default (R2 SP1) 
Requires WMF 
4.0 Update 
Requires WMF 
4.0 Update 
Requires WMF 
4.0 Update 
Requires WMF 
3.0 Update 
Requires WMF 
3.0 Update 
Memory Analysis 
© Mandiant, A FireEye Company. All rights reserved. 
§  What’s left in memory on the accessed system? 
§  How can you find it? 
§  How long does it persist? 
Memory Analysis 
10 
Scenario:  
Attacker interacts with target host through PowerShell remoting 
© Mandiant, A FireEye Company. All rights reserved. 
WinRM Process Hierarchy 
11 
Invoke-Command 
{c:\evil.exe} 
Client 
wsmprovhost.exe 
svchost.exe 
(DcomLaunch) 
evil.exe 
wsmprovhost.exe 
{PS code} 
Victim 
Invoke-Command  
{Get-ChildItem C:\} 
Invoke-Mimikatz.ps1 
-DumpCreds  
–ComputerName “victim" 
© Mandiant, A FireEye Company. All rights reserved. 
Remnants in Memory 
12 
wsmprovhost.exe 
svchost.exe 
(DcomLaunch) 
evil.exe 
wsmprovhost.exe 
{PS code} 
svchost.exe  
(WinRM) 
Remnants of 
WinRM SOAP 
persist 
Kernel 
Cmd history 
Cmd history 
Terminate 
at end of 
session 
© Mandiant, A FireEye Company. All rights reserved. 
How Long Will Evidence Remain? 
13 
wsmprovhost.exe 
svchost.exe 
(WinRM) 
Kernel Memory 
Pagefile 
Evidence 
Best source of 
command 
history, output 
Fragments of 
remoting I/O 
Fragments of 
remoting I/O 
Fragments of 
remoting I/O 
Retention 
Single remoting 
session 
Varies with # 
of remoting 
sessions 
Varies with 
memory 
utilization 
Varies with 
memory 
utilization 
Max Lifetime End of remoting 
session 
Reboot 
Reboot 
Varies – may 
persist beyond 
reboot 
© Mandiant, A FireEye Company. All rights reserved. 
Example: In-Memory Remnants 
14 
SOAP in WinRM service memory, after interactive PsSession with command:  
echo teststring_pssession > c:\testoutput_possession.txt 
© Mandiant, A FireEye Company. All rights reserved. 
Example: In-Memory Remnants 
15 
WinRM service memory - Invoke-Mimikatz.ps1 executed remotely on target host 
© Mandiant, A FireEye Company. All rights reserved. 
§  WSMan & MS 
PSRP Syntax 
/wsman.xsd 
§  Known attacker 
filenames 
§  View context 
around hits 
§  Yes, this is painful 
What to Look For? 
16 
""xmlns:r
sp="http://schemas.microsoft.com/wbem/wsman/
1/windows/shell"""C80927B1-C741-4E99-9F97-
CBA80F23E595prompt""/
rsp:Command>AAAAAAAAAFkAAAAAAA
AAAAMAAAajAgAAAAYQAgC2Yc+EDBrbTLq08PrufN
+rij8VmjyqZEaGAKwYZTnxB+
+7vzxPYmogUmVmSWQ9IjAiPjxNUz48T2JqIE49IlBvd2V
yU2hlbGwiIFJlZklkPSIxIj48TVM
+PE9iaiBOPSJDbWRzIiBSZWZJZD0iMiI
+PFROIFJlZklkPSIwIj48VD5TeXN0ZW0uQ29sbG 
. . . 
© Mandiant, A FireEye Company. All rights reserved. 
§  Timing is everything 
§  Challenging to recover evidence 
§  Many variables 
§  System uptime 
§  Memory utilization 
§  Volume of WinRM activity 
Memory Analysis Summary 
17 
Event Logs 
© Mandiant, A FireEye Company. All rights reserved. 
§  Which event logs capture activity? 
§  Level of logging detail? 
§  Differences between PowerShell 2.0 and 3.0? 
Event Logs 
19 
Scenario:  
Attacker interacts with target host through local PowerShell script 
execution or PowerShell remoting 
© Mandiant, A FireEye Company. All rights reserved. 
§  Application Logs 
§  Windows PowerShell.evtx  
§  Microsoft-Windows-
PowerShell/Operational.evtx 
§  Microsoft-Windows-WinRM/
Operational.evtx 
§  Analytic Logs 
§  Microsoft-Windows-
PowerShell/Analytic.etl 
§  Microsoft-Windows-WinRM/
Analytic.etl 
PowerShell Event Logs  
20 
© Mandiant, A FireEye Company. All rights reserved. 
Local PowerShell Execution 
21 
PowerShell 
EID 400: Engine state is changed 
from None to Available. 
… 
HostName=ConsoleHost  
EID 403: Engine state is changed 
from Available to Stopped. 
… 
HostName=ConsoleHost  
Start & stop times of 
PowerShell session 
© Mandiant, A FireEye Company. All rights reserved. 
Local PowerShell Execution 
22 
PowerShell 
Operational** 
EID 40961: PowerShell console is 
starting up  
EID 4100: Error Message = File C:
\temp\test.ps1 cannot be loaded 
because running scripts is disabled 
on this system  
** Events exclusive to PowerShell 3.0 or greater 
Start time of 
PowerShell session 
Error provides path to 
PowerShell script 
© Mandiant, A FireEye Company. All rights reserved. 
Local PowerShell Execution 
23 
PowerShell 
Analytic** 
EID 7937: Command test.ps1 is Started. 
EID 7937: Command Write-Output is Started. 