# 加密勒索软件行为侦测
## 以Mac OS X为例
### Henry
### HITCON 2016

#### 关于我
- **姓名**: 黄禹程 (Henry)
- **职位**: Verint公司开发者
- **专长**: Web开发
- **兴趣**: 信息安全
- **团队成员**: Chroot

#### 大纲
1. 侦测模型
2. 在Mac OS X上使用FUSE的实作成果演示
3. 实作说明
4. 问题与讨论
5. 新项目：RansomCare
6. 结论

### 侦测模型
#### 平台无关性
我们假设勒索软件有以下两种类型：
- **覆写型 (OVERWRITE)**: 加密并覆盖原文件。
- **开档型 (NEW_FILE)**: 生成加密的新文件并删除原文件。

对于勒索软件的行为，我们做出如下假设：
- 勒索软件一定会保留文件的全部内容。
- 勒索软件只具有普通用户权限。
- 可选：仅关注特定类型的文件（如.docx, .pptx, .xlsx, .pdf, .png, .jpg等）。

#### 勒索软件假设（续）
- **覆写型**:
  - 必须完全覆盖整个文件，并且文件内容会发生变化。
  - MIME类型改变（目前仅采用此标准）。
  - 文件相似度降低。
  - 文件熵增加。
- **开档型**:
  - 必须读取整个文件并在完成后删除该文件。
  - 进入点为`readdir`（列出目录下的文件）。

#### 执行路径归纳
- **覆写型**: `readdir` → `open` → `read all` → `write all` → `release`（文件变质）
- **开档型**: `readdir` → `open` → `read all` → `write to somewhere` → `unlink`

对所有进程进行如此详细的追踪会非常耗费资源。因此，可以利用白名单来优化这一过程。

#### 合理的白名单
- 系统程序
- 开启菜单中的程序
- 所打开文件的扩展名不在关注列表中（例如不是.docx, .pdf, .png等）

### 实作说明
#### Hansom如何利用FUSE来侦测勒索软件？
- **FUSE (Filesystem in Userspace)**: 
  - 在Mac OS X上通过osxfuse实现。
  - 包括FUSE内核模块和libfuse库。
  - FUSE将文件系统的操作请求交由用户空间程序处理。

#### 图解Hansom实作
- 示例：`open`操作

### 问题与讨论
#### 如何躲避侦测？改进空间？
- 将关键操作拆分到不同进程中。
- 注册到开启菜单中（需要高权限）。
- 放置在系统目录或注入系统进程中。
- 先更改文件扩展名再打开文件。
- 不关闭文件。

#### 改进方向
- **侦测方式**:
  - **Inline模式 vs Sniffer模式**
  - **FUSE方法**:
    - **Inline模式**:
      - 在勒索软件演化前有效。
      - 影响系统性能（系统调用从内核到用户再到内核）。
    - **理想方法**:
      - 从内核模式将关键行为事件传回用户模式进行判断。
      - 判断与系统操作异步，不影响系统稳定性。
      - 用户模式监控蜜罐文件。

### RansomCare
- **GitHub链接**: https://github.com/Happyholic1203/ransomcare
- **支持平台**: OS X, Windows
- **待办事项**

### 结论
- 本模型基于行为检测，与平台无关。
- 该模型能检测KeRanger及自制勒索软件。
- 目前尚未在非OS X平台上测试。
- 勒索软件会不断演化，攻防战将持续。
- 最令人头疼的演化方向包括高权限、DLL侧加载等。
- **Inline模式**: 系统性能/稳定性受影响。
- **Sniffer模式**: 某些文件可能被牺牲，误判率较高。

### 参考资料
- [1] FUSE: https://en.wikipedia.org/wiki/Filesystem_in_Userspace
- [2] osxfuse: https://osxfuse.github.io/
- [3] libfuse: https://github.com/libfuse/libfuse

### 相关工作
- **Emsisoft Behavior Blocker (2015)**: 成功检测20种勒索软件（附带演示）。
- **CryptoDrop (IEEE ICDCS 2016)**: 成功检测492个勒索软件样本。
  - 使用Windows内核驱动。
  - 指标包括文件类型变化、文件相似度和香农熵。

### Q & A
感谢大家的指教！您的建议是我们进步的动力！

谢谢！