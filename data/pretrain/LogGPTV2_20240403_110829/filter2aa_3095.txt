加密勒索软体行为侦测
(以Mac OS X为例)
Henry
HITCON 2016
About Me
• 黄禹程 (Henry)
• Developer at Verint
• 专长: Web Development
• 资安是兴趣
• Chroot成员
大纲
• 侦测模型
• Mac OS X上用FUSE实作成果演示
• 实作说明
• 问题与讨论
• 新专案：RansomCare
• 结论
侦测模型
与平台无关
对勒索软体的假设
• 世上只有两种勒索软体
– 覆写型 (OVERWRITE): 加密并覆写原档
– 开档型 (NEW_FILE): 产生新加密档并删除原档
• 一定会保留档案全部内容
• 只具一般使用者权限
• [optional] 只关注某些档案类型
– Ex. docx, pptx, xlsx, pdf, png, jpg, ......
对勒索软体的假设
(continued)
• 覆写型: 必覆写全档，且档案内容变质
– MIME Type改变 (目前只采用此项)
– 相似度变低
– Entropy变高
• 开档型: 必读取全档，且读完会删档
• 进入点是readdir (列出某目录下的档案)
归纳：执行路径
• 覆写型：readdir → open → read all → write 
all → release (档案变质)
• 开档型：readdir → open → read all → 
(write to somewhere) → unlink
• 对所有行程都追踪这么长的路径很耗资源
– 利用白名单
合理的白名单？
• 系统程式
• 在开启选单中的程式
• 所开档案副档名不被关注
– 不是.docx, .pdf, .png, ......
开启选单
inspected process
P
monitored ﬁle
F
侦测模型
DEMO - HANSOM
Hansom - 用FUSE实作的Proof of Concept
实作说明
Hansom如何利用FUSE来侦测ransomware？
FUSE[1]
• Filesystem in USErspace (OSX: osxfuse[2])
– FUSE kernel module
– libfuse[3] (library in userspace)
• FUSE的kernel module把filesystem的操作请
求交由userspace的程式来作回应
图解Hansom实作
例：open
问题与讨论
如何躲避侦测？改进空间？
inspected process
P
monitored ﬁle
F
如何躲避侦测？
档
4. 把关键动作拆在不同process中
5. 把自己注册到开启清单 (需要高权限)
6. 放进系统目录中 or 注射系统process
7. readdir完先把副档名改掉再open
2. 不要关档
改进空间及方向？
• 侦测方式：inline mode v.s. sniffer mode
• FUSE的作法
– Inline mode
– Ransomware演化前可有效侦测
– 会影响系统效能 (syscall从kernel → user → kernel)
• 较理想的作法
– 从Kernel mode将关键行为事件传回user mode判断
• 判断跟系统操作非同步 → 不影响系统稳定性
– User mode: 监控honey file
RANSOMCARE
https://github.com/Happyholic1203/ransomcare
OS X
Windows
TODO
结论
结论
• 本模型只看行为 → 与平台无关
• 该模型能侦测KeRanger及自制ransomwares
– 尚未在OSX外实验
• Ransomware会演化 势必会有一番攻防
– 最头痛的演化方向：高权限、DLL side loading等
• 知道盾的作法 也探讨了矛的新切入角度
• Inline mode penalty: 系统效能/稳定性
• Sniffer mode penalty: 有些档案会牺牲 误判率较
高
Reference
•
[1] FUSE https://en.wikipedia.org/wiki/Filesystem_in_Userspace
•
[2] osxfuse https://osxfuse.github.io/
•
[3] libfuse https://github.com/libfuse/libfuse
Related Works
• Emsisoft Behavior Blocker (2015)
– 成功侦测20支ransomware (连结里有demo)
• CryptoDrop (IEEE ICDCS 2016)
– 成功侦测492个ransomware sample
– Windows Kernel Driver
– Indicators
• File Type Changes: magic number
• File Similarity: sdhash outputs similarity bettween two 
files
• Shannon Entropy: entropy of an array of bytes
Q & A?
各位的指教都是进步的动力！
谢谢！