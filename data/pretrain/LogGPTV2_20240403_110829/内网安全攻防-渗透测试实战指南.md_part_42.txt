## Page 322
### 第6章 域控制器安全
#### 6.6.5 防范建议
针对Kerberos域用户提权漏洞，以下是一些防范建议：
- **启用Windows Update功能**：确保系统自动接收并安装最新的安全更新。
- **手动下载补丁包**：对于已知的安全漏洞，微软通常会发布相应的修复补丁。请参考[链接6-15]获取最新补丁。
- **加强账户管理**：禁止使用弱口令，并定期更改密码以增强安全性。
- **部署反病毒软件**：在服务器上安装反病毒软件，并及时更新病毒库，以防御潜在威胁。

---
## Page 324
### 第7章 跨域攻击分析及防御
许多大型企业拥有自己的内部网络，通过域林来共享资源。根据不同的职能，这些部门被逻辑地划分为主域和子域，便于统一管理。物理层面上，通常利用防火墙将各子公司及部门隔离成不同的区域。如果攻击者获得了某个子公司或部门的域控制器权限，但未能获得整个公司内网的所有权限（或者所需资源不在该域中），他们可能会尝试获取其他部门或域的权限。因此，在规划网络边界时，理解攻击者如何进行跨域攻击有助于更安全地部署内网环境，有效预防此类攻击行为。

#### 7.1 跨域攻击方法分析
常见的跨域攻击手段包括：
- 利用Web漏洞等常规渗透技术实现权限跨越；
- 使用哈希传递或票据传递攻击，特别是当多个域控制器使用相同的本地管理员密码时；
- 利用现有的域信任关系实施跨域攻击。

#### 7.2 利用域信任关系的跨域攻击分析
域信任机制旨在解决多域环境中的资源共享问题。默认情况下，一个域内的所有用户都可以访问该域内的资源。要访问其他域中的资源，则需建立域信任关系。这种关系允许另一个域的用户在通过身份验证后访问本域资源。此外，DNS服务器用于定位不同子域的域控制器；若无法找到另一方的域控制器，则不存在跨域资源共享的可能性。

##### 7.2.1 域信任关系简介
- **单向信任**：仅在一个方向上存在信任流和访问流。例如，A域信任B域意味着B域内的主体可以访问A域资源，反之则不行。
- **双向信任**：两个方向均存在信任流与访问流，适用于活动目录中所有域间的信任关系。创建新子域时，会在子域与其父域间自动建立双向可传递的信任关系。
- **内部信任**：默认情况下，在添加新域至域树或根域时，会自动建立双向可传递的信任关系。
- **外部信任**：指不同林之间的信任关系，通常是不可传递的。然而，某些类型的林间信任可能是可传递的。

从早期版本到Windows Server 2003，域信任关系经历了从单一、不可传递到双向且可传递的变化。只有DomainAdmins组成员有权管理这些信任设置。

##### 7.2.2 获取域信息
EnterpriseAdmins组成员对整个目录林具有完全控制权，默认包含所有域控制器上的Administrators权限持有者。LG.exe是一款C++编写的命令行工具，可用于枚举远程主机的用户和组信息。图示展示了如何使用`whoami /all`命令查看当前用户的权限状态，以及利用LG.exe列举特定域中的用户组详情。

##### 7.2.3 利用域信任密钥获取目标域权限
首先需要搭建合适的测试环境。通过mimikatz工具，可以基于已知的信任密钥生成伪造的票据，进而访问目标服务。具体步骤涉及指定当前域名、SID、目标SID、信任密钥等参数，并保存生成的票据文件供后续使用。最后，利用该票据请求目标服务的TGS票证，从而完成跨域攻击过程。

---

请注意，上述内容为网络安全领域专业知识介绍，仅供学习交流之用，请勿用于非法目的。