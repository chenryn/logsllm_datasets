# OCR Output
## Page 1
Linux/Unix
技术丛书
Python
自动化运维
技术与最佳实践
刘天斯著
AutomationOperationswithPython
Techniqueand BestPractices
·中国运维领域偶像级专家、腾讯高级系统工程师在天涯社区和腾讯
近10年运维实践的经验和智慧结晶
·不仅详尽介绍了服务监控、数据报表、系统安全等基础模块，而且
深入讲解了自动化操作、系统管理、配置管理、集群管理及大数据
应用等高级功能，包含4个完整的综合案例
机械工业出版社
China Mochlne Press
---
## Page 2
Python
自动化运维
技术与最佳实践
AutomationOperationswithPython
Technique and Best Practices
刘天斯著
---
## Page 3
图书在版编目（CIP）数据
Python自动化运维：技术与最佳实践/刘天斯著。一北京：机械工业出版社，2014.11
( 2014.12重)
（Linux/Unix技术丛书）
ISBN 9787111483069
I. PIL.刘III.软件工具程序设计IV.TP311.56
中国版本图书馆CIP数据核字（2014）第242462号
Python自动化运维：技术与最佳实践
出版发行：机械工业出版社（北京市西浦区百万建大衡22号
邮战输码：100037)
责任编辑：美影
责任校对：股虹
印
刷：三河市宏图印务有限公司
版
次：2014年12月第1版第2次印刷
开
本：186mm×240mm 1/16
印
张：19.5
书
号: ISBN 978-7-111-48306-9
价：69.00元
凡购本书，如有缺页、倒页、脱页，由本社发行部调换
客服热线：（010）8837899188361066
投辑热线：(010） 88379604
薪书热线：(010) 6832629488379649 68995259
读者信箱：PI:EMAIL
版权所有·经权必究
封底无防伤标均为盗版
本书级律额网：北京大成津所事务所韩光/晚东
---
## Page 4
7本书赞誉
市面上介绍互动的、面向对象的Python编程语言的书有很多，其强大而又灵活的特性，
使其成为很多企图通过工具来实现工作（半）自动化的运营同学的首选。更难得的是，本书
作者以其在腾讯游戏运营的工作经验，辅以大量实际的案例来讲述了他是如何使用Python来
解决诸如监控、安全、订制报表和大数据应用等问题，以及构建一个自动化运维的平台来提
升运维工作效率，值得一看。
腾讯互动娱乐运营部副总经理崔晓春
《Python自动化运维：技术与最佳实践》是结合刘天斯先生超过十年，在互联网行业“天
涯在线”及“腾讯”等的工作经验，实际贴近工作应用场景所撰写的书籍，没有浮夸的文藻
修饰，只有实际的落地执行和动手操做，可以作为大家在工作中的工具书。
全书以系统信息的了解、采集、监控，以及信息良好地输出为开头，以提升个人工作效
率的基础运维工具为承接，再深入介绍集中化管理海量机器、系统的方案，并且搭配实际的
例子进行介绍，相信能够覆盖读者的大部分应用场景需求，也能够给予读者相关领域的入门
指引。
刘天斯先生的精神也是很值得推广和赞赏的，在繁忙的工作之余，能够思考、总结，并
且能够以文字的方式与更多的人分享和传承，是除了书籍本身之外，我学习到的重要收获。
腾讯互动娱乐运管部数据中心总监孙龙君
在移动互联和大数据时代，无论是出于对效率的追逐，还是应对海量规模运维，自动化
运维都是企业的必然选择。Python因为具有简单、灵活、功能强大和适合脚本处理等优点，
在运维领域被广泛使用，让很多运维工程师从烦的日常工作中解放出来。
天斯是运维领域的资深专家，在互联网行业工作多年，不仅具备解决各种运维难题的
强大能力，拥有多项专利，还开发过多个运维利器，非常受欢迎。本书是国内第一本讲述
---
## Page 5
IV
Python如何应用在自动化运维领域的著作，是基于天斯对Python自动化运维的深入研究，
以及在海量互联网实战经验中总结提炼面来，具有高度可读性和实战价值。
腾讯架构平台部运维服务中心总监孙雷
刘天斯和我相识于腾讯，期间我正在负责腾讯云平台相关工作。腾讯有一个优良的新员
工培养体系，那就是导师制度。有幸作为天斯的导师，让我接触并逐渐深人了解天斯。所以
当天斯找到我为本书写推荐语时，我欣然应允，因为共事期间天斯给我留下了深刻的印象。
时至今日，在中国的互联网企业里，我认为天斯都是最优秀的架构师之一。
天斯来腾讯工作之前，在中国著名的天涯社区负责整个社区的运维工作，经历了天涯社
区从Windows平台到开源架构的大改造，因此对B/S相关产品的技术架构和细节非常熟悉；
面天斯又是一个在技术输出领域非常活嵌的人，自己维护的技术博客荣获2010年度十大杰
出IT博客，在中国互联网技术领域小有名气。
记得来腾讯不到两个星期，天斯就向我提交了一份关于腾讯业务自动化运维的技术文
档，从业务的部署到监控再到容灾等，都理解得较为深刻。这份输出文档让我眼前一亮，当
时第一感觉是这个典型的在生活中不善言辞的IT男，一定对云计算中的自动运维管理有独
到的思维和沉淀。
Python语言作为获得2010年度编程大奖的语言，具备诸多优点：简单、开源、速度快、
可移植性强、可扩展性强、面对对象、具备丰富的库等；更可贵的是，作为“胶水语言”，
可以把Python嵌入C/C++程序等，从而向程序用户提供脚本功能。
本书从互联网业务自动运维的场景出发，以Python语言为基础，总结了大量的实战案
例，这些都是作者在十余年的大型互联网运维工作中的宝贵经验，相信会给读者带来不少的
启发。
更难能可贵的是，作者能从通俗易懂的角度出发，由浅人深地剖析Python自动运维管
理之道。因此，目前Python水平处于各种层次的读者均能有效地阅读和吸收，各取所需。
最后，感谢天斯能给中国互联网从业者带来这么好的分享，感谢我们的老东家一中国
互联网的黄埔军校—腾讯培养了一批又一批的杰出架构师。
开卷有益，我想应该就是指的此类书籍吧。
微赢宝创始人许明
“Operation”，运维在互联网时代一直有着举足轻重的地位，面近两年运维本身这个群体
也变得强大起来，最为显著的特征就是运维人员所出的书越来越多，而都以“专”、“精”为
卖点。这也是作为一名运维人员值得骄傲的地方。
伴随着“云时代”、“物联网”的到来，无论数据，还是服务器规模都达到了空前的庞大，
---
## Page 6
企业对运维工作人员的要求也由之前的运维维护转为“DevOps”，即研发型运维；在这个充
满挑战的时代，任何一个岗位都需要保持持续学习的状态，而运维更不例外。
“Python”，运维的标配语言，比起Bash、Perl、PHP等，它在系统管理上有着强大的开
发能力和完整的工具链。易读易写，兼具面向对象和函数式风格，还有元编程能力都是它的
优势所在。最关键的地方在于，可以利用Python系统化地将各个工具进行整合，对运维常用
工具进行二次开发，形成一套完整的运维体系。“一套完整的产品生命周期”，这才是运维需
要做的事情。
运维“三板斧”：系统安装、命令执行、配置管理，再加上监控与日志分析等这些都是
我们最常用的工具，而它们都有 Python 的版本，例如：Fabric、Ansible、Saltstack、Fune 等，
这些都将在本书《Python自动化运维：技术与最佳实践》中向大家一一呈现，安装、用法、
技巧、特别是大量实例一网打尽。为了让读者更好地系统学习，天斯又写了前端以及从“0”
开始打造一个运维平台，可谓用心良苦。
未来，中小型企业将精减运维，不会开发的运维，竞争力将显得更加单薄，相信天斯多
年运维开发经验的结品能帮到大家。
西山居架构师，《Puppet实战》作者刘宇
网站架构与设计交流”，刘天斯先生提出的架构方案，堪称成熟、镇密、灵动，足见其在系
统运维领域的功力。纵观《Python自动化运维：技术与最佳实践》一书，都是出自于刘天斯
先生在天涯及腾讯工作的一线宝贵经验，相信无论是开发人员还是系统管理员们均能从中学
习到新的知识点，使自己的职业生涯更上一个新的台阶。
融贯资讯系统策构师余洪春
---
## Page 7
前言7cec
为什么要写这本书
随着信息时代的迅速发展，尤其是互联网日益融人大众生活，作为这一切背后的IT服
务支撑，运维角色的作用越来越大，传统的人工运维方式已经无法满足业务的发展需求，需
要从流程化、标准化、自动化去构建运维体系，其中流程化与标准化是自动化的前提条件，
自动化的最终目的是提高工作效率、释放人力资源、节约运营成本、提升业务服务质量等。
我们该如何达成这个目标呢？运维自动化工具的建设是最重要的途径，具体包括监控、部署
变更、安全保障、故障处理、运营数据报表等。本书介绍如何侵用Pyhon语言来实现这些功
能点，以及Python在我们的自动化运维之路上发挥作用，解决了哪些运维问题等。
为什么是Python？Python是一种面向对象、解释型计算机程序设计语言，由Guidovan
Rossum于1989年年底发明，具有简单易学、开发效率高、运行速度快、跨平台等特点，尤
其是具有大量第三方模块的支持，其中不乏优秀的运维相关组件，例如Saltstack、Ansible、
Func、Fabric等。大部分运维人员为非专业开发人士，对他们面言，选择一门上手快、技术
门槛低的开发语言非常重要。由于Python具有脚本语言的特点，学习资源多，社区非常活联，
且在Linux平台默认已安装等优势。Python已经是当今运维领域最流行程的开发语言之一。
2003年毕业后，我的第一份工作是当PHP程序员，人力紧张时还要兼顾美工的工作。
分公司都闭门不招聘，一个毕业生能有这样的机会锻炼也显得尤为珍贵。工作中一次偶然
的机会看到导师诗成兄在黑漆漆的界面中输人不同指令，第一感觉非常震撼，很酷，联想
到《黑客帝国》电影中的画面，与之前接触到的Windows系统完全不一样，后来才晓得是
Redhat9（红帽9）。此后很长的一段时间里，整个人完全沉醉在Linux的世界里，处于一种
痴迷的状态，那时我还是一个程序员。
到了2005年10月，看到隔壁公司招聘一名Linux系统工程师，抱着试一试的心态去
面试，结果出乎意料，我被录用了，这样我就找到了第二个东家一一天涯社区。人生的第一
---
## Page 8
个转折点在此配酿，由于赶上了公司快速发展的阶段，接触到了很多开源技术，包括LVS、
Squid、Haproxy、MongoDB、MySQL、Cfengine等，并且不断在生产环境中应用所学的技
术，取得了非常不错的效果，重点业务的高可用持续保持在99.99%。期间新的问题也陆续出
现，包括如何更好整合各类开源组件，发挥其最大效能，以及如何高效运营。不可否认，具
有开发背景的运维人员有着先天优势，可以在不同角色之间进行思考，扩大视野。期间我参
。与了推动大量标准化、规范化的建设，以此为前提，开发了“SDR1.0-Linux主机集中管理”、
"天涯LVS管理系统”、“天淮服务器管理系统（C/S与B/S版）、“服务器机柜模拟图平台”、
"Varmish缓存推送平台V1.0”等平台，这些平台在很大程度上改变了运维人员手工作坊式的
工作模式。在释放人力的同时，我看到国内其他公司的同仁也在做同样的事情，突然间有一
个想法，就是开源。此时已经是2009年，这个想法也得到系统部经理小军认可，同年12月
陆续在code-google.com平台托管，让业界更深人了解天涯社区的技术架构。凭着这些作品及
出IT博客”的殊荣。我还先后参与了51CTO、IT168、CU等门户网站以架构、运维为主题
的专访，在运维圈得到越来越多同仁的认同。
再谈谈如何与Python结缘。接触Python是从《简明Python教程》开始，由于我有Perl
与PHP的基础，学习Python没有太大压力。事实上，Python的简洁、容易上手以及大量第
三方模块等特点，深深吸引了我，让我第二次沉醉于知识的海洋。我很快深人学习了Fumnc、
Django 框架、SQLAlchemy、BeautifulSoup、Pys60、wxPython、Pygame、wmi 等经典模块，同
时将所学知识应用到运维体系中，解决在工作中碰到的问题。例如，开发的“多节点应用延
缓存推送平台”解决了快速刷新缓存对象的问题。再例如，删除敏感帖子的时效性要求非常
高，需要在后台触发删除后立即生效，与缓存推送平台对接后很好地解决了这一间题：天涯
服务器管理系统（C/S、B/S、移动版）实现自助、智能、多维度接人，提高了运维效率，减
少了人工误操作，释放了人力资源，同时标准化与流程化得到技术保障与实施落地。
天涯社区是我个人职业生涯的培育期，让我重新审视自我，明确了未来的规划与定
位。2011年9月是我职业生涯的成长期的开始，加盟了腾讯，负责静态图片、大游戏下载
业务CDN的运维工作，接触到庞大的用户群、海量的资源（设备、带宽、存储）、世界级的
平台、人性化的工作氨围以及大量优秀的同事。所有的这些都深深地吸引着我，也让我的视
野与工作能力得到前所未有的提升。分工细化产生运维工作模式的差异，从“单兵作战”转
向“集团军作战”。我继续保持着对新技术的狂热，思考如何使用Python在运维工作中发挥
作用。工作期间研究了大量高级组件，包括Paramiko、Fabric、Saltstack、Ansible、Func等，
这些组件有了更高级的封装，强大且灵活，贴近各类业务场景。我个人也基于Python开发
了集群自动化操作工具一-yorauto，在公司各大事业群广泛使用，同时入选公司精品推荐组
件。我的部分个人发明专利使用Python作为技术实现。目前我也关注大数据发展趋势，研究
Python在大数据领域所扮演的角色。
---
## Page 9
VIII
回到主题“为什么要写这本书”，这一点可以从51CTO对我的专访中找到答案。当时的
场景是这样的：
51CTO：您对开源是如何理解的？天涯社区在过去两年间陆续开源了包含LVS管理系
统、Varmish缓存推送平台、高性能数据引擎memlink等好几个项目，业内人士对此都十分关
注，您认为这给整个产业带来了哪些好处？身为天涯社区的一位运维人员，您认为在这个过
程中自己的价值在哪里？
刘天斯：开源就是分享，让更多人受益的网时自己也在提高。经常看到很多朋友都在微
监控平台、运维工具。事实上功能惊人相似，大家都在做重复的工作，为什么不能由一个人
开源出来，大家一起来使用、完善呢。这样对整个行业来讲，这块的投入成本都会降低，对
个体来诉也是资源的整合。如果形成良性循环，行业的生态环境将会有很大程度的改善。本
人热衷于开源技术，同样也隐意为开源贡献自己一分微薄之力，希望更多的人能支持开源、
参考开源。
这就是我的初衷，也是答案。写书的意义在于将10年的工作沉淀、经验、思路方法微
个梳理与总结，同时与大家分享。最终目的是为每个渴望学习、进步、提升的运营人员提供
指导。
读者对象
口系统架构师、运维人员
口运营开发人员
 Python 程序员
口系统管理员或企业网管
口大专院校的计算机专业学生
如何阅读本书
本书分为三大部分。
第一部分为基础篇（第1～4章），介绍Python在运维领域中的常用基础模块，覆盖了
系统基础信息、服务监控、数据报表、系统安全等内容。
第二部分为高级篇（第5～12章），着重讲解Python在系统运维生命周期中的高级应用
功能，包括相关自动化操作、系统管理、配置管理、集群管理及大数据应用等内容。
第三部分为案例篇（第13～16章），通过讲解4个不同功能运维平台案例，让读者了解
平台的完整架构及开发流程。
---
## Page 10
IX
说明：
项目”。
口书中涉及的所有示例及源码的 Github 地址为https://github.com/yorkoliu/pyauto，以章
节名称作为目录层次结构，模块及项目代码分别存放在对应的章节目录中。
其中第三部分以接近实战的案例来讲解，相比于前两部分更独立。如果你是一名经验丰
富Linux管理员且具有Python基础，可以直接切入高级篇。但如果你是一名初学者，请一定
从基础篇开始学习。本书不涉及Python基础知识，推荐新手在线学习手册：《简明Python教
程）与《深人Python:DiveInto Python 中文版》。
勘误和支持
由十笔者的水平有限，且编写时间仓促，书中难免会出现一些错误或者不准确的地方，
悬请读者批评指正。为此，特意创建一个在线支持与应急方案问答站点：http://qaliuts.com。
也可以在问答站点中发表，我将尽量在线上提供最满意的解答。我也会将及时更新相应的功
能更新。如果你有更多的宝贵意见，欢迎发送邮件至邮箱PI:EMAIL，期待能够得
到你们的真擎反馈。
致谢
首先要感谢Guido大神，是他创立了Python语言，同时也要感谢提供Python优秀第三
方模块的所有作者，开源的精神与力量在他们身上体现得淋漓尽致。
感谢钟总、王工、诗成兄，是他们给予我第一份工作，也为个人此后的成长提供了
非常多的指导。感谢天涯社区的邢总（968）、王总（建科）、小军，是他们提供了这么优
秀的平台，让我有机会可以尽情施展才能，体现个人价值。感谢腾讯的Willim（崔晓春）
Tomxiao（肖志立）Thundersun（孙雷）Stanleysun（孙龙君）Trackynong（农益辉）Chanceli（李
飞宏）、Blue（许明）导师，以及接入运维组（TEG）、数据管理组（IEG）所有兄弟姐妹在工
作中给予的帮助、指导与支持，让我可以在新的环境继续突破自我，实现自我价值。感谢洪
春兄（抚琴煮酒）的引荐，在他的努力下才促成了这本书的合作与出版。
感谢机械工业出版社的编辑杨福川和姜影，在这一年多的时间中始终支持我的写作，他
们的鼓励和帮助引导我能顺利完成全部书稿。
感谢已经过世的爷爷，是他深深影响着我的人生观与价值观，他的教导我会永远铭记在
心。感谢我的爸爸、妈妈，感谢他们将我培养成人，在成长的过程中不断鼓励、激励我继续
---
## Page 11
前进。感谢姐姐、弟弟，他们是我成长过程中最好的挚友与伙伴。
最后感谢我的爱人杜海英，没有你就没有我们幸福的小家和可爱的宝宝。感谢她支持我
做的所有决定，没有她背后默默的支持与鼓励，也没有我今天的成就，更也不会有这本书。
我想说：谢谢你！有你真好。
谨以此书献给我最亲爱的家人与我自己，以及众多热爱开源技术的朋友们！
刘天斯（Yorkoliu）
---
## Page 12
推荐阅读
Nagin最城监控实践
Puppet实战
Linux系统命令
及Shell本
实践指南
Linux服务器
建高可用
---