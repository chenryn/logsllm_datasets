### 版权信息

**书名**：【抢鲜版】-黑客秘笈——渗透测试实用指南（第3版）  
**ISBN**：978-7-115-52917-6

本书由人民邮电出版社发行数字版。版权所有，侵权必究。

您购买的人民邮电出版社电子书仅供您个人使用，未经授权，不得以任何方式复制和传播本书内容。我们相信读者具有保护知识产权的良知和觉悟。若发现侵权行为，我们将采取包括但不限于关闭账号等措施，并可能追究法律责任。

**版权**
- **作者**：[美] 皮特·基姆（Peter Kim）
- **译者**：孙勇、徐太忠
- **责任编辑**：张涛
- **出版发行**：人民邮电出版社
- **地址**：北京市丰台区成寿寺路11号
- **邮编**：100164
- **电子邮件**：PI:EMAIL
- **网址**：http://www.ptpress.com.cn
- **读者服务热线**：(010)81055410
- **反盗版热线**：(010)81055315

**版权声明**

Simplified Chinese language edition published by POSTS & Telecom Press. Copyright ©2020. All Rights Reserved.

The Hacker Playbook 3: Practical Guide To Penetration Testing, by Peter Kim, ISBN 9781980901754. Copyright ©2019 by Peter Kim.

本书中文简体版由作者授权人民邮电出版社有限公司出版。未经出版者书面许可，对本书的任何部分不得以任何方式或任何手段复制和传播。版权所有，侵权必究。

### 内容提要

本书是畅销图书《黑客秘笈—渗透测试实用指南》（第2版）的全新升级版，不仅对第2版内容进行了全面更新，还补充了大量的新知识。书中涵盖大量的实际案例，力求使读者迅速理解和掌握渗透测试中的技巧，做到即学即用。

全书共分为11章，内容涵盖了攻击工具的安装和使用、网络扫描、网络漏洞利用、突破网络、物理访问攻击、规避杀毒软件检测、破解密码的相关技巧以及如何编写分析报告等。

本书适合网络安全从业人员以及对黑客技术感兴趣的爱好者阅读，还可以作为高校信息安全专业师生的参考书。

### 前言

这是“黑客秘笈”系列图书的第3版。除第1版和第2版介绍的一些攻击方法和技术（目前仍有效）外，本书还将介绍以下新的漏洞和攻击方法：

- 活动目录攻击
- Kerberos攻击
- 网站攻击高级技术
- 更好的横向渗透方法
- 云漏洞
- 快速和智能口令破解
- 使用系统凭证和合法软件开展攻击
- 横向移动攻击
- 多种定制试验环境
- 新出现网站编程语言漏洞
- 物理攻击
- 权限提升
- PowerShell攻击
- 勒索攻击
- 红队与渗透测试
- 搭建红队所需的基础设施
- 红队效果评估
- 开发恶意软件和规避杀毒软件

除此之外，本书尝试响应读者对第1版和第2版图书提出的评论和建议，并作出了反馈。这里要强调的是，我不是职业作家，仅仅是喜欢安全技术，喜欢传播安全技术。这本书是我注入满腔热情写作的，希望您能够喜欢。

本书将深入探讨如何建立设备实验室的环境，用来检测攻击效果，同时还会介绍最新的渗透方法和技巧。本书力求通俗易懂，很多学校已经把这本书作为教科书。书中尽可能多地增加试验章节，为读者展示测试漏洞或者利用漏洞的方法。

与前两版图书相似，本书中的内容尽可能以实战为基础。本书中并不涉及理论攻击技术，主要内容来自于作者的实战技术和经验。目前网络安全已经有了很大变化，主要从渗透测试转到红队攻击模式，本书不是仅仅介绍这些变化，而是通过示例展示为什么发生这样的变化。因此本书目标分为两部分：一是了解攻击者的攻击思路，理解攻击怎样开展的；二是介绍攻击工具和技术，并详细解释。除帮助读者理解概念和展示试验过程外，本书更重要的目的在于启发读者进行独立思考和探索。与其辛苦地写简历（当然，您需要一份简历），还不如拥有一个很有影响力的Github代码库和技术博客，我认为这会胜过一份好简历。无论您是从事防御研究还是攻击研究，深入了解相关技术发展，并且与安全同行进行分享是必不可少的。

没有读过前两本书的读者，可能会产生疑问，我的经验来自于什么地方。我的工作背景包括超过12年的渗透测试/红队攻击经验，测试的对象包括大型金融机构、大型公用事业公司、财富500强企业和政府机构。多年来我也在多个大学传授网络安全攻击课程，在多个安全会议上做过主题发言，在多个安全杂志上发表论文，在国内各个地方授课，举办多个公开CTF比赛，并开办个人安全学校。我个人最感兴趣的项目是在南加州经营一个免费和开源安全社区LETHAL。目前，社区成员超过800人，每个月有安全主题会议和CTF比赛等多项活动，社区已经成为人们分享、学习和提高安全技能的一个神奇的平台。

一个重要提示是我同时使用商用工具和开源工具。对于每一个商用工具，我都会尽可能找到对应的开源工具。偶尔会遇到某些渗透测试人员，他们表示只使用开源工具。作为一名渗透测试人员，我觉得这种观念很难接受。“坏小子”没有仅使用开源工具的限制，因此如果要模拟“真实世界”的攻击，您需要使用任何有助于完成任务的工具。

我经常被问到，这本书面向哪些读者？这个问题很难回答，我认为安全人员都可以从这本书中学到知识。书中部分内容对于新手来说有些高深，部分内容对于有经验的黑客有些简单，还有些内容甚至可能与从事的领域无关。

### 声明和责任

我重申以下提示非常重要：如果未得到合法授权，不要扫描他人服务器，探测是否存在漏洞并攻击服务器。如果未得到合法授权，不要尝试本书中提到的任何攻击方法。即使不是怀着恶意目的，而只是好奇，上述行为也会为他人增添很多麻烦。目前有大量漏洞奖励项目和漏洞网站/虚拟机，可以用于学习技术和提高能力。对于有些漏洞奖励项目，超出约定范围或者攻击范围过广都会招惹麻烦。

如果您对上述提示感到困惑，那么可能是我表达得不清楚，您可以咨询律师或者联系电子前线基金会（EFF）。在技术研究和非法活动之间有一条清晰的界限。

请记住，您仅在测试系统中有权限写入程序。在Google搜索关键词“hacker jailed”（黑客监禁），您会看到大量不同的案例，比如青少年由于做了他们认为“很好玩”的事情而被判入狱多年。网络上有很多免费的平台，允许对其使用合法的技术，并且能够帮助您提高能力。

最后，我不是Windows、代码、漏洞挖掘、Linux或者其他领域的专家。如果在具体技术、工具或者进程等方面出现误差或遗漏，我会在本书的更新网站上更正相关内容。书中很多内容借鉴自其他人的安全领域研究成果，我会尽可能提供原成果的网络链接地址。

### 引言

在上一次交战中（本书第2版），您完成了任务，攻破了网络猫公司的武器设施。现在他们卷土重来，成立了新的太空部门—网络空间猫。这个新部门从先前的安全评估中汲取了所有经验教训，建立了一个本地安全运营中心来加固他们的系统，并且制定了安全策略。他们雇用您开展网络渗透，以测试所有安全加固措施是否能够真正提升安全防护能力。

从我们搜集到的少量细节来看，网络空间猫公司发现了一颗位于大仙女座星云或仙女座星系中的秘密行星。位于两个旋臂之一上的这颗行星被称为KITT-3n，其大小是地球的两倍，位于名为OI 31337的二元系统中，其恒星的大小也是地球恒星的两倍。这创造了一个可能适合居住的环境，包括海洋、湖泊、植物。

由于可能存在新生命、水甚至另一个适合生命生存的星球，因此太空竞赛是实际存在的。网络空间猫部门聘请我们进行红队评估，确保他们能够检测并阻止违规行为。他们的管理层已经了解和掌握了去年所有重大的安全违规行为，因此他们想雇用最好的网络攻击人员。这是您目前的处境……

如果您选择接受任务，任务是找到所有外部和内部漏洞，使用最新漏洞和组合漏洞开展攻击，来确定防御团队是否能够检测到或阻止攻击行为。

您需要采用什么类型的战术、技术和工具呢？在这次行动中，您需要进行大量的侦察和探测，寻找外部基础设施中的弱点，采用社会工程方法欺骗雇员，进行权限提升，获取内部网络信息，在整个网络中横向移动，并最终进入KITT-3n系统和数据库。

### 渗透测试团队与红队

在深入了解红队背后的技术理念之前，我需要说明渗透测试和红队的定义。这两个术语经常会被提起，读者通常摸不到头脑。在本书中，我想谈谈如何界定这两个术语。

渗透测试是对网络、应用程序和硬件等进行更严格和更有计划的测试。如果您还没有接触过渗透测试，建议您先阅读渗透测试执行标准—这是如何评估一项渗透测试的指南。简而言之，您需要开展范围界定、信息搜集、漏洞分析、漏洞利用、漏洞后利用和报告等所有步骤。在传统的网络测试中，我们通常会扫描漏洞，查找并攻击存在漏洞的系统或应用程序，可能会进行一些后期漏洞利用，查找域管理员并编写渗透测试报告。这些类型的测试会创建漏洞列表、找出急需修补的安全问题以及提供具有可操作性的建议。即使在创建测试范围期间，渗透测试也非常明确，仅限于一周或两周的评估期，并且通常会向公司的内部安全团队公布。公司仍然需要渗透测试人员作为其安全软件开发生命周期（S-SDLC）的一部分。

如今，即使公司有漏洞管理流程、安全软件开发生命周期流程、渗透测试人员、应急响应团队/流程以及许多非常昂贵的安全工具，公司的网络仍然可能被攻陷。如果看一下最近的攻击事件，我们会发现其中很多都发生在成熟的大公司。我们在其他安全报告中看到，一些攻击行为可能会持续超过6个月才能被发现。还有一些报道指出，2017年几乎有三分之一的公司遭到攻击。我认为公司应该想一想，如果这些“坏小子”针对自己采用完全相同的策略，能否发现它？需要多长时间才能发现？能否从攻击事件中恢复？能否准确找出攻击者对于公司资产做了什么？

这就是红队开始发挥作用的场景。红队的任务是模仿攻击者的战术、技术和工具（TTP）。目的是为公司提供真实的攻击场景，在应急响应计划中找到问题，了解员工的技能差距，并最终提高公司的安全防护能力。

对于红队来说，它不像渗透测试那样条理清晰。红队模拟的是真实的攻击场景，因此每项攻击测试都会有很大不同。有些任务可能专注于获取个人身份信息（PII）或信用卡信息，而其他任务则可能专注于获取域管理员权限。说到域管理员，我发现渗透测试和红队任务之间存在巨大的差异。对于渗透测试，我们力争在一天内得到域管理员账户，从而具有访问域控制器权限。对于红队任务，我们可能会完全忽略域控制器。其中一个原因是许多公司在域控制器周围设置了大量安全保护措施。

这些安全防护措施包括应用程序白名单、完整性监控、大量IDS/IPS/HIPS规则等。由于执行任务要避免被发现，因此红队需要保持低调。我们需要遵循的另一条规则是，不要在内部网络运行漏洞扫描程序。攻击者在已控制网络环境中开始执行完整的漏洞扫描的情况是非常罕见的，因为漏洞扫描在网络上非常容易被发现，并且很可能被即时捕获。

两者另一个主要区别是如下所示的时间表。对于渗透测试，工作时间通常是一周，幸运的话，工作时间可能达到两周的时间。但是对于红队来说，任务通常持续2周～6个月的时间。红队方式模拟真实攻击流程，需要开展社会工程，确定目标位置等。最大的差异是两种类型团队的输出报告。红队的研究报告需要更多地针对防御团队流程、策略、工具和技能方面的差距，而不是漏洞列表。在红队的最终报告中，可能会展示一些在任务中发现的漏洞，但是更多的内容是安全流程中存在的缺陷。注意，红队的输出报告应该主要针对安全流程，而不是针对IT（信息技术）部门未修补的漏洞。

| 渗透测试 | 红队 |
| --- | --- |
| **有条不紊的安全评估**<br>● 前期交流<br>● 情报搜集<br>● 漏洞分析<br>● 漏洞利用<br>● 漏洞后利用<br>● 报告 | **灵活的安全评估**<br>● 情报搜集<br>● 初步立足点<br>● 持久性/本地权限提升<br>● 本地主机/网络枚举<br>● 横向移动<br>● 数据分析/数据获取<br>● 获取域权限/获取系统散列<br>● 报告 |
| **范围**<br>● 限制范围<br>● 1～2周参与<br>● 一般公告<br>● 发现漏洞 | **范围**<br>● 没有规则*<br>● 1周～6个月的参与时间<br>● 没有公告<br>● 检验防御团队的流程、策略、工具和技能 |
| *不能违法…… |

作为红队，我们需要向公司展示自身价值。价值与发现漏洞的总数或发现漏洞的危害程度无关，与防御方安全防护机制是否发挥作用有关。红队的目标是模拟现实世界的攻击行为（实际检测到）。衡量行动的两个重要指标是检测时间和缓解时间。这两个指标不是新概念，但对红队来说仍然有重要的意义。

**检测时间（TTD）** 表示什么呢？这是攻击事件从开始到安全分析人员检测到攻击行为并开始采取措施之间的时间。假设您使用社会工程电子邮件攻击方式，用户在其系统上执行恶意软件。即使杀毒软件、主机安全系统或者监控工具可能检测到攻击行为，但是记录的检测时间是安全分析人员检测到攻击行为并创建分析攻击事件的时间。

**缓解时间（TTM）** 是记录的第二个指标。这个时间点是指安全人员开展防火墙实时拦截、DNS黑洞或网络隔离的时间。另外重要的衡量指标是安全团队如何与IT人员合作、如何处理关键事件，以及员工是否恐慌。掌握了所有这些数据，我们可以建立实际数据，评估您的公司面临的风险程度，或者被攻陷的可能性。

### 总结

我最想表达的是公司管理者不要过于依赖审计指标。每个公司都有合理的规章制度，能够帮助公司流程更加成熟，但是这并不能使公司真正做到信息安全。作为红方团队，任务是测试整体安全流程是否有效。

在您阅读本书时，希望您将自己看作红队并专注于以下几个方面：

- 安全漏洞而非IT漏洞。
- 模拟真实世界攻击行为。
- 始终以红队的姿态开展攻击。
- 挑战系统……提供真实数据以证明存在安全漏洞。

### 资源与支持

本书由异步社区出品，社区（https://www.epubit.com/）为您提供相关资源和后续服务。

#### 配套资源

本书提供如下资源：
- 本书配套资源请到异步社区本书购买页下载。

要获得以上配套资源，请在异步社区本书页面中单击，跳转到下载界面，按提示进行操作即可。注意：为保证购书读者的权益，该操作会给出相关提示，要求输入提取码进行验证。

#### 提交勘误

作者和编辑尽最大努力来确保书中内容的准确性，但难免会存在疏漏。欢迎您将发现的问题反馈给我们，帮助我们提升图书的质量。

当您发现错误时，请登录异步社区，按书名搜索，进入本书页面，单击“提交勘误”，输入勘误信息，单击“提交”按钮即可。本书的作者和编辑会对您提交的勘误进行审核，确认并接受后，您将获赠异步社区的100积分。积分可用于在异步社区兑换优惠券、样书或奖品。

#### 与我们联系

如有任何问题或建议，请随时与我们联系。