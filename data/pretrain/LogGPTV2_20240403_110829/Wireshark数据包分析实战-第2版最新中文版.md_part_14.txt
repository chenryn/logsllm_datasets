一个路由器，所以这个数据包不会到达目的地。这对我们来说是个好事，因为
了10，也就意味着这个数据包会在它遇到的第一个路由器处被丢掉。因为目标
个数据包的IP头时，你可以注意到一个奇怪的数字。这个数据包的TTL被设为
请求O，并且ICMP中的每一部分都与echo请求数据包相同。但是当你展开这
Protoco1,5rc:192.168.100.138(192.168.100.138),Dst:4.2,2.1（4.2.2.1）
到的echo请求（如图6-34所示）很类似。
举例来说，文件icmptraceroute.pcap中的第一个数据包，和我们在上一节中看
么确定数据包从一个目的地到另一个的实际路径对于通信检修十分重要。
的网络中，数据包可能会经过数十个路由器才会到达最终目的地。这就是为什
第二个数据包正如所期望的那样，
offset:0
ICMP
乍看起来，这个数据包就是一个从192.168.100.138到4.2.2.10的简单echo
通过使用ICMP（在IP的一些帮助下），路由跟踪可以画出数据包的路径。
92
88
(0x01)
图6-34一个TIL值为1的ICMPccho请求数据包
88
88
二
(192.168.100.138)
88
，是前往目的地路径上第一个路由器发回
第6章通用底层网络协议123
---
## Page 141
Ethernet Il:Src
Flags:
Identification:0x491a (18714)
version:4
124
checksum:oxbaff [correct]
超时，所以目的不可达。
Wireshark数据包分析实战（第2版）
D
Ox0O
192.168.100.1(192.168.100.1)
contro)
候非常有用。
4.2.2.1
56
目的地的路由图，如图6-36所示。
255
services FieTd:Oxco （oscP 0x30:class 5eTecton 6:ECN:0x00)
35:00
OXOS00
Mes
Src:192.168.100.138(192.168.100.138),D5t:4.2.2.1(4.2.2.1)
Protocol
[validation disabTed]
图6-35未自路径上第一个路由器的ICMP响应
046
20
8
puured)
88
Dst:
Compalco_b8:59:b1 (00:16:d4:b8:59:b1)
SD
---
## Page 142
注
AdminstratonCWindowessystem3Zcmdi.cke
C:<>tracort 4.2.2.1
ace conplete.
WND
的工作至关重要。在下一章中，我们将会学习一些常用的应用层协议。
议。IP、TCP、UDP和ICMP是所有网络通信的基础，并且对于你每天要进行
我们会更频繁地使用ICMP。
的跟踪
ICMP.Linux上的路由跟踪更复杂一些，并使用了其他的协议来进行路由路径
17m
这一章主要向你介绍了数据包分析过程中会经常看到的最重要的几种协
你会在整本书中看到ICMP有着不同的功能。在我们分析更多场景的时候，
我们这里所讨论的路由跟踪主要是基于Windows，因为只有它在使用
18ns
18
图6-36路由跟踪功能的样例输出
unsc-pri.sys.gtei.net [4.2.2.1]
inet-40et.net [65.143812.153]
第6章通用底层网络协议125
可回
---
## Page 143
7.1动态主机配置协议DHCP
在网络发展的早些时候，
7层）：DHCP、DNS和HTTP。
常见高层网络协议
在Wireshark中查看它们。我们将介绍3个最常见的高层协议（第
在这一章中，我们将继续介绍一些协议的功能，以及如何
第
当一台设备想要在网络上通信，它需要被手动分
---
## Page 144
1.1
DHCP头结构
Host ConfigurationProtocol）所取代。
的地址。
DHCP数据包中出现。
DHCP是一个应用层协议，
偏移位
DHCP数据包会为客户端带来很多信息。如图7-1所示，
228+
128
品
回复
196
160
以及其他）。
操作代码（OpCode）：
操作代码
消耗时间
0~15
图7-1DHCP数据包结构
硬件类型
服务器主机地址（64字节）
客户端硬件地址（16字节）
动态主机配置协议
启动文件（128字节）
客户端IP地址
服务器IP地址
你的IP地址
网关IP地址
事务ID
选项
硬件长度
16~31
标记
跳数
一个随机数
，下列的域都会在
---
## Page 145
7.1.2
DHCP续租过程
如图7-2所示。在这里，我们将对DORA数据包的每种类型进行逐一介绍。
为客户端IP地址域的值）。
域派生）。
后的时间。
包：发现（Discover）、提供（Ofer）、请求
DHCP的续租过程通常被称为DORA过程，
个客户端和 DHCP 服务器之间进行，如文件 dhcp_nolease_renewal.pcap 中所示。
DHCP最主要的任务就是在续租过程中向客户端分配IP地址。续租过程在
“你的”IP地址（YourIP Address）：DHCP服务器提供的IP地址（最终成
客户端IP地址
标记（Flags）：
消耗时间（Seconds Elasped）：客户端第一次向DHCP服务器发出地址请求
选项（Options）：
启动文件（BootFile）：DHCP所使用的启动文件（可选）。
服务器主机名（ServerHost Name）：服务器的主机名（可选）
客户端硬件地址（ClientHardwareAddress）：客户端的MAC地址。
网关IP地址
服务器IP地址
DCHP客户
（Gateway IPAddress）：网络默认网关的IP地址。
（ServerIPAddress）：DHCP服务器的IP地址
DHCP客户端能够接受的流量类型（单播、广播以及其他）
（ClientIPAddress）：客户端的IP地址（由“你的”IP地址
图7-2DHCP的DORA过程
用来对DHCP数据包进行扩展，
最认
请求
提供
发现
（Request）和确认（Acknowledgement），
因为它使用了4种类型的DHCP数据
DCHP服务器
第7章常见高层网络协议129
以提供更多功能。
---
## Page 146
130
Wireshark数据包分析实战（第2版）
注
Enter
其传输层协议的。DHCP客户端对请求响应速度着很高要求。由于DHCP有其
的地址，所以它的第一个数据包是为了寻找正在监听的DHCP服务器。
102555255PCDT3d
数据包的PacketDetails面板的DHCP部分，查看发现过程的细节，如图7-3所示。
内置的保证可靠性的方法，也就意味着UDP是最适合的协议。你可以在第一个
clientIP
BOH
11
oware
net
中仍会将其称为数据包的DHCP部分.
Hf004400430118591f
发现数据包
.
8881
8
ent)
1P
品
7
25
iddress
wire,314 bytes
uest
8888
CO.
图7-3DHCP发现数据包
.0.
0.
8888
888
DSt:
DST
00888
---
## Page 147
20.00029512.168.011921680.10CDH
是从192.168.0.1前往192.168.0.10，如图7-4所示。客户端实际上还没有192.168.0.10
项
的IP地址）。
这些值表明这是一
能不言自明了。这个数据包的主要内容是以下4个域。
多数域要么为空（就像是IP地址域），要么根据上一节所列出的DHCP域就
888
er
营
Dpt
88888
（其他重要网络设备的IP地址）。
r1le
这个文件中的第二个数据包在IP头中列出了可用的IP地址，显示这个数据包
DHCP消息类型这里的选项是一个长度和值均为1的53类型（t-53）
这是一个请求数据包，因为在消息类型域中标识为10。发现数据包中的大
2.提供数据包
请求参数列表
所请求IP地址
客户端标识符
MAC
(t-53
88
8
医
addri
ess:
addr
192.
个DHCP发现数据包。
0.0
这里列出了客户端希望从DHCP服务器接收到的不同配置
这里提供了客户端请求IP地址的额外信息。
88
168.
图7-4DHCP提供数据包
这里提供了客户端希望得到的IP地址（通常是之前用过
8887
0157
第7章常见高层网络协议131
422
---
## Page 148
个响应与我们原先的请求相对应。
务器IP地址（Next Server IPAddress）域O中的值192.168.0.1表明我们的DHCP
户端）IP地址域中的IP地址192.168.0.10就是要提供给客户端的。下一个服
服务器与默认网关共享一个IP地址。
它给出了如下信息。
以下选项和客户端的IP地址，
第二个数据包的DHCP部分，
据包作为接收确认，如图7-5所示。
子网掩码是255.255.255.0。
DHCP服务器。
列出的第一个选项指明这个数据包是一个DHCP提供。服务器所提供的
都是空的。
重新绑定时间的值是52min30s。
续租时间是30min。
DHCP服务器的标识符是192.168.0.1。
3.请求数据包
IP地址的租期是1h。
一起给出了它所能提供的额外信息。你可以看到
---
## Page 149
IP地址，并在其数据库中记录相关信息，如图7-6所示。
这个过程的最后一步就是DHCP在确认数据包中给客户端发送其所请求的
4.确认数据包
on
1342
t-59
(taSs.
Y
t=34
dd
Kidn
e33
261
166
SeFuer.
图7-6
图7-5
DHCP确认数据包
5DHCP请求数据包
0
192:168.0.1
第7章常见高层网络协议133
---
## Page 150
7.1.3
7.1.4
DHCP租约内续租
134
DHCP选项和消息类型
Wireshark数据包分析实战（第2版）
DORA过程来重新认领它的IP地址。这个过程被称为租约内续租。
已经过期的情况下。在这两种情况中，这台设备都会被视为租约过期。
到租约内续租的一个捕获样例。
过期时的DORA过程类似，可以发现在租约内续租并不需要那么做，而只是完
看到众多DHCP选项的完整列表。
这时客户端就有了一个IP地址，并且可以用它在网络上通信。
给出了所定义的8种消息类型。
在租约内续租时，发现和提供数据包就变得没有必要了。考虑到其与租约
类型号
表7-1DHCP消息类型
消息类型
ACK
拒绝
请求
提供
发现
释放
NAK
通知
客户端向服务器指明数据包的无效参数
客户端用来请求服务器所提供的参数
服务器用来给客户端发送发现数据包的响应
客户端用来定位可用的DHCP服务器
服务器向客户端发送所请求的配置参数