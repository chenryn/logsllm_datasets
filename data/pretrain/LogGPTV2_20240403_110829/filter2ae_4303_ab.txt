地址+4，蓝色的数据是0x9000，其他数据则是随机生成（之前我们提到过）。随后我们会看到如下的代码，代码首先从_pbRecvBuffer+4的位置（之前提到的第5个字节）读取数据和0x30h比较，如果相等的话就跳转到800e2a4处执行指令（会跳过存在漏洞的代码分支）。如果不相等则向_TAG_Prov_Context+0x18位置也就是keyset_name拷贝数据，被拷贝的数据是从_pbRecvBuffer的第六个字节开始，长度是_pbRecvBuffer的长度0xb2-7（十进制171）。
由于拷贝的时候并没有检查长度的大小是否大于keyset_name数组大小（171>128），从而导致了溢出的产生。
此时，位于_pbRecvBuffer
+0x8d位置的0x080190dc（被复制的第0x88字节）正好能够覆盖_TAG_Prov_Context指针偏移0xA0的位置处的HCRYPTKEY指针（0x8d-5+0x18=0xa）。
接着Esteemaudit发送buffer2，也就是rop的数据，这段数据同样被保存在_pbRecvBuffer中，图中的红框是我们构造的rop链的第一个代码片段地址（pop
ret0c）。 
之后，MyCPAcquireContext会调用ReleaseProvider。
在ReleaseProvider中会取出TAG_Prov_Context中偏移a0位置的hkey并调用ADVAPI32!CryptDestroyKey，此时hkey已经被覆盖成了0x080190dc。
在CryptDestroyKey函数会取出hkey（也就是该函数的参数），并执行命令call dword ptr [esi+8]。
这个esi+ 8正好是rop链的第一个代码片段的地址。
### 三、Esteemaudit的利用验证
Esteemaudit利用工具针对windows 2003和windows
xp，利用成功需要被攻击机开启域和远程桌面（默认3389端口）。域(Domain)是Windows网络中独立运行的单位，基于域可进行用户身份统一认证和安全边界集中管理等。
#### （1）环境搭建(以windows 2003为例)
##### 1.域的安装和设置
###### 1.1 DC的安装
要建立和管理域需要域控制器（DC），DC上存储着域中的信息资源如名称、位置和特性描述等。通过在一台服务器上安装活动目录（AD）来实现DC，首先要给DC设置一个静态IP，然后在windows
2003的“运行”中输入dcpromo，打开Active Directory安装向导。创建一个新域，填写DNS域名和NetBIOS域名，如下所示。
之后，一路“下一步”直到“DNS注册诊断”，如下图设置
到此DC成功建立，重启系统
###### 1.2 创建域用户
打开 “开始->管理工具->Active Directory用户和计算机”在创建的域下新建一个用户“adlab-test”如下图。
###### 2.域主机成员的设置
在要加入该域的主机中先开启远程桌面，然后打开“我的电脑->属性¬->计算机名->更改”后在域中填入刚才创建的域名，确定后输入DC的管理员账号密码，在加入域前先设置自己的IP和DNS，把DNS指向DC。
加入域成功后有如下提示：
上述对应测试环境网络拓扑如下：
##### （2）Esteemaudit利用
###### 1.攻击端(以win 10为例)
受限于fuzzbunch，攻击端需安装python2.6和pywin32-py2.6，
在`“…\shadowbroker\windows\”`下执行“fb.py”进行利用框架(Fuzzbanch)初始化设置，如下：
  1. 被攻击机器ip
  2. 本机ip
  3. 日志存储路径
初始设置后使用命令“use
Esteemaudit”对插件进行设置，由于初始设置了目标和监听ip所以基本使用默认设置就可以了。需要注意的是当设置到“Listen IP
[127.0.0.1]：”时这里需要填写的是被攻击机器的IP地址。
在“Press Any Key To Continue
:”提示后，会对被攻击机器做一次扫描，得到系统版本、平台等信息（如下图所示）。需要注意的是当测试不同的系统版本、平台时需要重新运行“fb.py”扫描被攻击机器，或者使用reset命令手动更新被攻击机器信息。
然后，进行再次的确认或设置，如果想修改被攻击机器的相关信息（payload的行为方式、目标机指令构架、目标机系统版本等），可以依据工具提示输入选项号进行修改，如下所示:
最后，需要（手动）设置回连端口和（手动设置或使用默认）NSA工具库文件的绝对路径。例如：“D:\shadowbroker\windows\storage\rudo_x86.dll”，如下图所示其中rudo_x86.dll、capa_x86.dll、lipa_x86.dll分别用作远程注入、回连、监听。
再次确认攻击与被攻击双方的IP和端口（其中Destination IP [0.0.0.0] 项使用默认值不需要手动设置）。
最终需确认配置信息 
若攻击成功，会显示如下信息。
攻击成功后被攻击机器会创建新进程回连之前设置的攻击机器端口（5678），如下所示（实际测试环境请关闭防火墙）：
上述通过Esteemaudit的利用流程如下：
###### 2.对比测试
我们以被攻击机器回连成功为标志，进行对比测试受影响系统和利用成功需要的关键触发条件，结果如下
测试结论：以上环境中并未对智能卡进行特别设置，除了域环境与远程桌面其余都是系统默认设置。所以，根据上述实验结果，网上所说的“需要开启智能卡登录”容易引起歧义（此结论也呼应了漏洞分析部分关于SmartCard的全部数据都由Esteemaudit模拟实现）。因此，只要是在域中开启了远程桌面的目标就可以被攻击，与是否是域控制器（DC）无关，与是否登录了域账号无关，与加入域后域控制器（DC）是否存在无关。
###### 3.防御建议
  * 关闭远程桌面
  * 退出域环境
  * 升级操作系统版本
  * 开启防火墙，过滤不信任的链接
### 四、总结
安全源自未雨绸缪，提高安全意识，及时止损。启明星辰ADLab会持续关注并研究由此次“永恒之蓝”以及影子经纪人陆续泄露的工具引发的“余震”，最后附上影子经纪人活动时间轴，也许下一次“蓝”不远了。
* * *
**启明星辰积极防御实验室（ADLab）**
ADLab成立于1999年，是中国安全行业最早成立的攻防技术研究实验室之一，微软MAPP计划核心成员。截止目前，ADLab通过CVE发布Windows、Linux、Unix等操作系统安全或软件漏洞近300个，持续保持亚洲领先并确立了其在国际网络安全领域的核心地位。实验室研究方向涵盖操作系统与应用系统安全研究、移动智能终端安全研究、物联网智能设备安全研究、Web安全研究、工控系统安全研究、云安全研究。研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。
* * *