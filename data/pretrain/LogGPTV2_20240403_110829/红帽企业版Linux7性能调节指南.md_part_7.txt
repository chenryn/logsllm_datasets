项，请阅读此章节。为这些文件系统的调整推荐，请参见〈第 5.3.7 节 “为性能配置文件系统”〉。
⁠XFS
XFS 是一个可靠的、且可高度缩放的 64 位文件系统。它是红帽企业版 Linux 7 中默认文件系统。
XFS 使用基于分区的分配，具有一些分配方案，包括预先分配和延迟的分配，这两种都会减少碎片
和辅助性能。它也支持促进故障恢复的元数据日志。当挂载并激活时，能够对 XFS 进行碎片整理和
放大，红帽企业版 Linux 7 支持几种 XFS 特定的备份和还原工具程序。
自红帽企业版 Linux 7.0 GA 起，XFS 支持最大容量可达 500 TB 的文件系统，以及最大容量为
8 EB 的文件偏移量（稀疏文件）。管理 XFS 的细节，请参见《红帽企业版 Linux 7 存储管理指
南》。可在下列网站中查找
http://access.redhat.com/site/documentation/Red_Hat_Enterprise_Linux/。如有调整 XFS 的特
殊需求而需要协助，请参见〈第 5.3.7.1 节 “调整 XFS”〉。
⁠Ext4
Ext4 是 ext3 文件系统的可缩放扩展。它的默认行为对大部分工作负载是最佳的。然而，它只支持
最大容量为 50 TB的文件系统以及最大容量为 16 TB 的文件。管理 ext4 的细节，请参见《红帽企
业版 Linux 7 存储管理指南》，可在下列网站中查找
http://access.redhat.com/site/documentation/Red_Hat_Enterprise_Linux/ ，如有调整 ex4 的特
殊需求而需要协助，请参见〈第 5.3.7.2 节 “调整 ext4”〉。
⁠Btrfs（（技技术术预预览览））
28
第⁠第 5 章章 存存储储和和文文件件系系统统
Btrfs 是提供缩放性、容错和方便管理的 copy-on-write（写时复制）文件系统。它包括内置快照和
RAID 支持，通过数据和元数据校验来提供数据的完整性。它也通过数据压缩提高性能及使用空间的
效率。Btrfs 作为一种技术预览，支持最大容量可达 50 TB 的文件系统。
Btrfs 是最适合桌面存储和云存储的。最初格式化设备时，最好按照预期使用而调整 btrfs。
红帽企业版 Linux 7 提供 Brtfs 作为技术预览。技术预览特征的细节，请参见
https://access.redhat.com/site/support/offerings/techpreview/。
管理 brtfs 的细节，请参见《红帽企业版Linux 7存储管理手册》，可在下列网站中查找
http://access.redhat.com/site/documentation/Red_Hat_Enterprise_Linux/。如有调整 btrfs 的
特殊需求而需要协助，请参见〈第 5.3.7.3 节 “调整 btrfs”〉。
⁠GFS2
GFS2 是具有极高可用性附加装置的一部分，为红帽企业版 Linux 7 提供簇文件系统支持。GFS2
集群提供所有服务器一致的文件系统图像，允许服务器在一个单独共享文件系统中读取和写入。
GFS2 支持最大容量可达 250 TB 的文件系统。
管理 GFS2 的细节，请参见《红帽企业版 Linux 7 存储管理指南》。可在下列网站中查找
http://access.redhat.com/site/documentation/Red_Hat_Enterprise_Linux/。如有调整 GFS2 的
特殊需求而需要协助，请参见〈第 5.3.7.4 节 “调整 GFS2”〉。
5.1.4. 文文件件系系统统的的一一般般调调整整注注意意事事项项
此章节涵盖普遍适用于所有文件系统的调整注意事项。特定文件系统的调整推荐，请参见〈第 5.3.7 节 “为性
能配置文件系统”〉。
5.1.4.1. 格格式式时时间间注注意意事事项项
在设备格式化后，文件系统配置的部分决定不能改变。此章节包含格式化存储设备前必须要做的决定的可用选
项。
大⁠大小小
按照工作负载创建合理大小的文件系统。按相应比例，较小的文件系统的备份次数也较少，且文件
系统检查所需时间和内存也更少。然而，如果您的文件系统太小，性能将因大量碎片而降低。
块⁠块大大小小
块是文件系统中工作的单位。块大小决定单个块能存储多少数据，也因而决定能够同时读写的数据
最小量。
默认块大小适用于大部分用例。然而，如果块大小（或者多个块大小）和通常同时读写的数据数量
一样大，或者略大时，文件系统将执行得更好、存储数据更加有效率。小文件仍将使用一个完整的
块。文件分布在多个块中，但这会造成额外的运行时间开销。另外，一些文件系统受限于一定数量
的块，转而限制文件系统最大尺寸。
使用 mkfs 指令格式化设备时，块大小作为文件系统选项的一部分而被指定。指定块大小的参数随
文件系统变化，文件系统的细节，请参见 mkfs 手册页。例如，查看格式化 XFS 文件系统时可用的
选项，执行下列命令：
$ man mkfs.xfs
几⁠几何何
29
红红帽帽企企业业版版 Linux 7 性性能能调调节节指指南南
文件系统几何与文件系统中数据的分布相关。如果系统使用带状存储器，例如 RAID，可在格式化设
备时，通过重新排列数据和底层存储几何的元数据提高性能。
很多数据导出的推荐几何在使用特定文件系统格式化设备时会被自动设置。如果设备没有导出这些
推荐几何，或您想要变更推荐设置，那么您在使用 mkfs 格式化设备时，需要手动指定几何 。
指定文件系统几何的参数随文件系统而变化；文件系统细节请参见 mkfs 手册页。例如，查看格式
化 ext4 系统时可用的选项，执行下列命令：
$ man mkfs.ext4
外⁠外部部日日记记
日志文件系统会在执行写操作之前，将写操作期间发生的变化记录到日志文件中。 这会降低系统发
生故障、电源故障时日志的存储设备损坏的可能性，并加速恢复过程。
元数据密集工作负载涉及日志的频繁更新。大型日志使用更多内存，但会减少写操作的频繁性。此
外，可通过将设备日志置于和主要存储一样快或者更快的专用存储上，提高带有元数据密集工作负
载的设备的寻道时间。
警警告告
确保外部日志的可靠性。失去外部日志，设备将导致文件系统损坏。
外部日志必须在格式化时便创建，并在挂载期间指定日志设备。细节请参见 mkfs 和 mount 手册
页。
$ man mkfs
$ man mount
5.1.4.2. 挂挂载载时时间间注注意意事事项项
此章节包含适用于大部分文件系统的调整决定，且可在挂载设备时指定。
⁠Barrier（（屏屏障障））
文件系统 barrier 确保文件系统元数据正确写入到永久存储并排序，使用 fsync 传输的数据在断电
下得以存留。以前红帽企业版 Linux 版本中，启用文件系统 barrier 会明显放慢严重依赖 fsync 的
应用程序，或者创建和删除很多小文件。
红帽企业版 Linux 7 中，文件系统 barrier 性能的得到的改善使禁用的文件系统 barrier 的性能影响
变得极小（小于3%）。
更多信息，请参见《红帽企业版 Linux 7 存储管理指南》，可在下列网站中查找
http://access.redhat.com/site/documentation/Red_Hat_Enterprise_Linux/。
访⁠访问问时时间间
每次读取文件，它的元数据随访问时间（atime）更新。这涉及额外的写入 I/O。在大多数情况
下，这样的开销是最小的，因为在默认设置下，前次访问时间早于上次修改时间（mtime） 或者状
态变化（ctime），红帽企业版 Linux 7 只更新 atime 字段。
然而，如果更新元数据耗时，且并不对准确访问时间做要求，您可以使用 noatime 挂载选项挂载
文件系统。读取文件时会禁用元数据的更新。它也会启用 nodiratime 行为，读取目录时，该行
30
第⁠第 5 章章 存存储储和和文文件件系系统统
为禁用元数据的更新。
预⁠预读读
预读行为通过预取可能立即需要的数据，并且将其加载到可比在磁盘上更快检索的页面缓存中加速
文件访问。预读值越高，系统预取数据越早。
红帽企业版 Linux 根据对于文件系统的检测，尝试设置一个合适的预读值。然而，检测不可能总是
准确的。例如，如果存储数组将自己作为单一 LUN 展示给系统，系统会检测单一 LUN，但不会为
数组设置合适的预读值。
涉及大量数据流的量数据流的顺序 I/O 的工作负载常常受益于高预读值。红帽企业版 Linux 7 提供
的相关存储调整配置文件提高预读值，和使用 LVM 条带化一样，但这些调整对于所有工作负载而言
并不总是足够的。
定义预写行为的参数随着文件系统而变化；请参见手册页。
$ man mount
5.1.4.3. 维维护护
定期丢弃文件系统不用的块是对于固态硬盘和精简配置存储的建议做法。有两种丢弃不使用的块的做法：
batch discard（批量丢弃）和 online discard（网络丢弃）。
⁠batch discard（（批批量量丢丢弃弃））
这种丢弃方式是 fstrim 指令的一部分。它丢弃文件系统中与管理员指定的标准相配的所有不使用
的块。
红帽企业版 Linux 7 支持 XFS 和 ext4 格式化设备上的 batch discard，这些设备支持实际丢弃操
作即（ /sys/block/devname/queue/discard_max_bytes 值不为 0 的 HDD 设备，和
/sys/block/sda/queue/discard_granularity 不为 0 的 SSD 设备）。
⁠online discard（（网网络络丢丢弃弃））
这种方式的丢弃操作在挂载时间使用 discard 选项配置，实时运行不受用户干扰。然而，online
discard 只丢弃从使用转换到空闲的块。红帽企业版 Linux 7 支持 XFS 和 ext4 格式化设备上的
online discard。
红帽推荐 batch discard，除非要求用 online discard 维持性能，或 batch discard 不可用于系统
工作负载。
预⁠预先先分分配配
预先分配将硬盘空间标记为已经将磁盘空间分配给一个文件，而未将数据写入该空间。这可用于限
制数据碎片和较差的读取性能。红帽企业版 Linux 7 支持挂载时间内 XFS、ext4、 和 GFS2 设备
上预先分配空间。对您文件系统的合适参数，请参见 mount 手册页。应用程序也可通过使用
fallocate(2) glibc 调用从预先分配空间受益。
5.2. 性性能能问问题题监监控控和和诊诊断断
红帽企业版 Linux 7 提供一些工具，这些工具有助于监控系统性能和诊断与 I/O、文件系统及其配置相关性能
问题。此章节概述可用的工具，并列举如何使用这些工具监控和诊断与 I/O 及文件系统相关的性能问题的例
子。
5.2.1. 使使用用 vmstat 监监控控系系统统性性能能
31
红红帽帽企企业业版版 Linux 7 性性能能调调节节指指南南
Vmstat 报告整个系统的进程、内存、分页、阻止 I/O、中断和 CPU 活动。它能帮助管理员决定 I/O 子系统是
否对任何性能问题负责。
下列是与 I/O 性能最相关的信息：
⁠si
切换进硬盘，或者以 KB 为单位写入交换空间。
⁠so
从硬盘中切换出，或者以 kb 为单位从交换空间读取。
⁠bi
写入块，或者以 kb 为单位阻止写操作。
⁠bo
读取块，或者以 kb 为单位阻止读操作。
⁠wa
等待 I/O 操作完成的队列部分。
交换空间和数据在同一设备上时，而且是内存使用指示器，切换进硬盘和从硬盘中切换出尤为有用。
另外，空闲、缓存和缓存列能帮助识别回写频率。缓存值突然下降和空闲值的增加表明回写和页面缓存无效。
如果使用 vmstat 的分析显示 I/O 子系统对性能下降负责，管理员可用 iostat 确定承担责任的 I/O 设备。
vmstat 由软件包 procps-ng 提供。更多使用 vmstat 的信息，请参见手册页：
$ man vmstat
5.2.2. 使使用用 iostat 监监控控 I/O 性性能能
Iostat 是由 sysstat 软件包提供的。它报告加载在您系统中的 I/O 设备。如果使用 vmstat 的分析显示 I/O
子系统对性能下降负责，您可以使用 iostat 来确定负责的 I/O 设备。
您可以使用 iostat 手册页中定义的参数，将 iostat 报告的输出集中在特定设备上。
$ man iostat
5.2.2.1. 使使用用 blktrace 详详细细说说明明 I/O 分分析析
Blktrace 提供 I/O 子系统上时间如何消耗的详细信息。配套工具 blkparse 从 blktrace 读取原始输出，并
产生人们可读的输入和输出操作摘要，该摘要由 blktrace 记录。
更多此工具的细节请参见手册页：