**作者：Heige (a.k.a. Superhei) of KnownSec 404 Team**  
**时间：2020年5月25日**  
**英文链接：**

在今年一月份发布的ZoomEye 2020版本中，我们上线了ZoomEye的历史数据查询API接口。这个历史数据接口具有很高的价值，本文将介绍我在追踪APT（高级持续性威胁）攻击时的一些案例。

在开始之前，请确保您了解如何使用ZoomEye的历史数据API接口。您可以参考官方文档或使用ZoomEye SDK进行操作。需要特别说明的是：

- **ZoomEye线上的数据采用覆盖更新模式**：如果第二次扫描未发现新数据，则不会覆盖原有数据。因此，ZoomEye会保留第一次扫描获取到的banner信息。这种机制在恶意攻击溯源方面非常有用，因为恶意攻击者通常会在被发现后立即停用下载服务器，而这些现场很可能已经被ZoomEye缓存。
- 目前，ZoomEye历史API只能通过IP地址查询，不能通过关键词匹配搜索。因此，我们需要结合ZoomEye线上缓存的数据来进行定位和分析。

## 案例一：Darkhotel APT

前几天我在“黑科技”知识星球中提到过一个关于Darkhotel APT的案例。这里需要修正一个小错误：Darkhotel使用的IE 0day漏洞应该是CVE-2019-1367，而不是CVE-2020-0674（感谢奇安信的廋肉丁指出）。不过这个小错误并不影响本文的主题。

通过ZoomEye线上数据，我们定位到了一个Darkhotel水坑攻击的IP地址。接下来，我们将使用ZoomEye SDK查询该IP的历史记录：

```bash
╭─heige@404Team ~
╰─$ python
Python 2.7.16 (default, Mar 15 2019, 21:13:51)
[GCC 4.2.1 Compatible Apple LLVM 10.0.0 (clang-1000.11.45.5)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import zoomeye
>>> zm = zoomeye.ZoomEye(username="xxxxx", password="xxxx")
>>> zm.login()
u'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpX...'
>>> data = zm.history_ip("202.x.x.x")
22
```

以下是该IP在ZoomEye历史数据中的时间节点及对应端口服务：

```python
for i in data['data']:
    print(i['timestamp'], i['portinfo']['port'])
(u'2020-01-28T10:58:02', 80)
(u'2020-01-05T18:33:17', 80)
(u'2019-11-25T05:27:58', 80)
(u'2019-11-02T16:10:40', 80)
(u'2019-10-31T11:39:02', 80)
(u'2019-10-06T05:24:44', 80)
(u'2019-08-02T09:52:27', 80)
(u'2019-07-27T19:22:11', 80)
(u'2019-05-18T10:38:59', 8181)
(u'2019-05-02T19:37:20', 8181)
(u'2019-05-01T00:48:05', 8009)
(u'2019-04-09T16:29:58', 8181)
(u'2019-03-24T20:46:31', 8181)
(u'2018-05-18T18:22:21', 137)
(u'2018-02-22T20:50:01', 8181)
(u'2017-03-13T03:11:39', 8181)
(u'2017-03-12T16:43:54', 8181)
(u'2017-02-25T09:56:28', 137)
(u'2016-11-01T00:22:30', 137)
(u'2015-12-30T22:53:17', 8181)
(u'2015-03-13T20:17:45', 8080)
(u'2015-03-13T19:33:15', 21)
```

我们进一步查看包含IE 0day漏洞利用的水坑攻击的时间节点及端口：

```python
for i in data['data']:
    if "164.js" in i['raw_data']:
        print(i['timestamp'], i['portinfo']['port'])
(u'2020-01-28T10:58:02', 80)
(u'2020-01-05T18:33:17', 80)
(u'2019-11-25T05:27:58', 80)
(u'2019-11-02T16:10:40', 80)
(u'2019-10-31T11:39:02', 80)
(u'2019-10-06T05:24:44', 80)
```

从以上数据可以看出，这次水坑攻击的时间区间大致是从2019年10月6日05:24:44到2020年1月28日10:58:02。此外，该IP显然不是攻击者购买的VPS，而是直接攻击了一个特定的网站作为“水坑”。可以确定的是，该网站早在2019年10月6日之前就已经被入侵了。根据这个水坑网站的性质，我们可以推断出Darkhotel此次攻击的主要目标是访问该网站的用户。

为了进一步分析可能的入侵点，我们列举了2019年该IP开放的端口和服务：

```python
for i in data['data']:
    if "2019" in i['timestamp']:
        print(i['timestamp'], i['portinfo']['port'], i['portinfo']['service'], i['portinfo']['product'])
(u'2019-11-25T05:27:58', 80, u'http', u'nginx')
(u'2019-11-02T16:10:40', 80, u'http', u'nginx')
(u'2019-10-31T11:39:02', 80, u'http', u'nginx')
(u'2019-10-06T05:24:44', 80, u'http', u'nginx')
(u'2019-08-02T09:52:27', 80, u'http', u'nginx')
(u'2019-07-27T19:22:11', 80, u'http', u'nginx')
(u'2019-05-18T10:38:59', 8181, u'http', u'Apache Tomcat/Coyote JSP engine')
```

通过这些信息，我们可以更好地理解攻击者的入侵路径和方法。