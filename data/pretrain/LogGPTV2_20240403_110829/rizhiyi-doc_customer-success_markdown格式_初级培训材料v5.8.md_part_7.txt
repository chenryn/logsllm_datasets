到部分资源，则仅赋予部分资源的URL访问权限即可，如今勾选搜索、仪表盘、趋势图三
个资源分组的URL访问权限。
60
日志学院
“告警插件”涉及告警可用方式，可全部勾选。
权限规划完毕后，点击“保存”即可。
4、角色赋权完毕，还需将日志来源与角色相关联。设置 à 数据（日志来源）à 编辑
tmplog，选择来源分组为tmprole，这样授权就算正式完成了。
关于更多资源授权的内容，还可以参考产品文档《日志易安全手册》2.4.1章节。
创建用户分组
1、设置 --> 权限（用户分组）--> 新建；
2、创建tmpgroup时，指定tmpgroup的拥有者和角色均为tmprole。
61
日志学院
创建用户
1、设置 --> 权限（用户管理）--> 新建；
2、创建tmp1时，填写邮箱及密码，并指定所属用户分组。
62
日志学院
用户登录
使用创建的tmp1用户名及密码登录日志易系统，测试权限。
5.4 权限管理补充说明
1、 用户分组可绑定多个角色，这只要在用户分组的地方指定用户分组所对应的角色即
可。这一般用在领导权限划分时，如领导即具备运维组的权限，也具备开发组的权
限；
2、 在实际工作场景中，用户往往会有权限划分的需求，权限可以在分析工作完成之后再
划分，但在日志接入之前就要对系统有所认知，并在日志接入时就规划好日志来源。
这样在权限划分时才不会混乱。
3、 “功能”可赋予用户一些特殊权限，一般情况下，普通用户勾选可使用离线任务、可
导入导出日志来源树状结构、可使用告警分析、可使用模式学习、可使用资源包导入
导出、可使用结算管理、可下载搜索结果即可。注意，这里的“功能”权限应给的越
少越好，后面需要时再添加即可。
4、 普通用户授权时，“URL访问”可以除资源分组、角色权限、用户分组、用户管理、
日志来源、路由配置、系统配置之外全选，“告警插件”可以全选。
更多权限相关设置可参考《日志易安全手册》第2章节。
本章习题：
某公司两个部门运维部、研发部，每个部门只能查看对应部门的资源，包括日志、仪表盘
等。但领导可以看所有资源。请创建符合要求的权限关系。
思考：
某公司有河南、河北两个分部，各分部的业务没有丝毫关联点，此时的权限应当如何设
置？
63
日志学院
六、日志采集
前面我们已经了解了如何通过本地上传进行一些简单的日志分析。更多情况下，日志是实
时、滚动生成的。
实时的日志该如何进行分析呢？我们可以使用Agent将其他服务器上的日志实时采集到日
志易系统中。
6.1 Agent 安装
日志所在的服务器不同，使用的Agent类型及版本也不相同。支持Go语言的服务器可安
装性能更高的Heka Agent，不支持Go语言的系统只能安装rizhiyi-Agent。
如果要采集的服务器是Linux系统的，我们可以安装Heka Agent实现日志数据采集。以
Linux CentOS 7为例，若日志易系统为3.0版本，则对应的heka Agent客户端安装步骤如
下：
在要采集日志的服务器上：
1、 新建Agent安装目录：
mkdir -p /opt/heka
2、 下载heka Agent安装包（默认下载最新版本，如果网站需要密码，需向日志易售后人
员申请获取安装包）：
wget http://222.128.29.229:9999/hekad/heka-3_0_0.28-linux-amd64.tar.gz
3、 解压安装包：
tar xvzf heka-3_0_0.28-linux-amd64.tar.gz -C /opt/heka --strip-components 1
4、 运行heka安装脚本：
cd /opt/heka/bin
64
日志学院
/bin/sh ./install.sh heka_addr:10001 frontend_ip:8080 rizhiyi_token collector_ip:5180
脚本运行方法说明如下：
l heka_addr：要采集日志的服务器的heka守护进程heka-daemon的监听地址。日志
易系统会定期同步个模块的配置信息，heka-daemon用来处理日志易系统发来的配置
管理相关请求。端口建议使用10001，以方便日志易集群管理（课堂练习期间，为方
便练习，可以采用其他端口安装，如10002、10003等）。可以通过制定为“”
（空）来让heka-daemon不监听及上报心跳，这样我们就不能通过日志易管理该
heka agent的配置信息了，当该heka挂掉时，从日志易系统也无法观测到，一般不
建议使用。
l frontend_ip：日志易系统frontend地址，heka-daemon会向这个地址发送心跳信息；
l rizhiyi_token：用户上报使用的token（域标识），可在日志易系统产品界面à运行à
域标识中进行查看；
l collector_ip：collector的地址，heka采集的信息要经过日志易系统的该模块发送给消
息队列。
非Centos服务器的Agent安装可查看以下材料：
1、其他采集端安装：《数据接入手册》2.4.1 Client安装部分。
6.2 Agent 数据采集
Agent安装完毕之后，我们还需要配置Agent采集项，即指定采集Agent服务器上的哪些
日志文件。开启heka-deamon之后，对应agent就会在日志易系统à设置à数据（Agent
管理）下显示出来，我们只需要在日志易系统上配置采集箱项即可。
配置Agent采集的步骤如下：
1、选取日志易系统上安装有agent的机器，点击IP进入添加日志采集页面，添加新的日
志采集项：
65
日志学院
2、选择日志采集方式。日志易可采集的共有文件、syslog、脚本、性能数据、数据库数
据、Beats、Packetbeat、S3等8种数据源。文件、目录、Syslog是3种最常用的数据采集
方式，也是我们初级学习的重点。
文件采集即采集单个日志文件，我们将以接入Linux系统的messages日志为例；
目录采集即采集一个目录下的多个日志文件，我们将以接入Nginx日志的access.log历史
日志为例；
防火墙、交换机等无法安装Agent的设备，需要在设备上配置将日志吐到日志易服务器，
然后在日志易系统上开启日志接收即可。
文件、目录、Syslog分别列举如下：
6.3 文件采集
Linux系统的messages日志采集步骤如下：
1、设置 à 数据（Agent管理）à 点击要采集的主机IP à 点击“添加” à 选择“文
件和目录”采集；
66
日志学院
2、点击“查看”，上下滑动，根据路径选择要采集的日志文件（如果知道确切的文件路
径，直接在文本框内输入也可），最后修改时间改为1天（最后修改时间即日志范围时
间，在该时间范围内的日志才会采集）；
3、点击下一步，在“选择文件路径”处预览要采集的文件（如果预览不到，说明上一步
的配置有误，可能是最后修改时间过小、日志文件路径不正确，或黑白名单配置有误，需
返回上一步调整配置。黑白名单会在目录采集时详细讲解）；
4、预览文件及路径无误后，点选日志文件，点击下一步，查看数据源及日志数据是否有
误，并配置该日志的appname及tag。
5、点击下一步，检查以上配置，无误后点击下一步，完成配置；
6、搜索验证日志接入是否成功：可使用刚刚定义的appname、tag搜索验证、也可使用
Agent所在主机的ip、hostname验证。
67
日志学院
68
日志学院
69
日志学院
6.4 目录采集
Nginx系统access.log日志包括历史access.log文件，也包括正在生成的access.log文件。
日志易Agent每隔250ms就会扫描一次要采集的文件中是否有新数据生成，这在采集实
时生成的文件时很有用，但历史日志文件不会才生新内容，为性能和实用性考虑，应在历
史文件采集完毕后关闭采集。
70
日志学院
由于实时生成的日志文件和历史日志文件的采集逻辑不同，我们应将二者分开采集。正在
生成的access.log文件可通过文件采集的方式采集，Nginx系统的历史access.log日志使用
目录采集到的方式。
Nginx系统的历史access.log日志采集步骤如下：
1、设置 à 数据（Agent管理）à 点击要采集的主机IP à 点击“添加” à 选择“文
件和目录”采集；
2、点击查看，上下滑动，根据路径选择要采集的日志文件目录（点选/var/log/nginx目
录），日志易Agent支持采集压缩后的日志文件，通过观察可知，我们要采集的历史
access.log日志名称都是access.log-yyyyMMdd.gz的形式。所以这里的文件路径白名单需
要写成access.log-\d{8}.gz（白名单处书写需要被匹配的日志文件，黑名单处过滤不想被匹
配到的日志文件。白名单为必填项，黑名单可不写，黑白名单均采用正则表达式的写法。
这里的\d表示单个数字，{8}表示匹配8次，关于正则表达式更多内容可参考第七章），最
后修改时间改为0天（0表示不限定时间范围，只要符合目录及黑白名单过滤规则的都会
被采集）；
3、点击下一步，在“选择文件路径”处预览要采集的文件（默认符合匹配规则的文件都
能预览到，如果预览不到，说明上一步的配置有误，可能是最后修改时间过小、日志文件
路径不正确，或黑白名单配置有误，需返回上一步调整配置。黑白名单会在目录采集时详
细讲解）；
4、预览文件及路径无误后，任选一日志文件，点击下一步，查看数据源及日志数据是否
有误，并配置该日志的appname及tag。
5、点击下一步，检查以上配置，无误后点击下一步，完成配置；
6、搜索验证日志接入是否成功：可使用刚刚定义的appname、tag搜索验证、也可使用
Agent所在主机的ip、hostname验证。
日志易内置了apache日志解析规则，但由于有些Nginx日志与Apache日志格式相同，此
类日志在进入到日志易系统时会被自动解析。所以，第六步搜索验证时应注意时间范围。
71
日志学院
72
日志学院
73
日志学院
思考：下面是一个搜索验证Nginx历史日志接入的小例子，你知道这个例子有什么作用
吗？你能看懂这个搜索语句的逻辑吗？
74
日志学院
6.5 Syslog 采集
防火墙、交换机等无法安装Agent的设备，需要在设备上配置将日志吐到日志易服务器，
然后在日志易系统上开启日志接收即可。
需要在装有Heka Server的主机上配置Syslog日志接收。（如果客户网络环境比较复杂，
也可以选择 Heka Agent，此时该 Heka Agent 承担数据转发作用）。
在日志易系统上配置Syslog日志接收的步骤如下：
1、 设置 à 数据（Agent管理）à 点击装有Heka Server的主机IP à 点击“添加” à
选择“Syslog”采集 à 选择“端口类型”为UDP à 监听地址为该主机IP:514；
2、 点击下一步，点击“添加新映射”为该Syslog数据源配置映射。如接入的Syslog日志
是IP地址为192.168.1.135的，型号为ASA5505_K8的思科防火墙的日志，此处的映射
就可以设为ip:192.168.1.135 appname:cisio tag:ASA5505_K8；
3、 当同时配置了多个Syslog日志源采集时，可通过IP映射区分不同IP 发来的Syslog数
据，并为其设置不同的appname及tag；
4、 检查配置后，点击下一步完成即可。
75
日志学院
76
日志学院
6.6 搜索验证
第3章节我们已经讲过通过appname和tag设置日志来源，且能通过appname或tag搜
索日志。日志入库之后，有些字段是日志易根据日志入库属性默认定义的，这些字段会帮
我们更好地定义日志范围。
了解了这些字段的基本信息，此时，我们再搜索来自新的agent的所有日志就很容易了。
如：
1、 搜索来自新Agent的搜索日志：
ip:'192.168.1.172'
2、 搜索来自新Agent的messages日志：
source:"/var/log/messages"
appname:linux tag: messages
使用以上搜索功能时，还应注意时间范围。当通过搜索能够看到接入的日志时，表示我们
前面的日志接入成功。
77
日志学院
注：当日志源暂时没有新数据产生时，业务系统可通过创建测试数据生成测试日志，Linux
系统可使用logger生成测试日志，搜索测试日志可验证数据是否成功采集。当采集的是不
太容易生成测试数据的日志时，如网络设备（极小情况下这些设备的日志不能及时生成
时），可使用清理缓存的方式使数据重新入库。“清理输入源缓存”可清理该Agent某个
采集项的缓存，“清理输出源缓存”会清理该Agent所有采集项的缓存，两种清理缓存的
方式都会造成数据重复入库，非特殊情况不要使用！
注：
更多日志采集内容可参考以下材料：