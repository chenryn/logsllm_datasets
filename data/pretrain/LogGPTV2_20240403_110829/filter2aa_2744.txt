•
研究背景
•
研究内容
•
总结
Part. 01
研究背景
2
3
探索⼀切、攻破⼀切
近年有关网络设备的安全事件
时间
事件
2014-04
思科(cisco)和瞻博(juniper)发现存在heartbleed漏洞
2014-11
卡巴斯基实验室发布报告披露黑暗能量（BlackEnergy）可
以攻击思科（cisco）路由器
2015-09
火眼（fireeye）发布了有关思科（cisco）路由器SYNful
Knock后门的报告
2015-10
安全公司volexity的Steven Adair发现了攻击思科（cisco）
web vpn的案例
2015-12
瞻博(juniper)发现漏洞： 万能密码登录设备（CVE-2015-
7755）、可解密VPN流量（CVE-2015-7756）
2016-01
@esizkur 发现飞塔防火墙（Fortigate）存在ssh未声明账户
漏洞（CVE-2016-5125）
2016-08
方程式针对防火墙攻击的工具泄露
4
探索⼀切、攻破⼀切
网络设备漏洞特点
（ASA）
2014.10-
2014.12
2015
2016.1-
2016.6
Dos
9
9
4
Bypass
1
3
1
其他
8
3
1
思科防火墙asa系统漏洞数目
思科ios系统漏洞数目
(CISCO
IOS)
2014
2015
2016.1-
2016.5
Dos
32
68
15
Bypass
2
3
0
其他
7
3
2
5
探索⼀切、攻破⼀切
研究历史
•
Attacking Network Embedded System Felix ‘FX’ Lindner 2002
•
The Holy Grail Cisco IOS Shellcode And Exploitation Techniques Michael Lynn 2005
•
Cisco IOS Shellcodes Gyan Chawdhary, Varun Uppal 2007
•
Cisco IOS - Attack & Defense. The State of the Art Felix ’FX’ Lindner 2008
•
Router Exploitation Felix ’FX’ Lindner 2009
•
Fuzzing and Debugging Cisco IOS SebasEan Muniz, Alfredo Ortega 2011
•
Killing the Myth of Cisco IOS Diversity Ang Cui, JaEn Kataria, Salvatore J. Stolfo 2011
•
Breaking Bricks and Plumbing Pipes:Cisco ASA a Super Mario Adventure Alec Stuart-
Muirk 2014
•
Cisco IOS shellcode:all-in-one George Nosenko 2015
•
Execute my packet David Barksdale,Jordan Gruskovnjak,Alex Wheeler 2016
Part. 02
研究内容
6
7
探索⼀切、攻破⼀切
研究步骤
获取
固件
固件
patch
真机
调试
固件
解包
静态
分析
模拟
网络
模拟
系统
模拟
8
探索⼀切、攻破⼀切
获取固件
•
从官网下载
•
通过网络从设备上拷贝到电脑上
•
从设备的存储模块读
•
从网上找网友的分享
8
探索⼀切、攻破⼀切
9
探索⼀切、攻破⼀切
ASA固件解包
Some
loader
vmlinuz
initrd
gzip压缩的rootfs.img
Directgbootingg fromgfloppyg isgnoglongergsupported.
10
探索⼀切、攻破⼀切
lina
•
$gcpio -idgloglevel=0>auto>=>>rdinit=/bin/sh
16
探索⼀切、攻破⼀切
设备调试命令
16
探索⼀切、攻破⼀切
设备调试命令
17
探索⼀切、攻破⼀切
CVE-2016-1287
•
CiscogASAg5500gSeriesgAdaptivegSecuritygAppliances
•
CiscogASAg5500-XgSeriesgNext-GenerationgFirewalls
•
CiscogASAgServicesgModulegforgCiscogCatalystg6500g
SeriesgSwitchesg
•
Ciscog7600gSeriesgRouters
•
CiscogASAg1000VgCloudgFirewall
•
CiscogAdaptivegSecuritygVirtualgApplianceg(ASAv)
•
CiscogFirepowerg9300gASAgSecuritygModule
•
CiscogISAg3000gIndustrialgSecuritygAppliance
18
探索⼀切、攻破⼀切
IKEv2协议
19
探索⼀切、攻破⼀切
使用Scapy构造POC
20
探索⼀切、攻破⼀切
漏洞触发
21
探索⼀切、攻破⼀切
漏洞利用
22
探索⼀切、攻破⼀切
堆块变化
溢出
合并
ikev2gdaemon
ikev2gfragmentgparse
22
探索⼀切、攻破⼀切
堆块变化
溢出
合并
ikev2gdaemon
ikev2gfragmentgparse
22
探索⼀切、攻破⼀切
堆块变化
溢出
合并
ikev2gdaemon
ikev2gfragmentgparse
23
探索⼀切、攻破⼀切
获取代码执行权
23
探索⼀切、攻破⼀切
获取代码执行权
24
探索⼀切、攻破⼀切
GetShell
25
探索⼀切、攻破⼀切
利用稳定性问题
•
IP数据包分片
•
其他进程干扰
26
探索⼀切、攻破⼀切
可能的解决办法
•
控制数据包的大小，使IP包数据不大于MTU
•
Defragment时占位的attribute尽可能的多
27
探索⼀切、攻破⼀切
网络设备利用时存在的问题
•
Arm，PowerPC，Mips架构设备的缓存一致性问题
•
依赖硬编码，需要知道具体的固件版本
•
网络环境的影响
28
探索⼀切、攻破⼀切
缓存一致性问题
28
探索⼀切、攻破⼀切
缓存一致性问题
Part. 03
总结
39
30
探索⼀切、攻破⼀切
总结
•
网络协议种类多，协议构成复杂，出现漏洞的部分往往是很“偏”的部位
•
还原漏洞触发需要一定的网络环境
•
网络设备固件版本多
•
分析不同的固件时，要重新识别功能函数
T
H
A
N
K
S