# 【技术分享】如何远程控制别人的无线鼠标：深度揭露鼠标劫持内幕
##### 译文声明
本文是翻译文章，文章来源：toshellandback.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
译者：[紫曦归来](http://bobao.360.cn/member/contribute?uid=2937531371)
预估稿费：260RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**简介**
****
无线鼠标是一种被广泛使用的输入设备，受到了许多白领人士以及在拎着笔记本在外奔波的业务员们的青睐。但研究表明，无线鼠标存在安全隐患，恶意攻击者可通过低成本的无线攻击设备通过远程控制受害者的无线鼠标并进行，这也就是俗一系列恶意操作称的“
**鼠标劫持** ”（mouseJack）。接下来，让小编带大家看看黑客究竟是如何实施鼠标劫持的。
在内部交互活动（internal engagements）中，对本地网络的名称解析请求（poisoning name resolution
requests）进行投毒污染，是一种获得初始域名密码的有效方法之一。虽然这一方法对多数客户端奏效（可以在非常短的时间内获得被攻击用户的域名管理权）。但是如果链路本地多播名称解析（
**LLMNR** ）和NETBIOS协议名称服务（ **NTB-NS**
）被安全地配置或者禁用时又该如何？还有一个问题那就是，目前已经证明Responder是一款强大并且简单易用的内网渗透神器，那么还有没有其他类似的工具或者方法呢？本研究将就此进行深入探讨。
在进行物理检测时，负责渗透测试的人员会运用多种攻击方法，其中就会使用到无线外设（wireless peripherals），这种技术也被称之为“鼠标劫持”（
**mousejacking** ）。2016年初一家美国物联网安全创业公司Bastille发布了一份披露无线鼠标漏洞的调查报告称,
多产商生产的无线鼠标和无线键盘存在安全漏洞。此后，鼠标劫持开始进入大众视野。恶意攻击者可以通过低成本的无线攻击设备远程控制受害者的无线鼠标并进行一系列恶意操作。事实上，鼠标劫持并不是不可能完成的任务，大多数无线鼠标（和少数键盘）在设备和其配对的USB加密狗之间没有使用加密通信，即使使用了加密通信也很难逃过攻击者的魔掌。
**你的鼠标存在漏洞吗？**
****
也许你会好奇哪些设备存在安全漏洞。Bastille网站上已经列出了一长串存在漏洞的设备名单。我本人对微软和罗技产品比较熟悉，下列微软的鼠标存在安全漏洞（事实上，存在漏洞的鼠标产品不只下面几个）：
[Sculpt人体工学鼠标 （Sculpt Ergonomic
Mouse）](https://www.amazon.com/gp/product/B00DUV01RS/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B00DUV01RS&linkCode=as2&tag=jrenard-20&linkId=4977184ed817063a716e0a44f7f01758)
[微软无线鼠标4000（Wireless Mobile Mouse
4000）](https://www.amazon.com/gp/product/B003PBZHPE/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B003PBZHPE&linkCode=as2&tag=jrenard-20&linkId=b7cb195a680409ed3b4819c459eda46b)
[微软无线鼠标5000（Wireless Mouse
5000）](https://www.amazon.com/gp/product/B008XB0JNG/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B008XB0JNG&linkCode=as2&tag=jrenard-20&linkId=3e22ed1de7fd1477c04743e312a452c2)
使用Unifying“优联”无线技术的罗技鼠标易遭受mousejacking攻击。但大多罗技公司生产的无线鼠标均采用了Unifying“优联”无线技术。使用这一技术的鼠标蓝牙适配器极易进行识别：
进行Mousejack攻击前，首先要购买SeeedStudio的Crazyradio PA USB的蓝牙适配器（加密狗）和天线。下图所示是一个2.4
GHz的远程无线发射器价值约30美元，部分无人机产品也使用这一型号的发射器。接下来，我们要将这个发射性进行改造，使其能够发起恶意攻击。这个新的固件将允许加密狗进行恶意运行，添加数据包嗅探（packet
sniffing）和注入功能。一旦获得Crazyradio PA套件，我们就可以在这里找到使用新固件进行设置的说明。
如果可以使用更多的设备进行测试效果会更好。在我的个人实验室里，我使用的是罗技的m510无线鼠标和微软的无线移动鼠标4000进行测试。
首选的实施攻击的软件是JackIt，这是一个由phiksun和infamy编写的python脚本。本研究在利用Bastille公司2016发布的研究报告基础上，简化了设备识别和攻击传播。使用Kali或自定义地传播，获取了脚本：
     $ git clone https://github.com/insecurityofthings/jackit.git /opt/
查看一遍README.md文件，并按照说明安装JackIt软件。安装完成后，须确保在启动工具之前插入Crazyradio
PA蓝牙适配器。如果没有做到这一步，将会导致JackIt发生错误。我们开始运行JackIt。此时，JackIt将进入搜索模式，帮助你找寻无线输入设备：
     /opt/jackit/$ ./jackit.py
你需要花费一些时间来检查JackIt的输出。
当JackIt发现范围内的无线输入设备后，会根据初始显示顺序在密码（KEY）栏中创建一个新的行。当你要针对某一设备实施攻击时，你需要参考这些数据。在地址（ADDRESS）栏中显示的是无线设备的硬件MAC地址。这一栏中的内容可以帮助你确定之前有没有见过，或者攻击过这些无线设备（JackIt不会跟踪你以前定位的设备，因此在同时使用多台设备时，你需要自行跟踪这些设备）。在JackIt捕获到足够的数据包后，类型栏（TYPE）就会显示捕获到的设备的具体品牌。值得注意的一点是，在上面这张截屏上，第二个设备（KEY
2）未被正确的识别出来。
与无线通信相关的统计（COUNT）和可见（SEEN）栏在无线设备及其蓝牙适配器之间进行检测。统计（COUNT）栏用于统计使用Crazyradio
PA软件获取到的无线设备及其蓝牙适配器之间通讯的次数；而可见（SEEN）栏显示的是设备最后一次通信距离现在的时间。没有被检测出的设备可能有以下两种原因，一是在检测时没有频繁使用，二是不在检测范围内。在第一种情况下，用户可能暂时没有使用电脑，从而导致电脑进入待机状态。
频道（CHANNELS）显示的是无线设备及其蓝牙适配器之间进行通信的频道。数据包（PACKET）栏显示的是最后捕获的通信内容。这两栏我们可以暂时忽略。
为了有效地实施攻击，JackIt软件需要了解发送给受害者的恶意鼠标操作（malicious
keystrokes）。该软件所使用的是Duckyscript脚本语言，这同样也是Hak5 USB 橡皮鸭（Rubber
Ducky）所使用的脚本语言。USB 橡皮鸭是一款按键注入工具。USB
橡皮鸭要求Duckyscript脚本语言在使用之前进行编码，但JackIt则无需这样，只需要在文本文件中发送一个“plaintext”命令即可。
以下是我推荐使用Duckyscript脚本语言进行鼠标劫持的起始点。鉴于用户可以看到正在进行的鼠标劫持，因此我会尽可能尝试简化攻击过程，但也会尽量详细地展示这一过程。延时（DELAY）的时间比使用USB橡皮鸭的脚本语言要短得多，因为我们无需等待驱动程序安装。除了降低延时（DELAY）外，尽可能地缩短实际的攻击有效载荷对达到攻击效果也大有裨益。原因有两个方面：一是较少的击键次数意味着可以在最短的时间内将字符发送给受害者（每一次击键将会在被攻击者电脑上打出字，从而引起被攻击者的注意）；二是可以减少数据在传输过程中的损失问题（无线攻击可能不稳定，可能会出现丢失字符或出现错误字符的问题）。稍后我会深入探讨这一问题。
使用上面这个脚本，JackIt将打开Windows的“运行”（run）提示，临时暂停，并发送指定的恶意有效载荷，再暂停，然后再发出命令。为了能够比较清楚明了地展示出击键注入的速度以及用户对鼠标劫持的反应情况，我向受害者设备发送了一串字符（如下图所示）：
正如你所见，即便我加快了输入字符的速度，但仍然会在用户计算机上显示一个活动窗口。用户就会注意到这一攻击行动。
注意：如果击键输入打开了一个有效的程序，例如 **powershell.exe**
，窗口将在输入结束后关闭。在这种情况下，运行提示窗口会自动弹出，并且在无法正确处理命令时突出显示文本。
**从鼠标到远程木马入侵**
****
下一步，漏洞利用——在大多数情况下，要实现这步，至少需要两台设备。一台是用于实施攻击的设备，这台设备一般须安装Crazyradio
PA蓝牙设配器以及JackIt软件。这台设备的操作者需要接近攻击目标，以获取正在使用的无线输入设备的相关信息。这台攻击设备发送的有效载荷将使受害者的计算机与第二台设备相连。这台设备是指挥与控制（C2）服务器的虚拟主机。
那么，问题来了，我们要使用哪种恶意有效载荷呢？PowerShell one-liners是一个不错的选择。Metasploit
Framework有一个专门为PowerShell one-liners建立的模块（可进行
**exploit/multi/script/web_delivery** 等操作）。
下图所示是Web_Delivery模块：
需要注意的一点是，默认的exploit目标值已经设置为 Python高级程序设计语言。使用PowerShell作为分发机制，我们就需要运行SET
TARGET
2程序。这将确保使用PowerShell下载的渗透测试平台和恶意软件所生成的有效载荷能够奏效。作为C2服务器的第二台设备上须按照SRVHOST和LHOST。其中，SRVPORT将被设置成用于托管恶意有效载荷的端口，而LPORT则被设置成有效载荷处理程序的端口。一般情况下，我们建议你尽可能使用无状态的有效载荷（例如windows/meterpreter_reverse_https等），这将有助于你成功绕过攻击目标计算机自带的防毒软件。尝试使用Web
Delivery模块将导致错误，这主要是由于有效载荷超出了窗口命令栏所规定的8192个字符命令限制（Cobalt
Strike的有效载荷可通过压缩字符数绕过这种限制）。由于存在这种限制，我们可以使用分级有效载荷：
**windows/meterpreter/reverse_https**
。最后，我们需要将URIPATH设置成一些简短的/a字符，以避免Metasploit生成一个随机的多字符串。当所有程序都设置完毕，模块将如下图所示：
让我们运行该模块生成单行PowerShell，展开攻击荷载handler：
如之前所述，使用此类攻击的优点是可以尽量缩短字符串的长度。 由Web
Delivery模块生成的字符串比我喜欢使用的大多数鼠标劫持（mousejacking）字符串略长一点：