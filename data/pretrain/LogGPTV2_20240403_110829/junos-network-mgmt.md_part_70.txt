IN THIS CHAPTER
Adaptive Sampling Overview | 858
Adaptive Sampling Overview
IN THIS SECTION
How Adaptive Sampling Works | 860
Adaptive Sampling Fallback | 860
Adaptive Sampling Limitations | 861
Adaptive sampling is the process of monitoring the overall incoming traffic rate on the network device
and providing intelligent feedback to interfaces to dynamically adapt the sampling rates on interfaces on
the basis of traffic conditions. Adaptive sampling prevents the CPU from overloading and maintains the
system at an optimum level, even when traffic patterns change on the interfaces. Whereas the sample
rate is the configured number of egress or ingress packets out of which one packet is sampled, the
adaptive sample rate is the maximum number of samples that should be generated per line card, that is,
it’s the limit given to adaptive sampling. Sample load is the amount of data (or number of packets)
moving across a network at a given point of time that is sampled. As you increase the sample rate, you
decrease the sample load and vice versa. For example, suppose the configured sample rate is 2 (meaning
1 packet out of 2 packets is sampled), and then that rate is doubled, making it 4, or only 1 packet out of
4 packets is sampled.
You configure the adaptive sample rate, which is the maximum number of samples that should be
generated per line card, at the [edit protocols sflow adaptive-sample-rate] hierarchy level.
To ensure sampling accuracy and efficiency, QFX Series devices use adaptive sFlow sampling. Adaptive
sampling monitors the overall incoming traffic rate on the device and provides feedback to the interfaces
859
to dynamically adapt their sampling rate to traffic conditions. The sFlow agent reads the statistics on the
interfaces every 5 seconds and identifies five interfaces with the highest number of samples. On a
standalone switch, when the CPU processing limit is reached, a binary backoff algorithm is implemented
to reduce the sampling load of the top five interfaces by half. The adapted sampling rate is then applied
to those top five interfaces.
Using adaptive sampling prevents overloading of the CPU and keeps the device operating at its optimum
level even when there is a change in traffic patterns on the interfaces. The reduced sampling load is used
until:
• You reboot the device.
• You configure a new sampling rate.
• The adaptive sampling fallback feature, if configured, increases the sampling load because the
number of samples generated is less than the configured threshold.
If a particular interface is not configured, the IP address of the next interface in the priority list is used as
the IP address for the agent. Once an IP address is assigned to the agent, the agent ID is not modified
until the sFlow service is restarted. At least one interface has to be configured for an IP address to be
assigned to the agent.
Considerations
On the QFX Series, limitations of sFlow traffic sampling include:
• sFlow sampling on ingress interfaces does not capture CPU-bound traffic.
• sFlow sampling on egress interfaces does not support broadcast and multicast packets.
• Egress samples do not contain modifications made to the packet in the egress pipeline.
• If a packet is discarded because of a firewall filter, the reason code for discarding the packet is not
sent to the collector.
• The out-priority field for a VLAN is always set to 0 (zero) on ingress and egress samples.
• You cannot configure sFlow monitoring on a link aggregation group (LAG), but you can configure it
individually on a LAG member interface.
• On QFX10000 Series switches, for a set of ports in a multicast group, since the actual sampling
happens in the ingress pipeline for egress packets, the minimum of the configured sFlow rate or the
most aggressive sample rate among those ports is used for sampling across all ports in that group.
• Starting from Junos OS Release 19.4 and later, on QFX10000 Series switches, if the destination port
of a sampled UDP packet is 6635 and the packet does not include a valid MPLS header, the flow
sampled packet gets corrupted or truncated. The actual packet is forwarded.
860
• On QFX10000 Series standalone switches and the QFX Series Virtual Chassis (with QFX3500 and
QFX3600 switches), egress firewall filters are not applied to sFlow sampling packets. On these
platforms, the software architecture is different from that on other QFX Series devices, and sFlow
packets are sent by the Routing Engine (not the line card on the host) and are not transiting the
switch. Egress firewall filters affect data packets that are transiting a switch but do not affect packets
sent by the Routing Engine. As a result, sFlow sampling packets are always sent to the sFlow
collector.
How Adaptive Sampling Works
Every few seconds, or cycle, the sFlow agent collects the interface statistics. From these aggregated
statistics, an average number of samples per second is calculated for the cycle. The cycle length depends
on the platform:
• Every 12 seconds for EX Series and QFX5K switches and MX Series and PTX Series routers
• Every 5 seconds for QFX Series switches other than QFX5K
If the combined sample rate of all the interfaces on an line card exceeds the adaptive sample rate, a
binary backoff algorithm is initiated, which reduces the sample load on the interfaces. Adaptive sampling
doubles the sample rate on the affected interfaces, which reduces the sampling load by half. This
process is repeated until the CPU load due to sFlow on a given line card comes down to an acceptable
level.
Which interfaces on an line card participate in adaptive sampling depends on the platform:
• For MX Series routers and EX Series switches, the sample rates on all the interfaces on the line card
are adapted.
• For PTX Series routers and QFX Series switches, only the five interfaces with the highest sample
rates on the line card are adapted.
For all platforms, the increased sampling rates remain in effect until one of the following conditions is
achieved:
• The device is rebooted.
• A new sample rate is configured.
If you have enabled the adaptive sampling fallback feature and, because of a traffic spike, the number of
samples increases to the configured sample-limit-threshold, then the adaptive sampling rate is reversed.
Adaptive Sampling Fallback
The adaptive sampling fallback feature, when configured and after adaptive sampling has taken place,
uses a binary backup algorithm to decrease the sampling rate (thus, increasing the sampling load) when
861
the number of samples generated is less than the configured sample-limit-threshold value, without
affecting normal traffic.
Starting in Junos OS Release 18.3R1, for EX Series switches, Junos OS supports the adaptive sampling
fallback feature. Starting in Junos OS Release 19.1R1, for MX Series, PTX Series, and QFX Series
devices, Junos OS supports the adaptive sampling fallback feature.
Adaptive sampling fallback is disabled by default. To enable this feature, include the fallback and adaptive-
sample-rate sample-limit-threshold options in the [edit protocols sflow adaptive-sample-rate] hierarchy level.
After adaptive sampling has taken place and the line card is underperforming—that is, the number of
samples generated in a cycle are less than the configured value for the sample-limit-threshold statement—
for five continuous cycles of adaptive sampling, the adapted rate is reversed. If the reverse adaptation
has happened and the number of samples generated in a cycle is less than half of the current adapted
rate again (and, therefore, for five continuous cycles), another reverse adaptation can happen.
Reverse adaptation does not occur if the interfaces are already at the configured rate.
Adaptive Sampling Limitations
The following are limitations of the adaptive sample feature:
• On standalone routers or standalone QFX Series switches, if you configure sFlow on multiple
interfaces and with a high sampling rate, we recommend that you specify a collector that is on the
data network instead of on the management network. Having a high volume of sFlow traffic on the
management network might interfere with other management interface traffic.
• On routers, sFlow does not support graceful restart. When a graceful restart occurs, the adaptive
sampling rate is set to the user-configured sampling rate.
• On a rate-selectable line card (which supports multiple speeds), interfaces with the highest sample
count are selected for adaptive sampling fallback. The backup algorithm selects those interfaces on
which the adaptive sampling rate is increased the maximum number of times and then decreases the
sampling rate on each of those interfaces every five seconds. However, on a single-rate line card,
only one sample rate is supported per line card, and the adaptive sampling fallback mechanism backs
up the sampling rate on all the interfaces of the line card.
862
CHAPTER 11
Packet Flow Accelerator Diagnostics Software
IN THIS CHAPTER
Packet Flow Accelerator Diagnostics Software and Other Utilities Overview | 862
Install Ethernet and PTP Scripts | 894
Install Packet Flow Accelerator Diagnostics Software | 897
Packet Flow Accelerator Diagnostics Software and Other Utilities
Overview
IN THIS SECTION
External and Internal Ports and Network Interface Card Ports | 863
Packet Flow Accelerator Diagnostics Software Tests and Scripts | 864
Ikondiag Command | 865
Basic Functionality Tests | 866
Ethernet Tests and Scripts | 869
Stress Tests | 876
PTP Tests | 876
QFX-PFA-4Q Module LED Tests | 878
Packet Flow Accelerator Diagnostics Utilities | 879
Sample Output for Packet Accelerator Diagnostics Software | 886
You can use Packet Flow Accelerator Diagnostics software to validate the integrity of the QFX-PFA-4Q
module and the QFX5100-24Q-AA switch. The Packet Flow Accelerator Diagnostics software contains
standard diagnostics, orchestration diagnostics, Precision Time Protocol (PTP) and synchronization
diagnostics, and other utilities. The Packet Flow Accelerator Diagnostics software runs in a guest virtual
863
machine (VM) on the QFX5100-24Q-AA switch and requires that you configure guest VM options in the
Junos OS CLI.
The QFX-PFA-4Q module contains four 40-Gigabit Ethernet QSFP+ interfaces, an FPGA module, and
timing input and output interfaces to support Precision Time Protocol applications. The FPGA module
contains logic that you can customize for processing compute-intensive, latency-sensitive, high-volume
transactions.
Before you can run the Packet Flow Accelerator Diagnostics software and utilities, make sure you have
performed the following tasks:
• Verify that you have installed the QFX-PFA-4Q module installed on the QFX5100-24Q-AA switch.
For more information, see Installing an Expansion Module in a QFX5100 Device
• Make sure you have Junos OS Release 14.1X53-D27 with enhanced automation installed on the
QFX5100-24Q-AA switch. For more information, see Installing Software Packages on QFX Series
Devices.
• Install the Packet Flow Accelerator Diagnostics software. For more information, see No Link Title.
External and Internal Ports and Network Interface Card Ports
Packet Flow Accelerator Diagnostics software and utilities validate the data paths between the external
and internal ports on the QFX5100-24Q-AA switch and QFX-PFA-4Q module. Figure 33 on page 863
illustrates the names of the ports on the QFX5100-24Q-AA switch and QFX-PFA-4Q module and how
they connect.
Figure 33: Ports on the QFX5100-24Q-AA switch and QFX-PFA-4Q module
864
Table 87 on page 864 provides information on the external and internal ports and NIC ports on the
QFX5100-24Q-AA switch and QFX-PFA-4Q module.
Table 87: External and Internal Ports on the QFX5100-24Q-AA Switch and the QFX-PFA-4Q Module
A-ports Interfaces xe-0/0/24 through xe-0/0/39 on the Packet Forwarding Engine (PFE) of the
QFX5100-24Q-AA switch connect to the B-ports on the FPGA module on the QFX-PFA-4Q
expansion module. A-ports require corresponding B-ports on the FPGA module. You can manage
these interfaces through the Junos OS.
B-ports Internal 10-Gigabit Ethernet ports connect to the FPGA module on the QFX-PFA-4Q module, which
then connect to the A-ports on the PFE of the QFX5100-24Q-AA switch. The naming convention
for these ports is determined by the guest VM. The guest VM controls the FPGA module.
C-ports Four, front-facing 40-Gigabit Ethernet ports on the QFX-PFA-4Q module connect to the FPGA
module running on the QFX5100-24Q-AA switch and the F-ports on the QFX5100-24Q-AA switch.
The guest VM controls the FPGA module.
D-ports Two 10-Gigabit Ethernet internal ports on the Packet Forwarding Engine of the QFX5100-24Q-AA
switch connect to the Ethernet NIC on the QFX5100-24Q-AA switch. The naming convention for
these ports is the same one used for the F-ports. You can manage these ports through the Junos OS.
F-ports Twenty four front-facing 40-Gigabit Ethernet ports on the QFX5100-24Q-AA switch. These ports
contain an “et” prefix when in 40-Gigabit Ethernet mode. If you channelize these interfaces, the
prefix is “xe.” You can manage these ports through the Junos OS.
NIC ports Internal interfaces xe-0/0/40 and xe-0/0/41 on the QFX5100-24Q-AA switch connect to the PFE
for use on the guest VM. The NIC ports perform the same functions as any other Linux OS NIC port.
The NIC ports do not work unless the QFX-PFA-4Q module is installed.
Packet Flow Accelerator Diagnostics Software Tests and Scripts
You can run Packet Flow Accelerator Diagnostics software to test the following subsystems on the QFX-
PFA-4Q module:
• FPGA
• QDR SRAM memory
• DRAM memory
• DRAM SPDs
865
• FPGA-connected PCI Express links
• FPGA-connected Ethernet data (QSFP interfaces)
• QSFP I2C I/O
• PTP I/O
Before you can run any test or script, you need to connect to the console connection of the guest VM. .
The following test sets are available:
• quick-test—Allows you to perform a basic test of all FPGA-attached functionality. These tests take
one or two minutes to complete.
• burn-in—Allows you to exercise all FPGA-attached functionality. These tests take several hours to
complete.
• individual test mode—Allows you to test a single subsystem with extra configuration options.
Ikondiag Command
To run any of the tests, issue the ikondiag command with the following arguments:
NOTE: Before you can run the tests, you need to connect to the console connection of the guest
VM.
• -t (quick-test | burn-in | )
This argument identifies the test.
• -h
This argument provides usage details for the test.
• -V
This argument provides verbose output for the tests.
For example, to run the PTP test, issue the ikondiag -t PTP command at the guest VM prompt:
ikondiag -t PTP
[2015-05-07 03:12:20][BEGIN TEST -
PTP]
866
*************************************************************************
PTP PHY interrupt:
PASS
1G Ethernet PHY packet loopback test:
PASS
PTP clock generation/check:
PASS
UART (ToD) loopback:
PASS
*************************************************************************
[2015-05-07 03:13:30][END TEST PTP RESULT
PASS]
Basic Functionality Tests
You can test basic functionality on the PCI Express interface and memory components. Table 88 on page
867 lists the names of the tests and their functions.
867
Table 88: Base Tests
Test Name Description Details Optional Test Failure Behavior
Arguments Sets
FPGABasic Tests basic Configures the FPGA and None. quick- Any failures in this
FPGA reads some simple registers test test cause the
operation. over PCI Express. and ikondiag command
burn-in to generate normal
test status and error
messages, and then
to terminate with
another error
message. You
cannot continue
testing because all
tests rely on the
functionality tested
by this one.
PCIe Verifies Repeatedly loops back -i  quick- This test reports
functionality pseudo random data number of test erroneous data
and stability of generated on the CPU to repetitions and values and offsets
bulk transfers the FPGA and then back to (default = 1 burn-in in data transfer. Any
of PCIe data. the CPU. Returned data is quick-test, failures in this test
verified on the CPU. 10,000 burn- will cause the
in) ikondiag command
to output normal
-j  size of
test status and error
individual
messages and then
transfer in
terminate with a
Mebibytes
further error. You
(default =
cannot continue
100 MiB).
further testing
because all tests
rely on functionality
tested by this test.
868
Table 88: Base Tests (Continued)
Test Name Description Details Optional Test Failure Behavior
Arguments Sets
DIMM Checks SPD Reads data from SPD None. quick- If any values are
query device on DIMM test unexpected, the
functionality modules ,reports contents, and test reports
and verifies and checks for erroneous burn-in erroneous values
that correct values and verifies: and provides
DIMMs are expected values
• DIMM part data against
installed. and ranges.
expected part data.
• SPD temperature is in
nominal operating
range.
DRAMMemory Tests data • Checks that PHYs are -i  vary quick- This test reports the
transfer number of test number of errors
initialized correctly.
functionality iterations) and during verification.
and stability of • Repeatedly does the default = 1 burn-in Number of errors
FPGA- following tasks: for quick- are specified as an
attached test, 500 for accumulated
DRAM • Writes to memory burn-in) number of errors
memory from the FPGA per byte-lane and
devices. DIMM module.
• Each pass
switches data
between: zeros,
ones, counter,
random, zeros,
random, ones,
random.
• Loops back memory
inside the FPGA
(simultaneous reads
and writes).
• Verifies memory
from the FPGA
869
Ethernet Tests and Scripts
The Ethernet tests and scripts test C-ports and traffic between A- and B-ports. The traffic between A-
and B-ports is tested by passing the data on the F-ports. For the C-ports, you need to loop back the
traffic sent on the C-ports. You can use physical copper loopback cables for this purpose. For the F-
ports, , you need to loop back the traffic sent on the F-ports. You can use copper loopback cables for
this purpose. Include the F-ports in a VLAN. You can use the python PFAD_exec.py -t 1 script as well as
the tests below. The python PFAD_exec.py -t 1 script verifies end-to-end L2 traffic on the external
QSFP ports and checks the statistics on the interfaces in Junos OS and the statistics on the interfaces in
the Packet Flow Diagnostics software VM. This test will fail if traffic loss is seen on any of the interfaces.
There is also a provision to test all the combinations of QSFP ports as well.
Table 89 on page 869 lists the names of the Ethernet tests and their functions. For information on how
to install the script, see No Link Title.
Table 89: Ethernet Tests and Scripts
Test Name Description Details Optional Test Failure Behavior
Arguments Sets
QSFPEthernet Verifies Generates, receives, and -i  varied quick- If the number of
functionality of verifies Ethernet frames number of test packets sent or
Ethernet are at line-rate through iterations and received correctly are
(QSFP) links. the FPGA module. The (default = burn-in verified as not being
contents and lengths of 1,000 for equal, this test is
packets consist of quick-test, considered a failure
pseudo-random data. 1e9 for burn- and the discrepancies
in) between these
During operation, QSFP
quantities are
connections are all
reported. This test
channelized to use 10
fails if the external
Gigabit Ethernet with all
Ethernet connections
32 Ethernet channels
are not configured for
operating in parallel in
loopback.
full-duplex mode.
870
Table 89: Ethernet Tests and Scripts (Continued)
Test Name Description Details Optional Test Failure Behavior
Arguments Sets
QSFPI2C Checks if there Performs reads of None. quick- This test fails if it
is access to the registers in the I2C test cannot detect the
four QSFP modules and verifies that and presence of a QSFP
modules the results are as burn-in module or if the
located on the expected. For this test to values it reads back
front of the pass, QSFP media must are unexpected.
QFX-PFA-4Q be inserted into all four
module. ports on the QFX-
PFA-4Q module. Any
kind of external media
can be used (for
example, DAC cables,
copper loopback,
modules, and optical
modules).