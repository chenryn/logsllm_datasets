Copyright© 2003 Avaya Inc. All rights reserved
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Stack Black Ops
Black Hat USA 2003
New Concepts for Network Manipulation 
Dan Kaminsky, CISSP
Copyright© 2003 Avaya Inc. All rights reserved
2
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
History:  
Peace through Superior Firepower
• History
– “Black Ops of TCP/IP” @ Black Hat 2002
• “We‟re not getting new networks – so if we want new capabilities, 
we need to find ways of teasing desired (if unexpected) 
functionality from established systems.”
– Paketto Keiretsu, Nov. 2002
• Scanrand – High Speed Network Auditor
• Minewt – Userspace NAT Router
• Linkcat – Simple Network Interface
• Paratrace – Parasitic TCP Traceroute
• Phentropy – Zalewskian Entropy Analysis
– Goal is to bring new tools to the table, keeping 
with the primary advantage of the defender
• The defender need not be stealthy.
Copyright© 2003 Avaya Inc. All rights reserved
3
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
How:  Regions of Analysis
• Regions of Analysis
– Intersections between layers
• Layers are never entirely independent -- what happens when 
redundant data disagrees?
– Manipulation of assumptions
• Systems necessarily assume certain things to be always true 
about their environment, because they usually are.  What happens 
when they‟re not?
– The Human Factor
• Somebody has to use all this stuff; someone needs to process an 
increasingly large amount of information.   How can this 
information be compiled into a maximally useful form?
Copyright© 2003 Avaya Inc. All rights reserved
4
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
LAYER 2:  ARP vs. IP
• Is it possible to acquire a usable IP address on a network that lacks a 
DHCP server?
– Classic approach: Sniff for broadcasted ARPs, 
find “gaps” between claimed IP addresses, 
attempt static mapping
• ARP:  Translator between MAC and IP
– If target in subnet, translate target IP, send to MAC.
– If not in subnet, translate IP of router, send to MAC of router.
– New Techniques
• Router Detection:  Router will route even if target was in subnet
• Subnet Detection:
– Router will ARP for us only if IP is in subnet range
– Subnets aren‟t randomly distributed
– Binary search across ip_dst will thus quickly show subnet boundries
– But what if all IP addresses are taken?
Copyright© 2003 Avaya Inc. All rights reserved
5
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
NAT-in-the-Middle
• Is is possible to acquire a usable IP address when all routable 
addresses are already in use?
• Yes:  Splice into existing ones
– NAT allows multiple hosts to share the same 
externally viewable IP address
– “NAT-In-The-Middle”
• ARP MITM vs. an existing IP
• Create second gateway router on L2 Subnet (using Minewt)
• Outgoing packets to second gateway MAC are NATted to IP
– Added to state table
• Incoming packets that match entries in state table are NATted 
appropriately, those that don‟t go on to original IP holder
• Also supports MAT-in-the-Middle – All hosts can share external IP
• Like NAT-DMZ w/o inline router
Copyright© 2003 Avaya Inc. All rights reserved
6
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
More ARP Tricks
• Is is possible to detect a single-port, multi-host portscan across a 
switched LAN?
• Yes:  Watch for the router to spew ARP Requests
– Blind scans don‟t know about empty IPs
– Empty IPs don‟t show up in ARP caches
– So whenever empty IPs are hit by a router, they 
elicit a broadcast ARP from the router
• Even though nobody can see everyone else being scanned, 
everybody can see the router preparing to do the scan
• Data point for the threat model
– Some routers (DSL) may flood entire subnet with 
ARPs regularly
• Small number of IPs = Why wait until a request, just send out 
ARPs every 30 seconds and actively maintain the ARP cache.
Copyright© 2003 Avaya Inc. All rights reserved
7
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Raw Network Access:  Linkcat
• Linkcat:  Standard-I/O Interface to Ethernet
– Allows very simple command line access to ethernet
• Plan 9:  Everything is a file
• Unix:  Everything is a file…or a really small tool that does 
one thing well
– Works over SSH
– New for Paketto2:  Automatic Checksums – write 
reasonably correct packets, and not only will they be 
sent, but the checksum will be automatically corrected
Copyright© 2003 Avaya Inc. All rights reserved
8
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Packet Zen #1:  Strings
# lc –l00 –tp | strings --bytes=8
FastEthernet0/6
Cisco Internetwork Operating System Software 
IOS (tm) C2900XL Software (C2900XL-H-M), Version 11.2(8)SA2, RELEASE SOFTWARE (fc1)
Copyright (c) 1986-1998 by cisco Systems, Inc.
Compiled Fri 24-Apr-98 10:51 by rheaton
cisco WS-C2924C-XLv
GET / HTTP/1.0
Host: www.doxpara.com
Accept: text/html, text/plain, text/sgml, */*;q=0.01
Accept-Encoding: gzip, compress
Accept-Language: en
User-Agent: Lynx/2.8.4rel.1 libwww-FM/2.14 SSL-MM/1.4.1 OpenSSL/0.9.6
HTTP/1.1 200 OK
Date: Mon, 07 Apr 2003 13:53:30 GMT
Server: Apache/1.3.26 (Unix) DAV/1.0.3 PHP/4.3.1
X-Powered-By: PHP/4.3.1
Connection: close
Content-Type: text/html
Copyright© 2003 Avaya Inc. All rights reserved
9
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Packet Zen #1.1:  Strings (without Linkcat)
# tcpdump –w - -s2000 | strings –-bytes=8
M-SEARCH * HTTP/1.1
Host:239.255.255.250:1900
ST:urn:schemas-upnp-org:device:InternetGatewayDevice:1
Man:"ssdp:discover"
SSH-1.99-OpenSSH_3.4p1
M!T7blnbXwG
SSH-2.0-OpenSSH_3.4p1 Debian 1:3.4p1-4
=diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1
ssh-rsa,ssh-dss
faes128-cbc,3des-cbc,blowfish-cbc,cast128-cbc,arcfour,aes192-cbc,aes256-cbc,PI:EMAIL
yourmom2
yourmom2
JlJmIhClBsr
JlJmIhClBsr
EJEDEFCACACACACACACACACACACACACA
FHEPFCELEHFCEPFFFACACACACACACABO
\MAILSLOT\BROWSE
JlJmIhClBsr
JlJmIhClBsr
g,QString,QString,QSL
Copyright© 2003 Avaya Inc. All rights reserved
10
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Packet Zen #2:  Ping over Copy and Paste
root@arachnadox:~# ping www.news.com
PING news.com (206.16.0.136): 56 data bytes
64 bytes from 206.16.0.136: icmp_seq=0 ttl=243 time=61.4 ms
root@arachnadox:~# lc -l00 -p "icmp and host www.news.com"
00 90 4c 49 00 2a 00 02 2d 4c 47 08 08 00 45 00 00 54 00 00 40 00 40 01 a0 4b \
c0 a8 0b 1d ce 10 00 88 08 00 bb 21 c5 4b 00 00 3e 59 40 ed 00 04 0d 45 08 09 \
0a 0b 0c 0d 0e 0f 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 \
24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30 31 32 33 34 35 36 37
00 02 2d 4c 47 08 00 90 4c 49 00 2a 08 00 45 00 00 54 a6 c9 a00 00 f3 01 86 81 \
ce 10 00 88 c0 a8 0b 1d 00 00 c3 21 c5 4b 00 00 3e 59 40 ed 00 04 0d 45 08 09 \
0a 0b 0c 0d 0e 0f 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 \
24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30 31 32 33 34 35 36 37
Copyright© 2003 Avaya Inc. All rights reserved
11
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Packet Zen #2:  Ping over Copy and Paste
root@arachnadox:~# lc -m00 -l00 -p "icmp and host www.news.com"
00 90 4c 49 00 2a 00 02 2d 4c 47 08 08 00 45 00 00 54 00 00 40 00 40 01 a0 4b \
c0 a8 0b 1d ce 10 00 88 08 00 bb 21 c5 4b 00 00 3e 59 40 ed 00 04 0d 45 08 09 \
0a 0b 0c 0d 0e 0f 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 \
24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30 31 32 33 34 35 36 37
00 90 4c 49 00 2a 00 02 2d 4c 47 08 08 00 45 00 00 54 00 00 40 00 40 01 a0 4b \
c0 a8 0b 1d ce 10 00 88 08 00 bb 21 c5 4b 00 00 3e 59 40 ed 00 04 0d 45 08 09 \
0a 0b 0c 0d 0e 0f 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 \
24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30 31 32 33 34 35 36 37
00 02 2d 4c 47 08 00 90 4c 49 00 2a 08 00 45 00 00 54 76 b1 00 00 f3 01 b6 99 \
ce 10 00 88 c0 a8 0b 1d 00 00 c3 21 c5 4b 00 00 3e 59 40 ed 00 04 0d 45 08 09 \
0a 0b 0c 0d 0e 0f 10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 \
24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30 31 32 33 34 35 36 37
Copyright© 2003 Avaya Inc. All rights reserved
12
Avaya - Proprietary (Restricted)   Solely for authorized persons having a need to know pursuant to Company instructions
Layer 3:  Scanrand Observations