都安装了，于是想到从这个软件下⼿
通过逆向得到代码，查看代码，看看能不能对代码进⾏修改
可以修改
我的思路是，在软件中去种⻢，诱导⼯作⼈员去安装，这部分过于敏感就简单的描述⼀下。 通过跳板 pc 机
浏览器历史记录，保存有邮件系统地址和⽤户名密码，登录邮件后在通讯录⾥⾯找到⼤量员⼯邮箱地址，接
下来构造⼀封邮件，诱导员⼯下载更新该带有后⻔的软件，等到隔天晚上 2 点查看结果，上线了不少⽤户
（由于他们的⽤户名很容易被逆向分析出⽬标单位，所以打码有点全，⼤家⻅笑了）
有 $ 的密码是我后加的，当时他们要证明能不能对电脑进⾏实际操作，所以都添加了个⽤户名，⽤户名涉及
到敏感信息所以也打码
通过对上线⽤户的分析，发现这些都是个⼈ pc，系统上⾯特别⼲净，⽽且都是以 administrator ⽤户上线，
电脑上只安装了⼀些和单位相关的软件，没有其他敏感信息，显示这都是单位统⼀配的办公电脑，虽然获取
了这么多 pc 权限但是没有我想要的东⻄，到这⾥渗透陷⼊了僵局。
脑⼦现在没啥思路了，⼩学⽼师告诉我们，当你遇到⼀道题解到⼀半的时候，发现前⾯都⻛调⾬顺，越到后
⾯越迷茫的时候，可以忘掉之前做过的，重新开始，于是乎我⼜回头去翻 ftp，⽆聊的翻了 2 个⼩时左右，
发现了⼀份备份源码，于是乎下载了下来，先看下⽬录，发现是⽤的 ThinkPHP 框架，突然想到之前收集的
信息中有⼀个 web 程序就是⽤ thinkphp 框架写的。
看了下框架的版本 3.2.3 这个版本是有官⽅未修复的注⼊漏洞，我们先找到后台登录位置
直接就拼接字符串了省的我们去全局找了注⼊了 看看 getValue ⽅法过滤了什么
满脸问号没看懂这段正则匹配的意义在那⾥，应该是想写匹配⼿机号登录的，注出数据是不可能了但可以利
⽤万能密码登录进去
利⽤ T-sql 语⾔的运算符执⾏优先级达到的注⼊效果
来到后台先找上传功能
成功的找到了上传⽂件⽩名单功能，尝试增加 php 后缀，但实际上传的时候还是不能上传 php ⽂件，还是
先看⼀下代码是怎么处理的
当遇到 php 后缀时直接跳过不过还好只进⾏了⼩写转换 可以利⽤上传 php 空格后缀⽂件绕过，虽然上传成
功了但是. htaccess 限制了访问规制所以这个点还⽆法利⽤。
继续寻找，如果可以删除. htaccess 就可以成功访问⽊⻢⽂件，成功找到⼀个删除功能。
Member_info 的上传头像缩略图地址清除，也就是说这个 Member_info 表 head_img 字段可控就可以删除
任何⽂件，先去找⽤户信息修改功能，果不其然。
⾃此成功访问删除. htaccess
该 0day 整个的利⽤链
1. 后台万能密码登录
2. 找到上传⽩名单功能添加 php 空格可上传后缀⽂件
3. 前台个⼈头像处上传⽂件
4. 利⽤前台⽤户修改功能修改⾃⼰的信息来篡改缓存头像地址
5. 在访问前台上传头像功能 会删除⽤户的缩略图
通过 0day 成功拿到了 webshell，终于撕开了⼀个⼝⼦
提权过程也很顺利，直接利⽤ ms15-051 添加⽤户得到服务器权限
抓了⼀下系统⽤户哈希，可能会暴露⽬标名称，打码。
利⽤该密码去跑了⼀遍开了 3389 的服务器，得出如下结果。
发现域控服务器也在列表中，⽴⻢登录 172.30.0.1，但是登录不上，这就奇怪了，尝试登录其他服务器，可
以成功登录，随意登录了 2 台，后⾯就不⼀⼀登录了。
我们的⽬标是域控，域控 ip 能 ping 通但是远程桌⾯连不上，扫了⼀下端⼝开放了 3389，为什么爆破能爆
破到，但是登录的时候登录不上，思考了⼀下忽略了⼀个细节，我爆破时候，是在 172.30.0.52 这台服务器
爆破的，不是在 pc 跳板机上⾯爆破的，因此猜想域控服务器只能通过 172.30.0.* 段服务器做跳板连接，因
此我随意选了⼀台服务器 172.30.0.104 成功登录了域控服务器。
拿下域控，项⽬基本结束，看似强⼤的外⽹都存在⼀个特别柔弱的内⽹，当你撕开外⽹这个强⼤的⼝⼦后，
进⼊到内⽹⾯对的将是⼀堆弱不禁⻛的系统，但是这弱不禁⻛的系统看似很容易进⼊，但是你确偏偏进不
去，只有当你突破这个意境后就能在内⽹⾏⾛⾃如。就如本⽂⼀样，想要通过外⽹访问内⽹，经过⼏番折
腾，最后通过 wifi 这个薄弱点，成功来到了内⽹，到了内⽹后得到了⼀些系统密码，似乎胜券在握的你确发
现⼜⼀道墙挡住了你的去路，这时你有 2 条路，⼀条路就是翻过这堵墙，第⼆条就是重新再找⼀条路。
本⽂就是如此，到达⽬标地点后，对⽬标周围环境进⾏侦查，经过侦查发现可以通过 WiFi 作为突破⼝成功
打通进⼊内⽹的通道，经过对员⼯的信息收集成功控制某员⼯ PC 电脑。控制 PC 后通过分析他们内部⽤的
办公软件并且种⼊后⻔，通过钓⻥等诱导⽅式，诱导员⼯更新带有后⻔的软件，成功上线⼀些安全意识较弱
的员⼯，此时发现上线的员⼯电脑并⽆我们想要的东⻄，因此毫不犹豫放弃，另寻它路。⼜在尝试了各种漏
洞⽆果后，回过头来对之前发现的漏洞仔细分析，寻找是否有遗漏的地⽅，经过耐⼼的分析和寻找，终于通
过 ftp 泄露的⽹站源码成功挖掘出可以 getshell 的漏洞，成功利⽤该漏洞获取到服务器权限。因此成功打⼊
内部核⼼系统拿到域控。
全⽂完
本⽂由 简悦 SimpRead 转码，⽤以提升阅读体验，原⽂地址