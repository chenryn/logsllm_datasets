DFH320.SDFHLOAD
(DFHSNP) 
CUSTINQ1 
DFH320.SDFHLOAD
(CUSTINQ1) 
PPT 
User & 
Password 
OK 
@ayoul3__ 
© WAVESTONE 
31 
CICS flow 
VTAM 
CUST1 
CUST1 
GMTRAN 
= CESN 
INQ1 
FCT 
FILE 
LOCATION 
LOAD 
CUSTMAS 
AYOUB.KICKS.MURACH.CUSTMAS 
0 
EXEC  CICS 
     READ FILE(CUSTMAS) 
END-EXEC 
DISK 
@ayoul3__ 
© WAVESTONE 
32 
Now that we are CICS experts 
Let’s break this **** 
@ayoul3__ 
© WAVESTONE 
33 
Jail break 
Find the right combination of keys to interrupt the normal flow 
of an App and get back to the CICS terminal 
It is the equivalent of finding the admin panel on a 
URL…except way easier 
It can be to press PF3 on the logon panel, or RESET button, 
or PF12 on some menu, etc. 
@ayoul3__ 
© WAVESTONE 
34 
1. Escaping from the CICS app 
© WAVESTONE 
35 
1. Escaping from the CICS app 
© WAVESTONE 
36 
We can enter any transaction ID..now what ? 
The ID is 4 digits….we can easily bruteforce it : 
• Mainframe_brute: 
https://github.com/sensepost/mainframe_brute 
• Nmap scripts: 
https://github.com/zedsec390/NMAP/blob/master/cics-
enum.nse 
• CICSShot: https://github.com/ayoul3/cicsshot 
@ayoul3__ 
© WAVESTONE 
37 
CESN (Login transaction) 
CEMT (Master terminal console) 
CECI  (Live interpreter debugger) 
CEDA (Online Resource Definition program) 
CEDB (Offline Resource Definition program) 
Default transactions 
@ayoul3__ 
© WAVESTONE 
38 
CEMT 
© WAVESTONE 
39 
CEMT INQUIRE 
© WAVESTONE 
40 
© WAVESTONE 
41 
© WAVESTONE 
42 
© WAVESTONE 
43 
© WAVESTONE 
44 
HLQ 
REST 
File Options 
© WAVESTONE 
45 
© WAVESTONE 
46 
© WAVESTONE 
47 
CEMT 
Get some useful information about the system: 
• List temporary storage queues 
• List DB2 connections 
• List webservices 
• Scrap userids in menus 
Uninstall programs, files, webservices, db2connections,etc. 
@ayoul3__ 
© WAVESTONE 
48 
CECI 
It executes CICS API commands…that’s it really :-) 
© WAVESTONE 
49 
Remember the CICS APIs 
© WAVESTONE 
50 
CECI 
© WAVESTONE 
51 
CECI 
© WAVESTONE 
52 
CECI 
© WAVESTONE 
53 
CECI 
© WAVESTONE 
54 
CECI 
© WAVESTONE 
55 
© WAVESTONE 
56 
This is all nice but can we 0wn the mainframe ? 
@ayoul3__ 
© WAVESTONE 
57 
CICS has a nice feature called Spool functions 
A spool is basically a normal dataset (or file) containing the 
output of a JOB (program) 
Using Spool functions we can generate a dataset and send it 
directly to JES (Job scheduler)…which will execute it ! 
CECI 
@ayoul3__ 
© WAVESTONE 
58 
The theory 
@ayoul3__ 
© WAVESTONE 
59 
The theory 
@ayoul3__ 
© WAVESTONE 
60 
The theory 
@ayoul3__ 
© WAVESTONE 
61 
© WAVESTONE 
62 
© WAVESTONE 
63 
© WAVESTONE 
64 
© WAVESTONE 
65 
Hurray ! 
@ayoul3__ 
© WAVESTONE 
66 
Let’s automate this to do some 3l33t3 stuff 
@ayoul3__ 
© WAVESTONE 
67 
A nice reverse shell 
Allocation of a dataset 
Reverse shell in REXX 
Execution of the dataset 
© WAVESTONE 
68 
© WAVESTONE 
69 
Kicker #1 
Shell payloads included in CICSPwn: 
• reverse_tso/direct_tso: shell in the TSO environment 
• reverse_unix/direct_unix: shell in the UNIX environment 
• ftp: connects to an FTP server and pushes/gets files 
• reverse_rexx/direct_rexx: execute rexx script directly in 
memory 
• Custom JCL: executes your own JCL 
@ayoul3__ 
© WAVESTONE 
70 
The JOB is executed with the userid launching CICS 
(START2) regardless of the user submitting it 
Kicker #2 
© WAVESTONE 
71 
Kicker #2 
© WAVESTONE 
72 
What if it were NODE(WASHDC) 
or NODE(REMOTESYS) 
… 
Yes execution on another mainframe :-) 
Kicker #3 
© WAVESTONE 
73 
A few problems though… 
• Spool option turned off (Spool=NO) 
• CECI not available 
@ayoul3__ 
© WAVESTONE 
74 
© WAVESTONE 
75 
Use Transient Data Queues instead 
TDQ are handles towards files not defined in CICS 
Some files are more special than others 
Spool=NO 
@ayoul3__ 
© WAVESTONE 
76 
TDQueues 
© WAVESTONE 
77 
TDQueues 
© WAVESTONE 
78 
• Spool option turned off 
(Spool=NO) 
• CECI not available 
One down 
@ayoul3__ 
© WAVESTONE 
79 
CECI not available 
© WAVESTONE 
80 
To forbid CECI for instance RACF admins define the following 
rule: 
RDEFINE TCICSTRN CECI UACC(NONE) 
CECI RACF rule 
@ayoul3__ 
© WAVESTONE 
81 
CEDA is an IBM utility to manage resources on CICS 
• map files to their real locations 
• set temporary storage files 
• define/alter resources 
CEDA to the rescue 
It is way less protected than CECI 
The idea is to copy CECI to a new transaction name always made 
available by RACF : 
Logon transaction 
Printing transaction 
Paging transaction… 
@ayoul3__ 
© WAVESTONE 
82 
CEDA to the rescue 
© WAVESTONE 
83 
If you have access to CEDA you can bypass 
any RACF rule 
Use --bypass on CICSPwn ;) 
CEDA to the rescue 
@ayoul3__ 
© WAVESTONE 
84 
vv 
CEDA to the rescue 
© WAVESTONE 
85 
CEDA to the rescue 
© WAVESTONE 
86 
• zospentest.tumblr.com 
• github.com/ayoul3 
• Ayoul3__