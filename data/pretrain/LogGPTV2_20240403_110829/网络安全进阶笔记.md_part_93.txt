for（inti=0:1
ca href=*#*anelicks*ImagaChange();*>
小知识：有时候，我们也会碰到验证码图案比较复杂的问题，其原因在于，为了对付验证码，
攻击者在自动登录软件中采用了文字识别技术，文字识别技术是指电脑自动识剧图片
中的文字，不用人的肉眼辨认，它可以被益号者用来挂号，与验证码是矛与盾的关系。
固此，我们必须不断改进才能防止这些软件的自动识别，改进的验证码加入了一些杂
点、线条，所以较以前更加难以辨认
（4）比较提交的字符和服务器端保存的该字符比较是否一致。如果一致，就继续，否则返
回提示。
以上是一个比较典型的案例，借助于验证码机制，有效地增强了网站的安全性。当然，验
证码也不是万能的。以QQ的验证码安全机制为例，它不能防止被盗，不能防止Q币转移，不
能防止好友、群被删除。但是，通过验证码，能够降低盗号者批量修改用户资料、转移Q币或
者发垃圾消息的速度。
而且，也可以不断地优化验证码机制，验证码更加智能化，使得好人更容易识别，坏人更
难识别。总之，了解验证码的实现机制，并对其不断优化，就能轻松游走于安全攻防之间。
257
---
## Page 463
网络安全进阶笔记
9.3.2实战iframe脚本攻防
iframe也称为嵌入式框架，它是一个非常普通的HTML语言标记。就像电视机的画中画效
果一样，设计者只需采用简单的网页标记，就可以达到栏目丰富化、功能多
样化、信息实时化等设计要求。但是，在日常应用中，我们经常会碰到有关iframe的安全间题。
比如，使用iframe绕过IE安全策略，远程地读取本地文件，或者构造iframeproxy直接挂马，
这都可能会带来灾难性的后果。因此，有必要了解iframe的使用技巧，提高脚本应用的安全性。
事出必有因。我们将对一个常见的irame漏洞进行分析。
下面是一个比较典型的ifame挂马过程。首先，准备一款木马，设置好相关服务后生成木
马所用的服务控制端，同时将木马上传到网站空间中，并用记事本记录下木马的网络路径。然
后，找一个能够正常浏览的新年贺卡，将其保存到指定的目录中，并用Dreamweaver等软件对
网页进行修改，上传到网站空间后查看图片等内容能否正常显示。紧接看，打开修改好的费卡，
使用iframe标记语句将生成好的攻击文件嵌入到贺卡中。这样，当测览贺卡的用户看到贺卡页
面之后，也随之运行了保存在指定位置的漏润溢出页面。由于它的长和宽都为0，观看费卡网
站的用户也不会看到溢出页面。
由此可见，iframe的文档可以是一个独立的HTML文件，也可是文本文件等各种文件格式。
因此，iframe功能就被攻击者巧妙地利用了，在一些看似正常的页面中，使用长宽为0的隐藏
框架，就可以让用户神不知鬼不觉地打开木马文件，可谓“受害匪浅”。
值得注意的是，由于用户无法了解当前浏览的网站采用了哪些iframe，至于引用的信息的
来源更是无从说起，因此一不小心就会“中招”、在日常应用中，大多数浏览器对ifame的使
用有着不同程度的限制，多数安全防护产品也禁止用户浏览iframe的内容。这样，对很多采用
iframe技术来设计网页的设计者来说，用户根本无法浏览完整的内容。所以，对于网站开发者
来说，这是一个“两难”的问题：既要显示iframe的内容，又要保证浏览的安全性。
1.基础工作：有关网页及服务器的安全维护
一般情况下，如果服务器文件包含了类似ifame的语句，这种情况有两种可能，一是用户
上传的文件已经包含有这样的语句，另一种情况是服务器存在危险组件或漏洞，对于这些问题，
如果有未感染的最新备份文件，可以直接恢复。
不过，动态的网页更新较快，很难有合适的备份。在这种情况下，推荐使用Editplus文件
编辑器的替换功能。Editplus支持正则表达式，使用合适的正则表达式匹配含有iframe木马的
语句即可批量替换为空，替换效率很高。如图9.34所示。
董我容：Gtrmueg://og
容
□区分大小写
R上下
全部警镇)
文请教量）
当文定区新有打开的文屏
图9.34替换含有iame木马的语句
558.
---
## Page 464
三
第9章举一反三学语言：以.NET为例
当然，此方法并不能从根本上解决问题，“正本清源”，一台物理服务器上通常可以提供
近百余个虚拟主机，因此还应从服务器的安全开始。
（1）关注系统及应用程序的最新漏洞和补丁.作为系统管理员，除了服务器防黑之外，还
要做好必要的补丁安装、杀毒软件安装及更新、配置合适的防火墙规则等例行工作。面且，对
于只提供Web虚拟主机的服务器来说，只要提供够用的权限即可，基本思路是将权限设置为
可以将危害减少在一个虚拟主机站点甚至一个虚拟目录里，避免一个站点出现问题导致整个服
务器都被感染。
（2）对组件进行管理，对于一些不安全的组件，使用很少或根本不用的组件，建议将其卸
载，比如，对于可以调用系统内核运行DOS基本命令的WScript.Shell和Shellapplication组件，
建议将其卸载。对于功能强大、使用较为广泛的组件，如Scripting.FileSystemObject组件（FSO
组件）有文件系统管理、文本文件读写等功能，需要对其进行合理限制。
2.在CSS中使用expression属性
对于IE5及其以后版本的测览器来说，expression的使用可谓锦上添花，很大程度上提高
了CSS的效果和代码效率。借用这个思路，在CSS中使用expression时，可以把CSS属性和
JavaScript脚本关联起来，CSS属性的值等于JavaScript表达式执行的结果，因此，要防止iframe
里的恶意文件被下载，比较合适的方法就是切断iframe的请求，也就是迅速销毁iframe对象。
按照这种思路，可以使用CSS样式表来对网页中所有的iframe对象进行过滤，把iframe
中的src属性的值换成空白页，这样加进去的iframe代码就不起作用了。因此，只要在网页的
style>之间加上以下CSS代码即可：
iframe(T:expression(this.arc='about:blank'.this.outerHrML=*):)
在上述代码中，首先将iframe里的请求地址变成空白页“aboutblank”。其中T是一个自
定义CSS属性，this代表所有将要描述外观的iframe对象，中间的逗号代表二句代码一起执行。
移除DOM节点时，可以使用outerHTML这个属性。outerHTML属性是DOM对象包含自身的
HTML代码，而innerHTML则是DOM对象（不含本身）里面所包含的HTML代码。
设置完毕，新建一个网页，插入以上的CSS代码到之间。然后，在这个页
面插入iframe代码（假设它们是被挂的木马网页），保存为noiframe.htm，打开浏览器测试一下。
为了查看实际效果，一个最简单有效的方法是打开正的缓存文件夹，先清空它，再刷新这
个页面，看看缓存文件夹里有没有这些网站文件，
3.利用正则表达式筛选iframe代码
为了安全而合理地引用iframe，可以采用抓取网页源码的技术，分析被引用页面的浏览器
输出源码，我出需要引用部分代码的共性和差异。用这样的方法，不但可以灵活地选择网页内
容，首且不用担心润觉器、安全防护软件等对董ame的限制，这里就需要使用正则表达式
(Regular Expression) 。
小知识：正则表达式，正则表达式是用来描述或者匹配一系列符合某个句法规则的字符串的单
个字符串，它实际上是一种生成字符串的字符事，能够很好地提高工作效率，正则表
达式包含一般的字符和一些特殊的字符，特殊字符可以扩展查找字符事的能力，正则
表达式查找和替换字符事的作用不可忽视，利用正则表达式，可满足页面调用、搜索
引学、新闻存档等相关需求，具有很好的可扩展性。
459
---
## Page 465
网络安全进阶笔记
利用正则表达式进行循环替换，在大量的数据替换时速度非常快，生成的代码根据设计者
需要可随意定义样式，具有很好的灵活性。对于不同的引用网页，只需定义不同的正则表达式
即可实现抵取，结果以JavaScript格式输出，对于任何格式的网页文件都可以直接调用，具有
很强的通用性。下面通过ASPNET环境的C#语言编程，利用C#所提供的WebClient类，实
现对指定网页的源码抓取，并以JavaScript的格式输出。在需要插入引用页面的地方，只需加
入相应的JavaScript脚本即可实现调用。下面给出一个具体实例。
(1）在ASP.NET环境下新建一个ASP.NETWeb应用程序项目WebCapture，在该项目下
建立Test.aspx文件。获取网页的部分源码如下：
7/引用正则表达式所需的命名空间
using System.Text.RegularExpressions;
public void GetWebCode()
//定义要引用的网页地址
string url-e*http://news.testnews.org.cn/*;
//定义用于存放输出结果的字符申
string result=:
try(
//创建一个Webclient实例
WebClient wb-new webClient(）:
7/从资源下我数据并返回字节数组
byte[] pagedata =wb.DowmloadData（eurl];
//将获得的源码进行转换
rocult-RobulidNows(Encoding.Default.GetString(pagedata));
(2）分析源码，得出正则表达式。本例中，每条新闻除链接地址、新闻标题、发表时间这
三部分外，代码完全相同。定义变量id、text、date分别表示这3部分内容。利用正则表达式
对抓取的代码进行处理的部分源代码如下：
public atring Rebulidews(string pagedata)
//定义输出字符串
String result-9*docunent,writeln(**);:
//定义正则表达式，变量id、text、date分别表示链接地址、新闻标题、发表时间
Regex re =new Regex（e*.*?)··[^>]*target=*._blank*-class=*"a2*">
（7.*?)（7,*7)*,RegexOptions.IgnoreCase)1
//定义播环变量，1<10表示最多抓取10条新闻
inti-0;
for（Matchmmre.Match（pagedata);m.Success&&i<10;m=m.NextMatch（1)
7/定文润足条件的新闻格式