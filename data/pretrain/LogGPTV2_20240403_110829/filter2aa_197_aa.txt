Modern Initial Access and Evasion Tactics
Red Teamer’s Delight
Mariusz Banach
Red Team Operator at ING Tech Poland
@mariuszbit, github/mgeeky
beacon> 
whoami
Agenda
» A Few Phishing Tricks
» Initial Access in 2022
»
Typical Vectors
»
Rise of Containerized Malware
»
The Beauty of HTML Smuggling
» Evasion In-Depth
»
Delivery
»
Exploitation
»
Installation
»
Command & Control
»
Exfiltration
Disclaimer
» Initial Access & Evasion tactics effectiveness is very Company/vendor specific
» Quite hard to maintain absolute 0% detection rate in Mature, Highly Secured Environments
» No fancy new tactics in this Talk : EC2 587/tcp Socat Redirector -> Gsuite -> Target
Phishing
INITIAL ACCESS
Initial Access
» Phish to Persist 
» instead of Phish to Access (Matt Hand @SpecterOps)
» Strive for delayed & elonged execution 
» --> dechain File Write & Exec events
» Use VBA/WSH to Drop DLL/XLL
» COM Hijacking
» DLL Side Loading / DLL Hijacking 
(%LOCALAPPDATA%\Microsoft\Teams\version.dll)
» XLL Persistence
» If dealing with CrowdStrike – drop CPL 
» Windows Script Host (WSH)
»
VBE, VBS - VBScript
»
JSE, JS – JScript
»
HTA – HTML Application
»
XSL - XML
»
WSF – Windows Script File
»
Language agnostic file format
»
Allows multiple scripts („jobs”) and combination of languages within a single file
» Mostly very-well detected
Typical Vectors - WSH
WSF
VBS
JS
XSL
Initial Access »
» Executable files
»
EXE
»
CPL – Control Panel Applet (DLL)
»
XLL – Excel Addition (DLL)
»
SCR – Screensaver (EXE)
»
BAT, COM, PS1, SH
» Very well detected
» Unless dealing with CrowdStrike
»
For some reason CPL files are excluded from scanning
»
100% Success Rate, No Joke
Typical Vectors - Executables
Initial Access »
» Clever use of shortcut files
» Still a popular threat, especially in Phishing campaigns
» lnk – Link
» Often detected
Typical Vectors - LNKs
Initial Access »
» HTML in Attachment – not so commonly detected
» Can contain HTML Smuggling payload inside (more on this later)
» Can be conveniently abused with Right-To-Left Override trick
»
„My Resume.vbs” ➔ „My Resume sbv.html”
Typical Vectors - HTMLs
Initial Access »
» COM Scriptlets
»
SCT – COM Scriptlet
»
WSC – Windows Script Component
»
INF-SCT – CSMTP accepts INF which can execute COM Scriptlets
» Used to instantiate COM objects
»
via Regsvr32
»
via GetObject
» Can be detected
WSC
SCT
Typical Vectors – COM Scriptlets
Initial Access »
» Dodgy VBA macros
»
Consider applying Defender ASR Bypasses
»
Prepend with “Enable Macro” lure message + lure-removal automation
»
Gazillion of different weaponization strategies – yet merely few effective:
»
File Dropping-based
»
DotNetToJS
»
XSL
» Documents that support Auto-Execution
»
Typical Word, Excel ones
»
pub - Publisher
»
rtf – disguised Word document
» Macro-Enabled Office still not eradicated
Typical Vectors - Maldocs
Initial Access »
» Some Office documents DO NOT support Auto-Exec
» But yet they can be instrumented to run VBA (CustomUI)
» ppt, ppsm, pptm – PowerPoint
» accde, mdb – Microsoft Access
» doc, docx – Word via Template Injection
» xls, xlsx – Excel via CustomUI Injection
» Lesser detected
Typical Vectors - Maldocs
Initial Access »
» There are other uncommon Office related vectors
that support Auto-Execution too:
» vdw, vsd, vsdm, vss, vssm, vstm, vst – Visio
» mpd, mpp, mpt, mpw, mpx – MS Project
»
Project_Open()? 
» Not detected
Typical Vectors - Maldocs
Initial Access »
Rise of 
Containerized
Malware
»
Starting with 7 Feb 2022, Microsoft 
blocks VBA macros in documents downloaded from Internet
»
Files downloaded from Internet have Mark-of-the-Web (MOTW) taint flag
»
Office documents having MOTW flag are VBA-blocked.
Containerized Malware
»
MOTW, We Evade
»
Some Container file formats DO NOT propagate MOTW flag to inner
files. – As pointed out by Outflank folks
»
ISO / IMG
»
7zip*
»
CAB
»
VHD / VHDX
»
Inner file w/o MOTW
Containerized Malware
»
PDF can contain URL pointing to malware or Attachments
»
Attachments are commonly used feature to package multiple docs into a single PDF
»
Attachment can auto-open using Javascript in PDF
»
We’ve seen Customers using PDFs with 10+ attached resources – on a daily basis
Containerized Malware
The Beauty of 
HTML Smuggling
Web Server
Super Duper Web 
Proxy
Web Browser
Endpoint
» Gets passed through the most aggressive Web Proxy policies
» Proxies, Sandboxes, Emulators, Email Scanning => BYPASSED
» Malicious file embedded in HTML in Javascript.
» MUST employ anti-sandbox/-headless, + timing evasions
HTML Smuggling – Deadly Effective
~ again, thanks Outflank!
» Plenty Ways To Skin A Cat (probably there’s a lot more) - Nightmare for detection Use Case designers
» Below list of extensions that pose actual risk:
Summing Up On File Format Vectors
1.
docm
2.
doc
3.
docx
4.
dot
5.
dotm
6.
rtf
7.
xls
8.
xlsm
9.
xlam
10.
xlsx
11.
xla
12.
xlt
13.
xltm
14.
slk
15.
chm
16.
scf
17.
url
18.
csproj
19.
pub
20.
ppa
21.
ppam
22.
pptm
23.
ppsm
24.
pot
25.
potm
26.
pps
27.
pptx
28.
vdw
29.
vsd
30.
vsdm
31.
vss
32.
vssm
33.
vstm
34.
vst
35.
library-ms
36.
settingscontent-ms
37.
mpd
38.
mpp
39.
mpt
40.
mpw
41.
mpx
42.
vbs
43.
vbe
44.
hta
45.
sct
46.
wsf
47.
wsc
48.
xsl
49.
vbe
50.
js
51.
jse
52.
html
53.
zip
54.
7z
55.
iso
56.
img
57.
cab
58.
pdf
59.
vhd
60.
vhdx
61.
exe
62.
scr
63.
cpl
64.
xll
65.
bat
66.
ps1
67.
cmd
68.
sh
69.
lnk
70.
chm
Word
Excel
Exotics
Visio
PowerPoint
MS Project
WSH, COM, HTML
Executables
Containers
Publisher
Evasion