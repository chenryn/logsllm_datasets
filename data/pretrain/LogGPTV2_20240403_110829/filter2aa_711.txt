Respond Before Incident
Building proactive APT defense capabilities (Public Version)
• Introduction
• Popular cyber attack countermeasures
• Evolution of cyber incident handling
• Traditional incident handling challenges
• Ideal CSIRT Resource Allocation
• Story of a long-term NPO victim
• Original Compromised Situation
• Attack campaigns and TTPs
• Effective Mitigation Cycle
• Proactive Defense How-to
• Situation Awareness & Visibility Building
• Proactive Internal Visibility: Threat Hunting
• External Situation Awareness: Threat Intelligence
• Intelligence-driven Proactive Defense
• Threat Hunting In-action
• Network-based & Host-based Threat Hunting
• Detecting abnormalities via Modeling
• Prioritizing with Threat Intelligence
• Intelligence-driven Threat Hunting Cycle
• Conclusion: Be Proactive
 PI:EMAIL
• Frequent Black Hat / hacker conference speaker
• Vulnerability researcher and owner of several CVE ID
• 10+ years on security product development
• 8+ years experience on cyber threat research
• Organizer of HITCON
• Digital Forensics & Incident Response background.
• Development of Threat Intel Platform and IR tools.
• Hacks in Taiwan Conference (HITCON) committee.
• Spoke at some conferences, played some CTF.
 PI:EMAIL
Introduction
Password Login
Firewall
Antivirus
Malware
Supply Chain
Email Phishing
IDS / IPS
Vulnerability / Worm
Drive-by Download
Sandbox
UTM / NGFW
EDR / UEBA
Network-exploit & Opportunistic        →
Endpoint-exploit & Targeted
• Famous system clean-up software
• Official website trojanized for 1 month
2 million user download and infected
• Only targeted user will received 
2nd stage RAT from github, wordpress
• Targets: Intel, Google, Microsoft, 
Akamai, Sony, Samsung, Vmware, HTC, 
Linksys, D-Link, Cisco
• Kaspersky: similar to APT17 base64
http://blog.talosintelligence.com/2017/09/avast-distributes-malware.html
http://blog.talosintelligence.com/2017/09/ccleaner-c2-concern.html
https://blog.avast.com/avast-threat-labs-analysis-of-ccleaner-incident
• Every vendor thinks it’s false positive
• Digitally Signed by CCleaner vendor
• Parent company is Avast antivirus
• Host-based signature delayed 1m
• 2017-08-15 CCleaner trojanized
• 2017-09-14 ClamAV add signature
• 2017-09-18 Cisco Blogged, only 10 detects
• Network-based traffic is encrypted
• RAT payload on
https://github.com , 
https://wordpress.com
• Even if you decrypts HTTPS, 
malware command is normal blog search
• Every human got sick eventually
− Nobody never get sick.
− Flu is not a big risk if you can recover fast.
− Exercise your body every day to recover faster.
• Systems eventually got compromised.
− 100% Blocking is difficult. 
− Detect early, recovery faster.
− Periodically health checks
• Hunt for unknown threats!
Digital Forensics        →
Incident Response     →  Proactive Incident Handling
Disk Forensics
Network Forensics
National CERT
Memory Forensics
Threat Hunting
Remote Forensics EDR
SIEM, SOC, MSSP
Private CSIRT
Stuxnet / APT
Orchestration
Threat Intelligence
Traditional CSIRT
Ideal Proactive CSIRT
Incoming Data
Large quantity false alarms
Alarms categorized and prioritized
Staff duty
Overwhelming work-loads
Time to research and tracking
Routine Jobs
Call-center like response
Solving incoming tickets
Discovering abnormalities
Patrolling Constituency
Event Systems
Separated Vendor-silos
Human apply settings
Automated orchestration
Playbook and self-remediation
Response System
Various tools fragile reports
Integrated reporting
Current Majority Organizations
Ideal Proactive Organizations
Story of a long-term NPO Target
• A research NPO in Taiwan
• 500~1000 PC and servers
• Most users are autonomous and difficult to regulate
• Researchers
• Professors
• IT budge: Pretty Limited, rsyslog on a few servers
• Network visibility: NAT built-in firewall
• Endpoint visibility: only one antivirus
• MIS says they
• Received FW blocking alert everyday
• Received VPN logon notification everyday (but don’t know why)
• Received Antivirus quarantine notification every few days
• Action taken
• Reinstall the system every time large number of alerts triggered
• What actually happened
• Attacker compromised director, IT manager, RD system and installed 
backdoors.
• Critical servers were controlled by attackers for a long time
• HR and ERP system: database leaked.
• AD server: Distributed malware with GPO. Credentials dumped.
• Office Scan server: Signature update was replaced with malware.
• Exchange server: Credentials leaked. Attackers were able to login OWA.
• Web server: Web app upload webshell, compromised for a long time.
• Multi-Layered defense reinforcement
• Install Email sandbox, IPS, WAF etc
• Deploy full packet recording and EDR
• Exam the effectiveness of current security solution. 
• Check all system anti-virus works?
• Write more rules on firewall
• Fusing internal and external intelligence
• Create Case management SOP
• Block C2 from previous incidents to firewall
• Applied our mitigation defense cycle 
• Helped to monitor and responds. Incidents decrease 95% in 3 months. 
Research
Prevent
Detect
Respond
• Daily compromise assessment scanning.
• Responding to attacks promptly.
• Less spear-phishing emails. 
• Attacker shifted TTP 
• target web server 
• cracking VPN 
• exchange OWA password
Proactive Defense How-to
• Visibility is surveillance camera on all corners of your constituency
• Critical Data, Users, Assets, Network, Backup Plan, Physical Location
• Situation Awareness is knowing “what happened” all the time
• Know what to know, too much information is no information.
External Situation:
Sight, cloud, 
weather, wind 
speed outside?
Internal Situation:
Navigation, radio, 
engine speed 
dashboard?
How to find-out 
Unknown-unknowns?
How to quickly learn 
Unknown-unknowns?
Proactive Defense Cycle
Intelligence Platform
Threat Hunting 
Threat Intel 
Intel Platform
Prevention
Traditional Signature
Antivirus Firewall
Detection
Internal & External
Threat Intelligence
Proactive
Threat Hunting
Behavior Analytics
Known-Known
Known-Unknown
Unknown-Unknown
Threat Hunting In-action
• Network-based Hunting
• Target: C&C channel, lateral movement, data exfiltration
• Monitor: Firewall, IPS, Proxy, NAT, Moloch, etc
• Outliers: packet with most outbound IP, longest, largest amount?
• Easy to scale-up, can search 10000 endpoint connection logs.
• Host-based Hunting
• Target: Compromised system, host, device
• Monitor: Process, File, Service, MBR, Registry, Eventlog, etc
• Outliers: Hidden process, Unique artifacts, Autorun entry, etc
• Difficult to scale-up without proper tool or hunting platform
• Application artifacts are more complicated than OS artifacts.
%Temp%\RarSFX1\1.exe looks suspicious dropper,
Is this a ransomware, banking Trojan or APT ?
> Not sure, check network side.
Any suspicious outgoing connection or DNS
from this endpoint at the timeframe of alert?
> Yes, one suspicious VPS IP found.
Get me additional logs to build activity timeline
on this endpoint using remote forensics tools?
> Yes, this host has been compromised
Is there any other host in my organization
connecting to the same IP?
> Yes, please block all of them.
• Standalone threats 
• Malware does not try hide itself or hijack other process
• File name or hash is special, only appears on a few endpoints.
• Masqueraded threats
• Hiding methods: Loaded using svchost.exe, DLL-Hijacking, etc.
• Same filename but different in-memory attributes.
• System Forensics
• EventLogs, Web logs, File system, Startup artifacts
• File-less threats: PowerShell, WMI Script, In-memory
• How many version of Office Word is in my organization?
• Which endpoint has a rarely seen Word version?
• Who has different parent process than others?
• Why is the intel driver using AES cryptography?
• GRR, Google Rapid Response
• https://github.com/google/grr
• Powerful but difficult to use
• OsQuery, Facebook Performant Endpoint Visibility
• https://osquery.io/
• Generic wmi-like system information access
• LOKI, Simple IOC Scanner
• https://github.com/Neo23x0/Loki
• Easy to use, cannot remediate or clean-up
• Packet Content-based 
• Traditional IDS/IPS: Pattern recognition
• Deep-Packet Inspection: Application-aware NG-FW
• Full Packet Retention: Moloch etc
• Expensive, slow, but comprehensive preservation (c.f. DLP).
• Metadata-based
• Netflow connections: Easy to preserve for a long while.
• Passive DNS replication: What IP does DNSName resolved to?
• Retro-Hunting: Compare with latest intelligence feeds.
• Lightweight, fast, but cannot see what data leaked.
• Who is most accessed endpoint?
• Why is there office access to non-server endpoints?
• How many IP organization did finance department access?
• Why are there endpoints connecting to China?
• Bro or Snort or Suricata, the old friends are always useful
• Write snort rule, de-facto industrial standard
• Moloch, full packet capturing, indexing, and database
• https://github.com/aol/moloch
• Extremely useful when investigating incidents
• Bro, Network Security Monitor
• https://www.bro.org/
• Powerful, has many plugins
Malware
A
Domain
A
IP
A
IP
B
WHOIS
Email
Endpoint
A
Domain
B
Malware
B
File Hash 
Path Name 
Attributes
Custom IoC
Yara Rule
Network IP
Domain
Organization
Endpoint 
User
Department
Event Log 
MBR Startup 
WMI Script
Endpoint
B
• Bring external situation awareness into your constituency
• Source: OSINT blog, commercial feeds, bring-your-own
• Matching Indicators: IP, Domain, IoC, Snort, Yara rule
• Collect artifacts: As precise as possible.
• Triage artifacts: Pre-filter and post-filter.
• Generate new indicators 
• Create Yara Rule on-the-fly
• Sweep with indicators
• Host & Network-based
• CRITS, MITRE Collaborative Research Into Threats
• https://crits.github.io/
• Powerful but complicated entity model
• Cyphon, Incident Management and Response Platform
• https://www.cyphon.io/
• YETI, Your Everyday Threat Intelligence
• https://yeti-platform.github.io/
• Powerful and easy to use
Threat Hunting
Threat Intel
Host-based activity
Network-based traffic
Central log management
Suspicious system activity
Previous security incidents
0day / CVE vulnerability
Latest attack method TTP
Adversary campaign tracking
Industrial Attack Trends
External Incident Sharing
Intelligence Platform
Proactive Defense Cycle
Conclusion
• Don’t response only when there’s incident
• When you see a bear, you run faster than other people.
• When you see Crime attack, you run faster than other victim.
• When you see APT attack, you must run faster than APT actor.
• Re-think about your strategy
• Effective Mitigation Cycle
• Intelligence-driven Proactive Defense Strategy
• Intelligence-driven Threat Hunting Cycle
Q&A
• FIRST CSIRT Framework 1.1 (FIRST)
• Security Operations Center on a Budget (AlienVault)
• Evolving to Hunt (Arbor Networks)
• Definitive Guide to Cyber Threat Intelligence (Fireeye iSIGHT)
• Threat Hunting Academy: Threat Hunting Essentials (Sqrrl Data)