title:Packet Sampling for Flow Accounting: Challenges and Limitations
author:Tanja Zseby and
Thomas Hirsch and
Benoit Claise
Packet Sampling for Flow Accounting: Challenges and 
Limitations 
Tanja Zseby1, Thomas Hirsch1, and Benoit Claise2 
1 Fraunhofer Institute FOKUS, Kaiserin-Augusta-Allee 31, 10589 Berlin, Germany 
{Tanja.Zseby,Thomas.Hirsch}@fokus.fraunhofer.de 
2 Cisco Systems, De Kleetlaan 6a b, 1831 Diegem, Belgium 
PI:EMAIL 
Abstract.  We  investigate  the  applicability  of  packet  sampling  techniques  to 
flow-based  accounting.  First  we  show  by  theoretical  considerations  how  the 
achievable  accuracy  depends  on  sampling  techniques,  parameters  and  traffic 
characteristics.  Then  we  investigate  empirically  which  accuracy  is  achieved 
with  typical  flow  characteristics  by  experiments  with  real  traffic  traces  from 
three different networks. In a third step we illustrate how to support sampling-
based  accounting  by  providing  an  accuracy  statement  together  with  the 
measured  data.  We  show  which  information  is  required  for  this  and  how  an 
accuracy assessment can be approximated from information available after the 
sampling process using information elements of the IP flow information export 
protocol (IPFIX). 
Keywords: packet sampling, accounting, IPFIX. 
1   Introduction 
Sampling  aims  at  the  reduction  of  measurement  costs  by  estimating  the  metric  of 
interest  from  a  subset  of  data.  It  is  important  that  the  extent  of  potential  estimation 
errors can be evaluated, especially if measurement results map to monetary values as 
it  is  the  case  for  accounting.  The  achievable  accuracy  usually  depends  on 
characteristics  of  the  population,  i.e.,  in  our  case  the  traffic  in  the  network.  Since 
network traffic is extremely dynamic providing an up-to-date accuracy assessment is 
not  trivial.  It  must  be  derived  from  the  limited  information  available  after  the 
sampling process. It has to be calculated per flow and updated continuously.  
Basic  packet  selection  methods  are  currently  standardized  in  the  IETF  PSAMP 
group [6]. A flow sampling scheme for accounting is introduced in [1]. Sample and 
Hold  [2],  Shared-state  Sampling    (S3)  [3],  and  the  Runs  bAsed  Traffic  Estimator 
(RATE) [4] propose packet sampling methods that bias the selection process towards 
large flows in order to reduce resource consumption for flow caching and flow record 
transfer. This makes sense for accounting because in typical flow distributions a few 
large  flows  contribute  to  the  majority  to  the  overall  traffic  volume  (e.g.  [1]). 
Nevertheless,  all  those  approaches  require  the  classification  of  packets  into  flows 
before or during the sampling process. In contrast to this we investigate the effects of 
packet  sampling  that  is  applied  before  flow  classification,  so  that  only  selected 
M. Claypool and S. Uhlig (Eds.): PAM 2008, LNCS 4979, pp. 61–71, 2008. 
© Springer-Verlag Berlin Heidelberg 2008 
62 
T. Zseby, T. Hirsch, and B. Claise 
packets need to be classified, which significantly reduces workload on routers [5]. We 
compare the achievable accuracy for basic PSAMP schemes and a stratified method 
used in Cisco NetFlow to accounting requirements. We show how the accuracy can 
be approximated from available information, using IPFIX information elements [11]. 
2   Flow Accounting Requirements 
The  accuracy  of  an  estimate  is  assessed  by  bias  and  precision.  For  accounting  we 
should only use unbiased estimates. This is the case if the expectation of the estimated 
values equals the real value. The precision is derived from the variance (or its square 
root: the standard error) of the estimate and expresses how far estimated values from 
sample runs  would spread. The  higher the  standard error the lower is the precision. 
An  accuracy  statement  can  be  presented  to  customers  by  a  confidence  interval. 
Confidence boundaries define the area in which the real value should lie and can be 
expressed  by  the  maximum  tolerable  estimation  error.  The  confidence  level  (CL) 
gives the probability that the real value lies within this range. From this we can derive 
a maximum standard error that should not be exceeded if a given accuracy is required. 
Table  1  shows  the  maximum  relative  standard  error  for  different  accuracy 
requirements for a normal distributed estimate.  
Table 1. Maximum Relative Standard Error for Different Accuracy Requirements 
Rel. StdErr 
Rel. Est. Error  CL 
99% 
0.01 (1%) 
0.003876 
95%   0.005102 
0.01 (1%) 
99%   0.019380 
0.05 (5%) 
0.05 (5%) 
95% 
0.025510 
  Rel. Est. Error  CL 
95% 
95% 
95% 
95% 
0.1 (10%) 
0.15 (15%) 
0.20 (20%) 
0.30 (30%) 
Rel. StdErr 
0.051020 
0.076531 
0.102041 
0.1531 
3   Accuracy Assessment in Theory 
We here provide a theoretical assessment of bias and precision by providing formulas 
for expectation and standard error for the sampling schemes. We also give formulas 
for sampling after classification, but our focus is on sampling before classification. It 
is the more complex case, saves classification effort and is used in NetFlow. 
Accuracy  Assessment  for  n-out-of-N  Sampling.  In  n-out-of-N  sampling  exactly  n 
elements are selected from the population, which consists of N elements [6]. If there 
is only one flow (N=Nf) in the traffic mix or we apply sampling after classification, 
the number Nf of packets per flow is known. The number nf of selected packets can be 
set per flow and is also known. 
ˆ
f
The estimate 
Sum for the number of bytes in flow f can be simply calculated from 
the  packet  sizes  xi,f  of  the  selected  packets,  by  extrapolating  with  nf  and  Nf.  The 
expected bias is zero. The standard error can be calculated by the standard formula for 
an n-out-of-N selection [9] from sampling parameters and packet size variance
σ . 
2
fx
Packet Sampling for Flow Accounting: Challenges and Limitations 
63 
Sum
ˆ
f
=
N
n
f
f
⋅∑                                                     (1) 
x
i
f
,
fn
=
1
i
StdErr
abs
⎡
⎣
Sum
ˆ
f
⎤ =
⎦
⋅
N
f
σ
fx
n
f
⋅
N
f
N
−
n
f
−
1
f
                                       (2) 
If we apply sampling before classification Nf and nf are unknown. Extrapolation must 
be done with the overall population N and sample size n. 
Sum
ˆ
f
=
N
n
fn
=
1
⋅∑                                                      (3) 
x
i
f
,
i
In contrast to the case above (where nf=n=const), here the number nf of packets from 
flow f in the sample varies for each sampling run and has to be considered as random 
variable (r.v.) itself. The estimate contains two random variables, nf and xi,f. To assess 
the  estimation  quality  we  need  to  calculate  expectation  and  variance  of  a  sum  of 
random variables, where the number of addends itself is a random variable. We model 
nf  as  a  discrete  r.v.  with  a  binomial  distribution1  B(n,  Nf/N).  We  denote  the  mean 
 and their variance 
packet size of all packet sizes in flow f in the population by 
σ . With xi,f we denote the number of bytes of the ith selected packet2. Since we 
by 2
fx
apply a random selection, the xi,f are independent identical distributed  (i.i.d.).  
μ
fx
With the assumption of the binomial distribution for nf and independency for the xi,f  
we can derive the following formulas for expectation and variance for the estimated 
sum for flow f (see appendix): 
⎡
⎣
E Sum
    (4) 
⎤ =
⎦
Sum
N
=
μ
ˆ
x
f
f
f
f
V Sum
ˆ
f
⎡
⎣
(
1
⎤ = ⋅
⎦
n
⋅
N N
f
⋅
σ μ
+
2
x
f
2
x
f
−
μ
⋅
                             (5) 
)
N
2
f
2
x
f
)
⋅
(
The expectation equals the real volume, i.e. the estimation is unbiased. The variance 
of the estimated flow volume, and with this the expected accuracy of the estimation 
σ . Sample size n and population size 
depends on the parameters n, N, Nf, 
μ
σ are flow characteristics. Nf 
N are preconfigured sampling parameters. Nf , 
denotes the number of packets in the population that belong to flow f. The packet size 
σ  depend on the packet size distribution in 
mean 
flow f.  If we take the square root of the variance we get the absolute standard error. 
 and the packet size variance 
 and 
and 
2
fx
2
fx
2
fx
μ
μ
fx
fx
fx
StdErr
abs
⎡
⎣
Sum
ˆ
f
⎤ =
⎦
(
⋅
1
n
⋅
N N
f
(
σ μ
+
2
x
f
⋅
2
x
f
)
−
μ
⋅
N
2
f
2
x
f
)
                   (6) 
A division by the flow volume provides the relative standard error (see appendix). 
1  If  f≤0.05  and  0.1>kl 
we can approximate Kl-kl≈Kl. With this we get 
]
StdErr Sum
strat
[
ˆ
=
⋅
K
2
l
L
∑
=
1
l
σ
2
,
x l
k
l
=
2
N
2
L
⋅
L
∑
=
1
l
σ
2
,
x l
=
⋅
N
1
2
L
L
=
1
l
σ
⋅∑              (9) 
2
,
x l
The accuracy depends on the number L of strata and on the packet size variances 
in the subintervals. 
σ  
2
,x l
If  the  packets  in  the  measurement  interval  belong  to  different  flows  (Nf<N),  one 
has to consider not only the distribution of packet sizes over the subintervals but also 
the  distribution  of  flow  IDs.  The  calculation  of  the  standard  error  becomes  more 
complex  because  the  variances  have  to  be  calculated  per  strata.  The  standard  error 
now  depends  on  the  per-flow  characteristics  (number  of  packets  Kf,  packet  size 
variance 
) within each subinterval.  
σ , and mean 
2
,fx
,fx
μ
l
l
StdErr Sum
[
ˆ
]
strat
f
=
(
L
∑
K
,
f l
⋅
K
⋅
(
σ μ
+
2
x
f
,
l
2
x
f
,
l
)
μ
−
)
⋅
K