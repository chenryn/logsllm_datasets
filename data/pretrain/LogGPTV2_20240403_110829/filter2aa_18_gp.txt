### 随机访问压缩文件
随机访问压缩文件是可行的，但需要一定的技巧。例如，假设一个进程要查找图11-46中文件的第35个块，NTFS如何定位这个压缩文件中的第35个块呢？NTFS必须首先读取并解压整个压缩单元，以找到第35个块的确切位置，然后将该块传递给请求它的进程。选择16个块作为压缩单元是一个折衷方案：如果单元太短，会影响压缩效率；如果单元太长，则会增加随机访问的开销。

### 日志
NTFS支持两种机制来监控卷上的文件和目录变化：
1. **NtNotifyChangeDirectoryFile**：通过调用此I/O操作，并传递一个缓冲区给系统，当系统检测到目录或子目录树的变化时，该操作会返回并在缓冲区中填充变化记录列表。如果缓冲区不够大，部分记录可能会被丢弃。
2. **NTFS变化日志**：NTFS将卷上目录和文件的变化记录保存在一个特殊文件中。程序可以通过调用`NtFsControlFile` API 并使用 `FSCTL_QUERY_USN_JOURNAL` 参数来读取这些记录。日志文件通常很大，且日志项在被检查之前重用的可能性很小。

### 文件加密
计算机经常用于存储敏感数据，如公司收购计划、税务信息和个人信件。为了防止这些信息泄露（例如由于笔记本电脑丢失或被盗），Windows 提供了文件加密功能。用户可以将重要目录标记为加密，其中的所有文件都将被加密，新创建或移动到这些目录的文件也会自动加密。加密和解密由EFS（Encryption File System）驱动程序管理，而不是NTFS本身。此外，Windows Vista还引入了BitLocker，它能够加密卷上的几乎所有数据，从而进一步增强数据安全性。

### Windows Vista中的安全特性
尽管Windows Vista并非专门设计来满足C2级安全需求，但它继承了许多来自早期NT版本的安全特性，包括：
- 安全登录（防欺骗措施）
- 自主访问控制
- 特权化访问控制
- 进程地址空间保护
- 新页映射前清零
- 安全审计

#### 基本概念
- **SID (Security ID)**：每个用户和组都有一个唯一的SID，用于标识其身份。
- **访问令牌**：包含用户的SID和其他属性，确保只有授权的线程才能访问特定对象。
- **安全描述符**：与每个对象关联，定义了谁可以对该对象执行哪些操作。它由DACL（自主访问控制列表）和SACL（系统访问控制列表）组成。

#### 安全相关的API调用
- 创建安全描述符涉及分配内存、初始化头部、设置所有者和组SID、初始化ACL等步骤。
- 重要的API调用包括`InitializeSecurityDescriptor`、`LookupAccountSid`、`InitializeAcl`、`AddAccessAllowedAce` 和 `SetSecurityDescriptorDacl`。

#### 安全性的实现
- 登录和认证分别由`winlogon`和`lsass`处理。
- 每次打开对象时，安全引用监控器会检查调用者的权限，通过比较访问令牌和对象的DACL来决定是否允许访问。
- SACL用于记录某些操作的日志，以便进行安全审计。

通过这些机制，Windows Vista提供了多层次的安全保护，有效防止未经授权的访问和数据泄露。