OR B.nane IS NULL;
---
## Page 103
90
第1章神奇的 SQL
■执行结果
1d
nane
伊集院
西园寺
■用全外连接求异或集
伊集院
田中铃木
西园寺
像这样改变一下WHERE子句的条件，就可以进行各种集合运算。现
在我们已经求了集合的并集、差集、交集，那么想求集合的商时该怎么做
呢？其实商也可以通过外连接来求。也就是说，我们在14节里介绍过的
关系除法运算也可以通过外连接来实现。如果使用1-4节里的表Items和
表Shopltems，可以像下面这样写。
用外连接进行关系除法运算：差集的应用
SELSCT DISTINCT shop
MHERE NOT EXISTS
(SELECT I.item
FROM Itens I LEFT OUTER JOIN ShopItens SI2
ON I.item = SI2.iten
AND SI1.shop = SI2.shop
HHERE SI2.Item IS NULL)-
■执行结果
sbop
仙台
东京
这个查询的意思是，用表Items减去表Shopltems里各个店铺的商品，
如果结果是空集，则说明该店铺库存里有表Items里的全部商品。其中，“各
个店铺”这一条件是通过on子句里的 sI1.shop－SI2.shop这个关联子
---
## Page 104
1-5外连接的用法—
16
注0
查询来表述的·。因为这种解法用到了集合的差集，所以也可以直接使用
据能者e认, 0ncle 10g 和 MyS0L
5,0 不支持在连接条件里使用关
EXCEPT运算符来实现。请大家把这当作练习题，试着按照这种思路改写
能正管执行, 但是在 PostgreSOL
联子查该的表名。所以这个 SOL 不
一下（答案将在1-7节中揭晓）。
9.6 中是可以正需扶行的。
本节小结
最后，我们稍微了解一点与外连接写法相关的内容。SQL有很多的方
言，例如外连接，Oracle数据库使用“(+)"，而 SQL Server数据库使用“+_"
等，非常依赖于数据库的具体实现。从代码的可移植性来说，我们应该避
免采用这样独特的写法，并遵循ANSI标准。因此，本书统一采用了标准
的写法。
还有，OUTER也是可以省略的，所以我们也可以写成LEFT JOIN和
FULLJOIN（标准SQL也是允许的）。但是为了区分是内连接和外连接，
最好还是写上。请大家在日常工作中多注意这一点（关于“标准写法和方
言”的间题，1-12节还会介绍）。
下面是本节要点。
1.SQL不是用来生成报表的语言，所以不建议用它来进行格式转换。
2.必要时考虑用外连接或CASE表达式来解决间题。
3.生成嵌套式表侧栏时，如果先生成主表的笛卡儿积再进行连接，很
容易就可以完成。
4.从行数来看，表连接可以看成乘法。因此，当表之间是一对多的关
系时，连接后行数不会增加。
5.外连接的思想和集合运算很像，使用外连接可以实现各种集合运算。
外连接是一种很常用的技术。即使是人们很熟悉的东西，也还能不断
地找到新的用途—这正是SQL这门语言有趣的地方之一。
如果大家想了解更多关于外连接的内容，请参考下面的资料。
1. C.J.Date、Hugh Darwen, A Guide to SQL Standard ( 4th Edition ),
( Addison-Wesley Professional, 1996 年)
关于外连接的标准语法，请参考该书第11章。
---
## Page 105
92
TDSW年享1集—
2.JoeCelko，《SQL权威指南（第4版）》（人民邮电出版社，2013年）
关于使用外连接进行集合运算，请参考第34章“集合操作”：关于使用
差集进行关系除法运算，请参考27.2.6节“用集合运算符进行除法”：
如果不清楚带有重复项的表格哪里让数据库工程师想买，请参考第25
章“SQL中的数组”
3.JoeCelko，《SQL解惑（第2版）》（人民邮电出版杜，2008年）
该书中很多谜题都用到了外连接，这里列出几个有代表性的谜题，如行
，
机与飞行员”，等等。
练习题
●练习题1-5-1：先连接还是先聚合
在“在交叉表里制作嵌套式表侧栏”部分里，我们通过聚合将DATA
视图和MASTER视图转换为一对一的关系之后进行了连接操作。采用这
种做法时，代码的确比较好理解，但是这就需要创建两个临时视图，性能
并不是很好。请想办法改善一下代码，尽量减少临时视图。
●练习题1-5-2：请留意孩子的人数
在“用外连接进行行列转换（1)（列→行）：汇总重复项于一列”部分，
我们求得了以员工为单位的员工子女列表。有了这个列表后，对员工进行
一下聚合很容易就可以知道每个员工抚养了几个孩子。
请修改一下正文中的SQL，求每个员工抚养的孩子的人数。这里，输
出结果如下所示。
enployee
child_ont
工藤
泰井
特木
吉田
1
---
## Page 106
1-5外连接的用法
93
这个间题应该挺容易的，只有个别细节需要稍微注意，所以请仔细比
较一下自己的结果和上面的结果有没有什么不同。
●练习题1-5-3：金外连接和MERGE运算符
在“全外连接”部分，我们提到过，在不遗漏任何信息这一点上，
MERGE和全外连接非常相似。那么接下来，我们练习一下MERGB的用法。
MERGE运算符是在SQL：2003标准中引入的新特性。因为它可以将两
张表的信息汇总到一张表上，所以在需要将分散在多个数据源的数据汇总
到一起的场景中能发挥很强大的威力。
这里继续使用正文中用到的 Class_A和 Class_B这两张表（表Class_
B中的数据有些变化）。
Class_A
Class_B
（编号）
（编号）
中田
（名字
中田
铃木
2
内海
伊集院
西圆寺
我们假设要将表Class_B里的数据汇总到表Class_A里，目标结果像
下表这样。
■汇总后的 Class_A
1e（名字）
田中
内海
伊集院
西圆寺
处理逻辑是在表Class_A中查询表ClassB里的“id（编号）”列，如
果存在则更新名字，如果不存在则插入。因此，两张表中同名的1号“田中”，
以及表Class_B中不存在的3号“伊集院”没有变化，两张表中编号相同
同学“西园寺”被添加进表中。
---
## Page 107
94
第1章神奇的SQL
用关联子查询比较行与行
用SOL进行行与行之间的比较
使用SQL对同一行数据进行列间的比较很简单，但是对不同行数据进行比较却没那么简单。然而，
这并不是说我们不能用SQL进行行与行之间的比较。本节，我们将通过应用事例学习一下如何使用关联
子查询进行行与行之间的比较。
写在前面
使用SQL对同一行数据进行列间的比较很简单，只需要在WHERE子
句里写上比较条件就可以了，例如col_1－col_2。但是，对不同行数据
进行列间的比较却没那么简单。然而，这并不是说我们不能用SQL进行
行与行之间的比较。虽然与面向过程语言的思路很不一样，但是使用SQL
也是可以实现这样的功能的。
使用SQL进行行间比较时，发挥主要作用的技术是关联子查询，特
注0
别是与自连接相结合的“自关联子查询"。本节，我们将通过具体事例
关于行与行之间比较的方述，近
些年新增了窗口函数这样—种违
来学习一下如何应用自关联子查询进行行间比较。
择。但是。因为窗口函数的实现
同。所以本节还见使用关取子查
情况也因具体的数据率系统而不
询的方法。
增长、减少、维持现状
需要用到行间数据比较的具有代表性的业务场景是，使用基于时间序
列的表进行时间序列分析。假设有下面这样一张记录了某个公司每年的营
业额的表 Sales.
---
## Page 108
1-6用关联子查询比较行与行一
95
Sales
ear（年册）
[年营业额：亿日元】
1990
50
1991
51
1992
52
1993
52
1994
50
1995
1996
49
1997
55
1年营业额的趋势
1930
1991
1992
1993
1994
1995
1996
请根据这张表里的数据，使用SQL输出与上一年相比营业额是增加
了还是减少了，抑或是没有变化。可以先试试求出“不变”这种情况。从
表里可以看到，我们需要求出的是1993年和1995年。如果用面向过程语
言来解决，应该是下面这样的思路。
1.按年份递增的顺序排序。
2.循环地将每一行与前一行的“sale”列进行比较。
使用SQL时的解题思路跟这个思路不太一样，需要用面向集合的方
式进行思考。这里，我们在表Sales的基础上，再加一个存储了上一年数
据的集合（S2）。
---
## Page 109
96
第1章神奇的 SQL
--求与上一年营业额一样的年份（1）：使用关联子查询
SEL&CT year, sale
FROM Sales S1
MHERE sale - (SELECT sale
FROM Sales S2
MHERE S2.year - Sl.year
ORDER BY yearJ
■执行结果
year
sale
1993
52
1995
50
S1：今年
S2：去年
Y（年龄）
sale|年营业额
year[年份）
sale（年营业额）
1990
50
1990
50
1991
51
1991
51
1992
52
1992
52
1993
52
1993
52
1994
50
1994
50
1995
50
1995
50 
1996
49
1996
49
1997
55
1997
55
子查询里的 S2.year－S1.year-1这个条件起到了将要比较的数
据偏移一行的作用。关联子查询和自连接在很多时候都是等价的，所以我
们也可以像下面这样使用自连接来实现。
--求与上一年营业额一样的年份（2）：使用白连接
SELSCT S1.year, S1.sale
FROM Sales S1,
Sales S2
MHERE S2.sale - S1.sale
AXD S2.year = S1.year - 1
ORDER BY yearJ
关于这两种做法哪种性能更好，我们不能一概而论，因为这会因环境
而不同，所以请实际比较一下看看。
图灵社区会员 非洲钢(PI:EMAIL) 专享 尊重版权