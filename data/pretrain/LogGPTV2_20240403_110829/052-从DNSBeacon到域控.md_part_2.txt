内⽹的所有机器对外都只通 DNS 协议，所以我们进⾏内⽹横向渗透需要以获取
到的 web 服务器作为中继监听，进⾏内⽹横向渗透。
在获取到的 web 服务器上执⾏中继监听。
⽬前获取到的只是数据库服务器的普通 network service 权限，我们现在需要提
权到管理员权限。使⽤ CobaltStrike 的插件进⾏提权，然后监听器选择刚刚创
建的 zhongji。执⾏后，成功获取到管理员权限。由于是 WinServer2008 的机
器，运⾏ mimikatz，得到明⽂账号密码。
⽬前我们已经拿到了两台服务器的管理员权限了。并且⼀台服务器是明⽂账号密
码，⼀台服务器是密码哈希。现在我们需要对内⽹进⾏更⼴阔的横向渗透了。现
在获取的两台机器都在 192.168 ⽹段。但是我们扫描的时候还需要探测 10.0 ⽹
段和 172.16 ⽹段。
对内⽹进⾏ MS17-010 探测攻击，成功攻下 3 台服务器，均在 192.168 ⽹段。
对内⽹ 445、1433、3306、6379 等端⼝进⾏扫描。
对开放了 445 端⼝的主机进⾏ SMB 爆破，利⽤刚刚读取到的明⽂账号
密码。如果爆破成功，直接 psexec 远程弹⼀个 CobaltStrike shell 回
来。这⾥获取到 3 台服务器权限，均在 192.168 ⽹段。
对于没爆破成功的主机，利⽤读取到的哈希进⾏哈希传递攻击。
对开放了 1433、3306 端⼝的主机，利⽤内⽹中获取到的账号密码进⾏
数据库爆破。如果爆破成功，再执⾏ UDF/XP_cmdshell 提权等操作。
这⾥ MySQL 的 UDF 提权未执⾏成功，但是 xp_cmdshell 提权执⾏成
功，获取了权限，在 10.0 ⽹段。
对 6379 端⼝进⾏爆破，如果有未授权访问或弱⼝令并且是 Linux 主机
的话，则直接尝试利⽤写⼊公钥提权。但是这⾥好多机器⽆写⼊权限，
只获取到⼀台 Linux 主机权限，在 10.0 ⽹段。
经过内⽹中继横向渗透，已经拿到了 8 台 Windows 服务器和 1 台 Linux 服务
器的权限了。但是，并没有找到在域内的机器。但是在前期的信息收集过程中，
已经得知⽬标内⽹存在域环境：xxx.com，并且收集到了域控的 IP 地址。后来
在 10.0 的机器上发现可以 ping 通域控的地址。
域内⽤户枚举
在 10.0 的机器上发现可以 ping 通域控后，在该机器上挂代理，准备对域内的
⽤户进⾏枚举。⽤户名使⽤之前在数据库中收集到的⽤户名 + 我的超强⽤户名
字典 (针对国内⽤户进⾏收集的⽤户名字典，⼀共两万多条)。
通过域内⽤户名枚举，⼀共枚举出了⼀百多个域内⽤户名。
nmap -sT -Pn -p 88 --script krb5-enum-users --script-args krb5-enum-users.re
域内⽤户密码碰撞
获取到了域内⽤户名之后，再查看哪些⽤户名在之前拿到的数据库中，找到其对
应的 MD5 密码去在线⽹站解密，尝试碰撞。最后，终于碰撞出⼀个属于信息管
理部⼈员的域账号。
然后，使⽤该域⽤户远程 RDP 连接开放了 3389 端⼝的域内主机，⽴⻢弹回⼀
个 dns beacon 的 shell，并且进⾏域内信息查询，发现该域账号只是普通域⽤
户。
当执⾏了 net group "domaian computers" /domain 后，发现了与刚刚破解的
⽤户名相同的主机名。于是可以猜测到，这台机器应该是这个⽤户的个⼈办公
机。扫描了⼀下端⼝，该机器开放了 3389 端⼝。
于是等到了中午⼗⼆点的时候 (这时候是饭点)，远程 RDP 登录该主机，进⾏快
速的信息查找。
RDP 凭据账号密码提取
当执⾏以下命令之后，发现该机器上存有登录到域内其他机器的 RDP
Session。
#查看mstsc的连接纪录
cmdkey /list
#查找本地的Credentials：
dir /a %userprofile%\AppData\Local\Microsoft\Credentials\*
于是乎上传 mimikatz，使⽤本地提权漏洞，提到 system 权限，执⾏以下命
令，成功获取到该 RDP 凭据中保存的⽤户名密码。
exp.exe mimikatz.exe
privilege::debug
dpapi::cred /in:C:\Users\xx\AppData\Local\Microsoft\Credentials\RDP Session
sekurlsa::dpapi
dpapi::cred /in:C:\Users\xxx\AppData\Local\Microsoft\Credentials\RDP Session
拿下域控
查询该⽤户名所属组，发现在管理员组中。
发现域控 3389 端⼝开着，直接 RDP 登录域控。
查看域内主机个数，3807 台，到此，项⽬结束。Game Over！
总结
本次项⽬最主要的特点是内⽹的主机对外都只能通 DNS 协议，所以我们需要利
⽤ DNS Becaon 弹 shell 回来。在进⾏内⽹横向渗透的时候，需要以获取到权
限的主机作为中继监听，进⾏内⽹横向。
1. 站库分离获取 web 服务器权限，然后通过 DNS Beacon 弹回 shell。
2. 内⽹连接数据库，翻阅数据库记录⽤户名和密码，xp_cmdshell 提权获
取权限。
3. 内⽹中继横向渗透获取到 9 台服务器权限。
4. 域内⽤户名枚举，枚举出⼀百多个⽤户名，并且通过密码碰撞得到信息
管理员⼈员域内⽤户名密码。
5. 登录域内任意主机，查询发现该⼈员的个⼈办公机器。
6. 趁着饭点连接该⼈员主机，从 RDP 凭据中获取到域管理员账号密码。
7. 直接使⽤该域管理员账号登录域控，GameOver。
全⽂完
本⽂由 简悦 SimpRead (http://ksria.com/simpread) 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看 (http://ksria.com/simpread/docs/#/词
法分析引擎)详细说明