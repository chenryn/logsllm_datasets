**日志管理平台**
**系统设计说明书**
**北京优特捷信息技术有限公司**
**2018年07月**
**版本信息**
  ------------ ---------- ------------------------------------------ -----------
  **日期**     **版本**   **描述**                                   **作者**
  2017-03-01   1.0        初始版本                                   工作组
  2018-07-25   1.1        调整目的等说明内容                         佘兴锋
  ------------ ---------- ------------------------------------------ -----------
# 目录 {#目录 .TOC-Heading}
[1. 引言 [5](#引言)](#引言)
[1.1 目的 [5](#目的)](#目的)
[1.2 背景 [5](#背景)](#背景)
[1.3 使用范围 [5](#使用范围)](#使用范围)
[1.4 定义 [6](#定义)](#定义)
[1.5 参考资料 [6](#参考资料)](#参考资料)
[2. 设计说明 [7](#设计说明)](#设计说明)
[2.1 架构概述 [7](#架构概述)](#架构概述)
[2.2 WEB服务 [9](#_Toc461958199)](#_Toc461958199)
[2.3 消息系统 [11](#消息系统)](#消息系统)
[2.4 数据处理 [12](#数据处理)](#数据处理)
[2.5 数据检索 [14](#数据检索)](#数据检索)
[2.6 后台系统 [15](#后台系统)](#后台系统)
[2.7 数据备份与恢复 [40](#数据备份与恢复)](#数据备份与恢复)
[2.8 数据聚合、关联、推送 [50](#数据聚合关联推送)](#数据聚合关联推送)
[2.9 Restful API服务 [59](#restful-api服务)](#restful-api服务)
本文件中出现的任何文字叙述、文档格式、插图、照片、方法、过程等内容，除另有特别注明，版权均属日志易所有，受到有关产权及版权法保护。任何个人、机构未经日志易书面授权许可，不得复制或引用本文件的任何片断，无论通过电子形式或非电子形式。
# 引言
## 目的
随着陕西信合业务的不断发展，信息系统的复杂度也越来越高，为了支持业务快速发展、降低开发难度、排除性能瓶颈，系统拆分以及各种专用功能的组件会不断的被引入，系统和机器规模不断膨胀，在这样的情况下，运维或者开发人员难以全面了解系统中的每个逻辑，通过人工登陆服务器排查日志找到系统问题产生的原因耗时耗力。为了解决这些问题，我们急需一个具备汇总、检索、展示、串接事件、快速定位问题的能力的日志管理系统，对日志管理平台技术实现进行整体设计。系统设计说明书是在系统需求分析的基础上进行的，主要解决实现系统需求的设计问题，在满足功能需求规范各项功能要求的同时，更加侧重与各业务系统组织的结合，突出详细设计在系统实施中的指导性。此文档对日志管理平台做了全面细致的用户需求分析，明确所要开发的软件应具有的功能、性能与界面，使软件开发人员以及系统分析人员能清楚地了解用户的需求。
## 背景
本文档是在完成需求分析报告的编写和软件需求说明书的编写以及全面深入地探讨和分析的基础上，编写了本系统下的督察分析平台的系统设计文档。以更为清楚准确的描述了客户的需求。
## 使用范围
建议以下人员阅读本文档：分析人员、项目管理人员、软件测试人员、质量管理人员，以及陕西信合的项目负责人。
## 定义
  ------ ------------ ------------ -------------- ------------------------------------------------------------------------
  编号   角色         对应岗位     所属组织单元   职责
  1001   系统管理员   系统管理     集团           对系统进行管理，可查看、处理公司整体日志、仪表盘、告警、事件结果；
  1002   普通管理员   管理组       各主体         可查看、下载各自主体整体日志、仪表盘、告警、事件的原始数据包；
  1003   运维人员     运维组       各主体         可查看、下载各自主体各自系统整体日志、仪表盘、告警、事件的原始数据包；
  1004   开发人员     开发组       各主体         可查看、下载各自主体各自系统整体日志、仪表盘、告警、事件的原始数据包；
  1005   外包人员     外包项目组   厂商           可查看、下载各自主体各自系统整体日志、仪表盘、告警、事件的原始数据包；
  ------ ------------ ------------ -------------- ------------------------------------------------------------------------
## 参考资料
无
# 设计说明
## 架构概述
日志管理平台采用高性能、低延时的准实时流式处理，采用分布式、松耦合、可扩展的集群架构，各模块可水平扩展，如果哪个模块成为性能瓶颈，只需要增加运行那个模块的服务器数量。提供开放的RESTful
API接口，可供第三方做二次开发。采用冗余容错的架构，所有模块都冗余部署，某台服务器出问题不会导致系统服务中断。提供完善的系统监控，无论是硬件还是软件故障，都能够及时告警。提供灵活的高可用、高性能分部署大数据接入、存储、处理、检索、展现的平台。
**架构图**
![](media/image1.png){width="5.78125in" height="2.96875in"}
**组件概述**
图中蓝色部分为日志管理平台的模块，红色部分为可通过RESTful
API接入的第三方模块
**采集系统**
1.  如果数据在服务器端是文件形式，数据采集可以采用Linux标配的Rsyslog或日志管理平台提供的agent监控服务器的数据文件，读取数据文件及其增量并发送给日志管理平台。
2.  如果数据已经存入Hadoop系统或数据库，日志管理平台可提供定制化agent，将数据从Hadoop系统或数据库里读出来并发送给日志管理平台。
3.  网络设备可通过syslog协议把数据传送过来。
    **消息系统**
日志管理平台采用分布式消息系统连接各个模块，消息系统也起到缓存的作用。
**数据处理系统**
数据处理系统基于高性能内存流式计算架构logriver，根据配置的规则抽取数据关键字段，将非结构化的数据转换成结构化数据。抽取关键字段的好处是可以对关键字段进行统计分析。日志管理平台将对关键字段及原始数据进行索引，用户可对关键字段及原始数据进行搜索。
日志管理平台已经配置了常见数据的解析规则，对于日志管理平台没有预先配置解析规则的数据，用户可通过后台或Web页面配置解析规则，抽取关键字段。即使没有抽取关键字段，用户仍然可以通过全文检索搜索数据。
日志管理平台在数据做索引之前抽取关键字段，提高了检索的速度。业界有的竞品在检索阶段抽取字段，导致检索速度慢。日志管理平台克服了这个弊端。
**数据检索系统**
对数据的关键字段及全文做索引，每天的数据存为一个索引文件，方便用户决定保留多少天的数据。索引文件采用分布式存储，并且有副本，保障高可用。另外，数据检索系统也支持对不同来源的数据做关联分析。
## WEB服务
进行数据展现、数据可视化，支持各种统计功能及图表展现，实现流畅的图形用户交互。
[]{#_Toc461958199 .anchor}**WEB服务**
WEB服务提供了日志管理平台的访问页面，进行数据展现、数据可视化，支持各种统计功能及图表展现，实现流畅的图形用户交互。
**服务架构**
![](media/image2.png){width="5.78125in" height="4.375in"}
**使用界面**
**ldap接入设计**
日志管理平台登陆支持OpenLDAP服务，同时保留原始的直接登陆方式用于管理员登陆，用户可在登陆界面进行选择。默认为通过LDAP登录。
首次通过LDAP登陆的用户只具有默认的基本权限，查看指定的默认分组的日志。
为首次通过LDAP登陆的用户在日志管理平台中创建平台用户，用于后续管理员对账户权限的管理。
日志管理平台管理员可配置接入LDAP的地址，加密方式，用户分组等。
配置项在Web服务的配置文件中指定，更改后只需重启Web服务即可生效，使用ini格式，含义依次说明：
ldap.server_domain:
OpenLDAP服务器域名。如果OpenLDAP服务端配置了传输加密,并且TLSVerifyClient配置项为demand,则需其为与证书CommanName一致的domain。
ldap.port: OpenLDAP服务端口。
ldap.domain_base: 搜索用户的根结点。
ldap.admin_dn: 通过此OpenLDAP账户进行用户查询。
ldap.admin_password: admin_dn密码。
ldap.encryption:
Web服务与OpenLDAP之间的传输支持plain,start_tls,ldaps三种加密方式。采用ldaps方式加密传输需要配置证书。
ldap.uid_attribute_name: LDAP中用户唯一ID字段名。
ldap.name_attribute_name: LDAP中用户名字段名。
ldap.email_attribute_name: LDAP中用户邮箱字段名。
ldap.rizhiyi_name_posfix:
用来为通过LDAP首次登陆的用户添加进大数据用户系统时作为后缀名，目的是避免命名冲突。
ldap.default_group: 默认可查询的日志分组。
ldap.operator\_\*:
因LDAP登陆用户第一次登陆时候即需要进行分组操作，需提供离线调查取证工具管理员账户密码。
ldap.private\_\*: 当对证书的要求是demand时候，客户端需要提供证书。
## 消息系统
用于消息的持久化和缓存。该系统使用磁盘文件做持久化，顺序进行读写，以append方式写入文件。为减少内存copy，集群使用sendfile发送数据，通过合并message提升性能。集群本身不储存每个消息的状态，而使用（consumer/topic/partition）保存每个客户端状态，大大减小了维护每个消息状态的麻烦。在消息推拉的选择上，集群使用拉的方式，避免推的方式下存在的各个客户端的处理能力、流量等不同产生不确定性。以多机形式形成集群，建议3台或3台以上奇数台服务器组建，并且支持分区副本。
**模块架构**
![](media/image3.png){width="5.770833333333333in"
height="4.395833333333333in"}
## 数据处理
采用了业界最先进的流式大数据处理架构logriver，构建的高性能、分布式日志处理架构可以每秒钟分析10万条日志，每天可以处理TB级的日志量，而且处理延时非常短，可以让用户搜索、分析几秒钟之前产生的日志。
处理延时非常短，可以让用户搜索、分析几秒钟之前产生的日志。
流式计算集群具有如下特性：
·轻量级快速处理：
·着眼大数据处理，速度往往被置于第一位。logriver通过减少磁盘IO来达到性能提升，它们将中间处理数据全部放到了内存中。
·无数据丢失：
系统需要保证无数据丢失，这也是系统高可用性的保证。系统为了无数据丢失，需要在数据处理失败的时候选择另外的执行路径进行replay（系统不是简单的重新提交运算，而是重新执行调度，否则按照来源的call
stack有可能使得系统永远都在相同的地方出同样的错误）。
·容错透明：
用户不会也不需要关心容错。系统会自动处理容错，调度并且管理资源，而这些行为对于运行于其上的应用来说都是透明的。
**模块架构**
> ![](media/image4.png){width="5.78125in" height="5.0625in"}
## 数据检索
索引集群是一个的分布式搜索引擎，具备高可靠性和高性能。支持时间文本索引和全文检索，提供丰富的api用于索引、检索、修改大多数配置。能够快速搜索数百亿的日志以及TB级的数据，结构化或者非结构化的数据都可以。
集群由2台及2台以上节点组成，其中一个为主节点，节点通过选举产生，主从节点是对于整个集群内部来说的，从外部来看整个集群，逻辑上是一个整体，与任何一个节点的通信和与整个集群通信是完全一致的。集群自动创建索引，通过配置我们可以非常方便的调整索引分片和索引副本。通过索引分片技术，一个大的索引被拆分成多个，然后分布在不同的节点上，以构成分布式搜索。索引副本的作用一是提供系统的容错性，当某个节点某个分片损毁或丢失时，可以从副本中恢复；二是提供查询效率，集群内部会自动实现搜索请求的负载均衡。
**模块架构**
> ![](media/image5.png){width="5.770833333333333in" height="4.6875in"}
## 后台系统
提供对各个模块的管理接口，均为通过Restful接口管理。
**2.6.1数据库设计**
**Domain**
  --------------------------------------- ----------------------- ----------------------------------------
  字段名称                                类型                    含义描述
  id                                      bigint                  自增ID
  name                                    varchar(128)            名称
  token                                   text                    token列表，可以有多个
  create_time                             bigint(20)              创建时间
  expiry_time                             bigint(20)              过期时间
  limit_flow_quota                        bigint(20)              每天可以上传的最大字节数
  used_flow_quota                         bigint(20)              已经上传的字节数
  update_used_flow_quota_timestamp        bigint(20)              最近一次更新上传字节数的时间戳
  upload_bytes_stat                       text                    历史上传日志量的统计结果，保留最近30天
  newest_timestamp_of_upload_bytes_stat   bigint(20)              最近一次更新历史记录的时间戳
  hostname_bytes_stat                     text                    基于hostname的上传量统计结果
  logtype_bytes_stat                      text                    基于logtype的统计结果
  appname_bytes_stat                      text                    基于appname的统计结果
  tag_bytes_stat                          text                    基于tag的统计结果
  update_stats_timestamp                  bigint(20)              最近更新上述四个统计值的整天数
  newest_update_stats_timestamp           bigint(20)              最近一次更新上述四个统计值的时间戳
  update_stats_version                    bigint(20)              
  activated                               tinyint(1)              是否激活
  activated_key                           varchar(255)            激活时使用的key
  --------------------------------------- ----------------------- ----------------------------------------
**TokenFinder**
**表，根据Token快速反查Domain**
  ------------------------ ----------------------- -----------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 自增ID
  domain_id                int(11)                 
  token                    varchar(255)            
  ------------------------ ----------------------- -----------------------
**Account**
**表，用来记录用户信息**
  ------------------------ ----------------------- -----------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 自增ID
  name                     varchar(255)            名称
  full_name                varchar(255)            全名
  passwd                   varchar(255)            密码，md5
  domain_id                int(11)                 所属domain
  phone                    varchar(255)            
  email                    varchar(255)            
  company                  varchar(255)            
  access_type              varchar(255)            权限，owner \| admin \|
                                                   normal
  create_time              bigint(20)              创建时间
  last_login_time          biging(20)              最近一次登录时间
  actions                  mediumtext              记录actions
  trends                   mediumtext              记录趋势图操作轨迹
  source_group_id          int(11)                 
  ------------------------ ----------------------- -----------------------
**SourceGroup**
**表，记录每个SourceGroup的信息**
  ------------------------ ----------------------- -----------------------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 自增ID
  name                     varchar(255)            
  domain_id                int(11)                 
  assigned_account_ids     mediumtext              指定的account_id列表
  owner_id                 int(11)                 创建者ID
  description              varchar(255)            描述
  hostname                 varchar(255)            设定的hostname值，用\",\"分割多个
  appname                  varchar(255)            appname值，用\",\"分割多个值
  tag                      varchar(255)            tag值，用\",\"分割多个值
  raw_sizes                mediumtext              记录该group下每天的原始日志量
  ------------------------ ----------------------- -----------------------------------
**AssignedSourceGroup**
**表，快速查找account所属的SourceGroup**
  ------------------------ ----------------------- -----------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 自增ID
  account_id               int(11)                 
  source_group_id          int(11)                 
  ------------------------ ----------------------- -----------------------
**SourceGroupStatInfo**
**表，记录每个小时内的数据来自哪些appname以及相应的hostname**
  ------------------------ ----------------------- -----------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 
  source_group_id          int(11)                 
  datetime                 datetime                记录的时间戳
  appnames                 mediumtext              记录结果
  ------------------------ ----------------------- -----------------------
**SavedSearch**
**记录已存搜索**
  ------------------------ ----------------------- -----------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 
  name                     varchar(255)            名称描述
  domain_id                int(11)                 
  creator_id               int(11)                 
  query                    varchar(255)            检索串
  time_range               varchar(255)            检索时间范围
  source_groups            varchar(255)            指定的sourcegroup
  filters                  varchar(255)            指定的过滤条件
  anonymous                tinyint(1)              是否匿名
  marked                   tinyint(1)              是否加关注
  ------------------------ ----------------------- -----------------------
**Alert**
**表，记录告警信息**
  ------------------------ ----------------------- --------------------------------------
  字段名称                 类型                    含义描述
  id                       int(11)                 
  name                     varchar(255)            
  domain_id                int(11)                 
  saved_search_id          int(11)                 关联的saved_search_id
  owner_id                 int(11)                 创建者ID
  email                    varchar(255)            报警邮件地址
  description              varchar(255)            描述
  check_interval           int(11)                 检测间隔时间值
  interval_unit            tinyint(1)              间隔时间值的单位，0表示分钟，1表示秒
  check_condition          varchar(255)            检测条件
  enabled                  tinyint(1)              是否打开
  last_run_timestamp       bigint(20)              上次检测的时间戳
  run_results              text                    运行结果记录集
  category                 smallint(8)             告警类型
  ------------------------ ----------------------- --------------------------------------
**LogType**
**表，用来记录日志解析的相关信息**