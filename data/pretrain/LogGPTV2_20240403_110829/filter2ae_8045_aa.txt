### 前言
不想当将军的士兵不是好士兵，不想getshell的Hacker不是好Hacker~  
有时候我们在做攻防对抗时经常会碰到可以上传webshell的地方，但是经常会被安全狗、D盾、护卫神、云锁等安全软件查杀，在本篇文章中将会介绍一些常用的木马免杀技巧，主要针对安全狗、护卫神、D盾进行免杀~
### 查杀软件
#### D盾
D盾是一个专门为IIS设计的主动防御的安全性保护软件，它采用以内外防护的方式防止服务器和网站被人入侵，它秉持在正常运行各类网站的情况下，越少的功能，服务器就越安全的理念而设。它具有一句话木马查杀、主动后门拦截、Session保护、CC攻击防御、网页篡改查询、WEB嗅探防御、SQL注入防御、XSS攻击防御、提权防御、恶意文件上传防御、未知0Day防御等特性。  
#### 安全狗
安全狗是一款安全防护软件，它提供木马查杀、漏洞防御、非法请求拦截等功能，致力于保护网站和服务器的安全。它具有应用防护WEB应用风险、拦截各类SQL注入、XSS攻击防御、0Day攻击防御、特定资源保护、网络木马文件、恶意畸形文件、0Day漏洞、黑链等特性。  
#### 护卫神
护卫神是一款以分离权限为基础，通过一系列独特技术手段，保障网站不被入侵的安全性防护软件。它适用于各类ASP和PHP编写的程序，在目前网站日益猖狂的挂马、入侵情况下，护卫神可以彻底解决用户所面临的众多安全难题，为网络安全保驾护航。
它具有实时木马程序查杀、网站挂马拦截、文件篡改保护、PHP拒绝服务攻击防御、SQL防御、XSS跨站攻击防御、入侵拦截防护、远程桌面安全保护等特性。  
## 免杀基础
#### 免杀需求
因为设计的木马的最终目的在发现目标网站有上传漏洞时可以将木马上传到目标服务器上并且可以远程访问实现远程控制，然而一些网站都会有安全狗、D盾、安骑士、护卫神、云锁等防护软件可以对一些Webshell进行查杀，那么要想使用Webshell进行远控就需要实现免杀，以此来躲避木马查杀工具的检查。
#### 查杀技术
目前主流的木马查杀方法有：静态检查、动态检测、日志检查三种方式。  
a、静态检查通过匹配特征码、危险函数和木马特征值来查杀木马程序，它的特点是快速方便，对已知的木马程序查找准确率较高，它的缺点是误报率较高，无法查找0Day型的木马程序，而且容易被绕过。  
b、动态检测通过木马程序的动态特征来检测，当木马程序被上传到服务器上后，攻击者总会去执行它，当木马程序被执行时所表现出来的特征就是所谓的动态特征。  
c、日志检测则主要通过日志分析检测技术来实现，它主要通过分析大量的日志文件并建立请求模型来检测出异常文件。它的优点为当网站上的访问量级达到一致值时，这种检测方法具有比较大参考性价值。它的缺点则是存在一定误报率，对于大量的日志文件，检测工具的处理能力和效率都会变的比较低。
#### 免杀技巧
木马程序可以使用多种编程语言来设计，不同的编程语言有不同特性以及提供的系统函数，所以在实现免杀时可以首先考虑灵活运用语言的特性来实现免杀，其次可以根据查杀软件的查杀规则来重构木马程序，躲避木马查杀工具的查杀，同时可以考虑密码学中的加密解密对源木马程序进行加密解密处理，以此来躲避木马查杀工具的检查。木马免杀技术的核心在于“灵活多变”。
### 免杀实战—小马免杀
#### 引用免杀
因为D盾、安全狗、护卫神会对关键字eval中的执行变量进行溯源，当追溯到要执行的变量为一个通过POST接收的可疑数据时就会显示可疑木马，为了躲避这种溯源方式，可以通过多次使用&来引用前一个变量，通过一连串的赋值操作最后将要执行的内容与反引号拼接后传入eval实现免杀，具体实现如下所示：  
之后使用D盾查杀一下看看：  
发现还是被查杀到了，这时候b有给a说了："喂，上面的a，我们换换位置呗~"，于是a无奈的说："为啥受伤的总是我呢？"  
之后a对b说："你看，不行吧？换了也没戏"，之后b皱了皱眉说："不急，我们来再拉一下伙伴——反引号，让他帮帮忙"：  
果然，b小哥说的还是有点门道的哦，从上面的结果中可以看到成功免杀了，之后再来看看安全狗——成功免杀  
护卫神——成功免杀  
至此，D盾、安全狗、护卫神已成功免杀，之后我们来看看可用性：  
#### 可变变量
可变变量是PHP中一种较为独特的变量，它可以动态的改变一个变量的名称，这种特性可以用于木马免杀中。首先可以定义一个变量$do并为其赋值为todo,之后将木马内容赋值给可变变量$$do,最后在调用eval函数执行时将执行对象定义为$todo即可，具体实现如下所示：  
之后使用D盾查杀一下看看：  
发现不行哦，那么怎么办呢？幸好今天"反引号"大哥来串门，不妨让他来帮个忙：  
发现成功免杀，之后我们再使用安全狗查杀一下看看————成功免杀  
护卫神————成功免杀  
至此，成功免杀安全狗、护卫神、D盾，之后我们试试可用性：  
#### 二维数组
在免杀时我们可以考虑见要执行的一句话木马程序放到数组中执行达到绕过的目的，例如：  
之后我们使用D盾进行查杀————成功免杀  
之后我们使用安全狗进行查杀————成功免杀  
之后我们使用护卫神进行查杀：  
oh, My
God！护卫神这么强悍的吗？？？好不容易过了D盾、安全狗的查杀检测，走到最后一步却被护卫神给查杀了.....，那么怎么绕呢？既然一维数组不行，那么我就来个二维数组，哼：  
之后再次使用护卫神查杀  
还是被查杀到了，那么怎么办呢？变量$a给变量$b说："我们不妨换换位置?"，变量$b只好带着"试一试"的心态回复"换就换呗，反正就那样....":  