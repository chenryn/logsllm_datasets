5559036386
5556(28527
590
第10章
---
## Page 627
正则表达式
标准化电话号码数据
现在RiskyJobs使用以下正则表达式验证用户通过注册表单提交的电
话号码。
/\（?[2-9]\d{2}\）？[-\s]\d{3}-\d{4}$/
这会匹配以下4种模式的电话号码：
####-###-###
####-######
（###）-#######
我们希望将数据从这种格
式.....
####一###（###）
尽管人很容易解释这些格式，但是这样一来，要让SQL查询按我们希望的
方式对结果排序就会很困难。例如，我们可能希望按区号对电话号码分组，
这对于RiskyJobs可能很重要，因为也许我们希望分析有多少网站用户来自
某个特定的地理位置，但是这些括号很可能会使这种想法成为泡影。
要完成这种查询，用INSERT向数据库插人数据之前需要先使用preg_
变为这种格式。
replace（）把电话号码标准化为同一种格式。最好的做法就是将数字以外
的所有其他字符都去除。这样一来，只需在表中存储10位数字（而没有任
何其他字符）。我们希望电话号码采用以下方式存储在数据表中：
为此需要查找和替换4个字符。我们希望找到并去除开始和结束括号、
空格和连字符。由于希望找到这些字符而不论它们处于串中的哪个位
置，所以这里不需要开始的脱字符（^）或结束的美元符（$）。我们
通过标准化数
知道需要查找一个集合中的某个字符，所以可以使用一个字符类。搜
索的顺序并不重要。以下是我们使用的正则表达式：
据，可以得到
/\(-s]/
更好的SQL查
询结果。
开始括号
结束括号
连字符
空格
你现在的位置
591
---
## Page 628
用preg_replace（）去除字符
去除不想要的字符
既然已经有了合适的模式来查找这些不想要的字符，我们可以把这个模
式应用到电话号码，从而在将电话号码存储在数据库中之前先进行清理。
不过如何做到呢？这就要用到preg_replace（）函数。这里的关键是，
我们不是希望替换这些不想要的字符，而是希望它们完全消失。所以只
需向preg_replace（）传入一个空串作为替换值。下面的例子会查找不
想要的电话号码字符并替换为空串，从而有效地将其去除：
将壹找一替换的结果存储在
对Sphone中的文本串
这个新的电活号码变量中。
完成这个替换。
$new_phone =preg_replace("/[\(\)\-\s]/`，''，$
$phone);
匹配这些字
…并将其替换为空事。
###-###-####
000
#排####-##排#
Risky Jubs
（##）#####
Risky Jobs - Registration
（###）###-####
所有这些电话号码格式都认为是合法
Fint Nam
的.都能被Registration表单所接爱。
La7
phone
preg_replace()
......
5559352659
5556720953
5553438263
5554419005
5559036386
个
5556128527
每个电话号码标准化为这种格式
使得数据库中的所有电话号码都有
相同的格式。
592
第10章
---
## Page 629
正则表达式
我不明白，看起来大可不必为数据库中存
储10位数字串而操心。难运不能从一开始
就要求用户这样输入吗？
当然可以，不过以后这会导致问题，因为电话号码查询将不能得到你
希望的结果。
大多数用户输人电话号码时都习惯于包含连字符、小括号和空格的某
种组合，所以试图强制要求只输人数字电话号码往往不能如愿。更好
的做法是努力迎合用户的需要，为他们提供相当灵活的输入选择，而
与此同时确保你存储的数据尽可能一致。
另外，我们只讨论了利用一个preg_replace（)调用来解决这个问题，
这并不麻烦。倘若需要编写某种包含大量代码的定制函数，则是另一
回事。不过如果只用一行代码就能改善可用性和数据完整性，还有什
么可犹豫的！
PDG
你现在的位置
593
---
## Page 630
测试registration.php
运行测试
Registration脚本中清理电话号码。
修改registration.php脚本来清理电话号码，在脚本中增加以下代码行，要
增加到感谢用户注册RiskyJobs的那行代码之后：
$pattern='/[\(\)\-\s]/';
$replacement ='';
$new_phone =preg_replace（$pattern,Sreplacement,$phone）;
echo 'Your phone number has been registered as '.$new_phone.'.';
将脚本上传到你的Web服务器，然后在一个Web浏览器中打开这个脚本。填写表
单，输入包含额外字符的电话号码，如（707)827-7000。提交表单，并检查结果。
000
RiskyJobs-Registration
Risky
Jubs
Dangerl Your dreamjob is out there.
Do you have the guts to go find it?
RiskyJobs-Registration
电话号码缩减为只
包含数字不再有
HowardSoarsten,thanksforregisteringwithDil,Joh
额外的字符！
Yourphonenumberhasbecnregistered7078277000.
尝试这个数的其他几种变型，如：707.827.7000、（707）-827-7000和707827-7000。
注意正则表达式和preg_replace（）如何去除额外的字符。
594
第10章
---
## Page 631
正则表达式
我给这个要刀的人发送的eail被退回来了。
我真不敢相信这个愚么的表单居然允许人们
输入不含法的email地址！
First Name:FourFingers
Last Name:McGraw
Email:four@gregs-listnet
Phone:555-098
Desired Job:Knife Juggler
emailt地址
缺少一个
点号！
类似于电话号码，email地址也有自己的格式，要求我们进行
验证而不仅仅检查是否为空。
就像之前验证电话号码一样，首先需要确定合法email地址必
须遵循的规则。然后可以形式化为一个正则表达式，并在我
们的PHP脚本中实现。所以下面首先来看email地址的具体构
成：
我们知道email地址必须包含这
两个字符。
LocalName@DomainPrefix.DomainSuffix
人这些将包含字母数字字符.其中LocalName
个
这通常是3个字
至少有1个字符，DomainPrelix至少有两个
字符。
母数字字符。
BRAIN
VPOWER
X
PI:EMAIL
看看你能不能给出一个足够灵活的正则表达式，可以匹
PI:EMAIL
配右边的这些email地址。请把你的正则表达式写在下面：
PI:EMAIL
你现在的位置
595
---
## Page 632
email地址的正则表达式
匹配email地址可能很困难
看起来匹配email地址相当简单，因为乍一看，对于可用字符好像没
有电话号码那么多限制。
例如，匹配email地址的LocalName部分（@符号之前的部分）看起来
就不是大问题。因为它只由字母数字组成，应该可以使用以下模式：
以..….…开头
一个或多个字母数字
宇符。
这允许本地名中出现任何字母数字字符，不过遗憾的是，这未能包括
email地址中也合法的其他字符。
不论相信与否，合法的email地址在LocalName部分还可以包含以下任
所有这些字符都可以
出现在emailt地址的
意字符，不过其中一些字符不能用作为email地址的首字符：
LocalName部分。
!$&*
一
?
如果希望允许注册用户的email地址中包含这些字符，就需要类似下面的一个正则表达
式：
/^[a-zA-Z0-9][a-zA-Z0-9\._\-&!?=#]*/
7
T
其余字符可以是其
中任何字…
……这些字符可以有0个或多个。
首字符应当是这些字符
之一。
这并不能匹配每一个合法的LocalName，因为我们还是省
1$&*-=1~#%+/?_0
略了一些相当少见的字符，不过这个正则表达式很实用，
可以匹配大多数RiskyJobs用户的email地址。
596
第10章
---
## Page 633
正则表达式
email的验证很容易。只需要使用本地名
同样的模式来验证城名.问题不大！
这只适用于域名的一部分，即前缀，不过不适用后缀。
类似于LocalName，域前缀可以包含字母数字和一些特殊字符的任
意组合，不过对域后缀的限制则要严格得多。
大多数email地址都以某个常用域后缀结尾：.com、.edu、.org、
gov等。所以我们也需要确保email地址以一个合法的域后缀结尾。
theregareno
DumbQuestions
会生气吗？
也应该这么做。不过，有时最好只是接受常用的格式，而
不必接受每一种可能的变型，你需要确定99.9%的用户会
大多数在线email服务都有自己的限制规则、保证用户不会
有怎样的email，为得到更优化的代码可能不会去验证余下
创建尽管合法但过于疯狂的email地址，如：
的.1%。验证实际上要在允许接受与实际接受之间做一个
'_i'm crazy"@gregs-list.net.
权衡。
如果你确实希望在网站上实现更为健壮的email验证，可以
验证通常是允许接受与实
在这里找到一些很不错的开源（即免费）PHP代码：http://
际接受之间的一个牧衡。
code.google.com/p/php-email-address-validation/,
你现在的位置
597
---
## Page 634
匹配域后缀
域后缀无处不在
除了你经常看到的最为常见的域后缀（如.com和.org），还有
很多很多其他的域后缀在email地址中使用也是合法的。域名系统
（DomainNameSystem，DNS）认为合法的其他后缴包括你之前见过
的.biz和.info。另外，还有一个后缀列表对应不同的国家，如.ca
对应加拿大，.tj对应塔吉克斯坦。
以下只列出了一些可能的域后缀。这并不是全部。
甚至我都不想“要
弄”所有这些城名。
sa.com
gb.net
de
aero
net.nz
ne
uk.ne
in
us.com
uy.com
cn
de.com
cn.com
.uk.com
kr.com
com
.mobi
co.uk
se.net
.museum
TW
ru.con
.com
la
.no.com
com.mx
.me.uk
eu.com
jpn.com
.fm
.org.uk
.br.com
za.com
q5
org.nz
.hu.com
ms
.co.nz
home
con
be
arpa
.org
.at
qc.com
GeekBits
有些城只有两个字母。有些有2个或3个字母。
然后是一个点号，接下来又是2个或3个字母。
有些甚至是4到5个字母。这么说我们需要维护
这些后缀的一个列表来查看是否有匹配吗？
域名系统（DomainName
System）是一个分布式数
据服务，提供世界范围内
可以这么做，这确实可行。
域及其IP地址的一个目录，
使域名的使用成为可能。
不过还有一种更容易的方法。并不需要跟踪所有
如果没有DNS，我们就必
这些可能的域，也不必一且增加新域就修改我们
须键人208.201.239.36而不
的代码，我们可以使用PHP函数checkdnsrr（）
是oreilly.com。
检查email地址的域部分。这个函数连接到域名系
统或DNS，并检查域的合法性。
---
## Page 635
正则表达式
使用PHP检查域
PHP提供了checkdnsrr（）函数来检查一个域是否合法。与使用正则
表达式匹配一个email地址模式相比，这个方法甚至要好，因为它不只
是检查一个文本串是否可能是一个合法的email域，还会具体检查DNS
记录，得出这个域是否已经注册。因此，举例来说，尽管一个正则表
达式可能指出lasdjlkdfsalkjaf.com是合法的，checkdnsrr（）
·则可能更进一步，告诉你实际上这个域并未注册，如果在我们的表单
上输人了PI:EMAIL，我们可能会拒绝
这个email地址。
checkdnsrr（）的语法相当简单：
checkdns（）接收一个包含域名的串。
如果这是一个真实的域则返回1，否则
这是@符号后面的所有内客。
返回0。
checkdnsrr('headfirstlabs.com')
只有当We6服务器是Windows时才存
在这个问题。如果你在使用一个
Windowsi计算机构建网站，但是实际
上金把它发布到一个UNJX/Linux服务
如果在一个Windows服务器上运行PHP，这个命令将不
器，就不存在这个问题。
起作用。
Watchit！在这种情况下，可以使用以下代码：
function win_checkdnsrr($domain,$recType='')
这个exec命今会调用服务
if (!empty($domain))(
器上运行的一个外部程序
if ($recType=='') $recType="Mx";
来检查域。
exec("nslookup -type=$recType $domain",$output);
foreach(Soutput as Sline){
if (preg_match("/^$domain/", $line)){
只是为了好玩，可以尝试在toeach后面回
return true;
显输出Slime。你会看到如下的结果：
Setvet:68.87.64.146Adtess
return false;
68.87.64.146#53Non-aathonitative
answet.oreilly.commailexchange:=20
return false;
smtpf.oreilly.com
你现在的位置
599
---
## Page 636
5步完成email验证
Email验证：集成
我们现在知道了如何使用正则表达式验证email地址的LocalName部分，
也了解了如何使用checkdnsrr（）验证email地址的域部分。下面来逐步
骤地分析如何将这两部分集成起来，为RiskyJobs注册表单增加完整的
email验证：
1
使用preg_match（）确定email地址的LocalName部分是否包含一个合法的字符
注意这个正则表达式末属
模式。
没有美元符，因为@后面还