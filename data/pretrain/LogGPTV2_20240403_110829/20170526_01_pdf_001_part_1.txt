http://www.slideshare.net/kaigai/pgconfasia2016-plcuda
PL/CUDA
~Fusion of HPC Grade Power with In-Database Analytics~
The PG-Strom Project / NEC OSS Promotion Center
KaiGai Kohei 
è‡ªå·±ç»ä»‹
â–ŒKaiGai Kohei
 tw: @kkaigai
 https://github.com/kaigai
â–ŒPostgreSQL
 SELinux, FDW, CustomScan, ...
â–ŒPG-Strom
 GPUã‚’ç”¨ã„ãŸPostgreSQLå‘ã‘
é«˜é€ŸåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œè€…
â–ŒãŠä»•äº‹
 NEC OSSæ¨è¿›ã‚»ãƒ³ã‚¿
 SWå¼€ç™ºï¼ãƒ“ã‚¸ãƒã‚¹å¼€æ‹“
2 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
PG-Stromæ¦‚è¦ (1/2) â€“ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
Application
No Query
Changes
 æœºèƒ½
â€¢ SQLã‹ã‚‰GPUã‚³ãƒ¼ãƒ‰ã‚’è‡ªåŠ¨ç”Ÿæˆã€‚
SQL Parser
â€¢ GPUã«ã‚ˆã‚‹éåŒæœŸ/è¶…å¹¶åˆ—å®Ÿè¡Œ
Query
PG-Strom
â€¢ WHEREå¥ã€JOINã€GROUP BYã€
Optimizer
Extension Projectionã«å¯¾å¿œ
 åˆ©ç‚¹
Query
Executor GPU â€¢ æ•°åƒæ¼”ç®—ã‚³ã‚¢ã‚’ç”¨ã„ãŸé€è¿‡çš„ãª
ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
Storage Manager
â€¢ è§£æç³»ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹
ä½ã‚³ã‚¹ãƒˆã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
No Storage
Storage
Changes
3 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
GPU (Graphic Processor Unit) ã®ç‰¹å¾´
GPU CPU
NVIDIA Intel Xeon
Model
Tesla P100 E5-2699v4
Architecture Pascal Broadwell
Launch Q2-2016 Q1-2016
# of transistors 15billion 7.2billion
3584 22
# of cores
(simple) (functional)
1.126GHz 2.20GHz
core clock
~1.303GHz ~3.60GHz
Perk FFLOPS 1.2 TFLOPS
9.3 TFLOPS
(FP32) (with AVX2)
DRAM Size 16GB (HBM2) max 1.5TB (DDR4)
Memory Band 732GB/s 76.8GB/s
Power
250W 145W
Consumption
4 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
PG-Stromæ¦‚è¦ (2/2) â€“ GPUãƒã‚¤ãƒŠãƒªã®è‡ªåŠ¨ç”Ÿæˆ
QUERY: SELECT cat, count(*), avg(x) FROM t0
WHERE x between y and y + 20.0 GROUP BY cat;
ä¾‹ï¼‰ WHEREå¥ã§ã®è®¡ç®—å¼ã‚’
Just-in-time
CUDAãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å¤‰æ¢ã€‚
Compile
:
STATIC_FUNCTION(bool)
gpupreagg_qual_eval(kern_context *kcxt,
kern_data_store *kds,
Run-time
size_t kds_index)
Compiler
{ Reference to input data
(nvrtc)
pg_float8_t KPARAM_1 = pg_float8_param(kcxt,1);
pg_float8_t KVAR_3 = pg_float8_vref(kds,kcxt,2,kds_index);
pg_float8_t KVAR_4 = pg_float8_vref(kds,kcxt,3,kds_index);
return EVAL((pgfn_float8ge(kcxt, KVAR_3, KVAR_4) &&
pgfn_float8le(kcxt, KVAR_3,
pgfn_float8pl(kcxt, KVAR_4, KPARAM_1))));
} : Parallel
SQL expression in CUDA source code
Execution
5 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
GPUã«ã‚ˆã‚‹SQLå®Ÿè¡Œé«˜é€ŸåŒ–ã®ä¸€ä¾‹
PG-Strom microbenchmark with JOIN/GROUP BY
300
CPU: Xeon E5-2670v3
248.95
250 GPU: GTX1080
]
c
e RAM: 384GB
s
[ 201.12
e 200 OS: CentOS 7.2
m
i DB: PostgreSQL 9.5 +
T
e
s PG-Strom v1.0 144.55
n 150
o
p 119.51
s
e 100.50
R
100
y 79.82
r
e 62.79
u
Q
50 40.44
9.96 9.93 9.96 9.99 10.02 10.03 9.98 10.00
0
2 3 4 5 6 7 8 9
Number of joined tables
PostgreSQL v9.5 PG-Strom v1.0
â–ŒTest Query:
SELECT cat, count(*), avg(x)
FROM t0 NATURAL JOIN t1 [NATURAL JOIN t2 ...]
GROUP BY cat;
 t0 contains 100M rows, t1...t8 contains 100K rows (like a start schema)
6 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
v1.0å¼€ç™ºè¿‡ç¨‹ã«ãŠã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
Application
SQL Parser
è®¡ç®—é›†çº¦çš„ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰
Query
PG-Strom
â€¢ In-database Analytics
Optimizer
Extension â€¢ ç§‘å­¦æŠ€æœ¯è®¡ç®—ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°
 by PL/CUDA + Matrix-Array
Query
Executor GPU
Storage Manager
I/Oé›†çº¦çš„ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰
â€¢ æ³›ç”¨ã®å¤§è§„æ¨¡OLAP
â€¢ ETLã€ãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°
Storage
 by SSD-to-GPU P2P DMA
7 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
Introduction of PL/CUDA
8 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
å¤±è´¥ã‹ã‚‰å­¦ã¶ (1/3) â€“ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’SQLã§è®°è¿°ã™ã‚‹
Apr-2016
9 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
å¤±è´¥ã‹ã‚‰å­¦ã¶ (2/3) â€“ æ€§èƒ½ä¸Šã®ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ (?)
Apr-2016
10 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
å¤±è´¥ã‹ã‚‰å­¦ã¶ (3/3) â€“ é—®é¢˜ç‚¹
â–Œé—®é¢˜â‘  â€“ SQLã§ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è®°è¿°ã™ã‚‹äººãªã‚“ã¦ã„ãªã„ã€‚
 ãã‚‚ãã‚‚ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å¤§åŠã¯æ‰‹ç¶šãå‹è¨€è¯­ã‚’å‰æã¨ã—ã¦å¼€ç™ºã•ã‚Œã¦ã„ã‚‹ã€‚
 ãƒ¦ãƒ¼ã‚¶ãŒCUDAã§ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ ¸ã‚’è®°è¿°ã™ã‚‹å¿…è¦ãŒãªã„ã¨ã—ã¦ã‚‚ã€
ã“ã‚Œã¯æ¨©å±€ã€SQLã®ãƒ‘ã‚ºãƒ«ã‚’è€ƒãˆãªãŒã‚‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è®°è¿°
ã—ã¦ã„ã‚‹ã®ã¨åŒã˜äº‹ã€‚
â–Œé—®é¢˜â‘¡ â€“ æ€§èƒ½ä¸Šã®ãƒ¡ãƒªãƒƒãƒˆã¯æœ¬å½“ã«ã‚ã£ãŸï¼Ÿ
 Min-Maxæ³•ã®è·ç¦»è®¡ç®—ã«ãŠã„ã¦ã€ç¡®ã‹ã«PG-Stromã®å®Ÿè¡Œæ€§èƒ½ã¯
PostgreSQLã‚’é¥ã‹ã«ä¸Šå›ã£ã¦ã„ã‚‹ãŒã€ãã‚‚ãã‚‚ã€ã“ã®ç§ã®è®¡ç®—ã‚’
PostgreSQLã§è¡Œã£ã¦ã„ã‚‹äººã£ã¦ã„ãªã„ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿ
 GpuProjectionã®æ€§èƒ½ã¯ã€ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«è®¾è®¡ã•ã‚ŒãŸ
CPUç‰ˆã®å¤–éƒ¨ã‚¢ãƒ—ãƒªã®æ€§èƒ½ã¨æ¦‚ã­åŒç­‰ã ã£ãŸã€‚ãªãœï¼Ÿ
SQLäº’æ¢æ€§ã«ç”±æ¥ã™ã‚‹éæ•ˆç‡æ€§
PostgreSQLã®è¡Œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ç”±æ¥ã™ã‚‹éæ•ˆç‡æ€§
11 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
è§£å†³ç­– â€“ PL/CUDA + Array-Matrix
PL/CUDA
Post SQL Process
æ‰‹åŠ¨ã§ã®æœ€é€‚åŒ–æ‰‹æ®µ
 Tables JOIN  ORDER BY
 Window  GROUP BY
CREATE FUNCTION my_logic(matrix, matrix) Function  etc....
RETURNS vector ç»“æœã‚»ãƒƒãƒˆã®
AS $$ ä¹¦ãæˆ»ã—
GPU Kernel
ãƒ¦ãƒ¼ã‚¶å®šä¹‰ã®CUDAã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
ãƒ¦ãƒ¼ã‚¶å®šä¹‰ã®
CUDAã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
$$ LANGUAGE â€˜plcudaâ€™;
é–¢æ•°ã®å¼•æ•°ã‚’
ãƒ­ãƒ¼ãƒ‰
Array-Matrix
éNULLã®2æ¬¡å…ƒé…åˆ—ã‚’â€œè¡Œåˆ—â€ã¨è§£é‡ˆ
ğ‘ â‹¯ ğ‘‘ Storage
1 1
â‹® â‹± â‹® 4åˆ—Nè¡Œ è¡Œåˆ—
ğ‘ â‹¯ ğ‘‘
ğ‘ ğ‘
ArrayType ãƒ˜ãƒƒãƒ€ a a a b b b c c c d d d
1 2 â€¦ N 1 2 â€¦ N 1 2 â€¦ N 1 2 â€¦ N
12 PGconf.ASIA - PL/CUDA / Fusion of HPC Grade Power with In-Database Analytics The PG-Strom Project
PL/CUDAé–¢æ•°å®šä¹‰ã®ä¾‹
CREATE OR REPLACE FUNCTION
knn_gpu_similarity(int, int[], int[]) CUDA code block
RETURNS float4[]
AS $$
#plcuda_begin
cl_int k = arg1.value;
MatrixType *Q = (MatrixType *) arg2.value;
MatrixType *D = (MatrixType *) arg3.value;
MatrixType *R = (MatrixType *) results;
:
nloops = (ARRAY_MATRIX_HEIGHT(Q) + (part_sz - k - 1)) / (part_sz - k);
for (loop=0; loop e, result,
isinf(arg1.value) || isinf(arg2.value),
arg1.value == 0.0 || arg2.value == 0.0);