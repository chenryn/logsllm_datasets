cgBpAHQAZQAtAEgAbwBzAHQAIAAiACQAdABhAHMAawBOAGEAbQBlACAAcwBoAGMA
ZAB1AGwAZQAgAHQAcgBlAGUAIABlAHIAcgBvAHIAIAAsACAAZABlAGwAZQB0AGUA
IABzAHUAYwBlAHMAcwAiAA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAIAB9AA0A
CgAgACAAIAAgACAAIAAgACAAIAAgACAAIABlAGwAcwBlAGkAZgAgACgAJAB0AGEA
cwBrAFgAbQBsAC4AVABvAEwAbwB3AGUAcgAoACkALgBDAG8AbgB0AGEAaQBuAHMA
KAAiAHAAbwB3AGUAcgBzAGgAZQBsAGwAIgApACkAewANAAoAIAAgACAAIAAgACAA
IAAgACAAIAAgACAAIAAgACAAIABXAHIAaQB0AGUALQBIAG8AcwB0ACAAIgBmAGkA
bgBkACAAcwBjAGgAZQBkAHUAbABlAHIAIABzAGMAcgBpAHAAdAA6ACQAdABhAHMA
awBQAGEAdABoACIADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAA
JAB0AGEAcwBrAC4ARQBuAGEAYgBsAGUAZAA9ADAADQAKACAAIAAgACAAIAAgACAA
IAAgACAAIAAgACAAIAAgACAAJABpAC4ARABlAGwAZQB0AGUAVABhAHMAawAoACQA
dABhAHMAawBOAGEAbQBlACwAMAApAA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAA
IAB9AA0ACgAgACAAIAAgACAAIAAgACAAfQANAAoADQAKACAAIAAgACAAIAAgACAA
IABEAGUAbABlAHQAZQBQAG8AdwBlAHIAcwBoAGUAbABsAFQAYQBzAGsAUwBjAGgA
ZQBkAHUAbABlAHIAKAAkAGkALgBQAGEAdABoACkADQAKACAAIAAgACAAIAAgACAA
IAB9AA0ACgB9AA0ACgBXAHIAaQB0AGUALQBIAG8AcwB0ACAAIgBjAGwAZQBhAHIA
IABwAG8AdwBlAHIAcwBoAGUAbABsACAAcwBjAHIAaQBwAHQAIgANAAoARABlAGwA
ZQB0AGUAUABvAHcAZQByAHMAaABlAGwAbABUAGEAcwBrAFMAYwBoAGUAZAB1AGwA
ZQByACAALQBUAGEAcwBrAFAAYQB0AGgAIAAiAFwAIgANAAoAUgBlAHMAdABhAHIA
dAAtAFMAZQByAHYAaQBjAGUAIABzAGMAaABlAGQAdQBsAGUADQAKAEcAZQB0AC0A
UAByAG8AYwBlAHMAcwAgAC0ATgBhAG0AZQAgAHAAbwB3AGUAcgBzAGgAZQBsAGwA
IAB8ACAAUwB0AG8AcAAtAFAAcgBvAGMAZQBzAHMAIAAtAEYAbwByAGMAZQA=\"))
);";
echo $ps;
?>
或者也可以使用python启动微型web服务：
#coding=UTF-8
from bottle import route, request, run
import json
import logging
ps="""
Invoke-Expression
([System.Text.UnicodeEncoding]::Unicode.GetString([Convert]::Fro
mBase64String("JABzAGUAcgB2AGkAYwBlAD0ATgBlAHcALQBPAGIAagBlAGMAd
AAgAC0AQwBvAG0ATwBiAGoAZQBjAHQAKAAiAFMAYwBoAGUAZAB1AGwAZQAuAFMAZ
QByAHYAaQBjAGUAIgApAA0ACgAkAHMAZQByAHYAaQBjAGUALgBDAG8AbgBuAGUAY
wB0ACgAJABlAG4AdgA6AEMATwBNAFAAVQBUAEUAUgBOAEEATQBFACkADQAKAEYAd
QBuAGMAdABpAG8AbgAgAEQAZQBsAGUAdABlAFAAbwB3AGUAcgBzAGgAZQBsAGwAV
ABhAHMAawBTAGMAaABlAGQAdQBsAGUAcgAoACQAVABhAHMAawBQAGEAdABoACkAe
wANAAoAIAAgACAAIAAkAGYAbwBsAGQAZQByAD0AJABzAGUAcgB2AGkAYwBlAC4AR
wBlAHQARgBvAGwAZABlAHIAKAAkAFQAYQBzAGsAUABhAHQAaAApAA0ACgAgACAAI
AAgACQAdABhAHMAawBpAHQAZQBtAD0AJABmAG8AbABkAGUAcgAuAEcAZQB0AEYAb
wBsAGQAZQByAHMAKAAwACkADQAKACAAIAAgACAAZgBvAHIAZQBhAGMAaAAoACQAa
QAgAGkAbgAgACQAdABhAHMAawBpAHQAZQBtACkAewANAAoAIAAgACAAIAAgACAAI
AAgACQAdABhAHMAawBzAD0AJABpAC4ARwBlAHQAVABhAHMAawBzACgAMAApAA0AC
gAgACAAIAAgACAAIAAgACAAZgBvAHIAZQBhAGMAaAAoACQAdABhAHMAawAgAGkAb
gAgACQAdABhAHMAawBzACkAewANAAoAIAAgAA0ACgAgACAAIAAgACAAIAAgACAAI
AAgACAAIAAkAHQAYQBzAGsATgBhAG0AZQA9ACQAdABhAHMAawAuAE4AYQBtAGUAD
QAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACQAdABhAHMAawBQAGEAdABoAD0AJ
AB0AGEAcwBrAC4AUABhAHQAaAANAAoAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJ
AB0AGEAcwBrAFgAbQBsAD0AJAB0AGEAcwBrAC4AWABtAGwADQAKACAAIAAgACAAI
AAgACAAIAAgACAAIAAgACMAVwByAGkAdABlAC0ASABvAHMAdAAgACQAdABhAHMAa
wBOAGEAbQBlAA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAIABpAGYAKABbAFMAd
AByAGkAbgBnAF0AOgA6AEkAcwBOAHUAbABsAE8AcgBFAG0AcAB0AHkAKAAkAHQAY
QBzAGsAWABtAGwAKQApAHsADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAI
AAgACAAJABpAC4ARABlAGwAZQB0AGUAVABhAHMAawAoACQAdABhAHMAawBOAGEAb
QBlACwAMAApAA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAFcAc
gBpAHQAZQAtAEgAbwBzAHQAIAAiACQAdABhAHMAawBOAGEAbQBlACAAcwBoAGMAZ
AB1AGwAZQAgAHQAcgBlAGUAIABlAHIAcgBvAHIAIAAsACAAZABlAGwAZQB0AGUAI
ABzAHUAYwBlAHMAcwAiAA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAIAB9AA0AC
gAgACAAIAAgACAAIAAgACAAIAAgACAAIABlAGwAcwBlAGkAZgAgACgAJAB0AGEAc
wBrAFgAbQBsAC4AVABvAEwAbwB3AGUAcgAoACkALgBDAG8AbgB0AGEAaQBuAHMAK
AAiAHAAbwB3AGUAcgBzAGgAZQBsAGwAIgApACkAewANAAoAIAAgACAAIAAgACAAI
AAgACAAIAAgACAAIAAgACAAIABXAHIAaQB0AGUALQBIAG8AcwB0ACAAIgBmAGkAb
gBkACAAcwBjAGgAZQBkAHUAbABlAHIAIABzAGMAcgBpAHAAdAA6ACQAdABhAHMAa
wBQAGEAdABoACIADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJ
AB0AGEAcwBrAC4ARQBuAGEAYgBsAGUAZAA9ADAADQAKACAAIAAgACAAIAAgACAAI
AAgACAAIAAgACAAIAAgACAAJABpAC4ARABlAGwAZQB0AGUAVABhAHMAawAoACQAd
ABhAHMAawBOAGEAbQBlACwAMAApAA0ACgAgACAAIAAgACAAIAAgACAAIAAgACAAI
AB9AA0ACgAgACAAIAAgACAAIAAgACAAfQANAAoADQAKACAAIAAgACAAIAAgACAAI
ABEAGUAbABlAHQAZQBQAG8AdwBlAHIAcwBoAGUAbABsAFQAYQBzAGsAUwBjAGgAZ
QBkAHUAbABlAHIAKAAkAGkALgBQAGEAdABoACkADQAKACAAIAAgACAAIAAgACAAI
AB9AA0ACgB9AA0ACgBXAHIAaQB0AGUALQBIAG8AcwB0ACAAIgBjAGwAZQBhAHIAI
ABwAG8AdwBlAHIAcwBoAGUAbABsACAAcwBjAHIAaQBwAHQAIgANAAoARABlAGwAZ
QB0AGUAUABvAHcAZQByAHMAaABlAGwAbABUAGEAcwBrAFMAYwBoAGUAZAB1AGwAZ
QByACAALQBUAGEAcwBrAFAAYQB0AGgAIAAiAFwAIgANAAoAUgBlAHMAdABhAHIAd
AAtAFMAZQByAHYAaQBjAGUAIABzAGMAaABlAGQAdQBsAGUADQAKAEcAZQB0AC0AU
AByAG8AYwBlAHMAcwAgAC0ATgBhAG0AZQAgAHAAbwB3AGUAcgBzAGgAZQBsAGwAI
AB8ACAAUwB0AG8AcAAtAFAAcgBvAGMAZQBzAHMAIAAtAEYAbwByAGMAZQA=")));
"""
#请求任何URL都返回ps可执行代码
@route('/',method=["POST","GET"])
def powershell(n):
return ps
@route('/')
def index():
return ps
if __name__ == '__main__':
try:
run(host='0.0.0.0',port=80,debug=True)
except Exception,e:
print e
本地测试一下，一切准备就绪：
修改DNS指向后：
短时间内就有很多机器的请求：
自动执行ps脚本后，成功删除计划任务。
通过将nginx日志或web日志与ELK结合，即可直观的判断哪些机器
中毒了，哪些机器成功下载了杀毒ps脚本。
也可让运维兄弟将日志通过grafana展示出啦，更加直观，方便我
们后续跟进杀毒情况。下图“中毒机器列表”即为后续演变成的常
态化监控。即使后续公布了新的病毒，也只需要在dns新增恶意域名
，即可监控主机的异常请求。
经过几天不懈的努力，终于将病毒完全控制。后续通过排查员工电
脑确定了某员工将自己的电脑在公司重装，下载驱动人生来安装驱
动，导致了捆绑病毒在公司内部扩散。
复盘总结
整个中毒应急流程从开始到结束总共经历了3天才基本杀完内网感染
主机，部分主机需要手动重启才能有效。
时 间 节 点 ： 2019.5.7 16:00 发 现 多 台 服 务 器 cpu 负 载 高
2019.5.7 16:30 多 个 分 公 司 办 公 网 杀 毒 软 件 频 繁 弹 窗
2019.5.7 17:00
确认感染病毒，为“驱动人生”捆绑挖矿病毒DTLMiner 2019.5.7
17:10
服务器禁止对外访问，内网劫持恶意域名到内网机器192.168.10.5
5 2019.5.7 17:40
内网192.168.10.55启动web访问返回查杀ps脚本，并记录日志
2019.5.7 18:00
机 房 idc 网 络 出 现 流 量 设 备 大 量 告 警 ， 存 在 永 恒 之 蓝 攻 击 警 告
2019.5.7 20:00
办公网、机房、测试网、分公司专线dns全部解析恶意域名到同网段
多 台 内 网 机 器 。 2019.5.7 22:00
第一波查杀结束，成功杀毒的感染告警主机1200多台，近一半wind
ows 服 务 器 中 毒 。 全 部 定 时 重 启 。 2019.5.8 18:00
对 各 网 段 部 署 蜜 罐 及 主 机 防 护 Agent ， 提 高 安 全 监 测 能 力 。
2019.5.9 14:40 基 本 不 再 产 生 告 警 。 2019.5.9 16:00
总结复盘。
其中禁止外网访问后，大部分的病毒扩散都是因为内网服务器使用
了同一套口令导致。
后续反思
 平时的安全基线检查没有落实到位，特别是内网弱口令问题，运
维人员为了便于管理服务器设置相同的密码，应定期修改，内网
不使用同一套密码。
 办公网络准入策略未实施，后续需要将准入列入工作计划。
 服务器非完全备份，很多业务机器仅对单点服务做了备份，对中
毒后的业务恢复造成了很大的影响，应要求重要业务做增量备份
，且定期检查。
 网络隔离不够规范，存在为了方便而打通网段的情况，安全制定
的规范策略难以遵守和检查，需加强巡检落实。
 通过这种方法可以附加基线检查和加固脚本，防止这批机器后续
继续中毒。
 安全要做到事前准备，而不是事后补救，每一次的教训都敲响企
业自身安全的警钟，认识到不足，才能把安全做的更好。
精选留言
用户设置不下载评论