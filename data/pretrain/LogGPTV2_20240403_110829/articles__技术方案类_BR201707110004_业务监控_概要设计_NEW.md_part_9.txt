|           |           |      | 值对输出，输出格  |                 |
|           |           |      | 式为：TaskID=ID1, |                 |
|           |           |      | TaskID=ID2,       |                 |
|           |           |      | TaskID=ID3\       |                 |
|           |           |      | 2、               |                 |
|           |           |      | Tra               |                 |
|           |           |      | ceFlag，格式为：T |                 |
|           |           |      | raceFlag=\*\*\*\* |                 |
|           |           |      | (取值为二进制数)\ |                 |
|           |           |      | 3、               |                 |
|           |           |      | 调用链            |                 |
|           |           |      | 组标识GroupID，BE |                 |
|           |           |      | S中对应为业务交易 |                 |
|           |           |      | 流水号，格式为：  |                 |
|           |           |      | GroupID=\*\*\*\*\ |                 |
|           |           |      | 4、               |                 |
|           |           |      | 调用链            |                 |
|           |           |      | 组名称GroupName， |                 |
|           |           |      | BES中对应为业务交 |                 |
|           |           |      | 易类型名，即Entr  |                 |
|           |           |      | yMenu，格式为：Gr |                 |
|           |           |      | oupName=\*\*\*\*\ |                 |
|           |           |      | 5、               |                 |
|           |           |      | 调用链子          |                 |
|           |           |      | 组标识SubGroupID  |                 |
|           |           |      | ，BES中对应为步骤 |                 |
|           |           |      | 标识，格式为：Su  |                 |
|           |           |      | bGroupID=\*\*\*\* |                 |
+-----------+-----------+------+-------------------+-----------------+
| ProdInfo  | varchar   | 可选 | 打印订单          | 格式：          |
|           | (max      |      | 中的产品信息，包  |                 |
|           | 10240)    |      | 括产品ID、产品名  | OR              |
|           |           |      | 称，操作类型、产  | DERPRODINFO=pro |
|           |           |      | 品订购失败内容（  | did1\[prodname1 |
|           |           |      | 响应报文时才有）  | \]\^OperType1\$ |
|           |           |      | ，该字段可为空。  | \$prodid2\[prod |
|           |           |      |                   | name2\]\^OperTy |
|           |           |      | 通过KEY=value格式 | pe2@@ORDERERRIN |
|           |           |      |                   | FO=\*\*\*\*\*\* |
|           |           |      |                   |                 |
|           |           |      |                   | 例：            |
|           |           |      |                   |                 |
|           |           |      |                   | ORDERPRODINFO   |
|           |           |      |                   | =prod.100000000 |
|           |           |      |                   | 66661\[手机宽带 |
|           |           |      |                   | 基础产品包\]\^  |
|           |           |      |                   | N\$\$prod.10000 |
|           |           |      |                   | 000066663\[手机 |
|           |           |      |                   | 宽带基础产品\]  |
|           |           |      |                   | \^N\$\$prod.100 |
|           |           |      |                   | 86000003846\[手 |
|           |           |      |                   | 机宽带90元月租  |
|           |           |      |                   | 套餐（省统）\]  |
|           |           |      |                   | \^N@@ORDERERRIN |
|           |           |      |                   | FO=用户已开通产 |
|           |           |      |                   | 品\[prod.100000 |
|           |           |      |                   | 00066661:手机宽 |
|           |           |      |                   | 带基础产品包\]  |
|           |           |      |                   | ,无需重复开通！ |
+-----------+-----------+------+-------------------+-----------------+
#### 【修改】CRM_IM_007 订单校验接口调用链日志打印逻辑（四期）
修改CRM_IM_007订单校验接口，在CICS服务端打印服务调用链日志时，判断系统参数CtrlServCallPrintProdInfo值是否为1，如果不是，则保持当前逻辑不变，如果是1，则增加打印订单产品信息，从请求对象CintRequest中获取订购产品列表，从列表中只取本次操作订购和退订的产品信息，包括产品ID、产品名称、操作类型，从响应对象RIntResponse对象中获取订单失败内容，组装订购产品信息打印信息，响应日志
采用KEY=VALUE格式，格式如下：
ORDERPRODINFO=prodid1\[prodname1\]\^OperType1\$\$prodid2\[prodname2\]\^OperType2@@ORDERERRINFO=\*\*\*\*\*\*
说明：
1、订单产品信息的KEY为ORDERPRODINFO,订单错误信息的KEY为ORDERERRINFO;
2、订单产品信息内容格式为：产品1ID\[产品1名称\]\^操作类型\$\$产品2ID\[产品2名称\]\^操作类型，产品之间通过\$\$符号分隔，产品名称和操作类型之间使用\^符号分隔；
3、KEY之间通过@@符号分隔
4、操作类型：N:订购；D:退订
5、请求时，ORDERERRINFO的值可为空，响应时，如果请求失败则要将失败信息打印到ORDERERRINFO键值中。
例：
ORDERPRODINFO=prod.10000000066661\[手机宽带基础产品包\]\^N\$\$prod.10000000066663\[手机宽带基础产品\]\^N\$\$prod.10086000003846
\[手机宽带90元月租套餐（省统）\]\^N@@ORDERERRINFO=用户已开通产品\[prod.10000000066661:手机宽带基础产品包\],无需重复开通！
#### 【修改】产品校验OPCODE调用链日志打印逻辑（四期）
修改产品校验OPCODE：PCProdRecCheck，在CICS服务端打印服务调用链日志时，判断系统参数CtrlServCallPrintProdInfo值是否为1，如果不是，则保持当前逻辑不变，如果是1，则增加打印订单产品信息，从请求对象CintRequest中获取订购产品列表，从列表中只取本次操作订购和退订的产品信息，包括产品ID、产品名称、操作类型，从响应对象RIntResponse对象中获取订单失败内容，组装订购产品信息打印信息，响应日志
采用KEY=VALUE格式，格式如下：
ORDERPRODINFO=prodid1\[prodname1\]\^OperType1\$\$prodid2\[prodname2\]\^OperType2@@ORDERERRINFO=\*\*\*\*\*\*
说明：
1、订单产品信息的KEY为ORDERPRODINFO,订单错误信息的KEY为ORDERERRINFO;
2、订单产品信息内容格式为：产品1ID\[产品1名称\]\^操作类型\$\$产品2ID\[产品2名称\]\^操作类型，产品之间通过\$\$符号分隔，产品名称和操作类型之间使用\^符号分隔；
3、KEY之间通过@@符号分隔
4、操作类型：N:订购；D:退订
5、请求时，ORDERERRINFO的值可为空，响应时，如果请求失败则要将失败信息打印到ORDERERRINFO键值中。
例：
ORDERPRODINFO=prod.10000000066661\[手机宽带基础产品包\]\^N\$\$prod.10000000066663\[手机宽带基础产品\]\^N\$\$prod.10086000003846
\[手机宽带90元月租套餐（省统）\]\^N@@ORDERERRINFO=
#### 【修改】产品校验OPCODE调用链日志打印逻辑（四期）
修改订单校验OPCODE：CSRecCheckOrder，在CICS服务端打印服务调用链日志时，判断系统参数CtrlServCallPrintProdInfo值是否为1，如果不是，则保持当前逻辑不变，如果是1，则增加打印订单产品信息，从请求对象CintRequest中获取订购产品列表，从列表中只取本次操作订购和退订的产品信息，包括产品ID、产品名称、操作类型，从响应对象RIntResponse对象中获取订单失败内容，组装订购产品信息打印信息，响应日志
采用KEY=VALUE格式，格式如下：
ORDERPRODINFO=prodid1\[prodname1\]\^OperType1\$\$prodid2\[prodname2\]\^OperType2@@ORDERERRINFO=\*\*\*\*\*\*
说明：
1、订单产品信息的KEY为ORDERPRODINFO,订单错误信息的KEY为ORDERERRINFO;
2、订单产品信息内容格式为：产品1ID\[产品1名称\]\^操作类型\$\$产品2ID\[产品2名称\]\^操作类型，产品之间通过\$\$符号分隔，产品名称和操作类型之间使用\^符号分隔；
3、KEY之间通过@@符号分隔
4、操作类型：N:订购；D:退订
5、请求时，ORDERERRINFO的值可为空，响应时，如果请求失败则要将失败信息打印到ORDERERRINFO键值中。
例：
ORDERPRODINFO=prod.10000000066661\[手机宽带基础产品包\]\^N\$\$prod.10000000066663\[手机宽带基础产品\]\^N\$\$prod.10086000003846
\[手机宽带90元月租套餐（省统）\]\^N@@ORDERERRINFO=
### 业务监控日志文件平台
业务调用链日志采集方案一：filebeat+logstarsh
#### Filebeat简介
filebeat是一个日志文件托运工具，在你的服务器上安装客户端后，filebeat会监控日志目录或者指定的日志文件，追踪读取这些文件（追踪文件的变化，不停的读），并且转发这些信息到elasticsearch或者logstarsh中存放。
以下是filebeat的工作流程：当你开启filebeat程序的时候，它会启动一个或多个探测器（prospectors）去检测你指定的日志目录或文件，对于探测器找出的每一个日志文件，filebeat启动收割进程（harvester），每一个收割进程读取一个日志文件的新内容，并发送这些新的日志数据到处理程序（spooler），处理程序会集合这些事件，最后filebeat会发送集合的数据到你指定的地点。
![](media/image22.png){width="5.768055555555556in"
height="2.3631944444444444in"}
1、
NGCRM、NGBOSS前台WAS应用、后台CICS服务、后台进程应用运行过程中将业务调用链日志写入本地服务器日志文件，在各应用主机部署日志实时采集程序filebeat，并配置filebeat业务日志的输入路径、文件名称，以及日志信息输出方式及IP、端口等信息。
2、
filebeat实时读取日志文件变更信息，并将日志信息实时写入业务监控日志服务器的logstash目录。通过logstash程序将filebeat写入的日志实时写入业务监控日志服务器的本地文件。
3、
在业务监控日志服务器部署BOMC采集代理程序，实时将调用链日志信息采集到BOMC服务器做日志分析和查询展示。
#### 采集器filebeat部署
> 配置采集器filebeat扫描的目录文件。
>
> 实时日志采集器配置：
>
> paths:
>
> \- /hwapp/NGCRM/cicslog/ZJ-NGCRM-CICS-TRACELOG-20180108\*.log
> #指明读取文件的位置
>
> output.logstash: #使用logstash对filebeat收集起来的数据执行其他处理
>
> hosts: \[\"logstash.xxx.xxx.xxx.xxx:xxxx\"\]
> #hosts选项需要指明logstash服务所监听的地址和它的端口
注：logstash将所监听的端口传入的数据写到本地磁盘文件。
#### logstash部署配置
> 业务监控日志服务器部署logstash应用，并监听xxxx端口，对于此端口写入的数据写入到本地磁盘的日志文件中：
**文件名称：**AA-NGXXX-BBB-TRACELOG.log.YYYYMMDD.nnn
其中
AA：地市编码简写，如广州:GZ
NGXXX：应用系统，如NGCRM、NGBOSS
BBB：应用服务，如WAS、CICS
YYYYMMDD：年月日，如20171121
nnn：文件序列号，如001，002递增
**文件路径：**
/xxx/logs/%{basepath}/%{host}/%{foldername}/%{filename}.%{suffix}
业务调用链日志采集方案二：FTP 工具RBI
![](media/image23.png){width="5.768055555555556in"
height="4.805555555555555in"}
程序特性：
1、FTP采集工具部署在业务监控日志文件服务器，采用pull的方式：定时（可配置时间间隔）到目标机器取文件（文件名称匹配规则可配置）。
2、可将当前接口机的文件分发到其他目标机器，分法策略可以配置。
### ~~业务配置平台~~
#### ~~业务配置新增日志服务模块功能~~
##### ~~日志数据采集~~
~~由于业务调用链日志散落在各节点CRM、节点BOSS应用服务器上，包括CRM
WEB、CRM WAS、CRM CICS、CRM APP、BOSS
CICS等，需要新增日志采集程序FTP上传到业务配置平台接口文件服务器主机进行汇总，然后由业务配置平台对日志文件数据入库。上传成功后各应用节点将原始日志文件删除，以减少到存储的占用。~~
![](media/image24.emf)
~~业务配置平台文件服务器信息:~~
~~IP地址：~~
~~账号：~~
~~密码：~~
~~文件目录：~~
~~业务配置平台数据库、应用主机容量评估：~~
~~目前业务配置平台的服务器如下：~~
  ------------------------------------------------------------------------------------------------------------------------------------------------------------
  ~~省中心独立模块-业务配置平台~~   ~~NF8460M3~~    ~~核心~~   ~~GDNG3CFG_DB1~~    ~~业务数据库~~       ~~32~~   ~~512~~   ~~4光(10GE)+2电~~   ~~16\*900(SAS
                                                                                                                                               RAID10)~~
  --------------------------------- --------------- ---------- ------------------- -------------------- -------- --------- ------------------- ---------------
                                    ~~NF8460M3~~    ~~核心~~   ~~GDNG3CFG_DB2~~    ~~业务数据库~~       ~~32~~   ~~512~~   ~~4光(10GE)+2电~~   ~~16\*900(SAS
                                                                                                                                               RAID10)~~
                                    ~~RH2288HV2~~   ~~核心~~   ~~GDNG3CFG_WAS1~~   ~~WAS应用服务器~~    ~~16~~   ~~256~~   ~~2光2电~~          ~~7\*240~~
                                    ~~RH2288HV2~~   ~~核心~~   ~~GDNG3CFG_WAS2~~   ~~WAS应用服务器~~    ~~16~~   ~~256~~   ~~2光2电~~          ~~7\*240~~
                                    ~~RH2288HV2~~   ~~中立~~   ~~GDNG3CFG_WEB1~~   ~~WEB服务器~~        ~~16~~   ~~256~~   ~~2光2电~~          ~~7\*240~~
                                    ~~RH2288HV2~~   ~~中立~~   ~~GDNG3CFG_WEB2~~   ~~WEB服务器~~        ~~16~~   ~~256~~   ~~2光2电~~          ~~7\*240~~
                                    ~~RH2288HV2~~   ~~中立~~   ~~GDNG3CFG_FS1~~    ~~接口文件服务器~~   ~~16~~   ~~256~~   ~~4光2电~~          ~~7\*240~~
                                    ~~RH2288HV2~~   ~~中立~~   ~~GDNG3CFG_FS2~~    ~~接口文件服务器~~   ~~16~~   ~~256~~   ~~4光2电~~          ~~7\*240~~
                                    ~~NF8460M3~~    ~~核心~~   ~~GDNG3CFG_APP1~~   ~~后台进程服务器~~   ~~32~~   ~~512~~   ~~4光2电~~          ~~4\*900
                                                                                                                                               (RAID5)~~
                                    ~~NF8460M3~~    ~~核心~~   ~~GDNG3CFG_APP2~~   ~~后台进程服务器~~   ~~32~~   ~~512~~   ~~4光2电~~          ~~4\*900
                                                                                                                                               (RAID5)~~
  ------------------------------------------------------------------------------------------------------------------------------------------------------------
~~    当前系统比较空闲，数据库共有7TB，目前使用1TB；~~
~~业务监控的存储根据业务量和日志量评估后共需要3179GB，从容量来看是已满足存储，目前评估不需要对业务配置平台进行扩容。~~