你背叛我!
不可测量!
利用CVE-2017-16837的情景(1)
Compromised Software Stack
(1）在事件日志中保留正常哈希值
BIOS/UEFI
Sleep
(5) Sleep
Compromised Software Stack
(6) Wake up
（2）提取并计算正常哈希值
（3）将正常哈希值存储在RAM中
DCE and DLME (tboot)
（5）重置TPM并用钩子函数重放正常哈希值
（4）DCE和DLME中的钩子函数指针
Hooked
functions
DCE and DLME (tboot)
Faked State (Normal State)
Compromised State
Hash
values
利用CVE-2017-16837的情景(2)
BIOS/UEFI
tboot
GRUB
Compromised
Kernel
User
Application
TPM           
Remote
Attestation
Server
Abnormal
PCRs
Nonce
Sig(PCRs, Nonce) AIK
利用CVE-2017-16837的情景(3)
BIOS/UEFI
tboot
GRUB
User
Application
TPM           
Remote
Attestation
Server
Abnormal
PCRs
Nonce
Sig(PCRs, Nonce) AIK
Compromised
Kernel
Replay Good Hashes
使用Sleep重置TPM
Normal
PCRs
~~
Happiness
0
5
10
- 10
- 5
- 1000
- 100
2017
2018
2019
Time
(year)
First Encounter
Second Encounter
CVE-2017-
16837
CVE-2018-
6622
USENIX
Security
Black Hat
Asia
Black Hat Asia
with Napper
内容- CVE-2018-6622
DRTM在唤醒时测量代码！
SRTM怎么样？?
唤醒SRTM的过程
OS
ACPI
(BIOS/UEFI)
TPM
(1) 要求保存状态
Sleep
(S3)
(5) 要求恢复状态
(2) 要求进入休
眠状态
(4) 唤醒
(3) 休眠
(6) 继续 OS
“灰色地带”漏洞（1）
（CVE-2018-6622）
OS
ACPI
(BIOS/UEFI)
TPM
(1) 要求保存状态
Sleep
(S3)
(5) 要求恢复状态
(2) 要求进入休
眠模式
(4) 唤醒
(3) 休眠
(6) 继续 OS
“灰色地带”漏洞（2）
（CVE-2018-6622）
什么是“纠正措施”？
这意味着“重置TPM”
TPM 2.0
TPM 1.2
“Grey Area” Vulnerability (2)
(CVE-2018-6622)
What is the “corrective action”?
This means “reset the TPM”
TPM 2.0
TPM 1.2
??
你背叛我!
我不知道“纠正措施”
我什么都做不了!
“灰色地带”漏洞（2）
（CVE-2018-6622）
什么是“纠正措施”？
这意味着“重置TPM”
TPM 2.0
TPM 1.2
安全!
利用CVE-2018-6622的方案
Compromised Software Stack
(1 )在事件日志中保留正常哈希值
Compromised State
BIOS/UEFI
Sleep
（4）休眠而不保存TPM状态
Compromised Software Stack
(5) Wake up
Faked State (Normal State)
（2）提取并计算正常哈希值
（6）重置TPM并重放正常的哈希值
（3）将正常哈希值存储在RAM中
Hash
values
~~
Happiness
0
5
10
- 10
- 5
- 1000
- 100
2017
2018
2019
Time
(year)
First Encounter
Second Encounter
CVE-2017-
16837
CVE-2018-
6622
USENIX
Security
Black Hat
Asia
Black Hat Asia
with Napper
内容 - “Napper”
又是你！
经理
二次遭遇!!!
“Napper”?
- 是否可以检查TPM中的ACPI S3睡眠模式漏洞的工具
- 它是一个基于Ubuntu 18.04的可启动USB设备
- 它有一个内核模式和用户态应用程序
- 使系统“小睡”并检查漏洞
- 内核模块通过修补内核代码在休眠时利用灰色区域漏洞
（CVE-2018-6622）
- 用户级应用程序检查TPM状态并显示报告
“Napper”?
- 是否可以检查TPM中的ACPI S3睡眠模式漏洞的工具
- 它是一个基于Ubuntu 18.04的可启动USB设备
- 它有一个内核模式和用户态应用程序
- 使系统“小睡”并检查漏洞
- 内核模块通过修补内核代码在休眠时利用灰色区域漏洞
（CVE-2018-6622）
- 用户级应用程序检查TPM状态并显示报告
CVE-2017-16837是一个软件漏洞！
如果版本低于v1.9.7，请升级tBoot
Napper内核模块(1)
- 在TPM驱动程序中修补tpm_pm_suspend（）函数
- S3休眠序列时内核调用该函数
- 内核模块将函数更改为“return 0;”
Napper内核模块(2)
Napper用户态应用程序
- 由TPM相关软件和启动器软件组成
- 我在tpm2_tools中添加了一个命令行工具“tpm2_extendpcrs”
- 我还制作了一个易于使用的启动器软件
- 加载内核模块并检查TPM漏洞
- 发射器加载napper的内核模块并小睡一会儿
- 检查TPM的PCR是否都是ZEROS并扩展PCR
- 使用tpm2_getinfo，dmidecode和journalctl工具收集和报告
TPM和系统信息
Napper Live-CD和USB可启动设备
Ubuntu 18.04
+ Kernel 4.18.0-15
TPM-related software
+
Napper Live-CD.iso
User-level Applications
+
+Pinguybuilder_5.1-7
Napper Live-CD和USB可启动设备
Ubuntu 18.04
+ Kernel 4.18.0-15
TPM-related software
+
Napper Live-CD.iso
User-level Applications
+
Pinguybuilder_5.1-7
Project page: 
https://github.com/kkamagui/napper-for-tpm
Model
Status
BIOS
TPM
Vendor
Version
Release Date
Manufacturer
Vendor String
ASUS
Q170M-C
Vulnerable
American 
Megatrends Inc.
4001
11/09/2018
Infineon (IFX)
SLB9665
Dell
Optiplex 7040
Vulnerable
Dell
1.11.1
10/10/2018
NTC
rls NPCT
Dell
Optiplex 7050
Vulnerable
Dell
1.11.0
11/01/2018
NTC
rls NPCT
GIGABYTE
H170-D3HP
Vulnerable
American 
Megatrends Inc.
F20g
03/09/2018
Infineon (IFX)
SLB9665
GIGABYTE
Q170M-MK
Vulnerable
American 
Megatrends Inc.
F23
04/12/2018
Infineon (IFX)
SLB9665
HP
Spectre x360
Vulnerable
American 
Megatrends Inc.
F.24
01/07/2019
Infineon (IFX)
SLB9665
Intel
NUC5i5MYHE
Vulnerable
Intel
MYBDWi5v.86A. 
0049.2018. 
1107.1046
11/07/2018
Infineon (IFX)
SLB9665
Lenovo T480 
(20L5A00TKR)
Safe
Lenovo
N24ET44W 
(1.19 )
11/07/2018
Infineon (IFX)
SLB9670
Lenovo T580
Safe
Lenovo
N27ET20W 
(1.06 )
01/22/2018
ST-
Microelectronics
Microsoft
Surface Pro 4
Safe
Microsoft 
Corporation
108.2439.769
12/07/2018
Infineon (IFX)
SLB9665
演示
Napper tool
对策 - CVE-2018-6622
（灰色区域漏洞）
1）在BIOS菜单中禁用ACPI S3睡眠功能
- 残酷，但简单而有效
2）修改TPM 2.0规范以详细定义“纠正措施”并修补BIOS / UEFI固
件
- 很长一段时间修改并应用于TPM或BIOS / UEFI固件
- 但是，根本的解决方案！
检查并更新BIOS/UEFI固件！
对策 - CVE-2017-16837
（丢失的指针漏洞）
1) 将我的补丁应用于tBoot
-
https://sourceforge.net/p/tboot/code/ci/521c58e51eb5be105a2998      
3742850e72c44ed80e/
2) 将tBoot更新到最新版本
结论
- 到目前为止，我们已经信任不可信赖的硬件和软件！
- “信誉”不是“可信度”
- 不仅要信任信誉，还要为自己检查一切
- Napper可帮助您检查TPM漏洞
- 使用Napper检查您的系统或访问项目站点以获取结果
- 使用最新版本更新BIOS / UEFI固件
- 如果还没有修补固件，请立即禁用BIOS菜单中的ACPI S3睡眠功能！
背叛信誉
用信誉为赌注信任不可信的硬件和软件
Twitter:       @kkamagui1
Seunghun Han
PI:EMAIL
Project: https://github.com/kkamagui/napper-for-tpm
参考资料
- Seunghun, H., Wook, S., Jun-Hyeok, P., and HyoungChun K. Finally, I Can Sleep Tonight: Catching Sleep Mode 
Vulnerabilities of the TPM with the Napper. Black Hat Asia. 2019.
- Seunghun, H., Wook, S., Jun-Hyeok, P., and HyoungChun K. A Bad Dream: Subverting Trusted Platform Module 
While You Are Sleeping. USENIX Security. 2018.
- Seunghun, H., Jun-Hyeok, P., Wook, S., Junghwan, K., and HyoungChun K. I Don’t Want to sleep Tonight: 
Subverting Intel TXT with S3 Sleep. Black Hat Asia. 2018.
- Trusted Computing Group. TCG D-RTM Architecture. 2013.
- Trusted Computing Group. TCG PC Client Specific Implementation Specification for Conventional BIOS. 2012.
- Intel. Intel Trusted Execution Technology (Intel TXT). 2017.
- Butterworth, J., Kallenberg, C., Kovah, X., and Herzog, A. Problems with the static root of trust for measurement.
Black Hat USA. 2013.
- Wojtczuk, R., and Rutkowska, J. Attacking intel trusted execution technology. Black Hat DC. 2009.
- Wojtczuk, R., Rutkowska, J., and Tereshkin. A. Another way to circumvent Intel trusted execution technology.
Invisible Things Lab. 2009.
- Wojtczuk, R., and Rutkowska, J. Attacking Intel TXT via SINIT code execution hijacking. Invisible Things Lab. 2011.
- Sharkey, J. Breaking hardware-enforced security with hypervisors. Black Hat USA. 2016.