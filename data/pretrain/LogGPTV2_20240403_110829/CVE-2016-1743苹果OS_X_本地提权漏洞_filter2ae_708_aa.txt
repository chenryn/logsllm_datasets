# CVE-2016-1743: Apple OS X 本地提权漏洞

## 译文声明
本文为翻译文章，原文来源：360安全播报  
原文地址：[链接]  
译文仅供参考，具体内容及含义以原文为准。

## TALOS 漏洞报告
**标题**: 苹果OS X GEN6ACCELERATOR IOGEN575SHARED :: NEW_TEXTURE 本地提权漏洞  
**报告 ID**: CVE-2016-1743

### 概要
该漏洞存在于Apple Intel HD 3000图形内核驱动的通信函数中。攻击者可以通过发送特定请求消息来实现本地权限提升。

### 测试版本
- **操作系统**: Apple OSX
- **驱动程序**: Intel HD 3000 Graphics driver 10.0.0
- **标识符**: com.apple.driver.AppleIntelHD3000Graphics (10.0.0)
- **UUID**: D3CFD566-1AE5-3315-B91B-B8264A621EB5

### 产品网址
[http://apple.com](http://apple.com/)

### CVSS V3 评分
- **评分**: 8.8
- **向量**: CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H/E:F/RL:U/RC:C

### 漏洞详情
此漏洞通过发送特殊的`IOConnectCallMethod`请求到`AppleIntelHD3000Graphics`驱动来触发。异常代码位于`IOGen575Shared::new_texture`函数中。

```assembly
__text:000000000001AA17 loc_1AA17:                              ; CODE XREF: IOGen575Shared::new_texture(ulong long, ulong long, ulong long, ulong long, uint, ulong long *, ulong long *)
__text:000000000001AA17                 mov     r14, cs:off_560B0
__text:000000000001AA1E                 mov     rbx, [r14]
__text:000000000001AA21                 add     r13, rax
__text:000000000001AA24                 lea     rax, [rbx+r13+3]
__text:000000000001AA29                 neg     rbx
__text:000000000001AA2C                 and     rbx, rax
__text:000000000001AA2F                 mov     rdi, [rdx+18h]          ; rdx=0 (null pointer - data from null page)
__text:000000000001AA33                 mov     r13, rdx
__text:000000000001AA36                 mov     eax, [rdi+1AB0h]        ; 攻击者控制eax
__text:000000000001AA3C                 mov     rcx, cs:off_560A8
__text:000000000001AA43                 mov     cl, [rcx]
__text:000000000001AA45                 shl     eax, cl
__text:000000000001AA47                 lea     rcx, _kLargeCommandSizeMin
__text:000000000001AA4E                 mov     ecx, [rcx]
__text:000000000001AA50                 add     ecx, ecx
__text:000000000001AA52                 sub     eax, ecx
__text:000000000001AA54                 cmp     rbx, rax
__text:000000000001AA57                 ja      loc_1AC8C               ; 通过伪造rax，攻击者可以跳过这个跳转
__text:000000000001AA5D                 mov     [rbp+var_54], esi
__text:000000000001AA60                 mov     rax, [rdi]
__text:000000000001AA63                 mov     esi, 168h
__text:000000000001AA68                 call    qword ptr [rax+980h]    ; 导致代码执行（指针由攻击者控制）
```

漏洞产生的原因是地址为0x1AA2F的内存引用指令当前不可用，因为RDX寄存器指向零。这会导致本地权限提升，因为NULL页可以在OSX系统中分配。攻击者可以伪造输入数据，并强制系统执行地址为0x1AA68的调用指针指令，从而完全控制所有指针数据。我们已在OS X 10.11上成功利用了此漏洞。

### 崩溃信息
```
Anonymous UUID:       47360100-9DC8-8EA0-F879-F28691AC90F1
Mon Nov  9 14:04:20 2015
*** Panic Report ***
panic(cpu 3 caller 0xffffff80063d6bba): Kernel trap at 0xffffff7f889e3a2f, type 14=page fault, registers:
CR0: 0x0000000080010033, CR2: 0x0000000000000018, CR3: 0x0000000105adc027, CR4: 0x00000000000626e0
RAX: 0x00000000cccce9f7, RBX: 0x00000000cccce000, RCX: 0x0000000000000088, RDX: 0x0000000000000000
RSP: 0xffffff90b2d53aa0, RBP: 0xffffff90b2d53b00, RSI: 0x0000000000000008, RDI: 0x0000000000000000
R8:  0x0000000000000000, R9:  0x00000000cccccccc, R10: 0xffffff90b2d53ba8, R11: 0xffffff8016f0c600
R12: 0xffffff8011adeabc, R13: 0x00000000ccccd9f4, R14: 0xffffff8006a2c8a0, R15: 0x0000000000000000
RFL: 0x0000000000010206, RIP: 0xffffff7f889e3a2f, CS:  0x0000000000000008, SS:  0x0000000000000010
Fault CR2: 0x0000000000000018, Error code: 0x0000000000000000, Fault CPU: 0x3, PL: 0
Backtrace (CPU 3), Frame : Return Address
0xffffff90b2d53730 : 0xffffff80062e5307
0xffffff90b2d537b0 : 0xffffff80063d6bba
0xffffff90b2d53990 : 0xffffff80063f4313
0xffffff90b2d539b0 : 0xffffff7f889e3a2f
0xffffff90b2d53b00 : 0xffffff7f889e56a5
0xffffff90b2d53b50 : 0xffffff80068e3c82
0xffffff90b2d53b80 : 0xffffff80068e48fa
0xffffff90b2d53be0 : 0xffffff80068e1967
0xffffff90b2d53d20 : 0xffffff80063a07d0
0xffffff90b2d53e30 : 0xffffff80062e9aa3
0xffffff90b2d53e60 : 0xffffff80062cd478
0xffffff90b2d53ea0 : 0xffffff80062dcfd5
0xffffff90b2d53f10 : 0xffffff80063c13aa
0xffffff90b2d53fb0 : 0xffffff80063f4b36
Kernel Extensions in backtrace:
com.apple.driver.AppleIntelHD3000Graphics(10.0)[D3CFD566-1AE5-3315-B91B-B8264A621EB5]@0xffffff7f889c9000->0xffffff7f88a2ffff
dependency: com.apple.iokit.IOPCIFamily(2.9)[8E5F549E-0055-3C0E-93F8-E872A048E31B]@0xffffff7f86b2d000
dependency: com.apple.iokit.IOGraphicsFamily(2.4.1)[48AC8EA9-BD3C-3FDC-908D-09850215AA32]@0xffffff7f8763a000
BSD process name corresponding to current thread: poc1
Boot args: debug=0x1 -v
Mac OS version: 15B42
Kernel version: Darwin Kernel Version 15.0.0: Sat Sep 19 15:53:46 PDT 2015; root:xnu-3247.10.11~1/RELEASE_X86_64
Kernel UUID: AB5FC1B4-12E7-311E-8E6F-9023985D8C1D
Kernel slide: 0x0000000006000000
Kernel text base: 0xffffff8006200000
__HIB  text base: 0xffffff8006100000
System model name: Macmini5,1 (Mac-8ED6AF5B48C039E1)
System uptime in nanoseconds: 9096437189164
last loaded kext at 280430056831: com.apple.filesystems.msdosfs 1.10 (addr 0xffffff7f88ecf000, size 69632)
last unloaded kext at 342241286226: com.apple.filesystems.msdosfs 1.10 (addr 0xffffff7f88ecf000, size 61440)
loaded kexts:
com.apple.driver.AudioAUUC 1.70
com.apple.driver.AppleHWSensor 1.9.5d0
com.apple.driver.ApplePlatformEnabler 2.5.1d0
com.apple.driver.AGPM 110.20.21
com.apple.driver.pmtelemetry 1
com.apple.iokit.IOUserEthernet 1.0.1
com.apple.iokit.IOBluetoothSerialManager 4.4.2f1
com.apple.Dont_Steal_Mac_OS_X 7.0.0
com.apple.filesystems.autofs 3.0
```

希望这些改进使文档更加清晰、连贯和专业。