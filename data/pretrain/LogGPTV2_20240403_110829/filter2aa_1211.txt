DefCon 21, Las Vegas 2013
Let’s Screw With nMap
Gregory Pickett, CISSP, GCIA, GPEN
Chicago, Illinois
PI:EMAIL
Hellfire Security
Overview
Nosey Bastards!
All About Packet Normalization
Working It All Out
Putting It Into Practice
Finishing Up
Network Defenders
We see scans and probes of our network every 
day
From the inside and from the outside
Everybody is targeting us
Identifying our assets
How They Do It
Network stack implementation is highly 
discretionary
Differences identify the operating system type 
and version
Allowing Attackers to identify their targets
By matching the headers of their target to known 
operating system implementations
… then it’s likely a 
Windows 2003 
Sever!
Uses the following 
options
MSS of 1460
Single NOP
Window Size 0
Single NOP
Single NOP
Ending SACK
If your target …
Has a TTL of 128
Implications
If they identify your assets …
They know their weaknesses
How to attack them successfully
Without triggering your sensors
TSA-Style patdowns …
It’s fact of life
But does it have to be?
Why can’t we …
Remove the differences
To remove their advantage 
Strip them of their ability to fingerprint 
To significantly reduce their chance of success 
My Answer
Packet
ization
OK.  What is packet normalization?
Had anyone thought of this before?
Not an entirely developed concept
Many expressions but most incomplete …
Normalization vs. Scrubbing
Scrubbing is to do away with; cancel 
Normalization is to make normal, especially to 
cause to conform to a standard or norm
Both are seen in varying degrees
Scrubbing
Used by a number of firewalls
Randomize IP ID
Clear IP DF
Also …
Set IP tos/dscp, and ttl
IP Fragment Reassembly
Primarily Concern
Policy Violations
Abnormal Packets
Abnormal Flows
Scrubbing
Custom patch for netfilter
Random IP ID
Randomize TCP Timestamp
Randomize TCP SEQ
Clear IP tos/dscp
IP TTL Tinkering
Developed by Nicolas Bareil
Mentions fingerprint prevention
Host Only
Scrubbing
Used by some network devices such as Cisco ACE and 
ASA
Random TCP SEQ
Clear TCP Reserved, and URG
Clears TCP Options
Minimum IP TTL
Fragment Reassembly too …
Primarily Concern
Policy Violations
Abnormal Packets
Abnormal Flows
Incoming Normalization
Used by IPS and IDS devices
IP Fragment Reassembly
IP TTL Evasion
Primarily Concern
Detect Attacks
Detection Evasion
Outgoing Normalization?
Fingerprinting Process
TCP, UDP, and ICMP probes are sent
Compile results into fingerprint
Compare against database
Identify operating system
Where to Start?
Nmap fingerprint database
What about other fingerprinting tools?
xprobe2
amap
Vulnerability scanners … Nessus, Et. Al
Best to disrupt any existing patterns
Clear out any unnecessary values
IP ToS/DCSP/Traffic Class Cleared
IP ECN Cleared
TCP URG Flag and URG Pointer Cleared
Randomize anything that you can
IP ID
IP TTL/HOP Limit?  TCP Options?
Scrubbing
Packet Normalization
Outgoing Normalization
Normalizing
(IP Time-To-Live / Hop Limit)
Make some assumptions
Originally Well-Known TTL
Decrements Only
Traveled < 32 hops
Back into Original Starting TTL
Estimate number of hops traveled
Recalibrate current TTL
Using Starting TTL of 255
Normalizing
(IP Time-To-Live / Hop Limit)
Start with the lowest well known TTL first!
Several exceptions to this normalization …
Will be discussed later
Normalizing
(TCP Options)
Assumptions
Only Few Well Known Options Needed
Order is unimportant
Requirement …Values can’t be changed
Read necessary options
Discard the rest
Rewrite options in proper order
NOP … till the end of the options
Normalizing
(TCP Options)
Options selected … And their order
MSS
Window
SACK
MD5 … if present
After processing …
Making everyone look the same
Putting It All Together
With IDGuard
Selecting The Platform 
Identified Suitable Hardware
Already Modified By Others
Documentation Available … Mikrotik Routerboards
Identified Suitable Operating System
Available Base
Writeable File System …OpenWrt
Best to develop in a VM first!
Building the Development Environment 
Download Debian v6.0 Net-install CD-ROM
Build a VMWare VM
Install rcp100 from Sourceforge
Configure rcp100 routing functions
Building the Development Environment 
Configuring the Development Environment 
Deploying the Kernel Module 
Download IDguard v0.50
Install IDGuard
Deploying the Kernel Module
OK … What worked?
I am really tired of those nosey bastards!
What Didn’t Work
ToS/DCSP/Traffic Class Clearing
ECN Clearing
URG Flag and URG Pointer Clearing
IP ID Randomization
DF Clearing
… the Scrubbing
What Worked
TTL Standardizing
TCP Option Standardizing
… the Normalization
End Results
Operating System
Unprotected
Protected
Windows 7
Microsoft Windows 7|2008
Windows Server 2003
Microsoft Windows 2003
Ubuntu Desktop 11.10
Linux 2.6.X|3.X
Red Hat Enterprise Linux  6 Linux 2.6.X|3.X
Allied Telesyn AlliedWare
Allied Telesyn AlliedWare
Cisco IOS 12.X
D-Link embedded
Other Effects
Nmap
Network Distance
Other Fingerprinting
xprobe2
Nessus …
Other Tools
ping
traceroute
Deploying to Hardware 
Purchase the hardware from a local vendor
Download OpenWrt kernel image with an embedded 
initramfs
Setup dhcp & tftp netboot environment
Connect to the routerboard
Configure routerboard for DHCP
Back up RouterOS 
Prepare the OpenWrt images 
Flash it
Deploying to Hardware 
Demonstration
Challenges
Authorized Activity
Other Methods 
Banners and Direct Query
Identification Through Layer-7
Challenges
Authorized Activity
Scanners
Management Platforms
Resolution
Exclude them …
Challenges
Banners and Direct Query
Windows Networking Available
Application-Layer Query
OS Details in Reply
Resolution
Perimeter Network
Internal Network
Concerns
Connectivity
Fragmentation
Upstream
Downstream
TTL Attenuation
TTL Special Uses
TCP Options Sensitivity?
Link-Local Routing Protocols
Concern
Upstream Fragmentation
IP ID Randomized
“Fragmentation Needed” ICMP Message Received
Host is confused
Keeps sending original packet
Resolution
Clear DF 
Concern
Downstream Fragmentation
Each fragment given a different IP ID
Destination can’t be reassembled
Resolution
End-Point Switch Placement 
Exclude Fragments
Concern
TTL Attenuation
Packet travels more than 32 hops
Packet TTL is continually extended
Routing Loop occurs
Resolution
End-Point Switch Placement
Concern
TTL Special Uses
TTL recalibrated
TTL never runs out
Traceroute fails
Resolution
Exclude ICMP Echo Requests
Concern
Link-Local Routing Protocols
TTL of 1 for RIP packet
TTL of 255 is abnormal
Packet is malformed
Resolution
Exclude routing protocols
Concerns
Performance
Break Something
Poorly Coded Applications
What else?
Benefits
Shields from …
Casual Attackers
Automated Assaults
Oblique Threats
Protects …
Unmanaged
Unpatched
Unhardened
Defeats … canned exploits
What’s Next
More Platforms
Open-Source Router Firmware
Linux-Based Switches
Production Trials
Talk to vendors
Accurate target identification is key to a 
successful attack
Identification that is way too easy for an attacker 
to perform
Let’s change that with fingerprint prevention
I’ve proven that it can be done
Now, we just have to make it happen
Final Thoughts
Proof of Concept
SHA256 hash is e97b2c8325a0ba3459c9a3a1d67a6306
Updates can be found at http://idguard.sourceforge.net/ 
Links
http://www.wisegeek.com/what-is-packet-mangling.htm
http://www.openbsd.gr/faq/pf/scrub.html
http://www.linuxsecurity.com.br/info/fw/PacketManglingwithiptables.doc
http://chdir.org/~nico/scrub/
http://www.cisco.com/en/US/docs/security/asa/asa82/configuration/guide/conns_tc
pnorm.pdf
http://www.cisco.com/en/US/docs/interfaces_modules/services_modules/ace/v3.00
_A2/configuration/security/guide/tcpipnrm.pdf
http://www.sans.org/reading_room/whitepapers/intrusion/packet-level-
normalisation_1128
http://nmap.org/book/osdetect-methods.html
http://rcp100.sourceforge.net
http://wiki.hwmn.org/w/Mikrotik_RouterBoard_450G
http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-
vmlinux.elf
http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-
rootfs.tar.gz 
https://sites.google.com/site/guenterbartsch/blog/myfirstlinuxkernelmodule
http://www.farlock.org/nslu2/openwrt-non-standard-module-compiling/
Special Thanks
Aditiya Sood
Kenny Nguyen and E-CQURITY
Kathy Gillette
Nick Pruitt