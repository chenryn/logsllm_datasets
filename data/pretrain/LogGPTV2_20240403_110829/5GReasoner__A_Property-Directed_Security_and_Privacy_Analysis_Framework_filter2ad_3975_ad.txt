dl
dl
Session 3D: Formal Analysis ICCS ’19, November 11–15, 2019, London, United Kingdom677Figure 10: Neutralizing TMSI Refreshment
another registration procedure. To make matters worse, the ad-
versary may replay the same attack numerous times to force the
victim UE to keep re-establishing the connection, causing DoS and
battery depletion together. It is also possible to replay the same
user-plane packets over and over again with same (keygNB) to cause
over billing to the client.
Attack Considering Case (ii). The adversary with a MitM relay
can drop an arbitrary number of packets without getting detected
since the receiver accepts a packet even if the received sequence
number is smaller than the stored sequence number at the receiver
end.
Figure 9: Counter reset attack
Attack Description. The adversary using a fake base station or a
MitM relay transmits unauthenticated initial broadcast (sysinfoblock1
and sysinfoblock2) messages with higher signal strength [30] and
forces the victim UE to connect to itself. The adversary captures
both sec_mode_command and sec_mode_complete message with seqamf
and
dl
, respectively being 0 during the initial registration procedure
seque
ul
as shown in Figure 9. Whenever the UE completes the registration
with a legitimate AMF, the adversary waits for the sec_mode_command
and the sec_mode_complete massage from AMF and UE, respectively.
If the AMF again sends sec_mode_command message for refreshing RRC
gets close to 28, the adver-
layer keys but long before the seqamf
dl
sary can selectively drops the message (by guessing the type of the
encrypted message from the packet length, context, and the DCI
values [45]) and replays the previously captured sec_mode_command
and sec_mode_complete messages with count values set to 0 (shown in
Figure 9). Both the replayed command and the complete messages
will be successfully verified because the overflow counter values
(e.g., ocamf
) at the legitimate UE and AMF will still be the
dl
are not close to 28. After suc-
same, i.e., 0 since the seque
dl
cessful verification, the AMF and UE updates its locally maintained
and seque
,
seqamf
dl
ul
respectively. Therefore, if the adversary can replay sec_mode_command
and sec_mode_complete, it will be able to reset seqamf
. Note
ul
that, with this attack, the adversary, however, cannot reset seque
ul
and seqamf
dl
Impact. With this attack, the adversary is able to desynchronize
the uplink counter values between the victim UE and the legiti-
mate AMF. These counters are crucial parameters which the UE
and the AMF use to generate the keygNB, later on, share with the
base station for providing RRC/PDCP layer security. Since the at-
tack desynchronizes the values of seque
, the keygNB
ul
generated by UE and AMF will be different and thus induce the
victim UE to re-establish the connection with the network using
, respectively with the received seque
ul
locally maintained by UE and AMF, respectively.
and seqamf
ul
and seque
dl
and ocue
dl
and seque
dl
and seqamf
ul
and ocue
ul
6.1.2 Uplink NAS Counter Desynchronization. In this attack,
the adversary exploits the lack of rate-limiting on the number of
failed security mode procedure to desynchronize UE’s uplink NAS
counters. Impacts of the attack are prolonged desynchronization
and DoS between UE and AMF.
Adversary Assumptions. Unlike the counter reset attack discussed
above, we assume that the adversary knows the victim UE’s C-
RNTI [45], but does not require it to eavesdrop on or capture
sec_mode_command message sent in the previous session.
Vulnerability. The root vulnerability of this attack is the lack
of attempt counter for the security mode command procedure.
Neither the UE nor the AMF checks how many times it fails to
verify the sec_mode_command or sec_mode_complete message in a row.
This allows the adversary to inject an arbitrary number of invalid
sec_mode_command messages to the victim device which induces the UE
to send sec_mode_reject messages as response while incrementing
its seque
ul
Detection. We model check the MNASadv against the following prop-
erty: the AMF will correctly verify a legitimate sec_mode_complete mes-
sage sent by the UE in response to a sec_mode_command message sent by
the AMF. This is trivially violated by a counterexample in which
the adversary sends/receives at most 28 arbitrary sec_mode_command
messages to the target UE triggering the increment of the uplink
overflow counter seque
by 1. After that any uplink message will
ul
violate our sanity check of the uplink counter.
Attack description: The adversary using a fake base station or
a MitM relay connects to a victim UE and sends sec_mode_command
messages containing arbitrary values for MAC. Since the UE fails
to verify the MAC, it sends sec_mode_reject to the fake base station
and increments its seque
by 1 (i.e., consistent behavior with respect
ul
to the reception of a uplink message). The attacker may continue
this process until he observers a seque
wraps around. This signifies
ul
at the UE has reached a value of 28 and UEs locally
that the seque
ul
stored ocue
has been incremented by 1. This desynchronizes the
ul
.
Session 3D: Formal Analysis ICCS ’19, November 11–15, 2019, London, United Kingdom678and cntamf
ul
) between the UE and the
uplink NAS counters (cntue
ul
legitimate AMF.
Impact.: As a result of such desynchronization, though the vic-
tim UE can correctly verify the downlink messages from AMF,
but the legitimate AMF will discard any uplink messages (both
control plane and data) sent from the victim UE. Even if the le-
gitimate AMF tries to resynchronize the uplink NAS counters
with a new sec_mode_command message, the AMF cannot verify the
sec_mode_complete message because of the mismatch of uplink over-
flow counters. This allows the adversary to carry out a prolonged
DoS and service disruption to the user. The victim UE will have
to either drop the connection and re-authenticate again with the
legitimate AMF or the AMF will initiate a tracking_area_update pro-
cedure (default timer for which is 54 mins [4]) to re-synchronize
with the UE.
and cntamf
dl
6.1.3 Exposing NAS Sequence Number. In this attack, the ad-
versary passively monitors the uplink and downlink transmissions
of the victim UE and reveals the cntue
. The adversary
ul
then uses this value to monitor victim UE’s cellular activity.
Adversary Assumptions. The adversary knows the victim UE’s
C-RNTI [45] and eavesdrops on the uplink and downlink NAS
messages of the victim UE. We, however, assume that the adversary
does not know the session keys to decrypt the messages.
and
Vulnerability. The NAS sequence number, part of the cntue
ul
, is exchanged in plaintext between the UE and the AMF as
cntamf
dl
part of the NAS signaling messages. The sender encrypts a NAS mes-
sage and computes the MAC with the corresponding NAS counter
values and then includes the MAC and NAS sequence number in
plaintext with the message.
Detection. While checking the observational equivalence property
for the prior linkability/coarse-grained location tracking attack
(migrated from 4G LTE), we also check the secrecy of the NAS
sequence numbers sent in the NAS messages. ProVerif returned a
violation of this secrecy property in which we observed that the
NAS sequence numbers of the UE and AMF have been exposed in
the sec_mode_command (cntamf
) messages.
dl
Attacks. The adversary learns the NAS sequence numbers and
may relate this information to infer the number of AKA sessions
or the number of change of cipher suites due to either handover
from 4G to 5G or the wrap-around of NAS counters. The adversary
can check the NAS counter values at different times and loosely
infer the engagement level (e.g., service consumption) during each
interval.
Impact. This attack may enable the adversary to profile the service
usage or monitoring the activity of a target UE.
) and sec_mode_complete (cntue
ul
consisting of a fake UE and a fake base station. We also assume that
the adversary knows the victim’s old TMSI using another attack
uncovered in the cross-layer analysis (Attack in Section 6.3.1).
Vulnerability. The AMF sends an encrypted and integrity pro-
tected config_update_command message to initiate the configuration
update procedure. This message includes the new TMSI and may
indicate if an acknowledgment (i.e., config_update_complete) from the
UE is requested. If there is no such indication, the adversary may
exploit this to disrupt the TMSI refreshing mechanism.
Detection. We checked the following property with MCheck: If
the AMF initiates configuration update procedure, it will eventually
assign a new TMSI to the device. We obtained a counterexample in
which the adversary drops the config_update_command message sent
from AMF to carry out the following attack.
Attacks. The adversary with the knowledge of victim device’s C-
RNTI and using a MitM relay can monitor the downlink messages
sent from the AMF. It can also drop the config_update_command mes-
sage (containing no indication of UE’s acknowledgment) destined
for the victim device. As a result of this, the victim has the old TMSI,
but the network will have both the old and new TMSIs until the
device reconnects to the network. Now, if there are any incoming
services (e.g., phone call or SMS) waiting for the device, the network
first tries paging with new-TMSI for a certain number of times and
then retries paging with the old-TMSI. Provided that the adversary
knows the old TMSI of the victim UE, it can compute the victim’s
paging occasion and hijack the paging channel, and thus prevent
legitimate paging messages from reaching to the victim UE. After
a certain number of attempts, the network aborts both the paging
and configuration update procedures. The adversary, thus, ceases
the changing of the victim’s TMSI in that case.
Impact. This attack may enable the adversary to force the network
to continue using the same TMSI for a victim long term which
makes the target user vulnerable to also location tracking attacks.
6.1.5 Cutting off the Device. The goal of the adversary is to
exploit the lack of integrity protection of the initial reg_request or
ue_dereg_request messages to stealthily disconnect the victim device
from the network.
The adversary knowing the C-RNTI [45] or TMSI (Attack in
Section 6.3.1) of the victim device can impersonate the victim by
sending the reg_request or ue_dereg_request messages to the AMF.
The AMF discards these initial request messages as they do not con-
tain integrity protection. This induces the AMF to implicitly release
the existing connection with the victim device by deregistering the
device from the network and connecting to the impersonator.
6.1.4 Neutralizing TMSI Refreshment. The AMF uses the con-
figuration update procedure to assign a new TMSI to a user upon
completion of a service, such as a phone call or SMS. In this attack,
the adversary prevents the network from changing the victim de-
vice’s TMSI when the change is required. This further enables the
adversary to correlate victim’s phone number with the old/new
TMSI which is a useful arsenal [37] for location tracking.
Adversary Assumptions. We assume the adversary knows the
victim UE’s C-RNTI [45], and can eavesdrop and selectively drop
victim UE’s downlink messages through a MiTM relay [28, 45]
6.2 Attacks in RRC Layer
We now present the findings of 5GReasoner when analyzing the
RRC layer in isolation.
6.2.1 Denial-of-Service with rrc_setup_request. In this attack, the
adversary exploits the lack of integrity protection of an RRC layer
message to stealthily disconnect a target UE from the network.
Adversary Assumptions. We assume that the adversary already
knows the TMSI (Attack in Section 6.3.1) of the device and is capable
of setting up a fake UE impersonating the victim device.
Session 3D: Formal Analysis ICCS ’19, November 11–15, 2019, London, United Kingdom679Figure 11: DoS with rrc_setup_request
Vulnerability. The rrc_setup_request message, which does not in-
clude any integrity protection, is sent by the UE to set up an RRC
layer connection with the base station. This lack of integrity pro-
tection enables an adversary to spoof this message to mount a
potential denial-of-service attack.
Detection and Attack Description. We check the MRRCadv against
the following property implicitly mentioned in TS 38.331: If the
base station (i.e., gNB) has an RRC security context in the current
state, it will exist forever unless there is a rrc_setup_request from the
UE. This is trivially violated by a counterexample in which the ad-
versary impersonating a victim UE sends a rrc_setup_request (with
victim’s TMSI) message to the base station to which the victim is al-
ready connected (shown in Figure 11). This induces the base station
to delete victim UE’s current RRC security context by implicitly
releasing the connection with the victim device and connecting
with the malicious UE. We also confirm this with ProVerif with a
correspondence property on the attack traces by the model checker.
Attack Variant. The adversary can also perform similar attacks
using rrc_reestablish_request or rrc_resume_request message (contain-
ing victim’s TMSI) by sending them over the initial signaling chan-
nel (i.e., signal radio bearer 0) as these messages also do not have
any integrity protection.
Impact. The adversary can stealthily disconnect a victim UE from
the network.
Figure 12: Installing Null Cipher and Null Integrity
Installing Null Cipher and Null Integrity. The goal of
6.2.2
this attack is to trick the victim UE in limited service mode to use
null cipher and null integrity protections. This unleashes the MitM
relay to not only relay the messages, but also to act as a full-form
Man-in-the-Middle attacker, i.e., to eavesdrop on, inject, or drop
legitimate messages.
Adversary Assumptions. We assume that the adversary already
knows the victim’s C-RNTI [45] and is able to set up a MitM re-
lay [28, 45] through which the device is connected to a core network.
Vulnerability. RRC layer’s security mode procedure is typically
initiated by the base station when it wants to set up/refresh the
RRC/PDCP layer security contexts. In this attack, the adversary
exploits the lack of integrity protection in rrc_sec_mode_failure mes-
sage which the UE sends to the base station when the UE cannot
verify the rrc_sec_mode_command message.
Detection and Attack Description. We model check the MRRCadv
against the following property implicitly mentioned in TS 38.331: If
the base station requires the access stratum (i.e., AS or RRC layer) secu-
rity context to be set up, the base station will eventually establish the
security context. The MCheck yields a counterexample in which the
adversary impersonating a victim UE sends a rrc_sec_mode_failure
message in response to the rrc_sec_mode_command message. Given
the attack trace, we also confirm this with ProVerif using a cor-
respondence property which confirms adversary’s capability to in-
ject rrc_sec_mode_failure message. According to TS 38.331 (clause:
5.3.4.3), the base station and UE continue using the security config-
uration used prior to the reception of rrc_sec_mode_command message,