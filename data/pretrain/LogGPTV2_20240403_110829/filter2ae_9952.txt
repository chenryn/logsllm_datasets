# 【技术分享】未遂的供应链攻击 - Defraggler后门代码分析

## 译文声明
本文为翻译文章，原文来源：安全客。译文仅供参考，具体内容及含义以原文为准。

## 概述
2017年9月18日，Piriform官方发布了一份安全公告，宣布其CCleaner version 5.33.6162和CCleaner Cloud version 1.07.3191版本软件遭到篡改并植入了恶意代码。这些被污染的软件版本在一个月内被广泛下载，导致数百万用户受到影响，敏感信息泄露，甚至有极少数用户的系统被进一步植入了更多恶意代码。近期，360威胁情报中心监测到的样本文件显示，Piriform旗下的另一款磁盘碎片整理工具Defraggler的一个版本也曾被篡改并植入了相同的恶意代码。幸运的是，由于发现及时，这个被篡改的版本并未对外公开发布。

## 事件时间线
根据公开资料和分析，360威胁情报中心还原了以下关键事件的时间线：
- **2017年8月2日**：CCleaner官方编译的主程序文件被植入恶意代码。
- **2017年8月3日**：Piriform开始对外发布被感染的CCleaner软件，并对其进行了数字签名。
- **2017年8月14日**：Defraggler官方编译的主程序文件也被植入恶意代码。
- **2017年9月11日**：Defraggler官方对被感染的软件进行了数字签名（但该版本因提前被发现而未公开发布）。
- **2017年9月12日**：Piriform发布了新版CCleaner (version 5.34)，移除了被污染的文件。
- **2017年9月14日**：第三方注册了恶意代码中预设的云控域名，从而阻止了攻击。
- **2017年9月18日**：Piriform发布安全公告，确认CCleaner version 5.33.6162和CCleaner Cloud version 1.07.3191版本软件被篡改并植入了恶意代码。

## 被污染的Defraggler样本分析
此次被污染的样本包括Defraggler安装包、Defraggler主程序、Defraggler DLL模块以及Defraggler命令行工具等。360威胁情报中心针对其中一个Defraggler主程序进行了详细分析。

### VirusTotal上的样本信息
- **文件版本**：2.22.0.995
- **编译时间**：2017年8月14日
- **数字签名时间**：2017年9月11日
- **数字签名状态**：已被颁发者吊销

通过文件版本和签名信息可以推断，Defraggler的这一版本在2017年8月14日被编译并植入恶意代码，在2017年9月11日由官方签署数字签名。然而，由于随后爆发的CCleaner污染事件，被污染的Defraggler版本并未如期发布，相关签名证书也直接被吊销，避免了更多的互联网用户受到攻击。

### 被污染的CRT代码位置
恶意代码位于CRT函数`___onexitinit()`中，调用过程如下：
- `___tmainCRTStartup()`
- `__cinit()`
- `__initterm_e()`
- `___onexitinit()`
- `Malicious call`

### 恶意代码功能
被植入恶意代码的Defraggler版本具有以下主要功能：
1. 攻击者修改了程序静态导入库函数`___onexitinit()`以执行恶意代码。
2. 收集主机信息（主机名、已安装软件列表、进程列表和网卡信息等），加密编码后通过HTTPS POST请求尝试发送到远程IP地址：216.126.225.148:443，伪造HTTP头中的host字段为：speccy.piriform.com，并下载执行任意恶意代码。如果该IP失效，则使用备用IP地址211.158.54.161再次尝试连接。
3. 如果IP失效，则根据月份生成DGA域名，并再次尝试发送相同的信息。如果成功，则下载执行任意恶意代码。

### C&C关联信息
在360威胁情报中心数据平台中搜索相关C&C IP地址，可以发现这些IP地址已被标记为CCleaner后门。

### IOC
- 首次尝试回连的IP地址
- DGA域名
- 文件HASH

## 总结
通过360威胁情报中心对受污染样本及相关C&C的关联分析，可以确定Defraggler被植入的后门与CCleaner后门共享完全相同的代码和C&C基础设施。软件被污染的时间点也高度重合，因此可以认为这是同一次供应链攻击中的多个植入对象。

## 参考资料
- [深入分析CCleaner恶意软件](https://ti.360.net/blog/articles/in-depth-analysis-of-ccleaner-malware/)
- [360安全警告详情](https://cert.360.cn/warning/detail?id=0dc8a230ad210be8a8b872a73b18d220)
- [Defraggler版本历史](https://www.piriform.com/defraggler/version-history)