### WMIC 提示符下的交互模式

在WMIC提示符下（例如“Rooticli”），交互模式通常用于执行多个WMIC指令。此外，在执行某些敏感操作（如删除）时，系统会要求用户确认，从而最大限度地减少误操作的可能性。

---
### Page 233
#### Web安全攻防：渗透测试实战指南

**非交互模式**

非交互模式允许将WMIC指令直接作为参数传递给WMIC命令，并在执行完毕后返回到普通命令提示符，而不是进入WMIC的上下文环境。这种模式主要应用于批处理脚本或其他自动化脚本中。

**权限说明**

- 在Windows XP中，低权限用户无法使用WMIC命令。
- 在Windows 7和Windows 8中，低权限用户可以使用WMIC，无需进行额外设置。

**信息收集与后渗透测试**

WMIC在信息收集及后渗透测试阶段非常有用，能够获取目标机器上的以下信息：
- 进程和服务
- 用户和用户组
- 网络连接
- 硬盘信息
- 网络共享
- 已安装补丁
- 启动项
- 安装的软件
- 操作系统详细信息
- 时区等

接下来，我们将演示如何通过利用特定漏洞进行提权操作。首先需要将Meterpreter会话切换至后台，然后搜索适用于MS16-032漏洞的相关模块。

```plaintext
afsearch ms16_032
```

**图5-51**展示了搜索结果。

**知识点**：如果找不到最新的Exploit，请运行`msfupdate`更新Metasploit以获取最新模块或手动添加相应漏洞EXP（详情见第5.7节）。

选择并配置MS16-032漏洞模块，指定会话ID进行提权，如**图5-52**所示。最后输入`exploit`或`run`执行攻击，参见**图5-53**。

---
### Page 234
#### 第5章 Metasploit技术

根据返回的信息可以看到已经创建了新的session，并且提权成功。检查当前Meterpreter Shell的权限显示为SYSTEM级别，如**图5-54**所示。

**防御方法**：针对该漏洞的安全补丁编号是KB3139914，安装此补丁即可修复。也可以通过第三方工具下载并安装该补丁包。

**表5-2**列出了部分操作系统版本及其对应的安全补丁号。

---
### Page 235
#### 续表

| Windows 版本 | 补丁编号 |
| --- | --- |
| Windows 2003 | KB2360937 (MS10-084) |
| Windows 2008 | KB3139914 (MS16-032) |
| Windows 2012 | KB3139914 (MS16-032) |

**令牌窃取**

1. **令牌简介及原理**

   令牌是一种临时密钥，类似于账户名和密码，用来验证请求的合法性以及确定请求者的身份。它允许在不提供密码或其他凭证的情况下访问网络和系统资源。常见的令牌类型包括访问令牌、密保令牌和会话令牌。

   Kerberos协议是实现假冒令牌攻击的关键。Kerberos是一种基于密钥系统的认证协议，旨在为客户端/服务器应用程序提供强大的认证服务。其工作机制如**图5-55**所示。

**客户端请求证书的过程**：

- 客户端向认证服务器（AS）发送请求，请求服务器证书。
- AS收到请求后，生成包含会话密钥的加密证书响应，并将其发送给客户端。
- 客户端将接收到的ticket传送到服务器上，服务器验证通过后允许客户端登录。
- 攻击者可以通过入侵服务器获取客户端令牌。

2. **假冒令牌实战利用**

假设我们已经获得了目标机的Meterpreter Shell，尝试通过`getsystem`命令提升权限失败后，使用`incognito`列出可用令牌，如**图5-57**所示。接着假冒管理员令牌，具体步骤如**图5-58**所示。

---
### Page 236
#### Hash攻击

1. **使用Hashdump抓取密码**

   `hashdump`可以从目标机器提取SAM数据库中的哈希值。然而，在非SYSTEM权限下可能无法成功执行。对于更复杂的情况，可以考虑使用`smart_hashdump`模块。

2. **使用QuarksPwDump抓取密码**

   QuarksPwDump是一款强大的Win32平台下的授权信息导出工具，支持多种操作系统版本。其主要功能包括导出本地和域账户的NT/LM哈希值、历史记录以及Bitlocker恢复信息等。运行QuarksPwDump.exe可查看帮助信息，如**图5-61**所示。

3. **使用Windows Credentials Editor抓取密码**

   WCE是一款功能强大的内网渗透工具，可用于列举登录会话并管理相关凭据。首先上传wce.exe到目标主机，然后执行`wce -w`命令提取系统明文密码，如**图5-62**所示。

4. **使用Mimikatz抓取密码**

   Mimikatz是一款轻量级调试器，适用于后渗透测试阶段。它可以轻松抓取系统密码及其他重要凭据。Mimikatz已被集成进Metasploit框架中，方便用户直接使用。