WMIC提示符下，如“Rooticli”，交互模式通常在需要执行多个WMIC指
令时使用，有时还会对一些敏感的操作要求确认，例如删除操作，这样能
最大限度地防止用户操作出现失误。
---
## Page 233
214Web安全政防：渗透测试实减指南
非交互模式。非交互模式是指将WMIC指令直接作为WMIC的参数放在
WMIC后面，当指令执行完毕后再返回到普通的命令提示符下，面不是进
入WMIC上下文环境中。WMIC的非交互模式主要用于批处理或者其他一些
脚本文件中。
需要注意的是，在WindowsXP下，低权限用户是不能使用WMIC命令的，但是
在Windows7系统和Windows8系统下，低权限用户可以使用WMIC，且不用更改任何
设置。
WMIC在信息收集和后渗透测试阶段非常实用，可以调取查看目标机的进程、服
务、用户、用户组、网络连接、硬盘信息、网络共享信息、已安装补丁、启动项、
已安装的软件、操作系统的相关信息和时区等。
接下来准备提权，同样需要先把Meterpreter会话转为后台执行，然后搜索
MS16-032，如图5-51所示。
afsearch ms16_032
Ratching Modules
Flane
Description
Disclosure Da
图5-51搜索模块
知识点：如果搜索不到最新的Exploit，可以输入msfupdate命令进行升级，获取
最新的Exploit模块、攻击载荷，或者手动添加相应漏洞EXP（详见第5.7节）。
执行以下命令选中MS16-032这个漏洞，然后指定“session”进行提权操作，这
16.002
图5-52设置模块参数
最后直接输入exploit或run命令即可，如图5-53所示。
---
## Page 234
第5章Metasploit技术215
sf eploitt=
）>run
Conprosinscriptcont
ents...
cnpres
to192.168.172.14
1[]Clned u C:1Users1testDesktopFRN.txt
图5-53进行攻击
根据返回的信息可以看到已经创建新的session，并提示提权成功。接着查看这个
Meterpreter Shell的权限，已经是SYSTEM级权限了，如图5-54所示。
Serverusemame:NT AUTHoRITYISYSTEM
图5-54查看权限
防御方法：这个漏洞的安全补丁编号是KB3139914，我们只要安装此补丁就可以
了，也可以通过第三方工具下载补丁包打上该补丁。
知识点：为方便提权，下面附上笔者收集的部分系统对应补丁号，如表5-2所示。
表5-2系统对应的补丁号（部分）
Windows 2003
Windows 2008
Windows 2012
KB2360937|MS10-084
KB3139914(MS16-032
KB3139914(MS16-032
KB2478960(MS11-014
KB3124280(MS16-016
KB3124280(MS16-016
KB2507938|MS11-056
KB3134228(MS16-014
KB3134228(MS16-014
KB2566454|MS11-062
KB3079904(MS15-097
KB3079904(MS15-097
KB2646524(MS12-003
KB3077657|MS15-077
KB3077657|MS15-077
KB2645640(MS12-009
KB3045171(MS15-051
KB3045171(MS15-051
KB2641653(MS12-018
KB3000061|MS14-058
KB3000061|MS14-058
KB944653(MS07-067
KB2829361|MS13-046
KB2829361(MS13-046
KB952004(MS09-012 PR
KB2850851(MS13-053
KB2850851(MS13-053EPATHOBJ
KB971657|MS09-041
EPATHOBJ Oday限 32 位
Oday限 32 位
KB2620712|MS11-097
KB2707511|MS12-042 sysret
KB2707511(MS12-042 sysret -pid
KB2393802(MS11-011
-pid
KB2124261|KB2271195 MS10-065
_KB942831MS08-005
KB2124261|KB2271195
IIS7
---
## Page 235
216Web安全政防：渗造测试实战指南
续表
Windows 2003
Windows 2008
Windows 2012
KB2503665)MS11-046
MS10-065 IIS7
KB970483(MS09-20 IIS6
KB2592799(MS11-080
KB970483(MS09-020 IIS6
KB956572|MS09-01巴西烤肉
KB2621440(MS12-020
KB977165(MS10-015 Ms Viru
KB3139914MS16-032
KB3124280(MS16-016
KB3134228MS16-014
KB3079904(MS15-097
KB3077657]MS15-077
KB3045171MS15-051
KB3000061|MS14-058
KB2829361|MS13-046
KB2850851|MS13-053
EPATHOBJ Oday 限 32 位
KB2707511MS12-042
KB2124261]KB2271195
MS10-065 IIS7
KB970483(MS09-020 IIS6
5.6.2令牌窃取
1.令牌简介及原理
令牌（Token）就是系统的临时密钥，相当于账户名和密码，用来决定是否允许
这次请求和判断这次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证
的前提下，访问网络和系统资源。这些令牌将持续存在于系统中，除非系统重新启
动。
令牌最大的特点就是随机性，不可预测，一般黑客或软件无法猜测出来。令牌
有很多种，比如访问令牌（AccessToken）表示访问控制操作主题的系统对象：密保
令牌（Security token），又叫作认证令牌或者硬件令牌，是一种计算机身份校验的物
理设备，例如iU盾：会话令牌（SessionToken）是交互会话中唯一的身份标识符。
在假冒令牌攻击中需要使用Kerberos协议。所以在使用假冒令牌前，先来介绍
---
## Page 236
第5章Metasploit技术4217
Kerberos协议。Kerberos是一种网络认证协议，其设计目标是通过密钥系统为客户机/
服务器应用程序提供强大的认证服务。Kerberos的工作机制如图5-55所示。
上传证书
响应
服务器
客户端
送证书
认证服务器AS
攻击者
图5-55 Kerberos工作机制
客户端请求证书的过程如下所示。
·客户端向认证服务器（AS）发送请求，要求得到服务器的证书。
·AS收到请求后，将包含客户端密钥的加密证书响应发送给客户端。该证书
一个临时加密密钥（又称为会话密钥，sessionkey）。当然，认证服务器也
会给服务器发送一份该证书，用来使服务器认证登录客户端的身份。
客户端将ticket传送到服务器上，服务器确认该客户端的话，便允许它登录
服务器。
客户端登录成功后，攻击者就可以通过入侵服务器获取客户端的令牌。
2.假冒令牌实战利用
此时假设我们通过一系列前期渗透，已经成功获得了目标机的MeterpreterShell，
首先输入getuid命令查看已经获得的权限，然后输入getsystem，发现提权失败，具体
如图5-56所示
rotergatstyt
priv.
Iapronat Lon(Dropr/ldin）
Token Duplicetion(InMenory/Adnin)
图5-56输入getsystem命令进行提权
---
## Page 237
218Web安全政防：渗造测试实战指南
我们先输入use incognito命令，然后输入list_okens -u列出可用的token，如图5-57
所示。
meterprater>useincognito
ito...success.
[-]warning:
wllt be avallaote
gat1on Tckens Ava11ab1e
NTAUTHORITYASYSTEM
Inpersonation Tokens Avallable
图5-57列出可用令牌
可以看到有两种类型的令牌：一种是DelegationTokens，也就是授权令牌，它支
持交互式登录（例如可以通过远程桌面登录访间）；还有一种是ImpersonationTokens，
也就是模拟令牌，它是非交互的会话。令牌的数量其实取决于Meterpreter Shell的访
问级别。
由图5-57可以看到，我们已经获得了一个系统管理员的授权令牌，现在就要假冒
这个令牌，成功后即可拥有它的权限。
从输出的信息可以看到分配的有效令牌包含WIN-57TJ4B561MTAdministrator，
其中WIN-57TJ4B561MT是目标机的主机名，Administrator表示登录的用户名。接下
来在incognito中调用impersonate_token命令假冒Administrator用户进行攻击，具体方
法如图5-58所示，
erraterInpersonate_token KIN-57T349561MTUceinstrator
[1 be arailab]
snatuserIN-57561Adnnstrator
nistratoriDesktoppwhoani
Ln-57t4
oselatLadminastrator
图5-58取令牌
知识点：在输入HOSTNAME\USERNAME时需要输入两个反斜杠（1）。
---
## Page 238
第5章Metasploit技术219
运行成功后在Meterpreter Shell下运行shell命令并输入whoami，可以看到笔者现
在就是假冒的那个WIN-57TJ4b561MTAdministrator系统管理员了。
5.6.3Hash攻击
1.使用Hashdump抓取密码
Hashdump Metcrprcter脚本可以从目标机器中提取Hash值，破解Hash值即可获得
登录密码。计算机中的每个账号（如果是域服务器，则为域内的每个账号）的用户
名和密码都存储在sam文件中，当计算机运行时，该文件对所有账号进行锁定，要想
访问就必须有“系统级”账号，所以要使用该命令就必须进行权限的提升。
在MeterpreterShell提示符下输入hashdump命令，将导出目标机sam数据库中的
Hash，如图5-59所示。
15138672b:
test:1002:d3b435e514049aad3b43551404e:699435e63b4d2:104dbcc15138b72b
10
图5-59导出Hash
在非SYSTEM权限下运行hashdump命令会失败，而且在Windows 7、Windows
Server2008下有时候会出现进程移植不成功等问题：而另一个模块smart_hashdump的
功能更为强大，可以导出域所有用户的Hash，其工作流程如下：
检查Meterpreter会话的权限和目标机操作系统类型。
检查目标机是否为域控制服务器。
首先尝试从注册表中读取Hash，不行的话再尝试注入LSASS进程。
这里要注意如果目标机的系统是Windows7，而且开启了UAC，获取Hash就会失
败，这时需要先使用绕过UAC的后渗透攻击模块，如图5-60所示。
Ruseenst741
图5-60导出域内的Hash
---
## Page 239
220Web安全攻防：渗透测试实战指南
可以使用暴力或者彩虹列表对抓取到的Hash进行破解，个人推荐http:/www
cmd5.com/或者http:/www.xmd5.com/这两个网站。
2.使用QuarksPwDump抓取密码
PwDump是一款Win32环境下的系统授权信息导出工具，目前没有任何一款工具
可以导出如此全面的信息、支持这么多的OS版本，而且相当稳定。
它目前可以导出：
·Local accounts NT/LMhashes+history本机NT/LM哈希+历史登录记录。
·Domain accounts NT/LMhashes+history域中的NT/LM哈希+历史登录记录。
Cached domainpassword缓存中的域管理密码。
Bitlocker recovery information（recovery passwords & key packages）使用
Bilocker的恢复功能后遗留的信息（恢复密码&关键包）。
7/Windows 2008/Windows 8。
在Windows的密码系统中，密码以加密的方式保存在/windows/system32/config
下的sam文件里，而账号在登录后会将密码的密文和明文保存在系统的内存中。正常
情况下系统启动后，sam文件是不能被读取的，但是PwDump就能读取sam，
直接运行QuarksPwDump.exe，如图5-61所示，默认显示帮助信息，其参数含义
如下所示。
·-dhl：导出本地哈希值。
。-dhdc：导出内存中的域控哈希值。
·-dhd：导出域控哈希值，必须指定NTDS文件。
·-db：导出Bitlocker信息，必须指定NTDS文件。
-nt：导出NTDS文件。
-hist：导出历史信息，可选项。
·：可选导出类型，默认导出John类型。
·-0：导出文件到本地.
---
## Page 240
第5章Metasploit技术4221
d
h
--dunp-hitlacker
-hist
ional>
hash-dona:
ith-histo
图5-61显示帮助信息
这里使用该工具抓取本机Hash值并导出，可以输入QuarksPwDump.exe-dhl-0
1.txt命令导出本地哈希值到当前目录的1.txt，此外，该工具还可以配合Ntdsutil工具导
出域控密码。
3.使用WindowsCredentialsEditor抓取密码
Windows Credentials Editor（WCE）是一款功能强大的Windows平台内网渗透工
具，它能列举登录会话，并且可以添加、改变和删除相关凭据（例如LM/NTHash）。
这些功能在内网渗透中能够被利用，例如，在Windows平台上执行绕过Hash操作或者
从内存中获取NT/LMHash（也可以从交互式登录、服务、远程桌面连接中获取）以
用于进一步的攻击，而且体积也非常小，是内网渗透时的必备工具。不过必须在管
理员权限下使用，还要注意杀毒工具的免杀。
首先输入upload命令将wce.exe上传到目标主机C盘中，然后在目标机Shell下输入
wce-w命令，便会成功提取系统明文管理员的密码，如图5-62所示。
---
## Page 241
222Web安全攻防：渗造测试实战指南
12
图5-62抓取系统明文管理员的密码
默认使用-1命令读取数据格式usemame:domain：lmntlm（这种读取是从内存中读
取已经登录的信息，而不是读取sam数据库中的信息），默认的读取方式是先用安全
的方式读取，若读取失败再用不安全的方式，所以很有可能对系统造成破坏。这里
建议使用-参数强制使用安全的方式读取。-g参数是用来计算密码的，就是制定一个
系统明文会使用的加密方法来计算密文，如图5-63所示。
assrd：1
图5-63抓取系统密码
-c参数用于指定会话来执行cmd，-v参数用于显示详细信息，这样才能看到luid
信息，-w参数是最关键的，用于查看已登录的明文密码，如图5-64所示。
lernah for heipe
图5-64抓取已登录的明文密码
4.使用Mimikatz抓取密码
Mimikatz是法国专家Benjamin Delpy（@gentilkiwi）写的轻量级调试器。作为一
款后渗透测试工具，它可以帮助安全测试人员轻松抓取系统密码，此外还包括能够
通过获取的Kerberos登录凭据，绕过支持RestrictedAdmin模式下Windows8或Windows
---
## Page 242
第5章Metasploit技术223
Server2012的远程终端（RDP）等功能。在最初渗透阶段之后的大多数时间里，攻击
者可能想在计算机/网络中得到一个更坚固的立足点，这样做通常需要一组补充的工
具，Mimikatz就是一种将攻击者想执行的、最有用的任务捆绑在一起的尝试。需要注
意该工具在Windows2000与WindowsXP系统下无法使用。
Mctasploit已经将其作为一个Mcterpreter脚本集成了，以便用户使用，而不需要