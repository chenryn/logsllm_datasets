PentesterAcademy.co
m/
©PentesterAcademy.com 
VOIPSHARK:开源VOIP分析平台是与⾮非 
Nishant/Sharma/
Jeswin1Mathai1
Ashish1Bhangale1
PentesterAcademy.com1&1AttackDefense.com1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
关于我们 
我,/Nishant/Sharma/
•  R&D1经理理及资深培训师, Pentester1Academy1
•  固件开发者, 企业级WiFi1APs和WIPS传感器器 
•  信息安全硕⼠士 
•  曾在US/Asia1Blackhat、DEFCON1USA及其它⼤大会上发表演讲 
1
合作者 
•  Ashish/Bhangale,1⾼高级安全研究员 
•  Jeswin/Mathai,1安全研究员 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
PentesterAcademy.com1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
AttackDefense.com1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
演讲概览 
• 
VoIP基本知识 
–  SIP,1RTP1
–  安全相关:1TLS,1SRTP11
1
• 
复原/解密VoIP通话 
1
• 
⽬目前已有的开源⼯工具及其问题 
1
• 
VoIPShark1
–  架构及内部原理理 
–  分析VoIP流量量 
–  复原通话 
–  被动攻击检测 
–  演示 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
VoIP电话通讯 
• 
信令1+1媒体 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
信令协议1
SIP/(会话初始协议) 
• 
IETF制定 
• 
替代固话及PSTN(公共电话交换⽹网络)1
1
H.3231
• 
ITU-T制定 
• 
主要为视频会议制定，也⽤用于语⾳音通话 
1
SCCP/(瘦客户端)1
• 
⽤用于电话线路路侧控制的思科专有协议 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
会话初始协议 
• 
基于⽂文本的协议 
• 
应⽤用 
–  使⽤用其它媒体流的通话(语⾳音、视频)，如RTP1
–  使⽤用SIP协议的“Message”⽅方法发送⽂文本消息 
• 
与其它协议协同⼯工作 
• 
会话描述协议1(SDP)1定义媒体协调和设置过程 
• 
可在TCP,1UDP1或1SCTP1(流控制传输协议)上⼯工作 
• 
安全性由TLS1(安全传输层协议)1提供，如SIP1over1TLS1
1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
订阅, 发布和通告  
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
会话初始协议: 通话过程示例例 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
⽤用户代理理服务 (UAS) 解决⽅方案 
www.sipfoundry.org1 
freeswitch.org1 
www.elastix.org1 
www.asterisk.org1 
www.3cx.com1 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
软电话客户端 
• 
基于IP的电话服务1
• 
可选软件1
–  Zoiper1
–  X1Lite1
–  LinPhone1
–  MicroSIP1
选择软电话客户端需考虑的因素1
• 
是否有编译码⽀支持1
• 
是否可以加密1(尤其是免费版)1
• 
其它功能1(如：⽂文本消息、挂起、等待)1
www.zoiper.com1 
www.microsip.org1 
www.linphone.org1 
www.counterpath.com/x-lite-download1 
www.3cx.com1 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Asterisk1Now1
+ 
= 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Scenario1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
配置⽅方案 
•  SIP1+1RTP1
1
•  SIP1over1TLS1+1RTP1
1
•  SIP1+1SRTP1
1
•  1SIP1over1TLS1+1SRTP1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
配置⽅方案 
•  SIP/+/RTP/
1
•  SIP1over1TLS1+1RTP1
1
•  SIP1+1SRTP1
1
•  1SIP1over1TLS1+1SRTP1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SIP/SDP数据包 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RTCP数据包 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RTP数据包 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
复原VoIP通话 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
通话流 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
通话重建 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
配置⽅方案 
•  SIP1+1RTP1
1
•  SIP1over1TLS1+1RTP1
1
•  SIP/+/SRTP/
1
•  1SIP1over1TLS1+1SRTP1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
在SDP数据包中传输SRTP密钥 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP流量量 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
加密后的通话 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
配置⽅方案 
•  SIP1+1RTP1
1
•  SIP/over/TLS/+/RTP/
1
•  SIP1+1SRTP1
1
•  1SIP1over1TLS1+1SRTP1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
⽆无SIP流量量 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
TLS流量量(SIP1over1TLS)1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
⽆无RTP流量量 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
为什什么没有RTP流量量?1
• 
Wireshark通过SDP数据包得到RTP/SRTP流使⽤用的端⼝口号1
• 
SIP和SDP被加密,1故wireshark⽆无法得知端⼝口号1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
未解码的RTP流量量 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
解码 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
解码为RTP1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RTP流量量 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
检查RTP流 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
分析RTP流 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
播放RTP流 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
配置⽅方案 
•  SIP1+1RTP1
1
•  SIP1over1TLS1+1RTP1
1
•  SIP1+1SRTP1
1
•  /SIP/over/TLS/+/SRTP/
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
TLS密钥交换⽅方法 
• 
TLS1使⽤用对称加密算法 (如AES,1Blowfish)1加密数据  
1
• 
两种可⾏行行⽅方法 
–  1DHE1(Diffie1Hellman密钥交换)1
–  1RSA1(⾮非对称加密)1
1
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Diffie1Hellman密钥交换 
假设 
1
• 
攻击者即使看到交换过程也⽆无法猜测原始颜⾊色 
1
• 
攻击者可以看到  
1
1111111以及  
1
1111111但不不知道添加的是什什么颜⾊色 
1
More1on:1en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange11
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RSA1(⾮非对称加密)1
PentesterAcademy.co
m/