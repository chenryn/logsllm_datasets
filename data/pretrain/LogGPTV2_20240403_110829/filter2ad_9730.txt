# 如何劫持大疆Spark无人机
##### 译文声明
本文是翻译文章，原文来源：embedi.com  
原文地址：[链接]  
译文仅供参考，具体内容表达及含义以原文为准。

## 引言
对于每个人来说，被犯罪分子骗取钱财无疑是一件令人沮丧的事情。随着物联网（IoT）的迅速发展，远程控制设备已成为我们日常生活的一部分。然而，这种便捷性也带来了明显的安全隐患——这些设备同样可能被恶意攻击者利用。想象一下，攻击者仅需坐在家中就能操控您的设备，并将其据为己有。这听起来似乎不可能，但我们已经成功地对大疆Spark无人机进行了此类操作。接下来，我们将展示如何实现这一过程。

## 背景介绍
长期以来，大疆无人机一直是黑客们关注的目标。他们主要致力于破解无人机的各种功能，如提高控制通道频率、消除飞行高度限制或禁飞区等。此外，还存在一些关于越狱无人机的信息。相关资料可以在[Github](https://github.com/MAVProxyUser/P0VsRedHerring)和[Wiki](https://dji.retroroms.info/)上找到。

大疆Spark属于非专业系列中的一款产品，于2017年发布，主要用于业余航空摄影。虽然在某些方面不如其他型号（例如电池续航时间仅为16分钟），但其价格优势明显，比Phantom 4和Mavic便宜了499美元。

Spark采用了基于Android 4.4系统的Leadcore LC1860C ARMv7-A CPU。更新文件带有.sig扩展名，并使用RSA-SHA256签名；部分文件则采用AES算法加密。网络安全爱好者已公开了该AES密钥，因此可以使用[工具](https://github.com/fvantienen/dji_rev/blob/master/tools/image.py)从文件中提取加密数据。在无人机固件中发现了许多确保设备正常运行的原生应用程序。

大疆Spark配备了一系列外部接口：
1. 用于连接PC的USB端口；
2. 用于闪存连接器的扩展槽；
3. 通过Wi-Fi与手机应用进行通信；
4. 使用2.412-2.462 GHz频段的遥控器进行管理。

此外，大疆还开发了DJI Assistant 2应用程序，允许用户通过USB将设备连接到台式机并执行诸如更新固件或更改Wi-Fi网络设置等功能。浏览社区资料时，我们发现了一个名为websocket_tool.py的脚本，能够修改无人机的最大飞行高度。每次请求都会向由DJI Assistant 2启动的web-socket服务器写入新值。换句话说，该应用具有两个接口：
1. 图形用户界面；
2. web-socket接口。

从理论上讲，在一台看似安全的计算机上感染系统比传统方法更容易，这也可能导致连接到PC的移动设备受到各种恶意软件的影响。因此，我们决定重现这一场景并对web-socket接口展开深入研究。

## Web-socket服务器

我们安装了最新版本的大疆Assistant 2 (1.1.6)，并将搭载V01.00.0600固件的大疆Spark连接至电脑。尝试访问Web-socket服务器时，我们使用了来自websocket-client包中的wsdump.py工具。初始测试显示URL `ws://victim:19870/` 上没有可用服务。但在运行web_socket_tool.py脚本后，我们找到了一个有效路径 - `/general`。显然，服务器无需授权即可访问，但其响应内容经过加密处理，表明此接口仅供DJI官方软件使用而非普通用户。那么问题来了：它究竟传递了什么信息？让我们进一步探讨客户端与服务器之间消息的加密机制。

在分析旧版DJI Assistant 2时，我们注意到它们是以明文形式与服务器通信。随后了解到，自1.1.6版本起引入了新的加密措施，这就是为何现有社区脚本无法直接使用的缘故。

## 加密算法

首先，我们检查了加密文本的特性。无论应用程序重新启动多少次，甚至是重启无人机或更换操作系统（例如Mac），加密文本始终保持一致。这表明加密密钥并非依赖于会话或操作系统环境。由此推测，密钥可能是硬编码的。

Web-socket服务器代码存储于DJIWebSocketServer.dll库内。借助PEiD Krypto ANALyzer等工具的帮助，我们确定了所使用的算法——AES以及本地化加密程序。即便对AES了解有限，也可以通过对比反编译代码与GitHub上的开源实现来识别具体的加密模式。最终确认使用的是CBC模式。通过对交叉引用的分析，我们成功定位到了初始化向量的位置。

## 破解用户界面

为了获取解密后的数据，我们需要在wsdump.py脚本中添加相应的加解密逻辑。我们在[GitHub](https://github.com/embedi/dji-ws-tools/blob/master/dji_wsdump.py)上分享了修改后的版本。

除了应用程序版本、设备类型等基本信息外，还包括一系列可经由web-socket接口远程调用的服务URL列表。

## 攻击方案

即使没有专用控制器，大疆无人机也能通过智能手机进行操控。如果购买了Spark Combo套装，则会包含一个控制器；否则只能单独购买。若无控制器，智能手机应用便成为唯一选择。无人机会创建一个受WPA2协议保护的Wi-Fi热点供手机接入，不过同一时刻只允许单个用户连接。

我们进行了一系列实验，试图从Wi-Fi热点角度验证驾驶员身份。结果发现，当无人机处于低空飞行状态时失去信号会导致坠落；而一旦达到较高海拔后再断开连接，无人机的行为变得异常，不仅提升转速还会继续爬升直至极限。由此可见，必须采取措施防止无人机失控飞离。

Web-socket接口赋予了对Wi-Fi网络的完全控制权。攻击者只需与启动了web-socket服务器的计算机建立连接，便能查看并篡改Wi-Fi设置，进而接管他人的无人机。具体攻击流程如下所示：

1. 请求`ws://victim:19870/generalurl`获取文件值。
   ```json
   "FILE":"1d9776fab950ec3f441909deafe56b1226ca5889"
   ```
2. 发送以下命令修改Wi-Fi密码：
   ```json
   ws://victim:19870/controller/wifi/
   {"SEQ":"12345","CMD":"SetPasswordEx","VALUE":"12345678"}
   ```
3. 使变更生效，重启Wi-Fi模块：
   ```json
   {"SEQ":"12345","CMD":"DoRebootWifi"}
   ```
4. 使用智能手机连接无人机。
5. 等待USB拔出并完成劫持。

以上步骤已在大疆Spark无人机上得到验证，理论上适用于所有兼容DJI Assistant 2的应用程序。更多细节请参阅我们的[PoC](https://github.com/embedi/dji-ws-tools/blob/master/dji_ws_exploit.py)。

## USB与物联网

目前几乎所有智能设备都可通过USB接口上传文件、更新固件等，这也意味着潜在的安全风险。一旦某台设备被感染，很容易将威胁扩散至其他相连设备。不法分子甚至可以根据需要更改配置或上传恶意固件。当这些受污染的装置再次连接至其他PC或笔记本时，感染范围将进一步扩大。

在物联网时代，此类问题变得更加严峻。因此，智能设备制造商应当重视设备间通信场景的设计，包括身份验证、授权机制以及可信引导签名固件等方面。否则，类似智能汽车因接口漏洞遭受攻击的情况可能会迫使车主支付赎金给犯罪分子。

## 时间轴
- 2017年9月25日 – 首次提交漏洞报告；
- 2017年9月28日 – 提交技术细节；
- 2017年10月12日 – 漏洞确认及奖金数额公布；
- 2017年12月20日 – 奖金发放。

## 结论

作为消费级与商用无人机市场的领导者，大疆占据了巨大的市场份额，预计到2021年将生产约400万台无人机。然而，任何安全缺陷都可能影响数百万用户及组织。过去曾发生过SSL密钥泄露和XSS漏洞事件，甚至有一架无人驾驶飞机撞击白宫草坪导致美军禁止使用大疆产品。鉴于DJI软件中存在的以下问题，潜在攻击手段包括但不限于：
- Web-socket服务器监听所有网络接口；
- 使用硬编码密钥与Web-socket服务器通信；
- 缺乏有效的web-socket接口认证机制；
- 数据轻易可得。

通过Wi-Fi发起的攻击不仅能够劫持无人机，还能利用web-socket接口提供的多种功能更改设置或窃取敏感信息。

工具参考：[GitHub]()