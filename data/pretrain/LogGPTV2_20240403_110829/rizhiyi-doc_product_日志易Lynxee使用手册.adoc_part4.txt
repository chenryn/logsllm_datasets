=== 自动训练检测
Lynxee 支持在数据对接的同时，自动学习指标的大致特征，选用合适的算法和参数，主动开始异常检测模型训练。在此基础上，用户再针对性的选取个别关键指标或明显不合适的指标，单独进行模型调整即可。在大规模 IT 环境下，开启自动训练可以大大节约用户配置的过程和时间。
开启自动训练功能，请设置日志易 Manager 中 kpi_monitor 模块的 `autotraining.turned_on` 参数为 `true` ，保存并重启服务即可。
为了保证自动学习和选择的有效，保证模型的准确，算法依赖足够数量的训练样本，因此，开启自动训练，并不代表指标数据在接入 Lynxee 系统的那一刻起，就已经处于监控状态。系统会持续接入一段时间，直到这个指标的入库数据量，达到了算法训练的最低要求才开始训练。数据量的最低要求默认为 10080 个数据点(`autotraining.min_point_count`)且**连续**每天的缺失率均小于 0.15(`autotraining.miss_point_rate`)，这同样也是用户在编辑页面上手动训练的限制。
自动训练的第一步，是自动选择合适的算法。自动选择算法的流程由可定制配置的基于指标名称的规则部分和基于数据形状特征的自动识别部分组成。
规则部分目前暂未内置，可以通过外置 ModelSelector 代码插件扩展，例如：对成功率指标，直接使用 RUBA 并设置 detect_rise 配置为 False；对业务量指标，直接使用 CVAE 算法等。
自动识别部分内置逻辑如下图所示，同样可以通过外置 ModelSelector 代码插件扩展和微调。例如，根据实际情况严格要求周期性的判断条件；或在算力允许的情况下，将 KDE 换成 CVAE 等。
image::images/lynxee-kpi-model-selector.png[]
. 采用假设检验法判断指标数据的周期性：
.. 从训练数据中随机抽取两段 24 小时数据，对比其相似度；重复 1000 次，得到随机两段数据的相似度分布；
.. 从训练数据中抽取相邻两个自然日数据，对比其相似度；依次滑动，得到 N-1 个相似度样本；
.. 假设训练数据没有周期性，则自然日数据相似度样本应当服从随机数据相似度分布。采用 Z-test 计算 p 值；
.. 当 p 值小于 0.001 时，认为假设不成立，即指标数据有周期性；
. 由于上述周期性识别方法较为敏感，再采用极值检验法判断弱周期性指标数据的震荡性。当训练数据中极值点的比例大于0.5时，认为指标数据主要特征为震荡而非周期
.. 对主要特征识别为震荡性的指标，采用 MDO 算法；
.. 对主要特征识别为周期性的指标，采用 KDE 算法；
. 对 Z-test 检验识别为完全非周期性的指标，进一步分析指标数据的突变比例情况；
.. 从训练数据中，计算每一对相邻数据点的差值：若后值大于前值，则差值为正；若后值等于前值，则差值为零；若后值小于前值，则差值为负；
.. 根据相邻差值是否为异向变化，判断是否是突变点：若相邻的差值为一正一负，则为异向变化；
.. 若数据点整体较平稳（相邻差值为零的情况较多），且突变点数量较多，则使用 RUBA 算法；
.. 若数据点整体震荡情况较严重，则使用 MDO 算法。
在系统初次对接时，您可以通过外部程序，批量导入历史数据。更多的数据同样有利于算法的训练效果，所以，Lynxee 将在最低数据量达标以后，额外等待一段时间(默认120s，可通过 `autotraining.wait_more_interval` 参数修改)，直到系统判断批量导入结束。然后选取其中最新的一部分，默认最多不多于 40320 个数据点，作为最终的算法训练样本集。同样的，这个样本也要满足每天缺失率小于 0.15 的限制。
如果您对接的数据并非一分钟一次采样，或者需要学习更长时间维度的特征等，您可能也需要调整训练样本的最大数据量配置，具体参数为 `autotraining.max_point_count` 。
在开启自动训练以后，还可以进一步开启自动检测功能，设置日志易 Manager 中 kpi_monitor 模块的 `autotraining.auto_apply` 参数为 `true` ，保存并重启服务，后续指标在训练得到模型后，就会自动上线应用了。
随着时间变化，指标数据的形态可能会因为应用扩缩容上下线等原因发生变化，原有模型不再适应新形态。因此，Lynxee 可以自动对模型进行重新训练，默认为每天一次，可通过 `autotraining.train_interval_days` 配置修改。
额外的，对用户手动调整过训练参数的指标，Lynxee 也会采用调整后的参数进行自动重训练，可以通过 `autotraining.turned_on_after_manually_adjust` 参数关闭。
如果在全局设置中，开启了"监控项告警发送配置"，后续指标数据在检测发现异常时，异常信息将会自动发给 Cruxee 模块。后续的事件归并和告警通知等操作，请参考《日志易Cruxee操作手册》相关章节。
== 服务及设备看板
配置和对接工作完成后，Lynxee 系统才正式上线运行。此后，你只需要通过概览看板，获取整体 IT 环境的健康状态。并在排障需要时，进行钻取查看分析。
=== 服务看板
服务看板也是 Lynxee 默认的首页。页面分为两种不同的视图: 卡片视图和拓扑视图。二者可以在页面右上角点击切换。
看板上方提供时间选择，按服务和按监控项过滤三种操作。当按服务过滤时，也只会展示过滤后的服务下属的监控项。
==== 卡片视图
卡片视图也是服务看板的默认视图，分为上下两段，上段的卡片展示服务健康度，下段的卡片展示监控项的最新取值。
image::images/lynxee/lynxee-service-kanban.png[]
卡片之间，根据危急程度排序展示，越高的越靠前。页面默认展示全部服务和危急程度排名靠前的 50 个监控项的状态卡片。你可以按需切换展示数量，由于系统中监控项一般较多，不建议展示过多的监控项卡片。
卡片左上角，展示服务或监控项名称。如果监控项名称前缀与所属服务的内部 ID一致的话，系统将自动将前缀部分转写为服务名称，放在监控项名称的下方。
注意: 看板上的监控项过滤框，是根据监控项名称匹配。
卡片根据危急程度，自动显示为对应的背景颜色。危机程度和分值的映射关系在前文已经讲解过。此外，当最近时刻的数值为空时，额外采用灰色展示。
在值的下方，采用迷你折线图展示当前指定时间范围内的历史趋势。
点击服务卡片，可以钻取查看服务详情。
通过开关可以快捷启用/禁用服务，服务禁用后，就不显示健康度且置灰，显示服务已禁用。
==== 拓扑视图
切换成拓扑视图后，将根据服务的依赖关系，组成服务的拓扑网络。网络上的每个节点代表一个服务，并根据服务健康度分值的危急程度，展示节点的颜色。
点击服务节点，可以钻取查看服务详情。
==== 服务详情
点击选中卡片或拓扑网络上的某个节点，可以跳转查看该卡片/节点代表的服务详情，包括服务列表、概要、指标、服务下属的监控项运行历史和服务关联的异常日志历史以及拓扑关系。监控项历史将聚合为 45 个分段，并独立给出每个历史分段的危急程度。
image::images/lynxee/service-details-abstract.png[]
点击切换到“指标”标签，则可查看服务相关的指标,并可以通过指标类型，指标名称及属性进行过滤搜索，指标类型包括原始指标和衍生指标，结果默认按异常度由高到低进行展示。
image::images/lynxee/service-details-kpi.png[]
点击切换到"异常日志"标签，则可查看服务相关的日志异常检测结果。可点击"打开详情页查看"跳转到日志异常检测任务历史页面，也可以在本标签页中进行常规的查看，修改操作。
image::images/lynxee/service-details-loganomally.png[]
点击切换到“拓扑关系”标签，则可查看服务的拓扑关系。
image::images/lynxee/service-details-topology.png[]
=== 设备看板
设备看板采用蜂窝图效果，从更传统和基础的角度，展示 IT 环境的整体运行状态。
image::images/lynxee-entities-kanban.png[]
设备看板提供分组方式，统计方式，展示指标和过滤条件四种操作。
你可以使用设备的任意属性来进行分组，包括索引字段名称和附加信息键名称。通常来说，业务线，机房，负责人等等都是比较好的分组方式。
你也可以选择最近、最大、平均三种统计方式，设备看板将以指定统计方式对选择时间范围内的指标进行计算，最终体现计算结果。
可选展示指标需在系统配置中预先定义。对应 yottaweb 配置项为: `Lynxee.custom_device_filter`。通常来说，建议设置为实际指标数据中代表单体服务器层次流量或饱和度的指标名称，比如 os.cpu.util%，os.mem.used%，os.disk.used%，os.disk.ops.total%，os.net.total等等。可以填写多个指标供界面选择，多个指标名称用逗号隔开即可。
你可以在设备看板上点击单个设备，钻取查看设备详情。
==== 设备详情
设备详情页，展示设备的属性，以及时序指标库中，所有和该设备相关的指标历史折线图，包括未被设置为监控项的指标。指标以健康度排序，优先展示当前有异常的指标。
image::images/lynxee-entity-detail.png[]
此外，在设备详情页上，还提供了搜索相关日志的入口。你可以点击打开日志易搜索页面，将自动代入该设备的索引字段值作为搜索语句，查看设备上传的日志信息。
== 指标异常检测
什么是异常：
根据Hawkins定义，某个或某些观测值远远偏离其他观测值以至于我们怀疑它是不是由另一种机理产生。
指标异常检测通过智能算法自适应的对接入的指标进行异常检测，从而观测IT环境的健康状态，是IT运维监控中最常用的智能运维方法。
=== 指标探索
导航栏点击打开"指标探索"页面。页面采用树状结构,指标类型名称保留以点分割树状结构的形式，内置第一层级分类，为基础架构，操作系统，中间件，数据库，业务，其他。
image::images/lynxee/kpi-tree.png[]
可以对多个指标序列进行对比，点击加入对比，可以把此序列加入对比中，可以加入多个，然后点击查看对比：
image::images/lynxee/kpi-comparison.png[]
在对比页面可以对某个序列退出对比，也可以清空所有。
为了跟踪模型的评价在新数据上的效果变化，用户可以搜索相应指标，点击评价开关，观察评价报告的趋势图：
image::images/lynxee/kpi-eval-trend.png[]
=== 指标生成
指标探索页面支持原始指标和衍生指标的生成。
原始指标： 通过对某些非指标数据基于某些属性进行采样聚合计算产生新的具有监控意义的原始指标，如对中间件日志中的非2xx请求进行统计。
image::images/lynxee/raw-data-gen.png[]
1. 指标名称： 必填项，填写一个有意义的指标名
2. 数据筛选条件：必填项，数据筛选
3. 聚合条件：必填项，目前支持COUNT、AVG、MIN、MAX、SUM 5种聚合计算；然后输入属性
4. 采样间隔：目前支持秒、分钟、小时 3种粒度
5. 按属性切分： 可以填入切分字段对指标进行切分，切分字段可以是多个，也可以选择是否保留聚合指标
6. 属性添加：对与创建的指标，用户可以添加其他属性
衍生指标： 经过原始指标聚合计算，可衍生出具有监控意义的新指标
image::images/lynxee/aggregated-data.png[]
1. 原始指标：必填，有意义的指标名称
2. 原始指标：必填，原始指标序列
3. 聚合条件：必填项，目前支持COUNT、AVG、MIN、MAX、SUM 5种聚合计算
4. 采样间隔: 目前支持秒、分钟、小时 3种粒度
5. 采样开始时间：采样开始的时间
6. 上采样： 其实是通常意义中的下采样，对细粒度数据进行粗粒度聚合，支持总计、平均、最大值、最小值、第一个值、最后一个值等聚合计算
7. 下采样：其实是通常意义上的上采样，对粗粒度的数据进行细粒度填充，支持原始值和平均值两种方式
8. 属性添加：对与创建的指标，用户可以添加其他属性
=== 模型训练和管理
点击指标探索页的“训练”操作，进入指标训练和模型管理页面。
image::images/lynxee/kpi-training-and-models.png[]
目前模型训练页面进行了优化，不再展示相关算法和参数，如果用户习惯老的页面，可以点击右下角的图标进行切换, 老页面的模型训练管理请参考《2.4.2》章节。
image::images/lynxee/new-old-switch.png[]
新建训练任务，自动选择缺省模式，此模式下，算法和参数的选择是自动，适用于未知类型指标或用户对指标不了解的场景；也可以根据指标的类型来选择内置的其他模式；如果用户对内置模式效果不满意，可以新建自定义模式后再选择此模式。
模式的选择可以一次选择多个，这样会一次启动多个训练任务得到多个模型。
在页面下方可以查看此指标历史训练任务，包括任务的状态，模型名称，选择的模式名称，算法，创建时间，和操作，任务的状态包括：应用中、初始化中、训练中、取消执行、执行失败、执行成功，模型的名称可以进行修改以便于用户留存；对于执行成功的任务可以进行删除，删除后相应模型会被删除，也可以执行应用操作；对于执行失败的任务可以进行删除和查看原因操作；应用中的模型置顶展示。
用户也可以基于状态，算法，模式进行过滤查询训练任务；
用户可以对模型进行对比和测试评价，以选出最优模型；
image::images/lynxee/model-testing.png[]
测试图中可以看到历史异常分值，原始值，上下界值，也可以根据需要调整敏感度；
=== 历史任务
点击“历史任务”，可以查看最近100个任务的状态，自动训练的任务，如果有异常，也记入。
image::images/lynxee/tasks-history.png[]
列表内容包括：任务类型（采集任务，训练任务，检测任务）、指标名、算法名、创建时间、模式名称、更新时间、状态、操作（错误时点击查看原因，正确时可以探索指标）
==== 批量训练
之前每次只能提交一个序列的训练任务，现在也可以对多个序列的训练进行批量提交，点击“新建”，可以进入批量训练页面。
image::images/lynxee/batch-train.png[]
搜索选取想要加入批量训练的指标序列，可以多次搜索选取，在已选指标中可以对指标再次进行调整或清空重选，最后点击“批量提交”进行训练任务的批量提交。