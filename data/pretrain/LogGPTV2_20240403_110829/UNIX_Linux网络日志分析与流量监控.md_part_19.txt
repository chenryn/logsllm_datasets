Reply-To:PI:EMAIL
From:PI:EMAIL
X-Mailer:YahooMailWebService/0.8.114.317681
51
第2章UNIX/Linux系统取证85
。王磊很高兴事情有了新的进展，他
---
## Page 109
试以后，有了重大的突破。
遗忘的Squid服务器
交换机的端口以便和计算机的MAC地址匹配起来。
是找到这个IP地址在物理上是从哪里连上网络的。要做到这一点，就要把该计算机连接到
“嫌疑人”更近了，尽管他还并不清楚该从何处开始。他认为追捕到这个IP地址的最佳办法
最终答案。张坤回到了自己的座位上继续跟踪刚才日志上的可疑IP。他感到非常兴奋，因为
发生了什么。张坤告诉了王磊新的进展，他为此很高兴，不过他希望张坤能尽快找到事情的
定再仔细查看一下Web服务器日志文件，这次主要是看一看这个可疑的IP地址：
用这个IP，王磊不能确定。但这个IP一定不属于后期制作服务器群所在的VLAN。张坤决
找到了“凶手”！他们发现了一个异常的IP地址，之前从来没有见过这个IP地址。这个IP
线索。
件又是怎么泄漏出去的呢？接下来王磊只好查看Web服务器日志文件，看看能否查到一点
些文件上传FTP服务器之后的SSH日志文件。
通过，也就是只允许通过 SSH、FTP 和 Apache 三种服务访问。于是张坤又让王磊检查在这
的方法能够获取这些文件。王磊解释说，这台主机设置了防火墙，只允许 21、22、80端口
86
使用ping命令看看Tom的计算机网卡的MAC地址是多少。
张坤得到了重要的信息，他立刻远程登录到服务器连接的Cisco 交换机上。经过几次尝
张坤首先ping这个IP地址，然后从ARP表中得到这台计算机的MAC地址。
UNIX/Linux网络日志分析与流量监控
张坤发现有一个人浏览了很多文件。在公司丢失更多的文件之前，张坤必须查清楚到底
王磊的眼睛亮了，张坤也惊喜地张大了嘴巴。192.168.1.11是公司内网地址，也许他们
同样的结果，张坤感到非常失落。现在的问题是，没有人访问过这些文件，那么这些文
192.168.1.11--[10/Sep/2010:23:55:36-0700]"GET/completed/less.aviHTTP/1.0"200 2552326
192.168.1.11--[10/Sep/2010:23:55:36-0700]"GET/completed/apple1.aviHTTP/1.0"200642326
192.168.1.11--[10/Sep/2010:23:52:24 -0700] "GET /completed/hawk.avi HTTP/1.0" 200 2323336
192.168.1.11--[10/Sep/2010:23:51:36-0700] "GET/completed/movie-cab.avi
192.168.1.11-[10/Sep/2010:23:55:36-0700]"GET/completed/hawk.avi HTTP/1.0"2002323336
#grephawk.avi /var/log/apache/
Sep 10 22:13:38 postprod sshd[3211]:Accepted password for wanglei from 192.168.0.3 port 49172 ssh2
192.168.1.11--[10/Sep/2010:14:00:38-0700]"GET/completed/pool.avi HTTP/1.0"200662326
Sep1018:03:18postprod sshd[3211]:Accepted password forwangleifrom192.168.0.3port 49172 ssh2
Sep 10 17:24:58 postprod sshd[3211]:Accepted password for wanglei from 192.168.0.3 port 49172 ssh2
HTTP/1.0200
2
---
## Page 110
悉以上方法，在排除故障时可达到事半功倍的效果。
然后根据综合布线时的跳线表就可直接连到这台计算机。接下来关闭该端口。
SW-440-2-4这台交换机，输入MAC查找。
终于找到它了，在SW-440-2-4Gig3/2143SIWS-C3550-2Gig0/2上。下面我们直接登录到
从结果看这是通过千兆端口连接。看看邻居（这是核心交换机的二级级联交换机）。
下一步，要知道他的计算机是接到哪台交换机上。
从本机的ARP 缓存里看这个可疑IP 地址的MAC 地址为 00-0d-56-21-af-d6，登录交换机
张坤发现了这个系统就连在服务器交换机的第23个端口上，于是冲下大楼直奔小机
作为管理人员，快速定位交换机端口，
注意：
00
Total MacAddressesfor thiscriterion:1
SW-440-2-4#showmac-address-table dynamicaddress 000d.5621.afd6
BJ-SW-419-1-4#sh cdp neighbors
Internet192.168.1.11
BJ-Sw#showarp|in192.168.1.11
SW-440-2-4
SW-440-1-4
SW-419-1-3
SW-419-2-3
DeviceID
Capability Codes:RRouter,TTransBridge,B-ourceRouteBridge
Vlan
UnicastEntries
BJ-SW#showmac-address-tabledynamicaddress000d.5621.afd6
192.168.1.11
192.168.1.1
InternetAddress
Interface:192.168.3.41onInterface 0x1000003
20
vlan-
000d.5621.afd6dynamic ip,ipx
000d.5621.afd6
MacAddress
Gig3/2
Gig3/1
Gig3/3
Gig3/4
Physical Address
Local Intrfce
00-0d-56-21-af-d6
00-30-ab-04-26-dd
S-Switch,H-Host,I-IGMP,r-Repeater,P-Phone
DYNAMIC
Type
3000d.5621.afd6ARPAVlan20
Holdtme
143
173
，找出 IP和MAC 对应关系是必须掌握的技能，熟
3
dynamic
dynamic
Type
Ports
Fa0/23
CapabilityPlatformPortID
SI
SI
SI
第2章UNIX/Linux系统取证87
GigabitEthernet3/2
WS-C3550-2Gig0/2
WS-C3550-4Gig0/2
WS-C3550-4Gig 0/2
WS-C3550-4Gig0/2
port
熟
---
## Page 111
己的座位决定做一些侦察工作。他想继续跟踪这个黑客，并且一定要给他一点儿颜色看看。
件。张坤回到小机房，拔掉代理服务器外网口的网线（这段是连接互联网的）。然后回到自
外网的接口，防止黑客卷土重来。王磊同意张坤的建议，至少他们不能再泄露更多胶片文
今晚再次“造访”，以便抓个正着。
文件，张坤清楚地知道黑客在昨天夜里访问过两部电影的胶片。他非常希望这个黑客能够在
在应该看看这个文件：
不是容易的事，如何将 access.log的 IP 提取出来呢？张坤使用以下命令：
张坤很容易就查到 access.log 文件，现在他可以查出任何一个登录过该服务器的人。
疑点分析
互动问答
望这一次能有所发现。
令清单交给了张坤。张坤迅速回到自己的座位开始工作。他登录到 Squid 代理服务器上，希
难题。王磊倒是给张坤提供了一些有用的线索，他把前任经理给他留下的服务器用户名及口
多没有使用了，而且自从他升职后，这台服务器也确实没有使用过。
签，上面写着Squid Proxy Server。这时张坤立刻有种反胃的感觉，因为这台服务器至少1年
部有两块网卡。他从网线堆里爬出来，无奈地看着这台机子，机箱上面贴着一张发黄的标
头疼，查找问题花去了张坤很多的时间。最后终于找到了连接的主机。张坤发现，该主机内
房，迅速来到Catalyst交换机前找到第23端口，开始顺藤摸瓜。可杂乱繁多的网线，一看就
88UNIX/Linux网络日志分析与流量监控
张坤赶紧跑到王磊的办公室，把这个消息告诉了他。找到了“凶手”，王磊感到轻松
张坤迅速打开终端，用 SSH登录到服务器，使用root 用户和口令，成功登录系统了。
张坤现在根本不能确定黑客到底是从哪儿入侵的，代理服务器又为他们的调查出了一个
显然，在公司网络以外的人通过代理服务器进入过后期制作的Web服务器。通过日志
张坤看到了他最不愿看到的事——该文件最后一次修改的时间是今天的凌晨3：00。现
这时问题出现了，由于Squid服务器工作时间长，squid.log的日志非常庞大，查个IP也
5）如何查到拨号用户的来源？
4）如何通过网络工具查找？
3）张坤是如何通过邮件头信息找到那个IP的？
2）
1）在FTP和SSH日志中都没有找到充分的证据，这说明了什么？
squidbox#awk'{print $3;}'access.log
张坤使用跟踪代理服务器的方法是最佳方法吗？
892710014.0161400910.100.4x.5xTCP_MISS/304126GEThttp://192.168.2.3/completed/less.avi--
squidbox# tail/usr/local/squid/logs/access.log
-rw-rw-r--1 squid squid 2838159 Sep 11 03:25 access.log
squidbox#1s-1/usr/local/squid/logs/access.logE
品
---
## Page 112
样可更好地运行多个虚拟蜜罐操作系统。
其他都是基于虚拟机之上。安装虚拟机系统的宿主计算机（蜜网网关）的配置要求稍高，这
网技术，构建集网络攻击和防御于一体的网络安全平台。虚拟蜜网部分，除管理计算机外，
单一主机上模拟出整个蜜罐系统的解决方案，它是基于最新虚拟机软件VMware9和虚拟蜜
而访问蜜罐的网络连接，都由重定向器引向蜜网，而攻击者往往无法察觉。本文描述的是在
处理，如iptables、Snort、SebekServer、Walleye等。访问业务主机的流量不经过蜜网网关，
控制蜜网网络的枢纽，在网关上安装多种工具软件，对数据进行重定向、捕获、控制和分析
机下的蜜罐系统。下面的内容讲述了架设蜜罐系统的注意事项。
诱捕人侵者
诱捕黑客，以便获得更多的证据。
因为此类入侵事件具有时效性，错过这个村就没这个店。这时张坤决定架设一套蜜罐系统来
由于IDS等网络设备昂贵，他们所在的公司无力更换新的安全设备，所以他设计了虚拟
架构详情如图2-10所示。
·Eth2是用作远程管理，具有实际IP地址，可把出入虚拟蜜罐系统的数据包及蜜网系
接口描述：在虚拟蜜网网关中，有3个网络接口。
一般情况下，蜜网由蜜网网关、入侵检测系统及若干个蜜罐主机组成。其中蜜网网关是
●Eth0是面向业务网络的外部接口。
统日志转发给一台作远程管理的主机。
攻击者是透明不可见的，入侵者不会识别出其所攻击的网络是一个蜜网系统。
据包经过网关时TTL值不会变化，也不会提供自身的MAC地址，因此蜜网网关对于
Eth1是面向多虚拟蜜罐系统的内部接口，EthO和 Ethl 在网桥模式，均无IP地址，数
业务系统
罐管理主机
内
图2-10虚拟蜜罐架构图
路由器
eth2
防火墙
路由器
第2章UNIX/Linux系统取证89
Windo
虚拟蜜罐
M
一
IDS
网管主机
---
## Page 113
即邮件从MUA传送到发件人服务器的轨迹信息。
站”，即传送到收件人服务器的轨迹信息；以及最下面的Received字段，邮件的“第一站”，
字段会多于两个。对取证来说，只用到两个，包括最上面的Received字段，邮件的“最后-
段被伪造的情况下，通过对Received字段信息的分析，也能发现伪造者的蛛丝马迹。
Transfer Agent）上的痕迹，因此一般能够提供真实的邮件传输历史记录。即使在其他信头字
信头信息。
邮件服务器在处理该邮件时逐个添加的，收件人的MUA在最后收取邮件时一般不会添加
出的是信头信息是由发件人 MUA（Mail User Agent）、发件人和收件人邮件服务器、中继
问控制列表），拒绝来自因特网对内网的访问。
的物理连接，因为这台服务器并没有使用。如果要用这台服务器，应该配置合理的ACL（访
客再次通过代理服务器“造访”。考虑到他们面临的处境和老板所给的指示，计划给黑客设
是最好的办法。张坤在最初的调查中应该断开代理服务器外部接口的连接，这样可以防止黑
进行检查。
取视频文件的日志时，最初的调查大多集中在某些特定的日志文件上，而没有对所有的文件
疑难解析
请人电话、住址及姓名。
于找到了，张坤松了口气。下面只要通过电信找到这个人是在哪里拨号上网的，就能找到申
使用 nslookup查看了该IP 的 DNS 服务器的主机名、域名、地址。
来架设好蜜网系统，就等神秘人再次“造访”，以便获取更多有价值的日志信息。张坤先
90UNIX/Linux网络日志分析与流量监控
1）由于在FTP或SSH日志文件中没有发现可疑的活动，调查人员在寻找服务器和被窃
邮件的传递需要通过中继服务器中转，最后才抵达收件人服务器MTA。所以Received
2）在局域网中跟踪一个捣乱的系统的确很繁琐。张坤的方法虽然花了大量时间，但仍
Received 字段是最重要的分析渠道，是邮件服务器自动记录的邮件在 MTA（Message
第一个Received字段：
说明：
hotmail.com with Microsoft SMTPSVC (6.0.3790.4675); Sat, 24 Sep 2010 08:17:50-0700
囿于篇幅，本书仅选取信头信息中对证据认定起到重要作用的字段进行分析。首先指
3）通过邮箱中发送的邮件信头信息分析。
经过综合分析，比较邮件头信息和蜜罐系统中找到的IP，完全吻合，这回发送者IP 终
Address:10.100.4x.5x
Address:10.1.1.11
Server:nsl.movie.com
#nslookup10.100.4x.5x
chewie.someisp.ru
1
---
## Page 114
细。在电信局查询注册电话号码就知道主人是谁。
IP:202.107.2.x，操作系统Windows7，拨号电话12345678，当然实际记录信息比这个还要详
此同时记录以下时间信息：2013年2月28日18时30分29秒，101023123383894（账号），
动态IP，ISP会根据你的宽带 ADSL 账号、密码随即在一个地址池中分配一个 IP 地址，与
用户的上网记录、上网IP反查出用户上网的线路信息，然后进一步追踪到用户的身份。
身份追查，而在技术层面需要提供的信息，通常就是用户的精确定位信息，也就是说，通过
图2-11所示。
源就要利用电信内部的认证/计费记录和用户信息/系统配置数据库才能查到有用信息。如
音业务和数据业务是分离的，所以不能直接获得用户的电话号码，这时要获取用户的真实来
前应用比较广泛的ADSL宽带接入，用户接入来源的确认就没有那么直观了。主要问题是语
户的主叫电话号码，并通过RADIUS服务器中存储的用户信息确定用户的接入来源；对于目
PSTN或ISDN方式PPP接入，调查这类用户的地址可以根据自动号码识别ANI技术获取用
查找到非法接入点。
是发送邮件计算机的真实IP地址。
是由发件人服务器核查后取得的使用MUA发送邮件的计算机的IP地址，因此可以直接确定
认是中国电信某城市分公司使用的，电信分配的地址是动态IP地址）。
IP 地址，该地址通过登录中国互联网络信息中心 CNNIC IP 地址注册信息查询系统查询，确
Mail直接生成邮件发送，因此信息中没有邮件发送者使用的计算机名称（但有该终端使用的
这个字段揭示了该邮件的真实发送时间为2010年9月24日23:17:48，由于是通过Web
传送到域名为web15604.mail.cnb.yahoo.com的邮件服务器。