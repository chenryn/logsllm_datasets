When Execution is Successful
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
The following is recorded when an SDB file is installed.
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\sdbinst.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Process Information -> Process Name: "C:\Windows\System32\sdbinst.exe"
- Confirmable Information
- SDB File: Object -> Object Name ("C:\Windows\AppPatch\Custom\{[GUID]}.sdb")
- Handle ID: Object -> Handle ID *Used for association with other logs
- Process ID of the Process that Requested the Handle: Process Information -> Process ID
(matches the ID of the process created in event 4688)
Event Log
- Process Details: Access Request Information -> Access / Reason for Access
- Required
("WriteData (or AddFile)" / "AppendData
Security
(or AddSubdirectory, or CreatePipeInstance")
- Success or Failure: Keywords ("Audit Success")
If an application is executed as a bypass, the following is recorded.
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[Command Executed as Bypass]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
Host
- - An ID of the Process of an Application Used for a Bypass That Executed the Application: Process Information -> Creator Process ID
(Windows)
Matches the process ID of an application used for a bypass
- Process Return Value: Process Information -> Exit Status
"0x0" if successful. If failed, a different value is entered according to the error. Depending on the application
used for a bypass, such as one executed from a command prompt, the return value may not be "0x0" only by
executing it as usual. For this reason, this information can be a reference for measuring whether the execution was
*Although "an application executed as a bypass" is always started following "an application used for a bypass," it may be ended before or after
the other application depending on how it is called.
The following is recorded when an SDB file is installed.
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\sdbinst.exe"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- Used SDB File: CommandLine
- User Name: User
- Process ID: ProcessId
Event Log If an application is executed as a bypass, the following is recorded.
- Required
Sysmon
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "[Command Executed as Bypass]"
- Confirmable Information
- Process Start Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
- Parent Process Name: ParentImage *An application specified in SDB.
An application that is normally assumed not to be the parent of a process becomes its parent process.
- Parent Process ID: ParentProcessId *Matches the process ID of an application specified in SDB that was executed first.
*If the process is for script files for batch processing or others, the process becomes the parent process and a child process will be
further executed. By tracking process IDs in order, it is possible to confirm the process tree of the executed applications.
48
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Application and Service
Event ID: 500 (Compatibility fix applied)
Log
\Microsoft\Windows - Confirmable Information -
\Application- - Program Applied: Details Tab -> UserData\CompatibilityFixEvent\ExePath
Experience - Program Fix: Details Tab -> UserData\CompatibilityFixEvent\FixName
\Program-Telemetry
File name:
C:\Windows\Prefetch\SDBINST.EXE-5CC2F88B.pf
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Execution History
- Last Execution Time and Date: Last Execution Time
- -
Prefetch
- Remarks
- In addition to the above, the last execution date and time of the application used for a bypass and executed application will change.
Registry Entry:
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{[GUID]}.sdb
- Confirmable Information
- Host - Content of SDB: DisplayName (The name of an application used for a bypass)
(Continued from (Windows) - Delete Command: UninstallString ("%windir%\system32\sdbinst.exe -u "C:\Windows\AppPatch\Custom\{[GUID]}.sdb")
the previous (Continued from the
entry) previous entry)
Registry Entry:
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom\
{[Name of Application Used for UAC Bypass]}
- Confirmable Information
- SDB Installation Time Stamp: DatabaseInstallTimeStamp (A hexadecimal value)
Execution History
- -
Registry Registry Entry:
HKEY LOCAL MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB\{[GUID]}
- Confirmable Information
- SDB File Path: DatabasePath ("C:\Windows\AppPatch\Custom\{[GUID]}.sdb")
- SDB Type: DatabaseType
- Content of SDB: DatabaseDescription (The name of an application used for a bypass)
- SDB Installation Time Stamp: DatabaseInstallTimeStamp (A hexadecimal value. The same value as one under
"Custom" stated the above.)
- Remarks
- The above registry value is deleted when the SDB file is uninstalled and will not always be left.
- Some tools in which an SDB file is uninstalled to delete evidence have been confirmed.
Remarks
Additional Event Logs That Can Be Output - In addition to the above, "the application used for a bypass" and "the application executed as a bypass" may be recorded.
49
3.9.1. MS14-068 Exploit
Basic Information
Tool Name MS14-068 Exploit Legend
Category Capturing the Domain Administrator Privilege and Account Credentials - Acquirable
Tool Overview Changes the privileges of the domain user to those of another user Information
- Event ID/Item Name
Tool This tool is used to perform operations requiring privileges pretending as an administrator by using an acquired domain user account.
Example of - Field Name
(For this test, Exploit is used to get the account's TGT ticket and mimikatz is used to log in remotely.)
Presumed Tool Use - "Field Value"
- Source host: Exploit execution source
During an Attack
- Destination host: Machine logged in remotely with the acquired ticket
Authority Standard user
Targeted OS Windows
Operating Domain Required
Condition Communication
88/tcp, 445/tcp
Protocol
Service Active Directory Domain Services
Information Standard Settings - Source host: Execution history (Prefetch)
Acquired from - Source host: Execution history (Sysmon / audit policy)
Additional Settings
Log - Destination host: The fact that higher privileges than the normal privileges are granted to other accounts (audit policy)
Evidence That Can Be Confirmed - Destination host: In the Event ID: 4672 of the event log "Security", high level privileges are granted to a standard user.
When Execution is Successful
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
When a ticket is generated, the following process is executed.
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name (ms14-068.exe)]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "\device\harddiskvolume2\[File Name (ms14-068.exe)]"
- Application Information -> Process ID: "[Process ID Recorded in Event 4688]"
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Domain Controller IP Address]"
- Network Information -> Destination Port / Protocol: "88" / "6"(TCP)
- Confirmable Information
- Source Port: Source Port *Used for association with logs on the Domain Controller side
When a ticket is used, the following process is executed.
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
OS: Windows
user Event ID: 4656 (A handle to an object was requested)
Event Log
↓
4663 (An attempt was made to access an object)
Source host - Required
OS: Windows 4658 (The handle to an object was closed)
Security
Server - Process Information -> Process Name: "[File Name (ms14-068.exe)]"
administrator
- Confirmable Information
- Target File: Object -> Object Name
- Handle ID: Object -> Handle ID *Used for association with other logs
- Process Details: Access Request Information -> Access ("WriteData (or AddFile)" / "AppendData
(or AddSubdirectory, or CreatePipeInstance)")
- Success or Failure: Keywords ("Audit Success")
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "System"
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Domain Controller IP Address]"
- Network Information -> Destination Port / Protocol: "445" / "6"(TCP)
- Confirmable Information
- Source Port: Source Port *Used for association with logs on the Domain Controller side
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "[\device\harddiskvolume2\windows\system32\lsass.exe"
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Domain Controller IP Address]"
- Network Information -> Destination Port / Protocol: "88" / "6"(TCP)
- Confirmable Information
- Source Port: Source Port *Used for association with logs on the Domain Controller side
In the case of mimikatz.exe, when an acquired ticket is used, the use of privileges (failure) occurs. (It does not occur when mimikatz.exe is
executed with administrator privileges.)
Event ID: 4673 (A privileged service was called)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Process Information -> Process ID: "[Process ID of the Tool]"
- Service Request Information -> Privileges: "SeTcbPrivilege"
- Keyword: "Audit Failure"
- Confirmable Information
- Account That Attempted the Above Operation: Account Name
50
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "[File Name (ms14-068.exe)]"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
Event Log
- Required
Sysmon
Event ID: 1 (Process Create)
Source host 5 (Process Terminated)
(Continued from the - Image: "[File Name (mimikatz.exe)]"
previous entry)
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
File name:
C:\Windows\Prefetch\[File Name (MS14-068.EXE)]-[RANDOM].pf
Execution History
C:\Windows\Prefetch\[File Name (MIMIKATZ.EXE)]-[RANDOM].pf
- -
Prefetch - Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
- Last Execution Time and Date: Last Execution Time
When a ticket is generated, the following communication and authentication occur.
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "[\device\harddiskvolume2\windows\system32\lsass.exe"
- Application Information -> Process ID: "[Process ID Recorded in Event 4688]"
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Domain Controller IP Address]"
- Network Information -> Destination Port / Protocol: "88" / "6"(TCP)
- Confirmable Information
- Source Port: Source Port *Used for association with logs on the Domain Controller side
Event ID: 4768 (A Kerberos authentication ticket (TGT) was requested)
- Service Information -> Service Name: "krbtgt"
- Additional Information -> Ticket Options: "0x50800000"
- Confirmable Information
- Executing Account: Account Information -> Account Name
- Source Host: Network Information -> Client Address
- Source Port: Network Information -> Client Port
OS: Windows
user Event ID: 4769 (A Kerberos service ticket was requested)
↓ - Service Information -> Service Name: "krbtgt"
- Additional Information -> Ticket Option: "0x50800000"
OS: Windows
Server
- Confirmable Information
administrator
- Executing Account: Account Information -> Account Name / Account Domain
(Continued from
- Source Host: Network Information -> Client Address
the previous - Source Port: Network Information -> Client Port
entry)
When an acquired ticket is used, the following communication occurs.
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "System"
- Application Information -> Process ID: "[Process ID Recorded in Event 4688]"
- Network Information -> Direction: "Outbound"
Event Log - Network Information -> Destination Address: "[Domain Controller IP Address]"
Destination host - - Network Information -> Destination Port / Protocol: "445" / "6"(TCP) Required
Security
- Confirmable Information
- Source Port: Source Port *Used for association with logs on the Domain Controller side
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "[\device\harddiskvolume2\windows\system32\lsass.exe"
- Application Information -> Process ID: "[Process ID Recorded in Event 4688]"
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Domain Controller IP Address]"
- Network Information -> Destination Port / Protocol: "88" / "6"(TCP)
- Confirmable Information
- Source Port: Source Port *Used for association with logs on the Domain Controller side
Event ID: 4769 (A Kerberos service ticket was requested)
- Confirmable Information
- Client IP Address: Network Information -> Client Address
- Ticket Request Type (Two different pairs of ticket requests are output.)
- Service Information: "[Host Name]$", Ticket Option: "0x40810000"
- Service Information: "krbtgt", Ticket Option: "0x60810010"
Event ID: 4672 (Special privileges assigned to new logon)
- Confirmable Information
- Account with Escalated Privileges: Subject -> Account Name / Account Domain
- Available Special Privileges: Special Privileges ("SeSecurityPrivilege" / "SeRestorePrivilege" / "SeTakeOwnershipPrivilege" /
"SeDebugPrivilege" / "SeSystemEnvironmentPrivilege" / "SeLoadDriverPrivilege" / "SeImpersonatePrivilege" /
"SeEnableDelegationPrivilege")
Event ID: 4624 (An account was successfully logged on)
- Logon Type: "3"
- Confirmable Information
- Used Security ID: New Logon -> Security ID
*If the security ID used and the account does not correspond, this value is the security ID of the captured account.
- Account: Account Name / Account Domain
- Host which Requested Logon: Network Information -> Source Network Address
Remarks
Additional Event Logs That Can Be Output Logs of commands executed with escalated privileges may be recorded at the destination host.
51
3.9.2. Mimikatz (Golden Ticket)
Basic Information
Tool Name Mimikatz (Golden Ticket) Legend
Category Capturing the Domain Administrator Privilege and Account Credentials - Acquirable
Tool Overview Issues an unauthorized Kerberos ticket that is valid for an arbitrary period and grants access without additional authentication Information
Tool - Event ID/Item Name
Example of This tool is used to grant a host concealing a record of authentication requests access using the Golden Ticket.
- Field Name
Presumed Tool Use - Source host: Mimikatz execution source
- "Field Value"
During an Attack - Destination host: The host logon in by Mimikatz
Standard user
Authority
*The NTLM password hash for a krbtgt account on the domain must have already been acquired.
Targeted OS Windows
Operating
Domain Not required
Condition
Communication
-
Protocol
Service Active Directory Domain Service
Standard Settings - Source host: Execution history (Prefetch)
Information
- Source host: Execution history (Sysmon / audit policy)
Acquired from
Additional Settings Access history (Sysmon - RawAccessRead, audit policy - Use of important privileges)
Log
- Destination host: Logon by an account with an illegal domain
Evidence That Can Be Confirmed - Destination host: If the following log is in the event log, it is considered that unauthorised logon was attempted.
When Execution is Successful - In the event IDs 4672, 4624, and 4634 in the event log "Security", a logon attempt by an account with an illegal domain is recorded.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain