Network Profiling Using Flow
Austin Whisnant
Sid Faber
August 2012
TECHNICAL REPORT
CMU/SEI-2012-TR-006
ESC-TR-2012-006
CERT® Program
http://www.sei.cmu.edu
Copyright 2012 Carnegie Mellon University.
This material is based upon work funded and supported by United States Department of Defense under Contract No.
FA8721-05-C-0003 with Carnegie Mellon University for the operation of the Software Engineering Institute, a federally
funded research and development center.
Any opinions, findings and conclusions or recommendations expressed in this material are those of the author(s) and do
not necessarily reflect the views of the United States Department of Defense.
This report was prepared for the
SEI Administrative Agent
AFLCMC/PZE
20 Schilling Circle, Bldg 1305, 3rd floor
Hanscom AFB, MA 01731-2125
NO WARRANTY
THIS CARNEGIE MELLON UNIVERSITY AND SOFTWARE ENGINEERING INSTITUTE MATERIAL IS
FURNISHED ON AN “AS-IS” BASIS. CARNEGIE MELLON UNIVERSITY MAKES NO WARRANTIES OF ANY
KIND, EITHER EXPRESSED OR IMPLIED, AS TO ANY MATTER INCLUDING, BUT NOT LIMITED TO,
WARRANTY OF FITNESS FOR PURPOSE OR MERCHANTABILITY, EXCLUSIVITY, OR RESULTS
OBTAINED FROM USE OF THE MATERIAL. CARNEGIE MELLON UNIVERSITY DOES NOT MAKE ANY
WARRANTY OF ANY KIND WITH RESPECT TO FREEDOM FROM PATENT, TRADEMARK, OR COPYRIGHT
INFRINGEMENT.
This material has been approved for public release and unlimited distribution except as restricted below.
Internal use:* Permission to reproduce this material and to prepare derivative works from this material for internal use is
granted, provided the copyright and “No Warranty” statements are included with all reproductions and derivative works.
External use:* This material may be reproduced in its entirety, without modification, and freely distributed in written or
electronic form without requesting formal permission. Permission is required for any other external and/or commercial
use. Requests for permission should be directed to the Software Engineering Institute at permission@sei.cmu.edu.
® CERT is a registered trademark owned by Carnegie Mellon University.
* These restrictions do not apply to U.S. government entities.
SEI markings v3.2 / 30 August 2011
Table of Contents
List of Figures iii
List of Tables v
Acknowledgments vii
Abstract ix
1 Introduction 1
1.1 Sample Data 2
1.2 The SiLK Analysis Tool Suite 2
1.3 Keeping Track of Findings 3
1.4 Extending the Analysis 3
2 Gather Available Network Information 4
2.1 Sample Network Information 4
3 Select an Initial Data Set 5
3.1 Sensor Placement and Configuration 5
3.2 Guidelines 6
3.3 Validating the Selection 7
3.3.1 Sample Network Data Set Validation 8
4 Identify the Monitored Address Space 10
4.1 TCP Talkers 10
4.2 Other Talkers 11
4.3 Aggregating Hosts 11
4.4 Supplemental Analysis and Validation 12
4.5 Anomalies 12
5 Catalog Common Services 14
5.1 Web Servers 14
5.1.1 The Process 14
5.1.2 How to Validate Findings 15
5.1.3 Anomalies 17
5.1.4 Results 18
5.2 Client Web 19
5.2.1 The Process 19
5.2.2 How to Validate Findings 21
5.2.3 Anomalies 22
5.2.4 Results 23
5.3 Email 24
5.3.1 The Process 24
5.3.2 How to Validate Findings 25
5.3.3 Anomalies 26
5.3.4 Results 27
5.4 Domain Name System 28
5.4.1 The Process 28
5.4.2 How to Validate Findings 30
5.4.3 Anomalies 31
5.4.4 Results 32
CMU/SEI-2012-TR-006 | i
5.5 Virtual Private Networks 33
5.5.1 The Process 34
5.5.2 How to Validate Findings 35
5.5.3 Anomalies 36
5.5.4 Results 37
5.6 Remote Services 38
5.6.1 The Process 38
5.6.2 How to Validate Findings 40
5.6.3 Anomalies 42
5.6.4 Results 42
5.7 Other Services 43
5.7.1 The Process 43
5.7.2 How to Validate Findings 45
5.7.3 Anomalies 46
5.7.4 Results 46
6 Catalog Remaining Active Assets 47
6.1 The Process 47
6.2 Example Findings 48
6.3 Results 49
7 Maintain the Profile 51
8 Conclusion 52
Appendix A Sample Network Profile 53
Appendix B Scripts 57
References 62
CMU/SEI-2012-TR-006 | ii
List of Figures
Figure 1: Network Profiling Process Cycle 1
Figure 2: SiLK Flow Types 2
Figure 3: Example Sensor Placement 6
Figure 4: Top Five IP Protocols on the Sample Network 8
Figure 5: Destination Ports for Outbound Traffic from the Sample Network 9
Figure 6: Source Ports for Outbound Traffic from the Sample Network 9
Figure 7: Active Hosts 10
Figure 8: Process for Finding Web Clients 19
Figure 9: Recursive DNS Servers 30
CMU/SEI-2012-TR-006 | iii
CMU/SEI-2012-TR-006 | iv
List of Tables
Table 1: Example Profiling Spreadsheet 3
Table 2: Sensor Placement Guidelines 5
Table 3: Guidelines for Selecting a Data Set 6
Table 4: Validating the Initial Data Set 7
Table 5: Active TCP Host Criteria 10
Table 6: Potential Web Servers for the Sample Network 15
Table 7: Validated Web Servers for the Sample Network 18
Table 8: Services for Normal Client Web Traffic 19
Table 9: Potential Web Clients for the Sample Network 21
Table 10: Final Web Clients for the Sample Network 23
Table 11: Email Ports and Protocols 24
Table 12: Potential Email Servers for the Sample Network 24
Table 13: Validated Email Assets for the Sample Network 27
Table 14: Potential DNS Assets for the Sample Network 30
Table 15: Final DNS Assets for the Sample Network 32
Table 16: VPN Technologies 33
Table 17: Potential VPN Gateways for the Sample Network 35
Table 18: Validated VPN Assets for the Sample Network 37
Table 19: Potential Remote Assets for the Sample Network 40
Table 20: Validated Remote File Services Assets for the Sample Network 42
Table 21: Assets for Other Services 46
Table 22: Final Assets from Leftovers in the Sample Network 50
Table 23: Final Sample Network Profile 53
CMU/SEI-2012-TR-006 | v
CMU/SEI-2012-TR-006 | vi
Acknowledgments
Special thanks to George Jones in the CERT Program for helping produce the System for Internet-
Level Knowledge (SiLK) command-line arguments and shell scripts.
Thanks to the organization that provided sample data for the case study.
CMU/SEI-2012-TR-006 | vii
CMU/SEI-2012-TR-006 | viii
Abstract
This report provides a step-by-step guide for profiling—discovering public-facing assets on a
network—using network flow (netflow) data. Netflow data can be used for forensic purposes, for
finding malicious activity, and for determining appropriate prioritization settings. The goal of this
report is to create a profile to see a potential attacker’s view of an external network.
Readers will learn how to choose a data set, find the top assets and services with the most traffic
on the network, and profile several services. A case study provides an example of the profiling
process. The underlying concepts of using netflow data are presented so that readers can apply the
approach to other cases. A reader using this report to profile a network can expect to end with a
list of public-facing assets and the ports on which each is communicating and may also learn other
pertinent information, such as external IP addresses, to which the asset is connecting. This report
also provides ideas for using, maintaining, and reporting on findings. The appendices include an
example profile and scripts for running the commands in the report. The scripts are a summary
only and cannot replace reading and understanding this report.
CMU/SEI-2012-TR-006 | ix
CMU/SEI-2012-TR-006 | x
1 Introduction
A network profile is an inventory of all the assets on a network and their associated purpose. Such
a profile can enable network administrators to better consider how decisions about configuration
changes will affect the rest of the assets on the network. Security administrators can evaluate the
profile for assets that violate policy and for any suspicious activity. Business administrators can
use the profile to help guide long-term plans for network upgrades and staffing. As the profile
changes over time, network operators and defenders can monitor for emerging concerns. This, in
turn, can lead to policy changes and reallocation of network resources.
This report discusses the steps for creating a profile of externally facing assets on mid-sized to
large networks serving thousands to hundreds of thousands of users. The steps involve analysis of
traffic over ports, protocols, and other network flow (netflow) data available at the perimeter
gateways. While some of the steps may be useful for profiling traffic on an intranet, there are
additional issues related to intranets that are not addressed in this report. By the end of this
tutorial, you should have a list of assets combined with the ports on which each is communicating
and notes on any associated questionable activity.
The general steps for network profiling as detailed in this report are as follows: (1) gather
available network information, (2) select an initial data set, (3) identify the active address space,
(4) catalog common services, (5) catalog other services, (6) catalog leftover assets, and (7) report
on findings. These steps can be turned into a cyclic feedback loop to maintain the profile as
shown in Figure 1.
Report on Gather
findings information
Catalog Select an
leftover initial data
assets set
Maintain
the Profile
Catalog
Identify
other
active assets
services
Catalog
common
services
Figure 1: Network Profiling Process Cycle
Before beginning, ensure there are enough resources to devote to this exercise. This process
should be completed within a fixed amount of time so that the results are relevant. For networks
with relatively fixed assets, this process could take place over one to two months. For faster
changing networks, it could take place in as little as one to two weeks. The amount of time and
CMU/SEI-2012-TR-006 | 1
other resources that it will take to complete the process depends primarily on the size of the
network and how well the assets conform to networking common practices.
Throughout this report, validation will be discussed as a key component of the profiling process.
It is essential to validate results before adding them to the profile. In general, there are two types
of validation: active and passive. Passive validation uses only stored data without extra resources.
Active validation involves using manual effort to validate initial findings by attempting to make
connections to the specific IP address and using third-party references. For example, one can
validate a potential web server by browsing to port 80 or by performing a name server lookup on
that IP address. When manual validation is not possible through these means, communication with
the owner or administrator of the device may be necessary, if possible.
This process uses netflow traffic to perform an analysis. We used the System for Internet-Level
Knowledge (SiLK)1 tool to collect and analyze the traffic, and we include examples of the SilK
commands and results of the commands in each of the steps. However, the steps apply to any flow
analysis tool.
1.1 Sample Data
We demonstrate how to create a network profile using sample data collected from the perimeter of
an enterprise network. These data were anonymized after analysis to protect the confidentiality of
the network owner without impairing the data’s usefulness.
1.2 The SiLK Analysis Tool Suite
Because the case study in this report uses SiLK for analysis, you should understand how SiLK
records flow data.
SiLK deals with uniflow traffic, meaning traffic coming into the network is recorded as separate
flows from traffic going out of the network. Although SiLK differentiates between inbound and
outbound traffic based on the source and destination IP addresses, it does not attempt to identify
traffic as either client or server, as do some other flow platforms.
SiLK is configured by setting an address range for the internal network. The type of flow is then
based on whether the source and destination IP addresses are inside or outside of that range. As
shown in Figure 2, a flow of type “in” is defined as traffic with an external source address and
internal destination address. A flow of type “out” is defined as traffic with an internal source
address and an external destination address.
Out
Internal
range
In
Figure 2: SiLK Flow Types
1 For more information, visit http://tools.netsa.cert.org/silk/.
CMU/SEI-2012-TR-006 | 2
Web traffic is separated from all other traffic and is defined in SiLK by default as traffic to or
from ports 80, 443, or 8080 and is labeled as “inweb” or “outweb” based on the same reasoning as
flows of type “in” or “out.”
1.3 Keeping Track of Findings
A spreadsheet like Table 1 is extremely useful to record findings throughout the profiling process.
The headers you choose will depend on the information that is needed about the network and may
be adapted for each step of the process.
Table 1: Example Profiling Spreadsheet
Internal IP Protocol Internal Port Internal External IP External Port External Comments
Name Name
Throughout the process, record the commands and tools used to gather and validate the data. This
record will enable automation of certain parts of the process, making future updates less labor
intensive, and will allow for reproducible results. As an example, shell scripts have been included
in Appendix B of this report. Note that the scripts are provided only for reference and may or may
not be appropriate for a specific network.
1.4 Extending the Analysis
The steps in this report are, by no means, the only way to use network flow data to learn about a
network. As you get comfortable using the features of the analysis tool, you should feel capable of
delving into further detail if the traffic flows look interesting or out of place. Flow data can be
used for forensics purposes, for finding malicious activity, and for determining appropriate packet
prioritization settings, among other things.
CMU/SEI-2012-TR-006 | 3
2 Gather Available Network Information
Gathering any available information about the network prior to beginning the profile is an
important step because it will help set the scope for the rest of the process. The types of
information that could be collected include items such as address space, network maps, lists of
servers and proxies, and policies governing network design. This information may be incomplete