Blowing up the Celly!
Building Your Own SMS/MMS Fuzzer!
!
Brian Gorenc, Manager, Vulnerability Research!
Matt Molinyawe, Security Researcher!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
2!
Agenda!
•  Introduction!
•  Testing Environment!
•  Bug Hunting!
•  Live Demonstration!
•  Key Takeaways!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
Introduction!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
4!
whois Brian Gorenc 
Employer:
 HP 
Organization:  
 HP Security Research 
     Zero Day Initiative 
Responsibilities:
 Manager, Vulnerability Research 
     Organizing Pwn2Own Hacking Competition 
     Verifying EIP == 0x41414141 
Free Time:  
     Endlessly following code paths that don’t lead to      
 vulnerabilities 
Twitter: 
     @MaliciousInput, @thezdi 
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
5!
whois Matt Molinyawe 
Employer:
 HP 
Organization:  
 HP Security Research 
     Zero Day Initiative 
Responsibilities:
 Security Researcher 
     Enjoying funny and awesome proof of concepts 
     Measuring my productivity in hours of YouTube watched 
     Process Janitor – Make exploits shine and not crash 
 Calc Connoisseur 
Free Time:  
     DJ Manila Ice – Two time United States Finalist DJ 
     Beat Contra using only the laser without death 
     Beat QWOP 
     Martial Arts 
Twitter: 
     @djmanilaice  
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
6!
“Do-It-Yourself” !
Fuzzing SMS/MMS is an interesting topic!
Always-on technology!
Limited in-line defenses!
!
Every researcher will have a diﬀerent take on the problem!
Usually roll their own fuzzer along with mutation logic!
!
Aim for this talk is to demonstrate approaches to get started in phone fuzzing!
!
Using Android as the reference device for research/demonstration!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
Testing Environment!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
8!
Virtual Lab and Conﬁguration!
Android Emulation!
Easy to attain-> http://developer.android.com/sdk!
Creating Virtual ARM devices is simple:!
• 
android create avd –n MyDeviceName –t android-19 –b default/armeabi-v7a!
• 
Use the UI with: android avd!
Write scripts to generate the AVDs and to power them on!
!
iOS Emulation!
No default Messaging app on emulator!
!
Windows Phone Emulation!
Pull the SDK from here: http://dev.windowsphone.com/en-us/downloadsdk!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
9!
Android Emulator Options!
Android SDK!
Beneﬁt of testing with several API versions !
•  ARM images!
•  x86 images!
Emulations tend to be slow!
!
Genymotion!
Fast x86 Virtualbox Virtual Machines!
User-friendly interface!
Available at genymotion.com!
!
Cheaper than phones because they’re free to create!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
10!
Debugging!
Attaching a debugger to the Virtual Device!
On the Android Virtual Device:!
•  Shell into device!
•  Run gdbserver attached to the process “com.android.mms”!
- 
gdbserver :5039 –attach 1234!
•  Forward traﬀic to a tcp port!
- 
adb forward tcp:5039 tcp:5039!
On your host machine:!
• 
Download Android NDK: http://developer.android.com/tools/sdk/ndk/index.html!
• 
Run a prebuilt gdb in there: arm-linux-androideabi-gdb for example!
• 
Run the following command in the debug session:!
- 
target remote :5039!
Attach, control and catch output of the debugger with Python. !
Push debugger output to webapp/database.!
!
Now you’re debugging!!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
11!
Scripting/Automation for Emulators!
SMS fuzzing on emulators:!
Send PDU formatted messages with “send pdu” over the telnet channel!
• 
Lots of prior research in this area.!
!
Initial fails with MMS – Repetitive failures you learn from can lead to your success!
Tried for weeks to get MMS networking working with emulators.  It’s ok to give up sometimes.!
!
Backing up your MMSs!
Look at EasyBackup!
•  Installed this application to an emulator!
•  Was able to restore my MMS messages from my phone to an emulator!
•  Win!!! Yes it’s possible to create MMS messages on the emulator!!
!
Looked at code and other things on the net!
Was able to determine you can just manipulate mmssms.db (a sqlite database) without having to 
write Java (Hooray! Matt is a burnt out Sun Certiﬁed Enterprise Architect)!
!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
12!
Scripting/Automation for Emulators!
Save clean mmssms.db  and compare with changed database!
adb pull your clean database, make changes and then push the new database!
•  Interesting directories!
–  /data/data/com.android.providers.telephony/databases – where mmssms.db is!
–  /data/data/com.android.providers.telephony/app_parts – where attachments go!
!
Send MMS to fake number!
Alter tables: pdu, addr, part, canonical_addresses, and threads!
•  Easy to automate this with Python and sqlite3 !
Push the altered mmssms.db back to the phone!
Make sure your set permissions back to radio:radio!
!
Monkeyrunner!
http://developer.android.com/tools/help/monkeyrunner_concepts.html!
• 
Use this to click on the phone or to send text!
• 
Eﬀectively it is Jython scriptable automation in SDK tools!
!
!
!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
13!
Multimedia Fuzz Case Generation and Deployment!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
14!
Mangled Test Case!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
15!
Real-World Lab and Conﬁguration!
Hardware!
RX/TX!
•  Universal Software Radio Peripheral (USRP)!
•  BladeRF!
•  RangeNetworks Device!
Emissions Control!
•  RF Enclosure!
!
Software!
OpenBTS - http://www.openbts.org/!
Base Station Information - http://openbsc.osmocom.org/trac!
NanoBTS - http://openbsc.osmocom.org/trac/wiki/nanoBTS!
Debugging Tools – usually come with the platform or you pay for one!
!
Cell Phones and other materials!
Your favorite cellphone target to fuzz!
SIM cards!
Photo: HP ZDI!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
16!
OpenBTS!
Setting up OpenBTS!
https://github.com/RangeNetworks/dev/wiki!
Used Ubuntu 12.04 32-bit on a VM!
!
Building and Finding Binaries for OpenBTS!
These were heavily referenced!
•  https://wush.net/trac/rangepublic/wiki/BuildInstallRun!
•  svn co http://wush.net/svn/range/software/public!
Built with --with-uhd (Ettus N210 USRP) !
For ease, we built the transceiver from the svn checkout and installed the 4.0 binaries!
!
UHD Drivers for Ettus N210 support!
Available here: http://code.ettus.com/redmine/ettus/projects/uhd/wiki/UHD_Linux!
Use the following commands to talk with the USRP once UHD drivers are built:!
•  uhd_ﬁnd_device!
•  uhd_usrp_probe!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
17!
USRP/Antennas/Cabling !
Ettus N210 USRP!
VERT900 Antennae!
SMA Cable!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
18!
RF Enclosures!
Ramsey STE3000FAV: http://www.ramseytest.com/product.php?pid=10!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
19!
Cells Phones/SIM Cards!
Take your pick on Cell phones!
Android!
iPhone!
Windows Phone!
etc.!
!
GSM!
We set up a GSM network to look like an AT&T 
Network with the USRP in the enclosure!
•  Set GSM.Identity.MCC to 310!
•  Set GSM.Identity.MNC to 410!
!
SIM Cards!
Purchase these from “big box” stores!
!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
20!
Our Bill of Materials!
USRP and Accessories!
USRP N210 Kit (782747-01) - $1,717.00!
WBX-40 USRP Daughterboard - $480.00!
USRP GPS-Disciplined Oscillator Kit - $758.00!
SMA-to-SMA Cable Assembly - $30.00!
VERT900 Vertical Antenna Dualband - $35.00!
Total: $3,020.00!
 !
Cell Phones and SIMs!
Unlocked Phones ~ $500!
Pre-paid SIMs ~ $10-$20!
Micro SIM Cutter Tool ~ $5!
Total: ~$550!
!
RF Enclosure and Accessories!
STE3000FAV - $2,495.00 !
SMA Feedthrough Connectors!
DB9 10 PF and DB9 100 PF Connectors!
USB, RJ45 Adapter Kits!
Total: $3,096.00!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
21!
Connecting to the USRP on Android!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
22!
Connecting to the USRP on Android!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
23!
Time To Blow Up The Celly!
Messaging From Within The RF Enclosure!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
24!
Starting up OpenBTS!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
25!
System Ready!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
26!
tmsis – Check Devices Connected!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
27!
Sending Messages with OpenBTS!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
28!
Basic Text Messages!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
Bug Hunting!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
30!
File Formats!
Audio!
"audio/aac”, "audio/amr”, "audio/imelody”, 
"audio/mid”, "audio/midi”, "audio/mp3”,"audio/
mpeg3”, "audio/mpeg”, "audio/mpg”, "audio/
mp4”, "audio/x-mid”, "audio/x-midi”, "audio/x-
mp3”, "audio/x-mpeg3”, "audio/x-mpeg”, 
"audio/x-mpg”,"audio/3gpp”, "audio/x-wav”, 
"application/ogg"!
!
Video!
"video/3gpp”, "video/3gpp2”, "video/h263”, 
"video/mp4”!
!
Pictures!
"image/jpeg”, "image/jpg”, "image/gif”, 
"image/vnd.wap.wbmp” ,"image/png”,"image/
x-ms-bmp”!
!
Others!
"text/x-vCalendar”, "text/x-vCard"!
!
!
Easy File Format Candidates to ﬁnd:!
• 
https://github.com/klinker41/android-smsmms/blob/master/src/com/google/android/mms/
ContentType.java!
• 
Download AOSP (http://source.android.com)!
• 
Source from Samsung (http://opensource.samsung.com/reception.do)!
• 
rgrep for mime, image/, audio/, video/!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
31!
Fuzzing Framework!
Fuzzing Seeds!
https://samples.libav.org/!
http://samples.mplayerhq.hu/!
Google out some ﬁle formats with ﬁletype: 
operator!
!
Mutation Libraries!
Creating vcards and vcal!
• 
http://vobject.skyhouseconsulting.com/!
• 
https://pypi.python.org/pypi/vobject!
Fuzzing pdu formats!
• 
https://pypi.python.org/pypi/smspdu/!
!
Fuzzing libraries!
Hachoir!
•  https://bitbucket.org/haypo/hachoir/wiki/Home!
Radamsa !
•  https://www.ee.oulu.ﬁ/research/ouspg/Radamsa !
•  https://code.google.com/p/ouspg/wiki/Radamsa!
!
Crash Triaging!
Very easy to roll your own gdb wrapper and 
create a web app with database backend to 
distribute load!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
Live Demonstrations!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
33!
…but we have video backups!
Pray to the Demo Gods!!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
Key Takeaways!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
35!
Blow Things Up!!
Attractive targets!
Filled with personal information and corporate secrets!
Process information without user interaction!
Handle large number of legacy formats !
!
Decreasing barrier to entry!
Leverage emulation provided by OS developers!
Physical hardware becoming cheaper!
Popularity of software deﬁned radio increasing!
Leverage previous lessons learned!
Similar to fuzzing desktop apps to ﬁnd bugs in MMS data handlers!
Break through the mystique of cell phone research!
!
© Copyright 2014 Hewlett-Packard Development Company, L.P.  The information contained herein is subject to change without notice.!
Thank you!