数据库的连线存取、建立、
邮件收发人、
网页点阅率、
用户登入登出、访问次数、文件的上传下载信息及带宽的占用。
CC
syslog
图城
、收发地址、收发状态、响应路径、邮件统计。
、页面停留时间、来源区域分布、点击路径分析。
图3-19Sawmill架构图
日志接收
下一步接受许可协议选择企业版。
日志模板
Web界面
、审计异常进入进出状态。
所以系统防火墙需要开放此端口。
、分析来源位置、带宽使用量。
所以系统防火墙需要开放此端口。
Web引擎
目前最新版本为8.7.4。读者可以到
连接
库
据
调度程序引擎
第3章
MSSQL
Oracle
Mysql
Sawmill
建立日志分析系统  121
日
---
## Page 145
有zwoaiw
络磁盘就要标示出主机名和具体路径，如图3-21所示。
志，方法是先新建一个 Profle，在日志来源处选择本地磁盘，如图 3-20 所示。如果选择网
122UNIX/Linux 网络日志分析与流量监控
下面假设分析本地 Apache 访问日志。过程很简单，如图 3-22 所示。这时系统会让你
上图通过Htp 方式获取日志。下面以本地磁盘的日志文件为例，介绍 Sawmil 的使用方法。
选择日志来源，既可以选择本地日志，也可通过FTP、SFTP 和HTTP 方式获取日志。
经过以上三个步骤，系统就安装完毕。下面开始在web下调试。可以先选择本地日
#/etc/init.d/syslogrestart
SYSLOGD_OPTIONS="-mO-r"
Logsources
New Profile Wizard
ntp：/192.166.150.150.8988/7dpnew
Pathname:
athname:
anosBo
Bo
source
ProfileWizard
ShowMatching Fles
aps sse
wLog Sourte
图3-22分析Apache访问日志
ouplicte
图3-21选择远程日志文件T
图3-20加载本地日志文件
miltogetyour logdata tm
_pronle_wtzard.index
XDta
dike
Und Al Cenges
立费
全性支w（
cess.log
ountaddiek
NecCencel
$.log
容（
一
Mareinta
品
2
5.0t
---
## Page 146
有一堆单调的字符。
统提供的丰富图表就能非常直观地看出网站访问过程的细节，不再像第1章中介绍的那样只
messages中。最后定义配置文件，取个有意义的名字即可。
DtPickaF
SAWMILL
经过以上导入设置，系统会自动计算分析并生成详细的结果，如图3-24所示。通过系
Dte
Caienuar
接下来输入 apache 的路径，如果输入错误，找不到文件的错误提示会输出到/var/log/
-age Summary
mes
Reports
1.HTTP access/Network device
Sawmil detected several logformats,piease select themostappropriate.
New Profile Wizard
Shoellfotethspn
Search engines
DaShbard11/Ja/20131enerange)
Traffic
Overview
Prnter
illto detectadiflerent logfom
Viitors
a7dp
图3-24分析Apache日志结果
anew_proftile
Country
Mis
size
图3-23检查日志格式
you want to ma
wiz
mat?
inde
100.0%(unknomcountry)
Pngevews
pat
Back
第3章建立日志分析系统123
8885E
NedCancel
lifimRe
森
mlqe
凡面
4.0.E
---
## Page 147
时记住关闭 SELinux 功能。另外注意一点，如果要通过 WMI 的方式来搜集 Windows（中文
3.7.2Splunk安装
免费版本多出了用户和角色访问控制、单一登录以及邮件、电话技术支持功能。
免费版本，若每天企业的日志总量不大于500MB，使用它是比较理想的选择。而商业版比
得非常到位。如果不想购买它的商业版本（以500MB日志/天为单位计费），可以使用它的
日志收集，使用起来比较方便。对比其他开源监控软件，它对日志数据分析详细，本地化做
可以通过文件方式传到 Splunk服务器，也可以通过网络实时传输过去。也可进行分布式的
后可以交叉查询，支持复杂的查询语句，最后通过直观的方式表现出来。待监控服务器日志
常规的日志格式，比如Apache、Squid、系统日志、邮件日志，对所有日志先进行索引，然
智能的工具，那就是 Splunk。Splunk 是一款功能强大的、记录详细的日志分析软件，能处理
在大数据时代，怎样在种类繁多的日志中快速找到需要的内容呢？此时需要一个更加方便、
3.7.1Splunk 简介
3.7使用Splunk分析日志
数据（Rawdata）内容建立索引，保存索引的同时也保存原始日志内容。
议)，攻击原理实际上就是通过Ping大量的数据包使得计算机的CPU使用率居高不下而崩
3.6.4监测网络人侵
124UNIX/Linux网络日志分析与流量监控
前面几节介绍了如何利用 grep、awk、sed、sort、uniq、tail、head 等工具来分析日志，
Ping 攻击是一种很原始的攻击方式，它主要利用了ICMP（因特网控制消息错误报文协
首先到 http://www.splunk.com/download注册一个账号，
综上所述，Sawmill 是一款功能强大的、记录详细的日志分析软件，它是基于原始日志
。面对这种攻击，Sawmill会立刻将其记录到日志库中。如图3-25所示。
Q1IDS:2003ICMPredirectfrom192.168.1.2to192.168.1.137oninteraceoutside
Q1IPS:ICMPRedirect
P
P
2IPS:ICMP EchoReply
事件（码）
2IDS:200CMPchplyfrom92.168.1.135t192168.1.137nitfacoutsid
Sub total
图3-25入侵攻击日志分析
8.8%
10.1%
IPS:ICMPRedirect
下载对应的操作系统版本，安装
个事件
14
---
## Page 148
3.7.3设置自动运行
面以Redhat Linux系统安装Splunk4.1为例讲解安装过程，启动过程如图3-26所示。
上。如果收集的日志主要是各种网络设备及Linux系统日志，建议装在类UNIX系统上。下
版）日志的话，那么Splunk建议装在Windows操作系统（必须要有2GB以上可用空间）
1）设置开机自动启动
当看到以上信息输出即可通过网址访问 Splunk。
（4）浏览Splunk Web 接口，在浏览器中输入以下地址：
（3）启动Splunk，命令如下：
（2）关闭 Selinux:
Splumk安装路径在/opt/splunk，这个路径各种UNIX/Linux系统都一样。
（1）安装软件包：
#/opt/splunk/bin/splunkstart
#ln-s/usr/local/splunk/bin/splunk/etc/rc2.d/S80splunk
#setenforceO
#rpm-ivh splunk-4.1.7.95063-linux-2.6-x86_64.rpm
tcp
tcp
ProtoRecv-QSend-QLocalAddress
#netstat-ant
http://localhost.localdomain:8000
outsk
00.0.0.0:8089
>Att batbelt.No tights
00.0.0.0:8000
图3-26Linux下安装Splunk
SED
audit,
ocksigna
0.0.0.0:*
0.0.0.0:*
Foreign Address
第3章建立日志分析系统125
2015
LISTEN
LISTEN
State
二
---
## Page 149
下内容：
Files\Splunk。在C:Program Files\Splunk\etc\system\local 文件下修改 inputs.conf 文件，添加以
Windows计算机的WMI信息。在本书14章中还会讲到利用WMI收集Windows日志。
3.7.4系统配置
126UNIX/Linux网络日志分析与流量监控
然后在Splunk服务器上做一下简单的配置。Splunk的安装路径默认为C:Program
接着在同一目录中新建一个文本文件，命名为wmi.conf，并添加以下内容：怪
2）设置到服务里面
首先要确保运行Splunk服务（在服务管理器中显示为Splunkd）的账号有权限读取远程
3）通过WMI收集Windows主机的日志
例如：
在Linux主机上修改/etc/syslog.conf配置，添加以下两行：
2）通过 Syslog收集Linux主机的日志
Splunk 默认使用 UDP 514端口来监听 syslog 消息。例如：
在Cisco网络设备上的配置命令一般为：
1）通过 Syslog收集 Cisco 网络设备的日志
下面我们通过配置来收集客户端的日志。
disabled=0
disabled=0
event_log_file =
server =
sourcetype=wmi
[script:/SSPLUNK_HOME\bin\scripts\splunk-wmi.py]
*.debug
#Send syslog to Splunk server
interval=60
[WMI:]
source=wmi
interval=10
*.
#Send syslog to Splunk server
loggingtrapwarning
logging192.168.122.1
loggingtrap
logging 
@192.168.122.1
@
1.00.00
sinlge
LTE
---
## Page 150
置，当系统提示索引建立后就可以查看日志。
首先向Splunk添加示例数据，方法如下：
splunk.com/base/images/Tutorial/Sampledata.zip下载一个演示文件。我们学习如何添加数据，
对其进行分析）。