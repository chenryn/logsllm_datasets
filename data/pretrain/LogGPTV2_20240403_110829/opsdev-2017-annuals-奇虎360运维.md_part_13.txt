强的关联性，且历史数据对未来的发展存在一定的影响。所以可以采用时间序列分析法对磁盘
被写满而导致系统故障。由此可见，在不考虑人为因素的影响时，存储空间随时间变化存在很
空间使用率来说明我们的系统如何做到智能预测与处理。很明显，磁盘预测工作应该分为两部
client 模块
分，
干预。
测只是第一步，如果预测后能让机器自动处理一些危险的监控项，就可以最大程度上减少人工
流量等。对于这两种趋势，我们需要使用不同的预测模型对未来一段时间的趋势进行预测。预
趋势趋于稳定，如磁盘空间使用率等，而有些监控项的趋势就波动得比较厉害，如CPU、网卡
（偏自相关系数）以及d（差分次数）。差分次数可以使用ACF函数来检测差分后该序列是否
，一部分是预测，另一部分是处理，下图是具体的流程：
如果是自动处理类型，我们会清理 100%可以确定删除的日志文件，比如 allweb 文件以
接下来将重点介绍在预测磁盘使用率将要达到阈值后，我们如何自动处理的过程。用户可
我们对线上20000+台机器在未来 24小时的走势进行预测，跟踪了将近一个月的预测结
2．报警减少率：
1．预测准确率：
有人可能会问这个系统可能依赖于预测模型的准确率。为了验证模型的准确率，我们提出
我们使用 ARIMA 模型来处理时间序列，ARIMA涉及到三个参数：p（自相关系数），α
首先说一下预测，系统长时间运行，数据会持续写入存储，存储空间逐渐变少，最终磁盘
应用系统出现故障通常不是突然瘫痪造成的，而是一个渐变的过程。本节我们将结合磁盘
预测覆盖率=预测报警且真正报警的机器数/报警的机器数
预测准确率=预测报警且具有报警趋势的机器数/预测报警的机器数
机器学习－360DoctorStrange95
---
## Page 101
们排查出问题，找到问题的根源。报警关联分析系统主要做了两件事情：
立的，而是存在着干丝万缕的联系。我们分析出某一时间段内协同发生变化的监控项，能够帮助我
波动剧烈的监控项的预测与故障定位
具有此特征的监控项的思路类似，在此就不一一展开。
直接处理占比比较高的进程会有风险，所以我们只会邮件通知负责人以及运维人员。
我们的预测模型可以达到比较好的效果。
50%。由于波动剧烈的项相比于趋势稳定的项来说，不太容易预测，能够一定程度减少报警也说明
则建立模型。
藏层的个数一般为输入层个数乘以2再加1，所以输出层为49，输出层的个数为1，我们根据此规
隐患的故障扼杀在摇篮中，提高系统的可靠性和可用性。
CPU预测，我们也分了两个过程：预测以及故障定位。
现过的情况。相反，神经网络模型由于输入的是非线性方程，可以处理更复杂的时间序列。对于
波动剧烈的监控项的预测与故障定位
用户，由用户自己去处理。
风险，所以我们还有一种是通知邮件，我们会定期将扫描出来的占用空间比较大的文件信息发送给
写的不规范，业务访问量的增长，还是会有磁盘被写满的情况，所以单纯依靠自动清理会有一定的
采用传统的ARIMA或者指数平滑的方法很难达到比较好的效果，因为他们很难捕捉到以前从未出
一个小时的趋势，同样的机器数量，我们的预测准确率能够达到80%左右，报警减少率能够维持在
96360DoctorStrange －机器学习
随着监控系统监控项的数目越来越多，报警的次数也会随之暴增。不同报警项他们之间并非孤
接下来说明预测报警后，如何进行故障定位。我们会根据top值来找到占比比较高的进程，由于
和趋势稳定的监控项的预测准确率和报警减少率一样，我们也预测了波动剧烈的监控项的未来
建立神经网络模型，首先要确定输入、隐藏和输出层的神经元个数。由于我们的线上业务具有
和磁盘这种趋势稳定的监控项不同的是，波动剧烈的监控项由于历史数据变化情况比较复杂，
实时报警分析：找到存在因果关系的监控项，帮助排查问题;
报警系统：加入报警合并算法，能够减少报警次数；
以上我们以磁盘使用率和CPU为例子介绍两种不同趋势的监控项的预测以及处理工作，其他
本节采用神经网络模型去预测CPU的走势，提前预测出将要发生报警的机器，尽可能将具有
---
## Page 102
的报警次数通知给用户。而对于实时报警分析，我们就可以通过输入一个波动项（原因），找
而会获得比较好的效果。
个自学习的关联分析系统，通过老case 和人工经验的加入，
后
动剧烈程度排序。利用均值波动法获得波动持续的时间
生波动的项可能非常多，适
我们可以给每个波动项赋
对于报警系统，我们主要找到正关联系数比较高的监控项，来合并一些报警之后，以最少
现实场景中，
怎样去找到关联项呢？：
下图是我们报警关联分析系统的框架图：
监控系统
单纯依靠当
新case案例分析—
通过求曲线斜率的方
我们根据自相关系数来获得该段时间内发送波动的监控项。一起发
前的数据来得到相关联的项可能不太准确，这时候我们就需要-
予
定
的权
关联报警
报警合并
值
新case结果
并
关联分析
老case库
由
相关值）
来
此得
获得
报警分析
报警系统
EE
在综
关
该模型得到不断地修正和补充，因
一波动项的波动剧烈程度，并按照波
机器学习－360DoctorStrange 
联和负
合
考虑波动剧烈程度和持续时间
报警实时分
反馈和修正
通知机制
负关联的项。
关联分析系统
7
---
## Page 103
我们具体的应用场景：
近于－1，则说明机器比较空闲，如果该值越接近于1，表明机器使用率比较高。
总体反映出机器的负载情况。
越来越成为业界比较关注的话题。我们不能使机器使用率过高，同样也不能使机器利用率过低，因
机器资源优化方案
到由此原因导致的其他波动的项（结果）。
个值：历史数据的均值上限、历史数据的均值下限、
流量、网卡流出流量和状态连接数作为考量因素。之所以选择这几个指标是因为这几个监控项能够
况
此我们提出来一个“机器健康度”的概念，该值会反映出该机器过去一段时间内重要指标的使用情
98 360DoctorStrange －机器学习
设置 cron 任务，比如每隔一周全量跑一次线上的机器，将有问题的机器录入到数据库中。
·场景一动态扩容和缩容
健康度的概念毕竟是一个学术的东西，我们如何将此概念应用到实际的场景中呢？下面将介绍
经过一个公式计算后，我们将得到一个－1到1 区间内的一个值，即为健康度。如果该值越接
我们分别通过阈值的方法为这六个监控项设置上限和下限后，针对于每个监控项我们得到了四
首先，
面对不同业务的机器使用程度不同的问题，如何在不影响业务的同时，最大化机器资源利用率
下图说明了我们方案实施的具体流程：
，如何选择机器指标？在我们的方案中，我们选择CPU空闲率、内存使用率、网卡流入
Cpu使用率：
磁盘使用率：
网卡流量；
重要指标：
连接数；
......
得到-1到1之间的
数据和预测数据
各个指标的历史
值
、预测数据的均值上限和预测数据的均值下限。
根据阀值为数据
健康度公式
打标签
该
---
## Page 104
机器使用率过低。
白色的机器表示该机器运行良好，红色的机器表示该机器使用率过高，而灰色的机器则表示该
器健康度”来表示每个机器现在的运行状态。如下图是我们一个简单机房的物理拓扑，在图中
该拓扑图里面，运维人员可以更方便知道机器的总体运行状况。而我们可以以上面提到的“机
有问题的机器录入到数据库中。
场景二是我们针对于运维人员经常不能了解线上机房机器的运行状况做得一个拓扑图。在
·场景二机房物理拓扑（及时了解机房机器的健康状况）
2．业务扩容的依据（关注健康度值为1的机器）
1．资源回收的依据（关注健康度值为－1的机器）
该数据库可以用于以下方面：
机器学习－360DoctorStrange
99
---
## Page 105
本文链接： https://opsdev.cn/post/360DoctorStarange.html
突增有可能导致 CPU 的上升，有可能单纯依靠算法无法达到好的效果，Case 库需要不断的丰富。
A：先说老 case 吧，将以前的有关联关系的结果保存在 case 库里面；人工经验比如某个机器的网络流量
说明下，最好能举一个案例，谢谢
Q：自学习的关联分析系统，通过老 Case 和人工经验的加入，该模型得到不断地修正和补充，能不能详细的
我们后期的一个目标。
问题：我们现在只做了磁盘使用率和CPU发生报警后如何去处理，我们接下来会做报警自发现的模块，这是
后，给每个波动项赋予一定的权值，并由此得出正关联，我们会选择关联系数比较高的项进行综合。第二个
A：第一个问题：我们的报警合并算法是考虑该报警发生的一段时间内，综合每个波动剧烈程度和持续时间
Q：请问能否说一下你们使用的报警合并算法？你们会发送并处理所有的报警吗？
面对面：
100360DoctorStrange－机器学习
日一扫查看文章详情
---
## Page 106
展存在一定的影响，所以可以采用时间序列分析法对磁盘容量进行预测分析。
在不考虑人为因素的影响时，存储空间随时间变化存在很强的关联性，且历史数据对未来的发
行，数据会持续写入存储，存储空间逐渐变少，最终磁盘被写满而导致系统故障。由此可见,
智能预测历史数据分析
数。我们的机制分为两部分，一部分是预测，另一部分是处理，下图是我们系统的框架图：
机器。但是只有预测是远远不够的，如果能够提前自动处理报警，将会最大程度减少报警的次
的处理，系统很容易出现故障，从而导致用户无法访问系统，严重影响企业的利益。
如果超过阈值，则会发生报警来让人工干预以降低磁盘容量。如果系统管理员不及时进行相应
量耗尽的情况而导致应用系统负载率过高，最终引发系统故障是一个比较棘手的问题。
■磁盘容量预测与处理机制
应用系统出现故障通常不是突然瘫痪造成的，而是一个渐变的过程。例如，系统长时间运
本文提出一种主动的预测与处理机制，提前对磁盘使用率进行预测，发现使用率比较高的
目前，工业界普遍采用被动容错机制，为磁盘容量设置一个阈值来保证系统的可靠性：即
存储设备中磁盘容量是服务器能够可靠运行的重要保障。如何避免应用系统中出现存储容
Jan.19th 2017BY 籍鑫璞
监控系统
采集监控项历史数据
预测趋势
建立模型
预测
自动处理→通知机制
机器学习－磁盘容量预测与处理机制101
通知机制
自动化处理
通知处理
处理
---
## Page 107
时间序列模型：
模型使用
102磁盘容量预测与处理机制－机器学习
查看磁盘容量过去一周的数据曲线：
历史趋势
使用均值来补齐缺失值。
缺失值处理
为数据建立索引，转换为 pandas 能够识别的时间序列。
创建时间序列
我们采集过去7天的数据，采集间隔是1小时，使用下面代码得到历史的数据。
获取数据
本节将以分析磁盘容量时序介绍时间序列模型如何使用。我们使用以下的步骤来建立一
 dta = dta.fillna(np.mean(mydata))
dta = dta.resample('H') 
dta.index=pd.DatetimeIndex(dta.index)
dta.index = pd.Index(time_series) 
dta=pd.Series(mydata)
zip(data['timestamp
#将.csv数据读入Pandas数据帧
#将时间保存在time列表中，
mydata
time_series = 
data = pd.read_csv("cpu_idle_data.csv")
#从csv文件中读取时间和对应的数据
import datetime 
import date
importcsv
#导入需要的模块
mydata.append(used_percent)
#将数字时间转换为能够识别的时间
= time . strftime("%Y-%m-%d %H:%M:%S", a) 
= time.localtime(timestamp)
,data['used _percent']):
而将数据保存在mydata中
---
## Page 108
检测代码：
图像显然不是平稳性检测最好的方法，我们可以使用单位根检测（ADF）进行平稳性检测。平稳性
平稳性检测
可以看出，经过一阶差分后，数据已经平稳了，可以进行ARMA模型了。通过肉眼观察每个
观察4中的图，可以看出该序列不平稳，
diff1.plot(ax=ax1)
diff1 = dta.diff(1)