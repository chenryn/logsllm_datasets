### Research Questions

**RQ1:** Can PayBreak protect users from the threat of real-world ransomware, i.e., can it restore files encrypted by the malware?

**RQ2:** Are malware family-specific modifications necessary to revert the encryption employed by different ransomware families?

**RQ3:** What are the performance impacts caused by running PayBreak as a proactive online protection mechanism?

These research questions aim to address the practicality and effectiveness of the proposed technique. RQ1 evaluates whether the technique is effective. A system that cannot affirmatively answer RQ1 would be of limited use in combating ransomware. RQ2 explores the versatility of the proposed system, with a preference for a versatile approach over one that requires continuous refinement to handle new ransomware families. Finally, RQ3 addresses the practical deployment concerns. Similar to popular anti-virus solutions, PayBreak is designed as an online protection mechanism. High performance impacts on common use-cases and workloads could significantly hinder its adoption.

### 5.1 Dataset

To test the functionality and effectiveness of PayBreak, we needed access to actively encrypting ransomware samples. To collect these samples, we developed the Real-time Automation to Discover, Detect, and Alert of Ransomware (RADDAR) system. This project will be made open source to further ransomware research. RADDAR crawls various locations for malware samples, primarily using VirusTotal Intelligence, which provides advanced search features and download functionality for malware samples. We searched for newly submitted samples (within a week of analysis) flagged by at least two anti-virus vendors and labeled as known ransomware families [10]. Additionally, we downloaded samples for generic search terms: "ransom," "crypt," or "lock." Beyond VirusTotal, we also crawled malware repositories such as Malc0de and VXVault, similar to the efforts presented in [33].

Once RADDAR discovers a malware sample, it determines whether the sample is crypto-based ransomware and if it is actively performing malicious activities. We used the Cuckoo Sandbox dynamic analysis framework to run each sample for 20 minutes in a monitored Windows 7 virtual machine (VM) running in KVM. The VM was set up with typical ransomed file types (PDFs, images, source code, and Word documents) across various directories. PayBreak was added to the VM to perform the measurements. We took a snapshot of the file system and referred to these files as "honey files."

After Cuckoo analyzes a malware sample, RADDAR generates a report containing metrics such as whether the sample is active and if PayBreak extracted the keys used during encryption. A ransomware sample is considered active if it:
1. Overwrites, deletes, and recreates at least one honey file.
2. The new file is identified as data by libmagic, indicating a change from the original content.

To determine the ransomware family, we performed majority voting of AV labels, following the approach of Kharraz et al. [34].

RADDAR ran for four months, collecting and generating reports for 1,691 malware samples, of which 713 matched ransomware labels used by AV companies. Figure 2 provides a detailed breakdown of this analysis.

Consistent with previous malware research, many samples did not show any malicious functionality (i.e., they were inactive) for various reasons. We conducted a two-step analysis:
1. Identify active samples.
2. Infer the reason for inactivity in inactive samples.

As discussed in Section 2, ransomware that uses hybrid encryption must retrieve the public key (pk) from the command and control infrastructure (C&C). If the malware does not produce network traffic, it cannot apply hybrid encryption securely. We classified a sample as "No Network" if all observed TCP and UDP traffic targeted only Windows-affiliated domains, such as those for time keeping and updating.

A sample was classified as "Disabled C&C" if:
1. All DNS queries (beyond Microsoft domains) returned negative.
2. All HTTP requests resulted in a 404 status code.

For the inactive samples, those reported as having a disabled C&C were due to DNS queries returning negative. However, we did not inspect HTTPS-protected network traffic generated by the malware.

Even if the C&C is operational and reachable, environment-sensitive malware may refrain from executing if it detects a sandboxed environment. "Environment" indicates that the malware may be analyzing its environment to detect if it is running in a virtual environment like KVM or VirtualBox. A sample is labeled "Environment" if Cuckoo's built-in detection identifies it as such.

The inactivity of the remaining samples could not be determined. Previous experience suggests this could be due to advanced environment fingerprinting, dependency on user activity, or the use of logic (time) bombs that delay execution beyond our 20-minute evaluation threshold.

In total, we evaluated our system against 20 active ransomware families, making this the largest study of ransomware we are aware of.

### 5.2 PayBreak Effectiveness

In this section, we address RQ1 and RQ2. Specifically, we evaluate whether PayBreak can revert the encryption performed by real-world ransomware and whether malware family-specific modifications are necessary to revert the encryption employed by different ransomware families.

PayBreak successfully recovers ransomed files from all ransomware families with known encryption signatures. Our results confirm that we can hook into the encryption functions of real-world ransomware samples and extract session keys and all materials necessary for file recovery.

More specifically, PayBreak defeated 12 out of the 20 active ransomware families, 9 of which, to our knowledge, have not been previously defeated. A ransomware family is defined as defeated if there exists a method or technique for fully recovering the ransomed files.

PayBreak successfully recovers files encrypted by CryptoWall and Locky, two of the three most economically successful ransomware families of 2016 [2]. CryptoWall alone has netted more than $325 million in revenue [3].

Table 1 summarizes the active ransomware families. The number of active samples for each family is specified in the "Samples" column. For previously defeated ransomware samples, a corresponding reference is included. Leaked cryptographic keys (e.g., obtained from a confiscated C&C server) are not considered defeated because they are specific to a ransomware campaign and do not imply a weak implementation of the ransomware family.

PayBreak has demonstrated the ability to defeat ransomware using multiple cryptographic libraries, including Microsoft CryptoAPI and Crypto++. The cryptographic algorithms used for encryption were extracted at runtime by PayBreak for the samples it defeats and are listed in the "Algorithm" column. For undefeated samples, the column contains information reported by other researchers, gathered to the best of our knowledge.

| **Families** | **# Samples** | **Previously Defeated By** | **Defeated** | **Library** | **Algorithm** |
|--------------|---------------|---------------------------|--------------|-------------|---------------|
| Almalocker   | 1             |                           | ✓            | CryptoAPI   | RSA+AES-128-CBC |
| Cerber       | 14            |                           | ✓            | CryptoAPI   | RSA+RC4-256   |
| Chimera      | 1             |                           | ✓            | CryptoAPI   | RSA+AES-256-ECB |
| CryptoFortress | 2           |                           | ✓            | CryptoAPI   | RSA+AES-256-ECB |
| CryptoLocker | 33            | [1]                       | ✓            | CryptoAPI   | RSA+AES-256-CBC |
| CryptoWall   | 7             | [4]                       | ✓            | CryptoAPI   | RSA+AES-256-CBC |
| CrypWall     | 4             | [38]                      | ✓            | CryptoAPI   | RSA+AES-256-ECB |
| GPcode       | 2             | [5]                       | ✓            | CryptoAPI   | RSA+AES-128-CTR |
| Locky        | 7             | [12]                      | ✓            | Crypto++    | ECC+AES-256-ECB |
| SamSam       | 4             | [9]                       | ✓            | .NET Crypto | AES with Constant Key |
| Thor Locky   | 1             | [13]                      | ✓            | Unknown     | XOR with Constant Key |
| Tox          | 9             | [15]                      | ✓            | Unknown     | RSA+AES-256-CBC |
| DXXD         | 2             | [11]                      | ✓            | .NET Crypto | AES-128 |
| MarsJokes    | 1             | [16]                      | ✓            | Unknown     | ECC+AES-256-CBC |
| PokemonGo    | 1             | [17]                      | ✓            | Unknown     | Unknown |
| Troldesh     | 5             | [18]                      | ✓            | Unknown     | Unknown |
| VirLock      | 4             | [19]                      | ✓            | Unknown     | RSA+AES-256-CBC |
| Androm       | 2             | [20]                      | ✓            | Unknown     | Unknown |
| Razy         | 3             | [21]                      | ✓            | Unknown     | ECC+AES-256-CBC |
| TeslaCrypt   | 4             | [22]                      | ✓            | Unknown     | RSA+AES-256-CBC |

**Table 1: Active Ransomware Samples**