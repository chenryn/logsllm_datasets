N / sqrt(N * N ) =
intersected intersected query
sqrt(N / N ) ≥ exact similarity of any
intersected query
successor
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
GIN
N intersect – exact value
●
N intersect as lower bound of N
●
elements
We know everything about query
●
N / sqrt(N * N ) =
intersected intersected query
≥ exact similarity
SQRT(N / N )
intersected query
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Other features
float4 smlar( compositetype[], compositetype[], bool
●
useIntersect )
CREATE TYPE compositetype AS (id text, w float4);
GIN index
●
TF*IDF metrics
●
float4 smlar( anyarray, anyarray, text Formula )
●
text[] tsvector2textarray( tsvector )
●
anyarray array_unique(anyarray)
●
float4 inarray( anyarray, anyelement
●
[, float4 found, float4 notfound])
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Availability
git clone git://sigaev.ru/smlar.git
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
TODO
Index support for ratings
●
Index optimizations
●
GIN per row storage?
●
TF*IDF speedup
●
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Recommender Systems
Recommender systems:
●
eBay, Amazon, last.fm, Pandora,...
Content filtering – based on content
–
attributes (Music Genome Project lists
~400 attributes) ! Match attributes of
content I like.
Collaborative filtering – based on
–
preferences of many users
User-based, item-based
●
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Recommender System
We use item-item CF (more stable)
●
Similarity metric: cosine
–
Input data from MovieLens
●
1mln rates: 6000 users on 4000
–
movies
10 mln rates: 72000 users on 10,000
–
movies
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Recommender System
Initial data:
●
movies(mid,title,genre,description)
–
rates(uid,mid,rate)
–
Step 1: Transform ratings to likes
●
u: r=1 if r>avg(rate)
rates(uid,mid,like)
Produce table
●
ihu(itemid,{users}, {rates})
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Recommender System
Step 2. item-item matrix
●
Precompute item-item matrix
●
ii(itemid1,itemid2, sml) from ihu table
Step 3. Evaluations
●
Q1: for given movie provide a list of
–
similar movies
Q2: for given user provide a list of
–
recommendations
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Recommender System
Step 1.
●
Produce table ihu (itemid,{users})
–
Create index to accelerate % operation
–
CREATE INDEX ihu_users_itemid_idx ON ihu
USING gist (users _int4_sml_ops, itemid);
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Step 2. Item-Item
SELECT
Smlar.threshold=0.2
r1.itemid as itemid1,
SELECT 209657
r2.itemid as itemid2,
smlar(r1.users,r2.users) as sml
Index | no-index
INTO ii
526195 ms | 1436433
FROM
ihu AS r1,
Speedup 2.7
ihu AS r2
WHERE
Smlar.threshold=0.4
r1.users % r2.users AND
SELECT 8955
r1.itemid > r2.itemid;
Index | no-index
253378 ms | 1172432
Speedup 4.6
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Step 2. Item-Item
CREATE INDEX ii_itemid1_idx on ii(itemid1);
CREATE INDEX ii_itemid2_idx on ii(itemid2);
CREATE OR REPLACE VIEW ii_view AS
SELECT itemid1, itemid2, sml FROM ii
UNION ALL
SELECT itemid2, itemid1, sml FROM ii;
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Step 3. Evaluations
CREATE OR REPLACE FUNCTION smlmovies(
movie_id integer,num_movies integer,
itemid OUT integer, sml OUT float, title OUT text)
RETURNS SETOF RECORD AS $$
SELECT s.itemid,s.sml::float, m.title
FROM movies m,
( SELECT itemid2 AS itemid, sml FROM ii_view
WHERE itemid1 = movie_id
UNION ALL
SELECT movie_id, 1 -- just to illustration
) AS s
WHERE
m.mid=s.itemid
GROUP BY s.itemid, rates, s.sml, m.title
ORDER BY s.sml DESC
LIMIT num_movies;
$$ LANGUAGE SQL IMMUTABLE;
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Step 3. Evaluations
=# select itemid, sml,title from smlmovies(1104,10);
itemid | sml | title
--------+-------------------+----------------------------------------
1104 | 1 | Streetcar Named Desire, A (1951)
1945 | 0.436752468347549 | On the Waterfront (1954)
1952 | 0.397110104560852 | Midnight Cowboy (1969)
1207 | 0.392107665538788 | To Kill a Mockingbird (1962)
1247 | 0.387987941503525 | Graduate, The (1967)
2132 | 0.384177327156067 | Who's Afraid of Virginia Woolf? (1966)
923 | 0.381125450134277 | Citizen Kane (1941)
926 | 0.377328515052795 | All About Eve (1950)
1103 | 0.363485038280487 | Rebel Without a Cause (1955)
1084 | 0.356647849082947 | Bonnie and Clyde (1967)
(10 rows)
Time: 5.780 ms
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Step 3. Evaluations
# select itemid, sml,title from smlmovies(364,10);
itemid | sml | title
--------+-------------------+----------------------------------------
364 | 1 | Lion King, The (1994)
595 | 0.556357622146606 | Beauty and the Beast (1991)
588 | 0.547775387763977 | Aladdin (1992)
1 | 0.472894549369812 | Toy Story (1995)
2081 | 0.4552321434021 | Little Mermaid, The (1989)
1907 | 0.442262977361679 | Mulan (1998)
1022 | 0.41527932882309 | Cinderella (1950)
594 | 0.407131761312485 | Snow White and the Seven Dwarfs (1937)
2355 | 0.405456274747849 | Bug's Life, A (1998)
2078 | 0.389742106199265 | Jungle Book, The (1967)
(10 rows)
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Step 3. Evaluations
=# select itemid, sml,title from smlmovies(919,10);
itemid | sml | title
--------+-------------------+-------------------------------------------------------
919 | 1 | Wizard of Oz, The (1939)
260 | 0.495729923248291 | Star Wars: Episode IV - A New Hope (1977)
912 | 0.483502447605133 | Casablanca (1942)
1198 | 0.481675773859024 | Raiders of the Lost Ark (1981)
1196 | 0.468295514583588 | Star Wars: Episode V - The Empire Strikes Back (1980)
1028 | 0.460547566413879 | Mary Poppins (1964)
1097 | 0.455985635519028 | E.T. the Extra-Terrestrial (1982)
1247 | 0.449493944644928 | Graduate, The (1967)
858 | 0.446784257888794 | Godfather, The (1972)
594 | 0.44676461815834 | Snow White and the Seven Dwarfs (1937)
(10 rows)
Time: 10.207 ms
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
I like these movies
CREATE TABLE myprofile (mid integer);
INSERT INTO myprofile VALUES
(912),(1961),(1210),(1291),(3148),(356),(919),(2943),(362),(2116);
=# select p.mid, m.title from movies m, myprofile p where m.mid=p.mid;
mid | title
------+---------------------------------------------------
912 | Casablanca (1942)
1961 | Rain Man (1988)
1210 | Star Wars: Episode VI - Return of the Jedi (1983)
1291 | Indiana Jones and the Last Crusade (1989)
3148 | Cider House Rules, The (1999)
356 | Forrest Gump (1994)
919 | Wizard of Oz, The (1939)
2943 | Indochine (1992)
362 | Jungle Book, The (1994)
2116 | Lord of the Rings, The (1978)
(10 rows)
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Give me recommendations
SELECT t.itemid2 as itemid, t.sml::float, m.title
FROM movies m,
(
WITH usermovies AS (
SELECT mid FROM myprofile
),
mrec AS (
SELECT itemid2, sml
FROM ii_view ii, usermovies um
WHERE
ii.itemid1=um.mid AND
ii.itemid2 NOT IN ( SELECT * FROM usermovies)
ORDER BY itemid2 ASC
)
SELECT itemid2, sml, rank()
OVER (PARTITION BY itemid2 ORDER BY sml DESC) FROM mrec
) t
WHERE t.itemid2=m.mid AND t.rank = 1
ORDER BY t.sml DESC
LIMIT 10;
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Recommendations
itemid | sml | title
--------+-------+-------------------------------------------------------
1196 | 0.71 | Star Wars: Episode V - The Empire Strikes Back (1980)
260 | 0.67 | Star Wars: Episode IV - A New Hope (1977)
1198 | 0.67 | Raiders of the Lost Ark (1981)
1036 | 0.58 | Die Hard (1988)
2571 | 0.57 | Matrix, The (1999)
1240 | 0.56 | Terminator, The (1984)
2115 | 0.56 | Indiana Jones and the Temple of Doom (1984)
589 | 0.54 | Terminator 2: Judgment Day (1991)
592 | 0.54 | Batman (1989)
923 | 0.53 | Citizen Kane (1941)
1270 | 0.53 | Back to the Future (1985)
1197 | 0.52 | Princess Bride, The (1987)
480 | 0.51 | Jurassic Park (1993)
1200 | 0.51 | Aliens (1986)
457 | 0.51 | Fugitive, The (1993)
1374 | 0.50 | Star Trek: The Wrath of Khan (1982)
2000 | 0.50 | Lethal Weapon (1987)
2628 | 0.50 | Star Wars: Episode I - The Phantom Menace (1999)
2028 | 0.49 | Saving Private Ryan (1998)
1610 | 0.49 | Hunt for Red October, The (1990)
(20 rows)
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Time: 207.065 ms
Recommender System
This is a very simple recommender
●
system !
But it works !
●
Recompute item-item if needed
●
(10 mln ratings took 
15x15
2. Array of
intensities
}
smlar(arr1,arr2)
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Content-based similarity
23.56% similarity
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa
Thanks !
Oleg Bartunov, Teodor Sigaev Finding Similar PGCon-2012, Ottawa