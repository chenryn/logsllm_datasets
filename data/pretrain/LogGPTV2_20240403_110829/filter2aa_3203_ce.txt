Page: 463 
Chapter 16 – Troubleshooting TCP/IP 
Abstract 
This chapter describes how to troubleshoot problems with connectivity, name resolution, and Transmission Control 
Protocol (TCP) session creation using the set of tools and capabilities provided in Microsoft Windows operating 
systems. A network administrator must know how to methodically analyze a TCP/IP-related networking problem in 
terms of the various layers of the TCP/IP model and use the appropriate tools to be effective in isolating and resolving 
issues with successful communication on an TCP/IP network. 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 464 
Chapter Objectives 
After completing this chapter, you will be able to: 
List the common questions to ask when troubleshooting. 
List the set of TCP/IP troubleshooting tools provided with Windows and describe how each is used to 
obtain troubleshooting information. 
List and describe the guidelines, tools, and techniques for troubleshooting Internet Protocol version 4 
(IPv4) communications including IPv4 connectivity, Domain Name System (DNS) name resolution for 
IPv4 addresses, Network basic input/output system (NetBIOS) name resolution, and IPv4-based TCP 
sessions. 
List and describe the guidelines, tools, and techniques for troubleshooting Internet Protocol version 6 
(IPv6) communication including IPv6 connectivity, DNS name resolution for IPv6 addresses, and IPv6-
based TCP sessions. 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 465 
Identifying the Problem Source 
A logical approach is helpful when troubleshooting any problem. Some common questions to ask during 
troubleshooting include the following: 
What works? 
What does not work? 
How are the things that do and do not work related? 
Have the things that do not work ever worked? 
If so, what has changed since it last worked? 
The answers to these questions can indicate where to begin troubleshooting, possibly allowing you to 
isolate the component, layer, or configuration issue that is causing the problem. 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 466 
Windows Troubleshooting Tools 
Windows provides a full set of configuration, administration, and diagnostic tools and services that can 
be used to troubleshoot TCP/IP problems, as listed in Table 16-1.  
Tool 
Description 
Arp 
Allows viewing and editing of the Address Resolution Protocol 
(ARP) cache. 
Hostname 
Displays the host name of the computer. 
Ipconfig 
Displays the current TCP/IP configuration for both IPv4 and 
IPv6. Also used to manage Dynamic Host Configuration Protocol 
(DHCP)-allocated IPv4 address configurations, display or flush 
the DNS client resolver cache, and register DNS names. 
Nbtstat 
Displays NetBIOS over TCP/IP (NetBT) configuration and allows 
management of the NetBIOS name cache. 
Netsh 
Configuration tool for many network services. For each network 
service, there is a context containing commands specific for that 
service. For the netsh interface ip, netsh interface ipv4, and 
netsh interface ipv6 contexts, displays and administers TCP/IP 
protocol settings on either the local computer or a remote 
computer. 
Netstat 
Displays protocol statistics and information on current TCP 
connections. 
Nslookup 
Performs DNS queries and displays the results. 
Ping 
Sends Internet Control Message Protocol (ICMP) Echo or 
Internet Control Message Protocol for IPv6 (ICMPv6) Echo 
Request messages to test reachability. 
Route 
Allows viewing of the IPv4 and IPv6 routing tables and editing of 
the IPv4 routing table. 
Tracert 
Sends ICMP Echo or ICMPv6 Echo Request messages to trace 
the network route taken by IPv4 or IPv6 packets to a specific 
destination. 
Pathping 
Sends ICMP Echo or ICMPv6 Echo Request messages to trace 
the route an IPv4 or IPv6 packet takes to a destination and 
displays information on packet losses for each router and link in 
the path. 
SNMP service 
Provides status and statistical information to Simple Network 
Management System (SNMP) management systems. 
Event Viewer 
Records errors and events. 
Performance Logs and Alerts 
Logs TCP/IP core protocol performance and sends alerts (the 
SNMP service must be installed). 
Network Monitor 
Captures and displays the contents of TCP/IP packets sent to 
and from computers. 
Netdiag 
Runs a series of diagnostics test on networking components. 
Netdiag is installed as part of the Windows XP and Windows 
Server 2003 Support Tools in the Support\Tools folder of the 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 467 
Windows XP or Windows Server 2003 product CD-ROM. 
Telnet 
Tests TCP connection establishment between two nodes. 
Ttcp 
Listens for and sends TCP segment data or UDP messages 
between two nodes. Ttcp.exe is provided with Windows Server 
2003 in the Valueadd\Msft\Net\Tools folder of the Windows 
Server 2003 product CD-ROM. 
Table 16-1  Tools and Services for Troubleshooting TCP/IP 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 468 
Troubleshooting IPv4 
The following sections describe the tools and techniques used to identify a problem at successive 
layers of the TCP/IP protocol stack that is using an IPv4 Internet layer. Depending on the type of 
problem, you might do one of the following: 
Start at the bottom of the stack and move up. 
Start at the top of the stack and move down. 
The following sections are organized from the top of the stack and describe how to: 
Verify IPv4 connectivity. 
Verify DNS name resolution for IPv4 addresses. 
Verify NetBIOS name resolution. 
Verify IPv4-based TCP sessions. 
Although not specified in the following sections, you can also use Network Monitor to capture IPv4 
traffic to troubleshoot many problems with IPv4-based TCP/IP communications. However, to correctly 
interpret the display of IPv4 packets in Network Monitor, you must have an detailed knowledge of the 
protocols included in each packet. 
Verifying IPv4 Connectivity 
You can use the following tasks to troubleshoot problems with IPv4 connectivity: 
Repair the connection 
Verify configuration 
Manage configuration 
Verify reachability 
Check packet filtering 
View and manage the IPv4 routing table 
Verify router reliability 
Repair the Connection 
The Network Connection Repair feature can be used to quickly renew IPv4 network connection settings 
in an attempt to correct common configuration problems. Network Connection Repair performs a series 
of tasks that attempt to renew the connection as if it were just initialized. To access Network Connection 
Repair, do the following: 
1. Open the Network Connections folder. 
2. Right-click the connection that you want to repair, and then click Repair.  
You can also click Repair on the Support tab for the status of a network connection. 
The tasks that are performed by Network Connection Repair are the following: 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 469 
Checks whether DHCP is enabled and, if enabled, sends a broadcast DHCPRequest message to 
refresh the IPv4 address configuration.  
Flushes the ARP cache. This is equivalent to the arp -d * command. 
Flushes and reloads the DNS client resolver cache with entries from the Hosts file. This is equivalent to 
the ipconfig /flushdns command. 
Re-registers DNS names using DNS dynamic update. This is equivalent to the ipconfig /registerdns 
command. 
Flushes and reloads the NetBIOS name cache with #PRE entries in the Lmhosts file. This is equivalent 
to the nbtstat -R command. 
Releases and then re-registers NetBIOS names with the Windows Internet Name Service (WINS). This 
is equivalent to the nbtstat -RR command. 
Verify Configuration 
To check the current IPv4 settings for the correct address configuration (when manually configured) or 
an appropriate address configuration (when automatically configured), you can use the following: 
ipconfig /all 
The display of the ipconfig /all command includes IPv4 addresses, default gateways, and DNS 
settings for all interfaces. The Ipconfig tool only works on the local computer. 
netsh interface ip show config 
The display of the netsh interface ip show config command includes DNS and WINS servers per 
interface. Netsh can also be used to show the configuration of a remote computer by using the –r 
RemoteComputerName command line option. For example, to display the configuration of the 
remote computer named FILESRV1, use the netsh –r filesrv1 interface ip show config 
command. 
Support tab on the Status dialog box on a network connection 
To get the status of a network connection, double-click the connection in the Network Connections 
folder, and then click the Support tab. The Support tab lists the address type (DHCP or manually 
configured), the IPv4 address, subnet mask, and default gateway. Click Details on the Support tab 
to display the media access control (MAC) address, DHCP lease information, DNS servers, and 
WINS servers. 
Manage Configuration 
To make changes to the IPv4 address configuration, you can use the following: 
Network Connections folder 
From the Network Connections folder, you can make changes to the properties of the Internet 
Protocol Version 4 (TCP/IPv4) or Internet Protocol (TCP/IP) component for the appropriate network 
connection. 
netsh interface ip set commands 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 470 
You can use the netsh interface ip set address command to configure the address type (DHCP or 
manually configured), the IPv4 address, subnet mask, and default gateway. You can use the netsh 
interface ip set dns command to configure the source of DNS server addresses (DHCP or 
manually configured), a DNS server address, and DNS registration behavior. You can use the 
netsh interface ip set wins command to configure the source of WINS server addresses (DHCP 
or manually configured) and a WINS server address. 
You can also use the –r RemoteComputerName command line option of the Netsh tool to manage 
the IPv4 configuration of a remote computer. 
Ipconfig commands to manage DHCP addresses 
You can use the following commands to manage DHCP addresses: 
ipconfig /release 
ipconfig /renew 
ipconfig /showclassid 
ipconfig /setclassid 
For more information about using Ipconfig commands to manage DHCP address configurations, see 
Chapter 6, "Dynamic Host Configuration Protocol." 
Verify Reachability 
To verify reachability with a local or remote destination, try the following: 
Check and flush the ARP cache 
To display the current contents of the ARP cache, use the arp –a command. To flush the ARP 
cache, use the arp –d * command. This command also removes static ARP cache entries. 
Ping the default gateway 
Use the Ping tool to ping your default gateway by its IPv4 address. You can obtain the IPv4 
address of your default gateway from the display of the ipconfig, netsh interface ip show config, 
or route print commands. Pinging the default gateway tests whether you can reach local nodes 
and whether you can reach the default gateway, which is used to forward IPv4 packets to remote 
nodes. This step might not succeed if the default gateway is filtering all ICMP messages. 
Ping a remote destination by its IPv4 address 
If you are able to ping your default gateway, ping a remote destination by its IPv4 address. This 
step might not succeed if the destination is filtering all ICMP messages. Filtering of ICMP messages 
is prevalent on the Internet. 
Trace the route to the remote destination 
If you are unable to ping a remote destination by its IPv4 address, there might be a routing problem 
between your node and the destination node. Use the tracert –d IPv4Address command to trace 
the routing path to the remote destination. The –d command line option prevents the Tracert tool 
from performing a DNS reverse query on every near-side router interface in the routing path, which 
speeds up the display of the routing path. This step might not succeed if the intermediate routers or 
Chapter 16 – Troubleshooting TCP/IP 
TCP/IP Fundamentals for Microsoft Windows  
Page: 471 
the destination are filtering all ICMP messages. Filtering of ICMP messages is prevalent on the 
Internet. 
Check Packet Filtering 
The problem with reaching a destination node might be due to the configuration of Internet Protocol 
security (IPsec) or packet filtering on the source node, intermediate routers, or destination node that is 
preventing packets from being sent, forwarded, or received.  
On the source node, check for the following: 
Active connection security rules with the Windows Firewall with Advanced Security snap-in 
Active IPsec policies with the IP Security Monitor snap-in 
For computers running Windows Server 2008 or Windows Server 2003, Routing and Remote Access 
IPv4 packet filters on routing interfaces with the Routing and Remote Access snap-in 
On intermediate IPv4 routers that are running Windows Vista or Windows XP, check for the following: 
Active connection security rules with the Windows Firewall with Advanced Security snap-in 
Active IPsec policies with the IP Security Monitor snap-in 
On intermediate IPv4 routers that are running Windows Server 2008 or Windows Server 2003 and 