如果连接成功则退出程序，连接失败则继续攻击（相当于是个开关）。但在WannaCry大爆发第二天（2017年5月13日晚），英国的一个分析人员对这个域名进行了注册，病毒再访问这个网站就发现能访问了，即不再加密用户数据。所以5月份之后，遭到WannaCry攻击的联网电脑中的文件不会被实质性加密。也就是说虽然该病毒还在传播，但已经没有实际危害了。2017年5月-11月，永恒之蓝勒索蠕虫WannaCry攻击态势分析如下图所示。
360威胁情报中心及360天擎的监测信息显示，不同行业遭受永恒之蓝勒索蠕虫攻击的情况也有所不同，工程建设行业是遭受攻击最多的行业，占比为20.5%，其次制造业为17.3%，能源行业为15.3%，具体分布如下图所示。需要说明的是，该数据是根据2017年5-11月的总体情况进行分析和统计的，与5月份永恒之蓝勒索蠕虫刚刚爆发时相关数据统计有一定的区别。
WannaCry的幕后真凶到底是谁？这似乎一直是个迷。目前包括美国、加拿大、澳大利亚、新西兰、日本等国家，以及微软、谷歌、卡巴斯基、赛门铁克、火眼等科技公司和知名安全公司，也在或明或暗指责朝鲜黑客将WannaCry传播到全世界。美英政府称“在谨慎调查之后更非常坚定认为朝鲜黑客是WannaCry的幕后真凶”并公开指责。
## 0x06小结
WannaCry在勒索类病毒中全球首例使用了远程高危漏洞进行自我传播复制，危害不小于冲击波和震荡波蠕虫，也是今年影响最为严重的勒索病毒之一，这起大规模勒索病毒网络爆发事件至今已袭击了全球至少150国家或地区，包括教育、电力、能源、银行、交通、医疗、企业等多个行业均遭受不同程度的影响。
此次WannaCry勒索病毒已经不再是单纯的“炫技”，而是直接威胁到了每个人的数据财产、数据权利，乃至威胁到了社会经济和国家安全。
###  Petya
## 0x01 简介
2017年6月，乌克兰、俄罗斯、印度、西班牙、法国、英国以及欧洲多国遭受大规模Petya勒索病毒袭击，该病毒远程锁定设备，然后索要赎金。其中，乌克兰地区受灾最为严重，政府、银行、电力系统、通讯系统、企业以及机场都不同程度的受到了影响，包括首都基辅的鲍里斯波尔国际机场（Boryspil
International Airport）、乌克兰国家储蓄银行（Oschadbank）、船舶公司（AP Moller-Maersk）、俄罗斯石油公司（Rosneft）和乌克兰一些商业银行以及部分私人公司、零售企业和政府系统都遭到了攻击。
此次黑客使用的是Petya勒索病毒的变种，因此有人也称其为NotPetya，使用的传播攻击形式和WannaCry类似，但该病毒除了使用了永恒之蓝（MS17-010）漏洞，还罕见的使用了黑客的横向渗透攻击技术。在勒索技术方面与WannaCry等勒索软件不同之处在于，Petya木马主要通过加密硬盘驱动器主文件表（MFT），使主引导记录（MBR）不可操作，通过占用物理磁盘上的文件名、大小和位置的信息来限制对完整系统的访问，从而让电脑无法启动，故而其影响更加严重。如果想要恢复，需要支付价值相当于300美元的比特币。
由于这次攻击有很强的定向性，所以欧洲被感染的受害者较多，国内感染量较少。
## 0x02 Petya老样本介绍
2016年4月，敲诈勒索类木马Petya被安全厂商曝光，被称作是第一个将敲诈和修改MBR合二为一的恶意木马。木马Petya的主要特点是会先修改系统MBR引导扇区，强制重启后执行MBR引导扇区中的恶意代码，加密受害者硬盘数据后显示敲诈信息，并通过Tor匿名网络索取比特币。
Petya与其他流行的勒索软件的不同点在于，Petya不仅逐个加密文件，而是通过攻击磁盘上的低级结构来拒绝用户访问完整的系统。这个敲诈勒索木马的作者不仅创建了自己的引导加载程序，还创建了一个32个扇区长的小内核。
Petya的木马释放器会将恶意代码写入磁盘的开头。被感染的系统的主引导记录（MBR）将被加载一个小型恶意内核的自定义引导加载程序覆盖，然后该内核会进一步加密。
Petya的敲诈信息显示其加密了整个磁盘，但这只是木马作者放出的烟雾弹，事实上，Petya只是加密了主文件表（MFT），使文件系统不可读，来拒绝用户访问完整的系统。
## 0x03 Petya新样本介绍
病毒样本类型为DLL，有一个导出序号为1的函数。当这个函数被调用时，首先尝试提升当前进程的权限并设置标记，查找是否有指定的安全软件，后面会根据是否存在指定的安全软件跳过相应的流程。绕过安全软件的行为监控。
接下来修改磁盘的MBR，并将生成的Key，IV，比特币支付地址以及用户序列号写入磁盘的固定扇区。然后创建计划任务于1小时后重启。遍历局域网可以连通的ip列表，用于后续的局域网攻击。释放并执行抓取密码的进程，释放psexec进程用于后续执行远程命令。对系统的网络资源列表进行过滤，筛选本地保存的凭据，使用保存的凭据连接，成功后执行远程命令，进行局域网感染。
下一步生成随机ip，连接445端口进行永恒之蓝漏洞攻击。然后遍历磁盘，对指定扩展名的文件进行加密。执行完所有流程后，清除日志并强行重启。总体流程图如下：
## 0x04 Petya勒索蠕虫感染传播趋势分析
自6月27日在欧洲爆发的起，Petya勒索病毒在短时间内袭击了多国。根据360互联网安全中心的监测，对每一个小时的远程攻击进程的主防拦截进行了统计。从6月28号0点至6月28日晚上7点整，平均每小时攻击峰值在5000次以内。上午10点攻击拦截达到最高峰，后缓慢波动，在14点达到一个小高峰，然后攻击频率开始缓慢下降。由此可见，Petya的攻击趋势在国内并不呈现几何级增长的趋势，而是缓慢下降的，并不具备进一步泛滥的趋势。
除乌克兰、俄罗斯、印度、西班牙、法国、英国以及欧洲多国遭受大规模的Petya攻击外，我国也遭受了同样的攻击。针对我国的攻击，主要集中在北京、上海、广州、深圳、香港等大城市，根据360互联网安全中心的监测，在全中国八十多个城市拦截到了攻击。
## 0x05 Petya勒索加密技术分析
Petya采用RSA2048 +
AES128的方式对文件进行加密，程序中硬编码RSA公钥文件，针对每一个盘符都会生成一个AES128的会话密钥，该盘符所有文件均用该AES
Key进行加密,加密流程如下图:
加密的文件类型如下：
当系统重启后，执行病毒的MBR，伪装成CHKDSK进行加密，不仅会加密MBR和MFT结构，也会将MFT对应的文件内容的前两个扇区进行加密加密，换句话说，Petya变种勒索蠕虫在系统启动时MBR中的代码执行时也会进行全盘文件的加密操作。结合RING3级别的勒索代码功能，Petya会对文件执行两次加密操作，第一次为Petya勒索蠕虫执行时，使用RSA与AES算法遍历文件系统对指定扩展名的文件加密，第二次为系统启动时，启动扇区的代码会通过遍历MFT结构定位文件内容并对文件使用修改的salsa20算法进行加密。
完成后弹出敲诈信息对用户进行敲诈：
## 0x06勒索病毒Salsa20算法实现的缺陷分析
对于RING3级别的文件加密过程，解密密钥可以通过勒索蠕虫作者的RSA私钥进行解密获得，而启动扇区级别的文件加密过程使用了随机密码进行，启动扇区级别的文件加密无法解密，但360CERT经过对修改版的Salsa20算法与原始算法对比分析发现存在两处变化，其中一处明显降低了标准Salsa20算法的加密强度，修改版Salsa20算法造成的差异会导致每隔64K块出现重复的核心函数输入项，这将极大影响这种加密算法的安全性。对此，算法攻击者只要已知连续4MB明文，就能解密全部密文。另外若已知若干离散明文块，则可解密部分密文，也可能解密全部密文（已知部分分布合适的情况）。
相关证明如下：
## 0x07小结
Petya勒索病毒早已被安全厂商披露，而Petya再一次卷土重来，肆虐欧洲大陆在于其利用了永恒系列漏洞、局域网感染等网络自我复制技术，使得病毒可以在短时间内呈暴发态势。
自5月份WannaCry勒索病毒爆发后，中国用户已经安装了上述漏洞的补丁，同时360安全卫士具备此次黑客横向攻击的主动防御拦截技术，故而并没有为Petya勒索病毒的泛滥传播提供可乘之机。
###  Bad Rabbit
## 0x01 简介
2017年10月，360CERT监测到有一起名为“坏兔子”（the Bad
Rabbit）的勒索病毒正在东欧和俄罗斯地区传播，影响了俄罗斯部分媒体组织，乌克兰的部分业务，包括基辅的公共交通系统和国家敖德萨机场，此外还影响了保加利亚和土耳其。
“坏兔子”主要是通过伪装flash安装程序让用户下载运行和暴力枚举NTLM帐号密码的形式进行传播，使用“永恒浪漫”漏洞进行传播，感染形式上和此前的Petya勒索病毒相似，会主动加密受害者的主引导记录(MBR)。“坏兔子”在勒索赎金上有所变化，初始赎金为0.05
比特币（约280美元），随时间的推移会进一步增加赎金。
## 0x02影响面
经过360CERT分析，“坏兔子”事件属于勒索病毒行为，需要重点关注其传播途径和危害：
主要通过入侵某合法新闻媒体网站，该媒体在乌克兰，土耳其，保加利亚，俄罗斯均有分网站。在受害者访问时会被引导安装一个伪装的flash安装程序（文件名为
install_flash_player. exe），用户一旦点击安装后就会被植入“坏兔子”勒索病毒。
“坏兔子”样本主要通过提取主机NTLM认证信息和硬编码部分用户名密码暴力破解NTLM登录凭据的方式和“永恒浪漫”漏洞来进一步感染可以触及的主机。
“坏兔子”会试图感染目标主机上的文件和主引导分区，赎金会随着时间的推移而增长。
综合判定“坏兔子”勒索病毒通过“水坑”方式和“永恒浪漫”漏洞进行较大规模传播，且产生的危害严重，属于较大网络安全事件。
根据360互联网安全中心的统计，该木马主要在俄罗斯、乌克兰等东欧国家和地区流行。
## 0x03技术细节
**传播信息**
“坏兔子”勒索病毒通过链接 hxxp://1dnscontrol[.]com/flash_install.php 链接进行传播，该域名下的可疑连接如下：
**整体行为**
“坏兔子”勒索病毒感染初期，需要通过受害者手动启动下载名为 install_flash_player.exe的可行性文件，该文件需要提升的权限才能运行,
Windows
UAC会提示这个动作，如果受害者还是同意了，病毒就会按照预期运行，在感染成功后会试图通过NTLM登陆凭证暴力破解和“永恒浪漫”的漏洞进行传播。
“坏兔子”勒索病毒主要包括如下流程：
  * “install_flash_player.exe”会下载名为 infpub.dat 的DLL恶意载体。
  * infpub.dat会夹带和释放传播模块和文件加密模块。
  * 合法的DiskCryptor加密模块，discpci.exe，包括32和64位。
  * 2个疑似mimikatz模块。
  * 生成IP信息，暴力破解NTLM登陆凭证，实现进一步感染。
  * 该文件会被保存到C[:]\Windows\infpub.dat路径中。
  * Rundll32.exe 加载infpub.dat文件。
  * 增加计划任务“rhaegal”启动discpci.exe实现磁盘加密。
  * 增加计划任务“drogon”重启系统，并显示被勒索界面。
  * 在暴力破解完成后，会试图利用“永恒浪漫”漏洞实现进一步感染。
  * 创建感染线程，尝试对外感染。
  * 重启前会主动删除部分日志信息。
流程图如下：
“坏兔子”勒索病毒在行为方面并没有太多的创新，具体的程序执行链可以直接通过360核心安全团队的沙箱平台分析出来：
“ **永恒浪漫”漏洞相关细节**
BadRabbit疑似在暴力破解NTLM之后，还试图利用了“永恒浪漫”EternalRomance漏洞传播。
与之前Petya使用TheShadowBrokers中的shellcode不同，BadRabbit中的利用根据github上公布的python漏洞利用脚本修改而来：
[https://github.com/worawit/MS17-010/blob/master/zzz_exploit.py](https://github.com/worawit/MS17-010/blob/master/zzz_exploit.py)
**加密信息**
加密手法并无太大新意，使用了上文中相同的RSA2048算法，这里不再赘述，勒索加密文件的类型如下：
而除了传统的加密文件之外，该木马还会创建一个名为dispci.exe的程序，而这个dispci.exe在重启之后会创建一个名为cscc.dat的驱动程序并与之通信，驱动的功能则和之前提到曾大规模爆发的Petya相似——通过修改MBR的方式劫持开机启动。感染成功后的logo:
## 0x04小结
根据监测，中国地区基本不受“坏兔子”勒索病毒影响。“坏兔子”勒索蠕虫虽然在传播范围上不及WannaCry，但在内部实现上却可以看出比之前WannaCry和Petya更为缜密，病毒作者在设计上是取其前者的优点并避开不足之处，同时也采用了前者没有利用的水坑攻击方式。