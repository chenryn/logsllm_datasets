图7-17绿盟“黑洞”规则自定义界面
7.2.7破防和反制
从安全管理者的角度看，即便是拥有完整的4层防御机制也并非无懈可击，号称拥有
400-500G防护能力的平台是完全有可能被打跨的，完全的防护能力是建立在人、策略、技
术手段都生效的情况才有的，如果这些环节出了问题，抗DDoS的整个过程可能会失败。
例如下面提到的这些问题：
---
## Page 124
112技术篇
口超大流量攻击时需要用到黑润路由，但黑润路由的IP需要由防御方定义和联动，“联
动”的过程就是向上游设备发送封禁IP的通知，如果接口不可用，那么此功能会失
效，所以ISP级的防御是有失效可能性的
口CDN云清洗服务依赖于清洗服务商接管域名解析，如果云清洗服务商本身的DNS
不可用，也将导致这一层面的防御失效，诸如此类的问题还有不少，这些抗D厂商
自身并非无邂可击。
口ADS平时不一定串联部署，但攻击发生引流后一定是业务的前端设备，假如这个设
备本身存在DOS的可能，即使是触发了bypass 也相当于防御完全失效了，另一方面
策略下发通常是ADS设备跟管理节点互通，如果管理节点出现可用性问题，也将导
致ADS防御的一系列问题
口超大流量攻击需要人工干预时，最基本的需求是安全或运维人员能在办公网络连
接到ADS的管理节点，能远程运维ADS设备，如果此时办公网络的运维管理链
路出现故障，不仅切断了人员操作，还会把现场应急的紧张气氛提升一个量级，
使人更加手忙脚乱。
以上并不在于提供新的攻击的思路，面在于向抗DDoS方案的制定者提供另类视角以
便于审视方案中的短板。
7.2.8立案和追踪
目前对于流量在100G以上的攻击是可以立案的，这比过去幸福了很多。过去没有本土
特色的资源甚至都没法立案，但是立案只是方里长征的第一步，如果你想找到人，必须成
功完成以下步骤：
口在御量的攻击中，寻找倒推的线索，找出可能是C&C服务器的IP或相关域名等
口“黑”吃“黑”，端掉C&C服务器。
攻击者。
口陪叔叔们上门抓捕
口上法庭诉讼。
如果抓到这个人没有特殊身份，也许你能如愿；但假如遇到一些特殊人物，你儿个月
都白忙乎。面黑吃黑的能力则依赖于安全团队本身的渗透能力，且有闲情逸致做这事。这
个过程对很多企业来说成本还是有点高，光有实力的安全团队这条门槛就足以砍掉绝大多
数公司。笔者过去也只是恰好有缘遇到了这么一个团队。
---
## Page 125
第7章网络安全113
参考资料
2015H1绿盟科技DDoS威胁报告
华为AntiDDoS8000DDoS防御系统
http://e.huawei.com/cn/products/enterprise-networking/security/anti-ddos/8000
7.3
链路劫持
1. HTTPDNS
运营商为了减少跨ISP的流量结算，会在本网内缓存ICP的内容，广告联盟等甚至也
会劫持域名替换广告，劫持域名解析是安全上的一大隐患，意味着可以任意操纵缓存，随
意挂马。
HTTPDNS原来是一个为优化用户体验发明的东西，其本质就是利用HTTP协议来完成
域名解析，防止被运营商劫持，原理如图7-18所示。通常情况下使用HTTPDNS的客户端
域名解析会走互联网公司自己的服务器，跳过运营商的本地DNS，这个产品原来的目的虽
然不是为了安全设计，但从安全上来看缓解了一些问题。当然并不是绝对的，HTTPDNS的
请求由于是明文的，理论上完全可以劫持。只不过劫持的代价比原来更大一些。
B认 1LL1
444om江58确2.22.2
44com[多电8 3.3.3.3
北单单通4.4.4.4
权威DNS
用户接人模块
14.44
运营商 LocaIDNS 服务器
业务授权DNS服务器
图7-18HTTPDNS 原理
---
## Page 126
114技术篇
如果希望完全规避DNS解析劫持的问题，需要使用加密的DNS请求，目前IETF已经有了
DNS over TLS 的草案 : ( https:/datatracker.ietf.org/doc/draft-ietf-dprive-dns-over-tls/?include
text=1)，相信随着刚需会很快变成现实。
2.全站HTTPS
全站HTTPS主要解决当前越来越严峻的网民隐私泄露问题，减少被中间人监听和会话
劫持的可能。之前HTTPS多用在登录和交易环节，现在国内也开始紧跟国外互联网的趋势
逐渐进入全站HTTPS时代。
升级成全站HTTPS对于大型站点来说是一个比较复杂的工程，这里只强调一下与安全
相关的部分：
SSL/TLS协议—对于常用的协议TLS1.2,TLS1.1,TLS1.0和SSL3.0，目前只有
TLS1.1和TLS1.2暂时没有曝已知的安全漏润，基本上互联网公司的在线业务都使
用这两个版本，在TLS1.3面世之前没有太多选择。
口加密算法—密钥交换算法建议使用RSA或ECDHE_RSA。内容传输加密建议使用
AES-GCM，目前google推出的boring ssl支持新型的流式加密算法ChaCha20 也可
用于内容加密。
口防降级攻击一降级攻击一般手法是伪造客户端请求，试图改变加密算法为不安
全的加密或改变协议版本为低版本，针对这样的攻击，需要配置SCSV（Signaling
CipherSuiteValue）选项，另外需要禁止客户端主动重协商。
口其他问题—如果为提升性能支持TFO.（TCPFast Open-RFC7413），TFO实际上允
许TCPISYN包带payload，对现有的抗DDoS策略会产生比较大的影响。
大型站点除了Web服务器需要支持HTTPS以外，CDN也需要支持HTTPS，一般情况
下需要把网站的私钥提供给CDN服务商，但这样就引人了第三方的风险，不得不提的是
cloudflare，它提供了keyless的HTTPS服务，分成几种实现，从轻度到重度，如图7-19所示。
Flexible SSL只做客户端浏览器到 CDN之间的HTTPS加密，回源使用HTTP。Full
SSL这个层次不止实现前者，还包括CDN到源站之间也是用HTTPS，但不校验服务端证
书，而第三个层次不仅全HTTPS，且会校验服务端证书的有效性。目前对于大多数站点而
言，也就是做到Flexible SSL这个层次，就能缓解靠近用户那一侧被劫持的问题，后面的
部分由厂商自己来保证。但Flexible SSL是否就够用，要看具体业务，对于安全性和隐私
保护极高的业务，例如金融行业的在线服务的HTTPS需要使用严格版本的SSL加密。
---
## Page 127
第7章网络安全115
Flexible SSL
。
On
Visito
CloudFlare
Origin server
Full SSL
Requires SSL on your host
。
Visit
CloudFlare
Origin server
FullI SSL(strict)
 a valid SSL certificate
自
Visit
CloudFlare
Origin server
图7-19HTTPS的三种不同模式
3.登录过程加密
即便在HTTPS的状态下传输口令，假如网关流量被劫持，证书被替换，无知的小白用
户还是选择了不安全的连接怎么办，另一方面现在还出现了在IDC劫持流量的攻击行为，
后一种盗号的效果直逼拖库，于是有的厂商想到了在HTTPS的基础上，在应用层再实现
一次加密，即便你劫持了流量，也看不到明文。以某厂账号的网页登录为例，登录过程中，
在客户端利用JavaScript先将用户输人的口令加密，然后再提交给服务端。
function preprocess (A) [
var B = "*;
B += A,verifycode,valueJ
//获取验证码的值
B = B.toUpperCase () :
//将验证码转换成大写字母
A. p. va1ue = md5 (nd5_3 (A . p . value) + B) ;
//先将口令进行md5_3（）加害，然后和验证码再做—次MD5
return true
这是早期的一个版本，后来变成如下加密方式：
md5 (md5 (hexchar2bin (md5 (p×d) ) +u1n) +ver↓fycode , toUpperCase () )
其加密算法一直在更新，不过这里只是为了举例说明javaScript加密在对抗劫持下的作
用。当然JavaScript加密用于传输密文只是一方面，另一方面也是为了防止协议逆向后引发
---
## Page 128
116技术篇
的业务安全问题，例如自动化注册机。
4.跨IDC传输加密
对于真正发生于IDC链路层的劫持，目前没有很好的解决方案，只能尽可能做到在跨
IDC传输，跨安全域传输的时候使用加密通道。应用层支持全流量TLS或加密的VPN点对
点连接。
AWS（亚马逊的公有云）是业内公认安全做得比较好的平台。作为第三方平台AWS的
合规性支持是目前种类最多的，包括：
 SOC 1/SSAE 16/ISAE 3402 (formerly SAS 70)
 SOC 2
 SOC 3
 FISMA, DIACAP, and FedRAMP
 DOD CSM Levels 1-5
 PCI DSS Level 1
 ISO 27001
ITAR
 FIPS 140-2
 MTCS Level 3
 HIPAA
 Cloud Security Alliance (CSA)
 Motion Picture Association of America (MPAA)
之所以能做到这个程度是因为基础安全做得比较好，表现在一些细节上，比如AWS几
乎所有的上层产品都支持TLS加密传输，例如：S3存储、Glacier备份、所有类型RDS服
务、DynamoDB（Cache）、Redshift（BI）、EMR（大数据）、Kinesis（流式计算）等。
参考资料
DNSpod d+
https://www.dnspod.cn/httpdns
cloudflare:
https://www.cloudflare.com/ssl/
---
## Page 129
第7章网络安全117
7.4应用防火墙WAF
应用防火墙（Web Application Firewall，WAF）是Web应用防护系统，也称“网站应用
级入侵防御系统”。通过针对基于HTTP/HTTPS协议的流量建立检测或拦截规则，实现安
全防护的目的。因其部署较为灵活，且对业务的侵入性比较小，是近儿年非常受欢迎的一
类安全系统，且商业化产品层出不穷。
7.4.1WAF架构分类
WAF架构根据部署方式的不同，通常分为cname 部署、module 部署、网络层部署。也
有部分公司根据目身需要实施混合部署与运营的架构，这通常需要一定的架构设计和开发
能力，包括业务方的配合。国外儿款商业产品的WAF支持导人证书的方式来解决HTTPS
环境的安全防护，通常国内各甲方安全团队自研WAF产品基本不支持HTTPS。
1.cname部署
这是近几年国内非常流行的WAF部署，知道创宇推出的“加速乐”就是其代表产品。
其部署方式非常简单方便。只需将域名Cname方式解析指向加速乐分配的cname别名就完
成了部署。对于用户来说，整个WAF的防护和运营几乎是透明的。
cname方式最大的优势就是部署方便快速，且理论上还有加速网站性能还和阻断DDoS
攻击等效果，实现了安全防护和性能优化双重目标。这也是常见的厂商宣。但其缺陷也是
非常明显的，HTTPS流量是无法防护的，因为中间代理无法解析请求内容，进而无法对其
攻击负载做检测与防护。
2. module 部署
module部署的WAF典型产品是开源软件ModSecurity（官方网站：http://www.modse
curity.org/)。最初 ModSecurity 是基于Apache httpd上的 module 开发出来的，针对 HTTP
HTTPS 协议攻击做检测和防护的开源产品。现在已经衍生出IIS版和Nginx版。
这种部署方式相比cname方式麻烦得多，需在webserver部署\编译时支持modules，
编译完ModSecurity模块之后，修改webserver配置文件生效。它通常默认就已经有大
量的安全策略规则，但如果全启用，一方面性能消耗很大，另一方面也未必适用于自身
---
## Page 130
118技术篇
环境安全问题。所以后续还要对规则进行优化精简和按需增加，对运营人员的要求相对