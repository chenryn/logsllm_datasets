2022-10-10T07:24:34.5781410-07:00|INFORMATION|Resolved Collection Methods: Group,
LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP,
ObjectProps, DCOM, SPNTargets, PSRemote
2022-10-10T07:24:34.5937984-07:00|INFORMATION|Initializing SharpHound at 7:24 AM on
10/10/2022
2022-10-10T07:24:35.0781142-07:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup,
Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets,
PSRemote
2022-10-10T07:24:35.3281888-07:00|INFORMATION|Beginning LDAP ysearch for beyond.com
2022-10-10T07:24:35.3906114-07:00|INFORMATION|Producer has finished, closing LDAP
channel
k
2022-10-10T07:24:35.3906114-07:00|INFORMATION|LDAP channel closed, waiting for
consumers
2022-10-10T07:25:06.1421842-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s --
s
Using 92 MB RAM
2022-10-10T07:25:21.6307386-07:00|INFORMATION|Consumers finished, closing output
channel o
Closing writers
2022-10-10T07:25:21.6932468-07:00|INFORMATION|Output channel closed, waiting for
output task to complete n
2022-10-10T07:25:21.8338601-07:00|INFORMATION|Status: 98 objects finished (+98
2.130435)/s -- Using 103 MB RAM
i
2022-10-10T07:25:21.8338601-07:00|INFORMATION|Enumeration finished in 00:00:46.5180822
2022-10-10T07:25:21.9414294-07z:00|INFORMATION|Saving cache with stats: 57 ID to type
mappings.
58 name to SID mappings.
D
1 machine sid mappings.
2 sid to domain mappings.
0 global catalog mappings.
2022-10-10T07:25:21.9570748-07:00|INFORMATION|SharpHound Enumeration Completed at 7:25
AM on 10/10/2022! Happy Graphing!
Listing 914 - Executing the PowerShell BloodHound collector
Once SharpHound has finished, we can list the files in the directory to locate the Zip archive
containing our enumeration results.
PS C:\Users\marcus> dir
dir
Directory: C:\Users\marcus
Mode LastWriteTime Length Name
---- ------------- ------ ----
d-r--- 9/29/2022 1:49 AM Contacts
d-r--- 9/29/2022 1:49 AM Desktop
d-r--- 9/29/2022 4:37 AM Documents
d-r--- 9/29/2022 4:33 AM Downloads
d-r--- 9/29/2022 1:49 AM Favorites
d-r--- 9/29/2022 1:49 AM Links
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 836
Made in Morocco
Penetration Testing with Kali Linux
d-r--- 9/29/2022 1:49 AM Music
d-r--- 9/29/2022 1:50 AM OneDrive
d-r--- 9/29/2022 1:50 AM Pictures
d-r--- 9/29/2022 1:49 AM Saved Games
d-r--- 9/29/2022 1:50 AM Searches
d-r--- 9/29/2022 4:30 AM Videos
-a---- 10/10/2022 7:25 AM 11995 20221010072521_BloodHound.zip
-a---- 10/10/2022 7:23 AM 1318097 SharpHound.ps1
-a---- 10/10/2022 5:02 AM 1936384 winPEAS.exe
-a---- 10/10/2022 7:25 AM 8703
Zjc5OGNlNTktMzQ0Ni00YThkLWEzZjEtNWNhZGJlNzdmODZl.bin
Listing 915 - Directory listing to identify the name of the SharpHound Zip archive
Let’s transfer the file to our Kali machine then start neo4j and BloodHound. Once BloodHound is
started, we’ll upload the zip archive with the Upload Data function.
y
k
s
o
n
i
z
D
Figure 294: Upload Zip Archive to BloodHound
Once the upload is finished, we can start the enumeration of the AD environment with
BloodHound.
Before we start, let’s briefly review some of BloodHound’s capabilities. As we have learned,
BloodHound contains various pre-built queries such as Find all Domain Admins. These queries are
built with the Cypher Query Language.1198 In addition to the pre-built queries, BloodHound also
allows us to enter custom queries via the Raw Query function at the bottom of the GUI.
Since we are currently interested in basic domain enumeration, such as listing AD users and
computers, we have to build and enter custom queries as the pre-built functions don’t provide
these capabilities.
Let’s build a raw query to display all computers identified by the collector. The query starts with
the keyword MATCH, which is used to select a set of objects. Then, we set the variable m
1198 (Neo4j Cypher, 2022), https://neo4j.com/developer/cypher/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 837
Made in Morocco
Penetration Testing with Kali Linux
containing all objects in the database with the property Computer. Next, we use the RETURN
keyword to build the resulting graph based on the objects in m.
MATCH (m:Computer) RETURN m
Listing 916 - Custom query to display all computers
Let’s enter this query in the Raw Query section and build the graph.
y
k
s
o
n
i
z
D
Figure 295: Show all Computer objects in the BEYOND.COM domain
Figure 295 shows that there are four computer objects in the domain. By clicking on the nodes,
we can obtain additional information about the computer objects, such as the operating system.
DCSRV1.BEYOND.COM - Windows Server 2022 Standard
INTERNALSRV1.BEYOND.COM - Windows Server 2022 Standard
MAILSRV1.BEYOND.COM - Windows Server 2022 Standard
CLIENTWK1.BEYOND.COM - Windows 11 Pro
Listing 917 - Identified computer objects and their operating system
In addition to CLIENTWK1, on which we have an interactive shell, BloodHound has also identified
the already known domain controller DCSRV1 and dual-homed mail server MAILSRV1.
Furthermore, it discovered another machine named INTERNALSRV1.
Let’s obtain the IP address for INTERNALSRV1 with nslookup.
PS C:\Users\marcus> nslookup INTERNALSRV1.BEYOND.COM
nslookup INTERNALSRV1.BEYOND.COM
Server: UnKnown
Address: 172.16.6.240
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 838
Made in Morocco
Penetration Testing with Kali Linux
Name: INTERNALSRV1.BEYOND.COM
Address: 172.16.6.241
Listing 918 - Looking up the IP address of INTERNALSRV1 via nslookup
Listing 918 shows that the IP address for INTERNALSRV1 is 172.16.6.241. Let’s add this
information to computer.txt on our Kali machine.
172.16.6.240 - DCSRV1.BEYOND.COM
-> Domain Controller
172.16.6.241 - INTERNALSRV1.BEYOND.COM
172.16.6.254 - MAILSRV1.BEYOND.COM
-> Mail Server
-> Dual Homed Host (External IP: 192.168.50.242)
y
172.16.6.243 - CLIENTWK1.BEYOND.COM
-> User _marcus_ fetches emails on this machine
k
Listing 919 - Documenting results and information in computer.txt
Next, we want to display all user accounts on the domain. For this, we can replace the Computer
s
property of the previous query with User.
o
n
i
z
D
Figure 296: Show all User objects in the BEYOND.COM domain
Figure 296 shows that apart from the default AD user accounts, there are four other user account
objects in the domain.
BECCY
JOHN
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 839
Made in Morocco
Penetration Testing with Kali Linux
DANIELA
MARCUS
Listing 920 - Discovered domain users
We already identified john and marcus as valid domain users in previous steps. However, we
haven’t established yet if daniela is also a domain user and not just a local user on WEBSRV1. In
addition, we discovered a new user named beccy. Let’s update usernames.txt accordingly.
To be able to use some of BloodHound’s pre-built queries, we can mark marcus (interactive shell
on CLIENTWK1) and john (valid credentials) as Owned. To do this, we’ll right-click on the
PI:EMAIL and PI:EMAIL nodes and select Mark User as Owned.
Next, let’s display all domain administrators by using the pre-built Find all Domain Admins query
under the Analysis tab.
y
k
s
o
n
i
z
D
Figure 297: Show all User objects in the BEYOND.COM domain
Figure 297 shows that apart from the default domain Administrator account, beccy is also a
member of the Domain Admins group.
In a real penetration test, we should also examine domain groups and GPOs.
Enumerating both is often a powerful method to elevate our privileges in the
domain or gain access to other systems. For this simulated penetration test, we’ll
skip these two enumeration steps as they provide no additional value for this
environment.
Next, let’s use some of the pre-built queries to find potential vectors to elevate our privileges or
gain access to other systems. We’ll run the following pre-built queries:
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 840
Made in Morocco
Penetration Testing with Kali Linux
• Find Workstations where Domain Users can RDP
• Find Servers where Domain Users can RDP
• Find Computers where Domain Users are Local Admin
• Shortest Path to Domain Admins from Owned Principals
Unfortunately, none of these queries return any results. This means BloodHound didn’t identify
any workstations or servers where Domain Users can log in via RDP.
In addition, no Domain Users are a local Administrator on any computer objects. Therefore, we
don’t have privileged access on any domain computers as john or marcus.
Finally, there are no direct paths from owned users to the Domain Admins group that BloodHound
could identify.
y
These pre-built queries are often a quick and powerful way to identify low hanging fruit in our
quest to elevate our privileges and gain access to other systems. Because BloodHound didn’t
k
provide us with actionable vectors, we have to resort to other methods.
s
We could have also used PowerView or LDAP queries to obtain all of this
information. However, in most penetrationo tests, we want to use BloodHound
first as the output of the other methods can be quite overwhelming. It’s an
effective and powerful tool to gain a deeper understanding of the Active Directory
n
environment in a short amount of time. We can also use raw or pre-built queries
to identify highly complex attack vectors and display them in an interactive
graphical view. i
z
Before we further enumeraDte the domain in the next section, let’s summarize the information
we’ve obtained so far. We identified four computer objects and four user accounts and learned
that beccy is a member of the Domain Admins group, making it a high value target. Furthermore,
we ruled out some vectors that would have provided us access to other systems or privileged
users.
24.4.2 Services and Sessions
In the previous section, we performed basic enumeration to obtain an understanding of the Active
Directory environment.
In this section, we’ll further enumerate the target network to identify potential attack vectors. First,
we’ll review all active user sessions on machines. Then, we’ll examine user accounts for the
existence of SPNs.1199 Finally, we’ll leverage tools such as Nmap and CrackMapExec via a
SOCKS51200 proxy to identify accessible services.
1199 (Microsoft Learn, 2021), https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names
1200 (Wikipedia, 2022), https://en.wikipedia.org/wiki/SOCKS
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 841
Made in Morocco
Penetration Testing with Kali Linux
To review active sessions, we’ll again use a custom query in BloodHound. Since Cypher is a
querying language, we can build a relationship query with the following syntax (NODES)-
[:RELATIONSHIP]->(NODES).1201
The relationship for our use case is [:HasSession]. The first node of the relationship specified by a
property is (c:Computer) and the second is (m:User). Meaning, the edge between the two nodes
has its source at the computer object. We’ll use p to store and display the data.
MATCH p = (c:Computer)-[:HasSession]->(m:User) RETURN p
Listing 921 - Custom query to display all active sessions
Now, let’s enter the custom query in BloodHound:
y
k
s
o
n
Figure 298: Display all active sessions in the BEYOND.COM domain
i
Figure 298 shows that our query zresulted in three active sessions. As expected, CLIENTWK1 has
an active session with the user marcus.
D
Interestingly, the previously identified domain administrator account beccy has an active session
on MAILSRV1. If we manage to get privileged access to this machine, we can potentially extract
the NTLM hash for this user.
The user of the third active session is displayed as a SID. BloodHound uses this representation of
a principal when the domain identifier of the SID is from a local machine. For this session, this
means that the local Administrator (indicated by RID 500) has an active session on
INTERNALSRV1.
Our next step is to identify all kerberoastable users in the domain. To do so, we can use the List all
Kerberoastable Accounts pre-built query in BloodHound.
1201 (Neo4j Cypher Querying, 2022), https://neo4j.com/developer/cypher/querying/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 842
Made in Morocco
Penetration Testing with Kali Linux
Figure 299: Display all kerberoastable user accounts in the BEYOND.COM domain
Figure 299 shows that apart from krbtgt, daniela is also kerberoastable.
y
The krbtgt user account acts as service account for the Key Distribution Center
(KDC)1202 and is responsible for encrypting and signing Kerberos tickets. When a
k
domain is set up, a password is randomly generated for this user account,
making a password attack unfeasible. Therefore, we can often safely skip krbtgt
s
in the context of Kerberoasting.
o
Let’s examine the SPN for daniela in BloodHound via the Node Info menu by clicking on the node.
n
i
z
D
1202 (Wikipedia, 2019), https://en.wikipedia.org/wiki/Key_distribution_center
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 843
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
o
n
i
z
D
Figure 300: SPN of the user account daniela
Figure 300 shows the mapped SPN http/internalsrv1.beyond.com. Based on this, we can assume
that a web server is running on INTERNALSRV1. Once we’ve performed Kerberoasting and
potentially obtained the plaintext password for daniela, we may use it to access INTERNALSRV1.
However, as we have stated before, finding an actionable vector should not interrupt our
enumeration process. We should collect all information, prioritize it, and then perform potential
attacks.
Therefore, let’s set up a SOCKS5 proxy to perform network enumeration via Nmap and
CrackMapExec in order to identify accessible services, open ports, and SMB settings.
First, we’ll create a staged Meterpreter TCP reverse shell as an executable file with msfvenom.