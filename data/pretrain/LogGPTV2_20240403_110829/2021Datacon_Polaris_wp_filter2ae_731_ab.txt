#### 1.2 UDP-based流量分析
分析通过UDP进行隧道通信的样本流量（`0,6,8`类样本）。在图
2中，我们展示了这三类样本基于UDP协议的应用层协议。其中，`0`类样本无法识别具体的应用层协议，判断为UDP私有协议通信。`6`样本具有少量的OCSP包。`8`样本的UDP载荷为WireGuard包，该样本通过该协议进行隧道通信。UDP通信样本类别的协议如下图：
#### 1.3 TCP-based流量分析
分析基于TCP的样本流量数据。由之前的分析可知，基于TCP的通信流量基本分为两类——TLS标准加密通信与TCP私有协议加密通信。分别对应`1,2,3,10`类样本与`4,5,7,9`类样本。
#### 1.3.1 TCP-based TLS流量分析
对基于TLS标准加密通信的流量数据进行分析。图3展示了`1,2,3,10`类样本的TLS版本包含情况。可以看到，所有的类别的通信都使用TLS1.2进行加密通信，但其中包含的TLS通信包数量比例不尽相同。类别`1`的TLS数据包占比比较高。TLS版本分布如下图：
统计流量样本中的握手信息。Client Hello数量纬度上，`1`类样本中不存在Client Hello报文。`2,3,10`类中均存在Client
Hello包。Client Hello包长统计分布如下图：
统计剩余三类样本的Client Hello的包长，按顺序分别为类别`2,3,10`。发现，三类样本类间包长不同，且类内包长十分统一。`2`的Client
Hello长度为334，`3`为330，`10`为571。
#### 1.3.2 TCP-based 私有协议分析
在流量数据中只存在TCP流量包，而不能识别出具体应用层协议的流量样本类别，推断为私有协议加密的流量（`4,5,7,9`）。
首先，分析了这四类中TCP通信错误包的占比。如下图所示，分析TCP错误包与TCP控制包的占比（错误ACK序列号的响应包数量）。其中，类别`4`的样本包含了大量的Bad
ACK包，而其他类别几乎不含此类通信包，因此可将其视为该类别的强特征。
对于类别`5,7,9`三类流量数据分析训练数据中的包长分布。下图从左到右依次为类别`5,7,9`。其中类别`5`的包长度基本小于1000，集中于300以下，类别`7`的最大包长为1514，类别`9`的最大包长为1478。
以上总结出每一个类的强特征规则，接下来介绍强特征推理算法。
### 1.4 基于强特征的推理树
我们设计了一种针对于该多分类任务的推理算法，将11类分类问题转化为多个二分类任务。每次二分类中，使用一组强特征规则，将类别划分为两种不同的子类。推理树算法的总体流程如下图所示。
**Step1**
：首先将总类别划分为两种子类，基于UDP的流量样本与基于TCP的流量样本，在该步骤中，提取每一个PCAP中每一个分组的传输层协议，基于UDP的划分为`0,6,8`三个子类，基于TCP的划分为`1,2,3,4,5,7,9,10`八个子类。
**Step2** ：对于 **UDP-based**
的流量数据，判断其具体的UDP载荷协议。具有WireGuard协议的通信，判定为0类通信软件产生的流量；包含OCSP协议的通信，为`6`类通信软件产生的流量；未能识别具体载荷协议的判定为`8`。
**Step3** ：对于 **TCP-based**
的流量数据，进一步分为两大子类。通过分析PCAP中的通信协议，将包含了TLS标准加密的PCAP划分到TLS-based的子类中，将只包含TCP包的PCAP划分到私有协议的子类中。
**Step4** ：对于 **TLS-based** 的标准协议流量，进一步使用强特征归类。在此，统计Client
Hello的数量与包长度分布。不具有该类流量包的PCAP认为是1类通信软件产生的。Client
Hello包长度大多为334的PCAP认为是`2`类通信软件产生的，同样的道理，330认为是`3`类软件产生的，571认为是`10`类软件产生的。
**Step5** ：对于 **私有协议加密** 的通信流量，首先计算PCAP中Bad
TCP包数量的占比，占比高于30%的PCAP，认为是`4`类通信软件产生的。剩下的流量归类到`5,7,9`的子类中。
**Step6** ：提取包中 **最大包长的分布**
。对于最大包长集中在1478以下的PCAP，认为是`5`类通信软件产生的，最大包长大多为1478的，是`7`类软件产生的，1514的，认为是`9`类软件产生的。
### 2\. 代理隧道识别总结
强特征的提取是代理软件识别任务的关键，在合适的推理算法下，可以克服训练样本不足的缺点，从而达到高识别率。我们分析了每一个类的强特征，把强特征应用于推理树，将多分类问题转化为更精准的多个二分类任务，获得了较好的分类效果。
### 3\. 隧道网页识别任务概述
加密代理识别的第二阶段，需要分类100个网站的代理流量，首先联想到的是网站指纹，其次是通过流级统计特征去做多分类。网站内容的业务资源的差异会带来传递载荷的区别，这个资源传输量可以构成网页访问的基本指纹，相似的数据量序列可以作为识别网页访问行为的基准。
其中，每一个网站给出的样本不算太多，因此如何从少量样本中学习到正确的特征分布是该分类任务的关键点。借鉴集成学习的思想，提出了一种数据增强的方法，迭代拓展数据集，不断提高模型的泛化能力。使用流统计特征作为流量的表征方法，进一步分析了统计特征的重要程度，并且使用更重要的特征作为流量数据的更优表征形式，进一步提高模型的准确率。
### 4\. 隧道网页流量表征
#### 4.1 表征方法的考虑
机器学习方法与输入特征的选择高度相关，此外，数据集的大小也影响模型的选择。例如，当数据集很小的时候，深度学习方法是不合适的。常用的输入特征和相应的训练模型如下：
##### 时间序列+报头
由于时间序列特性几乎不受加密的影响，因此被广泛应用于各种应用程序和数据集。前几个包(从10到30个包)足以在许多数据集中进行分类，经典的ML算法和MLP模型在表示输入维数的包数较小时表现得很好，对于数量较大的数据包，CNN和LSTM更准确。一般来说，深度模型的计算复杂度和训练时间都高于经典的机器学习算法。
##### Payload+报头
在当前加密流量中，包含握手信息的前几个数据包通常是未加密的，并且已经成功地用于分类。由于输入的高维性(负载中有大量字节)，传统的ML方法和MLP可能并不能很好地工作，但是通常CNN或LSTM却具有高精度。除了有效负载信息外，时间序列特性也有助于提高精度，但这几乎不会改变输入维度或模型的选择。
##### 统计特征
如数据包的包长、时间间隔等，利用统计特征作为输入的维度是有限的，大多使用经典的ML方法，在极少数情况下也使用MLP来实现。一般来说，根据数据集和统计特征的选择，利用前10到180个数据包的统计特征可能就足以进行分类。虽然统计特征可以让我们基于经典的机器学习算法构建一个更简单的分类器，但它可能不适合在线快速分类，因为它需要捕获足够多的数据包才能从流中获得可靠的统计特征。
综上，方案以通信流为基本单位，提取了PCAP中每一个流的统计特征，这些统计特征大致包含每个流的最大包长，最小包长，平均包长，包间隔时间等静态特征。初始的流量表征中一共为80维的静态特征。由于过于高维的表征形式会使得模型的泛化能力不足（高维稀疏特征会产生Outlier），因此需要分析每一维特征的重要系数，筛选重要的特征重组流表征向量，以获得更好的泛化能力。
#### 4.2 特征筛选
初版使用朴素的Random Forest与Decision
Tree进行预训练，得到初始模型，然后，计算每一维特征的重要系数。如图所示，随机森林和决策树得出的重要系数排名中，前20位具有很高的重合率，雷达图中也能很好地反映了这一点。将其交集的前20维特征独立出来，重构流的表征向量。
重要系数排名：  
重要系数分布雷达图：  
#### 4.3 基于集成学习的数据增强方法
为了解决数据样本不足的问题，我们使用集成学习的方法，迭代增强数据，并且预测数据的正确标签，在实际实施上，该方法取得了不错的分数。模型的大致方法如下，对于初始化的集成模型（集成模型由多个若分类器组成），我们进行迭代训练与预测，得到的每一个分类器的预测集合后，我们将具有共同预测标签的，具有较高置信度的测试样本（共性样本）加入到训练数据库中，增强训练样本后继续训练集成模型，最终达到预测所有待测样本的目标。
### 5\. 模型与增强训练
#### 5.1 初始化模型
在上一节中，我们选择了前20维作为每个流的表征向量。对于同一个PCAP中的每一个流，我们进一步筛选合法的流。我们认为，未完成握手的流为废弃流，在训练前应全部抛弃。这种做法可以排除无关变量对模型的污染。从初始的训练样本中提取的数据样本量较少，初始化的模型准确度不高，因此需要迭代训练。
#### 5.2 模型预测方法
对于一个PCAP文件，我们首先提取其长度合法的通信流，然后，提取每一个流的主要特征（20维主要特征）作为表征方式。集成模型中的每一个分类器分别对PCAP中的每一个流进行预测，得到PCAP中每一个流的标签。接着，模型通过投票机制，得到该PCAP预测最多的类别作为该PCAP的预测类别。
#### 5.3 数据增强
对于集成方法中的每一个分类器，我们得到了其预测集合。模型提取n个集合中的共性样本，作为高置信度的样本加入到原有的训练数据库中。增强的数据库作为新的训练用料，fine-tune现有的集成模型。
#### 5.4 迭代增强与训练
此时，得到增强训练用例后更新训练，使用增强的数据库fine-tune已有参数，使得模型具有更强的泛化能力。
### 6\. 隧道网页识别总结
克服该任务中训练数据量与测试类别量的不匹配问题是提高准确率的重要方法，本方案在给定的训练数据量上迭代增强训练样本，使模型获得更强的泛化能力，在我们多次提交的分数对比能看出，数据增强的集成迭代方法对分类准确率有显著提升（由0.762提升至0.845）。
## 总结
隐匿和检测是一个持续性的对抗过程。面对恶意通信高对抗性的隐蔽手段，攻击者伪装成正常通信，尽量模拟正常通信行为，检测与阻断就变得困难。
加密流量的检测，目前主流的方案仍然是提取数据包或流的统计特征，时序特征，来抽象表征不同种类的流量数据。这种侧信道的方法能有效地识别和分类不同种类的加密流量。
但实验室环境与在实际应用环境是有差距的，侧信道特征被证明在不同的网络环境中有着不同的特征分布，因此如何找到更稳定和可靠的流量行为表征方法，需要进一步研究。
## 参考文献
  1. [初探加密流量识别](https://www.secrss.com/articles/14298)
  2. [大海捞“帧”：Cobalt Strike服务器识别与staging beacon扫描](https://www.freebuf.com/articles/network/273480.html)
  3. [Redirecting Cobalt Strike DNS Beacons](https://medium.com/rvrsh3ll/redirecting-cobalt-strike-dns-beacons-e3dcdb5a8b9b)
  4. [浅谈OPSEC和C2](https://mp.weixin.qq.com/s/FIz4-xk093jGN3TOECAgqQ)
  5. [Vault 7: Projects](https://wikileaks.org/vault7/document/hive-Operating_Environment/)
  6. [吴桦，程光，一种识别QUIC协议加密传输的YouTube DASH视频的方法](https://cyber.seu.edu.cn/_s303/wh/list.psp)