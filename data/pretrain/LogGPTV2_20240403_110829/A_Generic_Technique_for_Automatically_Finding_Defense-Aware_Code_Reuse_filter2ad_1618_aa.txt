title:A Generic Technique for Automatically Finding Defense-Aware Code Reuse
Attacks
author:Edward J. Schwartz and
Cory F. Cohen and
Jeffrey S. Gennari and
Stephanie M. Schwartz
A Systematic Analysis of Defenses Against Code Reuse
Attacks
by
Kelly Casteel
Submitted to the Department of Electrical Engineering and Computer
Science
in partial fulﬁllment of the requirements for the degree of
Master of Engineering in Computer Science and Engineering
at the
MASSACHUSETTS INSTITUTE OF TECHNOLOGY
c(cid:13) Massachusetts Institute of Technology 2013. All rights reserved.
September 2013
Author . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
Department of Electrical Engineering and Computer Science
August 23, 2013
Certiﬁed by . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
Dr. Hamed Okhravi
Lincoln Laboratory Technical Staff
Thesis Supervisor
Certiﬁed by . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
Dr. Nickolai Zeldovich
Associate Professor
Thesis Supervisor
Accepted by. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
Albert R. Meyer
Chairman, Masters of Engineering Thesis Committee
2
A Systematic Analysis of Defenses Against Code Reuse Attacks
by
Kelly Casteel
Submitted to the Department of Electrical Engineering and Computer Science
on August 23, 2013, in partial fulﬁllment of the
requirements for the degree of
Master of Engineering in Computer Science and Engineering
Abstract
In this thesis, we developed a systematic model of the code reuse attack space where facts
about attacks and defenses were represented as propositional statements in boolean logic
and the possibility of deploying malware was a satisﬁability instance. We use the model
to analyze the space in two ways: we analyze the defense conﬁgurations of a real-world
system and we reason about hypothetical defense bypasses. We construct attacks based on
the hypothetical defense bypasses. Next, we investigate the control ﬂow graphs enforced
by proposed control ﬂow integrity (CFI) systems. We model the behavior of these systems
using a graph search. We also develop several code reuse payloads that work within the
control ﬂow graph enforced by one proposed CFI defense. Our ﬁndings illustrate that the
defenses we investigated are not effective in preventing real world attacks.
Thesis Supervisor: Dr. Hamed Okhravi
Title: Lincoln Laboratory Technical Staff
Thesis Supervisor: Dr. Nickolai Zeldovich
Title: Associate Professor
3
4
Acknowledgments
First of all, thanks to my advisors Hamed Okhravi and Nickolai Zeldovich for all of their
help and advice over the course of the past year.
Also, thanks to Richard Skowyra for the tremendous effort he put in to help with every
aspect of this thesis. I really could not have done this without his contributions.
Thanks as well to everyone in group 58 at Lincoln Lab and especially William Leonard,
Thomas Hobson, David Bigelow, Kathleen Silveri, Chrisantha Perera and William Streilein
for their invaluable advice, ideas and feedback.
Finally, thanks to my family and friends for their support, encouragement, and silliness.
This work is sponsored by the Assistant Secretary of Defense for Research & Engineer-
ing under Air Force Contract #FA8721-05-C-0002. Opinions, interpretations, conclusions
and recommendations are those of the author and are not necessarily endorsed by the United
States Government.
5
6
Contents
1 Introduction
2 Code Reuse Attack Background
3 Existing Defenses
4 Systematic Analysis
4.1 Attack Space Model . . .
.
.
.
.
.
.
.
4.1.1 Model Deﬁnition and Scope .
4.2 Attacker Assumptions . . .
.
.
4.3 Defensive Scenario Analysis .
4.4 Defense Bypasses . . . .
.
.
4.4.1
Pure ROP Payloads .
4.4.2 Return-into-LibN .
.
.
.
.
.
.
.
.
.
4.4.3 Turing Complete LibN .
4.5 Discussion . . . . . . . . .
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
. .
5 Control Flow Integrity Enforcement
.
5.1 Existing CFI Systems . .
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
5.1.1 Compact Control Flow Integrity and Randomization .
5.1.2 Control Flow Integrity .
5.2 Control Flow Graph Model .
5.3
Interactive Search . . . .
.
.
.
.
.
.
5.3.1 Data Dependent Edges .
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
7
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
11
15
19
23
. 24
. 25
.
.
.
.
. .
. 29
.
.
.
.
.
.
.
.
.