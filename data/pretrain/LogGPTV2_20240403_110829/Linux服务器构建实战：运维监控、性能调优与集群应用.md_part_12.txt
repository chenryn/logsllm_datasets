"http://.*yahoo
"http://.*google\.com
.cn"e
---
## Page 83
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
Server: Apache/2.2.14 (Unix) PHP/5.3.1 mod_per1/2.0.4 Per1/v5.10.1
HTTP/1.1200 OK
-H Accept-Encoding:gzip,defalte -I
然后用curl命令请求压缩的内容。
X-Cache: HIT from ixdba.net
ia: 1.1 varnish
X-Varnish:1515651004 1515651001
Date:Fri,
Vary: Accept-Encoding,User-Agent
ast-Modified:Mon,28 Jul 2008 00:48:20 GMT
Server:Apache/2.2.14(Unix) PHP/5.3.1 mod_per1/2.0.4 Per1/v5.10.1
HTTP/1.1 200 OK
[rootavarnish-server ~]#curl -Ihttp://www.ixdba.com/article/3e/1557.html
首先用curl命令请求未压缩的内容。
下面通过一个实例测试来验证压缩的效果。
这样就完成了Varnish的压缩配置，将需要压缩的内容都交给了后端服务器去处理。
sub vcl_hash {
然后修改“vcl_hash”函数为如下配置：
ntent-Type:text/html
Tag:"7102d5-819f-4530ae1357d00*
return (hash);
else if （reg.http.Accept-Bncoding ~"deflate"){
www.Linuxidc.com
16 Ju1 2010 06:34:35 GMT
}else if (req.http.Accept-Encoding ~
}else if (req.http.Accept-Encoding -"gzip"){
cemove
# No point in compressing these
else
set reg.hash +=
set req.hash +="gzip";
remove req.http.Accept-Encoding;
"deflate";
第2章
"deflate"){
PDG
---
## Page 84
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
力求使读者迅速掌握Varnish的使用。
来替换Squid，这些都促使Varnish迅速发展起来。本章通过理论与实践经验相结合的方法：
有性能更高、速度更快、管理方便等诸多优点，很多大型的运营网站都开始尝试用Varnish
识，并且能够熟练安装、搭建和配置一套Varnish系统。
Varnish的常见应用。通过本章的学习，读者可以对Varnish的结构和特点有一个清晰的认
还介绍了Varmish常用的指令以及Varnish的调优技巧和经验，最后通过两个实例介绍了
2.8本章小结
64
Varmish是一个开源的反向代理软件和HTTP加速器，与传统的Squid相比，Varnish具
本章主要介绍了高性能HTTP加速器Varnish的安装、配置、管理和使用技巧，同时
通过前后两个输出结果可以清楚地看到，压缩已经生效，说明配置成功。
X-Cache: HIT from ixdba.net
Connection:keep-alive
Via:1.1 varnish
Age:5
X-Varnish: 1515651003 1515651002
Date:
Content-Length:8538
Content-Type:text/html
Content-Encoding:gzip
Vary:Accept-Encoding,User-Agent
ETag:"748b19-8197-48b7acd54cb80"
www.Linuxidc.com
16
君
PDG
---
## Page 85
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
保证Memcache中的数据和数据库中的数据一致。
回给客户端，同时把数据缓存一份到Memcache中。
回，不再对数据进行任何操作。
图3-1展示了Memcache和数据库协作的流程。
或数据，来减轻数据库的压力，提高网站的响应速度，构建速度更快的可扩展的Web应用，
像一张大的HASH表，以key-value对的方式存在。Memcache通过缓存经常被存取的对象
常存取的对象或数据缓存在内存中，内存中缓存的这些数据通过API的方式被存取，数据就
起来），通过缓存来存取对象或数据要比磁盘存取快很多。Memcache是一种内存缓存，把经
的响应速度。Memcache是这个项目的名称，而Memcached是服务器端的主程序文件名。
发完成。目前全世界很多用户都在使用它来构建自己的大负载网站或提高自己的高访问网站
轻数据库负载加速动态Web应用。最初版本由LiveJournal的BradFitzpatrick在2003年开
3.1.1什么是Memcached
3.1
的事情。
Memcached有一个全面的了解，使构建一套属于自己的分布式内存对象缓存系统变成很简单
外，Memcached也经常作为服务器之间数据共享的存储媒介。学习完本章，相信读者能够对
作等开销，而且使用内存来管理数据，所以它可以提供比直接读取数据库更好的性能。另
在很多时候都作为数据库的前端cache使用，因为它比数据库少了很多SQL解析、磁盘操
内存对象缓存系统，用于在动态系统中减少数据库负载，进而提升系统性能。Memcached
3）每次更新数据库（如更新、删除数据库的数据）的同时更新Memcache中的数据，
2）如果请求的数据不在Memcache中，就去查询数据库，把从数据库中获取的数据返
1）检查客户端请求的数据是否在Memcache中存在，如果存在，直接把请求的数据返
这个流程的具体逻辑如下：
缓存一般用来保存一些经常存取的对象或数据（例如，浏览器会把经常访问的网页缓存
Memcached是一个免费开源的、高性能的、具有分布式内存对象的缓存系统，它通过减
本章主要介绍Memcached的特征、运行原理和使用经验。Memcached是一套分布式
Memcached基础
www.Linuxidc.com
第3章
Memcached应用实战
---
## Page 86
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
有兴趣的读者可以查看相关文档。
加也能发挥很好的性能。Memcached利用这个库进行异步事件处理。关于这个库的详细内容，
kqueue、Linux系统的epoll等事件处理功能封装成一个接口，确保即使服务器端的连接数增
Memcached服务器上存取数据。
3.1.2Memcached的特征
使用）策略加到期失效策略，失效的数据首先被替换掉，然后再替换掉最近未使用的数据。
66
了解libevent的用户都知道，libevent是一套利用C开发的程序库，它将BSD系统的
2.基于libevent的事件处理
Memcached的协议实现比较简单，使用的是基于文本行的协议，能直接通过telnet在
1.协议简单
下面分别进行简单介绍。
口互不通信的Memcached之间具有分布特征。
口内置的内存管理方式。
口基于libevent的事件处理
口协议简单。
Memcached作为高性能的缓存服务器，具有如下特征：
4）当分配给Memcache内存空间用完之后，会使用LRU（LeastRecentlyUsed，最近最少
www.Linuxidc .com
客户端
图3-1Memcache和数据库协作工作流程
更新至最新值
lem
请求数据返同
影
服务器
Memcache
如果没有找到，
库服务器
---
## Page 87
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
Linux、FreeBSD、Solaris、Mac OS X。
3.1.3Memcached的安装
过对客户端的设计，让Memcached具有分布式，能支持海量缓存和大规模应用。
题，和机器的内存一样，重启机器数据将会丢失。
存，即重用过期数据的内存空间。Memcached是为缓存系统设计的，没有考虑数据的容灾问
Memcached内置的内存中，当存人的数据占满空间时，使用LRU算法自动删除不使用的缓
2010-09-29 23:18:03 (105 KB/s)
[root@web181-]#tai1-5wget-1og|sed/~s/d
Continuing in background, pid 8659.
安装Memcached的过程如下：
2.安装Memcached
CentOS系统也可以通过yum直接安装libevent，不过所安装的版本可能比较低。
[root@web181 -]# wget -b http://www.monkey.org/-provos/1ibevent-1.4.13-stable.
安装Memcached前需要先安装libevent，首先用wget下载libevent。
1.安装libevent
也可以将Memcached安装在Windows系统上。这里以CentOS为例进行说明。
Memcached的安装比较简单，这里稍加说明。很多平台支持Memcached，常见的有：
各个Memcached 服务器之间互相不通信，都是独立的存取数据，不共享任何信息。通
[root@web181~]#wget -b http://memcached.googlecode,com/files/memcached-1.4.5.tar.gz
下面开始安装。
Outputwillbe written to~wget-log'
4.互不通信的Memcached之间具有分布特征
Memcached有一套自己管理内存的方式，这套管理方式非常高效，所有的数据都保存在
[root@web181 1ibevent-1.4.13-stable]# make && make
[root@web181 1ibevent-1.4.13-stable]#./configure
[root@web181-]#tail-5wget-1og|sed/~s/d
3.内置的内存管理方式
[499603/499603]
tar.gz
www.Linuxidc.com
(58.6KB/s)
“1ibevent-1.4.13-stable.tar.gz'
100$139K=8.3s#说明下载完成
第3章
install
Memcached应用实战67
100g145K=2.8s
saved
DG
---
## Page 88
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
中很多选项能改变Memcached的各种行为，推荐读者阅读相关资料。
过程如下：
68
settest0010
Escape character is ]
Connected to 1ocalhost.1ocaldomain (127.0.0.1).
>/etc/1d.so.conf
找不到libevent-1.4.so.2文件的解决的办法是，把/usr/local/lib加人到/etc/ld.so.conf中，
/usr/local/bin/memcached:error while 1cading shared 1ibraries: 1ibevent-1.4.so.2:
[root@web181-]#/usr/local/bin/memcached -m 32m-p 11211 -d -u root -P /var/run/
这里需要说明的是，启动时可能出现如下错误：
/x/d- 2ox -p- d-w -pqa/ua/o/xs/#[~etqneoox]
Memcached启动的过程如下：
3.启动Memcached
安装完成后，Memcached的默认目录为/usr/local/bin/memcached。
[root@web181 memcached-1.4.5]# make && make install
[root@web181memcached-1.4.5]#
[root@web181 ~]# tar zxf memcached-1.4.5.tar.gz
-u，运行Memcached的用户，默认不能由root用户启动，所以当前用户为root用户
-1，监听的服务器IP地址，如果有多个地址。
-P，设置保存Memcache的pid文件。
-C，最大运行的并发连接数，默认是1024，按照服务器的负载量来设定。
-d，作为守护进程在后台运行。
cannot open shared object file: No such file or directory
memcached.pid
memcached.pid -c 256
www.Linuxidc.com
-C256
#向test中存入数据
./configure
G
---
## Page 89
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
4）修改php.ini文件，把php.ini中的extension_dir=”/”修改为extension_dir=“/usr/
/usr/1ocal/php-cgi/1ib/php/extensions/no-debug-zts-20060613/
Installing shared extensions:
3）完成上述安装后会有类似以下的提示：
[root@web181 memcache-2.2.5]#make &&make instal1
Configuring for:
[root@web181 memcache-2.2.5]#/usr/local/php/bin/phpize
root8web181
[root@web181~]# tai1 -5 wget-1og|sed/~$/d
[root@web181 ~]#wget -b http://pecl.php.net/get/memcache-2.2.5.tgz
2）这里以memcache-2.2.5版本为例来安装Memcache的PHP扩展。安装代码如下：
1）在http:/pecl.php.net/package/memcache中选择想要下载的Memcache版本。
6.安装Memcache的PHP扩展
[root@web181~]#kil1~cat/var/run/memcached.pid
关闭Memcached的命令如下：
5.关闭Memcached
-enable-memcache\
root@web181memcache-2.2.5]#./configure\
end Extension Api No:
HP Api Version
Connection closed by foreign host.
30quit
END
test_value
VALUE test 0 10
30END
add(Skey,$value,
compress_threshold => 100
use Cache::Memcached;
#1/usr/bin/perl
通过Cache:Memcached连接Memcached的示例代码如下：
前面已经提到过，许多语言都实现了Memcached的客户端，目前应用最多的是通过
echo
val
$mem->connect(
mem
?php
运行下面的PHP代码，如果输出“Hello world!"，就表示环境搭建成功。
7.测试Memcache的PHP扩展是否安装成功
extension=memcache.so
5）添加如下一行代码来载入Memcache扩展：
$expires
Svalue-"HelloWorld!";
Skey="test";
Memcached的简单使用过程
$val;
Www.Linuxidc.com
=120;
= Cache::Memcached->new（{
‘127.0.0.1”
11211);
%
$expires);
，0,12]；
---
## Page 91