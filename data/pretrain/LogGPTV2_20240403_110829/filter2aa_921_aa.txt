MEMORY FORENSICS
识“黑”寻踪 之 内存取证
演讲人：伍智波 （SkyMine）
                  中国网安 · 广州三零卫士 - 安全专家
2 0 1 8
目录
CONTENTS
PART 01
内存取证的起源与发展
01
PART 02
内存管理机制简述
02
PART 03
如何获取内存数据
03
PART 04
内存分析的工具
04
PART 05
犯罪取证案例分析
05
KEYWORD : 应急响应、数字取证、行为溯源
THE ORIGIN AND DEVELOPMENT OF MEMORY FORENSICS
PART 
01
内存取证的起源与发展
2002年
2005年
2006年
2007年
2009年
2010年
2011年
         美国空军特别调查办公室的安全研究员于2002年发表
的DFRWS主题报告中曾经提到，为了处理网络应急响应所
面临的问题，需要调查易失性内存（RAM）的信息，以全
面而准确地获取网络攻击和网络犯罪证据。这是内存取证概
念首次被提出。
         DFRWS数字取证研究会于2005年夏季发起针对
Windows操作系统的内存取证分析挑战赛，通过分析一个
Windows 2000的物理内存转储文件，要求参赛者提取该文件
中所包含的隐匿进程及其隐匿方式、网络攻击者如何攻击以及
何时、何处发起攻击等相关攻击链信息。这是真正意义上的内
存取证研究的开始。
USA 2005
2002年
2005年
2006年
2007年
2009年
2010年
2011年
         安全研究员Andreas Schustert于2006年提出了在
Windows内存镜像文件中寻找进程和线程的方法，并使用Perl
语言开发了PTFinder，该工具可以找到Windows内存文件的
进程和线程信息。
PTFinder
Andreas Schustert
2002年
2005年
2006年
2007年
2009年
2010年
2011年
         纽约大学计算机科学与工程系助理教授Brendan Dolan-
Gavitt于2008年通过分析Windows的内存获取了注册表信息，
并通过提取注册表信息来判断系统是否受到了攻击。同年，
DFRWS继2005年的Windows内存取证分析挑战赛后又发起了
针对Linux系统的内存取证分析挑战赛。
2002年
2005年
2006年
2007年
2009年
2010年
2011年
         2009年，加拿大计算机安全研究员Seyed Mahmood 
Hejazi在DFRWS上提出了从Windows内存中提取敏感信息的
方法，同年，Zhang Shuhui等人提出了一种Kernel 
Processor Control Region（KPCR）结构的提取方法，学界
对内存取证的研究开始初有成果。
2002年
2005年
2006年
2007年
2009年
2010年
2011年
DESCRIPTION OF THE MEMORY MANAGEMENT MECHANISM
PART 
02
内存管理机制的简述
① 虚拟地址空间管理机制
② 物理页面管理机制
③ 地址转译和页面交换机制
Windows三大内存管理机制
         Windows为满足多进程工作的需要，采用虚拟地址空间
的机制来进行内存管理，每个进程拥有逻辑独立的内存空间，
各进程地址空间相互隔离，互不干扰。
         而这些虚拟地址空间是由VAD（Virtual Address Descriptor，
虚拟地址描述符）来管理的，VAD对象描述的是一些连续的
地址空间范围，但由于在整个内存地址空间当中，保留或提
交的地址范围可能是不连续的，所以，Windows会使用AVL树
的方式来管理VAD对象，形成VAD树。
         因此，借助VAD，不仅能获取进程所使用的虚拟地址空
间信息，还可以获取到该进程的其他相关信息。
① 虚拟地址空间管理机制
② 物理页面管理机制
③ 地址转译和页面交换机制
Windows三大内存管理机制
         由于Windows的进程都是在物理内存中执行的，因此
Windows需要管理物理地址所在的物理内存页面，Windows系
统使用PFN（Page Frame Number Database，页帧数据库）来
描述物理内存各页面的状态，PFN数据库中的每个项都分别
对应一个物理页面，记录了该页面的一些信息。
         此外，Windows还维护着一组链表，分别将相同类型的
的页面链接起来，主要包括零化链表、空闲链表、备用链表、
修改链表、坏页面链表等。
① 虚拟地址空间管理机制
② 物理页面管理机制
③ 地址转译和页面交换机制
Windows三大内存管理机制
         Windows的的地址转译机制，可将进程中所使用的虚拟
地址转换为物理内存中的物理地址，从而完成内存数据的定
位，为获取内存数据提取支持。
         当运行的进程所需的内存大于计算机所安装的RAM时，
Windows将会采用页面交互机制来处理，要么进程使用了某
个尚未得到物理页面的虚拟地址，要么进程工作集限制其不
能拥有更多物理页面。
         事实上，页面交换文件是物理内存的一种延伸，所以，
完整的内存数据应当包含物理内存数据和页面交换文件数据。
HOW TO GET MEMORY DATA
PART 
03
如何获取内存数据
内存获取方法
①基于用户模式程序的内存获取(User level applications)
②基于内核模式程序的内存获取(Kernel level applications)
③基于系统崩溃转储的内存获取(Crash dump technique)
④基于操作系统注入的内存获取(Operating system injection)
⑤基于系统休眠文件的内存获取(Hibernation file based technique)
⑥基于系统冷启动的内存获取(Cold booting)
⑦基于虚拟化快照的内存获取(Virtualization)
⑧基于硬件的内存获取(DMA by Hardware)