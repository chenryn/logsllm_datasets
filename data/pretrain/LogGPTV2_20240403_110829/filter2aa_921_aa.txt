# 内存取证
## 识“黑”寻踪：内存取证
### 演讲人：伍智波（SkyMine）
#### 中国网安 · 广州三零卫士 - 安全专家
#### 2018年

## 目录
- **PART 01** 内存取证的起源与发展
- **PART 02** 内存管理机制简述
- **PART 03** 如何获取内存数据
- **PART 04** 内存分析工具
- **PART 05** 犯罪取证案例分析
- **关键词**：应急响应、数字取证、行为溯源

## PART 01: 内存取证的起源与发展
### 2002年
美国空军特别调查办公室的安全研究员在DFRWS主题报告中首次提出，为了处理网络应急响应所面临的问题，需要调查易失性内存（RAM）的信息，以全面而准确地获取网络攻击和网络犯罪证据。这是内存取证概念的首次提出。

### 2005年
DFRWS数字取证研究会发起针对Windows操作系统的内存取证分析挑战赛。参赛者需通过分析一个Windows 2000的物理内存转储文件，提取隐匿进程及其隐匿方式、网络攻击者如何攻击以及何时、何处发起攻击等相关信息。这标志着内存取证研究的正式开始。

### 2006年
安全研究员Andreas Schuster提出了在Windows内存镜像文件中寻找进程和线程的方法，并使用Perl语言开发了PTFinder工具，该工具可以提取Windows内存文件中的进程和线程信息。

### 2007年
纽约大学计算机科学与工程系助理教授Brendan Dolan-Gavitt通过分析Windows内存获取注册表信息，并利用这些信息判断系统是否受到攻击。同年，DFRWS发起了针对Linux系统的内存取证分析挑战赛。

### 2009年
加拿大计算机安全研究员Seyed Mahmood Hejazi在DFRWS上提出了从Windows内存中提取敏感信息的方法。Zhang Shuhui等人也提出了一种Kernel Processor Control Region（KPCR）结构的提取方法，标志着学界对内存取证的研究初见成效。

## PART 02: 内存管理机制简述
### Windows三大内存管理机制
1. **虚拟地址空间管理机制**
   - Windows采用虚拟地址空间来满足多进程工作的需求。每个进程拥有逻辑独立的内存空间，各进程地址空间相互隔离。
   - 虚拟地址空间由VAD（Virtual Address Descriptor）管理，VAD对象描述连续的地址空间范围。由于整个内存地址空间中的保留或提交的地址范围可能是不连续的，Windows使用AVL树来管理VAD对象，形成VAD树。
   - 借助VAD，不仅可以获取进程使用的虚拟地址空间信息，还可以获取该进程的其他相关信息。

2. **物理页面管理机制**
   - Windows使用PFN（Page Frame Number Database）来描述物理内存各页面的状态。PFN数据库中的每个项对应一个物理页面，记录了该页面的一些信息。
   - Windows还维护着一组链表，将相同类型的页面链接起来，主要包括零化链表、空闲链表、备用链表、修改链表和坏页面链表等。

3. **地址转译和页面交换机制**
   - 地址转译机制将进程中使用的虚拟地址转换为物理内存中的物理地址，从而完成内存数据的定位。
   - 当运行的进程所需的内存大于计算机安装的RAM时，Windows采用页面交换机制处理。页面交换文件是物理内存的一种延伸，因此完整的内存数据应包含物理内存数据和页面交换文件数据。

## PART 03: 如何获取内存数据
### 内存获取方法
1. **基于用户模式程序的内存获取 (User Level Applications)**
2. **基于内核模式程序的内存获取 (Kernel Level Applications)**
3. **基于系统崩溃转储的内存获取 (Crash Dump Technique)**
4. **基于操作系统注入的内存获取 (Operating System Injection)**
5. **基于系统休眠文件的内存获取 (Hibernation File Based Technique)**
6. **基于系统冷启动的内存获取 (Cold Booting)**
7. **基于虚拟化快照的内存获取 (Virtualization)**
8. **基于硬件的内存获取 (DMA by Hardware)**

以上是对内存取证的起源与发展、内存管理机制以及如何获取内存数据的概述。接下来的部分将继续探讨内存分析工具及犯罪取证案例分析。