Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Passive DNS Hardening
Robert Edmonds
Internet Systems Consortium, Inc.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
Structure of this talk
▶ Introduction
▶ DNS
▶ Passive DNS
▶ ISC SIE
▶ DNS security issues
▶ Kashpureﬀ poisoning
▶ Kaminsky poisoning
▶ Passive DNS security issues
▶ Record injection
▶ Response spooﬁng
▶ ISC DNSDB
▶ Architecture
▶ Demos
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
The Domain Name System
▶ “The DNS maps hostnames to IP addresses.”
▶ More generally, it maps (key, type) tuples to a set of
unordered values. again, we can think of the DNS as basically
a multi-value distributed key-value store.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
Clients, caches, content
▶ Clients request full resolution service from caches.
▶ Caches make zero or more inquiries to DNS content servers
on behalf of clients. Results are cached for a limited time to
serve future client requests.
▶ Content nameservers serve DNS records for zones that have
been delegated to them.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
DNS Caching Resolvers 
gtisc.gatech.edu 
Facebook.com 
Google.com 
amazon.com 
.org 
.isc.org 
.com 
.net 
Dozens 
Millions 
Millions 
Clients 
Content 
Query 
Response 
Query 
Response 
Query 
Response 
Query 
Response 
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
Client-server and inter-server DNS protocols
▶ The DNS is actually two diﬀerent protocols that share a
common wire format.
▶ The client-to-server protocol spoken between clients and
caches.
▶ The inter-server protocol spoken between caches and content
servers.
▶ Passive DNS focuses on the latter.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
Passive DNS
▶ Passive DNS replication is a technology invented in 2004 by
Florian Weimer.
▶ Many uses! Malware, e-crime, legitimate Internet services all
use the DNS.
▶ Inter-server DNS messages are captured by sensors and
forwarded to a collection point for analysis.
▶ After being processed, individual DNS records are stored in a
database.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
DNS Caching Resolvers 
gtisc.gatech.edu 
Facebook.com 
Google.com 
amazon.com 
.org 
.sc.org 
.com 
.net 
Content 
Query 
Response 
DNSDB 
Security 
Information 
Exchange 
Passive DNS 
Sensor 
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
Passive DNS deployments
▶ Florian Weimer’s original dnslogger, ﬁrst at RUS-CERT,
then at BFK.de (2004–).
▶ Bojan Zdrnja’s dnsparse (2006–).
▶ ISC’s Security Information Exchange (2007–).
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
DNS
Passive DNS
ISC SIE
ISC Security Information Exchange
▶ SIE is a distribution network for diﬀerent types of security
data.
▶ One of those types of data is passive DNS.
▶ Sensor operators upload batches of data to SIE.
▶ Data is broadcast onto private VLANs.
▶ NMSG format is used to encapsulate data.
▶ Has a number of features which make it very useful for storing
passive DNS data, but won’t be covered further.
▶ See our Google Tech Talk for more information:
http://www.isc.org/community/presentations/video.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
DNS Security Issues
▶ Passive DNS captures both signed and unsigned data, so
DNSSEC cannot help us.
▶ What security issues are there in the DNS that are relevant to
passive DNS?
▶ Kashpureﬀ poisoning
▶ Kaminsky poisoning
▶ (Actually, just response spooﬁng in general.)
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Kashpureﬀ poisoning
▶ Kashpureﬀ poisoning is the name given to a particular type of
DNS cache poisoning.
▶ The attacker runs a content nameserver.
▶ A client is enticed to lookup a domain name under the
attacker’s control.
▶ The cache contacts the attacker’s nameserver.
▶ The attacker’s nameserver provides extra records to the cache.
▶ The extra records are inserted into the cache instead of being
discarded.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Kashpureﬀ poisoning example
Q: malicious.example.com.
IN A
?
R: malicious.example.com.
IN NS
www.example.net.
R: www.example.net.
IN A
203.0.113.67
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Kashpureﬀ poisoning example
Q: malicious.example.com.
IN A
?
R: malicious.example.com.
IN NS
www.example.net.
R: www.example.net.
IN A
203.0.113.67
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Kashpureﬀ poisoning example
Q: malicious.example.com.
IN A
?
R: malicious.example.com.
IN NS
www.example.net.
R: www.example.net.
IN A
203.0.113.67
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Kashpureﬀ hardening
▶ 1997: Eugene Kashpureﬀ hijacks the InterNIC website.
▶ BIND 4.9.6 and 8.1.1 introduce hardening against
Kashpureﬀ poisoning.
▶ RFC 2181 is published.
▶ See §5.4.1 “Ranking data” for details.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Lack of entropy
▶ 2000: DJB observes that a maximum of only about 31-32 bits
of entropy can protect a UDP DNS query.
▶ Other DNS implementations slow to adopt SPR.
▶ 32 bits of entropy particularly weak for a session ID due to the
birthday attack problem.
▶ Newer protocols use cryptographically secure session IDs with
64, 128, or more bits.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Kashpureﬀ poisoning
Kaminsky poisoning
Kaminsky poisoning
▶ 2008: Dan Kaminsky notices that the TTL can be bypassed.
▶ Coordinated, multi-vendor patches are released to implement
source port randomization.
▶ SPR makes Kaminsky attacks harder, but not impossible.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Relevance
Capture stage
Analysis stage
Relevance to passive DNS
▶ Weimer’s 2005 paper notes several problems with verifying
passive DNS data.
▶ Kashpureﬀ and Kaminsky poisoning of “active DNS” have
analogues in passive DNS.
▶ Passive DNS sensors can’t see the DNS cache’s “bailiwick”,
leading to record injection.
▶ Spoofed responses are treated just like normal responses.
▶ A single spoofed response can poison the passive DNS
database!
▶ Goal: make passive DNS at least as reliable as active
DNS.
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Relevance
Capture stage
Analysis stage
Protecting the capture stage against response spooﬁng
▶ Capture both queries and responses.
▶ Correlate responses with previously seen queries.
▶ The DNS message 9-tuple:
1. Initiator IP address
2. Initiator port
3. Target IP address
4. Target port
5. Internet protocol
6. DNS ID
7. Query name
8. Query type
9. Query class
Robert Edmonds
Passive DNS Hardening
Introduction
DNS Security Issues
Passive DNS hardening
DNSDB
Relevance
Capture stage
Analysis stage
nmsg/dnsqr