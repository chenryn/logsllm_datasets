== 索引管理
针对不同种类日志，其数据量大小、安保留存等级各不一致的情况，日志易提供索引管理功能，用户可以预先定义几个有效留存时间和切分时间各不相同的索引，然后将不同种类的日志，依据一定的路由规则，导入到不同的索引中。
对于长期留存，但未必经常查询的数据，日志易支持设置索引数据的热、温、冷阶段生命周期。温和冷阶段的索引数据依然可读(根据存储介质不同可能响应速度更慢)，但不再可写。通常可以根据自身硬件情况和业务逻辑，设置温阶段为 3-7 天后，冷阶段为 1-3 个月后。
对于暂时无法预估数据接入规模，但日志易集群规模已确定的情况，日志易支持设置索引的留存大小。索引大小超标时，即使还没有超过有效时间，也会强制启动数据淘汰删除机制，以确保磁盘空间可用。该配置请慎用。
在'数据流'菜单上点击'索引配置'，进入索引管理界面，可以对索引进行查看，新建，编辑，删除，禁用操作。
为了更好的展示当前留存的数据状态，列表上采用柱状图展示留存数据的周期时长、大小等数据。
image::images/index-list.png[]
[NOTE]
====
索引创建完毕以后，再次编辑修改时，无法改动索引名称。
====
=== 默认索引
yotta索引是日志易提供的默认索引，未匹配路由规则的数据，都会进入日志易默认的 yotta 索引。若SPL语句的起始位置未明确使用index=xxx，则默认查询的数据是yotta索引数据。如果要修改默认搜索时指向的索引，请调整用户角色授权中的默认索引配置。
yotta索引的默认配置是
* 索引模式：压缩模式
* 保存时间：3660天
* 切分时间：1天
* 保存大小：无限制
* 字段配置：无
默认索引不能禁用，不能删除，只能编辑。用户可以按需修改yotta索引的保存时间、切分时间、保存大小、冷热定义、字段配置等设置项。
image::images/index-yotta.png[]
=== 自定义索引
除了默认yotta索引，日志易还支持自定义索引，您可以在索引配置中新建索引。自定义索引和默认索引在索引配置、权限分配上完全一致。
自定义索引名称应为小写字母开头，小写字母及下划线组成的长度小于32位的字符串。不能使用内置索引名：yotta, schedule, monitor, machinelearning_showcase, rzy_internal, rzy_tmp，cruxee，kpi_monitor，kpi_tmp，siem_threat，siem_intelligence，_log_anomaly，_o11y_metrics，_o11y_trace，_o11y_topology。
==== 索引模式
在配置索引属性时，可以先根据数据场景需求选择压缩或数值场景的快捷模式：
* 压缩模式：压缩模式下，自动开启正排优化和正排压缩功能。日志易默认采用压缩模式。
* 数值模式：数值模式下，自动开启正排优化和丢弃部分内置字段功能。日志易默认对智能运维和观察易的索引采用数值模式。
* 自定义模式：由管理员自行定义索引配置的每个配置参数。
模式选择完毕后，即进入详细配置步骤，包括生命周期、字段配置、压缩配置等。
==== 索引生命周期
索引根据数据使用频率、生成时间的不同，可以划分为：热数据、温数据、冷数据、删除数据阶段。热数据阶段即数据正在入库、频繁被使用的阶段。删除数据阶段即数据已经不再被需要的阶段，如果永久留存的数据，也可以不开启删除阶段。
===== 热数据阶段
image::images/index-hot.png[]
热数据阶段对 CPU、IO 的要求都比较高，通常建议采用 SSD 磁盘。此外，合理的索引分片和副本设置也可以提供良好的分布式特性。热数据阶段的可用配置包括：
* 切分时间：小时、天、月、年。默认为 1 天。
* 副本数量：1 份、2 份、3份。单机环境下只能为 1 份。
* 分片数量：默认采用全局的 `default_shared_size` 配置，当数据量较大时，可按需增大。
* 异常时段数据处理策略：异常时段数据指的是，该数据入库时，时间戳距离当前时间点偏差超过设定阈值范围的情况。比如， 7 天前的老数据，或 1 天后的未来数据。异常时段数据大量导入可能会对集群的稳定性造成影响。因此，需要定义对异常时段数据的独立处理策略，可以丢弃这些数据，或单独采用 `.oor` 索引，以入库时间，而非日志原始时间来存储数据。
* 机器标签：如果集群内有不同批次的异构服务器，可以通过 bcli 给不同服务器定义标签，然后按标签分配数据。比如：客户有 3 台 SSD 机器，10 台 SATA 机器，可以分别定义 3 台 hot 和 10 台 cold。然后为热数据阶段定义机器标签为 hot。则数据入库时只会导入 3 台 SSD 机器。
注意：对应机器标签需要先通过 `bcli config node_tag` 命令行在后台配置。配置举例：`{"hot": ["192.168.1.18"],"cold": ["192.168.1.19"]}`。
===== 温数据阶段
image::images/index-warm.png[]
如果可以明确日志在若干天后不可能会有延迟写入和频繁读取，我们可以开启温数据阶段。对于温数据，系统可以按配置进行数据迁移、数据下沉、数据删减等不同操作，达到存储成本的有效控制。温数据阶段的可用配置包括：温阶段时间、机器标签。
数据下沉和机器标签的迁移有所区别。数据下沉方案中，集群内应使用同构服务器，同一台服务器上配备有部分 SSD 和部分 SATA。则热数据进入温数据阶段后，数据可以直接在本机从 kSSD 路径转移到 kHDD 路径上。和机器标签迁移方案相比，减少了网络流量交互，更加高效。
数据下沉方案除温阶段时间触发以外，还会因为磁盘空间百分比触发。磁盘空间触发条件在 Manager 中通过 `storage.sink_ratio0/1/2` 设置，不受具体索引配置影响。
注意：数据下沉方案对应的kSSD, kHDD, kNAS 路径需要先在日志易 Manager 中配置 `beaver_datanode` 模块的 `storage.path0/1/2` 参数。
===== 冷数据阶段
image::images/index-cold.png[]
如果客户明确日志在若干天后已经极少读取，仅用于偶尔审计场景，我们可以进一步开启冷数据阶段。数据下沉方案中，冷数据阶段对应 kNAS 路径。
冷阶段比温阶段新增配置：丢弃其他副本。一般而言，冷阶段数据会单独放在 NAS、HDFS、S3 等集中存储上，这些存储自身已经提供数据高可用机制，因此，索引无须通过多副本方式来提供冗余的数据高可用。
===== 删除数据阶段
image::images/index-delete.png[]
如果可以明确日志只需要保留多长时间，可以开启删除数据阶段。删除数据阶段的配置包括：
* 删除阶段时间：多久后可删除
* 索引保存大小：Byte、KB、MB、GB、TB、PB。当集群内索引总大小超过阈值后，开始删除老数据，保护磁盘空间。
填写删除时间和保存大小后，可以点击计划预览，查看在该配置项下，预计索引数据将保存多久。注意：保存大小阈值的线性估算取决于当前已保存的数据，仅在编辑时可见。