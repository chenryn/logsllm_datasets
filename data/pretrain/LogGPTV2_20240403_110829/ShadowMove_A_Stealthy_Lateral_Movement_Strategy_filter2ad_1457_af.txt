[5] List of ftp commands. https://en.wikipedia.org /wik-
i/List_of_FTP_commands, 2018. Accessed February
2019.
[6] Video Clip for the FTPShadowMove. http://54.36.162.
222/ShadowMoveDemo/FTPShadowMove.gif, 2018.
[7] A Comprehensive Open Source Security Platform.
https://wazuh.com/product/, 2019. Accessed October
2019.
[8] Install
npm
sudo
packages
with-
Linux.
out
https://github.com/sindresorhus/guides/blob/master/npm-
global-without-sudo.md, 2019.
Accessed October
2019.
globally
and
macOS
on
[9] OpenSSH/Cookbook/Multiplexing.
https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multi
plexing, 2019. Accessed October 2019.
[10] OSSEC:
The World’s Most Widely Used
Host-based
System.
https://github.com/ossec/ossec-hids, 2019. Accessed
October 2019.
Detection
Intrusion
[18] Adam Blaszczyk. Can we stop detecting mimikatz
please? http://www.hexacorn.com/blog/2019/02/03/can-
we-stop-detecting-mimikatz-please/, 2019. Accessed
Feb 2019.
[19] Adam Boileau. Trust Transience: Post Intrusion SSH
Hijacking. In BlackHat Brieﬁngs, August 2005.
[20] Thanh Bui, Siddharth Prakash Rao, Markku Antikainen,
Viswanathan Manihatty Bojan, and Tuomas Aura. Man-
in-the-machine: Exploiting ill-secured communication
inside the computer. In 27th USENIX Security Sympo-
sium (USENIX Security 18), pages 1511–1525, Balti-
more, MD, 2018. USENIX Association.
[21] Microsoft Windows Dev Center.
Protecting Anti-
Malware Services.
https://docs.microsoft.com/en-
us/windows/desktop/services/protecting-anti-malware-
services-, 2018. Accessed August 2019.
[22] Ping Chen, Lieven Desmet, and Christophe Huygens. A
study on advanced persistent threats. In Bart De Decker
and André Zúquete, editors, Communications and Mul-
timedia Security, pages 63–72, Berlin, Heidelberg, 2014.
Springer Berlin Heidelberg.
[23] Weiteng Chen and Zhiyun Qian. Off-path TCP exploit:
How wireless routers can jeopardize your secrets. In
27th USENIX Security Symposium (USENIX Security
18), pages 1581–1598, Baltimore, MD, 2018. USENIX
Association.
574    29th USENIX Security Symposium
USENIX Association
[24] B. Deply. Mimikatz. https://github.com/gentilkiwi/
mimikatz, 2014. Accessed February 2019.
[25] S. Duckwall and C. Campbell. Hello, my name
is microsoft and i have a credential problem.
In Blackhat USA 2013 White Papers, 2013.
https://media.blackhat.com/us-13/US-13-Duckwall-
Pass-the-Hash-WP.pdf.
[26] John Dunagan, Alice X. Zheng, and Daniel R. Simon.
Heat-ray: Combating identity snowball attacks using
machine learning, combinatorial optimization and attack
In Proceedings of the ACM SIGOPS 22Nd
graphs.
Symposium on Operating Systems Principles, SOSP ’09,
pages 305–320, New York, NY, USA, 2009. ACM.
[27] James Forshaw.
Injecting Code
into Win-
dows Protected Processes using COM - Part 1.
https://googleprojectzero.blogspot.com/2018/10/injecting-
code-into-windows-protected.html, October
Accessed August 2019.
2018.
[28] Nalani
Fraser,
Jacqueline
new north
O’Leary, Vincent
Apt38: Details
Cannon, and Fred Plan.
threat
on
korean
group.
https://www.ﬁreeye.com/blog/threat-
research/2018/10/apt38-details-on-new-north-korean-
regime-backed-threat-group.html, 2017.
regime-backed
[29] Steve Friedl. An Illustrated Guide to SSH Agent For-
warding. http://www.unixwiz.net/techtips/ssh-agent-
forwarding.html, 2006. Accessed October 2019.
[30] gaffe23. Linux inject. https://github.com/gaffe23/linux-
inject, 2016. Accessed July 2019.
[31] Tal Garﬁnkel and Mendel Rosenblum. A virtual ma-
chine introspection based architecture for intrusion de-
In Proceedings of Network and Distributed
tection.
Systems Security Symposium (NDSS), February 2003.
[32] M. Haardt and M. Coleman.
ptrace(2) Linux
Programmer’s Manual.
http://man7.org/linux/man-
pages/man2/ptrace.2.html, 1999. Accessed August
2019.
[33] Support Home. Clearing the Windows Temp Folders.
http://lexisnexis.custhelp.com/app/answers/answer_view/
a_id/1084415/. Accessed August 2019.
[34] CrowdStrike Inc. CrowdStrike Compromise Assess-
ment Data Sheet. https://www.crowdstrike.com/wp-
content/brochures/CrowdStrike_CompromiseAssessment
_DataSheet.pdf, 2019. Accessed February 2019.
[35] A. D. Kent and L. M. Liebrock. Differentiating user au-
thentication graphs. In 2013 IEEE Security and Privacy
Workshops, pages 72–75, May 2013.
[36] Linux.
Linux ACL on shared memory objects.
http://man7.org/linux/man-pages/man2/shmget.2.html.
Accessed August 2019.
[37] Strategic Cyber LLC.
tactics
threat
vanced
https://cobaltstrike.com/downloads/csmanual38.pdf,
2017. Accessed February 2019.
for penetration
Cobalt
strike: Ad-
testers.
[38] S. Metcalf. Unofﬁcial guide to mimikatz & command
reference. https://adsecurity.org/?page_id=1821, 2018.
Accessed February 2019.
[39] Microsoft.
ment.
us/windows/desktop/WinRM/portal.
November 2018.
Windows
Remote Manage-
https://docs.microsoft.com/en-
Accessed
[40] Microsoft.
func-
tion.
https://msdn.microsoft.com/en-
us/library/windows/desktop/ms724251(v=vs.85).aspx,
2017. [Online; accessed 10-May-2018].
Duplicatehandle
[41] Microsoft.
Wsaduplicatesocket
func-
tion.
https://msdn.microsoft.com/en-
us/library/windows/desktop/ms741565(v=vs.85).aspx,
2017. [Online; accessed 10-May-2018].
[42] Microsoft.
Mib_tcprow2
struc-
https://docs.microsoft.com/en-
ture.
us/windows/desktop/api/tcpmib/ns-tcpmib-
_mib_tcprow2, 2018. Accessed February 2019.
[43] Doug Miller, Ron Alford, Andy Applebaum, Henry Fos-
ter, Caleb Little, and Blake Strom. Automated adver-
sary emulation: A case for planning and acting with
unknowns. 2018.
[MS-TDS]: Tabular Data Stream
[44] MSDN.
Protocol.
https://msdn.microsoft.com/en-
us/library/dd304523.aspx, 2018. Accessed November
2018.
[MS-TDS]:
SQL Batch Client
[45] MSDN.
Request.
https://msdn.microsoft.com/en-
us/library/dd304416.aspx, 2019. Accessed November
2018.
[46] Mark O’Neill, Scott Heidbrink, Jordan Whitehead, Tan-
ner Perdue, Luke Dickinson, Torstein Collett, Nick Bon-
ner, Kent Seamons, and Daniel Zappala. The secure
socket API: TLS as an operating system service.
In
27th USENIX Security Symposium (USENIX Security
18), pages 799–816, Baltimore, MD, 2018. USENIX
Association.
[47] Pradeep Padala. Playing with ptrace, part i. Linux
Journal, 2002(103):5–, November 2002.
USENIX Association
29th USENIX Security Symposium    575
[48] Windows Defender Research. Detecting stealthier cross-
process injection techniques with windows defender atp.
https://cloudblogs.microsoft.com/microsoftsecure/2017/
07/12/detecting-stealthier-cross-process-injection-
techniques-with-windows-defender-atp-process-
hollowing-and-atom-bombing/, 2019. Accessed Feb
2019.
[49] Ryan Ries. Monitoring with Windows Remote
Management
I.
https://www.myotherpcisacloud.com/post/Monitoring-
with-Windows-Remote-Management-(WinRM)-and-
Powershell-Part-I. Accessed November 2018.
and Powershell Part
(WinRM)
[50] Neil
Rubenking.
Best
J.
Antivirus
2019.
https://www.pcmag.com/article2/0,2817,2372364,00.asp,
2019. [Online; accessed 04-February-2019].
Protection
The
for
[51] Hossein Siadati and Nasir Memon. Detecting struc-
turally anomalous logins within enterprise networks. In
Proceedings of the 2017 ACM SIGSAC Conference on
Computer and Communications Security, pages 1273–
1284. ACM, 2017.
[52] Abraham Silberschatz, Peter B. Galvin, and Greg Gagne.
Operating System Concepts. Wiley Publishing, 9th edi-
tion, 2012.
[53] SolarWinds.
command.
https://support.solarwinds.com/SuccessCenter/s/article/
SITE-FTP-command, 2017. Accessed August 2019.
SITE
FTP
[54] W. Richard Stevens, Bill Fenner, and Andrew M. Rudoff.
UNIX Network Programming, Vol. 1. Pearson Education,
3 edition, 2003.
[55] Suricata.
Suricata features.
https://suricata-
ids.org/features/, 2018. Accessed November 2018.
[56] Andrew S Tanenbaum and DJ Wetherall. Computer
In Pearson Education, Inc.
Networks, Fifth Edition.
Prentice Hall, 2011.
[57] FireEye FLARE Team. Windows management
instrumentation (wmi) offense, defense, and foren-
sics.
https://www.ﬁreeye.com/content/dam/ﬁreeye-
www/global/en/current-threats/pdfs/wp-windows-
management-instrumentation.pdf, 2015.
February 2019.
Accessed
[58] David
Treadwell.
socket.c.
http://icerote.net/doc/library/programming/source/
SOURCE.CODE.MICROSOFT.WINDOWS.2000.AND.
NT4-BTDE/win2k/private/net/sockets/winsock2/wsp/
msafd/socket.c, 1992. Accessed January 2019.
[59] David
Treadwell.
wspmisc.c.
http://icerote.net/doc/library/programming/source/
SOURCE.CODE.MICROSOFT.WINDOWS.2000.AND.
NT4-BTDE/win2k/private/net/sockets/winsock2/wsp/
msafd/wspmisc.c, 1992. Accessed January 2019.
[60] VMware.
Conﬁgure WinRM to Use
https://docs.vmware.com/en/vRealize-
HTTP.
Automation/7.5/com.vmware.vrealize.orchestrator-
use-plugins.doc/GUID-D4ACA4EF-D018-448A-
866A-DECDDA5CC3C1.html. Accessed November
2018.
[61] Taimour Wehbe, Vincent Mooney, and David Keezer.
Hardware-Based Run-Time Code Integrity in Embedded
Devices. Cryptography, 2(3), 2018.
A Prepare the Environment for WinRM Hi-
jacking
A.1 Server Conﬁguration
First, we conﬁgure the WinRM server on the remote ma-
chine by following these steps.
Set the default WinRM conﬁguration
winrm quickconfig
Run the following command to check whether a listener is
running, and verify the default ports
winrm e winrm/config/listener
Run the following command to enable basic authentication
winrm set winrm/config/service/auth
’@{Basic="true"}’
Run the following command to allow transfer of unen-
crypted data by the WinRM server
winrm set winrm/config/service
’@{AllowUnencrypted="true"}’
A.2 Client Conﬁguration
Next, we conﬁgure the WinRM client by following these
steps.
Run the following command to enable basic authentication
winrm set winrm/config/client/auth
’@{Basic="true"}’
Run the following command to allow transfer of unen-
crypted data by the WinRM client
winrm set winrm/config/client
’@{AllowUnencrypted="true"}’
If the WinRM host machine is in an external domain, run
the following command to specify the trusted hosts
winrm set winrm/config/client
’@{TrustedHosts="host1, host2, host3"}’
576    29th USENIX Security Symposium
USENIX Association