Egor Rogov
PostgreSQL 14
Internals
ThesearePartsI–IIIofthebook.
Theotherpartswillfollowsoon:
IV. QueryExecution
V. IndexTypes
PostgresProfessional
Moscow,
TheelephantonthecoverisafragmentofanillustrationfromEdwardTopsell’s
TheHistoryofFour-footedBeastsandSerpents,publishedinLondonin
PostgreSQL14Internals
byEgorRogov
TranslatedfromRussianbyLiudmilaMantrova
©PostgresProfessional,2022
Thisbookinisavailableatpostgrespro.com/community/books/internals
Contents at a Glance
AboutThisBook . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11
1 Introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
PartIIsolationandMVCC 37
2 Isolation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39
3 PagesandTuples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66
4 Snapshots . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 88
5 PagePruningandHOTUpdates . . . . . . . . . . . . . . . . . . . . . . . . 102
6 VacuumandAutovacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . 114
7 Freezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 139
8 RebuildingTablesandIndexes . . . . . . . . . . . . . . . . . . . . . . . . 152
PartIIBufferCacheandWAL 163
9 BufferCache . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 165
10 Write-AheadLog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 185
11 WALModes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 205
PartIIILocks 221
12 Relation-LevelLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223
13 Row-LevelLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235
14 MiscellaneousLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 259
15 LocksonMemoryStructures . . . . . . . . . . . . . . . . . . . . . . . . . 270
Index . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 279
3
Table of Contents
AboutThisBook 11
1 Introduction 17
1.1 DataOrganization . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
Databases . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
SystemCatalog . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18
Schemas . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19
Tablespaces . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20
Relations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 21
FilesandForks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22
Pages . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26
TOAST . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26
1.2 ProcessesandMemory . . . . . . . . . . . . . . . . . . . . . . . . . . 31
1.3 ClientsandtheClient-ServerProtocol . . . . . . . . . . . . . . . . . 33
Part I Isolation and MVCC 37
2 Isolation 39
2.1 Consistency . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39
2.2 IsolationLevelsandAnomaliesDefinedbytheSQLStandard . . . . 41
LostUpdate . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 42
DirtyReadsandReadUncommitted . . . . . . . . . . . . . . . . . . 42
Non-RepeatableReadsandReadCommitted . . . . . . . . . . . . . 43
PhantomReadsandRepeatableRead. . . . . . . . . . . . . . . . . . 43
NoAnomaliesandSerializable . . . . . . . . . . . . . . . . . . . . . 44
WhyTheseAnomalies? . . . . . . . . . . . . . . . . . . . . . . . . . 44
2.3 IsolationLevelsinPostgreSQL . . . . . . . . . . . . . . . . . . . . . 45
ReadCommitted . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46
RepeatableRead . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 55
Serializable . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61
2.4 WhichIsolationLeveltoUse? . . . . . . . . . . . . . . . . . . . . . . 64
4
TableofContents
3 PagesandTuples 66
3.1 PageStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66
PageHeader . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66
SpecialSpace . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67
Tuples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67
ItemPointers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 68
FreeSpace. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69
3.2 RowVersionLayout . . . . . . . . . . . . . . . . . . . . . . . . . . . 69
3.3 OperationsonTuples . . . . . . . . . . . . . . . . . . . . . . . . . . 71
Insert . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72
Commit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75
Delete . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 77
Abort . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 78
Update. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
3.4 Indexes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
3.5 TOAST . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 81
3.6 VirtualTransactions . . . . . . . . . . . . . . . . . . . . . . . . . . . 81
3.7 Subtransactions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82
Savepoints . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 82
ErrorsandAtomicity . . . . . . . . . . . . . . . . . . . . . . . . . . . 85
4 Snapshots 88
4.1 WhatisaSnapshot? . . . . . . . . . . . . . . . . . . . . . . . . . . . 88
4.2 RowVersionVisibility . . . . . . . . . . . . . . . . . . . . . . . . . . 89
4.3 SnapshotStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90
4.4 VisibilityofTransactions’OwnChanges . . . . . . . . . . . . . . . . 94
4.5 TransactionHorizon . . . . . . . . . . . . . . . . . . . . . . . . . . . 96
4.6 SystemCatalogSnapshots . . . . . . . . . . . . . . . . . . . . . . . . 99
4.7 ExportingSnapshots . . . . . . . . . . . . . . . . . . . . . . . . . . . 100
5 PagePruningandHOTUpdates 102
5.1 PagePruning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102
5.2 HOTUpdates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 106
5.3 PagePruningforHOTUpdates . . . . . . . . . . . . . . . . . . . . . 109
5.4 HOTChainSplits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 111
5.5 PagePruningforIndexes . . . . . . . . . . . . . . . . . . . . . . . . 112
5
TableofContents
6 VacuumandAutovacuum 114
6.1 Vacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 114
6.2 DatabaseHorizonRevisited . . . . . . . . . . . . . . . . . . . . . . . 117
6.3 VacuumPhases . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 120
HeapScan . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 120
IndexVacuuming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 120
HeapVacuuming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 121
HeapTruncation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 122
6.4 Analysis . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 122
6.5 AutomaticVacuumandAnalysis . . . . . . . . . . . . . . . . . . . . 123
AbouttheAutovacuumMechanism. . . . . . . . . . . . . . . . . . . 123
WhichTablesNeedtobeVacuumed? . . . . . . . . . . . . . . . . . . 125
WhichTablesNeedtoBeAnalyzed? . . . . . . . . . . . . . . . . . . 127
AutovacuuminAction . . . . . . . . . . . . . . . . . . . . . . . . . . 128
6.6 ManagingtheLoad . . . . . . . . . . . . . . . . . . . . . . . . . . . . 132
VacuumThrottling . . . . . . . . . . . . . . . . . . . . . . . . . . . . 132
AutovacuumThrottling . . . . . . . . . . . . . . . . . . . . . . . . . 133
6.7 Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 134
MonitoringVacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . 134
MonitoringAutovacuum . . . . . . . . . . . . . . . . . . . . . . . . . 137
7 Freezing 139
7.1 TransactionIDWraparound . . . . . . . . . . . . . . . . . . . . . . . 139
7.2 TupleFreezingandVisibilityRules . . . . . . . . . . . . . . . . . . . 140
7.3 ManagingFreezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . 143
MinimalFreezingAge . . . . . . . . . . . . . . . . . . . . . . . . . . 144
AgeforAggressiveFreezing . . . . . . . . . . . . . . . . . . . . . . . 145
AgeforForcedAutovacuum . . . . . . . . . . . . . . . . . . . . . . . 147
AgeforFailsafeFreezing . . . . . . . . . . . . . . . . . . . . . . . . . 149
7.4 ManualFreezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 149
FreezingbyVacuum . . . . . . . . . . . . . . . . . . . . . . . . . . . 150
FreezingDataattheInitialLoading . . . . . . . . . . . . . . . . . . 150
8 RebuildingTablesandIndexes 152
8.1 FullVacuuming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 152
WhyisRoutineVacuumingnotEnough? . . . . . . . . . . . . . . . . 152
EstimatingDataDensity . . . . . . . . . . . . . . . . . . . . . . . . . 153
6
TableofContents
Freezing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 156
8.2 OtherRebuildingMethods. . . . . . . . . . . . . . . . . . . . . . . . 158
AlternativestoFullVacuuming . . . . . . . . . . . . . . . . . . . . . 158
ReducingDowntimeduringRebuilding. . . . . . . . . . . . . . . . . 158
8.3 PreventiveMeasures . . . . . . . . . . . . . . . . . . . . . . . . . . . 159
Read-OnlyQueries . . . . . . . . . . . . . . . . . . . . . . . . . . . . 159
DataUpdates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 160
Part II Buffer Cache andWAL 163
9 BufferCache 165
9.1 Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 165
9.2 BufferCacheDesign . . . . . . . . . . . . . . . . . . . . . . . . . . . 166
9.3 CacheHits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 168
9.4 CacheMisses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 172
BufferSearchandEviction. . . . . . . . . . . . . . . . . . . . . . . . 173
9.5 BulkEviction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 175
9.6 ChoosingtheBufferCacheSize . . . . . . . . . . . . . . . . . . . . . 178
9.7 CacheWarming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181
9.8 LocalCache . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 183
10 Write-AheadLog 185
10.1 Logging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 185
10.2 WALStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 186
LogicalStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 186
PhysicalStructure . . . . . . . . . . . . . . . . . . . . . . . . . . . . 190
10.3 Checkpoint . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191
10.4 Recovery . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 195
10.5 BackgroundWriting . . . . . . . . . . . . . . . . . . . . . . . . . . . 198
10.6 WALSetup . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 199
ConfiguringCheckpoints . . . . . . . . . . . . . . . . . . . . . . . . 199
ConfiguringBackgroundWriting . . . . . . . . . . . . . . . . . . . . 202
Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 202
11 WALModes 205
11.1 Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 205
7
TableofContents
11.2 FaultTolerance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
DataCorruption . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 211
Non-AtomicWrites . . . . . . . . . . . . . . . . . . . . . . . . . . . . 213
11.3 WALLevels . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 215
Minimal . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216
Replica . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218
Logical. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 220
Part III Locks 221
12 Relation-LevelLocks 223
12.1 AboutLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223
12.2 HeavyweightLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . 225
12.3 LocksonTransactionIDs . . . . . . . . . . . . . . . . . . . . . . . . 227
12.4 Relation-LevelLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . 228
12.5 WaitQueue . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231
13 Row-LevelLocks 235
13.1 LockDesign . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235
13.2 Row-LevelLockingModes . . . . . . . . . . . . . . . . . . . . . . . . 236
ExclusiveModes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 236
SharedModes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 238
13.3 Multitransactions . . . . . . . . . . . . . . . . . . . . . . . . . . . . 239
13.4 WaitQueue . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 241
ExclusiveModes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 241
SharedModes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247
13.5 No-WaitLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250
13.6 Deadlocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252
DeadlocksbyRowUpdates . . . . . . . . . . . . . . . . . . . . . . . 254
DeadlocksBetweenTwoUPDATEStatements . . . . . . . . . . . . . 255
14 MiscellaneousLocks 259
14.1 Non-ObjectLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . 259
14.2 RelationExtensionLocks . . . . . . . . . . . . . . . . . . . . . . . . 261
14.3 PageLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 261
8
TableofContents
14.4 AdvisoryLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262
14.5 PredicateLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 264
15 LocksonMemoryStructures 270
15.1 Spinlocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 270
15.2 LightweightLocks . . . . . . . . . . . . . . . . . . . . . . . . . . . . 271
15.3 Examples . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 271
BufferCache . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 271
WALBuffers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 273
15.4 MonitoringWaits . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274
15.5 Sampling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 276
Index 279
9
About This Book
Booksarenotmadetobebelieved,buttobe
subjectedtoinquiry.
—UmbertoEco,TheNameoftheRose
For Whom Is This Book?
This book is for those who will not settle for a black-box approach when work-
ingwithadatabase. Ifyouareeagertolearn,prefernottotakeexpertadvicefor
granted,andwouldliketofigureouteverythingyourself,followalong.
IassumethatthereaderhasalreadytriedusingPostgreandhasatleastsome
general understanding of how it works. Entry-level users may find the text a bit
difficult.Forexample,Iwillnottellanythingabouthowtoinstalltheserver,enter
psqlcommands,orsetconfigurationparameters.
I hope that the book will also be useful for those who are familiar with another
databasesystem,butswitchovertoPostgreandwouldliketounderstandhow
they differ. Abook like this would have saved me a lot of time several years ago.
Andthat’sexactlywhyIfinallywroteit.
What This Book Will Not Provide
Thisbookisnotacollectionofrecipes. Youcannotfindready-madesolutionsfor
everyoccasion,butifyouunderstandinnermechanismsofacomplexsystem,you
willbeabletoanalyzeandcriticallyevaluateotherpeople’sexperienceandcome
to your own conclusions. For this reason,I explain such details that may at first
seemtobeofnopracticaluse.
But this book is not a tutorial either. While delving deeply into some fields (in
whichIammoreinterestedmyself),itmaysaynothingatallabouttheother.
11
AboutThisBook
By no means is this book a reference. I tried to be precise, but I did not aim at
replacingdocumentation,soIcouldeasilyleaveoutsomedetailsthatIconsidered
insignificant.Inanyunclearsituationreadthedocumentation.
ThisbookwillnotteachyouhowtodevelopthePostgrecore. Idonotexpect
any knowledge of the C language, as this book is mainly intended for database
administratorsandapplicationdevelopers.ButIdoprovidemultiplereferencesto
thesourcecode,whichcangiveyouasmanydetailsasyoulike,andevenmore.
What This Book Does Provide
Intheintroductorychapter,Ibrieflytouchuponthemaindatabaseconceptsthat
will serve as the foundation for all the further narration. I do not expect you to
get much new information from this chapter but still include it to complete the
bigpicture.Besides,thisoverviewcanbefoundusefulbythosewhoaremigrating
fromotherdatabasesystems.
PartIisdevotedtoquestionsofdataconsistencyandisolation. Ifirstcoverthem
fromtheuser’sperspective(youwilllearnwhichisolationlevelsareavailableand
what are the implications) and then dwell on their internals. For this purpose,
Ihavetoexplainimplementationdetailsofmultiversionconcurrencycontroland
snapshotisolation,payingspecialattentiontocleanupofoutdatedrowversions.
PartIIdescribesbuffercacheand,whichisusedtorestoredataconsistency
afterafailure.
Part III goes into details about the structure and usage of various types of locks:
lightweightlocksfor,heavyweightlocksforrelations,androw-levellocks.
PartIVexplainshowtheserverplansandexecutesqueries.Iwilltellyouwhich
dataaccessmethodsareavailable,whichjoinmethodscanbeused,andhowthe
collectedstatisticsareapplied.
PartVextendsthediscussionofindexesfromthealreadycoveredB-treestoother
accessmethods. Iwillexplainsomegeneralprinciplesofextensibilitythatdefine
the boundaries between the core of the indexing system, index access methods,
anddatatypes(whichwillbringustotheconceptofoperatorclasses),andthen
elaborateoneachoftheavailablemethods.
12
Conventions
Postgre includes multiple “introspective” extensions, which are not used in
routinework,butgiveusanopportunitytopeekintotheserver’sinternalbehav-
ior. Thisbookusesquiteafewofthem. Apartfromlettingusexploretheserver
internals, these extensions can also facilitate troubleshooting in complex usage
scenarios.
Conventions
Itriedtowritethisbookinawaythatwouldallowreadingitpagebypage,from
starttofinish.Butitishardlypossibletouncoverallthetruthatonce,soIhadto
getbacktooneandthesametopicseveraltimes.Writingthat“itwillbeconsidered
later”overandoveragainwouldinevitablymakethetextmuchlonger,that’swhy
insuchcasesIsimplyputthepagenumberinthemargintoreferyoutofurther p.
discussion. Asimilarnumberpointingbackwardswilltakeyoutothepagewhere