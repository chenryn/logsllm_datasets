Some things about LAN device detection  
(关于内网设备识别的二三事) 
Canaan Kao, Terence Liu, Hsien-Wei Hung and Ryan Lung 
PI:EMAIL 
Network Threat Defense Technology Group 
Trend Micro 
2015/8/29 
1 
HitCon2015: LAN device detection 
Who we are 
• Network Threat Defense Technology 
Group (NTDTG) of Trend Micro 
– We have offices in Hsinchu and Taipei. 
• We focus on  
– (Virtualized) High-speed IPS/IDS 
– Network-stream-based AV 
– Smart-home Protection 
– IoT Security 
2015/8/29 
2 
HitCon2015: LAN device detection 
Before we start 
• HitCon2014 slogan: 
– Adapt to the new era of security threats 
– 威胁是一定会有的，我们要学会适应。 
• HitCon2015 slogan: 
– Security of Things 
– 物连网安全。 
• The combination: 
– Adapt to the new era of IoT security threats. 
– 物连网威胁是一定会有的，我们要学会适应。 
2015/8/29 
HitCon2015: LAN device detection 
3 
Agenda 
• Why LAN device identification (LDI) 
• How to detect LAN devices 
• The threat intelligence with LDI 
• Summary 
2015/8/29 
HitCon2015: LAN device detection 
4 
• Why LAN device identification 
2015/8/29 
HitCon2015: LAN device detection 
5 
Why LAN device identification 
• 过去FW/IDS/IPS 基本上会以为家里的设备
是这样？ 
2015/8/29 
HitCon2015: LAN device detection 
6 
Why LAN device identification 
• 但是，家里连网的设备实际上可能会是…. 
2015/8/29 
HitCon2015: LAN device detection 
7 
Why LAN device identification 
• 万一有误会，就会产生拿针对 x86 产生的 
特征码来侦测攻击 ARM/MIPS 设备的 
shellcode 的状况…. 
• User 通常不知道 
2015/8/29 
HitCon2015: LAN device detection 
8 
Why LAN device identification 
• Monitoring 
– 计量 
• Access Control 
– 连网控制 
• Learning 
– 知己, LAN device behavior modeling 
– 知彼, Threat intelligence  
2015/8/29 
HitCon2015: LAN device detection 
9 
Why LAN device identification 
• Device identification is not important for 
traditional IDS/IPS? 
– Age is changed. 
– IDS/IPS need to change too. 
2015/8/29 
HitCon2015: LAN device detection 
10 
Why LAN device identification 
• PC 上的 Botnet/Malware 会让自己看起来越来越
正常。例如：透过 Dropbox 通讯、看Blog等等。 
• 这样比较好规避 AV/IPS/FW. 
2015/8/29 
HitCon2015: LAN device detection 
11 
Why LAN device identification 
• 可是其他的智慧家电呢？例如：冰箱。 
– 对 PC 来说是正常的行为，对其他的 
devices/things 来说，可能还是算异常。 
2015/8/29 
HitCon2015: LAN device detection 
12 
Why LAN device identification 
• 所以，问题是，我怎么知道目前在送 
emails 的是台什么样的机器？ 
– 是 PC? 还是冰箱？哪个牌子? 型号? 病历？ 
2015/8/29 
HitCon2015: LAN device detection 
13 
• How to detect LAN devices 
2015/8/29 
HitCon2015: LAN device detection 
14 
How to detect LAN devices 
• 基本上，方法有两种 
– 1. 主动进行 device fingerprinting scan 
• 就像是 Nmap  的  OS  fingerprinting 
• 缺点是容易被发现，且增加不必要的 traffic 
– 2. 被动观察 devices 送出来的 packets 
• 优点是隐密性高 
• 缺点是相关的 packets 一定要流经过 
• (我们用这种) 
2015/8/29 
HitCon2015: LAN device detection 
15 
How to detect LAN devices 
• 被动式的 LAN Device Identification 可以怎么
做？ 
– 0.  Are you router/NAT or devices? 
– 1. Check the OUI of MAC address 
– 2. Check the DHCP options 
– 3. Check the user-agent of HTTP request 
– 4. Check the used applications 
• 例如：发现它常用 Skype ，那就猜它应该是 PC/phone? 
– 5. Check 其他… 
• 习惯用的 DNS 与 互连的 IP 等等 
– 综合这些 features, 我们就可以来 算分数/learn   
2015/8/29 
HitCon2015: LAN device detection 
16 
How to detect LAN devices 
NAT/Router detection 
• 如果某个IP是台 router/NAT，而我们在它的 
WAN 端  
– 所辖设备的 MAC addresses，我们应该看不到 
– 所辖设备的 DHCP packets，我们应该看不到 
– 该 IP 所呈现的 user-agents 与 application 
traffic  可能会太多样 
2015/8/29 
HitCon2015: LAN device detection 
17 
How to detect LAN devices 
NAT/Router detection 
• Two keys 
– The ID field in IP Header 
• In general, NAT does not modify IP ID. 
• If an host presents multiple IP ID sequences, it 
may be a NAT. 
– The TTL field in IP Header 
• If you are in LAN and you find the packet’s TTL is 
not the initial value (128 for Windows), the packet 
may be NATed or routed. 
2015/8/29 
HitCon2015: LAN device detection 
18 
How to detect LAN devices 
NAT/Router detection 
• 主要我们会观察 IP header 的两个栏位 
2015/8/29 
HitCon2015: LAN device detection 
19 
How to detect LAN devices 
NAT/Router detection 
The ID field in IP Header 
• 有些 OS (例如 Win7) 会习惯用同一个 
counter 来设定所有送出的 IP ID。 
– 所以，如果一个IP送出来的 packets 其 IP ID 
都是以同一个序列递增，那它应该是台 host。 
– 如果不是，那就要再看其他的。 
2015/8/29 
HitCon2015: LAN device detection 
20 
How to detect LAN devices 
NAT/Router detection 
The ID field in IP Header 
•
如果没有经过 NAT，那我们看到的 IP ID 序列有可能长这样。 
2015/8/29 
HitCon2015: LAN device detection 
21 
How to detect LAN devices 
NAT/Router detection 
The ID field in IP Header 
•
如果有经过 NAT，那我们看到的 IP ID 序列有可能长这样。 
2015/8/29 
HitCon2015: LAN device detection 
22 
How to detect LAN devices 
NAT/Router detection 
The ID field in IP Header 
• 所以，如果要侦测家里的设备，最好的方
式就是和 home router 厂商合作。 
– 除非家里有另外的 NAT，要不然我们就可以免
除家里的困扰。 
2015/8/29 
HitCon2015: LAN device detection 
23 
How to detect LAN devices 
NAT/Router detection 
The TTL field in IP Header 
• TTL 通过 NAT/Router 就会被减一。 
– 所以如果我们看到的封包的 TTL 不是 default 
value，那它有可能先经过 NAT/Router. 
– Default values: 
• Win7_TCP: 128 
• Ubuntu_TCP: 64 
•
Ref: http://www.binbert.com/blog/2009/12/default-time-to-live-ttl-values/ 
2015/8/29 
HitCon2015: LAN device detection 
24 
How to detect LAN devices 
1. Check the OUI of MAC address 
• Source: https://en.wikipedia.org/wiki/MAC_address 
2015/8/29 
HitCon2015: LAN device detection 
25 
How to detect LAN devices 
1. Check the OUI of MAC address 
2015/8/29 
HitCon2015: LAN device detection 
26 
How to detect LAN devices 
1. Check the OUI of MAC address 
• Source: http://standards-oui.ieee.org/oui.txt 
2015/8/29 
HitCon2015: LAN device detection 
27 
How to detect LAN devices 
1. Check the OUI of MAC address 
• 基本上透过 OUI 的检查，我们可以知道厂牌 
2015/8/29 
HitCon2015: LAN device detection 
28 
How to detect LAN devices 
1. Check the OUI of MAC address 
应用：绵羊墙 
2015/8/29 
HitCon2015: LAN device detection 
29 
How to detect LAN devices 
1. Check the OUI of MAC address 
应用：绵羊墙 
2015/8/29 
HitCon2015: LAN device detection 
30 
How to detect LAN devices 
2. Check the DHCP options 
• Why? 
– 有人买 home router/gateway 回家启用后，没
开 DHCP 的吗?  
• 有普遍性 
– DHCP Client 有可能泄漏些可识别的资讯给 
DHCP Server  
– 以及中间偷听的设备  
2015/8/29 
HitCon2015: LAN device detection 
31 
How to detect LAN devices 
2. Check the DHCP options 
• Dynamic Host Configuration 
Protocol (DHCP) is based on 
BOOTP. 
– UDP port 67 for server 
– UDP port 68 for client 
•
Source: 
https://upload.wikimedia.org/wikipedia/commons/e/e4/
DHCP_session.svg 
2015/8/29 
HitCon2015: LAN device detection 
32 
How to detect LAN devices 
2. Check the DHCP options 
•
Source: http://www.cisco.com/web/about/ac123/ac147/images/ipj/ipj_5-
2/figure_2_dhcp.gif 
2015/8/29 
HitCon2015: LAN device detection 
33 
How to detect LAN devices 
2. Check the DHCP options 
2015/8/29 
HitCon2015: LAN device detection 
34 
For the details of DHCP options,  
please check RFC 2132. 
How to detect LAN devices 
2. Check the DHCP options 
2015/8/29 
HitCon2015: LAN device detection 
35 
How to detect LAN devices 
2. Check the DHCP options 
(Win7 DHCP packets) 
2015/8/29 
HitCon2015: LAN device detection 
36 
How to detect LAN devices 
2. Check the DHCP options 
(Win7 DHCP packets) 
2015/8/29 
HitCon2015: LAN device detection 
37 
How to detect LAN devices 
2. Check the DHCP options 
(Win7 DHCP packets) 
• 这个 option 有用 
2015/8/29 
HitCon2015: LAN device detection 
38 
How to detect LAN devices 
2. Check the DHCP options 
(Win7 DHCP packets) 
• 这个 option 也有用 
2015/8/29 
HitCon2015: LAN device detection 
39 
How to detect LAN devices 
2. Check the DHCP options 
• Option 55/0x37 要怎么用？ 