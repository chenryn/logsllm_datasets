### 关于内网设备识别的探讨
#### 作者：Canaan Kao, Terence Liu, Hsien-Wei Hung, Ryan Lung  
##### 电子邮件：PI:EMAIL  
##### 单位：Trend Micro 网络威胁防御技术组  
##### 日期：2015年8月29日

---

### HitCon2015: 内网设备检测

#### 我们是谁
- **网络威胁防御技术组 (NTDTG)**
  - 办公地点：新竹和台北
  - 专注领域：
    - 高速（虚拟化）IPS/IDS
    - 基于网络流的防病毒
    - 智能家居保护
    - 物联网安全

---

### 开场白
- **HitCon2014 主题**:
  - 适应新的安全威胁时代
  - “威胁是一定会有的，我们要学会适应。”

- **HitCon2015 主题**:
  - 物联网安全
  - “物连网安全。”

- **结合主题**:
  - 适应新的物联网安全威胁
  - “物连网威胁是一定会有的，我们要学会适应。”

---

### 议程
- 为什么需要内网设备识别 (LDI)
- 如何检测内网设备
- LDI 的威胁情报
- 总结

---

### 为什么需要内网设备识别 (LDI)

- **过去的情况**:
  - 传统的防火墙、入侵检测系统 (IDS) 和入侵防御系统 (IPS) 通常假设家庭网络中的设备都是标准的 x86 设备。
  - 实际上，现代家庭网络中可能包含多种不同架构的设备，如 ARM 或 MIPS 设备。

- **问题**:
  - 如果使用针对 x86 设备生成的特征码来检测 ARM/MIPS 设备上的 shellcode，可能会导致误报或漏报。
  - 用户通常不知道这种差异的存在。

- **监测**:
  - 计量：监控网络流量和行为
  - 访问控制：管理设备的网络访问
  - 学习：了解设备行为模式和威胁情报

- **传统 IDS/IPS 的局限性**:
  - 传统 IDS/IPS 在面对多样化设备时显得不足。
  - 需要随着时代的变迁而进化。

- **PC 上的 Botnet/Malware**:
  - 现代恶意软件会模仿正常行为，例如通过 Dropbox 通讯或浏览博客，以规避 AV/IPS/FW 的检测。
  - 其他智能家电（如冰箱）的行为对于 PC 来说是正常的，但对于其他设备来说可能是异常的。

- **识别设备的重要性**:
  - 了解发送邮件的设备类型（PC 还是冰箱？哪个品牌？型号？历史记录？）

---

### 如何检测内网设备

- **方法**:
  1. **主动设备指纹扫描**:
     - 类似 Nmap 的 OS 指纹扫描
     - 缺点：容易被发现，增加不必要的流量
  2. **被动观察设备发出的数据包**:
     - 优点：隐秘性高
     - 缺点：相关数据包必须流经检测设备
     - （我们采用这种方法）

- **被动式内网设备识别步骤**:
  1. **区分路由器/NAT 和设备**:
     - 检查 IP 报头中的 ID 字段
     - 检查 IP 报头中的 TTL 字段
  2. **检查 MAC 地址的 OUI**:
     - 可以确定设备的品牌
  3. **检查 DHCP 选项**:
     - DHCP 客户端可能会泄漏可识别的信息
  4. **检查 HTTP 请求的 User-Agent**:
     - 例如，如果常用 Skype，可以猜测是 PC 或手机
  5. **检查使用的应用程序**:
     - 例如，习惯用的 DNS 和互联的 IP 地址
  6. **综合这些特征进行评分/学习**

- **NAT/路由器检测**:
  - **IP 报头中的 ID 字段**:
    - 一些操作系统（如 Windows 7）使用同一个计数器来设置所有发送的 IP ID。
    - 如果一个 IP 发送的数据包的 IP ID 是按同一序列递增的，那么它可能是一台主机。
  - **IP 报头中的 TTL 字段**:
    - 经过 NAT/路由器的数据包的 TTL 会减一。
    - 默认值：Windows 7 TCP 为 128，Ubuntu TCP 为 64。

- **MAC 地址的 OUI 检查**:
  - 通过 OUI 可以知道设备的品牌。
  - 应用示例：绵羊墙

- **DHCP 选项检查**:
  - DHCP 客户端可能会泄漏可识别的信息给 DHCP 服务器及中间监听设备。
  - 具体的 DHCP 选项细节请参考 RFC 2132。

---

### 结论
- 内网设备识别 (LDI) 在现代网络安全中变得越来越重要。
- 通过被动观察设备发出的数据包，我们可以更准确地识别和分类设备。
- 结合多种特征进行综合分析，可以提高检测的准确性和可靠性。