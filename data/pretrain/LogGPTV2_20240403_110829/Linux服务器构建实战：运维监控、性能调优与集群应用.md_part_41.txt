643
7185
free
rsec/s
8.01
0.001704.00
rsec/s
8.19
rsec/s
8189
7468
925
steal
wsec/s avgrq-sz avgqu-sz
steal
wsec/s avgrq-sz avgqu-sz
z8-nb5Ae zs-bx5Ae 8/o38
0.00
114.03
shared
86.18
$idle
86.14
idle
62.33
buffers
0.04
0.07
243
cached
0.79
await
await
6299
0.14
svctm
svctm util
0.10
uti
0.24
---
## Page 279
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
10.6.6netstat 命令
片，比如本例的输出显示，
统性能。相反，如果load average的输出值小于CPU的个数，则表示CPU还有空闲的时间
很繁忙，负载很高，可能会影响系统性能；如果偶尔大于8，倒不用担心，一般不会影响系
录用户，系统在1分钟内、5分钟内、15分钟内的平均负载。看下面的一个输出：
信息依次为：系统现在的时间，系统从上次开机到现在运行了多长时间，系统目前有多少登
10.6.5
断地监控内存的使用情况。例如下面这个输出：
表示系统内存资源基本能满足应用需求，暂时不影响系统性能。
该命令的选项说明如表10-2所示。
netstat命令用于显示本机网络连接、运行端口、路由表等信息。其语法如下：
例如，本输出中系统有8个CPU，如果loadaverage的3个值长期大于8时，说明CPU
这里需要注意loadaverage这个输出值，
uptime是监控系统性能最常用的一个命令，主要用来统计系统当前的运行状况。输出的
free命令还可以适时监控内存的使用状况，使用“-s”参数可以在指定的时间段内不间
netstat[选项]
[root@webserver ~]#uptime
其中，
Swap:
em
Mem:
[root@webserver -]# free -b -s 5
uptime命令
buffers/cache:
，“-b”表示以千字节（也就是1024字节）为单位来显示内存使用情况。
www.Linuxidc.com
8587149312
8505901056
8587149312
8505901056
total
8587149312
8505901056
total
7523987456
665665536
7526936576
7528706048
CPU是非常空闲的。
662716416
used
used
667435008
163840 8586985472
163840
163840
2users,
7843184640
8586985472
7840235520
8586985472
7838466048
981913600
free
free
它的3个值的大小一般不能大于系统CPU的个
1oad average:0.12,0.08,0.08
shared
shared
shared
buffers
buffers
260141056 6601129984
260128768 6601142272
260112384 6601158656
cached
cached
cached
析与优化263
PDG
---
## Page 280
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
命令至关重要。
令执行过程中使用的一些命令。这些命令都是单个字母，从应用角度来讲，熟悉这些交互式
进程，类似于Windows的任务管理器。
示。同时top命令还可以通过交互式命令进行设定显示。通过top命令可以查看即时活跃的
用状况。该命令可以按照CPU的使用、内存的使用和执行时间对系统任务进程进行排序显
10.6.7
default行对应的值，表示系统的默认路由，对应的网络接口为eth0。
结果与route命令的输出完全相同。看下面的一个实例：
千兆网卡或光纤网络。还可以检查网络部署环境是否合理。
一定会下降。
为0，如果这几个选项的值不为0，并且很大，那么网络质量肯定有问题，网络传输性能也
top命令中除了以上这些选项外，还有很多交互式命令，这些交互式命令就是在top命
top命令提供了实时对系统处理器状态的监控，能够实时显示系统中各个进程的资源占
在网络不通或网络异常时，首先想到的就是检查系统的路由表信息。“netstat-r”的输出
当网络传输存在问题时，可以检测网卡设备是否存在故障，如果可能的话，应升级为
top的选项很多，其常用的选项如表10-3所示。
top[选项]
top命令的语法如下：
关于输出中每项的具体含义显示得很明确，这里不再多讲。这里我们重点关注的是
lefault
169.254.0.0
192.168.200.0
10.10.1.0
Destination
[root@webserver -]# netstat -r
选项
top命令
-n
上
www.Linuxidc.com
10.10.1.254
Gateway
top输出信息更新的次数，完成后将退出top命令
使top命令在安全模式下运行，此时top的交互式指令被取消，避免潜在危险
显示进程的整个命令路径，而不是只显示命令名称
不显示闲置或僵死的进程信息
指定每两次屏幕信息刷新之间的时间间隔
表10-3top的常用选项说明
0.0.0.0
255.255.0.0
255.255.255.0
255.255.255.0
Genmask
UG
C
Flags
义
MSS
.Window
irtt
优化265
C
etho
ethl
eth1
etho
Iface
---
## Page 281
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
f或者F
0或者0
h或？
交互命令
从图10-1中可以看到，top的输出分为两个部分：统计信息区和进程信息区，即前5行
查看当前系统活动的进程，如图10-1所示。
下面通过一个具体的例子来解释top命令中每个选项的含义。
表10-4就是交互式命令及其代表的具体含义。
RR.NI
将当前top设置写入~/.toprc文件中
切换到累计模式
根据时间/累计时间进行排序输出
根据CPU使用百分比大小进行排序输出
根据驻留内存大小进行排序输出
切换显示完整命令行和命令名称信息
退出top显示
切换显示平均负载和启动时间信息
切换显示进程和CPU状态信息
切换显示内存信息
改变top输出信息两次刷新之间的时间，系统将提示输人新的时间，单位是秒，如果是小数，
忽略闲置进程和僵死进程，这是一个开关式命令
终止一个进程，系统将提示用户输入一个需要终止进程的PID
显示帮助信息，给出交互式命令的一些总结或说明总结
进程的妆
表10-4交互式命令及其代表的具体含义
图10-1查看当前系统活动的进程
inuxidc.com
系统输出将不断被刷新
6244
表示含义
TIME+SCONMARO
默认
新时间是5秒
DG
---
## Page 282
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
显示为统计信息区，后面几行的为进程信息区。下面分别介绍。
口VIRT，进程使用的虚拟内存总量，单位为KB。VIRT=SWAP+RES。
口NI：nice值，负值表示高优先级，正值表示低优先级。
口
口USER，进程所有者的用户名。
口PID，进程的id。
进程信息区显示了每个进程的运行状态。先来看一下每列输出的含义：
（2）进程信息区
口
口
口0.0%ni，用户进程空间内改变过优先级的进程占用CPU的百分比。
口
口
口
口121 sleeping，处于休眠的进程数。
口
L
第
口loadaverage:0.47，0.20，0.10，表示系统平均负载，3个数值分别表示1分钟、5分钟、
D
口13:29:02，表示当前系统时间。
第一行为任务队列信息，含义如下：
（1）统计信息区
PR，进程优先级。
2320396kcached，高速缓存的大小。
8193108kfree，空闲的交换分区大小
0kused，已经使用的交换分区大小。
Swap:8193108ktotal，交换分区的内存大小。
1468964kbuffers，用作内核缓冲区的内存大小。
50412kfree，目前空余内存大小。
4009540kused，已经使用的物理内存大小。
Mem：4059952ktotal，系统的物理内存大小
后两行输出的是内存信息，具体含义如下：
10.2%wa：等待输人输出的进程占用CPU的百分比。
99.3%id，空闲CPU占用的百分比。
10.1%sy，系统进程占用CPU的百分比。
Cpu（s):0.3%us，表示用户进程占用CPU的百分比。
0zombie，僵死的进程数。
10stopped，停止的进程数。
11running，正在运行的进程数。
Tasks:122total，进程的总数。
二、三两行为进程和CPU信息，
15分钟前到现在的系统平均负载值。
12users，当前登录系统的用户数。
up3days，23:15，表示系统已经启动了3天23小时15分钟。
www.Linuxidc .
风
具体含义如下：
第10章基于Linux服务器的性能分析与优化267
.com
PDG
---
## Page 283
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
高，网页访问速度极慢。
一段时间发现，网站服务岩机时间间隔加长了，不像以前那么频繁了，但是系统负载还是很
1500。继续观察发现，网站还是频繁岩机，于是将“MaxClients”选项值降到1024。观察
了系统内存。然后，修改httpd.conf配置文件的“MaxClients”选项，将此值由2000降到
统内存仅有2GB大小，而“MaxClients”选项被配置为2000，过多的用户访问进程耗尽
的KeepAlive特性。
Apache配置文件httpd.conf，发现“MaxClients”选项值被设置为2000，并且打开了Apache
在一段时间内能正常服务，但过一会又变得响应缓慢，最后网页彻底无法打开。
SCSI磁盘。
10.7.1
10.7
268
根据上面的检查，
(3）处理措施
首先检查系统资源状态，
（2）检查配置
网站在上午10点左右和下午3点左右访问高峰时，网页无法打开，重启服务后，网站
（1）现象描述
2.性能问题现象及处理措施
网站架构：Web应用是基于LAMP架构，所有服务都在一台服务器上部署。
操作系统：
硬件环境：1台IBMx3850服务器，单个双核Xeon3.0GCPU，2GB内存，3块72GB
1.网站运行环境说明
口COMMAND，正在运行进程的命令名或命令路径。
口TIME+，进程使用的CPU时间总计，单位为1/100秒。
口%MEM，进程占用的物理内存百分比。
口%CPU，上次更新到现在的CPU时间占用百分比。
口
口SHR，共享内存大小，单位为KB。
口RES，进程使用的、未被换出的物理内存大小，单位为KB。RES=CODE+DATA。
示跟踪/停止，乙表示僵死进程。
S，进程状态，D表示不可中断的睡眠状态，R表示运行状态，S表示睡眠状态，T表
基于Web应用的性能分析及优化案例
基于动态内容为主的网站优化案例
www.Linuxidc .com
CentOS 5.4。
运维监控与性能优化篇
，初步判断是Apache的“MaxClients”选项配置不当引起的，因为系
，发现服务出现故障时系统负载极高，内存基本耗尽。接着检查
---
## Page 284
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
虽然偶尔也会使用虚拟内存，但是Web服务正常了，服务岩机问题也很少出现了。
置中的“KeepAlive”特性关闭，这样Apache进程数大量减少，基本维持在500～600之间，
I/O等待问题，最终导致CPU资源耗尽。
是必然的。当物理内存耗尽时，虚拟内存就会启用，频繁地使用虚拟内存，肯定会出现磁盘
Apache子进程消耗6～8MB内存，如果设置Apache的最大用户数为1024，那么内存耗尽
并且磁盘I/O有等待问题，于是得出如下结论：
还会无法正常访问。这次仍然从分析系统资源使用状况人手，发现系统内存资源消耗过大，
程序对数据库的访问。
有多高可想而知。
代码也没有相应的缓存机制，每个用户请求都要重新进行数据库查询操作，数据库查询负荷
问首页都要多次查询数据库，而查询数据库是个非常耗费CPU资源的过程，并且首页PHP
PHP代码，发现首页的页面非常大，图片很多，并且由全动态的程序组成，这样每次用户访
志发现，网站首页访问频率最高，也就是说首页程序代码可能存在问题。于是检查首页的
根据经验，在正常情况下每个Apache子进程消耗的内存在1MB左右。结合Apache输出日
耗过高的主要因素是用户进程消耗资源严重。
资源也消耗严重，这是造成网站响应缓慢或长时间没有响应的主要原因，而导致系统资源消
5.第三次分析优化
因此修改Apache 配置文件htpd.conf中的“MaxClients”选项值为“600"，同时把Apache配
经过前两次的优化，
通过上面对PHP代码的优化，每个Apache子进程消耗的内存资源基本维持在1～2MB左
(2）处理措施
内存消耗过大，肯定是用户访问进程数过多导致的，在没有优化PHP代码之前，每个
（1）原因分析
通过前面简单优化，
4.第二次分析优化
修改首页PHP代码，缩减页面大小，并且对访问频繁的操作增加缓存机制，尽量减少
(3）处理措施