A DIRTY LITTLE 
HISTORY
Bypassing Spectre Hardware Defenses to Leak Kernel Data
1
2
Vrije Universiteit Amsterdam
Enrico
Barberis
Herbert
Bos
Cristiano 
Giuffrida
Marius
Muench
Pietro
Frigo
2
TL;DR
â€¢
Spectre affects most modern CPUs
â—‹
You can leak data across privilege levels (e.g., User-to-Kernel)
â€¢
CPU vendors released HW defenses to thwart exploitation
â€¢
But do they actually work?
3
4
Outline
â€¢
Spectre-101
â€¢
Bypassing Spectre Hardware Defenses
â€¢
Branch History Injection
â€¢
Exploit + Live Demo
5
Spectre-101
6
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
array[x]
0
1
2
128
...
7
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
0
1
2
128
array[0]
...
7
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
0
1
2
128
array[0]
...
7
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
0
1
2
128
array[1]
...
7
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
0
1
2
128
array[2]
...
7
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
0
1
2
128
256
array[256]
...
7
Spectre 101
if (x < array.size) // size = 128
y = array[x];
BPU
Speculative 
OOB read
0
1
2
128
256
array[256]
...
7
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
...
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
...
...
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
Cached
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
Cached
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
Cached
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
Cached
8
Spectre & Flush+Reload
if (x < array.size) // size = 128
y = array[x];
z = reload_buff[y];
BPU
0
1
2
128
256
array[256]
0
1
2
256
reload_buff[y]
3
3
...
...
Cached
8
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
9
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
9
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œmeowâ€ ðŸ±
9
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
9
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œwoofâ€ ðŸ¶
9
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
10
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
10
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
10
BPU
ðŸ¤·
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
10
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
10
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
â€œmeowâ€ ðŸ±
â€œwoofâ€ ðŸ¶
Spectre-v2
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
11
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
Spectre-v2
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
11
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
Spectre-v2
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
11
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
leak_secret ðŸ˜ˆ
Spectre-v2
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
11
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
leak_secret ðŸ˜ˆ
Spectre-v2
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
leak_secret ðŸ˜ˆ
11
BTB
TAG
TARGET
TAGcat
â€œmeowâ€ ðŸ±
TAGdog
â€œwoofâ€ ðŸ¶
...
...
BPU
leak_secret ðŸ˜ˆ
Spectre-v2 capabilities
12
App
App
Kernel
User
Kernel
Guest
Host
â—
Software
â—
Intel:
Retpoline
Spectre-v2 defenses
13
call call_thunk
capture_spec:
pause
jmp capture_spec
call_thunk:
mov [rsp], rax; 
ret
call rax
â—
Software
â—
Intel:
Retpoline
â—
AMD:  
AMD Retpoline ( = concept, != implementation )
â—
Arm:   
Weird things ðŸ˜¢
Spectre-v2 defenses
14
â—
Software
â—
Intel:
Retpoline
â—
AMD:  
AMD Retpoline ( = concept, != implementation )
â—
Arm:   
Weird things ðŸ˜¢
â—
Hardware
â—‹
Intel:
eIBRS
â—‹
Arm:
FEAT_CSV2
Spectre-v2 defenses
15
â—
Software
â—
Intel:
Retpoline
â—
AMD:  
AMD Retpoline ( = concept, != implementation )
â—
Arm:   
Weird things ðŸ˜¢
â—
Hardware
â—‹
Intel:
eIBRS
â—‹
Arm:
FEAT_CSV2
Spectre-v2 defenses
15
Predictor-mode 
isola&on in hardware
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
Intel eIBRS & Arm CSV2
Idea: tag BTB entries by security domain
16
BPU
BTB
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
Intel eIBRS & Arm CSV2
Idea: tag BTB entries by security domain
16
kern: jmp rax
BPU
BTB
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
Intel eIBRS & Arm CSV2
Idea: tag BTB entries by security domain
16
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
kern: jmp rax
BPU
BTB
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
Intel eIBRS & Arm CSV2
Idea: tag BTB entries by security domain
16
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
kern: jmp rax
BPU
BTB
Is this isola*on complete?
Intel eIBRS & Arm CSV2
17
Intel eIBRS & Arm CSV2
17
Bypassing Spectre Hardware 
Defenses
18
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œmeowâ€ ðŸ±
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);