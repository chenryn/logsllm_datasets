            }c_k;
        }c_u;
    };
// 更改后
    struct vm_map_copy{
        int type;
        #define VM_MAP_COPY_ENTRY_LIST 1
        #define VM_MAP_COPY_OBJECT 2
        #define VM_MAP_COPY_KERNEL_BUFFER 3
        vm_object_offset_t offset;
        vm_map_size_t size;
        union{
            struct vm_map_header hdr;
            vm_object_t object;
            uint8_t kdata[0]; //  ~/.lldbinit
请注意主机和客户机都必须禁用 System Integrity Protection(SIP)。
你已经完成了对主机环境的配置，现在再对客户机进行配置就可以调试内核了。
**客户机设置**
OSX 可以使用 nvram 设置引导参数（boot-args）。
    $ nvram boot-args
boot-args 是作为 OS 在启动时设置的参数。但我们使用这些参数是为了记录调试所需的中断和日志信息。boot-args 有很多参数，这里我们先设置
debug。可以参考下面的图表。
调试内核时，给 debug 参数赋值 0x144。DB_NMI 标志允许调试器使用 NMI 中断 attach 到调试对象上。你可以设置如下所示的选项。
    $ sudo nvram boot-args="debug=0x144 -v"
    DB_LOG_PI_SCRN
    DB_ARP
    DB_NMI
    Boot Verbose mode
    $ sudo reboot
之后，boot-args 被设置并产生一个 NMI 中断，从而允许调试器调试内核。
有时候即使 NMI 已经在调试对象中给出，也不能进行调试，那么需要在调试器中添加 arp 表。
    $ arp -s  
这样就完成了主机和客户机的配置，可以继续下面的调试了。
**attach 到调试器**
作为本文的例子，我们将调试的 1day 漏洞是 CVE-2017-2370。
    $ vi test.c
    $ clang -o test test.c
在客户机中编译 PoC 并产生一个 NMI，NMI 可以通过命令 Command + Alt + Control + Shift + Esc
产生。一旦产生了 NMI，操作系统将被安全地停止运行。
在调试器中，你可以使用 kdp-remote 进行远程调试，首先打开 KDK 的内核二进制文件。
    songsangjun-ui-MacBook-Pro:~ s0ngsari$ lldb /Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel
    (lldb) target create "/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel"
    Loading kernel debugging from /Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py
    LLDB version lldb-350.0.21.9
    settings set target.process.python-os-plugin-path "/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/core/operating_system.py"
    settings set target.trap-handler-names hndl_allintrs hndl_alltraps trap_from_kernel hndl_double_fault hndl_machine_check _fleh_prefabt _ExceptionVectorsBase _ExceptionVectorsTable _fleh_undef _fleh_dataabt _fleh_irq _fleh_decirq _fleh_fiq_generic _fleh_dec
    command script import "/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/xnu.py"
    xnu debug macros loaded successfully. Run showlldbtypesummaries to enable type summaries.
    Current executable set to '/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel' (x86_64).
    (lldb)
如果没有报错，则使用 kdp-remote 命令链接到远程调试器。
    (lldb) kdp-remote 
    Version: Darwin Kernel Version 16.1.0: Wed Oct 19 20:31:56 PDT 2016; root:xnu-3789.21.4~4/RELEASE_X86_64; UUID=75CA1C4D-7BF4-321B-B544-D8F1B6D60EF8; stext=0xffffff8014200000
    Kernel UUID: 75CA1C4D-7BF4-321B-B544-D8F1B6D60EF8
    Load Address: 0xffffff8014200000
    Kernel slid 0x14000000 in memory.
    Loaded kernel file /Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel
    Loading 94 kext modules warning: Can't find binary/dSYM for com.apple.kec.corecrypto (809FEC94-017C-307A-B099-A01EFF5485FB)
    .warning: Can't find binary/dSYM for com.apple.kec.pthread (36567317-B854-3157-ABF3-CEAD0A3770BB)
    .warning: Can't find binary/dSYM for com.apple.kec.Libm (51D82C5F-0248-334D-ADC6-5861BBB83C97)
    .warning: Can't find binary/dSYM for com.apple.iokit.IOACPIFamily (4F7FB6AD-2498-3F71-827C-ED7AA4BF2511)
    .Target arch: x86_64
    Instantiating threads completely from saved state in memory.
    .warning: Can't find binary/dSYM for com.apple.driver.AppleACPIPlatform (249D7BA8-3FD5-3207-A482-0605CB898037)
    .warning: Can't find binary/dSYM for com.apple.driver.AppleFDEKeyStore (EA5D0966-E8EA-337A-98EB-195806E8F723)
    .warning: Can't find binary/dSYM for com.apple.iokit.IOReportFamily (B14DC3D3-7250-3DA3-BF50-C666EBEDAF4C)
    .Target arch: x86_64
    Instantiating threads completely from saved state in memory.
    .warning: Can't find binary/dSYM for com.apple.driver.DiskImages (05A729EF-20B8-3254-8F13-42DF42E0544B)
    .warning: Can't find binary/dSYM for com.apple.driver.AppleBusPowerController (DB526B45-1A45-3A81-A0C1-57F826CADEDF)
    .Target arch: x86_64
    Instantiating threads completely from saved state in memory.
    .warning: Can't find binary/dSYM for com.apple.driver.KernelRelayHost (3B58E6F0-DE92-3289-9D3B-3BF12208585F)
    .warning: Can't find binary/dSYM for com.apple.driver.AppleCredentialManager (54677B39-44B3-3AAA-BBEC-D78D0B5CC1A7)
    .warning: Can't find binary/dSYM for com.apple.driver.AppleMobileFileIntegrity (0EFA4D2C-2271-3C43-B777-17D05716144A)
    .warning: Can't find binary/dSYM for com.apple.driver.AppleKeyStore (75515493-6D25-39F7-8F0B-B08B505CAB74)