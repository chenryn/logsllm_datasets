#BHUSA @BlackHatEvents
BrokenMesh: New Attack
Surfaces of Bluetooth Mesh
Han Yan, Lewei Qu, Dongxiang Ke
Baidu AIoT Security Team
#BHUSA @BlackHatEvents
Information Classification: General
About US
Baidu AIoT Security Team
â€¢ Focus on Android / Linux platform
â€¢ Aim to discover 0day vulnerability and explore possible defenses
Members
â€¢ Han Yan
â€¢ Lewei Qu
â€¢ Dongxiang Ke
#BHUSA @BlackHatEvents
Information Classification: General
Agenda
â€¢ Introduction to Bluetooth Mesh
â€¢ Attack Surfaces Analysis
â€¢ BLE Mesh Fuzzer
â€¢ Case Study
â€¢ Summary
#BHUSA @BlackHatEvents
Information Classification: General
1 Introduction to Bluetooth Mesh
What is Bluetooth Mesh
â€¢ Aka, Bluetooth LE Mesh, BLE Mesh
â€¢ A wireless mesh networking technology based on BLE
â€¢ Made public by Bluetooth Special Interest Group (Bluetooth SIG) in 2017
Smart Home
Industrial IoT
#BHUSA @BlackHatEvents
Information Classification: General
Bluetooth Mesh vs Bluetooth Classic/LE
Key Differences
â€¢ Bluetooth Mesh is a networking technology, analogous to TCP/IP
â€¢ Bluetooth Classic/LE are wireless communication technologies
Network Layer in Protocol Stack
#BHUSA @BlackHatEvents
Information Classification: General
Network Topology
Node Type
â€¢ Node
â€¢ Relay node
â€¢ Low Power node
â€¢ Friend node
Managed Flooding
â€¢ Based on advertising
â€¢ Non-central
â€¢ Non-routing
#BHUSA @BlackHatEvents
Information Classification: General
Network Addresses
Address Type
Address Validity
Address Type
Values
Unassigned Address
16bits, 0b0000000000000000
Unicast Address
16bits, 0b0xxxxxxxxxxxxxxx
Virtual Address
16bits, 0b10xxxxxxxxxxxxxx
Group Address
16bits, 0x11xxxxxxxxxxxxxx
Address Type
Valid as SRC
Valid as DST
Unassigned Address
No
No
Unicast Address
Yes
Yes
Virtual Address
No
Yes
Group Address
No
Yes
#BHUSA @BlackHatEvents
Information Classification: General
Message-Oriented Communication
Publish
â€¢ Sending message
â€¢ Publish to a unicast / group / virtual address
Subscribe
â€¢ Receiving message
â€¢ Subscribe to a group / virtual address
Example
â€¢ Some lights subscribe to the group address â€œKitchenâ€ (e.g., 0xC001)
â€¢ Switch can publish â€œONâ€ message to â€œKitchenâ€, to turn on those lights
#BHUSA @BlackHatEvents
Information Classification: General
2 Attack Surfaces Analysis
Research Scope
â€¢ Bluetooth mesh protocol, including two key stages
â€¢ Bluetooth mesh wrapper application
Research Focus
â€¢ Focus on software implementation vulnerabilities
1
2
3
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Protocol
Concepts
â€¢ Provisioning
â€¢ Provisioner
â€¢ Unprovisioned device
Procedure
â€¢ Beaconing
â€¢ Invitation & Capabilities
â€¢ Public Key Exchange
â€¢ Authentication
â€¢ Distribution of Provisioning Data
Wireshark
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Protocol
Protocol Stack
â€¢ All the provisioning messages follow this format
â€¢ Different messages have different data
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Attack Surfaces
When to Attack
â€¢ Before authentication
â€¢ No extra information required
What to Attack
â€¢ Segmentation and Reassembly
â€¢ General mechanism, memory operation
How to Attack
â€¢ Mismatched ğ‘†ğ‘’ğ‘”ğ‘ and ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ğ¿ğ‘’ğ‘›ğ‘”ğ‘¡â„
â€¢ â€¦
#BHUSA @BlackHatEvents
Information Classification: General
Bad Unprovisioned Device
Bad Provisioner
Network Build Attack Surfaces
Threat Model
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Protocol
Protocol Stack
â€¢ Layered Architecture
Wireshark
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Protocol
Security Features
â€¢ ğ‘ğ‘’ğ‘¡ğ¾ğ‘’ğ‘¦
â€¢ ğ´ğ‘ğ‘ğ¾ğ‘’ğ‘¦
If We Have..
â€¢ No keys, we can only know ğ¼ğ‘‰ğ¼, ğ‘ğ¼ğ· and ğ‘ğ‘’ğ‘¡ğ‘€ğ¼ğ¶
â€¢ ğ‘ğ‘’ğ‘¡ğ¾ğ‘’ğ‘¦, we can parse network & lower transport layer
â€¢ ğ‘ğ‘’ğ‘¡ğ¾ğ‘’ğ‘¦ and ğ´ğ‘ğ‘ğ¾ğ‘’ğ‘¦, we can parse the whole message
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Attack Surfaces
What to Attack
â€¢ Segmentation and Reassembly
â€¢ General mechanism
â€¢ Memory operation
â€¢ Only ğ‘ğ‘’ğ‘¡ğ¾ğ‘’ğ‘¦ is required
How to Attack
â€¢ Inconsistent ğ‘†ğ‘’ğ‘”ğ‘
â€¢ ğ‘†ğ‘’ğ‘”ğ‘‚ > ğ‘†ğ‘’ğ‘”ğ‘
â€¢ â€¦
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Attack Surfaces
Threat Model
#BHUSA @BlackHatEvents
Information Classification: General
Wrapper Application Attack Surfaces
Mesh in BlueDroid
â€¢ Android version â‰¥ 8.0
â€¢ Mesh capabilities are wrapped as AIDL service
What to Attack
â€¢ Permission restriction of AIDL service
â€¢ Memory operation in JNI & HAL layer
How to Attack
â€¢ Try unauthorized access to service
â€¢ Call service with malformed parameters
#BHUSA @BlackHatEvents
Information Classification: General
3 BLE Mesh Fuzzer
Overview
â€¢ â€œBLE Mesh Fuzzerâ€, a fuzzing tool for Bluetooth Mesh protocol
â€¢ Fuzzing both network build and network control stages
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Fuzzing
Test Case Generation
â€¢ Generate a series of segmented packets at once
â€¢ ğ‘‡ğ‘’ğ‘ ğ‘¡ğ¶ğ‘ğ‘ ğ‘’ = {ğ‘ƒ!"#, ğ‘ƒ!$#
%
, â€¦ , ğ‘ƒ!$#
& }
Sender / Receiver
â€¢ Build link, then send test case
â€¢ Wait for ğ¿ğ‘–ğ‘›ğ‘˜ ğ¶ğ‘™ğ‘œğ‘ ğ‘’
Crash Detection
â€¢ â€œNo ğ¿ğ‘–ğ‘›ğ‘˜ ğ¶ğ‘™ğ‘œğ‘ ğ‘’â€ means crash
â€¢ A timer for each test case
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Fuzzing
Work Flow
Trigger Vulnerability
Not Trigger
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Fuzzing
Generation Strategy
â€¢ ğ‘‡ğ‘’ğ‘ ğ‘¡ğ¶ğ‘ğ‘ ğ‘’ = {ğ‘ƒ!"#, ğ‘ƒ!$#
%
, ğ‘ƒ!$#
'
, â€¦ , ğ‘ƒ!$#
& }
â€¢ Randomize packets count ğ‘ + 1
â€¢ Randomize ğ‘†ğ‘’ğ‘”ğ‘, ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ğ¿ğ‘’ğ‘›ğ‘”ğ‘¡â„, and ğ·ğ‘ğ‘¡ğ‘ ğ¿ğ‘’ğ‘›ğ‘”ğ‘¡â„ of Transaction Start PDU
â€¢ Randomize ğ‘†ğ‘’ğ‘”ğ‘‚ and ğ·ğ‘ğ‘¡ğ‘ ğ¿ğ‘’ğ‘›ğ‘”ğ‘¡â„ of Transaction Continue PDUs
System Output
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Fuzzing
Test Case Generation
â€¢ Generate a series of segmented packets at once
â€¢ ğ‘‡ğ‘’ğ‘ ğ‘¡ğ¶ğ‘ğ‘ ğ‘’ = {ğ‘ƒ%, ğ‘ƒ', ğ‘ƒ(, â€¦ , ğ‘ƒ&}
Sender / Receiver
â€¢ Send both test case and probe
â€¢ Probe is a valid SAR packet
â€¢ Wait for prob ğ´ğ¶ğ¾ğ‘ 
Crash Detection
â€¢ Missing probe ğ´ğ¶ğ¾ means crash
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Fuzzing
Work Flow
Trigger Vulnerability
Not Trigger
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Fuzzing
Generate Strategy
â€¢ ğ‘‡ğ‘’ğ‘ ğ‘¡ğ¶ğ‘ğ‘ ğ‘’ = {ğ‘ƒ%, ğ‘ƒ', ğ‘ƒ(, â€¦ , ğ‘ƒ&}
â€¢ Randomize packets count ğ‘
â€¢ Randomize ğ‘†ğ‘’ğ‘”ğ‘, ğ‘†ğ‘’ğ‘”ğ‘‚, ğ·ğ‘ğ‘¡ğ‘ ğ¿ğ‘’ğ‘›ğ‘”ğ‘¡â„ and ğ¶ğ‘‡ğ¿
System Output
#BHUSA @BlackHatEvents
Information Classification: General
System Implementation
Hardware
â€¢ nRF52840 module + MacBook
Software
â€¢ SweynTooth Driver, customize BLE via Python
â€¢ Implemented protocol stack, based on Mesh spec
#BHUSA @BlackHatEvents
Information Classification: General
4 Case Study
Vulnerabilities (up to 2022.07.24)
â€¢ A total of 17 issues were found
â€¢ Covered 8 well-known vendors
â€¢ Obtained 13 CVEs
All the listed CVEs have been fixed by vendors
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Vulnerability
CVE-2022-24893
â€¢ Out-of-bound Write in network build stage
â€¢ Mismatched ğ‘†ğ‘’ğ‘”ğ‘ and ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ğ¿ğ‘’ğ‘›ğ‘”ğ‘¡â„
#BHUSA @BlackHatEvents
Information Classification: General
Network Build Vulnerability
CVE-2022-24893 POC
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Vulnerability
CVE-2022-26527
â€¢ Out-of-bound Write in network control stage
â€¢ Inconsistent ğ‘†ğ‘’ğ‘”ğ‘
#BHUSA @BlackHatEvents
Information Classification: General
Network Control Vulnerability
CVE-2022-26527 POC
Hijack PC and R0
#BHUSA @BlackHatEvents
Information Classification: General
Wrapper Application Vulnerability
CVE-2022-20041
â€¢ Bluetooth Mesh Service permission leak
â€¢ Treat all foreground applications as permitted caller
#BHUSA @BlackHatEvents
Information Classification: General
Wrapper Application Vulnerability
CVE-2022-20027
â€¢ Stack overflow in Bluetooth Mesh JNI
â€¢ ğ‘šğ‘’ğ‘šğ‘ğ‘ğ‘¦ with no length check
#BHUSA @BlackHatEvents
Information Classification: General
5 Summary
Conclusion
â€¢ Memory corruption vulnerabilities are very likely to occur in SAR implementation
â€¢ Security of wrapper application, especially permission and native, also needs attention
â€¢ All the listed CVEs have been fixed by vendors
Future Work
â€¢ Feedback-driven fuzzing strategy
â€¢ Vulnerability mining at upper layers
â€¢ Attack surfaces exploration of GATT proxy protocol
#BHUSA @BlackHatEvents
Information Classification: General
Q&A
#BHUSA @BlackHatEvents
Information Classification: General
Thanks For Listening !