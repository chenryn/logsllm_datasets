访问匿名网站的原理复盘。在原Tor网络上增加了承载暗网网址导航功能的目录数据库(DB)，暗网服务器选定的允许与其通信的介绍点(Introduction
point)，及进行两端数据传输的最终会合点(Rendezvous point)。原理图中的每一步连接，都是建立在 Tor
网络的三跳连接之上，杜绝流量监控嗅探到明文数据。下面我们了解一下访问匿名网站的过程。
  * step 1: 暗网服务器连入 Tor 网络，并隐匿IP信息
这一步是通过介绍点来完成，方法是暗网服务器选取若干节点充当介绍点，建立Tor线路；并以介绍点充当影子功能，隐匿IP信息。
  * step 2: 暗网服务器通过向目录数据库注册，公示自身的存在
这一步是通过目录数据库来完成，目录数据库收录了各个暗网服务器上传的自身标识（公钥、对应介绍点摘要等），这些标识以自身的私钥签名。暗网服务器的域名(例：uffti3lhacanefgy.onion)由公钥派生。
  * step 3: 客户端获取暗网网址对应的标识信息，拿到网址对应的公钥与介绍点
这一步是客户端通过Tor线路访问目录数据库拿到的结果，此外还进行标识的篡改验证。
  * step 4: 客户端随机选取节点构建会合点，为后续与暗网服务器传输数据做准备
这一步是会合点的生成，除为选取的会合点创建Tor线路外，同时会合点还会收到一次性“验证信息”，用来校验暗网服务器。
  * step 5\6: 客户端通过介绍点，通告暗网服务器会合点的地址和“验证信息”
这一步的核心是让暗网服务器知道会合点的存在，媒介是客户端在目录数据库中获取到的对应暗网网址的介绍点，同时传递了后续用来对接验证的“验证信息”。
  * step 7: 暗网服务器通过Tor线路连接会合点，最终与客户端达成数据传输
这一步暗网服务器也通过Tor线路与会合点建立连接，但两端还未达成真正的通信，必须进行“验证信息”的核实，当真正验证成功后，才能达成真正的通路。
经过以上复杂流程，客户端和暗网服务器建立通信成功，形成一个上面截图的六跳连接，并成功保证了双方的匿名性。
### **Tor 网络节点**
从前面可以看到，暗网的匿名性基于其众多的节点，但如果部署足够多的节点，是否就能探测到双方的 IP 地址和通信数据呢？先来看看暗网节点的情况。
**节点介绍**
暗网节点一共分为以下3类：
  * 入口节点/中间节点
入口节点和中间节点没有本质的差别，通常各 IDC
运营商都允许服务器被部署为入口节点和中间节点，新节点上线只能是中间节点，当稳定性和带宽都比较高时，才允许被升级为入口节点。
  * 出口节点
出口节点从技术上看和入口节点一样，但通常 IDC
运营商是不允许服务器部署出口节点的，因为如果引发了犯罪行为，由于无法进行往回追踪，会导致运营商背锅。因此，出口节点通常是学术机构、ISP、科研单位、公共图书馆等才会部署。
  * 网桥
由于入口节点是公开的，因此很容易被封锁。为了保证这些地区的人也能访问 Tor
网络，还存在一个秘密的入口列表，称之为网桥节点。这个秘密列表每次只可以查询到3个入口节点，通过一些机制保证不能简单被遍历，以此来对抗封锁。
**节点数据**
截止当前，目前运行的 Tor 节点数量大概有7500，普通节点大约6500，网桥节点接近1000。
![
](https://images.seebug.org/content/images/2018/12/6e2c8784-0b99-4ba8-980a-36e8e6c20326.png-w331s)
普通节点中，入口节点（Guard）大约2400，出口节点（Exit）大约800多。
![
](https://images.seebug.org/content/images/2018/12/4c14681d-9f8b-4b19-9091-1a086b6d9b5c.png-w331s)
从这个数据来看，假设我们在“入中出”三类节点中各有一台机器，能检测到完整数据的概率大约是 1/(3400 * 800 * 3300) =
1/8976000000。大约是九十亿分之一。
其中大多数节点主要分布在欧美国家。
![
](https://images.seebug.org/content/images/2018/12/e47fad21-7297-4af3-9254-055065236507.png-w331s)
**节点详情**
完整的公开节点列表可以在以下网址查询到 ，云厂商可以根据这个列表进行自查。
![
](https://images.seebug.org/content/images/2018/12/10cb2a1c-e351-4a5b-95c8-446d730c326e.png-w331s)
部分节点详细数据
### **Tor 用户**
全球每天使用 Tor 网络的用户基本稳定在200万人，相对于数十亿的互联网用户，其实非常小量，而其中访问暗网匿名网站的用户更是其中的一小部分。
![
](https://images.seebug.org/content/images/2018/12/562a952e-6246-4fdb-9657-0d591b9425bd.png-w331s)
暗网用户分布国家 TOP10。
![
](https://images.seebug.org/content/images/2018/12/0a953efa-2ade-48b0-9f05-e9d49c200f37.png-w331s)
**其它平行网络**
前面说过，Tor 网络只是暗网的一个实现版本，其他的还有 Freenet 和 I2P 网络，但用户量远远低于 Tor，因此仅作了解就好。
近年来由于区块链技术的发展，又出现了一种基于区块链技术的分布式匿名网络，其典型例子是 ZeroNet（零网）。
![
](https://images.seebug.org/content/images/2018/12/5702280a-6e95-4770-935b-1790e6708f93.png-w331s)
具体用法可以参见官网，，用来搭建自己的网站，不但匿名，甚至无需服务器。
### **写在最后：**
技术本身是中立的，尤其是在密码学的领域，一方面保障着整个互联网的安全和信任基础，一方面也包庇了暗网下的种种犯罪。Tor
网络也一样，一方面为大众提供了一种安全的匿名方案，一方面也为非法交易提供了温床。阴阳总是交融地存在，所幸黑色领域终究是少数，如何将黑色领域尽量压缩，道阻且长。
揭开了暗网的面纱，本系列下一篇，将用最科普的方式，继续讲述暗网背后的密码学原理。
### **参考资料：**
[1] Tor: Overview  
[2] Tor: Onion Service Protocol  
[3] Tor: Relays and bridges  
[4] Tor: Relays by relay flag  
（部分图片来源网络）
**腾讯安全云鼎实验室**
关注云主机与云内流量的安全研究和安全运营。利用机器学习与大数据技术实时监控并分析各类风险信息，帮助客户抵御高级可持续攻击；联合腾讯所有安全实验室进行安全漏洞的研究，确保云计算平台整体的安全性。相关能力通过腾讯云开放出来，为用户提供黑客入侵检测和漏洞风险预警等服务，帮助企业解决服务器安全问题。
* * *