](https://images.seebug.org/content/images/2019/03/353cff84-abb2-4a84-a678-9fa1569d029f.png-w331s)
表1 控制命令和含义
图12 木马对恶意命令的接收和解析
从表1我们可以看到，控制命令分为两大部分，第一部分包含前9个命令，分别表示“木马上线、将自身设置为默认短信应用、清空用户数据、将指定号码设置成呼叫转移号码”等。第二部分包括后面的30个命令，当木马接收到Firebase传来的目标银行的APP包名字符串后，木马就打开对应的配置好的http钓鱼伪装界面，来窃取受害用户的银行登录凭证。
##### **4.1.1 木马上线**
木马收到“online”指令后，将自身是否激活管理员权限、是否开启无障碍服务等信息写入配置文件后，发送上线包到远程服务器（见图13）。
图13 发送上线包
##### **4.1.2 将自身设置为默认短信应用**
“lock”命令会引导用户设置木马自身为系统短信应用，接管短信服务，以获得对短信数据库的操作权限（见图14）。Android
4.4及其以后，只能设置一个默认的SMS短信APP，当短信到达后会首先通知设置的默认APP，并且只有该APP对短信数据库有修改的权限和短信的发送权限。设置成功后，木马就劫持了系统短信，破解了基于短信的SMS短信双因素验证机制。
图14 设置自身为默认短信应用
##### **4.1.3 清空用户数据**
当木马接收到“clear”指令，就清空用户数据（见图15）。
图15 清空用户数据
##### **4.1.4 设置呼叫转移号码**
“21”命令是设置感染设备的呼叫转移号码为攻击者远程指定的手机号码（见图16）。攻击者首先打开感染设备的拨号程序，然后通过输入“ _21_
手机号码#”对感染设备设置呼叫转移。这样，攻击者就可以成功拦截受害用户的手机来电。
图16 设置呼叫转移号码
##### **4.1.5 设置配置文件“addm”为on**
当木马收到“addm”命令后，就会设置配置文件“addm”项为on，用于激活自身管理员权限（见图17）。木马激活自身管理员权限后，可以防止自身被受害用户轻易卸载掉。
图17 设置配置文件“addm”项为 on
##### **4.1.6 解密指定文件**
图18中，“lckscr”指令目的是解密“asset”目录下加密文件到自身应用目录下的“/location/”路径下，根据指令“dellckscr”，猜测解密后的文件名为“www.html”。
图18 解密指定文件到指定路径
##### **4.1.7 加载指定页面**
“dellckscr”指令用于加载自身应用目录下位置为“/location/www.html”的页面（见图19），不过我们在分析该木马时，并未发现此目录和相应文件，目的未知。
图19 加载指定页面
##### **4.1.8 卸载指定应用**
当接收到“src”指令时，木马会打开卸载APP界面，卸载掉攻击者指定的APP（见图20）。
图20 卸载指定应用
##### **4.1.9 将目标手机安装的所有应用列表发送给恶意服务器**
当收到的消息为“alpkg”时，木马就遍历系统应用名称，将收集的感染设备安装的应用列表发送给攻击者控制的远程服务器（见图21）。攻击者知道目标设备安装有哪些应用后，尤其是银行应用，就可以针对目标银行来进行攻击。
图21 发送应用列表到远程服务器
##### **4.1.10 启动钓鱼页面**
当木马接收到Firebase传来的目标银行的APP包名字符串后，木马就打开对应的配置好的http钓鱼伪装界面，来窃取受害用户的银行登录凭证。从表1中我们可以看到在钓鱼服务器路径“http://anlixes.at/cz
_”和“http://anlixes.at/pl_ ”下，至少配置有26个伪装的钓鱼页面在等待受害用户上钩，其中“http://anlixes.at/cz
_”针对捷克、“http://anlixes.at/pl_ ”针对波兰”。我们分别列出其中的两个页面（图22和图23）。
图22 针对捷克用户的伪装钓鱼页面
图23 针对波兰用户的伪装钓鱼页面
#### **4.2 监控数据返回**
木马在执行命令后，会将执行结果或者对感染设备的监控数据回传给自己控制的恶意服务器（见图24），从图中的代码我们可以看到木马是将感染机的监控行为数据赋值给p参数后，发送到恶意服务器地址“http://anlixes.at/api/log”。图25是我们抓包的一个结果，从图中可以看到，我们试图卸载该恶意木马时，木马发送给恶意服务器的监控数据。
图24 回传指令执行的结果给恶意服务器
图25 回传数据抓包的结果
### **5、总结及建议**
“BankThief”从2019年1月开始活跃，主要的攻击目标为波兰和捷克，不排除后期对其他国家或地区实行攻击的可能性。
“BankThief”利用无障碍服务监控感染设备，劫持合法银行应用来对受害用户进行钓鱼攻击，再结合其截获到的银行验证短信，窃取受害用户钱财。“BankThief”还使用了代码混淆和字符串加密，增加了安全研究人员分析的难度。同时，在攻击过程中，攻击者将恶意攻击流量隐藏在Google
Firebase云消息隧道中，以避免攻击流量被网络设备处置，进一步加大了攻击的隐蔽性。
启明星辰ADLab建议广大用户尽量从官网下载手机应用，尤其是涉及到金钱的银行类应用，以免被不法分子利用，威胁到您的财产安全，给您造成不必要的麻烦和损失。
* * *
**启明星辰积极防御实验室（ADLab）**
ADLab成立于1999年，是中国安全行业最早成立的攻防技术研究实验室之一，微软MAPP计划核心成员，“黑雀攻击”概念首推者。截止目前，ADLab已通过CVE累计发布安全漏洞近1000个，通过
CNVD/CNNVD累计发布安全漏洞近500个，持续保持国际网络安全领域一流水准。实验室研究方向涵盖操作系统与应用系统安全研究、移动智能终端安全研究、物联网智能设备安全研究、Web安全研究、工控系统安全研究、云安全研究。研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。
* * *