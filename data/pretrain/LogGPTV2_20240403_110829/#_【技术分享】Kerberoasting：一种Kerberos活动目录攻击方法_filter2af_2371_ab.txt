# 配置静态IP地址和DNS解析
为了将当前主机设置为域控制器，我们首先需要为其配置一个静态IP地址：
```powershell
New-NetIPAddress -InterfaceIndex 9 -IPAddress 172.16.14.3 -PrefixLength 24
```
接下来，我们需要指向正确的DNS服务器（即我们的域控制器）以确保名称解析正确：
```powershell
Set-DnsClientServerAddress -InterfaceIndex 2 -ServerAddresses 172.16.14.1
```

# 加入到域中
使用`Add-Computer`命令将这台机器加入到`lab.local`域内：
```powershell
Add-Computer -DomainName lab.local
```
最后，重启计算机以完成加入域的过程：
```powershell
Restart-Computer
```

我还对VirtualBox进行了配置，给每个虚拟机分配了一个网络接口用于连接内部的“域”网络。这样，在所有虚拟环境搭建完毕后，我们将得到一个结构简单的网络拓扑图，其中包含三个具有不同IP地址的节点，它们都已成功加入了`lab.local`域。

现在，我们已经建立了一个理想的实验环境，可以用来尝试基于Kerberos协议的各种攻击技术。下面，让我们从Kerberoasting开始探讨。

## 什么是Kerberoasting

Kerberoasting是一种利用Kerberos协议缺陷进行攻击的技术。近年来，这种攻击手段越来越受到关注，甚至在今年的[Derbycon](https://www.irongeek.com/i.php?page=videos/derbycon7/t107-return-from-the-underworld-the-future-of-red-team-kerberos-jim-shaver-mitchell-hennigan)上有一个专门针对此话题的演讲。
  
存在多种工具能够简化在Windows域环境下实施Kerberoasting攻击的过程。本文中我选择使用的是由[HarmJ0y](https://twitter.com/harmj0y?lang=en)开发的PowerSploit工具集中的`Invoke-Kerberoast` PowerShell cmdlet。建议您阅读他的博客文章[《无需Mimikatz的Kerberoasting》](https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/)来了解更多背景信息，并订阅其博客获取最新动态。

### Kerberos认证流程概述

在深入了解Kerberoasting之前，先回顾一下标准Kerberos认证流程：

1. 用户向密钥分发中心（Key Distribution Center, KDC）发送AS-REQ数据包进行身份验证。
2. KDC验证用户凭证有效后返回TGT（Ticket-Granting Ticket）。
3. 若要访问特定服务（如IIS），用户需发起TGS请求，该请求包括TGT和服务主体名称SPN。
4. 如果TGT有效且未过期，TGS会生成针对目标服务的服务票据，并用服务账户的凭据加密之。
5. 用户接收包含加密服务票据的TGS响应数据包。
6. 最后，用户将服务票据转发至目标服务处解密并完成认证过程。

需要注意的是，服务票据是通过服务账户密码的哈希值加密的，这意味着任何经过身份验证的域用户都可以请求这些票据，并尝试离线破解它们。

### 服务主体名称 (SPN)

根据微软官方定义，**SPN**（Service Principal Name）是一个服务实例的唯一标识符，在Kerberos认证过程中用于关联服务登录账户与服务实例。例如，在我们的测试环境中，IIS服务对应的SPN可能是`HTTP/iis.lab.local`，它被绑定到了名为`LABiis_svc`的账户上。

### Kerberoasting的工作原理

在本实验环境中，当用户尝试访问IIS网站时，我们可以抓取网络流量以观察整个过程。具体步骤如下：

1. 使用Kerberos认证方式请求IIS服务：
   ```powershell
   Invoke-WebRequest http://iis.lab.local -UseDefaultCredentials -UseBasicParsing
   ```

2. 在Wireshark中查看捕获的数据包，重点关注TGS-REQ和TGS-REP部分。

3. TGS-REQ数据包显示了用户正在请求特定SPN的服务票据；而TGS-REP则包含了使用服务账户密码加密的服务票据。

4. 利用`setspn.exe /Q HTTP/iis.lab.local`命令可确定提供指定SPN的确切账户。

5. 将截获的服务票据转换成适合密码破解工具（如John the Ripper）处理的格式：
   ```
   $krb5tgs$<version>$<username>$<realm>$<spn>*<et_type><kvno>*<enc_part>
   ```

6. 对于示例中的数据，最终形成的字符串可能类似于：
   ```
   $krb5tgs$23$*iis_svc$LAB.LOCAL$HTTP/iis.lab.local*$0F6FC474DB169AA8CE9B5E626DAACC9D$1A346CE3F66C52976F53831AA24A1B217CDF0D68A0EB87FEE00CFD32F544BF83EBB6416732522B12232DD6935EAC076B439F56E6CB7FA6C37D984D132E2D2CB65CA399CD5E44EB2EB41F12C40F9044B40E3EA914278C8A3098BABACF49AB46E776D1413EF63ABCDF6418D2DB9241B2FDD9309346EC59AF20A82FD6DAEA9510C1DFD1A9E8D99C59FF72E985057BA0D18394B0A7CB1BD74F8D436A3DD780175A0C6BCAD9E46570A476AB9913B561EE481AD8C33A3C81CED055E959F08A52EBA7A342F53183E1531BE8EC2D28C7ECFA32F98DBC7FF87B4E5C79824F3868D38CE09010960726D58CFBFC88C9D34AB199169F39010AA4AAB92B6EA40F875963D518311B3F079D97B65FE9768C9A4EE50F7C16D525FDC081CE359A0B0FE5FB18D8D8690D8F88B010BEF4F28DC151A4137272AE9EACA9053406C0DDEAE453196E3B6C28B8359724BFC089B772CBAE093BF88ABC070D12B0FF2E721D7B8B10B822BFB514091EFFAF3F5FA8C286A9E45BF76BA171E6CABEB3DDADC297185C51A295855B8CFA8062BD6770093355C32690FD184D6EAE2B66EA1F553CBC7679681DB5089FDB23329EFE59DE807E657A98CCC0C2D95EAAC9F363D5B8C9B8A23AAB680C328B019AE99440A5D8795014BE22F6739A4F77874E94196F010C012F9A4A587570C38874AD7F8B9EC554FB865752A5F3DD4F785C9AF54031100CE580DFADF4C70FF11839647FC288FCE8D00BBCB680E02A46230ECB0530BA1771FB8485BA17F5218852C5CDFC769B89D77B37802CC6D22E6BA944F6E4B565D8D04418C44BF10E06294FD58913CA6D206BB6E46F15B3ABFC09695F5FBAB81D2E743AC19B24716D9D6CB6BAE65674F5CDF1935D1413A4BE6D96EAFAF65CFA361DECC0AB1E12998B5C26B6AD38C8077FD149CDEDA227C4C68F19FBF22B23E7E84581A64A413C1C983E01B56C2000656B4AAD8C67260FC0142EECCD96D624FA284B619D11E797AF2D730A5998D9E6D9F4FEF58A847D7D9B804BE2925BEAE627A0A9F335072F97F214A24DB58CF5E2E74F0EEFF1A43F1EC1B88C0110F3C2ABAAC0D3E954A42B550C37CF84BABE6E85EC4E0885EB8309A4C5E2A1BB473B332FF5C31C0B4C32DB507C1ECA5B7AE607D2423EE1E7F07361229E0AB2678CFBD07AFFFC5E989C5AB1821AC2F524083258D3F0CA7E7F8250BE3F7CC72CF636B098A3C9B3F4E289FD81A9B3C33BFA63ED8813BBC12205134ADD9FB8548312B734C921A2CF8A1687AF7EE022B0F57BBF0F8D8F17952614CB288B95DF3FE4F03D20B83227328603DAFB264537EB0CACDA18DE21AA99E07600030424EDB41FC3C8161238971BF62AF99DB8E2D438AF06F9D8FEEFF3EDB6A4D4F0A6FB5DFDBE99B1ED454D6FF3DC508C45ED430923212A088E6200B2076DA509888EDD32FCA946A215C8934DB7A3B5AC6BED10E4A114F2F132608DBE236CBA73CBCFFC024FB500E96C3D766CA7F4083DED3666C2B7DCD290F65F7E80FF70FA575777A845FBF7AF05B38DFB1CCD7ACCC0398F8DBF532E28DC6BC0EC49D18F2753CAEC5912693A0B6050F2BFCE72F5160847DCFC78D580609007DDBDF1F338C61C13E7B62FCEC6E51D1C0CD1EC0167E40042
   ```

通过以上步骤，您可以获得所需的服务账户密码。希望这篇文章能让您对Kerberoasting攻击有了更深入的理解。如果您有任何反馈或问题，请随时联系[我](https://blog.xpnsec.com/about/)。