Penetration Testing with Kali Linux
13.1.1 SSH and RDP ...................................................................................................................... 381
13.1.2 HTTP POST Login Form ................................................................................................... 383
13.2 Password Cracking Fundamentals ......................................................................................... 386
13.2.1 Introduction to Encryption, Hashes and Cracking ...................................................... 387
13.2.2 Mutating Wordlists ............................................................................................................ 392
13.2.3 Cracking Methodology ..................................................................................................... 398
13.2.4 Password Manager ........................................................................................................... 399
13.2.5 SSH Private Key Passphrase ........................................................................................... 404
13.3 Working with Password Hashes .............................................................................................. 408
13.3.1 Cracking NTLM .................................................................................................................. 409
y
13.3.2 Passing NTLM .................................................................................................................... 415
13.3.3 Cracking Net-NTLMv2 ...................................................................................................... 419
k
13.3.4 Relaying Net-NTLMv2 ....................................................................................................... 424
13.4 Wrapping Up ............................................................s.................................................................... 427
14 Fixing Exploits .................................................................................................................................. 428
o
14.1 Fixing Memory Corruption Exploits ......................................................................................... 429
14.1.1 Buffer Overflow in a Nutshell ........................................................................................... 429
n
14.1.2 Importing and Examining the Exploit ............................................................................. 433
14.1.3 Cross-Compiling Exploit Code ........................................................................................ 435
i
14.1.4 Fixing the Exploit ...z............................................................................................................. 436
14.1.5 Changing the Overflow Buffer ......................................................................................... 443
D
14.2 Fixing Web Exploits .................................................................................................................... 445
14.2.1 Considerations and Overview ......................................................................................... 445
14.2.2 Selecting the Vulnerability and Fixing the Code .......................................................... 445
14.2.3 Troubleshooting the “index out of range” Error ........................................................... 449
14.3 Wrapping Up ................................................................................................................................ 452
15 Locating Public Exploits ................................................................................................................. 453
15.1 Getting Started ............................................................................................................................ 453
15.1.1 A Word of Caution ............................................................................................................. 453
15.2 Online Exploit Resources ........................................................................................................... 454
15.2.1 The Exploit Database ........................................................................................................ 455
15.2.2 Packet Storm ...................................................................................................................... 456
15.2.3 GitHub .................................................................................................................................. 457
15.2.4 Google Search Operators ................................................................................................. 459
15.3 Offline Exploit Resources .......................................................................................................... 460
15.3.1 Exploit Frameworks .......................................................................................................... 460
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 9
Made in Morocco
Penetration Testing with Kali Linux
15.3.2 SearchSploit ........................................................................................................................ 461
15.3.3 Nmap NSE Scripts ............................................................................................................. 465
15.4 Exploiting a Target ...................................................................................................................... 466
15.4.1 Putting It Together ............................................................................................................. 466
15.5 Wrapping Up ................................................................................................................................ 471
16 Windows Privilege Escalation ....................................................................................................... 472
16.1 Enumerating Windows .............................................................................................................. 472
16.1.1 Understanding Windows Privileges and Access Control Mechanisms .................. 473
16.1.2 Situational Awareness ...................................................................................................... 476
16.1.3 Hidden in Plain View .......................................................................................................... 485
y
16.1.4 Information Goldmine PowerShell ................................................................................. 491
16.1.5 Automated Enumeration .................................................................................................. 496
k
16.2 Leveraging Windows Services ................................................................................................. 499
16.2.1 Service Binary Hijacking ...............................s.................................................................... 500
16.2.2 Service DLL Hijacking ....................................................................................................... 507
o
16.2.3 Unquoted Service Paths ................................................................................................... 514
16.3 Abusing Other Windows Components ................................................................................... 520
n
16.3.1 Scheduled Tasks ............................................................................................................... 520
16.3.2 Using Exploits ..................................................................................................................... 523
i
16.4 Wrapping Up ...................z............................................................................................................. 527
17 Linux Privilege Escalation .............................................................................................................. 528
D
17.1 Enumerating Linux ...................................................................................................................... 528
17.1.1 Understanding Files and Users Privileges on Linux .................................................... 528
17.1.2 Manual Enumeration ......................................................................................................... 529
17.1.3 Automated Enumeration .................................................................................................. 544
17.2 Exposed Confidential Information ........................................................................................... 546
17.2.1 Inspecting User Trails ....................................................................................................... 546
17.2.2 Inspecting Service Footprints ......................................................................................... 550
17.3 Insecure File Permissions ......................................................................................................... 551
17.3.1 Abusing Cron Jobs ............................................................................................................ 551
17.3.2 Abusing Password Authentication ................................................................................. 553
17.4 Insecure System Components ................................................................................................. 554
17.4.1 Abusing Setuid Binaries and Capabilities ..................................................................... 554
17.4.2 Abusing Sudo ..................................................................................................................... 557
17.4.3 Exploiting Kernel Vulnerabilities ...................................................................................... 559
17.5 Wrapping Up ................................................................................................................................ 562
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 10
Made in Morocco
Penetration Testing with Kali Linux
18 Port Redirection and SSH Tunneling ........................................................................................... 563
18.1 Why Port Redirection and Tunneling? .................................................................................... 563
18.2 Port Forwarding with Linux Tools ........................................................................................... 564
18.2.1 A Simple Port Forwarding Scenario ............................................................................... 565
18.2.2 Setting Up the Lab Environment ..................................................................................... 567
18.2.3 Port Forwarding with Socat ............................................................................................. 571
18.3 SSH Tunneling ............................................................................................................................. 577
18.3.1 SSH Local Port Forwarding ............................................................................................. 578
18.3.2 SSH Dynamic Port Forwarding ....................................................................................... 584
18.3.3 SSH Remote Port Forwarding ......................................................................................... 589
y
18.3.4 SSH Remote Dynamic Port Forwarding ........................................................................ 592
18.3.5 Using sshuttle ..................................................................................................................... 596
k
18.4 Port Forwarding with Windows Tools .................................................................................... 597
18.4.1 ssh.exe .............................................................s.................................................................... 598
18.4.2 Plink ...................................................................................................................................... 601
o
18.4.3 Netsh .................................................................................................................................... 607
18.5 Wrapping Up ................................................................................................................................ 613
n
19 Tunneling Through Deep Packet Inspection .............................................................................. 614
19.1 HTTP Tunneling Theory and Practice ..................................................................................... 614
i
19.1.1 HTTP Tunneling Fuzndamentals ...................................................................................... 614
19.1.2 HTTP Tunneling with Chisel ............................................................................................ 615
D
19.2 DNS Tunneling Theory and Practice ....................................................................................... 621
19.2.1 DNS Tunneling Fundamentals ........................................................................................ 621
19.2.2 DNS Tunneling with dnscat2 ........................................................................................... 629
19.3 Wrapping Up ................................................................................................................................ 634
20 The Metasploit Framework ........................................................................................................... 635
20.1 Getting Familiar with Metasploit .............................................................................................. 636
20.1.1 Setup and Work with MSF ............................................................................................... 636
20.1.2 Auxiliary Modules .............................................................................................................. 641
20.1.3 Exploit Modules .................................................................................................................. 647
20.2 Using Metasploit Payloads ....................................................................................................... 653
20.2.1 Staged vs Non-Staged Payloads .................................................................................... 654
20.2.2 Meterpreter Payload ......................................................................................................... 655
20.2.3 Executable Payloads ......................................................................................................... 663
20.3 Performing Post-Exploitation with Metasploit ...................................................................... 666
20.3.1 Core Meterpreter Post-Exploitation Features .............................................................. 667
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 11
Made in Morocco
Penetration Testing with Kali Linux
20.3.2 Post-Exploitation Modules ............................................................................................... 672
20.3.3 Pivoting with Metasploit ................................................................................................... 677
20.4 Automating Metasploit .............................................................................................................. 684
20.4.1 Resource Scripts ................................................................................................................ 684
20.5 Wrapping Up ................................................................................................................................ 687
21 Active Directory Introduction and Enumeration ........................................................................ 689
21.1 Active Directory - Introduction .................................................................................................. 689
21.1.1 Enumeration - Defining our Goals .................................................................................. 691
21.2 Active Directory - Manual Enumeration .................................................................................. 691
21.2.1 Active Directory - Enumeration Using Legacy Windows Tools ................................ 691
y
21.2.2 Enumerating Active Directory using PowerShell and .NET Classes ........................ 694
21.2.3 Adding Search Functionality to our Script .................................................................... 699
k
21.2.4 AD Enumeration with PowerView ................................................................................... 708
21.3 Manual Enumeration - Expanding our Repertoisre ................................................................ 711
21.3.1 Enumerating Operating Systems ................................................................................... 711
o
21.3.2 Getting an Overview - Permissions and Logged on Users ........................................ 713
21.3.3 Enumeration Through Service Principal Names ......................................................... 719
n
21.3.4 Enumerating Object Permissions ................................................................................... 721
21.3.5 Enumerating Domain Shares .......................................................................................... 725
i
21.4 Active Directory - Automzated Enumeration ........................................................................... 729
21.4.1 Collecting Data with SharpHound .................................................................................. 729
D
21.4.2 Analysing Data using BloodHound ................................................................................. 732
21.5 Wrapping Up ................................................................................................................................ 745
22 Attacking Active Directory Authentication .................................................................................. 746
22.1 Understanding Active Directory Authentication .................................................................... 746
22.1.1 NTLM Authentication ........................................................................................................ 746
22.1.2 Keberos Authentication .................................................................................................... 748
22.1.3 Cached AD Credentials ..................................................................................................... 751
22.2 Performing Attacks on Active Directory Authentication ..................................................... 756
22.2.1 Password Attacks ............................................................................................................. 757
22.2.2 AS-REP Roasting ............................................................................................................... 761
22.2.3 Kerberoasting ..................................................................................................................... 765
22.2.4 Silver Tickets ...................................................................................................................... 768
22.2.5 Domain Controller Synchronization ............................................................................... 773
22.3 Wrapping Up ................................................................................................................................ 776
23 Lateral Movement in Active Directory ......................................................................................... 777
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 12
Made in Morocco
Penetration Testing with Kali Linux
23.1 Active Directory Lateral Movement Techniques ................................................................... 777
23.1.1 WMI and WinRM ................................................................................................................ 778
23.1.2 PsExec ................................................................................................................................. 784
23.1.3 Pass the Hash .................................................................................................................... 785
23.1.4 Overpass the Hash ............................................................................................................ 786
23.1.5 Pass the Ticket ................................................................................................................... 791
23.1.6 DCOM ................................................................................................................................... 794
23.2 Active Directory Persistence ..................................................................................................... 796
23.2.1 Golden Ticket ...................................................................................................................... 796
23.2.2 Shadow Copies .................................................................................................................. 801
y
23.3 Wrapping Up ................................................................................................................................ 803
24 Assembling the Pieces ................................................................................................................... 805
k
24.1 Enumerating the Public Network ............................................................................................. 805
24.1.1 MAILSRV1 .......................................................s.................................................................... 806
24.1.2 WEBSRV1 ............................................................................................................................ 810
o
24.2 Attacking a Public Machine ...................................................................................................... 815
24.2.1 Initial Foothold .................................................................................................................... 816
n
24.2.2 A Link to the Past ............................................................................................................... 819
24.3 Gaining Access to the Internal Network ................................................................................. 824
i
24.3.1 Domain Credentialzs ........................................................................................................... 825
24.3.2 Phishing for Access .......................................................................................................... 827
D
24.4 Enumerating the Internal Network .......................................................................................... 832
24.4.1 Situational Awareness ...................................................................................................... 832
24.4.2 Services and Sessions ...................................................................................................... 841
24.5 Attacking an Internal Web Application ................................................................................... 851
24.5.1 Speak Kerberoast and Enter ............................................................................................ 851
24.5.2 Abuse a WordPress Plugin for a Relay Attack ............................................................. 853
24.6 Gaining Access to the Domain Controller .............................................................................. 858
24.6.1 Cached Credentials ........................................................................................................... 858
24.6.2 Lateral Movement ............................................................................................................. 860
24.7 Wrapping Up ................................................................................................................................ 861
25 Trying Harder: The Challenge Labs .............................................................................................. 863
25.1 PWK Challenge Lab Overview .................................................................................................. 863
25.1.1 STOP! Do This First ........................................................................................................... 863
25.1.2 Challenge Labs 1-3 ............................................................................................................ 863
25.1.3 Challenge Labs 4-6 ............................................................................................................ 864
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 13
Made in Morocco
Penetration Testing with Kali Linux
25.2 Challenge Lab Details ................................................................................................................ 865
25.2.1 Client-Side Simulations .................................................................................................... 865
25.2.2 Machine Dependencies .................................................................................................... 866
25.2.3 Machine Vulnerability ........................................................................................................ 866
25.2.4 Machine Ordering .............................................................................................................. 866
25.2.5 Routers/NAT ....................................................................................................................... 867
25.2.6 Passwords .......................................................................................................................... 867
25.3 The OSCP Exam Information ................................................................................................... 867
25.3.1 OSCP Exam Attempt ......................................................................................................... 867
25.3.2 About the OSCP Exam ...................................................................................................... 868
y
25.3.3 Metasploit Usage - Challenge Labs vs Exam ............................................................... 868
25.4 Wrapping Up ................................................................................................................................ 869
k
s
o
n
i
z
D
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 14
Made in Morocco
Penetration Testing with Kali Linux
1 Copyright
Please take the time to read our formal copyright statement below. Before you do, we would like
to explain that this publication is for your own personal use only. Any copying of this publication
or sharing of all or part of this publication with any third party is in breach of (a) our intellectual
property rights (b) the contractual terms you accept when you register with us (c) our Academic
Policy.
This includes:
• Making this publication available to other people by posting it on any third party platform,
repository or social media site
• Unintentional sharing of this publication because you have not tyaken enough care to protect
it
• Using all or part of this publication for any purpose other tkhan your own personal training
including to provide or inform the content of any other training course or for any other
commercial purpose.
s
Our Academic Policy can be found at https://www.offsec.com/legal-docs/
o
In our discretion, if we find you in breach:
• We will revoke all existing OffSec certifnication(s) you have obtained
• We will disqualify you for life from any OffSec courses and exams
i
• We will disqualify you for life from making future OffSec purchases
z
Copyright © 2023 OffSec Services Ltd. All rights reserved — no part of this publication/video may
be copied, published, shared, redistributed, sub-licensed, transmitted, changed, used to create
D
derivative works or in any other way exploited without the prior written permission of OffSec.
The following pages contains the lab exercises for the course and should be attempted only
inside the OffSec hosted lab environment. Please note that most of the attacks described in the
lab guide would be illegal if attempted on machines that you do not have explicit permission to
test and attack. Since the OffSec lab environment is segregated from the Internet, it is safe to
perform the attacks inside the lab. OffSec does not authorize you to perform these attacks
outside its own hosted lab environment and disclaims all liability or responsibility for any such
actions.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 15
Made in Morocco
Penetration Testing with Kali Linux
2 Penetration Testing with Kali Linux: General Course
Information
Welcome to the Penetration Testing with Kali Linux (PWK) course!
PWK was created for System and Network Administrators and security professionals who would
like to take a serious and meaningful step into the world of professional penetration testing. This
course will help you better understand the attacks and techniques that are used by malicious
entities against computers and networks.
The ultimate purpose of the course is to provide an understanding of, and intuition for, these
attacks at a deep enough level to be able to replicate them. By leveraging the ability to perform
them, we can develop a powerful insight into what kind of securityy defenses are important and
how to improve them. Congratulations on taking that first step. We’re excited you’re here.
k
PWK consists of two types of overarching learning modalities: Learning Modules and Challenge