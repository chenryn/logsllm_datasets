距离
下一跳路由器
Net1
4
R4
Net1
4
R4
Net2
5
R4
Net2
5
R4
Net3
2
R4
Net3
2
R4
...
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 182
182
6.路由选择协议
6.2 内部网关协议 RIP
现场测试讨论举例：路由表更新。
增加跳数以后
从 C 来的 RIP 报文
从 C 来的 RIP 报文
Net1：没有新信息，不变
Net2：相同的下一跳，替换
Net2
4
Net2
５９５４６
Net3:一条新路由，增加
Net3
8
Net3
Net6:不同的下一跳，新跳数小，替换
Net6
４
Net6
Net8:不同的下一跳，跳数相同，不变
Net8
３
Net8
Net9
5
Net9：不同的下一跳，新跳数大，不变
Net9
新路由表
旧路由表
Net1
7
ACCCEF
Net1
7
Net2
5
Net2
C
Net3
9
8
F
Net6
更新算法
Net6
5
Net8
4
E
Net8
F
4
Net9
4
Net9
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 183
183
6.路由选择协议
6.2 内部网关协议 RIP
口RIP2协议的报文格式：
4字节
地址族标识符
路由标记
4字节
网络地址
路由信息
(20字节/路由)
命令
版本
必为 0
子网掩码
可重复出现
下一跳路由器地址
最多25个
距离 (1-16)
UDP
首部
路由部分
RIP2支持无分类域间路
首部
由选择CIDR，提供简单
RIP报文
的鉴别，支持多播。
IP
首部
RIP2的报文用使用
UDP传送
UDP用户数据报
使用UDP端口520。
IP 数据报
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 184
184
6.路由选择协议
6.2内部网关协议RIP
RIP2 报文:
■组成：首部和路由2个部分组成。
路由部分：由若干个路由信息组成，每个路由信息共20个字节。
口地址族标识符（又称为地址类别）字段用来标志所使用的地址协议。
口路由标记填入自治系统的号码。
口后面为具体路由，指出某个网络地址、该网络的子网掩码、下一跳路由器地址以
及到此网络的距离。
n.edu.c
---
## Page 185
185
6.路由选择协议
6.2内部网关协议RIP
口RIP2报文 ：
1一个RIP 报文最多可包括 25个路由，因而RIP 报文的最大长度是4+20
x25=504字节。如超过，必须再用一个 RIP 报文来传送。
RIP2具有简单的鉴别功能。
·若使用鉴别功能，则将原来写入第一个路由信息（20个字节）的位置用作鉴别
口在鉴别数据之后才写入路由信息，但这时最多只能再放入24个路由信息。
---
## Page 186
186
6.路由选择协议
6.2内部网关协议RIP
口RIP 协议特点：
■特点：
好消息传播得快，坏消息传播得慢
口当网络出现故障时，要经过比较长的时间才能将此信息、（坏消息）传送到所有的
路由器。慢收敛。
■优点：
口实现简单，开销较小。
缺点：
口网络规模有限。最大距离为15（16表示不可达）。
口交换的路由信息为完整路由表，开销较大。
口坏消息传播得慢，收敛时间过长。
(慢收敛)
n.edu.cr
---
## Page 187
187
6.路由选择协议
6.3内部网关协议OSPF
互联网路由选择协议
域内路由选择
域间路由选择
内部网关协议（IGP)
外部网关协议（EGP)
距离向量
链路状态
路径向量
(Distance Vector)
(Link State)
(path vector)
RIP
OSPF
BGP
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 188
188
6.路由选择协议
6.3内部网关协议OSPF
升放最短路径优先
（Open Shortest Path First，OSPF）是为了克服 RIP
的缺点，在1989年开发出来的。
原理很简单，但实现很复杂。
1开放：表明OSPF协议不是受某一家厂商控制，而是公开发表的。
■最短路径优先：使用了Djkstra提出的最短路径算法SPF。
■采用分布式的链路状态协议（linkstateprotocol)。*
现在使用OSPFv2。
口OSPF只是协议名字，并不表示其他路由选择协议不是"最短路径优先"。
■实际上，所有的在自治系统内部使用的路由选择协议都是要寻找最短路径的。
---
## Page 189
189
6.路由选择协议
6.3内部网关协议OSPF
口OSPF协议最主要的特征就是使用分布式的链路状态协议
(Link State
ProtocOl），而不是像RIP那样的距离向量协议。
口OSPF的三个主要特点：
■采用洪泛法(flooding)，向本自治系统中所有路由器发送信息。
■发送的信息是与本路由器相邻的所有路由器的链路状态，但这只是路由器所
知道的部分信息。
口链路状态：说明本路由器都和哪些路由器相邻，以及该链路的度量 (metric)。
■当链路状态发生变化或每隔一段时间（如30分钟），路由器才用洪泛法向所
有路由器发送此信息。
1.edu.c
---
## Page 190
190
6.路由选择协议
6.3内部网关协议OSPF
口链路状态数据库（Link-stateDatabase）:
■由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建
立一个链路状态数据库。
这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称
为链路状态数据库的同步）。
每个路由器使用链路状态数据库中的数据构造自己的路由表
口例如，使用Dijkstra的最短路径路由算法，计算得出自己的路由表。
口链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。
口重要优点：OSPF更新过程收敛速度快
---
## Page 191
191
6.路由选择协议
6.3内部网关协议OSPF
口OSPF 区域（area）:
■为了使OSPF能够用于规模很大的网络，○SPF将一个自治系统再划分为若干
个更小的范围，叫作区域
■每一个区域都有一个32位的区域标识符（用点分十进制表示）。
1区域也不能太大，在一个区域内的路由器最好不超过200个。
河南中医药大学信息技
---
## Page 192
192
自治系统 AS
主干区域0.0.0.0
至其他自治系统
R-3
R-6
R-1
Net-2
Net-1
R-7
R-2
Net-6
R-5
Net-3
区域 0.0.0.1
Net-73
R-9
R-4
Net-8
区域边界路由器ABR
区域 0.0.0.3
R-3 R-4 R-7
Net-5
Net-4
主干路由器 BR (backbone router)
R-8
R-3 R-4 R-5 R-6 R-7
自治系统边界路由器ASBR
区域 0.0.0.2
(AS border router)
R-6
---
## Page 193
193
6.路由选择协议
6.3内部网关协议OSPF
口OSPF划分区域优点和缺点：
■优点：
分层次划分区域的好处：
口减少了整个网络上的通信量。
口减少了需要维护的状态数量。
使每一个区域内部交换路由
缺点：
信息的通信量大大减小，因
口交换信息的种类增多了。
而使OSPF协议能够用于规
使 OSPF协议更加复杂了
模很大的自治系统中。
n.edu.cr
---
## Page 194
194
6.路由选择协议
6.3内部网关协议OSPF
口OSPF划分区域优点和缺点：
■其他特点：
口对于不同类型的业务可计算出不同的路由。
可实现多路径间的负载均衡（load balancing）。
口所有在OSPF路由器之间交换的分组都具有鉴别的功能。
口支持可变长度的子网划分和无分类编址CIDR。
口32位的序号，序号越大状态就越新。
·全部序号空间在600年内不会产生重复号。
河南中医药大学信息技术学院
n.edu.cr
---
## Page 195
195
6.路由选择协议
6.3内部网关协议OSPF
口OSPF的五种分组类型：
■类型1：问候（Hello)分组。
■类型2：数据库描述（DatabaseDescription）分组。
■类型3：链路状态请求（Link State Request）分组。
■类型4：链路状态更新（Link State Update）分组。
口用洪泛法对全网更新链路状态。
类型5：链路状态确认（Link State Acknowledgment）分组。
---
## Page 196
196
6.路由选择协议
6.3内部网关协议OSPF
口OSPF 数据报:
OSPF不用UDP，而是直接用IP数据报传送
■OSPF构成的数据报很短：
口可减少路由信息的通信量
口不必将长的数据报分片传送。
m.edu.cn
---
## Page 197
197
6.路由选择协议
6.3内部网关协议OSPF
OSPF 数据报：位0
8
16
31
版本
类型
分组长度
路由器
标识符
区域标
识符
检验和
鉴
别类型
鉴
别
鉴
别
IP数据报首
—24字节-
部的协议字
OSPF分组首部
类型1至类型5的OSPF分组
段值为89
IP数据报首部
OSPF 分组
IP数据报
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 198
198
6.路由选择协议
6.3内部网关协议OSPF
口OSPF 工作过程
■第1：确定邻站可达
口相邻路由器每隔10秒钟要交换一次问候分组。
口若有 40 秒钟没有收到某个相邻路由器发来的问候分组，则可认为该相邻路由器是
不可达的。
■第2：同步链路状态数据库。
口同步：指不同路由器的链路状态数据库的内容是一样的。
口两个同步的路由器叫做完全邻接的（fullyadjacent）路由器。
口不是完全邻接的路由器：虽然在物理上是相邻的，但其链路状态数据库并没有达
到一致。
河南中医药大学信息技术学院互联网技术教学团队／https://int
cm.edu.cr
---
## Page 199
199
6.路由选择协议
6.3内部网关协议OSPF
口OSPF 工作过程
■第3：更新链路状态。
口只要链路状态发生变化，路由器就使用链路状态更新分组，采用可靠的洪泛法向
全网更新链路状态。
口为确保链路状态数据库与全网的状态保持一致，○SPF还规定：每隔一段时间，如
30分钟，要刷新一次数据库中的链路状态。
口〇SPF链路状态只涉及相邻路由器，与整个互联网的规模并无直接关系，因此当互
联网规模很大时，OSPF协议要比距离向量协议RIP好得多。
口○SPF没有"坏消息传播得慢"的问题，收敛速度快。
---
## Page 200
200
6.路由选择协议
6.3内部网关协议OSPF
口OSPF工作过程：
问候
确定可达性
问候
数据库描述
数据库描述
达到数据库的同步
数据库描述
数据库描述
链路状态请求
新情况下的同步
链路状态更新
链路状态确认
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 201
201
6.路由选择协议
更新报文
OSPF使用
可靠的洪泛法
R
发送更新分组
详见P167
ACK报文
R
河南中医药大学信息技术学院互联网技术教学团队
/ https://internet.hactcm.edu.cn
---
## Page 202
202
DR (designated router)
·若N个路由器连接在一个以太网上，则每个路由器要向其他
（N-1）个路由器发送链路状态信息，因而共有N（N-1）个链路
状态要在以太网上传送。
·多点接入的局域网采用了指定的路由器DR（designated
router）的方法，使广播的信息量大大减少。
·指定的路由器代表该局域网上所有的链路向连接到该网络上的
各路由器发送状态信息。
---
## Page 203
203
6.路由选择协议
6.4外部网关协议BGP