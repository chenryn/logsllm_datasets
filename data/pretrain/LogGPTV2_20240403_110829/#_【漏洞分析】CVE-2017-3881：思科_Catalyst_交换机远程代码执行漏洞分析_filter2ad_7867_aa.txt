# 漏洞分析：CVE-2017-3881 - 思科Catalyst交换机远程代码执行漏洞

## 译文声明
本文为翻译文章，原文来源：artkond.com  
原文地址：[链接]  
译文仅供参考，具体内容和含义以原文为准。

**翻译：shan66**  
预估稿费：200 RMB  
投稿方式：发送邮件至 linwei#360.cn 或登录网页版在线投稿

## 前言
如果您的思科Catalyst交换机启用了Telnet服务，请务必小心。本文将介绍一种针对运行最新固件的Catalyst 2960交换机的远程代码执行（RCE）漏洞的概念验证攻击方法。您可以从[这里](https://github.com/artkond/cisco-rce/)下载具体的漏洞利用代码。本文详细描述了2017年3月7日中情局泄露文件中的一个安全漏洞，并提供了详细的开发流程。尽管思科公司在2017年3月17日公开披露了该漏洞，但截至本文撰写时，仍未发布补丁。不过，可以通过禁用Telnet并改用SSH来缓解这一风险。

## CIA Vault 7 泄露
2017年3月7日，维基解密公布了中央情报局的一系列文件，其中包括一个影响多款思科交换机的远程代码执行漏洞。此漏洞在泄露文档中的代号为ROCEM。虽然泄露的技术细节较少，但仍引起了广泛关注。

### 交互模式
Vault 7 文档展示了实际的漏洞利用代码测试过程，但未泄露源代码。交互模式通过Telnet发送有效载荷，并在同一Telnet连接上下文中立即提供命令Shell给攻击者。以下是相关命令示例：
```bash
root@debian:/home/user1/ops/adverse/adverse-1r/rocem# ./rocem_c3560-ipbase-mz.122-35.SE5.py -i 192.168.0.254
[+] Validating data/interactive.bin
...
[*] Starting interactive session
User Access Verification
Password:
MLS-Sth#
```

### 设置模式
设置模式允许修改交换机内存，以便在未来无需密码即可建立Telnet连接。以下是从泄漏文档中提取的相关命令：
```bash
root@debian:/home/user1/ops/adverse/adverse-1r/rocem# ./rocem_c3560-ipbase-mz.122-35.SE5.py -s 192.168.0.254
...
[+] Done
root@debian:/home/user1/ops/adverse/adverse-1r/rocem#
Verified I could telnet and rx priv 15 without creds:
root@debian:/home/user1/ops/adverse/adverse-1r/rocem# telnet 192.168.0.254
Trying 192.168.0.254...
Connected to 192.168.0.254.
Escape character is '^]'.
MLS-Sth#
MLS-Sth#show priv
Current privilege level is 15
MLS-Sth#
```

### Telnet调试输出
在研究此漏洞时，我们发现了一段非常有用的Telnet调试输出信息：
```plaintext
000467: Jun 3 13:54:09.330: TCP2: Telnet received WILL TTY-SPEED (32) (refused)
...
000482: Jun 3 13:54:09.623: Telnet2: recv SB 36 0 ^CCISCO_KITS^Ap
```
请注意最后一行中的`CISCO_KITS`选项，这是一个重要的字符串。

## 思科漏洞报告
思科公司于2017年3月17日发布了关于其交换机中存在的漏洞的公告。该报告基于Vault 7中的文档，指出Cisco IOS和Cisco IOS XE软件中的集群管理协议（CMP）处理代码存在漏洞，可能允许未经身份验证的远程攻击者重新加载受影响的设备或远程执行具有更高权限的代码。

集群管理协议内部使用Telnet作为集群成员之间的信令和命令协议。此漏洞是由于两个因素共同导致的：
1. 未将与CMP相关的Telnet选项限制在集群成员之间的内部本地通信中。
2. 未正确处理畸形的与CMP相关的Telnet选项。

简而言之，该漏洞允许攻击者通过Telnet服务在目标交换机上远程执行代码。为了进一步研究，我们需要更多详细信息。因此，我决定深入研究思科集群管理协议。

## 交换机集群
为了研究这个漏洞，我配置了两台Catalyst 2960交换机。集群技术将交换机设置为主从关系，主交换机能够在从交换机上获得特权命令Shell。如思科报告所述，Telnet被用作集群成员之间的命令协议。

以下是主交换机的配置示例：
```plaintext
cluster enable CLGRP 0
cluster member 1 mac-address xxxx.xxxx.xxxx
```
这会将附近的交换机添加为集群的从交换机。`rcommand` 允许从主交换机的接口上获得从设备的命令接口。

### 集群成员间的通信
让我们看看集群成员之间的通信。以下是主交换机的配置：
```plaintext
catalyst1>rcommand 1
catalyst2>who
    Line       User       Host(s)              Idle       Location
*  1 vty 0                idle                 00:00:00 10.10.10.10
  Interface      User        Mode                     Idle     Peer Address
```
通过观察`rcommand`生成的流量，我们可以看到Telnet流量被封装在第2层的LLC数据包中。这些“IP”数据包包含Telnet会话的有效TCP帧。Telnet会话通常出现在Telnet选项协商之前，包括终端大小、终端类型等信息。更多信息请参考RFC。

### 固件分析
固件位于交换机的flash:.bin中。可以使用内置的FTP客户端将其传输到任意FTP服务器。接下来，我们使用`binwalk`来分析和提取文件内容：
```bash
$ binwalk -e c2960-lanbasek9-mz.122-55.SE1.bin 
DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
112           0x70            bzip2 compressed data, block size = 900k
```
为了便于对获取的二进制数进行静态分析，我们找到了固件加载的偏移量。在引导过程中，该偏移量将打印输出到串行控制台中：
```plaintext
Loading "flash:c2960-lanbasek9-mz.122-55.SE1.bin"...@@@@@@@@@@@@@@@@@@@@@@
File "flash:c2960-lanbasek9-mz.122-55.SE1.bin" uncompressed and installed,
entry point: 0x3000
executing...
```

通过以上步骤，我们可以更深入地理解该漏洞及其潜在风险。希望本文能为您提供有价值的参考。