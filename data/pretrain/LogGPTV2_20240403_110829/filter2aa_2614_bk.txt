API网关作为一个基础组件在应用技术架构中被使用已经越来越
多，很多企业和厂商也纷纷推出自家的商业版API网关产品。本节将结
合花椒直播使用开源Kong API网关实践进行分析，为读者讲述该使用案
例。
1.花椒直播Kong引入背景
花椒直播是国内一家知名的移动社交直播平台，2020年2月25日公
众号“花椒技术”发布篇名为《花椒直播Kong应用实践》的原创文章，讲
述了花椒直播内部使用Kong作为API网关的实践过程，感兴趣的读者可
以阅读原文了解更多细节。在这里，结合此文中的内容，从Kong实践
的角度分析其应用过程。
每一次架构的调整或引入外部组件，都不是无缘由的，通常是存在
某些问题或期望通过架构的调整来解决某些问题。在花椒直播Kong应
用实践中，作者首先抛出了引入Kong之前面临的问题。
■ 
缺少统一的API管理工具问题。在PHP作为开发语言向Java的
Spring开发架构迁移的过程中，涉及版本的迭代发布、外部多个接口的
调用、日常维护的管理。这些工作需要一个统一代理工具来辅助技术人
员提高工作效率。
■ 微服务架构中安全机制实现问题。在微服务架构中，后端往往存
在多个细粒度的、单一的微服务业务组件，共同为前端提供业务能力。
如果每一个微服务都要去实现一套安全机制，比如接口鉴权、访问控
制、限流等，既耗费人力成本又增加了编码开发的复杂度。
■ 
持续集成能力的支撑问题。DevOps的工具化管道流程已深入人
心，通过CI/CD的持续集成能力，既能自动化地提高工作效率也能减少
人操作出错的概率。
正是由于这些原因，才使得花椒直播的技术人员选择Kong作为管
理工具，并将接口鉴权、访问控制、限流等安全机制融入其中，作为微
服务访问的统一入口。
2.花椒直播Kong部署架构
引入API网关之后，通常带来技术架构的调整。在API网关的部署
架构中，通常有如下4种方式：单节点独立部署、分布式集群部署、内
外部并行部署、混合云部署。
（1）单节点独立部署
顾名思义，单节点独立部署是指将API网关的各个组件作为一个整
体，部署在一台服务器上，同时，各个组件之间也不存在备份节点。
在业务系统的生产环境中，采用此架构的情况比较稀少，大多数用于研
测环境，对API网关的可用性没有过高要求，即使宕机了几个小时也不
对业务造成多大影响。此时部署架构如图12-19所示。
●图12-19 API网关单节点独立部署示意图
（2）分布式集群部署
分布式集群部署在API网关的部署架构中极为常见，生产环境中，
需要考虑API的高并发和吞吐量，通常会采用集群化部署来提高API网
关自身的可用性。一个API网关产品，往往是由不同的产品组件组成
的，在集群化部署时，根据各个组件对外提供的功能的不同，区分考虑
哪些组件需要做分布式集群部署，哪些组件不需要做分布式集群部署。
一般来说，对于为外部提供API能力的组件需要分布式集群部署，而对
内部提供API维护和管理功能的组件不需要分布式集群部署。这种场景
下，API网关的部署架构如图12-20所示。
●图12-20 API网关分布式集群部署示意图
（3）内外部并行部署
内外部并行部署在大型互联网应用中也较为常见，它与分布式集群
部署比较接近。不同的是，根据API所提供服务对象的不同，划分为内
部API网关代理和外部API网关代理两个代理组件。内部API网关代理
负责管理后端微服务内部的各个API调用，更接近某个厂商的微服务网
关产品，相当于东西向流量的管控；而外部API网关代理负责管理外部
合作伙伴或第三方应用厂商的应用程序，对内部的各个API调用，相当
于南北向的流量管控。此场景下，API网关的部署架构如图12-21所示。
●图12-21 API网关内外部并行部署示意图
（4）混合云部署
混合云部署适合大型互联网应用在混合云架构下的部署方式，它
与内外部并行部署比较接近。不同的是，将内外部并行部署架构中的内
部API网关部署位置移动到云端，两个API网关各司其职，分别管理企
业内部和企业云端的API。此场景下，API网关的部署架构如图12-22所
示。
●图12-22 API网关混合云部署示意图
在花椒直播的Kong部署架构中，采用的是分布式集群部署，但由
于Kong自身不具备L4层负载均衡能力，故采取LVS技术，使用VIP作为
统一接入点。其部署架构图如12-23所示。
●图12-23 花椒直播Kong部署架构示意图
3.花椒直播Kong应用成效
在引入了Kong作为API网关之后，完美地解决了前文提及的问题。
在实践中，取得了预期的效果。
■ 统一了微服务入口，并将API安全机制纳入Kong管理，减少了各
个微服务实现的难度和冗余量。
■ 通过Dashboard管理工具管理API，便于对API的管理维护。
■ 与GitLab CI/CD流程打通，通过管道化完成从编码到发布的工
作，为蓝绿部署创建了条件。
■ 支持了动态扩容，在业务压力大的情况下，可以动态扩容Kong节
点。
除了这些可预期的效果外，使用API网关也会带来其他的好处。比
如性能与可用性上，除了Kong自身的集群部署外，也为后端服务的动
态扩容创造了可实施条件；可维护性上，从原来对API的纯手工管理到
使用网关后的可视化界面管理，对维护人员来说易用性提高了很多。
Kong对安全的意义只在使用Kong 
API网关的好处中占很小的一部分，
对API全生命周期的管理才是真正的意义所在。
12.4 小结
本章为读者介绍了API网关产品，从API网关产品自身的产品特
点、使用场景开始，详细讲述了Kong、WSO2 API管理平台的使用，并
以花椒直播Kong应用实践为案例，分析了API网关的使用背景和帮助企
业解决的问题。虽然涉及的内容较多，但总体来说大多是比较浅显的产
品分析。API网关是当前技术背景下，解决API安全问题最合适的产
品，却并不是最好的、唯一的产品。随着API技术使用场景的不断演
进，API网关也正在衍生出不同类型的API网关产品，比如云原生API网
关、Open API平台API网关、微服务网关等。最终可能像防火墙那样，
有L4层的网络防火墙，有L7层的Web应用防火墙，还有数据库层面的数
据库防火墙。消费者在使用时，只需要根据企业自身的技术路线特点，
选择不同的API网关即可使用，而不需面临使用一个产品来解决所有的
问题，偏偏这些问题又解决不了的苦恼。
第13章 API安全与数据隐私
自2017年6月1日施行《中华人民共和国网络安全法》之后，在政府
部门的强力监管和宣传下，数据隐私保护问题逐渐进入普通大众视野。
如果一家企业或组织一旦发生数据泄露事件，轻者影响企业声誉，重者
造成上市企业股价下跌。数据隐私保护，尤其是个人信息保护，成了企
业和个人关注的焦点。API作为互联网企业对外部提供业务能力的主要
技术通道，对数据隐私的保护成为API必须具备的基础能力。本章将为
读者介绍数据隐私在API安全的保护和处置相关问题。
13.1 数据隐私发展现状简述
人们对网络数据隐私问题的关注是因不断出现的数据泄露事件。在
互联网不断发展的过程中，越来越多与生活息息相关的数据从线下被搬
到互联网上。从最开始的互动、娱乐到后来的电商、支付，再到今天的
政务、医疗、教育、出行等，如果将这些企业的数据汇集起来，可以将
一个人的日常生活刻画得十分清晰。人们从互联网获得生活便捷的同
时，却不得不将个人隐私信息让渡给企业。
企业开展业务活动的过程中，往往片面地关注盈利或自身安全能力
的不足，存在对数据隐私保护不力的情况，导致不断地有数据泄露事件
进入公众视野。为了遏制这种乱象，保护每一个公民的数据隐私权利不
受侵犯，构建健康、长远的互联网环境，世界各国均加强了对数据隐私
保护工作的立法和监管。
13.1.1 国内个人信息保护监管现状
在2017年6月1日发布的《中华人民共和国网络安全法》中，第一
次明确地提出了网络运营者对个人信息的全生命周期保护，其中第四
章第四十一条的法律条文如下：
网络运营者收集、使用个人信息，应当遵循合法、正当、必要的原
则，公开收集、使用规则，明示收集、使用信息的目的、方式和范围，
并经被收集者同意。网络运营者不得收集与其提供的服务无关的个人信
息，不得违反法律、行政法规的规定和双方的约定收集、使用个人信
息，并应当依照法律、行政法规的规定和与用户的约定，处理其保存的
个人信息。
为了落实《中华人民共和国网络安全法》《中华人民共和国消费者
权益保护法》的要求，中央网信办、工业和信息化部、公安部、市场监
管总局四部门于23019年13月联合发布《关于开展App违法违规收集使
用个人信息专项治理的公告》，在全国范围内组织开展“App违法违规
收集使用个人信息专项治理”行动，结合《App违法违规收集使用个人信
息行为认定方法》和GB/T 35273-2020《信息安全技术 个人信息安全规
范》这些法律和标准规范，为企业使用个人信息的合规提供了可操作指
南。
同时，多家国内媒体也对App违法收集个人信息给予曝光或通报。
如“3.15”晚上曝光的SDK违规收集个人信息，工业和信息化部2020年连
续发布3批《关于侵害用户权益行为的App通报》，如图13-1所示。
●图13-1 工业和信息化部关于侵害用户权益行为的2020年第三批App通报
这些曝光和通报，给企业经营者在API的数据收集、使用和传递过
程中，如何合法、合规的使用，敲响了警钟。
13.1.2 国外数据隐私监管现状
说到国外数据隐私，首先要说的当属欧盟的《一般数据保护条例》
（General Data Protection Regulation，GDPR）。其于2018年5月25日在
欧盟成员国范围内正式生效实施，次年73月83日，英国航空公司因为违
反《一般数据保护条例》被罚13.8339亿英镑（约折合15.8亿元人民
币）。
GDPR被广泛认为是有史以来最严厉的数据安全管理法规，其强调
个人权利为主的数据保护、数据透明度、数据所有权以及数据权利的让
渡，尤其是数据主体的知情权、访问权、更正权和删除权等。同时，对
于儿童用户，根据不同年龄段明确了用户同意的数据处理合法标准。
除了欧盟的GDPR之外，印度的《个人数据保护法案（Personal
Data 
Protection 
Bill）》、韩国的《个人信息保护法案（Personal
Information Protection Act）》、加拿大的《个人信息保护与电子文档法
案（Personal Information Protection and Electronic Documents Act）》等
均从个人隐私保护的角度颁布数据隐私保护的法规。
在这些法律法规实施的过程中，要求企业从数据的采集、存储、
使用、共享、转让、披露、出境等数据生命周期的各个环节去保护数
据隐私的安全。企业使用互联网技术时，需要考虑相应的安全保护措
施，而API技术作为实现企业服务和生态构建的关键技术路径，数据隐
私的保护对API安全来说尤其重要。
13.2 API安全中的数据隐私保护
API交互过程中，主要的对象是数据，敏感数据也是API交互的重