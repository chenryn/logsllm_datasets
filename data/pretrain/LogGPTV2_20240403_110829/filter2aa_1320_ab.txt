 PAExec
 RemCom
 rcmd
 xcmd
 Impacket wmiexe
 Indicators
 Windows Event Log
 4624 
 Type 2
 If the attacker explicitly provides a diﬀerent credential 
 to psexec with the -u switch, Windows treats this as an 
 interactive logon on the remote system
 Type 3
 Since valid credentials are used, the account logon and 
 logon events discussed previously also apply to this 
 attack vector. If the attacker uses the currently logged-
 on user’s credentials, Windows will record the access 
 on the remote system with event "Network logon"
 4648
 On the system initiating the connection, when the -u 
 switch is used, an event 4648 is recorded, showing
 the account initiating the use of the credential in the 
 Subject section, the credential provided with the -u
 switch in the Account Whose Credentials Were Used 
 section, and the remote system targeted in the
 Target Server section
 4697
 Theexecutable may be uploaded with a random or 
 explicitly provided name, or the Service File Name 
 maybe PowerShell run with a long, Base64-encoded 
 command. If enabled, this event will also be logged in 
 the Security event log recording the service being 
 installed on the system
 7045
 (New service was installed) The creation of the service 
 generates this event in the System event log, complete 
 with the name of the service created (Service Name 
 ﬁeld) and the executable that was used to create it (
 Service File Name ﬁeld)
 7036
 (Service was started/stopped) When the session ends, 
 you may see this event in the System event log showing 
 the PSEXESVC service entering a stopped state
 Registry
 NTUSER.DAT\Software\Sysinternals\PsExec
 Where it sets the EulaAccepted value to 1. This key is 
 named PsExec even if the attacker named the tool 
 something else in an attempt to conceal its execution
 Could be easy renaming of PsExec to ps64.exe. Instead 
 of focusing on the process name, look for the 
 command parameters and the parent/child process 
 association
 Windows Admin Shares
 Windows systems have hidden network shares that are 
 accessible only to administrators (for example C$, 
 ADMIN$, and IPC$) and provide the ability for remote 
 ﬁle copy and other administrative functions
 Some telemetry patterns of this type of behavior 
 include the use of cmd.exe with the names of shares 
 such as localhost\ADMIN$ or 127.0.0.1\ADMIN$
 References
 Andrea Fortuna
 https://www.andreafortuna.org
 Applied Incident Response
 https://www.appliedincidentresponse.com/resources/
 Sans Institute
 https://www.sans.org/reading-room/whitepapers
 Wilbur Security
 https://www.wilbursecurity.com/
 MITRE ATT&CK
 https://attack.mitre.org/tactics/TA0008/
 Red Canary
 https://redcanary.com/blog/
 Cybereason
 https://www.cybereason.com/blog
 License
 Lateral Movement is licensed under a Creative 
 Commons Attribution-NonCommercial-ShareAlike 4.0 
 International License.
 https://creativecommons.org/licenses/by-nc-sa/4.0/
 13.Junio.2020
 Deﬁnitions
 An attacker will gain an initial foothold and start to pivot 
 across systems looking to gain higher access in search 
 for their ultimate objectives
 Lateral movement refers to the various techniques 
 attackers use to progressively spread through a 
 network as they search for key assets and data, and 
 usually is the second step of an cyberattack.
 Powershell
 Description
 Any action that can be taken on a Windows system can 
 be taken through PowerShell, without the need for 
 additional malware to be installed.  Any action that can 
 be taken on a Windows system can be taken through 
 PowerShell, without the need for additional malware to 
 be installed
 WARNING !
 Is one of the most useful tools in the administrator’s
 arsenal for daily administrative tasks as well as 
 baselining and incident handling. Just as attackers 
 have scripts like Empire to help do their jobs, so to do 
 defenders have frameworks like Kansa to help do
 theirs
 Security measurements
 GP path
 WARNING !
 These logs can provide a wealth of information 
 concerning the use of PowerShell on the systems. 
 However,  be sure to test and tune the audit facilities to 
 strike a balance between visibility and load before 
 deploying such changes in production
 Conﬁguration > Policies > Administrative Templates > 
 Windows Components > Windows PowerShell
 Module logging
 - Logs pipeline execution events;
 - Logs to event logs.
 Script Block Logging
 - Captures de-obfuscated commands sent to 
 PowerShell;
 - Captures the commands only, not the resulting output;
 - Logs to event logs.
 Transcription
 - Captures PowerShell input and output;
 - Will not capture output of outside programs that are 
 run, only PowerShell;
 Windows Event Log
 %SystemRoot%\System32\winevt\
 Logs\Microsoft-Windows-PowerShell%4Operational
 4103
 Includes the user context used to run the commands. 
 Hostname ﬁeld will show “Console” if executed locally 
 or will show if run from a remote
 system. Can correlate account logon and logon events 
 to determine further information about
 the source of a remote connection
 4104
 Shows script block logging entries. Logs full details of 
 each block only on ﬁrst use to conserve space. Will 
 show as a “Warning” level event if Microsoft deems the 
 activity “Suspicious.”
 Find a PowerShell history ﬁle per user
 %HOMEPATH%\AppData\Roaming\
 Microsoft\Windows\PowerShell\PSReadLine\
 ConsoleHost_history.txt
 WARNING !
 Conﬁrm the location on a system by running the Get-
 PSReadLineOption cmdlet and checking the 
 HistorySavePath
 The MaximumHistoryCount will show the number of 
 lines that will be stored in the consoleHost_history.txt
 ﬁle before it starts overwriting older entries (the default 
 is 4096)
 PowerShell remoting uses WinRM to establish 
 connections to remote machines. As a result, the same 
 detection methods used for WinRM also apply to 
 PowerShell Remoting. Note that regardless of whether 
 HTTP or HTTPS is used in the WinRM transfer, 
 PowerShell encrypts all remoting commands with AES-
 256 after the initial authentication
 Network activity
 Iimplement outbound restrictions to keep systems that 
 don’t need to initiate outbound PowerShell Remoting 
 sessions from initiating outbound connections on TCP 
 ports 5985 and 5986
 Utilizing common ports (TCP 80, 443, etc.), encrypted 
 communications, making infrequent connections, and 
 requesting benign-looking URI’s
 Por instance, PS Empire HTTP Listeners are conﬁgured 
 to continuously request three speciﬁc URI’s. While 
 these URI’s can be a helpful network signature, 
 attackers can easily change the Empire C2 URI’s:
 /login/process.php
 /admin/get.php
 /news.php
 Encrypted data sent over on a (typically) unencrypted 
 port (eg. 80, 23).
 The following launcher string, “powershell -noP -sta -w 
 1 -enc” is present by default in Empire HTTP listeners. 
 While the launcher string can be easily  
 changed, it is commonly unaltered by attackers
 Credential Theft
 Description
 Once a client system is compromised, attackers will set 
 to work to collect credentials from that machine
 WARNING !
 The credentials do not need to be full username and 
 cleartext password pairs. Attackers can steal hashed 
 representations of passwords, load them into memory, 
 and allow Windows passthrough authentication to 
 handle authentication to other systems as an arbitrary 
 user through pass- 
 the-hash attacks.
 Capture credentials such as user names and 
 passwords from client systems or oﬀ the wire when the 
 client returns to the corporate network
 Indicators
 Windows event logs
 Domain Controllers 
 WinEventIDs 
 4768 
 The issuance of a Ticket Granting Ticket (TGT) shows 
 that a particular user account was authenticated by the 
 domain controller
 4769
 A service ticket was issued to a particular user account 
 for a speciﬁed resource. This event will show the 
 source IP of the system that made the request, the user 
 account used, and the service to be accessed. These 
 events provide a useful source of evidence as they 
 track authenticated user access across the network
 4776
 While less common in a domain environment, NTLM 
 may still be used for authentication. Additionally, many 
 attack tools downgrade authentication attempts to 
 NTLM when authenticating. While these types of 
 authentication do frequently occur with legitimate 
 traﬃc, such as some authentication requests 
 originating by IP address rather than computer name, 
 their presence may also indicate a non-standard tool 
 being used to authenticate
 4720
 If a new account is created,  for a domain account or on 
 the local system for a local account
 Workstations WinEventIDs 
 4624
 A logon to a system has occurred. Type 2 indicates an 
 interactive (local) logon, while a Type 3 indicates a 
 remote or network logon
 4625
 A failed logon attempt
 4672
 This Event ID is recorded when certain privileges 
 associated with elevated or administrator access are 
 granted to a logon. As with all logon events, the event 
 log will be generated by the system being accessed
 4776
 An NTLM-based authentication has occurred. When 
 found on a non-domain controller this indicates the use 
 of a local user account. Since most domains are 
 designed to use domain rather than local user 
 accounts, the presence of this Event ID on member 
 servers or client workstations is frequently suspicious
 4634/4647
 User logoﬀ is recorded by Event ID 4634 or Event ID 
 4647. The lack of an event showing a logoﬀ should not 
 be considered overly suspicious, as Windows is 
 inconsistent in logging event 4634 in many cases
 5140
 A network share object was accessed, will show when a 
 shared folder or other shared object is accessed. The 
 event entry provides the account name and source 
 address of the account that accessed the object
 Registry
 Registering the ﬁle name for the next stage malware 
 under UserInitMprLogonScript
 HKCU\Environment\UserInitMprLogonScript