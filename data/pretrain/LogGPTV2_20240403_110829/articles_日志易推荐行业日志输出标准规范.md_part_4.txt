# 交易流程跟踪和错误定位
日志应该包含可实现错误定位以及交易流程跟踪的功能，能够清晰记录每笔交易的痕迹。由于交易往往是需要跨越多个应用系统的，而且有可能会被拆成多个子交易，因此必须制定统一的交易标识来跟踪跨系统交易（全局流水号）。
# 交易标识
**全局交易流水号**：用来标识某一次交易全局唯一性标识。在一个交易完成过程中，"交易跟踪号"是全局唯一的，用来跟踪交易的全生命周期记录。
**本地交易流水号**：考虑到交易组合的情况，通常需要全局流水号和系统内部的平台流水号进行组合交易的识别。
# 交易过程跟踪举例
完成支付业务中卡查询交易时在各个系统的日志记录。
根据日志，可以知道通过微信银行查询账户余额的全交易线，其中包括3个系统：微信银行、ESC、核心。
从各个日志文件中提取出交易线流程及相关日志记录，自上而下按时间顺序整理成下表。
+----+-----+---------------------------+------------------------------+
| 时 | 应  | 业务服务描述              | 日志记录中关键信息           |
| 序 | 用  |                           |                              |
|    | 系  |                           |                              |
|    | 统  |                           |                              |
+====+=====+===========================+==============================+
| W  | 微  | 微信银行收到客户对        | 微信银行平台流水号=          |
| XB | 信  | 账户余额的查询请求，为本  | WXB_ba8d785e                 |
| -1 | 银  | 次查询交易分配平台流水号  | -4029-41e3-9d02-f829a5f8c834 |
|    | 行  | WXB_ba8d785e-40           |                              |
|    |     | 29-41e3-9d02-f829a5f8c834 |                              |
+----+-----+---------------------------+------------------------------+
| W  | 微  | 微信银行服务器中的ESC     | 微信银行平台流水号=          |
| XB | 信  | angent                    | WXB_ba8d785e                 |
| -2 | 银  | 向ESC服务器请求全局流水号 | -4029-41e3-9d02-f829a5f8c834 |
|    | 行  | ，加入报文头，然后微信银  |                              |
|    |     | 行将查询请求报文发送到ESC | 全局流水号=MSG_C6DD4D88      |
|    |     |                           | -D33C-46F8-768A-9CDC69EC560D |
|    |     |                           |                              |
|    |     |                           | 消息目的地=ESC               |
+----+-----+---------------------------+------------------------------+
| E  | ESC | ESC收到微信               | 全局流水号=MSG_C6DD4D88      |
| SC |     | 银行的查询请求报文，分配  | -D33C-46F8-768A-9CDC69EC560D |
| -1 |     | 平台流水号ESC_A6DD4D88-D3 |                              |
|    |     | 3C-46F8-768A-9CDCBA8D785E | ESC平台流水号=               |
|    |     |                           | ESC_A6DD4D88                 |
|    |     |                           | -D33C-46F8-768A-9CDCBA8D785E |
|    |     |                           |                              |
|    |     |                           | 消息目的地=CBS               |
|    |     |                           |                              |
|    |     |                           | 消息来源=WXB                 |
+----+-----+---------------------------+------------------------------+
| C  | CBS | 核心收到请求报文，        | 全局流水号=MSG_C6DD4D88      |
| BS |     |                           | -D33C-46F8-768A-9CDC69EC560D |
| -1 |     | 调用                      |                              |
|    |     | 查询服务，分配平台流水号  | CBS平台流水号=               |
|    |     |                           | CBS_A0EEBC99                 |
|    |     |                           | -9C0B-4EF8-BB6D-6BB9BD380A11 |
|    |     |                           |                              |
|    |     |                           | 报文来源=ESC                 |
|    |     |                           |                              |
|    |     |                           | 报文内容来源=WXB             |
+----+-----+---------------------------+------------------------------+
| C  | CBS | 核心执行查询              | CBS平台流水号=               |
| BS |     | 服务，由于数据库问题失败  | CBS_A0EEBC99                 |
| -2 |     |                           | -9C0B-4EF8-BB6D-6BB9BD380A11 |
|    |     |                           |                              |
|    |     |                           | 服务结果=failed              |
|    |     |                           |                              |
|    |     |                           | 错误码= CBS0210003           |
|    |     |                           |                              |
|    |     |                           | 错误消息=数据库连接不可用    |
+----+-----+---------------------------+------------------------------+
| C  | CBS | 由于数据库错误是底层      | CBS平台流水号=               |
| BS |     | 错误，对外应该不可见，所  | CBS_A0EEBC99                 |
| -3 |     | 以对错误信息进行封装转换  | -9C0B-4EF8-BB6D-6BB9BD380A11 |
|    |     |                           |                              |
|    |     |                           | 错误码= CBS0210003           |
|    |     |                           |                              |
|    |     |                           | 原                           |
|    |     |                           | 始错误消息=数据库连接不可用  |
|    |     |                           |                              |
|    |     |                           | 转换后的错误码=CBS1004004    |
|    |     |                           |                              |
|    |     |                           | 转换后的错误消息=系统异常    |
+----+-----+---------------------------+------------------------------+
| C  | CBS | 核心                      | CBS平台流水号=               |
| BS |     | 完成交易CBS_A0EEBC99-9C0B | CBS_A0EEBC99                 |
| -4 |     | -4EF8-BB6D-6BB9BD380A11， | -9C0B-4EF8-BB6D-6BB9BD380A11 |
|    |     |                           |                              |
|    |     | 发送响应消息到ESC         | 错误码=CBS1004004            |
|    |     |                           |                              |
|    |     |                           | 错误消息=系统异常            |
|    |     |                           |                              |
|    |     |                           | 全局流水号=MSG_C6DD4D88      |
|    |     |                           | -D33C-46F8-768A-9CDC69EC560D |
|    |     |                           |                              |
|    |     |                           | 报文下一站=ESC               |
|    |     |                           |                              |
|    |     |                           | 报文最终目的地=WXB           |
+----+-----+---------------------------+------------------------------+
| E  | ESC | ESC收到核心的返回报文     | 全局流水号=MSG_C6DD4D88      |
| SC |     | ，处理后，进行报文转发。  | -D33C-46F8-768A-9CDC69EC560D |
| -1 |     |                           |                              |
|    |     |                           | ESC平台流水号=               |
|    |     |                           | ESC_A6DD4D88                 |
|    |     |                           | -D33C-46F8-768A-9CDCBA8D785E |
|    |     |                           |                              |
|    |     |                           | 错误码=CBS1004004            |
|    |     |                           |                              |
|    |     |                           | 错误消息=系统异常            |
|    |     |                           |                              |
|    |     |                           | 报文目的地=WXB               |
|    |     |                           |                              |
|    |     |                           | 报文来源=CBS                 |
+----+-----+---------------------------+------------------------------+
| W  | WXB | 微信银行收到ESC的报文     | 全局流水号=MSG_C6DD4D88      |
| XB |     | ，发现错误                | -D33C-46F8-768A-9CDC69EC560D |
| -1 |     | 信息不适合展现给前端用户  |                              |
|    |     | ，调用消息服务进行转译。  | 微信银行平台流水号=          |
|    |     |                           | WXB_ba8d785e                 |
|    |     |                           | -4029-41e3-9d02-f829a5f8c834 |
|    |     |                           |                              |
|    |     |                           | 错误码=CBS1004004            |
|    |     |                           |                              |
|    |     |                           | 错误消息=系统异常            |
|    |     |                           |                              |
|    |     |                           | 转译后的错误码=WXB1003001    |
|    |     |                           |                              |
|    |     |                           | 转译后的错误消息="查询服务   |
|    |     |                           | 异常，稍安勿躁，请稍后重试"  |
+----+-----+---------------------------+------------------------------+
| W  | WXB | 微信                      | 微信银行平台流水号=          |
| XB |     | 银行完成交易WXB_ba8d785e  | WXB_ba8d785e                 |
| -2 |     | -4029-41e3-9d02-f829a5f8c | -4029-41e3-9d02-f829a5f8c834 |
|    |     | 834，将结果返回给最终用户 |                              |
|    |     |                           | 错误码=WXB1003001            |
|    |     |                           |                              |
|    |     |                           | 错误消息="查询服务           |
|    |     |                           | 异常，稍安勿躁，请稍后重试"  |
+----+-----+---------------------------+------------------------------+
一般情况下，我们可以通过以下两个原则对问题进行跟踪、定位：
1.  "全局流水号"关联： 全局流水号可以进行系统间的交易跟踪。
2.  "平台流水号"关联： 在应用平台内部交易可以"平台流水号"进行跟踪。
根据上表可以看到，在支付业务中最终用户进行卡查询时，看到的出错信息包括：
1.  错误码=WXB1003001
2.  错误消息="查询服务异常，稍安勿躁，请稍后重试"
根据这些信息和各个系统日志记录，可以按照如下步骤跟踪错误的传递过程，最终定位到原始错误，过程如下：
1.  在微信银行中，根据错误码和错误消息，定位到微信银行平台流水号WXB_ba8d785e-4029-41e3-9d02-f829a5f8c834，按照"平台流水号"关联法则，可以查到所有微信银行交易的日志记录；
2.  从此次交易的日志记录中可以看到错误码WXB1003001被转译过，原始错误码是CBS1004004；
3.  原始错误码CBS1004004是从ESC返回的全局流水号MSG_C6DD4D88-D33C-46F8-768A-9CDC69EC560D中得到的，而这个消息正式关联到此次交易对ESC的平台流水ESC_A6DD4D88-D33C-46F8-768A-9CDCBA8D785E；
4.可以在ESC的日志中找到全局流水号MSG_C6DD4D88-D33C-46F8-768A-9CDC69EC560D的记录，从而发现此消息是CBS发到WXB，全局流水号也是MSG_C6DD4D88-D33C-46F8-768A-9CDC69EC560D，且未在ESC系统中发生异常；
5.根据全局流水号MSG_C6DD4D88-D33C-46F8-768A-9CDC69EC560D，在CBS的交易日志中找到所有的交易记录，可以发现错误码CBS1004004也是被转译过一次，最原始的错误码是CBS0210003，是数据库错误造成的。到此错误的定位就完成了。
# 性能分析
完整的日志信息必须支持对交易的性能分析。对跨系统或者跨组件的访问，必须能够记录下发起请求和得到应答的时间。
在上面的交易过程跟踪举例中，系统内通过交易跟踪号，系统间通过全局流水号，将整个交易线中涉及的各个系统的各个步骤衔接起来。根据各个日志文件中记录的时间信息，我们可以整理出各个系统中各个服务的耗时情况，这样就看到整个交易线中，不同服务在全时段的耗时比例。
# 监控统计功能 
日志应该满足监控和统计的功能。只有对日志进行监控、审查，才能真正让日志有助于维护系统的健康和稳定。为了能够使得运维团队更高效、更准确地监控、审查应用系统，需要基于日志记录建立监控机制。
根据功能性需求或非功能性需求，应该能够根据日志建立相应的统计指标，产生统计报告。
根据功能性需求或非功能性需求，应该能够根据日志建立相应的实时指标，如性能，并建立对这样的指标的实时监控。
# 特定审计日志的功能
当应用系统为满足某些特定需求记录日志时，如被银监会要求记录特定的审计日志，可能采取的策略有从现有的日志中摘录或单独产生这些日志。以下就这两种方式进行比较。
  ------------------------------------------------------------------------------------------------------------------------------------------------------
                 从现有的日志中摘录                                                         单独产生日志
  -------------- -------------------------------------------------------------------------- ------------------------------------------------------------
  实现方式       按照需求，从现有一般信息日志、错误日志中，选取相应的数据项，产生所需日志   在一般信息日志、错误日志之外配置单独的日志输出，单独的类别
  性能           由于不是实时生成数据，对生产环境的运行时的性能没有影响                     由于需要额外的实时记录数据，会影响系统的运行时的性能
  数据可靠性     由于是二次加工的数据，不适用严格要求数据不能被更改的情况                   直接记录原始数据，配合数字签名等方法，能保证数据的可靠性
  ------------------------------------------------------------------------------------------------------------------------------------------------------
具体实现方式请根据各个组件实际情况自行决定。