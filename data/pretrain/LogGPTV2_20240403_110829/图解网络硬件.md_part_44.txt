L3模式
也称为NAT模式，是与路由器接口一样拥有IP地址的接口。在进行路由选择、NAT以及连接IPSec-
VPN或SSL-VPN时，必须使用L3模式的接口
可以通过网络管理人员输入静态配置IP地址，也可以通过PPPoE、DHCP客户端动态分配来获取接口
的IP地址。在L3模式下进行路由时，需要使用虚拟路由器
L2模式
也称为透传模式或者透明模式（L2透明模式），是与交换机接口一样拥有同样MAC地址、可进行桥接
的接口。进行IP地址分配时需要使用VLAN
L1模式
也称为虚拟线缆模式。把两对儿网络接口组成一组，流量在其中一方的接口上输入并在另一块接口处
输出。该模式下无法进行路由和桥接
TAP模式
与交换机镜像端口（SPAN端口）相连接的模式。通过对交换机转发的数据帧进行复制并收集，可以将
通信内容可视化并检测恶意软件。由于不是内联结构，因此该模式无法阻止那些没有必要的通信过程
图5-8
内联模式的结构（由L1/L2/L3模式引I入）图5-9TAP模式的机构
互联网
互联网
路由器
路由器
（互联网网关）
（互联网网关）
（防火墙
防火墙
镜像端口
交换机
TAP模式的
交换机
防火墙
LAN
TAP模式的接口
(Intranet)
其他接口
与路由器和交换机一样，部分防火墙同样可以设置回环接口、VLAN接口（子接口）和汇聚
接口（IEEE802.3ad）等（参考表3-12）。
05.06防火墙能够预防的威胁
表5-10罗列了防火墙能够防范的威胁。
---
## Page 260
246第5章防火墙功能与防范威胁的对策
表5-10
防火墙能够防范的威胁
威胁种类
说明
窃听
通过窃听网络数据获取信用卡卡号、密码
发送方
接送方
等重要信息
恶意方
篡改
将网站主页、邮件等通信内容恶意修改
发送方
接收方
恶意方
破坏
通过计算机病毒或DoS攻击等破坏系统
发送方
接收方
的正常工作
恶意方
冒充
冒充他人接收邮件、对通信对方实施钓
发送方
接收方
鱼、诈骗等行为
信息泄露
个人计算机或服务器上重要的个人信息或
发送方
接收方
文档泄露
恶意方
攻击跳板
作为病毒部署或DoS攻击的跳板（中
发送方
接收方
继处）
垃圾邮件
以营利为目的发送大量邮件
---
## Page 261
05.07防火墙中搭载的各种功能|247
威胁安全的人
安全威胁一般分为人为因素和非人为因素（自然灾害等），防火墙面临的威胁一般来自于人
为因素。表5-11列出了安全威胁人（攻击者）的几个类型。
表5-11安全威胁人（攻击者）的几个类型
名称
说明
黑客（hacker）
经常会听到“被黑客入侵了”的说法，但实际上黑客是指那些对计算机技术了如指掌的人
而并非特指网络攻击者
破解者（cracker）
对网络进行非法访问、窃听信息、篡改等行为的人
进攻者（attacker）
以造成系统当机为目的、对系统施展DoS等攻击的人
妨碍者
发送大量垃圾邮件、在BBS中粘贴大量广告、散布以诽谤为目的的言论或发布大量无意义
信息的人
普通用户
尽管不会有主动的攻击行为，但普通用户会在不知情的情况下使用了被病毒、蠕虫等感染的
个人计算机，从而成为威胁网络安全的对象
僵尸（bot）
作为攻击跳板的终端，经常被植入带有攻击程序的病毒，遭受感染的终端称为“僵户”，由
大量僵尸程序组成的网络则称为“僵户网络
05.07
防火墙中搭载的各种功能
05.07.01会话管理
■会话与数据流
在TCP中某个服务器与客户端成对进行通信时，会完成3次握手来确认建立1个TCP连
接，在从连接建立开始至连接结束的时间里，客户端发送请求（request）和服务器进行应答
（response）这一交互过程即可称为进行了1个会话。
在UDP中，客户端与服务器之间只要发送源的端口和目的地端口的配对一致，随后的一系
列通信均可以称为会话。
在ICMP中，例如Echo和对应的Echoreply的组合就可以称为会话。
servertoclient）两个数据流（flow）。数据流是指发往通信对方的多个分组序列。
---
## Page 262
248丨第5章防火墙功能与防范威胁的对策
图5-10展示了HTTP通信中的数据流和会话示例
客户端
服务器
SYN
SYN+ACK
ACK
HTTPrequest
>1个会话
HTTP reply
FIN
FIN+ACK
发送源地址：1.1.1.1
发送源地址：2.2.2.2
目的地址：2.2.2.2
目的地址：1.1.1.1
发送源端口：11111
发送源端口：80
目的地端口：80
目的地端口：11111
c2s（clienttoserver）的数据流
s2c（servertoclient）的数据流
TCP连接管理
一个TCP的连接需要通过3次握手来确认建立。
最初由客户端发送SYN消息，即发送首部中SYN比特信息设置为“1”的TCP数据段。
SYN读作/sin/，表示同步的意思，取自Synchronization这个单词的前三个字母。SYN相当于一
个开始信号，与打电话时先拨号码的行为类似。
当服务器收到来自客户端的SYN消息后，将返回表示确认的ACK消息，同时也会发送一个
SYN消息至客户端。ACK表示确认的意思，取自Acknowledgement这个单词的前三个字母。
TCP连接使用端口号表示不同的网络服务（应用程序）。例如，HTTP使用80号端口，
TELNET使用23号端口。提供HTTP服务的服务器必须接收和处理客户端发送至80号端
口的TCP数据段。能够处理分组的状态一般表示为listen状态（listen意为“侦听”，也称为
listening)。
---
## Page 263
05.07防火墙中搭载的各种功能
249
图5-11TCP的3次握手
建立TCP连接/数据传输/结束步骤
客户端
服务器
SYN+ACK的Ack编
CLOSED
SYN(Seq=100,Ack=0)
号为SYN的Seq编
LISTEN号+1，Seq编号由
SYN_SENT
客户端随机生成
连接建立步骤
SYN+ACK（Seq=200,Ack=101
SYN_RCVD
ESTABLISHED
ACK（Seq=101,Ack=201)
PSH+数据（5byte）
ESTABLISHED
（Seq=101,Ack=201)
Ack编号为Seq编号+
附带ACK信息
数据的字节数
ACK+PSH+数据（64byte）
(Seq=201,Ack=106)
数据传输时保持
数据传输时保持
ESTABLISHED
数据传输步骤
ESTABLISHED
ACK+PSH+数据（5byte）
状态
状态
（Seq=106,Ack=265）
Ack编号为Seq编号+
数据的字节数
ACK+PSH+数据（64byte）
（Seq=265,Ack=111)
FIN+ACK的Ack编号为
FIN的Seq编号+1
ESTABLISHED
FIN
ESTABLISHED
(Seg=111,Ack=329)
FIN_WAIT1
FIN+ACK
CLOSE_WAIT
（Seq=329,Ack=112)
连接终止步骤
LAST_ACK
FIN_WAIT2
ACK(Seq=112,Ack=330)
TIME_WAIT
A
CLOSED
ACK的Ack编号为FIN+
CLOSE
ACK的Seq编号+1
在这期间（1~4分钟）内，相同端口之间无法连接
①客户端发送SYN标志位设置为On的TCP数据段。
②服务器接收到带有SYN标志位的消息后，将SYN与ACK的标志位设置为On，并设置
Ack编号为“发送方的Seq+1”后进行回复。
③客户端将ACK标志位设置为On，将Ack编号设置为“接收的Seq编号+1”的TCP数据
段发送回服务器，确认建立TCP连接。
TCP中用序列号（sequence）来表示应用程序数据发送至何处，TCP连接所使用的初始序列
在3次握手的过程中确定。
序列号分为两类，一类用于从客户端发往服务器端（c2s）的上行TCP数据段，另一类用于
从服务器端发往客户端（s2c）的下行TCP数据段。上行和下行两种数据流在建立时，各自使用
不同的随机数作为初始序列号ISN（InitialSequenceNumber）。
·SYN检查
TCP会话开始时客户端必会发送一个SYN消息。如果是没有附带会话信息（或尚未建立会
---
## Page 264
250！第5章防火墙功能与防范威胁的对策
话），即非SYN消息的TCP数据段到达防火墙，防火墙就会将其视作非法而整个丢弃。但也可
以根据不同的情形（双活允余或会话超时等）关闭（OFF）防火墙的这个功能，使不带有会话信
息的、非SYN消息的TCP数据段也能够通过防火墙。
·ACK检查
在根据SYNCookie（参考表5-27）信息防范SYNFlood攻击时，通过对SYN-ACK的ACK
消息进行检查，能够确认进行中的3次握手是否为非法尝试
·同一数据段检查
终端再次发送TCP数据段时，对于和之前收到的TCP数据段含有相同序列号或数据的
TCP数据段，可以指定防火墙的处理方式，即指定是使用新接收到的重复数据段还是丢弃该重
复数据段。
·窗口检查
检查TCP首部内的序列号和滑动窗口大小（WindowSize），拦截超过滑动窗口容量数据的序
列号。
·数据段重组
即使各数据段的顺序出现变化，TCP数据段也能根据序列号调整为正确顺序。在防火墙进
行这一工作，可以验证TCP数据段序列号是否完整。
会话建立的处理
防灭墙按照以下步骤处理从网络接口接收到的分组，从而完成会话建立。
①检索会话表，确认表内是否存在相同会话（若存在相同会话，则禁止会话建立的后续
流程）
②若不存在相同会话，则检查该分组是否可以通过L3路由选择或L2转发来输出。如果可
以输出，确定对应的网络输出接口和自的地区域（若不能输出，则丢弃该分组）。
③分组转发时，如果自的地址需要进行NAT则先完成NAT，确定NAT后的网络输出接口
和目的地区域。
④根据分组的发送源信息（发送源网络接口、发送源区域和发送源地址）以及经过②、③步
骤后得到的目的地信息（目的地网络接口、目的地区域、目的地址）进行安全策略检查，
发现有符合的安全策略时，则根据该策略（允许通信或拒绝通信）决定是继续转发还是丢
弃分组。如果没有符合的安全策略，则根据“默认拒绝”的设定去弃该分组。
5当分组被允许通信时，会话表中就会生成该会话的相关信息。
---
## Page 265
05.07防火墙中搭载的各种功能丨251
会话的生存时间
会话表中记录的会话信息有一定的生存时间。会话建立后，如果在一定时间内一直处于无通
信状态，防火墙将会判断该会话的生存时间已到，进而将该会话记录项从会话表内删除。如果无
条件地任由会话记录留在会话表中，这些会话信息则很有可能会被用于恶意攻击等行为。另外，
用，从而影响新会话记录的生成。
会话时间能够根据TCP、UDP或其他IP协议的不同分别进行设置。
对于TCP而言，会话的超时时间一般为30分钟~1小时，UDP则为30秒左右。例如，某
Telnet会话通过防火墙完成了连接，若在1个小时内没有进行任何通信，防火墙会自动将该会话
记录从会话表中删除。此后，客户端想要继续该Telnet会话时，也会被防火墙拒绝（图5-12），
因此客户端需要重新建立Telnet会话。会话生存时间的调整可以参考本书07.04节。
图5-12会话生存时间与超时的概念图
客户端
防火墙