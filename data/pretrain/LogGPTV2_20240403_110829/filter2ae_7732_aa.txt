作者: **启明星辰ADLab**
#### 一、分析背景
2017年6月12日，安全厂商 ESET 公布一款针对电力变电站系统进行恶意攻击的工控网络攻击武器 -win32/Industroyer (ESET命名),
ESET 表示该攻击武器可以直接控制断路器，可导致变电站断电。 Industroyer 恶意软件目前支持四种工控协议：IEC 60870-5-101、IEC
60870-5-104、IEC 61850以及OLE for Process Control Data Access（简称OPC
DA）。这些协议广泛应用在电力调度、发电控制系统以及需要对电力进行控制行业，例如轨道交通、石油石化等重要基础设施行业，尤其是 OPC
协议作为工控系统互通的通用接口更广泛应用在各工控行业。可以看出，攻击者对于工控系统尤其是电力系统相关的工控协议有着深厚的知识背景，并且具有目标工控环境下的各种工控设备，攻击者需要这些设备来实现恶意代码的编写和测试工作。
与2015年袭击乌克兰电网最终导致2015年12月23日断电的攻击者使用的工具集（BlackEnergy、KillDisk、以及其他攻击模块）相比，这款恶意软件的功能意义重大，它可以直接控制开关和断路器，Industroyer
身后的黑客团队无论从技术角度还是从对目标工控系统的研究深度都远远超过了2015年12月乌克兰电网攻击背后的黑客团队。
ESET 公布该恶意软件之前，曾经对 Dragos 公司做过相应通告，Dragos
根据通告的内容找到该恶意软件的样本并且通过他们对该批恶意软件的编译时间推测该恶意软件曾被利用来攻击乌克兰的变电站导致2016年12月那次半个小时的乌克兰停电事件。目前可以说
Industroyer 恶意软件是继 STUXNET、BLACKENERGY 2以及 HAVEX
之后第四款对针对工业控制系统进行攻击的工控武器。启明星辰ADLab根据 ESET 提供的HASH文件对这批样本进行了分析验证并在某些方面做了更加深入的分析。
#### 二、Industroyer 恶意软件简要分析
Industroyer 恶意软件是由一系列的攻击模块组成，根据目前所公开的信息及 ESET
得到的模块就多达10多个。其中存在一个主后门模块，它被用于连接C&C下载另外一批模块执行，这些模块分别为：实现 DLL Payload
模块执行的加载器模块、实现数据及痕迹清理的 haslo 模块、实现IP端口扫描的 port 模块以及实现西门子 SIPROTEC 设备 DoS 攻击的
DoS 攻击模块。其中，DLL Payload 模块包含实现 IEC 101 工控协议的 `101.dll` 模块、实现 IEC 104 工控协议的
104.dll 模块、实现 IEC 61850 协议的`61850.dll/61850.exe` 模块以及实现 OPC DA 协议的
`OPC.exe/OPCClientDemo.dll` 模块等。以下我们列出了可以收到的样本及其功能。
值得注意的是，Main Backdoor 与 C&C 通信的时候是通过内网中的一台主机作为跳板连接到 C&C 上实施命令控制的，ESET 发现该模块是通过
Tor 网络实现与 C&C 的交互。因此根据目前所掌握的信息我们绘制了该恶意软件大致工作流程。
从恶意软件的攻击流程中我们可以推测该黑客可能的攻击路径：首先黑客可以通过电子邮件、办公网系统、外来运维终端、U盘等途径成功入侵一台主机(如：内网的10.15.1.69)，并且在该主机联网时下载必要的模块执行比如
Tor
网络客户端或者代理服务模块等作为后续攻击的回连跳板，黑客接下来以该主机为跳板对系统局域网络进行探测扫描，当发现自己感兴趣的目标(是否为104从站、OPC服务器或者操作站等)后对其实施攻击，一旦攻击成功，黑客就将这台可以连接外网的主机
IP 配置为攻击模块 Main Backdoor 的代理IP，下发到该主机中，这台主机是可以直接与 RTUs 或者 PLCs
进行通信的，并且可以做直接的控制。
#### 三、详细分析描述
###### 1\. Main Backdoor 模块分析
该模块主要用于实现与攻击者 C&C 通信,
由于工控系统内部的控制主机可能处于无法连接外网的内部局域网络中，所以黑客事先在进入被感染系统之前已经非常清楚该工控系统内部的网络结构，在入侵的跳板主机上安装了
Tor 客户端以及代理服务（代理服务开启3128端口接收数据进行转发）。并且在进行内部网络攻击过程中，黑客将根据该跳板机的 IP 来定制化相应的 Main
Backdoor 程序下发到目标机上运行。因此，可以说该模块是在黑客攻击过程中实时根据黑客当前所掌握的资源信息进行定制的。
该模块的通信部分也是通过一个小时为单位的时间定制化任务来执行。也就是说，在黑客实时攻击过程中也是有可能的通过这个定制化功能在指定的时间里与 C&C
通信，比如深夜时间。如下图：
此外，该模块会创建一个匿名的互斥体，并且会在路径 %Common Documents% 的父目录创建一个标识文件 imapi
，只有这个文件存在的情况下才会执行与 C&C 通信的任务。
Main Backdoor 模块连接 C&C 是通过跳板机(10.15.1.69)来实现与 C&C 5.39.218.152 通信的，通信的端口为 443
端口，据 ESET 报告，与 C&C 通信的数据采用了 HTTPS 。
目前我们无法证实该情况，因为后门采用 443 端口通信但实际不为 HTTPS 的情况非常多。但是可以确定的是 Main Backdoor
与跳板机之间的通信是明文的。通信数据内容如下：
该后门收到控制命令数据后，会对数据做一定处理，最后创建一个线程来处理黑客端发来的控制请求。
其中，控制命令的前4个字节为命令 ID，接下来是单字节的控制命令，其值为 0-0xA
整形值，控制命令的控制命令参数位于第16个字节的偏移之后。控制命令分发以及处理功能代码如下：
其中控制命令以及相应的功能说明如下表所示：
从控制功能上可以看出该后门模块的主要任务是从C&C下载扩展模块执行以及做远程命令执行，并且提供了由账户凭证支持的权限控制。如果黑客获取了管理员权限就可以将已安装的后门升级到一个更高的权限版本，黑客可以选择一个现有的、非关键的
Windows 服务，在注册表中替换它的 ImagePath 键值为新后门的代码路径。
###### 2\. Launcher模块分析
该模块为 Main Backdoor 下载的众多模块之一，其实际上为黑客的进一步攻击提供一个统一的攻击接口，可以说是专门为运行 payload
模块而设计的。该模块在系统中以服务程序运行，运行时会创建一个定时器。定时器触发时该模块会创建新线程加载 hasio.dat 模块并调用 hasio.dat
模块的 Crash 函数（关于hasio.），并且执行 payload 模块的 Crash
函数。通过启动器模块，恶意代码可以在指定的时间根据命令行运行任意的 payload 。
该模块接受3个参数，格式为: %LAUNCHER%.exe‌ %WORKING_DIRECTORY% %PAYLOAD%.dll‌
%CONFIGURATION%.ini。 参数以及解释如下：
当模块启动运行时会将 workdirectory 设置为当前目录，然后加载 payload 模块。需要注意的是，此时加载 Payload
模块但是并没有执行模块的核心功能，这些功能实现在 Payload 模块的导出函数 `Crash()` 中，所以通过该 Launcher 运行的
Payload 模块都必须导出这么一个函数。
这个导出函数是通过定时器控制执行，定时器的触发时间为2016年12月17日22点。
历史上，乌克兰电力系统遭受了两次恶意网络攻击而引起的停电事故，其中一次便是2015年12月23号由恶意代码 BlackEnergy
攻击而导致大规模停电事故，第二次是在2016年12月17日遭受到未知恶意攻击而导致30分钟的停电事故。因而该恶意软件极有可能是第二次乌克兰停电事故的罪魁祸首。
###### 3\. 数据清除模块：haslo 模块分析
该模块为该恶意软件的数据擦除模块，与 KillDisk.DLL
模块具有类似的破坏性目的，它会删除注册表中服务对应的模块路径，并对磁盘上的文件进行改写，该模块对应的文件名为 `haslo.dat` 或
`haslo.exe` ，其中 `haslo.dat` 随启动器模块执行，`haslo.exe`
可以作为单独工具执行。当该模块运行时会枚举`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services`下的所有键，并设置该键的
ImagePath 为空，该操作会造成系统无法正常启动。
清理完注册表后，该模块会开始擦除文件，首先该模块枚举驱动器从C盘到Z盘中包含指定扩展名的文件，对发现的文件进行改写。其中会避免对 Windows
目录文件的改写。需要注意的是，在枚举的过程中该组件跳过了子路径中名称包含 Windows
的文件。该组件用从新分配内存中获得的随机数据来重写文件内容。为了达到彻底擦除数据使其无法恢复的目的，该组件会尝试重写两次。第一次是当文件在驱动器盘中被发现，如果第一次没有成功，该组件会尝试第二次。但是在此之前，该恶意软件会终止除了包含在关键系统列表中的所有进程。
该模块需要擦除的文件类型有：