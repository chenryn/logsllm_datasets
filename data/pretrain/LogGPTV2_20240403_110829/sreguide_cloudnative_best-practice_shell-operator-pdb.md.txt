---
isOriginal: true
category: ‰∫ëÂéüÁîü
tag:
  - Kubernetes
---

# Â∑ßÁî® shell-operator ÈÖçÁΩÆ K8s Pod ‰øùÊä§Á≠ñÁï•

‰øùÈöú Pod È´òÂèØÁî®ÂàÜ‰∏∫‰ª•‰∏ãÂá†‰∏™ÊñπÈù¢

* ËµÑÊ∫êÊ±†ÂàíÂàÜ ÔºöÊâìÊ±°ÁÇπ„ÄÅÁã¨Âç†„ÄÅÈöîÁ¶ª
* Qos ÂàÜÁ∫ß & ‰ºòÂÖàÁ∫ßÔºöÊåâÂ∫îÁî®Á≠âÁ∫ß‰øùÈöúÁ®≥ÂÆöÊÄß
* [Ëá™Âä®ÂºπÊÄß‰º∏Áº© HPA](https://clay-wangzhi.com/cloudnative/best-practice/hpa.html)
* Pod Âπ≤Êâ∞È¢ÑÁÆó PDB

Êú¨ÁØá‰∏ªË¶Å‰ªãÁªçÁ¨¨ÂõõÁÇπÔºö Â∑ßÁî®  Shell-operator ÈÖçÁΩÆ K8s Pod ‰øùÊä§Á≠ñÁï•



## ‰ªÄ‰πàÊòØ Shell-operator Ôºü

Shell-operator ÊòØ‰∏Ä‰∏™Âú® Kubernetes ÈõÜÁæ§‰∏≠ËøêË°å‰∫ã‰ª∂È©±Âä®ËÑöÊú¨ÁöÑÂ∑•ÂÖ∑„ÄÇ

ËØ•Êìç‰ΩúÂô®‰∏çÊòØÈíàÂØπÁâπÂÆöËΩØ‰ª∂‰∫ßÂìÅÁöÑÊìç‰ΩúÂô®Ôºå‰æãÂ¶Ç prometheus-operator Êàñ kafka-operator„ÄÇShell-operator ÈÄöËøáÂ∞ÜËÑöÊú¨ËßÜ‰∏∫Áî±‰∫ã‰ª∂Ëß¶ÂèëÁöÑÈí©Â≠êÔºåÊèê‰æõ‰∫Ü Kubernetes ÈõÜÁæ§‰∫ã‰ª∂Âíå Shell ËÑöÊú¨‰πãÈó¥ÁöÑÈõÜÊàêÂ±Ç„ÄÇÊÇ®ÂèØ‰ª•Â∞ÜÂÖ∂ËßÜ‰∏∫ operator-sdkÔºå‰ΩÜÁî®‰∫éËÑöÊú¨„ÄÇ

Shell-operator Áî®‰ΩúÊõ¥È´òÁ∫ßÁöÑ addon-operator ÁöÑÂü∫Á°ÄÔºåËØ• operator ÊîØÊåÅ Helm charts ÂíåÂÄºÂ≠òÂÇ®„ÄÇ

Shell-operator Êèê‰æõ‰∫Ü‰ª•‰∏ãÂäüËÉΩÔºö

* Kubernetes ÈõÜÁæ§ÁöÑÁÆÄÊòìÁÆ°ÁêÜÔºö‰ΩøÁî®ËøêÁª¥‰∫∫ÂëòÁÜüÊÇâÁöÑÂ∑•ÂÖ∑„ÄÇÂèØ‰ª•ÊòØ bash„ÄÅpython„ÄÅkubectl Á≠âÔºåÁúüÊòØËøêÁª¥‰∫∫ÁöÑÂÆûÁî®Â∑•ÂÖ∑üëçüëçüëç„ÄÇ

* Kubernetes ÂØπË±°‰∫ã‰ª∂ÔºöÈí©Â≠êÂèØ‰ª•Áî±Ê∑ªÂä†„ÄÅÊõ¥Êñ∞ÊàñÂà†Èô§‰∫ã‰ª∂Ëß¶Âèë„ÄÇ

* ÂØπË±°ÈÄâÊã©Âô®ÂíåÂ±ûÊÄßËøáÊª§Âô®Ôºöshell-operator ÂèØ‰ª•ÁõëËßÜÁâπÂÆöÁöÑÂØπË±°ÈõÜÔºåÂπ∂Ê£ÄÊµãÂÖ∂Â±ûÊÄßÁöÑÊõ¥Êîπ„ÄÇ

* ÁÆÄÂçïÁöÑÈÖçÁΩÆÔºöÈí©Â≠êÁªëÂÆöÂÆö‰πâÊòØËÑöÊú¨ÁöÑÊ†áÂáÜËæìÂá∫‰∏≠ÁöÑ JSON Êàñ YAML ÊñáÊ°£„ÄÇ

* È™åËØÅ Webhook Êú∫Âà∂ÔºöÈí©Â≠êÂèØ‰ª•Â§ÑÁêÜ Kubernetes ËµÑÊ∫êÁöÑÈ™åËØÅ„ÄÇ

* ËΩ¨Êç¢ Webhook Êú∫Âà∂ÔºöÈí©Â≠êÂèØ‰ª•Â§ÑÁêÜ Kubernetes ËµÑÊ∫êÁöÑÁâàÊú¨ËΩ¨Êç¢„ÄÇ



## ÂÄüÂä©  Shell-operator ÈÖçÁΩÆ PDB

> üëâ ËØ¥ÊòéÔºö‰ª•‰∏ãÊòØÂèòÈáèÔºåÂèØÁªìÂêàËá™Ë∫´ÈúÄË¶ÅËøõË°å‰øÆÊîπ
>
> ÈÖçÁΩÆ PDB ÈúÄË¶ÅÁî®Âà∞‰æøÁ≠æÈÄâÊã©Âô®  selectorÔºåÁ§∫‰æã‰∏≠ÈÄâÊã© AppID ‰Ωú‰∏∫Ê†áÁ≠æÂåπÈÖç
>
> Shell-operator ÈúÄË¶ÅÁõëÊéß‰∏Ä‰∏™ÂØπË±°ÁöÑÊó∂Èó¥ÔºåÊù•Êõ¥Êñ∞ PDB ÁöÑÁä∂ÊÄÅÔºåÁ§∫‰æã‰∏≠ÈÄâÊã© rollouts.argoproj.io ÂØπË±°
>
> namespace ÈÄâÊã© prod

1. ÂàõÂª∫Âü∫Á°ÄÊ®°Áâà `pdb-init.sh`

   ```bash
   #!/usr/bin/env bash
   
   NAMESPACE="prod"
   
   pdb_templates() {
     cat <<EOF
   apiVersion: policy/v1beta1
   kind: PodDisruptionBudget
   metadata:
     name: clay-test
     namespace: ${NAMESPACE}
   spec:
     minAvailable: 1
     selector:
       matchLabels:
         appid: clay-test
   EOF
   }
   
   replace_or_create() {
     object=$(cat)
   
     if ! kubectl get -f - <<< "$object" >/dev/null 2>/dev/null; then
       kubectl create -f - <<< "$object" >/dev/null
     else
       kubectl replace --force -f - <<< "$object" >/dev/null
     fi
   }
   
   init() {
     echo "Init PDB templates"
     pdb_templates | replace_or_create
     for resourceName in $(kubectl -n ${NAMESPACE} get rollouts.argoproj.io | grep default | awk '{print $1}'); do
       appid=${resourceName%-default} 
       echo "Init Add PDB '${appid}'"
       kubectl -n ${NAMESPACE} get pdb clay-test -o json | \
         jq -r ".metadata.name=\"${appid}\" | .spec.selector.matchLabels[\"appid\"]=\"${appid}\" |
                 .metadata |= with_entries(select([.key] | inside([\"name\", \"namespace\", \"labels\"])))" \
         | replace_or_create
     done
   }
   
   init "$@"
   ```

   ```bash
   bash pdb-init.sh
   ```

2. ÁºñÂÜôÈí©Â≠êËÑöÊú¨`pdb-hooks.sh`

   ```bash
   #!/usr/bin/env bash
   
   NAMESPACE="prod"
   ARRAY_COUNT=$(jq -r '. | length-1' $BINDING_CONTEXT_PATH)
   
   run_hook() {
     if [[ $1 == "--config" ]] ; then
       config
     else
       trigger
     fi
   }
   
   config() {
     cat <<EOF
   configVersion: v1
   kubernetes:
   - apiVersion: argoproj.io/v1alpha1
     kind: Rollout
     executeHookOnEvent:
     - Added
     - Deleted
     namespace:
       nameSelector:
         matchNames:
         - ${NAMESPACE}
   EOF
   }
   
   trigger() {
     for IND in `seq 0 $ARRAY_COUNT`; do
       resourceEvent=$(jq -r ".[$IND].watchEvent" $BINDING_CONTEXT_PATH)
       resourceName=$(jq -r ".[$IND].object.metadata.name" $BINDING_CONTEXT_PATH)
       appid=${resourceName%-default}
       if [[ $resourceEvent == "Added" ]] ; then
         echo "Add PDB '${appid}'"
         kubectl -n ${NAMESPACE} get pdb clay-test -o json | \
           jq -r ".metadata.name=\"${appid}\" | .spec.selector.matchLabels[\"appid\"]=\"${appid}\" |
                   .metadata |= with_entries(select([.key] | inside([\"name\", \"namespace\", \"labels\"])))" \
           | replace_or_create
       elif [[ $resourceEvent == "Deleted" ]]; then
         echo "Delete PDB '${appid}'"
         kubectl -n ${NAMESPACE} delete pdb ${appid}
       else
         echo "Do nothing"
       fi
     done
   }
   
   replace_or_create() {
     object=$(cat)
   
     if ! kubectl get -f - <<< "$object" >/dev/null 2>/dev/null; then
       kubectl create -f - <<< "$object" >/dev/null
     else
       kubectl replace --force -f - <<< "$object" >/dev/null
     fi
   }
   
   run_hook "$@"
   ```

3. ÊâìÂåÖÈïúÂÉèÔºåDockerfile Â¶Ç‰∏ã
   ```dockerfile
   FROM ghcr.io/flant/shell-operator:latest
   ADD pdb-hooks.sh /hooks
   ```

   ```bash
   # ÊâìÂåÖ‰∏ä‰º†ÈïúÂÉè
   docker build -t wangzhichidocker/shell-operator-pdb:v1.0 .
   docker push wangzhichidocker/shell-operator-pdb:v1.0
   ```

4. ÁºñÂÜô RBAC„ÄÅDeploymentÁ≠â`shell-operator-pdb.yaml`ÔºåÈÉ®ÁΩ≤Âà∞ K8s ÈõÜÁæ§‰∏≠

   ```yaml
   apiVersion: v1
   kind: ServiceAccount
   metadata:
     name: shell-operator-pdb
     namespace: monitor
     labels:
       app: shell-operator-pdb
       appid: shell-operator-pdb
   
   
   ---
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRole
   metadata:
     labels:
       app: shell-operator-pdb
       appid: shell-operator-pdb
     name: shell-operator-pdb
   rules:
   - apiGroups:
     - ""
     resources:
     - pods
     verbs:
     - get
     - watch
     - list
   - apiGroups:
     - argoproj.io
     resources:
     - '*'
     verbs:
     - get
     - list
     - watch
   - apiGroups:
     - policy
     resources:
     - poddisruptionbudgets
     verbs:
     - get
     - create
     - patch
     - update
     - delete
   
   
   ---
   apiVersion: rbac.authorization.k8s.io/v1
   kind: ClusterRoleBinding
   metadata:
     name: shell-operator-pdb
     labels:
       app: shell-operator-pdb
       appid: shell-operator-pdb
   roleRef:
     apiGroup: rbac.authorization.k8s.io
     kind: ClusterRole
     name: shell-operator-pdb
   subjects:
   - kind: ServiceAccount
     name: shell-operator-pdb
     namespace: monitor
   
   
   ---
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: shell-operator-pdb
     labels:
       app: shell-operator-pdb
       appid: shell-operator-pdb
     namespace: monitor
   spec:
     replicas: 1
     selector:
       matchLabels:
         app: shell-operator-pdb
     strategy:
       rollingUpdate:
         maxSurge: 25%
         maxUnavailable: 1
       type: RollingUpdate
     template:
       metadata:
         labels:
           app: shell-operator-pdb
           appid: shell-operator-pdb
       spec:
         containers:
         - image: wangzhichidocker/shell-operator-pdb:v1.0
           imagePullPolicy: IfNotPresent
           name: shell-operator-pdb
           resources:
             limits:
               cpu: 500m
               memory: 1000Mi
             requests:
               cpu: 100m
               memory: 200Mi
         dnsPolicy: ClusterFirst
         nodeSelector:
           kubernetes.io/os: linux
         serviceAccountName: shell-operator-pdb
   ```

   ```bash
   # ÈÉ®ÁΩ≤
   kubectl apply -f deploy/shell-operator-pdb.yaml
   ```

5. ËßÇÂØüÊó•ÂøóÊü•ÁúãËøêË°åÁä∂ÊÄÅ `kubectl -n monitor  logs -f shell-operator-pdb-xxx`

   ![](https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240318133056140.png)

   ![image-20240318133226486](https://clay-blog.oss-cn-shanghai.aliyuncs.com/img/image-20240318133226486.png)



Âø´Êç∑‰ΩìÈ™åÔºö

```bash
git clone https://github.com/clay-wangzhi/shell-operator-pdb
bash pdb-init.sh
kubectl apply -f deploy/shell-operator-pdb.yaml
```

ËØ¶ËßÅÔºöhttps://github.com/clay-wangzhi/shell-operator-pdb





ÂèÇËÄÉÈìæÊé•Ôºö

* shell-operatorÔºöhttps://github.com/flant/shell-operator






---



>




