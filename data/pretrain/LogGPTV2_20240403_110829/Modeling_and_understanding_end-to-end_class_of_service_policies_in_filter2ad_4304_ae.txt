CER could be con(cid:2)gured to use the 4 data classes in 16 (24) pos-
sible ways (which we refer to as combinations), corresponding to
whether a particular data class is present or not. For instance, one
combination could include both C1 and C4, and another combina-
tion could include C1 or C4 alone.
Fig. 11 studies the diversity of CoS con(cid:2)guration of CERs within
an enterprise. The X-Axis is the number of combinations that are
present in an enterprise, and the Y-Axis is the fraction of enterprises
that contain fewer than a particular number of combinations. We
see that 60% of the enterprises are homogeneous, containing just
one single combination (i.e., the same set of classes are con(cid:2)gured
in all CERs). However, the other enterprises show more diversity,
with some having as many as 7 different combinations that are con-
(cid:2)gured. This heterogeneity may stem from variations in bandwidth
capacity provisioned across sites, and the unique CoS requirements
of each site. For example, a site hosting the VoIP customer ser-
vice center may only need high priority real-time class, while a site
with multiple applications may need a mixture of voice and data
classes. As another example, data centers and head of(cid:2)ces are of-
ten provisioned with higher capacity to the provider backbone than
peripheral locations.
Fig. 12 studies whether all, or only a subset, of the 16 possible
combinations are actually con(cid:2)gured. Each combination is taken,
and the number of enterprises with at least one CER that uses the
combination is considered. It is interesting to see that all possible
combinations are con(cid:2)gured for some VPN. In addition, some com-
binations are more popular than the others (cid:150) 8 combinations (com-
binations 9 to 16) are each present in over 10 enterprises. These
226Pm
Tx
P2
Tx
P3
Tx
P4
M2
S
M3
M4
Customer 
LAN
Qm
exp:4
Q(C1,C2,NM)
exp:4
To(cid:3)
CER2
Q2
Q3
Q(C3)
Q(C4)
PER2
Q4
exp:3
CER1
PER1
MPLS
Direction of traffic flow
 100
 80
 60
 40
 20
)
s
e
s
i
r
p
r
e
t
n
e
(
F
D
C
 0
 0
 5
 10
 15
universal shadowing
address space shadowing
 30
 20
 25
 35
CER2
Number of CERs with shadowed policies
Figure 14: CDF of the number of CERs with some shadowed traf(cid:2)c
class per enterprise.
Figure 13: All possible end-to-end CoS treatments received by (cid:3)ows
sent from CER1 to CER2 in enterprise ENT6. Each of the round box
corresponds to a CoS policy block.
combinations correspond to different arrangements with the class
C3 (i.e., C3 alone, or C3 plus a subset of other classes), with the
largest combination (present in 100 enterprises) being the use of C3
alone. Further discussion with the designer indicates that C3 is the
recommended default class for customers. Finally, we observe that
even across homogeneous enterprises, 11 combinations are used,
indicating signi(cid:2)cant diversity in CoS usage across enterprises.
Overall, these results show that (i) the use of CoS is prevalent
in enterprise VPNs, (ii) there is signi(cid:2)cant diversity in CoS usage
across enterprises, and (iii) there exists a large degree of hetero-
geneity in how routers within an enterprise are con(cid:2)gured. These
results strengthen the case for formal modeling of CoS policies.
6.3 Tracing end-to-end CoS design patterns
An application of our tool is to identify all possible treatments
that a (cid:3)owset may receive on an end-to-end path. This can help
an operator analyze the design patterns used in putting together the
CoS design, as well as identify potentially anomalous patterns.
Fig. 13 pictorially shows the output obtained with our tool, when
run on the end-to-end path between the two CERs (CER1-PER1-
PER2-CER2) in ENT6. The left side of the (cid:2)gure shows three poli-
cies within CER1, the central portion shows the marking policy at
the ingress interface of PER1, and the right side shows the queuing
policy at the egress interface of PER2. At CER1, on the input inter-
face, traf(cid:2)c from the customer site (denoted by S) could be marked
using markers M2, M3, or M4, as belonging to C2, C3, or C4. Traf-
(cid:2)c corresponding to each of these classes is policed according to
different parameters (dictated by policers P2, P3, and P4), and the
compliant/non-compliant traf(cid:2)c of different classes is then queued
in separate queues Q2, Q3 and Q4. Some interesting parts of the
design deserve further discussion. First, a subset of traf(cid:2)c marked
as belonging to each of these classes are simply transmitted (de-
noted by a policing rule Tx) without checks for compliance and
are respectively queued in the appropriate class based on markings
obtained at the input interface. This traf(cid:2)c corresponds to SLA
probe traf(cid:2)c, which may be injected to help determine that the traf-
(cid:2)c corresponding to a particular class meets the performance met-
rics speci(cid:2)ed in the SLAs. Since the operator may explicitly desire
to test the performance of compliant traf(cid:2)c, the traf(cid:2)c must not be
subject to normal policing checks and should not be re-marked as
non-compliant. Second, a subset of traf(cid:2)c marked as belonging to
C2, C3, and C4 in the input interface are overridden and re-marked
as corresponding to network management traf(cid:2)c by the policer Pm.
This traf(cid:2)c typically corresponds to SNMP query traf(cid:2)c and BGP
routing update traf(cid:2)c, that must be treated separately from the data
classes. In fact, we can see this traf(cid:2)c is queued separately in Qm.
Customer traf(cid:2)c leaving CER1 enters the ingress interface of
PER1. Based on the ToS byte of each packet, PER1 changes the
EXP (cid:2)eld in its MPLS label (see §2.2). With network management
traf(cid:2)c, the EXP value is set unconditionally. However, the EXP
value of data traf(cid:2)c is changed conditionally based on compliance
to pre-set traf(cid:2)c parameters. Interestingly, traf(cid:2)c corresponding to
two of the data classes C2 and C3 is provided with an identical
EXP value, indicating that while the differentiation between traf(cid:2)c
belonging to C2 and C3 occurs at the enterprise edge, the traf(cid:2)c is
treated identically in the MPLS core. However, traf(cid:2)c in C4 con-
tinues to be treated at a lower priority level inside the core.
Finally, the right side of the (cid:2)gure shows how traf(cid:2)c is treated as
it comes out of PER2, and before entering CER2. We see that while
C3, and C4 traf(cid:2)c enter separate queues, the same queue is used
for C1, C2, and network management (NM) traf(cid:2)c. Note however
that the treatment handed out to these 3 traf(cid:2)c classes can still be
different (e.g., with different drop probabilities during congestion).
This example illustrates the power of our model in automatically
extracting the patterns used by the designer in identifying treat-
ment corresponding to various (cid:3)ows. It also highlights the need for
a systematic model, given the signi(cid:2)cant complexity of possible
treatments received by a (cid:3)owset.
6.4 Detecting shadowed policy con(cid:2)gurations
One application of our model is that it can help highlight shad-
owed policies (see §2.3). For instance, a CER may have a queuing
policy that pertains to four different classes. However, it is possible
that no traf(cid:2)c is ever classi(cid:2)ed as belonging to one of the classes,
and hence that portion of the queuing policy is never exercised.
In identifying shadowed policy con(cid:2)gurations within a CER, we
consider two types of shadowing: (i) Universal Shadowing: Here,
we consider classes shadowed when the universal set of (cid:3)ows (see
§5 and Table 1) are fed through a CER (cid:150) this indicates that a por-
tion of policy con(cid:2)guration is never utilized regardless of what traf-
(cid:2)c may (cid:3)ow through the CER; (ii) Address Space Shadowing: we
consider shadowing that occurs only when the input (cid:3)ow contains
a source address in the address space of the CER. This indicates
that a portion of policy con(cid:2)guration is not utilized given the cur-
rent address space assignments to the CER, but might be used later
when the address space changes.
Fig. 14 shows the prevalence of shadowed policies in the 150
enterprises. The number of CERs where a particular type of shad-
owing is present is computed for each enterprise, and a CDF is
plotted. We see that around 35% of the enterprises have some
CERs with classes shadowed, and 5% of the enterprises have more
227CER1
d:C1,C3,C4
a:C1
C1C1
(a) ENT1
CER2
d:C1,C3,C4
a:C1
CER1
d:C2,C3
a:C2,C3
C3C3
C3C3
CER2
d:C2,C3
a:C2,C3
C3C3
CER3
d:C2,C3
a:C2,C3
(b) ENT20
Figure 15: CoS matrix for enterprises ENT1 and ENT20.
CER3b
d:C1,C3
a:C1,C3
CER3
d:C1,C3
a:C1,C3
CER4
d:C1,C3
a:C1,C3
C1,C3
C1,C3
C1C1
CER1
d:C1
a:C1
CER2
d:C1
a:C1
CER1b
d:C1
a:C1
CER6
d:C1,C3
a:C1,C3
CER5
d:C1,C3
a:C1,C3
CER2b
d:C1
a:C1
ENT83
Figure 16: CoS matrix for enterprise ENT83.
than 5 routers shadowed. While the presence of shadowing might
correspond to an inadvertent error made by the operator, it may
also correspond to legacy con(cid:2)guration lines or actual design in-
tent. For example, the tail in Fig. 14 corresponds to enterprise
ENT139, where 36 CERs have universal shadowing of class C4
in the policing and queueing policy con(cid:2)gurations. A potential be-
nign explanation is that this was due to a deliberate design intent
to remove class C4 from these routers. To achieve this change, the
operators possibly modi(cid:2)ed the marking policy to no longer mark
(cid:3)ows as corresponding to C4, but did not remove the policing and
queuing rules already con(cid:2)gured for that class. While a judgement
regarding whether a particular example represents genuine design
intent, or an error can only be made by the appropriate operators, a
tool like ours can bring such examples to the operators’ attention.
6.5 Mapping network-wide CoS designs
Using our tool, one may obtain network-wide views of CoS de-
signs. To derive such views, we consider a simple abstraction,
called a CoS matrix that models how various traf(cid:2)c classes can be
exchanged between two CERs (see Fig. 15(a) for an example). We
can visualize a CoS matrix with a directed graph. Here, each node
represents a CER annotated with a set of classes con(cid:2)gured (de-
noted d:) and classes that may actually be active (denoted a:) tak-
ing shadowing into account. A bidirectional link between two nodes
indicates that when only the address spaces of the two CERs are
considered, they can communicate in a symmetric fashion using a
particular set of traf(cid:2)c classes as annotated on the link.
We have obtained such graphs for all enterprises in our datasets,
and we discuss some interesting examples that point the value of
our model and abstraction below.
Fig. 15(a) illustrates the CoS matrix for ENT1, a simple VPN
with two CERs. The annotations on each CER indicate that policies
corresponding to C1, C3, and C4 are de(cid:2)ned in the con(cid:2)guration,
but only traf(cid:2)c corresponding to C1 may exit the router once shad-
owed policies are considered. Further, the two routers have a link
between them annotated with C1 indicating that C1 traf(cid:2)c may be
exchanged in either direction. Fig. 15(b) depicts the CoS matrix for
ENT20, which has three CERs. In this case, traf(cid:2)c corresponding
to C2 and C3 may exit each router, which is consistent with what
is con(cid:2)gured by the network operator. However, it is interesting to
see that once the address spaces of the CERs are considered, each
router pair may only exchange C3 traf(cid:2)c. These examples high-
light the value of our model that can enable us to reason about what
traf(cid:2)c can be effectively exchanged between two VPN sites.
To show the value of our CoS matrix abstraction in reasoning
about the network design, Fig. 16 considers ENT83, a more com-
plex VPN with 9 CERs.
It is interesting that 4 of the routers,
namely CER3, CER4, CER5, and CER6, form a clique and ex-
change traf(cid:2)c corresponding to C1 and C3 as shown by the dotted
lines. However two other routers (CER1 and CER2) are exclu-
sively con(cid:2)gured with C1 and can only exchange C1 traf(cid:2)c with
other sites. We hypothesize that these two sites correspond to voice
call centers and only involve voice traf(cid:2)c. In contrast, the other
sites may include both voice and data traf(cid:2)c. Another interesting
aspect is that CER1 and CER2 are each co-located with another
router (i.e., CER1b and CER2b). This corresponds to a primary-
backup arrangement, where each site has two CERs, with one con-
(cid:2)gured as a primary and another con(cid:2)gured as a backup. The
backup router normally does not involve traf(cid:2)c but may take over
if the primary fails. Finally, we note that a primary-backup ar-
rangement is also used with CER3. Interestingly, we observed that
CER3 has a default route back to itself. Discussions with the de-
signers shows that this is an indication that CER3 is a gateway site,
through which all traf(cid:2)c to the Internet is routed. It makes sense
that such redundant arrangements are mainly employed for critical