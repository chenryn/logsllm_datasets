0.8
0.6
0.4
0.2
100
200
RTT (ms)
300
400
0
0
800
1600
2400
RTT (ms)
3200
4000
Figure 8. Hotmail RTT
Figure 9. Gmail RTT
Figure 10. Local mail server RTT
Figure 11.
Indian server RTT
1
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
0
−200−150−100 −50
0
50 100 150 200
T1 + T3 − T2 (ms)
1
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
0
−300
−200
−100
0
T1 + T3 − T2 (ms)
1
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
100
200
0
−150
−100
−50
0
T1 + T3 − T2 (ms)
1
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
50
100
0
−300
−200
−100
100
T1 + T3 − T2 (ms)
0
200
300
Figure 12.
RTT difference
Hotmail passive/active
Figure 13. Gmail passive/active RTT
difference
Figure 14.
sive/active RTT difference
Local mail server pas-
Figure 15.
sive/active RTT difference
Indian server pas-
1
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
0
0
1
1
1
Triangular routing
Direct connection from planetlab
0.5
1
1.5
Relative difference of RTT
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
2
0
0
Triangular routing
Direct connection from planetlab
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
Triangular routing
Direct connection from planetlab
s
e
s
s
e
r
d
d
a
P
I
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
Triangular routing
Direction connection from planetlab
0.5
1
Relative difference of RTT
1.5
0
0
0.5
1
Relative difference of RTT
1.5
0
0
0.5
1
Relative difference of RTT
1.5
Figure 16. Hotmail relative deviation
from passive RTT
Figure 17. Gmail relative deviation
from passive RTT
Figure 18. Local mail server relative
deviation from passive RTT
Figure 19.
deviation from passive RTT
Indian server relative
The results show that for Hotmail server, about 20% of
the IP addresses exhibit a difference between passive RTT
and active RTT of 50ms or larger. Depending on the relative
deviation from the passive RTT, 50ms can be sufﬁciently
large to be considered as an anomaly. For Gmail servers, the
difference is much smaller, so is the absolute RTT value. For
the local mail server, little difference is found between the
passive RTT and the active RTT. This is expected because
original sender and the target mail server are very close such
that t1 is close to zero and t2 and t3 are approximately the
same.
From Figure 16 to Figure 19, we can see that
the
distribution of relative difference of the active and passive
RTT computed by t1+t3−t2
. However, in order to know if
t1+t2+t3
the difference is large enough to be an anomaly, we need
to know the baseline of normal RTT variation in a short
period of time (within the order of seconds). Although it
is known that the RTT variation can be very large over
time, in triangular spamming detection, we can set up a
real-time active probing infrastructure to probe the active
RTT and compare it against the passive RTT. If the real-
time RTT variation is small, it is still possible to detect
such relatively large and stable RTT difference introduced
by triangular routing. We measure the RTT variation by
sending 3 consecutive probes with 1 sec interval from the
Planetlab nodes. The results clearly show that 95% of the
times the relative difference will be smaller than 0.1. This
implies that the relative RTT difference can be a useful
feature for detecting triangular spamming.
2) TTL value difference: Similarly, TTL values gener-
ated from the original sender can differ from the ones
generated by the relay bot as observed via active probing.
Previous work has studied the effectiveness of using TTL
value to detect spoofed DDoS trafﬁc [41]; thus, we do
not repeat the study of measuring the difference in TTL
values. Here we point out one key difference between DDoS
attack and triangular spamming: spoofed DDoS attacks
usually have no control over the hosts with spoofed IPs,
but in triangular spamming, the relay bots coordinate with
the original sender. It is thus harder to detect triangular
spamming. More speciﬁcally, the original sender can craft
a starting TTL such that the receiver cannot tell whether it
is generated by a different host other than the relay bot.
However, this coordination has to be done on a per-
destination and per-relay-bot basis which is likely high over-
head and may severely degrade the spamming throughput.
This is not a huge problem in DDoS attack since the attack
is typically targeted and well prepared before the actual
attack. The difﬁculty lies in obtaining the correct initial
TTL at the real sender.
In conclusion, we think TTL can be a useful feature
for detecting triangular spamming despite the robustness
problem outlined above.
It
3) OS ﬁngerprint:
is also possible to collect
lightweight passive OS ﬁngerprints from the ﬁrst SYN
packet using tools such as p0f [11]. Clustering the IP
addresses by ﬁngerprints can help detect trafﬁc associated
with the same original sender. However, this can be evaded
since the original sender can easily modify its kernel to
mimic different types of OS ﬁngerprints.
4) Port blocking behavior: If the OUT SMTP trafﬁc is
blocked at the ISP, there should not be any SMTP trafﬁc
generated from such IP addresses. As a result, if we can
identify that an incoming IP is blocked for OUT trafﬁc,
then it is highly likely that triangular spamming is used.
The limitation is false negatives. This can only detect cases
where the relay bots are indeed blocked for OUT trafﬁc
which is not a requirement for triangular spamming.
V. DETECTION AND PREVENTION
In this section, we discuss how to apply the previously
discussed techniques using data on our departmental mail
server to detect any evidence of triangular spamming and its
prevalence. We also discuss possible prevention techniques.
A. Experiment setup
Data source. Monitoring a mail server at our univer-
sity department mail server for 8 days from 2009.11.9 –
2009.11.16, we observe about 360,000 emails, of which
233,746 (87.6%) emails are spam emails (according to
SpamAssassin) from 200,347 distinct IP addresses. Each
log entry has four pieces of information: timestamp, sender
IP, spam tag, and spam score output by SpamAssassin.
Spam ﬁlter - SpamAssassin. Our mail server runs