1 
清华大学NISL实验室， 
Blue-Lotus黑客竞赛战队 
@清华诸葛建伟 
知道Web安全论坛KCON交流 
Blue-Lotus战队 
Defcon 20 CTF资格赛回顾 
Defcon CTF竞赛
2 
o   全球最有影响力的黑客竞赛 – “黑客奥运会” 
n  1996年开始，已成功举办16届 
n  组织者：DDTek（2009-Present） 
o   Defcon 20 CTF 
n  Quals – 资格赛 
o   Challenges Solving 
o   10支队 + 10支其他CTF冠军队 晋级 
n  Deathmatch – 拉斯维加斯 淘汰赛 
n  Final – 决赛 CTF (offense & defense) 
o   Defcon黑客会议现场 
梦想中的拉斯维加斯决赛现场
3 
Defcon CTF资格赛制
4 
o  
Grag bag 
（网络分析题） 
o  
Urandom 
（随机题） 
o  
Binary 
l33tness 
（二进制逆向
分析） 
o  
Pwnables 
（渗透攻击题） 
o  
Forensics 
（取证分析题） 
o  
100-500分 
o  
第一个解题队 
开出下一题 
Blue-Lotus（“蓝莲花”战队） 
o   清华大学网络与信息安全实验室(NISL@TU)参加黑
客竞赛的队名 
o   首次参赛：2010年12月iCTF’10 
n 
启蒙队：disket（UGA，Prof. Kang Li） 
n 
首次战绩: 35/72 
o   iCTF’11战绩：23/87 
n 
Metasploit原创书大结局场景 
5 
永不凋零的
蓝莲花 
Defcon CTF参赛征集外援帖 
6 
外援出现了！ 
7 
我们的参赛队员分布 
8 
CTF开赛 – 6.2 8:30am 
9 
[Blue-Lotus]清华总部 
[Syclover] 
成都信息工程学院
[Blue-lotus] 
早点&零食区 
0.01h – 旗开得分 
o   Grab Bag 100: Hack the planet_ 
o   2006: Hack the ______ 
o   2007: ____ the planet 
o   2008: Hack ___ planet 
o   2011: ____ ___ ______.  
o   2012: Hack the planet_ 
10 
G100 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/04/693 
0.01h – 旗开得分 (Hack the 
planet经典台词的电影-Hacker) 
11 
0.5h - 梦幻开局, 200分, 并列第1 
12 
o   Urandom 100:  
n  How many developers;) did it take to secure 
Windows 8? 
o   当时解题思路 
n  Google Windows 8发布会视频 - 是否微软某
高管提到Win8安全开发团队人数 
n  平均团队规模60-70人：人肉暴力猜解1-100未果 
o   最终解决：程序暴力猜解-答案152 
n  Slow Down?!! 
o   Why 152? (注意developers后面的奸笑) 
U100 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/05/719 
悲催的零分八小时 – p100 
o   p100: MIPS指令架构远程栈溢出 
n  很快fuzz出漏洞点和缓冲区长度 
n  搭环境本地动态调试：Qemu + Linux-mips 
n  缓冲区地址（覆盖返回地址）一直变化：ASLR 
o   指向堆栈的寄存器？一直未找到：放弃 
o   解答关键：利用binary中的write()探测出缓冲区地址 
o   不足 
n  对非主流平台与环境的不熟悉：学习MIPS指令、
搭环境花了很多时间 
n  思维定势：jmp esp（指向栈空间）绕过ASLR 
13 
P100 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/04/709 
悲催的零分八小时 – b100 
o   Binary l33tness 100: 给一个binary，recover 
my key 
n  一个加密mac.h，一个sshd，一个ssh 
n  Google: skynet ssh backdoor 
n  mac.h（后门记录日志文件）解密（xor 0xff） 
14 
这个Key曾经不是
Key?!!! 
B100 Writeup: http://wcf1987.iteye.com/blog/1550530 
悲催的零分八小时 – b100 (con’d) 
15 
o   眼皮底下“视而不见”的key：谁也没有想到这就是key 
这个Key据说是曾
经的Key?!!! 
b100受骗中 
16 
./john /root/
Desktop/
hash.txt 
Ali: 真的是破解crypt
()的明文后门密码吗？ 
就凭我的小Air，40小
时能破出来吗？ 
insight-?/fish: 发
现后门加密后的密码，
key可能是解密后的
原文密码吧 
悲催的零分八小时 – f100 
o   一个Linux文件系统，find the key 
o   落入了出题者的陷阱 
n 
包含软件包只有1个.c文件，十数个.x文件分析：编译执行？ 
n 
预编译头文件二进制中包含汇编源码：分析汇编？ 
n 
浪费大量劳力和时间，却毫无收获，郁闷！ 
o   Writeup 
n 
blkls -s f100: sleuthkit取证分析工具集中检查文件系统工具 
n 
Slack space: 包含删除文件的”松散”扇区 
17 
F100 Writeup: http://sysexit.wordpress.com/2012/06/03/defcon 
-20-ctf-prequals-2012-forensics-300-writeup/#comments 
F200 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/15/769 
悲催的零分八小时 - f200 
o   Forensic 200: 一个相机存储卡，recover the key 
n 
WinHex恢复出7张图片文件，并修复JPG 
n 
走上歪路：Google Map找出海景照片拍摄地？ 
n 
两张图片显示内容相同但二进制不同图片 
n 
对比分析，居然没想到使用隐写检测工具stegdetect 
n 
不过还需要猜测加密口令-ddtek （只有4个队解出F200） 
18 
f200图片对比后出现的3D效果 
19 
开饭了！开饭了！ 
Fish:等我搞
定b200,再… 
扭转局势的突破 – b200 
21 
o   提供样本，与远程运行实例交互获得key 
o   分析过程 
n  File: FreeBSD 32-bit 
n  IDA Pro反汇编、反编译 -> 理解程序逻辑 
n  绕过简单的权限控制 -> Nop相关代码破解 
n  Callback()关键函数最后的代码 
输入数据通过测试，则发
送Key过来，否则Sorry 
B200 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/17/779 
扭转局势的突破 – b200 
22 
o   Callback(
)函数中的
输入测试一 
o   读入4组4字节 
o   与4个整数
验证码对比 
o   通过则进入
下一测试 
o   Easy搞定 
扭转局势的突破 – b200 
23 
两个输入的
string要不相同 
两个输入string经
过crypt()函数计算 
判断两个输出
string却要相同? 
扭转局势的突破 – b200 
24 
o   crypt()函数到底是什么Hash算法呢？ 
o   发现Rijndeal算法(AES)的S-Box 
n  AES-based MAC?! 找哈希碰撞 
n  side-channel collision attack 
n  known-message scenario 
n  time and memory complexity 
扭转局势的突破 – b200 
25 
o   Fish的突破 
n 
v5.key[0] = 0x14B62D86u - 原先认为是使用的密钥 
n 
Tangle Hash Function!!! 
n 
Google “Tangle Hash collision” 
扭转局势的突破 – b200 
26 
o   构造能够满足测试条件的输入 
o   获得key：
437f085141d357c5d28850d5119aacb5 
扭转局势的突破 – p200 
27 
o   FreeBSD远程exploit 
o   关键漏洞函数逻辑分析 
重点怀疑 
对象 
网络获取输入
流，写buffer， 
明显的栈溢出 
这在干吗? 
Kelwin: 10 = 0A ！！！ 
这是个堆栈保护, 要覆盖buffer到返回
地址，必须要覆盖protection, 
保持protection不变会结束循环，死结！ 
扭转局势的突破 – p200 
28 
o  
Zhugejw: 不要着急，让我们画图仔细分析栈空间内存布局与
程序逻辑，可能会找出一条活路 
o  
Kelwin: 我知道了！循环变量index在覆盖途中, 可以进行精细
控制跳过protection。lycan, 快来搞shellcode！ 
Ret-add 
… 
protection 
index 
buffer 
… 
… 
sp 
sp+1Ch 
sp+21Ch 
sp+224h 
sp+220h 
shellcode 
ox0b 
Ret-add 
Ret-add 
sp+228h 
ox00 
ox02 
ox02 
ox0C 
P200 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/04/699 
第一天的战绩 – 700分(3x名) 
29 
比赛中场技术统计 
• 
解题:5/10 
• 
得分:700/1600 
• 
第1名:9/10 
• 
第1名:1400/1600 
• 
最高名次:并列第1 
• 
最低名次:6x+/5xx 
• 
当前名次:3x/5xx 
• 
最长板: binary 
• 
最短板: forensic 
• 
最闲组: grab bag 
势如破竹追分日-g组显身手(g200) 
30 
o   解压后是MACOS上的jpeg，缩略图中原始图片链接 
o   Diff发现解压图片比原图多了一段数据，DNS请求 
o   Scapy构造相同DNS请求包，修改源IP，发给目标 
o   dig -t ptr 13.12.11.10.in-addr.arpa 
@140.197.217.85 -b ::#31337 
o   DNS应答：dan.kaminsky.kung.fu. 
 G200 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/05/719 
势如破竹追分日-g组显身手(g300) 
31 
o   找出矩阵
规律，求出
PIN码 
o   10秒限制 
n 
This is 
semi-real. 
o   编程解决 
o   Balance: 
$92387409
825702370
12935.32 
G300 Writeup: http://netsec.ccert.edu.cn/blog/2012/06/09/760 
第2天15pm-首次进入首页榜单  
32 
18. Blue-
lotus:1200 
势如破竹追分日-p组稳步前进(p300) 
33 
o   FreeBSD服务程序exploit – 理解程序逻辑 