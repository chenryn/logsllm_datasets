-   解析报文头中调用路径号
-   记录日志
### 中间节点
![](media/image1.png)
**供接口请求报文接收动作职责：**
-   如果是联盟统建外第三方系统发送的请求报文，则生成统一流水号；否则解析报文头中是否有统一流水号，有则继续向后传递，无则后续动作保持报文头此字段为空；
-   如果是联盟统建外第三方系统发送的请求报文，则生成调用路径号；否则解析报文头中是否有调用路径号，有则继续向后按照规则传递，无则后续动作保持报文头此字段为空；
-   记录日志；
**需接口请求报文发送动作职责：**
-   请求报文接收点处理后的统一流水号，如果不为空，则填写到请求报文头；如果为空则保持报文头此字段为空；
-   请求报文接收点处理后的调用路径号，如果不为空，则做深度递增、广度递增后，填写到请求报文头；如果为空则保持报文头此字段为空；
-   记录日志；
**需接口响应报文接收动作职责：**
-   解析报文头中统一流水号；
-   解析报文头中调用路径号；
-   记录日志；
**供接口响应报文发送动作职责：**
-   请求报文接收点处理后的统一流水号，如果不为空，则填写到请求报文头；如果为空则保持报文头此字段为空；
-   请求报文接收点处理后的调用路径号，如果不为空，则填写到请求报文头；如果为空则保持报文头此字段为空；
-   记录日志；
### 联盟内部末端节点
![](media/image11.png)
**供接口请求报文接收动作职责：**
-   如果是联盟统建外第三方系统发送的请求报文，则生成统一流水号；否则解析报文头中是否有统一流水号，有则继续向后传递，无则后续动作保持报文头此字段为空；
-   如果是联盟统建外第三方系统发送的请求报文，则生成调用路径号；否则解析报文头中是否有调用路径号，有则继续向后按照规则传递，无则后续动作保持报文头此字段为空；
-   记录日志；
**供接口响应报文发送动作职责：**
-   请求报文接收点处理后的统一流水号，如果不为空，则填写到请求报文头；如果为空则保持报文头此字段为空；
-   请求报文接收点处理后的调用路径号，如果不为空，则填写到请求报文头；如果为空则保持报文头此字段为空；
-   记录日志；
### 联盟外部末端节点
![](media/image12.png)
动作职责：无；
## 联机交互动作职责图解
### 联盟内部发起
![](media/image13.png)
### 联盟外部发起
![](media/image14.png)
## 应用场景分析
### 场景一：联盟统建系统内部发起的交易
![](media/image15.png)
联盟统建系统内部发起的交易，统一流水号、调用路径号应从交易发起的最前端（例如：网上银行、手机银行APP、柜面系统等）生成。上图中，手机银行APP作为交易发起点，统一流水号、调用路径号应从此处生成。
说明：
H5页面、SDK等能力开放平台，作为联盟统建系统的延伸，也认为是交易发起的最前端系统。
上图中APP Server，是一个组合交易节点。
### 场景二：联盟端第三方系统发起的交易
![](media/image16.png)
联盟端第三方系统发起的交易，统一流水号、调用路径号应从第三方系统最先调用的联盟统建系统的组件处生成。
### 场景三：行内外围系统发起的交易
![](media/image17.png)
成员行内外围系统发起的交易，直连成员行ESB，再调用联盟ESB，统一流水号、调用路径号应从成员行ESB处生成，与场景二相同。
### 场景四：人民银行发起的来帐交易
![](media/image18.png)
人民银行发起的来帐交易，调用联盟二代支付系统（大小额），统一流水号、调用路径号应从联盟二代支付系统处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
![](media/image19.png)
人民银行发起的来帐交易，调用联盟网银互联系统，统一流水号、调用路径号应从网银互联系统处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
### 场景五：银联发起的来帐交易
![](media/image20.png)
银联发起的来帐交易，调用联盟银联前置，进入联盟系统，统一流水号、调用路径号应从银联前置系统处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
ATM发起的交易，因ATM属于行内外围系统，与场景三相同。
### 场景五：网联发起的来帐交易
![](media/image21.png)
网联发起的来帐交易，调用XBUS，进入联盟系统，统一流水号、调用路径号应从XBUS处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
### 场景六：联盟内部系统批量、定时任务
![](media/image22.png)
联盟统建系统内部通过批量、定时任务或其他方式自动发起的任务，统一流水号、调用路径号应从发起任务的系统处生成，与场景一相同。
### 场景七：消息推送类场景
![](media/image23.png)
消息推送类业务，例如由于用户帐户变动而触发的，由联盟统建系统内部CBUS核心发起的通知推送，通过ESB调用微信前置、XBUS相关服务，发送到微信公众号、短信平台等第三方系统，最终推送到用户手机上。统一流水号、调用路径号应从发起任务的CBUS核心处生成，与场景一相同。
## 传递规则
### 分布式域
分布式域在交易路径跟踪里，作为一个黑盒来处理，内部的跟踪串联由自身完成。
### 中间件组件
**容器类**：如果此类组件可以按照要求输出跟踪日志，则可作为交易路径上的节点体现，否则不需要在交易路径中体现。
**消息传输类**：如果此类组件可以按照要求输出跟踪日志，则可作为交易路径上的节点体现，否则不需要在交易路径中体现。
**负载均衡类**：如果此类组件可以按照要求输出跟踪日志，则可作为交易路径上的节点体现，否则不需要在交易路径中体现。
### 数据库组件
数据库组件不需要在交易路径中体现。
### 专用组件
例如安全加密设备、第三方前置，此类组件不需要在交易路径中体现。
### 第三方系统
交易调用路径中，联盟统建系统调用第三方系统时，如果是单向消息模式的调用，调用完成后携带统一流水号继续后续操作即可；如果是请求应答模式的调用，则等待第三方系统返回后，根据上下文找到原来的统一流水号继续后续操作。
无论是从第三方系统向联盟统建系统发起的服务调用，还是联盟统建系统向第三方系统发起的服务调用，调用路径号均应做深度、广度递增处理，由联盟统建系统供接口、需接口的相关接收或发送动作来处理。
### 历史负债直连系统
关于历史负债的系统直连的问题，也就是没有经过ESB，也没有按照ESB的报文规范来的，不在交易路径跟踪方案考虑范围之内。
## 持久化规则
### 持久化到日志文件
全局统一流水号、调用路径号，都应该在交易路径上各应用系统的日志文件中输出（详见后文的跟踪日志规范），用来支撑基于日志分析的交易路径跟踪和监控。
### 持久化到数据库
全局统一流水号应该在交易路径上各业务类系统的数据库中保存，用来支撑大数据平台开展数据整合、数据质量核检等功能。
## 报文规范支持
### ESB XML联机交易接口规范改造
新增三个报文头字段：
  -----------------------------------------------------------------------------------------------------------------
  XPATH              /Service/Service_Header                        
  ------------------ ------------------------- ------ ------ ------ -----------------------------------------------
  字段名称           字段中文名称              长度   必填   属性   内容说明
  global_trace_num   全局统一流水号            45     M      C      参考上文全局统一流水号规范
  global_path_num    调用路径号                45     M      C      参考上文调用路径号规范
  client_sysid       服务请求方系统编号        11     M      C      服务请求方填写。编号规则由ESB进行制定与管理。
  -----------------------------------------------------------------------------------------------------------------
### 核心CICS报文改造
（1）普通联机报文
新增两个报文头字段：
  --------------------------------------------------------------------------------------------
  字段名称               字段中文名称         类型   长度   内容说明
  ---------------------- -------------------- ------ ------ ----------------------------------
  INM-GLOBAL-SEARCH-NO   全局统一流水号       C      45     联盟交易路径跟踪日志统一规划需要