，IP地址与子网掩码做与运算可以得到网络号,
子网地址范围140.252.20.64~140.252.20.79
网络号
子网掩码
表 36.2.划分子网的例子2
子网地址范围140.252.20.0~140.252.20.255
子网掩码
表 36.1.划分子网的例子1
IP地址 
网络号 
IP地址
140.252.20.64
255.255.255.240
140.252.20.68
140.252.20.0
255.255.255.0
140.252.20.68
，本来网络号是24位的，但是这8个站点通过同一个ISP（Internet service
多个子网就可以汇总（summarize）成一个Internet上的网络，
一个路由表项，
，但是RFC 1918规定了用于组建局域网的私有IP地址，这些地址不会出
 IP地址只用于局域网内的通信,
称为CIDR （Classless Interdomain Routing）
，数据包通过Internet上的路由器到达ISP，然后在ISP这边再
负担越来越重。
 主机号从全0到全1就是子网的地址范围。IP地
8C FC 14 40
FF FF FF FO
8C FC 14 44
8C FC 14 00
FF FF FF 00
8C FC 14 44
只有低三位不同，这8个站点就可以汇
，而不直接连到Internet上,
而不能由IP地址本身的数值决定,
，因此称 
。网络号和主机
例如，有8个
、理论上
684
---
## Page 685
路由 (名词)
下面介绍路由的过程，
还有一些不能用作主机IP地址的特殊地址：
回给上层协议和应用程序，主要用于测试。如下图所示（该图出自[ICPIP1）
或者与本机其它网络设备的IP地址相同，则数据包不会发送到网络介质上，而是通过环回设备再发
除了私有IP地址之外，
·目的地址为255.255.255.255，表示本网络内部广播，路由器不转发这样的广播数据包。
数据包从源地址到目的地址所经过的路径，
示广播至192.168.10.0网络（假设子网掩码为255.255.255.0）。
目的地址的主机号为全1.
为255.255.255.0）。
主机号全为0的地址只表示网络而不能表示某个主机，
图 36.10.loopback设备
环回驱动程序
放入IP输入
队列中
首先正式定义几个名词：
IP输出
 还有几种特殊的IP地址。
函数
1
 表示广播至某个网络的所有主机，
否取
是
以太网地址
目的主机的
是
用ARP获
目的IP地址是否与接
地址或多播地址相同？
目的IP地址是否与广播
口IP地址相同？
127*的IP地址用于本机环回(loop back)测试,
，由一系列路由节点组成。
ARP
1
以太网
ARP
，如果发送数据包的目的地址是环回地址，
，如192.168.10.0（假设子网掩码
IP输入
函数
类型进行分用
基于以太网帧
例如目的地址192.168.10.255表
放入IP输入
I
接收
动程序
以太网驱
8
通
---
## Page 686
假设某主机上的网络接口配置和路由表如下：
缺省路由条目
路由条目
路由表
接口
路由节点
路由 (动词)
组成，
路由表中的一行，
最
由很多路由条目组成，
路由节点与某个网络相连的网卡接口。
发送数据包。
某个路由节点为数据报选择投递方向的选路过程。
路
下一跳地址。
10
Mask:255.255.255.0
ethl
Mask:255.255.255.0
etho
行都不匹配时，
由表中的最后
后一条是缺省路由条目。
一个具有路由能力的主机或路由器，
S
ifconfig
如果要发送的数据包的目的网络地址匹配路由表中的某一行，就按规定的接口发送到
collisions:0 txqueuelen:0
如双
Link encap:Local Loopback 
col:
UP
Link encap:Ethernet 
Interrupt:l0 Base
UP
inet
Link encap:Ethernet.
inet
inet
CO1
LOOPBACK RUNNING
bytes:55551
 packets:110 errors:0 dropped:0 overruns:0 carrier:0
packets:
BROADCAST RUNNING MULTICAST
 bytes:0
 packets:10 errors:0 dropped:0 overruns:0 carrier:0
 packets:0
 BROADCAST RUNNING MULTICAST
就按缺省路由条目规定的接口发送到下-
一行，
 每个条目主要由目的网络地址、
Lisions:0
主要由下一跳地址和发送接口两部分组成，
，每个条目都指明去往某个网络的数据包应该经由哪个接口发送，其中
：603
 Base address:0x10c0
0.0
e address:0x10a0
，它维护一张路由表，
TX
MTU:16436
Mask:255.0.0.0
Kb)
 HWaddr 00:0C:29:C2:8D:88
 HWaddr 00:0C:29:C2:8D:7E
 dropped:0 overruns:0
bytes:420 (420.0 b)
Tx bytes:7601 (7.4 Kb)
 子网掩码、
 Metric:1
 MTU:1500
 MTU:1500 Metric:1
 通过查询路由表来决定向哪个接口
一跳地址。
下一跳地址、发送接口四部分
Metric:1
 当目的地址与路由表中其
carrier:0
 frame:0
8
---
## Page 687
4.IP数据报格式
跳地址。
如果要发送的数据包的目的地址是202.10.1.2，跟前三行路由表条目都不匹配，那么就要按缺省路
是与eth1接口直接相连的网络，因此可以直接发到目的主机，不需要经路由器转发。
到192.168.56.0,
到192.168.56.0,
如果要发送的数据包的目的地址是192.168.56.3,
址方
到192.168.56.0/24网络。
思
条
这台主机有两个网络接口,
上一页
条目，
是与本机接口直接相连的网络，
目）
，从eth0接口发出去，首先发往192.168.10.1路由器，再让路由器根据它的路由表决定下-
 G标志表示此条目的下-
192.168.56.0
192.168.10.0
Destination
Kernel
$ route
127
eth1
etho
7.0.0.0
Iface
 IP routing table
正是第二行的目的网络地址，
与第-
RX bytes:3020 (2.9 Kb) TX bytes:3020 (2.9 Kb)
一行的目的网络地址不符,
。路由表的Destination是目的网络地址，
192.168.10.1
Gateway
lface是发送接口，
一个网络接口连到192.168.10.0/24网络，
一跳地址是某个路由器的地址，
，不必经路由器转发，因此下一跳地址处记为*号。
全国嵌入式人才培训基地
o·0·o·0
255.0.0.0
255.255.255.0
255.255.255.0
 Genmask
起始页
上一级
因此从eth1接口发送出去，
Flags中的U标志表示此条目有效（可以禁用某些
再跟第二行的子网掩码做与运算得
 跟第一行的子网掩码做与运算得
 没有G标志的条目表示目的网络地
：Genmask是子网掩 
Flags Metric Ref
UG
，另一个网络接口连
C
由于192.168.56.0/24正
C
0
6.UDP段格式
8
下一页
---
## Page 688
IP首部：每一个字节0x45包含4位版本号和4位首部长度，版本号为4，即IPv4，首部长度为5，
型0x0800表示IP。
0010: 00 53 93 25 00 00 80 11 25 ec c0 a8 00 37 c0 a8
6.UDP段格式 请点评
以太网首部：源MAC地址是00:05:5d:61:58:a8，
0060:00
:0. 00,a..Z..S. 00.0.. 00.n..O,w, :.0500
0040: "'00 "b""k"s""z"e'00 '5"1"2'00 't"'
0030: 'w"e"r"g"."q"w"e'00'n"e"t"a"s"c"i
0020:
TFTP协议
0020:
JDP首部
0020:00 01
0000:
IP首部
0000: 00 05 5d 67 d0 b1 00 05 5d 61 58 a8 08 00
以太网首部 
下面分析一帧基于UDP的TFTP协议帧。
下图是UDP的段格式（该图出自[ICPIP])
上二
图 36.11.UDP段格式
 05 d4 00 45 00 3f ac 40
 00 01'c":"\"g'
16位UDP长度
16位源端口号
4500
第36章TCP/IP协议基础
全国嵌入式人才培训基地
数据(如果有)
6.UDP段格式
1516
目的MAC地址是00:05:5d:67:d0:b1，
16位UDP检验和
16位目的端口号
，上层协议类
8字节
688
说
---
## Page 689
因此，使用UDP协议的应用程序必须考虑到这些可能的问题并实现适当的解决方案，例如等待应
前面提过，UDP协议不面向连接，也不保证传输的可靠性，例如：
想这是为什么。
很多服务有well-known的端口号，
known的服务端口和对应的传输层协议，
在使用客户端程序时，
的80端口，
址和端口号唯一
一般的网络通信都是修
tsize 0
timeout 10
blksize 512
netascii
c:lqwerq.qwe
的各字段是：
TFTP是基于文本的协议，各字段之间用字节0分隔，开头的00 01表示请求读取一个文件，接下来
度。UDP首部和UDP层payload的校验和为Oxac40。
UDP首部：源端口号0x05d4（1492）是客户端的端口号,
01（192.168.0.1）。
部校验和为0x25ec,
据报没有更多分片，
节。IP报标识是0x9325，
明IP首部不带有选项字段。
·接收端的UDP协议层只管把收到的数据根据端口号交给相应的应用程序就算完成任务了，如
客户端程序时由系统自动分配一个空闲的端口号，
程的端口号，
的TFTP服务进程，
包，UDP协议层并不报告这种错误。
果发送端发来多个数据包并且在网络上经过不同的路由，到达接收端时顺序已经错乱
因为网络故障该段无法发到对方，UDP协议层也不会给应用层返回任何错误信息。
处理，
了，UDP协议层也不保证按发送时的顺序交给应用层。
，FTP服务默认TCP协议的21端口，
，如果应用程序提取和处理的速度很慢，而发送端发送的速度很快，就会丢失数据
一标识了该主机上的TFTP客户端进程,
所以
，源主机IP是c0 a8 00 37（192.168.0.55），目的主机IP是c0 a8 00
，没有分片偏移。TTL是0x80，也就是128。上层协议0x11表示UDP协议。IP首
像TFTP协议这样,
必须指定服务器的主机名或IP地址，如果不明确指定端口号则采用默认端
由于客户端是主动发起请求的一方,
一些常见的网络协议有默认的服务器端口，
 标志字段和片偏移字段设置为0x0000，就是DF=0允许分片，MF=0此数
。服务类型为0，
，然而客户端程序的端口号却不必是well-known的，往往是每次运
通信的双方分别是客户端和服务器，
没有使用服务。
 而服务器被动地等待、接收和应答请求。客户端的IP地
TFTP服务默认UDP协议的69端口（如上例所示）
 加上以太网首部14字节可知整个帧长度是97字
为了清晰，
用完就释放掉，
 服务器的IP地址和端口号唯一标识了该主机
UDP
，它必须知道服务器的IP地址和TFTP服务
，目的端口号0x0045（69）是TFTP服务
16位总长度字段（包括IP首部
IANA规定这样的服务采用相同
 例如HTTP服务默认TCP协议
称为ephemeral的端口号，想
 客户端主动发起请求
689
---
## Page 690
5.IP地址与路由
看TCP协议如何用面向连接的服务来代替应用程序解决传输的可靠性问题。
于传送小文件（所以才叫trivial的ftp）
发送一些对可靠性要求不高的消息，
答、超时重发、
一页
为数据包编号、
流量控制等。
而不发送大量的数据。
全国嵌入式人才培训基地
，而基于TCP的FTP协议适用于各种文件的传输。下面
起始页
一般使用
级
例如，
协议的应用程序实现都比较简单,
基于UDP的TFTP协议一般只用
7.TCP协议
690
下一页
只是
---
## Page 691
7.2.通讯时序 请点评
TCP的段格式如下图所示(该图出自[TCPIP])
7.1.段格式 请点评
7.TCP协议 请点评
内。紧急指针和各种选项的解释从略。
释SYN、ACK、FIN、RST四个位，
最短20字节。URG、ACK、PSH、RST、SYN、FIN是六个控制位，
度
和UDP协议一样也有源端口号和目的端口号，
上一页
以4字节为单位,
图36.12.TCP段格式
4位首部
长度
 因此TCP协议头最长可以是4x15=60字节，
保留(6位)
16位源端口号
16位检验和
URG
 其它位的解释从略。16位检验和将TCP协议头和数据都计算在
ACK
第36章TCP/IP协议基础
PSH
全国嵌入式人才培训基地
S
选项
ZKS
数据
7. TCP协议
，4位首部长度和IP协议头类似，
Z
15
 通讯的双方由IP地址和端口号标识。32位序 
32位确认序号
32位序号
16位窗口大小
16位目的端口号
16位紧急指针
 如果没有选项字段，TCP协议头
 本节稍后将解 
表示TCP协议头的长
---
## Page 692
建立连接的过程: