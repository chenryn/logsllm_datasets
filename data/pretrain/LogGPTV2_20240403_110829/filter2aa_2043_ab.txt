    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:env="http://schemas.xmlsoap.org/soap/envelope/">
      blah
TL;DR
But what can you do with it?
But what can you do with it?
• Control AV equipment
• Home automation
• Network administration
• Physical security systems (ok, easy there buddy)
• Industrial monitoring and control (uh…what?)
• And this is just the oUcial specs
Neat, so…
• All our devices can talk to each 
other!
• Brave new worlds of remote control 
and automation!
• Have your toaster turn on the 
lights, set the TV to the news 
channel, and send you a text 
message when breakfast is ready!
• The future is now!
• Nothing could possibly go wrong!
And the bad things…
What about security?
• Embedded devices
• Limited memory and processing power
• Board dev and software dev are often completely diVerent companies
• Copy-and-paste development
• Keep costs low
• Not exactly concerned/knowledgeable
• Deployment
• Millions of internet-facing UPnP-enabled devices
• Too many vendors to count
• Frontend is standardized, backend varies even within same vendor
• DiUcult to patch/update Brmware
• Just because you can, doesn’t mean you should
What about security?
• XML parsing is hard
• Needs lots of system resources
• Free-form, user-supplied data
• In 2013, 2.5% of CVE’s were XML-related[2]
• Of those, almost 36% had CVSS severity of 7 or above
• As the use-case for XML grows, so do the classes of vulns
• Recursion bugs, XXE, command injection, etc…
[2] http://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=xml
Attack surface
• UPnP service
• HTTP header parsing
• SSDP parsing
• OS command injection
• Information disclosure
• SOAP service
• HTTP header parsing
• XML parsing
• Injection vulns
• OS command
• SQL injection
• SOAP injection
• Information disclosure
• Ridiculous levels of unauthenticated device control
Attack surface – UPnP
• CVE-2012-5958
• Disclosed a couple years ago by HD Moore (one of many)
• https://community.rapid7.com/docs/DOC-2150
• Calls strncpy to copy a string from the ST header into 
TempBuf[COMMAND_LEN]
• Size argument for strncpy is based on number of characters between colons
Attack surface – UPnP
• CVE-2012-5958
• Disclosed a couple years ago by HD Moore (one of many)
• https://community.rapid7.com/docs/DOC-2150
• Calls strncpy to copy a string from the ST header into 
TempBuf[COMMAND_LEN]
• Size argument for strncpy is based on number of characters between colons
M-SEARCH * HTTP/1.1
Host:239.255.255.250:1900
ST:uuid:schemas:device:[string longer than 
COMMAND_LEN]:blah
Man:"ssdp:discover"
MX:3
Attack surface – UPnP
• D-Link DIR-815 UPnP Command Injection
• Disclosed Feb 2013 by Zach Cutlip
• http://shadow-Ble.blogspot.com/2013/02/dlink-dir-815-upnp-command-injectio
n.html
• Contents of ST header get passed as arguments to M-SEARCH.sh
• No validation or sanitization
Attack surface – UPnP
• D-Link DIR-815 UPnP Command Injection
• Disclosed Feb 2013 by Zach Cutlip
• http://shadow-Ble.blogspot.com/2013/02/dlink-dir-815-upnp-command-injectio
n.html
• Contents of ST header get passed as arguments to M-SEARCH.sh
• No validation or sanitization
M-SEARCH * HTTP/1.1
Host:239.255.255.250:1900
ST:uuid:`[shell command]`
Man:"ssdp:discover"
MX:3
Attack surface – SOAP
• AirTies RT Series SOAPAction Name BuVer Over]ow
• Disclosed earlier this year by Onur Alanbel
• https://www.exploit-db.com/exploits/36839/
• ExecuteSoapAction function allocates statically-sized buVer
• Calls memcpy to copy value of SOAPAction header into it with no bounds 
checking
Attack surface – SOAP
• AirTies RT Series SOAPAction Name BuVer Over]ow
• Disclosed earlier this year by Onur Alanbel
• https://www.exploit-db.com/exploits/36839/
• ExecuteSoapAction function allocates statically-sized buVer
• Calls memcpy to copy value of SOAPAction header into it with no bounds 
checking
POST / HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: "n:schemas-upnp-org:service:WANIPConnection:1# 
[more than 2048 bytes]"
Content-Length: [length of req]
Host: x.x.x.x:5555
Attack surface – SOAP
• Broadcom SetConnectionType Format String Vulnerability
• Disclosed a couple years ago by Leon Juranic and Vedran Kajic
• http://sebug.net/paper/Exploits-Archives/2013-exploits/1301-exploits/DC-2013
-01-003.txt
• SetConnectionType action feeds value of NewConnectionType argument to 
snprintf
• No sanitization of user-controlled value
Attack surface – SOAP
• Broadcom SetConnectionType Format String Vulnerability
• Disclosed a couple years ago by Leon Juranic and Vedran Kajic
• http://sebug.net/paper/Exploits-Archives/2013-exploits/1301-exploits/DC-2013
-01-003.txt
• SetConnectionType action feeds value of NewConnectionType argument to 
snprintf
• No sanitization of user-controlled value
    [format 
string]
Attack surface – SOAP
• CVE-2014-3242
• Disclosed last year by pnig0s
• http://www.pnigos.com/?p=260
• SOAPpy allows declaration of user-deBned XML External Entities in SOAP 
request
• No sanitization of user-controlled value
Attack surface – SOAP
• CVE-2014-3242
• Disclosed last year by pnig0s
• http://www.pnigos.com/?p=260
• SOAPpy allows declaration of user-deBned XML External Entities in SOAP 
request
• No sanitization of user-controlled value
]>
      &xxe;
Attack surface – SOAP
• CVE-2014-2928
• Disclosed last year by Brandon Perry (PBerry Crunch!)
• http://seclists.org/fulldisclosure/2014/May/32
• F5 iControl API set_hostname action passes value of hostname argument to 
shell
• Once again, no sanitization of user-controlled value
Attack surface – SOAP
• CVE-2014-2928
• Disclosed last year by Brandon Perry (PBerry Crunch!)
• http://seclists.org/fulldisclosure/2014/May/32
• F5 iControl API set_hostname action passes value of hostname argument to 
shell
• Once again, no sanitization of user-controlled value
    `[shell command]`.whatever.com
Attack surface – SOAP
• Netgear R6200 SetFirmware fun
• Spread across a series of blog posts starting in April 2015 (Zach Cutlip again)
• http://shadow-Ble.blogspot.com/2015/04/abandoned-part-01.html
• Dead/non-functional code that shipped with the device…
• Multiple vulnerabilities
• No authentication
• And he works around the fact that the code doesn’t work to upload modiBed 
Brmware images anyway
DEMO TIME
Conclusion
Playing along at home
• Know your network
• M-SEARCH every network you connect to
• Watch for new NOTIFY messages
• If you don’t need UPnP, disable it
• If not on the device, then at the router
• Keep on top of Brmware updates
• Not always automatic
Playing along at home
• Fuzz the crap out of it
• Burp – http://portswigger.net/burp/
• WSFuzzer – 
https://www.owasp.org/index.php/Category:OWASP_WSFuzzer_Project
• Miranda – http://code.google.com/p/miranda-upnp/
• My stuV…if I ever release it, which I probably won’t…
Hit me up
• @HeadlessZeke on twitter
• Usually lurking on freenode as HeadlessZeke
• PI:EMAIL 
Thank you!