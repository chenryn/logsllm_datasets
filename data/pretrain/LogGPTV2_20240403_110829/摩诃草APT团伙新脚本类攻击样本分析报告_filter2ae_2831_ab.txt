  2. 指令下发
远控服务器是通过不同的HTTP状态码来下发控制指令，受控端会进行判断。
在返回的HTTP数据包头中，Date字段中存放服务器返回的机器码。
受控端会对服务器下发的控制信息进行解密，解密算法如下：
其解密密钥为136字节。
    EC1ABCB66F641126C2250C5CF26C9902BD53043EAAF5FE0374597261674FD732E2C0498A9FA06203C5641323C3B4DDCB5CD8A22A0EDCAE39A11D7E98A2B1B6276C595E7CC1E1A0C743B8C075416C7DB3CB509AB5059556E99D2818BDDDEEE508AC871474239CC4B5527A8AED49949D5A421C785484ED084F1FCD3D3CFD1D8D8B
  3. 回传数据
受控端接受到控制服务器下发的指令后，会根据HTTP返回的状态码确定要执行的命令，例如返回码是203的时候就会上传执行，返回码是202的时候就会截屏和获取进程列表。
并且上传数据按如下格式构造：
4个字节长度 + 1字节token + 加密后的内容。
例如这里执行获取屏幕截屏和进程快照信息，并加密发送到控制服务器。
###  功能小结
该远控模块实现了以下控制命令，包括：
  * 上传执行脚本
  * 上传执行PE
  * 回传屏幕截屏
  * 回传进程列表
其使用HTTP协议进行控制通信，采用这种控制协议也更便于攻击者使用Web页面来可视化控制和管理失陷主机，其HTTP协议通信步骤如下：
  * 机器中木马后，会每隔不定时间间隔去连接C&C服务器的80端口，根据HTTP协议发送touch包，发送的http数据包的GET数据中包括编码后的长度随机的机器码。
  * 服务器收到touch包后，会记录下来最近一次活跃时间，判断是否在线。
  * 服务器如果需要对受控端进行控制，就会回一个202或者203的HTTP状态码，下发指令。下发的指令是在http数据段里面，数据包格式为4个字节长度+1个字节token+加密后的内容。
  * 受控端收到命令后，会判断服务器返回的http状态码，根据不同的状态码去解析数据包去执行不同的命名，然后把执行后的结果回传给服务器。
  * 控制者可以通过对服务端的Web界面对受害者进行控制。
交互操作可以总结为如下图：
## 关联分析与回溯
360威胁情报中心通过对PowerShell Loader脚本中的关键字搜索，发现了其在一个VPS主机上搭建的Web控制端页面。
主控端的界面如下，最后一次测试时间应该在2017年6月，已经在近半年以前。
通过该Web管理后台可以对受控机器进行控制操作。
另外一个Loots页面保存了控制端发送控制指令后的一些日志数据，包括执行命令、上传文件、截屏、下载文件、执行脚本的功能。
我们从日志数据中找到了一个名为setup.js的脚本文件，其代码和我们分析的laksasokpaslkak.js的代码大致一样。
通过把该脚本中的DLL数据用同样的方法解密出来后，发现和前面分析的远控模块socksbot.dll完全一样，其C&C为46.166.163.243，与测试机IP
46.166.163.242属于同一网段。
查询360威胁情报平台数据确定其属于“摩诃草”组织。
我们可以看到测试机执行命令后的一些结果日志。
执行ipconfig命令的结果。
我们还发现攻击者曾在测试机上测试上传其另外的远控木马程序和从远程地址下载恶意载荷。
这个Web版木马控制端程序的网站域名（yds.deckandpatio.ca）绑定的IP地址为91.235.129.203。
这个IP的别名为：vds8262.hyperhost.name。
我们发现其是在一个乌克兰的服务商上申请注册的VPS服务器，其服务商官网为https://hyperhost.ua/ru。而yds.deckandpatio.ca这个域名应该是其提供的一个免费的二级域名。
## 总结
通过分析“摩诃草”组织最新制作并投入使用的攻击恶意代码，攻击者选择脚本类语言来重新实现攻击载荷的投放组件，可能源于其对开发工具的便利性和效率的倾向性。
虽然我们没有明确线索证实该次针对乌克兰人员的攻击事件中该类攻击脚本是如何诱导受陷用户下载和运行的，但根据其过去的攻击模式推测，其可能采用如下几种方式。
  * 构造包含有恶意脚本的自解压执行的压缩包；
  * 鱼叉攻击，并附带有包含恶意脚本的压缩包文件或附有恶意脚本压缩程序下载的钓鱼链接；
  * 在社交网络上发送附有恶意脚本压缩程序下载的钓鱼链接；
也不排除其可能通过入侵网站，在页面植入恶意脚本代码的方式。
从“摩诃草”过去采用的攻击模式和使用的恶意代码技术来看，该组织比较偏好于使用脚本和C#来开发攻击工具的习惯。我们推测其更倾向于选择能够快速开发和实现攻击的方式，并且通过不断更新和变化的攻击工具来逃避检测和隐藏其攻击行径。攻击者还制作了可用于Web管理的控制后台程序来方便大规模管理和控制受陷主机。
从我们发现的攻击者注册的VPS服务器及其Web控制页面，攻击者发起新的攻击和使用新的恶意代码工具至少会提前半年进行准备和测试。
目前我们还无法推测其发起此次攻击事件的动机，可能是该组织针对东欧部分国家发起的定向攻击，也不排除是其发起的一次基于新制作的攻击武器的一次实战演练。所以我们在此对该类恶意代码的部分技术细节进行披露，以便于提前防御该组织在未来的攻击行动中进一步大规模使用该类攻击恶意代码。
## 参考链接
【1】2016.8.4 360威胁情报中心
【2】2017.11.30 360威胁情报中心
【3】PowerShell ReflectivePEInjection脚本
## IOC列表
C&C服务器  
5.8.88.64  
文件名  
laksasokpaslkak.js  
互斥体  
Global\\\\[num]stp  
Global\\\\[num]nps  
解密密钥
    EC1ABCB66F641126C2250C5CF26C9902BD53043EAAF5FE0374597261674FD732E2C0498A9FA06203C5641323C3B4DDCB5CD8A22A0EDCAE39A11D7E98A2B1B6276C595E7CC1E1A0C743B8C075416C7DB3CB509AB5059556E99D2818BDDDEEE508AC871474239CC4B5527A8AED49949D5A421C785484ED084F1FCD3D3CFD1D8D8B