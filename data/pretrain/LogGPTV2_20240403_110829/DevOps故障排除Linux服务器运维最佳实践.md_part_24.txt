---
## Page 158
net，可以加载 http://www.example.net/server status 页面，如图 8-1
的 /server-status 页面。假设你的Web 服务器域名是www.example.
个点对应一个 Web 服务器进程，在进程上使用的字符表明进程正在
但记分板对快速了解服务器的运行状况尤为方便。在记分板里，每
眼即可看出你的Web 服务器繁忙程度。最底部是一个表格，展示了
网络流量，以及每秒响应多少Web 请求。接下来是一个记分板，
正在运行的 Apache 的版本号、服务器已经运行多长时间、所有的
所示。
做什么工作：
每个进程处理的最后一个请求详情。
Apache ServerStatus for localhost
尽管所有的这些数据在各种各样的故障排除情况下都非常有用
在状态页的顶部，你会看到Web 服务器的综合统计信息，包括
进程正在启动
等待连接
口
"Looglng,"
图8-1标准的 Apache 状态页
8.5获取Web服务器统计数据·151
Request
---
## Page 159
152
●第8章网站宕机了？追踪Web服务器问题
些处于“_”（等待连接）状态的进程，它们是Apache 根据配置文件
置文件中 MaxClients 的值（Apache可创建的最大进程数）。
分被“.”填充，表明是为新进程预留的地方—这个数量取决于配
预启动的一些进程，可以用来接收新的服务请求。计分板的其余部
处理了本例中查看状态页面的请求。你还会注意到在记分板上的一
程的编号是2-16。这在图8-1中不是很明显，实际上正是这个进程
板上找到对应编号的进程。举例来说，可以找到那个处于W状态进
奇这些进程都在做什么，
活）状态的进程和一个处于W（发送响应）状态的进程。如果你好
图8-1显示了一个相当空闲的 Web 服务器，只有一个处于K(存
清理闲置工作
进程正常结束
记录日志
正在关闭连接
执行 DNS查询
OD
保持进程存活，以便发送多个文件
K 
发送响应
正在读取请求
空闲，
OR
DG
OL
DC
，当前没有进程
只需要向下滚动页面到表格部分，在记分
---
## Page 160
息。但是，如果你将 auto 选项传递给服务器状态页，那么得到的文
过curl命令访问服务器状态页面，得到的将是HTML格式的输出信
页，同时仍然提供你所需要的信息。现在，默认情况下，如果你通
序访问服务器状态页。这可以限制哪些主机可以访问服务器状态
态，最终因为不再需要而被销毁。
处理服务请求，随着服务高峰退去，这些进程慢慢地转换为空闲状
即可。在服务高峰期间，你能看到新的进程被创建并切换到W状态
改变。记分板便于你随时留意服务器的状态，只要不断地刷新页面
你指定的命令(默认情况下是2秒)。所以如果你想时刻关注状态页
令，但是你还可以使用更简便的watch 命令，它会每x秒运行一次
本输出无论是对命令行查询还是脚本解析都很有帮助。
面，让其保持每5秒刷新一次，可以输入：
一般来说，你会登录到web 服务器所在主机上，用命令行程
当刷新页面时，你会发现记分板上的数据每次请求时都会发生
$watch-n 5'cur1http://localhost/server-status?auto
若想在命令行中监视服务器状态页，当然可以反复运行curl命
$curlhttp://localhost/server-status?auto
Scoreboad:wkkwwwwwwwwwwwwwwwwkkkkkw.w.
117586117
Busyworkers:
BytesPerReq:116210
BytesPerSec:40036.7
ReqPerSec:.34452
Uptime:6801454
PULoad:.0773742
Total Accesses:2343235
otalkBytes:265925501
%Total
%Received%XferdAverage SpeedTime
3
5860
02579
0--1----------------
Dload UploadTotal
0 --:--:----:--:------:--257911758611
8.5获取Web服务器统计数据·153
Time
Spent
Left Speed
Time Current
---
## Page 161
154
查找：
户)。语法检查成功的一个示例如下所示：
时验证自己的配置文件，这是发现配置错误的一种方法，遗憾的
8.6.1
题拥有一些可识别的症状。本节将重点介绍一些你可能会碰到的常
8.6解决常见的Web服务器问题
的。幸好这两种 Web 服务器都提供运行时测试配置文件语法的方
器拒绝启动。
加载新的 SSL证书）在你的配置文件中存在语法错误从而导致服务
可能会发现服务器需要维护的时候（或当你需要重新启动服务器，
可能多次修改了配置文件而没有重启Web 服务器。如果是这样，你
于 Web服务器需要重新加载配置文件才能使修改的配置生效，因而
见问题、这些问题的症状以及如何去修补它们。
服务器问题都记录下来，但你很可能会碰到几类常见问题，这些问
是，
，这也意味着一旦出现问题，在修复错误期间服务器是无法启动
在 Web 服务器上，一个常见和相对简单的问题是配置问题。由
无论是Apache还是Nginx 都会在启动、重启或重新加载服务
第8章
如果存在语法错误就会高亮显示。
Apache 检测配置文件语法的命令是 apache2ctl configtest，确
当语法有错误时，该命令将指出错误所在的文件和行号以便于
虽然很难将解决Web服务器问题的全部步骤以及所有的Web
只需要按Ctrl-C 组合键就可以退出这个程序。
SyntaxOk
$sudo apache2ctl configtest
配置问题
网站宕机了？追踪Web服务器问题
---
## Page 162
然后使用curl命令加载这个页面。
身份运行，但实际上用来提供服务的子进程都以限制权限的用户身
务器管理员来说更是如此。虽然 Apache 和Nginx 初始进程以 root
8.6.2
改主页 index.html文件的权限，使任何人都没有读取该文件的权限。
到你确保 www-data 或 apache 用户对每个文件都是可读的。
所在文件和行号：
/etc/apache2/conf.d。
一个不同用户身份上传网页，一开始你可能就会碰到权限问题，直
份运行，例如，用户www-data或者apache。举个例子，如果你以
那么，权限问题从表面看起来有什么症状？以Nginx为例，更
Web 服务器的权限问题是一个令人头疼的常见问题，对Web 服
Nginx 也提供语法检查方法，运行命令 nginx-t 即可:
$cur1 http://localhost
$sudo nginx -t
与Apache一样，
本例中配置文件有一处输人错误，你想包含的目录实际上是
403Forbidden
configuration file/etc/nginx/nginx.conf test failed
[emerg]: unknown directive "included" in /etc/nginx/nginx.conf:13
the configuration file /etc/nginx/nginx.conf syntax is ok
nginx/0.7.65
403Forbidden
sudo nginx-t
sudoapache2ctl configtest
权限问题
当Nginx检查到错误时，它也会告诉你错误
8.6解决常见的Web服务器问题●155
---
## Page 163
156
之后，确保将权限改回到更安全的级别。
份运行）以及上传文件的用户。如果你尝试使用“chmod 777”方法
的便捷。有个代替方法，考虑在系统中创建一个用户组，其成员包
组所有权，使得www-data用户组拥有该文件（或者设置为www-
检查该文件的权限，可以确定运行Nginx的用户www-data没有访
nginx-default/index.html，但是没有读取这个文件的权限。此时通过
来使用，用来确定这个问题确实是因为权限问题引起的。解决问题
将文件变为所有人可读写，应该只是将其作为一种临时的验证手段
含www-data或apache用户（取决于你的Web服务器以何种用户身
读写权限来回避权限问题，但这么做带来的安全风险要大于它带来
data 所在的用户组)。
可使所有用户拥有该文件的读权限。另外，也可以修改文件的用户
问这个文件的读权限：
时我们查看一下Nginx的错误日志：
知道该页面是被禁止访问的，但是不能确定具体的原因是什么。这
curl去显示：403Forbidden错误。遗憾的是，虽然从这个输出我们
喜8岁
虽然有些管理员可能会通过将所有文件设置为任何人都具有可
这种情况下，可以用chmod o+r命令来修复这个问题，该命令
从这个错误日志里我们可以发现，Nginx尝试打开/var/www/
从网页的输出中我们可以看到这个 http 错误，甚至不需要告诉
$ ps -ef I grep nginx
-rw-r-----1rootroot1512006-08-3003:39/var/www/nginx-default/index.html
1s-1/var/www/nginx-default/index.html
www-data
root
→HTTP/1.1", host: "localhost"
网站宕机了？追踪Web服务器问题
5
545015:19?
015:19?
00:00:00 nginx: worker process
00:00:00 nginx: master process /usr/sbin/nginx
---
## Page 164
到了暂时无法提供服务的程度。虽然引发这种问题的根源有很多，
8.6.3
容的CGI程序、PHP代码等。查看Web 服务器日志，尝试找出高
负载是CPU密集型的，那么你可能需要排查服务器用来动态产生内
型中的哪一种：CPU密集型、RAM 密集型或I/O密集型。
Web服务器进程造成的。如果是，你要学习确定负载是以下三种类
建更多的进程来处理当前请求负载，最终导致内存空间和交换空间
进程比驻留在内存中的进程响应慢得多，反过来这又将导致需要创
多进程，结果很多进程不得不使用缓慢的交换空间。这将导致这些
作模式下，就是设置MaxClient这个参数。当服务器收到大量请求
以设置响应 Web 服务的最大服务器进程数目。在Apache profork 工
器也会出现这样的情况。从本质上讲，当配置Web 服务器时，你可
能出现在 apache worker 工作模式下，甚至在特定条件下Nginx 服务
务器宕机的危险。这通常出现在Apache prefork工作模式下，也可
储，甚至可能耗尽全部内存，那么你可能会面临交换存储耗尽、服
的动态页面消耗了多少CPU资源。
服务器过载，可能需要在测试服务器上执行这个步骤）以测量不同
负载期间被访问的那些网页。然后尝试亲自加载它们（如果你的主
务器是否存在高负载问题，如果是的话，需要确认高负载是不是由
务器的负载。如果你还没有读过第2章，读一下以了解如何确定服
本节将介绍引发服务器性能迟缓的常见原因以及它们的症状。
的另一类常见的Web服务器问题却很难清晰描述一
时会创建很多Web服务器进程来提供服务，但是内存容纳不下这么
一旦确认负载过高并且是由Web 服务器进程引起的问题，如果
 高负载
如果负载是RAM密集型的，而且发现使用越来越多的交换存
虽然配置和权限问题已经描述得很清楚了，但可能你需要诊断
Web服务器性能迟缓或不可用
当服务器性能迟缓或暂时不可用时，我首先会检查服
8.6解决常见的Web服务器问题·157
一服务器好像慢
---
## Page 165
158
◆第8章网站宕机了？追踪Web服务器问题
何启用和查看服务器状态页面，在服务器性能迟缓或者无法提供服
以容纳多少个Apache 进程而不会将进程挪到交换分区。最终修改
全部消耗殆尽。
身高负载以外，还需要查看服务器的状态页。本章前面，讨论了如
完成请求之前等待每个DNS的查询结果。
向解析，以便IP地址转换成主机名。Web 服务器进程可能不得不在
的那台机器I/O 饱和引起的。或者，如果你允许日志中启用DNS反
Web 服务器本身而不是数据库，问题可能是由为你的网站提供服务
等待数据库响应仍然可能产生相当高的平均负载。