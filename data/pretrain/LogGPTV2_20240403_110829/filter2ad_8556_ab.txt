所使用的公钥被硬编码在程序中。
图 2 ‑ 6 加密所使用的公钥
除C:\Windows目录下外，所有盘符下的所有文件夹均会被加密。被加密的文件格式如下所示。
图 2 ‑ 7 被加密的文件格式
### 3.2.5 传播
该样本会释放出名为dllhost.dat的文件。该文件是微软Sysinternals工具集中的PsExec程序。该程序可用于在远程机器上执行命令。控制端和被控制端的数据传输都是通过445(Windows
2000)/135或139端口进行(非Windows 2000)。
### 3.2.6 日志清除
该样本使用了Windows自带的wevtutil工具进行日志清除工作。命令行如下所示。
图 2 ‑ 8 日志清除命令
# 4 风险防范与处置建议
## 4.1 影响操作系统
“必加”（Petya）勒索软件影响操作系统：Windows XP及以上版本；
## 4.2 如未被感染
1、邮件防范
由于此次“必加”（Petya）勒索软件变种首次传播通过邮件传播，所以应警惕钓鱼邮件。建议收到带不明附件的邮件，请勿打开；收到带不明链接的邮件，请勿点击链接。
2、更新操作系统补丁（MS）
3、更新Microsoft Office/WordPad远程执行代码漏洞（CVE-2017-0199）补丁
4、禁用WMI服务
禁用操作方法：
5、更改空口令和弱口令
如操作系统存在空口令或弱口令的情况，请及时将口令更改为高强度的口令。
6、免疫工具
安天开发的魔窟（WannCry）免疫工具，针对此次事件免疫仍然有效。
下载地址：
## 4.3 如已被感染
1、 如无重要文件，建议重新安装系统，更新补丁、禁用WMI服务、使用免疫工具进行免疫。
2、 有重要文件被加密，如已开启Windows自动镜像功能，可尝试恢复镜像；或等待后续可能出现解密工具。
# 5 总结
“必加”（Petya）一词一说为东欧女性的名字，来自斯拉夫语系；同时其更被作为一款前苏联的轻型护卫舰的名字。可以说，这个恶意代码从开始就展示出一定的地缘特点。“必加”（Petya）病毒所达成的后果，在勒索软件中是较为特殊的。其将导致计算机系统不能进入正常的系统启动流程，其即可达成勒索目的，其同样可以作为一种破坏载荷。由于其加密扇区，伪装成了系统卷出问题的磁盘检查过程，因此这种社工技巧，可以保证其完成加密作业的全程。而一旦其作为破坏载荷来使用，就同样可以达成和此前在乌克兰停电
[1]
、索尼攻击事件等破坏引导记录导致系统不能自举的同样效果。鉴于本次事件所发生的特殊的时点，因此安天分析小组认为，目前并不能得出本事件是完全以经济勒索为目的恶意代码攻击事件的结论，而还需要更多进一步的分析。
安天在2016年基础威胁年报 [2]
中，对比了“蠕虫时代的传播入口到勒索软件的传播入口”，对其复合型的传播趋势做了预判，而“必加”（Petya）新版本复合手段传播感染进一步看到，通过邮件进入到内部网络，在网内传播的方式，可能会带来比类似“魔窟”（WannaCry）
蠕虫这种单纯的扫描植入方式更严重的后果。但同时更值得警醒的是，“必加”（Petya）所使用的并非是0DAY漏洞，甚至也非1DAY漏洞，而是陈旧的漏洞，其他传播方式也是利用类似弱口令/空口令这种基本的配置问题。这些问题再次说明，系统策略加固和及时的补丁升级，是安全的必修手段。
通过类似邮件或浏览器等入口的单点注入、之后横向移动扫荡内部网络，这本身是传统定向攻击到APT攻击的基本手段，但由于APT攻击的隐蔽性，使多年类似的攻击存在，并没有有效驱动内网安全治理的改善。而勒索病毒攻击，是同样具有严重后果，同时却一种后果高度可见的安全风险。从“魔窟”（WannaCry）
到“必加”（Petya），其将许多信息系统的防护无效的情况全面暴露出来。
面对这种局面，与其夸大病毒本身的能力和威胁，不如认真思考安全基础工作的是否扎实。其应对不能更多立足于灾难响应、数据恢复甚至是破解解密，而必须立足于尽可能的防患于未然，最大程度将易被攻陷的节点减到最小。
2017年2月17日，习近平总书记在国家安全工作座谈会上指出“加强网络安全预警监测，确保大数据安全，实现全天候全方位感知和有效防护”，可以说，“有效”对关键信息技术设施保障的基本要求。如果说态势感知能力是信息安全的顶层价值，那么有效防护就是其能力的基本盘。没有有效防护这个基本盘，威胁情报等各种能力手段，都将无法对接落地、形成价值。
2015年起，安天根据勒索软件已经成为一种地下经济的商业模式，必然会推动其大规模蔓延爆发的判断，在终端防御智甲产品中增加了“加密行为识别”、“诱饵文件”等策略，使用2016年10月的智甲版本，在不升级病毒库和模块的情况下，就有效拦截“魔窟”（WannaCry）
等新兴勒索软件的加密行为。从安天的产品体系来看，达成有效防护、实现价值输出，则是我们一贯的追求。