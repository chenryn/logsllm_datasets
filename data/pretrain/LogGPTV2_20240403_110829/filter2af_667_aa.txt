## 0×01 引言
我们渗透的最终目的是获取服务器的最高权限，即Windows操作系统中管理员账号的权限，或LINUX操作系统中root账户权限。而在内网中，我们的最终目的就是获取域管理员账户或成为其中之一。今天要讲的就是如何通过一个普通的webshell权限一步步的获得域管权限，从而掌控整个内网。
## 0×02 渗透环境
此次渗透的环境：假设我们现在已经渗透了一台服务器PAVMSEF21，该服务器内网IP为10.51.0.21。经过扫描，内网网络结构大概如下图所示。其中我们控制的服务器是连接外网和内网的关键节点，内网其他服务器均不能直接连接。图还是我老婆画的，越来越漂亮了！:
)
## 0×03 反弹meterpreter
上传免杀的PAYLOAD到机器名为PAVMSEF21，IP为10.51.0.21的服务器上，然后在菜刀或者WEBSHELL下面运行，反弹成功。
## 0×04 提权
获得meterpreter
shell我们要做的第一件事情就是提权。通常，我们在渗透过程中很有可能只获得了一个系统的Guest或User权限。低的权限级别将会使我们受到很多的限制，所以必须将访问权限从Guset提升到User,再到Administrator,最后到SYSTEM级别。
我们先尝试利用本地溢出漏洞提权，即使用本地漏洞的利用程序（local
exploit）提升权限。就是说通过运行一些现成的造成溢出漏洞的exploit,把用户从users组或其它系统用户中提升到administrators组（或root）。
此时我们获取的权限是一个普通域用户权限，如下图所示。
先利用本地溢出提权，尝试了ms15_05和ms15_078，都以失败告终。如下图所示：
再试试看能不能绕过Windows账户控制（UAC），我们现在是具有一个普通域用户的权限的。
尝试了bypassuac模块，又以失败告终，如果成功会返回一个新的meterpreter shell。如下图所示：
使用bypassuac模块进行提权时，系统当前用户必须在管理员组，而且用户账户控制程序UAC设置为默认，即“仅在程序试图更改我的计算机时通知我”。而且Bypassuac模块运行时因为会在目标机上创建多个文件，所以会被杀毒软件识别。我们没能绕过UAC，可能是这二个原因。
> 其实提权没有成功也不要紧，我们还是可以通过此服务器为跳板，来攻击其他服务器的。
## 0×05 信息收集
我们此时虽然提权不成功，但我们还是可以进行域渗透测试的。有了内网的第一台机器的权限后，如何收集信息，这是很关键的一步，也是内网渗透中不可或缺的一部分。
查看当前机器的网络环境，收集域里面的相关信息，包括所有的用户，所有的电脑，以及相关关键的组的信息。常使用到的命令如下：
  1. net user /domain 查看域用户
  2. net view /domain 查看有几个域
  3. net view /domain:XXX 查看此域内电脑
  4. net group /domain 查询域里面的组
  5. Net group “domain computers” /domain 查看域内所有计算机名
  6. net group “domain admins” /domain 查看域管理员
  7. net group “domain controllers” /domain 查看域控制器
  8. net group “enterprise admins” /domain 查看企业管理组
  9. net time /domain 查看时间服务器
通过收集以上信息，我们可以分析出很多重要信息，比如：可以分析出内网是怎么划分的，还有各个机器名的命名规则，根据机器命名尝试找出重要人物电脑，还有域结构，是否是多层域结构等等，关键是要探测出域管理员的名字和域服务器的名字等。
## 0x06 获取一台服务器权限
我们的目标当然是域服务器，此时有二种情况，当前服务器可以直接攻击域服务器和不可以直接攻击域服务器。
  * 可以直接攻击域服务器
  * 不可以直接攻击域服务器，如果权限不够我们需要提升权限；如果是不能连接到域服务器需要攻击内网某个可以连接到域服务器的服务器，然后以此为跳板再攻击域服务器。
我们现在因为权限问题不可以直接攻击到域服务器，整理下思路，可以采取以下方法继续渗透：
  1. 使用meterpreter的目前权限来添加路由进行弱口令扫描
  2. 使用powershell对内网进行扫描（要求WIN7以上服务器）
  3. 架设socks4a，然后socks进行内网扫描
  4. 利用当前权限，进行内网IPC$渗透
通过上面的分析，我们先选择最简单的方法，我们在net view的机器名里选择一个和我们机器名相似的服务器来试试，不出意外，成功率很高，如下图所示。
> **给大家再温习下经典的ipc$入侵**
这里我们把我们免杀的PAYLOAD上传到PAVMSEP131服务器，然后利用AT命令启动PAYLOAD，反弹回来meterpreter
shell,具体操作见下图。
接着我们返回handler监听，可以看到反弹成功了，我们获得了pavmsep131服务器的meterpreter shell。见下图。
我们先看看PAVMSEP131服务器的信息和现在的权限
​ sysinfo  
​ getuid
看到没有system权限，现在可以用Mimikatz等工具也可以用run post/windows/gather/hashdump来抓HASH。
>
> 我们在用Mimikatz抓HASH之前要注意一点，如果服务器是安装的64位操作系统，要把Mimikatz进程迁移到一个64位的程序进程中，才能查看64位系统密码明文。32位系统没有这个限制，都可以查看系统密码。
这里我们使用大杀器（MIMIKATZ），抓HASH，具体操作见下图。
我们看下我们抓到的域用户的权限，如下图：
## 0x07 Powershell寻找域管在线服务器
Powershell，首先是个Shell，定义好了一堆命令与操作系统，特别是与文件系统交互，能够启动应用程序，甚至操纵应用程序。PowerShell还能允许将几个命令
组合起来放到文件里执行，实现文件级的重用，也就是说有脚本的性质。且PowerShell能够充分利用.Net类型和COM对象，来简单地与各种系统交互，完成各种复杂的、自动化的操作。
Powershell的脚本有很多，在内网渗透测试中不仅能扫，能爆，能转发，还能做更多的事情。我们常用的脚本有Powersploit，Empire，PowerView等等。
> 使用脚本之前，我们先科普下计算机上的执行策略，输入下面命令。
​ get-executionpolicy
  * Restricted------默认的设置，不允许任何script运行
  * AllSigned-------只能运行经过数字证书签名的script
  * RemoteSigned----运行本地的script不需要数字签名，但是运行从网络上下载的script就必须要有数字签名
  * Unrestricted----允许所有的script运行