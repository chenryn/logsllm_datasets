TABLE
sql packeges
infornation schena
TABLE
sql_pazts
infornation schena
TABLE
sql sizing
inforaation schena
TABLE
sqlsizing profiles
infornation schena
TABLE
tapob)
pub11c
TABLE
pg attrdet
pg catalog
TABLE
TABLE
Pg_a8
pg db role setting
pg catalog
TABLE
file
public
TABLE
图10-7包含PostgreSQL数据库对象列表的查询结果示例
功所需的证据。希望读者能够判伪可疑的SQL注入攻击，但是万一你找到了与之相反的证据，
请注意下面的内容。接下来将介绍退制SQL注入攻击以及从SQL注入攻击中恢复时必须执行
的关键操作。
10.3如果你是受害者，该怎么办？
有一句古老的谚语是这样说的：“be careful what you look for you just might find it”(只要用
心寻找，必见所寻之物）。但是安全事件完全顺覆了这一格言。处理安全事件是充满压力的，
因为我们试图拼凑出发生了什么情况，以及谁为造成的损失负责。但是另外一方面，处理安全
问题。虽然你可能想尽快跳入处理安全事件这一激动人心的领域，但从头至尾遵循一个有序的、
具有良好结构的处理过程是势在必行的，因为这样才能确保将安全事件对组织造成的影响降低
到最小，
现今的很多机构都具有计算机应急响应处理流程，这些流程已经定义好，或者根据安全事
件涉及的信息类型进行定义，诸如支付卡行业(Payment CardIndustry，PCI)标准和数据安全标
准(Data SecurityStandard，DSS）这样的技术标准可以控制管理和遇制安全事件所需的步骤。接
下来将介绍的处理流程将提供在管理安全事件期间所需的具体步骤。但是这些步骤并不能取代
你所在机构中响应安全事件的处理流程或授权管理的要求。相反，应该将其作为一种指导原则，
可以将其应用于支持你所要求的响应安全事件的处理中。
10.3.1遇制安全事件
在管理SQL注入攻击事件时，实现高效面有作用的遇制是必要的。SQL注入漏洞暴露的
时间越长，额外的记录受到损坏的可能性就越大，或者攻击者在数据库环境中涉足的程度就越
376
---
## Page 391
第10章确认井从SQL注入攻击中恢复
深。总而言之，遇制安全事件的速度越快，攻击对机构的影响就越小。对于还未被全面仔细研
究过的安全事件，退制此类安全事件的目标似乎非常困难，但这是必要的，也并非不可能实现。
当处理安全事件时，需要对遇制攻击的步骤进行详细计划。在遭到攻击时最好先“止血”，然
后在结束完整调查后，再查看你的遇制措施
要遇制SQL注入攻击事件，可以简单地拔除受损害服务器的网线。尽管SQL注入攻击的
直接目标是数据库服务器，但根据攻击者的行为和基于网络的控制（比如防火墙对数据库流量
施加的规则)，攻击者可能已经将目标数据库中的数据导出到另外一台连接到网络的服务器，
以使从外部传输数据。在这种情况下，如果仅仅拔除受攻击服务器的网线，攻击者依然可能下
载到数据库中的数据。最好的办法是既拔除数据库服务器的网线，也拔除Web服务器的网线，
使二者均从网络上移除。必须格外小心，既不能拔除系统的电源线，也不能停止和重启Web服
务器或数据库的服务进程，因为这将强制清除易失（volatile）的数据，而这些数据对于全面的取
证调查是至关重要的。另外，还应该确保记录以下信息：在什么时间将哪一根网线从哪一个系
统上拔除。在对安全事件进行遇制之后，可以进入到管理安全事件的下一步骤，确定安全事件
涉及哪些数据。
10.3.2评估涉及的数据
数据库可以存储各种各样的信息。数据库的某些内容可以是简单的公开信息，但其他内容
则可能包含敏感数据一比如可被用于社会工程攻击的个人信息，或者可被用于欺诈的金融和
健康信息。遗的是，数据库中的信息还远不止这些。其他类型的信息还可能带来更高的风险
失去生命。例如，如果卧底特工或证人保护程序中的公民的身份和住址信息被泄漏，就可
能极大地威胁到他们个人的人身安全。
在安全事件中确定涉及数据的类型，可以让你所在的机构决定管理安全事件要求采取的步
骤。这些步骤可能包括召开监管和法律方面所需的会议，这将影响到如何管理该安全事件以及
安全事件应该通报给谁。
请务必检查受损害系统存储、处理或传输的数据的特性，包括以下几点：
·涉及信息的类型。
·涉及的信息是否可辨识为个人信息还是组织机构的信息。
·影响到哪些国家、州或省的人。
·对数据执行了什么操作（更新、删除、修改或泄漏）。
·重用未授权数据的影响。
·任何缓解措施，比如数据加密，这可以降低未经授权的人重用这些信息的可能性。
这些要点有助于确定信息的危险程度，这将有助于确定要求采取的行动，包括需要将安全
事件通报给谁。
10.3.3通知相应人员
世界上的很多州和省都制定了规则，要求委托管理个人信息的组织机构在数据安全遭受破
坏时通知受影响的人员。州与州之间，省与省之间，具体的要求各有差异，具体要求取决于受
影响的人员所在的地区。
此外，与客户的契约和诸如PCI、DDS等规程的要求，可以授权公开损坏所影响到的信用
卡信息，侦若信息遭到破坏，还可以进一步强制公布所需的通告。
377
---
## Page 392
SQL注入攻击与防御（第2版）
从上面的分析可以看到，搞清楚应该通知到谁是一项困难的任务，可能包括具有法律约束
的契约、法规和规章。
这一任务最好由受害组织机构的高级管理人员和法律顾问来完成。他们可以做出业务决
策，确定需要提出哪些申请，需要发送的通知、消息和谁最适合处理这件事情。
这种方式还可以免除对事件处理者和取证专家的干扰，使他们可以专注于安全事件的技术
层面，比如确定攻击者在安全事件期间执行了哪些操作。
10.3.4确定攻击者在系统上执行了哪些操作？
之前在讨论如何确认SQL注入攻击时，介绍了一些关键痕迹，这些痕迹可用于标识数据
库服务器已经成功执行的恶意语句和查询。我们可以得出结论，是否存在一次成功的SQL注
入攻击。但是仅仅知道攻击已经发生是不够的一还应该确定攻击损害的范围。知道执行的查
询或语句只是开始，搞清楚被泄露或修改的具体记录才可以缩小安全事件的涉及范围。在考虑
上面刚介绍过的通知要求时，如果可以减少信用卡详细信息或个人隐私信息泄露的信息量，就
可以降低恢复的总成本，也可以降低被攻击组织机构所受的影响，这最好由执行数据库调查取
证的人员来进行管理。
数据库取证人员直接致力于证据的鉴别、保存和分析，这些证据可以证明发生了安全事件，
另外还可以通过下列几点正确地界定受影响的范围：
·标识出攻击者查看到的信息。
识别出攻击者执行的DML和DDL操作，以及受影响的特定记录。
标识出事务之前和事务之后受影响的数据状态，以支持恢复数据库。
·恢复之前已经被删除的数据。
数据库取证专家受过非常专业的训练，包括诸如分析用于存储数据库表数据的特定数据页
(datapage)，从事务日志中获取逆向工程信息。但这超出了本书的内容，表10-5列出了一些参
考资源，其中包含了一些与数据库取证有关的图书信息和工具。
表10-5数据库取证资源
RDBMS
图
书
专注于信息取证的Web网站
工具
Microsoft
SOL Senver Forersic Analysis.
www.applicationforensies.com
Windows Forensic Toolchest
SQL Server
Addison Wesley Professional
(SQL)
Oracle Foresics, Rampant
Oracle
www.v3rity.com
McAfee Security Scanner for
Press
Databases
www.applicationforensies.com
MySQL
无
www.applicationforensics.com
无
_PostgreSQL
无
www.applicationforensics.com
无
经过上面的学习，我们已经理解了数据库取证调查的好处
-可以正确地界定受攻击损害
的范围。接下来将介绍如何从SQL注入攻击中高效地恢复。
10.3.5从SQL注入攻击中恢复
在前面的章节中，我们介绍了多种SQL注入攻击技术，比如基于时间的攻击和基于错误
的攻击、自动注入工具、螺虫和愉取信息的有效载荷，以及脱离数据库的上下文并运行OS级
378
---
## Page 393
第10章确认井从SQL注入攻击中恢复
别的命令。在攻击中可以使用这些技术的多种组合，这些技术的组合将最终决定我们如何从攻
击中恢复。恢复的第一个步骤，是确定成功的SQL注入攻击投送了什么类型的有效载荷，
工具与陷阱
2009年，一家业界领先的反病毒公司成为SQL注入攻击的目标，攻击者宣称已经
成功利用了该公司网站上的一个SQL注入漏洞，并盗取了该公司客户的敏感信息。该
公司请数据库取证专家进行了鉴定，取证专家确认了攻击者的确成功地通过SQL注入
漏洞损坏了公司的网站，但是攻击者并没有访问到他所宣称的敏感数据，调查取证可以
成功地界定安全事件的范围，减少从攻击中恢复的代价和对商业的影响，更详细的信息
可以参阅该公司的网站：http://www.kaspersky.com/about/news/press/2009/Kaspersky_Lab_
Confirms_Website_Attack_Verifi es_No_Data_Was_Compromised.
静态有效载荷：从一个受损害系统到另外一个受损害系统，在后损害（post-compromise)系
统上执行的活动是一致的。静态有效载荷通常与SQL注入螨虫和脚本有关，实际上这些脚本
并没有太多的形态。每次当它们识别出利用一个SQL注入漏润时，它们将重复相同的操作。
动态有效载荷：从一个受损害系统到另外一个受损害系统，在后损害（post-compromise）系
统上执行的活动是不一致的。例如，攻击者使用某种漏洞利用工具执行了SQL注入攻击。
旦攻击者获得了访问权，就将枚举数据库并根据数据库服务器的版本、启用的特性和当前具有
的权限，在RDBMS中执行许多操作。即使攻击者使用相同的工具损害了多个服务器，但在不
同的受损害系统之间，执行的操作也几乎是完全不同的，这取决于攻击者的权限、数据库服务
器的配置和想要获取的信息。
这两种类型的有效载荷可以勾勒出攻击者的轮廊，接下来将介绍如何确定攻击所携带的有
效载荷。
1.确定攻击携带的有效载荷
用于确定攻击携带的有效载荷的步骤可能会影响到易失的数据库证据。如果正在处理数据
库的取证调查工作，除了本章介绍过的证据之外，还有另外一些数据库痕迹应该在继续调查取
证之前保护起来。读者可以参考10.3.4节“确定攻击者在系统上执行了哪些操作”中的内容，
以获得详细的指导。
可以执行下面的步骤，以识别成功SQL注入攻击的有效载荷：
（1）备份受损害数据库：为受损害数据库制作两份副本。一份用于恢复数据，另一份则作
为干净的恢复点，以备在恢复出现问题时使用。
(2）提取恶意的SQL注入查询：从受损害的Web服务器日志、数据库执行计划，包括从
一清单。
(3）理解恶意查询的逻辑：检查列出的恶意查询和语句，确定它们所创建、访问、更新或
剧除的对象，以及攻击者如何实现这些操作。我们需要这些信息来确定安全事件影响的范围，
从面规划出恢复安全事件的步骤。请注意，一些恶意查询可能被混淆以避免被检测，因此还需
379
---
## Page 394
SQL注入攻击与防御（第2版）
(4）搜索恶意查询参考：我们可能已经具有已知恶意语句和命令的列表，可以使用该列表
与之前提取的恶意查询清单相互比对，以识别恶意查询的来源。如果还没有已知恶意查询的列
表，可以使用Intemet搜索引擎搜索之前已经标识出来的恶意查询参考。在辨别成功的SQL注
入攻击时，可能还有其他受到该攻击损害的客户，或者安全公司和研究者对该攻击的评论，可
以利用这些信息来辨别攻击是否成功。当然，这种方法听起来似乎很初级。
(5）确定恶意查询是静态有效载荷还是动态有效载荷的一部分：从授索结果中可以确定，
攻击是与诸如SQL注入端虫这样的静态有效载荷有关，还是与攻击者使用SQL注入漏洞利用
工具、投送传统即席查询（ad-hoc)的动态有效载荷有关。
(6)查找多种漏洞：在恶意查询清单中检查所有的条目，因为同一SQL注入漏洞可能会被
多次利用，既可能使用静态有效载荷也可能通过动态有效载荷。无论检测出多少静态有效载荷，
识别出任何一个动态有效载荷都应该视为存在危险的标志。
在完成上面这些步骤之后，应该可以得出SQL注入攻击携带的是动态有效载荷还是静态
有效载荷的结论。该结论将决定恢复时需要执行的操作。在下面的内容，既介绍了携带静态有
效载荷攻击的恢复，也介绍了携带动态有效载荷攻击的恢复。在处理安全事件的恢复时，应该
选择并遵循其中一种合适的恢复方式一静态恢复或动态恢复。
2.从携带静态有效载荷的攻击中恢复
对于携带静态有效载荷的攻击，恢复处理过程相对简单，因为端虫或其他威胁执行的恶意
操作是已知的。恢复的核心问题，是将数据库回滚到受攻击影响之前的状态，或者识别并取消
(undo）那些恶意查询和语句所执行的具体操作。下面就是从携带静态有效载荷的攻击中进行恢
复的步骤：
(1）恢复数据库状态：使用下面方法之一，将受攻击的数据库恢复到来个已知的良好状态。
·从备份中恢复：使用痕迹分析期间找到的攻击时间线，可以将受攻击影响的数据库立
即恢复到受影响之前的某个已知状态。请注意，这可能会丢失从已知良好状态到遇制
安全事件这段时间内的事务。
·标识要回滚的事务：无论是手工分析还是使用日志分析器，比如Oracle的Logminer，