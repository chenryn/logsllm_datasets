(proc injection)
CS_Lateral_Movement_psexec
10/18/2016 11:17:13 PM
LogName=Microsoft-Windows-Sysmon/Operational
SourceName=Microsoft-Windows-Sysmon
EventCode=8
\\127.0.0.1\ADMIN$\8c0cb58.exe
EventType=4
# C:\Windows\system32\rundll32.exe
Type=Information
...
Message=CreateRemoteThread detected:
SourceProcessId: 29340
SourceImage: \\127.0.0.1\ADMIN$\8c0cb58.exe
TargetProcessId: 18476
TargetImage: C:\Windows\SysWOW64\rundll32.exe
NewThreadId: 20060
StartAddress: 0x0000000000110000
StartFunction:
 Search for rarest source or target images from proc injection
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 52
Keylogger
(proc injection)
CS_Keylogger_injection
10/26/2016 11:56:32 PM
LogName=Microsoft-Windows-Sysmon/Operational
SourceName=Microsoft-Windows-Sysmon
EventCode=8
C:\Windows\SysWOW64\rundll32.exe
EventType=4
# C:\Windows\system32\winlogon.exe
Type=Information
...
Message=CreateRemoteThread detected:
SourceProcessId: 17728
SourceImage: C:\Windows\SysWOW64\rundll32.exe
TargetProcessId: 836
TargetImage: C:\Windows\System32\winlogon.exe
NewThreadId: 14236
StartAddress: 0x0000000000C20000
StartFunction:
 Suspicious proc injection into «winlogon.exe»
 Steal user’s password while logging on or unlocking screensaver
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 53
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 54
Hunting for Delivery of Malware
 Malicious files downloaded via Browser
 Sysmon «FileCreateStreamHash» events generated
 Remember the malicious JS files from email links?
(Heodo/Emotet)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 55
Hunting for Delivery of Malware
 Remember that JS Filename from before?
 Let’s hunt for that… (DHL__Report__*.js)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 56
Hunting for Delivery of Malware
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 57
Hunting for Delivery of Malware
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 58
Hunting for Delivery of Malware
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 59
Hunting for Delivery of Malware
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 60
Hunting for Delivery of Malware
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 61
Detecting Persistence Methods
 Hunting for Persistence Methods
– Registry Keys
– Filesystem (e.g. Startup folders)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 62
Detecting Persistence (Registry)
 Searching for «Run» or «RunOnce» keys
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 63
Detecting Persistence (Registry)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 64
Detecting Persistence (Registry)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 65
Detecting Persistence (Filesystem)
 Example for «ProcessCreate», not «FileCreate»
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 66
Detecting Persistence (Filesystem)
This should make
you go «Hmmm??»
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 67
Detecting Persistence (Filesystem)
 Example for «FileCreate»
 Less than 400 results in > 2 months
 after tuning exclusion list
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 68
Detecting Persistence (Filesystem)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 69
Detecting Persistence (Filesystem)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 70
Detecting Internal Recon
 Internal Recon used as preparation for Lateral Movement
 Legit system commands used
 Can also be used by sysadmins or users
 Baseline and find appropriate thresholds
– Number of different commands and time window
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 71
Detecting Internal Recon
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 72
Detecting Internal Recon
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 73
Detecting Internal Recon
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 74
Detecting Internal Recon
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 75
Detecting Internal Recon
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 76
Detecting Internal Recon
 3 or more (of 7) different commands executed within 15 min
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 77
Detecting Internal Recon
15 occurences
6 diff cmds
within 15 mins
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 78
Detecting Internal Recon
«False detections»
are possible
Explorer -> cmd.exe
3 diff cmds
within 3 mins
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 79
Lateral Movement
 Lateral Movement using WMI for Execution
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 80
ATT&CK TTP on WMI
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 81
Who’s (ab-)using WMI
 Point 1
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 82
Who’s (ab-)using WMI
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 83
Who’s (ab-)using WMI
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 84
Who’s (ab-)using WMI
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 85
Who’s (ab-)using WMI
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 86
Who’s (ab-)using WMI
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 87
Testing with WMImplant
 Testing «command_exec» using WMImplant with PS-ISE
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 88
Testing with WMImplant
 Testing «process_start» using WMImplant with Beacon
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 89
Detecting WMI spawned proc’s
 Point 1
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 90
Detecting WMI spawned proc’s
 Point 1
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 91
Detecting WMI spawned proc’s
 Searching for Child-Process creations of «wmiprvse.exe»
 Filtering out «known good» processes
 Don’t filter out «Powershell.exe» in general
 Combine with «CommandLine» params
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 92
Detecting WMI spawned proc’s
 Command executions («powershell *$env:*» and IEX, obfusc.)
 Processes started (calc.exe, notepad.exe …)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 93
Detecting WMI spawned proc’s
 Also detecting CS Beacons WMI Lateral Movement method
 «powershell.exe … -encodedcommand …»
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 94
Internal P2P C2 using Named Pipes
 Internal Peer-to-Peer C&C using Named Pipes over SMB
 Using Cobalt Strike Beacon’s features for testing
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 95
Cobalt Strike Features
Only one egress point
using HTTP as C&C
Conn thru web proxy
SMB traffic
SMB traffic
between WS
between WS
Named Pipes C&C
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 96
Detecting C2 usingNamed Pipes
 Search for Processes
 Connecting through Web Proxy and
 Creating Named Pipes
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 97
Detecting C2 usingNamed Pipes
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 98
Detecting C2 usingNamed Pipes
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 99
Detecting C2 usingNamed Pipes
 Search for Processes creating «known malicious» Named Pipes
 with or without «default PipeNames»
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 100
Detecting C2 usingNamed Pipes
 Searching for «custom PipeNames» only
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 101
Detecting C2 usingNamed Pipes
 Searching for «default & custom PipeNames»
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 102
Detecting C2 usingNamed Pipes
 Searching for «default & custom PipeNames»
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 103
Detecting Mimikatz
(even file-less)
 Detecting ProcessAccess on LSASS.exe
 Idea by Mark Russinovich (RSA talk)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 104
Detecting Mimikatz
 Point 1
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 105
Detecting Mimikatz
 Point 1
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 106
Detecting Mimikatz
 Point 1
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 107
Detecting Mimikatz
 Search for ProcessAccess of LSASS.exe
 GrantedAccess of: 0x1010, 0x1410, 0x143A
 CallTrace: KERNELBASE.dll and (ntdll.dll or UNKNOWN)
 …
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 108
Detecting Mimikatz
 Mimikatz executable from Github
 File-based  No «UNKNOWN» from shellcode / injection
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 109
Detecting Mimikatz
 Cobalt Strike Beacon’s built-in Mimikatz «logonpasswords»
 File-less  «UNKNOWN» from shellcode / injection
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 110
Detecting Mimikatz
 Invoke-Mimikatz using PowerPick from Cobalt Strike’s Beacon
 File-less  «UNKNOWN» from shellcode / injection
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 111
Detecting Mimikatz
 Don’t search for specific SourceImage names
 e.g. Rundll32.exe -- it could be really anything! (even cmd.exe )
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 112
Detecting Mimikatz
(OpenProcess)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 113
Detecting Mimikatz
(OpenProcess)
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 114
I have some questions…
 Please stand up…
 Sit down if you…
 didn’t learn anything new (resources, examples)
 detect internal C&C using Named Pipes over SMB
 detect in-memory / file-less Mimikatz on (all of) your hosts
 Bonus: all versions of Mimikatz?
 Everyone sitting now I would like to have a chat 
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 115
Do you have questions?
 Is there time left for Q&A?
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 116
Thank you for your attention!
Tom Ueltschi, Swiss Post CERT
FIRST 2017 | Advanced Incident Detection and Threat Hunting using Sysmon and Splunk | Tom Ueltschi | TLP-WHITE Seite 117