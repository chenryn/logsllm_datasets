1．被监控端配置
图5-2是本节监控案例示意图，
Cacti监控应用案例
Browser
Cacti+RRDTool
，整体拓扑结构采用一台Cacti监控主机动态监控两台Web
vsa
图5-2
图5-1
T
→
Application
Server
PBX
Router
---
## Page 319
分信息)：
令验证SNMPD 服务是否运行正常，如果出现如下提示，则说明一切正常（命令输出仅为部
些端口数据。
息，SNMP使用的端口号为UDP161端口以及TCP199端口，我们需要在防火墙规则中开放这
组只读访问权限。主配置文件设置完成后重启服务，即可通过客户端访问该服务器获得系统信
第二步，将用户加入到组中；第三步，为组创建 systemvies视图；第四步，创建all视图并赋予
据模板文件，本书对需要修改的地方用黑体字表示）。
SNMPv2-MIB::SySORID.6=OID:
SNMPv2-MIB::SySORID.5=OID:
SNMPv2-MIB::SySORID.4=OID:SNMPv2-MIB::SnmpMIB
SNMPv2-MIB::SysORID.3=OID:SNMP-FRAMEWORK-MIB::SnmpFrameworkMIBCompliance
SNMPv2-MIB::SysORID.2=OID:SNMP-USER-BASED-SM-MIB::uSmMIBComp1iance
SNMPv2-MIB::SySORID.1=OID:SNMP-MPD-MIB::SnmpMPDMIBObjeCtS.3.1.1
Web1与Web2被监控主机均启动 snmpd服务后，可以在Cacti主机上执行 snmpwalk命
SNMP配置文件主要包括四部分内容需要修改。第一步，映射通信名称到安全用户名称；
#备注，以上黑色加粗部分为需要修改的内容
syscontact Root (configure /etc/snmp/snmp.local.conf)
syslocation Unknown
view all
group
group
com2secnotConfigUserdefault
#First,map the community name "public"into a"security name".
安装 snmp主程序及相关的依赖软件包，被监控主机仅需要修改 snmp主配置文件即可（根
[root@webl
[root@webl
root@webl
root@webl
[root@webl
access
Third,
ew
ew
notConfigGroup
systemview
systemview
notConfigGroup
notConfigGroup v1
create
~]# chkconfig snmpd start
~
~]#
included
#
#
service snmpd start
(edit/etc/snmp/snmpd.conf)
group
included
included
L
IP-MIB::ip
TCP-MIB::tCpMIB
any
tolet the group have
.1.3.6.1.2.1.25.1.1
notConfigUser
rose0011
noauth
exact
80
all
rights to.
all none none
view.
第5章系统监控
303
---
## Page 320
?
参数 date.timezone ="Asia/Shanghai"。
否则进行Cacti初始化时会提示It is not safe to rely on the system's timezone settings。
来实现监控的虚拟主机。
取 httpd-vhosts.conf文件的内容作为主配置文件的一部分，并在 httpd-vhosts.conf文件中加入用
页为 index.php，去除 Include conf/extra/httpd-vhosts.conf指令前的“#”符号。Include 指令将读
要修改Apache主配置文件httpd.conf，通过DirectoryIndex index.php index.html指令设置默认首
默认安装即可。
输出，就需要安装RRDTool工具，该软件的安装非常简单，使用configure、make、make install
数据，然后使用RRDTool工具保存数据并最终生成图表信息。
境可以参考第4章的内容搭建。此外，还需要使用SNMP简单网络管理协议从被监控主机提取
Linux运维之道
本书将时区修改为上海，即编辑PHP 配置文件/usr/local/php5/lib/php.ini，修改其中的时区
304
部署Cacti监控系统，创建Web页面根路径monitor目录，解压Cacti包并移动至Web 根路
修改PHP配置文件的时区设置，默认date.timezone为注释行，需要手动开启并设置时区，
[root@cacti ~]#vim /usr/local/apache2/conf/extra/httpd-vhosts.conf
因为是基于Web 的监控平台，而本书Web服务器采用的是Apache HTTP Server，因此，
设置Apache虚拟主机：
[root@cacti ~]# wget http://oss.oetiker.ch/rrdtool/pub/rrdtool-1.4.7.tar.gz
因为Cacti的优势在于其丰富的图表效果，为了将数据绘制成相应的更加直观的图表格式
安装相关依赖包软件：
Cacti 是基于 PHP 的 Web 监控管理系统，所以 Cacti监控主机需要部署LAMP 环境，此环
>pango-develgd
>net snmp-libs lm_sensors php-xml zlib libpng freetype cairo-devel\
2.
[root@cacti
[root@cacti
[root@cacti
[root@cacti
安装Cacti服务
ServerName cacti.example.com
DocumentRoot "/usr/local/apache2/htdocs/cacti"
ServerAdmin PI:EMAIL
~]#make&&makeinstall
~]#
~]#
~]#
./configure --prefix=/usr/local/
cd /usr/src/rrdtool-1.4.7/
tar -xzf rrdtool-1.4.7.tar.gz -C/usr/src/
需
---
## Page 321
的初始化操作，图5-3提示安装Cacti前请仔细阅读相关文档，单击“Next”按钮继续。图5-4
服务器，可以通过修改hosts文件实现域名解析。第一次登录Cacti监控页面时会提示进行基本
地址栏中输入http://cacti.example.com访问监控服务器，如果读者的实验环境中没有搭建DNS
览器访问Cacti管理界面，配置与管理监控服务器。本例中使用域名访问监控主机，在浏览器
文件中的数据库参数资料，需要修改的内容如下。
据库的所有权限，该账号密码为rose0011。
数据库备份文件，在本机生成名为cacti 的数据库，创建cactiuser 账户，并赋予其访问cacti 数
以便Apache读取相关页面。
径下，因为Apache默认以daemon用户及组身份启动，所以需要使用chown命令修改目录权限
当被监控主机与监控主机都部署完成后，管理员就可以在任意一台offce_pc 主机上通过浏
[root@cacti ~]# /usr/local/apache2/htdocs/cacti/include/config.php
3.Cacti生成图表信息
$database_password = "rose0011";
$database_hostname = "localhost";
$database_type = "mysql";
设置Cacti配置文件，根据上一步数据库初始化操作所创建的数据库信息，修改Cacti 配置
$database_default=
mysql> exit
mysql> flush privileges;
[root@cacti~]#/usr/local/mysql/bin/mysqladmin -u root-p create cacti
创建初始化数据库，这里要确保MySQL服务器程序是开启的，通过Cacti软件包内提供的
[root@cacticacti]#/usr/local/mysql/bin/mysql-u root-p
[root@cacti cacti]#/usr/local/mysql/bin/mysql-uroot-p cacti>
but
图5-5
***Forced Password Change***
Save
Confirm:
Password:oeooeoo
Please enteranewpasswordforcacti:
New Install
Please select the type ofinstallation
CactiInstallationGuide
eeeeeeee
图5-7
图5-4
on
---
## Page 323
表5-1
效果如图5-10所示。本例将Web1以及Web2两台Web服务器主机添加进来。
员可以根据实际需要继续添加需要监控的参数对象，确定后单击“Save”按钮保存所有的设置，
“Create”按钮，即可创建新的设备主机，同时在下方会出现图形模板以及数据查询模板，管理
填写相关的表单信息，需要填写的项目描述见表5-1，填写完所需项目表单后单击右下角的
建一棵便于查看图形的图形树，在一棵树下可以加入多个监控对象。
图形，通过NewGrahps菜单创建监控图形时可以根据情况有选择地监控对象主机。最后，要创
要在管理界面中通过Devices菜单将被监控主机添加进来。其次，要为新添加的主机创建监控
Hostname
Description
console
如图5-9所示，进入Devices菜单后单击“Add”按钮添加被监控的主机，此时系统会要求
登录Cacti管理界面后，如果需要监控其他主机，还需要完成一些简单的设置。首先，需
graphs
项目名称
SttueAny
ods
raphs
Creater:(Select agreph type to create）
Host:Localhost (127.0.0.1）GraphTypes:A11
Localhost(127.0.0.1)
2
sdal
设备名称，可以输入IP地址或主机名（需要DNS解析）
设备描述信息，描述被监控主机信息
图5-9
图5-8
Showing Rows1 to 1of1[1]
Ron perPag 3GoClear
Local Linux Machine
描述
第5章系统监控
307
Next>>
admin
---
## Page 324
按钮为被监控设备添加图形。
选择上一步添加的设备主机，并在需要监控的性能模板后点选对钩，设置完成后选择“Create”
Graphs菜单为Web1以及Web2创建图形。如图5-11所示，进入新建图形界面后在Host列表中
Linux运维之道
Associated GraphTemplates
SNMPTimeout
SNMPPort
SNMPCommunity.
SNMPVersion
Ping Retry Count
PingTimeout Value
DownedDeviceDetection
DisableHost
Numberof CollectionThreads
Host Template
AssociatedDataQueries
308
通过以上操作后，设备主机以及需要监控的性能指标已经创建完成。下面需要通过New
Web2（192.168.0.101)
reate:
项目名称
TP
添加数据查询项目，可以添加
添加图形监控模板，默认监控CPU、内存、负载
SNMP超时时间，单位为毫秒（ms）
SNMP端口号，默认161
输入被监控端定义的通信名，案例中为rose0011.
SNMP版本，使用默认的Version1
Ping重试次数，默认即可
测试Ping的超时时间，单位为毫秒（ms），默认为400ms
岩机检测方式，设置默认值SNMPUptime即可
停用该主机，仅在不需要监控该主机时选择
用于搜集数据信息的线程数量，默认即可
定义图形及数据查询模板，案例中选择ucd/net SNMPHost
图5-11
图5-10
描述
192.168.122
292.1680..
ReturnSave
区
续表
---
## Page 325
果希望当性能指标达到一个预设值后自动发出报警（通过邮件或手机短信等），Cacti报警插件
CPU性能图表。
形需要等待片刻才可以看出效果，最终查看效果如图5-15和图5-16所示，分别显示为内存与
所示，在此单击你希望查看的主机即可。由于默认为五分钟下载一次数据，所以最终生成的图
建了一棵名为Web的图形树，并在Web树下添加Web1与Web2两台主机的图形，如图5-14
执行该脚本立即同步数据。
需要每五分钟收集一次数据，管理员可以通过计划任务实现每五分钟执行该脚本，也可以手动
终生成图形窗口，在Cacti软件包中已经自带了一个用于收集数据的PHP脚本，默认Cacti系统
操作中创建的图形，如图5-13所示。
界面中会出现Default与Web 两棵图形树。单击进入Web 树中，单击“Add”按钮添加上一步
入Name（图形树名称）后单击“Create”按钮，本例使用的名称为Web，此时在GraphTrees
菜单打开图形树的设置界面，如图5-12所示，单击“Add”按钮可以添加新的图形树，提示输
图形树，本例将创建一棵新的图形树，并将Web1与Web2的图形添加进来。通过单击GraphTrees
树，在每棵图形树下可以插入多个设备主机的图形信息。Cacti初始状态有一个名为Default的
Cacti除了基本的性能监控功能外，通过安装插件可以提供更多其他有用的特性。比如，如
最后，我们通过Cacti平台的 graphs 选项卡进入图形窗口，该窗口将以树状显示。本例创
Cacti监控服务器需要根据以上设置连接所有被监控的主机，通过SNMP收集数据信息并最
ree
*/5****/usr/local/php5/bin/php /usr/local/apache2/htdocs/cacti/poller.php
[root@cacti~]# crontab
Cacti监控系统最终通过树状列表来查看被监控主机的性能图形，我们可以创建多棵图形
here
nt for this head
trolhowGraph Thu
bnails are disp
layec
-e
wher
图5-13
图5-12
Hourly (1 Minute Average)
eb2（192.168.0.101)
Host
[root]
第5章
CancelCreete
309
系统监控
Add
---
## Page 326
更多的Cacti插件，可以参考官方网站http://docs.cactinet/plugins的介绍。
帮助企业在出现严重故障前把问题解决，报警信息可以通过邮件或短信发送给管理员，让管理
务的正常运行，并且在服务发生问题时提供报警机制。Nagios强大而灵活的监控预警机制可以
是运行在服务器上的服务是否正常，而不会像Cacti一样生成图形，Nagios关注点在于保证服