# 【技术分享】TP-Link WR841N路由器任意代码执行漏洞分析（附演示视频）
|
##### 译文声明
本文是翻译文章，文章来源：blog.senr.io
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
****
译者：[兴趣使然的小胃](http://bobao.360.cn/member/contribute?uid=2819002922)
预估稿费：200RMB
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
**一、前言**
最近我们在TP-Link的WR841N
V8路由器上发现了两个漏洞，利用这两个漏洞，我们可以在这款路由器上执行我们自定义的代码。与厂商友好协商后，他们在新版路由器固件中修复了这个漏洞，因此我们决定公开我们的研究成果。
我们团队的主要研究方向是网络嵌入式设备，根据研究成果，我们对产品进行改进，同时也会在嵌入式设备生产及安全社区中分享成果。WR841N这款设备刚好是我们在硬件攻击[课程](http://www.sexviahex.com/)中用到的路由器，也是我们在介绍[JTAG](http://blog.senr.io/blog/jtag-explained)相关知识时的重点介绍对象。我们在对这款路由器进行研究时，发现它在配置服务的逻辑处理流程中存在一个缺陷，利用这个缺陷，我们能够绕过路由器的访问控制策略，并且能够重置路由器的凭证（CVE-2017-9466）。随后，我们利用获取到的访问权限，通过配置服务中存在的栈溢出漏洞实现了路由器的任意代码执行。
在这类抵近攻击中，我们用到了智能手机的热点功能，通过某个协议重设了路由器的凭证（新的硬件型号已经在固件中删除了这个协议）。不幸的是，尽管老型号可能不再得到官方的支持，但这些设备往往处于关键位置。幸运的是，当我们向TP-Link报告了这个问题后，他们马上同意在这个型号中删除存在漏洞的配置服务。
我们会详细分享这一技术细节，希望我们的研究成果能够帮助大家理解有关抵近攻击、过时版本的固件、加密的逻辑流程或者存在漏洞的配置服务方面的知识。
读者可以直接阅读本文的技术细节部分了解详细信息。
**二、漏洞摘要**
我们首先做的就是购买这款路由器、下载路由器固件然后开始分析固件。我们之前在[配置服务漏洞](http://blog.senr.io/blog/400000-publicly-available-iot-devices-vulnerable-to-single-flaw)方面已有所研究，因此我们直接查找并最终在固件中发现了这样一个服务。这个服务允许网络用户读取并写入系统设置。这款路由器要求用户使用基于用户名和密码的密钥对发往路由器的命令参数进行加密，借此保护这个服务的安全性。
参数所使用的加密算法为DES算法，按8个字符块形式对文本进行加密。识别文本加密的逻辑处理缺陷对我们而言并不是难事。因为我们已经从固件中了解了加密前的明文版本，也能够通过路由器的服务掌握加密后的密文版本，因此我们能够复制加密后的文本，并将其以有效参数形式发回路由器。此外，并不是所有的命令都需要参数，这导致这些命令的功能会暴露在公开互联网中，任何人都可以访问。
图2. 使用IDA Pro逆向分析路由器固件时的截图
为了利用这些命令，我们首先找到了某个不需要参数的命令，但这个命令依然能够返回可以预期的经过加密后的文本。我们复制了加密文本的前8个字符，将其作为一个特征名称加以使用。我们将智能手机的名称设为这个特征名称，然后开启手机的热点功能。我们通过网络向路由器发送了一个命令（这个命令同样不需要任何参数），触发路由器搜索附近的热点。在手机名称（即前面提到的特征名）的末尾添加“init”这个字符串后，我们向路由器请求一份包含所有热点的加密列表，通过这个特征名在这份列表中查找我们所提供的那个热点。在这个列表中，经过加密后的“init”会紧跟在特征名之后。这样一来，我们就能将经过加密的“init”作为参数，传递给相应的命令，通过这个命令，我们可以迫使路由器恢复初始设置，这些设置中包含默认的用户名及密码。
图3. iPhone上的热点设置界面
成功重置路由器用户名及密码后，我们对参数进行了加密，而没有使用热点技术。如果攻击者想避免引起用户的警觉，他们可以继续使用热点技术，获取后续漏洞利用所需的相关加密文本信息。在这里，我们通过另一条命令挖掘出路由器的一个栈溢出漏洞，成功获取这款路由器上的自定义代码执行权限。为了演示我们所获取的底层控制能力，我们使用自制代码控制路由器的灯光闪烁动作，通过路由器灯光以摩斯编码传递“Hi
Senrio”这个信息。现实生活中，攻击者可以利用这种技术，从隔离网络中传递信息，或者修改路由器的设置，将流量重定向到恶意服务器上。
如果读者不想了解技术细节，可以直接跳到本文结尾的总结部分。
**三、技术细节**
**3.1 获取访问权限  
**
首先，我们从TP-Link的支持网页上下载了这个硬件型号的最新固件，使用binwalk工具提取了squashfs文件系统。
图4. binwalk的输出信息
当我们拆掉路由器的顶部外壳后，我们发现了一个4pin引脚头，通过这个引脚头，我们能够使用UART接口访问受密码保护的控制台。我们尝试暴力破解文件系统中shadow文件的密码哈希，但直到我们发现路由器漏洞并完成漏洞利用技术时，暴力破解还是没有得到明文密码。然而，我们成功中断了路由器启动进程，获得了一个控制台接口，这个控制台原本是用于从外部FTP服务器上接收固件及文件系统的更新。我们备份了squashfs文件系统，修改其中的shadow文件，添加一个新的root密码，然后通过我们自己的FTP服务器更新了路由器的文件系统，最终获取到root控制台的访问权限。通过这个控制台，我们能够观察调试输出信息，并且当目标进程崩溃时也能导出内核信息加以分析。