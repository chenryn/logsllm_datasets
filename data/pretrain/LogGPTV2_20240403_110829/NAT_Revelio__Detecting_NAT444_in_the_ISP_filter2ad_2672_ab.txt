in the ISP access network.
1. Identify Subscriber’s GRA. First, we use the Session Traversal Utilities for
NAT (STUN) [13] protocol to discover the Globally Routable Address (GRA) that
corresponds to the subscriber. STUN is a standard client-server protocol that
allows a user behind a NAT to learn its public mapped address. We program the
Revelio client to behave as a STUN client that queries an external STUN server
(we use stun.stunprotocol.org), which replies with the GRA of the subscriber.
If the ISP does not deploy NAT444 (Fig. 1(a)), this GRA corresponds to the
address exposed at the Service Demarcation point. If the ISP deploys NAT444
using a topology similar to that of Fig. 1(b), this GRA corresponds to the public
IP address exposed at the Intra IP Access point along the reference path. This
step corresponds to the very ﬁrst block of the Revelio ﬂowchart in Fig. 2, labeled
154
A. Lutu et al.
STUN Binding Request. The information we retrieve by performing this action
is illustrated in the ﬂowchart by the data block labeled Subscriber GRA.
2. Discover Home NAT Device. Second, we establish whether the Service Demar-
cation device performs NAT. Speciﬁcally, we verify that the local IP address of
the Subscriber Device running the Revelio client in the home network is in pri-
vate address space [12]. If the IP address of the Subscriber Device is a public
address, we conclude that the client is not behind a NAT (and, implicitly, not
a NAT444 device either). We further conﬁrm this scenario when comparing the
local IP address to the GRA. If these two match, then there is no NAT device
along the path. We represent this step of the Environment Discovery phase in the
NAT Revelio ﬂowchart with the test block labeled Home NAT device. Depend-
ing on the results of the test, we include in the ﬂowchart a stop block with No
NAT444 (i.e., a negative result), or we move on to the next step in this phase.
3. Locate Service Demarcation Point [Path Analysis]. If the CPE performs NAT,
we test to identify the location of the access link (i.e. the link between the Service
Demarcation point and the ﬁrst hop in the access network of the ISP) relative
to the Revelio client. We heuristically identify the access link by assuming it is
the ﬁrst link on the outbound path with a transmission latency at least an order
of magnitude higher than its neighboring links [17].
To quantify per-link latency we use a technique similar to pathchar [7].
Namely, we estimate per-link delay parameters by taking the minimum values
of repeated Round Trip Time (RTT) measurements with diﬀerent UDP packet
sizes along a path, and assuming negligible queuing and processing delays (sim-
ilar to [7]). To minimize the impact of these measurements on the subscriber’s
network, we gather the data by running traceroute hourly over a period of two
days, using 21 diﬀerent packet sizes varying from 120 bytes to 1,400 bytes, and
using as a destination a high-availability IP address in Level 3’s network. Lim-
iting the number of packets to 21 per test allows us to complete one run of the
NAT Revelio measurements in 30 s. Running Revelio once per hour for 2 days
results in 48 RTT samples per TTL per packet size. We analyze these values to
estimate per-link propagation delay, and infer that the ﬁrst link with a ten times
latency increase relative to its neighboring links is the access link. We use the
pathchar result (labeled Service Demarc. Location in the ﬂowchart) in the tests
we perform in the second phase of NAT Revelio.
3.3 NAT444 Discovery Phase
This phase seeks to identify the location of the device performing NAT to the
GRA mapped to the subscriber, namely before or after the Service Demarcation
point. Figure 1(b) depicts the scenario with NAT444 (CGN) deployed in the
DSL access ISP network, after the BRAS and the Core Router. When the ISP
deploys NAT444, the location of the Intra IP Access point changes compared
with the case where the ISP does not use NAT444 (Fig. 1(a)). In Fig. 2, we
depict enclosed in red rectangles the three tests we run for NAT444 detection.
NAT Revelio: Detecting NAT444 in the ISP
155
We perform all three tests and interpret the set of results we obtain together with
the information we collect in the Environment Characterization phase to make
an inference regarding NAT444 deployment in the ISP we measure. To increase
the robustness of the test suite to non-standard architectures, e.g., when the ISP
does not deploy NAT444, but conﬁgures private addresses in its access network,
we assign a diﬀerent conﬁdence level to each test. One strength of Revelio lies
in being able to compare the results of multiple tests for the same subscriber.
To control against false positives, when test results conﬂict, we give priority to
the negative result, concluding there is no NAT444 deployment in the ISP.
1. Identify Private/Shared Addresses in the ISP Access Network. The ﬁrst
method in the NAT444 Discovery phase detects the use of private or shared IP
addresses in the access network, between the Service Demarcation point and the
Intra IP Access point. Figure 1(b) depicts an ISP using special address domains
(i.e., private or shared address space) in its access network when a NAT444 solu-
tion is in place. We characterize the path obtained by traceroutes in Phase (1),
step 3, including inferring the position of the Service Demarcation point. We
then check if private or shared addresses are conﬁgured along the path toward
the public Internet target which is a router inside Level3, and if so, determine
their location relative to the Service Demarcation point. This discovery helps
us to establish if the private/shared addresses we identify are conﬁgured in the
ISP access network. The information allows us to correctly distinguish cases of
multiple levels of NAT in the home network, which can otherwise be easily con-
fused with NAT444 deployment. The ﬂowchart (Fig. 2) represents this step by
including the data block labeled IP Addresses in the Access Network (which gets
as input the location of the Service Demarcation point relative to the Revelio
client) and the two following tests: Private/Shared Addresses in Access Network.
Note that we assign diﬀerent conﬁdence levels to these two tests. When
we observe shared address space in the ISP, beyond the Service Demarcation
point, we are highly conﬁdent of the presence of a NAT444 solution, given that
these addresses are speciﬁcally for use in NAT444 deployment. However, when
we observe RFC1918 private addresses beyond the Service Demarcation point,
we give a low conﬁdence level to our results, because the ISP might use pri-
vate address space for its internal infrastructure without deploying NAT444.
Moreover, in the case where NAT Revelio does not detect any private or shared
addresses past the Service Demarcation point, the test suite cannot discard the
possibility of a NAT444 deployment in the ISP. This case can occur when the
ISP conﬁgures public addresses (legitimate or stolen “squat” address space) in
the access network as part of a NAT444 deployment.1
2. Invoke UPnP Actions. NAT Revelio runs a series of tests that aim to infer
the hop count between the Service Demarcation device and the device per-
forming the ﬁnal translation to the subscriber GRA. To check if the Service
1 A common conﬁguration is to assign private or shared address space only to the
interface of the Service Demarcation point attached to the ISP network, while other
elements of the ISP network use public addresses.
156
A. Lutu et al.
Demarcation device is the device translating to the subscriber GRA, we verify
whether the address conﬁgured on the Service Demarcation point matches the
subscriber’s GRA.
If the Revelio client directly connects to the Service Demarcation device
(Fig. 1), we leverage the Universal Plug and Play (UPnP) IGP protocol [2] if
supported by the CPE. The Revelio client sends a UPnP client control message
to the CPE that retrieves the IP Address of the WAN interface of the CPE,
which, in this case, maps to the Service Demarcation point. In the case of a
match, we infer that the ISP does not use NAT444. A mismatch between these
addresses means that the ISP does indeed deploy NAT444. We give a high level
of conﬁdence to this result.
Otherwise, if the Subscriber Device running the Revelio client does not con-
nect to the Service Demarcation device, we ﬁnd ourselves in a non-standard
conﬁguration, where multiple NAT devices are present within the home net-
work. In this case, we cannot draw any conclusion regarding the presence of
NAT444 in the ISP from this test, since the UPnP test retrieves the IP address
of the innermost CPE device within the home network, and not the IP address
at the Service Demarcation point. The NAT Revelio ﬂowchart includes this set
of tests, following the yes branches both for the UPnP Supported and the Revelio
client connected to Service Demarcation device tests, in the NAT444 Discovery
phase in Fig. 2.
3. Traceroute to the Subscriber GRA. We also run traceroute from the Rev-
elio client to the subscriber GRA to measure the hop count between them.
Without NAT444, the GRA is at the Service Demarcation point (Fig. 1(a)),
and all traceroute-responding hops are inside the home network. With NAT444
(Fig. 1(b)), the GRA is at the Intra IP Access point, which is past the Service
Demarcation point. If we already know the location of the Service Demarcation
point relative to the Revelio client (from the ﬁrst phase), a UDP traceroute to
the GRA distinguishes these two cases.
We assign to the Traceroute to GRA test a high conﬁdence level, since it relies
on no CPE-speciﬁc capabilities, nor on the assumption that the ISP conﬁgures
private or shared IP addresses in the access network. Nonetheless, this test still
may fail to determine the presence of NAT444 in the ISP, for example when
the ISP actively blocks ICMP packets triggered by the traceroute. Thus, NAT
Revelio cannot conclusively determine the presence of a NAT444 solution in the
ISP. Figure 2 illustrates this possibility in the NAT Revelio ﬂowchart with the
purple inconclusive stop block.
4 Validation and Large-Scale Revelio Measurement
Campaigns
4.1 Revelio Validation in Controlled Environment
With the help of a large UK ISP operator, we tested NAT Revelio on a controlled
set of subscribers included in a trial deployment of a CGN implementation of
NAT Revelio: Detecting NAT444 in the ISP
157
NAT444 within the ISP network. The trial environment consisted of operational
DSL residential lines connected behind a stand-alone CGN NAT444 implemen-
tation. We ran the Revelio client on 6 Subscriber Devices, 2 of which were behind
the NAT444 device. We found that NAT Revelio accurately detected the deploy-
ment conﬁguration of all 6 devices. We explain details of the test results below.
After running the Environment Discovery (Sect. 3.2), we learned that
all six Subscriber Devices running the Revelio Client connected directly to the
Service Demarcation device within the home network.
For the two subscribers connected to the ISP behind a NAT444 solution, all
tests in the NAT444 Discovery (Sect. 3.3) successfully indicated the presence
of NAT444 within the access network. First, after retrieving the CPE’s WAN IP
address which corresponds to the Service Demarcation point address (as per the
test we describe in Sect. 3.3.1), we identiﬁed it as shared address space, which is a
clear symptom of NAT444 deployment. Second, we conﬁrmed that the subscriber
GRA did not match the Service Demarcation point address (as per the test we
describe in Sect. 3.3.2), reinforcing evidence of NAT444 deployment. Third, when
verifying how far from the Service Demarcation device the translation to GRA
occurred (as per the test we describe in Sect. 3.3.3), we measured 6 hops between
the Subscriber Devices and the device translating to the GRA. Only the ﬁrst of
these hops belonged to the home network, leaving 5 hops between the Service
Demarcation device and the device performing translation to the GRA.
NAT Revelio successfully inferred that the other 4 Whiteboxes were not
behind a NAT444 solution after Invoking UPnP Actions (Sect. 3.3.2) and con-
cluding that the IP addresses at the Service Demarcation point matched the
GRA of the subscriber.
To illustrate Revelio’s robustness to non-standard conﬁgurations, we also
tested our NAT444 detection approach on 24 residential DSL lines operated by
a large Italian ISP that does not employ NAT444 solutions in its DSL network.
However, in its access network conﬁguration, the ISP does use private IP address
space for its infrastructure. This is a non-standard conﬁguration that can wrongly
mimic the presence of a NAT444 solution in the ISP. Due to the fact that we con-
sider multiple tests to detect NAT444 in the ISP, we were able to discard such
cases on the basis of conﬂicting results. We found that the ﬁrst test in NAT444
Discovery (Sect. 3.3.1) indicated the existence of a NAT444 solution in the ISP
based on the detection of RFC1918 address space beyond the Service Demarca-
tion point. Since the operator disabled UPnP on its home routers, we could not
invoke any UPnP actions (Sect. 3.3.2). However, traceroute to the subscriber GRA
(Sect. 3.3.3) showed that the GRA is, in fact, at the Service Demarcation point.
As we mention in Sect. 3.3, when we have conﬂicting results from Revelio tests,
we give priority to the negative test to avoid false negatives. Thus, we accurately