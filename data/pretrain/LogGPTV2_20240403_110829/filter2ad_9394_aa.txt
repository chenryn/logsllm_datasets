# 部分中间件漏洞总结
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
做看客很久了，发现一直没有比较好的中间件漏洞的总结性文章，正好近期在做这方面的学习，在此仅总结了少部分中间件常见漏洞供学习参考，后续将补充另一部分常见漏洞。如有错误还请大佬们指正。
## 一、IIS文件解析漏洞
IIS文件解析漏洞存在于两个版本，一个是IIS6.0的文件解析漏洞，一个是IIS7.5的文件解析漏洞，IIS7.5的文件解析漏洞原理和IIS6.0类似，均因为存在逻辑问题，在此仅对IIS6.0的文件解析漏洞进行分析。在补充中将对IIS7.5文件解析漏洞差异性部分进行额外说明。
###  （一）漏洞原理
IIS6.0在处理含有特殊符号的文件路径时会出现逻辑错误（文件目录名称为test.asp，目录中的文件会被当做asp执行；后缀名为.asp;.jpg时，当作asp文件执行），从而造成文件解析漏洞。
###  （二）漏洞演示及利用
当网站上传点限制后缀名时（IIS主要和asp搭配），可以利用文件解析漏洞上传如test.asp;.jpg的文件，绕过后执行。如图1.1
图1.1
当允许新建目录而未对目录名做限制时，可利用文件解析漏洞新建名为test.asp的文件夹，并在其中构造需执行文件iisstart.jpg进行绕过。如图1.2
图1.2
###  （三）漏洞修复
1、对新建目录文件名进行过滤，不允许新建包含.的文件夹甚至禁止新建目录
2、限制上传文件的执行权限，不允许执行
3、过滤.asp/xm.jpg等，在httpd.ini中加入过滤规则（此方法为网络上的解决办法，但在server2003中未搜索到该文件）。
4、升级IIS版本
###  （四）补充
IIS6.0的解析漏洞同样存在于IIS 5.x的版本，而IIS7.5的畸形解析漏洞的攻击方法同样适用于IIS7.0和Nginx
修改IP地址未对应的目标机地址，如图2.2
图2.2
运行脚本，攻击目标机。如图2.3
图2.3
###  （三）漏洞修复
将IIS管理器中，web服务扩展下，webDAV禁用，即可修复，修复后再此运行脚本，未出现弹窗。如图2.4
图2.4
###  （四）补充
若能弹出计算器（calc）,则权限已经足以完成getshell的全部操作。
## 三、IIS短文件名
IIS短文件名漏洞，通过IIS短文件名机制，暴力列举短文件名，尝试猜解后台地址、敏感文件甚至直接下载对应的文件。但局限于只能猜解长文件名前6位和扩展名前3位，同时需要IIS和.net两个条件都满足。
###  （一）漏洞原理
利用了IIS短文件名机制，即为了兼容16位MS-DOS程序，Windows为文件名较长的（计算后缀后文件名长度大于9）文件（和文件夹）生成了对应的windows 8.3
短文件名。可以通过此漏洞猜解后台地址、敏感文件等。如图3.1
图3.1
###  （二）漏洞演示及利用
开启winserver2003虚拟机，在c:/Inetpub/wwwroot目录下新建对比文件夹12345678，123456789，对比文件aaaaaa.asp。在主机上打开虚拟机IP下的URL
尝试10.10.10.132/122~1**/a.asp和10.10.10.132/123~1/a.asp；得到不同的结果如图3.2，图3.3。
图3.2
图3.3
通过如上两图我们可以看出，根据返回结果的不同可以逐个猜解短文件名。
而后再尝试10.10.10.132/aaaaaa~1/a.asp（猜解无后缀，正常返回则为文件夹）和10.10.10.132/aaaaaa~1/a.asp（猜解为文件）。如图3.4，图3.5。
图3.4
图3.5
根据不同的回显我们可以判断正在猜解的对象是文件还是文件夹。
###  （三）漏洞修复
目前几种修复方式，可选择升级.net
framework或者将在注册表HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlFileSystem中修改NtfsDisable8dot3NameCreation为1，但修改方法尝试多次，不易成功。
除去上述方式，较易成功的方式为将web文件夹内容拷贝到其他区域，将原文件夹删除后，再将拷贝的文件夹移动回来。修复如图3.6，结果如图3.7
图3.6
图3.7
###  （四）补充
目前有比较好的IIS短文件名检查工具，下载地址为：
## 四、Nginx文件解析
Nginx文件解析漏洞，精心构造的恶意请求经过nginx中间件处理后，被合法的执行。php有一个选项cgi.fix_pathinfo，默认值为1，表示开启。
###  （一）漏洞原理
Nginx文件解析漏洞，涉及到选项cgi.fix_pathinfo，默认值为1，表示开启。请求文件/shell.gif时后面加个*.php，可能会被当作php代码执行。如果关闭此选项，输入10.10.10.130:55555/test.jpg/x.php只会返回找不到文件。但因为如果关闭可能会导致一些其他错误，所以默认是开启的。如图4.1
图4.1
同时配置文件/etc/php5/fpm/pool.d/www.conf中security.limit_extensions允许解析其他格式文件为php，如图4.2，二者共同作用造成了文件解析漏洞。
图4.2
###  （二）漏洞演示及利用
一是因为对任意文件名，在后面添加/任意文件名.php的解析漏洞，比如原本文件名时test.jpg，都可以添加为test.jpg/x.php进行解析攻击。如图4.3.二是对低版本的Nginx可以在任意文件名后添加%00.php进行解析攻击。
图4.3
###  （三）漏洞修复
1、将php.ini文件中的cgi.fix_pathinfo的值设为0。这样php在解析1.php/1.jpg这样的目录时，只要1.jpg不存在就会显示404。
2、将/etc/php5/fpm/pool.d/www.conf中security.limit_extensions后面的值设为.php。
修复结果如图4.4
图4.4
###  （四）补充
Nginx文件解析漏洞的本质原因时配置文件错误。网站上线前需要确认相关配置正确。
## 五、Nginx配置不当
Nginx配置不当除了造成文件解析漏洞，还可能造成两种后果：1、可以进行目录遍历（或目录穿越）；2、存在CRLF注入，CRLF是”回车+换行”（rn）的简称。目录穿越将在补充内容中进行介绍。
###  （一）漏洞原理