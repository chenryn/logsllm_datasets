## Page 29
的一些基数计算。
行支持，以保证Druid整体的查询性能，这些近似计算方法还包括HyperLoglog、DataSketches
暂时不提供支持。在支持直方图（Histogram）方面，Druid也是通过一些近似计算的方法进
如Count、Mean、Variance和其他查询统计。对于一些无法并行化的操作，例如Median，Druid
集群上的查询可以进行灵活的水平扩展。Druid内置提供了一些容易并行化的聚合操作，例
程的云服务。如果某些节点出现故障，则可借助Zookeeper协调其他节点重新构造数据。
的（Druid的每个Segment不超过2000万行），故Druid还支持对Segment进一步分区。
按照时间范围把聚合数据进行分区处理。对于高基数的维度，只按照时间切分有时候是不够
中，因此当数据增长的时候，可以通过简单增加机器的方式进行扩容。为了保持平衡，Druid
1.4.2水平扩展能力（HorizontalScalability）
AND和OR等计算操作。
压缩技术。
大小是非常有限的，因此在内存使用方面要精细设计，比如Druid里面使用了Bitmap和各种
合（Partial Aggregate）给Druid争取了很大的性能优化空间。
数据的细节情况。因此，数据聚合粒度可以是1分钟、5分钟、1小时或1天等。部分数据聚
1.4.1快速查询（FastQuery）
Append-Only Future )。
询（ParallelizableQuery）。
索引（Index）。
第1章初识Druid
Druid的查询模块能够感知和处理集群的状态变化，查询总是在有效的集群架构中进行。
历史 Segment数据可以保存在深度存储系统中，存储系统可以是本地磁盘、HDFS或远
数据内存化也是提高查询速度的杀手。内存和硬盘的访问速度相差近百倍，但内存的
（3）实时分析（Realtime Analytics）：不可变的过去，只追加的未来（Immutable Past，
Druid查询性能在很大程度上依赖于内存的优化使用。数据可以分布在多个节点的内存
另外，为了支持Drill-Down某些维度，Druid维护了一些倒排索引l。这种方式可以加快
对于数据分析场景，
（2）水平扩展能力（Horizontal Scalability）：分布式数据（Distributed Data）+并行化查
，大部分情况下，我们只关心一定粒度聚合的数据，而非每一行原始
---
## Page 30
据量小的时候，一切安好，但是数据量变大后，不能秒级返回结果的分析系统都是被垢病的
题，OLAP的StarSchema实际上就定义了一个很好的空间，让数据分析师自由探索数据。数
1.5.3
统并不多。
理，而 Storm则是一个流式计算平台，真正在分析平台层面上直接对接各种流式数据源的系
1.5.2
很多公司选型Druid是为了解决数据爆炸的问题。
到几百亿的事件，对于Druid来说是非常适合的场景，目前已被大量互联网公司实践。因此，
1.5.1
1.5
中将它们装载到内存供查询使用。
中，例如文件系统或亚马逊的 S3等。当需要查询这些数据的时候，Druid再从深度存储系统
的事件，因此在设计之初就约定事件一但进人系统，就不能再改变。
1.4.3
Druid提供了包含基于时间维度数据的存储服务，并且任何一行数据都是历史真实发生
数据分析师的想法经常是天马行空，希望从不同的角度去分析数据，为了解决这个问
很多数据分析软件在吞吐量和流式能力上做了很多平衡，比如Hadoop更加青睐批量处
很多公司选择Druid作为分析平台，都是看中Druid 的数据吞吐能力。每天处理几十亿
对于历史数据Druid以Segment数据文件的方式组织，并且将它们存储到深度存储系统
·社区支持力度大。
·查询灵活且快。
·支持流式数据摄入和实时。
·数据吞吐量大。
Druid具有如下技术特点。
Druid的技术特点
实时分析（RealtimeAnalytics）
查询灵活且快
支持流式数据摄人
数据吞吐量大
Druid实时大数据分析原理与实践
---
## Page 31
些类似数据库中表的概念。每个数据集合包括三个部分：时间列（TimeStamp）、维度列
1.数据格式
使用Java8版本安装Druid。
明人也成立了一家叫作 Implyio的新公司，推动Druid生态的发展，致力于Druid的繁荣和
的Committer有5个，谷歌有1个，阿里巴巴有1个。最近，MetaMarkets之前几个Druid发
1.5.4
的两个杀手。
对象。因此，Druid支持在任何维度组合上进行查询，访问速度极快，成为分析平台最重要
（Dimension）和指标列（Metric）。
不再支持Java 7，大部分公司都正在使用Java8版本，旧版本的Java也在升级中，建议直接
应用。
第1章初识Druid
一些数据行聚合在一起。另外，所有的查询都需要指定查询时间范围。
1.6.2
1.6.1
1.6
Druid在数据摄入之前，
Druid系统用Java编写，目前支持JDK7及以上版本。目前Druid论坛已经在开始讨论
每个数据集合都必须有时间列，这个列是数据聚合的重要维度，Druid会将时间很近的
内存配置越大越好，建议8GB以上。如果只用测试功能，4GB内存也可运行。
在操作系统方面，支持主流Linux和Mac OS，不支持Windows操作系统。
接下来，我们一起来看看Druid的HelloWorld 吧。
Druid开源后，
（1）时间列
Druid的基本概念
Druid 的 HelloWorld
Druid的部署环境
社区支持力度大
，受到不少互联网公司的青睐，包括雅虎、eBay、阿里巴巴等，其中雅虎
，首先需要定义一个数据源（DataSource），这个DataSource有
---
## Page 32
处理数据摄入。
用时长等核心可度量和比较的指标。
计算操作通常包括Count、Sum和Mean等。指标通常是业务的关键量化指标，包括收入、使
业务分析的精细化，增加维度列也是一个常见的需求。
告”、“哪个广告位置”、“计费的类型”、“广告主的类型”等作为广告展现的描述信息。随着
切片数据，维度列的字段为字符串类型。例如，对于一次广告展现，我们可以将“哪个广
8
Druid提供两种数据摄入方式，如图1-3所示，其中一种是实时数据摄人；另一种是批
数据摄人
数据格式样例如图1-2所示。
指标对应于OLAP概念中的Fact，即用于聚合和计算的列。指标列字段通常为数值类型，
维度来自于OLAP的概念，
（3）指标列
（2）维度列
批处理摄入
实时摄入
01T01:01:35Z
2011-01-
时间
时间列
#
HDFS
Kafka
广告主
Etc.
用来标识一些事件（Event），
图1-3两种数据摄人方式
图1-2
位置1
广告位置
数据格式样例
维度列
是否点击
20
展现次数
Druid实时大数据分析原理与实践
这些标识主要用于过滤或者
统一查询
展现价格
指标列
---
## Page 33
Zookeeper进行协调，另外还使用了MySQL提供一些元数据的存储。
式系统采用 Shared nothing的结构，各个节点都有自己的计算和存储能力。整个系统使用
实时数据处理部分是面向写多读少的优化，批处理部分是面向读多写少的优化。整个分布
端访问的开源项目，例如Python、R、JavaScript和Ruby等。
PlyQL等。
标准SQL的需求变得越来越重要，
的解析，采用自己定义的JSON格式，方便内外部处理。随着Druid应用越来越广泛，支持
准的SQL语言查询，因为有些SQL语言查询并不适用于Druid现在的设计。为了简化查询
3.数据查询
第1章初识Druid
有大规模部署Druid的成功经验。
1.7
在雅虎，已经验证过数百台Druid集群的规模。国内的阿里巴巴、小米、优酷等公司也
对于Druid的查询访问，除了原生Java客户端支持外，也出现了很多支持不同语言客户
在数据查询方面，Druid原生查询是采用JSON格式，通过HTTP传送。Druid不支持标
·超过100PB的原始数据
·每秒超过300万的事件
·每天1000亿的事件
MetaMarkets曾经介绍过它的一些扩展能力的数据。
Druid是一个分布式系统，
"context";{"skipEmptyBuckets":"true"}
"aggregations":[
"granularity":
"dataSource":
"queryType":"timeseries",
下面是一个用JSON表达的查询例子，该查询中指定了时间范围、聚合粒度、数据源等。
系统的扩展性
{"type":"LongSum", "name": "result_name","fieldName": “field_name” }
"day"，
"sample_datasource"
，采用Lambda架构，将实时数据和批处理数据合理地解耦。
一些开源生态项目正在向这个方面努力，例如Implyio的
---
## Page 34
数据库，Druid是一种时序数据库，按照一定的时间粒度对数据进行聚合，以加快分析查询。
署、更实时的数据摄入，Druid舍去了OLAP查询中比较复杂的操作，例如JOIN等。相比传统
系统，但是在实现方式上做了很多聚焦和取舍，为了支持更大的数据量、更灵活的分布式部
1.9
显的。
缩小了5~10倍。随着数据量的增大，这种性能改善的程度会越来越大。
Druid不能支持所有的查询，所以测试只覆盖了支持的查询场景。
有统一的业界标准。在参考资料中，提到了根据TPC-H标准数据集的性能评测结果。由于
1.8
0
从技术定位上看，Druid是一个分布式的数据分析平台，在功能上也非常像传统的OLAP
如图1-4所示是100GB规模的Druid测试数据，从测试结果来看，性能提升也是非常明
对于1GB的数据和100GB的数据，从查询性能来看，Druid基本完胜MySQL，查询时间
性能测试涉及太多的因素，包括测试数据源、访问模式、机器配置和部署等，因此很难
·数万个处理器核
·上千用户的每秒查询峰值
·超过50000亿的总数据
Druid 的应用场景
性能指标
Query
lop_100_commitdale
lop_100_parts_details-
top_100_parts_lfer -
counl _slar_mterval-
op_100_parts-
sum_al nter
sum all_year
sum_pnce
图1-4100GB规模的Druid测试数据
euns
Druid Scaling-100GB
09
Time(seconds)
Druid实时大数据分析原理与实践
150
---
## Page 35
6.优酷土豆
据洞察。
的实时监控系统，支持数百个关键业务指标。通过Druid，滴滴能够快速得到各种实时的数
5.滴滴打车
功能，支持细粒度的多维度查询。
后台数据收集和分析；另外，在广告平台的数据分析方面，Druid也提供了实时的内部分析
实时分析部分，每天处理数十亿的消息。
3.新浪微博
户的交互行为。
2.
Druid用于分析大量的用户行为，帮助提升客户价值。
量。在2B业务领域，作为中国领先的SaaS级社会化客户关系管理平台，腾讯企点采用了
1.腾讯
1.9.1
powered.html.
联网公司中，
第1章初识Druid
4.
小米
阿里巴巴
滴滴打车是世界领先的交通平台。Druid是滴滴实时大数据处理的核心模块，用于滴滴
优酷土豆是中国领先的互联网视频公司，Druid用于其广告平台的数据处理和分析。
小米是中国领先的专注智能产品和服务的移动互联网公司。Druid用于小米统计的部分
新浪微博是中国领先的社交平台。新浪微博的广告团队使用Druid构建数据洞察系统的
阿里巴巴是世界领先的电子商务公司。阿里搜索组使用Druid的实时分析功能来获取用
腾讯是一家著名的社交互联网公司，其明星产品如QQ、微信有着上亿级别庞大的用户
在应用场景上，Druid从广告数据分析平台起家，
国内公司
下面将介绍一些使用Druid的公司，最新列表可以访问http://druid.io/druid-
，已经广泛应用在各个行业和很多互
11
---
## Page 36
3.eBay
已经有一个非常大的集群，为业务分析组提供了各种各样的数据分析支持。
了Druid处理每天70~100亿条的记录数据，查询的响应时间非常理想。如今Druid在PayPal
2.PayPal
虎也深度参与这个项目的开发当中，不少Committer都来自雅虎公司，雅虎也在和社区紧密
Druid.
据摄入，无法灵活支持每日几百亿的事件。在尝试很多工具之后，最后他们还是深度拥抱了
点，高性能。
项目，针对单机JVM进程提供嵌人式的Druid解决方案，它不涉及复杂节点的部署，单节
支持商业分析的场景。另外，eBay的云平台组也在2016年2月开源了一个embedded-druid
析，数据量超过10万消息/秒。同时在查询方面，Druid提供了一个自由组合的条件查询功能，
合作推动Druid的发展。
着世界上最大的 Hadoop集群，但是Hadoop集群无法处理实时交互查询，无法支持实时数
1.雅虎（Yahoo!）
1.9.2
化率、IP分布情况和收入等维度的分析。
8.YeahMobi
监测数据收集，并且提供给用户灵活的查询功能。
7.
YeahMobi是一家专注移动互联网的营销公司。Druid用于广告数据的实时分析，包括转
蓝海讯通（OneAPM）
eBay是互联网电子商务的领先公司。eBay使用Druid聚合多个数据源，用于用户行为分
PayPal是世界领先的互联网支付公司。2014年年初，PayPal的Tracking Platform组采用
Druid用于数据收集，为管理层提供仪表盘，为客户提供实时的数据查询功能。另外，雅
雅虎是全球领先的互联网公司，它也是最早一批深度使用Druid的公司。雅虎曾经维护
蓝海讯通是中国领先的应用性能管理（APM）的技术服务公司。Druid用于实时的应用
国外公司
Druid实时大数据分析原理与实践
---
## Page 37
高效率。在应用场景上Druid 满足了OLAP的核心功能，在社区推广方面Druid也同样值得
数据摄入的能力，通过数据的预聚合、优化存储结构和内存使用，保证了在查询分析方面的
的数据分析痛点。在技术上Druid采用分布式、Sharednothing结构，提供了实时和离线批量
Druid，使用和优化Druid，以解决客户的数据分析需求。
来有三个原因。
色之一
1.10小结
数据量处理能力、数据实时性和秒级数据查询功能。
用，也有很多老牌公司在使用，例如Cisco、SKTelecom等。大部分公司都看中了Druid的大
告数据分析，但广泛应用于用户行为分析、网络数据分析等领域。不仅仅有互联网公司在使
和 Archive-it.org等，其他公司还包括AirBnb、DripStat等。
5.思科（Cisco）
用户行为和应用数据分析。
4.Hulu
第1章初识Druid
称赞。
据的摄人、
在Hadoop和 Spark大生态繁荣圈中，Druid能获得众多公司的青睐，异军突起，总结起
我们非常高兴看到最近几年Druid获得的长足快速发展，并且解决了很多公司在业务上
第三，出现了专业的Druid技术服务公司，例如 Implyio等，帮助企业客户更好地认识
Druid从出生到繁荣，很单纯和专注地解决了大规模数据的分析问题，实时性是它的特
第二
第一，Druid不断拥抱各种主流开源生态，例如Hadoop、Spark等。
总结这些公司的使用场景，Druid确实提供了一个相对通用的数据分析平台，起源于广
此外，还有很多使用Druid的公司，广告公司还包括Criteo、LDMobile、MetaMarkets
思科是世界领先的通信技术公司之一，使用Druid对网络数据流进行实时的数据分析。
Hulu是美国领先的互联网视频公司。Hulu使用 Druid 构建数据分析平台，进行实时的
客户端的访问、数据查询的便利和数据的可视化等。
、围绕着Druid，已经开始出现一些项目，完善了Druid的生态系统，其中包括数
13
---
## Page 38
参考资料
Druid 的技术论文：http://static.druid.io/docs/druid.pdf
Druid应用公司列表：http://druid.io/druid-powered.html
Druid主页：http://druid.io
Druid实时大数据分析原理与实践
---
## Page 39
联机分析处理（On-LineAnalyticalProcessing，OLAP）等概念在名称上和数据分析方面非常
过程如图2-1所示。
信息（Information），再从信息变成知识（Knowledge），最后从知识变成智慧（Wisdom）。其
有价值的洞察和可以付之于行动的建议。数据分析的目的就是帮助我们把数据（Data）变成
丰富的内容和精尖的技术。
2.1
适合自己场景的分析软件，并且和Druid做一些技术上的比较。
在数据分析领域，商务智能（Business Intelligence，
数据分析是指通过数据的收集，进行数据处理和分析，将数据整理成有用的信息，包括
数据分析（DataAnalytics）从来都不是一个寂寞的领域，每一个时代都赋予数据分析更
本章我们将介绍数据分析及相关软件，以帮助读者了解数据分析软件的一些分类，找到