1
DNSPD: Entrap Botnets Through DNS 
Cache Poisoning Detection
p1t1r
HITCON 2010
2
自介
 Hi, this is p1t1r
 资安背景
Rootkit
Web
Network
DNS spoofing
3
DNS攻击
 DNS Cache Poisoning攻击
 很危险的东西，迄今尚未被解决
 你上的任何网站都有可能是攻击者的网站
 防御机制
 一大堆
 不过预设的DNS环境是未受保护的
4
DNSPD
 防御，顺便抓 Botnet
 Botnet 正夯 !!!
 问题：
 这个防御机制够稳当吗?
要看攻击者的人品
 其他机制也可以抓，要你何用?
好像可以快一点、准一点
应该还有不少问题...
……. !!
5
DNS 简介
 功用
 将domain name 对应至 IP Address(es)
 www.google.com  74.125.153.103, …, 
etc.
 特点
 大多采用UDP连线
 快
 先到的答案，就是正确的答案
 (?)
6
DNS 结构
Domain Name Space
Name Server
储存/管理 特定的domain name
Resolver (cache server)
暂存之前查询过的资料(domain name & IPs)，方便快速回应
保存资料，直到 TTL 过期
攻击者的主要目标!!!
7
DNS 运行方式
8
DNS Resolver 面对的威胁
 UDP封包可以伪造来源IP
 难以认证资料的可信度
 Resolver 如何验证资料正确性?
 答案必须对应之前提出的问题
 来源IP 要符合
 Port Number 要符合
 Transaction ID 要符合
9
DNS Cache Poisoning 攻击
攻击目标
1.
先选 DNS Cache主机 (Resolver)
Google Public DNS - 8.8.8.8
2.
再选 特定domain
例如: 将 blog.hitcon.org 的IP改成 攻击者的IP
攻击发起时机
目标domain的资料，不存在Resolver的cache中
Resolver向外部name server发出询问，而且尚
未收到答案前
10
传统 DNS Cache Poisoning 攻击
www.google.com ?
相信我….
你要的答案是
115.115.115.115
实际上
www.google.com:
64.233.183.99 
64.233.183.103 
64.233.183.104 
64.233.183.105
...............
Attack end
Attack 
begin
11
传统攻击之缺点
 每次失败都要等! 等! 等!
 等 TTL过期
 若是TTL很长
 三秒捕鱼，两天晒网
12
Dan Kaminsky
 Black Hat USA 2008
 DNS Cache Poisoning Attack
不用再为TTL烦恼了 !
随时可以发起攻击
想打多久也随便你
 适用BIND9任何版本
不过，难度不同
v9.4.2之后，增加了random port
13
Kaminsky 效应 : DNSSEC热销
From: “Deploying and Monitoring DNS Security (DNSSEC)”
14
Kaminsky’s Poisoning Attack
.....        
1 
Time  
interval 
2 
3 
Malicious 4 
Client 
Resolver 
Authoritative  
name server 
我是 www.google.com，
我来自115.115.115.115
你要找的答案 并不存在
请相信我喔~
我是ns1.google.com
来自216.239.32.10
你要找的答案 并不存在
千万别问
www.google.com
改问
123.google.com?
1234.google.com?
……
99999.google.com?
……
15
Kaminsky攻击封包
16
数学公式 – 攻击成功机率
 RFC 5452
Poisoning 成功机率
打了很多回合，至少成功一次的机率
带入参数
W 
T
A
S
I
P
N
R
W
P
/
CS 
*
*
*
1
1
1
1
P
*P *I
N
W *R
PS 
T W 
R
/
CS
*64000*65536
5.2
*
1.0
1
1
P
17
攻击模拟
0
0.1
0.2
0.3
0.4
0.5
0.6
0.7
0.8
0.9
1
0
5
10
15
20
25
30
35
40
45
50
55
60
Time (hour)
Spoofing Probability
N(1), Rate(7000)
N(1), Rate(70000)
N(1), Rate(700000)
N(2.5), Rate(7000)
N(2.5), Rate(70000)
N(2.5), Rate(700000)
18
一些防范措施
 DNSSEC
非对称式加密、电子签章
 Google method
没有答案，就别多管闲事
19
Major Components of DNSPD
 DNS Resolver
 Router
 Analysis Crawler
20
DNSPD效应
 如果攻击者要躲避DNSPD的侦测
攻击频率必须小于门槛值
单一IP，非常难以成功
使用 Botnet 成员
投入多个IP
攻击低于门槛值的情况下，仍可提高成功机率
But …
21
结论
 DNSPD可以有效侦测Cache Poisoning
攻击，并避免其危害
 DNSPD可以迫使攻击者使用Botnet
 DNSPD可能会间接保护其他Resolver
22
Q & A
 谢谢大家