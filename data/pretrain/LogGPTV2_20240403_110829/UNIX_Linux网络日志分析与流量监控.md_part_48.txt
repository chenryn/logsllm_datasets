tcp
tcp
Proto Recv-QSend-QLocal AddressForeign Address(state)
ftp>1s
jane%telnetvictim.test.com
jane%ls-la
0
0
0
192.168.0.2
p
00:00:00
192.168.0.2.23192.168.0.4.1030ESTABLISHED
00:00:00
*.21
*.80
*.22
*.23
图9-6蜜罐系统报警信息
1021604
**
2-NETBIOS SMBIPCS share
LISTEN
LISTEN
LISTEN
LISTEN
nbufferoverlow attempt
overtlow
报警信息
六十案
惠
如
---
## Page 280
test.com上的工具。
com的telnet连接。对这个网站进行了同样的检查之后，攻击者通过FTP下载了一个隐藏在
录，接着查看还有谁在系统中：
日志，期望能找到一些线索。日志的第一部分显示，这个攻击者先用 jane这个用户账号登
部小军知道，他面临的是严重的网络滥用。小军可以肯定攻击者另有其人。他决定去分析
案情分析
交互问答
网络。很明显这是一个外部攻击者，利用他们的网络跳到了别的主机。
攻击者无意间用了错误的 nmap版本，但他通过第二次连接取得了正确版本。
攻击者发现这个系统对进一步攻击来说是安全的，因此他执行了另一个与victim.test.
4.本次事件涉及哪些潜在的法律问题？
在查看了这些日志后，小军联系了领导和同事，确信在那段时间内公司内部没有人使用
1.在这次事件中发生了什么？
确定攻击者来自何处的最佳途径是什么？
小军应该在网络上做些什么，以防止进一步的攻击？
jane%w
supper%/lamp -sT-p 20-79,111,143,6000 www.test.com
supper%./lamp-sT-p20-79,111,143,6000www.test.com
ftp>getlamp
supper%/lnmap
nbgetlamp
ftp>cdpub
ftp>cd pub
PnbupoDebb-blqh
治
第9章远程连接安全案例257
爱其
DGTRRE
卫
mlat
2
本
LE
---
## Page 281
次攻击正进行着，因此小军被卷入这次攻击并发现了它，就不足为奇了。
追查。收集中间跳的日志和记录将提供此嫌疑犯的罪证。
连出的所有连接，以免自己成为黑客的跳板。调查工作显示，攻击者用了多次跳转，以躲避
侵此主机的后门程序，主动攻击别人的网站，因此可在服务器防火墙中设定禁止由主机主动
全管制，其中网络访问的安全管制可以靠防火墙来执行。一般黑客跳板的发生，都是经过入
联动的日志分析引擎很有必要，具体搭建方法见第14章，与此同时应切实做好网络访问安
机的操作系统、应用程序的漏洞确实做好防补措施，另外使用一套像OSSIM那样具有安全
到一个只读介质上去，第2章介绍的dd命令是一个合适的工具（在第2章有使用方法）。
目前的状态，而与其他的访问断开连接。如果不可行，小军应该为其磁盘做一个映像，存放
为其他的受害者希望继续借助于法律，因此有必要保存资料作为证据。最好保存这个驱动器
FTP的账号）以及其他受害者的信息的站点。直接连接ISP可能泄露一些关于攻击者的额
级跳”技术来隐藏自己。这个攻击者也只是使小军看到一个用来隐藏踪迹的站点。攻击者总
258UNIX/Linux网络日志分析与流量监控
如果要防止自己的计算机成为黑客跳板，首先要确实做好自己计算机的安检工作，对主
预防措施
外信息。
全永远是第一位的，系统应该完全重装，所有邻近的系统也应仔细检查。
军应采用部署防火墙和IDS或IPS等安全设备。
置一个可靠的防火墙，并利用NAT 对网络内部IP地址进行转换。对于最近的这次攻击，小
是把被攻破系统的存储空间作为中转站。
疑难解答
本案例中，由于网络的安全级别太低，小军的网络被滥用了。
小军使用网络监控无疑是十分恰当的。有个账号被用来攻击 Intermnet 上的其他网站。因
：3．小军在系统被攻破之后才赶到现场，因此没有发现这次攻击利用了什么漏洞。但安
2.这个案例中显然仅仅依靠路由器上的访问控制链表ACL是不够安全的。小军应该设
1．攻击者用这几个账号作进一步攻击及扫描的跳板机。一般来说，攻击者会采用“多
4.攻击者的FTP连接显示，这个网站可能是一个存储关于这两个账号（用于登录
Nmap run completed -- 1 IP address(1 host up) scanned in 49 seconds
111/tcpopensunrpc
22/tcpopenssh
21/tcpopenftp
PortStateService
(The 59 ports scanned but not shown below are in state: closed)
Interestingportson(www.test.com):
Starting nmapV.4.1BETA27（www.insecure.org/nmap/)
/tcpopentelnet
naromiorbnnir
。当小军进入网络时，这
pomi
的
ip
---
## Page 282
行分布式的配置，可以把服务器和控制台接在一个交换机上，而其他传感器放置在不同的物
中是有可能实现的，但对大型企业来说，几乎是无法实现的。
和任何从外部到企业的连接都处在Snort的监视之下。这个想法在只有几十台计算机的环境
期安装前，需要先确定想要监控的内容。理想的状况是对一切进行监控，即所有网络设备
10.1.1准备工作
整个系统崩溃。下面以Snort为例，介绍正确地安装和维护IDS的思路和方法。
如，有的企业因为IDS 配置不当，仅误报一项就能把数据库填满，引起大量丢包，导致
它并不是万能的，不可能解决所有的安全问题，有时甚至还会给企业带来很多麻烦。
后面详细讨论。
行重组。Snort能够对IP包的内容进行匹配，但是对于TCP攻击，如果攻击者使用一个程
MySQL等任何UNIXODBC数据库。使用TCP流插件（tcpstream），Snort可以对TCP包进
使用数据库输出插件，Snort可以把日志记入数据库，当前支持的数据库包括Postgresql，
测、探测操作系统指纹特征的企图等。
UDP，ICMP 等。它能够检测多种方式的攻击和探测，如缓冲区溢出、CGI攻击、SMB 探
的报警机制很丰富，所以在各种应用系统中使用相当广泛。
时流量分析和网络数据包分析能力，能够快速地检测网络攻击，及时发出报警。Snort
都提炼出其特征值并按照规范写成检验规则，从而形成一个规则数据库。Snort具有实
入侵预警或记录。Snort能对已知攻击的特征模式进行匹配，它针对每一种入侵行为，
过分析捕获的数据包，匹配入侵行为的特征或者从网络活动的角度检测异常行为，进行
Snort 是一个基于网络的入侵检测系统（NIDS），其工作原理为在网络传输中，
的Snort系统。
记录网络IP数据包的强大的网络入侵检测系统。下面介绍讨论如何在企业中部署一个实用
1998年，由MartinRoesch开发的。今天，Snort已发展成为一个跨平台、实时流量分析、能
为了加强Snort检测的安全性，最好能为监控网段提供独立的智能交换机。如果需要进
IDS能发现可疑行为并发出警报，它已经成为企业深度防御策略中的重要部分。
Snort的日志格式既可以是tcpdump式的二进制格式，也可以解码成ASCⅡ字符形式
10.1
Snort能够进行协议分析及内容的搜索/匹配。目前Snort 能够分析的协议有TCP，
第10章
Snort 是美国 Sourcefire公司发布的IDS（Intrusion Detection System）软件。最初它是在
Snort安装与使用
Snort系统部署及应用案例
JOTTE
例
---
## Page 283
的瓶颈，那么如何缓解这种瓶颈呢？有以下几种方法可以尝试。
统调用以及内存操作都是非常消耗系统资源的，频繁的系统调用和内存复制会成为系统性能
理，每到达一个数据包，都会通过一个中断将数据包送到内核中。在操作系统中，中断、系
式。每个数据包到达网卡时，会产生一个硬件中断，然后调用网卡驱动程序中的函数来处
系统的数据包捕获性能瓶颈进行分析，并提出改进的思路。
系统不能及时得到所有的数据包，其作用就会大打折扣。下面对基于Snort的网络入侵检测
文件中。
ARPspoof、ASNI_decode、Fnord、Conversation、Portscan2、SPADE。
Frag2、Stream4、Stream4_reassemble、Http_decode、RPC_decode、BO、Telnet_decode
能对其进行正确解释。预处理的参数可以通过 snort.conf 配置文件调整。预处理器包括
迅速被送到预处理程序和检测引擎进行分析。
议的解码器时，解码后的数据包将堆满一个数据结构。数据包被存入数据结构中以后，就会
的方法，也成为制约 Snort 对千兆网络进行监控的瓶颈。可以用 PF_Ring 提高捕包效率。
理一个包，从网卡到内核，再从内核到用户空间，花去了大量 CPU 时间，所以这不是最好
操作系统更改的特性来检测某些形式的攻击。不过，利用 libpcap 抓取原始包，一次只能处
程序使用的，
抓包的任务。libpcap 可以独立地从物理链路上进行抓包，是由底层操作系统提供给其他应用
况定制Snort，避免一些常见的错误。
影响。深入了解 Snort 细节，有助于有效地利用 Snort 监控入侵，也便于根据网络的实际情
10.1.2深人了解Snort
理位置，但这样会增加成本。
260 UNIX/Linux 网络日志分析与流量监控
宣为了达到对网络上的所有数据包进行监听的目的，Snort 在启动之初，会工作在混杂模
3）预处理程序
Snort 没有自己的抓包工具，需要一个外部的抓包程序库 libpcap，由它承担直接从网卡
1）用libpcap输送Snort包
对于高速网络而言，当数据包流量较大时，Linux平台会大量地丢弃数据包，导致Snort
Snort的输出插件用来接收Snort传来的数据。输出插件的目的是将报警数据转储到另一
4）检测引擎
Snort的预处理分为两类，可以用来针对可疑行为检查包或者修改数据包以便检测引擎
2）包解码器
Snort 需要数据保持原始状态，它利用的就是原始包所有的协议头信息都保持完整未被
5）输出插件
检测引擎将流量与规则按其载入内存的顺序依次进行匹配，它是Snort的主要部件之一。
数据包一旦被收集到Snort，必须对每一个具体的协议元素进行解码。在包通过各种协
提示：
，是一个真正与平台无关的应用程序。
---
## Page 284
SPAN，Cisco交换机的中高端产品都有 SPAN 端口或镜像端口。SPAN端口既可以是一个专
可以按如下方式使用bondo网卡：
绑定的网卡：
你启用Snort时，就能用-i命令选项指定已被绑定的网卡（如bondo）。
样做，或者不想为每个网卡启用额外的 Snort 进程，则可以将两个网卡绑定在一起。这样当
Snort进程载入不同的配置、规则和输出插件。这最适合于独立的Snort进程。如果你不能这
创建了一个虚拟的传感器。在一个计算机上架设几个“传感器”，你就可以为每个独立的
是最理想的。如果你为每个网卡都分配了一个独立的Snort 进程，那么就相当于为每个网
警的时候。当你面对不同的网卡有不同的入侵检测需求时，为每个网卡分配单个Snort进程
配置，那么同样的攻击会被报告多次。这会令入侵检测系统管理员头疼，尤其是启用系统报
→
个网卡。在多网卡上运行Snort的方法是：
Snort 程序，可以配置Snort来侦听多个网卡，问题是Snort 每个命令行选项（-i）只接受
一个改善其性能的方法是多网卡绑定。下面以双网卡绑定为例来讲解。在双网卡上运行
段，
高网络性能的方法。
理延时，所以NAPI技术可用于高带宽情况下的数据包捕获，是一种能够在Linux系统中提
突问题。轮询在重负载的情况下非常有效，但是在负载较轻的情况下，可能会带来较大的处
的方式读取数据，而是结合中断与轮询的优点，来有效解决网络高负载情况下带来的拥塞冲
多个Snort进程，那么你应该考虑一下数据管理问题。假设所有的Snort实例以同样的方式
另一个方法就是在交换机上启用SPAN。在监控时从性能方面考虑，笔者建议做
现在每次重启计算机，都需要在将 IP 地址信息分配给网卡之后输入下而的命令，激活
Snort 进程会增大工作量，并浪费大量的处理器时间。如果你有可用的资源来运行两个或
注意，你可将这些命令放在一个脚本里，在系统启动时运行该脚本。当运行 Snort 时，
NAPI 是Linux 上采用的一种提高网络处理效率的技术，它的核心概念就是不采用中断
为了实现这个目的，应编辑/etc/modules.conf，加入如下行：
用Snort监控多个网卡时选择哪种方法取决于具体的环境和优先级等多种因素。运行多
●为每个网卡运行一个独立的Snort进程。
启用的检查包内容的规则越多，Snort 的运行就需要越多的系统资源。在部署 Snort 时，
Snort的性能主要受配置设定及规则集设置的影响。其内部瓶颈一般出现在包解码阶
2.采用多网卡绑定技术
1.利用NAPI技术提高数据包捕获性能
通过绑定Linux内核的特征将所有的网卡绑定在一起。
snort-ibondo
alias bondo bonding
ifenflavebondoethl
ifenslavebondo etho
ifconfig bondup
第10章Snort系统部署及应用案例261
品音
---
## Page 285
以“output database:”开头的行，将其“#”号去掉，即表示启用这些规则。
免费提供少量规则下载。
内容在前面章节已经详细讲解过。然后安装 Snort。
10.1.3安装Snort程序
SPAN端口监控法会使交换设备的内存负担过重，从而使设备的性能下降。
好了之后，可以切合实际地、循序渐进地增加其他端口，不要一次增加过多的监视端口。用
一个端口，对 Snort 的性能观察一段时间，并根据需要进行调整。当 Snort 的这个端口调整
硬盘I/O够快），效果比以上两种方法要好得多，但这种方法投资较大。AV
用硬件方式，采用VSS Monitoring的流量采集卡，可以轻松采集千兆及万兆流量（只要
这一点将在第13章解释。
用端口，也可以通过该端口实现交换机上所有端口的配置选项设定，当然SPAN也有不足，