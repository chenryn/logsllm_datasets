# 05 \| 云硬盘：云上IO到底给不给力？你好，我是何恺铎。通过前几讲的学习，我想你对云虚拟机应该有了不少的了解，也对如何根据实际情况来选择和运用虚拟机，有了一定的认识。在前面的学习过程中，我也留下了许多伏笔。其中之一，就是云虚拟机的重要组件：**云硬盘**。那么今天这一讲，我们就来深入讨论一下这个话题，来帮助你了解不同云硬盘的差别，以及如何在实际场景中挑选最合适你的硬盘型号。云硬盘是什么？云硬盘，又叫做"云盘"或者"云磁盘"，就是云虚拟机上可以挂载和使用的硬盘。这里，它既包含了用于承载操作系统的系统盘，也包括了承载数据的数据盘。在云计算的领域，有时，我们还会把云端磁盘服务叫做块存储（BlockStorage），因为它们与 Linux操作系统中的块设备相对应，是云上提供的"裸盘"，可以格式化并且施加文件系统。既然是硬盘，那么它就与我们通常的认知相一致，当然是带有数据持久化功能的。这在专业上被称为"**非易失性存储**"（Non-ephemeralStorage），也就是说**写入的数据不会丢失**。即便所在虚拟机重启、关机甚至下线删除，这块云硬盘只要还存在，其中的数据也并不会被擦除。事实上，云厂商对于云盘，不仅仅会保障数据的顺利写入，一般还会帮你在存储端同步和保留至少三份副本的数据。所以说，云硬盘的冗余度和可用性是非常之高的，一般极少发生云硬盘数据丢失的情况，你大可放心地使用。>  > 重要提示：尽管云硬盘有良好的存储冗余，但你不能仅仅依赖它的可靠性。从数据的层面来看，你必须进行额外的备份。2018> 年 7> 月曾有创业公司因为云厂商故障，丢失了在云硬盘上的所有重要数据，一时成为业界的热点新闻，这个教训是非常深刻的。所以，你应当通过定期为云磁盘创建快照、异地备份数据文件等方式，来保护你的关键数据。> > >云硬盘与传统磁盘的真正差异在于，绝大多数的云硬盘都是**远程**的。我们都知道，在经典计算机的体系结构中，硬盘是通过本地机器内部主板的高速总线，与CPU、内存等部件相连接；而在云端，你的硬盘则很可能并不在宿主机上，而是在专用的磁盘服务器阵列中，**两者是通过数据中心内部的特有 IO线路进行连接**。没错，这也正是**[计算存储分离架构 slate-object="mark"}**的一种体现。理解了这样的一个结构，你就能明白，有些云上的"IO 优化实例"（AWS 上称为EBS-Optimized）是指什么了。它就是指云虚拟机与云硬盘之间的网络传输，进行了软硬件层面的优化，这样可以充分地发挥所挂载磁盘的性能。现在较新型号、较强性能的云虚拟机，一般都自动启用了这个优化。云硬盘的性能等级你可能听说过一些，网上对于云硬盘性能方面的质疑。这在云计算发展的早期尤其多见，甚至成为了很多人反对上云的主要原因之一。不错，云硬盘的确有多副本写入的开销，同时也比较依赖于远程传输。所以，早期云硬盘的确存在一些性能上的短板。不过，那都是老黄历了。当下的云硬盘经过了多次的软硬件迭代，尤其是 SSD的迅速发展，吞吐量和随机读写能力等各项性能指标都已经不再是问题了。在现代云计算中，已经发展出了基于不同存储介质的、丰富的性能等级选择，你已经能够找到单盘IOPS在数十万量级甚至达到百万的云硬盘产品了。所以，现在的云硬盘，性能上已经非常"给力"了。**你更多的是要考虑如何根据应用场景，选择合适介质的****[硬盘等级 slate-object="mark"}****，同时权衡好相应的成本。**那么下面，我们就分别来看一看主流云硬盘的不同性能等级，以及它们对应的磁盘类型和存储介质。**第一个等级的云硬盘，是基于传统 HDD硬盘构建而成的**。这类云盘的性能一般，最高 IOPS大概在**数百**左右。在很多的云上，已经不把它作为推荐的选择了。但它并非一无是处，**成本低**就是它的最大优势，在不注重性能的测试环境，或者是个人自用的服务器，它就是一个很好的选择。**第二个等级，往往是基于混合硬盘，也就是结合 HDD 和 SSD硬盘构建的云硬盘**。它会综合发挥 SSD 的性能优势和 HDD的容量优势。比如它可以用 SSD部分来承载热点区域数据，或是作为缓存，来提高响应性能。在这个等级下，典型的IOPS 为**数千**左右，是很多云上创建硬盘的**默认选项**，比较适合像是操作系统启动盘这样的常规负载。**第三个等级的云硬盘，它的存储介质就是纯 SSD硬盘了**。虽然贵一些，但一分价钱一分货，这个等级下的云硬盘能够提供非常稳定的IO 能力，IOPS 通常能够**上万**，也有相当不俗的吞吐量和较低的访问延时。你可以用它来承载生产环境中重要的关键业务应用，或是各类数据库等IO 密集型应用。**第四个等级，也是当下业界的最高等级，就是进一步优化增强的最新 SSD云盘**。它一般会采用更新一代的企业级闪存硬件，配合自研或改进后的底层传输协议，和虚拟化技术栈的优化来提供服务。因此它能够达到惊人的性能水平，满足我们最为苛刻的性能场景需求，比如承载SAP HANA（SAP 的高性能计算平台）、高并发 OLTP 数据库等等。这类 SSD云盘的 IOPS 通常能够**突破十万以上**。各个云对于不同等级云硬盘的命名方法各有不同，我把相应的产品类型和名称整理成了一个表格，方便你去了解和查询：![](Images/3eb822c512fcbd9477aa7f68000863a2.png)savepage-src="https://static001.geekbang.org/resource/image/97/13/97150c100ba7b7d25dd5750e1c01ad13.jpg"}当然，这个表格只是一个大致的划分，仅供你作为参考。在具体的情况中，云和云必然存在一些差异，也会有一些各自的产品特点，建议你在使用时针对性地确认。比如说，AWS的 gp2 通用型 SSD 类型，它具有比较宽广的性能指标范围，还具备 I/O积分和性能突增机制（与性能突增 VM 实例的 CPU类似），可以提供比较高的峰值性能，应用场景是相当广泛的。除了云盘性能等级之外，**还有一个影响云盘性能的重要因素，就是这块云硬盘的****[容量 slate-object="mark"}**。不论是哪种磁盘类型，它的容量大小几乎都与性能正向相关。同等的性能等级下，云硬盘的容量越大，一般来说它的性能就越高，直到达到这个等级的上限。这是由云上磁盘能力共享的底层设计所决定的。**所以在某些时候，你可能需要刻意地增大所申请的云硬盘的容量，以获取更高的性能，即便这些额外的空间不一定能被用上。**好了，对于云盘性能的讨论就先到这里。在上面的性能讨论当中，我们主要通过**IOPS** 来进行衡量。事实上，衡量 IO性能还有吞吐量、访问延时等其他的重要指标。这些指标同样会由磁盘的类型和大小所决定，你可以查询云厂商文档来确认。这里限于篇幅，我就不详细展开了。云硬盘实战接下来，让我们进入实战环节，一起学习一下云硬盘的使用。在这个过程中，你也能真实地感受一下不同性能等级的区别。这里，可以继续沿用我们在第 2 讲slate-object="inline"中创建的阿里云虚拟机，目前它是默认挂载了一个 **40G的高效云盘**作为系统盘。**我们可以先用 lsblk 和 df命令查看一下磁盘的情况：**    [root@my-ecs-vm1 ~]
# lsblk    NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT    vda    253:0    0  40G  0 disk    └─vda1 253:1    0  40G  0 part /    [root@my-ecs-vm1 ~]
# df -hT -x tmpfs -x devtmpfs    Filesystem     Type  Size  Used Avail Use% Mounted on    /dev/vda1      ext4   40G  1.6G   36G   5% /通过命令的输出，可以清晰地看到，这台机器有一块 40G的系统盘，挂载在根目录下。**然后，我们可以使用 fio工具来测试一下这块系统盘的性能表现。**我们通过 fio 在系统盘上创建一个 1GB 的文件，接着进行 4K大小的随机读取实验。    [root@my-ecs-vm1 ~]