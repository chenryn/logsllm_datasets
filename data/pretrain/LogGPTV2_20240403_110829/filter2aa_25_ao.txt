15.4 密码重置凭证与用户账户关联不严
有些信息系统在密码找回功能的校验逻辑上存在缺陷，只校验了密码重置凭证是否在
数据库中存在，但未严格校验该重置凭证和用户账号之间的绑定关系。这种密码重置凭证
与用户账户关联不严的逻辑漏洞就让攻击者可以通过在数据包中修改用户账号达到重置其
他密码的目的，如图15-26所示。
图15-26 业务流程图
15.4.1 使用短信验证码找回密码
步骤一：进入某手机厂商官网，首先填写自己的手机号码进行密码找回。
步骤二：收到验证码后填入验证码和新密码提交，这时候使用数据抓包工具进行抓
包，将数据包中的username修改为其他账号，post上去后就可以使用自己设置的密码登录
其他账号，如图15-27所示。
图15-27 重置密码链接
15.4.2 使用邮箱Token找回密码
步骤一：进入某公共信息网站使用真实信息找回密码后，系统会发送一封邮件到绑定
的邮箱。邮件中的找回密码链接如下：
http：//**.**.**.**/test.do？method=resetPassword&id=用户ID值
&authcode=XXX&Email=邮箱地址
步骤二：访问后可直接进入用户密码重置页面。在该页面输入新密码，并在提交时使
用抓包工具抓取数据抓包，可获得以下内容：
org.apache.struts.taglib.html.TOKEN=83accc27d5178f832d9f22a1d02bdacf&org.apache.struts.taglib.html.TOKEN=83accc27d5178f832d9f22a1d02bdacf&rt Password=123456&passwordw=123456&rtEmail=邮箱&idtagCard=用户ID
步骤三：虽然包文中含有org.apache.struts.taglib.html.TOKEN和
org.apache.struts.taglib.html.TOKEN两个Token参数，但因为并没有和用户ID进行绑定验
证，依然可以通过修改用户ID重置他人密码。随机修改了一个用户ID并提交后，提示密
码重置成功，如图15-28所示。
图15-28 密码重置成功
15.5 重新绑定用户手机或邮箱
有些信息系统在绑定用户手机或者邮箱的功能上存在越权访问漏洞。攻击者可以利用
该漏洞越权绑定其他用户的手机或者邮箱后，再通过正常的密码找回途径重置他人的密
码。
15.5.1 重新绑定用户手机
步骤一：首先注册一个某邮箱的测试账号，然后会跳转到一个手机绑定的页面上，如
图15-29所示。
图15-29 绑定手机页面
步骤二：注意此处链接中有个参数为uid，将uid修改为其他人的邮箱账号。填入一个
你可控的手机号码，获取到验证码。确定后这个目标邮箱已经被越权绑定了密保手机，如
图15-30所示。
图15-30 手机号码绑定成功
步骤三：走正常的密码取回流程，发现这个邮箱多了一个通过手机找回密码的方式，
这个手机尾号就是刚刚绑定的手机号码，如图15-31所示。
步骤四：获取验证码并填入新密码，最终成功重置了目标账户的密码，如图15-32所
示。
图15-31 找回密码流程
图15-32 找回密码成功
15.5.2 重新绑定用户邮箱
步骤一：某网站用户注册后的激活页面链接如下：
http://**.***.com/user/test/2815193
步骤二：链接尾部的一串数字是用户的ID，通过修改这个ID即可进入其他用户的页
面，如图15-33所示，该页面提供了更改邮箱地址的功能，可在此处将邮箱地址修改为自
己的测试邮箱。
图15-33 用户激活页面
步骤三：然后使用该测试邮箱进行密码找回，即可重置目标用户的密码，如图15-34
所示。
图15-34 重置密码成功
15.6 服务端验证逻辑缺陷
有些信息系统的服务端验证逻辑存在漏洞。攻击者可以通过删除数据包中的某些参
数、修改邮件发送地址或者跳过选择找回方式和身份验证的步骤，直接进入重置密码界面
成功重置其他人的密码。
15.6.1 删除参数绕过验证
步骤一：某邮箱系统可以通过密码提示问题找回密码，如图15-35所示。
图15-35 通过密码提示问题找回密码
步骤二：首先随机填写密码答案，然后进入下一步，抓包后将问题答案的整个字段都
删除再提交，如图15-36所示。
图15-36 抓包截图
步骤三：因服务端验证逻辑存在缺陷，无法获取到问题答案的情况下直接通过了验
证，密码重置成功，如图15-37所示。
图15-37 密码修改成功
15.6.2 邮箱地址可被操控
步骤一：某网站可以通过注册时填写的邮箱来找回密码，但为防止网络不稳定等因素
导致邮件发送失败，找回密码页面提供了“重新发送邮件”的功能，如图15-38所示。
图15-38 重新发送邮件
步骤二：单击重新发送邮件，然后抓包拦截请求，将数据包中的邮箱地址改为自己的
测试邮箱，如图15-39所示。
图15-39 抓包截图
步骤三：进入自己的测试邮箱，单击收到的链接，密码重置成功，如图 15-40所示。
图15-40 修改密码成功
15.6.3 身份验证步骤可被绕过
步骤一：进入某网站的密码找回功能，输入账号和验证码，如图15-41所示。
步骤二：确定后，直接访问 http：//**.***.com.cn/reset/pass.do 即可跳过选择找回方式
和身份验证的步骤，直接进入重置密码界面，如图15-42所示。
图15-41 密码找回界面
图15-42 重置密码界面
步骤三：最终成功修改密码并登录到个人中心，如图15-43所示。
图15-43 登录成功
15.7 在本地验证服务端的返回信息——修改返回包绕过验证
有些信息系统在密码找回功能的设计上存在逻辑漏洞，攻击者只需要抓取服务端的返
回包并修改其中的部分参数即可跳过验证步骤，直接进入密码重置界面。
修改返回包绕过验证案例如下。
步骤一：进入某电商网站，单击忘记密码，输入用户名admin后选择手机找回，单击
发送验证码，然后随便填写一个验证码，单击下一步按钮，如图15-44所示。
图15-44 验证手机
步骤二：此时抓包并拦截返回的数据包。经过测试，将返回码改成 200 即可绕过验证
逻辑，如图15-45所示。
图15-45 修改返回包
步骤三：直接跳转到了重置密码页面，如图15-46所示。
图15-46 重置密码页面
15.8 注册覆盖——已存在用户可被重复注册
有些信息系统的用户注册功能没有严格校验已存在的用户账号，导致攻击者可以通过
重复注册其他用户账号的方式重置他人密码。
已存在用户可被重复注册案例如下。
步骤一：进入某快递网站，单击用户注册，输入用户名admin，在鼠标离开输入框后
会提示该账号已注册，如图15-47所示。
图15-47 注册界面
步骤二：输入一个未注册的用户名并提交表单，同时用抓包工具截取数据包并将
username修改为admin，如图15-48所示。
图15-48 抓包并修改用户名
步骤三：此时 admin 用户的密码被重复注册的方式修改了，但原用户的所有信息却没
有改变，也就是说这时候攻击者获取了用户的信息，包括姓名、身份证、手机号等。
15.9 Session覆盖——某电商网站可通过Session覆盖方式重置他人密码
有些服务器密码找回功能的服务端校验存在漏洞，攻击者使用密码找回链接重置密码
时可以通过Session覆盖的方式成功重置其他用户的密码。
某电商网站可通过Session覆盖方式重置他人密码案例如下。步骤一：使用自己的账
号进行密码找回，如图15-49所示。
图15-49 密码找回
步骤二：收到邮件后先不要打开链接，如图15-50所示。
图15-50 收到邮件
步骤三：在同一浏览器内打开网站再次进入密码找回页面，输入其他人的账号，如图
15-51所示。
图15-51 其他用户的身份验证界面
步骤四：单击发送“找回密码邮件”后停在该页面，如图15-52所示。
图15-52 发送邮件成功
步骤五：在同一浏览器中打开第二步中自己邮箱中收到的链接，然后设置一个新密
码，如图15-53所示。
图15-53 密码设置界面
步骤六：使用新设置的密码，成功登录进了其他人的账户，如图15-54所示。
图15-54 登录成功
15.10 防范密码找回漏洞的相关手段
（1）在密码找回功能设计时对用户凭证的验证次数和频率进行限制，防止攻击者对
用户凭证的暴力枚举攻击。
（2）对密码找回的各个环节进行梳理，记录分析所有交互数据，避免密码找回凭证
等敏感信息直接返回给客户端。
（3）对服务端密码重置Token的生成算法进行审计，避免使用容易被攻击者破解的
简单算法。
（4）密码重置凭证应与账户严格绑定，并设置有效时间，避免攻击者通过修改账户
ID的方式重置他人密码。
（5）对客户端传入的数据要进行严格的校验，手机号、邮箱地址等重要信息应和后
台数据库中已存储的信息进行核对，不应从客户端传入的参数中直接取用。避免攻击者通
过篡改传入数据的方式重置他人密码。
（6）对用户注册、手机邮箱绑定等业务逻辑进行审计，避免攻击者通过用户重复注
册和越权绑定等漏洞间接重置他人密码。
第16章 越权访问安全案例总结
16.1 平行越权
攻击者请求操作（增、删、查、改）某条数据时，Web  应用程序没有判断该数据的
所属人，或者在判断数据所属人时直接从用户提交的表单参数中获取（如用户ID），导
致攻击者可以自行修改参数（用户ID），操作不属于自己的数据，如图16-1所示。
图16-1 平行越权流程图
16.1.1 某高校教务系统用户可越权查看其他用户个人信息
某高校教务系统存在平行越权漏洞。通过测试发现，学号有规律可循，学号后4位是
连续的数字，普通用户登录系统后可越权查看其他学生的学籍信息、课程成绩等敏感信
息。
步骤一：以“高某某”学号为12xxxx0031为例，登录教务系统，并查看该账号的学籍信
息。查看学籍信息链接为 
http：//host/search.do？m=xsx&xh=12Sxxx0031，如图16-2所
示。
图16-2 查看学号为12xxxx0031的学生的学籍信息
步骤二：访问学号为 12Sxxx0032 的学生的学籍信息，链接为 http：//host/search.do？
m=xsx&xh=12Sxxx0032，如图16-3所示。
图16-3 越权查看其他学号（12xxxx0032）的学籍信息
步骤三：访问学号为 12Sxxx0033 的学生的学籍信息，链接为 http：//host/search.do？
m=xsx&xh=12Sxxx0033，如图16-4所示。
图16-4 越权查看学号12xxxx0033的学籍信息
16.1.2 某电商网站用户可越权查看或修改其他用户信息
某电商网站存在越权漏洞可任意进行读取或删除其他用户收货地址、订单信息等操
作。
步骤一：注册账号并登录，当前用户名为  april，UserID  为  460，添加收货地址并查
看“我的地址簿”，如图16-5所示。
图16-5 查看UserID为460的地址簿
步骤二：使用Burp  Suite抓包，修改cookie中的UserID为460，提交后服务器返回地址
信息，如图16-6所示。
图16-6 越权查看UserID为460的地址信息
步骤三：修改cookie中的UserID为360，提交后服务器返回地址信息，如图16-7所示。
图16-7 越权查看UserID为360的地址信息
步骤四：在前台下单并提交后，单击查看“我的订单”，如图16-8所示。
图16-8 单击“我的订单”查看订单详细信息
同时使用Burp Suite抓包发现用户ID为460，其订单详细信息如图16-9所示。