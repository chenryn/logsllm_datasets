===== 参数的重定义
在模型预览中，您可能发现某些参数位由于训练数据不足等各类原因，当前训练结果不如人意。您可以点击该参数位置详情中的"编辑"按钮，手动修改参数的名称、类型、可选值(枚举值或平均值标准差)等。
image::images/lynxee-logreduce-parameter-refine.png[]
一般而言，常见的参数重定义场景都集中在：ID、CODE 类数据。
===== 特殊参数处理
大多数情况下，计算机系统产生的日志都是类自然语言的英文文本。但不排除有部分软件，采取了特殊的日志输出方式。Lynxee 对下列两种情况，进行特殊的参数处理：
* 中文文本：系统将自动探测中文文本语句，并识别整条中文语句为 `` 参数。用户可以修改日志易 Manager 中 loganalyzer 模块的 `model.tokenizer.keep_chinese_content` 配置，默认为 false，即识别 `` 参数后，不关心参数位具体内容，当做模式内固定文本；修改为 true，则模式会按照普通文本参数来处理，识别其为枚举值或高基值，并按参数检测配置运行。
* 过长样本：loganalyzer 模块有 `model.tokenizer.max_log_sequence_payload_size` 和 `model.tokenizer.single_line` 两个配置，分别用于在训练和检测时，截取过长日志的有效部分，提高模型效果和速度。第一个参数，表示截取日志的前多少个分词，最大支持 1000 个。第二个参数，表示截取多行日志的第一行，常用于 exception 日志的检测。
==== 模式自定义操作
在模型预览列表上，可以进行模式的自定义操作，包括检索、合并、拆分、新建和编辑操作。
===== 模式合并
如果您对某个模式当前状态感觉过细，知道某部分固定文本其实属于可变参数。您可以点击模式右侧的"合并"按钮，打开合并操作浮层：
image::images/lynxee-logreduce-merge.png[]
在浮层的"蓝本模式"上，找到您准备定义为可变参数的位置，鼠标点击该处，参数会自动变成一个高亮的 `*` 。如果有多处需要修改，重复鼠标点击操作即可。
修改好蓝本模式上的参数以后，点击"匹配"按钮，系统将自动为您寻找当前模式集合中，还有哪些其他模式，符合您的新定义。在可匹配上的结果中，勾选您准备合并进来的其他模式，点击"合并"，系统就会为您合并这批模式成为一个新的模式。
===== 模式拆分
而如果您对某个模式当前状态感觉过粗，您可以点击模式右侧的"拆分"按钮，打开拆分操作浮层：
image::images/lynxee-logreduce-split.png[]
拆分操作目前不支持自定义拆分位置，系统会自动给您列出拆分结果，如果满意，点击"确定"即可。
模式的合并和拆分，本身不会影响模式异常检测的结果，但是模式变化会导致参数位变化，进而影响到原有的参数异常检测结果。所以，模式合并和拆分操作以后，必须在任务列表页上点击"重训练"操作，等待"训练完成"，才能对发生变化的模式中的参数位进行检测定义——未涉及合并拆分操作的其他模式，系统会自动运用过去的定义。
在未进行重新训练之前，您可以在任务列表上，看到明确的"(有新模型)"状态提示。此时，您点击"模型预览"，会发现无法点开模式的参数配置详情。此外，页面右上角，新出现"查看旧模型"的入口，您可以点击查看未变更之前的模型——也是目前依然还在运行中的模型。同样，旧模型预览页上，也无法进行任何参数配置、模型拆分合并操作。
image::images/lynxee-logreduce-oldview.png[]
===== 模式编辑/新建
如果用户对样本训练或合并操作所得模式不太满意，并且自己有明确已知的模式时，可以选择直接手动创建或编辑单个模式。
image::images/lynxee-logreduce-pattern-edit.png[]
手动填写的模式，默认情况下，只能进行模式异常检测，无法进行参数和占比异常检测。在该任务没有开始重新训练之前，也无法提供正确的占比和样例日志展示。如果需要参数检测，可以在模型预览中点选对应参数位置，手动定义参数类型、参数值范围等。
根据检测算法原理，过于宽泛的模式可能会掩盖掉原本能发现的异常。因此，请确认手动填写的模式能且只能包含您期望中的数据内容。
===== 模式检索
如果您正好发现一批日志值得重点关注，需要修改对应模式的级别、备注等配置时，可以通过模式检索功能，来快速查找日志对应的模式。
在模型预览页右上角，点击“检索模型”，打开模式检索页面。在检索文本框中输入日志，点击检索，页面下方即展示出对应的结果模式。
image::images/lynxee-logreduce-search.png[]
==== 模式的标注
当您对部分模式的含义十分了解时，为了将这个知识更好的传递给后续查看或接收告警的其他用户，您可以在模型预览列表上，标注该模式的含义。
模式的标注分为两部分：程度和备注。
点击模式列表对应行的"程度"列单元格，可以修改切换该模式的程度。将该模式从正常程度修改为低、中、高或严重，或从这几个异常等级修改为正常。由初始训练和增量训练得到的模式，默认都是正常模式。此外，Lynxee 默认每 10 分钟会对最新的异常历史尝试进行分组训练，训练得到的模式，默认都是异常模式。
点击模式列表对应行右侧的操作栏的备注链接，打开备注文案弹层，可以输入备注文案内容。系统会自动记录不同时间不同用户的备注修改历史，供用户参考：
image::images/lynxee-logreduce-label.png[]
=== 查看和标注异常历史
运行配置提交以后，模型即上线运行。检测产生的异常历史，会单独记录在系统中，供用户查看和操作。
异常历史默认记录在 `_log_anomaly` 内部索引中，用户也可以通过搜索查询的方式自行使用。`_log_anomaly` 索引的数据结构如下：
* ip: 仅当参数异常和模式异常时存在，即原始日志中的 hostname 字段值
* timestamp: 异常检测时间
* anomaly_id: 异常历史的唯一标识符
* anomaly_level_type: 异常等级
* job_name: 检测任务展示名称
* pct_type: 仅当占比异常时有值，可选值为："同比"和"环比"
* type: 异常类型，可选值为：pattern、cluster_percentage、parameter
* raw_message: 当参数异常和模式异常时，raw_message 为异常日志原文；当占比异常时，raw_message 为对应模式
* content: 关于异常的一些详细描述信息。不同类型的可用信息差异较大：
** 模式异常时，content 内只有 summary 文本比较有意义，同时用于发送告警消息
** 参数异常时，content 内除 summary 以外，还有 `similar_pattern` 记录了命中的模式，`cluster_id` 记录了命中的模式标识符，`parameter_type` 记录了参数类型。针对数值类型，还有 `mean`,`std` 字段，针对非数值类型，还有 `parameter_values` 字段等记录模型内参数信息
** 占比异常时，content 内除 summary 以外，还有 `pattern` 字段记录对应模式，`samples` 数组字段记录该异常时段内的样例日志原文，`new_count`,`old_count`,`new_percentage`,`old_percentage` 字段记录该异常时段及对比时段的占比和数据量。
==== 历史展示
在检测任务列表上，点击"查看异常"，进入异常历史页。异常历史页面顶部展示该检测任务的分类型异常事件数趋势图，左侧展示该检测任务当日的检测日志数量和异常日志数量，右下侧展示历史记录详情。用户可以在详情中通过下拉菜单快速过滤，以及完成对等级标记的批量修改和历史记录的批量删除等。
注意：由于任务模型可以变更，异常历史在检测时对应的模型不一定在查看时依然存在，异常等级的过滤下拉菜单中，专门有一个“未找到”，用来过滤已经不在当前模型中的过期模式对应的异常历史。
image::images/lynxee-logreduce-history.png[]
根据异常类型的不同，历史记录的展示也不相同。
* 实时模式异常： 在最近一次异常分组完成后的 10 分钟内，有新的模式异常产生时，异常历史页面上会实时提示新异常的出现，用户可以点击顶部提示条的"查看详情"，展开查看实时模式异常。实时异常会在下一次异常分组时，归入模式异常分组中。
* 异常分组：历史记录将自动按照模式进行聚合分组，分组以最后一条日志原文和时间为代表展示，组内按时间排序，组之间以各自最新一条异常历史的时间排序。可以点击模式分组右上角的查看按钮，在浮层里查看该模式的异常日志细节。
** 模式/参数异常：浮层包括模式、时间趋势图、异常日志列表和来源 IP 占比柱状图等部分。用户可以通过时间趋势图上划选缩放来过滤异常日志列表和来源 IP 的统计结果，也可以针对单条异常日志，点选查看来自相同模式或相同 IP 的其他异常：
+
image::images/lynxee-logreduce-history-cluster.png[]
+
** 占比异常：浮层包括模式、时间趋势图、异常信息和来源 IP 占比柱状图等部分。异常信息包括该时间段的数据量和占比变化情况：
+
image::images/lynxee-logreduce-history-perc.png[]