NinjaTV - Increasing Your 
Smart TV’s IQ Without 
Bricking It
Felix Leder
D
About Myself
• Passion: 
• Reverse Engineering (+ tool development)
• Being out in the snow, being out on a bike, being out in the water
• Fun Projects:
• Bug hunting in malware
• Botnet takeovers and countermeasure
• The Honeynet Project
• $$$ Job:
• Mobile Threat Research @ Blue Coat Norway
Credits
Western Digital TV (Live Hub)
Inside
Motivation to get other TV stations
Offline Analysis 1
Drive Investigation
• WDTVPriv partition
• Hauppauge TV app storage
• Spotify offline storage
• Last update pkg
• WDTVLiveHub
• Main media
• Swap
Offline Analysis 2
Updates
Update contents
felix@xxx:$ binwalk wdtvlivehub.bin
DECIMAL         HEX             DESCRIPTION
------------------------------------------------------------------------------------
-------------------------------
32              0x20            Squashfs filesystem, little endian, version 3.1, 
size: 94877984 bytes,  6913 inodes, blocksize: 131072 bytes, created: Tue Jul 16 
05:17:54 2013
felix@xxx:$ binwalk wdtvlivehub.bin
DECIMAL         HEX             DESCRIPTION
------------------------------------------------------------------------------------
-------------------------------
32              0x20            Squashfs filesystem, little endian, version 3.1, 
size: 94877984 bytes,  6913 inodes, blocksize: 131072 bytes, created: Tue Jul 16 
05:17:54 2013
00000000  63 34 32 63 35 34 61 63  32 66 38 33 34 32 66 66  |c42c54ac2f8342ff|
00000010  38 31 36 65 36 36 65 64  36 64 39 38 38 33 31 30  |816e66ed6d988310|
00000020  68 73 71 73 01 1b 00 00  00 00 00 00 00 00 00 00  |hsqs............|
00000030  00 00 00 00 00 00 00 00  00 00 00 00 03 00 01 00  |................|
00000040  00 00 11 00 e0 01 00 62  bb e4 51 b4 1b 06 08 01  |.......b..Q.....|
00000000  63 34 32 63 35 34 61 63  32 66 38 33 34 32 66 66  |c42c54ac2f8342ff|
00000010  38 31 36 65 36 36 65 64  36 64 39 38 38 33 31 30  |816e66ed6d988310|
00000020  68 73 71 73 01 1b 00 00  00 00 00 00 00 00 00 00  |hsqs............|
00000030  00 00 00 00 00 00 00 00  00 00 00 00 03 00 01 00  |................|
00000040  00 00 11 00 e0 01 00 62  bb e4 51 b4 1b 06 08 01  |.......b..Q.....|
Firmware signatures
wdtvlivehub.bin
wdtvlivehub.bi2
End Signature (16 bytes)
CE FA BE BA 
02 00 00 00
Image I size (little endian)
00 00 00 00
Image I
root Squashfs 3.1 image
Start Signature (32 bytes)
MD5 of Image I 
+ end signature
End Signature (32 bytes)
MD5 of Image I 
+ end signature
Image II
/opt Squashfs 3.1 image
Signature
MD5 of Image II
+ end signature
Update contents 2
Wdtvlivehub.bin
Wdtvlivehub.bi2
• /opt mounted
Which way in?
Vulnerability Finding
Vulnerability finding
SQL injection – here we come
0“; ATTACH DATABASE ‘lol.php’ AS lol; 
CREATE TABLE lol.pwn (dataz text); 
INSERT INTO lol.pwn (dataz) VALUES (‘’;--
0“; ATTACH DATABASE ‘lol.php’ AS lol; 
CREATE TABLE lol.pwn (dataz text); 
INSERT INTO lol.pwn (dataz) VALUES (‘’;--
Vulnerability finding
RFI – remote file inclusion
E
Where to place my PHP shell?
Investigating more files:
• /tmp/media/usb/Local/WDTV
LiveHub/ is root of SMB share
• So my videos are in
/tmp/media/usb/Local/WDTV
LiveHub/Videos/
M
That was only the beginning…
 Webserver running as root = w00t
O
Must remember low hanging fruits…
/opt/webserver/htdocs # ls -l
…
-rw-rw-r--
1 1007     1007         1685 Jun 24  2013 system_password.php
-rw-rw-r--
1 1007     1007          142 Jun 24  2013 test.php
drwxrwxr-x    3 1007     1007           21 Jul 16  2013 tmp
lrwxrwxrwx    1 1007     1007           32 Dec 12 08:15 user -> /tmp/media/usb/Local/WDTVLiveHub
drwxrwxr-x    8 1007     1007          298 Jul 16  2013 wd_nas
drwxrwxr-x    3 1007     1007           23 Jul 16  2013 wdtvlivehub
drwxrwxr-x    2 1007     1007          102 Jul 16  2013 whatson
Approach for HW hackers
Looking for interesting pins
D
Booting up
End of boot
41fa4f6ac0b8ebdefb89d443cb6c5ece login:
• What is the password?
Reverse Engineering the boot process
(parts of it)
• Password is set by a tool called 
gbus_read_serial_num
• Located in /usr/local/sbin
(encrypted file system image)
• Original: /home/file AES encrypted
• AES key to mount this image retrieved
from ROM during boot
• Not visible in raw update bins
gbus_read_bin_to_file 0x61d00 0x280 /tmp/xosinfo && genxenv2 g /tmp/xosinfo bc01 \
| sed 's/.*.bc01\(.*\)/\1/g' | sed 's/\ //g' > /tmp/log1 2>&1
echo `cat /tmp/log1` | mymount /home/file /usr/local/sbin -oencryption=aes -p 0
Visual
AES Key
What’s the root password?
• RE gbus_read_serial_num
echo $SERIALNUMBER | md5sum
41fa4f6ac0b8ebdefb89d443cb6c5ece login: root
Password: 
BusyBox v1.10.0 (2013-06-21 20:40:53 CST) built-in shell 
(ash)
Enter 'help' for a list of built-in commands.
#
E
Where are the Apps?
Many traces on disk
• Logos for all services
• Libraries and DRM files for some
• Spotify
• Netflix
• …
• NO Apps for e.g. 
redbull.tv, AOL, Bild.de
DMAOSD – the heart of WD TV
• Last process started
• System automatically reboots after process dies (e.g. is killed)
• Located in the encrypted partition
• Uses 75% of available RAM
Services
M
Service details
• On first connection WD TV uses GeoIP to determine country
• Some services are country specific (e.g. bild.de, ivi.ru)
• Pure web-pages
• Others use pipes to connect to local binaries/libraries (e.g. spotify)
• Crazy jump tables and if- statements
O
Dmaosd – all in one
• 13 MB (huuge executable for MIPS – even for x86)
• Everything statically linked in
• QT webbrowser to access the web “services”
• Libraries for HDMI and codec chips
• Auto-mounts attached USB sticks, built-in harddrive
• Controls network shares
• Update daemon
• Renderer for XML based menus
• Loads all resources (templates, pictures, …) into it’s process space
Debugging Dmaosd live – get GDB up
Step 1: GDBServer on device
• Compile chain for MIPS  create GDBServer
• http://www.mentor.com/embedded-software/sourcery-tools/sourcery-
codebench/overview/
• LSB, software floating point, shared libraries
(COMPILKIND=glibc,softfloat mipsel-linux-gcc -o test.mips test.c)
• Copy GDBServer executable on device
Debugging Dmaosd– attach IDA Pro
• IDA Pro for remote debugging 
(alternatively MIPS gdb)
• Very sensitive / unreliable
• Don’t be fooled by pipelining in assembly
• You cannot break much ☺
(more on that later)
This is executed
D
Tatort
How to get my own services on the box?
Broadcaster “Das Erste” live stream
Browser – lowest hanging fruit
• QT embedded browser started
• Run – time patch the urls
• Windows: OpenProcess, WriteProcessMemory
• Linux: ptrace
• PTRACE_ATTACH to process
• PTRACE_PEEKDATA to search
• PTRACE_POKEDATA to overwrite (in place – size limit)
http://www.redbull.tv
http://www.cnn.com
D
Supported (HW) codecs?
TV station codec has to fit
NPPVpluginDescriptionString The Totem 0.10.2 plugin handles video and 
audio streams
NP_GetMIMEDescription = application/acetrax:mp4, wmv, mp3:video/x-ms-
wmv;video/wmv:wmv:video/wmv;video/x-ms-asf:wmv:video/x-ms-
asf;application/maxdome:mp4, wmv, mp3:video/x-ms-
wmv;video/wmv:wmv:video/wmv;video/x-ms-asf:wmv:video/x-ms-asf;application/sigma:mp4, 
wmv, mp3:video/x-ms-
wmv;audio/mp3:mp3:audio/mp3;video/mp4:mp4:video/mp4;audio/mpeg:mpg:audio/mpeg;vid
eo/wmv:wmv:video/wmv;video/mpeg4:mp4:video/mpeg4;video/x-flv:flv,f4v:video/x-
flv;application/x-mpegurl:m3u8:vnd.apple.mpegurl;audio/x-
wav:wav:audio/wav;video/mp2t:ts:video/mp2t;application/x-netcast-
av::;application/yotavideo:mp4, wmv, mp3:video/x-ms-
wmv;video/wmv:wmv:video/wmv;video/x-ms-asf:wmv:video/x-ms-asf;video/vnd.ms-
playready.media.pyv:pyv:video/vnd.ms-playready.media.pyv;application/nowtilus:mp4, 
wmv:video/x-ms-wmv;video/mpeg4:mp4:video/mpeg4
NPPVpluginDescriptionString The Totem 0.10.2 plugin handles video and 
audio streams
NP_GetMIMEDescription = application/acetrax:mp4, wmv, mp3:video/x-ms-
wmv;video/wmv:wmv:video/wmv;video/x-ms-asf:wmv:video/x-ms-
asf;application/maxdome:mp4, wmv, mp3:video/x-ms-
wmv;video/wmv:wmv:video/wmv;video/x-ms-asf:wmv:video/x-ms-asf;application/sigma:mp4, 
wmv, mp3:video/x-ms-
wmv;audio/mp3:mp3:audio/mp3;video/mp4:mp4:video/mp4;audio/mpeg:mpg:audio/mpeg;vid
eo/wmv:wmv:video/wmv;video/mpeg4:mp4:video/mpeg4;video/x-flv:flv,f4v:video/x-
flv;application/x-mpegurl:m3u8:vnd.apple.mpegurl;audio/x-
wav:wav:audio/wav;video/mp2t:ts:video/mp2t;application/x-netcast-
av::;application/yotavideo:mp4, wmv, mp3:video/x-ms-
wmv;video/wmv:wmv:video/wmv;video/x-ms-asf:wmv:video/x-ms-asf;video/vnd.ms-
playready.media.pyv:pyv:video/vnd.ms-playready.media.pyv;application/nowtilus:mp4, 
wmv:video/x-ms-wmv;video/mpeg4:mp4:video/mpeg4
Finally ☺
O
Root but not 0wnd
ROM filesystem
root but not 0wnd by me
# mount
...
/dev/sigmblockh on / type squashfs (ro)  root
...
none on /tmp type tmpfs (rw)
/dev/sigmblocki on /opt type squashfs (ro)
/dev/loop0 on /tmp/static_config type minix (rw)
/dev/loop1 on /usr/local/sbin type romfs (ro)
tmpfs on /opt/webserver/logs type tmpfs (rw)
none on /lib/sigma type ramfs (rw)
/dev/sda3 on /tmp/media/usb/Local/WDTVLiveHub type ufsd (rw,nls=utf8,uid=0,gid=0,fmask=0,...)
# mount
...
/dev/sigmblockh on / type squashfs (ro)  root
...
none on /tmp type tmpfs (rw)
/dev/sigmblocki on /opt type squashfs (ro)
/dev/loop0 on /tmp/static_config type minix (rw)
/dev/loop1 on /usr/local/sbin type romfs (ro)
tmpfs on /opt/webserver/logs type tmpfs (rw)
none on /lib/sigma type ramfs (rw)
/dev/sda3 on /tmp/media/usb/Local/WDTVLiveHub type ufsd (rw,nls=utf8,uid=0,gid=0,fmask=0,...)
• All persistent file systems are read-only (from ROM)
• All dynamic parts are copied over to /tmp
(including shadow, hosts, …)
• Fresh reset after reboot
Root FS
(ROM)
Root FS
(ROM)
/tmp
(RAM)
/tmp
(RAM)
Copy
Copy
Persistence
… without the risk of bricking it
Patch firmware conservatively
Want to avoid bricking
• Use clean reset scheme
• Place other tools where they can be removed externally - harddrive
(just in case)
• Don’t patch the main image  has several integrity checks
(good conditions to run into problems)
• … patch as little as possible
/init
/init
/bin/run_all
/bin/run_all
/bin/dmaosd.sh
/bin/dmaosd.sh
/opt/qt/bin/run_qt
Challenge: Mount order
• Dmaosd is last process started
• Mounts the hard drive
• Race condition: No dmaosd if run_qt blocks  no hard drive  block
• Solution:
1.
Return control and continue as background process
2.
Wait for hard drive to be mounted
3.
Continue booting there
/init
/bin/run_all
/bin/dmaosd.sh
/opt/qt/bin/run_qt &
Where are the lawyers?
GPL? Linux? …
GPL Firmware
• Available but …
• will lose all DRM keys 
• Potentially WD keys
• … I haven’t tried what is lost
http://support.wd.com/product/download.asp?groupid=1010&sid=134&lang=en
Where is the security?
Conspiracy Theory
• Why is WD basically leaving the device open?
Outlook
My situation
Your options
Questions?