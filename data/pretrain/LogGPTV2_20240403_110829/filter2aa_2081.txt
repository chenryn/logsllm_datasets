KCon 
KCon 
重现速8僵尸车队 
蓝牙4.0 BLE协议的进攻 
    杨 晋 
    ThreatBook 
    曾仸职于 Microsoft，COMODO，Qihoo360 
    邮箱：PI:EMAIL 
    Linkedin：Jin Yang 
PART 01    BLE是什么？ 
PART 02    协议技术特点 
PART 03    寻找身边的设备 
PART 04    如何嗅探BLE协议数据 
PART 05    协议分析与攻击方式 
目录 
CONTENTS 
01 BLE是什么？  
BLE是什么？ 
- Bluetooth 4.0 协议家族 （2012） 
-   经典蓝牙 （Classic Bluetooth） 
-   高速蓝牙  
-   低功耗蓝牙 （Bluetooth Low Energy） 
BLE是什么？ 
- BLE VS 经典蓝牙 
技术规范 
BLE 
经典蓝牙 
频率 
2.4GHz 
2.4GHz 
作用距离 
100m 
10m 
响应延时 
1-3ms 
100ms 
安全性 
128-bit AES 
64/128-bit 
能耗 
1-50% 
100% 
传输数据速率 
1Mb/s 
1-3Mb/s 
BLE是什么？ 
- 哪些设备在使用BLE协议？ 
-   可穿戴设备：智能手表、手环、无线耳机、鼠标/键盘 
-   家庭用智能设备：门锁、智能玩具、音箱 
-   特种行业内设备：医疗器械、汽车、自动化 
02 协议技术特点 
协议技术特点 
BLE协议栈 
APP 
HOST 
CONTROLLER 
协议技术特点 
控制器部分 
（Controller） 
物理层 
（Physical Layer） 
链路层 
（Link Layer） 
主机控制接口层 
（Host Controller Interface） 
主机 
（Host） 
GATT 通用属性配置文件层 
（Generic Attribute Profile） 
GAP 通用访问配置文件层 
（Generic Access Profile） 
L2CAP 逻辑链路控制及自适应协议层 
（Logical Link Control and Adaptation Protocol） 
安全管理层（Security Manager） 
ATT 属性协议层（Attribute Protocol） 
协议技术特点 
- 物理层特性： 
-   免费的ISM频段：2.400 - 2.4835 GHz 
-   分为40个频段：0 – 39 （每仹的带宽为2MHz） 
-   跳频通信 （Hopping） 
协议技术特点 
- 广播频段与数据频段 
-    3 channels：37 38 39 
-    37 channels：0 – 36 
-    广播频段跳频与数据频段跳频 
协议技术特点 
频率 
频段类型 
数据频道编号 
广播频道编号 
2402MHz 
广播 
37 
2404MHz 
数据 
0 
… 
数据 
… 
2424MHz 
数据 
10 
2426MHz 
广播 
38 
2428MHz 
数据 
11 
… 
数据 
… 
2478MHz 
数据 
36 
2480MHz 
广播 
39 
协议技术特点 
当发生ADV_CONNECT_REQ后，确定了 
Hop Increment = 0x0C 
Data Channel 12 
Data Channel 24 
Data Channel 36 
Data Channel 11 
Data Channel 23 
Data Channel 35 
Data Channel 10 
03 寻找身边的设备 
寻找身边的设备 
- 最简单的方法 iPhone （LightBlue、BLE Finder …） 
寻找身边的设备 
- 利用 nRF51822 芯片来寻找 
寻找身边的设备 
- 大概判断一个设备的距离 
04 如何嗅探BLE协议数据 
如何嗅探BLE协议数据 
- 嗅探 广播频道数据 
- 嗅探 数据频道数据 
- 处理跳频 
- 4种嗅探BLE协议数据的设备 
如何嗅探BLE协议数据 
-  Ubertooth One （2011） 
-  Ubertooth 是著名无线硬件黑客 Michael Ossmann 研发
的一个基于2.4GHz的开源无线蓝牙开发平台，共有两个版本
分别是 Ubrtooth-One 和 Ubertooth-Zero ，而 Zero 版本
已经停止开发，很多的最新功能以及平台已经无法支持 Zero 
-  Ubertooth + Wireshark + Kismet + Crackle 
如何嗅探BLE协议数据 
-  Ubertooth 负责嗅探BLE协议数据并存储 
-  Wireshark + Kismet 分析BLE报文 
-  Crackle 在获取到一定数量的BLE报文之后，就可以用
它来破解出 STK/LTK 
    https://github.com/mikeryan/crackle 
如何嗅探BLE协议数据 
Ubertooth One 
如何嗅探BLE协议数据 
-  HackRF SDR，8 bit 
-   Michael Ossmann 和 Jared Boone 一起研发的一款廉价且功能
丰富的SDR硬件 
-   支持GNURadio的全开源SDR，工作频率 10MHz - 6GHz 
-   USB 2.0 
-   btle_rx btle_tx (https://github.com/JiaoXianjun/BTLE) 
如何嗅探BLE协议数据 
如何嗅探BLE协议数据 
-  BladeRF SDR，12 bit 
-   工作频率：300 MHz – 3.8 GHz 
-   全双工的一款神器 
-   USB 3.0 
-   btle_rx btle_tx (https://github.com/JiaoXianjun/BTLE) 
如何嗅探BLE协议数据 
如何嗅探BLE协议数据 
- nRF51822芯片 CC2540芯片 
-  这些产品实际上是智能设备使用的芯片，但是也可以做
BLE Sniffer来使用 
-  功能单一只支持蓝牙BLE协议 
-  价格便宜 
如何嗅探BLE协议数据 
如何嗅探BLE协议数据 
Ubertooth 
HackRF 
BladeRF 
nRF51822 
工作频率 
2.4G 
10 MHz - 
6GHz 
300 MHz - 
3.8GHz 
BLE 2.4G 
工作方式 
半双工 
半双工 
全双工 
半双工 
接口 
USB 2.0 
USB 2.0 
USB 3.0 
USB 2.0 
应用范围 
蓝牙 
SDR 
SDR 
蓝牙BLE 
开源资源 
全开源 
全开源 
部分 
部分 
价格 
1000 
2000 
2800 
100 
05 协议分析与攻击方式 
BLE协议分析 
- BLE报文结构 
- 字节序：大多数多字节域是从低字节开始传输的 
- 比特序：各个字节传输时，每个字节都是从低位开始  
BLE协议分析 
- 报头包含4bit广播报文类型、2bit保留位、1bit发送地
址类型和1bit接收地址类型 
BLE协议分析 
- BLE广播报文7种类型 
-  ADV_IND 
-  SCAN_REQ 
-  SCAN_RSP 
-  CONNECT_REQ 
BLE协议分析 
-  BLE数据包的CRC验证公式 
-  广播包最关键的：Access Address 0x8E89BED6 
BLE协议连接/通信流程 
-  Slave 37>38>39> ADV_IND 
-  Master > SCAN_REQ 
-  Slave > SCAN_RSP 
-  Master > CONNECT_REQ 
-  Master >data> Slave (Hopping 0-36) 
-  Slave >data> Master (Hopping 0-36) 
-  Master >LL_Terminate_Ind or 异常断开 
广播包 
ADV_IND 38 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
广播包固定的
Access Address 
0x8e89bed6 
广播设备地址 
71:1a:32:a3:90:90 
广播包含扫描请求 
SCAN_REQ 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
扫描设备地址 
71:1a:32:a3:90:90 
广播设备地址 
d0:5f:45:68:ef:bd 
包长度 12 
扫描响应 
SCAN_RSP 
随机地址 
71:1a:32:a3:90:90 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
CONNECT_REQ 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
内容 
XXXXXXXXXXXXX
XXXXXXXXXXXXX
XXXXXXXX 
Hopping Interval 
InitAddress 
AdvAddress 
BLE协议分析 
-  数据报文分析 Data Type: Empty PDU  
 报文序号，长度，数据内容，CRC，信号增益 
BLE协议分析 
-  数据报文分析 Data Type: L2CAP  
Logical Link Control and Adaptation Protocol 
逻辑链路控制及自适应协议层协议 
攻击方式 
-   被动嗅探，窃取BLE协议内的数据 
-   重放攻击，冒名顶替，未授权的访问 
-   中间人攻击，跨越BLE的通信距离，篡改数据 
中间人攻击 
正常方式连接：Phone MS BleCar 
中间人攻击：Phone MS1 代理 M1S BleCar 
代理端在中转数据的时候，可以修改其中的数据内容 
演示 - 速度与激情8的僵尸车队 
Thank you! 
Thank you!