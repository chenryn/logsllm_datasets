给proxy1.cache1.com。
代理1
图20-10 代理自动配置
486 ｜ 第20章
PAC协议是相当强大的：JavaScript程序可以请求浏览器根据大量与主机名相关的
参数来选择代理，比如DNS地址和子网，甚至星期几或具体时间。只要服务器中的
PAC文件保持更新，能反映代理位置的变化，PAC就允许浏览器根据网络结构的变
化自动与合适的代理进行联系。PAC存在的主要问题是必须要对浏览器进行配置，
让它知道要从哪个服务器获取PAC文件，因此它就是一个全自动配置的系统。下一
节讨论的WPAD解决了这个问题。
就像那些预配置浏览器一样，现在一些主要的ISP都在使用PAC。
20.5.3 Web代理自动发现协议
WPAD（Web代理自动发现协议）的目标是在不要求终端用户手工配置代理设置，
而且不依赖透明流量拦截的情况下，为Web浏览器提供一种发现并使用附近代理的 464
方式。由于可供选择的发现协议有很多，而且不同浏览器的代理使用配置也存在差
异，因此定义Web代理自动发现协议时，普通的问题会被复杂化。
本节包含了一个经过缩略，且重新组织过的WPAD因特网草案版本。现在，这个草
案是作为IETF的Web中间人工作组的一部分开发的。
1. PAC文件自动发现
WPAD允许HTTP客户端定位一个PAC文件，并使用这个PAC文件找到适当的代
理服务器的名字。WPAD不能直接确定代理服务器的名字，因为这样就无法使用
PAC文件提供的附加功能了（负载均衡，请求路由到一组服务器上去，故障时自动
转移到备用代理服务器等）。
如图20-11所示，WPAD协议发现了PAC文件URL，这个URL也被称为配置URL
（CURL）。PAC文件执行了一个JavaScript程序，这个程序会返回合适的代理服务
器地址。
实现WPAD协议的HTTP客户端：
• 用WPAD找到PAC文件的CURL；
• 根据这个CURL获取PAC文件（又名配置文件或CFILE）；
• 执行PAC文件来确定代理服务器；
• 向PAC文件返回的那个代理服务器发送HTTP请求。
重定向与负载均衡 ｜ 487
（b）获取PAC文件
因特网
PAC服务器 代理 原始服务器
（a）W PAD （c）通过代理
发现 访问服务器
HTTP客户端
图20-11 WPAD确定了PAC URL，这个PAC文件确定了代理服务器
2. WPAD算法
WPAD使用了一系列资源发现技术来确定适当的PAC文件CURL。并不是所有的
465 组织都可以使用所有技术的，所以WPAD指定了多种发现技术。在成功获得CURL
之前，WPAD客户端会一个个地尝试每种技术。
当前的WPAD规范按序定义了下列技术：
• DHCP（动态主机配置协议）；
• SLP（服务定位协议）；
• DNS知名主机名；
• DNS SRV记录；
• DNS TXT记录中提供的服务URL。
在这5种机制中，要求WPAD客户端必须支持DHCP和DNS知名主机名技术。我
们会在后继小节中提供更多的细节。
WPAD客户端会按顺序用上面提供的发现机制发送一系列资源发现请求。客户端只
会尝试它们所支持的机制。只要某次发现尝试成功了，客户端就会用得到的信息来
构建PAC CURL。
如果从那个CURL上成功获取到PAC文件，这个过程就结束了。如果没有，客户
端就从它在预定义的资源发现请求系列里中断的地方开始恢复。如果尝试了所有的
发现机制之后，都没有获取到PAC文件，WPAD协议就失败了，客户端会配置为
不使用代理服务器。
客户端首先会尝试DHCP，然后是SLP。如果没有获取到PAC文件，客户端会继续
488 ｜ 第20章
执行那些基于DNS的机制。
客户端会在DNS SRV、知名主机名和DNS TXT记录等方法中循环多次。每次都使
DNS查询的QNAME变得越来越不具体。通过这种方式，客户端就可以定位出尽可
能具体的配置信息，但也可能会转而使用一些不太具体的信息。每次DNS查找都会
在QNAME前加上wpad，用以说明请求的资源类型。
考虑主机名为 johns-desktop.development.foo.com 的客户端。下面是一个完整的
WPAD客户端会执行的发现尝试顺序：
• DHCP；
• SLP；
• 用QNAME=wpad.development.foo.com进行DNS A查找；
• 用QNAME=wpad.development.foo.com进行DNS SRV查找；
• 用QNAME=wpad.development.foo.com进行DNS TXT查找；
• 用QNAME=wpad.foo.com进行DNS A查找；
• 用QNAME=wpad.foo.com进行DNS SRV查找；
• 用QNAME=wpad.foo.com进行DNS TXT查找。 466
说明整个操作过程的详细伪代码请参见WPAD规范。后面的小节将讨论两种必备
机制——DHCP和DNS A查找。有关CURL发现方法的其他详细内容参见WPAD
规范。
3. 用DHCP进行CURL发现
要使用这种机制，就必须将CURL存储在WPAD客户端可以查询的DHCP服务器
上。WPAD客户端可以通过向DHCP服务器发送DHCP查询来获取CURL。（如果
DHCP服务器中配置了这种信息，）就可以在DHCP可选代码252中获取CURL。
所有WPAD客户端实现都必须支持DHCP。RFC 2131详细介绍了DHCP协议。现
存的DHCP选项列表参见RFC 2132。
如果WPAD客户端已经在其初始化过程中执行了DHCP查询，DHCP服务器可
能就已经提供了那个值。如果无法通过客户端OS API获得这个值，客户端就向
DHCP服务器发送一条DHCPINFORM报文，以获取这个值。
WPAD的DHCP可选代码252为STRING类型，可以是任意长度。这个字符串中
包含了一个指向适当PAC文件的URL。比如：
"http://server.domain/proxyconfig.pac"
重定向与负载均衡 ｜ 489
4. DNS A记录查找
要让这种机制工作，就必须将合适的代理服务器的IP地址存储在WPAD客户端可
以查询的DNS服务器上。WPAD客户端会向DNS服务器发送一个A记录查询，以
获取CURL。成功查询的结果中会包含合适的代理服务器的IP地址。
WPAD客户端实现必须支持这种机制。这应该是很简单的，因为它只要求基本的
DNS A记录查找。用知名DNS别名进行资源发现的详细过程请参见RFC 2219。对
WPAD来说，规范使用了“wpad”的“知名别名”来进行Web代理自动发现。
客户端执行了下列DNS查找：
QNAME=wpad.TGTDOM., QCLASS=IN, QTYPE=A
成功的查找中包含了IP地址，WPAD客户端根据这个地址构建CURL。
5. 获取PAC文件
只要创建了候选的CURL，WPAD客户端通常都会向CURL发送一条GET请求。
发出请求时，WPAD客户端必须要发送一些带有适当CFILE格式信息的Accept首
467 部，这些CFILE格式都是它们所能处理的。比如：
Accept: application/x-ns-proxy-autoconfig
而且，如果CURL的结果是要进行重定向，客户端就必须跟随这些重定向到其最终
目的地。
6. 何时执行WPAD
至少要在出现以下情况的时候进行Web代理自动发现。
• 在Web客户端启动的时候——WPAD只在第一个实例启动的时候执行。后面的
实例会继承这种设置。
• 只要有来自网络栈的通知，就说明客户端主机的IP地址改变了。
哪个选项在其环境中有意义，Web客户端就可以选择哪个。而且，客户端还必须根
据HTTP的过期时间，为之前下载的PAC文件的过期时间尝试一个发现周期。PAC
文件过期时，客户端遵循过期时间，重新运行WPAD过程是很重要的。
如果PAC文件没有提供替换方案，在当前配置的代理失效的情况下，客户端还可以
选择重新运行WPAD过程。
只要客户端决定使当前的PAC文件失效，就必须重新运行整个WPAD协议，以确
490 ｜ 第20章
保它会发现当前正确的CURL。具体来说，就是协议不能有条件地获取PAC文件的
If-Modified-Since。
WPAD协议广播与/或多播通信可能需要大量的网络环回时间。WPAD协议的激活
频率不应该高于上面指定的频率（比如在每次获取URL时进行一次）。
7. WPAD欺骗
WPAD的IE 5实现允许Web客户端在没有用户干预的情况下，自动检测代理设
置。WPAD使用的算法会在全称域名前加上主机名“wpad”，并会逐渐删除子域
名，直到它找到能够响应主机名的WPAD服务器，或到达第三级域名。比如，域
a.b.microsoft.com中的Web客户端会先查询wpad.a.b.microsoft、wpad.b.microsoft.
com，然后再查询wpad.microsoft.com。
这样会暴露出一个安全漏洞，因为在国际应用（及其他特定的配置）中，第三级域
名可能是不可信的。恶意用户可以建立一个WPAD服务器，并提供他选中的代理配
置命令。后继（5.01及以后）的IE版本修正了这个问题。
8. 超时
WPAD会经过多个级别的发现，客户端必须确保每个阶段都有时限保证。可能的情
况下，将每个阶段都限制在10秒以内是比较合理的，但实现者可能会选择其他更适 468
合其网络特性的值。比如，运行在无线网络上的设备实现，由于带宽较低或时延较
长，可能就会使用更大的时限。
9. 管理者的考虑
管理者至少应该在其环境中配置DHCP或DNS A记录查找方式中的一种，因为只
有这两种方式是所有兼容客户端都必须实现的。除此之外，通过配置环境使其支持
搜索列表中顺序靠前的机制，可以缩短客户端的启动时间。
使用这种协议结构的主要动力之一是支持客户端定位附近的代理服务器。在很多环
境中，都会有多个代理服务器（工作组、公司网关、ISP、骨干网等）。
在WPAD框架结构中，可以在很多地方确定代理服务器是否“邻近”。
• 不同子网的DHCP服务器会返回不同的答案。还可以根据客户端的cipaddr字
段或客户端标识符选项作出决定。
• 可以对DNS服务器进行配置，使其为不同的域名后缀（比如，QNAME wpad.
marketing.bigcorp.com 和 wpad.development.bigcorp.com）返回不同的 SRV/A/
TXT资源记录（RR）。
重定向与负载均衡 ｜ 491
• 处理CURL请求的Web服务器会根据User-Agent首部、Accept首部、客户
端IP地址/子网/主机名、附近代理服务器的拓扑分布等作出决定。可能由处理
CURL的CGI可执行文件进行这种处理。如前所述，甚至可能是某个处理CURL
请求的代理服务器来作出这些决定。
• PAC文件的表达能力可能足以在客户端运行时从一组候选的代理服务器中进行选
择。CARP就是在此基础上实现缓存阵列的。PAC文件可以计算出到一组候选代
理服务器的网络距离（或其他合理的度量方式），并选择“最近”或“响应最积极”
的服务器，这并不是什么不可思议的事情。
20.6 缓存重定向方法
我们已经讨论过一些将流量重定向到通用服务器的技术，以及一些将流量导向代理
或网关的专用技术了。这一节会介绍一些更复杂的、用于缓存代理服务器的重定向
技术。这些技术要尽量做到可靠、高效且能感知内容——这样可以将请求分配到可
469 能包含特定内容的位置上去，因此比前面讨论过的那些协议更复杂。
WCCP重定向
Cisco系统公司开发的WCCP可以使路由器将Web流量重定向到代理缓存中去。
WCCP负责路由器和缓存服务器之间的通信，这样路由器就可以对缓存进行验证
（确保它们已启动且正在运行），在缓存之间进行负载均衡，并将特定类型的流量发
送给特定的缓存了。WCCP版本2（WCCP2）是个开放的协议。这里我们会探讨
WCCP2。
1. WCCP重定向是怎样工作的
下面是WCCP重定向在HTTP上工作过程的概述（WCCP对其他协议的重定向过程
也是类似的）。
• 启动包含了一些支持WCCP的路由器和缓存的网络，这些路由器和缓存之间可
以相互通信。
• 一组路由器及其目标缓存构成一个WCCP服务组。服务组的配置说明了要将何
种流量发往何处、流量是如何发送的以及如何在服务组的缓存之间进行负载均衡。
• 如果服务组配置为重定向HTTP流量，服务组中的路由器就会将HTTP请求发送
给服务组中的缓存。
• HTTP请求抵达服务组中的路由器时，路由器会（根据对请求IP地址的散列，或
者“掩码/值”的配对策略）选择服务组中的某个缓存为请求提供服务。
492 ｜ 第20章
• 路由器向缓存发送请求分组，可以用缓存的IP地址来封装分组，也可以通过IP
MAC转发来实现。
• 如果缓存无法为请求提供服务，就将分组返回给路由器进行普通的转发。
• 服务组中的成员会互相交换心跳报文，不断验证对方的可用性。
2. WCCP2报文
WCCP2报文有4种，如表20-4所示。
表20-4 WCCP2报文
报 文 名 发 送 者 所承载的信息
WCCP2_HERE_I_AM 从缓存发送给路由器 这些报文告诉路由器，缓存可以接收流量。
报文中包含了该缓存的服务组的所有信息。
只要有缓存加入了服务组，它就会将这些报
文发送给组里所有的路由器。可以通过这些
报文与发送WCCP2_I_SEE_YOU报文的路
由器进行沟通
WCCP2_I_SEE_YOU 从路由器发送给缓存 这些报文是对WCCP2_HERE_I_AM报文的
响应。可以通过这些报文对分组转发方式、
分配方法（哪个是指定的缓存）、分组返回
方法和安全性进行沟通 470
WCCP2_REDIRECT_ASSIGN 从指定的缓存发送给路 这些报文为负载均衡分配任务，它们可以为
由器 散列表负载均衡发送桶信息，或为“掩码/
值”负载均衡发送“掩码/值”组对信息
WCCP2_REMOVAL_QUERY 从路由器发送给在2.5× 如果路由器没有周期性地收到WCCP2_