### 20.5.2 代理自动配置（PAC）

**图20-10 代理自动配置**

PAC（Proxy Auto-Configuration）协议非常强大，它允许通过JavaScript程序来决定浏览器应使用的代理服务器。该程序可以基于多种参数进行决策，包括主机名、DNS地址、子网，甚至是日期或时间。只要PAC文件保持更新以反映代理位置的变化，PAC就能使浏览器根据网络结构的变化自动选择合适的代理。

PAC的主要缺点是需要手动配置浏览器以获取PAC文件的位置。下一节将讨论的WPAD解决了这个问题。

目前，许多主要的ISP都使用PAC来预配置用户的浏览器设置。

### 20.5.3 Web代理自动发现协议（WPAD）

WPAD的目标是在不需用户手动配置的情况下，为Web浏览器提供一种自动发现并使用附近代理的方法。由于存在多种发现协议和不同浏览器的代理配置差异，定义WPAD时面临一些复杂问题。

#### 1. PAC文件自动发现

WPAD允许HTTP客户端定位一个PAC文件，并使用该文件找到适当的代理服务器。WPAD不能直接确定代理服务器的名字，因为这样会失去PAC文件提供的额外功能，如负载均衡、请求路由到一组服务器上以及故障时自动切换到备用代理服务器等。

**图20-11 WPAD确定了PAC URL，这个PAC文件确定了代理服务器**

实现WPAD协议的HTTP客户端执行以下步骤：
- 使用WPAD找到PAC文件的CURL；
- 根据CURL获取PAC文件（即配置文件或CFILE）；
- 执行PAC文件以确定代理服务器；
- 向PAC文件返回的代理服务器发送HTTP请求。

#### 2. WPAD算法

WPAD使用一系列资源发现技术来确定适当的PAC文件CURL。WPAD规范定义了以下技术：
- DHCP（动态主机配置协议）；
- SLP（服务定位协议）；
- DNS知名主机名；
- DNS SRV记录；
- DNS TXT记录中的服务URL。

WPAD客户端必须支持DHCP和DNS知名主机名技术。客户端按顺序尝试每种技术，直到成功获取CURL。如果所有尝试均失败，则客户端将配置为不使用代理服务器。

#### 3. 用DHCP进行CURL发现

要使用这种机制，必须将CURL存储在WPAD客户端可以查询的DHCP服务器上。WPAD客户端通过向DHCP服务器发送查询来获取CURL。如果客户端已经进行了DHCP查询，但未获得CURL，可以发送DHCPINFORM报文重新获取。

WPAD的DHCP可选代码252为STRING类型，包含指向适当PAC文件的URL，例如：
```
"http://server.domain/proxyconfig.pac"
```

#### 4. DNS A记录查找

为了使这种机制工作，必须将适当的代理服务器的IP地址存储在WPAD客户端可以查询的DNS服务器上。WPAD客户端向DNS服务器发送A记录查询，获取CURL。成功的查询结果中包含代理服务器的IP地址。

WPAD客户端执行以下DNS查找：
- QNAME=wpad.TGTDOM., QCLASS=IN, QTYPE=A

#### 5. 获取PAC文件

创建候选的CURL后，WPAD客户端通常会向CURL发送GET请求，并发送带有适当CFILE格式信息的Accept首部。例如：
```
Accept: application/x-ns-proxy-autoconfig
```

#### 6. 何时执行WPAD

WPAD应在以下情况下执行：
- 在Web客户端启动时（仅首次实例启动时）；
- 当客户端主机的IP地址发生变化时。

客户端还必须根据HTTP的过期时间，定期重新运行WPAD过程以更新PAC文件。

#### 7. WPAD欺骗

早期版本的IE实现了WPAD，但在某些情况下存在安全漏洞。后续版本修正了这些问题。

#### 8. 超时

每个WPAD阶段都应有超时限制，通常建议每个阶段不超过10秒，但具体值可根据网络特性调整。

#### 9. 管理者的考虑

管理者应至少配置DHCP或DNS A记录查找方式之一，以确保兼容性。此外，通过优化环境配置，可以缩短客户端的启动时间。

### 20.6 缓存重定向方法

本节介绍一些用于缓存代理服务器的更复杂的重定向技术，这些技术旨在提高可靠性和效率，并能够感知内容。

#### WCCP重定向

WCCP（Web Cache Communication Protocol）是由Cisco开发的协议，使路由器能够将Web流量重定向到代理缓存。WCCP负责路由器与缓存之间的通信，以验证缓存状态、进行负载均衡并将特定类型的流量发送给特定缓存。

##### 1. WCCP重定向的工作原理

以下是WCCP重定向在HTTP上的工作概述：
- 配置支持WCCP的路由器和缓存。
- 一组路由器及其目标缓存构成一个WCCP服务组。
- 如果服务组配置为重定向HTTP流量，路由器会将HTTP请求发送给服务组中的缓存。
- 路由器根据请求IP地址的散列或“掩码/值”策略选择缓存。
- 路由器将请求分组发送给选定的缓存。
- 如果缓存无法处理请求，则将分组返回给路由器进行常规转发。
- 服务组成员之间通过心跳报文互相验证可用性。

##### 2. WCCP2报文

WCCP2报文有四种类型，如下表所示：

| 报文名称               | 发送者           | 所承载的信息                                                     |
|----------------------|-----------------|--------------------------------------------------------------|
| WCCP2_HERE_I_AM      | 从缓存发送给路由器 | 告知路由器缓存可以接收流量，包含缓存的服务组信息                     |
| WCCP2_I_SEE_YOU     | 从路由器发送给缓存 | 对WCCP2_HERE_I_AM报文的响应，沟通分组转发方式、分配方法等                 |
| WCCP2_REDIRECT_ASSIGN | 从指定的缓存发送给路由器 | 为负载均衡分配任务，发送桶信息或“掩码/值”对信息                   |
| WCCP2_REMOVAL_QUERY | 从路由器发送给缓存 | 如果路由器未收到周期性的WCCP2_HERE_I_AM报文，则发送此报文进行查询       |

通过这种方式，WCCP确保了高效且可靠的流量重定向。