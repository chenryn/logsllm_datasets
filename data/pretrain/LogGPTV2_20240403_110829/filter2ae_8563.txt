## 介绍
自2018年5月vpnMentor发布博客以来，已近一年。该博客揭示了两个关键漏洞（[CVE-2018-10561](https://www.tenable.com/cve/CVE-2018-10561) 和 [CVE-2018-10562](https://www.tenable.com/cve/CVE-2018-10562)），这些漏洞可以被利用来完全破坏GPON家用路由器。这些问题引起了广泛关注，并已被多个僵尸网络（如Mettle、Muhstik、Mirai、Hajime和Satori）武器化。鉴于此，我决定深入研究GPON家庭网关的安全性。

通常，GPON光网络终端（ONT）设备由互联网服务提供商（ISP）分发给最终用户，作为互联网接入的端点。我的研究表明，至少有五家供应商生产的GPON家庭网关可能易受攻击。通过Shodan和Zoomeye的搜索显示，存在大量潜在易受攻击的设备。

尽管这些设备由不同的供应商生产，但它们使用相似的固件。任何差异主要是由每个供应商根据ISP的要求进行的修改。然而，核心固件保持不变。通过对不同ISP使用的多个固件版本进行分析，我确认了这一点。让我们比较一下来自不同固件包的Web根文件夹内容：

GPON家庭网关的固件通常不在供应商网站上公开提供，而是由ISP分发，并且通常自动更新或根本不更新。

## Telnet后门

为了进行深入的错误查找，通常需要将调试器附加到正在运行的服务上，这意味着我们需要访问路由器的控制台。完全模拟GPON家庭网关的固件是一项复杂的任务，因此我决定在eBay上购买了一台实际设备。这台设备是由阿尔卡特朗讯制造的I-240W-Q GPON家庭网关，基于ARM处理器（Feroceon 88FR131 rev 1 (v5l)）。

对阿尔卡特朗讯I-240W-Q GPON家庭网关的端口扫描显示了一些特殊之处。该设备运行Telnet和SSH服务，为ISP提供远程管理接口。然而，默认情况下，这些接口是防火墙保护的。Nmap扫描结果显示22/TCP和23/TCP端口被过滤。

这种情况看起来有些可疑，所以我决定检查WebMgr二进制文件以寻找后门代码。WebMgr负责GPON家庭网关的Web管理控制台。经过初步审查，“webLoginCheck”函数中的以下代码块显得很有希望：

```c
// webLoginCheck函数处理“ote”和“otd”命令，除了身份验证外，还可以用来启用或禁用后门代码。
```

通过发送简单的HTTP GET请求，我们可以关闭telnet端口的防火墙：

```http
GET /GponForm/diag_Form?diag_action=1&ping_ipaddr=127.0.0.1&ping_size=999999999&ping_times=999999999&ping_ttl=999999999 HTTP/1.1
Host: <target-ip>
```

通过发送以下命令，我们可以重新启用防火墙过滤：

```http
GET /GponForm/diag_Form?diag_action=0 HTTP/1.1
Host: <target-ip>
```

接下来，我们需要确定登录凭据。我们可以通过逆向工程`/bin/telnetd`来获取这些信息：

硬编码的密码对“root/admin”和“root/huigu309”可以正常使用并提供对shell的访问。同样的凭据也被硬编码到Dropbear（SSH）服务中。

## 利用Web界面中经过身份验证的缓冲区溢出

现在我们已经获得了对路由器控制台的访问权限，可以开始检查不安全的C函数使用情况。许多情况下，这些函数会直接处理用户的输入并通过HTTP请求传递。我们都熟悉`strcpy()`函数，它用于将字符串复制到目标数组中。但是，`strcpy()`不检查缓冲区长度，可能会覆盖相邻的内存区域，从而导致堆栈缓冲区溢出（BoF）。

让我们看一下处理“usb_Form”相关HTTP请求的子程序：

```c
// IDA Pro输出显示了一系列容易受到攻击的参数：“ftpusername”、“ftppassword1”、“ftpdirname”、“clientusername”、“clientpassword”、“urlbody”、“webdir”。这些用户输入由strcpy()复制，而不检查缓冲区长度。
```

通过执行以下curl命令，我们可以触发DoS条件并强制GPON路由器重启：

```sh
curl -X POST http://<target-ip>/GponForm/diag_Form -d "diag_action=1&ping_ipaddr=127.0.0.1&ping_size=999999999&ping_times=999999999&ping_ttl=999999999"
```

为了使此漏洞利用有效，我们仍然需要依赖身份验证绕过技巧（CVE-2018-10561）或获取Web管理界面的“登录/密码”对。

我们可以在“WebMgr”二进制文件中执行几个安全级别检查，找到最简单的利用方法，并将概念验证（PoC）转换为功能完备的漏洞利用：

我们在GPON路由器上启用了部分地址空间布局随机化（ASLR）。堆栈、虚拟动态共享对象（VDSO）页面和共享内存区域的位置是随机的，但堆不是随机的！如果我们可以找到存储在堆上的请求副本，我们可以通过修改“pc”寄存器跳转到它并触发shellcode执行。“WebMgr”堆是可执行的，看起来很有希望。

最终，我们得到了以下代码，允许我们通过触发存储在堆上的shellcode来成功执行ASLR旁路的“tftpd”服务：

```c
// 漏洞利用代码示例
```

漏洞利用执行如下：

```sh
# 示例命令
```

## 结论

在互联的世界中，路由器是任何网络中最关键的设备之一。家庭路由器通常是唯一将我们的私人网络与互联网隔离的边界设备。这个小巧的盒子抵御着持续的外部攻击，保护我们的隐私。为了保持这种保护边界，路由器的固件和硬件都需要不断升级和改进。只有最新的设备才能有效抵消攻击者的企图。对于现代攻击者来说，旧的、过时的设备是低悬的果实，对您的业务和个人隐私构成严重威胁。

根据Cyber​​-ITL研究人员的研究，大多数路由器没有使用ASLR、Stack Canaries和Non-executable stack等软件安全功能。不幸的是，阿尔卡特朗讯I-240W-Q GPON家庭网关也不例外。由于缺乏软件安全功能以及糟糕的编码实践，老式的堆栈粉碎攻击可以完全控制设备。

诺基亚目前是阿尔卡特朗讯I-240W-Q GPON家庭网关的官方供应商。我们已根据漏洞披露政策向诺基亚安全团队报告了所有发现，他们已经针对受影响的设备发布了补丁。

原文地址：