“占用率不错啊，70%了”
(￣▽￣)”
发现这病毒还通过OneDrive传输文件出去，然后我们发现了一个国外的IP，再查查，看看这个撒比（dalao）还干了啥。然后发现账户区域多了一个奇怪的账户，这里我们可以创建一个类似的账户以便去以假乱真，然后还等着干嘛，干掉那个新账户，接着我们发现最早是一个普通账户，我们把他叫做Disco吧（普通的Disco）；出现了异常登陆，登陆地址是美国，
“我们有美国的子公司么？”
“瞎说，不存在的”
“那这个？”
“干掉”
然后我们把病毒处理了，中毒机器的账户密码改了，系统还原了，处理完就回去了。
若干天后（一个礼拜左右吧）
微信传来了一个消息：
“192.168.1.1服务器状态满了”
“这么厉害的吗？我看看”，“卧槽，真满了”，”机器应该是闲着没事做，挖矿了“
”就你话多“
然后我还能怎样？我还怎么样？排查呗，然后经过大佬Feng和我们的排查发现，又是那个普通的Disco在普通的挖矿，哎哟，(￣y▽,￣)╭
，你还死灰复燃了，不对，这次好像换了个机器=。=
我去，这不是机器漏洞，这是弱口令啊。
”对“
”对的“
然后我们又给机器来了一套全面按摩（检查），检查完，发现，账户没有新建，然后就是在挖矿，也没有勒索我（这次低调了），然后OneDrive泥煤还是开着的，然后我们就干掉了它，还原镜像，然后我说：
”要不我们把所有账户全部统计一下，然后把Disco都重置了？“
”工作量有点大“
”=。=“
”搞呗“
就这样，我们把整个区域的Disco全部干掉了，你说你是Disco我会爱你么？干掉。不存在的
总结：账户管理要到位，所有的账户必须通过堡垒机进行管控，特权账户必须申请，审批后授予，然后需要及时收回，同时对操作要按时做审计，最后弱口令一点要干掉。偷偷告诉你们我见过的一些弱口令啊：
1qaz[@WSX](https://github.com/WSX
"@WSX"),qwer1234,1qaz[@WSX](https://github.com/WSX
"@WSX")#EDC,什么嘛，当我没有字典嘛，分分钟给你爆了
###  4.3.你的能量超乎你的想象
”Duke，去吧SIEM重装一下，然后写一份手册“
”OjbK“
然后我就找包，拷贝，上传，一气呵成，准备开始我的丰功伟业：重装SIEM，并记录过程。
唉，开始呗，在这之间我遇到好多事情的，我跟你们说，最奇葩的在后面
我兴奋的拿着我root账户，噼里啪啦一梭子下去，配置？不存在的，直接回车，然后提示我：
ulimit too small，然后建议我改成4096
然后继续操作，回车到最后设置一个登陆账户，我设置完了后，准备去检查一下我可爱的服务，然后我进入到了/etc/init.d
啥，你告诉我没有这个服务，然后我只能打开我那些user config book啊，然后我找了好久都没有找到相关的故障报错的信息。
我想，我可能需要再来一次，然后我删除了组件，重新开始了安装，然后我发现最上面有一对小字：please install tools through
Disco，啊哈？啥，用普通用户啊
我只好用Disco再来一遍，果然，服务起来了
后来我去检查了一下，我们可爱的SIEM（外国血统哦）需要使用普通用户创建服务，这样服务才能创建成功，那是不是root就不行了，不是，只是root不是默认的，我在最后面又看到了一排小字：
if you use root install as service，please run this command：
玛耶，你这不是刁难我胖虎近视么。
总结：有的时候你发现你的权限过大，这其实并不是一件好事，需要的时候再去获取或许是个更好的选择，因为权限过大也可能会出事，另外就是，别忽略小字
###  4.4百鬼夜行
夜半时分，为何蜜罐Honey会出现在其他区域，深夜十分，Honey为何不洗洗睡呢，要想知道为何Honey夜晚熬夜修仙，请慢慢看下去。欢迎准时收听：百鬼夜行—蜜罐
正文：
夜晚凌晨3点整，Felix正在梦乡，SZ夜晚的星空是那么的明媚，天空有几朵云朵飘荡着，夜猫子般的没有散去，可能正是应了一句话：月黑风高杀人夜，当然，这里没有命案；
一个浑身漆黑的影子在服务器A区域（安全域A）起来了，这么晚了，Honeypot小姐姐还没有睡，她神情麻木的游荡着，用简单一些的话来说，她梦游了，要叫醒他么？
A.叫醒
B.不叫醒
C.你就是一叙事人，叫啥叫
我当然是选择C啦，这么晚不睡，等着猝死吧。HoneyPot，简称Honey，我们Honey依然没有察觉自己在梦游，她仿佛很开心，一会儿在通往服务器B区域（安全域B，简称B区）瞧瞧，一会儿在C区瞧瞧，飘过来，飘过去的。然后Honey不知道从哪哪来的钥匙，开始去打开B，C甚至D，E等其他区域的门，门牌上写着445，有的可能写着443，有的可能写着135，138啥的，总之，Honey去开门了，开门？我又不在，开门干啥，肯定不是迎接我。
然后Honey打开了B区的门，打开了C区的门，D区的，E区的，能打开的都打开了，然后我明白了，她嫌弃我A区的空间太小了，然后从A跑到B，然后跑到C，就这样跑了一个晚上，不知道Honey累不累，反正我累的睡着了。
第二天早上，Felix来到办公室后，发现Honey有去过B，C，D，E等区域的痕迹（日志），立马对Honey进行了检查，彻彻底底的检查（算了，不开车）；最后发现，Honey吃了毒苹果(中毒)，然后神志不清的实现了内网漫游，中毒的Honey来了一次说走就走，还是熬夜的旅行，后来Honey飞升了
总结：中毒区域及时隔离，能恢复就回复，不能回复的想办法恢复，低权限可以暴力重装，蜜罐规则和机制要把控好，一些高危端口别开放，访问控制和规则要严谨，最后做好日志监控和相应的备份，顺便提一下，蜜罐玩不好还是要节制，不然责任基本上都是在你。
## 0x05.SOC建设全过程
这里我就SOC建设整体思维，以三个阶段的形式展现一下，也类似于“规划，建设，运维”的三个阶段。但这是笔者的SOC经历，每个人经历的可能不一样，也就是说，说不定你就是过去做最后一个阶段，或者在每个阶段的比重都有所不同，毕竟一切都应以实际情况出发。  
###  第一个阶段：规划
我一直都很坚信一句话：凡事预则立，不预则废；凡是预而立，尽在于心；
一个好的系统应该都有一份详细的规划和架构方案，一个好的SOC运营方案也应该是有详细的筹划和准备的，那么再规划阶段应该考虑一些什么东西呢？
####  1.资源
首先你要知道你的SOC运营中心有哪些支持的资源，这里提到的是工具或者辅助类的系统，一般来说支撑SOC运营中心的工具主要就是日志监控平台SOC/sao:k/,和其他的IPS，IDS，WAF，FW，终端管理，堡垒机，防病毒的安全设备等
其次，你可能需要一些进行测试和分析的服务器，一般用来按环境部署扫描器和用来镜像一些环境，还原测试
最后，你需要大量的日志，尽可能按照一级：环境分类，二级：设备，三级：日志类型，做到能够满足编写日志监控规则的要求即可，不用太详细，会带来不必要的工作量
备注：你可能还需要一些服务器的临时权限，一般用于对服务器进行检查和溯源分析等等
####  2.组织
我所在的公司SOC是一级部门，所以会比较注重安全，但并不是所有的企业都是特别注重安全，所以你需要去调整一个自身的位置，其实公司重视安全并不意味着你就可以强势，很多时候，决策是需要互相理解的，所以你需要知道你进行安全运营的时候，你所基础的那些部门会有哪些，一般来说会涉及到：监控，运维，业务，应用，基础设施以及OA部门，你们之间处理相关事件会不断的交流，另外还有一层组织就是领导部门，一般来说到部门的负责人是SOC工程师的顶端，至于再往上通过你的上级Leader再往上协调即可
####  3.目标
咋门既然要建设SOC运营中心，去监控整个企业的安全状态，那就得知道我们的目标，一般来说会有一些很简单的目标
a.运维权限的监控，目标不是针对运维组，而是排除他们的嫌疑，去分析异常登陆
b.账户权限的监控，和a有点像，一般来说是针对账户资源的
c.日志监控，监控所有的安全设备，系统，网络的日志即可，至于数据库业务那种，自己看着办，反正安全设备，系统，网络就基本上够吃一套了
e.变更审计，不是说你申请了变更就可以瞎搞，所以你需要对变更做一些详细的分析和判断
那么以上分别对应的资源就是：运维监控堡垒机权限，账户管理权限，日志服务器权限，变更审计权限
####  4.痛点
并不是所有的SOC都是从头开始建设，有的可能已经存在一段时间了，而恰好在某个时间段需要你就救火，这里的痛点指的就是企业当前迫于眉睫，亟待解决的安全问题
比如说你的员工上网行为不规范，经常不小心打通了内网，再比如你的员工把文件传输出去了，在或者离职的员工没有做好管理，出现了风险，甚至你的企业被勒索病毒烦恼，APT攻击缠绕，等等，都需要你去不断的收集上级领导，员工的安全需求，以及你自己发现的一些安全漏洞
###  第二个阶段：建设
建设实际上是在你知道自己想要把安全做到什么程度之后准备开始实施的阶段，这个阶段是凸显一个安全工程师底蕴的时刻，你得有足够丰富的系统经验去部署你的SOC，足够支持解决企业安全风险的安全知识，以及基本的网络通信等等，这些都是一个在对企业建设安全需要使用的一些部分，建设其实有点像架构好你的SOC监控平台的结构，然后安装，配置，调试，这类工作我就不做赘述，提一下我在建设过程的一些技巧吧。
####  1.资产规范很重要
你必须把你的资产严格按照你们内部定义或者集团定义的一套标准进行命名，在这里我把这个过程叫做资产建模，80%的企业的资产命名会出现一些差异，而建模的目标就是让所有的资产处于一种绝对标准化的命名，这样的优势是什么？有助于排查和分析，溯源，至于资产统一后的结果是如何的，一般按照具体的需求进行命名即可，但是要注意这里的资产，可以分享给基础设施，但并不建议强行推给他们，这会造成对方的工作负担，只有适合自己的才是最好的资产规范，我这里采用的是环境_应用名_IP的方式进行命名
例如：UAT_Test_192.168.1.1
最后注意的是，资产以IP为粒度，一个IP一个资产
####  2.网络结构
或许你们有网络架构师在对你们的网络做架构，这部分不需要太担心，网络架构基本上会负责基本的隔离要求，你可以考虑一些部署安全产品的位置以及补充一些安全防护手段，但这不是我要说的重点，这里的网络结构是网络区域的严格区分，主要是针对每个区域进行相应的命名，一般是使用英文进行规范，命名不要太长，也不用太洋气，内部看得懂就行
####  3.更新
更新主要是针对账户，资产，以及日志接入的更新，因为账户，资产在后续可能会增加，所以这里可以采用资产管理系统，或者定时的手动去咨询资产和账户情况，日志接入的更新一般都是在掌控中的，因为需要SOC团队和基础部门做日志的调试，参与其中
###  第三阶段：运营
当你的SOC日志监控平台搭建完毕，稳定运行的时候，就要考虑一些基础的运营内容
####  1.审计
审计账户的使用情况，审计资源的分配情况，审计变更的执行情况
####  2.巡检
定期对服务器，网络做巡检，主要是安全类型的巡检，就是基线和漏洞部分，这里可以加入漏洞管理，定期扫描和追踪漏洞修复情况
####  3.维护
对SOC监控平台做定期的巡检，这里是安全和系统的巡检，季度的重启
####  4调优
SOC监控平台建设完毕之后不可能是直接完美无缺的，所以需要不断地调整，这里你可以优化规则，可以优化日志，总之监控预警怎么直观怎么做
####  5.安全分析
这里一般来说是针对安全事件，比如企业遭到了攻击，或者出现了异常的事件预警，这里需要及时去处理和溯源，然后这里补充一个我在尝试去做到一个东西：威胁建模，可能是资产建模，网络建模产生的奇葩想法，。