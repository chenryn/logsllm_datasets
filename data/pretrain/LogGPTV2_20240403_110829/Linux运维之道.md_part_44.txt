## Page 341
iptables 防火墙规则的顺序非常重要，内核按顺序检查这些规则，如果发现有匹配的规则条
触发动作：
匹配参数：
Z
F
REDIRECT
MASQUERADE
SNAT
DNAT
LOG
REJECT
DROP
ACCEPT
[!] --string
[!] --state
[] --dports
[!]--mac-source
[!] --limit
[! --dst-range
[] --dport
[!] --sport
0
[!]-p
--sports
-0
-S
设置链默认规则。
清空防火墙数据表统计信息。
替换防火墙规则。
列出防火墙规则。
清空防火墙规则。
插入防火墙规则。
删除防火墙规则。
追加防火墙规则。
L.
重定向
地址欺骗
源地址转换
目标地址转换
将数据包信息记录syslog日志
拒绝数据包通过
丢弃数据包
匹配应用层字串
匹配状态（INVALID、ESTABLISHED、NEW、RELATED）
匹配目标端口
匹配源端口
匹配源MAC地址
匹配数据表速率
匹配目标地址范围
匹配源地址范围
匹配目标端口
匹配源端口
匹配出站网卡接口
匹配入站网卡接
匹配目标地址
匹配源地址
匹配协议，！代表取反
许数据包通过
口
戛9
网络安全
325
---
## Page 342
机：
命令的使用方法。
而使用-I选项添加的规则默认会插入到链中作为第一条规则。下面通过实例简单演示 iptables
功，则按照默认策略处理。我们使用-A选项添加防火墙规则会将该规则追加到整个链的最后，
目，则立刻执行相关动作，停止继续向下查找规则条目，如果所有的防火墙规则都未能匹配成
Linux运维之道
326
[root@centos6~]#iptables-I INPUT -i eth0--p tcp--dport 80-j ACCEPT
允许任何主机从eth0网络接口访问防火墙本机的80端口：
将192.168.0.10主机发送给防火墙本机22端口的所有数据包信息记录到messages日志：
修改filter表中INPUT链的默认规则为接收数据包：
[root@centos6~]# iptables -R INPUT 2!-s 192.168.0.254 -j REJECT
替换filter表中INPUT链的第二条规则，拒绝192.168.0.254之外的任何主机连接防火墙本
[root@centos6~]#iptables-D INPuT1
删除filter表中INPUT链的第一条规则：
[root@centos6 ~]#iptables-nL--line-number
查看filter表中防火墙规则并显示规则编号：
往filter表插入一条新的入站规则，拒绝192.168.0.22ping防火墙本机：
往flter表添加一条新的入站规则，丢弃192.168.0.1主机发送给防火墙本机的所有数据包。
清空filter表中的所有规则：
[root@centos6~]#iptables -tnat-nL
查看nat表的所有规则：
[root@centos6 ~]#iptables -nL
查看filter表的所有规则：
[root@centos6~]# iptables-F
---
## Page 343
需要被写入到NAT表的POSTROUTING链。
互联网将信息返回路由后，由路由再转交给真正的后端主机。防火墙源地址转换（SNAT）规则
网段内的主机连接外网时，防火墙自动将所有数据包的源地址修改为路由器上的公有IP，最后
拓扑结构如图6-2所示。我们使用CentOS6.3作为公司软路由，公司内部所有192.168.0.0/24
标准端口信息。
SMTP、POP3、SSH)，在Linux系统中，/etc/services文件可以帮助我们找到各种服务所对应的
6.1.2
案例1：允许任意客户端访问服务器主机提供的日常服务（HTTP、HTTPS、DNS、NTP、
#Kernel sysctl configuration file for Red Hat Linux
[root@router~]#vim/etc/sysctl.conf
案例2：公司拥有一个公有IP，使用防火墙实现局域网中所有的主机通过SNAT共享上网，
[root@centos6
[root@centos6
[root@centos6
[root@centos6
[root@centos6
[root@centos6
root@centos6
root@centos6
root@centos6
[root@centos6
iptables防火墙应用案例
~]#iptables
~]#
~]#iptables
#
#
#
#
#
iptables
iptables
iptables
iptables
iptables
iptables
iptables
iptables
124.126.199.84
-P
-A
-A
INPUT DROP
INPUT
INPUT
INPUT
INPUT
INPUT
INPUT
INPUT
图6-2
192.168.0.0/24
P
tcP
tcp
tcp
udp
tcp
--dport
--dport
--dport
--dport 22
53
U.
-jACCEPT
ACCEPT
ACCEPT
ACCEPT
ACCEPT
ACCEPT
ACCEPT
第6章网络安全
327
---
## Page 344
是连接的方向发生了改变，案例2是源地址转换（SNAT)，本例是目标地址转换（DNAT)。
客户可以从互联网的任意位置访问位于公司内部的两台服务器资源，拓扑结构类似于图6-2，只
Linux运维之道
328
>-jDNAT--to-destination 192.168.0.100
  #[ ]
net.ipv4.ip_forward =1
案例3：公司对外有一个公有IP，内部有HTTP、MAIL两台核心服务器，通过防火墙实现
[root@router~]#vim/etc/sysctl.conf
>-j SNAT --to-source 124.126.199.84
s#]
net.ipv4.ip_forward =1
#开启路由转发，实现基于Linux的软路由功能
..其余部分省略…
开启路由转发，实现基于Linux的软路由功能
Kernel sysctl configuration file for Red Hat Linux
For binary values,
.其余部分省略.
sysctl.conf(5) for more details.
For binary values,
for more details.
0is disabled,
0is disabled,
_124.126.199.84
#重新加载内核参数配置文件/etc/sysctl.conf
图6-2
------
192.168.0.0/24
1is enabled.
#重新加载内核参数配置文件/etc/sysctl.conf
1is enabled.
192.168.0.101
Postfix
Internet
See sysctl(8) and
See sysctl(8) and
---
## Page 345
至192.168.0.22地址段内所有的主机发送给路由要求转发的数据包，并允许转发这些数据包。
请求与无效连接，放行入站的回应请求。
-jREJECT
数据包，也就是防止将密码文件复制出局域网，并防止内部员工访问QQ网站。
入基于Linux的软路由服务器防火墙规则中，实现拒绝转发包含有关键词/etc/passwd以及qq的
但也提供了string扩展功能，通过--string 也可以根据关键词限制网络连接。将下面两条记录写
间内数据包的个数。下面的规则是当每秒钟数据包个数为500时接受入站连接，否则拒绝连接。
器，造成服务器无法响应正常的请求包，iptables 提供了一个limit 扩展功能，可以限制单位时
信息是不可能的。当然，如果你想匹配第二个及后面被分片的数据，可以使用“-f”选项。
等)，后续的数据片段仅包含数据包头部信息的一部分。这时再去检查后续数据片段的头部
当数据被分割后，只有前面的初始数据片段包含全部的数据头部信息（IP、TCP、UDP、ICMP
发送出去。接收端接收完数据后，将把这些数据片段重新组合成完整的数据包。但问题在于
案例8：公司采用基于Linux的软路由设备，要求在路由设备上设置防火墙规则，记录192.168.0.1
案例7：根据数据连接状态设置防火墙规则，放行所有的出站数据包。拒绝入站的新连接
案例6：企业环境中，服务器会面临各种各样的攻击，iptables本身属于三层包过滤防火墙，
案例5：目前网络上的攻击手法层出不穷，很多攻击会采用发送大量无效的数据包给服务
案例4：数据包因为太大无法一次完成数据的传输，此时数据包将被分割为数据片段再
[root@router ~]# iptables -A FORWARD -m iprange --src-range 192.168.0.1-192.168.0.10\
[root@centos6~]#iptables-F
[root@router~]#iptables-I FORWARD-m string--algobm--string"qq"-jREJECT
[root@centos6~]#iptables -A oUTPUT-f-d 192.168.1.1-jDROP
丢弃发送至192.168.1.1的所有数据以及分片数据：
[root@centos6~]#iptables-AINPUT-mstate--stateESTABLISHED,RELATED-jACCEPT
[root@centos6~]#
>-j DNAT --to-destination 192.168.0.101
>-j DNAT --to-destination 192.168.0.101
--src-range 192.168.0.1-192.168.0.10\
第6章网络安全
329
---
## Page 346
--to-destination 192.168.0.100
当前防火墙规则。
规则的作用。当防火墙规则需要做还原操作时，可以使用iptables-restore将备份文件直接导入
动加载该文件中的规则。如果使用iptables-save 将规则保存至其他位置，可以实现备份防火墙
使用iptables-save将规则保存至该文件中可以实现保存防火墙规则的作用，计算机重启后会自
的规则集时速度非常快。CentOS6.3系统中防火墙规则默认保存在/etc/sysconfig/iptables文件中，
iptables-restore，使用该工具实现防火墙规则的保存与还原。这两个工具的最大优势是处理庞大
用的工具，我们可以使用工具处理大量的防火墙规则。这两个工具分别是iptables-save和
丢失，所以对防火墙规则进行及时保存的操作是非常必要的。iptables 软件包提供了两个非常有
Linux运维之道
6.1.3防火墙备份与还原
330
默认的iptables防火墙规则会立刻生效，但如果不保存，当计算机重启后所有的规则都将
COMMIT
# Generated by iptables-save v1.4.7 on Thu May 23 10:46:00 2013
经过iptables-save命令导出的规则文件格式类似于如下内容：
A
OUTPUT ACCEPT[503:63104]
FORWARDACCEPT
:INPUT ACCEPT
*filter
#
-APREROUTING
:OUTPUTACCEPT
：POSTROUTING ACCEPT[O:0]
PREROUTINGACCEPT[54:4212]
nat
[root@centos6
[root@centos6
[root@centos6
Generated
Completed
INPUT
-m state
by iptables-save v1.4.7 on Thu May 23 10:46:00 2013
onThuMay2310:46:002013
tcp
tcp
[0:0]
~]#iptables-restore/etc/sysconfig/iptables
-d
[0:0]
[0:0]
-m iprange --src-range 192.168.0.1-192.168.0.10 -m tcp
iptables-save>firewall.bak
172.16.0.211/32
"qq.com"
-P
tcp
--algo bm--to 65535-j REJECT
IN- 08 4od-- du-
---
## Page 347
系统中SELinux全局配置文件为/etc/sysconfig/selinux，内容如下：
默认SELinux已经处于激活状态。对管理员来说，更多的是需要配置与管理SELinux，CentOS6.3
SELinux则是基于多个有效的安全标记判断权限，例如，SELinux用户、角色、类型、级别。
甚至其他进程域都不会产生影响。传统的DAC访问控制依靠用户及组的ID号进行权限判断，
时才被允许。当有黑客入侵你的某个服务时，也仅仅会影响到相应进程的域，对整个操作系统
进程与文件资源以及进程与进程之间的访问权限。所有对资源的访问，仅当有明确的策略规则
也定义了文件的类型。每个进程都被限制运行在自己独立的域中，由 SELinux策略规则来定义
SELinux依靠策略来决定是否允许主题访问目标对象。
如果传统的基于账户的访问权限允许，才会检查SELinux的强制访问控制（MAC访问控制），
题，一个主题能不能访问对象，首先系统会检查传统的账户权限是否允许（DAC控制权限），
SELinux后，系统中的文件、目录、设备甚至端口都作为对象，而用户运行的进程则被当作主
在Linux操作系统中一切皆文件（Everythingisfile）。
以GPL协议形式开源，目前所有的Linux内核2.6及以上版本中都集成了SELinux功能。使用
美国国家安全局开发的项目，旨在增强传统Linux操作系统的安全性。SELinux项目在2000年
13
6.2.1
在CentOS 6.3系统中部署SELinux非常简单，由于SELinux已经作为模块集成到内核中，
使用SELinux后所有的进程与文件都被标记为一种类型，类型定义了进程的操作域，同时
[root@centos6~]#vim/etc/sysconfig/selinux
SELinux（Security-EnhancedLinux）是基于Linux内核的强制访问控制机制实现，它是由
# This file controls the state of SELinux on the system.
#Completedon ThuMay2310:46:002013
COMMIT
SELinux简介
SELINux= can take one of these three values:
permissive - SELinux prints warnings instead of enforcing.
SELinux配置文件
第6章网络安全
331
---
## Page 348
SELinux相关软件包的介绍。
于当前系统，计算机重启后无效，永久修改模式需要修改配置文件。
作为 SELinux的控制类型。使用getenforce可以查看系统当前 SELinux的运行模式。
简单的命令（如Is）都会报错。计算机的入侵多数是来自网络的，所以企业中多数采用 targeted
的服务进程进行访问控制，mls类型将对系统中的所有进程进行控制，启用mls后，用户执行
项，用来设置SELinux类型，可以设置为 targeted类型或mls 类型，targeted类型主要对系统中
代表强制开启，SELinux会拦截非法的资源访问并记录相关日志。SELNUXTYPE=targeted 设置
不会拦截该访问，也就是最终访问是成功的，只是在SELinux日志中记录而已。enforcing 模式
仅警告模式，处于此状态下时，当主题程序试图访问无权限的资源时，SELinux会记录日志但
功能，由于 SELinux是内核模块功能，所以如果设置禁用，需要重启计算机。permissive 代表
SELinux总开关，有效值可以是enforcing、permissive或disabled。其中，disabled代表禁用SELinux
Linux运维之道
使用 setenforce可以临时在enforcing 模式与permissive 模式之间切换，切换会被立刻应用
6.2.2
332
CentOS 6.3 系统除了提供基本的 SELinux 功能外，还提供了一些管理工具。下面是对
全局配置文件中除去以#符号开头的注释行，有效配置参数仅两行。SELinux=enforcing 为
[root@centos6~]#setenforce
[root@centos6~]# setenforce0
SELINUXTYPE=targeted
SELINUxTYPE= can take one of these two values:
SELINUX=enforcing
policycoreutils：该软件包提供了用于管理 SELinux 的restorecon、secon、setfles、
libselinux-python：该软件包提供了SELinux应用开发的Python 资源。
selinuxconlist、selinuxdefcon、selinuxenabled、togglesebool命令管理工具。
libselinux-utils：该软件包提供avcstat、getenforce、getsebool、setenforce、matchpathcon、
selinux-policy-targeted：提供 targeted类型的策略。
/usr/share/selinux/devel/policygentool.
selinux-policy：该软件包负责提供 SELinux 参考策略，还提供了一个开发工具
SELinux软件包