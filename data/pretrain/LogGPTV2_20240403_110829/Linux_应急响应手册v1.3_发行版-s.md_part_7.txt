·日志
异常登录日志中无异常
[root@centos-7helper]#lastb
btmp begins Wed Apr 28 17:46:45 2021
[root@centos-7helper]#
在/var/log/secure 中可以看到 ssh认证连接
Apr 28 17:33:23 centos-7 sudo:helper : TTY=pts/1 ;PwD=/hone/helper :USER=root ; CoMMAND=/bin/1astb
Apr 28 17:33:23 centos-7 sudo: pam_unix(sudo:session): session opened for user root by helper(uid=a)
Apr 28 17:33:33 centos-7 sudo:
Apr
28 17:33:23 centos-7 sudo: pam_unix(sudo:session): session closed for user root
：helper:TTY=pts/1:PwD=/home/helper;USER=root;CoMMAND=/bin/lastb
Apr 28 17:33:33
3 centos7 sudo: pam_unix(sudo:session): session opened for user root by helper(uid=e)
Apr 28 17:33:33 centos7 sudo: pam_unix[sudo:session): session closed for user root
Apr 28 17:35:57 centos7 su: pam_unix(su:session): session opened for user root by helper(uid=10ee)
0xO2DNS隧道
dns隧道是一种相对隐蔽的一种连接方式，通过DNS的A、CNAME、TXT、MX各种记录进行流量传输，检查起来难度较大
常见的DNS隧道工具：
dns2tcp
dnscat2
---
## Page 53
● clnscat2 powershel反
●iodline
Cobalt Strike
●Reverse_DNS_Shell
对于DNS隧道，检测主要分为两个方面
·DNS隧道的进程
·DNS的流量传输
进程角度
其实从进程角度很难去查询DNS隧道，水平一般的攻击者也会把默认的工具名称改掉，甚至改成java等和正常应用一样的
名，所以这里也只是碰碰运气
ps afjx
流量角度
对于重要目标的APT一般可以无限延长攻击时间，如果攻击者想，完全可以将数据包发包频率随机化，将DNS查询子城名长
度限制在正常长度范围内（比如3~5个字符），在隧道DNS请求间穿播“正常“请求，比如www.cdemo.com的域名解析，甚
至抓包模拟正常业务需要解析的域名的各种记录查询，诱导安全人员和设备出错
所以这里我们仅仅讨论隧道正在进行的情况，网络上有很多从AI角度来进行检测DNS隧道的文章，挑选几篇看一看就能了解
怎么避免被检测到，可以参考
●DNS隧道检测特征总结 https://zhuonlan.zhihu.com/p/143220945
●探秘-基于机器学习的DNS隐蔽隧道检测方法与实现https://blog.riskivy.com/探秘-基于机器学习的dns隐蔽隧道检测
方法与实现/
理论结束，进入实操，宗旨就是在Linux服务器上抓一段时间的包，之后拿到桌面计算机上面进行分析
tcpdump
tcpdump =p =n =s 0 port donain =w dnstest.pcap
这样我们收集一段时间，之后放入wireshark中进行分析
rooteubuntu-64bit:/home/helper# tcpdump -p -n-s 0 port domain
tcpdump:verbose output suppressed,use -v or -vv for full protocol decode
listening on enpes5, link-type EN1eMB (Ethernet),copture size 262144 bytes
16:27:16.537682 IP 10.211.55.10.56689 > 10.211.55.1.53: 59730+ A? hichina.cn. (28)
16:27:17.125612 IP 10.211.55.1.53 >10.211.55.10.56689: 59730 1/0/0 A218.30.103.45 (44)
16:27:30.531525 IP 10.211.55.10.39753 > 10.211.55.1.53:13612+ A? toob00.com.(28)
16:27:30.978158 IP 10.211.55.10.59091 > 10.211.55.1.53:33646+ PTR7 96.220.205.140.in-oddr.orpo.(45)
16:27:31.226820 IP 10.211.55.1.53 >10.211.55.10.59891:33646 NXDcmoin 0/1/0 (116)
---
## Page 54
18.00000
10:21:551
18:211555.11
Internet Protocel versian 4,Sr 10.1.55.1,Dst:28.11.55.18
ort: 53, Dst Port: 4996#
sct1ateStande
query respo
onst, Ns errer
Cl: type a, class IN
[Label Count:3]
55)(1)
如果DNS流量较大，可以按照域名进行过滤，baidu，sina，ubuntu，centos，redhat等官方域名都可以筛选掉，剩下的
再进行分析
如果其中A、TXT、CNAME、MX等记录中存在像以下这种比较特殊的请求，可能就存在DNS隧道
Quer1es
46a401907a57e1336938f3003e06a03945.km.com:type CNAME,class IN
Name :46a401907a57e1336938f 3003e06a03945.km.com
[Name Length: 46]
[LabelCount:3]
Type: CNAME (Canonical NAME for an alias) (S)
Class:IN (OxO0O1)
Ox03ICMP隧道
ICMP隧道与DNS隧道类似，都是在正常的请求中加密传输我们自己的载荷
常见ICMP隧道工具
● ptunnel
ysduo! ●
jauunds) ●
● icmpshell
进程角度
ps afjx
1180
1547
1560 pts/6
1160 pts/e
1596
1647
rBkali)-[~/Desktep
网络连接角度
---
## Page 55
被攻击主机可能开放新的监听端口，以便后续进行端口转发或者在隧道内创建新的隧道，我们通过以下指令查看
netstat -pantu
netstat
-QLocalA
S(servers and established)
0.0.0.0:*
state
PID/Progran name
10.211.55.6:47162
LISTEN
ESTABLISHED 1280/X-
1547/ptu
10.211.55.
10.211.55.1:67
fe60::21c:42ff:fe58:546111*
ESTABLISHED
r@kati)-[~/Desktop]
流量角度
tcpdump 抓取ICMP流量
deod·duot=doT0S=U=d=dunpdo
放入wireshark进行分析，看看是否存在一些包大小不太正常的流量或者流量中存在其他协议的字符
自→T
rega
( reest 133)
(
---
## Page 56
OxO4HTTP/HTTPS隧道
http隧道一般以webshell的形式存在，检测起来基本上就是检测webshell那一套
lauun/xod ●
●httptunnel(htc/hts)
▪reGeorg
●Neo-reGeorg
Duunl▪
•ABPTTS
检测手段：
文件查杀
。使用D盾等webshell查杀工具进行查杀
D盾
WEBDIR+
owebShellkiller
。河马查条
0..
·文件名
参照小技巧章节中的“查找文件”
·文件内容关键字
。参照小技巧章节中的“查找文件内容”
·流量特征关键字
。例如regeorg的cmd参数等，一般需要安全设备进行辅助
·进程
° proxytunnel 和 httptunnel 这种
新建文件
。查找最近或者一段时间内新创建的文件，查找小技巧中查找文件的章节
·主机对外行为
。建立隧道的目的无非就是攻击内网主机，所以关注本机对外攻击情况可以有一些发现
OxO5SSL加密隧道
SSL隧道致力于将其他数据通过SSL加密封装，使内部安全传输
●stunnel
● go-funnel
ssI隧道软件一般也都是采用客户端/服务端+配置文件的形式，所以可以从以下几个角度去分析
·进程
ops afjx
·文件名&新建文件
。参照小技巧中关于文件查找的章节
·文件内容（配置文件）
---
## Page 57
。参照小技巧中关于文件内容查找的章节
·网络通信
。至少多一个SSL的端口和网络连接
0x06Socks隧道
·frp
●earthworm
●shadowsocks
socks协议的代理隧道非常多，基本可以通过协议来进行区分，如果安全设备发现存在socks协议的通信，那么可以着
重观察一下
ssh 的-D 参数也是使用了 socks代理
协议
。需要安全设备自动分析，不然tcpdump抓包后放入wireshark上分析比较麻烦，同时难度也很大
·进程
ops afjx
·文件名&新建文件
。参照小技巧中关于文件查找的章节
·文件内容（配置文件）
。参照小技巧中关于文件内容查找的章节
·网络连接
netstat-pantu查看是否存在异常的端口连接
行为
。是否存在对内网其他主机攻击行为
Ox07wi-FiorBluetooth隧道
●Ghost Tunnel
参考GhostTunnel：适用于隔离网络的wiFi隐蔽传输通道-FreeBuf网络安全行业门户
检测方法：
来发现取证的角度来写
wi-Fi
·将无限网卡设置为监听模式
iwconfigwlan0modemonitor（wlanO为网卡接口名称）
如果执行失败，可以先把网卡down掉，再进行设置，再up起来
ifconfig wlan0 down
ivconfig vlan0 node monitor
ifconfig wlan0 up
●wireshark 抓 802.11的包
·对Wi-Fi认证过程进行分析，是否存在异常数据包
---
## Page 58
正常的认证过程如下：
STA
AP
(1)Beacon(BroadcastSSID)
(2)Probe Request
GhostTunnelConnection
(3) Probe Response
(4)Authentication Request
(5)Authentication Response
(6)Association Request
(7)Association Response
WifiConnection Established
REEBUF
参考GhostTunnel：适用于隔离网络的wiFi隐蔽传输通道-FreeBuf网络安全行业门户
Bluetooth
蓝牙的协议一般人了解较少，需要进行抓包后与常规协议进行对比
可以使用wireShark进行蓝牙数据包分析，具体可以参考
Bluetooth - wiki - wireshcrk Foundotion / wireshork - GitLob
wi-Fi和Bluetoot的隧道对传输距离有要求，可以简单观察一下四周，不使用的时候关闭蓝牙和wi-Fi
---
## Page 59
善后阶段
善后阶段是所有事件处置都要做的步骤，放在最后一起写，主要内容包括以下几个方面
0x01杀毒工具查杀
●chkrootkit
●clamov
●Unhide
●Rootkit Hunter
0x02history信息
以下三种情况history会不完整
·被清空或设置不记录，history =c或者unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG;
export HISTFILE=/dev/null; export HISrSIzE=0; export HISTFILESIzE=0
·如果ssh异常中断（比如网络中断），历史命令还在缓冲区中不会写入到文件中，就会导致此连接执行的命令没有记录
·如果命令前带一个空格，这条命令就不会被记录
0x03计划任务
需要检查的项
▪/etc/crontab
●/etc/cron.d/*
●/var/spool/cron/xxx
● /etc/anacrontab (Redhat/Centos)
建议检查的时候使用vim打开具体的计划任务文件去看，cat命令存在一些缺陷，可以被某些字符截断，造成看的不全，具
体可以参考公众号文章计划任务后门Linux后门系列
[ubuntu server 16.04 64位】默认计划情况
helpereubuntu-64bit:~$cat/etc/crontab
#/etc/crontab:system-wide crontab
#Unlike any other crontab you don't have to run thecrontab
#command to install the new version when you edit this file
and files in /etc/cron.d. These files also have userncme fields,
that none of the other crontabs do.
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
mh dom mon dow usercormond
17*
..root
cd/&&run-parts--report/etc/cron.hourly
256
root
test-x/usr/sbin/anacron11（cd/8& run-ports -report /etc/cron.daily）
476
7root
test -x/usr/sbin/anacron 11（cd/&& run-ports --report/etc/cron.weekly）
526
1**
root
test-x/usr/sbin/anacron11（cd/&&run-parts--report/etc/cron.monthly)
helper@ubuntu-64bit:~s
---
## Page 60
-- schediles periodic redundsnky checks ef uo devtces
CopyrigM C sortin f.krafft 
dsstributed under the tarrs of the Artistic Lscemce 2.2
 By defoult, run at a0:s7 en ewiry Sundly, but do rothing anliss the duty of
he north is ess then o epel to 7. Thus,orly run on the first Sundy of
hack (see #388425).
enth,<rontab(5) sucks, usfortunetely. un this regard; thenefore this
root 1f[x/as/shore/ndad/checkerroy ]sEsCdotee）e7：then /usr/shore/ndd/checkoraycron1desulet: f
ELL=/bin/sh
/lecol/sin1/use/acol/bin/ubin:/sin:Aesr/sbinc/usr
reuburtu-64bit:-$
helpereubuntu-64bit:~Ssudols-al/var/spool/cron/*
/var/spool/cron/atjobs:
total12
drwxrwx--T2 doemon doemon 4096Apr 2611:34
drwxr-xr-x5rootroot4096Apr2611:34
-rW..-1 doemon doemon2Apr 2611:34.SEQ
/var/spool/cron/atspool:
total8
drwxrwx--T2doemon doemon 4096Jan152016
drwxr-xr-x5rootroot4096Apr2611:34
/var/spool/cron/crontabs:
total8
drwx-wx--T2root crontab 4096Apr62016
helper@ubuntu-64bit:~Ssudo cat/var/spool/cron/atjobs/-SEQ
helper@ubuntu-64bit:~S
helper@ubuntu-64bit:~Scat/etc/anacrontab
cat:/etc/anacrontab:No such file or directory
helper@ubuntu-64bit:~s
【Centos764位】默认计划任务情况
---
## Page 61
[helper@centos-7~]ssudocat/etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO-root
#For details see man 4crontabs
#Example of job definition:
#1
hour（0-23)
day ofmonth （1-31)
-------
month（1-12)ORjan,feb，mar，apr
dayofweek （0-6)（Sunday=0 or 7)OR sun,mon,tue，wed,thu，fri，sat
[helper@centos-7~]ssudo cat/etc/cron.d/*
#Run the hourly jobs
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
01****root run-parts /etc/cron,hourly
#Run system wide raid-check once a week on Sunday at lam by default
01**Sun root/usr/sbin/raid-check
*/10*+**root/usr/lib64/sa/sal11
#0****root/usr/lib64/sa/sa16006&
5323***root/usr/Lib64/sa/sa2-A
[helperecentos-7-]$ sudo1s-al/var/spool/cron/
drnx,2rootroot68月92019
总用量
drmxr-xr-x.12 root root 1489月17 2819
[helperecentos-7~]$
---
## Page 62
#/etc/anacrontab: configuration file for anacron
LheLpe
#See anacron(8) ond anocrontab(5) for details
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
the maximal random delay odded to the bose deloy of the jobs
RANDOM_DELAY=45
#the jobs wilt be started during the following hours only
START_HOURS_RANGE=3-22
#period in doys
delay in minutes
job-identifiercornand
1
5
cron.daily
nice run-parts /etc/cron.daily
25
cron.weekly
nice run-parts/etc/cron.weekly
Emonthly 45
cron.monthly
nice run-parts /etc/cron.monthly
[helperecentos-7-]s
更加详细信息可以参照下面这篇文章
https://mp.weixin.qq.com/s/sn.J80-Aiy9-XfFv.Jw380vg
0x04账户信息
·新增账户
o cat /etc/passwd
ost：/rost:/usr/bia/fish
or/q//e:x
x:1:1:da
on:/usr/sbin:/vsr/sbin/nalogin
ys1x13131sys1/dev1/usr/sbia/n01egin
znc:x:4:65534:sync:/tin:/bin/sy
/man:/esr/sbin/naloglr
il:xi8:8:mai11/war/111/usr/shin/eolegls
：/lse/1bin/sologln
uacp:x:10:10:wcp:/var/1gco1/uucp:/usr/sbls/nologln
：x:13:13:prexy=/tsn:/usr/sbte/nslogls
1st:x:38:38.Ma11ing 1starge:/vae/1ist:/usr/5in/o1ogfn
Lhin/nologin
systeed-etuorkix11ee:se2isysteed NetuorkRaageen51/rus/sstedretif:/se/shin/molgin
65534:65534:00
aresistenti/ase/eain/nalogir
ystemd-resolve:x:lel:ie3:systemdFesolrer,.
:/eun/systeed/reselve:/esr/sbin/mologin
yslog:x:ta2:106::/hcee/sysieg:/usr/sbls/sa1agls
1x:103:107:/
existeet:/usr/sbi/mlegi
x：x:105:55534::/var/11s/1xe/:/bin/fa1se
al04:x:105:138::/esn/vu506:/usr/sb1e/melegls
var/11b/alsc:/usr/sbLn/nologln
pal1Inate:x:109:3::/var/cache/pe11inate:/asn/fa1so
sshd:x:11a:655s4::/rus/sshd:/usr/sbie/nologis
proftpd:x:11:6553:1/rva/preftpdi/use/sbta/a0logln
elper:x:laoa:io2e:helper:hcme/helpee:/bin/ba
ftp1x1112:113:ftp
gob:x:113:115::/var/1b/eongoeb:/use/shis/na1og1n
,1/srv/ftp:/use/sbin/aologln
pestf1x1x1134131611/var/spo01/pestf1x1/ese/s9in/nologin
red1s:x:115:119:/var/115/re61s:/sr/sb1n/so1og1n
botghelper
可以与主机和业务相关人员确定是否存在未知账号，即使是nologin的也是可能造成风险的，比如使用sfftp上传下载
文件
---
## Page 63
[ubuntu server 16.04 64位】默认账号情况（helper是我创建的账号)
eL/wsr/sin/relogin
usr/soue/no
p:/asr/shiw/mologl
husr/sb
t:x:38:38:Moitsng List 
er:/var/1ist:/usr/shiw/nologi
k:x:39:183=systend
emen..1/ne/systed/rett:/bu/talse
x:203:1a5:systend Bus Preny...1/run/systend:/biv/false
x：10665536
Ad:X:185:112:5
c:/oir/false
root
daemon
bin
sys
sync
games
man
1p
mail
news
donn
proxy
www=data
backup
list
irc
gnats
nobody
systend-timesync
systend-network
systend-resolve
systend-bus-proxy
syslog
_apt
1.xd
messagebus
uuidd
dnsmasg
sshd
---
## Page 64
【Centos7】默认账号情况（helper是我创建的账号）
root
bin
daemon
adm
1p
sync
shutdown
halt
mai1
operator