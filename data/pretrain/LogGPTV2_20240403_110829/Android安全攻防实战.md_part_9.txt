u6_a38
u_a37
ity-test
uD_47
ue_a34
2813-85-18
0O15S
uD_a28
2013-05-16 
6:55
rold.fallbac
55:90
gallery
utdesde
图 2.17
一集中（）（）是目，
第二列。这里，拥有者实际上就是app 本身。Linux 默认情况下是在app 的
拥有者权限下运行app的——这实际上就是app的沙箱是如何运作的。如果
一个app 需要获得一个它原本无权访问的资源的访问权限时，Limux就会把
它加到相应的组中。
3.如果你想要一次性地查看app的所有资源和元数据，请执行下面这条命令，
如图2.18所示。
18 -a1R */
2913·05-16 06:55 1.5 -s /de
363-65：1606：55150
图 2.18
52
---
## Page 71
第2章实践app安全
但是一般，你不会愿意屏幕被一大堆目录列表占满一除非你是把它重定向
到一个文件中去。你或许只想显示数据库，如图2.19所示。
1s -alR */databases/
2996
0a13
53592
u0a134
524288
2013-05138:20ste
2913-03.
1-05-15
Coakiesch
0084
0034
272013513150 
684 2013-03-20:30t1.
40085
40085
2013-05-158:00
095
0
yel
 2.19
或许你只想显示所有的文件，或者每个app保存在/files/目录中的东西，如图2.20
所示。
1s -alR */files/
6 2813-5-16 06:36contacts-.5.dictict
15 28138516 86:56 Launcher -pref
2013-05-36 0:16 photfo1e
ts/files
213-851：56
yfttes//eroflle/ghete
图 2.20
53
---
## Page 72
Android安全攻防实战
再或者，你甚至可能想要搜索指定类型的文件（根据扩展名），下面是一些例子：
16 -a1 */*/*.png
1s -a1 */*/*.xm1
18 =al */*/*.mp3
4.找到你想找的文件之后，你要做的就是用我们的老朋友“adbpull”命令，把
它们从你的手机上复制出来。
adb pu11 /data/data/[包名]/[文件路径]
更多内容.
我们在这里要做的不过就是列出不同的文件类型。其中一类是sqlite3数据库一
一刚才你在一些目录中看到的DB文件。我打赌你想知道怎么打开它们，查看里面的
内容。下面是怎么做。
在正式开始之前，你需要确认sqlite3已经安装好了。这是个AndroidSDK中自
带的工具。
1.用下面这条命令把DB文件提取到你的计算机的本地目录中
adb pul1l/data/data/[包名]/databases/[数据库文件名]
2.用sqlite3加载.db文件
sqlite3[database-filename]
如果你正找例子的话，请看一下图2.21这张截图。
30.15
图 2.21
54
---
## Page 73
第2章实践app安全
在这一章中，我们介绍了一些保护app的机制，一些基本的保护包括：app内部
的通信、app的权限，以及加密签名和与文件系统相关的访问控制保护。
你应该从中学到的是：手工实现这些安全机制所需的技巧和技能。这让你能在
android设备强制要求使用它们时，能独立地评估这些机制的有效性。这也让你能更
直接地与这些机制进行交互，希望能让你更好地理解它们。
55
---
## Page 74
第3章Android安全评估工具
在这一章里，我们将进行下面这些实验：
·制作 Santoku启动盘和安装 Santoku;
·安装drozer;
·运行一个drozer会话：
·枚举已安装的包（package）；
·枚举activity：
·枚举 content provider;
·枚举service：
●枚举broadcast receiver;
·确定app的受攻击面（attack surface）；
·运行activity：
·编写drozer模块
一个驱动枚举模块；
·编写一个app证书枚举器。
3.1简介
我们已经讨论了Android开发方面的所有基本知识，也介绍了所有Android开发
工具。现在是时候开始探讨Android黑客和安全评估工具了。
）
利用和Android安全评估框架—它是由MWR实验室里的一些人员研发的。此外，
这一章里也会介绍一个基于Debian的Linux发布版本一Santoku，它是一个基本上
类似BackTrack或Kali的软件，用于移动安全评估的Linux系统。这一章里，我们
会教你怎么安装和运行它。
---
## Page 75
第3章Android安全评估工具
在我们开始安装drozer和编写一些样例脚本之前，你必须理解的一些重要的内
容是一些关于如何操作drozer，以及它是怎样解决Android安全评估这场“游戏”里
的一些问题的事。
Drozer可以分成两个部分：其一是“console”—它运行在你的本地计算机上，
其二是“server”—它基本上就是一个安装在目标Android设备上的 app。当你使用
console 与 Android 设备交互时，基本上就是把Java 代码输入到运行在实际设备上的
drozer代理（agent）中。
为什么要以这种方式设计它呢？好吧，在drozer 问世之前，编写app 中漏洞的
利用代码，就意味着要编译一个Androidapp，利用给定的漏洞，把它部署到目标手
机上，再去看它是不是正常工作了。要是它没能正常工作，你还必须把整个过程重
新再来一遍！这在实践操作中是非常烦琐的，并且使人感觉Android安全评估好像是
一种无趣的低级重复性劳动。Drozer使部署漏润利用代码变得容易，使你能通过
drozeragent这个代理，而不是不断地向设备发命令的方式测试漏洞利用代码。这意
味着，你不再需要一遍遍地使用Android开发环境，或者不断地重新编译有漏洞的app。
Drozer之所以被称为是一个框架（framework）是因为：它允许你编写你自己的
模块或插件，扩展它的功能使之适用于你的需求。从本质上来说，它最像一个专用
于移动安全评估的Metasploit。
标准drozer 框架的另一个作用是：它本质上是一个不需要任何权限的Android
app—这实际上是它的一个组件。这也就是说：你管理的任何exploit，装入Android
设备之后，能够相当好地自动适应当前设备，只需要很低的权限就能成功运行。其
目标在于：展示一个“无权限的”app可以多么有效地黑掉一个Android设备及安装
在该设备上的众多app。
以上就是关于drozer的一些基本背景知识。阅读本章中余下部分时，由于drozer
模块是用python开发的，所以你也需要一些python这门编程语言的基本知识。如果
你有一些关于Java反射机制的知识，了解如何开发Android app，或者开发过Android
aPp，那也将是有用的。不过，即使你从来没有正儿八经地开发过什么东西，或者更
常见的，从来没有用python写过程序，那也别着急一我保证会说明所有python代
码，并仔细地解释它。
闲话不表，我们开始！
①Agent 是指在计算机中安装的，“代替”人们完成某一专门任务的程序，比如 outlook、foxmail
之类的程序就是电子邮件的agent。—译者注
57
---
## Page 76
Android安全攻防实战
3.2制作Santoku启动盘和安装Santoku
viaForensics公司的开发人员开发了一个基于Ubuntu 的发布版本—Santoku，
它确实很酷，并且预装了一些移动安全评估工具。下面这个实验将教你怎样动手制
作一个Santoku的启动盘。我之所以这样安排的理由是：你可能想在你自己的Santoku
启动盘中安装和运行drozer。
准备工作
一开始，我们先要下载一点东西。请去 https:/santoku-linux.com/download 下载
最新版本的 Santoku的镜像。
怎么做··
在下载完最新版本的Santoku之后，你可以通过以下步骤制作它的启动盘。
1.首先，要下载制作 Santoku启动盘的必要工具。它可以是Unbuntu启动盘创
建器，也可以是Windows 下的通用USB启动光盘生成工具，下载地址是：
http:/www.pendrivelinux.com/downloads/Universal-USB-Installer/Universal-US
B-Installer-1.9.4.7.exc-
2.把已经下载好了的 Santoku镜像写到U盘中去。
3.使用Windows下的通用USB启动光盘生成工具，执行下列步骤。
（1）启动通用USB启动光盘生成工具，在“Step1”中选择“TryUnlistedLinux
ISO”，如图3.1所示。
S veal U/S8 1ur 13.44 St)
roe
图3.1
58
---
## Page 77
第3章Android安全评估工具
（2）单击“Browse”按钮，输入你Santokuiso文件的存放路径，如图3.1所
示。
（3）在“Step3”中选取你要写入镜像的U盘。
（4）单击“Create”按钮，放松休息一下，等待启动盘制作完毕。
4.从插入的U盘启动你的物理计算机—进入启动菜单，选择从USB设备启
动计算机。
5.计算机从U盘启动完毕之后，你会看见如图3.2所示的画面。
0.4
图3.2
6.在这个启动屏募中选择“install start the installer directly”
7.安装将在屏幕上出现图3.3所示的界面后开始。
Welcome
aleg
图 3.3
69
---
## Page 78
Android安全攻防实战
8.根据安装向导的提示操作，完成安装前的设置。这一过程非常容易理解，如
果你之前安装过Ubuntu，一定会很熟悉它。
安装完毕之后，你就能看到一个带有Logo标志的新Santoku桌面了。如图
3.4所示：
图 3.4
进一步说明..·
如果你想在一台虚拟机上执行安装操作。你需要下载VirtualIBox软件。对于
Windows 和UNIX/Linux用户,这个软件的下载地址是https://www.virtuabox.org/wiki/
Downloads.
下载和安装好VirtualBox之后，你可以通过以下步骤创建一台新的虚拟机。
1.单击VirtualBox窗口项部左端的“新建”按钮。
2.将会弹出一个“新建虚拟电脑”的对话框，在“名称”中输入“Santoku”或
者其他任意一个你为新虚拟机取的名字。
3.在下拉菜单“类型”中选择“Linux”。
①以下VirtualBox 中相关内容，根据VirtualBox 4.3.10 中文版（本书翻译时最新版的 VirtualBox）
进行翻译。——译者注
60
---
## Page 79
第3章
Android安全评估工具
4.在下拉菜单“版本”中选择“Ubuntu”，并单击“下一步”按钮，如图3.5所
示。
图3.5
5.现在该弹出“内存大小”对话框了，默认值是512，这已经够用了。不过，
如果你宿主机的内存确实有富裕的话，你也可以再给它多加那么一点点。在
你确定内存大小之后，单击“下一步”按钮。
击“下一步”按钮。
7.现在弹出的是“虚拟硬盘文件类型”对话框，选择“VDI（VirtualBox磁盘
映像）”选项，并点击“下一步”按钮。
是因为你可能会要在这台虚拟机的硬盘上下载和安装一大堆app和工具。单
击“下一步”
9.该弹出“文件位置和大小”对话框了，选择默认值就可以了。8GB空间足以
装下系统初始安装时要写入的数据和工具了。如果你还想要硬盘再大些，你
也可以再给虚拟机多分配一点存储空间，一切都取决于你。选定一个合适的
值之后，单击“下一步”按钮。
10.你的虚拟机现在就已经创建好了，你需要给它配置一个启动光盘，用以启
61
---
## Page 80