# Kernel Pwn å­¦ä¹ ä¹‹è·¯ï¼ˆå››ï¼‰
|
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
## 0x01 å‰è¨€
ç”±äºå…³äºKernelå®‰å…¨çš„æ–‡ç« å®åœ¨è¿‡äºç¹æ‚ï¼Œæœ¬æ–‡æœ‰éƒ¨åˆ†å†…å®¹å¤§ç¯‡å¹…æˆ–å…¨æ–‡å¼•ç”¨äº†å‚è€ƒæ–‡çŒ®ï¼Œè‹¥å‡ºç°æ­¤æƒ…å†µçš„ï¼Œå°†åœ¨ç›¸å…³å†…å®¹çš„å¼€å¤´äºˆä»¥è¯´æ˜ï¼Œéƒ¨åˆ†å¼•ç”¨å‚è€ƒæ–‡çŒ®çš„å°†åœ¨æ–‡ä»¶ç»“å°¾çš„å‚è€ƒé“¾æ¥ä¸­æ³¨æ˜ã€‚
Kernelçš„ç›¸å…³çŸ¥è¯†ä»¥åŠä¸€äº›å®ä¾‹åœ¨Kernelä¸­çš„åˆ©ç”¨å·²ç»åœ¨Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸€)(äºŒ)ç»™äºˆäº†è¯´æ˜
Kernelä¸­å†…å­˜ç®¡ç†çš„ç›¸å…³çŸ¥è¯†å·²ç»åœ¨Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸‰)ç»™äºˆäº†è¯´æ˜
æœ¬æ–‡ä»¥åŠæ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« å°†ä¸»è¦ä»¥ç³»ç»Ÿè°ƒç”¨ä¸ºä¾‹ä»‹ç»å†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†æœºåˆ¶ã€‚æœ¬æ–‡æ¶‰åŠåˆ°çš„æ‰€æœ‰`Linux Kernel`ç›¸å…³ä»£ç å‡åŸºäº`5.6.2`ç‰ˆæœ¬ã€‚
é™äºç¯‡å¹…çš„åŸå› ï¼Œæœ¬æ–‡ä»…ä»‹ç»äº†`IDT`çš„åˆå§‹åŒ–ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†æ›´å¤šçš„æ¶‰åŠä¸­æ–­æœåŠ¡å‡½æ•°çš„å†…å®¹~
ã€ä¼ é€é—¨ã€‘ï¼š[Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸€)](https://www.anquanke.com/post/id/201043)
ã€ä¼ é€é—¨ã€‘ï¼š[Kernel Pwn å­¦ä¹ ä¹‹è·¯(äºŒ)](https://www.anquanke.com/post/id/201454)
ã€ä¼ é€é—¨ã€‘ï¼š[Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸‰)](https://www.anquanke.com/post/id/202371)
## 0x02 ä¸­æ–­çš„æ¦‚è¿°
###  ä»€ä¹ˆæ˜¯ä¸­æ–­
ä¸­æ–­æ˜¯æŒ‡åœ¨CPUæ­£å¸¸è¿è¡ŒæœŸé—´ï¼Œç”±äºå†…å¤–éƒ¨äº‹ä»¶æˆ–ç”±ç¨‹åºé¢„å…ˆå®‰æ’çš„äº‹ä»¶å¼•èµ·çš„CPUæš‚æ—¶åœæ­¢æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œè½¬è€Œä¸ºè¯¥å†…éƒ¨æˆ–å¤–éƒ¨äº‹ä»¶æˆ–é¢„å…ˆå®‰æ’çš„äº‹ä»¶æœåŠ¡çš„ç¨‹åºä¸­å»ï¼ŒæœåŠ¡å®Œæ¯•åå†è¿”å›å»ç»§ç»­è¿è¡Œè¢«æš‚æ—¶ä¸­æ–­çš„ç¨‹åºã€‚
è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸€ä¸ªæ¯”è¾ƒå®é™…çš„ä¾‹å­ğŸŒ°ï¼š
æ¯”å¦‚è¯´æˆ‘æ­£åœ¨å¨æˆ¿ç”¨ç…¤æ°”çƒ§ä¸€å£¶æ°´ï¼Œè¿™æ ·å°±åªèƒ½å®ˆåœ¨å¨æˆ¿é‡Œï¼Œè‹¦è‹¦ç­‰ç€æ°´å¼€â€”â€”å¦‚æœæ°´æº¢å‡ºæ¥æµ‡ç­äº†ç…¤æ°”ï¼Œæœ‰å¯èƒ½å°±è¦å‘ç”Ÿä¸€åœºç¾éš¾äº†ã€‚ç­‰å•Šç­‰å•Šï¼Œå¤–è¾¹çªç„¶ä¼ æ¥äº†æƒŠå¥‡çš„å«å£°â€œæ€ä¹ˆä¸å…³æ°´é¾™å¤´ï¼Ÿâ€ï¼Œäºæ˜¯æˆ‘æƒ­æ„§çš„å‘ç°ï¼Œåˆšæ‰æ¥æ°´ä¹‹ååªé¡¾ç€æŠ±æ€¨è¿™ä»½æ— èŠçš„å·®äº‹ï¼Œå±…ç„¶å¿˜äº†è¿™äº‹ï¼Œäºæ˜¯æ…Œæ…Œå¼ å¼ çš„å†²å‘æ°´ç®¡ï¼Œä¸‰ä¸‹ä¸¤ä¸‹å…³äº†é¾™å¤´ï¼Œå£°éŸ³åˆä¼ åˆ°è€³è¾¹ï¼Œâ€œæ€ä¹ˆå¹²ä»€ä¹ˆéƒ½æ˜¯è¿™ä¹ˆé©¬è™ï¼Ÿâ€ã€‚ä¼¸ä¼¸èˆŒå¤´ï¼Œè¿™ä»¶å°äº‹å°±è¿™ä¹ˆè¿‡å»äº†ï¼Œæˆ‘è½å¯çš„çœ¼ç¥åˆè½åœ¨äº†æ°´å£¶ä¸Šã€‚
é—¨å¤–å¿½ç„¶åˆä¼ æ¥äº†é“¿é”µæœ‰åŠ›çš„æ­Œå£°ï¼Œæˆ‘æœ€å–œæ¬¢çš„å¤è£…å‰§è¦å¼€æ¼”äº†ï¼ŒçœŸæƒ³å¤ºé—¨è€Œå‡ºï¼Œç„¶è€Œï¼Œå¬ç€æ°´å£¶å‘å‡ºâ€œå’•å˜Ÿå’•å˜Ÿâ€çš„å£°éŸ³ï¼Œæˆ‘æ¸…æ¥šï¼šé™¤éç­‰åˆ°æ°´å¼€ï¼Œå¦åˆ™æ²¡æœ‰æˆ‘äº«å—äººç”Ÿçš„æ—¶å€™ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘æ˜¯å”¯ä¸€å…·æœ‰å¤„ç†èƒ½åŠ›çš„ä¸»ä½“ï¼Œä¸ç®¡æ˜¯çƒ§æ°´ã€å…³æ°´é¾™å¤´è¿˜æ˜¯çœ‹ç”µè§†ï¼ŒåŒä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šæˆ‘åªèƒ½å¹²ä¸€ä»¶äº‹æƒ…ã€‚ä½†æ˜¯ï¼Œåœ¨æˆ‘ä¸“å¿ƒè‡´å¿—å¹²ä¸€ä»¶äº‹æƒ…æ—¶ï¼Œæ€»æœ‰è®¸å¤šæˆ–ç´§è¿«æˆ–ä¸ç´§è¿«çš„äº‹æƒ…çªç„¶å‡ºç°åœ¨é¢å‰ï¼Œéƒ½éœ€è¦å»å…³æ³¨ï¼Œæœ‰äº›è¿˜éœ€è¦æˆ‘åœä¸‹æ‰‹å¤´çš„å·¥ä½œé©¬ä¸Šå»å¤„ç†ã€‚åªæœ‰åœ¨å¤„ç†å®Œä¹‹åï¼Œæ–¹èƒ½å›å¤´å®Œæˆå…ˆå‰çš„ä»»åŠ¡ï¼Œâ€œæŠŠä¸€å£¶æ°´å½»åº•çƒ§å¼€ï¼â€
ä¸­æ–­æœºåˆ¶ä¸ä»…èµ‹äºˆäº†æˆ‘å¤„ç†æ„å¤–æƒ…å†µçš„èƒ½åŠ›ï¼Œå¦‚æœæˆ‘èƒ½å……åˆ†å‘æŒ¥è¿™ä¸ªæœºåˆ¶çš„å¦™ç”¨ï¼Œå°±å¯ä»¥â€œåŒæ—¶â€å®Œæˆå¤šä¸ªä»»åŠ¡äº†ã€‚å›åˆ°çƒ§æ°´çš„ä¾‹å­ï¼Œå®é™…ä¸Šï¼Œæ— è®ºæˆ‘åœ¨ä¸åœ¨å¨æˆ¿ï¼Œç…¤æ°”ç¶æ€»æ˜¯ä¼šæŠŠæ°´çƒ§å¼€çš„ï¼Œæˆ‘è¦åšçš„ï¼Œåªä¸è¿‡æ˜¯åŠæ—¶å…³æ‰ç…¤æ°”ç¶è€Œå·²ï¼Œä¸ºäº†è¿™ä¹ˆä¸€ä¸ªä¸€ç§’é’Ÿå°±èƒ½å®Œæˆçš„åŠ¨ä½œï¼Œå´è®©æˆ‘æ­»æ­»åœ°å®ˆå€™åœ¨å¨æˆ¿é‡Œï¼Œåœ¨10åˆ†é’Ÿçš„æ—¶é—´é‡Œä¸åœåœ°çœ‹å£¶å˜´æ˜¯ä¸æ˜¯å†’è’¸æ°”ï¼Œæ€ä¹ˆè¯´éƒ½ä¸åˆ’ç®—ã€‚æˆ‘å†³å®šå®‰ä¸‹å¿ƒæ¥çœ‹ç”µè§†ã€‚å½“ç„¶ï¼Œåœ¨æœ‰ç”Ÿä¹‹å¹´ï¼Œæˆ‘éƒ½ä¸å¸Œæœ›è®©å¨æˆ¿æˆä¸ºç«æµ·ï¼Œäºæ˜¯æˆ‘ä¸Šäº†é—¹é’Ÿï¼Œ10åˆ†é’Ÿä»¥åå®ƒä¼šå‘å‡ºâ€œå°–å«â€ï¼Œæé†’æˆ‘ç‚‰å­ä¸Šçš„æ°´çƒ§å¼€äº†ï¼Œé‚£æ—¶æˆ‘å†å»å…³ç…¤æ°”ä¹Ÿå®Œå…¨æ¥å¾—åŠã€‚æˆ‘ç”¨ä¸€ä¸ªä¸­æ–­ä¿¡å·â€”â€”é—¹é“ƒâ€”â€”æ¢æ¥äº†10åˆ†é’Ÿçš„æ¬¢ä¹æ—¶å…‰ï¼Œå¿ƒé‡Œä¸ç¦ç”±è¡·åœ°æ„Ÿå¹ï¼šä¸­æ–­æœºåˆ¶çœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚
**æ­£æ˜¯ç”±äºä¸­æ–­æœºåˆ¶ï¼Œæˆ‘æ‰èƒ½æœ‰æ¡ä¸ç´Šåœ°â€œåŒæ—¶â€å®Œæˆå¤šä¸ªä»»åŠ¡ï¼Œä¸­æ–­æœºåˆ¶å®è´¨ä¸Šå¸®åŠ©æˆ‘æé«˜äº†å¹¶å‘â€œå¤„ç†â€èƒ½åŠ›ã€‚**
å®ƒä¹Ÿèƒ½ç»™è®¡ç®—æœºç³»ç»Ÿå¸¦æ¥åŒæ ·çš„å¥½å¤„ï¼šå¦‚æœåœ¨é”®ç›˜æŒ‰ä¸‹çš„æ—¶å€™ä¼šå¾—åˆ°ä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼ŒCPUå°±ä¸å¿…æ­»å®ˆç€ç­‰å¾…é”®ç›˜è¾“å…¥äº†ï¼›å¦‚æœç¡¬ç›˜è¯»å†™å®Œæˆåå‘é€ä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼ŒCPUå°±å¯ä»¥è…¾å‡ºæ‰‹æ¥é›†ä¸­ç²¾åŠ›â€œæœåŠ¡å¤§ä¼—â€äº†â€”â€”æ— è®ºæ˜¯äººç±»æ•²æ‰“é”®ç›˜çš„æŒ‡å°–è¿˜æ˜¯æ¥å›è¯»å†™ä»‹è´¨çš„ç£å¤´ï¼Œè·ŸCPUçš„å¤„ç†é€Ÿåº¦ç›¸æ¯”ï¼Œéƒ½å¤ªæ…¢äº†ã€‚æ²¡æœ‰ä¸­æ–­æœºåˆ¶ï¼Œå°±åƒæˆ‘ä»¬è‹¦å®ˆå¨æˆ¿ä¸€æ ·ï¼Œè®¡ç®—æœºè°ˆä¸ä¸Šæœ‰ä»€ä¹ˆå¹¶è¡Œå¤„ç†èƒ½åŠ›ã€‚
è·Ÿäººç›¸ä¼¼ï¼ŒCPUä¹Ÿä¸€æ ·è¦é¢å¯¹çº·ç¹èŠœæ‚çš„å±€é¢â€”â€”ç°å®ä¸­çš„æ„å¤–æ˜¯æ— å¤„ä¸åœ¨çš„â€”â€”æœ‰å¯èƒ½æ˜¯ç”¨æˆ·ç­‰å¾—ä¸è€çƒ¦ï¼ŒçŒ›æ•²é”®ç›˜ï¼›æœ‰å¯èƒ½æ˜¯è¿ç®—ä¸­ç¢°åˆ°äº†0é™¤æ•°ï¼›è¿˜æœ‰å¯èƒ½ç½‘å¡çªç„¶æ¥æ”¶åˆ°äº†ä¸€ä¸ªæ–°çš„æ•°æ®åŒ…ã€‚è¿™äº›éƒ½éœ€è¦CPUå…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œè¦ä¹ˆé©¬ä¸Šå¤„ç†ï¼Œè¦ä¹ˆæš‚ç¼“å“åº”ï¼Œè¦ä¹ˆç½®ä¹‹ä¸ç†ã€‚æ— è®ºå¦‚ä½•åº”å¯¹ï¼Œéƒ½éœ€è¦CPUæš‚åœâ€œæ‰‹å¤´â€çš„å·¥ä½œï¼Œæ‹¿å‡ºä¸€ç§å¯¹ç­–ï¼Œåªæœ‰åœ¨å“åº”ä¹‹åï¼Œæ–¹èƒ½å›å¤´å®Œæˆå…ˆå‰çš„ä½¿å‘½ï¼Œâ€œæŠŠä¸€å£¶æ°´å½»åº•çƒ§å¼€ï¼â€
###  ä¸­æ–­çš„ç±»å‹
æ¦‚æ‹¬åœ°è¯´ï¼Œå¯ä»¥å°†ä¸­æ–­åˆ†ä¸ºä¸¤ä¸ªä¸»è¦ç±»åˆ«ï¼š
  * å¤–éƒ¨æˆ–ç¡¬ä»¶äº§ç”Ÿçš„ä¸­æ–­ï¼ˆå¼‚æ­¥ä¸­æ–­ï¼‰
  * è½¯ä»¶ç”Ÿæˆçš„ä¸­æ–­ï¼ˆåŒæ­¥ä¸­æ–­ï¼‰
å¼‚æ­¥ä¸­æ–­æ˜¯é€šè¿‡ç”± `Local APIC` æˆ–è€…ä¸ `Local APIC` è¿æ¥çš„å¤„ç†å™¨é’ˆè„šæ¥æ”¶ã€‚
åŒæ­¥ä¸­æ–­æ˜¯ç”±å¤„ç†å™¨è‡ªèº«çš„ç‰¹æ®Šæƒ…å†µå¼•èµ·(æœ‰æ—¶ä½¿ç”¨ç‰¹æ®Šæ¶æ„çš„æŒ‡ä»¤)ã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯æ˜¯`division by
zero`ï¼ˆé™¤é›¶é”™è¯¯ï¼‰ï¼Œå¦ä¸€ä¸ªç¤ºä¾‹æ˜¯ä½¿ç”¨`syscall`æŒ‡ä»¤é€€å‡ºç¨‹åºã€‚
å¦‚å‰æ‰€è¿°ï¼Œä¸­æ–­å¯ä»¥åœ¨ä»»ä½•æ—¶é—´å› ä¸ºè¶…å‡ºä»£ç å’Œ CPU æ§åˆ¶çš„åŸå› è€Œå‘ç”Ÿã€‚å¯¹äºåŒæ­¥ä¸­æ–­ï¼Œè¿˜å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š
  * `Faults`ï¼ˆæ•…éšœï¼‰â€”â€” è¿™æ˜¯åœ¨æ‰§è¡Œâ€œä¸å®Œå–„çš„â€æŒ‡ä»¤ä¹‹å‰æŠ¥å‘Šçš„å¼‚å¸¸ï¼Œä¸­æ–­æœåŠ¡ç¨‹åºè¿è¡Œç»“æŸåå…è®¸æ¢å¤è¢«ä¸­æ–­çš„ç¨‹åºã€‚
  * `Traps`ï¼ˆé™·é—¨ï¼‰â€”â€” è¿™æ˜¯åœ¨æ‰§è¡Œ`trap`æŒ‡ä»¤ä¹‹åå³åˆ»æŠ¥å‘Šçš„å¼‚å¸¸ï¼Œä¸­æ–­æœåŠ¡ç¨‹åºè¿è¡Œç»“æŸåå…è®¸æ¢å¤è¢«ä¸­æ–­çš„ç¨‹åºã€‚
  * `Aborts`ï¼ˆç»ˆæ­¢ï¼‰â€”â€” è¿™ç§å¼‚å¸¸ä»ä¸æŠ¥å‘Šå¼•èµ·å¼‚å¸¸çš„ç²¾ç¡®æŒ‡ä»¤ï¼Œä¸­æ–­æœåŠ¡ç¨‹åºè¿è¡Œç»“æŸä¸å…è®¸æ¢å¤è¢«ä¸­æ–­çš„ç¨‹åºã€‚
å¦å¤–ï¼Œä¸­æ–­åˆå¯åˆ†ä¸ºå¯å±è”½ä¸­æ–­(`Maskable interrupt`)å’Œéå±è”½ä¸­æ–­(`Nomaskable interrupt`)ã€‚
å¯¹äºå¯å±è”½ä¸­æ–­ï¼Œåœ¨`x86_64`æ¶æ„ä¸­ï¼Œå¯ä»¥ä½¿ç”¨`cli`å‘½ä»¤é˜»æ­¢ä¸­æ–­ä¿¡å·çš„å‘é€ã€‚
    /* In /source/arch/x86/include/asm/irqflags.h#L47 */
    static inline void native_irq_disable(void)
    {
        asm volatile("cli": : :"memory");
    }
    static inline void native_irq_enable(void)
    {
        asm volatile("sti": : :"memory");
    }
å¯å±è”½ä¸­æ–­èƒ½å¦å‘é€å–å†³äºä¸­æ–­å¯„å­˜å™¨ä¸­çš„`IF`æ ‡å¿—ä½ã€‚
`cli`å‘½ä»¤ä¼šå°†åœ¨è¿™ä¸ªæ ‡å¿—ä½æ¸…é™¤ï¼Œè€Œ`sti`å‘½ä»¤ä¼šå°†è¿™ä¸ªæ ‡å¿—ä½ç½®ä½ã€‚
éå±è”½ä¸­æ–­å°†ä¼šå§‹ç»ˆè¿›è¡ŒæŠ¥å‘Šï¼Œ **é€šå¸¸ï¼Œç¡¬ä»¶äº§ç”Ÿçš„ä»»ä½•é”™è¯¯éƒ½å°†ä½œä¸ºéå±è”½ä¸­æ–­è¿›è¡ŒæŠ¥å‘Šï¼**
###  ä¸­æ–­çš„äº§ç”Ÿ
ç®€åŒ–èµ·è§ï¼Œå‡å®šæ¯ä¸€ä¸ªç‰©ç†ç¡¬ä»¶éƒ½æœ‰ä¸€æ ¹è¿æ¥ CPU
çš„ä¸­æ–­çº¿ã€‚è®¾å¤‡å¯ä»¥ä½¿ç”¨å®ƒå‘CPUå‘å‡ºä¸­æ–­ä¿¡å·ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¸­æ–­ä¿¡å·å¹¶ä¸ä¼šç›´æ¥å‘é€ç»™CPUã€‚åœ¨è€æ—§çš„æœºå™¨ä¸­ï¼Œæœ‰ä¸€ä¸ª[PIC](http://en.wikipedia.org/wiki/Programmable_Interrupt_Controller)èŠ¯ç‰‡ï¼Œè´Ÿè´£é¡ºåºå¤„ç†æ¥è‡ªå„ç§è®¾å¤‡çš„å„ç§ä¸­æ–­è¯·æ±‚ã€‚åœ¨æ–°æœºå™¨ä¸­ï¼Œæœ‰ä¸€ä¸ªé€šå¸¸è¢«ç§°ä¸º
`APIC`çš„[é«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨](https://en.wikipedia.org/wiki/Advanced_Programmable_Interrupt_Controller)ã€‚ä¸€ä¸ª`APIC`
ç”±ä¸¤ä¸ªäº’ç›¸ç‹¬ç«‹çš„è®¾å¤‡ç»„æˆï¼š
  1. `Local APIC`(æœ¬åœ°æ§åˆ¶å™¨)
  2. `I/O APIC`(IOæ§åˆ¶å™¨)`Local APIC`ä½äºæ¯ä¸ªCPUæ ¸å¿ƒä¸­ï¼Œå®ƒè´Ÿè´£å¤„ç†ç‰¹å®šäº CPU çš„ä¸­æ–­é…ç½®ã€‚
`Local APIC`å¸¸è¢«ç”¨äºç®¡ç†æ¥è‡ª`APIC`æ—¶é’Ÿ(`APIC-timer`)ã€çƒ­æ•å…ƒä»¶å’Œå…¶ä»–ä¸`I/O`è®¾å¤‡è¿æ¥çš„è®¾å¤‡çš„ä¸­æ–­ã€‚
`I/O APIC`æä¾›å¤šæ ¸å¤„ç†å™¨çš„ä¸­æ–­ç®¡ç†ï¼Œå®ƒè¢«ç”¨æ¥åœ¨æ‰€æœ‰çš„ CPU æ ¸å¿ƒä¸­åˆ†å‘å¤–éƒ¨ä¸­æ–­ã€‚
ä¸­æ–­å¯ä»¥éšæ—¶å‘ç”Ÿã€‚å‘ç”Ÿä¸­æ–­æ—¶ï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»ç«‹å³å¤„ç†å®ƒã€‚å¤„ç†é€»è¾‘çš„æ¦‚è¿°å¦‚ä¸‹ï¼š
  1. å†…æ ¸å¿…é¡»æš‚åœæ‰§è¡Œå½“å‰è¿›ç¨‹ã€‚ï¼ˆæŠ¢å å½“å‰ä»»åŠ¡ï¼‰
  2. å†…æ ¸å¿…é¡»æœç´¢ä¸­æ–­å¤„ç†ç¨‹åºå¹¶ä¸”è½¬äº¤æ§åˆ¶æƒï¼ˆæ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºï¼‰
  3. ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œç»“æŸåï¼Œè¢«ä¸­æ–­çš„è¿›ç¨‹å¯ä»¥æ¢å¤æ‰§è¡Œã€‚ï¼ˆäº¤è¿˜æ§åˆ¶æµï¼Œè§£é™¤æŠ¢å ï¼‰
å½“ç„¶ï¼Œåœ¨å¤„ç†ä¸­æ–­çš„è¿‡ç¨‹ä¸­æ¶‰åŠè®¸å¤šå¤æ‚é—®é¢˜ã€‚ä½†æ˜¯ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤æ„æˆäº†è¯¥è¿‡ç¨‹çš„åŸºæœ¬æ¡†æ¶ã€‚
æ¯ä¸ªä¸­æ–­å¤„ç†ç¨‹åºçš„åœ°å€éƒ½è¢«ä¿å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®è¢«ç§°ä¸º`IDT(Interrupt Descriptor Table,ä¸­æ–­æè¿°ç¬¦è¡¨)`ã€‚
å¦‚æœåŒæ—¶å‘ç”Ÿå¤šä¸ªå¼‚å¸¸æˆ–ä¸­æ–­ï¼Œåˆ™å¤„ç†å™¨å°†æŒ‰ç…§å…¶é¢„å®šä¹‰çš„ä¼˜å…ˆçº§é¡ºåºå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ä¼˜å…ˆçº§å¦‚ä¸‹æ‰€ç¤ºï¼š
  1. ç¡¬ä»¶ **é‡ç½®** æˆ– **æœºå™¨æ£€æŸ¥** (`Hardware Reset and Machine Checks`)
  2. ä»»åŠ¡è°ƒåº¦æ—¶è§¦å‘é™·é—¨(`Trap on Task Switch`) â€”â€” `TSS`ä¸­çš„`T`æ ‡å¿—ä½è¢«ç½®ä½æ—¶å‘ç”Ÿ
  3. å¤–éƒ¨ç¡¬ä»¶å¹²é¢„(External Hardware Interventions) â€”â€” å‘ç”Ÿä¸‹åˆ—æŒ‡ä»¤ä¹‹ä¸€æ—¶æŠ¥å‘Š 
    * `FLUSH` â€”â€” åˆ·æ–°
    * `STOPCLK` â€”â€” æ—¶é’Ÿå‘å‡ºç»ˆæ­¢ä¿¡å·
    * `SMI` â€”â€” ç³»ç»Ÿç®¡ç†ä¸­æ–­(`System Management Interrupt`)
    * `INIT` â€”â€” åˆå§‹åŒ–
  4. æŒ‡ä»¤é™·é—¨(`Traps on the Previous Instruction`) â€”â€” å¸¸è§äºæ–­ç‚¹(`BreakPoint`)å’Œè°ƒè¯•å¼‚å¸¸(`Debug Trap Exceptions`)
  5. éå±è”½ä¸­æ–­(`Nonmaskable Interrupts`)
  6. å¯å±è”½çš„ç¡¬ä»¶ä¸­æ–­(`Maskable Hardware Interrupts`)
  7. ä»£ç æ–­ç‚¹é”™è¯¯(`Code Breakpoint Fault`)
  8. ä»¥ä¸‹ä¸‰ç§å¼‚å¸¸æˆ–ä¸­æ–­å‡å±äºç¬¬å…«ä¼˜å…ˆçº§ 
    * è·å–ä¸‹ä¸€æ¡æŒ‡ä»¤æ—¶å‡ºé”™(`Faults from Fetching Next Instruction`)
    * è¿åä»£ç æ®µé™åˆ¶(`Code-Segment Limit Violation`)
    * ä»£ç é¡µé”™è¯¯(`Code Page Fault`)
  9. ä»¥ä¸‹å››ç§å¼‚å¸¸æˆ–ä¸­æ–­å‡å±äºç¬¬ä¹ä¼˜å…ˆçº§ 
    * å¯¹ä¸‹ä¸€æ¡æŒ‡ä»¤è§£ç æ—¶å‡ºé”™(`Faults from Decoding the Next Instruction`)
    * æŒ‡ä»¤é•¿åº¦å¤§äº16ä¸ªå­—èŠ‚(`Instruction length > 15 bytes`)
    * `OP Code`ä¸åˆæ³•(`Invalid Opcode`)
    * åå¤„ç†å™¨ä¸å¯ç”¨(`Coprocessor Not Available`)
  10. ä»¥ä¸‹å‡ ç§å¼‚å¸¸æˆ–ä¸­æ–­å‡å±äºç¬¬åä¼˜å…ˆçº§ 
    * è¿è¡ŒæŒ‡ä»¤æ—¶å‡ºé”™(`Faults on Executing an Instruction`)
    * æº¢å‡º(`Instruction length > 15 bytes`)
    * ç»‘å®šé”™è¯¯(`Bound error`)
    * ä»»åŠ¡çŠ¶æ€æ®µä¸åˆæ³•(`Invalid TSS(Task State Segment)`)
    * æ®µä¸å­˜åœ¨(`Segment Not Present`)
    * å †æ ˆé”™è¯¯(`Stack fault`)
    * ä¸€èˆ¬ä¿æŠ¤(`General Protection`)
    * æ•°æ®é¡µé”™è¯¯(`Data Page Fault`)
    * å¯¹é½éªŒè¯(`Alignment Check`)
    * x87 FPUæµ®ç‚¹å¼‚å¸¸(`x87 FPU Floating-point exception`)
    * SIMD FPUæµ®ç‚¹å¼‚å¸¸(`SIMD floating-point exception`)
    * è™šæ‹ŸåŒ–å¼‚å¸¸(`Virtualization exception`)
###  ä¸­æ–­å·ä¸ä¸­æ–­å‘é‡
å¤„ç†å™¨ä½¿ç”¨å”¯ä¸€çš„ç¼–å·æ¥è¯†åˆ«ä¸­æ–­æˆ–å¼‚å¸¸çš„ç±»å‹ï¼Œè¿™ä¸ªç¼–å·è¢«ç§°ä¸ºä¸­æ–­å·( `vector number`)ã€‚å®ƒå°†ä½œä¸º`IDT(Interrupt
Descriptor Table,ä¸­æ–­æè¿°ç¬¦è¡¨)`çš„ç´¢å¼•å€¼ï¼Œä¸­æ–­å·çš„å–å€¼èŒƒå›´æ˜¯ä»`0`åˆ°`255`ã€‚åœ¨`Linux
Kernel`ä¸­å…³äºä¸­æ–­è®¾ç½®çš„åœ°æ–¹å¯ä»¥æ‰¾åˆ°è¿™æ ·çš„æ£€æŸ¥ï¼š
    /* In /source/arch/x86/kernel/idt.c#L230 */
    static void set_intr_gate(unsigned int n, const void *addr)
    {
        struct idt_data data;
        BUG_ON(n > 0xFF);
        memset(&data, 0, sizeof(data));
        data.vector    = n;
        data.addr    = addr;
        data.segment    = __KERNEL_CS;
        data.bits.type    = GATE_INTERRUPT;
        data.bits.p    = 1;
        idt_setup_from_table(idt_table, &data, 1, false);
    }
**ä»`0`åˆ°`31`çš„å‰32ä¸ªä¸­æ–­å·ç”±å¤„ç†å™¨ä¿ç•™ï¼Œç”¨äºå¤„ç†ä½“ç³»ç»“æ„å®šä¹‰çš„å¼‚å¸¸å’Œä¸­æ–­ã€‚**
Vector | Mnemonic | Description | Type | Error Code | Source  
---|---|---|---|---|---  
0 | #DE | Divide Error | Fault | NO | DIV and IDIV  
1 | #DB | Reserved | F/T | NO |  
2 | â€”- | NMI | INT | NO | external NMI  
3 | #BP | Breakpoint | Trap | NO | INT 3  
4 | #OF | Overflow | Trap | NO | INTO instruction  
5 | #BR | Bound Range Exceeded | Fault | NO | BOUND instruction  
6 | #UD | Invalid Opcode | Fault | NO | UD2 instruction  
7 | #NM | Device Not Available | Fault | NO | Floating point or [F]WAIT  
8 | #DF | Double Fault | Abort | YES | An instruction which can generate NMI  
9 | â€”- | Reserved | Fault | NO |  
10 | #TS | Invalid TSS | Fault | YES | Task switch or TSS access  
11 | #NP | Segment Not Present | Fault | NO | Accessing segment register  
12 | #SS | Stack-Segment Fault | Fault | YES | Stack operations  
13 | #GP | General Protection | Fault | YES | Memory reference  
14 | #PF | Page fault | Fault | YES | Memory reference  
15 | â€”- | Reserved |  | NO |  
16 | #MF | x87 FPU fp error | Fault | NO | Floating point or [F]Wait  
17 | #AC | Alignment Check | Fault | YES | Data reference  
18 | #MC | Machine Check | Abort | NO |  
19 | #XM | SIMD fp exception | Fault | NO | SSE[2,3] instructions  
20 | #VE | Virtualization exc. | Fault | NO | EPT violations  
21-31 | â€”- | Reserved | INT | NO | External interrupts  
ä» `32` åˆ° `255` çš„ä¸­æ–­æ ‡è¯†ç è®¾è®¡ä¸ºç”¨æˆ·å®šä¹‰ä¸­æ–­å¹¶ä¸”ä¸è¢«ç³»ç»Ÿä¿ç•™ã€‚è¿™äº›ä¸­æ–­é€šå¸¸åˆ†é…ç»™å¤–éƒ¨`I/O`è®¾å¤‡ï¼Œä½¿è¿™äº›è®¾å¤‡å¯ä»¥å‘é€ä¸­æ–­ç»™å¤„ç†å™¨ã€‚
å¦‚å‰æ‰€è¿°ï¼Œ`IDT`å­˜å‚¨ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†ç¨‹åºçš„å…¥å£ç‚¹ï¼Œå…¶ç»“æ„ä¸`Global Descriptor
Table`ç»“æ„ç±»ä¼¼ã€‚`IDT`çš„è¡¨é¡¹è¢«ç§°ä¸ºé—¨(`gates`)çš„æˆå‘˜ï¼Œå®ƒå¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ä¹‹ä¸€ï¼š
  * Interrupt gates(ä¸­æ–­é—¨)
  * Task gates(ä»»åŠ¡é—¨)
  * Trap gates(é™·é˜±é—¨)
åœ¨`x86`æ¶æ„ä¸‹ï¼Œä»…èƒ½ä½¿ç”¨[é•¿æ¨¡å¼](http://en.wikipedia.org/wiki/Long_mode)ä¸‹çš„`Interrupt
gates`æˆ–`Trap gates`èƒ½åœ¨`x86_64`ä¸­è¢«å¼•ç”¨ã€‚å°±åƒ `GDT`(å…¨å±€æè¿°ç¬¦è¡¨)ï¼Œ`IDT` åœ¨ `x86` ä¸Šæ˜¯ä¸€ä¸ª 8
å­—èŠ‚æ•°ç»„é—¨ï¼Œè€Œåœ¨ `x86_64` ä¸Šæ˜¯ä¸€ä¸ª 16 å­—èŠ‚æ•°ç»„é—¨ã€‚
`IDT` å¯ä»¥åœ¨çº¿æ€§åœ°å€ç©ºé—´å’ŒåŸºå€çš„ä»»ä½•åœ°æ–¹è¢«åŠ è½½ã€‚åŒæ—¶ï¼Œå®ƒéœ€è¦åœ¨ `x86` ä¸Šä»¥ 8 å­—èŠ‚å¯¹é½ï¼Œåœ¨ `x86_64` ä¸Šä»¥ 16 å­—èŠ‚å¯¹é½ã€‚`IDT`
çš„åŸºå€å­˜å‚¨åœ¨ä¸€ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨â€”â€”`IDTR`ä¸­ã€‚
åœ¨ `x86` ä¸Šæœ‰ä¸¤ä¸ªæŒ‡ä»¤`LIDT(Load Interrupt Descriptor Table`)ã€`SIDT(Store Interrupt
Descriptor Table)`æ¥ä¿®æ”¹ `IDTR` å¯„å­˜å™¨çš„å€¼ã€‚
æŒ‡ä»¤ `LIDT` ç”¨æ¥åŠ è½½ `IDT` çš„åŸºå€ï¼Œå³å°†æŒ‡å®šæ“ä½œæ•°å­˜åœ¨ `IDTR`ä¸­ã€‚
æŒ‡ä»¤ `SIDT` ç”¨æ¥åœ¨è¯»å– `IDTR` çš„å†…å®¹å¹¶å°†å…¶å­˜å‚¨åœ¨æŒ‡å®šæ“ä½œæ•°ä¸­ã€‚
åœ¨ `x86` ä¸Š `IDTR` å¯„å­˜å™¨æ˜¯ 48 ä½ï¼ŒåŒ…å«äº†ä¸‹é¢çš„ä¿¡æ¯ï¼š
    47                                16 15                    0
    +-----------------------------------+----------------------+
    |     Base address of the IDT       |   Limit of the IDT   |
    +-----------------------------------+----------------------+
## 0x03 IDT çš„åˆå§‹åŒ–
`IDT`ç”±`setup_idt`å‡½æ•°è¿›è¡Œå»ºç«‹åŠåˆå§‹åŒ–æ“ä½œ
### å¤„ç†å™¨å‡†å¤‡è¿›å…¥ä¿æŠ¤æ¨¡å¼(`go_to_protected_mode`å‡½æ•°åˆ†æ)
å¯¹IDTçš„é…ç½®åœ¨`go_to_protected_mode`å‡½æ•°ä¸­å®Œæˆï¼Œè¯¥å‡½æ•°é¦–å…ˆè°ƒç”¨äº†
`setup_idt`å‡½æ•°é…ç½®äº†IDTï¼Œç„¶åå°†å¤„ç†å™¨çš„å·¥ä½œæ¨¡å¼ä»å®æ¨¡å¼ç¯å¢ƒä¸­è„±ç¦»è¿›å…¥[ä¿æŠ¤æ¨¡å¼](http://en.wikipedia.org/wiki/Protected_mode)ã€‚ä¿æŠ¤æ¨¡å¼(`Protected
Mode`ï¼Œæˆ–æœ‰æ—¶ç®€å†™ä¸º
`pmode`)æ˜¯ä¸€ç§`80286`ç³»åˆ—å’Œä¹‹åçš„`x86`å…¼å®¹`CPU`æ“ä½œæ¨¡å¼ã€‚ä¿æŠ¤æ¨¡å¼æœ‰ä¸€äº›æ–°çš„ç‰¹è‰²ï¼Œè®¾è®¡ç”¨æ¥å¢å¼ºå¤šåŠŸèƒ½å’Œç³»ç»Ÿç¨³å®šåº¦ï¼Œåƒæ˜¯å†…å­˜ä¿æŠ¤ï¼Œåˆ†é¡µç³»ç»Ÿï¼Œä»¥åŠç¡¬ä»¶æ”¯æ´çš„è™šæ‹Ÿå†…å­˜ã€‚å¤§éƒ¨åˆ†çš„ç°ä»Š`x86`æ“ä½œç³»ç»Ÿéƒ½åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œï¼ŒåŒ…å«`Linux`ã€`FreeBSD`ã€ä»¥åŠå¾®è½¯
`Windows 2.0`å’Œä¹‹åç‰ˆæœ¬ã€‚
`setup_idt`å‡½æ•°åœ¨`go_to_protected_mode`å‡½æ•°ä¸­è°ƒç”¨ï¼Œ`go_to_protected_mode`å‡½æ•°åœ¨`/source/arch/x86/boot/pm.c#L102`ä¸­å®ç°ï¼š
    /*
     * Actual invocation sequence
     */
    void go_to_protected_mode(void)
    {
        /* Hook before leaving real mode, also disables interrupts */
        // é¦–å…ˆè¿›è¡ŒHookæ“ä½œè¿›è€Œä»å®æ¨¡å¼ä¸­è„±ç¦»ï¼Œç¦ç”¨ä¸­æ–­
        realmode_switch_hook();
        /* Enable the A20 gate */
        // å¯åŠ¨ A20 é—¨
        if (enable_a20()) {
            puts("A20 gate not responding, unable to boot...n");
            die();
        }
        /* Reset coprocessor (IGNNE#) */
        // é‡ç½®åå¤„ç†å™¨
        reset_coprocessor();
        /* Mask all interrupts in the PIC */
        // åœ¨ PIC ä¸­æ ‡è®°æ‰€æœ‰çš„ä¸­æ–­
        mask_all_interrupts();
        /* Actual transition to protected mode... */
        // å¼€å§‹è¿‡æ¸¡åˆ°ä¿æŠ¤æ¨¡å¼
        setup_idt();
        setup_gdt();
        // æ­£å¼è¿›å…¥ä¿æŠ¤æ¨¡å¼
        protected_mode_jump(boot_params.hdr.code32_start,(u32)&boot_params + (ds() 
    #include 
    #include 
    #include 
        .text
        .code16
    /*
     * void protected_mode_jump(u32 entrypoint, u32 bootparams);
     */
    SYM_FUNC_START_NOALIGN(protected_mode_jump)
        movl    %edx, %esi        # Pointer to boot_params table
        xorl    %ebx, %ebx
        movw    %cs, %bx