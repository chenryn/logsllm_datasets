### 事件前言
除了粉丝们对不同移动平台的喜爱之外，Android和iOS系统设备之间同样存在着其他明显的差异性：苹果系统的广告商将为苹果手机和平板电脑的使用者支付更多的广告费用。自`clickfraud`成为移动应用开发程序人员的主要收入来源以来，欺骗性的广告点击就成为恶意者获取利润的一种手段。
直到上个月SophosLabs公司偶然发现了22个移动应用程序的下载情况以来，`clickfraud`已经在`Google Play
Market`上托管并下载超过200万次。值得我们震惊的事实不是欺诈app并没有消失，而是数月或数年没有引起安全部门的关注。这些Android应用程序伪装成苹果设备向广告商索取高额的回报。
在我们的调查研究中，我们发现其中三个应用程序可以追溯至一年前，其中一个（手电筒应用程序）至少下载了一百万次。大多数这些恶意应用程序是在2018年6月及之后创建的。在最初的时候，这三个应用程序并不是恶意的，但是在6月份左右，这些应用程序中的clickfraud代码中被添加了木马。
谷歌在11月25日采取行动并从Play Market中删除了应用程序。 之后，这些应用无法再从官方Google商店下载，但其C2架构仍然有效。
此事件中所提及的应用（在本文末尾列出）仍然可以通过欺骗广告网络向应用创建者提供诈骗资金。
### 欺骗的关键特征
与已知广告相关的恶意软件相比，这些应用程序中的一些恶意功能被不断的改进：与前几代相比，它们拥有更好地持久性、灵活性，并且更具欺骗性。
如果命令和控制服务器指示他们检索其他文件，那么应用程序还可以在游戏过程中运行，并且被赋予下载的功能。
命令和控制服务器发送指令并指示恶意软件发送广告请求，这些请求伪装成为各种型号的移动手机上的应用。我们观察到clickfraud工具似乎是随机向Android和iOS手机模型进行网络报告。
这些恶意代码调用并不会导致那些预期的、破坏性的广告出现，否则会引起使用设备用户的关注。相反，恶意广告的调用是隐藏在浏览器窗口中的，应用程序会模拟用户与广告的交互行为。
对于用户来说，这些恶意程序的唯一影响就是会以更快的速度消耗手机的电池电量。由于用户无法将电量消耗的情况与恶意程序相关联，所以这些应用的Play
Market几乎没有显示负面评论。
恶意软件的灵活性是通过隐藏应用程序的真正来源而保证的，并以此来欺骗广告商。然而广告欺骗并不是用户所面临的唯一威胁。这些应用程序除了进行广告诈骗以外，还能够从C2服务器检索代码并下载程序。
此处显示的是Android调试器窗口，此时clickfraud代码正在广告商报告。而在Android虚拟设备中运行的应用与iPhone中运行的应用有所不同。
无论用户当前是否正在使用该应用，手机都会自动进行检索并“点击”此广告。由于存在这种恶意的功能，所以我们决定将这些文件归类为恶意文件。并将它们检测为`Andr
/ Clickr-AD`。
### clickfraud应用是如何工作的
我们检测到的`Andr / Clickr-AD`应用程序在设计之初就考虑了应用的最大灵活性和可扩展性。一切功能都可以通过应用程序的C2服务器进行配置。下面让我们来看看恶意软件的运作方式。
当用户首次启动应用程序时，它会向c2服务器发送`HTTP GET`请求。
    http[://]sdk.mobbt.com/auth/sdk/login
服务器返回一个JSON格式的命令列表，它被称之为“sdk”。每个命令都包括下载“sdk”模块的URL、要调用的类和方法名称以及模块传递给方法所使用的参数。
以下是C2服务器的响应情况：
在此响应中，服务器告诉客户端下载并运行“rtb”或“mpb”模块。
对于每个模块，C2指定要下载URL的“libpath”字段，以及“sdk_data”字段中的类名、方法名和参数。
C2还控制应用程序以“exp”字段中所指定的时间间隔来更新指令。
在上面的示例中，应用程序等待10分钟（600秒）后再联系服务器以获取其sdk。
    JSONArray v11_2 = v11_1.optJSONArray("sdk_data");
        while(v2 
它将同步适配器设置为定期运行。
    long v4 = SyncUtils.prefs.getSyncPeriodicFrequency();
        Log.d("SyncUtils", "init frequency: " + String.valueOf(v4));
        v2_1.putBoolean("syncIdentifier:" + SyncUtils.mAccountName, true);
        ContentResolver.addPeriodicSync(v1_2, SyncUtils.mContentAuthority, v2_1, v4);
之后应用会从服务器接收恢复应用程序的间隔。 在我们所分析的例子中，间隔被设定为3分钟。
    if(v11_1.has("sync")) {
            v0_1 = v11_1.optLong("sync");
            if(this.preferences.getSyncPeriodicFrequency() != v0_1) {
                this.preferences.setSyncPeriodFrequency(v0_1);
                Utils.updateSyncFrequency(this.context, v0_1);
            }
        }
如果应用尚未被启动，那么app会从“sync：180”参数中读取时间，并每三分钟启动一次。
### Andr / Clickr-ad的演变
在上面分析的22个应用程序中有19个是在2018年6月之后创建的。自第一个版本以来，大多数应用程序都包含“sdk”下载功能。
三个旧应用程序`com.sparkle.flashlight`，`app.mobile.justflashlight`和`com.takatrip.android`是在2016年和2017年创建的。而早期版本是没有安全问题的。
具有sdk下载功能的早版本于2018年3月被发现。这表明开发这些应用程序的作者能够决定具体的攻击时间。然而我们无法分辨出具体的服务器响应。
但是，通过分析March版本的下载代码我们发现，开发者似乎只使用了“`rtb`”sdk模块。
2018年6月的版本与目前的版本更为接近。名为`mpb.jar`的空文件开始包含在`assets`文件夹中。
很可能`“mpb”sdk`模块从那时开始具有了恶意性。
### 结论
`Andr / Clickr-ad`是一种具有良好的组织性、持久性恶意软件。其有可能对用户的整个Android生态系统造成严重伤害。这些应用会产生欺诈性请求，导致广告网络因虚假点击而产生大量非法收入。
从用户的角度来看，由于应用程序在后台不断运行并与服务器通信，所以这些应用程序耗尽了手机的电量，并可能导致数据过剩的情况出现。此外，设备完全由C2服务器控制，并且可以根据服务器的指令在用户手机中安装恶意模块。
### IOC
    本文为翻译稿件，原文为：https://news.sophos.com/en-us/2018/12/06/android-clickfraud-fake-iphone/