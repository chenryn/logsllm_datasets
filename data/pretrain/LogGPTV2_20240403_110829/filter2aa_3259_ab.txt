. å­˜å‚¨ç»„ä»¶
. å®‰å…¨ Agent
å…¶ä¸­ï¼Œkube-system/kube-proxy æ˜¯ Kubernetes çš„é»˜è®¤è®¾è®¡ï¼Œä»–çš„ ServiceAccount â¼€èˆ¬ä¸åšä¿®æ”¹ï¼Œåˆ©â½¤ä»·å€¼
æœ‰é™ã€‚
3. ææƒ
node_to_clusteradmin-å¦‚ä½•ä»KubernetesèŠ‚ç‚¹æƒé™æå‡â¾„é›†ç¾¤ç®¡ç†å‘˜æƒé™.md
5/23/2022
5 / 8
æœ€ç»ˆæˆ‘ä»¬å‘ç°å…¶ä¸­â¼€ä¸ª DaemonSet: å®‰å…¨ Agentï¼Œå…¶é…ç½®â½‚ä»¶â¾¥ç»™ ServiceAccount è®¾ç½®äº† RBAC æƒé™ï¼Œç»‘å®š
äº†â¼€ä¸ªæƒé™è¾ƒâ¼¤çš„ Cluster roleï¼Œå¹¶ä¸”å¯ä»¥ list å’Œ get secret ä¿¡æ¯ã€‚è™½ç„¶ï¼Œå…¶ä»– DaemonSet çš„
ServiceAccount ä¹Ÿè®¾ç½®äº†ä¸åŒ RBAC æƒé™ï¼Œä½†å½“æˆ‘ä»¬æ‹¥æœ‰äº† kube-system å‘½åç©ºé—´ä¸‹çš„ Secret æƒé™æ—¶ï¼Œæˆ‘
ä»¬å°±ç­‰åŒæ‹¥æœ‰äº† K8s Cluster Admin çš„æƒé™ã€‚ä¹Ÿç”±äºæˆ‘ä»¬æœ¬æ¬¡çš„é¶æ ‡åœ¨é›†ç¾¤å†…ï¼Œæ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬è¾¾æˆäº†â½¬æ ‡ã€‚
ï¼ˆç”»å¤–â¾³ï¼šè¿™ä¸ª DaemonSet è¿˜é…ç½®äº†å¾ˆå¤šé‡å¤ä¸”æ‚ä¸ƒæ‚â¼‹çš„ Capabilityï¼Œå®‰å…¨ Agent é…ç½®ç‰¹å®šçš„ Capability
æ¥æå‡æƒé™å¹¶ä¸å°‘â»…ï¼Œä½†ç ”å‘è€…å¯èƒ½å¹¶ä¸èƒ½å¾ˆå¥½çš„æŠŠæ¡æ¯ä¸ª Capability çš„ä½œâ½¤ï¼Œæœ‰äº›ç”šâ¾„é…ç½®äº†ç‰¹æƒå®¹å™¨ä»¥
æ±‚â½…ä¾¿ã€‚ç”±äº DaemonSet çš„é…ç½®â¼€èˆ¬ä¸ä¼šç»ç”± PodSecurityPolicy æˆ– K8s Admission Webhook æ‰€é™åˆ¶ï¼Œæƒ
é™è¿‡â¼¤å’Œæƒé™æ»¥â½¤çš„æƒ…å†µè¿˜æ˜¯â½è¾ƒå¤šçš„ï¼Œå»ºè®®é›†ç¾¤ç®¡ç†å‘˜ä¹Ÿæ³¨æ„æ­¤å¤„çš„æƒé™æ”¶æ•›ã€‚
è¿™â¾¥çº¢é˜Ÿæœ‹å‹ä»¬å¯ä»¥ä½¿â½¤â¼€æ¡ç®€å•çš„å‘½ä»¤æ¥æµ‹è¯•å½“å‰çš„æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å®¹å™¨çš„ ServiceAccount æ˜¯å¦æ‹¥æœ‰åˆ—ä¸¾
Secret çš„æƒé™ï¼Œâ½è¾ƒå¥½çš„â½…å¼æ˜¯ä½¿â½¤ kubectl auth can-i æ¥æ£€æµ‹ï¼Œä½†èŠ‚ç‚¹å’ŒPODä¸Šâ¼€èˆ¬ä¸å®‰è£… kubectlï¼Œæ‰€ä»¥
æˆ‘æ›´å€¾å‘â½¤ curl è¿›â¾ç®€å•æµ‹è¯•ã€‚
docker ps | grep -v "/pause" | awk -F" " '{print $1}' | grep -v CONTAINER 
| while read line; do echo $line; docker exec -t $line sh -c 'curl -k 
"https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT/api/v1/namespac
es/kube-system/pods?limit=2" -H "Authorization: Bearer `cat 
/var/run/secrets/kubernetes.io/serviceaccount/token`"'; done; 
å½“ç„¶ï¼Œè¿™ä¸ªâ½…æ³•å¹¶ä¸ä¼˜é›…ï¼›ç†Ÿæ‚‰æˆ‘çš„åŒå­¦çŸ¥é“æˆ‘è¿˜ç»´æŠ¤äº†â¼€ä¸ªå®¹å™¨å®‰å…¨â¼¯å…· ğŸ“¦  CDKï¼Œé›†æˆäº†å¾ˆå¤šå®¹å™¨å’Œ
Kuberneteså®‰å…¨æµ‹è¯•çš„ç‰¹æ€§ï¼›æœ‰â¼€ä¸ªåŠŸèƒ½â€œæ£€æµ‹èŠ‚ç‚¹ä¸Š ServiceAccount å¯â½¤äºææƒçš„æƒé™â€â¼€ç›´èººåœ¨æˆ‘çš„
TODO â¾¥ï¼Œä½†â¼€ç›´æ²¡å¾—ç©ºå»å®ç°å‡ºæ¥ï¼Œæ¬¢è¿PRï¼Œæˆ–è€…å‚¬æˆ‘æ›´æ–°ğŸ˜­
é™¤äº†åˆ—ä¸¾å’ŒæŸ¥çœ‹ secret çš„æƒé™ï¼Œè¿˜æœ‰å¾ˆå¤šé›†ç¾¤å†…çš„â½¬æ ‡å’Œæƒé™ä¸ Cluster Admin ç­‰ä»·ï¼Œæˆ‘ä¹‹å‰ç”»äº†â¼€å¼ å›¾å¯
ä»¥ä½œä¸ºå‚è€ƒï¼š
node_to_clusteradmin-å¦‚ä½•ä»KubernetesèŠ‚ç‚¹æƒé™æå‡â¾„é›†ç¾¤ç®¡ç†å‘˜æƒé™.md
5/23/2022
6 / 8
é”…ä¸èƒ½å…¨ç»™é›†ç¾¤ç®¡ç†å‘˜
çœ‹åˆ°è¿™â¾¥ï¼Œâ¼¤å®¶å¯èƒ½ä¼šè®¤ä¸ºè¿™â¾¥é—®é¢˜ä¸»è¦æ˜¯é›†ç¾¤ç®¡ç†å‘˜çš„é”™è¯¯é…ç½®å¯¼è‡´çš„ã€‚å…¶å®ä¸ç„¶ï¼Œå¾ˆå¤šé›†ç¾¤åœ¨ä»äº‘â¼šå•†
è´­ä¹°ä¸‹æ¥çš„æ—¶å€™å°±å·²ç»å†…ç½®äº†â¼€äº› DaemonSetï¼Œâ½¤æ¥å¢å¼ºé›†ç¾¤å’ŒèŠ‚ç‚¹ä¸Šçš„èƒ½â¼’ï¼Œæå‡è¿ç»´å’Œâ½¹ç»œé€šè®¯çš„æ•ˆ
ç‡ï¼›è¿™â¾¥ä¸ä¹é”™è¯¯é…ç½®çš„æƒ…å†µï¼ŒAKS(å¾®è½¯), EKS(AWS), GKE(Google), OpenShift æ­¤å‰éƒ½æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œè½»åˆ™
å¯ä»¥æ§åˆ¶PODï¼Œé‡åˆ™å¯ä»¥ææƒâ¾„ Cluster Admin æƒé™ï¼›åŒæ—¶åƒ Antrea, Calico, Cilium, WeaveNet è¿™äº›åº”â½¤â¼´
æ³›çš„ CNI æ’ä»¶ä¹Ÿå­˜åœ¨å¯ä»¥ææƒâ¾„ Cluster Admin æƒé™çš„é—®é¢˜ï¼›ä¸è¿‡ç°åœ¨éƒ½ä¿®çš„å·®ä¸å¤šäº†ï¼Œè¿™å— Palo Alto
Networks çš„ç ”ç©¶å‘˜ä»¬æ¢³ç†çš„æœ€å¥½ï¼Œâ¼¤å®¶å¯ä»¥çœ‹ä»–çš„ç»“æœã€‚
è¿™å—ä¹Ÿæ˜¯æˆ‘å»å¹´çš„æ„éš¾å¹³å‘€ï¼Œå¯æƒœå½“æ—¶æ²¡é’±ä¹Ÿæ²¡æ—¶é—´æï¼Œå…¶å®æ˜¯â¼€ä¸ªå¾ˆä¸é”™çš„ bugbounty IDEAã€‚å›½å†…çš„å¹³å°
ä¼°è®¡ä¹Ÿä¼šæœ‰åŒæ ·çš„é—®é¢˜ï¼Œä¸è¿‡å›½å†…çš„æ¼æ´èµâ¾¦è®¡åˆ’å¯¹é›†ç¾¤å†…çš„æƒé™æå‡é—®é¢˜å¹¶ä¸å…³æ³¨ï¼Œæ‰€ä»¥ç»™åˆ°çš„å¥–åŠ±ä¼šå¾ˆ
æœ‰é™ï¼Œæˆ‘å°±ä¸â¼€â¼€å»æµ‹äº†ï¼›å¦‚æœé‚£å®¶çš„å¸ˆå‚…è§‰å¾—å¯ä»¥ç»™åˆ°ä¸é”™çš„èµâ¾¦å¯ä»¥å’Œæˆ‘è¯´â¼€ä¸‹ï¼Œæˆ‘æ¥è¯•è¯•çœ‹èƒ½ä¸èƒ½æ‰¾
åˆ°å¯ä»¥ææƒçš„ç‚¹ã€‚
æœ¬â½‚æåˆ°çš„æˆ‘å†å²çš„PPTå¯ä»¥åœ¨ https://github.com/neargle/my-re0-k8s-security/tree/main/slide æŸ¥çœ‹ï¼Œæˆ‘æŠŠ
Palo Alto Networks PPT ä¹Ÿé™„åœ¨â½‚æœ«äº†ï¼Œâ¼¤å®¶å¯ä»¥å‚è€ƒã€‚ç¬¬ä¸‰â½…çš„PPTæˆ‘å°±ä¸æ”¾ Githubäº†ï¼Œæœ‰ç‚¹ä¾µæƒã€‚
é™¤äº† CNI æ’ä»¶å’Œå®‰å…¨ç»„ä»¶ï¼Œâ½‡å¿—ç»„ä»¶çš„ DaemonSet é»˜è®¤é…ç½®ä¹Ÿç»å¸¸é…ç½®è¿‡â¼¤çš„æƒé™å’ŒæŒ‚è½½è¿‡â¼¤çš„â½¬å½•ï¼Œå¦‚
å¾ˆå¤šâ¼ˆä½¿â½¤ filebeat é…ç½®ï¼š
apiVersion: apps/v1
kind: DaemonSet
node_to_clusteradmin-å¦‚ä½•ä»KubernetesèŠ‚ç‚¹æƒé™æå‡â¾„é›†ç¾¤ç®¡ç†å‘˜æƒé™.md
5/23/2022
7 / 8
metadata: 
  name: filebeat-logsystem 
  namespace: kube-system 
  labels: 
    k8s-app: filebeat
spec: 
  template: 
    metadata: 
      labels: 
        k8s-app: filebeat 
    spec: 
      serviceAccountName: filebeat 
      terminationGracePeriodSeconds: 30 
      hostNetwork: true 
      dnsPolicy: ClusterFirstWithHostNet 
      containers: 
      - name: filebeat 
        image: docker.elastic.co/beats/filebeat:%VERSION% 
        args: [ 
          "-c", "/etc/filebeat.yml", 
          "-e", 
        ] 
        env: 
        - name: ELASTICSEARCH_HOST 
          value: elasticsearch 
        - name: ELASTICSEARCH_PORT 
          value: "9200" 
        - name: ELASTICSEARCH_USERNAME 
          value: elastic 
        - name: ELASTICSEARCH_PASSWORD 
          value: changeme 
        - name: ELASTIC_CLOUD_ID 
          value: 
        - name: ELASTIC_CLOUD_AUTH 
          value: 
        - name: NODE_NAME 
          valueFrom: 
            fieldRef: 
              fieldPath: spec.nodeName 
        securityContext: 
          runAsUser: 0 
          # If using Red Hat OpenShift uncomment this: 
          privileged: true 
        resources: 
          limits: 
            memory: 200Mi 
          requests: 
            cpu: 100m 
            memory: 100Mi 
        volumeMounts: 
        - name: logpath 
          mountPath: /hostfs/ 
      volumes: 
      - name: logpath 
node_to_clusteradmin-å¦‚ä½•ä»KubernetesèŠ‚ç‚¹æƒé™æå‡â¾„é›†ç¾¤ç®¡ç†å‘˜æƒé™.md
5/23/2022
8 / 8
        hostPath: 
          path: /
å½’æ ¹ç»“åº•ï¼Œè¿˜æ˜¯æœ€â¼©æƒé™åŸåˆ™çš„é—®é¢˜ã€‚â½¼â½£å¸¸è°ˆäº†ï¼Œä½†åœ¨ Kubernetes çš„å®è·µâ¾¥å´â¼œæœ‰å¾ˆå¤šæ–°çš„ä¸œâ»„éœ€è¦å®‰å…¨
ä»ä¸šè€…ä»¬å»æŠŠæ¡ã€‚è¿™â¾¥è¿˜æ˜¯æœ‰æŒºå¤šæœ‰è¶£çš„ç‚¹çš„ï¼Œå¸Œæœ›è¿˜æœ‰æœºä¼šå’Œâ¼¤å®¶èŠèŠã€‚