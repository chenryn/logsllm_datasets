**4.2.1 启用无障碍辅助服务**
I.
此类木马在启动后，会诱骗用户开启无障碍辅助服务(AccessibilityService)。此服务设计初衷在于帮助残障用户使用android设备和应用，启动后在后台运行，可以监听用户界面的状态。如下图所示：
图4-2-1 诱骗用户开启无障碍辅助服务
此恶意程序通过此服务监听用户手机界面变化，同时会禁止用户查看应用程序列表，禁止用户关闭无障碍模式，阻止用户卸载此应用。一般用户极难卸载此类木马。
II. 开启无障碍辅助服务后，TeaBot会请求敏感的android权限，如上图：
权限 |  | 功能 |  
---|---|---|---  
监测您的操作 |  | 用于拦截和监视用户的操作 |  
检索窗口内容 |  | 用于正在访问的窗口内容，如登录凭证、短信等 |  
执行手势 |  | 可执行操作手势 |  
III.
接受请求的权限后，恶意应用程序将从设备中删除自身的图标。删除图标后，此恶意程序依然在后台运行，与C&C服务器通信并持续监控和窃取用户数据，然而用户却并不知情。
**4.2.2 在后台与C &C服务器通信**
**4.2.2.1 使用http协议通信**
通过抓包发现恶意程序和C&C之间的通信使用的是http协议。服务器地址：185.215.***.31:80
图4-2-2 wireshark抓包数据
​如图所示，根据其网络通讯内容和功能，将与C&C服务器的通信分为3个阶段：
1）Uricontent：/api/botupdate
从抓包数据中可以发现，TeaBot恶意软件每10秒钟发送一次POST请求，其中包含有关受感染设备的所有信息（图4-2-7网络数据加密部分详解）。
图4-2-3 第一次请求botupdate
C&C服务器返回信息使用异或XOR解密，如下图：
图4-2-4 C2返回信息解密
该响应通常由配置更新组成（例如C2地址，远控命令启动等）。
2）Uricontent：/api/getkeyloggers
每10秒钟TeaBot执行一次GET请求，以检索跟踪记录功能所收到的应用程序列表。
图4-2-5 第二次请求getkeyloggers
3）Uricontent：/api/getkeylogge
TeaBot发送包含受感染设备上安装的所有程序包名称的JSON文件（未加密）的POST请求。通过这些信息，C&C服务器就能知道是否有一个或多个目标应用程序，并响应下载相关的注入。
图4-2-6 第三次请求getbotinjects
**4.2.2.2 使用XOR异或加密流量**
通过逆向恶意代码模块，发现其加密部分使用了XOR异或加密。
图4-2-7 网络数据加密部分详解
**4.2.2.3 远控命令**
恶意程序通过onAccessibilityEvent方法实施远控操作，包含的远控指令，如下表所示：
**指令** |  | **功能** |  
---|---|---|---  
app_delete |  | 从包名称中删除一个应用程序 |  
ask_syspass |  | 显示生物识别授权弹出窗口 |  
ask_perms |  | 向用户请求权限 |  
change_pass |  | 显示一条提示消息（小弹出窗口），通知用户更新密码（锁定模式） |  
get_accounts |  | 在Android设置中获取帐户 |  
kill_bot |  | 自行删除 |  
muute_phone |  | 使设备静音 |  
open_activity |  | 通过包名打开一个应用程序 |  
open_inject |  | 执行覆盖攻击，打开注入（html负载） |  
reset_pass |  | 功能缺失 |  
start_client |  | 设置一个IP和PORT，用于通过屏幕截图观察受感染的设备 |  
swipe_down |  | 执行手势，例如在屏幕上滑动 |  
grab_google_auth |  | 打开并在Google Auth应用中获取code |  
activate_screen |  | 启用屏幕。TeaBot能够控制设备的屏幕（例如，能够使屏幕保持暗淡状态） |  
表4-2远控指令列表
### **4.3 服务器地址**
**服务器地址** |  | **分布区域** |  
---|---|---|---  
185.215.***.31 |  | 英国（塞舌尔 英吉利河 维多利亚） |  
Kop***apalo.xyz |  | 比利时（域名解析：35.205.**.67） |  
Sepo***kotop.xyz |  | 德国（域名解析：87.106.**.146） |  
表4-3 服务器地址分布
## 5\. 应用危害
此类银行木马的危害十分严重，一旦安装后，用户的所有信息将被窃取，并且还会实时的监控用户的使用状态、截屏上传服务器。此木马最大的危害是对银行信息的窃取，其使用的覆盖攻击可以以假乱真，在用户不知情的情况下，轻松获取用户的凭证和短信信息。对用户造成财产损失。虽然目前TeaBot只是针对欧洲银行，但是不排除会增加其他国家的银行注入，所以此类木马家族还需要持续关注。
## 6\. 安全建议
  1. 此恶意软件对自身实时了保护，用户通常难以卸载。
（1）立即关闭所有网络连接（断开手机移动网络和wlan），在未删除app前，建议禁止网络连接；
（2）使用adb指令删除恶意软件；
（3）如果以上方法都无法删除，备份一些重要数据到电脑，然后恢复出厂设置。
  1. 用户安装所需软件，建议去正规的应用市场下载、去官方下载。
  2. 在手机当中安装必要的安全软件，并保持安全软件更新。
  3. 关注“暗影安全实验室”微信公众号，我们将持续关注安全事件。