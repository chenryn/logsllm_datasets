找出任何大于它们实际应该花费时间的查询。如果发现一个查询拖
周而复始地循环执行。然后你可以根据命令的出现监视它们，由此
连人。
processlist命令，它会列出当前MySQL 活动进程的全部信息。这里
到查询的问题所在，然后再想办法优化。
了多少行以及检查了多少行。带着这些信息回到应用程序当中，找
其查询信息，如执行这个查询的用户、查询内容和锁的次数、发送
第9章
另外一个确定MySQL查询问题的方法是使用mysqladmin
$mysqladmin-u root-pkil1 2663
你也可以添加-i选项以及秒数，这样，命令就会根据这个秒数
$mysqladmin-u root-p processlist
当出现比你预设的阈值长的查询，就可以在日志中看到它们及
Tcpport:3306Unix socket:/var/run/mysqld/mysqld.sock
/usr/sbin/mysqld, Version: 5.1.63-0ubuntu0.10.04.1-log (Ubuntu)). started with:
|Id|User丨Host
Enter password:
|2663丨root|
------+------—-----------+-----------+---------+------+-------+-----------------
Time
2686|root|localhost
为什么数据库这么慢？追踪数据库问题
Id Command
|db
Argument
| Command|Time | State |Info
Query
10
180
Ishow processlist
--
---
## Page 180
不同的是，PostgresSQL 以毫秒为单位记录这个值，而不是秒。不
所有查询时间大于100毫秒的查询，应该将这个值设置为如下所示：
超过由 log_min_duration_statement 设置的特定阈值的查询。如果这
录全部查询；如果设置为任何比0大的值，那么它就会记录所有以
9.4.2
志中静态数据收集查询的内容。
库的响应速度。比如说将这个值设置为1的时候，它甚至会采集日
要将这个阈值设置得过低，除非你想通过记录所有内容来拖慢数据
会看到所有大于这个阈值的查询都出现在日志中。记住与MySQL
毫秒为单位查询时间比这个值大的查询记录。所以，如果想要记录
个值设置为－1，那么它不会记录任何查询；如果设置为0，就会记
PostgresSQL 为你提供了记录全部查询的选择，不仅仅是那些
2012-07-12 11:02:00 PDT LOG:duration:28.964 ms Statement: select from
设置完毕，重启 PostgresSQL 服务后更改才会生效。之后你就
2012-07-12 11:02:12 PDT L0G:duration:39.845ms statement: select  from
log_min_duration_statement=100
pg_stat_activity;
-pg_stat_all_tables;
 PostgresSQL
9.4识别查询缓慢的问题·173
---
## Page 181
件问题。
起——硬盘驱动器和RAM，然后继续讲解如何解决其他常见的硬
溃，那可能不是代码的问题而是内存的问题。
的原因不是因为代码问题，而是因为网卡损坏，那么你可能会为
损坏，难道你不想知道吗？如果你知道网络应用程序无法正常工作
这一块，如果你能提前发现一台很重要的服务器的硬盘驱动器即将
所以拥有硬件故障排除技能非常有价值。毕竞，无论是谁负责硬件
管辖范围，但因为DevOps 团队中每个人的工作内容都非常相近
发人员或者测试人员，你可能会认为硬件问题应该是系统管理员的
理机器上，而物理机器也有它们自己的问题。虽然如果你是一名开
以及确认和解决这些问题的步骤。首先从常见的硬件故障问题讲
自己节省数小时甚至数天的调试时间。如果应用程序无缘无故地崩
这是硬件问题！诊断常见的硬件问题
第10章
本章将会介绍你可能会碰到的一些很常见的硬件故障问题
DevOps 的领域主要是软件，但是最后这些软件都要运行在物
---
## Page 182
时候会发出警告。它与众多硬件提供商提供的工具的不同之处在
Analysis and Reporting Technology，自我监测分析与报告技术），它
测试工具，但是现代硬件驱动器也支持SMART（Self-Monitoring,
有很多冗余磁盘。虽然硬件驱动器制造商有它们自己的硬件驱动器
务器采用RAID（Redundant Arrays of Inexpensive Disks，磁盘阵列），
寿命之前损坏，那它极有可能是硬件驱动器。这就是为什么很多服
组件中最容易出问题的一个。如果某个硬件可能会在达到正常工作
动器。在 smartctl 中使用-H选项可以检查驱动器的健康状况。
装了这个包，就可以运行一个名为 smartctl的程序扫描整个硬盘驱
例如基于Debian 的版本，这个包的名字为 smartmontools。一旦安
使用包管理工具在其中搜索关键字“smart”就可以找到这个工具。
康程度。
会监视整个硬件驱动器的健康状况，并且当硬盘驱动器即将损坏的
10.1硬盘驱动器无法工作
返回驱动器的一些故障或者警告：
于，在不重启系统的情况下就能使用SMART检查硬盘驱动器的健
SMART工具能够在任何主流Linux发行版上使用，所以仅需
众多不同的组件构成了一台服务器，但硬盘驱动器一直是这些
在这个例子中，硬盘驱动器很健康，但是 smartctl也许仍然会
$sudo smartct1-H/dev/sda
ID#ATTRIBUTE_NAME
Home page is http://smartmontools.sourceforge.net/
smartct1 version 5.38[x86_64-unknown-1inux-gnu]Copyright（C)2002-8Bruce A1len
$sudo smartct1-H/dev/sda
SMART Health Status: OK
Home pageishttp://smartmontools.sourceforge.net/
smartct]version 5.37[i686-pc-linux-gnu] Copyright(C)2002-6 Bruce A1len
Pleasenote the following marginal Attributes:
=START OFREAD SMART DATA SECTION
FLAG
VALUE WORST THRESH TYPE
10.1
硬盘驱动器无法工作·175
UPDATEDWHEN_FAILED RAW_VALUE
---
## Page 183
176
第10章
项可以一次性获得硬盘驱动器的全部SMART信息。
可以查看 sudo fdisk-1命令的输出。它会列举出能够检测到的全部
样才能检查所有的驱动器。如果不确定系统中有哪些硬盘驱动器，
驱动器，所以你可能需要将它更改为/dev/sdb 或者其他驱动器，这
何软件 RAID 分区（/dev/mdX设备）。
磁盘和分区，但是请记住它也会显示虚拟磁盘，比如说你设置的任
警告。这两个例子都指向了位于/dev/sda的 smartctl，系统中的第
硬盘气流温度（它是外层气流，还可以使用更好的气流度量值）的
一个SCSI（小型计算机系统接口，SmallComputerSystemInterface
也可以在 smartctl 中用-a选项获取更详细的硬件信息，这个选
在这个例子中，硬盘驱动器通过了测试，但是返回了一个关于
190 Airflow_Temperature_Cel 0x00220560370450ld_age AlwaysIn_the_past 44
Self-test execution status:
Ooffline data collection status:(0x82）Ooffline datacollectionactivity
General SMARTValues:
Local Time is:
ATA Standard is:
ATA Version is:
Model Family:
smartct1version5.38[x86_64-unknown-1inux-gnu]Copyright（C)2002-8Bruce A1len
$sudo smartctl-a/dev/sda
Seevendor-specificAttributelistfor marginal Attributes.
SMARToverall-health self-assessmenttestresult:PASSED
=START OF READ SMART DATA SECTION===
Jser Capacity:
irmware Version:3.AAD
Serial Number
Device Model:
(Lifetime Min/Max 20/50)
这是硬件问题！诊断常见的硬件问题
Seagate Barracuda 7200.10 family
Available- device has SMART capability.
Sun Ju11514:03:442012PDT
Exact ATA specification draft version not indicated
In smartct] database [for details use:-P show]
400,088,457,216 bytes
3QH01QZ3
ST3400620AS
(0) The previous self-test routine completed
Auto Offline Data Collection:Enabled.
---
## Page 184
Error logging capability:
SMART capabilities:
capabilities:
Offline data collection
data collection:
Total time to complete Offline
ID#A
VendorSpecificSMART Attributeswith Thresholds:
Short self-test routine
202T
194Temperature_Celsius
recommended polling time:
Extended self-testroutine
6
99
recommendedpolling time:
(0160 0)
(Lifetime Min/Max20/50)
ARTAttributes Data Structure revision number:10
TA_Increase_Count
Hardware_ECC_Recovered
Airflow_Temperature_Cel 0x0022
Multi_Zone_Error_Rate
UDMA_CRC_Error_Count
offline_Uncorrectable
High_Fly_Writes
RealTocated_Sector_Ct
Spin_Up_Time
Raw_Read_Error_Rate
ATTRIBUTE_NAME
Current_Pending_Sector
Reported_Uncorrect
Spin_Retry_Count
Seek_Error_Rate
Power_Cycle_Count
ower_On_Hours
tart_Stop_Count
0x001a
0x0022
0x0033
0x0032
0x0003
0x000f
FLAG
0x0032
0x0000
0x003e
0x0010
0x0012
0x003a
0x0032
0x0032
0x0013
0x0032
0x000f
(0x0003)
（132）minutes.
(0x01) Error logging supported.
(430) seconds.
(0x5b）s
040063
1) minutes.
VALUE WORST THRESH TYPE
00
6
000
0
Auto Offline data collection on/off support.
SMART execute Offline immediate.
General Purpose Logging supported.
SavesSMART data before entering
without error orno self-test has ever
Supports SMART auto save timer.
Selective Self-test supported.
Self-test supported.
Offline surface scan supported.
power-saving mode.
No ConveyanceSelf-testsupported
Suspend Offline collection upon new
been run.
command.
68
000
006
00g
00g
00
09
00
00
00
20
0
68
Pre-fai1
01d_age
0ld_age
01d_age