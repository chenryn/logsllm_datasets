livosys-lato
IWXr-xI-X.
1root root 7.8K3月292019network
1root
root4.5K3月
292819
netconsole
-TWXI-XI-X.
TW-====,
root1.2K8月
82819README
[helper@centos-7 ~]$
●chkconfig --list
---
## Page 214
[helper@centos-7 ~]$ sudo chkconfig --list
注：该输出结果只显示SysV服务，并不包含
原生Systemd服务。SysV配置数据
可能被原生systemd配置覆盖。
要列出systemd 服务，请执行'systemctl list-unit-files
查看在具体target启用的服务请执行
'systemctl list-dependencies [target]'。
livesys
0：关
1：关
2:关
3:开
4:开
5:开
6：关
livesys-late
0：关
1：关
2:关
3：开
4:开
5：开
6：关
netconsole
0：关
1：关
2:关
3：关
4:关
5：关
6:关
network
0：关
1：关
2:关
3：关
4:关
5:关
6：关
[helper@centos-7 ~]$
/etc/profile
---
## Page 215
[helper@centos-7 -]S cat /etc/profile
/etc/profile
Systen wide environment and startup prograns, for 1ogin setup
Functions and aliases go in /etc/bashrc
It's NOT a good idea to change this f11e unless you know what you
/etc/profile.d/ to make custon changes to your environnent,as this
are doing. It's much better to create a custom.sh shell script in
i11 prevent the need for merging In future updates.
Dathnunge(）{
case *:S(PATH):* in
*:*$1*:*)
)
f[*s2*=*after*]; then
else
PATH=$PATH:S1
PATH=$1:SPATH
fi
esac
if[-x/usr/bin/id ]; then
if [ -z *SEUID*
ksh workaround
1:then
EUID=/usr/bin/id-u
UIO=/usr/bin/id -ru
USER=**/usz/bin/id -un'*
f1
MAIL=*/var/spoo1/ne11/$USER*
LOGNAME=SUSER
if[“sEUto=*e]；then
Path nanipulation
pathnunge /usr/local/sbin
pathmunge /usx/sbin
pathnunge /usr/sbin after
HOSTNAME= /usr/bin/hostnane 2>/dev/nu11*
1s0
export HISTCONTROL=ignoreboth
export HISTCONTROL=1gnoredups
1
export PATH USER LOGNAME MAIL HOSTNANE HISTSIZE HISTCONTROL
Qurrent threshold for system reserved uid/gids is 2ee
You could check uidgid reservation validity in
/usr/share/doc/setup
*/uidgid file
lse
umask 022
forin /etc/orofile,d/*.sh /etc/profile.d/sh.1ocal : do
if [ *s（=#i1=*s= ]; then
e1se
'si"
.*Si* >/dev/nul1
fi
Duo
unset -f pathnunge
unset i
[heloerDcentos7
---
## Page 216
Functions and aliases go in /etc/bashrc
# It's Nor a good idea to change this file unless you know what you
# are doing. It's much better to create a custom.sh shell script in
# /etc/profile.d/ to make custom changes to your environment, as this
# will prevent the need for merging in future updates.
pathmunge (){
*:"$1*:*)
*)
if 丨*$2"=“after”]; then
PATH=$PATH:$1
else
PATH=$1: $PATH
esac
if [ =x /usr/bin/id ]; then
if [ =z “$EUID" ]; then
 ksh workaround
EUID=^/usr/bin/id =u
UID=~/unr/bin/id =ru
fi
USER=**/usr/bin/id =un^*
LOGNAHE=$USER
MAIL=*/var/spool/mail/$usER"
fi
 Path manipulation
ua i[ 0. = a1nas. 1 3T
pathmunge /usr/sbin
pathmunge /usr/local/sbin
else
pathmunge /usr/local/sbin after
pathnunge /usr/sbin after
fi
HOSTNAME=^ /usr/bin/hostname 2>/dev/nul1
HISTSI2E=1000
export HISTCoNTROL=ignoreboth
else
fi
exPOIt PATH USER LOGNANE MAIL HOSTNAME HISTSIZE HISTCONTROL
---
## Page 217
Current threshold for system reserved uid/gids is 200
 You could check uidgid reservation validity in
#/usr/share/doc/setup=*/uidgid file
uq f[un=p/urq/xsn/.=.、ub=p/uq/xsn/1s[ 66T b=aIns ] T
umask 002
else
umask 022
for i in /etc/profile.d/+,sh /etc/profile.d/sh.local ; do
if [ =r “$i" ]; then
uq[=$=1{#=)s。]
."$i"
else
Tnu/Aap/
Options Indexes FollowSymilinks
AllowOverride Mane
Require all granted
Deny Frdm/10.211.55.2
重启apache后，再次访问如下
---
## Page 221
不
→
C
不安全10.211.55.10
编程招I刷新（R）全软件
微软Bing搜索-国..
Boq
在线工具集
黑科技
Forbidden
Youdon'thavepermission toaccess thisresource.
Apache/2.4.18(Ubuntu)Serverat10.211.55.10Port80
现在我们通过被控主机Centos的SSH来做隧道，实现将访问受限的 Ubuntu的apache映射出来
假设我们已经得到了Centos的密码（或者将我们的密钥写入进去，通过公钥进行认证）
攻击机（物理机10.211.55.2）执行
ssh fCNg -L 8008:10.211.55.10:80 helperf10.211.55.11 =p 22
-f后台执行
●-N 不需要TTY，即notty
-C使用压缩
-g设置监听端口为0.0.0.0这种形式
ECDSA key fingerprint is SHA256:GL5Mz9fte80EECVrV27xr+Daqh+yIEJpwqR73kR3DXk.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
PI:EMAIL's password:
现在攻击机直接访问自己的8008端口就可以访问到受限主机的apache了
个
→
127.0.0.1:8008
编程招聘安全软件
微软Bing搜索-国
blog
在线工具集
黑科技
hack-tech
I am Ubuntu !
可以看到，我们的隧道成功了，已经成功将访问受限的Ubuntuapache映射到了攻击机本地
我们看—下Ubuntu上 Apache 的日志/var/log/apache2/access.log
10.211.55.11 - - [27/Apr/2021:11:34:27 +e888] "GET / HTTP/1.1° 304 179 “-= *Mozil1a/5.0 (Mocintosh; Intel Moc 05 X 1e_15_7) AppleWebk
---
## Page 222
这里可以看到，日志记录的访问IP为受控主机Centos的IP
我们来看一下受控主机是否存在异常
网络连接
(Not all processes could be identified,non-owned process info
will not be shown,youwould have to be root to see itall.)
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address
Foreign Address
State
PIO/Progrom name
tcp
0127.0.0.1:631
0.0.0.0:*
LISTEN
tcp
0127.0.0.1:25
0.0.0.0:*
LISTEN
tcp
00.0.0.0:111
0.0.0.0:*
LISTEN
tcp
00.0.0.0:22
0.0.0.0:*
LISTEN
tcp
010.211.55.11:22
10.211.55.2:56450
ESTABLISHED
tcp
010.211.55.11:53348
10.211.55.10:80
TIME_WAIT
tcp
010.211.55.11:22
10.211.55.2:55843
ESTABLISHED
tcp
010.211.55.11:22
10.211.55.2:55845
ESTABLISHED
tcp6
0::1:631
LISTEN
tcp6
0：::111
LISTEN
tcp6
0:：:22
LISTEN
udp
00.0.0.0:951
0.0.0.0:*
udp
00.0.0.0:68
0.0.0.0:*
dpn
00.0.0.0:111
0.0.0.0:*
udp
00.0.0.0:5353
0.0.0.0:*
dpn
0127.0.0.1:323
0.0.0.0:*
dpn
00.0.0.0:55883
0.0.0.0:*
udp6
0：::951
udp6
0：::111
:.:*
udp6
0::1:323
[helperecentos-7
-了s
从流量上看多了一个攻击机连接受控主机Centos22端口的连接，同时多了一个受控主机Centos访问10.211.55.1080端口
的连接，在我们实验主机中可以清晰看出来，但是如果在实际情况中，很多业务在使用同一个主机的时候，是非常难以分辨
出这是一个SSH隧道的，所以从网络连接上辨别SSH隧道难度较大
·进程
2460 2469 2469 2469 pts/0
2658 Ss
1000
0:00
bash
2469
2658
2469 pts/0
2658 R+
-1 5s
1080
0:80
0 : 00
/usr/sbin/sshd -D
\_ps afjx
2567 2599
1
2567
2567
2567 ?
2599
-1 Ss
0: 80
\_sshd:helper [priv]
25992604
2599
25997
-1 S
1000
0 : 00
\_ sshd: helper
[helper@centos-7 ~]$
从进程角度来查看多了一个ssh连接进程，这个进程很可能就是有问题的了，可以联系相关主机业务人员确认