Poisoning 进行的中间人攻击。同时它也可以防御其他类型的攻击，如 Sniffing、Hijacking、
一种ARP欺骗的预防措施
协议。
能性，于是他们开始制定一些措施防范这种形式的攻击，例如用一种安全协议来替代WEP
实现起来非常简单。工程师已经考虑到这种未授权的无线入口点服务的连通性受到攻击的可
钥，于是他们一般只是接受远程主机的密钥而不去验证。对这种攻击不必详细讨论，因为它
击。因为一些人在无线网中使用借来的笔记本电脑，在本地系统中没有缓存服务器的主机密
机安全大会上的攻击者更喜欢设置一个入口点，目的就是对警惕性差的用户发起中间人攻
路由信息，结果就使得新的客户把包发送到攻击者的路径上来。
信息。这样恶意的攻击者便可以假扮 DHCP 服务器的角色应答一个有效的 IP 地址和无效的
包的DHCPOFFER包作出应答。服务器初始化的过程全部是通过传送DHCPACK包实现的。
供配置参数列表的DHCPOFFER包作出应答。接着客户端将对其中一个含有DHCPREQUEST
包，并且进行网络广播。在网络中所有听到并且能够提供服务的DHCP服务器将通过发送提
议，但没有意识到这一点。这个协议的工作过程使DHCP客户端产生一个DHCPDISCOVER
机系统网络参数的机制。ISP用户、802.11使用者、普通用户和无数电脑用户使用着这个协
讨论过。
迫交换机把不是发送给攻击者的包发送到他的网络端口上去。这样的攻击我们在本书案例中
的数据包。尽管这言之有理，但是交换机功能的完整性也可以通过几种方法来攻破，比如强
服务器还没有大面积部署（其应用见本书4.4节内容）。
有效。在2010年5月ICANN已在全球13台根域名服务器部署了DNSSEC，但是国内域名
在整个DHCP包交换的过程中，服务器指派的不仅是IP地址，同时还提供路由和DNS
有经验的读者也许会认为，一个由交换机组成的交换式网络能够防止攻击者监听网络上
动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）提供了自动配置计算
3.DHCP欺骗
目前，无线入口点（WirelessAccessPoint）这种形式的欺骗越来越流行，特别是在计算
4.无线入口点欺骗
40 byte packets
traceroute to www.hacktivismo.com (216.201.96.65) from 68.81.173.85. 30hops max.
$traceroute-nwww.hacktivismo.com
第12章数据加密与解密案例323
JHC
---
## Page 347
所以在交换机上设置 DHCP Snooping就可以防止非法 DHCP 服务器在网上出现。
应关系；通过设置DHCPSnooping信任端口，可保证客户端从合法的服务器获取IP地址，
DHCP安全特性，能够通过监听DHCP报文，记录DHCP客户端IP地址与MAC地址的对
攻击。
次traceroute命令，如果看到本地的主机不使用标准指定的网关，那么很明显是受到了这种
括通过 traceroutes得到信息，并将这些信息与已知的网络拓扑结构相比较。例如，运行-
端的网络中设置了中间人攻击，就是远程的服务器系统已经被攻破了。其他更多的方法包
底隔离的地方来发起SSH连接。如果还存在主机密钥侵害，这就可以证实，不是已经在远
不太可能同时被攻破，这的确是不太可能。唯一可能的解释是杨芳受到了中间人攻击。
才有些相信它的不可能性。而且她的电子邮件账号、私有密钥和口令，以及CVS服务器也
刻成功地攻破所有的计算机。
出太明显的异常信息。就算是这里的每一台计算机都非常容易受到攻击，也不可能在同一时
的，因为我们知道这两台计算机的安全性都维护得非常好。另外，入侵检测系统也没有显示
答疑解惑
offer信息，迫使黑客用于攻击的DHCP服务器离线，故障随即消失。她终于松了口气。
络中的计算机中转，而他们的网址段已经不在你们的网络范围。现在你能帮我吗？‘
在这个网段中建立起一个用于攻击的 DHCP 服务器。随后他们让我的 SSH 流量经过他们网
通过了一个二级链路连接。
个案例中应该是 68.81.173.1。从这些收集到的数据可以看出，在杨芳和路由之间的中间节点
址，要么是尾地址)。大多数的管理员都是使用网络地址段的首 IP 作为路由器的地址，在这
就太不正常了，通常是不应该把处在中间的这个IP地址分配给路由器的（通常要么是首地
324
息，
3．很多中高端交换机都支持DHCP snooping，它是运行在二层接入设备上的一种
2．可以通过一些方法证实你是否受到了中间人攻击。一种策略是到一个与这个网络彻
远程终端受到了攻击。这就真的是不可能了，但是杨芳还是通过和远程系统管理员讨论
“技术支持吗？有人利用68.81.173.79地址对我的主机发起中间人攻击。采用的手段是
她立即给ISP技术支持打电话。
traceroute 命令显示网关的地址是 68.81.173.79，这个地址正好是在子网范围的中间。这
4UNIX/Linux网络日志分析与流量监控
每一台计算机都受到了攻击。OpenBSD 系统和 Solaris 系统同时被攻破几乎是不可能
网管立即在交换机上进行了设置，通过禁止转发交换机下非法 DHCP 服务器的 DHCP
“我给你转到网络管理员，请不要挂机。”
1.本案例中杨芳成为中间人攻击的对象。
正如杨芳所料，她必须请求ISP的网络管理员帮助。由于她向管理员提供了大量背景信
168.81.173.794.079ms4.285ms6.300ms
162.33.240.73
.·.
64.159.3.33
63.217.101.57
163.34.250.1
5.454ms
4.198ms
5.854ms
5.763ms4.266ms3.883ms
4.611ms
4.341ms
5.763ms
4.733ms
下面对得出的其他两个可能的解释一
4.273ms
5.232ms
一排除
---
## Page 348
敬就好有中
购
预先发出主机密钥更改通知。
况，用户应该明白，这时的主机密钥应作废，并且不应该继续与远程主机连接，除非管理员
应该让用户知道主机密钥受到侵害后的危险，如果出现意想不到的主机密钥受到侵害的情
外，除非提前通知。如果主机密钥经常更换，用户很快就习惯了不假思索地接受主机密钥。
当密钥改变时给用户发警告，应该让用户知道，任何形式的主机密钥改变都是一种意
卡的芯片中，发给经常在外出差的成员使用。
优秀的安全政策需要考虑如下的因素：分配主机密钥指纹，这种指纹信息，最好记录到员工
全政策来解决问题。事实上，这样的安全政策对于一个好的密码系统的成功运行是必须的。
户意识到网络在传输中有可能存在这样的攻击行为。
防止中间人攻击的发生。而且ISP那里需要保护自己的链路不被破坏。还要加强培训，让用
要操纵受害者控制范围以外区域，简单地改变防火墙配置策略或者修改入侵检测系统并不能
预防措施
在受到中间人攻击后，解决方法是：不要再连接到SSH主机。这一类型的攻击通常需
很少有什么简单的办法来防范在SSH连接中受到的中间人攻击风险，通常需要围绕安
M2
阿品
第12章数据加密与解密案例325
#外国出
VOMAT
网
---
## Page 349
需求，IETF开发了RMON用以解决SNMP暴露的不足。
为了提高传送管理报文的有效性，减少网管工作站的负载，满足网络管理员监控网段性能的
由于只有网管工作站负责采集数据和分析数据，所以网管工作站的处理能力可能成为瓶颈。
验证，不能提供可靠的安全保证。此外，SNMP也不支持分布式管理，而采用集中式管理。
而在大型网络中轮询会产生巨大的网络管理报文，从而导致网络拥塞。SNMP仅提供一般的
视和分析网络运行情况，但是SNMP也有一些明显的不足之处。SNMP使用轮询采集数据，
SNMP是基于TCP/IP并在Internet中应用比较广泛的网管协议，网络管理员可以使用它来监
13.1.2SNMP协议的不足
络出现问题时，快速准确地分析问题原因、定位故障点并进行相应处理。
用分布、通信连接、数据包原始内容等所有网络行为，以及整个网络的运行情况，以便在网
数据包的大小进行统计和分类。
析，通常指从海量数据中发现任务所需的关键信息，例如按协议的不同种类和每种协议发送
括两种核心技术，即数据流采集技术和网络流量/协议分析技术。数据流采集，指通过在特
据中心，并利用网络流量/协议分析系统完成对海量数据的初步分析和预处理。网络监听包
工作流程是：监听者通过探针，收集目标网段数据流，通过预定的隧道汇总到远程/本地数
13.1.1网络监听
息），能从这些参数中分析网络的运行状态。
针对性地监测网络流量的各种参数（如接收和发送数据报大小、丢包率、数据报延迟等信
通过对网络流量的研究来获得。网络的运行特点可以通过其承载的流量来动态反映，所以有
13.1
无论是网络监听还是网络管理都会用到SNMP，它是RMON模型的前身。目前
网络监听是一种监视网络状态、数据流程，以及网络上信息传输的管理工具，其监听的
从网络体系架构来说，网络流量是分析网络的基础。网络应用和网络本身的运行特点可
网络流量/协议分析技术能帮助网络运行维护人员充分了解和掌握网络的流量占用、应
第三篇网络流量与日志监控
网络监听关键技术
第13章网络流量监控
---
## Page 350
据流采集端口上。网络管理员配置交换机上的一个端口作为SPAN 端口，然后交换机就将其
防火墙或路由器的内网口处，可以收集到10M及以下带宽的互联网流量。
非常大时还可采取在网段中串接TAP设备的方式；最原始的方式是把集线器（Hub）布置在
见的交换机端口分析器（SPAN）功能，本书中涉及的监控部分都是利用此功能；监控流量
法，即硬件探针和软件代理。网络探针（Sensor）通常借助Hub/交换机/TAP等设备，如常
13.1.6网络数据流采集技术
识别方法。
征，这样便于对流量进行分类并完成对各种应用层协议的准确识别。在13.2节中会详细介绍
13.1.5协议和应用识别
流量采集的支持。
持，它采用了定时抽样采集数据。在OSSIM中Ntop工具的插件就提供了sFlow和NetFlow
Networks等厂家的设备支持。NetFlow是思科的技术，目前应用广泛，各种中高端设备都支
输。但是支持sFlow的硬件设备并不多，目前有惠普和FoundryNetworks以及Extreme
需要硬件支持，可以适应超大网络流量，例如在万兆流量的环境中，进行实时分析网络传
厂家有所不同。sFlow由惠普和FoundryNetworks联合开发，它采用随机数据流采集技术，
目前基于流量的解决方案主要分为 sFlow和NetFlow两种。它们实现功能类似，但主导
13.1.4NetFlow与sFlow的区别
据包解码分析等。
员快速发现异常流量，从而进一步查找异常流量的源地址和目的地址。
NetFlow，它是判断异常流量、流向的有效工具。通过对流量大小的监控，可以帮助网管人
量异常监测的需求。这是常见的流量监控方式。目前有很多流量监控管理软件，都利用了
度等。但SNMP在大型网络中应用有一定局限。
的变量。基于SNMP收集的网络流量信息包括传输字节数、广播包数、丢包数和输出队列长
的流量信息采集，通过提取网络设备代理提供的MIB收集一些具体设备及与流量信息有关
此同时，业界也存在另一种划分方法，将网络监听的关键技术概括为以下三个方面的内容：
13.1.3
交换机端口分析器（俗称SPAN）在网络分析中比较常见，且作用在交换机上的网络数
采集的数据报头信息包括IP地址、端口号、关键字、报文格式、传输层协议等多种特
流量监测技术主要包括基于 SNMP的流量监测和基于NetFlow的流量监测。基于SNMP
掌控网络通信情况的最佳办法是对网络数据流进行全面采集。目前主要有两类采集方
协议分析技术用于掌握用户具体使用了什么协议和应用，主要包括协议和应用识别、数
（3）协议分析技术
基于网络设备提供的NetFlow机制实现的网络流量采集，效率和效果均能够满足网络流
（2）基于NetFlow流量采集
（1）流量监测技术
监听关键技术
第13章网络流量监控327
---
## Page 351
人员选择特定的数据流通过指定的工具。但是，这种设备价格不菲，一般的企业难以接受。
探工具接到上面进行分析。矩阵交换机比起TAP更多的是使用内置的过滤功能，它可以让运维
无法使用SPAN，这时使用矩阵交换机就可以保证监控工具正常运行。并且能够将更多的网络嗅
只能设置2个SPAN端口，这时如果有多套监控系统就无法同时使用。而且当负载增大时再也
出现问题时，运维人员通常会在多个交换机上创建SPAN端口。我们知道Cisco6500系列交换机
TAP三者的优缺点有个清晰的认识。
的指定端口就能实现多个安全设备同时工作的目的。表13-1会让读者对HUB、SPAN 和
式是将TAP设备串联在防火墙和核心交换机之间，然后将IDS/IPS等多套安全设备接到TAP
件ASIC方式复制交换引擎，所以可以保证设备端口千兆全线速用来复制监听。通常部署方
多个监听端口上供多套分析系统使用。为什么它能这么强悍？因为TAP设备内部采用了硬
设备，作用是支持多端口的流量汇聚，而且能做到真正的全线速，也就是能够完整地复制到
AccessPoint）方式，而传统的SPAN可以作为补充。基于TAP的流量复制/汇聚器是个硬件
的限制，无法满足要求，所以用户通常会考虑采用专用流量分析接入设备一一TAP（Test
况），会要求使用2个以上的安全设备或者流量分析设备，这时由于交换机SPAN端口数量
有一些限制：
13.1.7SPAN的局限
Endace公司开发的GAG系列检测卡，有兴趣的读者可以在网上查询。
在千兆速率以上的网络中要实施流量收集分析，就要用到硬件加速技术，目前比较好的是
使用率在10%以下，如果CPU使用率过半，就不能使用SPAN方案）。为了解决这个问题，
它的不足，它工作时要以牺牲交换机性能为代价（正常情况下启用SPAN后交换机CPU的
指定端口/VLAN的流量复制并发送到 SPAN端口，用于监听网络流量。当然 SPAN方式也有
328UNIX/Linux网络日志分析与流量监控
13.2
不足
优点
在一些网络应用成熟的大型企业中，例如某用户后台使用基于IBMWebSphere的应用，
在本书中有不少案例都用到了 SPAN 技术，应指出的是思科、华为等厂商在 SPAN 方面
随着各种网络应用迅速增加，由此带来了网络流量的激增。在这些流量中，网络用户的
在安全级别和要求比较高的场合（例如多个IDS系统+多个流量分析系统并行使用的情
●一般中档的思科设备通常只支持一个会话。
·SPAN会话中目的端口只能有一个。
不同的SPAN会话目的端口只能有一
用NetFlow分析网络异常流量
超过10M时，对网络传输延
成本低廉，无需改变拓扑
HUB
表13-1HUB/SPAN/TAP监听方法比较
量大时会增加交换机负载
需要占用一个交换机端口，流
无需增加设备，无需改变拓
SPAN
中断网络，存在单一故障点（可以通过
不占用IP
不干扰数据流，不增加设备现有负荷，
TAP
---
## Page 352
确反映流量的实际情况。
比较好的选择。流量计费系统采用NetFlow的话则造成误差，使得NetFlow输出有时不能准
多数的流量信息。当我们不需要了解网络流量的每个Flow的具体细节的时候，抽样就成了
过使用抽样技术可以降低路由器的CPU利用率，减少Flow的输出量，但仍然可以监测到大
13.2.3NetFlow的抽样机制
相同，且NetFlow采用UDP报文，这更有利于大流量情况下的数据报文传输。
间等，Flow流包含具体内容，如IP地址、端口、路由信息等。各个版本的NetFlow格式都
13.2.2NetFlow的输出格式
Collector）采集到并做出进一步分析，这些FlowCollecoer能够识别NetFlow的特殊格式。
中Flow的信息，并且判断哪些Flow应该到期终止。
已存在Flow的一部分，还是应该在缓存中产生一条新的Flow。这些算法也能动态更新缓存
13.2.1NetFlow的Cache管理
种属性，快速区分网络中传送的各种类型的业务数据流。
Flow至少定义了下面7个关键元素：
V5，这一版本数据包中的基本元素包含哪些内容呢？首先从Flow讲起，一
多种版本，如V5、V7、V8、V9。目前 NetFlowV5 是主流。因此本节主要针对 NetFlow
前很多厂家都开发了类似软件，如 Juniper、Extreme、Foundry、H3C。Cisco 的NetFlow
效工具以满足对网络流量管理的需求，NetFlow最初是由Cisco开发的，由于使用广泛，
上网行为如何管理？各种类型的流量如何分布？要解决以上问题，可以使用NetFlow这一有
NetFlow的输出报文包含报头和一系列的Flow 流，报头包含系列号、记录数、系统时
含30条以上的Flow信息。这些NetFlow信息一般是无法识别的，需由专用收集器（Flow
在NetFlow的实际应用中，它不是时刻都把数据包抓取过来，而是采用抽样的机制，通
首先了解NetFlowCache（缓存机制)。当缓存中的Flow到期后，就产生一个将Flow输出