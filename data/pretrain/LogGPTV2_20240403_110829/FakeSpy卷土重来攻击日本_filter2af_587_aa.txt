# FakeSpy卷土重来攻击日本
|
##### 译文声明
本文是翻译文章，文章来源：fortinet.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
## 一、前言
FortiGuard实验室最近发现了一些恶意流量，其C2服务器位于中国境内。恶意链接所使用的域名与日本最知名的快递服务商非常相似。根据我们的分析，创建该链接的网站属于虚假网站，并且会传播Android恶意软件。
初步分析时，这个Android文件非常像趋势研究人员在2018年6月份发现的FakeSpy恶意软件，但根据我们分析平台的处理结果，虽然该样本在代码上基于FakeSpy，但这款新变种还包含新的功能，并且恶意活动势力不断增长。
## 二、网页分析
初步分析样本后，我们发现了一个域名：`hxxp://sagawa-ba[.]com`。
图1. 伪造的日本快递官网
眼尖的读者可能会发现，该网站伪装的是日本的某家快递服务公司。然而仔细检查后，我们可以看到该网站并没有使用SSL证书，并且页面布局也不正确。
在分析页面源码时，我们首先注意到的是其中的Mark of the Web（MOTW）注释。MOTW是Windows XP
SP2开始引入的一个安全机制，现在每一个浏览器都会部署该机制，在用户下载Web页面和脚本到本地磁盘时提高用户的安全性。
图2. 主页面的MOTW标志
这行注释表明该页面最早下载自某个页面，然后再上传到其他页面中，以便添加一些新的“功能”。新增的一个主要功能是包含`kk`函数的一段脚本。我们还观察到页面中注释掉了一个弹出消息，可能表明攻击代码仍在研发中。`kk`函数很简单，会打开网站的`pp.html`页面，一旦终端用户点击网站时就会调用该函数。
图3. 主页面中的重定向脚本
跟随重定向代码，我们可以看到如下错误信息，声称出于安全原因，用户需要输入手机号码。
图4. 出于“安全”原因弹出来的手机号码页面
分析处理输入字段的脚本后，我们发现用户输入的数据会直接发送到恶意服务器，其中cookie字段用来发送用户输入的移动手机号码。之后浏览器会跳转到下一个页面，调用`pp2.html`。该页面中同样包含被注释的代码段，可能表明攻击代码仍在研发中。
图5. 手机号码发送脚本
进入下一页，恶意网站会要求我们输入“确认”码：
图6. 手机号的“确认”码
当我们检查输入字段的代码时，可以发现其中依然包含注释代码，但这次代码与之前的`pp.html`
JavaScript代码非常相似。很有可能是开发者复制粘贴代码后，在投入实际环境中前忘了删掉其中的注释，也有可能将这些注释代码留在页面中用来测试。
图7. 确认码的验证代码
分析该脚本，我们可以看到脚本会调用`validate()`函数，检查用户提供的代码是否包含4个数字。如果满足该条件，网站就会将代码发送到服务端，将用户重定向到`loding1.html`页面。不幸的是，我们没有从服务器那获取任何响应数据。但该元素可能用来帮用户订阅付费服务，或者用来验证用户提供的是真实的手机号，该页面只为用户“服务”一次。
除了该脚本外，该页面还包含一个定时器脚本。这里有趣的是，该页面的注释中包含一些中文字符。
图8. 带有中文注释的自定义定时器代码
接下来，如果我们我们分析`loding1.html`源码，可以找到负责处理服务器返回数据的另一个脚本，脚本中我们还是可以找到中文注释，还有一条韩文注释。这可能表明攻击者存在代码复用，没有翻译中文字符，或者也有可能是中国攻击者和韩国攻击者合作的结果。
图9. 带有中文和韩文注释的页面加载脚本
在搜索代码模式时，我们发现这些有趣的地方并不足以作为追踪钓鱼网站开发者的证据。虽然钓鱼页面中的`setInterval('newArticleCheck()',
2000);`代码与2015年韩国人`쥬리앙`（Juriang）在Q&A
PHP论坛上使用的代码样式、函数名以及语法相匹配，但我们无法肯定新的攻击代码由同一个人开发，有可能其他人直接复用了PHP论坛上的代码。
图10. 论坛上发现的同样的代码特征
观察网站的主逻辑后，我们决定分析分析其他功能的页面代码，此时我们发现页面上存在安装`sagawa.apk` Android应用的代码：
图11. Android应用安装链接
不幸的是，此时该链接已失效，会跳转到一个中文404页面：
图12. 中文404页面
完成对该网站的初步检查后，我们分析了该域名的WHOIS信息。该服务器位于台湾地区，域名注册时间为2018年7月16日。
图13. C2服务器位置信息
令人惊讶的是，我们发现恶意活动并不仅限于这个域名。我们可以找到347个域名，这些域名对快递官网域名的第一部分或者最后一部分域名做了修改。攻击者使用如下3个邮箱来注册这些域名。
    mantianxing0111[at]yahoo.co.jp （注册104个域名）
    2509677308[at]qq.com （注册55个域名）
    21449497[at]qq.com （注册188个域名）
图14. 伪造域名部分列表
我们决定检查该列表中的某些域名。这些网站大部分都已注册，但没被使用过。某些域名已连接到托管服务器（托管服务器主要位于台湾地区），但并不包含网页内容。然而，某些网站上的确包含同样的钓鱼页面。
我们针对性检查了结尾为`-iso.com`以及`-wow.com`的那些域名。在检查过程中，我们发现了另一个脚本，该脚本与`-ba.com`网站上的脚本非常相似，但并不会将用户重定向到电话号码页面，而是在用户点击网页时，下载`sagawa.apk`应用。以`-wow.com`结尾的域名并不会收集用户手机号码，也不像`-ba.com`的域名那样包含`pp.html`、`pp2.html`或者`loding1.html`页面。此外，该域名会使用英文的404页面。
图15. 投放`sagawa.apk`应用的脚本
## 三、应用分析
我们分析的APK哈希值为`92cd2e43bf85703f92a493668be3d777c3d3cfab3f674b62bd334ddc082ac50d`。
###  释放器
首先我们分析的是APK文件的内容。
我们使用内部分析工具分析样本，分析报告部分内容如下图所示。应用的包名为`fang.tang.sha`，除了与正常APK文件一样包含`classes.dex`外，还包含适配不同架构的一个库（`libxxn.so`）、一个asset文件（`nini.dll`）。这已经是一个危险标志：正常Android应用不需要依赖MS
Windows库。