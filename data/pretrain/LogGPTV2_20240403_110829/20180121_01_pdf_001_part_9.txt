标准字段切分、列存储、
分区 等
实时分析，举例(不限于此)：
指定维度、日UV，新增UV，。。。透视
select x,count(distinct y) from tbl where dt=? group by x;
案例 架构设计、代码、实操手册
-
• https://www.postgresql.org/docs/10/static/datatype-
json.html
• https://www.postgresql.org/docs/10/static/functions-
json.html
• RDS PG OSS 外部表文档：
https://help.aliyun.com/knowledge_detail/43352.html
• HDB PG OSS 外部表文档：
https://help.aliyun.com/document_detail/35457.html
画像、特征、透视
Case3( )
• 画像系统
背景
– 业务背景： ToB 实时圈人系统
– 数据来源：实时标签数据
– 数据规模：单表10亿条记录，单个B-1亿用户，1万个标
签字段。
– 数据描述：每个用户的标签数据
– 查询需求：任意标签组合圈人
• 100毫秒级响应
– 并发需求：200+
– DML需求：实时标签分钟级体现到查询中
痛点
• 1万个 TAG，大宽表。
– 目前没有数据库支持。需要拆分成多表。
• 原方案成本高，收益低。
– 8台，数据延迟天级别，响应时间接近分钟级，
并发不到 。
100
效率低
案例
• 数据银行项目
• 20亿+用户，万级标签，大屏展示（100+标签组合
圈选透视）
– 1、求COUNT，2000亿（20亿用户，100个标签组合）
USER_IDS，响应速度2.6秒。
– 2、求USERID明细，返回500万用户ID位置，692毫秒。
– 3、求USERID明细，返回BITMAP，500万个BIT，224毫
秒。
插件
roaring bitmap
• 提供：bitmap新增元素、删除元素接口。BITMAP计算接口。聚合接口。
• bitand，同时包含
• bitor，包含任意
• bitand bitxor，包含1但是不包含2
tag1 bitmap
......
tagn bitmap
案例 架构设计、代码、实操手册
-
• roaringbitmap插件使用
– https://github.com/digoal/blog/blob/master/201
801/20180127_01.md
时空分析
Case4 ( )
• GIS与新零售
案例
• 新零售 - LBS数据应用, 网格化运营
– 业务背景：LBS透视、圈人
– 数据来源：ODPS
– 数据规模：千亿+
– 数据描述：商铺位置、用户轨迹数据，保留3个月。
– 查询需求：
• 选址，分析某个商圈的对象透视，秒级
• 商铺地推，商圈周边的潜在目标人群，秒级
• 时间区间、空间覆盖查询，秒级
– 并发需求：100+
– DML需求：OSS批量写入
• 黄金策
– 精准筛选（任意字段、标签过滤、透视分析），高效分析
痛点
• 数据量较大
• 时间、空间、对象属性多维透视
• 有空间需求
• 透视实时响应
• 存储乱序、 IO放大
云产品方案、效果
案例 架构设计、代码、实操手册
-
• https://github.com/digoal/blog/blob/master/201706/20170629_01.md
• https://github.com/digoal/blog/blob/master/201709/20170918_02.md
• https://github.com/digoal/blog/blob/master/201708/20170820_02.md
• https://github.com/digoal/blog/blob/master/201708/20170820_01.md
• https://github.com/digoal/blog/blob/master/201707/20170722_01.md
• https://github.com/digoal/blog/blob/master/201703/20170328_04.md
批量数据圈选与导出
Case5
• CDN，数据归集
• 某物流公司，数据归集 数据
(tbls)
• 品牌圈人，导出
• 速度
单次Query结果
– ~ 30MB/s/Segment
集合1 集合n
海量数据实时
归集、导出。 导出；
prefix区分归集. 作为输入继续查询；
...
OSS 对象存储
批量数据圈选与导出
Case5
• DEMO
• 详见阿里云官网, HDB PG产品手册
– create table tbl_output_struct(prefix text, struct json);
– insert into tbl_output_struct values ('label1', '{col:type, col2:type, ....}');
– create writable table tbl_output (prefix text, content json) bucket ....;
– insert into tbl_output select 'label1' as prefix, row_to_json(t) (select ... from
tblxxx where ..... ) as t;
案例 架构设计、代码、实操手册
-
• https://github.com/digoal/blog/blob/master/
201801/20180109_01.md
优土 智能广告
Case 6 -
优土 智能广告
-
优土 智能广告
-
优土 智能广告
-
• RDS PostgreSQL 角色
– FEED表
• 命中规则，写入FEED。(100万+ 行/s)
– 计数表
• 分区：小时、天、周
• 实时写入、阅后即焚(300万行+/s)，合并到计数表
– 实时统计表
• 阅后即焚(300万行+/s) 、合并到实时统计表，提供毫秒级任意维度查询
– OSS存储
• 计数表，上一小时、天、周，调度写入OSS。200MB/s 并行读写速度。
• HDB PostgreSQL 角色
– 对接OSS(30MB/s/segment节点读写速度)、实时分析。无限扩容。
• https://github.com/digoal/blog/blob/master/201711/20171126_01.md
优土 智能广告
-
RDS PostgreSQL
HybridDB PostgreSQL
在线
实时写入明细
FEED表 百万+ 行/s APP 分析
50亿/天 规则判定 APP
0.0n毫秒级
任意维度毫秒级响应
阅后即焚
300万行/s
计数 规则
+ 统计表 历史表
表 表
外部表存储，暖热分级存储
外部表存储，暖热分级存储
OSS 海量存储（暖数据）
优土 智能广告 衍生需求
- ( )
• MADLib库(支持几百个机器学习库函数、对应各种数学模型)，PL/R, PL/Python
• 例子
– p元线性回归
– y1=b0+b1x11+b2x12+…+bpx1p+ε1
– y2=b0+b1x21+b2x22+…+bpx2p+ε2
– ………………
– 求截距，斜率。
– 预测yn
– yn=b0+b1xn1+b2xn2+…+bpxnp+εn
linregr_train( source_table,
out_table,
dependent_varname,
independent_varname,
grouping_cols,
heteroskedasticity_option
)
优土 智能广告 衍生需求
- ( )
• 一条SQL搞定聚类分析
• SELECT kmeans(ARRAY[columns,...], K) OVER (...), * FROM samples;
优土 智能广告 衍生需求
- ( )
• SQL接口机器学习库MADLib (支持几百个机器学习库函数、对应各种数学模型)，PL/R, PL/Python
案例 架构设计、代码、实操手册
-
• MADlib机器学习库
– https://github.com/digoal/blog/blob/master/201511/
20151111_01.md
– http://madlib.apache.org/
– https://cran.r-
project.org/web/packages/PivotalR/vignettes/pivotalr
.pdf
– https://pypi.python.org/pypi/pymadlib/0.1.4
案例小结
• 物联网、电商、生物、游戏
行业
• 企业CRM、传统行业、ZF
• 物流、音视频、BI、证券、金融
• 手机、
• 搜索（ADHoc, 全文检索、模糊、数组）
技术点
• 相似搜索（图片、文本、数组）
• 用户画像、空间、时空、挖掘
• 图式搜索、流计算、秒杀、树结构、非结构
化
• 单元化部署、sharding
目录
• 产品介绍
• 生态介绍
• 应用案例
• 开发、管理实践
• 数据库原理
• 参考文档
开发、管理实践
• RDS PostgreSQL\PPAS
• HybridDB for PostgreSQL
开发、管理实践
• RDS PPAS
• RDS PostgreSQL
• HybridDB for PostgreSQL
PPAS
• SQL防火墙
– https://github.com/digoal/blog/blob/master/201801/20180116_02.md
• CPU\IO 资源隔离
– https://github.com/digoal/blog/blob/master/201801/20180113_01.md
• 索引推荐
– https://github.com/digoal/blog/blob/master/201801/20180113_02.md
• AWR
– https://github.com/digoal/blog/blob/master/201606/20160628_01.md
• VPD(RLS)
– https://www.enterprisedb.com/docs/en/10.0/EPAS_Guide_v10/EDB_Postgres
_Advanced_Server_Guide.1.52.html#pID0E04QC0HA
PPAS AWR
• 全面的系统报告
• edbreport(beginning_id, ending_id)
• 数据库报告
• stat_db_rpt(beginning_id, ending_id)
• 指定范围的表级报告
• stat_tables_rpt(beginning_id, ending_id, top_n, scope)
• scope=ALL, USER, SYS
• 指定范围的表级IO报告
• statio_tables_rpt(beginning_id, ending_id, top_n, scope)
• 指定范围的索引级报告
• stat_indexes_rpt(beginning_id, ending_id, top_n, scope)
• 指定范围的索引级IO报告
• statio_indexes_rpt(beginning_id, ending_id, top_n, scope)
阿里云
RDS PPAS AWR API
• 数据库报告
• sys.rds_stat_db_rpt(beginning_id, ending_id)
• 指定范围的表级报告
• sys.rds_stat_tables_rpt(beginning_id, ending_id, top_n, scope)
• scope=ALL, USER, SYS
• 指定范围的表级IO报告
• sys.rds_statio_tables_rpt(beginning_id, ending_id, top_n, scope)
• 指定范围的索引级报告
• sys.rds_stat_indexes_rpt(beginning_id, ending_id, top_n, scope)
• 指定范围的索引级IO报告
• sys.rds_statio_indexes_rpt(beginning_id, ending_id, top_n, scope)
阿里云
RDS PPAS AWR API
• 全面的系统报告
• sys.rds_report(beginsnap bigint, endsnap bigint)
• 删除指定范围快照
• sys.rds_purgesnap(beginsnap int, endsnap int)
• 删除所有快照
• sys.rds_truncsnap()
• 查看已有快照
• sys.rds_get_snaps()
• 创建快照
• sys.rds_snap()
实例版本管理与插件管理
• 查看当前实例版本
– select version();
• 升级实例版本
– 控制台，重启实例。
• 列出支持哪些插件
– select pg_get_functiondef('sys.rds_manage_extension'::regproc);
• 创建插件
– select rds_manage_extension('create','dblink');
• 升级插件版本
– select rds_manage_extension('update','dblink');
• 删除插件
– select rds_manage_extension('drop','dblink');
会话管理
• 查看当前会话状态 , pid为会话 ID
– select * from sys.rds_pg_stat_activity()
• KILL 会话
– select sys.rds_pg_terminate_backend(upid int)
• KILL QUERY
– select sys.rds_pg_cancel_backend(upid int)
查询
TOP SQL
• TOP SQL查询接口
– https://github.com/digoal/blog/blob/master/201
704/20170424_06.md
– sys.rds_pg_stat_statements()
• 重置 SQL统计信息
– select sys.rds_pg_stat_statements_reset()
重置统计信息计数
• select sys.rds_pg_stat_reset()
设置所有用户的用户级参数
• 查看有哪些参数
– select * from pg_settings;
• 查看参数当前设置
– select current_setting('参数名');
• 设置所有用户的用户级参数
– select sys.rds_set_conf_for_all_roles(param text, val
text)
开发、管理实践
• RDS PPAS
• RDS PostgreSQL
• HybridDB for PostgreSQL
实例版本管理与插件管理
• 查看当前实例版本
– select version();
– show rds_release_date;
• 升级实例版本
– 控制台，重启实例。
• 列出支持哪些插件
– show rds_internal_allowed_extensions;
– show rds_available_extensions;
• 创建插件
– create extension 插件名;
• 升级插件版本
– alter extension 插件名 UPDATE;
• 删除插件