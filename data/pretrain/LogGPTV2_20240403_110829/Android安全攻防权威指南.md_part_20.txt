4.2案例分析：移动安全应用
71
关于sh4ka工作的更多信息，请查看他的那篇博客文章，网址为http:/sh4ka.frandroid/
4.2案例分析：移动安全应用
本节将示范对一个移动安全/防窃Android应用进行安全评估的完整过程。这一过程将引人进
行静态与动态分析的工具和技术，你也可以看到如何进行一些基本的逆向工程分析。而你的目标
是更好地理解如何攻击应用中特定的组件，如何发现一些有避的安全漏洞并加以利用。
4.2.1初步剖析
在初步剖析阶段，你需要收集目标应用的一些粗略信息，从而对所要分析的对象有个大致的
方法），那么对应用开发者、应用的依赖关系，以及应用任何其他值得注意的属性进行了解，是
非常重要的。这将帮助你决定在后续阶段利用哪些技术，另外这一阶段也可能会揭露出一些安全
问题，比如利用了带有已知安全漏洞的代码库或Web服务。
首先，对这个应用的目标、开发者、开发历史或评论进行大致的了解，比如说由同一位开发
者开发的多个应用都存在许多安全漏洞记录，那么这个应用也很可能存在安全问题。图43显示
了在GooglePlay商店页面中一款移动设备恢复与反窃应用的基本信息。
Description
Soble Reecue
Coep your nobie phote sale ed soune
ABOUT THI8 APT
(8t
Nlth Mobile Rescut, yowi cant.
SacR
d a nu  o c n ts  woog pp g r dn
Lock yaur ghone frun your canputer i its niseing or sloien, Orce ITs locked, It cant be
ocking it, even if the SIM is changed
I your ghone's lot or stoien, Sist lock It wth Mle R
Pey/1 tkook Ihe SIM
and then.cal Virgin Media an
9092 9000-00 ≥ 90
Keywords: vigin mgble, ghore iocetor, ghone lom, arti vis proteclon, antivins for
PAE:
ang, iookout, netqjn, wtbrot,
outy
stdefendt. mcafee, eset, avast, trend micro, katgensky
图43在Google Play商店中的应用描述
---
## Page 88
72
第4章云计算的安全风险
当你仔细审查这一条目时，你会发现这款应用会请求许多权限。这款应用被安装后，将会获
到这款应用到底请求了哪些权限，如图44所示。
Permissions
THIS APPLICATION HAS ACCESS TO THE FOLLOWING
SERVICES THAT COST YOU MONEY
DIRECTLY CALLPHONE MUMBERS
Allows the app to cafl phore tuT
[0 0) dse xg moge 1ussop t4 )mg
SEND SNS MESSAGES
Allows Bhe app to sened SMS 
oOessguSupuas g faucs
HARDWARE CONTROLS
Alows Dhe apo to take pictures
and vice
YOUR LOCATION
PRECISE LOCATION (GPS AND NETWORK-BASED)
cise localion sing Ihe Gidtal Posifioring Syslen (GPS) or nebaot iocatine sourtee
vse them. Apps may use INis to deteesine shere you om, and may coneume additional battery power
cadr no. ya o dde ag smopy
APPROICMATE LOCATION (NETWORK-BASED)
sue no ououm. Ipgeupeudte eurutap of tsg esn ieu sddy weig een t; de eg
RECENE TEXT MESSAGES (SMS)
YOUR MESSAGES
nol o, wekg fuouyi ynogm eoynig noi. o)
Adows tte app to msceive and grocees SMS messages. Tsis means the app could montor or driete mes
图44目标应用所请求的一些权限
基于应用的描述和所列出的申请权限，可以得出一些结论。例如，描述中提及了远程加锁、
擦除和音频报警，这些再结合上READ_SMS权限，会让你认为应用使用了SMS短信作为带外通
信（out-of-bandcommunication），这在移动杀毒软件中是非常普遍的。我们对此做个笔记，因为
这意味着你可能需要检查一些收取短信的代码。
4.2.2静态分析
静态分析阶段涉及在不直接运行应用的情况下，分析应用及其支持组件中的代码和数据。首
先可以识别应用中的一些有趣字符串，如硬编码URI、认证凭据或密钥。接着可以尝试进行其他
一些分析以构建调用图、确定应用逻辑和程序流程，以及发现潜在的安全问题。
尽管Android SDK提供了一些有用的工具（如 dexdump）来反汇缩classes.dex，但你还可以
---
## Page 89
4.2案例分析：移动安全应用
73
从APK的其他文件中找到一些其他的有用信息。这些文件格式多样（如二进制XML文件），难
以用grep这样的常用工具读取。但是你可以使用apktoo1工具（可从htps://code.google.com/
p/android-apktool/获取），将这些资源转换成明文，也可以将Dalvik可执行字节码反汇编为一种被
称为smali的中间格式（后面会有许多smali格式的代码）。
以APK文件作为参数运行apktoo1d命令，来解码APK的内容，并将解出的文件都放置
到以APK名称生成的目录中。
I: Baksmaling...
-$ apktool d ygib-1.apk
I: Loading resource table...
I: Decoding values */* xMLe...
I：
Dene.
I: Copying assets and libs...
现在你就可以使用grep，在应用中查找诸如URL之类的有趣字符串，这可以帮助你理解应
用和Web服务之间的通信。你也可以使用grep来忽略对schemas，android，com的引l用，后
者是一个常见的XML命名空间字符串。
uo*ptozpue*sewos, A- dex6 | t-qt6 //:gsdt. x1g- dex5 s~
ygib1/smal1/com/yougetitback/androidapp1ication/sett.1ngs/xm1/
Xmloperator.smali :
const-string v2, *http://cs1.uce.1e/-yx2/upload/up1oad.php*
ygib1/re8/1ayout/main,xm1 :xm1ns :ygib= *http: /www-yw1x.net/apk/res/
com.yougetitback.androidapplication.cpw.mobile*>
ygib-1/res/values/strings.xml: Please enter
a previous email address if you already have an account on
https://virgin-yougetitback.com or a new enai1 address
ygib-1/res/values/strings.xml:
https: //virgin.yougetitback ,com
ygib-1/res/values/strings.xml:Please create an account on
https://virgin-youget1tback,com
ygib-1/res/values/strings.xml: 
before activating this device*
http: / /virgin.yougetitback,con/showSALocation?ce11id=
ygib-1/res/values/strings.xnl:  
https://virgin-yougetitback,com/terms_of_usec/string>
ygib-1/res/values/strings.xml:
>https : //virgin-yougetitback.com/eula
https: //virgin-yougetitback.com/privacy_policy
ygib-1/res/values/strings.xml : 
Account Registration Successful, you can now use the
email address and password entered to log in to your personal vault on
ygib-1/ren/values/strings.xn1:
ERRoR:creating user account.
Please go to http://virgin-yougetitback.com/forgot_password
---
## Page 90
74第4章云计算的安全风险
where you can reset your password, alternatively enter a new
emai1 and password on this screen and we wi11 create a new account for you.
Thank You.
ygib-1/res/values/strings,xml: 
login to your personalised vault on http://virgin.yougetitback.con
You can now use this emai1 and passvord provided to
ygib-1/res/values/strings.xm1: 
x>/m*ye6x1
Ygib-1/res/values/strings.xm1: 
https: //virgin yougetitback.com/forgot_pa8sword&1t:/a>
Access your online vault, or change your password at slt;a>
尽管apktool和通用UNIX实用程序都提供了许多帮助，但是你还需要一些更加强力的工
具。在本例中，需要考虑基于Python的逆向工程和分析框架Androguard。尽管Androguard包含
了适合执行特定任务的一些实用程序，但本章主要关注以交互模式运行的androlyze工具，它
提供了一个IPythonshell。对于初学者而言，只需使用AnalyzeAPK方法创建表示APK、资源与
dex代码的恰当对象，并添加一个使用dad反编译器的选项，就可以将dex代码转换回Java伪码。
8-Adztoxpue s~
In [1] : a, d, dx = AnalyzeAPK(*/home/ahh/ygib-1.apk*, decompiler=*dad*)
接下来，收集应用的其他一些粗略信息，用来确认你在初始副析环节看到的内容。其中包括
了解应用使用了哪些权限，用户最经常交互的Activity，应用运行的Service，以及是否有其他Intent
接收组件。首先调用permissions命令来检查权限：
In [23]: a.permissions
:[ez]no
[ 'android,permission, CAMBRA',
'android.permission.PROCESs_oUTGOING_CALLS*,
android.pernission. CALL_PHoNB',
android.permission.REcBIVE_SHS*,
android.permission.ACC8SS_GPS* ,
android.permission.SED_SHS*,
android.permission.READ_SMS',
android.permi8sion.WRITB_SHS',
这些权限和你在GooglePlay商店上查看这一应用时所看到的应该是一致的。你可以进一步
使用Androguard，找出这个应用的哪些类和方法实际使用了这些权限，这可能会帮你将分析范围
缩小到一些有题的组件上：
In [28] : show_PexmLsslons (dx)
1 Lcom/yougetitback/androidapp1icatLon/PingService; =>deviceOnline () 2
ACCESS_NETWORK_STATS :
(0x22) --> Landroid/net/ConnectivityManager;*
>getA11NetworkInfo() (Landroid/net/NetworkInfo;
1 Lcom/youget.itback/andro.idapp1icat.Lon/PingService; ->wi fiAval1able (12
(0x12) ---> Landroid/net/ConnectivityManager;-
---
## Page 91
4.2案例分析：移动安全应用
75
>getActiveNetwozkInfo()Landroid/net/NetworkInfo;
：SHSONNS
* - -
1 Lcom/yougetitback/androidapplication/ActivateScreen; -
>sendActivat LonRequestMessage (Landroid/content/Context ;
>getDefault () Landroid/telephony/SmsManager;
Ljava/1ang/String:)V (0x2) ---> Landroid/telephony/SmsManager;
1 Lcom/yougetitback/androidapplication/ActivateScreen;
->sendActivationRequestMessage (Landroid/content /Context;
INTERNET :
 1 1
1 Lcom/yougetitback/androidapplication/ActivationAcknowledgeService;
>doPost (Ljava/1ang/String; Ljava/lang/String:1z (0xe)
1 Lcom/yougetitback/androidapp1ication/ConfirmPinSereen;->doPost (
Ljava/1ang/String; Ljava/1ang/String:)2 (0xe)
--→> Ljava/net/URL; =>openConnection()Ljava/net/URLConnection;
尽管输出结果比较长，但是经过修剪的代码片段还是显示出了一些有趣的方法，如
ConfirmPinScreen类中的doPost方法，这一方法使用了android.permission.INTERNET