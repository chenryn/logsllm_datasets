# CVE-2018-0101 Cisco ASA 拒绝服务&远程代码执行漏洞分析
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 0x00漏洞背景
2018年1月29日，思科公开了旗下ASA防火墙设备的拒绝服务&远程代码执行漏洞（CVE-2018-0101），并在2月期间多次对公开信息进行修改和更新。在思科更新漏洞相关信息期间，该漏洞也有更多信息被披露出来，其中包括漏洞发现者——NCC
Group研究人员Cedric Halbronn关于漏洞细节的更多信息和安全研究者根据相关资料完成的PoC代码（拒绝服务部分）。
从已经公开的资料来看，该漏洞影响多个版本的思科安全产品和软件。同时，受影响的系统需在网络设备端口上开启SSL服务或IKEv2
VPN服务。如果该漏洞被成功利用，将导致远程设备内存破坏，造成设备重启或拒绝服务，甚至允许攻击者在无需用户验证的情况下实现远程代码执行，进而远程控制设备并产生进一步的攻击行为。本文出于探究漏洞技术原理，了解此类网络设备漏洞分析调试方法的目的，从ASA设备解析XML数据包的过程入手，分析该漏洞产生的原因，并将部分技术细节予以呈现。
## 0x01 漏洞简要介绍
####  1. 漏洞原理
CVE-2018-0101漏洞存在于思科ASA设备的XML解析器处理XML数据包时的分配和释放内存的过程当中，是一个Double
Free漏洞，攻击者可以通过发送精心构造的SSL 协议的HTTP
XML数据包来完成对受漏洞影响系统的攻击。当漏洞触发时，可导致系统崩溃重载，ASA设备停止接受VPN验证请求，或允许攻击者远程执行代码，获得对系统的控制。
####  2. 漏洞影响范围和脆弱性配置信息
思科官方在最初的公开信息中声称：多个版本的ASA和下一代防火墙平台受漏洞影响，且受影响设备需要配置启用WebVPN功能，并允许用户访问。由于发现了新的攻击向量，思科官方在2月份数次更新了安全公告，并在更新中将开通SSL
VPN的说法引申为“Secure Socket Layer (SSL) services or IKEv2 Remote Access VPN
services”。更新后的受漏洞影响设备和软件列表如下所示：
Ø 3000 Series Industrial Security Appliance (ISA)
Ø ASA 5500 Series Adaptive Security Appliances
Ø ASA 5500-X Series Next-Generation Firewalls
Ø ASA Services Module for Cisco Catalyst 6500 Series Switches and Cisco 7600
Series Routers
Ø ASA 1000V Cloud Firewall
Ø Adaptive Security Virtual Appliance (ASAv)
Ø Firepower 2100 Series Security Appliance
Ø Firepower 4110 Security Appliance
Ø Firepower 4120 Security Appliance
Ø Firepower 4140 Security Appliance
Ø Firepower 4150 Security Appliance
Ø Firepower 9300 ASA Security Module
Ø Firepower Threat Defense Software (FTD)
Ø FTD Virtual (FTDv)
其中，Cisco ASA中易受攻击的功能列表和配置信息如下所示：
在上图的信息中：
1. ASDM仅受http 命令配置列表范围的IP攻击影响；
2. Cisco Security Manager仅受http 命令配置列表范围的IP攻击影响；
3. MDM 9.3.1以上版本受上述配置影响；
4. 其他API 9.3.2以上版本受上述配置，且仅受http 命令配置列表范围的IP攻击影响；；
5. SAML SSO 9.6以上版本受上述配置影响。
FTD软件中易受攻击的功能和配置信息如下所示：
我们可以看到，上图中的配置信息，均与Web VPN的配置有关。
####  3. 修复方案
由于在1月29日发布报告后发现了新的攻击向量，所以Cisco官方在2月份的后续更新中，对固件升级的版本信息做了变更，细节参见Cisco官方关于CVE-2018-0101的说明。版本升级建议如下：
**Cisco ASA** **列表：**
**Cisco FTD** **列表：**
****
## 0x02 调试环境准备
####  1. 调试环境信息
如果没有ASA设备，需要通过搭建模拟调试环境并修改固件来完成调试的前期准备，具体思路就是GNS3 + Qemu +
修改后的系统固件；对于有真机作为调试环境的情况而言，则可直接修改固件，使之进入调试模式，并将其刷入ASA设备，然后在终端设备启用gdb，并通过串口连接远程gdbserver，即可完成调试前的准备工作。在上述两种方案中，本文使用Cisco
ASA 5505 series + ASA924-k8.bin + Ubuntu 16.04-3 amd64作为调试环境，完成了漏洞的调试过程。
以下是调试设备软、硬件信息：
设备名称
|
ASA-5505  
---|---  
硬件信息
|
AMD Geode (x86)  
Marvell 88E6095 Gigabit Ethernet Switch  
软件信息
|
ASA924-k8.bin  
Linux 2.6.29.6  
lina 9.2.4  