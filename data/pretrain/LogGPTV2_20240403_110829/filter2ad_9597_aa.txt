**作者：腾讯科恩实验室  
公众号：**

腾讯安全科恩实验室的研究论文《Order Matters: Semantic-Aware Neural Networks for Binary Code Similarity Detection》入选了人工智能领域顶级学术会议AAAI-20。该研究的核心在于利用AI算法解决大规模二进制程序函数相似性分析的问题。本文将深入解读这篇论文，点击链接获取完整论文。

## 引言与背景
二进制代码分析是信息安全领域的重要研究方向之一，其中一项关键任务是在无法访问源代码的情况下检测相似的二进制函数。同一份源代码在不同编译器、平台或优化选项下生成的二进制代码可能完全不同。因此，我们的目标是从不同的二进制代码中识别出源自同一份源代码的函数。传统方法通常采用图匹配算法来解决这一问题，但这些算法速度慢且准确性较低。近年来，随着深度学习技术的发展，研究人员开始尝试在控制流图（CFG）上应用图神经网络，取得了显著的效果。

### Gemini算法简介
Gemini是一种基于图神经网络的算法，其输入为两个二进制函数对，输出则是这两个函数之间的相似度得分。首先，Gemini将二进制函数的控制流图作为输入，并通过人工设计的方法将每个基本块（block）转换成低维向量表示。随后，它使用Structure2vec算法计算图嵌入（graph embedding），最后通过孪生网络（siamese network）计算相似度得分，并利用梯度下降法训练模型以最小化损失。相较于传统方法，Gemini不仅提高了处理速度，也大幅提升了准确率。

尽管如此，Gemini仍存在一些不足之处。例如，在特征提取过程中，由于采用的是人工设计的方式，导致每个基本块仅被压缩为8维向量，这可能会丢失大量语义信息。此外，现有模型未能充分利用二进制代码中节点顺序这一重要特征。

### 提出的新框架
针对上述问题，我们提出了一种新的框架，该框架由三个主要模块组成：语义感知（semantic-aware）、结构感知（structural-aware）以及顺序感知（order-aware）。具体来说：

- **语义感知模块**：利用BERT等预训练模型从控制流图中提取语义信息。
- **结构感知模块**：采用消息传递神经网络（Message Passing Neural Network, MPNN）算法生成包含语义和结构信息的图嵌入。
- **顺序感知模块**：通过卷积神经网络（Convolutional Neural Network, CNN）处理控制流图的邻接矩阵，从而捕捉到节点顺序特征。

## 模型详解

### 整体架构
新提出的模型接收二进制代码的控制流图为输入，并依次经过上述三个模块进行处理，最终生成用于比较相似性的图嵌入。整个流程如图4所示。

#### 语义感知模块
在此模块中，我们采用了BERT模型对控制流图中的token进行预训练，以获得更丰富的语义表示。除了标准的掩码语言建模（Masked Language Model, MLM）外，还引入了相邻节点预测（Adjacency Node Prediction, ANP）、块内图关系判断（Block Inside Graph, BIG）以及图分类（Graph Classification, GC）等辅助任务，旨在增强模型对于控制流图内部结构的理解能力。

#### 结构感知模块
经过BERT预训练后，利用MPNN进一步细化控制流图的表示。MPNN通过定义的消息传递、更新及读出函数实现了对图结构的有效编码。具体实现时，消息传递阶段采用多层感知机（Multi-Layer Perceptron, MLP），更新阶段则使用门控循环单元（Gated Recurrent Unit, GRU），而最终的读出操作则是通过对所有节点状态求和完成。

#### 顺序感知模块
为了更好地保留并利用节点间的顺序信息，我们在该模块中引入了CNN。通过分析不同类型图及其对应邻接矩阵的特点，可以发现即使在节点位置发生变化时，某些局部模式依然保持不变。因此，借助于具有平移不变性和尺度不变性的CNN，能够有效地从邻接矩阵中提取出有用的顺序特征。

总之，通过结合以上三种不同视角下的特征提取机制，本研究提出的新框架能够在保证较高效率的同时，显著提升二进制函数相似性检测任务的表现。