IPFlow
##
172.16.56.15
192.168.25.6
10.65.34.54
10.18.18.18
172.16.87.11
192.168.57.2
10.18.18.18
172.16.43.131
10.18.18.18
192.168.15.12
10.231.76.8
10.18.18.18
192.168.89.111
-Frag
10.18.18.18
10.34.67.89
10.23.67.9
10.18.18.18
10.168.45.3
源IP地址
flows
64
tineout in
002
1829
Total
921340
92871
30minutes
tion
0.0
alloc failures
(567238991totalpackets）:
他还打印了在
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
192.168.0.175
目的IP地址
Web
6服务器开始出现问题的前几周他保存的缓存数
源端口号
45987
21453
52967
65212
6588
22387
8935
17330
29589
1783
34511
8745
19
19
#
19
19
中中3
目的端口号
馆
（续）
17
17
G
17
二
V
议
---
## Page 174
来只需联系那个网络的管理员就可以得到进一步的信息。不过这对DoS攻击不太可能。
Internet号码注册处，从它的“Whois”数据库查出这个入侵IP地址属于哪个网络。接
假 IP 地址，这个问题比较难判断。假如源IP 地址不是伪装的，则可以咨询 ARINI 美
址源不确定，不知道是攻击源本身是分布的，还是同一个真实地址伪装出许多不同的）
时使用不同的工具。在任何情况下，超负荷的数据流都会拖垮Web服务器。然而攻击地
口号为7）不断发送UDP 数据包实现的。攻击看似发自两个地方，可能是两个攻击者同
事件推理
交互问答
开始研究到底发生了什么，以及该如何尽快地修复故障。
里显示的内容表明：只有2%的数据包的大小在33～64B之间。
据（正常状态的数据）。正常路由日志如下所示：
小杨的Web服务器受到了什么样的攻击呢？这一攻击是通过对回显端口（echo，
注意网站的访问量直线下降。很明显，在这段时间没人能访问他的Web服务器。小杨
IP packet size distribution这个标题下的两行显示了数据包按大小范围分布的百分率。这
IP-
，如果地址伪装过，那么他怎样才能追踪到攻击者？
小杨的Web服务器到底发生了什么？可能的攻击类型是什么？
如果地址未伪装，那么小杨如何才能追踪到攻击者？
the
#
aring
96
sta
128
in
8
.974
15
0.0
active(Sec） Idle(Sec)
18.0
384
1.9
28 6
6288
2
第5章DoS防御分析151
司
（口品回限）
同
---
## Page 175
网络上游。
的流量总是不会错的。这还能防止 DoS 攻击，但为了达到效果，这些过滤器应尽量设置在
网络。这将防止攻击者伪装 IP 地址，从而易于追踪。网络流量过滤软件过滤掉网络不需要
“粗管子打败细管子”的攻击。攻击者若能“指使”更多带宽，有时甚至是巨大的带宽，就
能击溃带宽不够的网络。在这种情况下，预防和缓解应相辅相成。
针对措施
7 上的UDP进入流量。这样做会显著降低网络到服务器的流量。
络性能。那么下一步工作是联系上游带宽提供商，想请他们暂时限制所有在小杨的网站端口
UDP包。这种做法会使服务器丧失某些功能，如DNS，但至少能让Web服务器正常工作。
难用限制某个地址或某一块范围的地址来阻止攻击，因此决定禁止所有发给192.168.0.175
上堵截攻击。快速地为路由器设置了一个过滤规则。因为源地址的来源很随机，他们认为很
进行洪泛式攻击，因此小杨他们的下一步任务就是阻止这一攻击行为。首先，小杨在路由器
Web服务器日志也一切正常。这种现象与基于UDP的拒绝服务攻击的假设还是很相符
有趣。他接着又将注意力集中到路由器日志上。
常随机)。地址看起来是随机的，只有一个源地址是固定不变的，其源端口号也没变。这很
（即回显端口）。这看起来很像拒绝服务攻击（但还不能确定，因为攻击的源IP地址分布非
性，见表5-1中黑色标记处。攻击的目标显然是Web服务器（192.68.0.175），端口为UDP7
是司法部门介入，很难查到源头。
能有许多路由器，而且属于不同的组织。另外，必须在攻击正在进行时做这些分析。如果不
到那个 IP 地址源。然而这样做是非常难的，因为在Web Server 和攻击者的发起 PC 之间可
缓存，才能确定流量进入了哪个接口，然后通过这些路由器的接口，逐个往回追踪，直至找
查询NetFlow高速缓存。但是为了追踪这个伪装的地址，必须查询每个路由器上的NetFlow
152UNIX/Linux网络日志分析与流量监控
的。
上没有任何问题。他还发现，案发时路由器日志里还有大量的“UDP-other”数据包，而
对于预防及缓解这种带宽相关的 DoS 攻击并没有什么灵丹妙药。本质上，这是一种
网络流量速率限制。一些路由器有流量速率的最高限制。这些限制条款将加强带宽策
网络入口过滤网络服务提供商应在他的下游网络上设置入口过滤，以防止假信息包进入
有许多方法可以使攻击更难发生，或者在攻击发生时减小其影响，
此时，可假设攻击者正是用许多小的UDP数据包对Web服务器的回显（echo7）端口
他发现，攻击发生时路由器日志上有大量的64B的数据包，而此时Web服务器日志
经过分析之后，将防火墙日志和路由器日志里的信息关联起来，发现了一些有趣的相似
假如源地址是伪装的，追踪这个攻击者就麻烦得多。若使用的是Cisco路由器，则还需
这样的做法为Web服务器减轻了负担，但攻击仍能到达Web，在一定程度上降低了网
路由器最初的临时DoS访问控制链表（ACL）如下：
access-list105permit ip any any
access-list 105denyudp anyhost 192.168.0.175
 acces-list 121 remark Temporary block DoS attack on web server 192.168.0.175
具体如下：
的
口
---
## Page 176
息。例如，某网站在受到DoS攻击时TCP连接如下：
几，根据TCP三次握手原理分析可知，这肯定不是正常现象，网络肯定存在问题，需要
通过结果可以发现网络中存在大量TCP同步数据包，而成功建立TCP 连接的却寥廖无
输入以下命令：
以及IDS系统来仔细判断。后两者将在14章中详细讲解。最快捷的方式还是命令行，
能实时显示网络连接情况，
工具，当然，利用Sniffer Pro以及科莱网络分析工具也可以达到同样效果。Sniffer Pro
RPF的妙处在于，它阻止了所有伪装源IP地址的攻击。
CEF表上不具有与指向接收数据包时的接口一致的路由，路由器就会丢掉这个数据包。丢弃
工具单点传送 RPF，这是CEF 用于检查在接口收到的数据包的另一特性。如果源IP 地址
者使用的攻击工具，这将能协助阻止攻击。主机监听工具能警告管理员系统中是否出现DoS
攻击。
略，并允许一个给定类型的网络流量匹配有限的带宽。这一措施也能预先缓解正在进行的
所示。
进一步查实，如果数值很高，例如达到上千数值，那么很有可能是受到了攻击。如图5-1
址就能初步判定攻击类型，
使用入侵检测系统和主机监听工具。IDS能警告网络管理员攻击的发生时间，以及攻击
在图5-1 中，OSSIM系统中的 Snort 检测到DoS 攻击并以图形方式显示大量告警信
利用主机监测系统和IDS 系统联合分析，可以很快发现问题，例如通过EtherApe
下面进行DoS攻击检测。
#netstat -anlgrep SYN_RECV|wc-1
12h13h14h15h1h171ah19h2h21h22h2
营
茗
这时可以采用OSSIM系统中的流量监控软件，例如Ntop，
，如果遇到DoS攻击，从它内部密密麻麻的连线，以及IP 地
图5-1OSSIM发现DoS攻击
23h
163
rity Evonts:
L150
Top
10 Hosts
12Oct
wit
第5章DoS防御分析153
国
X7
---
## Page 177
发出的请求都是完全合法、符合标准的，
加复杂。最困难的是必须在攻击期间才能做准确分析，一旦攻击结束就只好去日志系统里查
往往涉及很多运营商，以及司法机关，工作量和时间都会延长，如果涉及跨国追查工作就更
直到找到发起的IP地址源。但是这样做涉及多个AS，如果在国内，寻找其攻击源头的过程
据，才能确定流量进出在哪些接口，然后对这些路由器一次一个接口地往回逐跳追踪查询，
IP 地址属于哪个网络。
址伪装出的许多不同IP地址不好确定。
很快拖垮Web服务器。难点在于攻击地址源不确定，攻击源本身是分布的，还是同一个地
现的。这次攻击看起来源自两个地方，很可能是两个攻击者使用不同的工具。大量的数据流
疑难解答
击方式为SYN Flood攻击。
据包往往指向同一个 IP 地址。至此可以验证上面的判断：这台主机遭受到 DoS 攻击，而攻
询了。
协议，查看TCP标志发送所有的数据包均为SYN置1，即TCP同步请求数据包，而这些数
154
看了上面的实际案例我们也了解到，许多 DoS 攻击都很难应对，因为搞破坏的主机所
3．如果 IP 地址是伪装的，这种追踪比较麻烦，需要查询每台路由器上的 NetFlow 数
2．假设地址不是伪装的，小杨可以查询 ARIN，从它的 Whois 数据库中查出这个入侵
1．小杨的服务器遭到了 DoS攻击，攻击是通过对端口7不断发送小的UDP 数据包实
这条命令得到的信息更详细。数值达到1989，有近两千条，这明显说明受到了DoS攻
还可以用下面的 shell命令，显示哪个 IP 连接最多。
这么大的数值再配合图 5-1 可确定很显然受到 DoS 攻击。
统计“SYN_RECV”状态的数量：
UNIX/Linux网络日志分析与流量监控
2192.168.150.20
1192.168.150.10
1989
#netstat -na Igrep SYN _RECV |wc -1
1989192.168.150.200
netstat
9
18
168
168,150
150
239:
.239:
239:
239:
只是数量太大。我们可以在路由器上借助恰当的
7.7.157
7.7.
.151:77