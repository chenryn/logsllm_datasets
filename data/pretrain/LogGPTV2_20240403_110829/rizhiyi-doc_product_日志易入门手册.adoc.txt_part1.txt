= 日志易入门手册
北京优特捷信息技术有限公司
v4.4, 2022-10-28
== 上传日志
日志易产品支持的数据接入方式主要包括以下三种，本次示例我们将采用第三种接入方式---“web方式”，关于其它方式的数据接入配置，请参阅《日志易数据接入手册》。
1. 日志易agent：通过使用日志易Agent进行采集。我们推荐部署版用户采用此种方式。
2. rsyslog agent：使用rsyslog5.8.0或更高版本，确保您拥有sudo权限，可通过配置rsyslog agent转发本地日志文件到日志易。
3. web方式：使用http post上传日志文件。
=== 下载样例文件
作为快速入门示例，您可以下载使用日志易已有的样例文件：
https://www.rizhiyi.com/install/RizhiyiSample.log                 
=== 文件概述
日志易提供的样例文件内容来自日志易多个界面的访问日志，如登录界面，告警界面，搜索界面，以及仪表盘的界面等等。
通过浏览我们大致可以得知，样例文件记录的是时间戳在2017年6月12日到6月13日之间事件，共计约1万条数据，文件大小为4.8MB。 
在通过web上传其他文件时，请参照界面提示的上传大小的上限（可在后台调整）。
在日志解析过程中，如果上传日志是日志易识别的日志格式，日志将被自动转化为结构化数据并做全文索引，否则，日志将默认做全文索引。对于样例文件这类格式是每一行是一个事件的情况，如果上传日志的时间戳符合标准格式，日志易将自动解析此事件的时间戳，以样例文件为例，解析后的时间戳对应各事件发生时的时间戳；若上传日志中没有时间戳或不符合标准时间戳格式，日志易将以收到日志时间作为该事件的时间戳。
=== 上传文件
下载好样例文件后，通过日志易的界面进行上传，也就是我们所说的“本地上传”（通过web上传）。步骤如下：
1. 进入“本地上传”界面：点击日志易顶部导航栏，选择“数据流”下的“本地上传”，如下图所示。
+
image::images/web-upload.png[]
2. 进入到“本地上传”界面内，点击“本地上传”按钮，选中之前下载好的“RizhiyiSample.log”文件，并点击“打开”。日志进入等待上传状态：
+
image::images/web-upload-wait.png[]
3. 给appname和tag自定义名称。我们暂给appname命名为logsample，给tag命名为demo，点击“上传”按钮，若看到到“上传完成”的弹窗提示，则代表样例文件已成功上传到了日志易的系统内。
+
image::images/web-upload-succ.png[]
=== 验证
为确保日志上传成功，用户可以直接在搜索框用以下搜索语句对样例文件进行查询：
[source,bash]
appname:logsample
或
[source,bash]
tag:demo
若您的系统中存在多个appname相同或tag相同的文件，需要使用下面语句：
[source,bash]
appname:logsample AND tag:demo
表示在全部事件中搜索“appname”为“logsample”且“tag”为“demo”的日志全文。其中“AND”作为逻辑运算符，起到连接前后的作用。
[NOTE]
====
在设置时间范围时将文件的时间戳包含在内。
====
== 搜索界面
在使用日志查询指令之前，先大致了解一下搜索功能界面。您可以不用掌握复杂的搜索语句就可以从搜索界面得到大量信息。
=== 模块介绍
我们把常用的数据展示模块和其他界面的跳转标签用数字标出，每个功能模块请参照数字在表格查看说明：
image::images/search-page-intro.png[]
[options="header",cols="1,2,8"]
|=====
|数字|名称|描述
|1
|选中数据集
|默认不选择，表示搜索授权范围内的全部数据。日志易通过设置数据集来对日志数据进行分类，配置和使用数据集可以有效的缩短输入语句。完整数据集列表可通过页面左侧中部位置的数据集展开收起按钮拖拽展开查看。
|2
|搜索框
|在搜索框中输入查询语句，点击“搜索”查看结果。
|3
|时间选择器
|设定查询数据的时间范围。默认设置是查询最近10分钟为时间范围。
|4
|时间轴
|显示随时间统计的日志事件数量。可以试着点击任意一个方块，观察时间范围的改变（变化成该方块所代表的时间域）。
|5
|字段列表
|用来展示查询到的前 1000 条日志数据中含有的不同类型的字段。根据字段类型的不同，字段名左侧有不同的标记：`A`表示文本类型、`#`表示数值类型、`B` 表示布尔类型、`!`表示高基数类型，建议不要用于分组统计。
|6
|事件列表
|显示搜索结果中日志数据的原始视图，一般用来查看原始日志及抽取的字段
|7
|搜索保存和读取
|根据选择格式，将搜索框内的查询语句保存下来，方便调用。
搜索列表可以查看，过滤之前保存的搜索语句。
|8
|统计
|根据搜索结果形成表格和其他可视化图形
|9
|模式
|对日志进行自动归类，方便用户对相似度高的日志集中分析
|10
|数据集展开收起按钮
|拖拽展开或收起数据集展示区域，在区域内选中的数据集会展示在搜索框顶部的选中数据集区域内
|=====
=== 时间选择器
该模块使用下拉菜单快速挑选预设时间范围或自行设置时间范围。通过调整时间选择器，可以缩小查询范围，实现快速的排除或查询问题。
我们常用的是“快捷选项”的下拉菜单内的时间范围，是用户常用的设置，并由系统提前配置好，在“快捷选项”的下拉菜单内，类型可分为以下几种：
* 实时：查询内容为实时变化的情况下，可设置实时类的时间范围，查询结果会根据选定的频率来动态刷新，而不是一直处于静态不变的。
* 最近/相对：两者主要区别在截止时间的不同，“最近”的截止时间均为当前时刻，而“相对”下面的截止时间则不一定。
具体选项见下图：
image::images/timerange-fast.png[]
对于样例日志来说，因为其自身不带时间戳，所以该日志时间戳为上传时的日期。若您在上周上传了样例文件，而今天您想查看样例文件的内容，不调整时间范围的情况下直接搜索会导致得到“查询无结果”的提示，而默认查询时间范围为最近十分钟。因此，您需要将时间选择器配置为“上周”。若这期间其他数据过多影响查看，您也可以通过“自定义时间范围”的下拉菜单，将范围精确到上传日期当天或具体时间段。
除了常用的“快捷选项”外，若您想了解更多时间选择器的使用，请参考《使用手册》的“3.1.1时间范围选择”。
== 日志查询
=== 搜索入门
完成样例文件的上传后，我们先来学习下使用简单命令进行日志查询。
打开搜索页面后，搜索框默认的输入值为“*”，表示搜索时间范围内的所有日志数据。此时把鼠标放在搜索框内会出现下拉菜单，作为一种帮助功能，方便用户搜索。详细内容参考《使用手册》的“3.1.2搜索提示”
=== 字段过滤
==== 字段列表
字段列表默认采用二级菜单折叠方式，点击一个字段将出现二级菜单显示该字段出现次数最多的前一百个值及它们的统计计数。通过选择字段（单选或组合），可对当前结果再次过滤检索，并同时刷新事件列表与搜索框的内容，根据选定的字段和不同操作（选择过滤或是屏蔽字段），可自动形成新的查询语句并提交，即时的更新搜索结果和直方图，一定程度上取代了代码的简单输入。
image::images/field_stats.png[]
假设您希望取出POST方法的访问日志，按照上图的方式，在apache.method 字段里勾选“POST”，点击“过滤选中字段值”。同时搜索框内的搜索语句也会根据这一动作形成相应的查询命令行，嵌套在查询所有样例文件的外面。语句将变为:
[source,bash]
appname:logsample AND 'apache.method':POST
==== 事件列表
事件列表显示搜索结果中日志数据的原始视图，一般用来查看原始日志及抽取的字段。同上一节提到的字段列表过滤功能一样，在事件列表中也可以对所选择的字段过滤或屏蔽，取代查询语句，搜索框中语句会根据不同操作而随时更新。
若您希望通过事件列表上的操作，取出POST方法的事件， 在任意一个“POST”文本上双击或鼠标拖动选择，在弹出的方块内选择“添加到搜索”，如下图
image::images/search-event-content-menu.png[]
可以看到搜索框也会随之改变。选用的字段也会高亮出来。
image::images/search-keyword-highlight.png[]
但是事件列表过滤是对日志整体文本的过滤，也就是只要某条事件的全文含有该字段值，就符合过滤条件，与“字段列表”的过滤是针对某一字段值的操作不同。为了避免在其他字段位置出现POST字样的干扰，建议使用字段列表过滤。
=== 搜索语句
为了更好的使用日志易的数据查询功能，除了界面勾选、拖动的筛选方式外，您还需要掌握些基本的日志查询语句和相关语法。
==== 字段查询与过滤
为方便您更好的了解字段查询与过滤语句的构成，我们在本册主要对两个常用的成分---“逻辑运算符”和“数值范围”举例讲解。
===== 逻辑运算符
在学习字段列表和事件列表的过滤时，我们可以发现搜索框随之刷新的查询语句中是由“AND”或“OR”连接的，对这类表达式我们称之为逻辑运算符，且必须大写，更多详情见《使用手册》的“3.3.4 逻辑运算符”。
用查询语句表示“3.2.2事件列表”的过滤逻辑。也就是在样例文件中，筛选出“GET”方法的所有事件，如下：
[source,bash]
* AND appname:logsample AND GET NOT apache.method:POST
'*' 表示查询所有事件，第一个AND用来筛选出样例文件的所有数据；第二个AND筛选出全文含有GET字符的所有事件，对于查询的词汇系统不区分大小写；最后一个逻辑运算符为“NOT”，用来将http方法的字段为“POST”的事件过滤掉。了解更多关于字段查询的内容，请查看《入门手册》的“3.3.基础搜索语法”。
===== 数值范围
以apache.status的筛选为例，若您想重点看状态码：200，206，301，302，303，304的情况，使用逻辑运算符逐个连接字段值的方法就显得没那么简洁了，如下：
[source,bash]
(* AND appname:logsample) AND (apache.status:200 OR apache.status:206 OR apache.status:304 OR apache.status:303 OR apache.status:302 OR apache.status:301)
若您的筛选对象和例子一样，有一定规则，并且也属于数值类的字段，对于这类的情况，我们可以通过限制数值范围来筛选过滤日志，注意用来赋值的“:”不要忘记。若您想了解更多对数值类字段控制范围的指令可参考《入门手册》的“3.3.5 数值范围”。查询语句如下：
[source,bash]
* AND appname:logsample AND apache.status:<400
筛选后的数据通过字段列表来查看，得到结果均为状态码<400的事件。
image::images/apache-status-example.png[]
掌握了字段查询，您可对特定事件进行快速排查，过滤掉无用的记录，提高对日志理解和掌握的效率。