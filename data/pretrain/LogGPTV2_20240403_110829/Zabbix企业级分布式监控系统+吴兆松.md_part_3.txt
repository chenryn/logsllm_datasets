监控系统更重要的功能是告警和故障处理，这对及时解决问题和故障自愈非
常重要。告警的时候，需要考虑到故障的有效汇报和集中汇报，防止出现“告警
3
---
## Page 20
Zabbix企业级分布式监控系统
洪水”，即同一类告警信息重复大量地发送。
监控系统的开源软件现状
1.3
前面简单介绍了监控的原理，下面看看已有的解决方案。
在监控软件中，开源的解决方案有流量监控（MRTG、Cacti、SmokePing、
Graphite等）和性能告警（Nagios、Zabbix、ZenossCore、Ganglia、OpenTSDB
等）可供选择，并且每种软件都有自己的特点和功能，各自的侧重点和目标不完
全相同，在设计理念和实现方法上也大同小异，但都具有共同特征，例如，采集
数据、分析展示、告警以及简单的故障自动处理。最终都能达到对IT系统服务可
用性的一个完全展示。下面将详细介绍各自的特点。
1.3.1MRTG
MRTG（MultiRouterTrafficGrapher）是一套可用来绘制网络流量图的软件，
由瑞士奥尔滕的TobiasOetiker与DaveRand所开发，以GPL授权。
MRTG最早的版本是在1995年春推出的，用Perl语言写成，可跨平台使用，数
据采集用SNMP协议，MRTG将收集到的数据通过Web页面以GIF或PNG格式绘制
出图像，并以日、周、月为单位分别绘出，可以查询最大值和最小值，如图1-6所示。
Weekly'Graph (30 Ilinute Average)
390.0 k
1009
0.0k
lur
luc
205.7
Ionthly’Graph (2 Hour Average)
In:42.7kb/s（0.4%）AverageIr:14.4kb/s（0.1%)Current
Yearly'Graph(1DayAverage)
280.0k
140.0k
70.0K
图1-6
4
---
## Page 21
第1章监控系统简介
MRTG原本只能绘出网络设备的流量图，后来发展出了各种插件。因此，网
络以外的设备也可由MRTG监控，例如，服务器的硬盘使用量、CPU的负载等。
1.3.2Cacti
Cacti（英文含义为仙人掌）是一套基于PHP、MySQL、SNMP和RRDtool
开发的网络流量监测图形分析工具，如图1-7所示。它通过snmpget来获取数据，
使用RRDtool绘图，但使用者无须了解RRDtool复杂的参数。它提供了非常强大
的数据和用户管理功能，可以指定每一个用户能查看树状结构、主机设备以及任
何一张图，还可以与LDAP结合进行用户认证，同时也能自定义模板，在历史数
据的展示监控方面，其功能相当不错。
graphs
orrest
图1-7
Cacti通过添加模板，使不同设备的监控添加具有可复用性，并且具备可自定
义绘图的功能，具有强大的运算能力（数据的叠加功能）。
1.3.3SmokePing
SmokePing主要用于监视网络性能，包括常规的ping、WWW服务器性能、
DNS查询性能、SSH性能等。底层也是用RRDtool做支持，特点是绘制的图非常
5
---
## Page 22
Zabbix企业级分布式监控系统
漂亮，网络丢包和延迟用颜色和阴影来表示，支持将多张图叠放在一起，如图1-8
所示。其作者（TobiOetiker）还开发了MRTG和RRDtool等工具。
SmokePing的站点为：http://tobi.oetiker.ch/hp/。
Last 30Hours
700
600m
500m
400m
300m
200m
100m
Thu00:00
Thu 12:00
Fr100:00
median rtt: 63.0m5 avg 646.0 ms max 23.6asain
38.6m5
5now87.8mssd717.5mam/s
packetloss:0.02avg4.87max
0.008min0.00now
losscolor:
0
probe:
end:Fri 0ct 700:58:21 2011
图1-8
1.3.4Graphite
Graphite是一个用于采集网站实时信息并进行统计的开源项目。Graphite服务
支持平均每分钟4800次更新操作，采用简单文本协议，具有绘图功能，其即插即
用的功能可方便地用于任何需要监控的系统上。Graphite的界面如图1-9所示。
Graphite
Tree
SerAutC
Graphte
agents
www
7.5
3.0
1.5
us#g
s
errs
mm
BAM
Fri12PM
Fri4PM
FnBPM
at12AM
carbonagentswwwitnihao_com.a.cachebuktfiower
MyGraph
No savedgraph
UserGr
Noavedgraphs
图1-9
和其他监控工具不同的是，Graphite本身并不收集具体的数据，这些数据收
集的工作通常由第三方工具或插件完成（如Ganglia、Nagios、collectd、statsd、
Collectl等）。因此，可以说，Graphite是一个绘图工具。
6
---
## Page 23
第1章监控系统简介
值得一提的是，Graphite用Python语言编写，采用Django框架，对于熟悉
Python的用户（通常是运维人员）来说，将是一个不错的绘图工具选择。
简单地说，Graphite做两件事：存储数据和按需绘图。
Graphite的官方站点为：http://graphite.wikidot.com/。
1.3.5Nagios
Nagios是一个企业级的监控系统，可监控服务的运行状态和网络信息等，并
能监视所指定的本地或远程主机参数以及服务，同时提供异常告警通知功能等。
Nagios 可运行在Linux和UNIX平台上，同时提供一个可选的基于浏览器的
Web界面，以方便系统管理人员查看网络状态、各种系统问题，以及日志等，如
图1-10所示。
Nagios的功能侧重于监控服务的可用性，能及时根据触发条件告警。
目前，Nagios也占领了一定的市场份额，不过从笔者的观察来看，Nagios 并
没有与时俱进，已经不能满足于多变的监控需求，架构的扩展性和使用的便捷性
有待增强，其高级功能集成在商业版NagiosXI中。
Nagios'
IOS
Version3.1.0
January25,2009
Read what's now in Nagios3
Grid
Nagios'
Nagios
Enterprises
STAURCEFORCE.NE
图1-10
1.3.6 Zenoss Core
ZenossCore（简称Zenoss）是开源企业级IT管理软件，它允许IT管理员依
---
## Page 24
Zabbix企业级分布式监控系统
靠单一的Web控制台来监控网络架构的状态和健康度。
ZenossCore的强大功能来自深入的列表与配置管理数据库，用于发现和管理
公司IT环境的各类资产（包括服务器、网络和其他结构设备）。Zenoss可以创建
关键资产清单和对应的组件级别（接口、服务、进程、已安装的软件等）。建立好
模型后，Zenoss就可以监控和报告IT架构中各种资源的状态和性能状况了。同时
还提供与CMDB关联的事件和错误管理系统，以协助提高各类事件和提醒的管理
效率，以此提高IT管理人员的效率。
ZenossCore采用SNMP来采集数据，其界面如图1-11所示。
ZenOsS'ICoRE
ProdSat
apci
Prod
AV310002-EF-22
buld
uosonpaid
Devices/
catalyst500
cen14-641
Producton
cm4b-64
Peoducian
loca
cnt46-64
ce4-64
hp3055
hp3055
2
图1-11
1.3.7Ganglia
Ganglia 是一个跨平台的、可扩展的、高性能的分布式监控系统，如集群和
网格。它基于分层设计，使用广泛的技术，用RRDtool 存储数据，具有可视化
界面，适合于对集群系统的自动化监控。其精心设计的数据结构和算法使得监
控端到被监控端的连接开销非常低。目前已经有成千上万的集群正在使用这个
所示。
8
---
## Page 25
第1章
监控系统简介
UCBerkeley Grid Report for Pri,05Deo200806:50:36-0800
Last
Sarled
司
ICBerkeley Crid(9
PeTotal
RAD LN
(PVaTo1al:
38
Lasthou
Hoets
CPUaTerel:
Lasthut
10
Saret
ey
CPUeTotal:
图1-12
1.3.8
3OpenTSDB
开源监控系统OpenTSDB用HBase存储所有时序（无须采样）的数据，来构
建一个分布式、可伸缩的时间序列数据库。它支持秒级数据采集，支持永久存储，
可以做容量规划，并很容易地接入到现有的告警系统里（如图1-13所示）。
OpenTSDB可以从大规模的集群（包括集群中的网络设备、操作系统、应用程序）
中获取相应的采集指标，并进行存储、索引和服务，从而使这些数据更容易让人
理解，如Web化、图形化等。
Se
在对实时性要求比较高的场
合，OpenTSDB 是一个很好的选
Network
TSDRPC
Gear
择。它支持秒级别的数据采集，这
TSD
TSD
在其他监控系统中是无法想象的。
RPC
HBase RPC
因得益于其存储系统的选择，所以
webUI
Scripts
(alerting.
Collector
key
它支持大数据分析。因此，这个开
Humans
Maindlrection
源软件在未来的环境中会有更多
ofdatanow
的用户，也会获得更广泛的支持。
图1-13
9
---
## Page 26
Zabbix企业级分布式监控系统
1.3.9 Zabbix
Zabbix是一个分布式监控系统，支持多种采集方式和采集客户端，有专用的
Agent（代理），也可以支持SNMP、IPMI、JMX、Telnet、SSH等多种协议，它将
采集到的数据存放到数据库，然后对其进行分析整理，达到条件触发告警。其灵
活的扩展性和丰富的功能是其他监控系统所不能比的。相对来说，它的总体功能
做得非常优秀，其界面如图1-14和图1-15所示。
ZABBIX
8659
002%
0.03%
0.05%
OTnggerocessorladistoohigh on zabbix server[2]
图1-14
ZABBIX
Mapswebappm3D
webappr
OUT
900M
图1-15
10
---
## Page 27
第1章监控系统简介
该监控工具也是本书的重点，具体功能将在后面详细介绍。
从以上各种监控系统的对比来看，Zabbix都是具有优势的，其丰富的功能、
可扩展的能力、二次开发的能力和简单易用的特点，读者只要梢加学习，即可构
建起自己的监控系统。
1.4监控系统的原理探究
前面已经介绍了为什么需要监控系统，下面将深入介绍监控系统的原理。
1.监控系统的诞生
首先来看一下监控系统的使用者都有哪些？
试想一个很小的网站，刚上线也许就只有一个VPS或者一台服务器。随着业
务的发展，它逐渐成为一个大型的网站，服务器从一台发展到多台，运维人员从
一个发展到多个，业务战线也从一条发展到多条，这时候出现故障的概率就会大
大增加。当有一天，你作为该网站的运维人员，你的老板问你为何某个服务不可
使用，为何出现故障时，而身为运维人员的你却不知道故障出现在哪里，此时你
是不称职的。如果换一个角度，在未发生故障的时候就已经把故障解决了，那你
就是幕后英雄。
有一个故事是讲神医扁鹊的。有人对扁鹊说：“你是天下的神医，能治天下各
种疑难杂症，很了不起。”而扁鹊却说：“你知道吗？我和我长兄比起来，可差远
啦！我长兄给人治病，是治人于病未发之前，在稍见端倪的时候就能防患于未然，
而我只能治人病于膏肯之中，往往是病人受尽折磨才来找我。”（引自魏文王问扁
鹊一一《冠子》世贤第十六）
监控系统就是这么一个“神医”，救人于膏盲之中（发送故障告警，或者自动
修复故障），在发生故障之前，监控系统中会隐约显现故障的前期迹象，这也适用
于其他事物，即任何事物的发生必有其原因和条件。有经验的人会从这小小的迹
象中发现更大的问题，例如，突发的流量增长，突发的访问量增大，某台服务器
的瞬间负载变高，都表明了即将出现异常情况。对出现的故障，能及时通知告警
和敌障的自动修复，对运维人员响应处理故障的速度会大大加快，甚至在异常严
重的故障情况下，对及时采用应急预案，有不可或缺的作用。如果没有监控，故
障的反馈往往来自用户的报告，然后才由运维人员处理。
2.监控系统的实现
监控系统往往需要对物理硬件和应用软件的性能和参数进行数据汇集，实现
集中管理和统一分析。
在一个监控系统中，构成要素为监控服务器端程序、数据存储、被采集节点
11
---
## Page 28
Zabbix企业级分布式监控系统
等相关模块，其告警分析和自动故障处理功能由服务器端执行。在数据采集完成
之后，需要对采集到的数据进行分析和处理，判断是否有异常，是否属于告警条
件。告警条件如何设置呢？通常是根据实际的经验值、业务需求来设置告警阈值。
达到告警条件时，则发送告警信息给管理人员，然而，对于有些故障，我们希望
程序能自动处理，减少人工干预，让程序自动修复，只在出现严重故障、程序无
法判断的时候，才告警通知管理人员处理。
一个监控系统往往需要集成资产管理，可以从逻辑上展示业务和功能的信息，
通过对其进行数据分析，做到对投资与回报的一个反馈展示，为资产的合理规划
与使用提供了依据。
从其工作模式来看，监控系统的数据采集可以分为两种：主动监控和被动监
控，在1.2节已经详述，一个理想的监控系统，其采集端支持的采集方式越多，
其扩张能力越强大，适用的环境场合越多。
监控系统需要提供一个API，方便其他功能系统对监控数据进行操作管理，
这在业务系统精密的情况下显得特别重要，通常能对外提供API功能的软件，其
用户群会更广，产品会越做越好。API一般可以分为RESTful、SOAP等形式，数
据类型有JSON、XML等多种。从目前的趋势来看，RESTfuI已经成为绝大多数
API首选的方式。
监控系统需要对敌障数据进行分析汇总，从敌障中分析出现的概率，从而可
以积累经验，避免以后出现类似的问题。例如，由于机器硬件导致的故障，其概
率有多大，哪些部件最容易出问题，出问题的影响概率多大，问题解决的概率有
多大。从监控的数据中就可以分析并发现相关数据，在此基础上进行分析汇总，
可以整理出相应的对策和相应的技术应急方案。
常见的监控系统性能采集指标如表1-1所示。
表1-1
监控项目
详细内容
主机监控
CPU、内存、磁盘的剩余空间/利用率和I/O、SWAP使用率、系统UP时间、进程数、负载
网卡监控
Ping的往返时间及包成功率、网卡流量，包括流入/流出量和错误的数据包数
文件监控
监控文件大小、Hash值，匹配查询、字符串存在与否
URL监控
监测指定URL访问过程中的返回码、下载时间及文件大小，支持内容匹配
端口和内存使用率、CPU使用率、服务状态、请求数、并发连接数、消息队列的字节数、
应用程序
Client事务处理数、Service状态等
监测数据库中指定的表空间、数据库的游标数、Session数、事务数、死锁数、缓冲池命中
数据库
率、库Cache命中率、当前连接数、进程的内存利用率等性能参数
日志
错误日志匹配、特定字符串匹配
硬件
温度、风扇转速、电压等
12
---
## Page 29
第1章监控系统简介
3.监控系统对时间的要求
监控系统需要根据实际应用的需求，实时/非实时地采集和展示数据。另外，
包括历史趋势数据的展示和分析，以及容量报表、可用性报告的生成。
4.监控系统的告警需求
支持多种方式，如短信、邮件、IM和其他接口。具备可定制化功能，对第
三方告警介质提供可编程接口。这一点在很多场合非常重要，例如，将告警结果
发送到专用的告警分析系统。
支持对告警内容的分析自动处理，防止误报、漏报，以及防止抖动。这一点
对大多数监控系统都是一个值得挑战和研究的课题。例如，一个机房网络发生故
障，按照常规告警内容，会收到无数条告警信息，内容是每个设备的故障，而对
于更高级的告警信息，我们希望收到的是“某机房存在网络故障，受影响的设备
的IP是X.X.X.X～X.X.X.X，受影响的业务是XXX.”，这样做的目的是让告警信
息更智能、更有效，防止“告警炸弹”的产生。
简而言之，监控数据的采集、存储、分析和故障报告是每个监控系统的基本
功能，其他复杂的附加功能则是监控系统的增值业务。
在本书中，你将会看到以上功能的具体体现，无论你是使用Zabbix，还是自
行开发监控系统，本书都具有良好的参考价值。
13
---
## Page 30
第2章
Zabbix简介
本章对Zabbix 的发展历史、客户群、开源模式、软件架构和Zabbix的详细
功能等方面进行了详细介绍，使读者对Zabbix有一个全面的认识，读者稍做了解
即可，重点为如图2-5所示的Zabbix架构理解。
2.1
Zabbix的客户
在国外，有如图2-1所示的用户在使用Zabbix。
在国内，BAT的部分业务、豆瓣、58同城、PPTV、搜狐、Letv、人人、网
易、小米、360等公司都在使用Zabbix。
IVPN
JAHCHA
三
makonnx
alya
ARI
netia
NeXTNaV
NFOrce
Basler
OnMobile
B
=
Citadele
proctne
CRENNER
CommuniGs
SERPRO
mesa-az
dATADREV
deac
eltele.
Total Senver
Tgerogie
tns
Fraunhofer
fellowtaoh"
Pwtrip
VIP
OVSAA
GroupMealth
图2-1
注：对于以上信息，读者可以参考http://www.zabbix.com/users.php。
随着云计算、虚拟化的大规模应用，以及未来移动互联网、物联网等的兴起
Zabbix的使用将越来越广泛，应用场合也越来越多。目前，不少互联网公司、云
计算公司、系统集成软件公司、外包服务公司等，都有对Zabbix进行二次开发和
大规模使用。所以，可以断言，Zabbix在未来将会引领监控软件的潮流。
Zabbix适合中小型企业、大中型企业的用户使用。单个Server节点可以支持
---