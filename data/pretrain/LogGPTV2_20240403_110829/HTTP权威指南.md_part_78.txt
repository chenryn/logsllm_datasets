版本字符串给出了与客户端和服务器有关的一些提示，在客户端和服务器之间出现
一些比较奇怪或非预期的交互动作时，它会非常有用。比如，如果请求的失败率高
于预期，那版本信息指向的可能是一个无法与服务器进行交互的新版浏览器。
HTTP状态码说明了请求的执行状况：是否成功执行，认证请求是否失败，资源是
否找到等（HTTP状态码列表参见3.2.2节）。
请求/响应的大小和时间戳主要用于记账；就是记录流入、流出或流经应用程序的
字节有多少。还可用时间戳将观察到的问题与当时发起的一些请求关联起来。
506 ｜ 第21章
21.2 日志格式
目前已有一些日志格式的标准了。本节我们会讨论一些最常见的日志格式。大部分
商用和开源的HTTP应用程序都支持以一种或多种常用格式进行日志记录。很多这
样的应用程序都支持管理者配置日志格式，创建自定义的格式。
应用程序支持管理者使用这些更标准的格式的主要好处之一就在于，可以充分利用
那些已构建好的工具处理这些日志，并产生基本的统计信息。有很多开源包和商用
包都可用来压缩日志，以进行汇报。使用标准格式，应用程序及其管理员就都可以
利用这些包了。
21.2.1 常见日志格式
现在，最常见的日志格式之一就是常用日志格式。这种日志格式最初由NCSA定
义，很多服务器在默认情况下都会使用这种日志格式。可以将大部分商用及开源服
务器配置为使用这种格式，有很多商用及免费工具都可辅助解析常用日志格式的文
件。表21-1按序列出了常用日志格式中的字段。
表21-1 常用日志格式字段
字 段 描 述
remotehost 请求端机器的主机名或IP地址（如果没有配置服务器去执行反向DNS或无
法查找请求端的主机名，就使用IP地址）
username 如果执行了ident查找，就是请求端已认证的用户名a 484
auth-username 如果进行了认证，就是请求端已认证的用户名
timestamp 请求的日期和时间
request-line 精确的HTTP请求行文本， GET /index.html HTTP/1.1
response-code 响应中返回的HTTP状态码
response-size 响应主体中的Content-Length，如果响应中没有返回主体，就记录0
a：RFC 931描述了在此认证中使用的ident查找。ident协议是在第5章介绍的。
例21-1列出了几个常见日志格式条目。
例21-1 常见日志格式
209.1.32.44 - - [03/Oct/1999:14:16:00 -0400] "GET / HTTP/1.0" 200 1024
http-guide.com - dg [03/Oct/1999:14:16:32 -0400] "GET / HTTP/1.0" 200 477
http-guide.com - dg [03/Oct/1999:14:16:32 -0400] "GET /foo HTTP/1.0" 404 0
在这些例子中，字段的分配如下所示。
日志记录与使用情况跟踪 ｜ 507
字段1 条目1 条目2 条目2
remotehost 209.1.32.44 http-guide.com http-guide.com
username   
auth-username  dg dg
timestamp 03/Oct/1999:14:16:00 -0400 03/Oct/1999:14:16:32 -0400 03/Oct/1999:14:16:32 -0400
request-line GET / HTTP/1.0 GET / HTTP/1.0 GET /foo HTTP/1.0
response-code 200 200 404
response-size 1024 477 0
注意，remotehost字段可以是http-guide.com那样的主机名，也可以是209.1.32.44
这样的IP地址。
第二个（username）和第三个（auth-username）字段之间的破折号说明字段为空。
这说明要么是没有进行ident查找（第二个字段为空），要么是没有进行认证（第三
个字段为空）。
21.2.2 组合日志格式
另一种常用日志格式为组合日志格式（Combined Log Format），例如Apache服务器
就支持这种格式。组合日志格式与常用日志格式很类似。实际上，它就是常用日志
格式的精确镜像，只是添加了（表21-2中列出的）两个字段。User-Agent字段用于
说明是哪个HTTP客户端应用程序在发起已被记录的请求，而Referer字段则提供
485 了更多与请求端在何处找到这个URL的有关信息。
表21-2 新加的组合日志格式字段
字 段 描 述
Referer Referer首部的内容
User-Agent User-Agent首部的内容
例21-2给出了一个组合日志格式的条目。
例21-2 组合日志格式
209.1.32.44 - - [03/Oct/1999:14:16:00 -0400] "GET / HTTP/1.0" 200 1024
"http://www.joes-hardware.com/" "5.0: Mozilla/4.0 (compatible; MSIE
5.0; Windows 98)"
在例21-2中，Referer字段和User-Agent字段的值如下所示。
字 段 值
Referer http://www.joes-hardware.com/
User-Agent 5.0: Mozilla/4.0（兼容的，MSIE 5.0，Windows 98）
508 ｜ 第21章
例21-2的组合日志格式条目示例中的前七个字段和常用日志格式中的完全一样（参
见例21-1中的第一个条目）。两个新字段Referer和User-Agent附加在日志条目的
末尾。
21.2.3 网景扩展日志格式
网景进入商用HTTP应用程序领域时，为其服务器定义了很多其他HTTP应用程
序开发者已接纳的日志格式。网景的格式是基于NCSA的常用日志格式的，但它
们扩展了该格式，以支持与代理和Web缓存这样的HTTP应用程序相关的字段。
网景扩展日志格式的前7个字段与常用日志格式中的那些字段完全相同（参见表
21-1）。表21-3按序列出了网景扩展日志格式引入的新字段。
表21-3 网景扩展日志格式新加的字段
字 段 描 述
proxy-response-code 如果事务处理经过了某个代理，就是从服务器传往代理的HTTP响应码
proxy-response-size 如果事务处理经过了某个代理，就是发送给代理的服务器响应实体的
Content-Length
client-request-size 发给代理的客户端请求的所有主体或实体的Content-Length
proxy-request-size 如果事务处理经过了某个代理，就是代理发往服务器的请求的所有主体
或实体的Content-Length
client-request-hdr-size 以字节为单位的客户端请求首部的长度
proxy-response-hdr-size 如果事务处理经过了某个代理，就是以字节为单位的、发送给请求端的 486
代理响应首部的长度
proxy-request-hdr-size 如果事务处理经过了某个代理，就是以字节为单位的、发送给服务器的
代理请求首部的长度
server-response-hdr-size 以字节为单位的，服务器响应首部的长度
proxy-timestamp 如果事务处理经过了某个代理，就是请求和响应经过代理传输所经过的
时间（单位为秒）
例21-3给出了一个网景扩展日志格式的条目。
例21-3 网景扩展日志格式
209.1.32.44 - - [03/Oct/1999:14:16:00-0400] "GET / HTTP/1.0" 200 1024
200 1024 0 0 215 260
279 254 3
在这个例子中，扩展字段的值如下所示。
日志记录与使用情况跟踪 ｜ 509
字 段 值
proxy-response-code 200
proxy-response-size 1024
client-request-size 0
proxy-request-size 0
client-request-hdr-size 215
proxy-response-hdr-size 260
proxy-request-hdr-size 279
server-response-hdr-size 254
proxy-timestamp 3
例21-3中网景扩展日志格式条目示例中的前7个字段是常用日志格式条目示例的镜
像（参见例21-1中的第一个条目）。
21.2.4 网景扩展2日志格式
另一种网景日志格式，网景扩展2日志格式采用了扩展日志格式，并添加了一些与
HTTP代理和Web缓存应用程序有关的附加信息。这些附加字段有助于更好地描绘
HTTP客户端和HTTP代理应用程序间的交互图景。
网景扩展2日志格式是基于网景扩展日志格式的，初始字段与表21-3中列出的字段
487 完全相同（它也是表21-1中常用日志格式字段的扩展）。
表21-4按序列出了网景扩展2日志格式新加的字段。
表21-4 附加的网景扩展2日志格式字段
字 段 描 述
route 代理用来向客户端发送请求的路径（参见表21-5）
client-finish-status-code 客户端完成状态码。说明了发送给代理的客户端请求是成功完成（FIN）
了，还是被打断了（INTR）
proxy-finish-status-code 代理完成状态码。说明代理发送给服务器的请求是成功完成（FIN）了，
还是被打断了（INTR）
cache-result-code 缓存结果代码；说明缓存是如何响应请求的a
a：表21-7列出了网景的缓存结果代码。
例21-4给出了一个网景扩展2日志格式的条目。
例21-4 网景扩展2日志格式
209.1.32.44 - - [03/Oct/1999:14:16:00-0400] "GET / HTTP/1.0" 200 1024
200 1024 0 0 215 260
510 ｜ 第21章
279 254 3 DIRECT FIN FIN WRITTEN
这个例子中扩展字段的值如下所示。
字 段 值
route DIRECT
client-finish-status-code FIN
proxy-finish-status-code FIN
cache-result-code WRITTEN
例21-4的网景扩展2日志格式条目中的前16个字段就是网景扩展日志格式示例条
目的镜像（参见例21-3）。
表21-5列出了有效的网景路由代码。
表21-5 网景路由代码
值 描 述
DIRECT 资源是直接从服务器上获取的
PROXY(host:port) 资源是通过代理“host:port”获取的
SOCKS(socks:port) 资源是通过SOCKS服务器“host:port”获取的
表21-6列出了有效的网景完成代码。
表21-6 网景完成状态码
值 描 述
- 请求未开始
FIN 请求成功完成
INTR 请求被客户端中断或被代理/服务器终止 488
TIMEOUT 请求被代理/服务器超时
表21-7列出了有效的网景缓存代码。1
表21-7 网景缓存代码
代 码 描 述
- 资源不可缓存
WRITTEN 资源被写入了缓存
REFRESHED 资源被缓存，且被刷新了
NO-CHECK 返回已缓存的资源，未进行新鲜性检查
注1：表21-7列出了网景缓存结果代码。
日志记录与使用情况跟踪 ｜ 511
（续）
代 码 描 述
UP-TO-DATE 返回已缓存的资源，进行了新鲜性检查
HOST-NOT-AVAILABLE 返回已缓存的资源。由于远程服务器不可用，所以未进行新鲜性检查
CL-MISMATCH 未将资源写入缓存。由于Content-Length与资源尺寸不匹配，放弃了写
操作
ERROR 因为出错，资源未被写入缓存。比如，出现了超时，或客户端放弃了此事务
与很多其他HTTP应用程序一样，网景应用程序也有其他的日志格式，包括一种灵
活日志格式和一种管理者输出自定义日志字段的方式。这些格式给予管理者更大的
控制权，并可以选择在日志中报告HTTP事务处理的哪些部分（首部、状态、尺寸
等），以自定义其日志。
由于很难预测管理者希望从其日志中获取哪些信息，才添加了管理者配置自定义格
式的能力。很多其他的代理和服务器都有发布自定义日志的能力。
21.2.5 Squid代理日志格式
Squid代理缓存（http://www.squid-cache.org）是Web上一个很古老的部分。其起源
可以回溯到一个早期的Web代理缓存项目（ftp://ftp.cs.colorado.edu/pub/techreports/
schwartz/Harvest.Conf.ps.Z）。Squid是开源社团多年来扩展增强的一个开源项目。
有很多工具可以用来辅助管理Squid应用程序，包括一些有助于处理、审核及开发
其日志的工具。很多后继代理缓存都为自己的日志使用了Squid格式，这样才能更
489 好地利用这些工具。
Squid日志条目的格式相当简单。表21-8总结了该日志格式的字段。
表21-8 Squid日志格式字段
字 段 描 述
timestamp 请求到达时的时间戳，是从格林尼治标准时间1970年1月1日开始的秒数
time-elapsed 请求和响应通过代理传输所经历的时间（以毫秒为单位）
host-ip 客户端（请求端）主机的IP地址
result-code/status result字段是Squid类型的，用来说明在此请求过程中代理采取了什么动作；a
code字段是代理发送给客户端的HTTP响应代码
size 代理响应客户端的字节长度，包括HTTP响应首部和主体
method 客户端请求的HTTP方法
a：表21-9列出了各种结果代码及其含义。
512 ｜ 第21章
（续）
字 段 描 述
url 客户端请求中的URLb
rfc931-identc 客户端经过认证的用户名d