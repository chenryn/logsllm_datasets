剑走偏锋
—蓝军实战缓解措施滥用
# Whoami
• @askme765cs
• 安全研究员@绿盟科技
• M01N战队核心成员
• 专注系统安全与终端对抗
目录
CONTENTS
01
02
03
Mitigations 101
Red Team Operation
"Mitigation Hell"
Part 01
Mitigations 101
01
Why Mitigations?
漏洞利用两种常见路径
• 数据破坏
• 代码执行
利用过程中的动作与特征
• 修改代码段
• 加载DLL
• 创建新进程
• …
Mitigations的效用
• 截断利用链，削减机会窗口
• 对抗未知威胁与潜在攻击
02
Mitigations Timeline
• ASLR
• DEP
• SafeSEH
• SEHOP
• CFG
• CIG
• ACG
• Child Process
Policy
• CFG Strict Mode
• CFG Export Suppression
• NoLowMandatoryLabelImages
• …
Pre-Win10
TH1
RS1
RS2
RS3 +
03
Code intergerity guard-CIG
• Windows 10 TH2 (1511)引入
• 阻止恶意DLL注入受保护应用程序
• 对加载DLL的签名进行验证
• 仅允许可信签名的DLL加载
• MicrosoftSignedOnly
• StoreSignedOnly
• 内核主要检查代码位于
MiValidateSectionSigningPolicy
• 受影响的API
NtCreateSection
04
Arbitrary code guard-ACG
• Windows 10 RS1 (1607)引入
• 贯彻W^X原则
• 禁止修改已有代码(X)修改为可写(W)
• 禁止修改可写数据(W)修改为可执行(X)
• 禁止分配或映射新的可执行内存
• 内核主要检查代码位于
MiAllowProtectionChange
MiMapViewOfSection
• 受影响的API
NtAllocateVirtualMemory
NtProtectVirtualMemory
NtMapViewOfSection(SEC_IMAGE/SEC_FILE)
Arbitrary code guard-ACG
05
• 用户态API
• VirtualAlloc with PAGE_EXECUTE_*
• VirtualProtect with PAGE_EXECUTE_*
• MapViewOfFile with FILE_MAP_EXECUTE | FILE_MAP_WRITE
• SetProcessValidCallTargets for CFG
Boundary of ACG
06
• 只能限制程序本身，不能阻止其他程序对其的修改
• 开启AllowRemoteDowngrade则可通过其他程序关闭ACG
08
Mitigation Flags-EPROCESS
ULONG Flags、Flags2、Flags3、Flags4
ULONG MitigationFlags、MitigationFlags2
09
Mitigation Policy-注册表
设置指定名称\路径程序的Mitigation Policy-IFEO
• HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\
• MitigationOptions:REG_BINARY
系统全局Mitigation Policy
• HKLM\System\CurrentControlSet\Control\Session Manager\kernel\
• MitigationOptions:REG_BINARY
10
Mitigation Policy-注册表
11
Mitigation Policy-Powershell
查看程序Mitigation Policy(从程序读取)
• Get-ProcessMitigation –Running –Name notepad.exe
查看程序Mitigation Policy(从注册表读取)
• Get-ProcessMitigation -Name notepad.exe
设置程序Mitigation Policy(写入注册表)
• Set-ProcessMitigation -Name notepad.exe -Enable MicrosoftSignedOnly
12
13
系统设置
• 设置系统全局Mitiation Policy
• CFG、DEP、强制ASLR等
程序设置
• 设置单个程序Mitigation Policy
• 图形化、用户友好
Mitigation Policy-Exploit Protection
Part 02
Red Team 
Operation
14
CobaltStrike Blockdlls
• CobaltStirke 3.14版本中引入
• 开启后子进程只能加载微软签名的DLL
• 一些后渗透指令受益于blockdlls 
• Spawn
• Screenshot
• Keylogger
• Mimikatz
• …
15
16
Blockdlls原理-CIG滥用
• UpdateProcThreadAttribute
• 子进程中开启CIG
• 阻止部分安全产品DLL注入
若DLL有微软签名？
17
18
更进一步，阻击HOOK
• CIG无法阻止签名DLL的加载
• ACG可阻止对代码段的修改
• 利用ACG阻止DLL对代码段的修改
EDR DLL
Malware
.text
System DLLs
19
ACG+CIG防线
DL
L
签名
加载
Y
N
CIG
Hook
AC
G
注入
20
实时修改自身Mitigation Policy
• SetProcessMitigationPolicy
• 底层调用NtSetInformationProcess
• 可实时开启CIG、ACG等Mitigations
• 开启后无法由自身关闭
21
实时修改其他程序Mitigation Policy
• NtSetInformationProcess
• 只能修改ACG
• 开启AllowRemoteDowngrade
可关闭ACG
Part 03
"Mitigation Hell"
22
Side Effect Of Mitigations
“Mitigation Hell”——利用缓解措施使程序失去可用性乃至崩溃
• ACG-无法修改自身代码，导致具有自解密、自修改行为的程序失败
-杀死几乎所有.NET程序，CLR初始化依赖于RWX内存
• CIG-无法加载非微软签名的组件，导致运行异常或失败
• Child Process Policy-破坏依赖子进程创建的进程，例如守护进程
若将Mitigations强制应用于未适配的安全软件会如何？
23
剑走偏锋，利用"Mitigation Hell"击破安全防线
• 修改特定安全产品关键程序Mitigation Policy，破坏可用性
安全产品A-自修改行为+ACG=>闪
退
安全产品B-未签名DLL+CIG=>初始化错
误
ATT&CK T1562
Impair Defenses 防御削弱
24
• 修改或禁用安全产品
• 破坏日志记录机制
• 清除历史日志信息
• 限制关键IFEO注册表项修改
25
Hunting "Mitigation Hell"-Audit Mode
Audit审计模式-记录日志而不阻止
Set-ProcessMitigation -Name notepad.exe -Enable AuditDynamicCode,AuditMicrosoftSigned
日志记录 Microsoft-Windows-Security-Mitigation/Kernel Mode
26
Hunting "Mitigation Hell"-ETW
• Microsoft-Windows-Kernel-Memory:KERNEL_MEM_KEYWORD_ACG
• Microsoft-Windows-Security-Mitigations:Microsoft-Windows-Security-Mitigations/KernelMode
观点总结
27
• Mitigations带来的不止是“安全”，亦为新的利用方式埋下伏笔
• 终端对抗领域Mitigations的利用已不鲜见，攻防一体两面，没有银弹
• 对安全软件强制开启缓解措施，有破坏其可用性的可能，是一种行之有效的手段
感谢观看！
KCon 汇聚黑客的智慧
感谢观看！
演讲者：绿盟科技 顾佳伟