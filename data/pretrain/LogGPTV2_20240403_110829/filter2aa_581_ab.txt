How Transport Layer Security (TLS) Works  364
Transport Layer Security (TLS) Handshake  365
Application Data Transfer  374
Appendix D: UMA Evolution .................................................................................. 377
ProtectServe  377
UMA and OAuth 384
UMA 10 Architecture  384
UMA 10 Phases  385
UMA Phase 1: Protecting a Resource  385
UMA Phase 2: Getting Authorization  388
UMA Phase 3: Accessing the Protected Resource  394
UMA APIs  394
Protection API  395
Authorization API  396
Appendix E: Base64 URL Encoding ....................................................................... 397
Appendix F: Basic/Digest Authentication ............................................................. 401
HTTP Basic Authentication  402
HTTP Digest Authentication  406
Appendix G: OAuth 2.0 MAC Token Profile ............................................................ 425
Bearer Token vs MAC Token  427
Obtaining a MAC Token  428
Invoking an API Protected with the OAuth 20 MAC Token Profile  432
Calculating the MAC  433
Table of ConTenTs
xiv
MAC Validation by the Resource Server  435
OAuth Grant Types and the MAC Token Profile  436
OAuth 10 vs OAuth 20 MAC Token Profile  436
Index ..................................................................................................................... 439
Table of ConTenTs
xv
About the Author
Prabath Siriwardena is an identity evangelist, author, 
blogger, and VP of Identity Management and Security at 
WSO2. He has more than 12 years of industry experience 
in designing and building critical identity and access 
management (IAM) infrastructure for global enterprises, 
including many Fortune 100/500 companies. As a 
technology evangelist, Prabath has published seven books. 
He blogs on various topics from blockchain, PSD2, GDPR, 
IAM to microservices security. He also runs a YouTube 
channel. Prabath has spoken at many conferences, including 
RSA Conference, KNOW Identity, Identiverse, European Identity Conference, Consumer 
Identity World USA, API World, API Strategy and Practice Conference, QCon, OSCON, 
and WSO2Con. He has traveled the world conducting workshops and meetups to 
evangelize IAM communities. He is the founder of the Silicon Valley IAM User Group, 
which is the largest IAM meetup in the San Francisco Bay Area. 
xvii
Acknowledgments
I would first like to thank Jonathan Gennick, Assistant Editorial Director at Apress, for 
evaluating and accepting my proposal for this book. Then, I must thank Jill Balzano, 
Coordinating Editor at Apress, who was very patient and tolerant of me throughout the 
publishing process. Alp Tunc served as the technical reviewer—thanks, Alp, for your 
quality review comments, which were quite useful. Also I would like to thank all the 
external reviewers of the book, who helped to make the book better.
Dr. Sanjiva Weerawarana, the Founder and former CEO of WSO2, and Paul 
Fremantle, the CTO of WSO2, are two constant mentors for me. I am truly grateful to 
both Dr. Sanjiva and Paul for everything they have done for me.
My wife, Pavithra, and my little daughter, Dinadi, supported me throughout this 
process. Thank you very much, Pavithra and Dinadi.
My parents and my sister are with me all the time. I am grateful to them for 
everything they have done for me. Last but not least, my wife’s parents—they were 
amazingly helpful.
Although writing a book may sound like a one-man effort, it’s the entire team behind 
it who makes it a reality. Thank you to everyone who supported me in many different 
ways.
xix
Introduction
Enterprise APIs have become the common way of exposing business functions to the 
outside world. Exposing functionality is convenient, but of course comes with a risk of 
exploitation. This book is about securing your most important business assets or APIs. As 
is the case with any software system design, people tend to ignore the security element 
during the API design phase. Only at the deployment or at the time of integration they 
start worrying about security. Security should never be an afterthought—it’s an integral 
part of any software system design, and it should be well thought out from the design’s 
inception. One objective of this book is to educate the reader about the need for security 
and the available options for securing APIs.
The book guides you through the process and shares best practices for designing 
APIs for better security. API security has evolved a lot in the last few years. The growth of 
standards for securing APIs has been exponential. OAuth 2.0 is the most widely adopted 
standard. It’s more than just a standard—rather a framework that lets people build 
solutions on top of it. The book explains in depth how to secure APIs from traditional 
HTTP Basic authentication to OAuth 2.0 and the profiles built around OAuth, such as 
OpenID Connect, User-Managed Access (UMA), and many more.
JSON plays a major role in API communication. Most of the APIs developed today 
support only JSON, not XML. The book focuses on JSON security. JSON Web Encryption 
(JWE) and JSON Web Signature (JWS) are two increasingly popular standards for 
securing JSON messages. The latter part of the book covers JWE and JWS in detail.
Another major objective of the book is to not just present concepts and theories 
but also to explain concepts and theories with concrete examples. The book presents 
a comprehensive set of examples to illustrate how to apply theory in practice. You 
will learn about using OAuth 2.0 and related profiles to access APIs securely with web 
applications, single-page applications, native mobile applications and browser-less 
applications.
I hope this book effectively covers a much-needed subject matter for API developers, 
and I hope you enjoy reading it.
1
© Prabath Siriwardena 2020 
P. Siriwardena, Advanced API Security, https://doi.org/10.1007/978-1-4842-2050-4_1
CHAPTER 1
APIs Rule!
Enterprise API adoption has exceeded expectations. We see the proliferation of APIs in 
almost all the industries. It is not an exaggeration to say a business without an API is like 
a computer with no Internet. APIs are also the foundation for building communication 
channels in the Internet of Things (IoT) domain. From motor vehicles to kitchen 
appliances, countless devices have started communicating with each other via APIs.
The world is more connected than ever. You share photos from Instagram in 
Facebook, share a location from Foursquare or Yelp in Twitter, publish tweets to the 
Facebook wall, connect to Google Maps via the Uber mobile app, and many more. The 
list of connections is limitless. All this is made possible only because of public APIs, 
which have proliferated in the last few years. Expedia, Salesforce, eBay, and many other 
companies generate a large percentage of their annual revenue via APIs. APIs have 
become the coolest way of exposing business functionalities to the outside world.
 API Economy
According to an infographic1 published by the ACI Information Group, at the current 
rate of growth, the global Internet economy is around 10 trillion US dollars. In 1984, at 
the time the Internet was debuted, it linked 1000 hosts at universities and corporates. In 
1998, after almost 15 years, the number of Internet users, globally, reached 50 million. 
It took 11 years since then to reach the magic number 1 billion Internet users, in 2009. 
It took just three years since then to get doubled, and in 2012 it reached to 2.1 billion. 
In 2019, more than half of the world’s population—about 4.3 billion people—use the 
Internet. This number could further increase as a result of the initiatives taken by the 
Internet giants like Facebook and Google. The Internet.org initiative by Facebook, 
1 The History of the Internet, http://aci.info/2014/07/12/the-data-explosion-in- 
2014-minute-by-minute-infographic/
2
launched in 2013, targets to bring together technology leaders, nonprofits, and local 
communities to connect with the rest of the world that does not have Internet access. 
Google Loon is a project initiated by Google to connect people in rural and remote areas. 
It is based on a network of balloons traveling on the edge of space and aims to improve 
the connectivity of 250 million people in Southeast Asia.2
Not just humans, according to a report3 on the Internet of Things by Cisco,  
during 2008, the number of things connected to the Internet exceeded the number 
of people on earth. Over 12.5 billion devices were connected to the Internet in 2012 
and 25 billion devices by the end of 2015. It is estimated that by the end of 2020, 50 
billion devices will be connected. Connected devices are nothing new. They’ve been 
there since the introduction of the first computer networks and consumer electronics. 
However, if not for the explosion of the Internet adoption, the idea of a globally 
connected planet would never take off. In the early 1990s, computer scientists theorized 
how a marriage between humans and machines could give birth to a completely new 
form of communication and interaction via machines. That reality is now unfolding 
before our eyes.
There are two key enablers behind the success of the Internet of Things. One is the 
APIs and the other is Big Data. According to a report4 by Wipro Council for Industry 
Research, a six-hour flight on a Boeing 737 from New York to Los Angeles generates 
120 terabytes of data that is collected and stored on the plane. With the explosion of 
sensors and devices taking over the world, there needs to be a proper way of storing, 
managing, and analyzing data. By 2014, an estimated 4 zettabytes of information was 
held globally, and it’s estimated, by 2020, that number will climb up to 35 zettabytes.5 
Most interestingly, 90% of the data we have in hand today is generated just during the 
last couple of years. The role of APIs under the context of the Internet of Things is equally 
important as Big Data. APIs are the glue which connect devices to other devices and to 
the cloud.
2 Google Loon, http://fortune.com/2015/10/29/google-indonesia-internet-helium- 
balloons/
3 The Internet of Things: How the Next Evolution of the Internet Is Changing Everything,  
www.iotsworldcongress.com/documents/4643185/3e968a44-2d12-4b73-9691-17ec508ff67b
4 Big Data: Catalyzing Performance in Manufacturing, www.wipro.com/documents/Big%20Data.pdf
5 Big data explosion: 90% of existing data globally created in the past two years alone,  
http://bit.ly/1WajrG2
Chapter 1  apIs rule!
3
The API economy talks about how an organization can become profitable or 
successful in their corresponding business domain with APIs. IBM estimated the API 
economy to become a $2.2 trillion market by 2018,6 and the IBM Redbook, The Power 
of the API Economy,7 defines API economy as the commercial exchange of business 
functions, capabilities, or competencies as services using web APIs. It further finds 
five main reasons why enterprises should embrace web APIs and become an active 
participant in the API economy:
• 
Grow your customer base by attracting customers to your products 
and services through API ecosystems.
• 
Drive innovation by capitalizing on the composition of different APIs, 
yours and third parties.
• 
Improve the time-to-value and time-to-market for new products.
• 
Improve integration with web APIs.
• 
Open up more possibilities for a new era of computing and prepare 
for a flexible future.
 Amazon
Amazon, Salesforce, Facebook, and Twitter are few very good examples for early 
entrants into the API economy, by building platforms for their respective capabilities. 
Today, all of them hugely benefit from the widespread ecosystems built around these 
platforms. Amazon was one of the very first enterprises to adopt APIs to expose its 
business functionalities to the rest. In 2006 it started to offer IT infrastructure services to 
businesses in the form of web APIs or web services. Amazon Web Services (AWS), which 
initially included EC2 (Elastic Compute Cloud) and S3 (Simple Storage Service), was a 
result of the thought process initiated in 2002 to lead Amazon’s internal infrastructure in 
a service-oriented manner.
6 IBM announces new solutions for the API economy, http://betanews.com/2015/11/05/
ibm-announces-new-solutions-for-the-api-economy/
7 The Power of the API Economy, www.redbooks.ibm.com/redpapers/pdfs/redp5096.pdf
Chapter 1  apIs rule!
4
The former Amazon employee, Steve Yegge, shared accidentally an Amazon internal 
discussion via his Google+ post, which became popular later. According to Yegge’s 
post,8 it all began with a letter from Jeff Bezos to the Amazon engineering team, which 
highlighted five key points to transform Amazon into a highly effective service-oriented 
infrastructure.
• 
All teams will henceforth expose their data and functionality through 
service interfaces.
• 
Teams must communicate with each other through these interfaces.
• 
There will be no other form of interprocess communication 
allowed: no direct linking, no direct reads of another team's data 
store, no shared memory model, no backdoors whatsoever. The 
only communication allowed is via service interface calls over the 
network.
• 
It doesn't matter what technology is used. HTTP, Corba, Pubsub, 
custom protocols—doesn't matter.
• 
All service interfaces, without exception, must be designed from the 
ground up to be externalizable. That is to say, the team must plan and 
design to be able to expose the interface to developers in the outside 
world. No exceptions.
This service-based approach leads Amazon to easily expand its business model from 
being a bookseller to a global retailer in selling IT services or cloud services. Amazon 
started exposing both EC2 and S3 capabilities as APIs, both in SOAP and REST (JSON 
over HTTP).
8 Steve Yegge on Amazon, https://plus.google.com/+RipRowan/posts/eVeouesvaVX
Chapter 1  apIs rule!
5
 Salesforce
Salesforce, which was launched in February 1999, is a leader in the software-as-a-service 
space today. The web API built around Salesforce capabilities and exposing it to the rest 
was a key success factor which took the company to the state where it is today. Salesforce 
kept on using platforms and APIs to fuel the innovation and to build a larger ecosystem 
around it.
 Uber
Google exposes most of its services via APIs. The Google Maps API, which was introduced 
in 2005 as a free service, lets many developers consume Google Maps to create much 
useful mashups by integrating with other data streams. Best example is the Uber. Uber 
is a transportation network company based out of San Francisco, USA, which also offers 
its services globally in many countries outside the United States. With the Uber mobile 
application on iOS or Android (see Figure 1-1), its customers, who set a pickup location 
and request a ride, can see on Google Maps where the corresponding taxi is. Also, from 
the Uber driver’s application, the driver can exactly pinpoint where the customer is. This 
is a great selling point for Uber, and Uber as a business hugely benefits from the Google 
Maps public API. At the same time, Google gets track of all the Uber rides. They know 
exactly the places of interests and the routes Uber customers take, which can be pumped 
into Google’s ad engine. Not just Uber, according to a report9 by Google, by 2013 more 
than 1 million active sites and applications were using Google Maps API.
9 A fresh new look for the Maps API, for all one million sites, http://bit.ly/1NPH12z
Chapter 1  apIs rule!
6
 Facebook
Facebook in 2007 launched the Facebook platform. The Facebook platform made most 
of the Facebook’s core capabilities available publicly to the application developers. 
According to the builtwith.com,10 the Facebook Graph API was used by 1 million web 
sites across the Internet, by October 2019. Figure 1-2 shows the Facebook Graph API 
usage over time. Most of the popular applications like Foursquare, Yelp, Instagram, and 
many more consume Facebook API to publish data to the user’s Facebook wall. Both 
parties mutually benefit from this, by expanding the adaptation and building a strong 
ecosystem.
Figure 1-1. Uber mobile app uses Google Maps
10 Facebook Graph API Usage Statistics, http://trends.builtwith.com/javascript/
Facebook-Graph-API
Chapter 1  apIs rule!
7
 Netflix
Netflix, a popular media streaming service in the United States with more than 150 
million subscribers, announced its very first public API in 2008.11 During the launch, 
Daniel Jacobson, the Vice President of Edge Engineering at Netflix, explained the role of 
this public API as a broker, which mediates data between internal services and public 
developers. Netflix has come a long way since its first public API launch, and today it 
has more than a thousand types of devices supporting its streaming API.12 By mid-2014, 
there were 5 billion API requests generated internally (via devices used to stream the 
content) and 2 million public API requests daily.
Figure 1-2. Facebook Graph API usage statistics, the number of web sites over 
time
11 Netflix added record number of subscribers, www.cnn.com/2019/04/16/media/netflix-
earnings-2019-first-quarter/index.html
12 API Economy: From systems to business services, http://bit.ly/1GxmZe6
Chapter 1  apIs rule!
8
 Walgreens
Walgreens, the largest drug retailing chain in the United States, opened up its photo 
printing and pharmacies to the public in 2012/2013, via an API.13 They started with 
two APIs, a QuickPrints API and a Prescription API. This attracted many developers, 
and dozens of applications were developed to consume Walgreens’ API. Printicular is 
one such application developed by MEA Labs, which can be used to print photos from 
Facebook, Twitter, Instagram, Google+, Picasa, and Flickr (see Figure 1-3). Once you pick 
your photos from any of these connected sites to be printed, you have the option to pick 
the printed photos from the closest Walgreens store or also can request to deliver. With 
the large number of applications built against its API, Walgreens was able to meet its 
expectations by enhancing customer engagements.
Figure 1-3. Printicular application written against the Walgreens API
13 Walgreens API, https://developer.walgreens.com/apis
Chapter 1  apIs rule!
9
 Governments
Not just the private enterprises but also governments started exposing its capabilities 
via APIs. On May 22, 2013, Data.gov (an initiative managed by the US General Services 
Administration, with the aim to improve public access to high-value, machine-readable 
datasets generated by the executive branch of the federal government) launched two 
initiatives to mark both the anniversary of the Digital Government Strategy and the 