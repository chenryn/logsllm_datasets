> 黑客入侵案件日志分析
日志易系统对海量日志进行抽取关键字段，建立索引入库，数据整合后，极大提高搜索、分析日志的效率。
我们通过把服务器日志导入到日志易系统，给日志打上标签"hacking"，标签和日志分组方便日志易系统同时处理不同的案件的日志，每个案件都有自己的标签和分组，方便不同的办案人查看不同的日志。这批将近5GB的日志总共有19,556,430条：
![](media/image1.png){width="6.682638888888889in"
height="0.9041666666666667in"}
![](media/image2.png){width="6.690972222222222in"
height="2.8319444444444444in"}日志易解析出日志格式为apache。在服务器存在web后门的情况下，该后门程序格式通常为php文件，并且一般后门通过POST方式进行请求。所以在搜索框搜索
"php AND apache.method:POST AND
apache.status:200"，得到以下结果，共3642条日志，可以清晰发现请求中存在异常文件：
也可以使用日志易左栏字段过滤功能，不使用复杂的搜索，通过点击选择apache.methed:"POST"，apache.status:"200"做过滤，并在搜索框搜索"php"，找出我们想进一步查看的日志：
![](media/image3.png){width="6.690972222222222in"
height="2.372916666666667in"}
点击可视化，选择饼状图，可以发现搜索结果中请求数量最多的基本都是异常文件，可以统计这些异常文件的数量，快速确定了服务器内后门位置。
如//sites/default/files/upload/201404/ec70c4642fa08bff32922a3e0dd2a702.php
可以观察到该目录应为图片及其它文件上传目录，不应该存在可解析的php文件，所以判断为异常。
![](media/image4.png){width="6.988194444444445in"
height="2.045138888888889in"}
并且可以对文件访问次数和IP来源等做出清晰的统计
![](media/image5.png){width="6.691666666666666in"
height="1.7458333333333333in"}
异常文件的相对地址，访问请求次数分别为：
/uc/uc_client/data/cache/1.php 访问请求1711次
/sites/all/themes/wip/templates/css/1.php 访问请求 828次
//sites/default/files/upload/201404/ec70c4642fa08bff32922a3e0dd2a702.php
访问请求 539次
/uploadfile/2013/0422/1.php 访问请求283次
/bbs/data/backup_9d525d/1.php 访问请求122次
/bbs/data/attachment/forum/201207/31/1.php 访问请求79次
/bbs/template/default/userapp/2.php 访问请求37次
/public/search/1.php 访问请求15次
/sites/default/files/upload/201404/d6630c171fdbe4cb2fcc97f999c40549.php
访问请求10次
/ucserver/c99.php 访问请求9次
/sites/default/files/upload/201404/93cce51142893b65317be1b0a8560a03.php
访问请求5次
//sites/all/themes/wip/templates/css/1.php 访问请求3次
//sites/default/files/upload/201404/ec70c4642fa08bff32922asse0dd2a702.php
访问请求1次
来源IP分别为：
222.141.155.4
203.160.131.104
119.4.252.36
119.4.252.209
119.4.252.123
182.16.27.66
61.53.46.82
通过日志查询，可以看到后门最初访问时间为2014年4月10日
9点10分，进一步缩小时间段，扩大搜索范围，以便查找该黑客攻击行为
![](media/image6.png){width="6.690972222222222in"
height="3.7256944444444446in"}定位该黑客攻击IP为222.141.155.4，搜索该IP活动：
![](media/image7.png){width="6.690972222222222in"
height="3.6381944444444443in"}"apache.clientip:222.141.155.4 AND
apache.status:200 "
观察发现最初访问为9点9分，文件为/nbproject/jj.php/8286/463，无法发现发现更多攻击请求，判断该黑客攻击时使用代理IP，并且经常更改，扩大该时间段内搜索范围。
在使用"uploadfile NOT jpg"关键字搜索时，可以发现存在其他两个可疑程序。
![](media/image8.png){width="6.726388888888889in"
height="3.067361111111111in"}
![](media/image9.png){width="6.690972222222222in"
height="1.55in"}chashell.php
访问时间为9点24，应为黑客获取权限后再次上传的新后门程序
![](media/image10.png){width="6.690972222222222in"
height="1.1840277777777777in"}t00ls.php
访问时间为6点14分，定位新IP为119.4.252.209。
通过定位119.4.252.209，可以发现其访问/bbs/source/admincp/uc.class.er.php
文件，并可以看到返回数据长度值均不同，判断此文件为黑客上传的隐藏后门，并且此IP第一条访问记录为GET请求此地址，判断此文件为早已被黑客隐藏。
![](media/image11.png){width="6.690972222222222in"
height="2.915277777777778in"}点击查询"uc.class.er.php"，结果如下：
![](media/image12.png){width="6.638888888888889in"
height="3.0701388888888888in"}
存在三个不同IP访问，但其他两个IP访问时间均为6点后。
![](media/image13.png){width="6.690972222222222in" height="1.6375in"}
减小时间范围至0点到2点44，经过搜索分析这段时间内无其他攻击特征，判断黑客在之前已成功上传后门程序并伪装。由于缺少10号之前日志，无法继续追踪。
溯源结论：
该黑客攻击行为狡猾，在服务器多处位置上传后门文件，并对后门做出隐藏处理，在进行攻击时，多次通过IP代理服务进行攻击，由以下IP：
119.4.252.36
119.4.252.209
119.4.252.123
可以判断该名黑客位置为四川省成都市可能性最大，但不排除都为代理IP可能性。
以上溯源分析，一名工程师只需在极短时间内，就能从5GB、将近2000万条日志里找到黑客攻击的线索和证据，可以看到日志易给安全审计带来的巨大便利：
1.  对日志进行集中处理并提供搜索及过滤功能，实现了快速便捷的查询，从几千万条日志里搜出有用的数据仅需几秒时间，并且可以进一步使用更有针对性的查询，不断缩窄搜索范围，找出最终证据。
2.  通过提供图形用户界面，选择、点击关键字段值进行过滤，避免办案人员使用复杂的搜索语句，降低使用门槛。
3.  把数据转化为图形化视图，更加直观，方便办案人员进行安全审计，以及快速追踪黑客入侵行为与溯源。
4.  另外，如果网站部署了日志易，可以实时采集、处理服务器产生的日志，杜绝黑客入侵后在服务器删除日志，导致安全事件发生后无法进行安全审计。