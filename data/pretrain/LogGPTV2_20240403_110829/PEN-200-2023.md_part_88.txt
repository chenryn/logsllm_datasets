Resource Script Commands
======================== n
Command Description
------- ----------- i
... z
Database Backend Commands
D
=========================
Command Description
------- -----------
...
db_nmap Executes nmap and records the output automatically
...
hosts List all hosts in the database
loot List all loot in the database
notes List all notes in the database
services List all services in the database
vulns List all vulnerabilities in the database
workspace Switch between database workspaces
Credentials Backend Commands
============================
Command Description
------- -----------
creds List all credentials in the database
Developer Commands
==================
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 638
Made in Morocco
Penetration Testing with Kali Linux
Command Description
------- -----------
...
Listing 621 Help menu of MSF commands
Before we jump into performing operations within Metasploit, let’s discuss one important concept
first: workspaces. Let’s assume we have performed a penetration test and Metasploit stored all
information about our target and its infrastructure in the database. When we start the next
penetration test, this information still exists in the database. To address this and avoid mixing
each assessment’s results with results from different assessments, we can use workspaces.
The Metasploit workspace command lists all previously-created workspaces. We can switch to a
workspace by adding the name to the command. To create a new workspace, we have to provide
the workspace name as argument to -a.
y
Let’s create a workspace named pen200 where we’ll store the results of this section and the next
one. k
msf6 > workspace
s
* default
msf6 > workspace -a pen200
o
[*] Added workspace: pen200
[*] Workspace: pen200
Listing 622 - Cnreating workspace pen200
Once created, Metasploit will use it as a current workspace as shown in listing 622.
i
Now, let’s populate the database and get familiar with some of the Database Backend
z
Commands. For this, we’ll scan BRUTE2 with db_nmap which is a wrapper to execute Nmap
inside Metasploit and save the findings in the database. The command has identical syntax to
D
Nmap:
msf6 > db_nmap
[*] Usage: db_nmap [--save | [--help | -h]] [nmap options]
msf6 > db_nmap -A 192.168.50.202
[*] Nmap: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-28 03:48 EDT
[*] Nmap: Nmap scan report for 192.168.50.202
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 993 closed tcp ports (reset)
[*] Nmap: PORT STATE SERVICE VERSION
[*] Nmap: 21/tcp open ftp?
...
[*] Nmap: 135/tcp open msrpc Microsoft Windows RPC
[*] Nmap: 139/tcp open netbios-ssn Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp open microsoft-ds?
[*] Nmap: 3389/tcp open ms-wbt-server Microsoft Terminal Services
...
[*] Nmap: 5357/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
...
[*] Nmap: 8000/tcp open http Golang net/http server (Go-IPFS json-rpc or
InfluxDB API)
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 639
Made in Morocco
Penetration Testing with Kali Linux
...
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 67.72 seconds
Listing 623 - Using db_nmap to scan BRUTE2
Listing 623 shows the results of the port scan performed with Nmap. As stated before, if the
database service is running, Metasploit will log findings and information about discovered hosts,
services, or credentials in a convenient, accessible database.
To get a list of all discovered hosts up to this point, we can enter hosts.
msf6 > hosts
Hosts
=====
address mac name os_name os_flavor os_sp puyrpose info comments
------- --- ---- ------- --------- ----- ------- ---- --------
192.168.50.202 Windows 2016 server
k
Listing 624 - Display all discovered hosts
In addition, we can enter services to display the discovered services from our port scan. We can
s
also filter for a specific port number by providing it as argument for -p.
msf6 > services o
Services
========
n
host port proto name state info
---- ---- ----- ---- ----- ----
i
192.168.50.202 21 tcp ftp open
192.168.50.202 135 tcp mzsrpc open Microsoft Windows RPC
192.168.50.202 139 tcp netbios-ssn open Microsoft Windows netbios-ssn
192.168.50.202 445 tcp microsoft-ds open
D
192.168.50.202 3389 tcp ms-wbt-server open Microsoft Terminal Services
192.168.50.202 5357 tcp http open Microsoft HTTPAPI httpd 2.0
SSDP/UPnP
192.168.50.202 8000 tcp http open Golang net/http server Go-IPFS
json-rpc or InfluxDB API
msf6 > services -p 8000
Services
========
host port proto name state info
---- ---- ----- ---- ----- ----
192.168.50.202 8000 tcp http open Golang net/http server Go-IPFS json-rpc or
InfluxDB API
Listing 625 - Display all discovered services
Listing 624 shows all discovered services up to this point. As we can filter for specific port
numbers, we can quickly identify all hosts with a specific service running.
When working on an assessment with numerous target systems, the Database Backend
Commands are invaluable in identifying important information and discovering potential attack
vectors. We can also use the results stored in the database as input to modules, which we’ll
discuss in the next section.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 640
Made in Morocco
Penetration Testing with Kali Linux
Before we head into the next section, let’s briefly review modules again. As stated, modules are
used to perform tasks in Metasploit such as scanning or exploiting a target. The framework
includes several thousand modules, divided into categories.
The categories are displayed on the splash screen summary, but we can also view them with the
show -h command.
msf6 > show -h
[*] Valid parameters for the "show" command are: all, encoders, nops, exploits,
payloads, auxiliary, post, plugins, info, options
[*] Additional module-specific parameters are: missing, advanced, evasion, targets,
actions
msf6 >
Listing 626 Help flag for the show command
Listing 626 shows the categories of Metasploit’s modules. To activatye a module, we need to enter
use with the module name. The modules all follow a common slash-delimited hierarchical syntax
(module type/os, vendor, app, operation, or protocol/module name), which makes it easy to explore
k
and use the modules. We’ll begin by exploring auxiliary modules in the next section and then dive
into exploit modules.
s
20.1.2 Auxiliary Modules
o
The Metasploit Framework includes hundreds of auxiliary modules that provide functionality such
as protocol enumeration, port scanning, fuzzing, sniffing, and more. Auxiliary modules are useful
n
for many tasks, including information gathering (under the gather/ hierarchy), scanning and
enumeration of various services (under the scanner/ hierarchy), and so on.
i
There are too many to cover here, but we will demonstrate the syntax and operation of two very
z
common auxiliary modules. To list all auxiliary modules, we can run the show auxiliary command.
This will present a very long list of all auxiliary modules as shown in the truncated output below:
D
msf6 auxiliary(scanner/portscan/tcp) > show auxiliary
Auxiliary
=========
Name Rank Description
---- ---- -----------
...
985 auxiliary/scanner/smb/impacket/dcomexec
2018-03-19 normal No DCOM Exec
986 auxiliary/scanner/smb/impacket/secretsdump
normal No DCOM Exec
987 auxiliary/scanner/smb/impacket/wmiexec
2018-03-19 normal No WMI Exec
988 auxiliary/scanner/smb/pipe_auditor
normal No SMB Session Pipe Auditor
989 auxiliary/scanner/smb/pipe_dcerpc_auditor
normal No SMB Session Pipe DCERPC Auditor
990 auxiliary/scanner/smb/psexec_loggedin_users
normal No Microsoft Windows Authenticated Logged In Users Enumeration
991 auxiliary/scanner/smb/smb_enum_gpp
normal No SMB Group Policy Preference Saved Passwords Enumeration
992 auxiliary/scanner/smb/smb_enumshares
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 641
Made in Morocco
Penetration Testing with Kali Linux
normal No SMB Share Enumeration
993 auxiliary/scanner/smb/smb_enumusers
normal No SMB User Enumeration (SAM EnumUsers)
994 auxiliary/scanner/smb/smb_enumusers_domain
normal No SMB Domain User Enumeration
995 auxiliary/scanner/smb/smb_login
normal No SMB Login Check Scanner
996 auxiliary/scanner/smb/smb_lookupsid
normal No SMB SID User Enumeration (LookupSid)
997 auxiliary/scanner/smb/smb_ms17_010
normal No MS17-010 SMB RCE Detection
998 auxiliary/scanner/smb/smb_uninit_cred
normal Yes Samba _netr_ServerPasswordSet Uninitialized Credential State
999 auxiliary/scanner/smb/smb_version
normal No SMB Version Detection
y
...
Listing 627 - Listing all auxiliary modules
k
We can use search to reduce this considerable output, filtering by app, type, CVE ID, operation,
platform, and more. For this first example, we want to obtain the SMB version of the previously
s
scanned system BRUTE2 by using a Metasploit auxiliary module.
To find the correct module, we can search for oall SMB auxiliary modules by entering search
type:auxiliary smb.
n
msf6 > search type:auxiliary smb
Matching Modules
i
================
z
# Name Disclosure Date Rank Check
Description
D
- ---- --------------- ---- -----
-----------
...
52 auxiliary/scanner/smb/smb_enumshares
normal No SMB Share Enumeration
53 auxiliary/fuzzers/smb/smb_tree_connect_corrupt
normal No SMB Tree Connect Request Corruption
54 auxiliary/fuzzers/smb/smb_tree_connect
normal No SMB Tree Connect Request Fuzzer
55 auxiliary/scanner/smb/smb_enumusers
normal No SMB User Enumeration (SAM EnumUsers)
56 auxiliary/scanner/smb/smb_version
normal No SMB Version Detection
...
Interact with a module by name or index. For example info 7, use 7 or use
auxiliary/scanner/http/wordpress_pingback_access
Listing 628 - Searching for all SMB auxiliary modules in Metasploit
Listing 628 shows us all SMB auxiliary modules the search has identified. As stated before, to
activate a module we can enter use followed by the module name, or use the index provided from
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 642
Made in Morocco
Penetration Testing with Kali Linux
search results. Let’s use the latter to activate the module auxiliary/scanner/smb/smb_version with
index 56.
msf6 > use 56
msf6 auxiliary(scanner/smb/smb_version) >
Listing 629 - Activate smb_version module
Listing 629 shows we have activated the smb_version module as indicated in the command-line
prompt.
To get information about the currently activated module, we can enter info.
msf6 auxiliary(scanner/smb/smb_version) > info
Name: SMB Version Detection
Module: auxiliary/scanner/smb/smb_version y
License: Metasploit Framework License (BSD)
Rank: Normal
k
Provided by:
hdm  s
Spencer McIntyre
Christophe De La Fuente
o
Check supported:
No
n
Basic options:
Name Current Setting Required Description
i
---- --------------- -------- -----------
RHOSTS yezs The target host(s), see
https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
THREADS 1 yes The number of concurrent threads (max one per
D
host)
Description:
Fingerprint and display version information about SMB servers.
Protocol information and host operating system (if available) will
be reported. Host operating system detection requires the remote
server to support version 1 of the SMB protocol. Compression and
encryption capability negotiation is only present in version 3.1.1.
Listing 630 - Displaying information about the smb_version module
The module description provides information about the purpose of the module as shown in listing
630.
The output also contains the Basic options, which are the arguments for the module. We can also
display the options of a module by entering show options. The options contain a column named
Required, which specifies if a value needs to be set before the module can be launched. We
should note that in most modules, Metasploit will already set some of the options for us.
msf6 auxiliary(scanner/smb/smb_version) > show options
Module options (auxiliary/scanner/smb/smb_version):
Name Current Setting Required Description
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 643
Made in Morocco
Penetration Testing with Kali Linux
---- --------------- -------- -----------
RHOSTS yes The target host(s)...
THREADS 1 yes The number of concurrent threads (max one per
host)