signature (with n = 2) simply uses the initial TTL of two diﬀerent
messages: an ICMP time-exceeded message elicited by a trace-
route probe, and an ICMP echo-reply message obtained from an
IMC ’17, November 1–3, 2017, London, United Kingdom
Y. Vanaubel et al.
echo-request probe. Table 1 summarizes the main router signa-
tures, with associated router brands and router OSes. This feature
is really interesting since the two most deployed router brands,
Cisco and Juniper, have, in theory, distinct MPLS behaviors.
In our survey, if a large proportion (i.e., 25%) of operators used a
mix of router technologies, Cisco routers are the most prominent
(58%), followed by Juniper (28%).
3 DISCOVERING INVISIBLE MPLS TUNNELS
This section describes our techniques for revealing the content,
or at least identifying the presence, of invisible MPLS tunnels. We
propose four complementary mechanisms simply based on trace-
route or ping and falling into two categories. First, Forward/Re-
turn Path Length Analysis (FRPLA) and Return Tunnel Length Anal-
ysis (RTLA) are only able to provide more or less high-level in-
formation about invisible MPLS tunnels5: an estimation (FRPLA)
or the exact number (RTLA) of hops hidden by the return MPLS
tunnel6 between the Ingress and Egress LERs in the return LSP.
Second, Direct Path Revelation (DPR) and Backward Recursive Path
Revelation (BRPR) are able to explicitly reveal the content of the
obfuscated tunnel (the hidden LSR hops in the LSP), either in a
single probe or hop by hop with a recursive probing process.
Combining those four techniques allows us to capture a major-
ity of MPLS use cases: Juniper and Cisco standard behaviors and
typical network MPLS/IGP/BGP conﬁgurations (per default in par-
ticular). Table 2 summarizes the scope of the four measurement
techniques for diﬀerent MPLS conﬁgurations. While the two fol-
lowing sections deepens our measurement techniques (Sec. 3.1 is
dedicated to FRPLA and RTLA and Sec. 3.2 to DPR and BRPR),
Sec. 3.3 validates them using several studies: (i), experimentally
with GNS3, an emulator running the actual IOS of real routers in a
virtualized environment8, and (ii), with a dedicated cross-validation
campaign on explicit tunnels. Finally, Sec. 3.4 discusses the inher-
ent limitations of our techniques.
3.1 Inferring the Length of Tunnels
The two ﬁrst techniques (FRPLA and RTLA) are based on the
same principle. When entering an invisible tunnel in the forward
path (i.e., from source to destination), the IP-TTL is not copied in
the MPLS LSE (the Ingress LER does not enable the ttl-propagate
option, as explained in Sec. 2.2), making the tunnel appear to be a
single hop route. In Fig. 2, P1, P2, and P3 in AS2 are not revealed
by the traceroute run from the Vantage Point to the target CE2,
located in AS3. Instead, the link PE1 → PE2 appears as a single hop,
as illustrated by the ﬁrst Paris traceroute [5] output on Fig. 4c.
Hopefully, when performing the traceroute from the Vantage
Point to the target, when the TTL expires at the Egress LER, it gen-
erates an ICMP time-exceeded message. If this reply also goes
back to the Vantage Point through an MPLS tunnel, when leaving
this return tunnel at its last hop, the LSE-TTL is copied in the IP-
TTL only if it is lower than the IP-TTL in order to avoid routing
5Those methods are not able to reveal the internal IP hops hidden by the tunnels.
6A return tunnel refers to the MPLS tunnel taken by the ICMP time-exceeded or
ICMP echo-reply packet.
7On Juniper routers, the TTL of the ping reply diﬀers from the traceroute one [40].
We may exploit this singularity and analysis the potential gap between the two.
8See https://gns3.com/
loops (this min behavior is implemented by Cisco [17]). More for-
mally, if we denote TT LI P (X ) (resp., TT LLS E (X )) the IP-TTL (resp.,
LSE-TTL) of the reply in transit at a node X on the return path, and
h(X , Y ) the number of hops (of the return path) from nodes X to-
wards Y , it comes:
TT LI P (V P ) = min(TT LI P (E), TT LLS E (E)) − h(E, V P ).
(1)
where V P is the vantage point that receives replies coming back via
E, the Egress LER of the return path.9 Thus, we have TT LI P (V P )
= TT LLS E (E) − h(E, V P ) when there is a tunnel on the return path.
Indeed, it is very likely the LSE-TTL and the IP-TTL have been
initialized to the same value (e.g., 255 in the vast majority as de-
scribed in [40]) at the router that originates the ICMP reply, e.g., the
Egress LER of the forward path. Thus, the LSE-TTL, at E, is always
lower than the IP-TTL as it has been decremented along the return
LSP. While the forward tunnel is totally invisible, one can infer
the length of the return tunnel (LSET T L(E) is visible). For instance,
imagine on Fig. 2 that the forward tunnel from the Vantage Point
to CE2 is the same as the return tunnel when the IP packet expires
at PE2. In that case, when generating the ICMP time-exceeded,
PE2 sets the IP and LSE-TTL to 255 [40] but only the LSE-TTL is
decremented in the tunnel. When arriving at the Egress LER of the
return path (i.e., PE1), the min scheme is applied, resulting in the
value 252 being copied in the IP-TTL (i.e., min(255, 252)). Thus, the
IP-TTL observed by the Vantage Point when receiving the ICMP
time-exceeded message would be 252 - 2 = 250.
In practice, this min scheme allows Egress routers to behave
the same (i.e., applying a minimum function on both TTLs before
leaving the MPLS tunnel) whether the ttl-propagate option is
used or not at the Ingress LER. Therefore, avoiding routing loop
occurrences is performed in a stateless manner without any sig-
nalization. With this standard behavior, the number of hops of the
tunnel is included in the return path length. However, the return
tunnel length is still not clearly retrievable. Indeed, the Egress of
the return path is not necessarily the Ingress of the forward path,
and the forward/return paths are not the same in general as rout-
ing, and BGP in particular, may introduce path asymmetry.
With FRPLA, we compare, at the AS granularity, the length dis-
tribution of forward and return paths. Then, we can statistically
analyze whether we observe a signiﬁcant diﬀerential (the so-called
“shift” in Table 2) as return paths are expected to be longer than for-
ward ones. Tunnel hops being not counted in the forward paths
while they are taken into account in the return paths. We expect
that, when no IP hops are hidden, the resulting distribution will
look like a normal distribution centered in 0 (i.e., forward and re-
turn paths have, on average, a similar length). If we observe, rather,
a shift towards positive values, it is then likely that the AS makes
use of the no-ttl-propagate option. This diﬀerence may provide
the average tunnel length of the AS.
As an example, on Fig. 2, the Egress LER, PE2, is located six hops
from the Vantage Point while only the two LERs (PE1 and PE2) are
exposed when the LSP is turned invisible. On the Paris traceroute
output, when the tunnel is made visible on Fig. 4a, we can observe
each internal hop of the forward LSP. One can conclude that if the
9In practice, this min operation is rather implemented at the penultimate hop of the
LSP, the LH LSR, when PHP is the rule. However, for readability reason, we keep the
notation as simple as possible.
Through the Wormhole: Tracking Invisible MPLS Tunnels
IMC ’17, November 1–3, 2017, London, United Kingdom
LDP advertising policy
traceroute
ttl-propagate
no-ttl-propagate
TTL propagation policy (assuming the same conﬁguration on both LERs)
All internal preﬁxes
Loopback address only
target
external
internal
external
internal
explicit LSP
no shift & no gap
explicit LSP
no shift & no gap
explicit LSP
no shift & no gap
explicit IP route
no shift & no gap
 7
invisible LSP
shift (FRPLA) & gap (RTLA)
invisible LSP
shift (FRPLA) & no gap
Last Hop without label via BRPR Last Hop without label via BRPR
shift (FRPLA) & no gap
invisible LSP
shift (FRPLA) & no gap
route without labels via DPR
shift (FRPLA) & no gap
shift (FRPLA) & gap (RTLA)
invisible LSP
shift (FRPLA) & gap (RTLA)
route without labels via DPR
shift (FRPLA) & gap (RTLA)
Table 2: Visibility eﬀects of basic MPLS conﬁgurations according to the label advertisement policy (see Sec. 2.1 for details),
traceroute target (i.e., “external” refers to a traceroute target outside the AS having the invisible MPLS tunnel, while, with
“internal”, the traceroute destination is inside the AS), and TTL policy (i.e., does the ISP hides the tunnel using a no propaga-
tion feature or not?) and the signature of the LER. We assume PHP is applied.
is initialized at 64 for ICMP echo-reply [40]. In this latter case, the
IP-TTL of the answer is always lower than the LSE-TTL (because
this one is always set to 255 and tunnels are short enough). Conse-
quently, the last hop of the return tunnel, when applying the min
function, does not copy the LSE-TTL inside the IP-TTL packet, but
rather keeps the IP-TTL, which is is still at 64 for the reply that is
originated from the Egress LER of the forward path. That is what
we call a “gap” in Table 2. More formally, we can deduce the length
of the return tunnel, h(I , E), as illustrated in Fig. 3. We observe that
the gap between the two return path lengths, given in the ﬁrst line,
is the number of hops of the return tunnel, h(I , E).
For example, applying this computation to the example of Fig. 2
and assuming that the return path is the same as the forward path,
and that PE2 has a  signature, we would have for the
time-exceeded packet TT LI P (V P ) = 250, while for the echo-reply
packet TT LI P (V P ) = 62. It comes (255 − 250) − (64 − 62) = 3, which
is the length of the (return) tunnel.
3.2 Revealing the Hidden Hops
The basic idea of these methods is that inside an MPLS net-
work, not all packets are forwarded through LSPs. This is because
LSPs may be constructed towards only a subset of internal pre-
ﬁxes (for example loopback addresses for Juniper routers, while
Cisco routers create LSPs for all internal preﬁxes) or only pack-
ets destined to a BGP next-hop may be switched through MPLS
(also a default behavior of Juniper routers [13, 27]). If one is able to
traceroute one of the router’s internal IGP IP addresses (belong-
ing to the preﬁxes related to internal traﬃc), e.g., the incoming in-
terface of the Egress LER (revealed with PHP), one can see explicit
IGP routes without labels, and so infers the hidden LDP tunnel.
Besides, Cisco routers can also be conﬁgured that way when
the network is partitioned into core and edge routers regarding
the IGP/BGP structuration (e.g., to avoid external routes redistri-
bution to IGP-only LSR). One can easily conﬁgure LDP preﬁxes
ﬁlters in order to limit LDP signalling for external BGP transit traf-
ﬁc. In both cases (Juniper per default or basic Cisco conﬁguration),
and when using the BGP next hop feature on LERs, all the exter-
nal BGP transit traﬃc goes through MPLS tunnels while the traﬃc
Figure 3: Return Tunnel Length Analysis (RTLA). I and E are
respectively the Ingress and the Egress LERs of the return
LSP. h(X , Y ) is the number of hops from node X to node Y.
forward and return paths are the same, the LSP is made of three
LSRs (a diﬀerence of 6−3 = 3 hops between the return and forward
path lengths).
FRPLA is our most generic method (see Table 2) as it should
work at least for all Cisco LSRs using PHP as default conﬁgura-
tion.10 On the contrary, RTLA only works for networks deploying
Juniper LERs on the edges. It produces similar results to FRPLA,
but with more accuracy (because Juniper TTL signatures provide
more information – see Table 1): while FRPLA only provides the
return path length until the vantage point and is, thus, sensitive
to route asymmetry (due to BGP in particular), RTLA provides ex-
actly the return tunnel length (at least in the absence of ECMP
routes that have distinct hop number) by exploiting the TTL gap
between two kinds of probes.7 Hence, when both RTLA and FRPLA
apply, we prefer to exploit the result given with RTLA.
With Juniper Egress LERs or other routers with signature  (see Table 1), and when the min behavior is enabled on the
return LSP, two kinds of probes can be used for revealing the ac-
tual return path length with RTLA. Indeed, while the TTL of the
return path is initialized at 255 for ICMP time-exceeded replies, it
10Our survey highlights that 58% of operators deploy Cisco hardware.
IMC ’17, November 1–3, 2017, London, United Kingdom
Y. Vanaubel et al.
targeting internal IP preﬁxes is routed via IGP explicit routes. On
Fig. 4c, we illustrate the use of the command mpls ldp label
allocate global host-routes that mimics a Juniper behavior
on Cisco routers: we reveal the explicit IGP route in a single prob-
ing shot if we target the incoming interface of the Egress PE2.left
(this interface shares a preﬁx with the last hop P3 on Fig. 4c). This
is the principle of the Direct Path Revelation (DPR).
Our last method, Backward Recursive Path Revelation (BRPR),
is based on the PHP feature when the network enables LDP ev-
erywhere (the standard and per default behavior of Cisco LSRs).
Since traceroute naturally reveals the incoming IP interface of
each Egress LER, we can apply a recursive traceroute approach
that targets this last internal preﬁx to reveal each intermediate hop
in a backward fashion from the Egress LER until the Ingress LER.
This approach works well when the BGP routes remain similar for
all internal preﬁxes of the targeted AS, i.e., they enter via the same
Ingress LER and follow the same shortest IGP path inside (this is
the default LDP behavior). It is worth mentioning that the incom-
ing IP interface of each Egress LSR appears thanks to both PHP and
the fact that the IP preﬁx belongs to the last hop and the Egress
LSR. On Fig. 4b, we show that four steps are necessary to stop the
recursion and reveal all internal LSRs in a backward fashion.
3.3 Validating our Measurement Techniques
In order to validate our measurement mechanisms, we conducted
experimentations using GNS3. It allows us to run the actual Cisco
IOS system, in our case IOS 15.2(4), over an emulated platform. We
also analyzed a similar Juniper testbed, except for the UHP case
which is not available for LDP on Junos. We do not show the Ju-
niper emulation here due to space limitations. For our experimenta-
tions, we setup a simple conﬁguration (see Fig. 2) with three ASes:
AS1 is the client AS, with router CE1 (the traceroute source is
connected to CE1), a transit AS (AS2) running MPLS and LDP as the
labeling protocol for the LSP setup between the ﬁve routers PE1,
P1, P2, P3, and PE2, and ﬁnally, another client AS, AS3, with router
CE2 connected to PE2. The initial traceroute target is an inter-
nal preﬁx of AS3 (i.e., a loopback of CE2). Routing between ASes
is handled with BGP, while internal routing is managed through
OSPF.
We tested several MPLS feature combinations on the network
given in Fig. 2. All of them are simple to enable (a few basic com-
mands per LSR) and close to the Cisco MPLS default conﬁguration.
The ﬁrst scenario is the so-called Default conﬁguration. PHP
(with implicit null label – label value of 3) and TTL propagation
are enabled by default, and all internal IP preﬁxes are announced
through LDP. In this case, traceroute explicitly shows LSPs, with
MPLS labels, as shown by the simulation output in Fig. 4a. Note
that the return TTL shown between brackets for nodes P1 and P2
are 247 and 248, because time-exceeded messages generated in-
side a tunnel are ﬁrst forwarded to the end of the tunnel [19].
The second scenario is the Backward Recursive conﬁguration.
It is the same as Default except that the TTL propagation is dis-
abled (command no mpls ip propagate-ttl applied on all LERs).
traceroute does not show MPLS tunnels anymore, as illustrated
in Fig. 4b. However, as mentioned in Sec. 3.2, retracing the previous
trace recursively backward starting initially from the Egress LER
8%
BRPR or DPR fail
57%
DPR successful
3%
BRPR successful
hybrid DPR/BRPR 5%
26%
BRPR or DPR
Table 3: Cross-validation results on 5,364 Ingress-Egress
LERs pairs, scattered in 271 diﬀerent ASes.
PE2 until the Ingress LER PE1 allows us to reveal the entire tun-
nel, but without any MPLS ﬂag, one LSR at a time: tracing towards
PE2 reveals the incoming address of P3 (thanks to PHP), and trac-
ing towards P3 reveals the incoming address of P2, and so on. This
corresponds to the expected output with the Backward Recursive
Path Revelation technique (BRPR).
The third scenario is the Explicit Route conﬁguration. It is sim-
ilar to Backward Recursive, but only loopback addresses (i.e., “host
addresses” instead of all preﬁxes) are announced into LDP (com-
mand mpls ldp label allocate global host-routes applied
on all LERs). As said in the introduction of Sec. 3, this is also the
default Juniper conﬁguration. In this case, a trace towards CE2 re-
veals PE2 incoming address (which is not a loopback address, hence
it is not announced through LDP), and then a trace towards this ad-
dress reveals the full LSP PE1 → P1 → P2 → P3 → PE2 (Fig. 4c) but
without MPLS ﬂags since it is not switched through MPLS space.
It corresponds thus to the output expected with the Direct Path
Revelation (DPR).
Finally, the last scenario is the Totally Invisible conﬁguration.
In this case UHP is enabled on all LERs (the command mpls ldp