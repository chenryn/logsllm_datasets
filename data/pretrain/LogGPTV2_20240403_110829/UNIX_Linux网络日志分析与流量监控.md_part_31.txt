.114:77
.55:77
201
SYSBEC
SYN_REC
SYN_RECT
SYNRECV
SYN_RECV
SYN_RECT
13
人用
---
## Page 178
案例总结
INPUT链设置为拒绝。
对于较早的系统，可能必须使用命令 scheduler interval。
过载：
为随机源地址的洪流。可以对调度程序做些设置，避免在洪流的冲击下路由器的CPU完全
超时和阈值设置应对SYN洪流和UDP垃圾洪流。例如：
ACL 阻断 ICMP echo 请求。例如：
如果能采用基于上下文的访问控制（Context Based Access Control,CBAC），则可以用其
无论是出于何种目的而发起的，DoS/DDoS 攻击都是一种不容轻视的威胁。要防范这种
该脚本会对处于 SYN_RECV 并且数量达到5 个的 IP 做统计，并且把写到 iptables 的
另一种方法是利用 iptables预防 DoS 脚本：
。在配置之后，IOS会用3秒的时间处理网络接口中断请求，之后用1秒执行其他任务。
打开Cisco快速转发（CiscoExpressForwarding，CEF）功能可帮助路由器防御数据包
printS2}'
警告：建议不要同时使用TCP截获和CBAC防御功能，因为这可能导致路由器过载。
#!/bin/bash
done
for i in $(cat /tmp/dropip)
Router(config)#scheduler allocate 3000 1000
Router(config)#ipinspect tcp max-incomplete host 300 block-time 0
Router(config)#ip inspectmax-incomplete low300
Router(config)# ip inspect max-incomplete high 400
Router(config)# ip inspect tcp synwait-time 20
Router(config)#access-list 101 permit any any
Router(config)#ip tcp intercept list 101
/sbin/iptables-AINPUT-sSi-jDROP
Router(config)#ipinspectone-minutelow500
Router(config)#ip inspect one-minute high600
Router(config)#ipinspect udpidle-time 20
Router(config)#ipinspect tcp idle-time 60
Router(config)#ip tcpintercept one-minute low2000
Router(config)#ip tcpinterceptone-minutehigh2500
Router(config)#iptcpinterceptmax-incompletelow3000
Router(config)#ip tcpinterceptmax-incomplete high3500
40
卡（
第5章DoS防御分析155
只200
AAEV
9
---
## Page 179
然在很大程度上简化了客户端进行域名查询的过程，但极大地增加了支持递归查询的DNS
是支持递归查询的本地域名服务器，会负责代理客户端完成多层迭代查询的复杂过程，这虽
特性攻击第三方主机，使该主机所在网络拥塞而无法对外提供服务。
务器本身的攻击，使 DNS 服务器不能提供正常的解析服务；放大攻击是利用DNS 服务器的
DoS扩展知识
冲区和路由器之后的主机的占用。
或 NBAR 来抛弃数据包或限制发动进攻的网络流速度，减轻路由器CPU的负担，减少对缓
接，但这与应对消耗高带宽的常规DoS/DDoS洪流的要求还有差距。我们总是可以用CAR
减轻DDoS 攻击的脚本，通过系统内置的 netstat 命令来监测跟踪创建大量网络连接的 IP 地
如DDoSDeflate，它的官网地址是http://deflate.medialayer.com，它是一款免费的用来防御和
务造成影响。
这样即使有攻击者进行DDoS攻击，破坏范围可能也仅仅是其中的一个机房，不会对整个业
权威IP信誉信息，指导安全设备自动生成防护策略，详情见本书2.1节。
和准确度。例如对应用软件和文件给予安全信誉评价，引导网络用户的下载行为，通过发布
法研究。
击的检测和防护的效率。国外已经有学者开始利用 Hadoop平台进行 Http Get Flood 的检测算
术和各种脱壳技术的恶意代码自动化分析设备，加强对新型恶意代码的研究，提高研究的时
挂马、访问重定向机制和域名解析的监控，切断恶意代码的主要感染途径。采用具备沙箱技
署蜜网设备以便追踪僵尸网络的动态，捕获恶意代码。部署网站运行监控设备，加强对网页
有效的应对策略。可以采取下面介绍的几种方法：
UDPFlood和 SYN Flood等流量攻击，还是类似于TCPFlood、CC等方式，然后再寻找相对
我们能做的就很有限了。针对DDoS 攻击，首先要分析它的攻击方式，是ICMPFlood、
访问。常规的 DoS 攻击，特别是 DDoS 攻击更难防范。如果整个带宽都被 Ping 洪流耗尽，
攻击，应该及时打上来自厂商的补丁，同时要关闭有漏洞的服务，或者用访问控制列表限制
156UNIX/Linux网络日志分析与流量监控
效性。
3）利用IP信誉机制。在信息安全防护的各个环节引入信誉机制，提高安全防护的效率
“1）利用“蜜网”防护，加强对攻击工具和恶意样本的第一时间分析和响应。大规模部
无论是本地域名服务器还是权威域名服务器，对收到的DNS 请求都会进行解析。尤其
与 DNS 相关的DoS 攻击主要分为直接攻击和放大攻击两类。直接攻击是针对 DNS 服
最后还要用不同供应商、不同AS 路径并支持负载均衡功能的不止一条到因特网的连
6）如果规模不大，机房条件一般，那可以考虑在系统中使用一些防DDoS的小工具，
5）构建分布式的系统，将自己的业务部署在多地机房，将各地区的访问分散到对应的
2）利用云计算和虚拟化等新技术平台，提高对新型攻击尤其是应用层攻击和低速率攻
（1）直接DoS攻击
当然此工具也仅仅是减轻而不能全部防止攻击。
4）采用被动策略即购买大的带宽，也可以有效减缓DDoS攻击的危害。
---
## Page 180
成。网络分为两个常规的子网（其中一个是DMZ区，连接着一台Web 服务器）、一台邮件
络包含500多台计算机，网络拓扑如图5-2所示，主要由Windows Server 和Linux 系统组
事件背景
所致。小杰管理的网络到底遭受了什么样的攻击，这种攻击又是如何得逞的呢？
为零。通过大量路由器和防火墙日志对比，得出结论：这是攻击者对其开展的一次网络攻击
中间放大器。
存在大量的僵尸网络，可以作为攻击平台，同时又有大量的开放递归的域名服务器可以作为
流量，导致其无法提供正常服务甚至崩溃。这种攻击为什么会比较流行呢？因为当前互联网
迫使其提供应答服务，经 DNS 服务器放大后的大量应答数据发送到被攻击主机，形成攻击
伪装成被攻击主机，在特定的时间点上，连续向多个DNS服务器发送大量DNS查询请求，
是巨大的，服务器会疲于处理大量的虚假域名而无法处理正常请求。
行多次本地域名列表匹配和多次网络通信。因此攻击发生时，计算资源耗费和网络带宽消耗
耗。在这种情况下虚假域名解析过程会遍历从DNS根节点到各层DNS节点的所有位置，进
解析到较小域时才发现域名不存在，这时已对服务器本地资源和所在网络带宽产生大量的消
发往更高级服务器迭代查询，直到在某一级服务器上发现此虚假域名并不存在。如果在选代
名：域名的后缀是正常的顶级域名或二级域名，域名的前端是字母、数字的随机组合。
以实施各种各样的破坏行为。为了达到更好的攻击效果，请求域名经常是随机产生的虚假域
猛增。
服务器端会比正常情况下增加约1.8MB/s的数据率。这样在短时间内引起DNS流量的
解析，所以DNS服务器对外转发，致使数据率也增加650KB/s，假设迭代查询两次，DNS
极短时间内DNS的数据率增加约650KB/s，由于攻击者发送的域名DNS服务器本地无法
须在300ms的时间内发出1000个包，每个包大小不超过200KB，因此在服务器端表现为
200ms，假设攻击者到被攻击服务器的时延约为100ms，因此要想保证攻击成功，攻击者少
回来之前发出1000个数据包才能保证足够高的成功率。正常响应时间一般不会超过
网上的计算机，秘密组建的可以集中控制的计算机群。例如缓存中毒攻击要赶在正确的响应
5.2案例五：“太冏”防火墙
服务器的负担。攻击者经常利用僵尸网络发起DoS 攻击。僵尸网络指的是攻击者利用互联
。在僵尸网络中攻击者通过控制端控制大量的僵尸主机。利用这样的攻击平台，攻击者可
某外企公司IT 工程师小杰是名普通的北漂一族。他在公司从事运维开发工作，公司网
管理员小杰在一次巡检中发现了防火墙失效，随着深入调查发现防火墙的可用空间竟然
DNS放大攻击是一种新型的拒绝服务攻击，攻击者利用僵尸网络中大量的僵尸主机，
故事人物：小杰（网络工程师）、小赵（网络工程师）
关键日志：防火墙日志、路由器日志
难度系数：★★★★
（2）DNS放大攻击
由于这些请求的域名是随机伪造的，其在服务器本地缓存中找不到相关资源记录，将被
第5章DoS防御分析157
---
## Page 181
但是用dfk查看磁盘空间，并没有释放空间。他心里直纳闷，这是怎么回事啊？
件、设置和其他目录，没有发现任何可疑之处，因此他删除了在/tmp 目录下的几个大型日志
在发生什么事。
目录已满了。小杰以前从未见过这种情况。他赶紧查看系统中的其他目录，试图找出正
就看到服务器（Checkpoint安装在Solaris 系统中）正显示存储空间分配错误，因为/tmp
事，这样他可以抽身去备考。但是他还是决定亲自去观察一下。小杰一到服务器机房，
信系统发来的报警短信，说一台
来又无法按时下班了，小杰决定去服务器机房看看出了什么问题。
终端，注意到一台防火墙没有响应了。从控制台的监控图像显示，
望尽快离开办公室去准备即将来临的CISSP认证考试。坐下之后，小杰警了一眼防火墙监
务之后，小杰返回办公室，简单回复了几封电子邮件和顾客提出的问题就一直没闲过，他希
RVO
158UNIX/Linux网络日志分析与流量监控
他删除了一个大小为3GB左右的日志文件，删除之后用Is命令查看不到这个文件了，
文件和一些没用的dump文件。
在路上，小杰遇到了另一名网络工程师小赵。小赵告诉小杰，他刚收到一个机房短
他抓取了系统中占用最高分区大小的数值：
下午两点，小杰对克隆Windows 客户端和服务器进行了一些收尾工作。在完成日常
很明显，磁盘分区用得一点儿都不剩，接着他又查看了几个关于Checkpoint 的配置文
100%
#df-ksnort-k5rlawk'/\//{printS5;exit}'
DMZ
Server
台防火墙已停止了流量转发。小杰考虑是否让小赵接管这
图5-2公司网络拓扑
Web
Server
内部办公网
CheckPoint
防火墙好像死机似的。
财
希
---
## Page 182
防火墙日志文件
天CheckPoint 防火墙内存耗尽的情况相同。随后他检查了防火墙的日志文件。
路由器部分日志文件
到端口6550结束的端口扫描证据。以下就是他发现的路由器和防火墙的日志。
近100%并且响应极其迟缓。这次小杰去检查了路由器日志文件并发现了一个从端口1开始
公室，再次查看防火墙的监视软件，看上去一切正常。
过问题，或是否升级过软件、更改过配置。小赵回答什么都没有动过。随后小杰回到了他的办
还是无功而返。小杰来到小赵的办公室和小赵讨论遇到的问题。他询问小赵，防火墙是否出现
然后将输出的进程号一一通过kill-9 终止该进程即可。很快空间得到释放。
据，还可以访问网络连接和硬件。在终端下以 root 身份输入 lsof 即可显示系统打开的文件：
第二天，小杰在上午11点左右回来工作。他注意到，还是那台防火墙的CPU使用率接
，随后，服务器恢复正常运行。小杰在服务器中查看许久，试图找到一些蛛丝马迹，最终
这是个偶然事件还是蓄谋已久的呢？接下来小杰检查了前一天的日志文件，发现这跟那
在UNIX/Linux环境下，任何事物都以文件的形式存在，通过文件不仅可以访问常规数
17042 12-Jan-10 11:00:22 accept daemon inbound tcp 10.198.167.183 172.20.10.2 htp 48347
1703912-Jan-1011:00:17accept daemon inbound tcp192.168.2.23172.20.10.2http 23409
1703812-Jan-1011:00:15 accept daemon inbound tcp10.98.242.242172.20.10.2http48456
17030 12-Jan-1011:00:14 accept daemon inbound tcp 10.142.198.25172.20.10.2htp 57424
1702812-Jan-1011:00:11 accept daemon inbound tcp10.13.3.211172.20.10.2http63992
1701512-Jan-1011:00:07 accept daemon inbound tcp172.30.3.32172.20.10.2http 50373
15589 12-Jan-10 11:00:03 accept daemon inbound tcp192.168.16.52172.20.10.2http 43822
1704012-Jan-1011:00:19accept daemon inbound tcp192.168.3.93172.20.10.2http34824
12 Jan 2010 10:56:51Accept 10.98.242.42172.20.10.26550 TCP
12 Jan 2010 10:56:40Accept 192.168.242.42172.20.10.2 6549 TCP
12Jan201010:35:08Accept192.23.98.2172.20.10.28TCP
12Jan201010:34:53Accept192.168.80.23172.20.10.27TCP
12
12J
12Jan201010:33:43Accept192.168.80.23172.20.10.24TCP
12Jan201010:33:10Accept
12 Jan201010:33:02Accept
12Jan201010:32:54Accept 192.168.6.2172.20.10.21 TCP
Jan201010:34:17Accept 192.168.134.32172.20.10.26TCP
Jan 2010 10:34:04Accept 192.168.67.83172.20.10.2 5 TCP
10.87.38.93172.20.10.23TCP
10.2.52.78172.20.10.22TCP
第5章DoS防御分析159
MuMaas
公
卫
MY&
---
## Page 183
防火墙可能允许一个孤立的 ACK 包触发一次假的会话，并在把它清除之前保存长达 1h。因
储器中清除。另一方面，ACK信息包的保存时限一般为3600s，如图5-3所示。这就意味着
说，防火墙可能会错误地将一个原有的ACK 包填充到状态表中，而不管它们是否属于同-
意一个ACK在状态表中有相应的初始化SYN信息与之对应，防火墙就能接受它。也就是
定），过程如图5-3所示。1
包匹配的SYN包，这个ACK也会被存储在状态表中（如果不违反访问控制列表的规
态表中，状态表被更新，等待最后一个ACK 发过来。但如果状态表中不包含与这个ACK
个 SYN 信息包是否被认可了。如果与状态表里的记录是匹配的，这个 ACK 就被加入到状
接。下一个“握手”数据包（ACK）首先要跟状态表中的相应记录比较，以查看它的上一
按照它的访问控制规则决定这个请求是否能被接受。如果接受，这个信息就被保存到防火
好像是“三次握手”，当防火墙接到开始“握手”的第一个包（带SYN的TCP包）时，将
说，计算机将无丢失地传输所有的通信数据。为了保证这种可靠的通信，连接初始过程就
连接的发起过程的每一个包，并将这些信息一直保存到连接会话结束。
说它能跟踪通过防火墙的网络连接的状态。一个具有“状态”的防火墙，能保存每一个网络
调查分析
互动问答
特殊的模式。束手无策的小杰下一步该怎么办呢？
源IP都不同，似乎是随机产生的地址。扫描的端口号似乎也是随机选择的，没有遵循任何
UDP包，只有大约9%是ICMP包。正当他想搞清楚激增的流量来自何处时，他发现每一个
650~1500个。从日志上小杰查明，至少扫描了23500个端口，大约65%是TCP包，13%是
因。小杰注意到，在攻击期间数据包的数量从通常的每秒20～70个左右，突然跳到每秒
进入网络。
拒绝了大部分专用端口（1024以下的端口）的流量，只允许FTP、HTTP、SSL和SSH流量
数据库中更改他的工资外，公司还没有经历过任何真正的安全事件。防火墙的访问控制列表
160UNIX/Linux网络日志分析与流量监控
当SYN传输的下一个ACK没有在规定时间内到达时，这个SYN信息就被从防火墙存
但问题是防火墙并不要求在一次会话中的第一条信息必须是SYN包。理论上讲只要任
存储器的状态表中，同时，防火墙等待按顺序到达的下一个信息包，以建立正确的连
两台计算机通过TCP协议（HTTP连接）的通信被认为是一种可靠的连接。换句话
小杰认定他遭受的是针对防火墙的拒绝服务（DoS）攻击，而且他也已经弄明白了攻击
2.这类攻击是如何得逞的？
平静下来后，小杰开始逐行仔细检查日志文件，试图找出事件的次序和扰乱防火墙的原
看到这里，他心跳开始加速。直到现在为止，除了会计部的一个家伙企图在人力资源部
1.本案例中的网络遭受了哪类攻击？
1704312-Jan-1011:00:23 accept daemon inbound tcp10.134.118.45172.20.10.2http54827
文志日衣由部
---
## Page 184