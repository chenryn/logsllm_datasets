K-nearest neighbour search
for PostgreSQL
Oleg Bartunov, Teodor Sigaev
Moscow University
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Knn-search: The problem
What are interesting points near Royal Oak pub in Ottawa ?
●
What are the closest events to the May 20, 2009 in Ottawa ?
●
Similar images – feature extraction, Hamming distance
●
Classification problem (major voting)
●
............
●
GIS, Science (high-dimensional data)
●
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Knn-search: Existing solutions
knn=# select id, date, event from events order by date  '1957-10-04'::date asc
limit 10;
id | date | event
--------+------------+-----------------------------------------------------------------
58137 | 1957-10-04 | U.S.S.R. launches Sputnik I, 1st artificial Earth satellite
58136 | 1957-10-04 | "Leave It to Beaver," debuts on CBS
117062 | 1957-10-04 | Gregory T Linteris, Demarest, New Jersey, astronaut, sk: STS 83
117061 | 1957-10-04 | Christina Smith, born in Miami, Florida, playmate, Mar, 1978
102670 | 1957-10-05 | Larry Saumell, jockey
31456 | 1957-10-03 | Willy Brandt elected mayor of West Berlin
58291 | 1957-10-05 | 12th Ryder Cup: Britain-Ireland, 7 -4 at Lindrick GC, England
58290 | 1957-10-05 | 11th NHL All-Star Game: All-Stars beat Montreal 5-3 at Montreal
58292 | 1957-10-05 | Yugoslav dissident Milovan Djilos sentenced to 7 years
102669 | 1957-10-05 | Jeanne Evert, tennis player, Chris' sister
(10 rows)
Time: 115.548 ms
Very inefficient:
●
– Full table scan, classic B-tree index on date won't help.
– Sort full table
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Knn-search: Existing solutions
Traditional way to speedup query
●
– Constrain data space (range search)
Range search can use index
●
Incremental search → to many queries
●
Need to know in advance size of neighbourhood, how ?
●
1Km is ok for Paris, but too small for Siberia
Maintain 'density map' ?
●
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
What's a neighbourhood ?
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Knn-search: What do we want !
We want to avoid full table scan – read only  tuples
●
– So, we need index
We want to avoid sorting – read  tuples in 
●
order
– So, we need special strategy to traverse index
We want to support tuples visibility
●
– So, we should be able to resume index traverse
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
R-tree index
Root page
Root page
R1 I1 E
R1 R2
E
E
E
R2 I2 E Inner page 1 Inner page 2
Inner page 1 Inner page 2
I1 I3 I2 I4
I3 E
E
E E
E
E Leaf page 1 Leaf page 3 Leaf page 2
Leaf page 1 Leaf page 3 Leaf page 2
I4 E
E E E E E E E E
E
E
E E
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
R-tree index
Visualization of
●
R-tree index using
Gevel.
●
Greece
(data from
rtreeportal.org)
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
R-tree index
R1 I1 E
SELECT
E *
E
E FROM
events
R2 I2 E
WHERE
events.coord  tuples
●
– So, we need index
+ We want to avoid sorting – read  tuples in 
●
order
– So, we need special strategy to traverse index
+ We want to support tuples visibility
●
– So, we should be able to resume index traverse
We want to support many data types
●
– So, we need to modify GiST
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Knn-search: modify GiST
GiST – Generalized Search Tree, provides
●
– API to build custom disk-based search trees (any tree, where
key of internal page is a Union of keys on children pages)
– Recovery and Concurrency
– Data type and query extendability
GiST is widely used in GIS (PostGIS), text search,...
●
Current strategy of search tree traverse is DFS
●
– Not good for knn-search
– We need to add Best First Search strategy for knn-search
– Retain API compatibility
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Knn-search: syntax
Knn-query uses ORDER BY clause
SELECT … FROM … WHERE …
ORDER BY p  '(0.0, 0.0)'::point
LIMIT k;
 - distance operator, should be
provided for data type
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
GiST interface
compress/decompress
●
same
●
union
●
penalty
●
picksplit
●
Consistent – controls search tree traverse
●
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
GiST changes
! bool consistent(
Datum key,
Datum query,
StrategyNumber strategy,
Oid subtype /* unused */,
bool *recheck );
--- XXX, YYY ---
! double consistent(
Datum key,
Datum query,
StrategyNumber strategy,
Oid subtype /* unused */,
bool *recheck );
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Return value of consistent
 0 - distance for ORDER BY clause
●
„wrapper“ for old consistent method:
●
false => -1
true => 0
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
Consistent interface
GiST's traverse algorithm treats WHERE and ORDER BY
●
clauses in uniform way.
Consistent from strategy number knows data types of query
●
and WHERE/ORDER BY clauses.
Consistent should not return recheck = true for ORDER
●
BY clause – how to order data, which need recheck ?
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
The problem
We need to recognize if operator is from ORDER BY clause –
●
different work with NULL values
– For WHERE clause strict operator should discard NULL
– For ORDER BY assume distance is infinity (ASC NULLS
LAST)
Currently, we do this by operation's returned value – non-bool type
●
Option 1: add flag to pg_amop to indicate, that operator used in
●
ORDER BY clause
– bool returned operator could be duplicated in operator family →
too many work to allow index support for boolean distance
Option 2: if operator returns DOUBLE – it's knn-search
●
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
GiST + Depth First Search
Go away
Push BlkNo of root
into stack
Y
N
Is stack empty?
N Pop BlkNo
Push all matched
and read page
BlkNos into stack
Is a leaf?
Return all matched
entries
Y
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
KNN-search: GiST + Priority Queue
Go away
Push (BlkNo of root,
Y
distance = 0)
N
Is queue empty?
Read index page,
push matched pairs
Pop (pointer, distance)
N
(pointer, distance)
Distance is a result
of consistent methods
Is a pointer
to heap?
Y
Return pointer
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
GiST: Technical details
Priority queue is implemented as a RB-tree (Red-Black tree)
●
Each node of RB-tree contains a list of pointers - pointers to
●
internal pages follow pointers to heap.
Heap (10,12)
1100..33
HEAD
Heap (34,1)
88..11 1111..99 Heap (9,30)
TAIL of Heap (98,11)
heap's
99..00
Index (p 34)
pointers
Index (p 102)
Oleg Bartunov, Teodor Sigaev PGCon-2010, Ottawa, May 20-21, 2010
GiST: Technical details
Depth First Search
Best First Search
push Stack, Root;
push PQ, Root;
While Stack {
While PQ {
If p is heap {
If p is heap {
output p;
output p;
else {
else {
children = get_children(p);