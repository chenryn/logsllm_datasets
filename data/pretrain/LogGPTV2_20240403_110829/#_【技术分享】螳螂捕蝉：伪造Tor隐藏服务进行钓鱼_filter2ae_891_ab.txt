### 信息POST给我，以便后续分析

在使用合法网站时，我发现浏览器会修改我使用的脚本。然而，在访问钓鱼网站时，我收到的是一个过时的版本。这表明钓鱼站点可能使用了额外的缓存机制，以减少页面加载时间。

在调查这种缓存机制的过程中，我发现了一些有趣的信息。代理服务器会丢弃跟踪脚本获取的所有内容，导致我无法获取这些信息。通过重命名脚本并稍加修改其内容，我解决了这个问题，但我不希望继续玩这种猫捉老鼠的游戏。这种情况至少表明有人正在积极维护这个代理服务，并采取措施保持其正常运行。

### 隐藏服务地址被修改

代理服务器似乎会将所有出现 **smspriv6fynj23u6.onion** 的实例替换为 **smsprivyevs6xn6z.onion**。不过，对于大写的地址，代理服务器不会进行同样的操作。

### 比特币地址被修改

这是钓鱼站点的主要目的。通常情况下，钓鱼网站会窃取用户凭据，用于后续使用或出售。但这个站点采取了一种更直接的方法：将原始的比特币地址替换为攻击者可以控制的地址。

当用户首次被重定向到支付页面时，会感受到一段延迟。这可能是由于代理服务器在后台生成新的比特币地址（这一过程需要时间，意味着该地址可能被插入一个缺少索引的大数据库中，或者由速度较慢的机器生成，甚至可能是由效率较低的代码语言生成）。所有文本形式的比特币地址都会被重写为攻击者可控的地址，合法地址与伪造地址之间存在一一映射关系。值得注意的是，二维码（QR）仍然对应原始的合法地址。

我向伪造的地址 **1GM6Awv28kSfzak2Y7Pj1NRdWiXshMwdGW** 发起了一笔支付请求，以观察会发生什么。这笔钱目前尚未被使用，但一旦被使用，我们可能会发现一些有价值的信息。

### 伪造站点如何分发给用户

当用户在未知域上查看站点时，JavaScript 会将referrer信息POST到服务器。大多数情况下，这些信息来自人们使用web代理（如onion.link）来查看隐藏服务。但我发现了两个特殊的隐藏服务：

- **7cbqhjnpcgixggts.onion**：“The onion crate”：这是一个Tor隐藏服务列表，类似于远古的“Web网站清单”，但专为Tor设计。其中，钓鱼站点被标记为“钓鱼链接”（尽管Reddit上有用户指出“The onion crate”本身可能是钓鱼链接）。
- **hss3uro2hsxfogfq.onion**：“not Evil”：这是一个搜索引擎服务，用于搜索Tor隐藏服务。搜索“sms privacy”时，合法站点排在第一位，钓鱼站点排在第二位。我点击了钓鱼站点旁的“滥用情况报告”按钮，但搜索结果仍未删除该站点。

这并没有提供我希望的结果。我希望找到某人伪造的推特、博客或其他相关信息。“The onion crate”的管理员不太可能负责维护这个钓鱼站点，因为如果他们希望人们使用他们的钓鱼站点，就不会将其标记为“钓鱼链接”。而“not Evil”搜索引擎的管理员可能是肇事者，但这也并不符合实际情况。如果我维护某个搜索引擎并希望推送钓鱼链接，根本不会将正常链接包括在搜索结果中，更不会将其排在第一位。

很有可能真正的钓鱼攻击正在进行，“The onion crate”于2017-05-17将钓鱼链接标记出来，表明这个钓鱼网站已经存在一段时间。

### 谁是肇事者

最有可能的情况是，某个普通的网络犯罪分子编写了一个代理服务器，将比特币地址替换为自己的地址，为各种合法的隐藏服务生成了许多伪造的隐藏服务，然后等待金钱流入他的钱包。

起初我认为是情报部门希望监控隐私短信用户，但如果是这种情况，他们不会修改比特币地址导致站点失效，而是会悄悄进行监视。我猜测情报部门会将该站点设计成只监听特定的用户子集，对其他人呈现普通的钓鱼站点。但我还是认为“普通网络犯罪分子”这种可能性最大。

与传统网站相比，伪造隐藏服务进行钓鱼更容易，因为定位隐藏服务的服务器本身就不是件容易的事（这也是隐藏服务的设计理念）。隐藏服务没有集中管控的命名系统，这意味着即便是合法的站点，其地址中也会包含随机字符。获取伪造的地址也比较容易。即便伪造的钓鱼网站被发现，也没有人能够撤销攻击者的域名或关闭托管页面。这是完美的犯罪行为，唯一的缺点是隐藏服务的目标用户群体的技术水平往往更高，因此不是那么好欺骗。

### 用户如何保护自己

SMS Privacy的客户应确保通过HTTPS浏览smsprivacy.org。如果使用Tor，请核实使用的隐藏服务名为唯一正确的 **smspriv6fynj23u6.onion**。除此之外，其他访问方式几乎肯定会带来安全风险。

### 是否有用户受到影响

截至目前，我尚未收到用户的电子邮件抱怨支付异常。因此，我认为目前没有用户受到影响，或者至少没有大量用户受到影响。

### 后续调查

我猜测运行这个代理的软件也在代理许多其他隐藏服务。如果你想编写代码来代理隐藏服务，只需将域名和比特币地址改成自己的即可。你可以将代理服务放置在许多上游隐藏服务的前端，这几乎不需要消耗额外的精力及资源。如果攻击者没有这么做，反而会让我感到奇怪。

如果我们能找到另一个具有相同特征的Tor隐藏服务钓鱼站点（例如Connection: [object Object]、缺失Content-Length字段、重写小写的隐藏服务地址、首次呈现比特币地址时会有延迟以及访问未知主机名时返回500响应代码），那么我们可能会发现一些有趣的结论。

此外，如果我们探测该网站的漏洞，看看是否能找到所代理的隐藏服务的完整列表，也会非常有趣。攻击者可能在代理代码中实现了主机名选择功能，也就是说请求不同的钓鱼站点可能会返回其他钓鱼站点的内容。如果出现这种结果，我们可以更加确信这些代理站点运行在同一台主机上。

### 总结

发现有人正在积极从事这项活动是非常有趣的一件事。只要稍作思考，我们可知大范围部署这种方案非常容易：只需一个周末的时间，攻击者就能搭建起基本的工作环境。如果未来有大量隐藏服务的钓鱼网站出现，我并不会感到惊讶。

### 2017-10-13 更新

在这篇文章发表之后，我根据“后续调查”中的建议进行了调研。我在“The onion crate”中查找其他钓鱼链接，发现某个网站会在响应头中包含Connection: [object Object]信息，并传递伪造的SMS Privacy隐藏服务地址。调查结果表明，这个毫不相关的隐藏服务同样给出了伪造的SMS Privacy内容！这表明这两个站点很可能托管在同一台主机上，由同一个操作者（或组织）进行维护，这一切证实了这个系统的规模非常庞大：

```bash
$ torsocks curl -I -H 'Host: smsprivyevs6xn6z.onion' http://cboc66yz75virnj7.onion
HTTP/1.1 200 OK
Server: nginx/1.10.2
Date: Fri, 13 Oct 2017 16:26:10 GMT
Content-Type: text/html;charset=UTF-8
Connection: [object Object]
Set-Cookie: mojolicious=eyJsYW5kaW5nX3VybCI6Ii8iLCJhYnRlc3RzIjp7ImxhbmRpbmdfdXJsIjoiLyIsInNpZ251cGxpbmsiOiJvcmlnaW5hbCIsInJlZmVyX3NyYyI6Im5vbmUiLCJoaWRkZW5fc2VydmljZSI6ImhpZGRlbiJ9LCJleHBpcmVzIjoxNTA3OTE1NzE1LCJjc3JmX3Rva2VuIjoiZmQzNjc4NzcyMjRiNDZkZWZhYjNhM2ViZDIwMDY0ZmRmMDliZmQ0NCIsImFidGVzdHNfc2Vzc2lvbmlkIjoiOGM4NWQxMTZjMmE1MTBkOSJ9--785fbe83dce1217e74543ed831eb4c18c1cd6105; expires=Fri, 13 Oct 2017 17:28:35 GMT; path=/; HttpOnly
X-Frame-Options: DENY
```

这段输出进一步确认了我们的假设。