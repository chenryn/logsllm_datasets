Attack Scenario ...............................................................................................................152
ARP Poisoning with Cain and Abel ................................................................................153
Sniffing Session Cookies with Wireshark ........................................................................155
Hijacking the Session ......................................................................................................156
SSL Strip: Stripping HTTPS Traffic ...............................................................................157
Requirements ..................................................................................................................157
Usage .....................................................................................................................158
Automating Man in the Middle Attacks .........................................................................158
Usage .....................................................................................................................158
DNS Spoofing ................................................................................................................159
ARP Spoofing Attack ............................................................................................159
Manipulating the DNS Records ............................................................................160
Using Ettercap to Launch DNS Spoofing Attack ...................................................160
DHCP Spoofing .............................................................................................................160
Conclusion ......................................................................................................................161
xii ◾ Contents
7 Remote Exploitation .................................................................................................163
Understanding Network Protocols ..................................................................................163
Transmission Control Protocol ..............................................................................164
User Datagram Protocol ........................................................................................164
Internet Control Messaging Protocol .....................................................................164
Server Protocols ..............................................................................................................164
Text-Based Protocols (Important) ..........................................................................164
Binary Protocols ....................................................................................................164
FTP ..............................................................................................................165
SMTP ...........................................................................................................165
HTTP ..........................................................................................................165
Further Reading..............................................................................................................165
Resources ........................................................................................................................166
Attacking Network Remote Services ...............................................................................166
Overview of Brute Force Attacks ...........................................................................166
Traditional Brute Force ................................................................................166
Dictionary Attacks .......................................................................................166
Hybrid Attacks .............................................................................................167
Common Target Protocols ..............................................................................................167
Tools of the Trade ...........................................................................................................167
THC Hydra ...........................................................................................................167
Basic Syntax for Hydra ...................................................................................................168
Cracking Services with Hydra ...............................................................................168
Hydra GUI .....................................................................................................................170
Medusa ..................................................................................................................170
Basic Syntax ....................................................................................................................170
OpenSSH Username Discovery Bug ...............................................................................170
Cracking SSH with Medusa ...........................................................................................171
Ncrack ...................................................................................................................171
Basic Syntax ....................................................................................................................171
Cracking an RDP with Ncrack .......................................................................................172
Case Study of a Morto Worm ................................................................................172
Combining Nmap and Ncrack for Optimal Results .......................................................172
Attacking SMTP ...................................................................................................173
Important Commands ....................................................................................................174
Real-Life Example ..........................................................................................................174
Attacking SQL Servers ....................................................................................................175
MySQL Servers ......................................................................................................175
Fingerprinting MySQL Version ......................................................................................175
Testing for Weak Authentication ....................................................................................175
MS SQL Servers .............................................................................................................176
Fingerprinting the Version ..............................................................................................177
Brute Forcing SA Account ..............................................................................................177
Using Null Passwords .....................................................................................................178
Introduction to Metasploit ..............................................................................................178
History of Metasploit ......................................................................................................178
Contents ◾ xiii
Metasploit Interfaces .......................................................................................................178
MSFConsole ...................................................................................................................178
MSFcli ...................................................................................................................179
MSFGUI ...............................................................................................................179
Armitage ................................................................................................................179
Metasploit Utilities .........................................................................................................179
MSFPayload ....................................................................................................................179
MSFEncode ....................................................................................................................179
MSFVenom ....................................................................................................................179
Metasploit Basic Commands ..........................................................................................180
Search Feature in Metasploit ...........................................................................................180
Use Command ................................................................................................................181
Info Command ...............................................................................................................181
Show Options .................................................................................................................181
Set/Unset Command ......................................................................................................182
Reconnaissance with Metasploit .....................................................................................182
Port Scanning with Metasploit .......................................................................................182
Metasploit Databases ......................................................................................................182
Storing Information from Nmap into Metasploit Database ............................................183
Useful Scans with Metasploit ..........................................................................................184
Port Scanners .........................................................................................................184
Specific Scanners ...................................................................................................184
Compromising a Windows Host with Metasploit ...........................................................184
Metasploit Autopwn .......................................................................................................188
db _ autopwn in Action .............................................................................................188
Nessus and Autopwn ......................................................................................................189
Armitage ................................................................................................................189
Interface ..........................................................................................................................190
Launching Armitage .......................................................................................................190
Compromising Your First Target from Armitage ............................................................191
Enumerating and Fingerprinting the Target ...................................................................191
MSF Scans ......................................................................................................................192
Importing Hosts .............................................................................................................192
Vulnerability Assessment ................................................................................................193
Exploitation ....................................................................................................................193
Check Feature .................................................................................................................195
Hail Mary .......................................................................................................................196
Conclusion ......................................................................................................................196
References .......................................................................................................................196
8 Client Side Exploitation ...........................................................................................197
Client Side Exploitation Methods ...................................................................................197
Attack Scenario 1: E-Mails Leading to Malicious Attachments .............................197
Attack Scenario 2: E-Mails Leading to Malicious Links ........................................197
Attack Scenario 3: Compromising Client Side Update ..........................................198
Attack Scenario 4: Malware Loaded on USB Sticks ...............................................198
xiv ◾ Contents
E-Mails with Malicious Attachments ....................................................................198
Creating a Custom Executable ......................................................................198
Creating a Backdoor with SET .....................................................................198
PDF Hacking ...............................................................................................201
Introduction ...................................................................................................................201
Header ..................................................................................................................202
Body .....................................................................................................................202
Cross Reference Table ...........................................................................................202
Trailer ...................................................................................................................202
PDF Launch Action .......................................................................................................202
Creating a PDF Document with a Launch Action .........................................................203
Controlling the Dialog Boxes ...............................................................................205
PDF Reconnaissance ............................................................................................205
Tools of the Trade ..........................................................................................................205
PDFINFO ............................................................................................................205
PDFINFO “Your PDF Document” .............................................................206
PDFTK ................................................................................................................206
Origami Framework ......................................................................................................207
Installing Origami Framework on BackTrack ................................................................207
Attacking with PDF .......................................................................................................208
Fileformat Exploits ...............................................................................................208
Browser Exploits ...................................................................................................208
Scenario from Real World ..............................................................................................209
Adobe PDF Embedded EXE ...........................................................................................210
Social Engineering Toolkit ..............................................................................................211
Attack Scenario 2: E-Mails Leading to Malicious Links ........................................213
Credential Harvester Attack ...........................................................................................214
Tabnabbing Attack .........................................................................................................215
Other Attack Vectors ......................................................................................................216
Browser Exploitation .......................................................................................................217
Attacking over the Internet with SET .............................................................................217
Attack Scenario over the Internet ....................................................................................217
Using Windows Box as Router (Port Forwarding) .........................................................220
Browser AutoPWN ...............................................................................................220
Why Use Browser AutoPWN? ........................................................................................221
Problem with Browser AutoPWN ...................................................................................221
VPS/Dedicated Server ...................................................................................................223
Attack Scenario 3: Compromising Client Side Update .........................................223
How Evilgrade Works ....................................................................................................223
Prerequisites ...................................................................................................................223
Attack Vectors ......................................................................................................223
Internal Network Attack Vectors ..........................................................................223
External Network Attack Vectors .........................................................................224
Evilgrade Console .................................................................................................224
Attack Scenario.....................................................................................................224
Attack Scenario 4: Malware Loaded on USB Sticks ..............................................227
Contents ◾ xv
Teensy USB ...................................................................................................................229
Conclusion .....................................................................................................................229
Further Reading.............................................................................................................229
9 Postexploitation ........................................................................................................231
Acquiring Situation Awareness........................................................................................231
Enumerating a Windows Machine ........................................................................231
Enumerating Local Groups and Users ...................................................................233
Enumerating a Linux Machine ..............................................................................233
Enumerating with Meterpreter ..............................................................................235
Identifying Processes ....................................................................................235
Interacting with the System ..........................................................................235
User Interface Command .............................................................................235
Privilege Escalation ........................................................................................................236
Maintaining Stability ...........................................................................................236
Escalating Privileges.......................................................................................................237
Bypassing User Access Control .............................................................................238
Impersonating the Token ......................................................................................239
Escalating Privileges on a Linux Machine ..............................................................241
Maintaining Access.........................................................................................................241
Installing a Backdoor ......................................................................................................241
Cracking the Hashes to Gain Access to Other Services ..................................................241
Backdoors .......................................................................................................................241
Disabling the Firewall ...........................................................................................242
Killing the Antivirus .............................................................................................242
Netcat ...................................................................................................................243
MSFPayload/MSFEncode ..............................................................................................244
Generating a Backdoor with MSFPayload ............................................................244
MSFEncode ...........................................................................................................245
MSFVenom ...................................................................................................................246
Persistence .............................................................................................................247
What Is a Hash? ....................................................................................................249
Hashing Algorithms ..............................................................................................249
Windows Hashing Methods ..................................................................................250
LAN Manager (LM) .............................................................................................250
NTLM/NTLM2 ...................................................................................................250
Kerberos ................................................................................................................250
Where Are LM/NTLM Hashes Located? ..............................................................250
Dumping the Hashes ......................................................................................................251
Scenario 1—Remote Access ...................................................................................251
Scenario 2—Local Access ......................................................................................251
Ophcrack ...............................................................................................................252
References .......................................................................................................................253
Scenario 3—Offline System ..................................................................................253
Ophcrack LiveCD .................................................................................................253
Bypassing the Log-In .............................................................................................253
xvi ◾ Contents
References .......................................................................................................................253
Cracking the Hashes .......................................................................................................253
Bruteforce ..............................................................................................................253
Dictionary Attacks ...............................................................................................254
Password Salts .......................................................................................................254
Rainbow Tables ....................................................................................................254
John the Ripper ..............................................................................................................255
Cracking LM/NTLM Passwords with JTR ...........................................................255
Cracking Linux Passwords with JTR .....................................................................256
Rainbow Crack ...............................................................................................................256
Sorting the Tables ..................................................................................................257
Cracking the Hashes with rcrack ...........................................................................258
Speeding Up the Cracking Process ........................................................................258
Gaining Access to Remote Services .......................................................................258
Enabling the Remote Desktop ...............................................................................259
Adding Users to the Remote Desktop ....................................................................259
Data Mining ...................................................................................................................259
Gathering OS Information ...................................................................................260
Harvesting Stored Credentials ...............................................................................261
Identifying and Exploiting Further Targets ...................................................................262
Mapping the Internal Network .............................................................................263
Finding Network Information ..............................................................................264
Identifying Further Targets ...................................................................................265
Pivoting ................................................................................................................266
Scanning Ports and Services and Detecting OS .....................................................267
Compromising Other Hosts on the Network Having the Same Password ............268
psexec ............................................................................................................................269
Exploiting Targets ..................................................................................................270
Conclusion ......................................................................................................................270
10 Windows Exploit Development Basics .....................................................................271
Prerequisites ....................................................................................................................271
What Is a Buffer Overflow?.............................................................................................271
Vulnerable Application ..................................................................................................272
How to Find Buffer Overflows .......................................................................................273
Methodology .................................................................................................................273
Getting the Software Up and Running ..........................................................................273
Causing the Application to Crash ..................................................................................273
Skeleton Exploit ..............................................................................................................275
Determining the Offset ........................................................................................278
Identifying Bad Characters ...................................................................................280
Figuring Out Bad Characters with Mona .......................................................................281
Overwriting the Return Address ...........................................................................283
NOP Sledges.........................................................................................................285
Generating the ShellCode .....................................................................................286
Generating Metasploit Module ......................................................................................287
Porting to Metasploit .....................................................................................................288
Contents ◾ xvii
Conclusion .....................................................................................................................290
Further Resources ..........................................................................................................290
11 Wireless Hacking .....................................................................................................291
Introduction ...................................................................................................................291
Requirements ..................................................................................................................291
Introducing Aircrack-ng ..................................................................................................293
Uncovering Hidden SSIDs .............................................................................................293
Turning on the Monitor Mode ......................................................................................294
Monitoring Beacon Frames on Wireshark .....................................................................294
Monitoring with Airodump-ng ......................................................................................295
Speeding Up the Process ................................................................................................296
Bypassing MAC Filters on Wireless Networks ......................................................296
Cracking a WEP Wireless Network with Aircrack-ng ..........................................298
Placing Your Wireless Adapter in Monitor Mode ...........................................................298
Determining the Target with Airodump-ng...................................................................299
Attacking the Target .............................................................................................299
Speeding Up the Cracking Process .......................................................................300
Injecting ARP Packets ..........................................................................................300
Cracking the WEP ................................................................................................301
Cracking a WPA/WPA2 Wireless Network Using Aircrack-ng .....................................302
Capturing Packets ..........................................................................................................303
Capturing the Four-Way Handshake .............................................................................303
Cracking WPA/WAP2 ..................................................................................................304
Using Reaver to Crack WPS-Enabled Wireless Networks.....................................305
Reducing the Delay .......................................................................................................306
Further Reading.............................................................................................................306
Setting Up a Fake Access Point with SET to PWN Users .....................................306
Attack Scenario ..............................................................................................................309
Evil Twin Attack ....................................................................................................310
Scanning the Neighbors ..................................................................................................311
Spoofing the MAC..........................................................................................................311
Setting Up a Fake Access Point .......................................................................................311
Causing Denial of Service on the Original AP ................................................................311
Conclusion ......................................................................................................................312
12 Web Hacking ............................................................................................................313
Attacking the Authentication ..........................................................................................313
Username Enumeration .........................................................................................314
Invalid Username with Invalid Password ...............................................................314
Valid Username with Invalid Password ..................................................................314
Enabling Browser Cache to Store Passwords ..........................................................314
Brute Force and Dictionary Attacks ................................................................................315
Types of Authentication ..................................................................................................315
HTTP Basic Authentication ..................................................................................315
HTTP-Digest Authentication ................................................................................316
Form-Based Authentication ...................................................................................317
Exploiting Password Reset Feature ........................................................................319
xviii ◾ Contents
Etsy.com Password Reset Vulnerability ...........................................................................319
Attacking Form-Based Authentication ..................................................................320
Brute Force Attack .........................................................................................................322
Attacking HTTP Basic Auth ................................................................................323
Further Reading.............................................................................................................326
Log-In Protection Mechanisms .............................................................................326
CAPTCHA Validation Flaw ................................................................................326
CAPTCHA Reset Flaw ........................................................................................328
Manipulating User-Agents to Bypass CAPTCHA and Other Protections .............329
Real-World Example .............................................................................................330
Authentication Bypass Attacks ..............................................................................330
Authentication Bypass Using SQL Injection .........................................................330
Testing for SQL Injection Auth Bypass ..................................................................331
Authentication Bypass Using XPATH Injection ....................................................333
Testing for XPATH Injection .......................................................................333
Authentication Bypass Using Response Tampering ..............................................334
Crawling Restricted Links .............................................................................................334
Testing for the Vulnerability ...........................................................................................335
Automating It with Burp Suite .............................................................................336
Authentication Bypass with Insecure Cookie Handling .................................................336
Session Attacks ......................................................................................................339
Guessing Weak Session ID ....................................................................................339
Session Fixation Attacks .......................................................................................341
Requirements for This Attack ........................................................................................342
How the Attack Works ..................................................................................................342
SQL Injection Attacks ..........................................................................................342
What Is an SQL Injection? ...................................................................................342
Types of SQL Injection .........................................................................................342
Union-Based SQL Injection ........................................................................343
Error-Based SQL Injection ..........................................................................343
Blind SQL Injection ....................................................................................343
Detecting SQL Injection ......................................................................................343
Determining the Injection Type ...........................................................................343
Union-Based SQL Injection (MySQL)..................................................................344
Testing for SQL Injection ..............................................................................................344
Determining the Number of Columns ..................................................................345
Determining the Vulnerable Columns ..................................................................346
Fingerprinting the Database .................................................................................347
Enumeration Information .....................................................................................347
Information_schema .............................................................................................348
Information_schema Tables ..................................................................................348
Enumerating All Available Databases ...................................................................348
Enumerating All Available Tables in the Database ................................................349
Extracting Columns from Tables ..........................................................................349
Extracting Data from Columns .............................................................................350
Using group _ concat .....................................................................................350