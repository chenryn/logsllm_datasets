6/25/11 
Balancing the Pwn Trade Deficit Series: 
APT Secrets in Asia 
{Anthony Lai,Benson Wu,Jeremy Chiu} Xecure Founder and 
Researcher 
PK, Security Researcher 
6/25/11 
There is no national secret here   
We welcome spies and SS here.  
Spies/SS are human, too :)  
6/25/11 
Why we are here again 
  Last	
  year,	
  Val	
  Smith,	
  Colin	
  Ames	
  and	
  I	
  (Anthony)	
  have	
worked	
  together	
  on	
  analyzing	
  China-­‐made	
  malware,	
making	
  ﬁrst	
  east-­‐meets-­‐west	
  research	
  and	
  studies.	
  We	
conCnue	
  this	
  eﬀort.	
  This	
  year,	
  we	
  have	
  dealt	
  with	
  many	
  targeted	
  aFack	
  cases,	
we	
  would	
  like	
  to	
  share	
  the	
  case	
  studies	
  with	
  you	
  and	
  the	
correlaCon	
  analysis	
  with	
  my	
  Taiwanese	
  research	
  fellows.	
  We	
  are	
  happy	
  about	
  this	
  presentaCon	
  is	
  accepted	
  in	
  ﬁrst-­‐
round	
  selecCon	
  of	
  DEFCON	
  19,	
  however,	
  it	
  is	
  rejected	
  in	
Blackhat	
  with	
  reviewer	
  comment:	
  “	
  We	
  are	
  curious	
  about	
your	
  automated	
  analysis.”	
  -­‐	
  Thank	
  you	
  for	
  their	
comment	
  ;-­‐)	
6/25/11 
Who we are? 
  Anthony	
  Lai	
  (a.k.a	
  Darkﬂoyd)	
  He	
  works	
  on	
  code	
  audit,	
  penetraCon	
  test,	
  crime	
invesCgaCon	
  and	
  threat	
  analysis	
  and	
  acted	
  as	
  security	
consultant	
  in	
  various	
  MNCs.	
  His	
  interest	
  falls	
  on	
studying	
  exploit,	
  reverse	
  engineering,	
  analyse	
  threat	
and	
  join	
  CTFs,	
  it	
  would	
  be	
  nice	
  to	
  keep	
  going	
  and	
boost	
  this	
  China-­‐made	
  security	
  wind	
  in	
  malware	
analysis	
  and	
  advanced	
  persistent	
  threat	
  areas.	
  He	
  found	
  security	
  research	
  group	
  called	
  VXRL	
  in	
  Hong	
Kong	
  and	
  has	
  been	
  working	
  as	
  visiCng	
  lecturer	
  in	
  HK	
Polytechnic	
  University	
  on	
  hacking	
  course	
  :)	
  Spoken	
  at	
  Blackhat	
  USA	
  2010,	
  DEFCON	
  18	
  and	
  Hack	
  In	
Taiwan	
  2010/2011	
6/25/11 
  Benson Wu 
  He currently works as Postdoctoral Researcher from 
Research Center for Information Technology 
Innovation at Academia Sinica in Taiwan. 
  He focuses research on malware and threat 
analysis, code review, secure coding and SDLC 
process implementation. He graduated from 
National Taiwan University with PhD degree in 
Electrical Engineering. He had spoken at NIST 
SATE 2009, DEFCON 18 (with Birdman), OWASP 
China 2010, and wrote the "Web Application 
Security Guideline" for the Taiwan government. 
6/25/11 
  Jeremy Chiu (a.k.a Birdman) 
  He has more than ten years of experience with host-
based security, focusing on kernel technologies for 
both the Win32 and Linux platforms. In early 2001 
he was created Taiwan's first widespread trojan 
BirdSPY. The court dropped charges after Jeremy 
committed to allocate part of his future time to assist 
Taiwan law enforcement in digital forensics and 
incidence response. 
  Jeremy specializes in rootkit/backdoor design. 
Jeremy also specializes in reverse engineering and 
malware analysis, and has been contracted by law 
enforcements to assist in forensics operations. 
Jeremy is a sought-after speaker for topics related 
to security, kernel programming, and object-oriented 
design   
6/25/11 
  PK 
  Peikan (aka PK) has intensive computer forensic, 
malware and exploit analysis and reverse 
engineering experience. He has been the speaker in 
Syscan and HIT (Hack In Taiwan) and convey 
various training and workshop for practitioners. 
6/25/11 
Agenda 
  APT	
  Vs	
  Malware	
  Case	
  Studies	
  Research	
  Methodology	
  Clustering	
  Analysis	
  and	
  Results	
6/25/2011 
Abstract 
•  APT (Advanced Persistent Threat) means 
any targeted attacks against any specific 
company/organization from an or/and a 
group of organized attack party(ies). 
•  Other than providing the case studies, we 
would like to present and analyze APT 
from the malicious email document, 
throughout our automated analysis, we 
could identify and cluster the correlation 
among the samples featured with various 
exploit, malware and Botnet . 
6/25/2011 
Major APT Activity: Targeted-Attack Email 
•  We have observed there are three major types 
of Targeted-Attack Email： 
1. Phishing mail: Steal user ID and password 
2. Malicious script: Detect end-use computing 
environment 
3. Install and deploy Malware (Botnet) ! 
APT Mail = Document Exploit + Malware 
6/25/2011 
APT Attack Vs Traditional Botnet Activities 
APT Botnet Activities 
Traditional Botnet Activities 
With organized planning 
Mass distribution over regions 
Cause damage? 
No 
No 
Targeted or not? 
Targeted (only a few groups/organizations) 
Not targeted (large area spreadout) 
Target Audience 
Particular organization/company 
Individual credentials including online 
banking account information 
Attack Effective 
Duration 
Long duration 
Relative Short 
Frequency of attacks 
Many times 
Once or twice 
Weapon 
• 
0-day Exploit 
• 
Drop Embedded Malware 
• 
Use existent multiple exploits 
• 
URL Download Malware 
AV Detection Rate Detection rate is lower than 10% if the 
sample comes out within one month 
Detection rate is around 95% if the 
sample comes out within one month 
Remarks: IPS, IDS and Firewall cannot help and detect in this area  
Distribution 
6/25/11 
Part 1: 
Case Studies: 
Against a Political Party in Hong Kong 
6/25/11 
Case 1: Calling from Mr. X 
•  Mr. X is a one of the key persons of political 
party in Hong Kong.	
•  He dropped us an email as he feels suspicious 
on an attachment called meeting.zip and it 
contains two files, agenda.doc and minutes.doc	
•  It looks like a member meeting agenda.	
•  The email targets all committee members in his 
organization. 
•  Mr. X said he always got this kind of mails 
before 4 June, 1 July and election. 
6/25/11 
Analysis 
•  Running analysis in our Xecure analyzer engine	
•  Basically, it is not a fake.doc but a PE file and 
minutes.doc is a document shortcut .lnk file 
which triggers to execute agenda.doc 
Xecure Analyzer Engine 
6/25/11 
Analysis - CnC location 
•  Connect to remote IP address in Hong Kong at 
8080 port. 
•  It is still alive  
6/25/11 
Analysis – CaptureBAT 
Recorded in chronological order	
C:\Documents and Settings\Administrator\Local Settings\Application 
Data\ws2help.PNF was added by “Agenda.doc”	
C:\Documents and Settings\Administrator\Local Settings\Application 
Data\msvcr.dll was added by “Agenda.doc”	
C:\WINDOWS\system32\netstat.exe was [written/accessed] by 
“Agenda.doc”	
C:\WINDOWS\inf\1.txt was deleted by “Agenda.doc”	
C:\WINDOWS\system32\netstat.exe was modified by “Agenda.doc”	
6/25/11 
C:\Documents and Settings\Administrator\Local Settings\Application 
Data\IECheck.exe was added by “Agenda.doc”	
C:\WINDOWS\system32\ipsecstap.dat was added by “explorer.exe”	
C:\Documents and Settings\Administrator\Start Menu\Programs
\Startup\Internet Explorer Security Check.lnk was added by 
“explorer.exe” 
6/25/11 
Analysis - Regshot 
Files added	
C:\Documents and Settings\Administrator\Local Settings
\Application Data\IECheck.exe	
C:\Documents and Settings\Administrator\Local Settings
\Application Data\msvcr.dll	
C:\Documents and Settings\Administrator\Local Settings
\Application Data\ws2help.PNF	
C:\Documents and Settings\Administrator\My Documents
\My Pictures\PI:EMAIL	
C:\Documents and Settings\Administrator\Start Menu
\Programs\Startup\Internet Explorer Security Check.lnk	
C:\WINDOWS\system32\2525	
C:\WINDOWS\system32\ipsecstap.dat	
Files deleted	
C:\Documents and Settings\Administrator\Desktop
\Democracy Depot meeting\Sample\Agenda.doc 
Analysis - Target popular IM and emails 
Analysis - Injection to explorer.exe 
6/25/11 
Infection Path 
•  Agenda.doc (Dropper)	
o  Create IECheck.exe	
o  Copy WS2Help.PNF to application data folder.	
o  Change netstat.exe	
o  Inject code to msvcr.dll and then to explorer.exe	
o  Creat mutux (VistaDLL Running)	
o  Detect anti-virus program including Kapersky	
o  Target QQ, MSN, sina, foxmail and hotmail 
Analysis - Encoding Scheme 
•  XOR encoding only	
•  Encode and decode the traffic 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – Encoding Scheme 
6/25/11 
Analysis – What information has been 
sent to CnC server? 
•  After decoding the network traffic	
o  The host name	
o  Installed OS type and patch level	
•  There should  be more information sent to CnC server :) 
6/25/11 
Analysis – Found the .cab file 
•  We have found .bmp file in a compressed .cab 
file under application folder	
•  Screenshots are found. What the fxxk that our 
Wireshark screenshot is captured and sent back 
to CnC server :) 
6/25/11 
Digging into Tiger's Mouth  
•  We have tried to install QQ, MSN and see 
what's going on:	
o Binaries are downloaded to the victim in C:
\Windows\Debug folder	
o Malware creates more files in C:\Windows
\Debug\Data folder	
o Those files are removed shortly.	
o Collected information are saved as file with .dll 
as extension and send it back to CnC server 
6/25/11 
What's going on? 
•  We	
  have	
  found	
  that	
  CnC	
  server	
  sent	
  an	
  instrucCon	
  to	
  the	
  vicCm	
machine	
  to	
  compress	
  ﬁles	
  and	
  send	
  them	
  back	
  to	
  the	
  CnC	
  server.	
•  There	
  is	
  a	
  traﬃc	
  sequence	
  number	
  set	
  by	
  the	
  CnC	
  server.	
  Once	
  the	
sequence	
  number	
  is	
  used	
  or	
  wrong,	
  the	
  machine	
  will	
  not	
  be	
infected	
  again	
  or	
  CnC	
  server	
  will	
  not	
  send	
  further	
  instrucCon..	
•  The	
  ﬁles	
  iestorage.dll,	
  SAM.dll	
  and	
  system.dll	
  are	
  actually	
  cab	
compressed.	
  Just	
  rename	
  the	
  extension	
  as	
  "cab"	
  and	
  decompress	
them	
  to	
  get	
  the	
  following	
  informaCon.	
o  The	
  SAM	
  and	
  system	
  kept	
  the	
  vicCm	
  machines	
  account	
informaCon	
  and	
  registry	
  informaCon.	
•  The	
  iestorage	
  contains	
  a	
  ﬁle	
  called	
  "自动表单.txt987654321"	
  which	
keeps	
  the	
  hacked	
  email	
  accounts	
  and	
  passwords.	
•  Another	
  ﬁle,	
  called	
  drive,	
  it	
  keeps	
  all	
  ﬁlenames	
  and	
  Cme	
informaCon	
  on	
  the	
  hard	
  disk	
o  The	
  APT	
  task	
  force	
  really	
  wants	
  to	
  know	
  what	
  informaCon	
  that	
the	
  target	
  kept	
  in	
  the	
  vicCm	
  machine.	
6/25/11 
•  Carrying out the dynamic analysis 
o  The	
  injected	
  explorer.exe	
  downloads	
  fvcwin32.exe,	
acvcwin32.exe	
  and	
  avcwin32.exe	
  and	
  kick	
  started	
  these	
programs.	
o  fvcwin32.exe	
  is	
  responsible	
  to	
  collect	
  all	
  hard	
  disk	
  ﬁle	
informaCon	
  and	
  create	
  the	
  ﬁle	
  "drive"	
  under	
  C:\windows
\debug	
o  avcwin32.exe	
  is	
  responsible	
  to	
  collect	
  email	
  accounts	
  and	
passwords,	
  SAM,	
  system	
  info,	
  keeping	
  them	
  under	
  a	
  %AppData
%\temp.	
  They	
  are	
  removed	
  immediately	
  amer	
  amer	
  compressed	
and	
  saved	
  under	
  C:\windows\debug\data\.	
  In	
  addiCon,	
  it	
  keeps	
capturing	
  screen	
  for	
  every	
  1000	
  ms	
  and	
  saves	
  the	
  image	
  under	
C:\windows\debug\data	
  folder	
o  acvwin32.exe	
  is	
  to	
  capture	
  screenshots	
  for	
  every	
  1000ms	
o  The	
  injected	
  "msrvc.dll"	
  keep	
  on	
  monitoring	
  the	
  c:\windows
\debug\data	
  folder	
  and	
  send	
  out	
  any	
  new	
  ﬁles	
  under	
  the	
folder	
  to	
  CnC	
  server,	
  immediately	
  deleCng	
  sent	
  ﬁles.	
6/25/11 
Case Summary (1) 
•  Target political party in Hong Kong 
•  CnC server is in Hong Kong.	
•  The origin is from our mother country, China.	
•  This “China-made” APT is NAPT (Non-
Advanced Persistent Threat) as we found 
some old routines for Win95/98. The 
“programmer” adds new features to it indeed 