主数据中心
Squid
LVS
---
## Page 188
加速应用服务器的数据读操作速度，减轻存储和数据库服务器的负载。Wikipedia的缓存
服务通常是一些有状态的服务，即需要提供数据存储服务，这些服务大多建立在网络通
样的服务器），从硬件上改善性能。
杂笨重，需要消耗较多的资源，Wikipedia 将最好的服务器部署在这里（和数据库配置一
使用策略如下：
信和磁盘操作基础上，是性能的瓶颈，也是性能优化的重灾区。
10.2.3
后端优化最主要的手段是使用缓存，将热点数据缓存在分布式缓存系统的内存中，
包括缓存、存储、数据库等被应用服务器依赖的服务都可以归类为后端服务。后端
除了硬件改善，Wikipedia还使用许多其他开源组件对应用层进行如下优化。
使用Tex进行文本格式化，特别是将科学公式内容转换成图片格式。
·使用Imagemagick 进行图片处理和转化。
·使用较大的服务器内存。在Wikipedia应用场景中，增加内存比增加其他资源更能
作为存储核心资产的MySQL数据库，Wikipedia也做了如下优化：
·相比数据库，Memcached的持久化连接非常廉价，如有需要就创建一个Memcached
·缓存数据的内容尽量是应用服务器可以直接使用的格式，
●热点特别集中的数据直接缓存到应用服务器的本地内存中，因为要占用应用服务
·使用RAIDO磁盘阵列以加速磁盘访问，RAIDO虽然加速磁盘访问，但是却降低了
●替换PHP的字符串查找函数 strtrO，使用更优化的算法重构。
·使用APC，这是一个PHP字节码缓存模块，可以加速代码执行减少资源消耗。
·使用缓存服务器存储 session对象。
改善MySQL 性能。
少应用服务器从缓存中获取数据后解析构造数据的代价。
器的内存且每台服务器都需要重复缓存这些数据，因此这些数据量很小，但是读
取频率极高。
连接。
Wikipedia后端性能优化
10维基百科的高性能架构设计分析-
，比如HTML格式，以减
167
---
## Page 189
168
大型网站技术架构核心原理与案例分析
·如果Master数据库宕机，立即将应用切换到Salve数据库，同时关闭数据写服务
·将数据库事务一致性设置在较低水平，加快宕机恢复速度。
这意味着关闭词条编辑功能。Wikipedia 通过约束业务获得更大的技术方案选择余
从复制，数据异步备份等）。
数据库的持久可靠性（一块盘坏了，整个数据库的数据都不完整了）。显然Wikipedia
地，很多时候业务后退一小步，技术就可以前进一大步。
认为性能问题迫在眉睫，而数据可靠性问题可以通过其他手段解决（如MySQL主
---
## Page 190
存储，服务可用。
及更友好的图形用户管理界面。
（Doris0.1vs.HBase0.90），Doris具有相似的性能和线性伸缩能力，并具有更好的可用性
目标是支持中等规模高可用、可伸缩的KV存储集群。跟主流的NoSQL系统HBase 相比
那么高可用的架构设计也就是在各种软硬件故障的情况下，系统如何保障数据可靠
Doris（https://github.com/itisaid/Doris）是一个海量分布式KV存储系统，其设计
对于一个数据存储系统而言，高可用意味着两个意思：
●高可用的服务：任何时候，包括宕机、硬盘损坏、系统升级、停机维护、集群扩
高可靠的数据：任何情况下，数据可靠存储，不丢失。
容等各种情况，都可以对系统进行读写访问操作。
海量分布式存储系统Doris
的高可用架构设计分析
---
## Page 191
170
物理存储的副本数目，副本份数越多，可用性级别越高，当然需要的服务器也越多。为
统的架构如图11.1所示。
可以进行灵活的失效转移（Failover），保证系统整体依然可用，数据持久可靠。Doris系
的主要手段是余：服务器热备，数据多份存储。使整个集群在部分机器故障的情况下
为这些故障发生时，保证系统依然可用而进行系统设计。在系统架构层面，保证高可用
11.1
大型网站技术架构核心原理与案例分析
对一个大规模集群的存储系统而言，服务器宕机、
其中数据存储服务器又根据应用的可用性级别设置数据复制份数，即每个数据实际
●管理中心服务器：这是一个由两台机器组成的主-主热备的小规模服务器集群，主
●数据存储服务器：
●应用程序服务器：它们是存储系统的客户，
系统整体上可分为如下三个部分。
据操作请求。
对应用程序服务器提供集群地址配置信息服务等。
要负责集群管理，对数据存储集群进行健康心跳检测；集群扩容、故障恢复管理；
分布式存储系统的高可用架构
999
他们是存储系统的核心，
席列！
存储服务器集群
应用服务器集群
图11.1Doris的整体架构
数据访问
99.
序列2
健康心器检理
联取容储惠
，负责存储数据、响应应用服务器的数
，对系统发起数据操作请求。
、交换机失效是常态，
苗
服务器
，架构师必须
---
## Page 192
故障类型带来的问题复杂性不同，不可能使用一种解决方案处理所有情况，所以需要针
中计算得到一台服务器，然后同时并发写入这些服务器中；应用服务器读取数据时，只
对各种故障提供具体解决方案。
少，就越少依赖，发生故障时互相影响就越少，集群的可用性就越高。
障、扩容），否则应用服务器不会和管理中心服务器通信。一般而言，服务器之间通信越
器也只在启动时从管理中心服务器获取存储服务器集群信息，除非集群信息发生变化（故
常情况下，系统最少写入的副本份数是两份，如图11.2所示。
需要随机选择一个序列，
储在不同的序列中（序列可以理解为存储集群中的子集群）。
了便于管理和访问数据的多个副本，将存储服务器划分为多个序列，数据的多个副本存
11.2
应用服务器
应用服务器写入数据时，根据集群配置和应用可用性级别使用路由算法在每个序列
高可用的系统需要解决的是在不同故障情况下都保持较高的系统可用性，但是不同
在正常状态下，存储服务器集群中的服务器互不感知，不进行任何通信；应用服务
不同故障情况下的高可用解决方案
3：路由计算存储服务器0
2:获取应用可用级别0
1：获取集群信息0
管理中心服务器
根据相同路由算法计算得到服务器编号和地址，即可读取。通
写入数据（
图11.2Doris系统调用时序模型
11海量分布式存储系统Doris的高可用架构设计分析T
5：写入数据（
171
---
## Page 193
11.2.1分布式存储系统的故障分类
172
服务器；而读数据时，只需要到这两台服务器上任意一台服务器读取即可。
11.2.2正常情况下系统访问结构
一个分布式存储系统而言，影响系统整体可用性的故障可以分成以下三类。
大型网站技术架构核心原理与案例分析
在讨论解决方案之前，我们先对故障进行分类，针对不同故障情况分别对待。对于
应用程序在写数据时，需要路由计算获得两台不同的服务器，同时将数据写入两台
在只使用两份副本作为高可用策略的情况下，系统访问结构如图11.3所示。
●临时故障：引起这类故障的主要原因是交换机宕机、网卡松动等导致的网络通信
●瞬时故障：引起这类故障的主要原因是网络通信瞬时中断、服务器内存垃圾回收
?
永久故障：引起这类故障的主要原因只有一个：硬盘损坏，
时间可分为两个阶段：临时故障期间，临时故障恢复期间。
热等硬件原因导致的服务器宕机；这类故障的主要特点是需要人工干预（更换硬
或后台线程繁忙停止数据访问操作响应。其特点是故障时间短，在秒级甚至毫秒
也需要更长的时间。故障时间可分为两个阶段：永久故障期间和永久故障恢复期间。
远找不回来了，因此其处理策略也和前面两种故障完全不同，恢复系统到正常状态
硬盘和损坏内存一样，可以通过更换硬盘来重新启动机器，但是丢失的数据却永
件、重启机器等）才能恢复正常。通常持续时间需要几十分钟甚至几小时。故障
中断；系统升级、停机维护等一般运维活动引起的服务关闭；内存损坏、CPU过
级系统即可自行恢复正常响应。
应用程序服务器A
存健服务器
写数据
图11.3正常情况下Doris访问模型
写数据
随机选择一台服务器读数据
应用程序服务器日
数据丢失。虽然损坏
---
## Page 194
等，这时需要请求管理中心服务器进行故障仲裁，以判定故障种类。
到瞬时故障只需要多次重试，就可以重新连接到服务器，
这时需要执行临时故障处理策略。
11.2.3
瞬时故障是一种严重性较低的故障，一般系统经过较短暂的时间即可自行恢复，遇
当然也有可能是应用服务器自己的故障，比如系统文件句柄用光导致连接不能建立
瞬时失效访问模型如图11.5所示。
如果经多次重试后，仍然失败，
瞬时故障的高可用解决方案
访问重试
应用服务器
应用程序服务器
存储服务器
1访问失败
图11.4Doris瞬时故障解决方案
图11.5Doris 瞬时失效访问模型
2:重新请求（×次）直到成功（）
11海量分布式存储系统Doris的高可用架构设计分析下
通信超时，不可识别异常
1：请求服务（)
，那么有可能不是瞬时故障，而是更严重的临时故障，
3存储服务器失效仲裁一
，正常访问。如图11.4所示。
存储服务器
管理中心服务器
173
---
## Page 195