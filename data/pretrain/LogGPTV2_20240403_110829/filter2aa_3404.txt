Vmware CB Workload
360 政企安全
Skay-2021.9.14
2
Vmware CB workload 
3
查看分别监听了哪些端口
端口的启动文件
全局搜索jar class
确定工作目录
Vmware CB worktaion 
4
Vmware CB workload 拿到手后是一个ova文件，直接导入vmware
改ssh配置文件root登录，/opt/vmware 为工作目录，配置及启动文件也在这里
调试：三个springboot jar包 分别配置远程调试
Vmware CB workload 
5
工作目录打包扒下来，对jar包配置远程调试   tar czvf test.tar.gz *     
Vmware CB workload 
6
工作因为jar包是fatjar，所以还需要对jar包进行更改再 add as library
Vmware CB workload 
7
Run.sh 启动脚本添加启动参数即可
Vmware CB workload 
8
最终idea项目配置如下
VMware CB Workload 
漏洞挖掘及复现
9
Vmware CB workload 
10
最终首先整体了解下虚拟机默认安装后开启了哪些端口及服务
Envoy
11
Envoy 是专为大型现代 SOA（面向服务架构）架构设计的 L7 代理和通信总线
去看它的配置文件
Envoy
12
Vmware CB workload 
13
最终再结合查看java进程
Vmware CB workload 
14
我们对这个组件的大体架构有了一个了解，接下来回到漏洞本身，我们能拿到的就只有一个官方通告
https://www.vmware.com/security/advisories/VMSA-2021-0005.html，是一个身份绕过
Vmware CB workload 
15
我们回到拖出来的代码本身，是Spring boot 且用了Spring Security + jwt 做身份校验
三个项目分别有三个SecurityConfiguration
Vmware CB workload 
16
跟了一遍身份校验流程后没什么大思路，不如直接diff以下
官方通告里给出了1.0.2 为修复版本，下载1.0.2 并安装，将工作目录dump下来进行diff
Vmware CB workload 
17
跟了一遍身份校验流程后没什么大思路，不如直接diff以下
官方通告里给出了1.0.2 为修复版本，下载1.0.2 并安装，将工作目录dump下来进行diff
Vmware CB workload 
18
Diff一圈儿  最终定位到这里
Vmware CB workload 
19
URL有了 怎么去定位请求处理类？ 关键字搜(需要反编译 反编译后还有一个好处可以find usage)  
或者因为是Spring的项目，所以可以在调试时获取所有请求url的处理类
Vmware CB workload 
20
最终找到com.vmware.cwp.appliance.acs.api.controller.TokenGeneratorApi
Vmware CB workload 
21
最终找到com.vmware.cwp.appliance.acs.api.controller.TokenGeneratorApi
curl http://localhost:3010/acs/api/v1/service-token/apw  本机访问成功获取token
Vmware CB workload 
22
回去看com.vmware.cwp.appliance.acs.security.config.SecurityConfigurationi，也确实配置了白名单放行
Vmware CB workload 
23
先别高兴的太早，这个api无法在外网直接访问 先去跟调用栈，意外找了了一个不能30X的ssrf
Vmware CB workload 
24
当URL存在临时(302)或永久(301)跳转时，则继续请求跳转后的URL
那么我们可以通过HTTP(S)的链接302跳转到任意我们想要访问的地址上
Vmware CB workload 
25
com.vmware.cwp.appliance.acs.delegate.impl.VCReqValidatorController#validate
进入这个逻辑即可
SSRF 30X
26
当URL存在临时(302)或永久(301)跳转时，则继续请求跳转后的URL
那么我们可以通过HTTP(S)的链接302跳转到任意我们想要访问的地址上
配置301跳转 
27
Vmware CB workload 
28
没反应,不能用SSRF 串起来打了
Vmware CB workload 
29
Vmware CB workload 
30
应该是Envoy做了什么东西，但是看着配置文件也没什么，去抓一下envoy 与本机服务的通信
Vmware CB workload 
31
应该是Envoy做了什么东西，但是看着配置文件也没什么，去抓一下envoy 与本机服务的通信
Vmware CB workload 
32
应该是Envoy做了什么东西，但是看着配置文件也没什么，去抓一下envoy 与本机服务的通信
Vmware CB workload 
33
com.vmware.cwp.appliance.applianceworker.configuration.SecurityConfiguration
Vmware CB workload 
34
com.vmware.cwp.appliance.applianceworker.api.EnvoyXDSController
Vmware CB workload 
35
最后总结下架构
Vmware CB workload 
36
最终url编码以下就可以了23333
THANKS