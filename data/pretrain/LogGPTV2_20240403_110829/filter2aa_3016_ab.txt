hospitals, and government buildings all over the world
 The group that broke Mifare Classic is from 
Radboud University Nijmegen in the Netherlands
 The security of Mifare Classic is terrible â€”
kindergarten cryptography
2017/12/07 
HITCON PACIFIC
31
Source: Schneier on Security
https://www.schneier.com/blog/archives/2008/08/hacking_mifare.html
EasyCard / Mifare  NXP
 NXP called disclosure of the attack â€œirresponsibleâ€, 
warned that it will cause â€œimmense damagesâ€
 The Dutch court would have none of it: â€œDamage 
to NXP is not the result of the publication of the 
article but of the production and sale of a chip that 
appears to have shortcomingsâ€
 NXP Semiconductors lost the court battle to 
prevent the researchers from publishing
2017/12/07 
HITCON PACIFIC
32
Source: Schneier on Security
https://www.schneier.com/blog/archives/2008/08/hacking_mifare.html
EasyCard / Mifare  NXP
2017/12/07 
HITCON PACIFIC
33
https://www.ithome.com.tw/node/63075
EasyCard / Mifare  NXP
2017/12/07 
HITCON PACIFIC
34
http://news.ltn.com.tw/news/society/paper/658204
Crypto Flaws on Chips
 EasyCard (æ‚ æ¸¸å¡) / Mifare Classic, NXP, 2008
 Citizen Certificate (è‡ªç„¶äººå‡­è¯), Renesas, 2013
â€“ â€œCoppersmith in The Wildâ€
 Devices around the world, Infineon, 2017
â€“ â€œReturn of Coppersmithâ€™s Attack (ROCA)â€
â€“ CVE-2017-15361
2017/12/07 
HITCON PACIFIC
35
Citizen Certificate  Renesas
 The Renesas HD65145C1 chip is a "High-Security 
16-bit Smart Card Microcontroller" used in many 
high-security applications, including banking
 This chip received a certificate, that certifies the chip 
was conformant with Protection Profile BSI-PP-0002-
2001 at Common Criteria assurance level EAL4+
 HD65145C1 was used in the Chunghwa Telecom 
HICOS PKI Smart Card, which received FIPS 140-2 
Validation Certificate at Level 2 from NIST, USA
2017/12/07 
HITCON PACIFIC
36
Source: Coppersmith in the wild
https://smartfacts.cr.yp.to/index.html
 103 Citizen Certificate using Renesas HD65145C1 chip 
were broken by computing GCD of RSA public moduli
â€“ Some RSA moduli  N1 = p  q and  N2 = p  r
â€“ GCD(N1, N2) = p, thus both N1 and N2 are factored
 Most frequent primes found
â€“
0xc00000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000002f9
â€“
0xc92424922492924992494924492424922492924992494924492424922492924
992494924492424922492924992494924492424922492924992494924492424e5
â€“
0xf6dbdb6ddb6d6db66db6b6dbb6dbdb6ddb6d6db66db6b6dbb6dbdb6ddb6d6db
66db6b6dbb6dbdb6ddb6d6db66db6b6dbb6dbdb6ddb6d6db66db6b6dbb6dbdbc1
2017/12/07 
HITCON PACIFIC
37
Citizen Certificate  Renesas
Source: Coppersmith in the wild
https://smartfacts.cr.yp.to/index.html
2017/12/07 
HITCON PACIFIC
38
https://smartfacts.cr.yp.to/smartfacts-20130916.pdf
2017/12/07 
HITCON PACIFIC
39
Citizen Certificate  Renesas
2017/12/07 
HITCON PACIFIC
40
http://www.moi.gov.tw/info/news_content.aspx?sn=7771&page=0
2017/12/07 
HITCON PACIFIC
41
Lattice
ğ¿ =
ğ‘1ğ®ğŸ + ğ‘2ğ®ğŸ ğ‘1, ğ‘2 âˆˆ â„¤ }
=
ğ‘1ğ®ğŸ + ğ‘2ğ®ğŸ ğ‘1, ğ‘2 âˆˆ â„¤ } is a 2-dim lattice
ğ®ğŸ, ğ®ğŸ : good basis
ğ®ğŸ, ğ®ğŸ : bad basis
Image courtesy: 
https://en.wikipedia.org/wiki/Lattice_reduction
SVP (Shortest Vector 
Problem) is hard if the 
dimension is high 
 RSA modulus  N = p q
 If  p = ax + b where a, b are known, and 
x is small enough, then x can be found 
by Don Coppersmithâ€™s algorithm
 Generate a lattice by known information
(N, a, b), then solve SVP on the lattice
2017/12/07 
HITCON PACIFIC
42
Coppersmithâ€™s Attack
Crypto Flaws on Chips
 EasyCard (æ‚ æ¸¸å¡) / Mifare Classic, NXP, 2008
 Citizen Certificate (è‡ªç„¶äººå‡­è¯), Renesas, 2013
â€“ â€œCoppersmith in The Wildâ€
 Devices around the world, Infineon, 2017
â€“ â€œReturn of Coppersmithâ€™s Attack (ROCA)â€
â€“ CVE-2017-15361
2017/12/07 
HITCON PACIFIC
43
ROCA
 ROCA  Return of Coppersmithâ€™s Attack
 The vulnerability was discovered by Slovak 
and Czech security researchers from the 
Centre for Research on Cryptography and 
Security at Masaryk University, Czech 
Republic; Enigma Bridge Ltd, Cambridge, UK; 
and Ca' Foscari University of Venice, Italy
2017/12/07 
HITCON PACIFIC
44
Prime Generation
 Textbook prime generation for RSA-1024
â€“ Choose a 512-bit random odd integer
1 â€¦â€¦ â€¦â€¦ â€¦â€¦ 1 
â€“ Test divisibility for small primes: 3, 5, 7, 11, â€¦
â€“ Run the Miller-Rabin test enough times
â€¢ Reference Standard: FIPS 186-4
2017/12/07 
HITCON PACIFIC
45
510 random bits
Earlier Work
2017/12/07 
HITCON PACIFIC
46
https://www.usenix.org/node/197198
Earlier Work
2017/12/07 
HITCON PACIFIC
47
https://www.usenix.org/node/197198
Motivation
 Distribution of RSA keys modulo small primes 
2017/12/07 
HITCON PACIFIC
48
https://crocs.fi.muni.cz/_media/public/papers/ccs-nemec-handout.pdf
Black-Box Attack
 The researchers had access neither to the 
libraryâ€™s source code nor to the object code
â€“ Stored only in the secure on-chip memory and not extractable
 The whole analysis was performed solely using 
RSA keys generated and exported from the 
Infineonâ€™s cards and tokens
 Not based on any weakness in an RNG or any 
additional side-channel information
2017/12/07 
HITCON PACIFIC
49
https://crocs.fi.muni.cz/_media/public/papers/nemec_roca_ccs17_preprint.pdf
Infineonâ€™s Primes
 512-bit primes (RSA-1024) are generated by
â€¢ ğ¿ = 2 Ã— 3 Ã— 5 Ã— â‹¯ Ã— 349 Ã— 353 is fixed
â€“ 475 bits, the product of the first 71 primes
â€¢ ğ‘˜ is a 37-bit random integer
â€¢ ğ‘ is a 135-bit random integer
â€“ The order of the cyclic subgroup 65537 in 
the multiplicative group â„¤ğ‘€
âˆ— has 135 bits
â€¢ Entropy: 37 + 135 = 172 bits
2017/12/07 
HITCON PACIFIC
50
ğ‘ = ğ‘˜ Ã— ğ¿ + 65537ğ‘ mod ğ¿
Why the Formula?
 Infineonâ€™s prime generation is much faster than 
the textbook method
â€“ For small prime ğ‘ â‰¤ 353, ğ‘|ğ¿, ğ‘ âˆ¤ 65537 â‡’ ğ‘ âˆ¤ ğ‘
â€“ All trial divisions of ğ‘ by small primes can be skipped
â€“ Before any primality test, the probability that the 
candidate ğ‘ is a prime has been much larger already
2017/12/07 
HITCON PACIFIC
51
= ğ‘˜ğ¿ + 65537ğ‘ âˆ’ ğ‘¡ğ¿ for some ğ‘¡ âˆˆ â„¤
ğ‘ = ğ‘˜ Ã— ğ¿ + 65537ğ‘ mod ğ¿
Fingerprint
 RSA modulus ğ¿ is generated by Infineonâ€™s chip 
if and only if (almost) ğ‘ = log65537 ğ¿ mod ğ¿ exists!
2017/12/07 
HITCON PACIFIC
52
ğ¿ = ğ‘˜ Ã— ğ¿ + 65537ğ‘ mod ğ¿
Ã— ğ‘˜ Ã— ğ¿ + 65537ğ‘ mod ğ¿
= ğ‘˜ Ã— ğ‘˜ Ã— ğ¿ + ğ‘˜ Ã— 65537ğ‘ mod ğ¿ + ğ‘˜ Ã— 65537ğ‘ mod ğ¿
Ã— ğ¿
+ 65537ğ‘ mod ğ¿
65537ğ‘ mod ğ¿
â‰¡ 65537ğ‘+ğ‘ â‰¡ 65537ğ‘ (mod ğ¿)
ğ‘
ğ‘
Discrete Logarithm
 How hard is solving ğ¿ â‰¡ 65537ğ‘ (mod ğ¿)?
â€“ 135-bit group order, 65537 , is huge
â€“ However
â€¢
65537
divides â„¤ğ‘€
âˆ—
by Lagrange Theorem
â€¢ â„¤ğ‘€
âˆ—
= ğœ™ ğ¿ = Ï‚ğ‘¡|ğ‘€ ğ‘¡ âˆ’ 1 is a product of small 
primes, where ğœ™ is the Euler ğœ™ function
â€¢ Hence solving ğ¿ â‰¡ 65537ğ‘ (mod ğ¿) by Pohlig-
Hellman algorithm (divide and conquer) is pretty easy
2017/12/07 
HITCON PACIFIC
53
NaÃ¯ve Factoring
 Once ğ‘ is found, try all possible ğ‘ (hence 
respective ğ‘ is determined), and solve for ğ‘˜ by 
Coppersmithâ€™s algorithm, then ğ‘ is obtained
 However, it fails since there are too many 
possibilities (â‰ˆ 2135) for ğ‘
 Solution: Try smaller ğ¿â€²|ğ¿ and keep primes of 
the same form 
2017/12/07 
HITCON PACIFIC
54
ğ¿ = ğ‘ Ã— ğ‘ = ğ‘˜ Ã— ğ¿ + 65537ğ‘ mod ğ¿
Ã— ğ‘˜ Ã— ğ¿ + 65537ğ‘ mod ğ¿
â‰¡ 65537ğ‘+ğ‘ â‰¡ 65537ğ‘ (mod ğ¿)
Practical Factoring
 ğ¿â€² has 286 bits with ğ¿â€²|ğ¿
 The cyclic subgroup 65537 in â„¤ğ‘€â€²
âˆ—
has 31-bit 
order (possibilities of ğ‘â€²), which is small enough
 Find ğ‘â€², try all possible ğ‘â€² (so respective ğ‘â€² is 
determined), and solve for ğ‘˜â€² (226 bits) by 
Coppersmithâ€™s algorithm, then ğ‘ is obtained
2017/12/07 
HITCON PACIFIC
55
ğ¿ = ğ‘ Ã— ğ‘ = ğ‘˜â€² Ã— ğ¿â€² + 65537ğ‘â€² mod ğ¿â€²
Ã— ğ‘˜â€² Ã— ğ¿â€² + 65537ğ‘â€² mod ğ¿â€²
â‰¡ 65537ğ‘â€²+ğ‘â€² â‰¡ 65537ğ‘â€² (mod ğ¿â€²)
RSA 1024 & 2048
 97.1 CPU days to factor an RSA-1024 
modulus produced by Infineon chips
â€“ Parallelization is straightforward
â€“ Less than 1 day if parallelized with 100 cores
 140.8 CPU years to factor an RSA-2048 
modulus produced by Infineon chips
2017/12/07 
HITCON PACIFIC
56
Impacts
At least tens of millions devices around the world are affected
2017/12/07 
HITCON PACIFIC
57
https://crocs.fi.muni.cz/public/papers/rsa_ccs17
Morals
 Taking shortcut to enhance efficiency 
â€“ might compromise security
â€“ hence very dangerous
 Secret crypto design
â€“ delays the discovery of flaws
â€“ hence impacts are increased
2017/12/07 
HITCON PACIFIC
58
References
 KRACK
â€“ https://www.krackattacks.com
 ROCA
â€“ https://crocs.fi.muni.cz/public/papers/rsa_ccs17
2017/12/07 
HITCON PACIFIC
59
Thank You!
2017/12/07 
HITCON PACIFIC