hospitals, and government buildings all over the world
 The group that broke Mifare Classic is from 
Radboud University Nijmegen in the Netherlands
 The security of Mifare Classic is terrible —
kindergarten cryptography
2017/12/07 
HITCON PACIFIC
31
Source: Schneier on Security
https://www.schneier.com/blog/archives/2008/08/hacking_mifare.html
EasyCard / Mifare  NXP
 NXP called disclosure of the attack “irresponsible”, 
warned that it will cause “immense damages”
 The Dutch court would have none of it: “Damage 
to NXP is not the result of the publication of the 
article but of the production and sale of a chip that 
appears to have shortcomings”
 NXP Semiconductors lost the court battle to 
prevent the researchers from publishing
2017/12/07 
HITCON PACIFIC
32
Source: Schneier on Security
https://www.schneier.com/blog/archives/2008/08/hacking_mifare.html
EasyCard / Mifare  NXP
2017/12/07 
HITCON PACIFIC
33
https://www.ithome.com.tw/node/63075
EasyCard / Mifare  NXP
2017/12/07 
HITCON PACIFIC
34
http://news.ltn.com.tw/news/society/paper/658204
Crypto Flaws on Chips
 EasyCard (悠游卡) / Mifare Classic, NXP, 2008
 Citizen Certificate (自然人凭证), Renesas, 2013
– “Coppersmith in The Wild”
 Devices around the world, Infineon, 2017
– “Return of Coppersmith’s Attack (ROCA)”
– CVE-2017-15361
2017/12/07 
HITCON PACIFIC
35
Citizen Certificate  Renesas
 The Renesas HD65145C1 chip is a "High-Security 
16-bit Smart Card Microcontroller" used in many 
high-security applications, including banking
 This chip received a certificate, that certifies the chip 
was conformant with Protection Profile BSI-PP-0002-
2001 at Common Criteria assurance level EAL4+
 HD65145C1 was used in the Chunghwa Telecom 
HICOS PKI Smart Card, which received FIPS 140-2 
Validation Certificate at Level 2 from NIST, USA
2017/12/07 
HITCON PACIFIC
36
Source: Coppersmith in the wild
https://smartfacts.cr.yp.to/index.html
 103 Citizen Certificate using Renesas HD65145C1 chip 
were broken by computing GCD of RSA public moduli
– Some RSA moduli  N1 = p  q and  N2 = p  r
– GCD(N1, N2) = p, thus both N1 and N2 are factored
 Most frequent primes found
–
0xc00000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000002f9
–
0xc92424922492924992494924492424922492924992494924492424922492924
992494924492424922492924992494924492424922492924992494924492424e5
–
0xf6dbdb6ddb6d6db66db6b6dbb6dbdb6ddb6d6db66db6b6dbb6dbdb6ddb6d6db
66db6b6dbb6dbdb6ddb6d6db66db6b6dbb6dbdb6ddb6d6db66db6b6dbb6dbdbc1
2017/12/07 
HITCON PACIFIC
37
Citizen Certificate  Renesas
Source: Coppersmith in the wild
https://smartfacts.cr.yp.to/index.html
2017/12/07 
HITCON PACIFIC
38
https://smartfacts.cr.yp.to/smartfacts-20130916.pdf
2017/12/07 
HITCON PACIFIC
39
Citizen Certificate  Renesas
2017/12/07 
HITCON PACIFIC
40
http://www.moi.gov.tw/info/news_content.aspx?sn=7771&page=0
2017/12/07 
HITCON PACIFIC
41
Lattice
𝐿 =
𝑎1𝐮𝟏 + 𝑎2𝐮𝟏 𝑎1, 𝑎2 ∈ ℤ }
=
𝑎1𝐮𝟏 + 𝑎2𝐮𝟏 𝑎1, 𝑎2 ∈ ℤ } is a 2-dim lattice
𝐮𝟏, 𝐮𝟏 : good basis
𝐮𝟏, 𝐮𝟏 : bad basis
Image courtesy: 
https://en.wikipedia.org/wiki/Lattice_reduction
SVP (Shortest Vector 
Problem) is hard if the 
dimension is high 
 RSA modulus  N = p q
 If  p = ax + b where a, b are known, and 
x is small enough, then x can be found 
by Don Coppersmith’s algorithm
 Generate a lattice by known information
(N, a, b), then solve SVP on the lattice
2017/12/07 
HITCON PACIFIC
42
Coppersmith’s Attack
Crypto Flaws on Chips
 EasyCard (悠游卡) / Mifare Classic, NXP, 2008
 Citizen Certificate (自然人凭证), Renesas, 2013
– “Coppersmith in The Wild”
 Devices around the world, Infineon, 2017
– “Return of Coppersmith’s Attack (ROCA)”
– CVE-2017-15361
2017/12/07 
HITCON PACIFIC
43
ROCA
 ROCA  Return of Coppersmith’s Attack
 The vulnerability was discovered by Slovak 
and Czech security researchers from the 
Centre for Research on Cryptography and 
Security at Masaryk University, Czech 
Republic; Enigma Bridge Ltd, Cambridge, UK; 
and Ca' Foscari University of Venice, Italy
2017/12/07 
HITCON PACIFIC
44
Prime Generation
 Textbook prime generation for RSA-1024
– Choose a 512-bit random odd integer
1 …… …… …… 1 
– Test divisibility for small primes: 3, 5, 7, 11, …
– Run the Miller-Rabin test enough times
• Reference Standard: FIPS 186-4
2017/12/07 
HITCON PACIFIC
45
510 random bits
Earlier Work
2017/12/07 
HITCON PACIFIC
46
https://www.usenix.org/node/197198
Earlier Work
2017/12/07 
HITCON PACIFIC
47
https://www.usenix.org/node/197198
Motivation
 Distribution of RSA keys modulo small primes 
2017/12/07 
HITCON PACIFIC
48
https://crocs.fi.muni.cz/_media/public/papers/ccs-nemec-handout.pdf
Black-Box Attack
 The researchers had access neither to the 
library’s source code nor to the object code
– Stored only in the secure on-chip memory and not extractable
 The whole analysis was performed solely using 
RSA keys generated and exported from the 
Infineon’s cards and tokens
 Not based on any weakness in an RNG or any 
additional side-channel information
2017/12/07 
HITCON PACIFIC
49
https://crocs.fi.muni.cz/_media/public/papers/nemec_roca_ccs17_preprint.pdf
Infineon’s Primes
 512-bit primes (RSA-1024) are generated by
• 𝐿 = 2 × 3 × 5 × ⋯ × 349 × 353 is fixed
– 475 bits, the product of the first 71 primes
• 𝑘 is a 37-bit random integer
• 𝑎 is a 135-bit random integer
– The order of the cyclic subgroup 65537 in 
the multiplicative group ℤ𝑀
∗ has 135 bits
• Entropy: 37 + 135 = 172 bits
2017/12/07 
HITCON PACIFIC
50
𝑝 = 𝑘 × 𝐿 + 65537𝑎 mod 𝐿
Why the Formula?
 Infineon’s prime generation is much faster than 
the textbook method
– For small prime 𝑝 ≤ 353, 𝑝|𝐿, 𝑝 ∤ 65537 ⇒ 𝑝 ∤ 𝑝
– All trial divisions of 𝑝 by small primes can be skipped
– Before any primality test, the probability that the 
candidate 𝑝 is a prime has been much larger already
2017/12/07 
HITCON PACIFIC
51
= 𝑘𝐿 + 65537𝑎 − 𝑡𝐿 for some 𝑡 ∈ ℤ
𝑝 = 𝑘 × 𝐿 + 65537𝑎 mod 𝐿
Fingerprint
 RSA modulus 𝐿 is generated by Infineon’s chip 
if and only if (almost) 𝑎 = log65537 𝐿 mod 𝐿 exists!
2017/12/07 
HITCON PACIFIC
52
𝐿 = 𝑘 × 𝐿 + 65537𝑎 mod 𝐿
× 𝑘 × 𝐿 + 65537𝑎 mod 𝐿
= 𝑘 × 𝑘 × 𝐿 + 𝑘 × 65537𝑎 mod 𝐿 + 𝑘 × 65537𝑎 mod 𝐿
× 𝐿
+ 65537𝑎 mod 𝐿
65537𝑎 mod 𝐿
≡ 65537𝑎+𝑎 ≡ 65537𝑎 (mod 𝐿)
𝑝
𝑝
Discrete Logarithm
 How hard is solving 𝐿 ≡ 65537𝑎 (mod 𝐿)?
– 135-bit group order, 65537 , is huge
– However
•
65537
divides ℤ𝑀
∗
by Lagrange Theorem
• ℤ𝑀
∗
= 𝜙 𝐿 = ς𝑡|𝑀 𝑡 − 1 is a product of small 
primes, where 𝜙 is the Euler 𝜙 function
• Hence solving 𝐿 ≡ 65537𝑎 (mod 𝐿) by Pohlig-
Hellman algorithm (divide and conquer) is pretty easy
2017/12/07 
HITCON PACIFIC
53
Naïve Factoring
 Once 𝑎 is found, try all possible 𝑎 (hence 
respective 𝑎 is determined), and solve for 𝑘 by 
Coppersmith’s algorithm, then 𝑝 is obtained
 However, it fails since there are too many 
possibilities (≈ 2135) for 𝑎
 Solution: Try smaller 𝐿′|𝐿 and keep primes of 
the same form 
2017/12/07 
HITCON PACIFIC
54
𝐿 = 𝑝 × 𝑝 = 𝑘 × 𝐿 + 65537𝑎 mod 𝐿
× 𝑘 × 𝐿 + 65537𝑎 mod 𝐿
≡ 65537𝑎+𝑎 ≡ 65537𝑎 (mod 𝐿)
Practical Factoring
 𝐿′ has 286 bits with 𝐿′|𝐿
 The cyclic subgroup 65537 in ℤ𝑀′
∗
has 31-bit 
order (possibilities of 𝑎′), which is small enough
 Find 𝑎′, try all possible 𝑎′ (so respective 𝑎′ is 
determined), and solve for 𝑘′ (226 bits) by 
Coppersmith’s algorithm, then 𝑝 is obtained
2017/12/07 
HITCON PACIFIC
55
𝐿 = 𝑝 × 𝑝 = 𝑘′ × 𝐿′ + 65537𝑎′ mod 𝐿′
× 𝑘′ × 𝐿′ + 65537𝑎′ mod 𝐿′
≡ 65537𝑎′+𝑎′ ≡ 65537𝑎′ (mod 𝐿′)
RSA 1024 & 2048
 97.1 CPU days to factor an RSA-1024 
modulus produced by Infineon chips
– Parallelization is straightforward
– Less than 1 day if parallelized with 100 cores
 140.8 CPU years to factor an RSA-2048 
modulus produced by Infineon chips
2017/12/07 
HITCON PACIFIC
56
Impacts
At least tens of millions devices around the world are affected
2017/12/07 
HITCON PACIFIC
57
https://crocs.fi.muni.cz/public/papers/rsa_ccs17
Morals
 Taking shortcut to enhance efficiency 
– might compromise security
– hence very dangerous
 Secret crypto design
– delays the discovery of flaws
– hence impacts are increased
2017/12/07 
HITCON PACIFIC
58
References
 KRACK
– https://www.krackattacks.com
 ROCA
– https://crocs.fi.muni.cz/public/papers/rsa_ccs17
2017/12/07 
HITCON PACIFIC
59
Thank You!
2017/12/07 
HITCON PACIFIC