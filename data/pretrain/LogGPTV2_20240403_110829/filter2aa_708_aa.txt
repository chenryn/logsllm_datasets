页眉 
忆一次渗透实战 
从打点到域控的全过程 
杭州安恒信息技术股份有限公司 
安服战略支援部-星火实验室-李兵 
2019 年 9 月 19 日 
目录 
1. 信息收集阶段 ................................................................................................................................................ 1 
2. 外部打点阶段 ............................................................................................................................................. 10 
3. 内网渗透阶段 ............................................................................................................................................. 15 
页眉 
杭州安恒信息技术股份有限公司 
第1页/共 24 页 
本次内容跟大家分享一次完整的从打点到域控的实战过程。其目的是通过总
结在渗透中的每个阶段，来和大家分享一些优秀的渗透工具、渗透技巧，以及我
个人一些浅薄的渗透经验。 
本文主要内容分为三个阶段： 
信息收集阶段 
外部打点阶段 
内网渗透阶段 
1. 信息收集阶段 
当我们准备渗透一个目标的时候，往往都是从信息收集阶段开始。信息收集
可以分为互联网端的信息收集和内网的信息收集。互联网端需要收集的最重要的
资产就是域名资产和 IP 资产。每个企业都会有自己的域名和 IP，这是黑客与测
试人员关注的重点，其次是企业相关的账户信息、服务信息、指纹信息等。 
让我们从域名（DNS）的信息收集说起，收集 DNS 的方法有很多种，可以通
过搜索引擎、历史数据、网站爬虫、SSL 证书、DNS 区域传送、暴力破解等方式。
如果单独去执行每一种方法，可能需要做不少的工作。下面我介绍一款优秀的开
源工具，它可以完成以上 80%以上的工作。 
页眉 
杭州安恒信息技术股份有限公司 
第2页/共 24 页 
Sublist3r 是一款基于 Python 实现的域名收集工具。它基本支持上面提到的大
部分方法，从搜索引擎、Virustotal、DNSdumpster、SSLCert 等站点查找子域名。
在进行域名爆破时，程序会使用到一个互联网 DNS 服务器列表，然后以轮训的
方式来进行枚举任务。这种方式可以避免因为大量 DNS 请求所导致的访问受限。 
Python sublist3r.py -d target.com -b -t 50 -o target.dns.txt 
当程序将扫描结果写入 target.dns.txt 文件之后，我们就有了这个目标的域名
资产。那么我们如何再获取目标的 IP 资产呢？ 
我的方法是使用 BASH 脚本将文件中的域名解析为 IP，然后再做去重和 C
段识别处理，随手找了个目标域名用于演示： 
页眉 
杭州安恒信息技术股份有限公司 
第3页/共 24 页 
for i in `cat target.dns.txt`;do host $i|grep -E -o "([0-9]{1,3}[\.]){3}[0-
9]{1,3}";done |sort|uniq|grep -E -o "([0-9]{1,3}[\.]){3}"|uniq -c|awk '{if ($1>=3) print 
$2"0/24"}' 
这样就获取到了目标的域名资产和 IP 资产。 
这里关于 IP 信息收集有一个小技巧，就是渗透一些大型目标时，在目标公
司有 AS（自治系统）的情况下可以通过 https://bgp.he.net/ 这个运营商来查询
目标公司的自治系统号和 CIDR 路由。自治系统分配情况也可以在 IANA 查询
到： 
页眉 
杭州安恒信息技术股份有限公司 
第4页/共 24 页 
https://www.iana.org/assignments/as-numbers/as-numbers.xhtml。 
有了 DNS、IP 段、C 段列表这些目标的基础轮廓以后，就可以对目标进行端
口和服务探测，以及 Web 资产识别了。端口服务探测我使用的是 Nmap，如果目
标网络范围超过一个 C 段，我通常会用 Masscan，Masscan 也可以将扫描结果存
储为 Nmap 格式。拿到 XML 扫描结果以后，再用 Webmap 来解析 XML 扫描结
果，Webmap 还有一个好处就是可以团队协作。它的扫描结果展示如下： 
页眉 
杭州安恒信息技术股份有限公司 
第5页/共 24 页 
可以为每个目标打上 Critical、Checked、Vulnerable 等标签，以及给目标添加
备注、生成拓扑和 PDF 报告。 
页眉 
杭州安恒信息技术股份有限公司 
第6页/共 24 页 
如果不需要团队协作，不想搭建服务器，还可以使用 nmap-bootstrap.xsl 模板
将 Nmap 扫描结果转换成更直观，支持搜索的 HTML 格式。关于 Nmap 的 Nse
玩法有很多，以后可以单独搞个技术分享。 
Nmap –iL ips.txt -sS -T4 -A -sC -oA scanme 
xsltproc -o scanme.html nmap-bootstrap.xsl scanme.xml 
页眉 
杭州安恒信息技术股份有限公司 
第7页/共 24 页 
有了端口、服务等信息以后，我开始用 Eyewitness 来了解目标的 Web 资产情
况，这是个基于 Python，Headless（无头游览器）驱动实现的快照工具。它除了
能将目标 Web 资产迅速快照，还可以识别一些中间件的默认页（例如：Tomcat、
Jboss 等等），网站登陆接口，记录 HTTP 响应头，以及页面源码。类似的工具还
有 GoWitness，以及 Nmap 的 http-screenshot-html.nse 脚本。下面是这个工具的使
用方法及演示： 
python EyeWitness.py –f target.com-dns.txt --web --active-scan --add-http-ports 
80,81,88,888,2082,2083,3122,4848,6588,7000,7001,7002,7003,8000,8080,8081,8089
,8090,8500,8888,9000,9001,9200,9080,10000,10051,50000 
--add-https-ports 
443,8443,9043 
随便找个公司测试一下扫描结果： 
页眉 
杭州安恒信息技术股份有限公司 
第8页/共 24 页 
页眉 
杭州安恒信息技术股份有限公司 
第9页/共 24 页 
前面看到的是用 Eyewitness 解析 DNS.txt，我们也可以直接解析 Nmap 的扫
描结果： 
nmap 
-T4 
-iL 
ip.txt 
-oX 
scan.xml 
-p 
80,81,88,443,888,2082,2083,3122,4848,6588,7000,7001,7002,7003,8000,8080,8081,
8089,8090,8443,8500,8888,9000,9001,9200,9043,9080,10000,10051,50000 -Pn --
open -n 
python EyeWitness.py -x scan.xml  --web --no-dns --active-scan  
页眉 
杭州安恒信息技术股份有限公司 
第10页/共 24 页 
在测试漏洞之前，我还用 Git-all-secret 和 SimplyEmail 开源工具收集到一些
信息： 
从 Github 上获取到 1 个账号和密码，以及一些内网域名信息。 
使用 SimplyEmail 从搜索引擎和元数据中收集到部分目标的邮箱地址。 
在信息收集阶段完成以后，对目标情况就有了一定的了解。我拿到了目标的
IP 信息、DNS 信息、Web 资产情况、一个账号密码和一些内网域名信息。因为
不是真正的 APT，项目仅有一周的时间，我没有做更详细的信息收集，直接是进
入到了打点阶段。 
2. 外部打点阶段 
如何利用好之前收集到的信息？我做的第一件事是直接访问公司邮件系统
OWA 登录页面，运气不错，成功使用 Github 上收集到的账号登录电子邮箱，在
邮箱中搜索敏感关键字并没有发现有价值的信息。那么如何最大化利用这个账号
呢？ 
页眉 
杭州安恒信息技术股份有限公司 
第11页/共 24 页 
在登录页面的 Body 中，可以查看到 OWA 的版本。 
15.0 对应的版本是 Exchange2013，使用 EWS Editor 导出公司其他人的邮
箱：
导出后的文件都是 XML 格式，使用正则表达式提取与此邮箱关联的邮件地
址： 
cat * | egrep -o '[0-Z_]{3,}@[0-Z]{2,}(\.[0-Z]{2,})+' >email.txt //我们会获得一
个目标公司的邮件列表 
页眉 
杭州安恒信息技术股份有限公司 
第12页/共 24 页 
有了邮件列表我们就可以继续对其他账号进行爆破了，运气好的话我们也许
会遇到运维人员，或者遇到一些具有 VPN 登陆权限的账号。爆破工具推荐使用
Exchange 的滥用工具 ruler、mailsniper.ps1。 
当时在获取到的几个邮箱账户中，并没有获得有价值的东西。接下来我又尝
试在目标公司的 VPN 客户端上尝试登陆收集到的账号，发现有一个账号密码是