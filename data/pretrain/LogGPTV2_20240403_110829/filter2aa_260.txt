(U) I hunt TR-069 admins 
Shahar Tal
T O P  S E C R E T / / S I / / R E L  T O  D C 2 2  
no ISPs were harmed during the 
making of this presentation 
corporate legal wouldn't let us 
• Shahar Tal (@jifa) 
• Father, husband, geek 
• 10 years with IDF 
obligatory whoami 
Agenda 
• Intro to TR-069 
• Why you should care 
• Landscape walkthrough 
• Top kek pwnage 
• Conclusion 
Residential Gateway Security 
• It sucks. 
• Pedro Joaquin (Routerpwn), Jacob Holcomb (“SO HOpelessly broken”), 
Zachary Cutlip (“rooting SOHO”), devtty0 (everything) 
TR-069 in 69 seconds 
CPE WAN Management Protocol  
(CWMP/TR-069) 
 • 2004: v1.0 
• 2013: v1.4 (amendment 5) 
TR-069 Provisioning Session 
SOAP RPC 
(XML over HTTP) 
Always* initiates session 
Dual authentication mechanism 
ACS  can  issue  “Connection  Request” 
TR-069 Example RPC (ACSCPE) 
  ... 
                InternetGatewayDevice.ManagementServer.URL 
                http://acs.supersecureisp.com/cwmp/ 
            ... 
TR-who? 
• Growing trend to adopt TR-069 
• Endorsed by Home Gateway Initiative, Digital Video Broadcasting, WiMax Forum 
• (2011) Estimated 147M TR-069 enabled devices online 
• 70% Gateways 
• According to zmap, 7547 is open on 1.12% of IPv4 
Good Guy ACS 
• Provision devices (“zero-touch configuration”) 
• Tech Support remote management 
• Monitor for faults, errors or malicious activity 
• Diagnostics and Performance 
• Replace/fix faulty configuration 
• Deploy upgraded firmware 
Trust Issues 
• Who do you trust to run code on your devices? 
• Silently? 
• Remotely? 
• With elevated permissions? 
• I *might* trust heavily protected updates from Apple / Microsoft 
/ Google with this, but what about my ISP? 
TR-069 Architecture 
Photo credit: https://www.etsy.com/shop/sharpwriter  
APT APT APT APT APT APT APT APT CYBER APT CYBER  
Scumbag ACS 
• What would an attacker do if he was in control of an ACS? 
• Get private data 
• SSID, hostnames & MAC addresses, usernames, VoIP 
• Get complete configuration incl. passwords (vendor-specific) 
• Set every parameter 
• DNS servers 
• Wi-Fi (add new hidden SSID, remove password) 
• PPP (replace WAN service with attacker controlled tunnel) 
• Download 
• Configuration, firmware, logs 
• Upload 
• Configuration, firmware 
Previous Work? 
• Luka Perkov (“ISP’s black box” @ 29c3, UKNOF24) 
• A brief survey of CWMP security (3SLabs) 
• http://blog.3slabs.com/2012/12/a-brief-survey-of-cwmp-security.html 
• That’s about it. 
• (Apologies if my google fu wasn’t strong enough to find you) 
Niche Market 
• Service Provider world 
• TR-069 community?  
TR-069 Community 
ADB, Affinegy, Agile ACS, Alvarion, Arris, AVSystem, Axiros, Calix, Cisco, Comtrend, Consona, Dimark, Draytek, Fine Point Technologies, 
Friendly Tech, GIP, Incognito Software, Intraway, Iskratel, iWedia, Jungo, Juniper Bridge, Mobigen, Motive, Netgem communications, 
Netmania, OneAccess, Pace, ProSyst, Ronankii Infotech, Sigma Systems, Tata Elxsi, Tilgin, Wi-tribe, Wind River, Works Systems 
I got TR-069 problems 
Insecure 
Configuration 
Insecure 
Implementation 
How do you find ACSs ITW? 
• Hack a single router. QED. 
• Scanning 
• zmap/masscan FTW 
• 7547 and friends 
• UPnP endpoints 
• Public datasets 
• Internet Census 2012 
• DNS Census 2013 
• lmgtfy 
• lmstfy 
ACS Authentication Drill Down 
• SSL 
• 2nd option: shared secret 
• Shared secret = HTTP auth (basic/digest) 
HTTP 
81% 
HTTPS 
19% 
is RECOMMENDED 
Stealing the Secret 
• Router interfaces try to protect ACS passwords. 
• But… allow you to change the ACS URL. 
• ACS can even enforce HTTP Basic auth 
• Base64 encoded “username:password” 
SSL Certificate Validation 
Field Test 
Recap 
• TR-069 is very powerful 
• ACS makes a very lucrative, accessible target 
• A LOT of implementations are just not serious enough 
OpenACS 
• Open source (Java) 
• Start auditing 
• 3 days later: RCE  
• Reflection + Native File Upload = CVE-2014-2840  
GenieACS 
• Open source (Node.js, Redis, MongoDB) 
• Start auditing 
• 2 days later: RCE 
• Non-Global regex - CVE-2014-4956 
• Running as root 
output = input.replace(/[\[\]\\\^\$\.\|\?\+\(\)]/, "\\$&") 
GET /devices?query=["./;require('util').log(‘lolwut');//*"] HTTP/1.1 
PWNAGE 
>be scanning ipv4 for GenieACS 
>detect instance in middle-eastern ISP 
>nbi exposed 
>picard_facepalm.png 
>OP delivers (vulnerability report) 
>ISP support center not thrilled with Israeli calling about “vulnerable 
infrastructure”  
>8/10 would report again 
Undisclosed Vendor 
• Massive global install base incl. major providers 
• Internal API auth bypass, 2xSQLi, DoS 
• CVE-2014-{4916,4917,4918,4957} 
• Can write arbitrary files to any location 
• Including C:\Inetpub    RCE 
• Tested vulnerable provider (with permission) 
What can I do? 
• Audit your TR-069 settings 
• Ensure SSL & proper cert validation 
• Unsatisfied? disable TR-069 
• (If you can) 
• Add home security layer 
• Another router with NAT/FW capabilities 
• Open source firmware alternatives 
• Ask your provider about their TR-069 configuration! 
Fixing the Problem 
• There is no easy fix. 
• Bad implementations are out there 
• TR-069 has to mature 
• Awareness is key 
• Security community 
• That’s you guys 
• ACS vendors 
• Write better software, put money in secure coding 
• Show your security stance (bug bounties?) 
• Service Providers  
• Protect your customers, it’s your responsibility 
Future Directions 
• TR-069 client pwnage 
• Stay tuned for CCC 
Thank you! 
Hit me up on @jifa or 
PI:EMAIL 
• @swiftonsecurity 
• https://www.iol.unh.edu/sites/default/files/knowledgebase/hnc
/TR-069_Crash_Course.pdf TR-069 Crash Course (University of 
New Hampshire Interoperability Laboratory) 
• https://community.rapid7.com/servlet/JiveServlet/download/21
50-1-16596/SecurityFlawsUPnP.pdf Whitepaper: Security Flaws in 
Universal Plug and Play: Unplug, Don’t Play. (Rapid7) 
• http://internetcensus2012.bitbucket.org/ Internet Census 2012 
(anonymous researcher) 
• http://www.team-
cymru.com/ReadingRoom/Whitepapers/SOHOPharming.html 
SOHO Pharming (Team Cymru)