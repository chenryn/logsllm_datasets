为了安全起见，不允许管理员使用 root 用户帐户登录 ESXI 主机，而是从 vCenter 
Server 创建指定管理员用户，并为这些用户分配管理员角色。不同的角色其权限也
不同，例如创建虚拟机管理员用户则给予虚拟机添加、创建、删除、重新分配虚拟
机等权限。
ITDR 之 vSphere
86
加固方法
自定义创建角色
登录 vCenter Server -> 点击右上角菜单栏 -> 系统管理 -> 角色 -> 新建一个角
色，这里创建一个虚拟机管理员，可以将虚拟机选项全都勾选。
使用系统角色
点击右上角菜单栏 -> 系统管理 -> 角色 -> 选择我们要使用的角色
5.vSphere 加固
87
5.1.3 ESXI 端口管理
默 认 的 情 况 的 下 ESXI 开 放 有 以 下 端 口，80，443，902(vCenter Server 
Agent)，5989( 适用于 CIM 的安全服务器 ) 等一些端口，如果要开启另外一些服务，
具体端口可参考官网 ESXI 所需的端口，但是如果端口开放过多，一些服务则可能会
受到被攻击的威胁。因此我们可以对 ESXI 的端口访问设置防火墙，并且对一些不必
要的服务进行关闭。对于一些 ESXI 的重要服务，设置只能由内网中一些管理员 IP
访问，并且减少端口在公网中暴露。
加固方法
通过 vCenter 设置防火墙，通过 vSphere Client-> 点击左上角的清单 -> 点击主
机 -> 点击配置 -> 往下拉找防火墙 -> 设置每个端口的作用 ip 范围。
通过 ESXI 登录 web 端 -> 网络 -> 防火墙规则
5.1.4 开启ESXI锁定模式
在现有的智能手机中，当手机丢失后可能会进入锁定模式，无法直接从手机端
解锁必须从绑定的官网的账号解锁。
为了提高 ESXI 主机的安全性，可以将其置于锁定模式。锁定模式分为两种，一
种是严格锁定，一种是正常锁定，严格锁定默认用户只能从 vCenter Server 登录，
ITDR 之 vSphere
88
正常锁定模式默认可以 vCenter Server 登录，也可以通过 DCUI 登录。还可以使用“例
外用户”列表，主机进入锁定模式时，例外用户不会丢失其特权。使用“例外用户”
列表可添加在主机处于锁定模式时需要直接访问主机的第三方解决方案和外部应用
程序帐户。
加固方法
通 过 vSphere Client 开 启 锁 定， 通 过 vSphere Client 开 启 锁 定 模 式 登 录
vSphere Client-> 点击左上角点击清单 -> 点击主机 -> 点击配置往下拉点击安全配
置文件，可以编辑锁定模式
通过 ESXI 开启锁定模式，登录 ESXI-> 主机 -> 管理 > 安全与用户 -> 锁定模式 ->
选择禁用的方式
5.1.5 虚拟主机启用UEFI安全引导
UEFI，全称 Unified Extensible Firmware Interface，即“统一的可扩展固件
接口”，是一种详细描述全新类型接口的标准，是适用于电脑的标准固件接口，旨
在代替 BIOS（基本输入 / 输出系统 )。安全引导是在 BIOS 中实施的一项服务器安
全功能，不需要使用专门的硬件。安全引导会确保在引导过程中启动的每个组件均
经过数字签名，并且对照 UEFI BIOS 中嵌入的一组受信任证书对签名进行验证。
5.vSphere 加固
89
加固方法
如果一个虚拟机操作系统支持 UEFI 安全引导，则在虚拟机进行加载的过程中会
验证驱动程序是否经过签名。如果某个组件缺少签名或签名无效，则引导过程将会
停止，可以防止攻击者加载一些不被信任的组件而遭受攻击。
启用条件:
◑ 有 EFI 固件
◑ 虚拟硬件版本 13 或更高版本。
◑ 支持 UEFI 安全引导的操作系统。
这里以 Windows 主机作为演示
ITDR 之 vSphere
90
5.1.6 ESXI启用TLS加密通信
ESXI 为了确保主机安全，并且保证通信主机之间的隐私和数据完整性，采用了
TLS 加密安全传输协议进行通信。在 ESXI 安装的时候会生成多个非对称密钥，用于
正常的通信加密。同时 vCenter Server 与 ESXI 主机结合使用时，vCenter Server
会自动生成 CSR，使用 VMware Certificate Authority (VMCA) 对其进行签名，并生
成证书。
将 ESXI 主机添加到 vCenter Server 时，vCenter Server 会在该 ESXI 主机上安
装该生成的证书。默认 TLS 证书是自签名证书，且 subjectAltName 字段与安装时
主机名匹配。可以安装不同的证书，以便使用不同的 subjectAltName 或在验证链
中包含特定的证书颁发机构（CA）等。
ESXI 启用或禁用 TLS 版本
5.vSphere 加固
91
5.1.7 ESXI配置PTP或NTP
NTP 是用来同步网络设备（如计算机，手机等）的时间协议，在 ESXI 中我们
可以配置 NTP 或 PTP 来同步我们的时间，如果未配置 NTP，当我们后面安装大量
的虚拟机服务器，如果这些服务器的时间各不相同，则会在交互时可能会产生一些
麻烦，包括在现实中大型企业 ESXI 项目，都会有一台时间服务器，这样保证当客户
端在操作的时候，后台相应的记录顺序不会乱。在配置 NTP 时我们可以选择一些公
网的 NTP 服务器来进行时间同步，例如腾讯或者阿里的 NTP 服务器。但是在内网
中我们可能无法连接到公网中的一些服务器，此时需要我们搭建一台 NTP 服务器来
进行同步时间。
ESXI配置NTP
具体配置方法如下:
在管理 -> 系统 -> 时间和日期 ->NTP 设置 -> 使用网络时间协议 然后设置 NTP
服务启动策略和 NTP 服务器，其中启动策略与 NTP 服务器有如下几种
◑ 策略 - 根据端口使用情况启动和停止：在主机的安全配置文件中启用或禁
用 NTP 客户端端口访问时启动或停止 NTP 服务。
◑ 与主机一起启动和停止：在打开和关闭主机电源时启动和停止 NTP 服务
◑ 手动启动和停止：手动开启
公网的NTP服务器常用的有如下几个：
✓ 阿里云授权服务器：ntp.aliyun.com
✓ 中国科学院国家授时中心：ntp.ntsc.ac.cn
✓ NTP 授时快速域名服务：cn.ntp.org.cn
✓ 腾讯云授时服务器：time1.cloud.tencent.com 
✓ 国内大学授时服务器：ntp.tuna.tsinghua.edu.cn
最后在服务启动 NTP 服务器
ITDR 之 vSphere
92
ESXI配置PTP
管理 -> 系统 -> 时间和日期 -> PTP 设置 -> 开启 enable -> 保存，最后在服务中
找到 ptpd 设置为启动
5.1.8 对ESXI网络流量进行分层管理
网络流量隔离对保护 ESXI 环境至关重要，不同的网络需要不同的访问权限和隔
离级别。在 ESXI 网络中有两种网络，物理网路和虚拟网络。物理网络是 ESXI 主机
与其他组件通讯的真实网络，虚拟网络是建立在物理网络之上，负责 ESXI 上虚拟主
机的之间的相互通讯。如果将每个虚拟机区域隔离在自己的网络段中，可以最大限
度降低区域间泄露数据的风险。分段可防止多种威胁，包括地址解析协议 (ARP) 欺骗。
通过 ARP 欺骗，攻击者操作 ARP 表格以重新映射 MAC 和 IP 地址，并得以访问进出
主机的网络流量。攻击者使用 ARP 欺骗生成中间人 (MITM) 攻击、执行拒绝服务 (DoS) 
攻击，劫持目标系统并以其他方式破坏虚拟网络。
分层隔离的安全建议
◑ vSphere 基础架构网络用于 vSphere vMotion、VMware vSphere Fault 
Tolerance、VMware vSAN 和存储等功能。隔离开这些特定功能使用的网络。通常
不必将这些网络中的流量路由到单个物理服务器机架外部。
5.vSphere 加固
93
◑ 管理网络将客户端流量，命令行界面（CLI）或 API 流量以及第三方软件流
量与其他流量隔离开来。通常，管理网络只能由系统、网络和安全管理员访问。要
保护对管理网络的访问，请使用堡垒主机或虚拟专用网络（VPN）。严格控制该网
络中的访问。
◑ 虚拟机流量可以通过一个或多个网络流动，可以通过在虚拟网络控制器设
置防火墙规则的虚拟防火墙解决方案增强虚拟机的隔离。这些设置通过虚拟机传输，
像在 vSphere 环境中将其从主机迁移到主机一样。
5.1.9 启用主机加密模式
ESXI 的主机加密模式是将 ESXI 上面的虚拟机以及虚拟磁盘都进行加密，当启
用主机可以接受密钥材料后，核心的转储文件都会进行加密，以防止一些重要的数
据未经授权而被访问造成泄漏。另外如果需要在 ESXI 上面添加加密的虚拟机，则首
先应该开启主机加密模式才能够添加。
开启主机加密模式
如果要开启主机加密模式则首先要在 vCenter 上创建一个密钥提供程序来存放
我们的加密密钥。
打开 vCenter，在配置处找到安全 -> 然后选择密钥提供程序
接着选择添加 -> 添加本机密钥提供程序 -> 设置名称 -> 确认添加密钥提供程序，
此时会显示我们并没有进行备份，添加密钥程序一定得设置备份，否则开启主机加
密模式会失败。点击备份然后设置密码将会下载我们的密钥文件。
在 vCenter 上启用 ESXI 的主机加密模式，选择 ESXI 主机 -> 配置 -> 安全配置
文件 -> 主机加密模式 -> 编辑 -> 开启主机加密
ITDR 之 vSphere
94
5.1.10 使用TPM2.0验证ESXI
TPM 是可信平台模块，英文全称 Trusted Platform Module，是一项安全密码
处理器的国际标准。TPM 就是利用经过安全验证的加密密钥为设备带来更强的安全
性，他也是很多安全应用的核心。目前 TPM 最新的版本为 2.0 版。ESXi 主机可以
使用 TPM 芯片，通过提供植根于硬件（而不是软件）的信任保证来增强主机安全性。
TPM 2.0 芯片可证明 ESXi 主机的身份。主机证明是在给定时间点对主机软件状
态进行身份验证和证明的过程。UEFI 安全引导可确保在引导时只加载签名软件，这
是成功证明的一项要求。TPM 2.0 芯片将记录并安全存储系统中引导的软件模块的
测量数据，vCenter Server 将远程验证这些测量数据。
加固方法
1. 首先建立远程 TPM 的可信赖度并在其上创建证明密钥 (Attestation Key，AK)
将 ESXi 主机添加到 vCenter Server、从中重新引导 ESXi 主机或重新连接到 
vCenter Server 时，vCenter Server 将从主机请求 AK。AK 创建过程的一部分还涉
及到 TPM 硬件本身的验证，以确保已知（且可信）的供应商生成该 TPM 硬件。
2. 从主机检索证明报告。
vCenter Server 请求主机发送证明报告，其中包含由 TPM 签名的平台配置寄存
器 (Platform Configuration Register，PCR) 证言，以及其他签名的主机二进制元
数据。通过检查与其认为可信的配置相对应的信息，vCenter Server 将在先前不可
信的主机上标识平台。
3. 验证主机的真实性
vCenter Server 会验证签名证言的真实性，推断软件版本并确定所述软件版本
的可信赖度。如果 vCenter Server 确定签名证言无效，则远程证明失败，该主机不
可信。
登录到 vCenter 中，点击左上角菜单栏 -> 全局清单列表 -> 数据中心 -> 点击监
控选项卡 -> 安全 即可以查看
5.vSphere 加固
95
5.2 vCenter Server 加固方案
5.2.1 开启双因素身份验证
双因素身份验证 (2FA) 是一种身份和访问管理安全方法，用户需要经过两种形
式的身份验证才能访问资源和数据。在 vCenter 中可以配置 2FA 来保障身份的安全，
即使攻击者通过钓鱼或者密码泄漏拿到我们的 Web 控制台账号密码，也无法通过身
份认证。
开启智能卡身份认证
vCenter 这里提供了一种是智能卡身份验证登录，登录 vSphere Client -> 菜单 ->
系统管理 ->Single Sign On-> 配置 -> 智能卡身份认证 -> 编辑 vCenter( 各个版本稍
有不同 )
5.2.2 加固 vCenter Server 系统
对于管理人员来说要实时关注 vCenter 操作系统自身的安全漏洞，要确保漏洞
能够及时发现，并能够及时打补丁，以积极应对来自终端层面的攻击威胁。
ITDR 之 vSphere
96
5.2.3 vCenter 配置SSO(Single Sign-On)
SSO 是一个身份验证代理程序和安全令牌交换基础架构。vCenter SSO 在用户
进行身份验证时发出令牌。用户可以使用该令牌向 vCenter Server 服务进行身份验
证。然后，该用户可以执行其权限范围内的操作。vCenter 也可以通过外部身份提
供程序联合或 vCenter Server 内置身份提供程序对用户进行身份检验。内置身份提
供程序支持本地帐户、Active Directory 或 OpenLDAP、集成 Windows 身份验证 
(IWA) 和其他身份验证机制（智能卡、RSA SecurID 和 Windows 会话身份验证）。
vCenter 在首次安装软件时，为 vCenter SSO 域的管理员（administrator@
vsphere.local）指定密码。并且将该域作为最初的标识源。同时也可以将其他标识
源添加进来，例如 Acttve Directory 或 LDAP 并设置为默认标识源。