# Firefox Pwn 0x00
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
## æ¦‚è¿°
å‰ä¸€é˜µåœ¨å­¦ä¹ æµè§ˆå™¨PWNï¼ŒèŠ±äº†å‡ å¤©æŠŠè¿™ç¯‡[æ–‡ç« ](https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation)å•ƒå®Œäº†ï¼Œå…¶ä¸­çš„å‡ ä¸ªexpä¹Ÿéƒ½è°ƒè¯•äº†ä¸‹ï¼Œå­¦åˆ°å¾ˆå¤šã€‚
åŸæ–‡ååˆ†è¯¦ç»†åœ°æè¿°äº†æŠŠ18å¹´çš„ctfé¢˜ [Blazefox](https://ctftime.org/task/6000)
ç§»æ¤åˆ°Windowså¹³å°åˆ©ç”¨çš„è¿‡ç¨‹ï¼Œæ€»å…±å†™äº†ä¸‰ä¸ªexpè„šæœ¬ï¼ˆbasic.js, kaizen.js,
ifrit.js)ï¼Œä»ä¸€å¼€å§‹ç¡¬ç¼–ç çš„ropé“¾åˆ°åé¢åŠ¨æ€è§£æåœ°å€å¹¶åˆ©ç”¨JITæºå¸¦rop gadgetï¼Œå¾ªåºæ¸è¿›ã€‚
è¿™ç¯‡æ–‡ç« æ¢³ç†äº†ä¸€ä¸‹spidermonkeyåŸºç¡€çŸ¥è¯†ï¼Œå¹¶è®²è®²basic.jsä¸­çš„åˆ©ç”¨æ–¹æ³•ã€‚
## ç¯å¢ƒæ­å»º
>  è¿™é‡Œæœ‰ç¼–è¯‘å¥½çš„ï¼Œæ‡’å¾—ç¼–è¯‘çš„åŒå­¦å¯ä»¥è‡ªå–ã€‚
###  clone
é¦–å…ˆè¦æŠŠgeckoä»£ç æ‹‰ä¸‹æ¥ï¼Œç”±äºæ˜¯æ•™ç¨‹æ˜¯å†™äº18å¹´çš„ï¼Œå¯èƒ½ç°åœ¨ä»£ç æ”¹åŠ¨æ¯”è¾ƒå¤šï¼Œæ‹‰æœ€æ–°åˆ†æ”¯çš„ä»£ç patchä¼šæ‰“ä¸ä¸Šå»ï¼Œäºæ˜¯åªå¥½å…¨éƒ¨cloneä¸‹æ¥ã€‚
    git clone https://github.com/mozilla/gecko-dev.git
è¿™é‡Œä»£ç é‡æœ‰ç‚¹å¤§ï¼ˆ5.6gï¼‰ï¼Œå›½å†…çš„ç½‘ç»œçŠ¶æ€ä¼°è®¡ä¸å¤ªå®¹æ˜“æ‹‰ä¸‹æ¥ï¼Œgit clone
è²Œä¼¼ä¹Ÿä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œä¸­é€”è¿æ¥ä¸­æ–­å°±å¾ˆä¼¤ã€‚æˆ‘çš„åšæ³•æ˜¯åˆ°å›½å¤–vpsä¸Šå»cloneï¼Œæ‰“åŒ…å‹ç¼©ä¹‹åä¸‹è½½åˆ°æœ¬åœ°ã€‚
###  patch
æœ‰äº†ä»£ç ä¹‹åæ¥ä¸‹æ¥å°±æ˜¯æ‰“patchï¼Œç”±äºæœ€æ–°åˆ†æ”¯patchæ‰“ä¸ä¸Šå»ï¼Œäºæ˜¯æˆ‘è¯•ç€åˆ‡åˆ°patchä¸­æ ‡æ³¨çš„æ—¥æœŸæ‰€å¯¹åº”çš„commitï¼Œæœ€ååˆ‡åˆ°be1b849fa264æˆåŠŸæ‰“ä¸Šäº†patchã€‚ï¼ˆè¿‡ç¨‹æ›²æŠ˜ã€‚ã€‚ï¼‰
    # æ‰“å°æŸä¸ªæ—¥æœŸèŒƒå›´å†…çš„commitä¿¡æ¯
    git log --after="2018-04-01 00:00" --before="2018-04-10 23:59"
    git checkout -f be1b849fa264
    cd gecko-devjs
    git apply c:xxxblaze.patch
    # git apply --reject --whitespace=fix mypath.patch
    # git checkout -f master
###  build
å‘çˆ¹çš„visual studioï¼Œ è¿™é‡ŒæŠ˜è…¾äº†ä¸€å¤©ã€‚è¯¦ç»†è®°ä¸€ä¸‹
å®‰è£…
[MozillaBuildSetup-3.2.exe](https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-3.2.exe)
ï¼Œåœ¨C:mozilla-buildä¸‹é¢æ‰¾åˆ°start-shell.batåŒå‡»æ‰“å¼€æ˜¯ä¸€ä¸ªmingw32çš„ç»ˆç«¯ï¼Œä¹‹åå°±åœ¨è¿™é‡Œé¢æ“ä½œã€‚
åˆ°è¿™ä¸ªé“¾æ¥ä¸‹ ï¼Œæ‰¾åˆ°15.6.7ç‰ˆæœ¬çš„é“¾æ¥ç‚¹å¼€ä¸‹è½½ã€‚æ³¨æ„ï¼google
vs2017æœåˆ°çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„vs2017ï¼Œæœ€æ–°ç‰ˆæœ¬ç¼–è¯‘æ˜¯ä¼šæœ‰é—®é¢˜çš„ã€‚
ä¸‹å›¾æ˜¯å®‰è£…æœ€æ–°ç‰ˆæœ¬vs2017æˆ–è€…vs2019ï¼Œåé¢ç¼–è¯‘æ—¶çš„æŠ¥é”™ï¼š
â€œThis version (19.16.27034) of the MSVC compiler is not supported due to
compiler bugs.â€,
â€œYou must install Visual C++ 2017 Update 6 in order to buildâ€
æ ¹æ®[bugzillaé‡Œé¢çš„è¯´æ³•](https://bugzilla.mozilla.org/show_bug.cgi?id=1472148)ï¼Œè¿™é‡Œçš„Update
6æŒ‡çš„å°±æ˜¯15.6ç‰ˆæœ¬.
å®‰è£…å®Œä¹‹åï¼Œé…ç½®ã€ç¼–è¯‘ã€è¿è¡Œ
    gecko-dev/js/src$ autoconf-2.13
    gecko-dev/js/src$ mkdir build.asserts
    gecko-dev/js/src$ cd build.asserts
    gecko-dev/js/src/build.asserts$ ../configure --host=x86_64-pc-mingw32 --target=x86_64-pc-mingw32 --enable-debug # vsç‰ˆæœ¬ä¸å¯¹çš„è¯è¿™é‡Œä¼šæŠ¥é”™
    gecko-dev/js/src/build.asserts$ mozmake -j2
    # åˆ°è¿™é‡Œç¼–è¯‘å®Œæˆï¼Œäº§å‡ºjs.exeï¼Œæ­¤æ—¶è¿è¡Œjs.exeï¼Œä¼šæŠ¥é”™ç¼ºå°‘dll
    gecko-dev/js/src/build.asserts$ cp ./mozglue/build/mozglue.dll       ./config/external/nspr/pr/nspr4.dll  ./js/src/
    gecko-dev/js/src/build.asserts$./js/src/js.exe # doneï¼
    js> 1+1
    2
    js>
## æ•°æ®è¡¨ç¤º
jså¼•æ“ä¸­éƒ½ä¼šæœ‰ä¸€äº›ç”¨æ¥debugçš„å‡½æ•°ï¼Œå’Œ JavaScriptCore ä¸­çš„describeä¸€æ ·ï¼Œ SpiderMonkeyä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„ï¼š
  * objectAddress æ‰“å°objectåœ°å€
  * dumpObject æ‰“å°objectä¿¡æ¯
æ‰“å¼€windbgï¼Œattachåˆ°js.exeï¼ŒæŒ‰gè¿è¡Œï¼Œè®¾ç½®æ–­ç‚¹çš„æ–¹å¼æ˜¯æ‰¾ä¸€ä¸ªå¾ˆå°‘è¢«ç”¨åˆ°çš„å‡½æ•°ï¼Œæ¯”å¦‚ `Math.atan2` ã€‚
Math.atan2çš„å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š
    bool js::math_atan2(JSContext* cx, unsigned argc, Value* vp)
windows x64æ±‡ç¼–ä¸­ï¼Œå‡½æ•°ä¼ å‚ä½¿ç”¨å‰ä¸‰ä¸ªå¯„å­˜å™¨ä¾æ¬¡æ˜¯ï¼šRCX, RDX, R8D
    dqs @r8 l@rdx+2 # dqsæ¯è¡Œæ‰“å°8bytesé•¿åº¦ï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯èµ·å§‹åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°Lxxæ˜¯å‡ è¡Œ
åœ¨math_atan2å¤„æ–­ä¸‹åargc+2(rdx)æ˜¯å‚æ•°ä¸ªæ•°ï¼Œvp(r8)æŒ‡å‘å‚æ•°åˆ—è¡¨ï¼Œè¿™é‡Œä¸ªæ•°æ˜¯argc+2çš„åŸå› æ˜¯ä¿ç•™äº†ä¸¤ä¸ªå‚æ•°ï¼ˆè¿”å›å€¼å’ŒthisæŒ‡é’ˆï¼‰
æ‰€ä»¥`dqs [@r8](https://github.com/r8 "@r8") l[@rdx](https://github.com/rdx
"@rdx")+2`æ‰“å°å‡ºå‡½æ•°çš„ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯thisæŒ‡é’ˆï¼Œç¬¬ä¸‰ä¸ªå°±æ˜¯è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°ã€‚
æ¥ä¸‹æ¥é€šè¿‡ä¸‹é¢çš„æµ‹è¯•è„šæœ¬æ¥çœ‹çœ‹ä¸åŒæ•°æ®ç±»å‹åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºï¼š
    'use strict';
    const Address = Math.atan2;
    const A = 0x1337;
    Address(A);
    const B = 13.37;
    Address(B);
    const C = [1, 2, 3, 4, 5];
    Address(C);
###  æ•´æ•° æµ®ç‚¹æ•°
ä¸Šå›¾æ˜¯åœ¨`Address(A)`å¤„æ–­ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºæ•´æ•°A(1377)åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºæ˜¯fff88000`00001337
    0:000> dqs @r8 l@rdx+2
    0000028f`87ab8198  fffe028f`877a9700
    0000028f`87ab81a0  fffe028f`87780180
    0000028f`87ab81a8  402abd70`a3d70a3d Value* vp
    0:000> .formats 402abd70`a3d70a3d
    Evaluate expression:
      Hex:     402abd70`a3d70a3d
      Double:  13.37
ç›¸åº”çš„ï¼Œæµ®ç‚¹æ•°B(13.37)åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºä¸º402abd70`a3d70a3dï¼Œ
å¯¹è±¡Cåœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºä¸ºfffe028f`87790400,
ç»è¿‡åˆ†æï¼Œ `JS::Value` çš„é«˜17ä½æ˜¯tagä¿å­˜ç±»å‹ä¿¡æ¯ï¼Œä½47ä½æ˜¯valueä¿å­˜å€¼ä¿¡æ¯ã€‚ï¼ˆ17+47=64ï¼‰
tagè¡¨ç¤ºå¦‚ä½•è§£è¯»åé¢çš„valueï¼Œå½“tagæ˜¯æ•´æ•°ã€å¸ƒå°”è¿™äº›ç±»å‹çš„æ—¶å€™ï¼Œvalueæ˜¯ç«‹å³æ•°ï¼›å½“tagæ˜¯objectçš„æ—¶å€™ï¼Œvalueæ˜¯æŒ‡é’ˆã€‚
    enum JSValueType : uint8_t
    {
        JSVAL_TYPE_DOUBLE              = 0x00,
        JSVAL_TYPE_INT32               = 0x01,
        JSVAL_TYPE_BOOLEAN             = 0x02,
        JSVAL_TYPE_UNDEFINED           = 0x03,
        JSVAL_TYPE_NULL                = 0x04,
        JSVAL_TYPE_MAGIC               = 0x05,
        JSVAL_TYPE_STRING              = 0x06,
        JSVAL_TYPE_SYMBOL              = 0x07,
        JSVAL_TYPE_PRIVATE_GCTHING     = 0x08,
        JSVAL_TYPE_OBJECT              = 0x0c,
        // These never appear in a jsval; they are only provided as an out-of-band
        // value.
        JSVAL_TYPE_UNKNOWN             = 0x20,
        JSVAL_TYPE_MISSING             = 0x21
    };
    JS_ENUM_HEADER(JSValueTag, uint32_t)
    {
        JSVAL_TAG_MAX_DOUBLE           = 0x1FFF0,
        JSVAL_TAG_INT32        = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_INT32, //intçš„tagæ˜¯0x1ff1
        JSVAL_TAG_UNDEFINED            = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_UNDEFINED,
        JSVAL_TAG_NULL                 = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_NULL,
        JSVAL_TAG_BOOLEAN              = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_BOOLEAN,
        JSVAL_TAG_MAGIC                = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_MAGIC,
        JSVAL_TAG_STRING               = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_STRING,
        JSVAL_TAG_SYMBOL               = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_SYMBOL,
        JSVAL_TAG_PRIVATE_GCTHING      = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_PRIVATE_GCTHING,
        JSVAL_TAG_OBJECT               = JSVAL_TAG_MAX_DOUBLE | JSVAL_TYPE_OBJECT
    } JS_ENUM_FOOTER(JSValueTag);
ä»ä¸Šé¢çš„å®šä¹‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œintç±»å‹çš„tagæ˜¯0x1ff1ï¼Œobjectç±»å‹çš„tagæ˜¯0x1ffc
éªŒè¯å¦‚ä¸‹ï¼š
    >>> v = 0xfff8800000001337
    >>> hex(v >> 47)
    '0x1fff1'
    >>> hex(v & ((2**47) - 1))
    '0x1337'
    >>> 
    >>> obj = 0xfffe028f87790400
    >>> hex(obj>>47)
    '0x1fffc'
    >>> hex(obj & ((2**47)-1))
    '0x28f87790400'
    >>>
###  æ•°ç»„
    # const C = [1, 2, 3, 4, 5];
    0:000> dqs @r8 l@rdx+2
    0000027a`bf5b8198  fffe027a`bf2a9480
    0000027a`bf5b81a0  fffe027a`bf280140
    0000027a`bf5b81a8  fffe027a`bf2900a0 ğŸ‘ˆ
    0:000> dqs 27a`bf2900a0
    0000027a`bf2900a0  0000027a`bf27ab20
    0000027a`bf2900a8  0000027a`bf2997e8
    0000027a`bf2900b0  00000000`00000000
    0000027a`bf2900b8  0000027a`bf2900d0 æ•°æ®æŒ‡é’ˆğŸ‘‡
    0000027a`bf2900c0  00000005`00000000
    0000027a`bf2900c8  00000005`00000006
    0000027a`bf2900d0  fff88000`00000001  dt JSObject
       +0x000 group_           : js::GCPtr
       +0x008 shapeOrExpando_  : Ptr64 Void
    0:000> dt js::NativeObject
       +0x000 group_           : js::GCPtr
       +0x008 shapeOrExpando_  : Ptr64 Void
       +0x010 slots_           : Ptr64 js::HeapSlot
       +0x018 elements_        : Ptr64 js::HeapSlot
    0:000> dt js::ArrayObject
       +0x000 group_           : js::GCPtr
       +0x008 shapeOrExpando_  : Ptr64 Void
       +0x010 slots_           : Ptr64 js::HeapSlot
       +0x018 elements_        : Ptr64 js::HeapSlot
ç»§æ‰¿é“¾ï¼š js::ArrayObject  æ¨èè§†é¢‘ï¼š
æˆ‘ä»¬ä¸»è¦åé¢å…³æ³¨property(å±æ€§)å’Œvalue(å€¼)ï¼Œshapeæè¿°å¯¹è±¡ properties çš„ä¿¡æ¯ï¼Œåœ¨shapeOrExpando_ä¸­è¡¨ç¤ºã€‚
åé¢ç”¨æ¥è°ƒè¯•çš„ä»£ç ï¼š
    'use strict';
    const Address = Math.atan2;
    const A = {
        foo : 1337,
        blah : 'doar-e'
    };
    Address(A);
    const B = {
        foo : 1338,
        blah : 'sup'
    };
    Address(B);
    const C = {
        foo : 1338,
        blah : 'sup'
    };
    C.another = true; // Cå¢åŠ äº†ä¸€ä¸ªprop
    Address(C);
**prop**
    # address(A)å¤„æ–­ä¸‹