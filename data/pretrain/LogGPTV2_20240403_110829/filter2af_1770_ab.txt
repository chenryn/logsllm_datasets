# 四．对抗技术升级盘点
  1. 拦截过滤  
Rootkit病毒往往会注册各种各样的回调，或者hook系统相关函数，以在合适的时间点获得执行机会，在回调函数中完成相关的拦截过滤功能。以独狼一代为例，独狼系列病毒家族可以说是病毒高难度对抗的集大成者，这是一个过滤型驱动，具有完善的过滤架构，拦截过滤点包括文件过滤、网络过滤等，下图为过滤点及其使用的技术，及影响风险。  
图13独狼Rootkit过滤点
  2. 对抗杀软  
Bootkit/Rootkit病毒为了躲避杀软查杀，对抗技术手段有很多，常见的一些对抗手段如下：  
图14
道高一尺魔高一丈，杀毒软件和顽固病毒的对抗是一个持续性的过程，每当病毒用一种新的方法来躲避或者绕过杀毒软件查杀的时候，很快杀毒软件也会升级查杀能力对新病毒进行查杀。走投无路了病毒也会放出大招，比如强制重启电脑以阻断查杀过程。
2018年电脑管家披露的主页保安病毒就使用了这种强对抗手段来躲避查杀，其主要逻辑为木马会不断的检查系统启动组注册表项HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ServiceGroupOrder
下的List键值，系统默认该键值第一项为System Reserved，如果检查到启动组第一项不是System
Reserved则暴力重启电脑，通过OUT指令直接写IO端口0x64实现强制重启，往64号端口写入0xFE后电脑强制重启以阻断杀毒软件查杀  
图15暴力重启电脑  
图16设备占坑
  1. 自保护  
这里提到的自保护主要指病毒为了防止被用户发现，或被安全研究人员分析透彻，往往会通过一些技术手段来保护自身以加大被发现或被分析的难度。
最常见的自保护对象是病毒文件及对应的注册表项。注册表的保护主要是通过注册cmpcallbakck回调来完成，通过阻止或者隐藏自身注册表以达到自保护的目的。病毒文件的保护也是通过底层的文件钩子来实现。此外为了防止被ARK等分析工具发现往往会隐藏自身的模块信息。
以“血狐”病毒为例，通过KeServiceDescriptorTable拿到NtLoadDriver函数地址，然后通过调用4次硬编码查找函数（ba7011a4），找到MiProcessLoaderEntry函数，通过搜索获取MiProcessLoaderEntry地址调用，达到摘链来隐藏模块信息不被ARK工具发现。  
图17隐藏模块信息
Bootkit的自保护主要是保护自身的MBR或者VBR感染代码及payload不被发现，比如暗云木马会根据磁盘类型和操作系统替换DriverStartIo、
AtapiHwStartIo、RaUnitStartIo等函数，实现阻止其他程序读取磁盘1-3F 扇区（MBR）。当检测到读MBR时，
返回一个构造好的正常的MBR作欺骗，检测到写MBR时，则直接pass 该操作。  
图18MBR保护挂钩逻辑
五．典型案例  
2018年下半年最为活跃的Rootkit病毒家族为独狼家族，仅腾讯电脑管家进行批露的独狼家族相关的病毒感染事件就有3例，传播渠道从独狼一代的盗版GHOST系统到独狼二代的激活工具，从主页锁定，刷量获利到传播盗号木马，到强力破坏杀毒软件功能，可谓是无恶不作。  
Bootkit最为活跃的病毒家族为暗云及隐魂系列，其中暗云不仅频繁更换C2网址，还首次发现和Mykings僵尸网络进行捆绑传播，此外国内厂商披露的暗云变种“隐匿者”也加入了挖矿的行列。Bootkit病毒家族隐魂最早在2017年被披露，其变种“隐蜂”最主要的变现方式也是挖矿。
  1. 独狼Rootkit病毒家族  
独狼一代病毒家族最早由腾讯电脑管家于2018年6月披露，独狼一代其传播渠道主要是Ghost系统。腾讯御见威胁情报中心已在不同的Ghost系统中捕获到多个“独狼”系列Rootkit，包括Jomalone系列，chanel系列，Msparser系列，Wdfflk系列，在不同的Ghost系统里会以固定的服务名(如Jomalone)启动，每个系列有多个变种。
独狼系列其PDB信息都是PASS
Through.pdb（过滤），都是一个过滤型驱动，具有完善的过滤架构，包括文件过滤、网络过滤、进程创建过滤、注册表过滤、模块加载过滤等。这四个系列中出现最早的是在2017年10月。此外其签名信息都有着高度关联性。  
参考链接：  
盗版Ghost系统携“独狼”Rootkit来袭，锁定浏览器主页超20款  
图19独狼系列出现时间文件签信息
独狼二代重新拓展了传播渠道，并且各个病毒模块功能都得到进一步改进，传播渠道由单一的Ghost盗版系统传播演变为假冒系统激活工具传播。主要通过静默推广安装浏览器获利，并会锁定23款浏览器主页，将浏览器地址栏锁定为带推广渠道号的网址导航站，和独狼一代一大区别为从纯Rootkit驱动劫持首页，转变为内存解密Payload结合浏览器注入实现，此外还会静默推装浏览器  
(参考链接：[2])  
Rootkit病毒“独狼2”假冒激活工具传播，锁定23款浏览器主页  
图20独狼系列病毒静默安装的浏览器
独狼系列最新变种，会通过“酷玩游戏盒子”、“桌面助手”、“玩玩游戏”等软件传播盗号木马，该木马累计已感染超过5万台电脑。软件运行后会首先下载伪装成WPS的病毒，再下载安装“独狼”Rootkit病毒，最终进行营销推广、恶意推装更多软件来获利。  
木马作者疑似伪造“北京方正阿帕比技术有限公司”的相关信息，申请了正规的数字签名，该病毒文件会下载Steam盗号木马，因病毒程序拥有合法数字签名导致多款杀毒软件未及时查杀，这是该病毒感染超过5万电脑的重要原因。  
(参考链接：[3])  
酷玩游戏盒子伪造知名公司数字签名，传播Steam盗号木马  
图21独狼木马执行流程
  1. 暗云木马  
暗云家族最早由电脑管家于2015年进行披露，18年9月国内安全厂商披露了暗云变种“隐匿者”转投挖矿，病毒暴力破解用户数据库入侵电脑，MBR感染代码获得执行后将恶意代码注入到系统进程中（winlogon或explorer进程），最终恶意代码会下载后门病毒到本地执行，后门病毒会下载执行挖矿相关病毒模块，挖取门罗币。  
(参考链接：[4])  
"隐匿者"病毒团伙技术升级传播病毒  
图22暗云木马挖矿配置信息
腾讯御见威胁情报中心2018年12月监控到暗云最新动态，和Mykings僵尸网络木马捆绑传播，通过MS SQL
SEVER弱密码入侵用户机器成功后会执行远程脚本命令，远程脚本执行后会下载多个木马文件到本地执行包括暗云感染器、Mykings僵尸网络木马、Mirai僵尸网络木马。和以往的暗云系列相比，主要变化包括会强制结束包括管家、360等杀软进程，随后注入应用层的payload会根据云端配置文件进行主页锁定及下载执行木马病毒等功能。(参考链接：[5])  
弱口令爆破SQL Server服务器，暗云、Mykings、Mirai多个病毒家族结伴来袭  
图23暗云配置文件
  1. 隐魂木马家族  
隐魂系列最早于2017年进行披露，和暗云系列最大区别为payload的存储区域及hook流程有着较大差异，暗云payload存储在3到63扇区，而隐魂系列存储在磁盘末尾。