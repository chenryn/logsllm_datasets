 和diStorm
1
 。ndisasm
 是Netwide Assembler（NASM ）2
 中的一个工具。下面的例子说明了如何使用 ndisasm
 反汇编一段由Metasploit框架3
 生成的shellcode ：
1 参见http://www.ragestorm.net/distorm/
 。
2 参见http://nasm.sourceforge.net/
 。
3 参见http://www.metasploit.com/
 。
idabook#  ./msfpayload linux/x86/shell_findport CPORT=4444 R > fs  
idabook#  ls -l fs  
-rw-r--r-- 1 ida ida 62 Dec 11 15:49 fs  
idabook#  ndisasm -u fs  
00000000  31D2              xor edx,edx  
00000002  52                push edx  
00000003  89E5              mov ebp,esp  
00000005  6A07              push byte +0x7  
00000007  5B                pop ebx  
00000008  6A10              push byte +0x10  
0000000A  54                push esp  
0000000B  55                push ebp  
0000000C  52                push edx  
0000000D  89E1              mov ecx,esp  
0000000F  FF01              inc dword [ecx]  
00000011  6A66              push byte +0x66  
00000013  58                pop eax  
00000014  CD80              int 0x80  
00000016  66817D02115C      cmp word [ebp+0x2],0x5c11  
0000001C  75F1              jnz 0xf  
0000001E  5B                pop ebx  
0000001F  6A02              push byte +0x2  
00000021  59                pop ecx  
00000022  B03F              mov al,0x3f  
00000024  CD80              int 0x80  
00000026  49                dec ecx  
00000027  79F9              jns 0x22  
00000029  52                push edx  
0000002A  682F2F7368        push dword 0x68732f2f  
0000002F  682F62696E        push dword 0x6e69622f  
00000034  89E3              mov ebx,esp  
00000036  52                push edx  
00000037  53                push ebx  
00000038  89E1              mov ecx,esp  
0000003A  B00B              mov al,0xb  
0000003C  CD80              int 0x80  
由于流式反汇编非常灵活，因此它的用途相当广泛。例如，在分析网络数据包中可能包含shellcode 的计算机网络攻击时，就可以采用流式反汇编器来反汇编数据包中包含 shellcode 的部分，以分析恶意负载的行为。另外一种情况是分析那些不包含布局参考的 ROM镜像。ROM中有些部分是数据，其他部分则为代码，可以使用流式反汇编器来反汇编镜像中的代码。
2.4 小结
本章所讨论的工具不一定是同类中最优秀的，但是，它们是从事二进制文件逆向工程的分析人员常用的工具。更重要的是，这些工具大大促进了 IDA 的开发过程。在接下来的几章中，我们还会讨论这些工具。掌握这些工具可为你了解 IDA 的用户界面以及显示它提供的许多信息提供极大的帮助。
第3章 IDA Pro 背景知识
交互式反汇编器专业版（Interactive Disassembler Professional），人们常称为 IDA Pro，或简称为IDA ，是总部位于比利时列日市（Liège）的Hex-Rays1
 公司销售的一款产品。开发IDA 的编程天才名叫 Ilfak Guilfanov，人们常叫他 Ilfak 。十多年前诞生时，IDA 还是一个基于控制台的 MS-DOS 应用程序，这一点很重要，因为它有助于我们理解 IDA 用户界面的本质。除其他内容外，IDA 的非GUI 版本是针对所有 IDA 支持的平台2
 发布的，并且继续采用源于最初DOS版本的控制台形式的界面。
1. 多年来，IDA 一直由DataRescue 公司销售。但自 2008年1 月，Ilfak 开始通过他自己的公司Hex-Rays 推广和销售IDA 。
2. 目前支持的平台是Windows、Linnux 和OSX 。
就其本质而言，IDA 是一种递归下降反汇编器。但是，为了提高递归下降过程的效率，IDA的开发者付出了巨大的努力，来为这个过程开发逻辑。为了克服递归下降的一个最大的缺点，IDA应用大量启发式技术来识别那些在递归下降过程中遗漏的代码。除反汇编过程本身外，IDA 在区分数据与代码的同时，还设法确定这些数据的类型。虽然你在 IDA 中看到的是汇编语言形式的代码，但IDA 的主要目标之一在于，呈现尽可能接近源代码的代码。此外，IDA 不仅使用数据类型信息，而且通过派生的变量和函数名称来尽其所能地注释生成的反汇编代码。这些注释将原始十六进制代码的数量减到最少，并显著增加了向用户提供的符号化信息的数量。
3.1 Hex-Rays公司的反盗版策略
IDA 用户应了解以下几项事实。IDA 是Hex-Rays 公司的旗舰产品。因此，他们对于未经授权就使用 IDA 的做法深恶痛绝。过去，该公司发现，盗版 IDA 的发布与公司销售量的下滑有着直接的因果关系。为此，IDA 的前发行公司 DataRescue 甚至将盗版者的姓名张贴在它的“耻辱堂”（Hall of Shame ）1
 中。为打击盗版，IDA 采用了几项反盗版技术，并实施了许可限制。
1. 该“耻辱堂”已被转移到Hex-Rays 的网站：http://www.hex-rays.com/idapro/hallofshame.html
 。
用户需要了解的第一种技术是：每一份IDA 都带有水印，以将它与购买者一对一地对应起来。如果一份 IDA 出现在盗版软件站点中，Hex-Rays 就能够通过水印追踪到购买者，并将其列入销售黑名单。我们常常可以在 Hex-Rays 的IDA 支持论坛上发现有关 IDA 的“泄露”版本的讨论。
为实施许可策略，IDA 采用的另一种技术是扫描在局域网中运行的其他 IDA 程序。例如，Windows 版本的IDA 启动后，它会在端口 23945 上广播一个UDP 包，并等待响应，看相同子网中是否有其他使用相同许可证密钥的 IDA 实例在运行。然后，IDA 会将得到的响应数量与使用该许可证的用户的数量进行比较，如果发现网络中存在过多的 IDA 实例，IDA 会拒绝启动。但是要注意，用户可以在一台计算机上使用相同的许可证运行多个 IDA 实例。
IDA 实施许可策略的最后一种方法是，使用密钥文件将每一名购买者与产品联系起来。在启动时，IDA 会搜索一个有效的 ida.key 文件。如果无法定位有效的密钥文件，IDA 就会立即关闭。密钥文件还用于确定用户升级 IDA 的资格。基本上，ida.key 文件就像是用户的购买收据，要想在将来获得升级资格，用户必须保管好这个文件。
3.2 获取IDA Pro
首先，也是最重要的是，IDA 并非免费软件。从某种程度上说，Hex-Rays 的员工要靠卖IDA来开工资。不过，Hex-Rays 为希望了解 IDA 基本功能的用户提供了一个功能有限的免费版本1
 ，但是，该免费版本并不提供最新版本的功能。该免费版本为IDA 5.0（当前版本为 6.1）的简化版，我们将在附录 A 中详细介绍这个免费版本。除免费版本外，Hex-Rays 还提供当前版本的功能有限的演示版2
 。如果你在讨论逆向工程的地方发现的对于 IDA 的称赞尚不足以吸引你购买 IDA ，那么，花一些时间熟悉免费版或演示版的功能，将有助于你了解 IDA 的强大功能及周到的客户服务，促使你购买这一产品。
1. 参见http://www.hex-rays.com/idapro/idadownfreeware.htm
 。
2. 参见http://www.hex-rays.com/idapro/idadowndemo.htm
 。
3.2.1 IDA 版本
从版本6.0开始，IDA 可以在 Windows、Linux 和OS X的GUI 和控制台界面中使用。IDA利用Qt的跨平台GUI 库在上述三个平台上提供一致的用户界面。从功能上看，IDA Pro 共有标准版和高级版两个版本。这两个版本的主要区别，在于它们支持反汇编的处理器体系结构数量不同。快速浏览一下它们所支持的处理器体系结构列表3
 ，即可发现：标准版（写作本书时售价约为540 美元）支持 30 多种处理器，而高级版（价格几乎是标准版的两倍）则支持50多种处理器。高级版支持的其他体系结构包括 x64、AMD64、MIPS、PPC 和SPARC等。
3. 参见http://www.hex-rays.com/idapro/idaproc.htm
 。
3.2.2 IDA 许可证
在购买IDA 时，用户可以选择两种许可证。Hex-Rays 网站4
 称：“已命名许可证（named license ）与某一特定的最终用户有关，可安装到该用户使用的任意多个计算机上。而计算机许可证则与某一台特定的计算机有关，任何使用该计算机的用户都可以使用这种许可证，但一次只能有一名用户使用该许可证。”注意，虽然已命名许可证可以让你在任意多个计算机上安装IDA 软件，但只有你才能运行这些 IDA 软件。而且，对于单个许可证，在某一给定时刻，IDA 只能在其中一台计算机上运行。
4 参见http://www.hex-rays.com/idapro/idaorder.htm
 。
说明
  与许多其他专有软件的许可证不同，IDA 的许可证特别赋予了用户对 IDA 进行逆向工程的权利。
3.2.3 购买IDA
在版本6.0 之前，用户购买的 IDA 包括一个 Windows GUI 版本及用于 Windows、Linux 和OS X的控制台版本。从版本 6.0开始，购买者必须具体指定他们希望运行 IDA 的操作系统。每个IDA 6. x 的副本仅提供指定操作系统的控制台和基于 Qt的GUI 版本。如果用户需要购买针对备用操作系统的其他许可证，Hex-Rays 将给予价格优惠。用户可以从 IDA 销售网页上列出的授权分销商那里购买 IDA ，或者通过传真或电子邮件直接向 Hex-Rays 购买。购买后，用户可获得产品光盘或下载版本的软件，并且可获得一年的免费产品服务和升级。除 IDA 安装程序外，产品光盘中还包括 IDA SDK 以及其他实用工具。通常，选择以下载方式购买 IDA 的用户只能获得IDA 的安装程序，并需要单独下载其他组件。
一直以来，Hex-Rays 根据 IDA 在各国的盗版情况，将IDA 的销售限制在特定的一些国家。对于违反 IDA 许可证条款的用户，它还保留有一份黑名单，并拒绝与这些用户及其雇主开展业务。
3.2.4  升级IDA
IDAHelp （帮助）菜单包括一个用于检查可用升级的选项。此外，IDA 会根据你的密钥文件中的过期日期自动向你发出警告，提示你 IDA 即将过期。一般情况下，在升级过程中，用户必须向Hex-Rays 提交ida.key 文件。然后，Hex-Rays 会验证用户的密钥，并提供如何获得升级版本的详细信息。如果你发现你的 IDA 版本过低，没有升级资格，请记得利用 Hex-Rays 向密钥过期的用户提供的折扣升级价格。
警告
  如果没有小心保管密钥文件，未授权用户可能会假冒你提出升级请求，导致你无法升级 IDA 。
最后，强烈建议在升级 IDA 时备份现有的 IDA 版本，或将升级版本安装到一个完全不同的目录，以避免丢失你修改的任何配置文件。为了恢复你之前所做的任何修改，你可能需要编辑升级版本中的相应文件。同样，你还需要移动、重新编译或以其他形式获得新版的自定义 IDA 插件（请参阅第 17 章了解有关插件及其安装的详细信息）。
3.3 IDA 支持资源
作为一名 IDA 用户，你可能想知道，如果遇到与 IDA 有关的问题，该从什么地方寻求帮助。如果我们做得还不错的话，本书也许能够解决用户遇到的大多数问题。如果你需要额外的帮助，请参考下面一些常用的资源。
正式的帮助文档
 。IDA 确实提供了通过菜单激活的（menu-activated）帮助系统，但是，该文档主要介绍 IDA 的用户界面和脚本子系统，它对于我们了解 IDASDK 以及解决类似于“我该如何处理……”的问题并没有多大帮助。
Hex-Rays的支持页面和论坛
 。Hex-Rays运行着一个支持页面1
 ，提供各种与 IDA 有关的资源的链接，包括针对得到许可证的用户的在线论坛。用户会发现，Ilfak 和Hex-Rays的其他核心程序员经常访问这些论坛，解答问题。用户可以通过这些论坛获得 SDK方面的非正式支持，因为在这里，有许多经验丰富的 IDA 用户乐于根据他们自己的经验为大家提供帮助。
1. 参见http://www.hex-rays.com/idapro/idasupport.htm
 。
有关如何使用 SDK 的问题，人们常常会告诉你“阅读包含文件”。但是，购买 IDA 产品，并不能获得 SDK 方面的正式支持。不过，Hex-Rays 倒是提供一个年度支持计划，每年收费 10 000 美元（是真的，10 000 美元）。要想了解 SDK ，Steve Micallef 的著作 IDA Plug-in Writing in C/C++2
 是一个非常有用的资源。
2. 参见http://www.binarypool.com/idapluginwriting/idapw.pdf
 。
openRCE.org
 。http://www.openrce.org/
 是一个活跃的逆向工程社区，其中包含大量介绍IDA 应用的文章，以及一些活跃用户论坛。与Hex-Rays 网站上的论坛类似，openRCE.org也吸引了许多经验丰富的 IDA 用户，他们常在论坛上与其他用户彼此交流、分享经验，也许能帮助你解决在使用 IDA 时遇到的问题。
RCE论坛
 。逆向代码工程（RCE ）论坛（http://www.woodmann.com/
 ）中包含大量与使用IDA Pro 有关的帖子。这个论坛的内容非常广泛，其主题不仅涉及如何使用 IDA Pro ，而且涵盖了许多用于对二进制文件进行逆向工程的工具和技巧。
IDA Palace
 。虽然最近 IDA Palace3
 的人气已经明显不如从前，但是，它仍然是一个专门提供IDA 相关资源的网站。在这个网站上，访问者可以找到大量介绍如何使用 IDA 的文章的链接，以及用于扩展 IDA 功能的脚本和插件。
3. 参见http://old.idapalace.net/
 。
Ilfak 的博客
 。Ilfak 的博客4
 中包含许多详细介绍 IDA 用法的文章，可帮助用户解决通用反汇编、调试及恶意软件分析等各种问题。此外，其他 Hex-Rays 团队成员发的帖子通常会详细介绍一些最新的 IDA 功能，以及正在开发的功能。
4 参见http://www.hexblog.com/
 。
3.4 安装IDA
从收到崭新的 IDA 光盘的兴奋中平静下来后，开始安装 IDA 吧。你会看到，光盘中包含两个名为utilities 和sdk 的目录，其中分别是各种附加实用工具和 IDA 软件开发套件（这些内容将在后面几章中讨论）。在光盘的根目录下，你将找到一个安装二进制文件。对于Windows 用户，这个二进制文件是一个传统的 Windows 安装程序可执行文件。对于 Linux和OS X用户，该安装二进制文件是一个由 gzip 压缩的.tar 文件。
3.4.1 Windows安装
在Windows 系统上安装 IDA 非常简单。IDA 的Windows 安装程序需要随光盘提供的密码，如果你已经下载了 IDA ，那么密码会通过电子邮件提供。启动 IDA 的Windows 安装程序后，你会看到几个对话框，其中只有一个对话框需要你操作。如图 3-1 所示，你可以在这个对话框中指定IDA 的安装目录，或接受安装程序默认的安装目录。无论你是选择默认的安装目录，还是指定其他安装目录，在本书的剩余部分，我们将以 作为安装目录。在 IDA 目录中，你将发现密钥文件 ida.key 和下列IDA 可执行文件。
idag.exe ：IDA 的Windows GUI 版本。从 6.2版开始，IDA 中不再包含该文件。
idaq.exe ：IDA6.0或更新版本的 Windows Qt GUI版本。
idaw.exe ：IDA 的Windows 文本模式版本。
图3-1 选择安装目录
随着IDA 6.0 开始采用 Qt跨平台GUI 库，IDA 的原始 Windows 版本（idag.exe ）已被废弃，将从版本 6.2开始停止随 IDA 向用户提供。
3.4.2 OS X和Linux安装
要在OS X或Linux系统上安装 IDA ，首先必须用 gunzip 和untar程序将相应的压缩文件解压到你所选择的位置。在 Linux系统中，解压命令为：
# tar -xvzf ida61l.tgz
在OS X系统中，解压命令为：
# tar -xvzf ida61m.tgz
无论是哪一种情况，你将得到一个名为 ida 的顶层目录，其中包含所需的全部文件。