2.3 攻击入侵分析 
从安全日志分析发现攻击入侵是安全运营的重点任务。如下示例：
据力度有待确定。举个常见的例子，如在对方不知情的情况下偷录 的语音，其证据力度、合法性在法庭上有待法官确认。如上图所示
…	的溯源取证的例子：
	（1）事件描述：对恶意 IP 进行溯源，拿下该 IP 控制权限；	（2）受攻击主机：www.xxx.com；
 （3）攻击源 IP：103.XX.184.194；
从全流量抓取攻击数据包，查看日志携带 webshell 恶意字段：（1）事件描述：攻者队使用扫描器进行 IP 信息收集和漏洞扫描；（2）受攻击主机：112.XX.XX.230；（3）攻击源 IP:…59.1XX.XX.20。
这些消息表明攻击者对网络做了一次端口扫描，试图寻找有安全漏
（4）信息收集与分析过程：从全流量抓取攻击数据包，查看日志，Webshell，确定恶意攻击行为。
三、安全日志实战应用的几个场景
3.1 利用流量日志查找肉鸡
洞的主机，这一系统近期发现大量易受攻击的漏洞。	1、场景描述
在恶意攻击中受控主机会从受感染的主机向攻击者控制的主机发
2.4 鉴定取证 
计算机取证是近年最热门的一个专业词汇，原来专指在特定领域拥 有鉴定资格或司法人员在处理案例过程中使用专业工具对计算机 系统获取的日志或记录，可以在侦察、诉讼等阶段作为证据使用。其他人员如企业安全管理员、第三方安全厂商在安全事件中记录的 安全日志，在法律程序上不能算是严格的“证据”，其合法性和证送简短和定期的通讯的做法，以传达受感染主机恶意软件处于活动 状态、正常运行并准备好接收指令的相关信息。此通信流量通常来 自受感染的内部企业主机（例如 bots 或 zombies），并发送到企 业网络外部的命令和控制（C&C）服务器。这种通信允许僵尸网 络管理员自动追踪、管理和控制数十万受感染的主机。
当我们面对恶意软件的时候，为什么不直接寻找恶意软件本身，而 要利用流量日志去作为检测的依据呢？那是因为随着技术的增长，好的恶意软件并不总是那么容易被找到。因为恶意软件的作者知道 防病毒、反恶意软件和端点保护是如何运作的，所以复杂的恶意软 件很容易逃避各类检测。作者可以围绕它们进行设计，甚至在开始 执行任何嘈杂的活动或在受感染的主机上写入任何文件之前检查 是否存在这些防御机制。因此，仅检查机器上的恶意软件是不够的，我们还需要从流量日志上寻找恶意软件感染的迹象。通常恶意软件
214 	215214 	215
证券行业安全日志的几个应用场景
在主机上立足后，它会迅速确定主机环境并与命令和控制服务器（Command&Control…Server）取得联系。然后，C2 服务器会决 定向受感染主机传输或者安装什么样的内容。
2、检测模型和检测步骤
NTA 流量日志，未经处理的数据如下图所示：…
(2) 筛选数据流向：上文提到的恶意流量通常来自受感染的内部企 业主机，并发送到企业网络外部的命令和控制（C&C）服务器，所 以本模型关注源地址为内网IP，目的地址为外网IP的流量（Internal…IP → External…IP）。在模型使用过程中可通过平台提供的 lookup 函数对内网段作出筛选。
(3) 数据处理 - 时间数据：由于此模型需要计算时间间隔等数据，时间戳字段不便于运算，故需把时间戳转化为以秒为单位的数值。转化思路为，如时间戳成时间为 10:12:14.321，则转换为秒的公式 为Time=10×3600s+12×60s+14.321s=36734.321s
(4) 数据处理 - 时间重整：在时间转化完毕后，我们需要对数据进 行重整，展示出同一源 IP 对同一目的 IP 的所有通讯时间，将时间 排序，为后续计算时间间隔作准备，同时展示两个 IP 之间的连接 次数。
…  
(1) 采集原始日志：本模型通过安全大数据分析平台接入数据源为
(5) 时间间隔计算：使用脚本计算出同一源 IP 对同一目的 IP 所有
216 	217
证券行业安全日志的几个应用场景
相邻通讯的时间间隔。
(6) 利用阀值进行过滤：在得到所有时间间隔之后，我们需要定义 异常场景的筛选条件以此作为告警条件。根据肉鸡的特性以及其它
发生通讯的总次数。通过与这个值对比可以将通讯次数较少的事件 过滤掉，降低误报，提高模型的实用性。此处设定当连接总次数阀 值 =20，当 conn_cnt>20 时为有效事件。百分比阀值：百分比指的是同一源地址至同一目的地址之间的通讯 存在行为的可能性。利用这个值进行筛选可以有效提高告警的精 度。此处设定百分比阀值为 30，当百分比大于 30 为有效事件。百 分比计算公式为：
… 
阀值的设定需要和时间框架关联，此模型使用的时间框架为 24 小 时，另外阀值的设定应根据环境或告警的真实情况作出调整。
(7) 验证告警：根据阀值筛选结果，由安全分析人员验证可疑事件，如确认存在肉鸡行为以及恶意软件，标示主机失陷并进行响应。
3、减少干扰的检测 
在检测时，结果可能包含已知设备供应商的合法流量，例如与 Windows 更新相关的流向 Microsofts 的流量、流向设备制造供应 商的流量，或任何其他配置为按预定时间间隔启动网络连接的合法 应用程序。在模型使用初期，安全分析人员需要根据历史事件分析 了解基线，使用 IP 地址白名单来过滤此类合法 IP 以减少大量的误 报，提高检测精准度。由于检测会根据重复最多的时间间隔发出告警，但攻击者也可以添
参考定义以下两条：	加抖动或随机性使各个网络连接之间的时间间隔值看起来有所不
连接总次数阀值：连接总次数指的是同一源地址至同一目的地址所
同，并使流量百分比阀值的匹配失效，从而绕过此检测。为应对此
218 	219
问题，安全分析人员可以使用基线分析和数据集的其他参数，推导 出额外的阀值进行更精准的匹配，提高效能。
4、告警以及分析样例 
告警样例：如下图告警所示，告警样例中可以清晰的显示到源地址 以及目的地址，以及涉及到的资产、用户，以及资产所在的区域， 
证券行业安全日志的几个应用场景
1、攻击步骤
涉及到的攻击阶段等信息。
(1) 信息收集
➢ 利用工具、搜索语法、搜索引擎对暴露在外网的资产进行信息收 
	集。
…	➢ 识别语言、框架、CMS…等信息，寻找薄弱点。
(2) 实施攻击集。
…	➢ 识别语言、框架、CMS…等信息，寻找薄弱点。
(2) 实施攻击
➢…1、通过常规漏洞 / 逻辑漏洞进行外网突破，例如注入，XSS，上传，
	越权，修改任意用户密码等漏洞。
➢…低线程漏扫。
(3) 横向移动
➢…获取到 DMZ…区服务器权限，并提权成功，获得持久高权限账户。
➢…添加代理脚本或搭建隧道绕过防火墙策略限制。
3.2 DMZ 区主机异常连接检测 
内网渗透的手法思路也越来越灵活，包括各种域内横向移动以及跨
➢…横向渗透，域内信息收集，漏洞利用。
域攻击等，在这样的情况下，只通过边界部署 WAF 等安全设备已 	2、检测模型
经变得远远不够，这种时候就需要通过部署主机安全设备发现横向 行为，通过结合边界安全设备日志、防火墙日志、主机日志、主机 保护设备日志进一步确认横向渗透行为。在大部分情况下，Web 服务器都会处于 DMZ 区，所以此条规则针对 DMZ 主机的连接行(1)…通过结合当前设备资产，配置规则，在确认当前 DMZ 区主机 安全的情况下，通过防火墙日志，将 DMZ 区主机主动连接的设备 IP 以及对应端口写入观察列表，该列表为 DMZ 区主机连接白名单，该规则需要持续一段时间，具体时间要结合实际网络情况下的资产
220 为做出分析。 量（开启且不触发告警）。SPL…配置自学习监控以及形成的观察 221
列表如下：
appname:firewall…AND…(firewall.src_ip:DMZ… 区 主 机 IP)…|stats…count()…as…cnt…by 
证券行业安全日志的几个应用场景
(4)…触发异常连接告警后，首先可结合 WAF 等边界安全设备确认 该 IP 是否受到攻击且 WAF 状态为 allow，其次可结合 HIDS 等主 机保护设备以及主机日志确认该主机是否已失陷。firewall.src_ip,firewall.dst_ip,firewall.dst_port…|eval…table_ 
name=“网络连接白名单”|lookup2…watch_list_add 	3、产生误报的其他情况 