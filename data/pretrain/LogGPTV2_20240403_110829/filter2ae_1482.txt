# 【技术分享】利用Discuz e2dk地址XSS挂马分析报告（针对某专业军事论坛）

## 译文声明
本文为翻译文章，原文来源于安全客。译文仅供参考，具体内容和含义请以原文为准。

## 概述
2023年1月11日，360安全卫士云安全系统检测到国内知名军事论坛“军号网”上出现可疑的挂马行为。经过进一步确认，发现这是一次攻击范围较小、时间短暂且被迅速清理的挂马事件，疑似具有明确目标的针对性攻击。

攻击者使用了升级版的BlackHole EK挂马工具包（原作者已于2013年被捕），结合论坛的XSS漏洞进行挂马，显示出较高的技术水平。

## 论坛挂马手段
此次挂马点较为隐蔽，通过反复检查后确认是利用了Discuz论坛在解析ed2k协议时的一个XSS漏洞。该漏洞允许攻击者插入恶意JS脚本代码，调用`document.write`函数向页面中插入挂马iframe页面和恶意JS脚本。

### 攻击示例
- **图1**：攻击者发帖
- **图2**：插入的XSS代码

## 挂马页面分析
攻击者在帖子中插入了两类代码：
1. 第一类仅在其发表的第一个帖子中存在，该脚本是从网上获取cookie的代码修改而来，怀疑用于获取用户访问信息，但可能编写有误，并未成功获取。
   - **图3**：获取信息的脚本内容
2. 第二类代码则插入了恶意挂马代码，利用JS载入一个iframe，地址为`hxxp://lynxlyragrus.com/aengewauhg/ball/nobody_grows-leaving-complained.php`。该网址采用了`.com`域名，并且其他相关URL也有伪装模式。载入的页面是攻击包的着陆页面，代码加密特点是使用`-1`来分割加密字符串。
   - **图4**：着陆页面解密代码

### 解码后的代码
解码后的代码分为三部分：
1. **第一部分**：内容丰富的浏览器及插件版本判断方法，代码编写规范，比常见的EK更加工程化。
   - **图5**：版本判断代码
2. **第二部分**：使用JS对Java、Flash进行版本判断，并选择执行对应的挂马函数。
3. **第三部分**：包含多个待执行的函数代码，分别为`f1`、`f2`、`f3`、`i1`、`i2`、`i3`、`p2`、`j1`。这些函数引入漏洞利用文件和JS代码，并向服务端传递动态生成的参数信息，确保漏洞页面只能被一次性访问。
   - **图6**：引入攻击代码

#### 具体函数
- **f2**：载入一个Flash文件，通过RC4加密方法将实际的漏洞利用代码加密到BinaryData中，解开后确认是CVE-2015-8651。
   - **图7**：CVE-2015-8651代码
- **i1**：引入的JS文件是Base64编码的，解开后是CVE-2013-2551的漏洞利用代码。
   - **图8**：CVE-2013-2551代码

## 进一步分析
复现挂马后，我们对挂马页面进行了多次试探，发现所有页面访问都具备常见的安全措施。错误链接或过期参数访问只会返回“Industry is the parent of success”的字符串。此外，不同浏览器版本会引入不同的漏洞攻击函数。例如，使用IE9访问时，`i3`函数会出现具体的攻击代码；而使用Chrome访问时，则能获取`f1`和`f3`代码内容。

### 漏洞利用情况
根据着陆页面的相关插件软件版本判断，结合以往常见漏洞的利用情况，大致猜测该攻击包所利用的漏洞情况如下表所示：

| 函数 | 漏洞 |
|------|------|
| f1, f2, f3 | Flash 相关漏洞 |
| i1, i2, i3 | IE 相关漏洞 |
| p2 | PDF 相关漏洞 |
| j1 | Java 相关漏洞 |

### 攻击包来源
根据着陆页面的代码风格与部分特殊函数命名，发现该攻击包是基于最后的BlackHole Exploit Kit版本修改而来。BlackHole Exploit Kit曾是前几年比较流行的攻击包，但其作者在2013年被捕后，该攻击包不再更新并逐渐消失。这次的攻击代码显然基于最后活跃版本的BlackHole，并更新了最新的相关漏洞。

## 载荷分析
最终释放到本地的文件是一个基于Zeus Bot代码的新变种，我们根据其配置信息将其命名为ff0bot木马。Zeus Bot是有史以来最臭名昭著的网银木马之一，其完整源代码曾被人泄露在互联网上，并不断被修改用于恶意攻击。

### 木马功能
- **图9**：木马配置信息
- **图10**：指令代码
- **图11**：窃取用户密码
- **图12**：窃取证书私钥
- **图13**：屏幕截图功能
- **图14**：解密配置文件代码

## 总结
此次挂马时间非常短暂，攻击者在1月10日凌晨第一次发布两个帖子，随后每隔一天继续发布回帖，总共发布了4条帖子。1月13日晚挂马页面失效，1月16日晚攻击者删除所有攻击代码，并逐一删除相关回复帖子，至此销声匿迹。

相比以往监测到的挂马，此次攻击范围较小，时间短暂且注重隐蔽清理现场，利用的技术水平比常见的国内黑产更高，喜欢在现有成熟的攻击工具基础上进行改造升级。

为了有效防范此类攻击，请大家及时更新系统补丁并升级常见软件。同时，希望各个论坛管理员能够及时更新论坛代码，减少用户遭受攻击的风险。360安全卫士也采用多层次防御体系进行有效阻止，保护用户电脑安全。

本文由360 QEX引擎团队和追日团队共同撰写。

## 参考文献
1. 大批知名论坛被挂马,系 Discuz!论坛标签权限设置不当
2. [Discuz! X 储存型XSS (X1 ~ X3.1最新版)](https://web.archive.org/web/20150125060822/http://www.wooyun.org/bugs/wooyun-2014-051123)
3. NeutrinoEK来袭：爱拍网遭敲诈者病毒挂马
4. 2014-05-23 – BLACKHOLE EK FROM 109.120.173.4 – BLACK1.WHA.LA