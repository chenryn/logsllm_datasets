9. Router 1 performs the route determination process for the destination address 2001:DB8:0:48::3. The 
closest matching route is the route for 2001:DB8:0:48::/64. Router 1 sets the next-hop address to 
FE80::E and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:21::/64 
subnet. 
10. Router 1 updates its destination cache with an entry for 2001:DB8:0:48::3 with the next-hop IPv6 
address of FE80::E and the next-hop interface of the network adapter that is attached to the 
2001:DB8:0:21::/64 subnet. 
11. Router 1 checks its neighbor cache for an entry with the IPv6 address of FE80::E and does not find a 
match. 
12. Router 1 sends a Neighbor Solicitation message to the solicited node multicast IPv6 address 
FF02::1:FF00:E, querying the 2001:DB8:0:21::/64 subnet for the MAC address of the interface that is 
assigned the IPv6 address of FE80::E. 
13. Because Router 3 is listening on the solicited node multicast address of FF02::1:FF00:E, the router 
receives the Neighbor Solicitation message. The router adds an entry to its neighbor cache for the 
IPv6 address FE80::B and the MAC address of Router 1's interface on the 2001:DB8:0:21::/64 
subnet. 
14. Router 3 sends a unicast Neighbor Advertisement message to Router 1. 
15. Router 1 updates its neighbor cache with an entry for the IPv6 address of FE80::E and the MAC 
address of Router 3's interface on the 2001:DB8:0:21::/64 subnet. 
16. Router 1 forwards the unicast TCP SYN segment destined for 2001:DB8:0:48::3 to Router 3's MAC 
address on the 2001:DB8:0:21::/64 subnet. 
17. Router 3 receives the TCP SYN segment, checks its destination cache for an entry for 
2001:DB8:0:48::3, and does not find a match. 
18. Router 3 performs the route determination process for the destination address 2001:DB8:0:48::3. The 
closest matching route is the route for 2001:DB8:0:48::/64 (a directly attached network route). Router 
3 sets the next-hop address to the packet's destination address of 2001:DB8:0:48::3 and the next-
hop interface to the network adapter that is attached to the 2001:DB8:0:48::/64 subnet. 
19. Router 3 updates its destination cache with an entry for 2001:DB8:0:48::3 with the next-hop IPv6 
address of 2001:DB8:0:48::3 and the next-hop interface of the network adapter that is attached to the 
2001:DB8:0:48::/64 subnet. 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 309 
20. Router 3 checks its neighbor cache for an entry with the IPv6 address of 2001:DB8:0:48::3 and does 
not find a match. 
21. Router 3 sends a Neighbor Solicitation message to the solicited node multicast IPv6 address 
FF02::1:FF00:3, querying the 2001:DB8:0:48::/64 subnet for the MAC address of the interface that is 
assigned the IPv6 address of 2001:DB8:0:48::3. 
22. Because the Web server is listening on the solicited node multicast address of FF02::1:FF00:3, the 
server receives the Neighbor Solicitation message. The server adds an entry to its neighbor cache 
for the IPv6 address FE80::F and the MAC address of Router 3's interface on the 2001:DB8:0:48::/64 
subnet. 
23. The Web server sends a unicast Neighbor Advertisement message to Router 3. 
24. Router 3 updates its neighbor cache with an entry for the IPv6 address of 2001:DB8:0:48::3 and the 
MAC address of the Web server's interface on the 2001:DB8:0:48::/64 subnet. 
25. Router 3 forwards the unicast TCP SYN segment destined for 2001:DB8:0:48::3 to the MAC address 
of the Web server's interface on the 2001:DB8:0:48::/64 subnet. 
26. The Web server receives the TCP SYN segment.  
For the end-to-end delivery of the TCP SYN segment, the following has occurred: 
The Web client sent the TCP SYN segment, and Router 1 and Router 3 forwarded it over the 
2001:DB8:0:13::/64, 2001:DB8:0:21::/64, and 2001:DB8:0:48::/64 subnets to the Web server. 
The Web client's destination cache has a new entry for 2001:DB8:0:48::3. 
Router 1's destination cache has a new entry for 2001:DB8:0:48::3. Router 1's neighbor cache has a 
new entry for FE80::E. 
Router 3's destination cache has an entry for 2001:DB8:0:48::3. Router 3's neighbor cache has entries 
for FE80::B and 2001:DB8:0:48::3. 
The Web server's neighbor cache has an entry for FE80::F. 
TCP SYN-ACK Segment to the Web Client 
When the Web server sends the TCP SYN-ACK segment to the Web client, the following process 
occurs: 
1. The Web server constructs a TCP SYN-ACK segment with the source IPv6 address of 
2001:DB8:0:48::3 and the destination IPv6 address of 2001:DB8:0:13::1. 
2. The Web server checks its destination cache for an entry for the IPv6 address of 2001:DB8:0:13::1 
and does not find a match. 
3. The Web server performs the route determination process to find the closest matching route for the 
destination IPv6 address of 2001:DB8:0:13::1. The default route (::/0) is the closest matching route. 
The Web server sets the next-hop IPv6 address to FE80::F and the next-hop interface to the network 
adapter attached to the 2001:DB8:0:48::/64 subnet. 
4. The Web server updates its destination cache with an entry for 2001:DB8:0:13::1 with the next-hop 
IPv6 address of FE80::F and the next-hop interface of the network adapter that is attached to the 
2001:DB8:0:48::/64 subnet. 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 310 
5. The Web server checks its neighbor cache for an entry with the IPv6 address of FE80::F and finds a 
match. 
6. Using the neighbor cache entry for FE80::F, the Web server sends the unicast TCP SYN-ACK 
segment destined for 2001:DB8:0:13::1 to the MAC address of Router 3's interface on the 
2001:DB8:0:48::/64 subnet. 
7. Router 3 receives the TCP SYN-ACK segment, checks its destination cache for an entry for 
2001:DB8:0:13::1, and does not find a match. 
8. Router 3 performs the route determination process for the destination address 2001:DB8:0:13::1. The 
closest matching route is the route for 2001:DB8:0:13::/64. Router 3 sets the next-hop address to 
FE80::B and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:21::/64 
subnet. 
9. Router 3 updates its destination cache with an entry for 2001:DB8:0:13::1 with the next-hop IPv6 
address of FE80::B and the next-hop interface of the network adapter that is attached to the 
2001:DB8:0:21::/64 subnet. 
10. Router 3 checks its neighbor cache for an entry with the IPv6 address of FE80::B and finds a match. 
11. Using the neighbor cache entry for FE80::B, Router 3 forwards the unicast TCP SYN-ACK segment 
destined for 2001:DB8:0:13::1 to Router 1's MAC address on the 2001:DB8:0:21::/64 subnet. 
12. Router 1 receives the TCP SYN-ACK segment, checks its destination cache for an entry for 
2001:DB8:0:13::1, and finds a match. 
13. Using the destination cache entry for 2001:DB8:0:13::1, Router 1 sets the next-hop address to 
2001:DB8:0:13::1 and the next-hop interface to the network adapter that is attached to the 
2001:DB8:0:13::/64 subnet. 
14. Router 1 checks its neighbor cache for an entry with the IPv6 address of 2001:DB8:0:13::1 and finds 
a match. 
15. Using the neighbor cache entry for 2001:DB8:0:13::1, Router 1 forwards the unicast TCP SYN-ACK 
segment destined for 2001:DB8:0:13::1 to the MAC address of the Web client's interface on the 
2001:DB8:0:13::/64 subnet. 
16. The Web client receives the TCP SYN-ACK segment.  
For the end-to-end delivery of the TCP SYN-ACK segment, the following has occurred: 
The Web server sent the TCP SYN-ACK segment, and Router 3 and Router 1 forwarded it over the 
2001:DB8:0:48::/64, 2001:DB8:0:21::/64, and 2001:DB8:0:13::/64 subnets to the Web client. 
The Web server's destination cache has a new entry for 2001:DB8:0:13::1. 
Router 3's destination cache has a new entry for 2001:DB8:0:13::1. 
TCP ACK Segment to the Web Server 
When the Web client sends the TCP ACK segment to the Web server, the following process occurs: 
1. The Web client constructs a TCP ACK segment message with the source IPv6 address of 
2001:DB8:0:13::1 and the destination IPv6 address of 2001:DB8:0:48::3. 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 311 
2. The Web client checks its destination cache for an entry for the IPv6 address of 2001:DB8:0:48::3 
and finds a match. 
3. Using the destination cache entry for 2001:DB8:0:48::3, the Web client sets the next-hop address to 
FE80::A and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:13::/64 
subnet. 
4. The Web client checks its neighbor cache for an entry with the IPv6 address of FE80::A and finds a 
match. 
5. Using the neighbor cache entry for FE80::A, the Web client sends the unicast TCP ACK segment 
destined for 2001:DB8:0:48::3 to the MAC address of Router 1's interface on the 2001:DB8:0:13::/64 
subnet. 
6. Router 1 receives the TCP ACK segment, checks its destination cache for an entry for 
2001:DB8:0:48::3, and finds a match. 
7. Using the destination cache entry for 2001:DB8:0:48::3, Router 1 sets the next-hop address to 
FE80::E and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:21::/64 
subnet. 
8. Router 1 checks its neighbor cache for an entry with the IPv6 address of FE80::E and finds a match. 
9. Using the neighbor cache entry for FE80::E, Router 1 forwards the unicast TCP ACK segment 
destined for 2001:DB8:0:48::3 to Router 3's MAC address on the 2001:DB8:0:21::/64 subnet. 
10. Router 3 receives the TCP ACK segment, checks its destination cache for an entry for 
2001:DB8:0:48::3, and finds a match. 
11. Using the destination cache entry for 2001:DB8:0:48::3, Router 3 sets the next-hop address to the 
packet's destination address of 2001:DB8:0:48::3 and the next-hop interface to the network adapter 
that is attached to the 2001:DB8:0:48::/64 subnet. 
12. Router 3 checks its neighbor cache for an entry with the IPv6 address of 2001:DB8:0:48::3 and finds 
a match. 
13. Using the neighbor cache entry for 2001:DB8:0:48::3, Router 3 forwards the unicast TCP ACK 
segment destined for 2001:DB8:0:48::3 to the MAC address of the Web server's interface on the 
2001:DB8:0:47::/64 subnet. 
14. The Web server receives the TCP ACK segment.  
15. Windows Sockets indicates to the Web browser that the requested TCP connection is complete. 
The Web client sent the TCP ACK segment, and Router 1 and Router 3 forwarded it over the 
2001:DB8:0:13::/64, 2001:DB8:0:21::/64, and 2001:DB8:0:48::/64 subnets to the Web server. 
HTTP Get Segment to the Web Server 
When the Web client sends the HTTP Get message to the Web server, the following process occurs: 
1. When the Web browser receives the indication that the TCP connection is complete, it constructs an 
HTTP Get message with the source IPv6 address of 2001:DB8:0:13::1 and the destination IPv6 
address of 2001:DB8:0:48::3, requesting the contents of the Web page from the Web server. 
2. The Web client checks its destination cache for an entry for the IPv6 address of 2001:DB8:0:48::3 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 312 
and finds a match. 
3. Using the destination cache entry for 2001:DB8:0:48::3, the Web client sets the next-hop address to 
FE80::A and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:13::/64 
subnet. 
4. The Web client checks its neighbor cache for an entry with the IPv6 address of FE80::A and finds a 
match. 
5. Using the neighbor cache entry for FE80::A, the Web client sends the unicast HTTP Get message 
destined for 2001:DB8:0:48::3 to the MAC address of Router 1's interface on the 2001:DB8:0:13::/64 
subnet. 
6. Router 1 receives the HTTP Get message, checks its destination cache for an entry for 
2001:DB8:0:48::3, and finds a match. 
7. Using the destination cache entry for 2001:DB8:0:48::3, Router 1 sets the next-hop address to 
FE80::E and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:21::/64 
subnet. 
8. Router 1 checks its neighbor cache for an entry with the IPv6 address of FE80::E and finds a match. 
9. Using the neighbor cache entry for FE80::E, Router 1 forwards the unicast HTTP Get message 
destined for 2001:DB8:0:48::3 to Router 3's MAC address on the 2001:DB8:0:21::/64 subnet. 
10. Router 3 receives the HTTP Get message, checks its destination cache for an entry for 
2001:DB8:0:48::3, and finds a match. 
11. Using the destination cache entry for 2001:DB8:0:48::3, Router 3 sets the next-hop address to the 
packet's destination address of 2001:DB8:0:48::3 and the next-hop interface to the network adapter 
that is attached to the 2001:DB8:0:48::/64 subnet. 
12. Router 3 checks its neighbor cache for an entry with the IPv6 address of 2001:DB8:0:48::3 and finds 
a match. 
13. Using the neighbor cache entry for 2001:DB8:0:48::3, Router 3 forwards the unicast HTTP Get 
message destined for 2001:DB8:0:48::3 to the MAC address of the Web server's interface on the 
2001:DB8:0:47::/64 subnet. 
14. The Web server receives the HTTP Get message.  
The Web client sent the HTTP Get message, and Router 1 and Router 3 forwarded it over the 
2001:DB8:0:13::/64, 2001:DB8:0:21::/64, and 2001:DB8:0:48::/64 subnets to the Web server. 
HTTP Get-Response Segment to the Web Client 
When the Web server sends the HTTP Get-Response message to the Web client, the following occurs: 
1. The Web server constructs an HTTP Get-Response message with the source IPv6 address of 
2001:DB8:0:48::3 and the destination IPv6 address of 2001:DB8:0:13::1. 
2. The Web server checks its destination cache for an entry for the IPv6 address of 2001:DB8:0:13::1 
and finds a match. 
3. Using the destination cache entry for 2001:DB8:0:13::1, the Web server sets the next-hop IPv6 
address to FE80::F and the next-hop interface to the network adapter attached to the 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 313 
2001:DB8:0:48::/64 subnet. 
4. The Web server checks its neighbor cache for an entry with the IPv6 address of FE80::F and finds a 
match. 
5. Using the neighbor cache entry for FE80::F, the Web server sends the unicast HTTP Get-Response 
message destined for 2001:DB8:0:13::1 to the MAC address of Router 3's interface on the 
2001:DB8:0:48::/64 subnet. 
6. Router 3 receives the HTTP Get-Response message, checks its destination cache for an entry for 
2001:DB8:0:13::1, and finds a match. 
7. Using the destination cache entry for 2001:DB8:0:13::1, Router 3 sets the next-hop address to 
FE80::B and the next-hop interface to the network adapter that is attached to the 2001:DB8:0:21::/64 
subnet. 
8. Router 3 checks its neighbor cache for an entry with the IPv6 address of FE80::B and finds a match. 
9. Using the neighbor cache entry for FE80::B, Router 3 forwards the unicast HTTP Get-Response 
message destined for 2001:DB8:0:13::1 to Router 1's MAC address on the 2001:DB8:0:21::/64 
subnet. 
10. Router 1 receives the HTTP Get-Response message. 
11. Router 1 checks its destination cache for an entry for 2001:DB8:0:13::1 and finds a match. 
12. Using the destination cache entry for 2001:DB8:0:13::1, Router 1 sets the next-hop address to 
2001:DB8:0:13::1 and the next-hop interface to the network adapter that is attached to the 
2001:DB8:0:13::/64 subnet. 
13. Router 1 checks its neighbor cache for an entry with the IPv6 address of 2001:DB8:0:13::1 and finds 
a match. 
14. Using the neighbor cache entry for 2001:DB8:0:13::1, Router 1 forwards the unicast HTTP Get-
Response message destined for 2001:DB8:0:13::1 to the MAC address of the Web client's interface 
on the 2001:DB8:0:13::/64 subnet. 
15. The Web client receives the HTTP Get-Response message.  
16. The Web browser constructs the visual representation of the Web page at 
http://web1.example.com/example.htm. 
The Web server sent the HTTP Get-Response message, and Router 3 and Router 1 forwarded it over 
the 2001:DB8:0:48::/64, 2001:DB8:0:21::/64, and 2001:DB8:0:13::/64 subnets to the Web client. 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 314 
Chapter Summary 
The key information in this chapter is the following: 
The end-to-end delivery process consists of a source host process, a router forwarding process, and a 
destination host process.  
To send an IPv4 packet, an IPv4 source host checks its route cache (performing route determination if 
needed) and then checks its ARP cache (performing address resolution if needed). When the source 
host has determined the MAC address that corresponds to the next-hop address for the IPv4 packet, 
the host sends the packet to the destination or to an intermediate router. 
To forward an IPv4 packet, an IPv4 router decrements the TTL, updates the checksum, checks its route 
cache (performing route determination if needed) and then checks its ARP cache (performing address 
resolution if needed). When the router has determined the MAC address that corresponds to the next-
hop address for the IPv4 packet, the router forwards the packet to the destination or to another router. 
To receive an IPv4 packet, an IPv4 destination host verifies that the packet is addressed to an IPv4 
address that has been assigned to the host and then passes the IPv4 payload to the appropriate upper 
layer protocol. For TCP and UDP traffic, the host passes the data to the listening application. 
To send an IPv6 packet, an IPv6 source host checks its destination cache (performing route 
determination if needed) and then checks its neighbor cache (performing address resolution if needed). 
When the source host has determined the MAC address that corresponds to the next-hop address for 
the IPv6 packet, the host sends the packet to the destination or to an intermediate router. 
To forward an IPv6 packet, an IPv6 router decrements the hop limit, checks its destination cache 
(performing route determination if needed) and then checks its neighbor cache (performing address 
resolution if needed). When the router has determined the MAC address that corresponds to the next-
hop address for the IPv6 packet, the router forwards the packet to the destination or to another router. 
To receive an IPv6 packet, an IPv6 destination host verifies that the packet is addressed to an IPv6 
address assigned to the host and then passes the IPv6 payload to the appropriate upper layer protocol. 
For TCP and UDP traffic, the host passes the data to the listening application. 
Chapter 10 – TCP/IP End-to-End Delivery 
TCP/IP Fundamentals for Microsoft Windows  
Page: 315 
Chapter Glossary 
ARP cache – A table for each interface of static or dynamically resolved IPv4 addresses and their 
corresponding MAC addresses. 
default gateway –  The IPv4 address of a neighboring IPv4 router. Configuring a default gateway 
creates a default route in the IPv4 routing table. The default gateway is an important parameter for 
TCP/IP in Windows. 
default route – A route that is used when the routing table contains no other routes for the destination. 
For example, if a router or end system cannot find a network route or host route for the destination, the 
default route is used. The default route is used to simplify the configuration of end systems or routers. 
For IPv4 routing tables, the default route is the route with the network destination of 0.0.0.0 and the 
netmask of 0.0.0.0. For IPv6 routing tables, the default route has the prefix ::/0. 
destination cache – A table  in which IPv6 stores the next-hop IPv6 address and interface for recently 
determined destination IPv6 addresses. 
longest matching route – The algorithm  by which the route determination process selects the routes in 
the routing table that most closely match the destination address of the packet being sent or forwarded. 
neighbor cache – A cache that every IPv6 node maintains to store the on-subnet IPv6 addresses of 
neighbors and their corresponding MAC addresses. The neighbor cache is equivalent to the ARP cache 
in IPv4. 
next-hop determination – The process of determining the next-hop address and interface for sending or 