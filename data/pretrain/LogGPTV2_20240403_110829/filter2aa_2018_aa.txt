EXTRACTING CNG TLS/SSL ARTIFACTS FROM LSASS MEMORY
Jake Kambic
2016
Defcon
ii
TABLE OF CONTENTS
Page
LIST OF TABLES . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
iv
LIST OF FIGURES
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
v
LIST OF ACRONYMS & ABBREVIATIONS . . . . . . . . . . . . . . . . .
vii
LIST OF TERMS
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
ix
CHAPTER 1. INTRODUCTION . . . . . . . . . . . . . . . . . . . . . . . .
1
1.1
Statement of Problem
. . . . . . . . . . . . . . . . . . . . . . . . .
2
1.2
Signiﬁcance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
3
1.3
Research Question
. . . . . . . . . . . . . . . . . . . . . . . . . . .
4
1.4
Hypothesis . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4
1.5
Assumptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4
1.6
Limitations
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
5
1.7
Delimitations
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
5
CHAPTER 2. RELEVANT LITERATURE . . . . . . . . . . . . . . . . . .
7
2.1
Volatile Memory Analysis Frameworks
. . . . . . . . . . . . . . . .
8
2.2
Secure Socket Layer (SSL) & Transport Layer Security (TLS)
. . .
10
2.2.1
Handshake & Key Exchange . . . . . . . . . . . . . . . . . .
11
2.2.2
Perfect Forward Secrecy . . . . . . . . . . . . . . . . . . . .
14
2.2.3
Key Calculation . . . . . . . . . . . . . . . . . . . . . . . . .
16
2.2.4
Session Resumption . . . . . . . . . . . . . . . . . . . . . . .
17
2.3
Windows Internals
. . . . . . . . . . . . . . . . . . . . . . . . . . .
21
2.3.1
Memory Management . . . . . . . . . . . . . . . . . . . . . .
21
2.3.1.1
Virtual Address Space . . . . . . . . . . . . . . . .
22
2.3.1.2
Virtual Memory Allocation
. . . . . . . . . . . . .
24
2.3.2
TLS Implementation . . . . . . . . . . . . . . . . . . . . . .
24
2.3.2.1
DPAPI
. . . . . . . . . . . . . . . . . . . . . . . .
25
2.3.2.2
Key Isolation . . . . . . . . . . . . . . . . . . . . .
26
2.3.2.3
Schannel . . . . . . . . . . . . . . . . . . . . . . . .
27
2.4
Prior Work
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
30
2.4.1
Key Identiﬁcation . . . . . . . . . . . . . . . . . . . . . . . .
30
2.4.2
SSL/TLS Decryption . . . . . . . . . . . . . . . . . . . . . .
33
2.4.3
Key Extraction . . . . . . . . . . . . . . . . . . . . . . . . .
34
2.4.4
Perfect Forward Secrecy . . . . . . . . . . . . . . . . . . . .
37
iii
Page
CHAPTER 3. RESEARCH METHODOLOGY . . . . . . . . . . . . . . . .
39
3.0.1
Design Decisions
. . . . . . . . . . . . . . . . . . . . . . . .
39
3.0.2
Overview
. . . . . . . . . . . . . . . . . . . . . . . . . . . .
41
3.0.3
Discussion of Methods . . . . . . . . . . . . . . . . . . . . .
44
3.0.3.1
Searching for session keys . . . . . . . . . . . . . .
44
3.0.3.2
Identifying known values . . . . . . . . . . . . . . .
44
3.0.3.3
Intercepting master key generation . . . . . . . . .
45
3.0.3.4
Leveraging unique structure identiﬁers . . . . . . .
46
3.0.3.5
Walking pointers . . . . . . . . . . . . . . . . . . .
47
3.0.3.6
Comparing related structs to unique public values .
48
3.0.3.7
Debugging Local Security Authority Sub-System
.
49
3.0.3.8
Scanning Physical Memory
. . . . . . . . . . . . .
49
3.0.4
Infrastructure . . . . . . . . . . . . . . . . . . . . . . . . . .
49
3.0.5
Measure of Success . . . . . . . . . . . . . . . . . . . . . . .
52
3.1
Summary
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
53
CHAPTER 4. RESULTS & DISCUSSION . . . . . . . . . . . . . . . . . . .
54
4.1
Staging and Execution . . . . . . . . . . . . . . . . . . . . . . . . .
54
4.2
Heuristic Scanning for Advanced Encryption Standard (AES) keys .
56
4.3
Public Connection Values
. . . . . . . . . . . . . . . . . . . . . . .
61
4.4
Identiﬁed SSL Structures . . . . . . . . . . . . . . . . . . . . . . . .
64
4.5
Conﬁrming the master key . . . . . . . . . . . . . . . . . . . . . . .
77
4.6
Mapping master keys to session IDs . . . . . . . . . . . . . . . . . .
77
4.7
SSL Session Cache Items . . . . . . . . . . . . . . . . . . . . . . . .
80
4.8
Schannel Classes
. . . . . . . . . . . . . . . . . . . . . . . . . . . .
84
4.9
Schannel Parameters . . . . . . . . . . . . . . . . . . . . . . . . . .
85
4.10 Scanning Physical Memory . . . . . . . . . . . . . . . . . . . . . . .
87
4.11 Automating Extraction . . . . . . . . . . . . . . . . . . . . . . . . .
87
4.12 Decrypting a TLS session
. . . . . . . . . . . . . . . . . . . . . . .
90
CHAPTER 5. CONCLUSIONS . . . . . . . . . . . . . . . . . . . . . . . . .
92
5.1
Summary of Outcomes . . . . . . . . . . . . . . . . . . . . . . . . .
92
5.2
Contributions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
93
5.3
Anecdotes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
95
5.4
Future Work . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
95
LIST OF REFERENCES
. . . . . . . . . . . . . . . . . . . . . . . . . . . .
97
iv
LIST OF TABLES
Table
Page
3.1
Analysis infrastructure
. . . . . . . . . . . . . . . . . . . . . . . . . .
52
4.1
Ncryptsslp magic values to function mapping
. . . . . . . . . . . . . .
66
4.2
Client and server SSL cache time . . . . . . . . . . . . . . . . . . . . .
86
v
LIST OF FIGURES
Figure
Page
2.1
Volatility plug-in interface and address space abstraction (Ligh, Case,
Levy, & Walters, 2014) . . . . . . . . . . . . . . . . . . . . . . . . . . .
10
2.2
SSL/TLS Handshake (Dierks & Allen, 1999; Freier, Karlton, & Kocher,
2011; Microsoft, 2003a) . . . . . . . . . . . . . . . . . . . . . . . . . . .
13
2.3
TLS master secret generation pseudo-code (Dierks & Allen, 1999; Dierks
& Rescorla, 2008) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
16
2.4
TLS session resumption abridged Handshake . . . . . . . . . . . . . . .
18
2.5
Session Ticket per RFC 5077
. . . . . . . . . . . . . . . . . . . . . . .
19
2.6
Microsoft Key Isolation paradigm (Microsoft, 2014b)
. . . . . . . . . .
27
2.7
Schannel SSP architecture (Microsoft, 2015d)
. . . . . . . . . . . . . .
28
3.1
TLS artifact identiﬁcation methodology . . . . . . . . . . . . . . . . . .
43
3.2
Analysis infrastructure logical diagram . . . . . . . . . . . . . . . . . .
51
4.1
Example connection parameters in Wireshark
. . . . . . . . . . . . . .
56
4.2
ssl3 tag to AES artifact adjacency . . . . . . . . . . . . . . . . . . . . .
58
4.3
Disassembled validateMSCryptSymmKey function (annotated) . . . . .
59
4.4