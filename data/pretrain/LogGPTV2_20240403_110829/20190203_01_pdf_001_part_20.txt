the secondary mouse button on the Subscription node and choose Update Subscription.
The Update Subscription dialog box appears.
Figure 5-43 - Update Subscription dialog box
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 218
EDB Postgres Replication Server User’s Guide
Step 4: If the publication server now runs on a host with a different IP address or port
number than what is shown in the dialog box, enter the correct information. You must
also enter the admin user name and password saved in the xDB Replication
Configuration file that resides on the host on which the publication server is running.
Click the Update button.
Figure 5-44 - Subscription successfully updated
Step 5: If Subscription Updated Successfully appears, click the OK button, otherwise
investigate the error and make the necessary corrections.
Step 6: If the publication server with the new network location manages publications
subscribed to by other subscriptions, repeat steps 1 through 5 for these other
subscriptions.
5.5.4 Enabling/Disabling Table Filters on a Subscription
Table filters must first be defined in a set of available table filters in the publication
before they can be enabled on a subscription. See Section 5.2.3 for information on
defining table filters in a single-master replication system.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 219
EDB Postgres Replication Server User’s Guide
The following are the steps for enabling or disabling table filters on an existing
subscription.
Step 1: Make sure the publication server whose node is the parent of the publication
associated with the subscription you wish to change is running and has been registered in
the xDB Replication Console you are using. See Section 5.2.1 for directions on starting
and registering a publication server. Make sure the subscription server whose node is the
parent of the subscription you wish to change is running and has been registered in the
xDB Replication Console you are using. See Section 5.3.1 for directions on starting and
registering a subscription server.
Step 2: Select the Subscription node of the subscription on which you wish to enable or
disable individual filter rules.
Figure 5-45 - Selecting a subscription on which to enable or disable filter rules
Step 3: Open the Filter Rules tab in any of the following ways:
 Choose Update Filter Rule from the Subscription menu.
 Click the secondary mouse button on the Subscription node and choose Update
Filter Rule.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 220
EDB Postgres Replication Server User’s Guide
Figure 5-46 - Opening the Filter Rules tab on a subscription
Step 4: In the Filter Rules tab check or uncheck the boxes to specify the filter rules to
enable or disable on the subscription. At most one filter rule may be enabled any given
subscription table. Click the Update button.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 221
EDB Postgres Replication Server User’s Guide
Figure 5-47 - Filter Rules tab
Step 5: A confirmation box appears presenting a warning message and a
recommendation to perform a snapshot replication to any subscription on which you
changed the filtering criteria.
Click the Ok button in the confirmation box to proceed with the update to the filter rule
selections. Click the Cancel button to return to the Filter Rules tab if you wish to modify
your filter rule selections.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 222
EDB Postgres Replication Server User’s Guide
Figure 5-48 - Change filter rule confirmation
Step 6: If you clicked the Ok button in the preceding step, the Filter Rules updated
successfully confirmation message appears if the update was successful.
Figure 5-49 - Successful update of filter rules
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 223
EDB Postgres Replication Server User’s Guide
If you clicked the Cancel button in the preceding step, the Filter Rules tab reopens. You
can modify your filter rule selections by repeating Step 4, or you can click the Cancel
button in the Filter Rules tab to abort the filter rule updates on the subscription.
Step 7: It is strongly recommended that a snapshot replication be performed to the
subscription that contains tables on which the filtering criteria has changed.
A snapshot ensures that the content of the subscription tables is consistent with the
updated filtering criteria. See Section 5.4.1 for information on performing a snapshot
replication.
5.5.5 Removing a Subscription
After a subscription is removed, replication can no longer occur for the publication that
was associated with it until the publication is subscribed to with a new subscription.
Removing a subscription does not delete the subscription tables in the subscription
database. It removes the identity and association of these tables to xDB Replication
Server so the tables remain in the database until the DBA deletes them with DROP TABLE
SQL statements.
Step 1: Make sure the subscription server whose node is the parent of the subscription
you wish to remove is running and has been registered in the xDB Replication Console
you are using. See Section 5.3.1 for directions on starting and registering a subscription
server.
Step 2: Select the Subscription node of the subscription that you wish to remove.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 224
EDB Postgres Replication Server User’s Guide
Figure 5-50 - Selecting a subscription to remove
Step 3: Remove the subscription in any of the following ways:
 Choose Remove Subscription from the Subscription menu.
 Click the secondary mouse button on the Subscription node and choose Remove
Subscription.
 Click the primary mouse button on the Remove Subscription icon.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 225
EDB Postgres Replication Server User’s Guide
Figure 5-51 - Removing the subscription using the toolbar
Step 4: In the Remove Subscription confirmation box, click the Yes button.
Figure 5-52 - Remove Subscription confirmation
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 226
EDB Postgres Replication Server User’s Guide
The Subscription node no longer appears under the Subscription Database node.
Figure 5-53 - Replication tree after removing a subscription
5.5.6 Removing a Subscription Database
Deleting a subscription database definition from xDB Replication Server is equivalent to
removing its Subscription Database node. Before a Subscription Database node can be
removed, all subscriptions under that Subscription Database node must be removed. See
Section 5.5.5 for removing a subscription.
Removing a Subscription Database node does not delete the physical database from the
database server. It removes the identity and association of the database to xDB
Replication Server so no further replications can create or update tables in the database
unless there are other subscription database definitions in xDB Replication Server with
the same host and database identifier. The physical database can only be removed using
the database management system’s database removal procedures.
Step 1: Make sure the subscription server whose node is the parent of the subscription
database definition you wish to remove is running and has been registered in the xDB
Replication Console you are using. See Section 5.3.1 for directions on starting and
registering a subscription server.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 227
EDB Postgres Replication Server User’s Guide
Step 2: Select the Subscription Database node that you wish to remove.
Figure 5-54 - Selecting a subscription database definition for removal
Step 3: From the Subscription menu, choose Subscription Database, then Remove
Database. Alternatively, click the secondary mouse button on the Subscription Database
node and choose Remove Subscription. The Remove Subscription Database confirmation
box appears.
Step 4: In the Remove Subscription Database confirmation box, click the Yes button.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 228
EDB Postgres Replication Server User’s Guide
Figure 5-55 - Remove Subscription Database confirmation
The Subscription Database node no longer appears under the Subscription Server node.
Figure 5-56 - Replication tree after removal of a subscription database
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 229
EDB Postgres Replication Server User’s Guide
5.6 Performing Controlled Switchover
Controlled switchover is the exchanging of roles between a publication database and a
subscription database. That is, the tables that were formerly publications become the
subscription tables. The former subscription tables now become the publications.
Controlled switchover is useful for situations where the publication database must be
taken offline such as for periodic maintenance. After the switchover, applications connect
to the former subscription database to perform their queries and updates, while the former
publication database is kept synchronized by replication.
Updates for replication are accumulated in shadow tables that are created on the former
subscription tables during the controlled switchover procedure. When the former
publication database is online, it is synchronized as the target of replication.
When you determine that you want to reverse the roles again so that the original
publication database directly receives queries and updates from applications, and the
original subscription database receives updates by replication, you perform the controlled
switchover procedure once again, switching the roles back.
Note: This discussion assumes that the trigger-based method of synchronization
replication is used by the publication database. If the publication database employs the
log-based method, then it must be determined if the current subscription database meets
the criteria for using the log-based method if that is so desired when it is switched to the
role of the publication database. If the subscription database does not meet the criteria,
then the trigger-based method must be implemented and used. See Section 2.2.10 for
information on the log-based method and the necessary configuration steps that must be
performed if the log-based method is to be used.
5.6.1 Controlled Switchover Overview
When you perform controlled switchover, you are modifying the replication system so
that the database identified and referenced in the control schema as the publication
database is the physical database that was originally defined as the subscription database.
Similarly, the database identified and referenced in the control schema as the subscription
database is changed to the physical database on which the publication was originally
defined.
You must also create the database objects on the former subscription database that xDB
Replication Server uses to capture and store updates for replication.
In order to accomplish the controlled switchover, the following tasks must be performed:
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 230
EDB Postgres Replication Server User’s Guide
 Copy the control schema of the publication database (that is, all control schema
objects, shadow tables, sequences, triggers, and a package) to the subscription
database.
 Copy the control schema of the subscription database to the publication database.
 Update certain control schema tables so as to exchange the connection
information for the publication database and subscription database. These
updates must be made in the control schema of all publication databases to
ensure consistency of the control schema across all publication databases.
 Modify the xDB Replication Configuration file to reference a new controller
database if the former publication database was the designated controller
database.
5.6.2 Controlled Switchover Steps
This section describes the steps for performing a controlled switchover.
The following assumptions are made about the replication system environment:
 “Node 1” is the server where the publication database originally resides. Its
network IP address is 192.168.2.19.
 “Node 2” is the server where the subscription database originally resides. Its
network IP address is 192.168.2.20.
 The publication and subscription databases have the same name.
 You use the publication database user for the role of the subscription database
user and the subscription database user for the role of the publication database
user in the switched environment.
 The publication server and subscription server are running on the same host (node
1).
Step 1: Stop all transaction processing against the publication database.
Step 2: Perform an on demand synchronization replication or a snapshot replication (for
snapshot-only publications) in order to replicate any pending updates in the publication
database shadow tables to the subscription database.
Step 3: Stop the publication server and the subscription server.
Step 4: Review the prerequisites in Section 5.1 to ensure that the subscription database
and its host can be used in the role of a publication database, and the publication database
and its host can be used in the role of a subscription database.
For practical purposes, the following items are the most likely to be affected:
 The publication database user must be a superuser with system catalog
modification privileges to allow it to act as the new subscription database user.
 Additional entries may be needed in the pg_hba.conf files.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 231
EDB Postgres Replication Server User’s Guide
Step 5: Create a backup of schemas _edb_replicator_pub,
_edb_replicator_sub, and _edb_scheduler from the publication database on node
1.
Delete these schemas from the publication database on node 1 after the backup has been
made.
Step 6: Create a backup of the replication triggers and their corresponding trigger
functions on the publication tables on node 1. For the trigger-based method, these triggers
are named with prefixes of rrpd_, rrpi_ and rrpu_. The trigger functions are named
with the same prefixes. For the log-based method, a trigger for each table is prefixed with
rrpt_. The function is named capturetruncateevent.
Delete or disable these triggers on node 1.
Step 7: Create a backup of schema _edb_replicator_sub from the subscription
database on node 2.
Delete this schema from the subscription database on node 2 after the backup has been
made.
Step 8: Restore the backups of schemas _edb_replicator_pub,
_edb_replicator_sub, and _edb_scheduler created in Step 5 to the subscription
database on node 2. Also restore the backup of the replication triggers and trigger
functions created in Step 6 to the subscription database on node 2.
Step 9: Restore the backup of schema _edb_replicator_sub created in Step 7 to the
publication database on node 1.
Step 10: Update the control schema objects so that the publication database definition
references the new publication database (that is, the former subscription database) on
node 2 and the subscription database definition references the new subscription database
(that is, the former publication database) on node 1.
The connection information that may require updating includes the following:
 Host IP address
 Port number
 User name
 Password
These updates must be made in the control schema of all publication databases to
ensure consistency of the control schema information should the controller database
be switched at some later point in time.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 232
EDB Postgres Replication Server User’s Guide
For example, the following shows the update to the publication database definition so that
its network IP address is now node 2 (192.168.2.20).
UPDATE _edb_replicator_pub.xdb_pub_database SET db_host = '192.168.2.20';
The following shows the update to the subscription database definition so that its network
IP address is now node 1 (192.168.2.19).
UPDATE _edb_replicator_sub.xdb_sub_database SET db_host = '192.168.2.19';
Step 11: If you decide to use a publication server or subscription server on a new host,
perform the following step, otherwise go to Step 12.
The following example assumes you decide to use the publication server and subscription
server running on node 2.
Update the subscription metadata to the new location of the publication server managing
its associated publication.
UPDATE _edb_replicator_sub.xdb_subscriptions SET pub_server_ip =
'192.168.2.20';
Update the publication metadata to the new location of the subscription server managing
its associated subscription.
UPDATE _edb_replicator_pub.xdb_sub_servers SET sub_server_ip =
'192.168.2.20';
Step 12: Edit the xDB Replication Configuration file on the publication server and
subscription server host so that it contains the controller database connection and
authentication information for the new publication database now running on node 2.
The following is the modified xDB Replication Configuration file with the network
location and authentication information of the new controller database now running on
node 2.
#xDB Replication Server Configuration Properties
#Fri Jan 30 17:34:06 GMT-05:00 2015
port=5444
admin_password=ygJ9AxoJEX854elcVIJPTw\=\=
user=enterprisedb
admin_user=enterprisedb
type=enterprisedb
database=edb
password=ygJ9AxoJEX854elcVIJPTw\=\=
host=192.168.2.20
Step 13: Update the pg_hba.conf files of the database servers to allow access to the
subscription database now on node 1 and the publication database now on node 2 in
accordance with Section 5.1.6.3.
Copyright © 2010 - 2018 EnterpriseDB Corporation. All rights reserved. 233
EDB Postgres Replication Server User’s Guide
Step 14: When using the log-based method, create a replication slot on the database
server that now contains the publication database.
Use the following query to obtain the slot name from the database server that was
previously running the publication database, but is now the subscription database server:
SELECT slot_name FROM pg_replication_slots WHERE plugin = 'test_decoding';
slot_name
-------------
xdb_47919_5
(1 row)
Create a new replication slot on the database server that is now running the publication
database, but was previously the subscription database server. The slot name from the
previous query is used when creating the new replication slot.
SELECT pg_create_logical_replication_slot('xdb_47919_5', 'test_decoding');
pg_create_logical_replication_slot
------------------------------------
(xdb_47919_5,0/37A1270)
(1 row)
You may choose to keep the replication slot on the database server that now contains the
subscription database, particularly if you plan to switch the publication and subscription
databases back to their original roles at some future point. This eliminates the necessity
for recreating the replication slot since it will still exist, but will be inactive until the
publication is switched back to that database server.
Alternatively, you can delete the replication slot from the database server that now
contains the subscription database. The replication slot is deleted with the following
command:
SELECT pg_drop_replication_slot('xdb_47919_5');
See Section 10.3.4.4 for additional information on deleting the replication slot if the
pg_drop_replication_slot function is not successful. If you switch back the
databases to their original roles, you will just have to recreate the replication slot on the
publication database server as previously described in this step.
Step 15: The controlled switchover is now complete. Start the publication server and the
subscription server.
Step 16: After confirming that the publication tables are consistent with the subscription
tables, the first replication operation must be a snapshot. After performing a snapshot,
synchronization replications may be performed.