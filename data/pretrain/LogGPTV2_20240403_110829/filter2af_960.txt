# Evernote Chrome 扩展漏洞分析

##### 译文声明
本文为翻译文章，原文作者为 guard，来源于 guard.io。具体表达及含义请以原文为准。

## 0x00 前言
2019年5月，Guardio研究团队发现了一个严重的逻辑缺陷，该缺陷存在于Evernote Web Clipper Chrome插件中。利用此漏洞，攻击者能够绕过域名隔离机制，以用户身份执行代码，从而访问用户的敏感信息（不仅限于Evernote自身的数据）。这包括但不限于金融、社交媒体和个人邮件等信息。此通用型XSS漏洞的编号为CVE-2019-12592。

一旦成功利用该漏洞，当用户访问受控网站时，第三方站点就能窃取访问者的私密数据。Guardio在概念验证（PoC）中展示了如何利用此漏洞来获取社交媒体内容（读取和发布）、金融交易记录和个人购物清单等信息。由于Guardio及时报告了这一问题，Evernote迅速响应并在几天内发布了修复补丁的新版本。

## 0x01 背景
随着互联网技术的发展，现代用户越来越多地依赖浏览器直接提供的服务而不再需要下载可执行文件或安装专门的应用程序。尤其是在社交账号管理、在线购物以及金融服务领域，这种趋势尤为明显。

然而，这也给应用程序开发者带来了新的挑战。为了提供更好的用户体验，某些工具需要更多权限去访问各种资源，这就使得浏览器扩展变得至关重要。虽然初衷是为了提升用户体验，但这些扩展通常具有广泛的敏感数据访问权限，因此与传统网站相比，它们可能带来更大的安全风险。

在一次安全研究过程中，Guardio的研究人员发现了Evernote Web Clipper Chrome扩展中的一个严重漏洞。考虑到Evernote拥有庞大的用户基础（当时约有460万用户），这个问题的影响范围非常广泛。与其他已知的扩展漏洞（例如Grammarly的安全漏洞）不同的是，这次的问题不仅仅影响到用户的Evernote账户，而是直接威胁到了第三方服务的安全性。

## 0x02 概念验证（PoC）
为了展示攻击者如何利用这个漏洞，Guardio发布了一个PoC演示视频，说明了如何静默地窃取用户的敏感信息。结合几个关键步骤后，可以看到惊人的攻击效果：

1. 用户浏览由攻击者控制的恶意网页（如虚假的社交媒体登录页、钓鱼邮件链接或者恶意博客评论）；
2. 该恶意网页悄悄加载一个隐藏且合法的目标站点`iframe`标签；
3. 利用漏洞，攻击者可以将自定义的payload注入所有`iframe`上下文中；
4. 注入的payload针对每个目标网站进行了定制化处理，用于窃取cookies、凭证、私人资料以及冒充用户进行操作。

## 0x03 漏洞细节
要理解这个漏洞的具体情况，我们需要先了解一下Evernote Web Clipper Chrome插件是如何与页面及其框架交互的。

Evernote的代码注入链始于其`manifest.json`文件，在这里定义了`BrowserFrameLoader.js`内容脚本，并通过`all_frames`指令将其注入到所有的网页和框架中。值得注意的是，这是唯一使用这种方式注入的脚本，目的是减少潜在的攻击面。该脚本的主要作用是作为小型命令与控制服务器，根据需求向页面加载其他代码。

通信方面，该脚本通过`postMessage` API实现窗口间的消息传递。对于几种特定类型的消息，它提供了处理接口，其中包括`installAndSerializeAll`命令，该命令会触发第二阶段的`FrameSerializer.js`执行序列化任务。尽管这种机制本身并不构成漏洞，但由于采用了较弱的身份验证方案，它可以成为后续攻击链的一部分，在网站沙箱环境中运行的脚本可以通过发送消息来触发进一步的操作。其中涉及的关键参数（例如`resourcePath`和`target`）可以在请求消息中作为负载字段传递。

原本`_getBundleUrl`函数的设计意图是为扩展命令空间生成有效的URL（格式类似于`chrome-extension://...`），但由于编码上的疏忽加上缺乏对输入数据的有效过滤，攻击者可以通过操纵前面提到的`resourcePath`参数来篡改最终生成的URL首部。

综合以上各点形成完整的攻击链路后，远程攻击者只需简单地发出一条`window.postMessage`命令，便能将自己的恶意脚本载入至任意网站的上下文中。借助Evernote现有的注入架构，攻击者能够在不违反跨源策略的情况下将恶意代码植入到页面的所有目标框架内，进而实施通用型XSS攻击。一旦得手，除了Guardio在向Evernote提交的PoC中所展示的一些场景外，攻击者还可以开展更广泛的非法活动。

## 0x04 缓解措施
目前，Evernote已经发布了修复补丁，并通过更新版7.11.1向用户推送了修正后的软件。建议各位用户检查自己是否已安装最新版本（可通过访问Chrome扩展管理页面`chrome://extensions/?id=pioclpoplcdbaefihamjohnefbikjilc`确认，出于安全考虑，请手动复制地址并粘贴到浏览器地址栏）。

此次事件再次提醒我们重视浏览器扩展的安全性问题，仅从可信来源安装扩展是非常重要的。因为即便只有一个存在安全隐患的插件也可能对用户的在线隐私造成极大损害，比如泄露财务记录、社交媒体账号和个人电子邮件等重要信息。

## 0x05 时间线
以下是Evernote对此问题的响应过程概览：
- 2019年5月27日：首次报告漏洞
- 2019年5月28日：收到官方回复邮件
- 同日：确认存在问题并将之归类为安全漏洞
- 2019年5月29日：在Evernote的安全公告板上提及此事
- 2019年5月31日：发布修复版本Evernote Web Clipper 7.11.1
- 2019年6月4日：确认问题已被彻底解决