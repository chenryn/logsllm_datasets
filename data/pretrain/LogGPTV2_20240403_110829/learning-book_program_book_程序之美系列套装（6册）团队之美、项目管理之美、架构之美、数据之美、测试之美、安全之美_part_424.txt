## Page 2456
击开始到入侵成功只需要儿秒的时间，任何非自动化的内联阻塞响
应根本无济于事。因此，把注意力集中在带外事件可以提高我们的
效率，因为我们只要处理真正的事件就可以了。这种技巧不仅对于
端虫有效，而且适用于各种类型的恶意软件和其他攻击。为了允许
根据方向性进行监测，我们可以对警告进行过滤或者对签名进行重
新配置，只报告在自己的网络中进行扩散的事件。经过微小的调整
之后，安全从业人员可以把每次遇到攻击尝试时都会发出警告的签
名转变为可靠地检测需要付诸行动的安全事件的签名。
安全从业人员还使用了许多其他技巧对来自IDP技术的结果进行调
整，最大限度地提高效率。但是，根据我们的经验，即使采用最有
效的技巧，IDP所能产生的最好结果就是能够发现在自己的网络上所
发生的32%的安全事件。虽然许多安全从业人员相信他们使用了IDP
技术有效地对他们的环境进行看监测。但是，他们还需要使用其他
技术和技巧，寻找其他68%的安全事件。
11根据我们对世界上数百个企业的监测，我们对得到验证的事件进
行了检查，确定了哪些发现归功于对它们的检测。根据我们的分
析，被确认的事件中只有32%来自于IDP的警告。
[2]虽然大部分厂商在螨虫露面之后很快推出了它的签名，但许多
IDP在Slammer出现之前就已经有了通用的SQL缓冲区溢出签名，可
以进行早期的检测。
14.2改进与上下文相关的检测
一种有效的改进检测功能的技巧是增加与上下文相关的信息，帮助
验证是否可以对攻击不予理会。我们可以观察来自IDP的另一个事件
的例子。如果我们有一台公共Web服务器，我们可以确保它每大对
漏洞进行扫描，甚至更勤快。大多数IDP拥有数以千计的签名，能够
检测不同的攻击。下面是一些Snort签名，一般是在Web服务器遭到
攻击时被触发的：
WEB-IIS ISAPLida attempt
WEB-IIS cmd.exe access
WEB-IIS msadcs.dll access
2455
---
## Page 2457
这些签名是否都是应该付诸行动的事件？也许是。这些签名可能提
示一次失败的攻击尝试，但是也可能表示一次对Web服务器的成功
入侵。问题是，根据这些签名，失败的尝试和成功的入侵看上去可
能是完全一样的。我们需要更多的信息来判断攻击是否成功。通过
结合方向性的考量，如果web服务器开始启动对Internet上其他主机的
攻击，就可以证实人侵是成功的。但是，如果攻击者的痕迹更为微
妙，我们可能需要寻找其他提示入侵成功的蛛丝马迹。
一个稳定的上下文信息来源是防火墙或路由器的日志。这些日志一
般记录了一台主机是什么时候以什么方式连接到另一台主机。例
如，主机A通过TCP端口80到主机B的连接很可能表示主机A访问主
机B上的Web服务器。另外，取决于流量日志的来源，我们还可能看
到在会话中所传输的字节、会话被接受还是被拒绝、NAT转换以及
其他信息片段。准确地知道在出现了问题的主机之间还发生了什么
对于确定攻击的本质是极为关键的，它可以提供成功入侵的证据。
例如，我们可以想象一下，有一次攻击被IDP和防火墙所记录，日志
里留下了下面的内容：
1）IDP根据多个被触发的签名，记录了主机A通过TCP端口80对主机
B发起攻击。
2）防火墙把这次流量记录为主机A通过TCP端口80连接到主机B。
3）防火墙接着记录了主机B通过TCP端口21（TCP）连接到主机A，
下载一个工具包或肉鸡恶意代码。
IDP设备不太可能对第3个连接发出警告，因为这次流量看上去是极
为普通的。但是，当这个连接紧随这次攻击之后发生时，就强有力
地证明了这次攻击是成功的，因为在入侵之后发生了连接到攻击者
的FTP会话。对于经常受到攻击的Web服务器而言，分析师如果只参
考IDP警告，就经常需要猜测攻击是否成功。攻击之后的流量是攻击
痕迹的一个关键部分，可以轻易地把一个预想的假阳性或者低优先
级的事件转变为确定的入侵。简单地通过在IDP日志中增加额外的与
上下文有关的信息，可以把检测率大约提高40%。
14.2.1用流量分析提高覆盖率
IDP的另一个重大局限性是它们只能找到已经存在签名的攻击。新的
威胁和漏洞以令人惊异的速度不断增长，常常要求对签名进行更新
2456
---
## Page 2458
才能保证检测。根据Symantec的Internet安全威胁报告口l，Symantec
在2007年的下半年共报告了499，811例新的恶意代码，比2006年上
半年增加了567%。对于每个新威胁而言，从它在Internet上的初次露
面到出现能够检测到它的存在的签名之间可能存在一段时间。即使
是最优秀的IDP技术，这段窗口期的长度也可以持续几小时甚至几
周。以W32.Gaobot螨虫为例，2004年共编写并释放了这个端虫的几
十种变型。如果发动攻击时所使用的是IDP的签名并不匹配的变型，
结果会怎么样呢？如果我们完全依赖IDP进行检测，可能会对许多攻
击视而不见。除了根据签名观察单独的数据包之外，如果我们对一
段时间内主机之间的交互情况进行分析又会有什么效果呢？如果我
们能够用一种足够实时的方式对日志进行组织，有些常见的攻击模
型就会清晰地浮现在我们面前。例如，每个被Slammer感染的系统很
容易辨认，因为它试图在一个非常短的时期内通过1434/udp端口连
接到数以千计的其他主机。由于两个原因，这种行为被认为是不正
常的：1）主机一般不会通过1434/udp端口连接到大量的其他主机。
2）通过1434/udp端口的连接频繁非常高。通过分析我们所保护的主
机在一段时期内相互之间的连接情况，很可能会发现不需要依赖已
知签名的可疑流量。例如，考虑下面这些情况：
不是非常可疑
主机A通过TCP端口25（SMTP）连接到主机B
更加可疑
主机A通过TCP端口25（SMTP）连接到1000台不同的主机
第1个例子看不出有什么恶意，很可能表示一台主机试图连接到一台
邮件服务器以发送邮件。但是，第2个例子可能表示截然不同的事
件。如果主机A是一台邮件服务器，这很可能也是正常的活动，因为
邮件服务器频繁向Intermet上的其他主机发送电子邮件属于预期行
为。但是，如果主机A并不是邮件服务器，这个行为就变得非常可
凝，很可能表示使用SMTP作为感染向其他主机进行自身扩散的恶意
代码。让我们观察另外一个例子：
其他信息
主机A通过TCP端口25（SMTP）连接到100万台不同的主机
2457
---
## Page 2459
首先，我们重新分析主机A是一台邮件服务器的情形。这可能表示主
机A发送了过量的合法邮件。另一方面，如果邮件服务器除了为企业
发送正常的邮件之外还被垃圾邮件发送者所劫持，向世界上数以百
万计的人们发送垃圾邮件，情况又会怎么样呢？为了警告类似这样
的事件，我们还必须把流量作为检测标准的一部分。由于每台服务
器和每个企业可能具有不同层次的活动量，因此用一个固定的门槛
表示预期的连接很难产生良好的效果。
但是，一种可以采取的技巧是为主机A在一段时间内的正常邮件活动
设立一条基线，并确定它的合理变化范围。假设我们确定主机A在30
天内平均每天建立50万个连接，标准差为24小时的窗口期内10万个
连接。如果在一个后续的24小时窗口期内，我们检测到主机A建立了
100万个连接，这个统计数字提示这个连接量远远超过了平均值，要
求进一步的检测。虽然这个技巧会出现假阳性，因为流量出现异常
波动的可能性也是存在的。但是，它可以检测出那些用其他方式检
测将会忽略的事件。我们发现这个技巧对于检测那些垃圾邮件发送
者所使用或者受到某种类型的DOS攻击错误配置的邮件服务器非常
有效。
IDP在具有详细的签名时可以实现精确的检测，但这个特性也可能使
它们对那些同等有效的事件检测方式视而不见。反之，像上面这样
通过检查网络流量寻找不同寻常的流量模式，完全可以根据攻击者
与网络上其他主机的交互对攻击者进行有效的检测，而不必考虑是
否能够看到实际的攻击。这个技巧具有什么样的价值呢？考虑到恶
意负载尝试在人侵成功之后所采取的最常见活动之一就是搜索其他
存在漏洞的主机，光凭这个技巧就可以使企业内部的攻击检测率增
加大约66%。
[1]Symantec的Intermnet安全威胁报告，第13卷（2008年4月）。
14.2.2对监测列表进行综合分析
在过去的几年里，网络攻击的动机已经从获取名声转变为通过窃取
机密信息搜取经济利益。黑客们保护自己身份的隐蔽性并感染大量
的系统以进行非法交易为目标，创建了由被恶意软件感染的系统所
组成的网络，称为肉鸡网络，或简称为肉鸡。一个肉鸡可以由
Intermet上数百台、数千台甚至数万台属于未察觉的家庭用户和公司
的计算机所组成。它们一般都是在访问受感染的网站时由于客户端
的漏洞受到攻击而被黑客秘密接管控制的。每台被接管的计算机都
2458
---
## Page 2460
称为肉鸡，或称为"僵户”。它们都被安排与“母舰”系统（称为肉鸡
命令和控制服务器）中的一个或几个IP地址进行接触，通过一个独
特的通信渠道接收后所发出的命令。这种命令可能简单如在受感染
的主机上搜索信用卡信息，也可能复杂如针对一台目标Wweb服务器
并发地发动分布式拒绝服务攻击。
今天，肉鸡网络已经成为Intermet上的一个重大威胁：2007年下半
年，Symantec确认受到肉鸡感染的计算机数量超过500万台，连接到
超过4000台肉鸡命令和控制服务器。为了强调这个问题的严重性，
在Symantec的托管安全服务操作中，我们所检测到的超过50%的付诸
行动的事件存在肉鸡感染的痕迹。
检测肉鸡所面临的一个挑战是，除了经常与肉鸡命令和控制服务器
进行回调通信之外，许多受感染的主机可能不会产生其他任何可疑
的行为，直到几关甚至几个月后发出一个命令。虽然有些更为常见
的、广泛传播的肉鸡感染主机网络有公开的签名可用于检测，但大
多数未知的肉鸡网络却是IDP无法检测的。如果没有签名，可以使用
什么技巧检测肉鸡感染呢？熟悉了肉鸡命令和控制服务器之后，可
以揭露这些付诸行动的事件。不管是否存在其他任何痕迹或签名，
服务器就应该可以确定系统很可能遭到了入侵。
对于Internet上已知与垃圾邮件、钓鱼、端口扫描或任何其他恶意活
动相关联的系统，这个原则也是适用的。如果能够知道Internet上那
些恶意系统或地址名，无疑会有很大的帮助。作为托管安全服务供
应商，我们的工作由于能够看到大范围的恶意攻击而获益良多。只
要我们的一家客户能够根据一次事件就把相应的IP地址标识为存在
恶意，其他所有客户也能从中受益。这个适用于Internet安全的“邻居
监测程序"可以快速确定犯罪分子的存在。这个概念非常简单明了，
但它的功能却是非常强大的。只要简单地在发现与已知的恶意IP地
址进行连接的时候对路由器或防火墙发出警告，应该能够找到自己
的网络上最危险和最隐蔽的病根。
创建和维护这样的监测列表既不是一项简单也不是一项精确的活
动。肉鸡命令和控制服务器可以在一天被分配给一个系统，第二天
被分配给另一个完全不同的系统。一个具有高风险的IP地址很可能
是个并不知情的公司或家庭用户的受害计算机，只是作为向下一台
主机发出攻击的中继。虽然大多数安全从业人员并没有创建一个全
面的监视列表的有机功能，但这样的列表作为商业产品或者在公开
2459
---
## Page 2461
领域中存在山。取决于智能输入和流量日志来源的可靠性和及时性
[2]，可以很轻松地把检测率大约提高80%。
[1]公开的监视列表的例子可见http://www.spamhaus.org和
http://cbl.abuseat.org/
志。显然，如果你的企业采用了这种做法，很可能无法发现通过这
些端口所进行的任何连接。
14.3使用主机日志增强洞察力
通过网络设备（路由器、防火墙和IDP）对企业进行监测具有很大的
优势。由于网络设备的良好覆盖率，分析师能够监测企业的大多数