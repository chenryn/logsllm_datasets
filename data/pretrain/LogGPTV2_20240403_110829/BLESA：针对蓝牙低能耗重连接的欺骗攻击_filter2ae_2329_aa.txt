# BLESA：针对蓝牙低能耗重连接的欺骗攻击
##### 译文声明
本文是翻译文章，文章原作者 Jianliang Wu，Yuhong Nan，Vireshwar Kumar，Jing Tian，Antonio
Bianchi，Mathias Payer and Dongyan Xu，文章来源：usenix.org
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
蓝牙低功耗（BLE，Bluetooth Low
Energy）协议在资源受限的设备之间实现高能效的无线通信。为了简化其应用，BLE需要有限的交互或不需要用户交互才能在两个设备之间建立连接。不幸的是，这种简单性是几个安全问题的根本原因。在本文中，重点分析了两个先前连接的设备重新连接的情况，从而分析了BLE链路层的安全性。在对BLE规范定义的重新连接过程进行形式化分析的基础上，本文重点说明了该规范中的两个关键安全漏洞。结果，即使是正确实现BLE协议的设备也可能容易受到欺骗攻击。
为了证明这些设计缺陷，并进一步研究其安全隐患，本研究开发了BLE欺骗攻击（BLESA，BLE Spoofifing
Attacks）。这些攻击使攻击者可以模拟BLE设备并将欺骗性数据提供给另一个先前配对的设备。
BLESA可以很容易地针对BLE协议的某些实现进行实施，例如Linux中使用的一种。此外，对于Android和iOS使用的BLE堆栈实现，发现了一个启用BLESA的逻辑错误，将此安全问题报告给了受影响的各方（Google和Apple），他们也承认了本文的发现。
## 0x01 Introduction
低功耗蓝牙（BLE）是使用最广泛的低能耗通信协议，到2023年，支持BLE的设备数量有望达到50亿。
BLE协议支持无线短距离通信，该通信允许两个设备连接和交换数据。非典型使用场景由智能手机和通过BLE进行通信的“小工具”设备（例如健身追踪器）组成。每个BLE连接都涉及充当客户端的设备（在此示例中为智能手机）和充当服务器的另一设备（在此示例为健身追踪器）。第一次，两个设备进行连接（允许它们交换数据），它们执行特定的配对过程，具体过程取决于所连接设备的类型及其用户界面的功能。
促成启用BLE的设备的快速增长的主要因素是其低成本和最终用户所需的最少设置工作。先前的研究表明这些用户友好的功能对该协议的安全性具有负面影响。由于BLE通信通常用于对安全敏感的设备中，例如物理安全设备（例如，锁）或健康监控设备（例如，医疗植入物）[16]，因此这种担忧尤其令人担忧。
研究人员通过手动分析其规范指出并研究了BLE协议中的许多实现缺陷。此外，一些先前的工作还对BLE规范进行了自动的形式化分析。但是，这些形式化方法仅关注整个协议的有限方面，例如BLE配对机制。这种局限性是由于以下事实：完全规范化和自动分析BLE规范具有挑战性。挑战来自BLE协议的复杂性，建模其多层设计的困难，其多种变体和可选功能（这使该协议能够支持功能明显不同的各种设备）。
## 0x02 Threat Model
在本文中，研究了BLE协议一个尚未探索的机制。具体来说，专注于处理重新连接两个先前连接的设备的机制。例如，当服务器设备（例如，健身跟踪器）移出所连接的客户端设备（例如，智能手机）的BLE无线通信范围之外，然后稍后，这两个设备足够靠近时，该机制就起作用了重新建立连接。
为了开始对此场景的分析，首先使用ProVerif协议验证程序对相关的BLE链路层规范进行了正式验证。本文的形式化分析强调了BLE官方规范中的两个弱点。这些漏洞（在某些BLE堆栈实现中）使攻击者可以发起欺骗性攻击，在这种攻击中，攻击者伪装成先前配对的服务器设备，从而诱使客户端设备接受欺骗性数据。
特别是发现BLE规范允许以多种方式实现此协议的多个方面，其中某些方面很容易受到攻击。因此，即使在规范之后正确执行BLE协议栈，也很容易受到欺骗攻击。例如，发现BLE协议栈（通过gatttool进行访问）在Linux客户端设备（例如，Linux笔记本电脑）中正确遵循BLE规范时，很容易受到所识别的欺骗攻击的影响。
此外还发现，即使以理论上不易受到已识别攻击的方式实现的BLE协议栈，由于特定的逻辑漏洞，在实践中仍然容易受到攻击。具体来说，在Android设备使用的BLE堆栈和iOS设备使用的BLE堆栈中发现了类似的实现问题。此问题使许多Android和iOS设备容易受到已识别的攻击。已将发现的问题报告给Google和Apple，他们已确认了这些漏洞。截至2020年6月，Apple已为漏洞分配了CVE-2020-9770并对其进行了修复，但经过测试的设备（即运行Android10的Google
Pixel XL）中的Android BLE实施仍然很容易受到攻击。
为了展示确定的问题，设计了一种新颖的攻击称为BLESA（BLE欺骗攻击）。在BLESA中，攻击者假装是先前配对的服务器设备，拒绝了来自客户端设备的身份验证请求，然后将欺骗性数据提供给它。然后，表明运行Ubuntu且其BLE堆栈的最新版本的Linux笔记本电脑容易受到BLESA的攻击。另外，通过将它发布到Google
Pixel
XL手机上来展示BLESA的有效性，该手机记录了来自称为OuraRing的可穿戴活动跟踪设备的信息。特别是，通过使用BLESA，攻击者成功假冒了该手环，将欺骗数据注入到手机中，并且在手机上运行的环的配套应用程序接受并显示了欺骗数据。
假设攻击者具有与Dolev-Yao模型相同的功能，即，攻击者可以窃听，拦截和修改服务器与客户端之间传递的合法消息。 攻击者还可以将任何消息注入通信渠道。
但是，攻击者不知道服务器和客户端之间共享的密钥，并且所使用的加密功能是完全安全的。 而且，攻击者无法替换服务器或客户端的固件。
由于BLE是一种短距离通信协议，因此假设攻击者与客户端之间的距离以及攻击者与服务器之间的距离都在蓝牙范围内， 用欺骗性消息误导客户。
## 0x03 Formal Analysis of BLE Reconnection
当客户端与先前连接的服务器重新连接时，将对BLE链路层身份验证机制进行正式验证。利用ProVerif进行此协议验证。
###  A.ProVerif模型
当客户端在新会话中与服务器重新连接时，将为身份验证过程建立一个正式的模型。身份验证过程被建模为两个通信状态机，一个用于客户端，一个用于服务器。在BLE规范中，对与客户端的属性请求的传输相对应的状态机和与服务器上的属性请求的处理相对应的状态机进行建模。该模型全面涵盖了不同类型的消息，包括与属性访问请求，属性访问响应和错误响应相对应的消息。客户端和服务器之间的通信被建模为自由（或开放）通道（free
plain_channel：channel），在该通道中，攻击者具有威胁模型中描述的功能。
还考虑了属性的所有特征，以涵盖服务器设备的不同使用场景。因此，将服务器上的属性建模为可读和可写。此外对两种类型的属性进行建模：（1）无需配对即可访问的基本属性（即，在安全级别1），以及（2）敏感属性配对后即可访问（安全级别为2或更高）。最后，对客户端进行建模以将访问请求发送到服务器，以按不同的顺序读取/写入这两种类型的属性。配对期间建立的共享密钥用于在需要加密时对通信进行加密/解密。
**安全目标：**
根据上面代码中列出的传统安全目标来分析上述模型。这些安全目标包括：（1）机密性，即，所传达的消息不应将任何敏感数据泄露给攻击者（第6-9行），（2）完整性，即所传递的消息不应被攻击者篡改而不被检测到（第6-9行），以及（3）真实性，即可以验证所传递的消息是由真实发件者生成的（第11行）。此外，当启动来自客户端的请求并处理服务器上的请求时，还将检查从规范中指定的规则中提取的一个BLE特定安全目标。仅当连接的安全级别与访问该属性的要求一致时，服务器才应授予对客户端的读/写访问权限（第13行）。
###  B.发现的设计缺陷
通过正式验证，当先前连接的设备重新连接时，本研究发现了一些违反已检查的安全目标的情况。这些违规导致以下两个安全漏洞，攻击者可能会利用这些漏洞来发起欺骗攻击。
####  漏洞1：可选身份验证
发现链路层加密/身份验证是可选的：客户端和服务器可以针对特定属性选择禁用它。因此，在基本属性的情况下，可能会违反属性访问请求和响应的机密性，完整性和真实性目标，如ProVerif的以下结果所示。