GET /hammers.html HTTP/1.0
Host: www.joes-hardware.com
User-Agent: Mozilla/4.51 [en] (X11; U; IRIX 6.2 IP22)
在图20-1b中，服务器没有回送带有HTTP状态码200的Web页面主体，而是回送
了一个带有状态码302的重定向报文：
HTTP/1.0 302 Redirect
Server: Stronghold/2.4.2 Apache/1.3.6
Location: http://161.58.228.45/hammers.html
现在，在图20-1c中，浏览器会用重定向URL重新发送请求，这次会发送给主机
161.58.228.45：
GET /hammers.html HTTP/1.0
Host: 161.58.228.45
User-Agent: Mozilla/4.51 [en] (X11; U; IRIX 6.2 IP22)
另一个客户端可能会被重定向到另一台服务器上去。在图20-1d-f中，Bob的请求会
452 被重定向到161.58.228.46。
474 ｜ 第20章
因特网
（a）Alice向www.joes-hardware.com发送HTTP请求
（b）服务器返回302，重定向到161.58.228.45
（c）浏览器重新发送HTTP请求，这一次发w 5ware.com161.58.228.45161.58.228.46161.58.228.47
Alice 送w 给w 16.j 1o .5e 8s .- 2h 2a 8.r 4d
Bob
因特网
Alice
（d）Bob向www.joes-hardware.com发送HTTP请求
（e）服务器返回302，重定向到161.58.228.46 161.58.228.45161.58.228.46161.58.228.47
（f）浏览器重新发送HTTP请求，这次发送w
Bob 给w 1w 61.j .o 58e .s 2- 2h 8a .4r 6dware.com
图20-1 HTTP重定向
HTTP重定向可以在服务器间导引请求，但它有以下几个缺点。
• 需要原始服务器进行大量处理来判断要重定向到哪台服务器上去。有时，发布重
定向所需的处理量几乎与提供页面本身所需的处理量一样。
• 增加了用户时延，因为访问页面时要进行两次往返。
• 如果重定向服务器出故障，站点就会瘫痪。
由于存在这些弱点，HTTP重定向通常都会与其他一种或多种重定向技术结合使用。
20.4.2 DNS重定向
每次客户端试图访问Joe的五金商店的网站时，都必须将域名www.joes-hardware.
com解析为IP地址。DNS解析程序可能是客户端自己的操作系统，可能是客户端
网络中的一台DNS服务器，或者是一台远距离的DNS服务器。DNS允许将几个IP
地址关联到一个域中，可以配置DNS解析程序，或对其进行编程，以返回可变的
IP地址。解析程序返回IP地址时所基于的原则可以很简单（轮转），也可以很复杂
（比如查看几台服务器上的负载，并返回负载最轻的服务器的IP地址）。 453
重定向与负载均衡 ｜ 475
在图20-2中，Joe为www.joes-hardware.com运行了4台服务器。DNS服务器要决
定为www.joes-hardware.com返回4个IP地址中的哪一个。最简单的DNS决策算
法就是轮转。
www.joes-hardware.com
DNS服务器
决定是否解析到
10.10.10.1、
10.10.10.2、
10.10.10.3、 10.10.10.4 www.joes-hardware.com
10.10.10.4 服务器4
骨干网络
10.10.10.1
客户端 服务器1
路由器
交换机
www.joes-hardware.com
客户端
边缘网络 www.joes-hardware.com
10.10.10.2
服务器2
10.10.10.3
服务器3
图20-2 基于DNS的重定向
整个DNS解析过程的完整介绍，请参见本章末尾列出的DNS参考资料。
1. DNS轮转
最常见的重定向技术之一也是最简单的重定向技术之一。DNS轮转使用了DNS主机
名解析中的一项特性，在Web服务器集群中平衡负载。这是一种单纯的负载均衡策
略，没有考虑任何与客户端和服务器的相对位置，或者服务器当前负载有关的因素。
我们来看看CNN.com实际上都做了些什么。我们在2000年5月初，用Unix中的
工具nslookup来查找与CNN.com相关的IP地址。例20-1给出了结果。2
例20-1 www.cnn.com的IP地址
% nslookup www.cnn.com
454 Name: cnn.com
Addresses: 207.25.71.5, 207.25.71.6, 207.25.71.7, 207.25.71.8
207.25.71.9, 207.25.71.12, 207.25.71.20, 207.25.71.22, 207.25.71.23
207.25.71.24, 207.25.71.25, 207.25.71.26, 207.25.71.27, 207.25.71.28
注2： DNS的结果是在2000年5月7日，从北加州解析出来的。有些特定值可能会随时间发生变化，有些
DNS系统还会根据客户端的位置返回不同的值。
476 ｜ 第20章
207.25.71.29, 207.25.71.30, 207.25.71.82, 207.25.71.199, 207.25.71.245
207.25.71.246
Aliases: www.cnn.com
网站www.cnn.com实际上是20个不同的IP地址组成的集群。每个IP地址通常都
意味着一台不同的物理服务器。
2. 多个地址及轮转地址的循环
大多数DNS客户端只会使用多地址集中的第一个地址。为了均衡负载，大多数
DNS服务器都会在每次完成查询之后对地址进行轮转。这种地址轮转通常称作DNS
轮转。
例如，对www.cnn.com进行三次连续的DNS查找可能会返回例20-2给出的那种IP
地址轮转列表。
例20-2 轮转DNS地址列表
% nslookup www.cnn.com
Name: cnn.com
Addresses: 207.25.71.5, 207.25.71.6, 207.25.71.7, 207.25.71.8
207.25.71.9, 207.25.71.12, 207.25.71.20, 207.25.71.22, 207.25.71.23
207.25.71.24, 207.25.71.25, 207.25.71.26, 207.25.71.27, 207.25.71.28
207.25.71.29, 207.25.71.30, 207.25.71.82, 207.25.71.199, 207.25.71.245
207.25.71.246
% nslookup www.cnn.com
Name: cnn.com
Addresses: 207.25.71.6, 207.25.71.7, 207.25.71.8, 207.25.71.9
207.25.71.12, 207.25.71.20, 207.25.71.22, 207.25.71.23, 207.25.71.24
207.25.71.25, 207.25.71.26, 207.25.71.27, 207.25.71.28, 207.25.71.29
207.25.71.30, 207.25.71.82, 207.25.71.199, 207.25.71.245, 207.25.71.246
207.25.71.5
% nslookup www.cnn.com
Name: cnn.com
Addresses: 207.25.71.7, 207.25.71.8, 207.25.71.9, 207.25.71.12
207.25.71.20, 207.25.71.22, 207.25.71.23, 207.25.71.24, 207.25.71.25
207.25.71.26, 207.25.71.27, 207.25.71.28, 207.25.71.29, 207.25.71.30
207.25.71.82, 207.25.71.199, 207.25.71.245, 207.25.71.246, 207.25.71.5
207.25.71.6
在例20-2中：
• 第一次DNS查找时的第一个地址为207.25.71.5；
• 第二次DNS查找时的第一个地址为207.25.71.6；
• 第三次DNS查找时的第一个地址为207.25.71.7。
455
重定向与负载均衡 ｜ 477
3. 用来平衡负载的DNS轮转
由于大多数DNS客户端只使用第一个地址，所以DNS轮转可以在多台服务器间提
供负载均衡。如果DNS没有对地址进行轮转，大部分客户端就总是会将负载发送给
第一台服务器。
图20-3说明了DNS轮转循环是如何平衡负载的。
• Alice试图连接www.cnn.com时，会用DNS查找IP地址，得到207.25.71.5作
为第一个IP地址。在图20-3c中，Alice连接到Web服务器207.25.71.5。
• Bob 随后试图连接 www.cnn.com 时，也会用 DNS 查找 IP 地址，但由于地址
列表在 Alice 上次请求的基础上轮转了一个位置，所以他会得到一个不同的结
果。Bob 得到 207.25.71.6 作为第一个 IP 地址，在图 20-3f 中它连接到了这台
服务器上。
（a）Alice向DNS请求www.cnn.com的IP地址
（b）DNS以207.25.71.5进行回应
（c）Alice向207.25.71.5发送HTTP请求DNS服务器 207.25.71.5207.25.71.6207.25.71.7
Alice
因特网
Bob
因特网
Alice
（d）Bob向DNS请求www.cnn.com的IP地址
（e）DNS以207.25.71.6进行回应 207.25.71.5207.25.71.6207.25.71.7
（f）Bob向207.25.71.6发送HTTP请求
Bob DNS服务器
图20-3 DNS轮转在服务器集群的各台服务器之间进行负载均衡
478 ｜ 第20章
4. DNS缓存带来的影响
DNS对服务器的每次查询都会得到不同的服务器地址序列，所以DNS地址轮转会
将负载分摊。但是这种负载均衡并不完美，因为DNS查找的结果可能会被记住，并
被各种应用程序、操作系统和一些简易的子DNS服务器重用。很多Web浏览器都 456
会对主机进行DNS查找，然后一次次地使用相同的地址，以减少DNS查找的开销，
而且有些服务器也更愿意保持与同一台客户端的联系。另外，很多操作系统都会自
动进行DNS查找，并将结果缓存，但并不会对地址进行轮转。因此，DNS轮转通
常都不会平衡单个客户端的负载——一个客户端通常会在很长时间内连接到一台服
务器上。
尽管DNS没有对单个客户端的事务进行跨服务器副本的处理，但在分散多个客户端
的总负荷方面它做得相当好。只要有大量具有相同需求的客户端，就可以将负载合
理地分散到各个服务器上去。
5. 其他基于DNS的重定向算法
我们已经讨论了DNS是如何对每条请求进行地址列表轮转的。但是，有些增强的
DNS服务器会使用其他一些技术来选择地址的顺序。
• 负载均衡算法
有些DNS服务器会跟踪Web服务器上的负载，将负载最轻的Web服务器放在
列表的最前面。
• 邻接路由算法
Web服务器集群在地理上分散时，DNS服务器会尝试着将用户导向最近的Web
服务器。
• 故障屏蔽算法
DNS 服务器可以监视网络的状况，并将请求绕过出现服务中断或其他故障的
地方。
通常，运行复杂服务器跟踪算法的DNS服务器就是在内容提供者控制之下的一个权
威服务器（参见图20-4）。
有一些分布式主机服务会使用这个DNS重定向模型。对于那些要查找附近服务器的
服务来说，这个模型的一个缺点就是,权威DNS服务器只能用本地DNS服务器的
IP地址，而不能用客户端的IP地址来做决定。
重定向与负载均衡 ｜ 479
址
地
求IP 址
请 地
权器 的IP
） 从 根 服 送务 威 服 务 器 根DNS服务器
（ b
发
）
地 址 （ c
的IP
n.c o m （ （d e）） 返请 回求 II PP 地地 址址
w.c n
求 w w 207.25.71.5
a） 请 本地DNS服务器 权威DNS服务器
（
监视着cnn服务器
（f）向207.25.71.5上的服务器发送HTTP请求
Alice
www.cnn.comwww.cnn.comwww.cnn.com
(207.25.71.5) (207.25.71.6) (207.25.71.7)
图20-4 涉及权威服务器的DNS请求
20.4.3 任播寻址
在任播寻址中，几个地理上分散的Web服务器拥有完全相同的IP地址，而且会通
过骨干路由器的“最短路径”路由功能将客户端的请求发送给离它最近的服务器。
要使这种方法工作，每台服务器都要向邻近的骨干路由器广告，表明自己是一台路
457 由器。Web服务器会通过路由器通信协议与其邻近的骨干路由器通信。骨干路由器
收到发送给任播地址的分组时，会（像平常一样）寻找接受那个IP地址的最近的
“路由器”。由于服务器是将自己作为那个地址的路由器广告出去的，所以骨干路由