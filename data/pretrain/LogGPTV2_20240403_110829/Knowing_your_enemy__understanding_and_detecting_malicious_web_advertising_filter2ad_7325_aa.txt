title:Knowing your enemy: understanding and detecting malicious web advertising
author:Zhou Li and
Kehuan Zhang and
Yinglian Xie and
Fang Yu and
XiaoFeng Wang
Knowing Your Enemy: Understanding and Detecting
Malicious Web Advertising
Zhou Li∗
Indiana University at Bloomington
PI:EMAIL
Kehuan Zhang†
Indiana University at Bloomington
PI:EMAIL
Yinglian Xie
MSR Silicon Valley
PI:EMAIL
Fang Yu
MSR Silicon Valley
PI:EMAIL
ABSTRACT
With the Internet becoming the dominant channel for marketing
and promotion, online advertisements are also increasingly used
for illegal purposes such as propagating malware, scamming, click
frauds, etc. To understand the gravity of these malicious adver-
tising activities, which we call malvertising, we perform a large-
scale study through analyzing ad-related Web traces crawled over a
three-month period. Our study reveals the rampancy of malvertis-
ing: hundreds of top ranking Web sites fell victims and leading ad
networks such as DoubleClick were inﬁltrated.
To mitigate this threat, we identify prominent features from ma-
licious advertising nodes and their related content delivery paths,
and leverage them to build a new detection system called Mad-
Tracer. MadTracer automatically generates detection rules and uti-
lizes them to inspect advertisement delivery processes and detect
malvertising activities. Our evaluation shows that MadTracer was
capable of capturing a large number of malvertising cases, 15 times
as many as Google Safe Browsing and Microsoft Forefront did to-
gether, at a low false detection rate. It also detected new attacks,
including a type of click-fraud attack that has never been reported
before.
Categories and Subject Descriptors
H.3.5 [[Information Storage and Retrieval]: Online Information
Services Web-based services
Keywords
Online Advertising, Malvertising, Statistical Learning
1.
INTRODUCTION
Visiting any commercial Web site today, rarely will you not bump
into banner advertisements (ads for short). Such Web advertising
∗Part of the work was done during Zhou Li’s intern at Microsoft
Research.
†Kehuan Zhang is also afﬁliated with The Chinese University of
Hong Kong.
Permission to make digital or hard copies of all or part of this work for
personal or classroom use is granted without fee provided that copies are
not made or distributed for proﬁt or commercial advantage and that copies
bear this notice and the full citation on the ﬁrst page. To copy otherwise, to
republish, to post on servers or to redistribute to lists, requires prior speciﬁc
permission and/or a fee.
CCS’12, October 16–18, 2012, Raleigh, North Carolina, USA.
Copyright 2012 ACM 978-1-4503-1651-4/12/10 ...$15.00.
Indiana University at Bloomington
XiaoFeng Wang
PI:EMAIL
has already grown into billion-dollar businesses [36]. Compared to
traditional media, online advertising is more convenient and eco-
nomic. One can easily set up an account with major advertisers
such as DoubleClick, and immediately push her marketing mes-
sages to a large population. Unfortunately, this bless can also turn
into a curse: hackers and con artists have found Web ads to be
a low-cost and highly-effective means to conduct malicious and
fraudulent activities.
In this paper, we broadly refer to such ad-
related malicious activities as malvertising, which can happen to
any link on an ad-delivery chain, including publishers, advertising
networks (ad network), and advertisers. A well-known example is
New York Times’ malvertising incident, in which a fake virus scan-
ner was found on its home page [32]. Indeed, malvertising becomes
a vibrant underground business today, endangering even those who
trust only the contents from reputable Web sites.
Anti-malvertising. Both industry and academia have been work-
ing on this threat, typically through inspecting ads to detect their
malicious content [22]. However, malicious ads often use obfus-
cation and code packing techniques to evade detection. Further
complicating the situation is the pervasiveness of ad syndication, a
business model in which an ad network sells and resells the spaces
it acquires from publishers to other ad networks and advertisers. Ad
syndication signiﬁcantly increases the chance of posting malicious
content on a big publisher’s Web site. It allows a malicious ad net-
work to deliver ads directly to a user’s browser, without the need
of submitting them through the more reputable ad networks and
publishers from whom it gets the ad space. Furthermore, attackers
continue to invent new, stealthy strategies for exploiting ad-delivery
channels: a prominent example is leveraging a compromised pub-
lisher page to hijack user trafﬁc into clicks (Appendix C).
Thus, despite years’ effort, anti-malvertising remains challeng-
ing with many open questions. Particularly, little is known about
the infrastructure used to deliver malicious ad content. One may
ask: how do attackers get onto the ad networks? what roles do
malicious nodes 1 play in a malvertising campaign? how do they
hide their activities from detection? An in-depth understanding of
these issues can help identify the weakest link in the malvertising
infrastructure, and present a new angle to address them using infor-
mation that characterizes not just individual entities, but their roles
and interactions with each other.
Our new ﬁndings. In this paper, we report an extensive study on
the malvertising infrastructure, based upon a crawling of 90,000
leading Web sites over a 3-month span. Using the Web trafﬁc traces
collected through the crawling, we perform a ﬁne-grained, in-depth
1Here a node represents an entity (e.g., publisher, ad network, advertiser,
etc.) on an ad-delivery chain.
674analysis on the malvertising cases reported by Google Safe Brows-
ing and Microsoft Forefront, and make the following discoveries:
• Malvertising scale: Not only does malvertising infect top Web
sites, it also inﬁltrates leading ad networks like DoubleClick.
• Evading strategies: Different cloaking techniques are deployed
over malvertising nodes, which work together to evade detection.
• Properties of malicious parties: Malicious parties exhibit dis-
tinctive features, including their ad-related roles, domain and URL
properties, the popularity and the lifetimes of their URLs, and their
pairing relations. These features, when viewed in isolation, are of-
ten not reliable enough for detection. But when they are viewed
collectively in the context of ad delivery infrastructure, they offer a
good characterization of malvertising activities.
• Ad delivery topology: A malvertising path usually involves mul-
tiple malicious domains and they tend to stand close to each other
in distance. This observation reveals the topological connection
among these malicious parties in the ad context, which can be lever-
aged to characterize their malicious behaviors (Section 5).
New techniques. The dynamic interactions among malvertising
entities and their distinctive features present unique opportunities
for detection. As a ﬁrst step, we model ad-delivery topologies us-
ing a simple representation in terms of short path segments that
describe the redirection relations among domains. Previous work
has also measured the redirection chains of malicious Web activ-
ities [27]. However, little has been done to explore such topol-
ogy information for detection. As malicious nodes often stay close
along redirection chains, the use of short ad path segments, com-
bined with node features, effectively leverages this observation as
well as other properties speciﬁc in the ad context. For example, it is
unusual to see multiple consecutive domains irrelevant to ads along
an ad-delivery path and our representation naturally captures such
suspicious cases. Since this approach does not depend on Web page
content, it is robust to code obfuscation. Further, it is fundamen-
tally difﬁcult for attackers to alter the features and the interconnect
relations of multiple ad entities, especially when some of them are
controlled by legitimate domains.
Based on the new representation, we design and implement Mad-
Tracer, the ﬁrst infrastructure-based malvertising detection system.
We utilize a machine learning framework to automatically generate
detection rules on three-node path segments annotated with node
attributes. Applying our system to the crawled data from Jun to
Oct, 2011, we detect 9568 malvertising redirection chains, each of
which involves a unique domain sequences (called domain-path,
see Section 3.2). Compared to what are detected by Safe Browsing
and Forefront combined, our system increases detection coverage
by 15 times. Over 95% of the detected malvertising cases have been
conﬁrmed so far, either through our collaboration with Microsoft
Forefront or by manual validation. Apart from drive-by downloads
and fake-AV scams, our system also discovers a new type of click
fraud attacks, in which attackers compromise Web sites and hijack
normal user trafﬁc into fraudulent ad clicks.
Roadmap. The rest of the paper is organized as follows: Section 2
provides the necessary background information and presents a case
study; Section 3 describes the datasets and the terminologies we
use; Section 4 elaborates our measurement study; Section 5 de-
scribes our new detection techniques; Section 6 reports our experi-
mental results; Section 7 compares our work with related prior re-
search; Section 8 discusses deployment scenarios and future work;
Section 9 concludes the whole paper.
2. BACKGROUND
2.1 Online Advertising
Our research focuses on display ads, whose contents are loaded
automatically to a Web page without the need of user clicks. Dis-
play ads are extremely popular, appearing on most highly-ranked
Web pages today. Here we describe how this type of ads work.
Actors in Web advertising. Display ads are delivered through a
Web-based infrastructure that involves the following major parties:
• Publishers display ads on their Web pages on behalf of adver-
tisers. They usually make proﬁt by either pay-per-impression, i.e.,
paid by the number of user views, or pay-per-click, i.e., paid by the
number of ad-clicks.
• Advertisers create ads. They are the revenue sources of online
advertising. During an ad delivery process, ad networks play the
role of match-makers to bring together publishers and advertisers.
Large ad networks often provide platforms (e.g., Google Display
Network [2]) where advertisers can select publishers and specify
targeted audience. Ad networks could also resell ad spaces in their
inventory to other ad networks through ad syndication.
• Audiences, or users visit publisher pages and receive ad contents
(e.g., ad banners). When they click these ads, they will be redi-
rected to the corresponding advertiser Web sites.
In addition to these main actors, there are several other parties
playing different roles in ad delivery. For example, trackers gather
delivery statistics, which is important to the performance measure-
ment of ad campaigns.
Ad delivery process. Figure 1 shows how these parties interact to
deliver ads.
Figure 1: (a) Direct delivery (b) Ad syndication.
A publisher ﬁrst embeds ad tags [14], which is a piece of HTML
or JavaScript code, on its Web page for ad networks. Whenever a
user visits the publisher page, the tags on the page will generate a
request to an ad network for ad contents, including code, images,
and others. The above dynamic process allows an ad network to
customize the type of ads according to user geographic locations,
behaviors, and activity histories. Alternatively, an ad network could
also serve as an ad syndicator as shown in Figure 1(b), reselling ad
spaces to other ad networks. When this happens, the code that the
browser receives from the syndicator will fetch ad tags from third-
party ad networks, which will either provide ad contents directly or
further outsource the spaces to other parties.
2.2 How Malvertising Works: An Example
Online advertising has been extensively used by miscreants for
malicious activities. To explicate how such malvertising works, we
describe a real malicious ad campaign discovered by our study in
June, 2011 and later conﬁrmed by BlueCoat Security Lab
in July, 2011 [17].
 Publisher Ad Syndicator Third-party Ad Network Request Next Ad Tag Publisher Ad Network (a) (b) 675This is a fake Anti-Virus (AV) campaign that infected 65 pub-
lisher pages from June 21st to August 19th, 2011. One of them
was the home page of freeonlinegames.com, an Alexa top
2404 Website. The page’s ad tag ﬁrst queried Google and Dou-
bleClick, which referred the visitors to a third-party ad network
adsloader.com. This ad network turned out to be malicious:
it delivered an ad tag which automatically redirected the user’s
browser to a fake AV site and tried to trick the visitor to download
a malware executable. Figure 2 illustrates this delivery process.
Figure 2: An example delivery chain of a fake AV campaign.
Figure 3: An ad delivered by adsloader.com.
What makes this campaign interesting is that its delivery path
includes DoubleClick, a popular ad exchange network. The attack-
ers set up a third-party ad network called adsloader.com (this
domain name resembles adloader.com, held by a legitimate ad
company) to syndicate with DoubleClick. When accessed by a vic-
tim, adsloader.com displayed an image (Figure 3).
Besides delivering an ad image, adsloader.com also injected
a hidden iframe pointing to enginedelivery.com, which redi-
rected users to eafive.com (a fake AV site), whose HTML code
was classiﬁed by Forefront as TrojanDownloader:HTML/Renos.
After visiting the publisher with different conﬁgurations, we fou-
nd that all of the involved malicious parties performed cloaking to
evade detection. Speciﬁcally, adsloader.com never redirected
the visitor from the same IP address to enginedelivery.com
twice, and only did the redirection if the user agent was IE. It also
checked a request’s referrer ﬁeld and did not inject the iframe when
it was empty. The redirector enginedelivery.com did not
send malicious contents to requests from certain IP ranges (e.g.,
Amazon EC2 IP ranges). Finally, the fake-AV Web site eafive.
com attacked only IE-6 users. The attackers recruited in total over
24 ad networks, 16 redirectors, and 84 fake-AV scanners, and ro-
tated them throughout the campaign. This strategy worked well:
only 4 redirectors and 11 fake-AV sites were caught by Google
Safe Browsing; none of the malicious ad networks were blocked.
• Each attack in this campaign requires three types of entities (ad-
networks, redirectors, and fake-AV hosts) to work together.
• These entities could be controlled by different malicious parties.
The Whois records [34] of the malicious ad networks are quite dif-
ferent from those of the redirectors and the fake-AV sites, suggest-
ing that they may have been registered by different parties.
• All malicious domains were registered after 2010 and set to ex-
pire in one year, suggesting that they are registered by attackers
within a short period.
This attack exhibits the following features:
These ﬁndings indicate that malvertising has distinctive infras-
tructure features. Such features, particularly those of the entities
involved in an ad delivery process and their relations may provide
valuable information for malvertising detection.
2.3 Attacks Leveraging Malvertising
We consider the following three categories of attacks in our re-
search. All of them leverage the ad-delivery infrastructure to con-
duct malicious activities.
• Drive-by download: Such attacks exploit the vulnerabilities of
browsers or plugins using dynamic contents in JavaScript or Flash.
• Scam and phishing: These attacks include fake-AVs or others
that attempt to trick users into disclosing sensitive information, e.g.,
usernames, passwords, and bank account numbers.
• Click-fraud: Publishers routinely embed advertiser URLs with
clickable links on their Web pages as contexual ads. Only when a
user clicks such a link will the user be redirected to an advertiser
page. However, we ﬁnd that attackers set up malicious publisher
sites and redirect user trafﬁc (e.g., via hidden iframes) to adver-
tiser pages automatically without user awareness, thus generating
fraudulent clicks [13, 23].
In all of these attacks, attackers store malicious contents on ei-
ther their own Web sites or compromised sites. To attract victims,
traditionally, attackers promote these sites via blackhat SEO tech-
niques [20, 16] or spam campaigns [30]. As online advertising
reaches a large user population today, attackers have started ex-
ploiting ad networks, including DoubleClick and Zedo, to launch
attacks in different ways. For example, drive-by downloads, scams,
and phishing typically exploit malicious advertisers or ad networks
to reach victims, whereas click frauds often go through malicious
or compromised publishers.
3. DATASET AND TERMINOLOGY
Our research focuses on the ad infrastructure, which links multi-
ple ad-related parties during an ad delivery process. By infrastruc-
ture, we broadly refer to the collective set of entities involved, their
roles in Web advertising, and their interactions and relationships
with each other. Our goal is to identify distinguishing infrastructure-
related characteristics and to leverage them for developing detec-
tion techniques. To this end, we crawl popular Web pages, which
we call publisher pages, to measure and analyze ad-redirection
chains. In this section, we describe our data collection process and
deﬁne the concepts to be used throughout this paper.
3.1 Dataset Collection