Breaking the 
Chrome Sandbox 
with Mojo
_tsuro@, 2022
No memory was corrupted in the 
making of this presentation
Kernel
Browser Process
Renderer
Renderer
Renderer
Renderer
Network
GPU
Renderer
Browser Process
Network
URLLoader
NetworkService
NetworkContext
...
RendererHost
BlobRegistry
GpuHost
...
Renderer
Browser Process
Network
URLLoader
NetworkService
NetworkContext
...
RendererHost
BlobRegistry
GpuHost
...
Renderer
Browser Process
Port X
Port Y
Port Z
...
Port A
Port B
Port C
...
To: X
REQUEST_INTRODUCTION
INTRODUCE
BROADCAST_EVENT
ACCEPT_INVITATION
Data
Data
Data
Data
EVENT_MESSAGE
EVENT_MESSAGE
...
Data
EVENT_MESSAGE
kUserMessage
kMergePort
...
port_name
port_name
port_name
Data
Data
Data
OffensiveCon 2020 - Popping Calc with Hardware Vulnerabilities
Leaking ports == bad
?
Browser
Renderer
Network
?
0
!
!
!
!
0
!
?
Socket is closed
Browser process
Delete peer node
Node name reused
Destroy all ports with peer
Browser thread 2
Prepare to send message
Read node name from port
Send message
(to wrong node)
?
1. leak port name
2. spoof message
Socket is closed
Browser process
Delete peer node
Node name reused
Destroy all ports with peer
Network Process
Port OnError handlers
Send PortClosed events
ChildProcessHost: kill(child)
Socket is closed
Port OnError handlers
ChildProcessHost: exit()
Destroy all ports with peer
Delete peer node
“I have a dangerous fascination with terrible bugs.”
@halvarflake
Socket is closed
Browser process
Delete peer node
Node name reused
Destroy all ports with peer
Network Process
Port OnError handlers
Send PortClosed events
ChildProcessHost: kill(child)
Socket is closed
Port OnError handlers
ChildProcessHost: exit()
Destroy all ports with peer
Delete peer node
These are tasks on the
IO thread
Socket is closed
Browser process
Delete peer node
Node name reused
Destroy all ports with peer
Port OnError handlers
Send PortClosed events
ChildProcessHost: kill(child)
Network Process
Socket is closed
Port OnError handlers
ChildProcessHost: exit()
Destroy all ports with peer
Delete peer node
Node name reused
Send PortClosed (P1)
Browser Process
Port OnError handlers
Send PortClosed (P2)
...
Send PortClosed (Pk)
ChildProcessHost: kill(child)
...
Send PortClosed (Pn)
First leak
Game over
Issues:
●
Tight race between leak and kill
●
Network process will exit()
KATE
We need your help to overload the Gibson.
RAZOR
You are going to need more than just two media icons like us. You need an army.
BLADE
That's it! An electronic army! If I were us, I'd get on the internet, send out a major 
distress signal.
RAZOR
Hackers of the World, Unite!
KATE
Now listen up, use your best viruses to buy us time, we have to spoof a message 
to the network process.
Virus
Broadcast
Request
Issues:
●
Tight race between leak and kill
●
Network process will exit()
KATE
It's the Gibson, it's finding us too fast.
Send PortClosed (P1)
Browser Process
Port OnError handlers
Send PortClosed (P2)
...
Send PortClosed (Pk)
ChildProcessHost: kill(child)
...
Send PortClosed (Pn)
First leak
Game over
Send PortClosed (P1)
Browser Process
Port OnError handlers
Send PortClosed (P2)
...
Send PortClosed (P 100000)
ChildProcessHost: kill(child)
...
Port
Name: X
Peer:
Issues:
●
Tight race between leak and kill
●
Network process will exit()
Issues:
●
Tight race between leak and kill
●
Network process will exit()
●
How to inject a message during the DoS?
Turn off and on again?
Network Process
OnError Tasks
DoS
Destroy all ports with peer
DoS
Enqueue OnError Handlers
Network Process
OnError Tasks
DoS
Destroy all ports with peer
DoS
Enqueue OnError Handlers
Process Spoofed Message
Network Process
OnError Tasks
DoS
Destroy all ports with peer
DoS
Enqueue OnError Handlers
Process Spoofed Message
Read Spoofed Message
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
B
B
B
B
B
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
Msg
Msg
Msg
Msg
Msg
Msg
Msg
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
Msg
Msg
Msg
Msg
Msg
Msg
Msg
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
Msg
Msg
Msg
Msg
Msg
Msg
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
Msg
Msg
Msg
Msg
Msg
Msg
Msg
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
Msg
Msg
Msg
Msg
Msg
Msg
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
Msg
Msg
Msg
Msg
Msg
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
Msg
Msg
Msg
Msg
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
Msg
Msg
Msg
X
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
Msg
Msg
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
X
Msg
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
X
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
X
B
B
B
B
B
B
B
X
Spoofed Message
B
BroadcastRequest
Msg
Small Message
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
B
HAL
They're coming in from remote nodes. They're going after the kernel!
PHREAK
Yo, check this out guys, this is insanely great. It's got a JavaScript engine!
:(
:(
INSERT INTO cookies VALUES('\r\ncalc.exe\r\n')
Takeaway
Target-specific knowledge can be crucial
●
Find bugs that fuzzers will never trigger
●
Turn impossible bugs exploitable
Got stuck? Watch Hackers!