1-36
日志学院
1.3. 其他数据源的接入
Syslog 数据接入
Syslog数据接入较为简单，只需要在数据源上配置Syslog日志发送到日志易服务器上，再
在日志易上配置数据接受即可。
在日志易上配置接收Syslog数据的步骤如下：
1. 点击添加数据页面的Syslog标签，进入添加Syslog数据源流程：
2. 首先需要配置监听的IP和端口和协议信息，通常我们会用监听UDP的514，用来接收
Syslog；
3. 配置好监听端口信息后，点击下一步，配置IP映射：
1-37
日志学院
所谓IP映射，是指为不同IP发来的Syslog标注不同的appname，tag和编码。IP支持
192.168.1.* 的通配符配法，但必须单独占据某一段，而不能是 192.1*8.1.1。靠前的映射优
先被匹配。
4. 配置好IP映射后，点击下一步，进入最后检查页面:
5. 检查无误后，点击下一步，完成Syslog数据源的添加。
批量管理 Syslog 映射表
逐一添加IP映射关系，在大规模部署的情况下是一件工作量巨大的工作。日志易提供批量
管理Syslog映射表的功能。
在 Agent 配置首页，点击Syslog配置修改，即可导出当前Syslog配置，或上传Syslog配置。
上传的Syslog 配置，必须是CSV文件格式，表头顺序为：ip，appname，tag，charset。如
下所示：
1-38
日志学院
脚本及命令采集
有时候我们需要对命令或脚本定期执行，并对执行结果进行采集。在日志易中，可通过脚本
采集配置，将脚本的输出作为数据源采集。
脚本采集配置的流程如下：
1. 点击添加数据页面的脚本标签，进入添加脚本数据源流程，所谓脚本数据源，即将脚本
的输出作为数据源采集。
2. 在选择来源页面，可以配置脚本文件路径，以及参数还有执行时间间隔:
参数以空格分开，时间间隔单位为秒，换行规则默认输出格式为所有内容在一行表示，此处
可通过设置 默认格式用正则表达式来配置，上图表示的为每60秒，执行一次/bin/ls–l，以
\n为换行规则。
日志易默认分发一些内置的采集脚本。点击文件路径右侧的"浏览"，可以打开文件路径预览
浮层，树状展示 $AGENT_HOME/add_on/ 目录下的文件，供选择：
1-39
日志学院
部分脚本的采集依赖于 crontab 或其他第三方程序的处理输出，对应的部署方式在脚本同
级目录中有相关的 README.txt 说明。请使用者单独阅读。
3. 配置好脚本文件，参数，间隔信息后，点击下一步，进入输入设置，定义该页面上配置
该脚本输出的appname，tag和编码即可。
4. 点击下一步，进入最后检查页面：
5. 检查无误后，点击下一步，完成脚本数据源的添加。
Windows 事件日志采集
步骤如下：
1. 点击添加数据页面的Windows事件日志标签，进入添加EventLog数据源流程：
1-40
日志学院
2. 在选择来源页面，可以通过添加自定义Channel，选择要监听的事件日志类型，可以多选。
Ignore_older表示采集特定时间后的日志，时间单位可以选择天\小时\分钟，填0则表示从
最早的日志开始。event_ids 表示采集特定event_id的日志，注意id数目不能超过22个
(windows系统限制)，负数表示不采集某个id的日志。用户还可以在info\warn\crit\err\verbose
中选择日志事件levels.levelsproviders表示采集特定 provider 的日志(即前台显示的
evenlog 数据中的 source_name)。
3. 选择完毕后，点击下一步，进入输入设置页面。该页面用于设置该EventLog对应的
appname和tag。
4. 配置完毕后，点击下一步，进入最后检查阶段：
5. 检查无误后，点击下一步，完成Windows事件日志数据源的添加。
数据库数据采集
步骤如下：
1. 数据库数据采集需要日志易1.8.0之后版本提供，agent需要1.7.30.0以上版本才支持。
点击添加数据页面的数据库数据标签，进入添加数据库数据源流程；
2. 在选择数据库连接页面，可以选择一个已有的连接来进行数据库采集，也可以新建一个
数据库连接采集；
1-41
日志学院
3. 如果是新建连接，那么需要按提示填入对应配置，点击保存后会自动验证，建议起一个
方便管理的连接名称。
选中连接后，点击下一步，进入相关参数输入和SQL预览页面, 左侧配置该数据源的
appname，tag信息，以及配置采集频率;右侧在输入框输入采集使用的SQL语句，点击预览，
下方表格将会展示若干行数据供预览:
4. 如果需要增量采集，请点击增量采集tab，配置增量采集字段等相关配置项:
5. 配置完毕后点击下一步，进行最后检查；
1-42
日志学院
6. 检查无误后，点击下一步，完成数据库数据源的添加。
1.4. 数据备份
日志种类不同，备份需求也会不同。总的来说，备份的需求大概是以下几种：
1、对日志原文进行备份：在Agent管理界面备份日志原文到磁盘上；
2、按系统类别进行备份：在“备份策略”处以Appname和日期进行数据备份，此处的备份是
从消息队列中实时接收并备份数据，可对删除的索引数据进行恢复；
以上方式，均可通过日志易产品前端界面进行配置。相应的配置说明如下：
备份方式 配置位置 作用
对日志原文进行备份 Agent管理界面 备份日志原文到磁盘上
按系统类别进行备份 备份策略 消息队列中实时接收并备份数据，可对删
除的索引数据进行恢复
日志原文备份（heka）
日志易原文备份有两种方式：
1、将日志原文备份在本地服务器上，此种方式直接在Agent管理界面进行配置即可；
2、将日志原文备份在NAS存储上，此种方式需要HekaAgent将数据发送至HekaServer，
由HekaServer完成集中备份。
日志易提供日志原文备份配置，要求：
•Heka 需升级到v2.2.0.21 以上版本；
•RizhiyiAgent 需升级到v2.2.0.6 以上版本。
两种日志原文备份的方式说明如下：
1-43
日志学院
本地备份使用说明
1、进入Agent管理界面，选择要进行备份的Agent，点击"备份配置",进入备份管理界面。
这时点击“数据源配置”，切换到数据源功能列表来添加数据源采集等。
2、备份配置管理界面如下：
其中，下方表格为目前运行中的备份策略，表格右侧可对备份策略进行删/改/停操作，备份
历史展示该备份策略的历史执行情况。
3、添加备份来源，点击“添加备份”，进入备份配置详情页。首先要选择文件或目录，点击
浏览，会弹出agent所在服务器的目录树，供选择具体的文件或目录。
 如果选中的是某个目录，那么需要配置白名单(需要监听目录下的哪些日志文件)；如果
选中的是某个文件，则无需选择白名单，选中的文件会自动加入白名单。白名单需要填
入一串正则表达式(注：AIXagent暂不支持正则，只能使用 *、? 通配符)，满足正则的
日志文件将被监听采集。
 如果要从白名单中过滤掉某些文件，可以用正则表达式配置黑名单，黑名单中的文件不
会被采集。(注：与白名单相似，只支持通配符，不支持正则，AIXagent暂不支持黑名
单) 。
 最后配置“只备份改时间前的文件”的时间，可以选择：天，小时，分钟。注意，我们要
备份的日志文件不能是正在滚动中的日志文件，否则文件的时间戳发生变化，会造成数
据无法备份，这时我们在下面的预览界面将无法预览该文件。
4、配置好选择来源页面后，点击“下一步”，预览匹配上规则的待备份文件。
1-44
日志学院
5、如果预览结果符合预期，点击"下一步",选择备份目的并对备份策略进行配置，配置项如
下：
目的对象：本地配置时，目的对象选择"本地磁盘"即可。
备份路径：备份文件存放的根目录，备份后的文件实际存放路径为
backup_directory/date/backup_name/filename+.${md5}+(.gz)
其中:
date使用待备份文件的最后更新时间，格式为yyyyMMdd
▪
backup_name为备份策略名
▪
md5是根据文件长度和头部64kb计算出来的md5，用来避免重复备份
▪
.gz是开启压缩后使用的文件名后缀
▪
◦ 备份策略名：字母+数字+下划线命名备份策略
◦ 执行周期：crontab格式(秒 分 时 日 月 星期)
◦ 超时时间：备份任务的超时时间，如果执行时间超过该时间，则本次备份将停止
◦ 压缩保存：是否采用gz格式保存备份后的文件
◦ 删除日志源：备份成功后，是否删除原始文件
6. 配置完成后，点击"下一步"，检查备份策略配置详情。
1-45
日志学院
7. 检查无误后点击"下一步"，完成本地备份策略添加。
集中备份使用说明
集中备份的逻辑如图所示：
其中：
AgentHeka将需要备份的文件通过Http协议将文件上传至ServerHeka；
ServerHeka通过高级配置启动备份用的Http服务，支持Agent上传的文件；
NAS将mount在每个ServerHeka主机上，上传文件最终会保存到NAS对应目录下(NAS挂
载操作需要针对不同集群情况手动进行)；
采用POST+multipart/form-data方式上传文件
所以，进行集中步骤大致有以下步骤：
1、确保NAS挂载正常；
2、向ServerHeka配置文件中添加 备份HTTP服务 配置；
3、在Agent配置界面，添加WEB集中备份（此时的目的对象为“ServerHeka”），完成配置。
NAS挂载方式请自行了解，或联系客户方工程师提供环境，其他两步的配置如下：
向ServerHeka添加备份HTTP服务配置
在Agent管理界面，点击“高级”，编辑挂载了NAS的ServerHeka的高级配置，在###Other
下追加如下配置：
[BackupHttpInput]
#Http服务监听端口
address=":10041"
1-46
日志学院
# 备份根目录 (典型场景是挂载在本地的NAS目录，或NAS目录下的某个子目录)directory
="/tmp/backup"
# 是否开启https传输，如果配成true，则需要去掉后续三行的注释 #cert_file和key_file为
https相关证书，需要提前部署 use_tls=false
#[BackupHttpInput.tls]
#cert_file="/opt/heka-2_2_0.11-linux-amd64/conf/cert.pem"
#key_file="/opt/heka-2_2_0.11-linux-amd64/conf/key.pem"
注：需确保AgentHeka到address的网络策略开通。
配置集中备份
大致步骤参考“本地备份”一节，区别在于，选择目的对象时，需要选择Http类型的目的对象：
 如果尚未创建期望的Http类型的目的对象，则选择"新建目的对象"
 编辑目的对象相关配置
 名称：字母+数字+下划线命名
 是否使用安全链接：这里请保持和ServerHeka一致（如果ServerHeka采用https方式
监听，则使用；否则不用)；如果不一致，则备份失败
 处理线程数：默认是1，如果备份策略较多可以适当调高
 服务器地址：Http服务器地址(IP+端口)，如果多个用逗号分隔
 超时秒数：Http超时时间
1-47
日志学院
 ◦ 目的对象配置完成后，点击保存
 ◦ 选择适当的Http对象，作为备份目的
此时的备份路径，将默认用采集AgentIP，最终文件备份路径为:ServerHeka机器上的
directory/backup_directory/date/backup_name/filename+.${md5}+(.gz)
1、directory为ServerHeka配置BackupHttpInput使用的directory；
2、backup_directory为AgentHeka添加备份任务时配置的备份路径，建议带上hostname或
ip等信息，方便后续管理；
3、date 使用待备份文件的最后更新时间，格式为yyyyMMdd；
4、backup_name 为备份任务名；
5、md5 是根据文件长度和头部64KB计算出来的md5，用来避免重复备份；
6、.gz 是开启压缩后使用的文件名后缀。
备份不占用日志易使用限额。
进入备份策略管理界面，还看查看指定备份策略的“备份历史”。历史页面将展示最近30天
历史策略执行的起止时间，以及执行期间被备份的文件明细，和备份结果。
1-48
日志学院
备份策略（archiver）
在“备份策略”处可以Appname和日期进行数据备份，此处的备份是从消息队列中实时接收
并备份数据。备份之后，如有数据误删，还可从已备份的数据中，对删除的索引数据进行恢
复；
“备份策略”的内容包括数据备份及数据恢复两部分。
数据备份
数据备份功能将从消息队列中实时接收并备份数据。以日期和appname两个层级进行文件
存储，并按指定的原始日志大小进行文件切分和压缩。目前只支持yotta索引，不支持自定
义的索引名。
实际的备份目录层级示例如下：
如果在多台服务器上启动了备份模块，请确保备份目录为共享存储。
进行数据备份有两个步骤：
1、确保Logriver模块的输出topic：Log_rivertopic已经创建；
2、进行备份配置；
Log_rivertopic创建