《软件调试》补编 
- 1 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
《软件调试》补编 
作者：张银奎 
2009 年 1 月 12 日 
《软件调试》补编 
- 2 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
大多数程序员的技术水平不如黑客的主要原因是他们远远不如黑客
那样重视和擅于使用调试技术。 
《软件调试》补编 
- 3 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
前    言 
总的来说，今天的软件很糟糕，而且一段时期内还会继续变得更糟。原因有
很多，关键的是错误观念大行其道，聊举数例。 
“写代码很容易，不需要那么资深的人”，于是乎软件白领变蓝领了，蓝领
还是大材小用，“软件民工刚刚好，性价比最高。” 
“我从来不调试我的程序，运行一下没有错误就可以了。”这是为什么使用
调试器来看时，很多软件有那么多明晃晃的问题。 
“XXX 很快呀”，还可以用它来写操作系统呢？！当我启动一个应用程序需
要 5 秒钟以上时，看着硬盘的灯疯狂的闪动，我恨不得快点把它从我的系统中删
掉。 
“抓 BUG 完全是程序员自己的事。”那么项目延迟了还是程序员自己的事
么？ 
“今天的硬盘空间大，CPU 速度快，内存条便宜，软件大一些，多用些资
源没关系。” 
事实上，没有简单的软件，无论是上层的应用程序，还是下层的驱动或者系
统程序。 
软件的特征决定了软件天生就需要像绣花那样精工细作。软件是给 CPU 来
运行的，让高速的 CPU 在软件编排的指令流上奔跑可谓是系千钧于一发。糟糕
的软件在浪费能源、也在浪费时间，如果套用鲁迅先生说的话，那么糟糕的软件
每天都在图财害命。 
如何才能让软件变得很精细，准确无误呢？不仔细看一看可以做到么？ 
有些软件可以工作，但是有时会出问题，糟糕的是，出了问题后没有什么办
法来寻找原因。在 XXX 做了一年多的开发之后，对此深有体会，一次我向在
XXX 上工作多年的一个朋友询问：“在 XXX 上调试主要靠什么方法呢？”他的
回答颇令人回味：“靠想！” 
“使劲想，然后加些 PRINT，逐步缩小范围…….” 
多么好的程序员呀！ 
老雷 
2009 年元月 
《软件调试》补编 
- 4 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
《软件调试》书友活动获奖名单 
整理和发布这份补编的主要目的是赠送给参加“2008《软件调试》以书会友”
活动的朋友们。这次活动从 2008 年 6 月 1 日开始，截止日期为 2008 年 12 月 31
日。从 6 月 11 日 Neilshu 第一个参与，到 12 月 31 日的 23 点 47 分 Vito1997 参
与，共有 22 位朋友参加了这次活动，收到照片大约 100 幅。 
参与这次活动的 22 位朋友是： 
Casechen 
Ccl 
ckj1234 
Coding 
Dbgsun 
Flyingdancex 
PI:EMAIL 
hnsy777 
KernelPanic 
Mabel 
Mybios 
Neilhsu 
Nightxie 
Pch 
s5689412 
shamexln 
speedingboy 
turboc 
Vito1997 
WANGyu 
xszhou1997 
yfliu 
经过博文视点的周老师和《软件调试》这本书的编辑团队以及作者的认真评
比，获奖结果如下： 
一等奖
一等奖
一等奖
一等奖一名
一名
一名
一名：
：
：
：Neilhsu 
奖品为《奔腾 4 全录：IA32 处理器宗谱》（The Unabridged Pentium 4: IA32 
Processor Genealogy）作者签名英文原版 
二等奖
二等奖
二等奖
二等奖两名
两名
两名
两名：
：
：
：mybios 和
和
和
和 nightxie 
奖品为《深入解析 Windows 操作系统 第 4 版》 
三等奖
三等奖
三等奖
三等奖三名
三名
三名
三名：
：
：
：yfliu、
、
、
、WANGyu 和
和
和
和 shamexln 
奖品为《Windows 用户态程序高效排错》 
所有参加活动的朋友都获得纪念奖，奖品是电子版本的《补编》。 
衷心感谢参加这次活动的所有朋友，愿我们的友谊永驻！ 
《软件调试》补编 
- 5 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
目    录 
补编内容 1 错误提示机制之消息框............................................................................................. 9 
13.1  MessageBox .................................................................................................................. 9 
13.1.1  MessageBoxEx................................................................................................. 10 
13.1.2  MessageBoxTimeout........................................................................................ 10 
13.1.3  MessageBoxWorker...........................................................................................11 
13.1.4  InternalDialogBox.............................................................................................11 
13.1.5  消息框选项（uType） .................................................................................... 12 
13.1.6  返回值.............................................................................................................. 13 
13.1.7  归纳.................................................................................................................. 13 
补编内容 2 堆检查之实例分析................................................................................................... 15 
23.16  实例分析................................................................................................................... 15 
23.16.1  FaultDll 和 FaultApp...................................................................................... 15 
23.16.2  运行调试版本................................................................................................ 16 
23.16.3  分析原因........................................................................................................ 17 
23.16.4  发布版本........................................................................................................ 18 
23.16.5  回放混乱过程................................................................................................ 19 
23.16.6  思考................................................................................................................ 20 
补编内容 4 异常编译................................................................................................................... 22 
24.6  栈展开......................................................................................................................... 22 
24.6.1  SehUnwind ....................................................................................................... 22 
24.6.2  全局展开.......................................................................................................... 24 
24.6.3  局部展开（Local Unwind） ........................................................................... 25 
24.7  __try{}__finally 结构 ................................................................................................. 27 
24.8  C++的 try{}catch 结构 ............................................................................................... 29 
24.8.1  C++的异常处理............................................................................................... 30 
24.8.2  C++异常处理的编译....................................................................................... 31 
24.9  编译 throw 语句.......................................................................................................... 35 
补编内容 5 调试符号详解........................................................................................................... 38 
25.9  EXE 和 Compiland 符号............................................................................................. 38 
25.9.1  SymTagExe[1].................................................................................................. 38 
25.9.2  SymTagCompiland[2] ...................................................................................... 40 
25.9.3  SymTagCompilandEnv[4]................................................................................ 40 
25.9.4  SymCompilandDetail[3]................................................................................... 41 
25.10  类型符号................................................................................................................... 42 
25.10.1  SymTagBaseType[16]..................................................................................... 42 
25.10.2  SymTagUDT[11]............................................................................................ 42 
《软件调试》补编 
- 6 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
25.10.3  SymTagBaseClass[18].................................................................................... 43 
25.10.4  SymTagEnum[12]........................................................................................... 44 
25.10.5  SymTagPointerType[14]................................................................................. 45 
25.10.6  SymTagArrayType.......................................................................................... 45 
25.10.7  SymTagTypedef[17] ....................................................................................... 45 
25.11  函数符号................................................................................................................... 46 
25.11.1  SymTagFunctionType[13] .............................................................................. 46 
25.11.2  SymTagFunctionArgType[13] ........................................................................ 46 
25.11.3  SymTagFunction [5] ....................................................................................... 47 
25.11.4  SymTagFunctionStart[21]............................................................................... 47 
25.11.5  SymTagFunctionEnd[22]................................................................................ 48 
25.11.6  SymTagLabel[9] ............................................................................................. 48 
25.12  数据符号................................................................................................................... 48 
25.12.1  公共属性........................................................................................................ 49 
25.12.2  全局数据符号................................................................................................ 50 
25.12.3  参数符号........................................................................................................ 50 
25.12.4  局部变量符号................................................................................................ 51 
25.13  Thunk 及其符号........................................................................................................ 52 
25.13.1  DLL 技术中的 Thunk.................................................................................... 52 
25.13.2  实现不同字长模块间调用的 Thunk............................................................. 52 
25.13.3  启动线程的 Thunk......................................................................................... 53 
25.13.4  Thunk 分类..................................................................................................... 53 
25.13.5  Thunk 符号..................................................................................................... 54 
补编内容 6 调试器标准............................................................................................................... 55 
28.9  JPDA 标准 .................................................................................................................. 55 
28.9.1  JPDA 概貌........................................................................................................ 55 
28.9.2  JDI .................................................................................................................... 56 
28.9.3  JVM TI ............................................................................................................. 57 
28.9.4  JDWP................................................................................................................ 60 
补编内容 7 WinDBG 内幕............................................................................................................ 62 
29.8  内核调试..................................................................................................................... 62 
29.8.1  建立内核调试会话.......................................................................................... 62 
29.8.2  等待调试事件.................................................................................................. 64 
29.8.3  执行命令.......................................................................................................... 65 
29.8.4  将调试目标中断到调试器 .............................................................................. 66 
29.8.5  本地内核调试.................................................................................................. 66 
29.9  远程用户态调试......................................................................................................... 67 
29.9.1  基本模型.......................................................................................................... 67 
29.9.2  进程服务器...................................................................................................... 67 
29.9.3  连接进程服务器.............................................................................................. 68 
29.9.4  服务循环.......................................................................................................... 68 
29.9.5  建立调试会话.................................................................................................. 69 
29.9.6  比较.................................................................................................................. 70 
补编内容 8 WMI ........................................................................................................................... 71 
《软件调试》补编 
- 7 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
WMI.................................................................................................................................................. 72 
31.1  WBEM 简介................................................................................................................ 72 
31.2  CIM 和 MOF............................................................................................................... 73 
31.2.1  类和 Schema .................................................................................................... 74 
31.2.2  MOF ................................................................................................................. 75 
31.2.3  WMI CIM Studio.............................................................................................. 76 
31.2.4  定义自己的类.................................................................................................. 78 
31.3  WMI 的架构和基础构件 ........................................................................................... 80 
31.3.1  WMI 的架构 .................................................................................................... 80 
31.3.2  WMI 的工作目录和文件................................................................................. 81 
31.3.3  CIM 对象管理器.............................................................................................. 82 
31.3.4  WMI 服务进程 ................................................................................................ 87 
31.3.5  WMI 服务的请求和处理过程......................................................................... 88 
31.4  WMI 提供器 ............................................................................................................... 90 
31.4.1  Windows 系统的 WMI 提供器 ....................................................................... 91 
31.4.2  编写新的 WMI 提供器.................................................................................... 92 
31.4.3  WMI 提供器进程 ............................................................................................ 96 
31.5  WMI 应用程序 ........................................................................................................... 97 
31.5.1  通过 COM/DCOM 接口使用 WMI 服务 ....................................................... 97 
31.5.2  WMI 脚本 ........................................................................................................ 98 
31.5.3  WQL................................................................................................................. 99 
31.5.4  WMI 代码生成器 .......................................................................................... 102 
31.5.5  WMI ODBC 适配器 ...................................................................................... 102 