Kubernetes Privilege Escalation:
Container Escape == Cluster Admin?
Yuval Avrahami & Shaul Ben Hai, Palo Alto Networks
#BHUSA  @BlackHatEvents 
whoami
â— Cloud security researchers @PANW
â— Vulnerability research in the cloud
â—‹
Azurescape
â— Threat hunting in the cloud
â—‹
Slioscape
Kubernetes Privilege Escalation:
Container Escape == Cluster Admin?
Agenda
â— Container Escapes
â— Kubernetes 101
â— Malicious Node
â— Attack Classes
â— Escape == Admin?
â— Recommendations & Takeaways
Container Escapes
Do containers contain?
â— Containers are great for packaging & deploying software
â— Weak security boundary
â— Escapes will inevitably occur
â—‹
Vulns in 2022 alone: DirtyPipe, containerd CVE-2022-23648, 
multiple kernel vulns @Google's kctf, cri-o CVE-2022-0811
â—‹
Misconfigurations: privileged containers, host mounts, etc
â—‹
In-the-wild malware: Siloscape, TeamTNT
â— What's the impact?
Kernel
Obvious Impact: Compromised Node
ğŸ”‘
Container Escape == Cluster Admin?
ğŸ”‘
Container Escape == Cluster Admin? (Feb)
â— We looked into the 
most popular 
platforms
â— In half, by default 
escape == admin
Terminology
â— Admin 
â— Admin-equivalent
Few trivial steps
Kubernetes 101
Kubernetes 101
â— Orchestrates pods 
(containers) on nodes 
(VMs)
â— It's everywhere
Kubernetes 101 - Authentication
â— Certificates: users & nodes
â— ServiceAccount tokens: pods 
Kubernetes 101 - Authorization (RBAC)
â— Perms expressed  
â—‹
list secrets, create pods
â— Perms grouped into Roles
â— Bindings grant Roles
â—‹
ns-scoped
â—‹
cluster-wide
Permission grant to Pod
list services
list pods
Grants Role to 
identity
Pod's SA token can list 
services & pods
Post Container Escape
Credentials on a Rogue Node
â— Kubelet credentials
â—‹
Restricted: NodeAuthorizer & 
NodeRestriction
â—‹
Node perms != admin
â— Neighboring pods' service accounts
â—‹
Permissions vary
Node's interesting permissions are 
largely its pods' permissions!
Trampoline Pods 
â— Powerful pods with enough permissions to 
bounce you around the cluster 
â—‹
Reach higher privileges
â—‹
Jump to other nodes
â—‹
Feel young again
Know Your Nodes
â— What pods run on your nodes?
â—‹
Applications 
â—‹
Add-on (Prometheus, Istio)
â—‹
System (kube-proxy, coredns)
â— Permissions blind spot: system & 
add-on pods
â—‹
Often as DaemonSets on all nodes
DaemonSets VS Pods
Trampolines Pods
â—‹
Attacker might hit jackpot
Trampoline DaemonSets
â—‹
Attacker guaranteed to hit 
jackpot
DaemonSets VS Pods
Trampolines Pods
â—‹
Attacker might hit jackpot
Trampoline DaemonSets
â—‹
Attacker guaranteed to hit 
jackpot
Real impact on escape == admin
Spotting Trampolines:
What Makes a Pod Bouncy?
Example Infra Pod
â— list services 
â— delete pods
â— create configmaps
â— update nodes/status
Is this pod powerful?
Powerful Permissions?
â— No public list
â—‹
"Is this add-on asking for risky permissions?"
â—‹
"Can I abuse this pod's perms for privEsc?"
â— Seemingly restricted perms surprisingly powerful
â— Define interesting attacks & classify perms
Kubernetes Attack Classes
â— Impersonate other identities / alter permissions
Manipulate AuthN / AuthZ
â— Impersonate other identities / alter permissions
â— escalate roles
Manipulate AuthN / AuthZ
update roles
escalate roles
Pod's Role
â— Impersonate other identities / alter permissions
â— escalate roles
Manipulate AuthN / AuthZ
update roles
escalate roles
* *
Pod's Role
â— Impersonate other identities / alter permissions
â— escalate roles
Manipulate AuthN / AuthZ
update roles
escalate roles
* *
Pod's Role
Acquire Tokens
â— Retrieve or create SA tokens 
â— Impact: does namespace host powerful SAs?
â—‹
kube-system ns
Acquire Tokens
â— list secrets
Acquire Tokens
â— list secrets
Remote Code Execution
â— Execute code on pods / nodes
create nodes/proxy
Remote Code Execution
â— Execute code on pods / nodes
create nodes/proxy
â— Move pods from one node to another
â—‹
Interesting business logic
â—‹
Pods with powerful SAs!
Steal Pods
â— update nodes/status
â— delete pods
Steal Pods
Steal Pods
â— update nodes/status
â— delete pods
â— update nodes/status
â— delete pods
Steal Pods
â— update nodes/status
â— delete pods
Steal Pods
Powerful Permissions By Attack Class
Manipulate AuthN \ AuthZ
â—
impersonate
â—
escalate
â—
bind
â—
approve signers
â—
update csr/approval
â—
control mutating webhooks
Remote Code Execution
â—
create pods/exec
â—
update pods/ephemeralcontainers
â—
create nodes/proxy
â—
control pods
â—
control pod controllers
â—
control mutating webhooks
Acquire Tokens
â—
list secrets
â—
create secrets
â—
create serviceaccounts/token
â—
create pods
â—
control pod controllers
â—
control validating webhooks
â—
control mutating webhooks
Steal Pods
â—
modify nodes
â—
modify nodes/status
â—
create pods/eviction
â—
delete pods
â—
delete nodes
â—
modify pods/status
â—
modify pods
Trampolines:
â— Pods with permissions to:
â—‹
Manipulate AuthN/AuthZ
â—‹
Acquire Tokens
â—‹
Remote Code Execution
â—‹
Steal Pods
â— Real shot at getting cluster admin
Escape == Admin?
Trampolines Across Popular Platforms
Analyzed Platforms
â— Focused on common infra components
â— Managed K8s Services & K8s Distributions 
â—‹
AKS, EKS, GKE, OpenShift
â— Container Network Interfaces (CNIs)
â—‹
Antrea, Calico, Cilium, WeaveNet
Trampoline DaemonSets (Feb 22)
â— Most (62.5%) installed 
Trampoline DS by 
default!
Container Escape == Cluster Admin? (Feb)
â— In half the platforms 
escape == admin by 
default
â—‹ (no panic pls)
Attack on a Popular K8s Platform
Cilium
â— Cilium - popular Container Network Interface (CNI)
â—‹
GKE Dataplane v2
â— Showcases a number of attack classes
â— Released fixes!
Cilium: Trampolines
â— cilium DaemonSet 
â—‹
Can delete pods & update nodes/status (Steal Pods)
â— cilium-operator Deployment 
â—‹
Can list secrets (Acquire Tokens)
Cilium: Trampolines
â— Compromised pod and escaped to node
â— Goal: cluster admin
Cilium: Trampolines
1. Zero other nodes' capacity & delete cilium-operator
Cilium: Trampolines
1. Zero other nodes' capacity & delete cilium-operator
Cilium: Trampolines
1.
Zero other nodes' capacity & delete cilium-operator
2. Abuse operator to retrieve powerful built-in token
Cilium: Trampolines
1.
Zero other nodes' capacity & delete cilium-operator
2. Abuse operator to retrieve powerful built-in token
CRAC SA can 
escalate roles
Cilium: Trampolines
1.
Zero other nodes' capacity & delete cilium-operator
2.
Abuse operator to retrieve powerful built-in token
3. Add admin perms to CRAC's ClusterRole
Demo!
Cilium: Trampolines
1. Zero other nodes' pod capacity & delete cilium-operator
2. Abuse cilium-operator to retrieve powerful built-in token
3. Add admin perms to the ClusterRole binded to our token
Steal Pods
Manipulate AuthN/Authz
Acquire Tokens
Fixes by Affected Platforms
Fixes
â— Disclosed all findings
â—‹
Great experience all around (:
â— Most fixed!
â—‹
Remove
â—‹
Relocate
â—‹
Restrain
â—
But countless other K8s add-ons 
& distribution out there
Platform
Had Trampoline 
DaemonSets
Fixed
AKS
Yes
No
EKS
Yes
Yes, >=v1.18
GKE
With Dataplane v2
Yes, >=1.23.4-gke.900, 13022$ Bounty
OCP
Yes
Yes, >=v4.11
Antrea
Yes
Yes, v1.6.1 + an admission policy
Calico
No
-
Cilium
Yes
Yes, >=v1.12.0-rc2
Weave Net
No
-
Identifying Risky Perms
rbac-police
â— New open-source tool 
â— Evaluate the RBAC perms of pods, SA & nodes
â— ~20 policies out-of-the-box
â—‹
Each targets risky perm / privEsc technique
â—‹
Identify powerful pods & the attacks they enable
â— Customizable! policies written in Rego (OPA)
â—‹
CRDs? Platform specific attacks? PrivEsvs we missed?
github.com/PaloAltoNetworks/rbac-police
Policy & 
Severity
Violating 
SAs and 
their Pods
Checkov
â— Open source Infra-as-Code (IaC) security scanner
â— Alerts on risky perms before they're installed to cluster
â—‹
Inspect add-ons prior to deployment
github.com/bridgecrewio/checkov
Takeaways
Takeaways
â— Trampolines introduce new privEsc avenues to K8s
â—‹
Up to escape == admin
â— K8s attack classes & powerful perms
â— Tricky to safely configure RBAC
â—‹
Seemingly restricted perms may allow privEsc 
â—‹
Not in checklists / benchmarks
â— Good RBAC hygiene is key: 
â—‹
Regularly monitor RBAC (rbac-police / Checkov)
â—‹
Minimize distribution of powerful tokens
â—‹
Admission / audit policies to detect attacks! (see report)
Questions?
rbac-police
Report