å¯¼å…¥ CrossC2Kit_Loader.cna
**æ³¨æ„**
å…¶å®å¯ä»¥ä¸ç”¨ CrossC2.cna è¿™ä¸ªè„šæœ¬, ç›´æ¥åœ¨ cs æœåŠ¡å™¨çš„å‘½ä»¤è¡Œä¸‹ç”Ÿæˆå³å¯, æ³¨æ„ç”Ÿæˆæ—¶å€™çš„å›è¿åœ°å€, å¦‚æœæ˜¯åŸŸå‰ç½®è¦æŠŠåŸŸå‰ç½®çš„ ip æŒ‡å®šï¼Œç„¶å host å¤´è¦åœ¨ profile é‡ŒæŒ‡å®šï¼Œå’Œ genCrossC2.Linux æ²¡æœ‰å…³ç³»
å¦‚æœè¿˜æ˜¯ä¸Šä¸äº†çº¿,å»ºè®®ä»”ç»†çœ‹çœ‹è¿™å‡ ä¸ªissue
- https://github.com/gloxec/CrossC2/issues/60
- https://github.com/gloxec/CrossC2/issues/89
- https://github.com/gloxec/CrossC2/issues/65
å¦å¤–ï¼Œmac m1 ä¸‹ç”Ÿæˆçš„ shell ï¼Œx86 æœºå™¨æ˜¯ç”¨ä¸äº†çš„ï¼Œæ‰€ä»¥å»ºè®® cs å…¨å¥—éƒ½åœ¨ x86 çš„æœºå™¨ä¸Šå¼„
**mac ğŸ**
- [Macosé’“é±¼ä¸Šçº¿CSè¸©å‘æµç¨‹](https://mp.weixin.qq.com/s/ZptprvkNXRP0PNpmoXpbFg)
---
## CS æ ·æœ¬
ç›®å½•ä¸­æœ‰ä¸€ä¸ª CobaltStrike.jar æ–‡ä»¶ï¼Œç›´æ¥è§£å‹ï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªåä¸º resources çš„æ–‡ä»¶å¤¹ï¼Œå°±æ˜¯ CobaltStrike çš„é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬åœ¨ CobaltStrike æ§åˆ¶å°ç”Ÿæˆçš„æœ¨é©¬éƒ½æ¥æºäºè¿™ä¸ªæ–‡ä»¶å¤¹ã€‚
å¯ä»¥ç›´æ¥åˆ†æè¿™é‡Œé¢çš„æ ·æœ¬ï¼Œæå–è§„åˆ™è¿›è¡ŒæŸ¥æ€ã€‚
---
## CNA æ‰©å±•
Cobalt Strike å¯ä»¥ä½¿ç”¨ AggressorScripts è„šæœ¬æ¥åŠ å¼ºè‡ªèº«ï¼Œèƒ½å¤Ÿæ‰©å±•èœå•æ ï¼ŒBeacon å‘½ä»¤è¡Œï¼Œææƒè„šæœ¬ç­‰
**ç›¸å…³æ–‡ç« **
- https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/agressor_script.htm
**CSæ’ä»¶èµ„æº**
- [rmikehodges/cs-ssl-gen](https://github.com/rmikehodges/cs-ssl-gen) sslgen å°†å®‰è£…ä¸€ä¸ª letsencrypt è¯ä¹¦å¹¶ä»ä¸­åˆ›å»ºä¸€ä¸ª Cobalt Strike å¯†é’¥åº“.
- [uknowsec/SharpToolsAggressor](https://github.com/uknowsec/SharpToolsAggressor) - å†…ç½‘æ¸—é€ä¸­å¸¸ç”¨çš„ c# ç¨‹åºæ•´åˆæˆ cs è„šæœ¬, ç›´æ¥å†…å­˜åŠ è½½.
- [DeEpinGh0st/Erebus](https://github.com/DeEpinGh0st/Erebus) CobaltStrike åæ¸—é€æµ‹è¯•æ’ä»¶
- [QAX-A-Team/EventLogMaster](https://github.com/QAX-A-Team/EventLogMaster) - RDP æ—¥å¿—å–è¯ & æ¸…é™¤æ’ä»¶
- [outflanknl/Spray-AD](https://github.com/outflanknl/Spray-AD) - Cobalt Strikeå·¥å…·ï¼Œç”¨äºå®¡æ ¸ AD ç”¨æˆ·å¸æˆ·ä¸­çš„å¼±å¯†ç 
- [gloxec/CrossC2](https://github.com/gloxec/CrossC2) - generate CobaltStrike's cross-platform payload
- [lintstar/LSTAR](https://github.com/lintstar/LSTAR) - LSTAR - CobaltStrike ç»¼åˆåæ¸—é€æ’ä»¶
- [AttackTeamFamily/cobaltstrike-bof-toolset](https://github.com/AttackTeamFamily/cobaltstrike-bof-toolset) - åœ¨cobaltstrikeä¸­ä½¿ç”¨çš„bofå·¥å…·é›†ï¼Œæ”¶é›†æ•´ç†éªŒè¯å¥½ç”¨çš„bofã€‚
- [outflanknl/PrintNightmare](https://github.com/outflanknl/PrintNightmare) - CVE-2021-1675 / CVE-2021-34527 exploit.
- [helpsystems/nanodump](https://github.com/helpsystems/nanodump) - Dumping LSASS has never been so stealthy
- [optiv/Registry-Recon](https://github.com/optiv/Registry-Recon) - Cobalt Strike Aggressor Script that Performs System/AV/EDR Recon
- [mgeeky/cobalt-arsenal](https://github.com/mgeeky/cobalt-arsenal) - My collection of battle-tested Aggressor Scripts for Cobalt Strike 4.0+
---
## é€šä¿¡æ‰©å±•
Cobalt Strike å¯ä»¥å¼•ç”¨å…¶ä»–çš„é€šè®¯æ¡†æ¶ ExternalC2ï¼ŒExternalC2 æ˜¯ç”± Cobalt Strike æå‡ºçš„ä¸€å¥—è§„èŒƒ/æ¡†æ¶ï¼Œå®ƒå…è®¸é»‘å®¢æ ¹æ®éœ€è¦å¯¹æ¡†æ¶æä¾›çš„é»˜è®¤ HTTP(S)/DNS/SMB C2 é€šä¿¡é€šé“è¿›è¡Œæ‰©å±•ã€‚
**ç›¸å…³æ–‡ç« **
- https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_main.htm
- https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2-extend_main.htm
**Profile èµ„æº**
C2 Profile å¯ä»¥è°ƒæ•´ä¼ è¾“è¿‡ç¨‹ä¸­çš„æµé‡, ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥éšè”½ C2 æœåŠ¡å™¨
- [rsmudge/Malleable-C2-Profiles](https://github.com/rsmudge/Malleable-C2-Profiles) - This repository is a collection of Malleable C2 profiles that you may use. These profiles work with Cobalt Strike 3.x.
- [threatexpress/malleable-c2](https://github.com/threatexpress/malleable-c2) - Cobalt Strike Malleable C2 Design and Reference Guide
- [HuskyHacks/CobaltNotion](https://github.com/HuskyHacks/CobaltNotion) - A spin-off research project. Cobalt Strike x Notion collab 2022
**è¾…åŠ©é¡¹ç›®**
- [CodeXTF2/Burp2Malleable](https://github.com/CodeXTF2/Burp2Malleable) - Quick python utility I wrote to turn HTTP requests from burp suite into Cobalt Strike Malleable C2 profiles
**Malleable C2**
Beacon ä¸­çš„ http é€šè®¯ç”± Malleable-C2 é…ç½®æ–‡ä»¶å®šä¹‰ï¼Œåœ¨å¯åŠ¨ teamserver æ—¶æ¥æŒ‡å®šæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶, æ¯ä¸ª CS åªèƒ½è½½å…¥ä¸€ä¸ªé…ç½®æ–‡ä»¶, å¤šä¸ªæ–‡ä»¶éœ€è¦å¯åŠ¨å¤šä¸ª teamserver
ç›®å½•ä¸‹çš„ c2lint æ–‡ä»¶å¯ä»¥æ£€æµ‹é…ç½®æ–‡ä»¶çš„è¯­æ³•é—®é¢˜å’Œæµ‹è¯•
```bash
chmod +x c2lint
./c2lint [/path/to/my.profile]
```
### profile è¯­æ³•
**ç®€å•ä¸¾ä¾‹**
```
#
# Backoff POS Malware
#
# This profile takes steps to dress up the POST side of Beacon's C2 to
# look like Backoff. The GET side is left generic.
#
```
æ³¨é‡Šç¬¦å· `#`
```
set sample_name "Backoff POS Malware";
set sleeptime "30000"; # use a ~30s delay between callbacks
set jitter    "10";    # throw in a 10% jitter
```
é€‰æ‹©èµ‹å€¼ `set` ç”¨æ¥è®¾ç½®ä¸€äº›ç¨‹åºçš„é»˜è®¤å€¼ è¯­å¥ä»¥; ç»“æŸ,ç±»ä¼¼JavaScript.
ä»£ç ä¸­ `set sleeptime "30000";` å³ä¸ºè®¾ç½®å¿ƒè·³æ—¶é—´ä¸º30000æ¯«ç§’ï¼Œ`set jitter "10";` ä¸ºé»˜è®¤æŠ–åŠ¨ç³»æ•°ï¼ˆ0-99%ï¼‰
```
set useragent "Mozilla/5.0 (Windows NT 6.1; rv:24.0) Gecko/20100101 Firefox/24.0";
```
è®¾ç½® user-agent
**Data Transform Language**
```
http-get {
    set uri "/updates";
    client {
        metadata {
            netbiosu;
            prepend "user=";
            header "Cookie";
        }
    }
    server {
        header "Content-Type" "text/plain";
        output {
            base64;
            print;
        }
    }
}
```
æ•°æ®è½¬æ¢,CSå†…ç½®çš„å‡ ç§ç¼–ç 
Statement | Action |  Inverse
-|-|-
append "string"	 | Append "string"	| Remove last LEN("string") characters
base64	| Base64 Encode	| Base64 Decode
base64url	| URL-safe Base64 Encode |	URL-safe Base64 Decode
mask	| XOR mask w/ random key	| XOR mask w/ same random key
netbios	| NetBIOS Encode 'a'	| NetBIOS Decode 'a'
netbiosu	| NetBIOS Encode 'A'	| NetBIOS Decode 'A'
prepend "string" |	Prepend "string" |	Remove first LEN("string") characters
æ•°æ®è½¬æ¢è¯­å¥å¯ä»¥ä»»æ„æ•°é‡é¡ºåºç»„åˆ,ä»¥ç»ˆæ­¢è¯­å¥ç»“æŸ,åœ¨è½¬æ¢ä¸­åªèƒ½ä½¿ç”¨ä¸€ä¸ªç»ˆæ­¢è¯­å¥
Statement | What
-|-|
header "header" |Store data in an HTTP header
parameter "key" | Store data in a URI parameter
print   | Send data as transaction body
uri-append | Append to URI
ç»ˆæ­¢è¯­å¥å°†è½¬æ¢åçš„æ•°æ®å‚¨å­˜åˆ° Http å¤´ä¸­ï¼Œå‚æ•°ç»ˆæ­¢è¯­å¥å°†è½¬æ¢çš„æ•°æ® print æ¥æœ€åå‘é€è¿™äº›ç¼–ç çš„æ•°æ®
print æ˜¯ `http-get.server.output`ï¼Œ`http-post.server.output` å’Œ `http-stager.server.output` çš„ç»ˆæ­¢è¯­å¥é…åˆä¸Šæ–‡ä»£ç å¯ä»¥çœ‹å‡ºã€‚
å…¶ä»–å—ä½¿ç”¨ `header`ï¼Œ`parameter`ï¼Œ`print` å’Œ `uri-append` `termination` è¯­å¥, å¦‚æœåœ¨ `http-post.client.output` ä¸Šä½¿ç”¨ `header` `parameter` `uri append` `termination` è¯­å¥ï¼Œbeacon ä¼šå°†å…¶å“åº”åˆ†å—åˆ°ä¸€ä¸ªåˆç†çš„é•¿åº¦ï¼Œä»¥é€‚åº”äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ã€‚
**Strings**
Beacon çš„ Profile è¯­æ³•å¯ä»¥å¤šä¸ªåœ°æ–¹ä½¿ç”¨ Strings
Value | Special Value
-|-|
"\n"  |  Newline character
"\r"   | Carriage Return
"\t"   | Tab character
"\u####"  |  A unicode character
"\x##"  | A byte (e.g., \x41 = 'A')
"\\"   | \
**Options**
Beacon çš„é»˜è®¤å€¼, åˆ†ä¸ºå…¨å±€å’Œæœ¬åœ°, å…¨å±€æ›´æ”¹ Beacon çš„è®¾ç½®ï¼Œæœ¬åœ°ç”¨äºç‰¹å®šäº‹åŠ¡ã€‚
Option | Context | Default Value | Changes
-|-|-|-|
amsi_disable  | null  |    false  | (Attempt to) disable AMSI for execute-assembly, powerpick, and psinject
dns_idle    | null |    0.0.0.0 | IP address used to indicate no tasks are available to DNS Beacon; Mask for other DNS C2 values
dns_max_txt  | null |   252   | Maximum length of DNS TXT responses for tasks
dns_sleep    | null |   0  | Force a sleep prior to each individual DNS request. (in milliseconds)
dns_stager_prepend   | null  |   null  |    Prepend text to payload stage delivered to DNS TXT record stager
dns_stager_subhost   | null |   .stage.123456.    | Subdomain used by DNS TXT record stager.
dns_ttl  | null |   1    |  TTL for DNS replies
host_stage   | null    |   true     |  Host payload for staging over HTTP, HTTPS, or DNS. Required by stagers.
jitter     | null  |   0     | Default jitter factor (0-99%)
maxdns     | null  |   255   | Maximum length of hostname when uploading data over DNS (0-255)
pipename     | null   |    msagent_##   |  Name of pipe to use for SMB Beacon's peer-to-peer communication. ## is replaced with a number unique to your team server.
pipename_stager  | null   |    status_##    |  Name of pipe to use for SMB Beacon's named pipe stager. ## is replaced with a number.
sample_name   | null   |   My Profile   |  The name of this profile (used in the Indicators of Compromise report)
sleeptime     | null   |   60000     | Default sleep time (in milliseconds)
spawnto_x86   | null   |   %windir%\syswow64\rundll32.exe   |  Default x86 program to open and inject shellcode into
spawnto_x64   | null     | %windir%\sysnative\rundll32.exe  |  Default x64 program to open and inject shellcode into
tcp_port     | null    |   4444     |  TCP Beacon listen port
uri   | http-get,http-post    |  [required option]  |   Transaction URI
uri_x86   | http-stager      | null |  x86 payload stage URI
uri_x64   | http-stager      | null | x64 payload stage URI
useragent    |null  |     Internet Explorer (Random)   |  Default User-Agent for HTTP comms.
verb     |  http-get,http-post   | GET,POST     |  HTTP Verb to use for transaction
**Beacon HTTP Transaction**
HTTPè¯·æ±‚ å‚æ•°
Request | Component | Block | Data
-|-|-|-|
http-get   |   client  |  metadata   |   Session metadata
http-get    |  server  |  output  |  Beacon's tasks
http-post  |   client  |  id  |  Session ID
http-post   |  client  |  output  |  Beacon's responses
http-post   |  server   | output  |  Empty
http-stager  | server |   output  |  Encoded payload stage
**HTTP Staging**
Beacon æ˜¯ä¸€ä¸ªåˆ†é˜¶æ®µçš„ payloadï¼Œæœ‰æ•ˆè´Ÿè½½ç”± stager ä¸‹è½½å¹¶æ³¨å…¥å†…å­˜ï¼Œåœ¨ç›®æ ‡å†…å­˜ä¸­æœ‰ Beacon ä¹‹å‰ HTTP GET å’Œ HTTP POST ä¸ä¼šç”Ÿæ•ˆã€‚ Malleable C2 çš„ http-stager å—å¯è‡ªå®šä¹‰ HTTP åˆ†æ®µè¿‡ç¨‹ã€‚
```
http-stager {
      set uri_x86 "/get32.gif";
      set uri_x64 "/get64.gif";
```
uri_x86 é€‰é¡¹è®¾ç½® URI ä¸‹è½½ x86 çš„ payload,uri_x64 é€‰é¡¹è®¾ç½® URI ä¸‹è½½ 64 ä½çš„ payload ã€‚
**Self-signed Certificates with SSL Beacon**
HTTPS Beacon åœ¨å…¶é€šä¿¡ä¸­ä½¿ç”¨ HTTP Beacon çš„æŒ‡ç¤ºç¬¦, Malleable C2 é…ç½®æ–‡ä»¶è¿˜å¯ä»¥æŒ‡å®š Beacon C2 æœåŠ¡å™¨çš„è‡ªç­¾å SSL è¯ä¹¦çš„å‚æ•°ã€‚
```
https-certificate {
      set CN       "bobsmalware.com";
      set O        "Bob's Malware";
}
```
è¯ä¹¦å‚æ•°
Option | Example | Description
-|-|-|
C   |  US   | Country
CN   | beacon.cobaltstrike.com  | Common Name; Your callback domain