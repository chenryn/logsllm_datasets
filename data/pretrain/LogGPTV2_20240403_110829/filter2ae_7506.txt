## 引言
近期，笔者在研究WordPress的安全漏洞。Sucuri、RIPS和Fortinet等安全公司对WordPress进行了深入的研究，因此笔者计划陆续翻译一些有趣的文章，与大家分享并共同学习。本文来自Sucuri Labs，介绍了WordPress插件WP Statistics的一个存储型XSS漏洞及其与防火墙的组合利用。文中括号加粗部分为译者的个人见解，欢迎大家在评论区讨论。

## 漏洞概述
**风险评级：** 次要（可用于有针对性攻击，但需要特定配置后才能利用）
**漏洞名称：** 存储型XSS漏洞
**修复版本：** 12.6.7

### 插件信息
- **插件名称：** WP Statistics
- **用户数量：** 50万活跃安装
- **受影响版本：** 12.6.7之前的版本
- **漏洞描述：** 在某些配置下存在未经身份验证的存储型XSS漏洞，默认设置不易受到攻击。

## 时间线
- **2019/06/26：** 初步与开发人员取得联系。
- **2019/06/27：** 开发人员回应，披露漏洞。
- **2019/06/30：** 提议审核补丁。
- **2019/07/01：** 发布12.6.7版本，修复漏洞。

## 通过IP操作存储型XSS漏洞
在某些配置情况下，该插件使用HTTP头部来查找访问者的IP地址。在使用防火墙的环境中，这种做法是常见的，否则所有访问者都会显示代理IP而不是实际IP。

### 为什么使用防火墙需要使用Header
默认情况下，网站可以轻松找到访问用户的IP地址。但在使用防火墙时，请求会先经过防火墙，导致网站无法直接获取原始IP。为了解决这个问题，防火墙通常会在HTTP头部中添加用户原始IP，使网站能够正确识别用户。

#### 多层防火墙
当攻击者构造虚假的forwarded IP时，可能会使服务器误认为这是原始IP。在多层防火墙的情况下，每一层都可能添加一个IP地址，具体取决于防火墙的配置。

大多数防火墙会将用户的真实IP加入自定义字段，如`X_SUCURI_CLIENTIP`。即使攻击者在报文中构造了这个字段，SUCURI防火墙也会覆盖它。在多个代理的情况下，可以使用`X-forwarded-for`来获取用户真实IP。

### 漏洞分析
该插件的漏洞源于不对用户IP进行过滤或验证。只有当插件使用HTTP头部来识别访问者的IP地址时，才会触发漏洞。漏洞利用条件如下：
- 防火墙必须可绕过，即网站接受所有连接而不仅仅是防火墙端口转发的连接。
- 或者防火墙必须原样保留header，如果其存在的话。

在这两种情况下，forwarded值完全由攻击者控制。启用WAF可以防止攻击，除非攻击者绕过了WAF或防火墙被配置为保持IP不变。如果之前使用过WAF但在未更新插件设置的情况下停止运行，则可能受到攻击。

### 技术细节
插件使用`class-wp-statistics.php`文件中的`get_IP`方法。IP变量的默认值为设置中提供的header，默认情况下为`REMOTE_ADDR`。如果有多个以逗号分隔的IP地址，插件将使用最后一个有效的IP地址。由于未使用`FILTER_VALIDATE_IP`方法进行清理或验证，当header中没有多个IP地址时，它将按原样存储。

在“top visitor”、“online users”和“最近访问者”等模块中，访问者IP作为页面的一部分输出。如果用户选择`X_Forwarded_For`方式获取IP，攻击者可以在`X_Forwarded_For`中传入XSS payload，最终注入恶意代码并执行。

## 结论
尽管访问者的IP地址看起来是安全的，但由于开发人员的假设，攻击者可以在管理页面上注入恶意代码，导致整个网络瘫痪。为了不受此漏洞影响，强烈建议用户尽快将插件更新到12.6.7版本。

## 修复措施
WP Statistics在12.6.7版本中使用`esc_html`对获取到的IP进行过滤。虽然现在仍然可以在header里传payload，但由于`esc_html`的转义，payload在页面渲染时已经失效。

**原文地址**：[链接]

希望这篇文章对大家有所帮助，欢迎在评论区交流讨论！