# 【技术分享】CFIRE：如何绕过Cloudflare安全防护

## 译文声明
本文为翻译文章，原文来源：rhinosecuritylabs.com  
原文地址：[链接]  
译文仅供参考，具体内容及含义以原文为准。

## 译者信息
- **译者**：testvul_001
- **预估稿费**：170 RMB
- **投稿方式**：发送邮件至 linwei#360.cn 或登录网页版在线投稿

## 前言
Cloudflare 是一家提供 DNS 服务（包括 WAF 和 DDoS 防护）的云安全供应商。如果配置得当，这些安全服务可以很好地隐藏网站的真实 IP 地址，并发挥 Cloudflare 的安全过滤能力。在无法获取服务器真实 IP 的情况下，攻击者很难直接对目标发起攻击。然而，随着架构和 DNS 记录的持续增长，配置可能会发生变化，这可能会导致一些问题。

在本文中，我们将介绍几种策略来绕过 Cloudflare 的安全服务并发现云服务器的真实 IP 地址。同时，我们还会介绍一个工具——CFire，它可以帮助安全工程师发现他们自己云架构中的配置错误。

## CFire 简介
CFire 使用多种技术来发现 Cloudflare 后面的真实 IP 地址，并且能够管理相关数据。尽管这个工具刚刚诞生，但在我们的渗透测试中已经显示出其实用性。因此，我们将它介绍给社区，希望它能帮助更多人，并在未来发现更多云供应商的配置错误（如 AWS Cloudfront）。

从 Rhino Security Labs 的 GitHub 下载 CFire 脚本后，需要执行一些安装步骤，首先是安装或更新 CrimeFlare 数据库。CFire 默认查询本地的 CrimeFlare sqlite3 数据库，并使用 Sublist3r 模块进行子域名枚举。

## 发现真实 IP
目前已有多种方法可以发现 Cloudflare 后面的真实 IP 地址，这些方法的一个共同特点是利用配置错误来泄露 IP 地址。

### 1. 普通 DNS 记录误配置
最常见的技术之一是寻找子域名或用于后台服务的域名。在过去，Cloudflare 的自动配置有时会泄露 Web 服务器的 IP 地址。许多用户并不知道这些 DNS 记录的存在，这种方法存在了多年。目前，Cloudflare 已经修复了这个问题，但这种方法仍适用于某些旧设置。

### 2. MX 记录
不同的环境有不同的需求，有些客户喜欢自己搭建邮件服务。根据 RFC5321，MX 记录用于指定优先级最高的邮件服务器。如果目标没有使用第三方邮件服务，其邮件服务器很可能与 Web 服务器在同一网络内。在这种情况下，通过简单的 DNS 查询即可发现真实 IP。

### 3. FTP/SCP
类似于 MX 记录，许多组织需要将外部资源传输到内部服务器。正确的方法是使用 VPN 允许远程办公的员工安全地传输文件到内部网络。不幸的是，许多老旧架构中仍然使用 FTP/SCP 服务，这大大增加了攻击者发现真实 IP 的机会。

### 4. WebSocket
尽管 Cloudflare 最近开始支持 WebSocket (WS) 技术，但许多客户尚未迁移他们的 WS 服务。WS 可用于发现真实 IP，因为它在 HTTP(S) 握手后需要在客户端和服务端之间保持持久连接。2014 年以前，Cloudflare 不支持 WS 技术，因为它们使用的 NGINX 服务器直到 2013 年底才支持 WS 代理。浏览某个网站时，我发现尽管该站点的主站已使用 Cloudflare 防护，但其 WS 服务器却暴露了真实 IP。结果表明，WS 服务器使用的 IP 地址也是主站使用的 IP 地址。

### 5. 旧的 DNS 记录
CrimeFlare 项目是一个研究数据库，尽管其主要目的是发现服务背后的犯罪行为，但攻击者也可以利用它来发现潜在的 IP 泄露。CrimeFlare 没有详细描述其数据收集方法，但我们可以相信开发者每周都会查询大量域名、相关的域名服务器、IP 地址和 SSL 证书信息，并将这些信息分组存入数据库。目前，CrimeFlare 已开放成立以来的数据，研究人员可以利用这些数据分析 Cloudflare 用户的趋势。在开发 CFire 项目的过程中，我们创建了一个 SQLite3 数据库和一个查询工具，如下例所示：

### 6. SSRF 漏洞
Server-Side Request Forgery (SSRF) 漏洞允许攻击者代理访问任意资源（通常是内部服务）。已经有大量关于 SSRF 的研究，SSRF 不仅可以用于探测应用所处的生产环境，还可以用于发现 Cloudflare 隐藏的真实 IP。

我们使用安装了有漏洞的 Nelio AB Testing 4.5.8 插件的 WordPress 进行测试。该插件的 /ajax/iesupport.php 页面存在 SSRF 漏洞，无需身份验证即可触发。由于缺乏有效的验证，攻击者可以利用此漏洞访问任何站点，即使禁止访问内部资源，也可以通过访问自己的服务器来获取隐藏在 Cloudflare 后面的 Web 服务器的真实 IP。

## 总结
与 Amazon Web Services S3 Buckets 类似，一个小的配置改变也会对安全性产生重大影响。

1. Cloudflare 是一个有用的云安全工具，可以保护你的 IP 和资产。
2. Cloudflare 只有在正确配置下才能发挥作用。
3. 如果你从 Cloudflare 迁移到“直接 IP”DNS 服务商，IP 仍然会暴露。
4. 子域名绕过 Cloudflare 通常会暴露所有 DNS 记录。

CFire 将加速安全研究中寻找真实 IP 的繁琐过程。我们开发这个工具的目的是提醒人们，虽然 Cloudflare 很好，但我们仍需进行正确的配置来保护自己的资产。