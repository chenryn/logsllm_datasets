Wmicookr.dll 
WMI 高性能计数器数据加工期（Cooker）。 
Msiprov.dll 
MSI（MS Installer）提供器。 
Wbemcntl.dll 
WMISnapin 组件，即配置 WMI 的 MMC（Microsoft Management Console）
插件。 
Repdrvfs.dll 
包含了管理 CIM 对象数据仓库的各个类，参见下文。 
Scrcons.exe 
供脚本（Active Scripting）使用的事件消耗器提供器。 
Fastprox.dll 
包含了用于进程间调用和 RPC通信的类和函数，又称为 Microsoft WBEM 
Call Context。 
Wbemcons.dll 
命令行的事件消耗器提供器。 
Wmitimep.dll 
当前时间提供器。 
Esscli.dll 
事件子系统的过滤器列集代理（filter marshaling proxy）。 
Wbemess.dll 
WMI 的事件子系统。 
Fwdprov.dll 
转寄（Forwarding）事件提供器和转寄事件消耗器提供器。 
Wbemcons.dll 
日志文件（Log File）和 NT 事件日志事件消耗器提供器。 
Wmimsg.dll 
消息服务，RPC 消息收发器（Receiver 和 Sender）。 
Wbemess.dll 
新的事件子系统。 
Ntevt.dll 
WMI 事件日志（Eventlog）事件提供器。 Event Provider 
tmplprov.dll 
模版（Template）提供器。 
trnsprov.dll 
Microsoft WBEM Transient Instance Provider 
Unsecapp.exe 
非安全套间（Unsecured Apartment）进程，用于需要穿过防火墙的 RPC
通信时向 MMC 或客户程序返回调用结果。 
updprov.dll 
Microsoft WBEM Updating Consumer Provider 
viewprov.dll 
Microsoft WBEM View Provider 
policman.dll 
安全策略状态提供器。 
wmiprvsd.dll 
WMI 提供器子系统 DLL。 
wmiprvse.exe 
WMI 提供器子系统的宿主进程。 
wmidcprv.dll 
提供器子系统的非耦合（Decoupled）提供器注册和事件管理。 
31.3.3  CIM 对象管理器 
CIM 对象管理器（CIM Object Manager，简称 CIMOM）是 WMI 的核心部件。它负责
管理和维护系统中的类和对象，也是 WMI 管理程序（消耗器）和 WMI 提供器之间进行
交互的桥梁。从进程的角度看，CIMOM 是工作在 WMI 服务器进程中的一系列动态链接
库，它们利用 COM/DCOM 技术相互协作。对外也是以 COM 接口的形式公开它们的服务。 
《软件调试》补编 
- 83 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
CIM 标准中没有规定 CIMOM 该如何实现，微软也没有公开过 WMI 的 CIMOM 的内
部实现方法。所有的文档中都是将其模糊的看作一个整体，称之为 CIMOM。但是因为
CIMOM 是 WMI 的核心，了解 CIMOM 是了解 WMI 的捷径。处于这一考虑，笔者对 CIMOM
做了很多探索，仅供读者参考。必须说明的是，这些内容没有得到微软的认可和确认，也
会因为 Windows 的版本不同而有所不同。 
CWbemClass 类
类
类
类 
WBEMCORE.DLL 中的 CWbemClass 类是描述和管理 CIM 类对象的一个内部类。包
括存取类的名称、属性、方法、修饰符，产生类的实例，克隆（Clone）和派生类等。表
31-3 列出了 CWbemClass 类的一些重要方法和属性。 
表 31-3  CRepository 类的部分方法和属性 
方法或属性 
描述 
GetClassNameW 
取类的名称。 
GetPropertyCount 
取属性个数。 
BeginMethodEnumeration，NextMethod 和
EndMethodEnumeration 
用于便利类的所有方法，分别是开始枚举类的
方法，取下一个，和结束枚举。 
Clone 和 CloneEx 
复制类。 
GetProperty，GetMethod 
取类的属性和方法。 
PutMethod 
SetPropQualifier 和 SetMethodQualifier 
设置属性和方法的修饰符。 
SpawnInstance 和 SpawnKeyedInstance 
产生当前类的实例。 
CWbemInstance 类
类
类
类 
WBEMCORE.DLL 中的 CWbemInstance 类是描述和管理 CIM 类实例的一个内部类。
包括读取实例的类名（class name）、修改或读取实例的属性值、复制实例数据等。 
MSDN 中公开的 IWbemClassObject 接口定义了操作 WMI 类和实例的基本方法，通过
该接口，WMI 应用程序可以访问相应的 WMI 类或实例。可以认为 CWbemClass 类和
CWbemInstance 类为实现这一接口的方法而提供的支持类。 
CRepository 类
类
类
类 
REPDRVFS.DLL 中的 CRepository 类是对 WMI 数据仓库（CIM Repository）的抽象，
它是管理和维护 WMI 数据仓库的一个最重要的类。它实现了一系列方法来完成有关 WMI
数据仓库的各种操作，包括初始化、读取、锁定、解锁、关闭、备份、恢复等。表 31-3
列出了 CRepository 类的一些重要方法和属性。 
表 31-3  CRepository 类的部分方法和属性 
方法或属性 
描述 
Initialize 
初始化 WMI 数据仓库 
GetRepositoryVersions 
读 取
WMI
数 据 仓 库 的 版 本 ， 保 存 在 全 局 变 量
repdrvfs!g_dwCurrentRepositoryVersion 中，对于 XP SP2，为 6。 
GetRepositoryDirectory 
从注册表中（"SOFTWARE\Microsoft\ WBEM\CIMOM"）读取
WMI
数
据
仓
库
文
件
的
路
径
，
默
认
为
%SystemRoot%\system32\WBEM\Repository。  
GetNamespaceHandle 
获取某个命名空间的句柄。这是从仓库中读取数据的主要途径。 
GetStatistics 
读取统计信息。 
Backup 和 Restore 
备份和恢复数据仓库。 
《软件调试》补编 
- 84 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
方法或属性 
描述 
Logon 
登陆数据仓库。 
Shutdown 
关闭 WMI 数据仓库。 
LockRepository
和
UnlockRepository 
锁定和解除锁定。 
ReadOperationNotification
和
WriteOperationNotification 
当有读/写数据仓库的操作发生时，此方法会被调用，以产生事
件通知。 
FlushCache 
冲转缓存区，即将缓存在内存中的数据写入文件。 
m_ulReadCount
和
m_ulWriteCount 
读/写次数计数。 
m_threadCount 
工作线程数。 
在 WBEMCORE.DLL 中也有个 CRepository 类，它是对 CIM 数据仓库的顶层抽象，
对于需要底层操作的任务，它仍需转给 REPDRVFS.DLL 中的 CRepository 类来完成。 
CNamespaceHandle 类
类
类
类 
REPDRVFS.DLL 中的 CNamespaceHandle 类是对 CIM 命名空间（CIM Namespace）
物理特性的抽象，它封装了关于命名空间的各种底层操作，包括初始化命名空间和向命名
空间中增加删除类、实例和关系等。表 31-4 列出了 CNamespaceHandle 类主要方法和简单
说明。 
表 31-4  CNamespaceHandle 类的主要方法 
方法或属性 
描述 
Initialize 和 Initialize2  
初始化命名空间。 
DeleteInstance 
删除实例。 
PutInstance 
加入实例。 
DeleteDerivedClasses 
删除派生类。 
EraseClassRelationships 
删除类关系。 
GetInstanceByKey 
根据键值取实例。 
FireEvent 
激发事件。 
DeleteObjectByPath 
根据路径删除对象。 
PutObject 
保存或加入对象。 
PutClass 
保存或加入类。 
DeleteClass 
删除类。 
DeleteClassInstances 
删除类实例。 
EnumerateClasses 
枚举命名空间中所包含的类。 
ExecQuery 
查询功能的总入口函数，预处理后产生一个纤程（Fiber）
任务（CreateFiberForTask）。而后再在纤程分发给真正的
查询函数（ExecInstanceQuery 或 ExecClassQuery）。 
ExecInstanceQuery 
查询实例。 
GetObjectW 
读取对象。 
ExecClassQuery 
查询类。 
CSession 类
类
类
类 
REPDRVFS.DLL 中的 CSession 类是外界与 WMI 数据仓库对话的主要媒介。通常，
数据仓库的使用者只要调用 CSession 类封装好的方法，而不必关心数据仓库内部的操作
细节。CSession 类接收到调用后通常再转发给内部的其它类来真正完成各种操作。 
清单 31-3 显示了一个典型的查询操作的执行过程，wbemcore.dll 中的 CRepository 的
《软件调试》补编 
- 85 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
ExecQuery 方法调用 repdrvfs.dll 中的 CSession 类的 ExecQuery 方法。而后 CSession 类的
ExecQuery 再分发给 CNamespaceHandle 类的 ExecQuery 方法。 
清单 31-3 一个典型的查询操作的执行过程 
0:022> k 
ChildEBP RetAddr   
011cfbdc 752146c9 repdrvfs!CNamespaceHandle::ExecQuery 
011cfc1c 762d11e0 repdrvfs!CSession::ExecQuery+0xb6 