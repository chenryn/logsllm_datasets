# 【技术分享】基于误植域名的水坑攻击实践

##### 译文声明
本文为翻译文章，原文来源：[blog.0day.rocks](http://blog.0day.rocks)。译文仅供参考，具体内容和含义以原文为准。
- 译者：[qqwe_01](http://bobao.360.cn/member/contribute?uid=2614799936)
- 预估稿费：200 RMB
- 投稿方式：发送邮件至linwei#360.cn 或登录网页版在线投稿

### 引言
并非所有人都能拥有NSA Quantum系统那样的高级工具。因此，对于资源有限的人来说，寻找一种低成本的方法来渗透目标网络显得尤为重要。自20世纪90年代以来，误植域名（typosquatting）已被广泛用于网络钓鱼。然而，它在水坑攻击中同样具有潜力。本文将探讨如何利用误植域名进行水坑攻击。

### 误植域名及其应用
误植域名是指注册与流行网站相似但拼写略有不同的域名。例如：
- `google.com` -> `google.co`
- `com` -> `cm` (喀麦隆顶级域名)
- `com` -> `co` (哥伦比亚顶级域名)
- `om` (阿曼顶级域名)
- `net` -> `ne` (尼日尔顶级域名)
- `net` -> `et` (埃塞俄比亚顶级域名)

这些误植域名可以被用来引导受害者访问恶意网站，从而实施攻击。

### 实验步骤

#### 第一步：寻找流行的域名
我们可以通过Alexa网站获取最受欢迎的.com域名，并检查其对应的.co域名是否可用。以下是具体操作步骤：
```bash
$ wget http://s3.amazonaws.com/alexa-static/top-1m.csv.zip
$ unzip top-1m.csv.zip
$ cut -d',' -f 2 top-1m.csv | grep "com$" | rev | cut -d'.' -f 1,2 | uniq | rev | head -n 2000 > top-2000.com.txt
```

使用Python脚本批量检查这些域名的可用性。在前2000个.com域名中，有320个对应的.co域名可用（约占16%）。从中选择了8个高价值的域名进行测试。

#### 第二步：搭建“水坑”服务
购买了一个便宜的VPS（虚拟专用服务器），并设置了一个简单的网页服务器来托管重定向页面。这个页面会先加载一个无害的JavaScript代码，然后悄悄地将用户重定向到预期的.com网站。示例代码如下：
```html
<!DOCTYPE html>
<html>
<head>
    <title>Loading...</title>
    <script>
        window.location.href = "https://example.com";
    </script>
</head>
<body>
    Loading...
</body>
</html>
```

#### 第三步：数据分析
实验持续了40天，日志文件记录了5430个条目。过滤掉爬虫和机器人后，得到了916个独立IP对“水坑”服务器发起的1765次页面请求（平均每天约23次）。通过分析User-Agent值，确认这些请求是用户在浏览器地址栏手动输入URL时发生的误植。

遗憾的是，只有392个独立访问者加载了JavaScript代码。这可能是因为许多用户启用了广告拦截或隐私插件。尽管如此，这种攻击方法仍然具有一定的效果。

### 结果与统计
- **实际成本**：每次点击的成本约为0.05美元（按独立IP计算），低于电子商务网站的平均PPC（每次点击付费）成本。
- **地域分布**：误植域名的访问者显示出一定的地域性。例如，一个伊朗新闻网站的误植域名收到了大量来自伊朗的连接（超过50%的流量）。

### WhatsApp泄漏
值得注意的是，从WhatsApp客户端发起了800多个对“水坑”服务器的简单GET请求。这可能是由于用户在输入完整URL时触发的。这种数据泄漏可能导致严重的隐私问题。

### 误植域名的欺诈活动
已经观察到活跃的DNS误植活动，特别是在俄罗斯，针对各种VPN和托管服务提供商。攻击者通过注册错误域名并将affiliate ID注入302重定向到合法网站，从中获利。

### 结论
虽然误植域名可以用于欺诈或公司间谍活动，但从统计数据来看，鲜有人将其用于大规模传播勒索软件。不过，这种方法仍然值得警惕。

### 如何保护自己？
- **记录所有内容**：包括DNS请求，并在访问新注册的域名时设置警报。
- **使用工具**：如Dnstwist，监测相似或钓鱼域名。

感谢@scriptjunkie1提供的研究思路。如果您对误植攻击感兴趣，请查看他在OPCDE 2017上的幻灯片。