Roaming Mantis:
an Anatomy of a DNS 
Hijacking Campaign
Suguru Ishimaru
GReAT APAC
Kaspersky Lab
Manabu Niseki
NTT-CERT
NTT SC Labs
Hiroaki Ogawa
Professional Service
McAfee
2
Contents
1. Introduction
2. What is Roaming Mantis
3. MoqHao and SMShing
4. Attribution
5. Conclusions
HITCON CMT 2019
$ whoami
Introduction of ourselves
Who are we..?
4
HITCON CMT 2019
Manabu Niseki
NTT-CERT
NTT SC Labs
Suguru Ishimaru
GReAT APAC
Kaspersky Labs
Hiroaki Ogawa
Professional Service
McAfee
$ man roamingmantis
What is Roaming Mantis
Phishing site
Web mining
Malicious APK
Multilingual
6
HITCON CMT 2019
What is Roaming Mantis?
•
Cyber criminal campaign
•
Compromised routers
•
Targeted multi platform and 
multiple language 
•
Started since early 2018
7
HITCON CMT 2019
What is Roaming Mantis?
Compromised router
Roaming
Bugdroid’s color
Mistakes (BUG)
Mantis
Roaming Mantis aka 少爷(Shaoye)
8
•
５７东森财经新闻台: “少爷僵尸”网路扩散！ 全球百万笔个资遭窃 (2018/06/07)
•
https://www.youtube.com/watch?v=NEVMxhXG2lE
•
TWNCERT: Shaoye Botnet Affecting Network Devices in Asia-Pacific (2018/06/14)
•
https://www.nccst.nat.gov.tw/NewsRSSDetail?lang=en&RSSType=news&seq=16111
TWNCERT says: 
•
At least 6,000 mobile devices are 
infected with malicious apps, leaking 
more than 1 million pieces of personal 
information.
•
The infection spreads to 55 countries in 
the world and South Korea being the 
main target has a victim rate of 75%. 
Compromised routers
9
HITCON CMT 2019
Compromised routers
10
HITCON CMT 2019
Rogue DNS servers
11
A
B
C
D
Primary
1.53.252.215 
(Vietnam)
171.244.3.110
(Vietnam)
118.30.28.38
(China)
42.112.35.45
(Vietnam) 
Secondary
1.53.252.164
(Vietnam)
171.244.3.111
(Vietnam)
118.30.28.39
(China)
42.112.35.55
(Vietnam)
Korea is the first priority target
12
168.126.63.1 (Korea Telecom / Korea)
203.248.252.2 (LG DACOM Corporation / Korea)
219.250.36.130 (SK Broadband Co Ltd / Korea)
Note: they are legitimate DNS servers in Korea
DNS changer
13
HITCON CMT 2019
•
My handmade honeypot (which impersonates a Korean router) observed a DNS 
changer payload via 205.209.174.238.
•
Roaming Mantis DNS changer takes 2 steps.
1.
Taking a fingerprint of a target.
2.
Sending an attack payload based on the fingerprint.
JS DNS changer
14
HITCON CMT 2019
The router’s DNS setting is potentially compromised if the device reads the URL query 
of the DNS changer from localnet under a router with the following conditions:
•
No authentication for router panel from localnet
•
The device has an admin session for the router panel
•
Simple ID and password (or default) for router panel like admin:admin / user:user
KSN data for detection of rogue DNS (1 – 19 Aug 2019)
15
HITCON CMT 2019
98,000+ detections based on KSN data.
1.
Russia
2.
India
3.
Vietnam
4.
Bangladesh
5.
Japan
6.
Kazakhstan
7.
Indonesia
8.
Pakistan
9.
Taiwan
10. Iran
Landing page
16
HITCON CMT 2019
Using Taiwanese hosts as landing pages
17
•
HiNet:
•
1.171.153.177, 1.171.154.9, 
1.171.156.75
•
1.171.158.91, 1.171.169.160, 
1.171.169.201
•
1.171.171.34, 1.171.174.228, 
1.171.175.167
•
Etc.
•
SEEDNET:
•
175.181.255.52
•
112.104.27.225, 112.104.26.33
•
Etc. 
HITCON CMT 2019
18
HITCON CMT 2019
Targeted multi-platform
Malicious APK file(MoqHao)
Phishing
Mining
HITCON CMT 2019
Accessing a landing page with iOS 
19
Accessing a landing page with Android 
20
Infection with an Android malware MoqHao
(chrome1.0.7.apk)
HITCON CMT 2019
$ file moqhao.apk
MoqHao and SMShing
MoqHao via SMShing
•
MoqHao (alias: Shaoye and XLoader) is spreading via SMShing which 
impersonates Japanese logistics brands in Japan.
HITCON CMT 2019
(source: https://asia.nikkei.com/Business/Japan-s-Sagawa-chasing-drivers-with-4-day-workweek 
https://asia.nikkei.com/Business/Yamato-Transport-No.-1-in-Japan-brand-survey)
Spreading chain 
23
HITCON CMT 2019
• An infected Android device sends a SMS with a bit.ly link.
• The bit.ly link is a link to a Tumblr blog.
• The Tumblr blog redirects a user to a landing page.
Phishing website in Japan
24
sagawa.apk(MoqHao)
iOS
Android
HITCON CMT 2019
HITCON CMT 2019
In July 2019, new target is …
25
(source: https://www.motive.com.tw/?p=18207)
黑猫宅急便 is targeted in Taiwan
26
•
Since early July 2019, MoqHao SMShing is started targeting 
黑猫宅急便 in Taiwan.
HITCON CMT 2019
(source: https://www.youtube.com/watch?v=0QKrDFua7Dc)
黑猫宅急便 landing page
27
smartcat.apk (MoqHao/Shaoye)
Apple phishing
HITCON CMT 2019
Phishing website in Taiwan
28
smartcat.apk(MoqHao)
iOS
Android
HITCON CMT 2019
29
HITCON CMT 2019
Android malware MoqHao (smartcat.apk)
MoqHao contains encrypted payload executed by loader module: 
Loader module
Encrypted payload
Payload is Moqhao
Decryption using zlib + base64
30
HITCON CMT 2019
Android malware MoqHao
1.
sendSms
2.
setWifi
3.
gcont
4.
lock
5.
bc
6.
setForward
7.
getForward
8.
hasPkg
9.
setRingerMode
10. setRecEnable
11. reqState
12. showHome
13. getnpki
14. http
15. onRecordAction
16. call
17. get_apps
18. show_fs_float_
window
19. Ping
20. getPhoneState
20th backdoor commands
4,000+ stolen info
•
IP
•
Language
•
ID (email)
•
Password
•
Name
•
Address
•
Credit card info
•
Tow factor auth
•
Bank info
•
Etc…
MoqHao payload module is a backdoor.
Improving crypto algorithm of loader module
31
HITCON CMT 2019
¥classes.dex
loader module
¥assets¥bin
encrypted payload (-> .dex)
…others
2018 April
Base64
2018 May
Base64
+
Zlib
2018 Aug
Zlib
+
Base64
2019 Mar
DES
Key “xieurjke”
+
ZIP
2018 Feb
Skip 4bytes
+
Zlib
+
Base64
2018 Apr
Skip 4bytes
+
Zlib
+
Base64
#!/usr/bin/env python
import sys
import zlib
import base64
data = open(sys.argv[1], "rb").read()
dec_z = zlib.decompress(data[4:])
dec_b = base64.b64decode(dec_z)
with open(sys.argv[1]+".dec","wb") as fp:    
fp.write(dec_b)
Wrong design (vulnerability?) in old versions
32
HITCON CMT 2019
If someone send 
a Email to there…? 
Wrong design
Read email subject and decrypt real C2 destination
Real C2
Sinkhole?
Other actor?
Fixed wrong design in 2019
33
HITCON CMT 2019
Fixed
Real C2 of Roaming Mantis
Feb 2019
xor + sub
Apr 2019
Base64.urlsafe + DES (CBC)
Mar 2019
Base64 + DES(EBC)
#!/usr/bin/env python
from Crypto.Cipher import DES
import sys
import base64
enc = base64.urlsafe_b64decode(sys.argv[1])
key = b"Ab5d1Q32"
des = DES.new(key,2,key)
dec = des.decrypt(enc)
print(dec)
Crypto Algorithm
$ whois
Attribution
The goal of the attacker
35
Of course…
Get the money!
Create 
accounts with 
compromised 
devices’s
Telephone 
Number
Creating account from stolen information
36
EC sites
payment 
service
Carrier 
Billing
Steal SMS 
messages and 
send these to 
the C2
SMS message send to 
Compromised device 
with authentication code
Get authentication code from a stolen SMS
C2 Server
Send device information
Include device’s telephone
number after infected MoqHao
Get the compromised device’s telephone number
Stealing authentication code 
37
EC Sites/Payment Service SMS 
Carrier Billing
Abusing stolen information
38
Source: https://www.setn.com/News.aspx?NewsID=577291
Money earning and money laundering technique
39
Carrier 
Billing
EC sites
payment 
service
Shopping
with
Stolen credit 
card
Stolen credit card
By money launderer (Money mule phase)
Nikkei 2019/6/6
Buy iTunes 
card with 
payment 
service
Yahoo!知恵袋 2018/8/3
How to recruit a money Launderer 
40
“If you have an 
iPhone, there is a job.
Get rewards just by 
purchasing a game 
item!
No cost at all.”
$ shutdown –h now
Conclusions
Conclusions
42
HITCON CMT 2019
THE ROAMING MANTIS
Targets Taiwan via SMShing
Is rapidly improving
Has strong financial motivation
Example of IoCs
43
HITCON CMT 2019
Malicious smartcat.apk Type A (MoqHao/XLoader) and its modules
c2dea0e63bd58062824fd960c6ff5d10 APK file
720c9528f2bb436fa3ca2196af718332 APK file
11ab174bf1dbac0418a14853bae5f1ae ¥classes.dex
95aa090211fd06bbd2d2c310d0742371
¥classes.dex
2275e5b5186fdfddd64cbb653cc7c5e2 ¥assets¥?¥????? (Encrypted payload)
14eb70a63a16612ec929b552fced6190 ¥assets¥?¥????? (Encrypted payload)
710b672224653ad7e31bd081031928b4
Decrypted payload(.dex)
7d41ef4c8e39d4dd8ca937d23521254aDecrypted payload(.dex)
Suspicious hardcoded accounts 
id538254835
m.vk.com
id538255725
m.vk.com
id538256404
m.vk.com
09261074305103529133 blogger.com
17996104865618190962 blogger.com
00569308955552776429 blogger.com
44
HITCON CMT 2019
References
1.
https://blog.trendmicro.com/trendlabs-
security-intelligence/a-look-into-the-
connection-between-xloader-and-fakespy-
and-their-possible-ties-with-the-yanbian-
gang/
2.
https://securelist.com/roaming-mantis-
uses-dns-hijacking-to-infect-android-
smartphones/85178/
3.
https://securelist.com/roaming-mantis-
dabbles-in-mining-and-phishing-
multilingually/85607/
4.
https://securelist.com/roaming-mantis-
part-3/88071/
5.
https://securelist.com/roaming-mantis-
part-iv/90332/
6.
https://securingtomorrow.mcafee.com/
other-blogs/mcafee-labs/moqhao-
related-android-spyware-targeting-
japan-and-korea-found-on-google-play/
Suguru Ishimaru
GReAT APAC
Kaspersky Lab
Let’s Talk?
Manabu Niseki
NTT-CERT
NTT SC Labs
Hiroaki Ogawa
Professional Service
McAfee