### 加密货币挖矿恶意软件KingMiner分析

#### 背景
2018年，加密货币挖矿活动迅速增长。由于加密货币的高价值，黑客有很强的动力利用受害者机器的CPU算力进行非法挖矿。本文将重点分析一种针对Windows服务器的门罗币挖矿恶意软件——KingMiner。

#### KingMiner概述
KingMiner首次出现于2018年6月，并在短时间内出现了两个更新版本。攻击者在开发过程中使用了多种绕过技术来规避模拟和检测方法，使得许多杀毒软件引擎未能及时发现该恶意软件。

#### 攻击流程
研究人员发现，KingMiner主要攻击Microsoft服务器（尤其是IIS和SQL Server），并通过猜测密码的方式获取访问权限。一旦成功入侵，恶意软件会在受害者的机器上下载并执行一个Windows Scriptlet文件（`.sct`）。

具体执行步骤如下：
- **检测CPU架构**：首先确定目标系统的CPU架构。
- **清理旧版文件**：如果存在旧版本的攻击文件，则终止相关进程并删除这些文件。
- **下载payload**：基于检测到的CPU架构，下载相应的payload zip文件（如`64p.zip`）。需要注意的是，这个zip文件实际上是一个XML文件，用于绕过模拟检测。
- **解码payload**：从XML payload中提取base64编码的数据，生成实际的ZIP文件。该ZIP文件包含以下五个文件：
  - `config.json`：XMRig CPU挖矿机的配置文件。
  - `md5.txt`：仅包含字符串`zzz.`的文本文件。
  - `powered.exe`（或`fix.exe`）：主可执行文件。
  - `soundbox.dll`：包含`powered.exe`所需导出函数的DLL文件。
  - `x.txt/y.png`：二进制blob文件，但并非真实的PNG文件。

图1展示了HTTP响应中的zip payload示例；图2则描绘了攻击的第一阶段；图3为XMRig配置文件内容，其中包括钱包地址和私有池信息。

在所有文件被正确提取后，`md5.txt`的内容会被添加至相关的DLL文件（如`sandbox.dll`或`active_desktop_render_x64.dll`）。接着，`powered.exe`或`fix.exe`被执行，创建XMRig挖矿机实例及一些新的注册表项（值设为`Test.`）。

图4展示了含有必要函数的DLL文件结构。其中，`ClearDesktopMonitorHook`返回值1，而`King1`负责创建新线程并处理二进制blob文件（即`x.txt`或`y.png`），最终生成简化的XMRig CPU挖矿程序。

此外，还有四个未使用的函数（`King2`, `King3`, `King4`, 和 `SetDesktopMonitorHook`）可能在未来版本中发挥作用。

图5说明了`king1`函数如何创建线程并将二进制数据作为参数传递；图6展示了整个攻击过程的第二阶段。

尽管XMRig配置文件设定只使用75%的CPU资源，但实际上它会占用全部100%的算力，如图7所示。

#### KingMiner的发展与进化
自首次出现以来，Check Point的研究人员已监测到KingMiner经历了两次重大更新。每次更新都引入了新的特性及绕过机制以逃避检测。此外，代码中还预留了许多占位符供未来版本使用，进一步增加了其隐蔽性。

#### 绕过技术
KingMiner之所以能够成功，很大程度上归功于其巧妙运用的各种绕过手段，包括但不限于：
- 对`32p.zip/64p.zip`文件进行混淆处理，使其呈现为基本XML格式的数据。
- 将核心功能封装在独立的可执行文件（`powered.exe`）及其依赖的DLL文件内，确保单独运行时不会触发额外的安全警报。
- 将`md5.txt`中的特定字符串嵌入到DLL文件中。
- 通过解码`x.txt/y.png`文件内容来动态生成完整的XMRig CPU挖矿工具。

以上措施显著降低了KingMiner被常规安全系统识别的风险。

#### 威胁情报
据观察，KingMiner背后的攻击者利用私人挖矿池来掩盖其活动轨迹。目前，该挖矿池的API已被关闭，且涉及的钱包地址从未出现在任何公共平台上。因此，确切的域名信息尚无法确认。然而，可以肯定的是，此类攻击已波及全球多个国家和地区，包括墨西哥、印度和挪威等地。

图6提供了受攻击国家分布情况的可视化展示。

#### 总结
KingMiner是一款持续演进中的加密货币挖矿恶意软件，具备强大的反检测能力。预计随着技术进步，类似绕过策略将在2019年乃至更长时间内继续成为加密货币挖矿攻击的重要组成部分。