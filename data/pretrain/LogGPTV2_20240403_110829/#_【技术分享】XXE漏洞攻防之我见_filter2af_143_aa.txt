# 【技术分享】XXE漏洞攻防之我见
##### 译文声明
本文是翻译文章，文章来源：安全客
译文仅供参考，具体内容表达以及含义原文为准。
作者：[ **激越王**](http://bobao.360.cn/member/contribute?uid=2577494374)
**预估稿费：400RMB**
投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿
你是否听说过xml注入攻击呢，或者对它只知其一不知其二呢？
现在让我们从xml相关基础知识开始，一步步了解xml攻击的原理和方式。
这篇文章主要针对扫盲，请大佬们轻喷，有错误的地方欢迎指出。
XML 被设计为传输和存储数据，其焦点是数据的内容。
HTML 被设计用来显示数据，其焦点是数据的外观。
XML 把数据从 HTML 分离。
XML 是独立于软件和硬件的信息传输工具。
    Everyday Italian      
    Giada De Laurentiis       
    2005 
    30.00 
XML 中，一些字符拥有特殊的意义。为了避免这个错误，请用实体引用来代替特殊字符
附表一
附表一注释：在 XML 中，只有字符 "
    ]>
    Dave
    Tom
    Reminder
    You are a good man
实例
源码
当DTD 位于 XML 源文件的外部，通过下面的语法被封装在一个 DOCTYPE 定义中
外部DTD实例
      Dave
      Tom
      Reminder
      You are a good man
"note.dtd" 文件
实例
源码
dtd文件
PCDATA 的意思是被解析的字符数据（parsed character data）。PCDATA
是会被解析器解析的文本。这些文本将被解析器检查实体以及标记。文本中的标签会被当作标记来处理，而实体会被展开。不过，被解析的字符数据不应当包含任何 &、 字符；需要使用 &amp;、&lt; 以及 &gt; 实体来分别替换它们。
CDATA 的意思是字符数据（character data）。CDATA
是不会被解析器解析的文本。在这些文本中的标签不会被当作标记来对待，其中的实体也不会被展开。
**DTD元素**
备注：由于仅仅是扩展，所以仅展示一些常用的元素语法
**DTD – 属性**
属性声明使用下列语法：
DTD 实例:
XML 实例:
以下是属性类型的选项：
默认值参数可使用下列值：
**DTD – 实体（重要）**
实体是用于定义引用普通文本或特殊字符的快捷方式的变量。
实体引用是对实体的引用。
实体可在内部或外部进行声明。
**Schema 介绍（XSD）**
XML Schema 是基于 XML 的 DTD 替代者。
XML Schema 描述 XML 文档的结构。
XML Schema 语言也可作为 XSD（XML Schema Definition）来引用
但是目前XSD对本文的XXE攻击相关性不是太大，如果有大佬想深入了解可以到  或
 学习
**攻击套路**
**一般技巧：**
1.引用外部实体远程文件读取
2.URL请求(可借此发起ssrf)
3.参数实体
4.通过 XInclude 包含外部资源
5.DoS
**1\. 外部实体引用**
通过外部实体引用，可以获取远程文件内容
本地实验：
test.txt 文件中的内容就是 123123admin
但是有个问题，如果文件内容格式太过复杂，就会导致 xml 解析失败(比如内容里含有 空格、一些特殊字符  & ; 之类的文件)
这个其实有绕过方法的，如上文所述，可以利用 参数实体，具体的内容后面介绍
还有一个我们知道的方法，就是使用 php 伪协议，php://filter 读取文件内容（ 文件内容经过 base64 过滤器，就是全字符的，没有格式干扰）
**2\. URL 请求(ssrf)**
直接使用外部实体引用就可以发起一个请求，原因是很多 xml 解析器读取到引用外部文件的模块时，就会强制性发出请求
本地实验:
首先在 172.16.169.153 监听 1231 端口：
在 172.16.169.142 利用 xml 发出请求（将 xml 放入浏览器即可）
如上图，浏览器一直处于加载内容状态，这是因为 153 的机器上没有返回信息…
172.16.169.153 的 1231 端口状态：