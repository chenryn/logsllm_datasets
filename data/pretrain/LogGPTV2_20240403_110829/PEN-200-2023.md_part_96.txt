...
-rw-r--r-- 1 root root 2419 Jul 14 12:06 portscan.rc y
-rw-r--r-- 1 root root 1251 Jul 14 12:06 run_all_post.rc
-rw-r--r-- 1 root root 3084 Jul 14 12:06 smb_checks.rc
k
-rw-r--r-- 1 root root 3837 Jul 14 12:06 smb_validate.rc
-rw-r--r-- 1 root root 2592 Jul 14 12:06 wmap_autotest.rc
Listing 710 - Listing all resource scripts psrovided by Metasploit
Listing 710 shows that there are resource scripts provided for port scanning, brute forcing,
protocol enumerations, and so on. Before we oattempt to use them, we should thoroughly
examine, understand, and modify them to fit our needs.
n
Some of these scripts use the global datastore of Metasploit to set options such as RHOSTS.
When we use set or unset, we define options in the context of a running module. However, we can
also define values for options across all modules by setting global options. These options can be
i
set with setg and unset with unsetg.1006
z
Resource scripts can be quite handy to automate parts of a penetration test. We can create a set
of resource scripts for repDetitive tasks and operations. We can prepare those scripts and then
modify them for each penetration test. For example, we could prepare resource scripts for
listeners, pivoting, post-exploitation, and much more. Using them on multiple penetration tests
can save us a lot of time.
Let’s summarize what we learned in this section. We began by getting familiar with resource
scripts. Then, we created our own resource script to automate the setup process of a
multi/handler listener. Finally, we executed the resource script and a corresponding executable
file to receive an incoming Meterpreter reverse shell, which migrated itself to a newly spawned
Notepad process.
20.5 Wrapping Up
In this Module we covered various features, modules, and capabilities of Metasploit. We started
by getting familiar with the framework itself and we explored how to use auxiliary and exploit
modules. Next, we discussed several types of payloads available in Metasploit and msfvenom.
Then, we covered features and modules for post-exploitation with Meterpreter and how to use
pivoting in Metasploit. Finally, we created a resource script to automate the set up process of a
1006 (Rapid7 Documentation, 2022), https://docs.rapid7.com/metasploit/msf-overview/#Datastore
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 687
Made in Morocco
Penetration Testing with Kali Linux
multi/handler that migrates to a newly spawned process once Metasploit starts a session due to
an incoming reverse shell.
Exploit frameworks such as Metasploit are invaluable in penetration tests since it quickly
becomes tedious and error-prone to manually manage various shells and sessions. Furthermore,
the modules contained in the frameworks can be easily customized to fit our needs without going
through the process of fixing public exploit code. These frameworks often also provide the ability
to create executable files, which we can use for client-side attacks or web application attacks. By
using Metasploit’s signature payload Meterpreter, we obtain a broad range of powerful post-
exploitation and pivoting techniques.
y
k
s
o
n
i
z
D
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 688
Made in Morocco
Penetration Testing with Kali Linux
21 Active Directory Introduction and Enumeration
In this Learning Module, we will cover the following Learning Units:
• Introduction to Active Directory
• Active Directory enumeration using manual tools
• Enumerating Active Directory using automated tools
Active Directory Domain Services,1007 often referred to as Active Directory (AD), is a service that
allows system administrators to update and manage operating systems, applications, users, and
data access on a large scale. Active Directory is installed with a standard configuration, however,
system administrators often customize it to fit the needs of the organization.
y
From a penetration tester’s perspective, Active Directory is very interesting as it typically contain a
wealth of information. If we successfully compromise certain objects within the domain, we may
k
be able to take full control over the organization’s infrastructure.
In this Learning Module, we will focus on the enumseration aspect of Active Directory. The
information we will gather throughout the Module will have a direct impact on the various attacks
we will do in the upcoming Attacking Active Direoctory Authentication and Lateral Movement in
Active Directory Modules.
Introdun
21.1 Active Directory - ction
This Learning Unit will cover the folloiwing Learning Objectives:
z
• Introduction to Active Directory
• Define our enumeration goals
D
While Active Directory itself is a service, it also acts as a management layer. AD contains critical
information about the environment, storing information about users, groups, and computers, each
referred to as objects. Permissions set on each object dictate the privileges that object has within
the domain
Configuring and maintaining an instance of Active Directory can be daunting for administrators,
especially since the wealth of contained information often creates a large attack surface.
The first step in configuring an instance of AD is to create a domain name such as corp.com in
which corp is often the name of the organization itself. Within this domain, administrators can
add various types of objects that are associated with the organization such as computers, users,
and group objects.
1007 (Microsoft, 2022), https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-
domain-services-overview
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 689
Made in Morocco
Penetration Testing with Kali Linux
An AD environment has a critical dependency on the Domain Name System
(DNS) service. As such, a typical domain controller will also host a DNS server
that is authoritative for a given domain.
To ease the management of various objects and assist with management, system administrators
often organize these objects into Organizational Units (OUs).1008
OUs are comparable to file system folders in that they are containers used to store objects within
the domain. Computer objects represent actual servers and workstations that are domain-joined
(part of the domain), and user objects represent accounts that can be used to log in to the
domain-joined computers. In addition, all AD objects contain attributes, which will vary depending
on the type of object. For example, a user object may include attributes such as first name, last
y
name, username, phone number, etc.
AD relies on several components and communication services. For example, when a user
k
attempts to log in to the domain, a request is sent to a Domain Controller (DC),1009 which checks
whether or not the user is allowed to log in to the domain. One or more DCs act as the hub and
s
core of the domain, storing all OUs, objects, and their attributes. Since the DC is such a central
domain component, we’ll pay close attention to it as we enumerate AD.
o
Objects can be assigned to AD groups so that administrators can manage those object as a
single unit. For example, users in a group could be given access to a file server share or given
n
administrative access to various clients in the domain. Attackers often target high-privileged
groups.
i
Members of Domain Admins1010 are among the most privileged objects in the domain. If an
z
attacker compromises a member of this group (often referred to as domain administrators), they
essentially gain complete control over the domain.
D
This attack vector could extend beyond a single domain since an AD instance can host more than
one domain in a domain tree or multiple domain trees in a domain forest. While there is a Domain
Admins group for each domain in the forest, members of the Enterprise Admins group are granted
full control over all the domains in the forest and have Administrator privilege on all DCs. This is
obviously a high-value target for an attacker.
We will leverage these and other concepts in this Module as we focus on the extremely important
aspect of AD enumeration. This important discipline can improve our success during the attack
phase. We will leverage a variety of tools to manually enumerate AD, most of which rely on the
Lightweight Directory Access Protocol (LDAP). Once we’ve introduced foundational techniques, we
will leverage automation to perform enumeration at scale.1011
1008 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Organizational_unit_(computing)
1009 (Microsoft, 2021), https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-authsod/c4012a57-16a9-42eb-8f64-
aa9e04698dca
1010 (Microsoft, 2022), https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-
groups#domain-admins
1011 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 690
Made in Morocco
Penetration Testing with Kali Linux
21.1.1 Enumeration - Defining our Goals
Before we begin, let’s discuss the scenario and define our goals.
In this scenario, we’ll enumerate the corp.com domain. We’ve obtained user credentials to a
domain user through a successful phishing attack. Alternatively, the target organization may have
provided us with user credentials so that we can perform penetration testing based on an
assumed breach. This would speed up the process for us and also give the organization insight
into how easily attackers can move within their environment once they have gained initial access.
The user we have access to is stephanie who has remote desktop permissions on a Windows 11
machine that is a part of the domain. This user is not a local administrator on the machine, which
is something we may need to take into consideration as we move along.
During a real-world assessment, the organization may also define the scope and goals of the
y
penetration test. In our case however, we are restricted to the corp.com domain with the PWK
labs. Our goal will be to enumerate the full domain, including finding possible ways to achieve the
k
highest privilege possible (domain administrator in this case).
In this Module, we will perform the enumeration from osne client machine with the low privileged
stephanie domain user. However, once we start performing attacks and we are able to gain
access to additional users and computers, we may have to repeat parts of the enumeration
o
process from the new standpoint. This perspective shift (or pivot) is critical during the
enumeration process considering the complexity of permissions across the domain. Each pivot
may give us an opportunity to advance our nattack.
For example, if we gain access to another low-privileged user account that seems to have the
same access as stephanie, we shouildn’t simply dismiss it. Instead, we should always repeat our
enumeration with that new accozunt since administrators often grant individual users increased
permissions based on their unique role in the organization. This persistent “rinse and repeat”
process is the key to successful enumeration and works extremely well, especially in large
D
organizations.
21.2 Active Directory - Manual Enumeration
This Learning Unit will cover the following Learning Objectives:
• Enumerate Active Directory using legacy Windows applications
• Use PowerShell and .NET to perform additional AD enumeration
There are many ways to enumerate AD and a wide variety of tools we can use. In this Learning
Unit, we will start enumerating the domain using tools that are already installed in Windows. We
will start with the “low-hanging fruit”, the information we can gather quickly and easily. Eventually,
we will leverage more robust techniques such as invoking .NET classes using PowerShell to
communicate with AD via LDAP.
21.2.1 Active Directory - Enumeration Using Legacy Windows Tools
Since we are starting in an assumed breach scenario and we have credentials for stephanie, we
will use those credentials to authenticate to the domain via a Windows 11 machine (CLIENT75).
We’ll use the Remote Desktop Protocol (RDP) with xfreerdp to connect to the client and log in to
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 691
Made in Morocco
Penetration Testing with Kali Linux
the domain. We’ll supply the user name with /u, the domain name with /d and enter the password,
which in this case is LegmanTeamBenzoin!!.
kali@kali:~$ xfreerdp /u:stephanie /d:corp.com /v:192.168.50.75
Listing 711 - Connecting to the Windows 11 client using “xfreerdp”
AD contains so much information that it can be hard to determine where to start enumerating.
But since every AD installation fundamentally contains users and groups, we’ll start there.
To start gathering user information, we will use net.exe,1012 which is installed by default on all
Windows operating systems. More specifically, we will use the net user sub-command.1013 While
we can use this tool to enumerate local accounts on the machine, we’ll instead use /domain to
print out the users in the domain.
C:\Users\stephanie>net user /domain
y
The request will be processed at a domain controller for domain corp.com.
User accounts for \\DC1.corp.com k
-------------------------------------------------------------------------------
Administrator dave sGuest
iis_service jeff jeffadmin
jen krbtgt pete
o
stephanie
The command completed successfully.
Listing 712 - Running “net user” to display users in the domain
n
The output from this command will vary depending on the size of the organization. Armed with a
list of users, we can now query information about individual users.
i
z
Administrators often have a tendency to add prefixes or suffixes to usernames that identify
accounts by their function. Based on the output in Listing 712, we should check out the jeffadmin
user because it might be anD administrative account.
Let’s inspect the user with net.exe and the /domain flag:
C:\Users\stephanie>net user jeffadmin /domain
The request will be processed at a domain controller for domain corp.com.
User name jeffadmin
Full Name
Comment
User's comment
Country/region code 000 (System Default)
Account active Yes
Account expires Never
Password last set 9/2/2022 4:26:48 PM
Password expires Never
Password changeable 9/3/2022 4:26:48 PM
1012 (Microsoft, 2021), https://learn.microsoft.com/en-US/troubleshoot/windows-server/networking/net-commands-on-operating-
systems
1013 (Microsoft, 2016), https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-
2012/cc771865(v=ws.11)?redirectedfrom=MSDN
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 692
Made in Morocco
Penetration Testing with Kali Linux
Password required Yes
User may change password Yes
Workstations allowed All
Logon script
User profile
Home directory
Last logon 9/20/2022 1:36:09 AM
Logon hours allowed All
Local Group Memberships *Administrators
Global Group memberships *Domain Users *Domain Admins
The command completed successfully.
Listing 713 - Running “net user” against a specific user
y
According to the output, jeffadmin is a part of the Domain Admins group, which is something we
should take note of. If we manage to compromise this account, we’ll essentially elevate ourselves
to domain administrator. k
We can also use net.exe to enumerate groups in the domain with net group:1014
s
C:\Users\stephanie>net group /domain
The request will be processed at a domain conotroller for domain corp.com.
Group Accounts for \\DC1.corp.com
n
-------------------------------------------------------------------------------
*Cloneable Domain Controllers
*Debug i
*Development Department z
*DnsUpdateProxy
*Domain Admins
D
*Domain Computers
*Domain Controllers
*Domain Guests
*Domain Users
*Enterprise Admins
*Enterprise Key Admins
*Enterprise Read-only Domain Controllers
*Group Policy Creator Owners
*Key Admins
*Management Department
*Protected Users
*Read-only Domain Controllers
*Sales Department
*Schema Admins
The command completed successfully.
Listing 714 - Running “net group” to display groups in the domain
1014 (Microsoft, 2012), https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-
2008/cc754051(v=ws.10)?redirectedfrom=MSDN
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 693
Made in Morocco
Penetration Testing with Kali Linux
The output includes a long list of groups in the domain. Some of these are installed by default.1015
Others, like those highlighted above, are custom groups created by the administrator. Let’s
enumerate a custom group first.
We’ll again use net.exe to enumerate the group members, this time focusing on the Sales
Department group.