# XNUCA2020-RE-repair
|
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
当初没做出来，官方也没放WP，最近有空整理一下这道题
## 题目分析
首先看一下程序逻辑
程序首先注册了SIGILL的信号处理函数。程序提供了一个qemu_arm，不知道做了什么特殊处理，官方的qemu是无法运行这段程序的，应该就是SIGILL这个地方有差异。
然后经过分析得知建立了一个二叉树头，并且把一个键值对表加入到了这个树里，最后要求输入44字符flag，起始固定为`flag{`，进入`sub_10A54`执行程序逻辑，由于需要repair，自然F5是没法儿好好解析了，其实还存在一段正确的输出。
进入逻辑函数，发现充满了`PUSH {R0-R5, R7}; UND
#1;`这样的东西，此时会进入到SIGILL的处理函数中进行跳转，因此本题的意义就是修复这段逻辑。
首先搜索一下这个桩的Hex，发现只有这里有。
随后分析SIGILL处理函数，首先根据信号发生的位置`sig_addr`减去常量获得偏移，随后以这个为key去树里查找要跳转的位置，如果没有查找到，就去查找另一个表，如果找到了某一项，则根据找到的idx，去两个表里取得一个值，取哪个表取决于R6，这里应该是一个判断的结构
最后一段其实是保证堆栈平衡和手动跳转，F5失败了
因此我们优化一下条件跳转表的结构，重新F5
## 解题思路
写脚本追随跳转还原代码，随后给IDA进行分析，请看注释
    from keystone import *
    from capstone import *
    from enum import Enum
    # 原程序提取出来的数据
    jump_offsets = [3072, 2050, 4, 3414, 2056, 3756, 10, 2062, 16, 2068, 22, 2074, 28, 2080, 34, 1030, 2086, 40, 3420, 2092,
                    3762, 46, 2098, 52, 2104, 58, 2110, 64, 2116, 70, 1036, 2122, 76, 3426, 2128, 3768, 82, 2134, 88, 2140,
                    94, 2146, 100, 2152, 106, 3090, 2158, 112, 3432, 2164, 118, 124, 2176, 130, 2182, 136, 2188, 142, 3096,
                    2194, 148, 3438, 2200, 154, 2206, 160, 2212, 166, 2218, 172, 2224, 178, 3102, 2230, 184, 3444, 2236,
                    190, 2242, 196, 2248, 202, 208, 2260, 214, 1060, 2266, 220, 3450, 2272, 226, 2278, 232, 2284, 238, 2290,
                    244, 2296, 250, 1066, 2302, 256, 3456, 2308, 262, 2314, 268, 2320, 274, 2326, 280, 2332, 286, 3120,
                    2338, 292, 1414, 2344, 298, 2350, 304, 2356, 310, 2362, 316, 2368, 322, 1078, 2374, 328, 1420, 2380,
                    334, 2386, 340, 2392, 346, 2398, 352, 2404, 358, 3132, 2410, 364, 3474, 2416, 370, 2422, 376, 2428, 382,
                    2434, 388, 2440, 1090, 2446, 400, 3480, 2452, 406, 2458, 412, 2464, 418, 2470, 424, 2476, 430, 1096,
                    2482, 436, 1438, 2488, 442, 2494, 448, 2500, 454, 2506, 460, 2512, 466, 1102, 2518, 472, 1444, 2524,
                    478, 2530, 484, 2536, 490, 2542, 496, 2548, 502, 3156, 2554, 508, 3498, 2560, 514, 2566, 520, 2572, 526,
                    2578, 532, 2584, 538, 3162, 2590, 544, 1456, 2596, 550, 2602, 556, 2608, 562, 2614, 568, 2620, 574,
                    3168, 2626, 580, 1462, 2632, 586, 2638, 592, 2644, 598, 2650, 604, 2656, 610, 1126, 2662, 616, 3516,
                    2668, 622, 2674, 628, 2680, 634, 2686, 640, 2692, 646, 3180, 2698, 652, 3522, 2704, 2710, 664, 2716,
                    670, 2722, 676, 2728, 796, 682, 2734, 688, 3528, 2740, 694, 2746, 700, 2752, 706, 2758, 712, 2764, 2850,
                    718, 3192, 2770, 724, 1486, 2776, 730, 2782, 736, 2788, 742, 2794, 748, 2800, 2856, 754, 3198, 2806,
                    760, 1492, 2812, 766, 2818, 772, 2824, 778, 2830, 784, 2862, 790, 3204, 2844, 1498, 802, 808, 814, 820,
                    2868, 2874, 1162, 832, 1504, 838, 2892, 850, 856, 826, 862, 3216, 868, 3558, 874, 880, 2934, 2940, 2880,
                    2946, 1174, 2952, 3564, 910, 916, 2970, 928, 2886, 934, 1180, 2988, 1522, 2994, 3000, 3006, 3012, 844,
                    970, 1186, 976, 1528, 982, 3036, 3042, 3048, 2898, 3054, 3240, 1012, 3582, 1018, 1024, 3078, 3084, 2904,
                    1042, 3246, 1048, 3588, 1054, 3108, 3114, 1072, 2910, 3126, 3252, 1084, 3594, 3138, 3144, 3150, 1108,
                    2916, 1114, 1210, 1120, 3600, 3174, 1132, 3186, 1144, 2922, 1150, 1216, 1156, 1558, 3210, 1168, 3222,
                    3228, 2928, 3234, 1222, 1192, 1198, 1204, 3258, 3264, 886, 3270, 1228, 3276, 1570, 1234, 3288, 1246,
                    1252, 892, 1258, 3282, 3312, 1576, 1270, 3324, 3330, 1288, 898, 3342, 1240, 1300, 3630, 3354, 3360,
                    3366, 3372, 904, 1330, 3294, 1336, 3636, 3390, 3396, 3402, 1360, 2958, 1366, 3300, 1372, 3642, 1378,
                    1384, 1390, 1396, 2964, 1402, 3306, 1408, 3648, 3462, 3468, 1426, 1432, 922, 3486, 1264, 3492, 1606,
                    1450, 3504, 3510, 1468, 2976, 1474, 3318, 1480, 3660, 3534, 3540, 3546, 3552, 2982, 1510, 1276, 1516,
                    3666, 3570, 3576, 1534, 1540, 940, 1546, 1282, 1552, 3672, 3606, 1564, 3618, 3624, 946, 1582, 3336,
                    1588, 1630, 1594, 1600, 3654, 1612, 952, 1618, 1294, 1624, 1636, 3678, 3684, 3690, 1648, 958, 3702,
                    3348, 1660, 3714, 1672, 1678, 1684, 964, 3738, 1306, 3744, 3696, 3750, 1708, 1714, 1720, 3018, 1726,
                    1312, 1732, 1654, 1738, 1744, 1750, 1756, 3024, 1762, 1318, 1768, 3708, 1774, 1780, 1786, 1792, 3030,
                    1798, 1324, 1804, 1666, 1810, 1816, 1822, 1828, 988, 1834, 3378, 1840, 3720, 1846, 1852, 1858, 1864,
                    994, 1870, 3384, 1876, 3726, 1882, 1888, 1894, 1900, 1000, 1906, 1912, 3732, 1918, 1924, 1930, 1936,
                    1006, 1942, 1948, 1690, 1954, 1960, 1966, 1972, 3060, 1978, 1354, 1984, 1696, 1990, 1996, 2002, 2008,
                    3066, 2014, 3408, 2020, 1702, 2026, 2032, 2038, 2044]
    jump_targets = [-1380, 1426, 3520, -1062, -1534, -436, 1130, 650, 662, -442, 2636, -520, 3220, -1522, 626, 1646, -562,
                    1442, -2172, 1246, -1740, 806, 982, 2492, 620, 1766, -22, 554, -1582, -16, 686, -1276, 1058, -1950, 140,
                    -2334, 1130, -1042, 1628, -196, 260, 86, 686, 530, 2468, -1854, -22, 80, -1680, -520, 8, 2312, -2086,
                    -58, -1894, 2024, -1378, 2222, -1044, -1390, 1808, -1224, 1342, 2800, 958, 2234, -292, 1250, -412, 2498,
                    1384, 890, 608, -1546, 3280, -400, -982, 854, 1144, 1616, 640, 1412, 398, 706, 3292, 2686, -1636, 2540,
                    -1800, -202, 2354, 1276, 3424, -796, 14, -1690, 1478, -1876, 458, 374, 1072, 2234, -1068, -520, 1688,
                    796, 488, -58, 3208, -1468, 2752, -2014, 1688, -432, -1504, 1250, -904, -1888, 824, -1972, -244, -838,
                    3268, 478, 1580, 398, 1106, 2254, -1642, 1418, 2116, -1834, 578, 490, 2354, 520, 3292, -898, 836, 862,
                    1604, -960, -688, 2222, 230, -2074, 3226, 224, 3094, 502, 1346, 266, -106, -1414, 2002, -994, -298,
                    -2022, -946, 602, -1378, 38, -682, 146, -1198, 950, -1522, 2168, -790, -2236, 2416, 1762, -1042, 2884,
                    -838, 2330, -1576, 2174, -322, 1568, -652, -400, 1756, -808, 1202, 428, -1132, 3124, -214, 1496, -700,
                    2752, 272, 410, -1858, 1376, -726, -832, 1292, 14, 928, 2638, 230, 974, -2092, -94, -478, 296, -898,
                    2446, -936, -1864, 632, 1316, 1196, 2518, -1540, 2878, -2032, 2078, -1600, 1418, 1030, 1556, -1788,
                    -964, 68, 572, -568, 1796, -1408, 668, -1540, 1334, -1054, 1508, -1954, 2464, 1876, -2362, 1868, -2358,
                    -1132, 14, 158, 2308, -58, 3130, 934, 2950, 856, 1172, 380, -832, 1646, -1818, -196, -694, 2866, -2494,
                    2230, 562, -22, 934, 1772, 2036, -808, -16, -2778, -2350, 248, -508, 3052, -1582, 2812, 700, 2158, 232,