MySQL性能监控与诊断
苏普@Taobao DBA
目录
• 监控系统天机：
– 群组、Dashboard ...
• 监控架构
• 其他工具
MySQL监控：告警架构
DB With Agent
北斗展现
数据Server
数据分析
DB With Agent
DB With Agent
DB With Agent 数据报表
DB With Agent
DB With Agent
MySQL监控
• 找到你关心的主机：
MySQL监控：Dashboard
天机 ==> Dashboard
MySQL监控：性能指标
天机 ==> Dashboard ==> 趋势图
MySQL监控：SQL运行
天机 ==> Dashboard ==> Top SQL
MySQL监控：群组监控
天机 ==> 群组 ==> KPI趋势
MySQL监控：实时监控
天机 ==> 群组 ==> 实时趋势
MySQL监控：告警
天机 ==> 告警 ==> 已发送
MySQL监控：告警阀值
天机 ==> 告警 ==> 主机阀值
合并告警 多次确认发送
常见故障排查
• 慢日志
mk-query-digest \
--type=slowlog \
--since="2011-11-02 15:14:00" \
--until="2011-11-02 15:16:25" \
--filter '($event->{host} || $event->{ip} || "") =~ m/192.168.0.1/' \slow.log
|more
常见故障排查(2)
• Orzdba --lazy
Internal Troubleshooting
• GDB
• tcpdump
• oprofiled
GDB
• Quick And Simple
sudo sh -c 'gdb -ex "set pagination 0" –ex \
"thread apply all bt" --batch \
-p $(pidof mysqld) > bt.log'
sudo sh -c 'gdb -ex "set pagination 0" -ex \
"thread apply all bt full" --batch \
-p $(pidof mysqld) > bt.log.full'
GDB-1
• Sample:
#0 0x00002aaab3020481 in buf_LRU_search_and_free_block
#1 0x00002aaab302094e in buf_LRU_get_free_block
#2 0x00002aaab301643e in buf_page_init_for_read
#3 0x00002aaab30214d5 in buf_read_page_low
#4 0x00002aaab3021ec1 in buf_read_ahead_linear
#5 0x00002aaab3018d0e in buf_page_get_gen
#6 0x00002aaab300c612 in btr_pcur_move_to_next_page
#7 0x00002aaab30b8d6a in row_search_for_mysql
#8 0x00002aaab305133c in ha_innodb::general_fetch
#9 0x00000000006a7d97 in rr_sequential
#10 0x000000000061b756 in sub_select
#11 0x000000000062e0ad in do_select
#12 0x000000000063b0d4 in JOIN::exec
GDB-2
• PMP: poor man's profiler
for x in $(seq 1 $nsamples)
do
gdb -ex "set pagination 0" -ex "thread apply all bt"
-batch -p $pid
sleep $sleeptime
done | \
awk '
BEGIN { s = ""; }
/Thread/ { print s; s = ""; }
/^\#/ { if (s != "" ) { s = s "," $4} else { s = $4 } }
END { print s }' | \
sort | uniq -c | sort -r -n -k 1,1
tcpdump
• tcpdump:
nohup tcpdump -n -nn -tttt -i bond0 \
-s 65535 'port 3306' -w tcpdump.ret -C 100 &
tcpdump-1
• tcpdump: Client端瓶颈
tcpdump-2
• tcpdump: Server端瓶颈
tcpdump-3
• tcpdump: Response Time Monitor
oprofile
• oprofile:
sudo yum install binutils-devel
./configure --with-kernel-support && make
make install
sudo opcontrol --deinit
sudo modprobe oprofile timer=1
$dmesg|grep oprofile|tail -n 1
sudo opcontrol --reset
sudo opcontrol --separate=lib --no-vmlinux \
--start --image=/opt/mysql/bin/mysqld
sudo opcontrol --dump
sudo opcontrol --shutdown
opreport -l /opt/mysql/bin/mysqld
Oprofile-1
• oprofile:
CPU: CPU with timer interrupt, speed 0 MHz (estimated)
Profiling through timer interrupt
samples % image name symbol name
34043 72.3826 ha_innodb_plugin.so.0.0.0 buf_LRU_search_and_free_block
4837 10.2845 ha_innodb_plugin.so.0.0.0 ut_delay
2959 6.2915 ha_innodb_plugin.so.0.0.0 buf_LRU_free_block
1283 2.7279 libpthread-2.5.so pthread_mutex_lock
851 1.8094 ha_innodb_plugin.so.0.0.0 buf_page_is_corrupted
546 1.1609 ha_innodb_plugin.so.0.0.0 mutex_spin_wait
315 0.6698 libc-2.5.so memcpy
239 0.5082 ha_innodb_plugin.so.0.0.0 buf_calc_page_new_checksum
179 0.3806 ha_innodb_plugin.so.0.0.0 rec_get_offsets_func
162 0.3444 libpthread-2.5.so pthread_mutex_unlock
107 0.2275 ha_innodb_plugin.so.0.0.0 row_search_for_mysql
98 0.2084 ha_innodb_plugin.so.0.0.0 row_sel_store_mysql_rec
数据查询:WebSQLPlus
WebSQLPlus ==> 分库分表
数据查询:云梯
链接:
hive>
SELECT count(1)
FROM s_xxx
WHERE user_id=452751208 and pt=20111226000000;
Q&A