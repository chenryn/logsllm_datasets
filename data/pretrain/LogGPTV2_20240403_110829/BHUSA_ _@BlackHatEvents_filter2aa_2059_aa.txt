#BHUSA   @BlackHatEvents
Ghost in the Wireless,
iwlwifi Edition
Nicolas Iooss, Gabriel Campana
#BHUSA   @BlackHatEvents
Information Classification: General
Context
-
Up-to-date Ubuntu 18.04 LTS
-
HTTP server
-
Android smartphone
2
#BHUSA   @BlackHatEvents
Information Classification: General
Context
# dmesg
iwlwifi 0000:01:00.0: Start IWL Error Log Dump:
iwlwifi 0000:01:00.0: Status: 0x00000100, count: 6
iwlwifi 0000:01:00.0: Loaded firmware version: 34.0.1
...
iwlwifi 0000:01:00.0: Start IWL Error Log Dump:
iwlwifi 0000:01:00.0: Status: 0x00000100, count: 7
iwlwifi 0000:01:00.0: 0x00000070 | ADVANCED_SYSASSERT
...
iwlwifi 0000:01:00.0: 0x004F01A7 | last host cmd
ieee80211 phy0: Hardware restart was requested
3
#BHUSA   @BlackHatEvents
Information Classification: General
Why this research?
-
This chip implements complex features
-
Likely to have vulnerabilities
-
No public research about the security of Intel‚Äôs Wi-Fi chips
-
Prior art: Broadcom‚Äôs Wi-Fi cards and Intel‚Äôs NIC
-
This sounds fun
-
Yet another smart piece of hardware, widely used in laptops
-
The chip has DMA (Direct Memory Access) by design, because network
-
DMA attacks: FireWire attacks, PCIe screamer, Thunderspy, Thunderclap‚Ä¶
4
#BHUSA   @BlackHatEvents
Information Classification: General
Studied Wi-Fi chips
Intel Wireless-AC 9560
(Picture of a Companion RF Module)
Intel Wireless-AC 8260
5
#BHUSA   @BlackHatEvents
Information Classification: General
Agenda
-
The Ô¨Årmware & talking to the chip
-
Vulnerability research
-
Dynamic analysis experiments
-
DMA through the paging memory
6
#BHUSA   @BlackHatEvents
Information Classification: General
The Firmware
7
-X
7
#BHUSA   @BlackHatEvents
Information Classification: General
Intel WireLess (IWL) Wi-Fi on Linux
8
FW
#BHUSA   @BlackHatEvents
Information Classification: General
iwlwiÔ¨Å chooses a compatible Ô¨Årmware Ô¨Åle using the API version
https://git.kernel.org/pub/scm/linux/kernel/git/Ô¨Årmware/linux-Ô¨Årmware.git/
Firmware file (for Intel Wireless for Linux)
# dmesg
iwlwifi 0000:00:14.3: loaded firmware version 46.6f9f215c.0 
9000-pu-b0-jf-b0-46.ucode op_mode iwlmvm
# ls /lib/firmware/iwlwifi-9000-pu-b0-jf-b0-* 
/lib/firmware/iwlwifi-9000-pu-b0-jf-b0-33.ucode
/lib/firmware/iwlwifi-9000-pu-b0-jf-b0-34.ucode
/lib/firmware/iwlwifi-9000-pu-b0-jf-b0-38.ucode
/lib/firmware/iwlwifi-9000-pu-b0-jf-b0-41.ucode
/lib/firmware/iwlwifi-9000-pu-b0-jf-b0-43.ucode
/lib/firmware/iwlwifi-9000-pu-b0-jf-b0-46.ucode
9
#BHUSA   @BlackHatEvents
Information Classification: General
Firmware file format
00000000: 0000 0000 4957 4c0a 7265 6c65 6173 652f  ....IWL.release/
00000010: 636f 7265 3433 3a3a 3666 3966 3231 3563  core43::6f9f215c
00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 2e00 0000 5c21 9f6f  ............\!.o
00000050: 0000 0000 0000 0000 1600 0000 0c00 0000  ................
00000060: 0000 0000 db15 060f 8b95 020f 2400 0000  ............$...
00000070: 0c00 0000 2e00 0000 5c21 9f6f 0000 0000  ........\!.o....
00000080: 3700 0000 2000 0000 143c 8100 7c74 4600  7... .... $DBGFS/iwlmvm/prph_reg
# cat $DBGFS/iwlmvm/prph_reg
Reg 0xa05c18: (0xc0084f40)
# echo 0xa05c1c > $DBGFS/iwlmvm/prph_reg
# cat $DBGFS/iwlmvm/prph_reg
Reg 0xa05c1c: (0xb552)
# echo 0xa05c20 > $DBGFS/iwlmvm/prph_reg
# cat $DBGFS/iwlmvm/prph_reg
Reg 0xa05c20: (0x0)
// Linux: drivers/net/wireless/intel/iwlwifi/iwl-prph.h
#define UREG_UMAC_CURRENT_PC
0xa05c18
#define UREG_LMAC1_CURRENT_PC
0xa05c1c
#define UREG_LMAC2_CURRENT_PC
0xa05c20
UMAC pc
LMAC pc
No second LMAC
20
HOW‚ÄΩ
#BHUSA   @BlackHatEvents
Information Classification: General
The perspective from iwlwifi (Linux)
21
#BHUSA   @BlackHatEvents
Information Classification: General
Host commands
-
Communication with the chip through PCIe
-
Commands processed by UMAC CPU
-
Undocumented commands
22
#BHUSA   @BlackHatEvents
Information Classification: General
Arbitrary Code Execution
23
-X
23
Abusing undocumented host commands from Linux
#BHUSA   @BlackHatEvents
Information Classification: General
Vulnerability
24
#BHUSA   @BlackHatEvents
Information Classification: General
Exploitation
25
#BHUSA   @BlackHatEvents
Information Classification: General
Send arbitrary commands to the chip
-
Linux ftrace framework
-
No need to build a custom iwlmvm.ko
-
Hijack a single function: iwl_mvm_send_cmd()
-
Custom requests from userland
-
Communicate through /sys/kernel/debug/iwlwifi/*/iwlmvm
$ make
make -C /lib/modules/4.15.0-177-generic/build M=/home/user/hook-driver 
modules
make[1]: Entering directory '/usr/src/linux-headers-4.15.0-177-generic'
  CC [M]  /home/user/hook-driver/exploit.o
  CC [M]  /home/user/hook-driver/ftrace_hook.o
  LD [M]  /home/user/hook-driver/pwn.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/user/hook-driver/pwn.mod.o
  LD [M]  /home/user/hook-driver/pwn.ko
make[1]: Leaving directory '/usr/src/linux-headers-4.15.0-177-generic'
26
#BHUSA   @BlackHatEvents
Information Classification: General
-
rwx region, no mitigations
-
Put the shellcode in a global buffer thanks to a speciÔ¨Åc command 
-
Optional: read memory to ensure that the shellcode was successfully 
written
-
Trigger the vulnerability
Exploit
27
#BHUSA   @BlackHatEvents
Information Classification: General
Payload ‚Äì enable debug mode
$ sudo ./iwldebug.py read 0xc0887ff4 16
c0887ff4: efbe adde efbe adde efbe adde efbe adde
$ sudo ./iwldebug.py write 0xc0887ff4 61626364
Failed to write 4 bytes to 0xc0887ff4 (61626364)
$ sudo ./exploit_enable_debug.py 
[*] loading module pwn
[*] putting shellcode in memory (24 bytes)
[*] ensuring shellcode is there 
[*] triggering overflow
[*] ensuring debug flag is set
    SUCCESS (read at 0xc0a03088: 0x400)!
[*] unloading module pwn
$ sudo ./iwldebug.py write 0xc0887ff4 61626364
$ sudo ./iwldebug.py read 0xc0887ff4 16
c0887ff4: 6162 6364 efbe adde efbe adde efbe adde
28
#BHUSA   @BlackHatEvents
Information Classification: General
Old vulnerability
Intel Wireless-AC 9560
‚õî The vulnerability does not seem to be present
29
Intel Wireless-AC 8260
Old Ô¨Årmware vulnerable
üéâ  Enable debug mode
#BHUSA   @BlackHatEvents
Information Classification: General
Loading patched firmware
30
-X
30
#BHUSA   @BlackHatEvents
Information Classification: General
Discovering the Loader
Linux
Wi-Fi chip
iwlwiÔ¨Å
Memory