因在于只有与用户相关的信息需要防止越权。在实践过程中，携程收集了一批与订单及个人信息关联的关键字用于越权检测的流量筛选。
第二个筛选条件是请求报文是否为静态页面。携程网站基本都做到了前后端分离，页面上展示的与用户强相关的信息都是通过ison请求获取，也就
是说越权检测真正需要检测便是这些json接口的请求。
（2）返回报文的筛选
替换Cookie后，部分返回报文可直接判断是否存在越权。判断条件便是基于关键字的判定筛选，关键字包括“没有权限”、
“无权访问”、
“失败”等。
（3）登录会话维持
落地越权检测系统中很重要的一点是需要维护一套用于替换的Cookie，对此，携程制作了后端平台用于收集和维护各种站点的登录信息。
图：携程越权检测流程示例
http请求输入
替换cookie 发包请求
是否开启了url 关键字匹配
判断是否有权限访问(response中不包含请求失败关键字)
response是否形似度较高&&response中是否包含敏感信息关键字
是否命中关键字
response 是否为html
无需检测
无需检测
无需检测
存在越权
命中关键字的url才会做越权逻辑检测
是
是
是
否
否
否
否
否
无需检测
是
若替换cookie后无权限访问则无需检测
html页面现在关键字误报较高,
目前只关注接口返回信息
FreeBuf 咨询荣誉出品 
30
2 0 2 0  D e v S e c O p s 企 业 实 践 白 皮 书
该后台保存了登录站点所需的用户名、密码、URL以及登录态的Cookie，并且会持续验证Cookie的有效性。验证cookie有效性的方法通常是是每隔
一段时间访问一遍事先配置好的URL，称为“检查URL”，如果访问检查URL返回的页面中包含特定关键字（可通过xpath定位），则证明登录态仍然
有效。
图 携程登录会话维持后台
数据库审计主要是为了检测SQL查询中的异常行为，目前携程分为四个方向进行检测：
-数据外泄：即数据外出检测，用来检测数据被大量拖库的情况； 
-SQL注入：检测是否被尝试或成功SQL注入；
-DB账户鉴权：检测数据库账号使用是否正常；
-DB直连：检测数据库是否被非生产环境直接连接。
具体实现方式是把所有实际执行的SQL语句写入到clickhouse，然后定时去读取其中的SQL语句，分析SQL语句是否存在异常。整体架构图如下：
5.4.5 数据库审计
图：携程 SQL 注入
clickhouse
数据库
应用程序
实际执行的SQL语句
DBAudit
FreeBuf 咨询荣誉出品 
CHAPTER FIVE
31
2 0 2 0  D e v S e c O p s 企 业 实 践 白 皮 书
图 携程内部漏洞管理界面
目前携程在SAST、SCA每周的扫描量约3万任务数，安全评审数量每周约100，内部发现的漏洞数占全部漏洞数的95%以上，其中99%以上为工具自
动发现，漏洞闭环率100%。
携程落地DevSecOps的关键在于嵌入CI/CD流程，减少对开发流程的阻碍，运用多种自动化测试工具使得安全与业务研发实现更紧密的合作。
以应用层面最关注的SQL注入检测为例，分析规则主要分为白名单检测和黑名单检测。
-白名单检测是按照IP或hostname过滤规则，处理来自DBA管理工具或大数据平台的SQL查询问题；-黑名单通过匹配SQL注入特征的规则实现，同
时为了提高准确率，携程还提炼了SQL语句结构树，使得所有黑名单匹配的策略最终落在SQL语句结构树上。
此外，SQL注入检测的特征维度主要根据SQL结构树内容和SQL函数，包含SQL注入常用的探测方式。例如盲注所需的waitfor 
delay、sleep，探测
MySQL表名/列名的information_schema，截取字符串所需的mid、substr，报错注入常用的extractvalue、updatexml、恒真规则，探测数据库信息
所需的current_user等等。此类有效规则共计60多条，基本上涵盖了常见手工注入和工具注入的特征。 
作为DevSecOps流程中重要的一环，漏洞管理平台是不可或缺的一部分，携程使用内部的自研漏洞平台实现全生命周期的漏洞跟踪管理，漏洞管
理流程包括：
-漏洞跟踪：从漏洞发现生成工单到修复完成关闭工单。
-漏洞统计：按漏洞类型、时间、严重等级、来源各个维度进行统计和分析。
-漏洞复盘：对于外部发现的漏洞，通过复盘内部工具、流程，记录未能发现的原因和改进措施；对于内部发现的漏洞，结合黑白盒扫描方式改进规则
发现，提升漏洞检出率。
5.4.5 漏洞全生命周期管理
FreeBuf 咨询荣誉出品 
6
CHAPTER
SIX
第六章
总结 与展望
FreeBuf 咨询荣誉出品 
CHAPTER FIVE
33
2 0 2 0  D e v S e c O p s 企 业 实 践 白 皮 书
6.1 头部行业加快实践步伐
从DevSecOps的发展历程来看，2015年处于技术关注的最高点，承载了极高的市场期望。此后，逐渐从关注度高峰下沉到了具体实践阶段。在此过
程中，有一类声音一度出现过，DevSecOps对于企业是一个乌托邦式的存在。事实上，企业文化鸿沟与先进工具的缺失、潜在的威胁与安全问题等
等，都让企业在落地DevSecOps的过程中困难重重，变得可望而不可及。
不过伴随着DevSecOps战略框架的日趋完善，国内相关行业的建设也迅速开展起来，金融、运营商、通信、互联网等头部行业实践效果也在逐步提
升。同时，此外，随着《研发运营一体化（DevOps）能力成熟度模型》的发布，合规也成为企业落地的方向之一。
6.2 实践需贴合企业属性
DevSecOps贯穿于企业开发运维整体的生命周期，对于IT发展成熟企业或规模较小企业，实践往往意味着大刀阔斧的变革。
因此并不是所有甲方都适合直接套用DevSecOps实践流程，还需根据自身的组织发展目标、文化特点及业务场景做进一步论证，将安全长远规划与阶
段性实施相结合，逐步摸索出企业自己的安全能力体系。对企业来讲，选择合适的安全工具切入DevSecOps是更加柔和有效的实践方式。
6.3 安全是每个人的责任
安全是每个人的责任，人人参与DevSecOps才能保障安全。2020 RSAC也以“Human Element”为主题，核心是从源头做安全治理，需要让人成为安
全建设的一环，而不是安全问题的一环。
同时在成熟企业落地DevSecOps的过程中，不难发现，企业安全文化的培养总会列为重中之重。安全和各个团队都需要参与到DevSecOps研发模
式的不断建设和优化中来，不断推进DevSecOps理论和工具链的向前发展，不断提供更好更便利的安全能力并且尽可能的通过自动化、自助化等
方式为研发工程师赋能，这种多文化、多学科的自动化安全环将会促使每个人都关注安全，这也是DevSecOps的驱动来源。
FreeBuf 咨询荣誉出品 
附录：参考链接
[1]中国DevOps现状调查报告（2019）
[2]GitLab第四次全球DevSecOps年度调查报告
https://blog.csdn.net/weixin_40046357/article/details/106271285
[3]2017 State of DevOps Report.
https://puppet.com/system/ﬁles/2017-10/2017-state-of-devops-report-puppet-dora.pdf
[4]Gartner: DevSecOps: How to Seamlessly Integrate Security Into DevOps.
https://www.gartner.com/document/3463417
[5]RSA Conference.
https://www.rsaconference.com
[6]Gartner: 10 Things to Get Right for Successful DevSecOps.
https://www.gartner.com/document/3811369
2 0 2 0  D e v S e c O p s 企 业 实 践 白 皮 书
34
FreeBuf 咨询荣誉出品 
出 品 方
安全聚合力系列
《2020 DevSecOps 企业实践白皮书》
FreeBuf 咨询荣誉出品