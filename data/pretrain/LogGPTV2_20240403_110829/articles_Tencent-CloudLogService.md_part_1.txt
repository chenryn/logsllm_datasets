TencentCLS: The Cloud Log Service with High Query
Performances
MuzhiYu ZhaoxiangLin JinanSun
PekingUniversity TencentCloudComputing(Beijing) PekingUniversity
Beijing,China Co.,Ltd. Beijing,China
PI:EMAIL Beijing,China PI:EMAIL
PI:EMAIL
RunyunZhou GuoqiangJiang HuaHuang
TencentCloudComputing(Beijing) TencentCloudComputing(Beijing) TencentCloudComputing(Beijing)
Co.,Ltd. Co.,Ltd. Co.,Ltd.
Beijing,China Beijing,China Beijing,China
PI:EMAIL PI:EMAIL PI:EMAIL
ShikunZhang
PekingUniversity
Beijing,China
PI:EMAIL
ABSTRACT PVLDBArtifactAvailability:
Withthetrendofcloudcomputing,cloudlogserviceisbecoming Thesourcecode,data,and/orotherartifactshavebeenmadeavailableat
increasinglyimportant,asitplaysacriticalroleintaskssuchas URL_TO_YOUR_ARTIFACTS.
rootcauseanalysis,servicemonitoringandsecurityaudition.Cloud
LogServiceatTencent(TencentCLS)isaone-stopsolutionforlog
1 INTRODUCTION
collection,storage,analysisanddumping.Itcurrentlyhostsmore
thanamilliontenantsandthetoptenantcangenerateuptoPB-level Withthetrendofcloudcomputing,cloudlogservicehasbecomein-
logsperday. creasinglypopular.Logservicessignificantlysimplifythecollection
ThemostimportantchallengethatTencentCLSfacesistosup- andanalysisoflogs,andprovideanone-stopsolutionforscenar-
portbothlow-latencyandresource-efficientqueriesonsuchlarge iossuchasrootcauseanalysis,servicemonitoringandsecurity
quantitiesoflogdata.Toaddressthatchallenge,weproposeanovel audition.
searchenginebaseduponLucene.Thesystemfeaturesanovelpro- Cloudlogservicealsohasahugebusinessvalueandtherefore
cedureforqueryinglogswithinatimerange,anindexingtechnique attractsmanycompanies.Notonlytherehavebeencommercially
forthetimefield,aswellasoptimizedqueryalgorithmsdedicated successfulenterprisesdedicatedinlogservices,suchasSplunk[9]
tomultiplecriticalandcommonquerytypes. andElastic[6],butalsomanycloudvendorshavelaunchedtheir
Asaresult,thesearchengineatTencentCLSgainssignificant ownlogserviceproduct[1,4,5].
performanceimprovementswithregardtoLucene.Itgains20x TencentCloudLogServices(TencentCLS)[?]isthelogservice
performanceincreasewithstandardqueries,and10xperformance product provided at the Tencent Cloud, and it has experienced
increasewithhistogramqueriesinmassivelogqueryscenarios. rapidgrowthinthepastyear(500%anualgrowth).Inthispaper,
Inaddition,TencentCLSalsosupportsstoringandqueryingwith wedescribesomecharacteristicsandchallengesofthebusiness
microsecond-leveltimeprecision,aswellasthemicrosecond-level scenariosfacedbyTencentCLS,andexplainthearchitectureand
timeorderpreservationcapability. thetechniquesemployedwithinTencentCLS.Wealsoprovideex-
perimentalevaluationswithregardtosomemajortechniques,in
ordertoshowthebenefitsofthosedesigns.
PVLDBReferenceFormat:
MuzhiYu,ZhaoxiangLin,JinanSun,RunyunZhou,GuoqiangJiang,Hua TheTencentCLSbusinessscenarioshavethefollowingcharac-
Huang,andShikunZhang.TencentCLS:TheCloudLogServicewithHigh teristicsandchallenges.
QueryPerformances.PVLDB,14(1):XXX-XXX,2020. HeavyandSkewedLogWrites
doi:XX.XX/XXX.XX ThelogsstoredinTencentCLSareoflargeandskewedquantity.
Currently,TencentCLShasmillionsoflogtopics,aboutonly10%
ThisworkislicensedundertheCreativeCommonsBY-NC-ND4.0International percentofwhicharemonthlyactive.
License.Visithttps://creativecommons.org/licenses/by-nc-nd/4.0/toviewacopyof Thelogscollectedperdayfortheactivetopicsarehighlyskewed.
thislicense.Foranyusebeyondthosecoveredbythislicense,obtainpermissionby
emailinginfo@vldb.org.Copyrightisheldbytheowner/author(s).Publicationrights Concretely,thetoptopichasmorethan100billionlogscollected
licensedtotheVLDBEndowment. perdaywhile90%oftheactivetopicsgeneratelessthan10million
ProceedingsoftheVLDBEndowment,Vol.14,No.1ISSN2150-8097.
logsperdayeach.
doi:XX.XX/XXX.XX
HeavyandSkewedLogQueries
It is worth noting that higher timestamp precision not only
allowsstoringandqueryingwithhigherprecision,butalsokeeps
amicrosecond-leveltimeorderoftheretrievedlogs.Thisisuseful
whenapplicationsgeneratemultiplelogsatthesamesecond.With
TencentCLS,itismoreprobablethatthoselogsareretrievedinthe
sameorderastheywerewritten.
Wehaveconducteddetailedexperimentsusingtheopenbench-
marktodemonstratethesuperiorityofoursolutioncomparedto
Lucene.Generally,oursolutiongains7.5xto38xperformancein-
creases,withregardtodifferenttypesofqueries.Moredetailed
comparisonsandanalysesareshownintheexperimentalevalua-
tionsection.Inadditiontotheopenbenchmark,wehavealsoshow
Figure1:Thelatencydistributionofdifferenttypesofqueries
theperformanceincreasesusingtherealworlddatacollectedby
CloudLogServiceatTencent.
Thepaperisorganizedasfollows.Section2givesthebackground
Notonlythequantityoflogshasaskeweddistributionbutalso
forthelogsearchsolutions.Section3describestheoverallarchi-
thequerylatency.AsisshowninFigure1,althoughtheaverage
tectureofTencentCLSanditsmodules.Section4elaboratesonthe
latencyofqueriesisbelow1second,thereisalong-taileffect,and
designofthesearchengineofTencentCLS.Section5providesboth
someofthequeriestakeupto30secondsoreventimeout.
offlineandonlineexperimentalevaluationofthesearchengineof
To be more precise, suppose that we use Lucene [12] as the
TencentCLS.
searchengineofTencentCLS,theindexofthetimestampfieldof
10billionlogswouldhavethesizeofaround30GB.Evenloading
2 BACKGROUND
theindexfromadiskdrivethathasthespeedof150MB/stakesup
atotalof200seconds. Currently,therearemanysearchenginesintheindustry,including
Accordingtotheonlinedata,around95%ofthequeriesaskfor Lucene[2,12]anditsvariants[16,21],Sphinx[8],Xapian[10],
thelatestdailylogs.Inorderforthosequeriestobeansweredin MG4J[7],etc.ThemostwidelyusedareLucene-basedproductsand
lessthan30seconds,thenumberofthelogswrittenoneachdrive Sphinx.Welistthecharacteristicsofeachsolutionbelow,explain
perdayislimitedto1.5billion.Therefore,forthetoptopicthat whywechoosetobasethesearchengineofTencentCLSonLucene,
generates100billionlogsperday,atotalofatleast67disks(witha anddescribeafewweaknessesofLucenethatweneedtoaddress.
speedof150MB/s)arerequired,whichisverycostly.
HistogramQueriesareCommon 2.1 SearchEngineOptions
Inaddition,foreachquery,TencentCLSshowsthedistribution Sphinx [8] is a search engine library that features high-speed
oflogsintimethatmeetstheconditions.Wecallthequeriesthat indexgenerationandhigh-speeddistributedsearch.Ithasagood
supportsuchvisualizationhistogramqueries,whichcollectthe supportforMySQL.However,asastaticsearchengine,Sphinxis
countsofhitsindifferenttimesegments.Histogramqueriesare notsuitableforreal-timesearch,orscenarioswithfrequentdata
extremelycommon,butalsoresourcedemanding. updates.ItalsohasahighdiskIOoverhead.
Theabovechallengescanbeworseifweusehigherprecisionfor Xapian[10]sharesasimilardesignwithLucene,andalsopro-
timestamps,becausetheindexofthetimestampwillgrowlarger videsarichandextensiblesetofAPI.Itevenachieveshigherquery
astheprecisionincreases,andultimatelyslowingdownthequery performancesthanLucene.However,itlackstheconceptsoffields
processes. orcolumns,whichisratherdifferentfromtraditionaldatabases.
Therefore,itisabothnecessaryandchallengingtasktodesign Lucene[2],ontheotherhand,cangenerateindexesonfieldsand
asystemthatsupportslow-latencyqueriesontheselarge-quantity, supportretrievalbyfields.Italsosupportsreal-timeindexgenera-
highly-skewedlogdata. tion,queryandupdate.Luceneitselfhasexcellentobject-oriented
Oursolutionisanovellogsearchenginefeaturingtimeseries systemarchitectureandintegratesapowerfulsearchengine.Based
index.ItisbasedonLuceneandisoptimizedespeciallyforlogdata. onLucene,SolrandElasticSearchbothsupportdistributedstorage
ComparedwithLucene,itdiffersmainlyinthefollowingaspects. anddistributedquery.
(1) Wekeepthedocumentssortedaccordingtotheirtimes- Solr[3]wasthemostmatureandstableLucene-basedindexing
tamps. componentbeforeElasticSearch.Afteritslaunch,ElasticSearch
(2) Wedesignantimeseriesindexdedicatedforthetimefield. becomefarmorepopularthanSolr,becauseElasticSearchhasmore
(3) We design a search algorithm dedicated for tail queries powerfulreal-timesearchcapabilitiesaswellasotheradvantages
(queriesthatareexpectedtoreturnthelastfewhits). includingeasy-to-use,near-zeroconfiguration,friendlyRESTful
(4) We optimize the histogram queries (queries that are ex- queryinterface,convenientclusterdeploymentandmanagement.
pectedtoreturnthedistributionofnumberoflogsintime). Italsohasthefollowingfeatures.
Thankstothedesign,TencentCLSsignificantlylowersthequery • Highavailability:ESsupportsindexingonshardsandmulti-
latency,andsupportsmicrosecond-levelprecisionfortimestamps nodedistributedquery.
withlittlecost.Inthescenariodescribedabove,weonlyneed3 • Persistency:ESsupportsmulti-machinebackup,self-monitoring
disksinsteadof67toachievethesamequerylatency. andbalancing.
2
3.1 AccessLayer
Theaccesslayerreceives,processes,andforwardstherequeststo
otherlayers.Itconsistsofmultiplemoduleswhichtakescharge
ofauthentication,validation,centralizedflowcontrol,andsoon.
Validrequestswillbeeventuallyforwardedtothewritelayeror
thequerylayeraccordingtotheirtypes.Modulesatthislayerare
deployedascontainers,andtheresourceswillbeautomatically
adjustedasthedemandschange.
3.2 StatelessWriteLayer
Thewritelayerprocessesthewriterequests.Itwritesthedatato
thecorrespondingtopicinthemessagequeueofthedatastorelayer.
Thelayerisdesignedtobestateless,andthemappingbetweenthe
topicsandthetopicsinthemessagequeueismaintainedwiththe
Multi-TenantResourceManager,whichisdescribedbelow.The
layerisdeployedascontainers,andsupportsautoscaling.
3.3 StatelessQueryLayer
Thequerylayerprocessesthequeryrequests,andconsistsoffunc-
tionalitiessuchasqueryparsing,querytranslation,collectionand
aggregationofretrievedinformation,etc.Thelayerisalsodesigned
tobestateless,thankstotheMulti-TenantResourceManagermod-
Figure2:TheTencentCLSArchitecture ule.Thelayerisdeployedascontainers,andsupportsautoscaling.
3.4 Multi-TenantResourceManager
• Scalability:ESsupportsdiscoveringandjoiningnewnodes
Themulti-tenant[11]resourcemanagermaintainsthemappings
andhorizontalautoscaling.Nodefailuresdonotaffectthe
fromthetopicsofthetenantstothreekindsofresourcesinthe
cluster.
datastorelayer:thetopicsinmessagequeue,theindexes,andthe
Due to its many advantages and rapid development, Elastic- buckets.Tobemoreprecise,eachtopiccorrespondstoonetopicin
Searchnowenjoysagreatcommunity,andhasmanywell-known themessagequeue,manyindexesandonebucket.Therefore,we
enterprisesusersaswellasalargenumberofstartupcompanies. achieveagoodisolationbetweenthedatafromdifferenttenants.
Aftercomparativeanalyses,wehavefinallydecidedtouseLucene Wealsoconductedtwooptimizations.First,weslicethedatainto
/ElasticSearchasthebasisofourdistributedlogstorageanddis- manyindexesaccordingtotheirtimestamps,sothatwecanperform
tributedfull-textsearchsolution. basicpre-filteringonthequeries.Second,sincealargeproportion
ofthetenantsneverwriteanydata,wepostponedtheresource
2.2 WeaknessesofLucene allocationinthedatastorelayertothepointwheretheactualdata
writehappens.Todoso,weintroducetheconceptofvirtualstorage
Lucene’ssupportforrangequerywasnotprovidedatthebegin-
resource(VSR),anabstractionofthestorageresource.However,
ning,andwhenitwasfinallyintroduced,ithasperformanceissues.
thisoptimizationbyitselfincreasesthelatencyoftheinitialwrite.
Inpractice,thesearchcanbeveryslowwhentherearemanyoc-
Tomitigatetheeffect,wemaintainapoolofresourcesinthedata
currencesoftermsinasingledocument.AlthoughLuceneisoften
storelayersothattheallocationisdonebeforehand,andonlythe
regardedasanefficientfull-textsearchengine,itshighperformance
databindingisdoneattheinitialwrite.
ismostlylimitedtobooleanqueries.
StartingwithLuceneversion6.0,anewindexdatastructure
3.5 DataStoreLayer
BKD-Tree[19]fornumericdatatypewasintroducedtooptimize
theperformanceofrangequeriesinLucene. Thedatastorelayerconsistsofthreeparts:1)themessagequeue,2)
ThecomplexityoftheBKDalgorithmislinearlycorrelatedwith theindexstorage,and3)thecloudstorage.Themessagequeueisto
theindexcardinality,andthenumberofhits.Therefore,theorig- smoothoutthelatencyofwriterequests.Toensuredatareliability,
inalBKDalgorithmisnotsuitableformassivelogquery,whose multiplecopiesofdataarekeptinthequeue,andthewriterequestis
timestampsareofhighcardinality. respondedonlywhenmorethantwocopieshavebeensuccessfully
written.
3 ARCHITECTURE
3.6 IndexStorageLayer
ThearchitectureforTencentCLSisshowninFigure2.Theentire
systemisdeployedonTencentCloud,usingcloudservicessuchas Theindexstoragelayermaintainstheindexesfordifferenttenant
ElasticComputeService,CloudObjectStorage,etc.Itscomponents topics.TheimplementationisbasedonLucene.Inordertosupport
aredescribedasfollows. variouskindsofqueries,webuildvariousindexessuchasinverted
3
indexes[14],SkipList[17]indexesandBKDTree[19]indexes.Also, indexing.Therefore,searchingwithtimeconditionsonmassivelog
column-orientedstorageisadoptedtosupportefficientanalyses. datawithLucenecanbeextremelyslow.
Whatmakesitevenworseisthat,mostlogqueriesdoesnot
3.7 ObjectStorageLayer specify a single timestamp, but instead specify a range of time,
Theobjectstoragelayertakescareofthedatapersistence.Italso asisshownintheaboveexample.Suchquerieswillrequireeven
supportsdemandssuchasre-indexingfromobjectsintheeventof moretimetofinish,becauseLucenehastoscanthroughallthe
anexception. timestampsandretrievethecorrespondingdocids.Therefore,the
timerangequeryonmassivelogdataalmostguaranteestotime
4 ASEARCHENGINEOPTIMIZEDFORLOG out.
QUERY Althoughtherehavebeenvariousoptimizationsandvariants
basedoninvertedindex[13,15,16,18,20,20],veryfewofthem
ThissectiondescribesthesearchengineusedinTencentCLS.The
arebattletested.Whatweadopthereisalightweightsolution.
searchengineisbuiltuponLuceneandishighlyoptimizedforlog
queries.
4.4 OurSolution:ASearchEnginewithTime
Webeginwithsomebasicexamplesofqueries,andthenwe
brieflydescribetheindexingandsearchingofLucene.Next,we SeriesIndex
demonstratethecharacteristicsoflogqueriesandexplainwhythe Toachievebetterperformanceswithlogqueriesandaddressthe
defaultindexingandsearchingfunctionalitiesprovidedbynative aboveproblems,weproposeaLucene-basedsearchenginewith
Lucene is not satisfactory. Finally, we propose our design, and timeseriesindex.
elaborateonitsdifferencesfromtheLucenesearchengine. ThecoredesignchoicewemakewiththeTencentCLSsearch
engineisthatthelogdocumentsarealwayssortedbytimestamps
4.1 AnExampleLogDocumentandLogQuery
intheascendingorder.
Atypicallogdocumentconsistsofatimestamp,text,andproperties. Wefirstexplainhowthisdesignbenefitstheperformanceoflog
Belowisanexample. queries,thendescribetheoverheadofapplyingthatfunctionality,
and next provide some implementation details. Finally, we also