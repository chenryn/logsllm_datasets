志。当然也可以把我们所需要记录的日志，比如 PHP 错误日志等都输出到/var/log 目录下，
点击应用菜单下方的Search按钮即可看到生成的日志报告（比如cron日志，mail日
要分析的那些日志类型。
从图中我们也可以看出Splunk默认支持的日志种类很多，包含多数运维人员平时工作所需
为中文，开始导入数据，如图3-27所示。
3.7.5设置日志分析目录
NTSyslog。
点击Splunk首页右上角的Home按钮，再选择添加数据，选择服务器本地文件，若选
Log:
当首次进入Web 界面后，需要重设密码，并添加数据。进入系统可以将默认语言选择
系统中的搜索工具栏是Splunk最强大的工具，为了学习Splunk，我们先在http://www.
1.Splunk搜索的使用
选择数据源（从本地），接着选“从文件和目录”，选择/var/log 即可。如图3-28所示。
其实还可以通过 Syslog 来收集 Windows 的日志，这里可以使用一个免费工具—
我们看看仪表盘的内容。读者应该已经熟悉搜索栏及时间范围选择，摘要仪表板上也有
disabled=0
event_log_file=Application,System
interval=60
server=192.168.122.1
[WMI:AppAndSys]
欢迎使用Splunk
splunks
欢迎使用
用是用于提和分折数据的默认界面。它允许急格数据案引]例 Spnk;
启动搜索应用
图3-27导入数据
第3章建立日志分析系统127
入门教程
本版本的新增内答
文档
助
---
## Page 151
查各事件活动的高峰期和低谷期。时间轴选项位于时间轴上方。可以放大或缩小图表。
峰值和谷值可表示活动高峰期或服务器停机。因此，此时间轴可有效用于强调时间模式或调
不断更新时，读者可能会注意到有条状图案。每一条状图案的高度表示时间记录。时间轴的
到，当向下钻取事件时，此数目会发生变化。
的总数。时间轴下方事件列表上方的记录显示用户所选时间范围内的事件数目。稍后可以看
配事件记录，另一组为已扫描事件记录。搜索完成后，时间轴上方的记录显示的是匹配事件
件列表或搜索结果。
这些内容。但搜索仪表板上还包含其他内容，如事件记录、时间轴、字段菜单及检索到的事
128UNIX/Linux网络日志分析与流量监控
2）事件的时间轴：时间轴能直观地显示每一时刻发生的事件。当时间轴随着搜索结果
source(5)
2,000
1）匹配及扫描事件记录：在搜索中，Splunk在检索时将显示两组事件记录：一组为匹
三7月38
4.171
编小
细的至物
splunk>主贡》添加数据
近回主页
从UDP端口
从文件和目录
或选择救据源
文件或文件目录
达择救据类型
向Splunk添加数据
113-7-10下午03:00.000
导出活项
74,171事件始线
区域
从TCP瑞口
取消选择
周五7月5日
图3-28选择本地数据源
收集Windows性能数据
收集Windows注册表数据
Cisco设备日志
OPSECLEA
图3-29开始搜索
周日7月7日
监视AdiveDirectory架构
收集本地Windows事件日志
任何其他数据
IS日志
日志、指标和其他数据
管理器告警任务注销
上页23456789
助（关于
周二7月9日
---
## Page 152
如图 3-31 所示。
精确找到数据源就很容易找到问题。
10.2.1.44有错误。这时该如何利用搜索功能查找问题？
看事件时，表格只显示已选字段。
件查看器位于时间轴下方。事件默认显示为列表，也可以选用表格查看。选择按表格形式查
中抽取的。
设置为搜索结果可见格式。将默认显示主机、源及源类型。其他字段是 Splunk从搜索结果
有字段列在搜索结果旁边。运维人员可以选择其他字段来显示搜索的事件。所选字段都已被
生成数据信息，这称作字段。当运维人员进行搜索时，Splunk 将把其从字段菜单上识别的所
access_combined_wcookie代表数据源，根据提交的日志而定。为了缩小范围，在搜索栏
4）事件查看器：事件查看器将显示Splunk 搜索到的与运维人员的搜索匹配的事件。事
当然如果不知道数据源，也可以直接输入 IP 地址，这时匹配的条目会非常多，如果能
先构造一个场景：假如有人投诉网站，说在提交购物表单时系统总是提示 IP 地址
3）字段菜单：前面说过，将数据编入索引时，Splunk可自动按名称和值的格式识别并
这时可以输入如下内容：
2.搜索实例解析
Seids
sourcetype=access_combined_wcookie 10.2.1.44 purchase
sourcetype=access_combined_wcookie 10.2.1.44
积事件始修
109事件触线
周7月4日
10.2.1.44
10.1
出速质
图3-31缩小搜索范围
图3-30使用搜索功能
六7月6日
日7月7日
日7月7日
第3章建立日志分析系统129
上一页234567日910下一页10每页
一7月吧
第二7月日
月站
折
Smar
10每页
---
## Page 153
件。该搜索可告诉 Splunk，希望看到在这段时间内发生的所有事件。
小时内所发生的事件，如图3-33所示。
间戳，1个柱状体=1分钟，这个单位根据你的选择而动态变化，这样搜索将仅限于选定的
间。滑动鼠标，选中其中一个柱状体，将弹出工具提示，并显示时间数目和该柱距的原始时
那次搜索开始，继续进行下面的步骤。时间轴上的各柱状体代表搜索的匹配事件发生的时
算和或者非子句。
号外面的下一个值对。当括号内的所有运算符都运行完成，Splunk 将先计算或子句，然后计
便进行更复杂的搜索。计算布尔表达式时，Splunk 将从最里面的括号开始运算，接着运算括
以第四步的搜索和下述语句相同：
除无关事件。
如图3-32所示。
诉网站出了问题，那么就要找出不是200的日志。使用布尔运算方法：
130UNIX/Linux网络日志分析与流量监控
Splunk支持使用星号（*）通配符来搜索“所有”或根据关键词的部分进行模糊检索事
、使用布尔运算符可进行搜索的信息更多，Splunk 支持的布尔运算符有：与、或和非。所
Apache 服务器日志中发现大部分事件的状态码为“200”，它代表“成功”。现在有人投
●点击选择上述的所有时间轴，可再次显示所有时间。
时间轴的其他功能：
现在已经确认存在问题的类型，下一步是找到导致问题的原因。从发现顾客无法购买的
4.使用时间轴
当搜索中含有布尔表达式时，运算符须全部大写。使用括号将有关表达式组合起来，以
匹配条数骤减到31条。这时发现了HTTP服务器（503）错误，用这个方法可以快速排
3.使用布尔运算符查找日志
可以看到左上角搜到的日志从109条降到83条。注意，搜索关键词时，不用区分大小写。
点击缩小，可扩展时间轴，看到更多事件。
点击放大，可锁定与搜索匹配的选定事件范围。
四7月日
 sourcetype=access.* 10.2.1.44 purchase NOT 200
出选项
五7月5日
图3-32使用布尔运算符查找
周六7月6日
上一页234下一页。10页
周一7月日
Smr
1条
---
## Page 154
进行下一个指令或进入下一个搜索指令管道线。
线左边的搜索结果，并将这些结果作为管道线后面的开头部分。可以跳过一个指令的结果，
所示。
所示。
源和数据源类型都为已选择字段，并包含在搜索结果中。
行搜索后，Splunk从数据中选取的所有字段会出现在这个列表中。注意所有默认字段、数据
如果想通过Splunk了解网店最受欢迎的商品，top指令实际上很适用。搜索指令如图3-35
例如，要搜索某人已经从网店购买过几次鲜花，可用以下命令实现。操作结果如图3-34
完成购买类型的搜索，指令如下：
经过这样处理 Splunk 检索搜索目的更明确。
当Splunk 检索到这些事件时，字段菜单（左边蓝色部分）与已选字段一同更新。在运
搜索所有时间内的互联网访问数据，通常这样匹配出来的日志有很多。量会参个为
5.使用字段进行搜索
tcess_"
sourcetype=access_*purchase flower*
sourcetype="access_*"
purchase flower
272事件2013-7-4从下午07:00:00到下午08:00:00
下午710
下午720
图3-34搜索购买次数
图3-33使用时间轴
CEHL
14.ce
上页23 4 5 67 09 10 下一页。20
第3章建立日志分析系统131
下午750
自时姆
20每
---
## Page 155
所示。
“Successfully created pfirewall”提示则表示整个设置过程成功了。分析防火墙日志如图3-37
息，这时系统提示为新建的数据源类型命名，例如 pfirewall，然后点击保存。若看到
源类型，这里选择“Start a new source type”，点击继续按钮之后就能立刻看到防火墙日志信
录”，此时出现“Previewdata”，意思是需要选择Splunk服务器的本地文件日志文件，这时
“添加数据”。这时在第一行显示“向Splunk添加数据”，在选择数据源中点击“从文件和目
是添加数据和启动搜索应用，这里点击添加数据。或者在右上角单击“应用”－“Home”
该搜索的结果展示在用户IP及计数字段值列表中。使用如下指令实现：
所示。
132UNIX/Linux网络日志分析与流量监控
访问鲜花和礼品店的用户通过他们的IP地址区分各种身份，IP地址为用户 IP字段值。
默认情况下，登录到Splunk后，首先看到的是“欢迎使用”标签。下面有两项，分别
8.分析防火墙日志
7.使用stats指令
这个指令会显示出一张顾客最经常购买商品列表，附有每个值的计数和百分比。如图3-36
sourcetype=access_*action-purchase category_id=flowers|stats count by clientip
导出
图3-36搜索顾客最经常购买商品
UR
图3-35搜索指令流水线
201
-e14
号开自
自定义时有
---
## Page 156
机），它们对应的时间就分别是开机时间和关机时间。
事件（事件ID号为6005 的事件表示事件日志服务已启动，即开机；事件 ID6006表示关
查看器程序，在左侧窗口中选择“系统”，从右侧系统事件中查找事件ID为6005、6006的
提取6006的事件和6005的事件信息系统，思路是在Windows中打开eventvwr.msc，即事
源头。输入EventCode-6005orEventCode-6006查询可以掌握计算机的开关机情况，主要
核心交换机上丢弃数据包的具体情况，根据这些情况可以统计一些经常出现的被丢弃数据
“power”可快速查找重要设备是否会出现“poweroff”的情况。搜索关键字“deny”可查
一目了然；搜索关键字“SYNflood”，可在防火墙日志中查找SYN攻击事件；搜索关键学
量存在IP地址冲突的地址，其中地址冲突所发生的时间以及冲突的源主机MAC地址都可
管可更快捷地查看当天或者过去几天设备接口连接状态。搜索关键字“duplicate”，发现有少
32767KB，路径为%systemroot%\system32\LogFiles\Firewallpfirewall.log。
进入控制面板-Windows 防火墙-高级设置-选择属性，打开日志即可，最大记录日志大小为
志，所有日志都不可重复添加，否则会报错。
择 Splunk 主页标签，再选择搜索栏目，在“来源类型”中就能看到刚刚设置的 pfirewall 
Splunk能通过搜索出日志中的重要关键字来挖掘出网络设备日志中有价值的信息。搜索
9.关键字段的应用
默认情况下Windows7系统防火墙日志记录功能是关闭的，首先需要启用，方法如下：
如果下次进入 Splunk 找不到 pfirewall 位置，可以在右上角单击“应用”－“Home”，
注意：
source(1)
Tields
Q缩
pe=windowsfirewal1DROPTCPAND142.e
62
宿融到所选区域1-联消选择
下午0258:10
1137127年
1evet2013-7-12下午025847
下午0258:20
图3-37分析防火墙日志
工
内