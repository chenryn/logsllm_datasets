**作者：启明星辰ADLab**  
**原文链接：**
## 引言
Cobalt Strike是一款商业化的渗透测试利器，由著名的攻防专业团队Strategic
Cyber开发。该工具被广泛应用于渗透测试项目中，在提高政府和企业网络设施安全性上起到了重要的作用。同时，随着网络空间的红蓝对抗不断发展，该框架成为对手模拟和红队行动中最为流行的一款软件。但由于该框架具备团队协作攻击、流量防检测、防安全软件查杀等优势，因而也被大量黑客组织用于真实的高危害性的攻击。目前已知的多个APT组织都曾经使用过Cobalt
Strike攻击框架，如FIN6、Cobalt Group组织和“海莲花”等。但是，目前所披露出来的攻击情报只是黑客利用Cobalt
Strike进行非法攻击的冰山一角。由于该框架集成有丰富的逃避流量监测和沙箱检测技术，且具备优秀的反追踪能力，再结合黑客团体积累的免杀技术和C&C隐藏技术，使得业内对Cobalt
Strike框架的在野利用状况知之甚少，也很难有一个全面的了解和清晰的认知。这种情况直接导致大量依赖于Cobalt
Strike框架进行的网络攻击行为被忽视或者漏掉，如目前仍然存在许多VT查杀率为0的样本以及因利用C&C隐藏技术而存活至今的控制命令服务器。
因此，本文通过逆向工程的手段提取出深度有效的指纹特征，通过各种渠道和自有样本平台对关联样本进行采集分析，最后我们利用其C&C加密与存放的机制来自动化的提取这些被深度隐藏的C&C服务器地址。通过已有数据的分析和追踪我们将对Cobalt
Strike框架的在野利用情况进行一次全面分析。最后，我们还溯源到10个已知的APT组织在使用该框架进行攻击，并且发现了大量使用流量伪装技术、DNS隧道技术、CDN技术、域名前置技术进行流量隐藏的未知APT攻击。当然还收获了大量的使用Cobalt
Strike框架的仿冒域名。这些数据在我们进一步的威胁分析与情报挖掘中起到了重要的作用。
本文将揭秘Cobalt
Strike的在野使用情况，对具体所使用的部分APT攻击组织进行披露，同时对在野利用的各种技术如流量伪装和C&C隐藏技术进行分析，并对Cobalt
Strike服务器“NanoHTTPD
Servers”特征探测的价值进行评估。木马分析部分，我们通过以上情报发现了一起攻击案例，通过分析最后确定该攻击是由攻防实战演练的一个红队发起的，文中我们会阐述这次攻击案例的攻击过程及其攻击手法，并进一步的对黑客所采用的一些特种技术包括逃逸管道、DNS隧道、SMB隧道技术等进行深入分析。
## 分析简述
### 2.1 Cobalt Strike简介
Cobalt Strike是一款基于Java编写的全平台多方协同后渗透攻击框架，也称为CS。早期版本依赖Metasploit框架，Cobalt Strike
3.0之后则是作为单独的平台使用。其支持多种通信协议，包括http、https、dns、smb等，同时集成了提权、凭据导出、端口转发、端口扫描、横向移动、Socks代理、钓鱼攻击等功能，且支持丰富的扩展插件，几乎可以覆盖APT攻击链所需的各个技术环节。木马生成方面也涵盖了大多数的平台和攻击场景，包括
PE木马、ELF木马、网页木马、Office宏病毒木马等。不过Cobalt
Strike是一款商业运营的收费软件，每位使用者一年的许可证费用为3500美元，许可证续签费用为每年2500美元。
图1 Cobalt Strike软件界面
### 2.2 样本采集与处理
为了对Cobalt
Strike的在野使用情况进行全方位的了解和评估，启明星辰ADLab安全研究人员通过长期追踪，采集和分析了大量的关联木马样本，并针对其多种类型和版本的样本提取了指纹特征。
Cobalt Strike的木马生成基于其框架下的模版文件如：beacon.dll、artifact32.dll(存放于Cobalt
Strike.jar文件内的resources目录下)。使用者在配置C&C、端口及其他信息时，Cobalt
Strike会将这些信息加密存放于这些模板文件中。通过分析这些信息加密算法和存放规则，便可以大批量地提取Cobalt
Strike样本的C&C服务器地址。目前我们分析了包含有Beacon、Artifact、Payload、Shellcode等类的Cobalt
Strike样本，并实现了批量样本的C&C解密和提取。这种方法相对来说比自动化沙箱更快速有效。有了这些C&C我们可以进一步描绘出CS使用者的分布情况，以此为线索还可以挖掘出更多情报。
通过长期的样本收集，我们共得到了8380个Cobalt
Strike样本，样本文件包含有EXE、DLL、VBScript、PowerShell等。我们将逆向分析得到的C&C定位规则和C&C解密算法脚本化，得到了自动化处理脚本。通过脚本处理后，最终提取到了973个C&C。在分析过程中我们还发现这批样本中有6410个左右使用了相似的C&C地址，通过溯源发现这些样本的主体为一款名为XMRig的挖矿病毒。这批样本背后的黑客不仅在该病毒中嵌入了Cobalt
Strike木马(全部为beacon.dll木马，C&C为ns7.softline.top、ns8.softline.top、
ns9.softline.top)以获得更为强大的远程控制的功能，而且还在病毒中加入一些可以自动改变HASH的功能（在自我复制过程中变换复制体的数据），在一定程度上达到了自动变异的效果，这也会导致以HASH作为病毒检测的方法失效。
接下来，我们将对这批C&C进行分析处理，并对其中一些有价值的情报进行挖掘，以进一步的掌握Cobalt Strike在野使用者的现实情况。
## CS攻击方情报分析
在这里我们通过CS回连的C&C数据作为线索，以分析Cobalt
Strike木马攻击来源的分布情况，进一步关联出一些已知APT组织并发现一些新的未知黑客组织。同时我们还对Cobalt
Strike木马使用者所采用的一些特种技术进行分析和评估。
### 3.1 分布概况
首先，我们针对Cobalt Strike的C&C服务器地理位置进行了统计分析，从而评估该框架在全球的分布情况和流行程度。从结果来看，Cobalt
Strike服务器的分布范围非常广泛，包括42个国家和地区，其中分布较为密集的国家为中国、美国、荷兰、俄罗斯和日本，上述国家同样也是黑客组织聚集和遭受网络攻击较多的国家。图2是根据C&C数据绘制的Cobalt
Strike C&C全球分布图。
图2 C&C全球分布图
之后，我们对这批C&C的所属运营商进行了细分。结果表明，大量服务器归属于规模较小或无法识别的运营商(图3中以XX表示)。此类厂商的安全管理工作通常较为松散、混乱，相应的租金也较为低廉，攻击者往往倾向于选择此类厂商架设服务器以降低攻击成本和躲避监管。除此之外，内网IP、阿里云、电信、亚马逊、脸书以及谷歌的C&C服务器数量较多。相关占比分布如图3所示。
图3 C&C所属运营商占比分布图
考虑到Cobalt
Strike支持多种通信协议，我们进一步提取了样本中的端口特征，从而评估在实际攻击中其端口和通信协议的使用情况。结果显示，443(https)、80(http)和8080端口的使用频率较高，这三种常见端口均具有较强的穿透性和隐蔽性，可以有效避开一些防御方案的网络出站规则限制。虽然Cobalt
Strike也支持攻击者自定义配置端口，但在实际攻击中结合通信协议设置端口显然更具迷惑性。其中，443端口结合https协议加密传输的隐蔽性较高；80端口结合http协议，再配合流量伪装技术也具有不错的隐蔽效果。相关通信端口占比分布如图4所示。
图4 通信端口占比分布图
由于样本中存在大量C&C指向内网IP和域名，我们继续对C&C的类型进行了分类整理。973个C&C共涵盖了公网IP、内网IP和域名三类，数量分别为548个、227个和198个，其中公网IP占比超过56%，内网IP和域名数量接近，分别占比23.33%和20.35%。C&C类型占比如图5所示。
图5 C&C类型占比图
针对C&C数据中出现的大量内网IP和域名，我们推测连接内网IP的样本可能存在如下情况：
  1. 攻击者/渗透测试人员在攻陷某内网主机后，通过横向渗透获取了更多内网机器权限，并进一步借助可连接公网的内网主机作为跳板C&C进行流量转发，从而达到其它主机上线的目的。
  2. 攻击者/渗透测试人员在内网环境部署Cobalt Strike服务器并进行免杀功能测试。
对于连接C&C域名的样本，我们在深入分析后发现了更多有价值的线索，也将在下个小节进行详细的介绍。
### 3.2 隐匿技术
随着网络安全审查制度的不断完善，隐匿技术正越来越受到攻击者的重视。在对C&C为域名的样本进行整理分析时，我们发现了大量特殊的域名，例如仿冒的知名网站域名、CDN域名、DNS服务器NS记录地址、甚至是合法网站的白域名等等，这也引起了我们的疑问，是否攻击者在利用白域名进行免杀测试，或是采用了一些更高级的隐匿技术？
经过筛选发现，C&C为域名的样本中16%的样本存在C&C冗余机制（包含多个备用C&C域名），这种机制也给攻击者提供了更加多样和可靠的连接选择，我们将这些备用C&C也列入了统计，去重整理后共计247个域名。经过VirusTotal扫描分析，超过61%的域名并未报毒。在进一步分析后，我们发现攻击者运用了多种C&C隐藏技术和通信隐匿技术来对抗监管审查和流量分析，从而确保更稳定的权限维持，相关技术说明如表1所示。
隐匿技术 | 技术说明  
---|---  
域名仿造技术 | 通过仿造合法域名干扰普通用户或日志分析人员  
CDN技术 | 借助CDN服务进行流量中转，隐藏真实C&C地址  
域前置+CDN技术 | 借助合法域名作为前置域，结合CDN隐藏真实C&C地址  
DNS隧道技术 | 将恶意流量隐藏在DNS协议中对抗流量检测  
流量伪装技术 | 借助Malleable-C2-Profiles配置文件自定义通信流量规则对抗流量检测  
表1 隐匿技术说明
我们进一步统计了这批域名样本中各类隐匿技术的使用占比情况，其中，部分样本融合了多项技术，例如同时运用域名仿造和DNS隧道技术(归类至DNS隧道)、同时使用域名仿造和流量伪装技术(归类至流量伪装)等，由于此类样本数量较少，对分析结果的影响有限，故进行了调整处理，得到隐匿技术占比图。
图6 隐匿技术占比图
由图6可知，超过72%的攻击者尝试通过隐匿技术来增强自身隐蔽性。其中，约37%的攻击者采用通信隐匿技术（流量伪装、DNS隧道）来躲避流量检测，且往往会结合域名仿造进一步增强伪装性。约15%的攻击者采用C&C隐藏技术（CDN技术、域前置+CDN技术）来逃避审查和溯源分析，相关技术将结合样本中的示例进行介绍。
#### 3.2.1 域名仿造技术
通过仿造合法域名干扰普通用户或日志分析人员。攻击者通常采用插入“-”连字符、替换形近字符、颠倒词语顺序、更改顶级域名等方式仿冒合法域名，从而将域名伪装成知名公司、软件、更新服务等网站域名进一步开展恶意活动，包括Baidu、Chrome、Windows、Office等都是常常被选择的伪造目标。由于此类伪装方式具有很强的迷惑性和隐蔽性，会对普通用户或日志分析人员产生较大干扰，且技术门槛和成本较低，俨然成为许多攻击组织的标准配置。一些仿造示例如表2所示。
**C &C** | **仿造目标** | **备注** |  
---|---|---|---  
baidu-search.net | Baidu | 仿造知名公司或软件域名 |  
dns-chrome.com | Chrome |  |  
ns1.fackbook.gq,ns2.fackbook.gq,ns3.fackbook.gq | Fackbook |  |  
update.server.evevnote.com,server.evevnote.com | Evernote |  |  
windows-system.host | Windows | 仿造系统或更新服务域名 |  
windwosupdate-beijing2019.com-system2019-micortsoftewindowschina2019.com.glxqn.cn | Windowsupdate |  |  
upgrade-services.com | Upgrade |  |  
fedex.global | Fedex | 仿造商业公司或社会机构域名 |  
update.safebuikers.com | Safebulkers |  |  
thimunsingapore.org | singapore.thimun.org |  |  
officewps.net | office、wps | 攻击组织 | APT32  
helpdesk-oracle.com | Oracle | Cobalt Group |  
mcafee-analyzer.com | Mcafee | CopyKittens |  