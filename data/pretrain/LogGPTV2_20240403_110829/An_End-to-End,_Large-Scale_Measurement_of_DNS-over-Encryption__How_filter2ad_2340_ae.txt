ing, a possible performance improvement when using DNS-over-
Encryption has also been reported by other tests, like Mozilla’s test
on DoH [62]. Their hypothesis include that DoH has better service
consistency, and uses modern features of HTTP such as loss recov-
ery and congestion control for better operation. We presume that it
also could be caused by anycast or different routes that the queries
are taking, and that resolvers in different regions have different
latency to nameservers [59].
5 USAGE: DNS-OVER-ENCRYPTION TRAFFIC
For the DNS community, it’s crucial to understand how DNS-over-
Encryption is positioned in the contemporary DNS ecosystem, in-
cluding the trend and characteristics of its real-world traffic. On
this basis, the DNS community can better push forward the future
deployment and usage of DNS-over-Encryption. In this section, we
investigate its current usage using several large-scale passive traffic
datasets.
5.1 Methodology
Observing DoT traffic. DoT by default uses port 853, therefore
can be distinguished from other traffic. As such, we use a 18-month
NetFlow [1] dataset (Jul 2017 to Jan 2019) collected by the backbone
routers of a large Chinese ISP. NetFlow-enabled routers aggregate
Figure 10: Query time of DNS and DoH (left), DoT (right) on
individual proxy clients.
report. According to the response, they are now considering loosen-
ing the timeout. In the end, we suggest that DNS-over-Encryption
servers be carefully designed and implemented, and eliminate con-
figuration issues.
4.3 Performance of Encrypted Queries
Key observation 3: When connection is reused, encrypting DNS
transactions introduces a tolerable overhead on query latency
for global clients, and can perform well as clear-text DNS.
Finding 3.1: On average, query latency of encrypted DNS with
reused connection is several milliseconds longer than tradi-
tional lookups. Connection reuse is required by the standard doc-
uments whenever possible. Our discussion in Section 4.1 also shows
that connection reuse can be frequent for DNS-over-Encryption in
practice. As shown in Figure 9, when connection is reused, encrypt-
ing DNS transactions brings a tolerable performance overhead on
query time. Comparing the query latency of Cloudflare’s clear-text
DNS, DoT and DoH, we are getting average/median performance
overhead of 5ms/9ms (for DoT) and 8ms/6ms (for DoH) from our
global clients. If we look at individual clients, Figure 10 shows their
query performance of clear-text DNS and DNS-over-Encryption.
The majority of clients distribute near the y=x line, suggesting they
do not suffer from significant performance downgrade.
By contrast, with each query establishing a complete new TCP
and TLS session (i.e., not reusing connections), we find that the
performance overhead can be large, especially when resolvers are
far from the clients. Table 7 shows the test results comparing query
latency of our self-built DNS resolver: the performance overhead
without connection reuse can be up to hundreds of milliseconds.
An End-to-End, Large-Scale Measurement of DNS-over-Encryption: How Far Have We Come?
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
sequential packets in a flow (i.e., packets with the same transfer
protocol, IP addresses and ports) and create a record containing its
statistics. Each NetFlow record include IP addresses, ports, total
bytes of packets, and the union of TCP flags. When collecting
NetFlow, our provider ISP uses a sampling rate 1/3,000, and expires
a flow if idle for 15 seconds.
To begin our analysis, we first select all NetFlow records over
TCP port 853, and exclude all flows which only contain a single SYN
flag5. We then check if the traffic is DoT by matching the destination
address with the DoT resolver list we create in Section 3. If a flow
is sent by a client to TCP port 853 of a DoT resolver, we consider it
as DoT traffic. For ethical considerations, we only keep the /24 of
each client IP address before further processing and analysis.
Observing DoH traffic. DoH queries are mixed with HTTPS traf-
fic, thus it’s infeasible to observe them from traffic datasets such
as NetFlow. However, the URI template of a DoH service con-
tains a domain that should be resolved before DoH lookups (e.g.,
dns.example.com, see Section 2). This inspires us to evaluate DoH
usage, by checking the query volumes of resolver domain names in
passive DNS datasets.
DNSDB [22] and 360 PassiveDNS [16] are two large passive DNS
datasets maintained by Farsight Security and Qihoo 360, respec-
tively. They both contain aggregated statistics of a given domain, in-
cluding timestamps of its first and last query, and number of histori-
cal lookups. While DNSDB has a wider coverage of resolvers across
the globe, 360 PassiveDNS provides us with more fine-grained statis-
tics such as daily query volume per domain. Therefore, we leverage
DNSDB to study the scale of lookups for DoH domains, and use
360 PassiveDNS to investigate their query trends over time.
Limitations. While large, our passive datasets inevitably contain
geographical bias. Admittedly, traffic collected directly by DNS-
over-Encryption resolvers allows us to perform more fine-grained
and systematic analysis, yet we currently do not have access to such
dataset. Second, due to DNS cache, we may underestimate the query
volume of DoH domains from passive DNS datasets. However, it
still provides us with an opportunity to evaluate the current trend
of DoH usage.
5.2 DoT Traffic
Key observation 4: Although still at a small scale compared to
traditional DNS, real-world traffic to DNS-over-Encryption ser-
vices is observed, and reflects a growing usage in recent months.
Finding 4.1: DoT traffic to large public resolvers is still at a
small scale, mostly coming from both centralized clients and
temporary users. From our NetFlow dataset, we only spot traffic
to large public DoT resolvers (e.g., Cloudflare and Quad9), yet its
amount is still small compared to traditional DNS. Particularly, the
traffic does not originate from automated scanners.
Figure 11 depicts the monthly count of bidirectional flows to
Cloudflare and Quad9 DNS. We find that the amount of DoT traffic
is still small: about 2-3 orders of magnitude less than traditional
DNS, under the same sampling rate. We also notice an increase of
traffic to Cloudflare DoT: it grows by 56% from Jul 2018 (4,674 flows
5The TCP flags field unions all flags observed in a NetFlow. A single SYN flag indicates
an incomplete TCP handshake and cannot contain DoT queries.
Figure 11: Traffic to Cloudflare and Quad9 DNS
Figure 12: DoT traffic to Cloudflare DNS per /24 network.
The size indicates the proportion of DoT traffic, and the color
shows the active time of each network.
recorded) to Dec 18 (7,318 flows recorded), while traffic to Quad9
DoT fluctuates.
Zooming into client distribution, we find several networks ac-
count for a great proportion of DoT traffic. Among all 5,623 /24
netblocks which send DoT traffic to Cloudflare resolver, the top five
netblocks account for 44% of all DoT traffic, and the top 20 account
6. As shown in Figure 12, the active time (i.e., count of days
for 60%
when we observe DoT traffic from this network) of giant client
networks tends to be several weeks or months long. On the other
hand, we also notice a number of temporary users: 5,416 (96%) net-
blocks are only active for less than one week, producing 25% of all
DoT traffic we observe.
Moreover, in order to verify whether the DoT traffic we observe
comes from automated scanners, we submit all client networks to
NetworkScan Mon [20] and check their behaviors. Developed and
maintained by 360 Netlab, it runs on various data inputs including
NetFlow, darknet and honeypot, and detects scan behaviors based
on real-time traffic statistics and state transition model. The system
has been effective in quickly reporting attacks including Mirai, IoT
Reaper and Hajime botnet [65]. In the end, we do not get any alert
on port-853 scanning activities related to the client networks. As a
complement, we also check the SOA and PTR records of the client
addresses, and do not find them potentially related to scanning
experiments. Therefore, we regard the DoT traffic we observe from
our NetFlow dataset is not generated by automated scanners.
69 of the 10 top networks belong to ISPs, and the remaining one is owed by a cloud
platform. We speculate the reasons for their large ratio include: 1) DoT is less popular
in other networks, 2) the observed addresses under the two netblocks are associated
with proxy or NAT.
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
Chaoyi Lu et al.
eavesdropping and manipulation. Previous studies have shown
that DNS queries and logs can be used to accurately fingerprint
client machines and even identify users [32, 48, 54, 55, 72]. On-path
attackers can therefore build a profile for each client and track them
across the Internet from DNS queries [52].
Because DNS lacks authentication, adversaries can arbitrarily
manipulate unprotected DNS traffic. Transparent proxies can spoof
the IP addresses of user-specified resolvers and surreptitiously inter-
cept DNS queries [60]. Moreover, adversaries can build rogue DNS
servers and return malicious responses to launch an attack [35, 57],
or redirect traffic of non-existent domains for illegal monetiza-
tion [78]. Attackers can also build fake DNS root servers to hijack
all DNS root traffic [26]. Their motivations include malware dis-
tribution, censorship, ad injection [57] and performance improve-
ment [26].
Improving DNS Privacy. The DNS community have been dis-
cussing DNS privacy threats [29]. To add confidentiality to tradi-
tional DNS, DNS-over-TLS [49] and DNS-over-HTTPS [50] have
been standardized, which offer both encryption and authentication.
Besides adding confidentiality, there are also techniques to eliminate
privacy data in DNS packets, such as QNAME minimization [30].
Currently, significant efforts have been devoted by the DNS com-
munity to pushing forward the deployment of DNS-over-Encryption.
Before the standards, [79] presents a performance evaluation of
encrypted DNS (T-DNS), which concludes that it only introduces a
modest cost with careful implementation. To study side-channel
problems of DoH, [71] performs traffic analysis to distinguish web-
pages from encrypted DNS traffic. Cloudflare, as a DNS service
provider, measures and tries to fix the global reachability to its
public resolvers [74]. Meanwhile, the DNSPrivacy Project [37] has
gathered latest updates of DNS-over-Encryption, and performed
studies on their implementations.
Compared to previous researches, our work presents the first
systematic and large-scale research on the evolution of DNS-over-
Encryption techniques, serving as a complement to understanding
the DNS ecosystem.
8 CONCLUSION
To solve DNS privacy concerns, various protocols are proposed to
encrypt and secure DNS transactions. In this paper, we perform the
first systematic and large-scale measurement study on the ecosys-
tem of DNS-over-Encryption. Our study shows that two recent
standardized protocols, DoT and DoH, are with promising global
reachability, minor performance overhead and growing usage. We
also provide recommendations for the DNS community to push
forward the future deployment of DNS-over-Encryption, and re-
lease our collected datasets. Our findings highlight the need for
service providers to re-evaluate their implementations, and encour-
age more Internet users to use DNS-over-Encryption and secure
their DNS queries.
ACKNOWLEDGMENTS
We sincerely thank our shepherd Prof. kc claffy, and all anonymous
reviewers for their valuable reviews and comments to improve the
paper. We also thank Genshen Ye, Haosheng Han, Yuanhao Chen,
Figure 13: Query volume of popular DoH domains
5.3 DoH Traffic
Finding 4.2: Large providers dominate in all DoH services,
and their usage is growing. According to DNSDB, among the
17 public DoH resolvers we discover (15 in [73] and 2 beyond,
see Section 3) 7, only 4 domains have more than 10K queries. As
the rest resolvers do not witness much traffic, we focus on the
query trend of the 4 popular DoH resolvers (i.e., Cloudflare, Google,
CleanBrowsing and crypto.sx).
Figure 13 shows the monthly query volume of the 4 popular
DoH domains, according to 360 PassiveDNS. Google DoH, as the
most popular DoH resolver with the longest history (since 2016),
receives several orders of magnitude more queries than other do-
main names. Cloudflare’s DoH also receives much traffic, owing to
the support of DoH on Firefox, and the recent DoH test on Firefox
Nightly [62]. The query volumes of the DoH resolvers have all wit-
ness a growth. For instance, the query volume of CleanBrowsing
DoH has increased by nearly 10 times from Sept 2018 (200 queries
recorded) to Mar 2019 (1,915 queries recorded).
6 DISCUSSION
Recommendations. We believe to push forward the development
and deployment of DNS-over-Encryption, efforts from all parties
in the Internet ecosystem are required. For protocol designers, it is
important to reuse well-developed protocols to encrypt DNS mes-
sages, for new protocols to be widely supported and implemented.
For DNS service providers, as we find less-known resolvers, in-
valid SSL certificates and configuration issues, we suggest that they
promote their services, correct misconfigurations, and keep their
services under careful and regular maintenance. Meanwhile, we
recommend them to use resolver addresses with a clean history. For
DNS clients, as we find the usability of public DNS-over-Encryption
servers is promising, we believe education is necessary to let them
understand the benefits of encrypting their DNS queries.
Dataset and code release. We release our source code and col-
lected datasets at https://dnsencryption.info. We believe our
dataset release is helpful for further studies.
7 RELATED WORK
DNS Privacy Threats. The lack of encryption and authentication
in DNS is widely seen as one of the Internet’s biggest unpatched
bugs. Unencrypted DNS queries are vulnerable to attacks including
7For Cloudflare, we use mozilla.cloudflare-dns.com instead of the more popular
cloudflare-dns.com, because the second domain is not exclusively used for DoH
service. We also exclude dns.quad9.net, because it’s not for DoH until Oct 2018, and
most of its queries are recorded before this date.
An End-to-End, Large-Scale Measurement of DNS-over-Encryption: How Far Have We Come?
IMC ’19, October 21–23, 2019, Amsterdam, Netherlands
Table 8: Current implementations of DNS-over-Encryption
(last updated on May 1, 2019).
DoE
Others
DoT DoH DC DNSSEC QM
✓
✓
✓
✓
✓
✓
✓
✓
✓
✓
Yang Xu, Jinjin Liang, Fengpei Li, Yiming Zhang and Vern Paxson
for their help on the paper.
This work is supported by National Key R&D Program of China
(No. 2017YFB0803202, No. 2018YFB1800405), NSFC Program (grants
U1836213, U1636204, 61772307) and BNR2019TD01004.
APPENDIX
A CURRENT IMPLEMENTATIONS OF
DNS-OVER-ENCRYPTION PROTOCOLS
We provide an extensive survey on current implementations of DNS-
over-Encryption protocols in Table 8. DNS-over-DTLS and DNS-
over-QUIC are not included, as we do not find implementations
yet.
Compared to DNSSEC (a widely-deployed security extension
standardized in 2005) and QNAME Minimization (also used to im-
prove DNS privacy, standardized in 2016), we find DoT (standard-
ized in 2016) and DoH (standardized in 2018) is getting quickly
supported by large DNS service providers and software vendors.
REFERENCES
[1] [n. d.]. Cisco IOS NetFlow. https://www.cisco.com/c/en/us/products/ios-nx-os-
software/ios-netflow/index.html.
[2] [n. d.]. Cloudflare Resolver. https://cloudflare-dns.com/.
[3] [n. d.]. DNSCrypt-proxy 2. https://github.com/jedisct1/dnscrypt-proxy.
[4] [n. d.]. Google Public DNS. https://developers.google.com/speed/public-dns/.
[5] [n. d.]. HTTP and SOCKS PROXIES. https://www.proxyrack.com/.
[6] [n. d.]. Knot DNS. https://www.knot-dns.cz/.
[7] [n. d.]. Latest 1.1.1.1 Topics - Cloudflare Community. https://community.cloudf
lare.com/c/reliability/1111.
[8] [n. d.]. Let’s Encrypt - Free SSL/TLS Certificates. https://letsencrypt.org.
[9] [n. d.]. OpenNIC Project. https://www.opennic.org/.
[10] [n. d.]. Zhima Proxy. http://h.zhimaruanjian.com/.
[11] 2013. DNSCrypt version 2 protocol specification. https://dnscrypt.info/protocol.
[12] 2014. The NSA and GCHQ’s QUANTUMTHEORY Hacking Tactics. https://theint
ercept.com/document/2014/03/12/nsa-gchqs-quantumtheory-hacking-tactics/.
[13] 2018. OpenSSL Cryptography and SSL/TLS toolkit. https://www.openssl.org/.