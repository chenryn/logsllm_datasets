User: My goal is to be able to start shell script in separate process and inspect it by linux ptrace syscall.
The problem is that I need to get process PID before it even starts. Stuff like subprocess.Popen(['ls', '-l']) or python-sh runs command immediately, so in a time I am trying to inspect this process by its PID it is likely finished.
On the other hand I cant use os.fork + exec because bash command I start overrides python code.
Assistant: Just fork and before exec of the shell you call ptrace() with PTRACE_TRACEME so the exec doesn't start immediately, giving the parent all the time it needs to prepare before it tells the child to continue (PTRACE_CONT, PTRACE_SYSCALL, or PTRACE_SINGLESTEP).
When using subprocess.Popen() you may use the preexec_fn argument mentioned by @RuiSilva to do the PTRACE_TRACEME call.