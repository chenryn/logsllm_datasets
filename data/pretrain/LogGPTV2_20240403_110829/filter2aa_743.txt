DEFCON16 
Virtually Hacking
08 August 2008
2
Why VMware?
•
Virtualisation has taken off and is here to stay
•
Many of our clients are using virtualisation technologies
•
Virtualisation services are being sold
•
VMware is the dominant product*
•
Need to be familiar with a product in order to hack it
*source ­ silicon.com
3
Structure
•
VMware 
Different flavours
Key concepts
•
Hacking VMware Server + Demo
•
Hacking VMware ESX + Demo
•
dradis – putting it all together
•
Recommendations
Am I going to get owned?
4
Structure
•
VMware 
Different flavours
Key concepts
•
Hacking VMware Server + Demo
•
Hacking VMware ESX + Demo
•
dradis – putting it all together
•
Recommendations
Am I going to get owned?
5
Different Flavours
•
Player
•
Workstation
•
Server (GSX)
•
ESX
6
Different Flavours
•
Player
•
Workstation
•
Server (GSX)
•
ESX
7
Key concepts
Server
Guest OS
•
One server can run multiple operating systems
8
Key concepts
Hardware
OS
VMware Server
Virtual Machines
Apps
OS
Apps
OS
Apps
OS
VMware Server
9
Key concepts
Hardware
VMware ESX
Virtual Machines
Apps
OS
Apps
OS
Apps
OS
VMware ESX
10
Key concepts
•
Primary configuration file (.vmx)
•
Virtual disk file – the virtual machines hard drive (.vmdk)
•
Virtual machines snapshot (.vmsn)
•
Virtual machines page file (.vmem)
Overview of the main files which make up a virtual machine
11
Key concepts
•
Virtual machine disk file can be mounted
•
Files can therefore easily be read from the disk
•
Demo...
12
Structure
•
VMware 
Different flavours
Key concepts
•
Hacking VMware Server + Demo
•
Hacking VMware ESX + Demo
•
dradis – putting it all together
•
Recommendations
Am I going to get owned?
13
VMware:Server
14
VMware:Server
Interesting ports on 192.168.1.53:
Not shown: 1707 closed ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
80/tcp  open  http
111/tcp open  rpcbind
113/tcp open  auth
389/tcp open  ldap
902/tcp open  iss­realsecure­sensor
vmware­authd
15
VMware:Server
16
VMware:Server ­ Tools
•
List VM's
•
Get state
•
Start/Stop
•
Get config
•
Get remote connections
•
Set guest info
vmware­cmd.pl
17
VMware:Server ­ Tools
•
List VM's
•
Power On/Off
•
Login Guest
•
Copy file from host to guest / guest to host
•
Run program in guest
•
Run script in guest
VMware VIX API
18
VMware:Server ­ Tools
VMware VIX API
1: require 'ruby_vix'
2: Vix.RunProgramInGuest('10.0.0.9',902,s_username,s_password,vmusername,
   vmpassword,'/var/vms/windows.vmx','net user vmuser vmuser /ADD',"")
•
Ruby bindings
•
Easily scriptable
•
Equivalent to 130 lines of C
19
VMware:Server ­ Demo
•
Obtain credentials
•
Extract information
•
Own the box
20
Structure
•
VMware 
Different flavours
Key concepts
•
Hacking VMware Server + Demo
•
Hacking VMware ESX + Demo
•
dradis – putting it all together
•
Recommendations
Am I going to get owned?
21
VMware:ESX
22
VMware:ESX
23
VMware:ESX
Interesting ports on 192.168.1.58:
Not shown: 65528 filtered ports
PORT     STATE  SERVICE
22/tcp   open   ssh
80/tcp   open   http
427/tcp  closed svrloc
443/tcp  open   https
902/tcp  open   iss­realsecure
903/tcp  open   iss­console­mgr
5988/tcp open   unknown
5989/tcp open   unknown
24
VMware:ESX
• Provides a web service (SOAP) interface
• https://vmware­esx/sdk
• Web server
• https://vmware­esx/ui
• https://vmware­esx/mob
• Vmware authd still available on port 902
• Vmware­serverd not present
• COS (Console Operating System) via SSH
• Red Hat derived
25
Vmware:ESX ­ Tools
• Example operations include:
• RebootGuest
• RebootHost_Task
• ScanHostPatch_Task
• CreateUser
• RemoveVirtualSwitch
VI API
26
Vmware:ESX ­ Demo
•
Perform checks unauthenticated
•
Exploit weaknesses
27
Structure
•
VMware 
Different flavours
Key concepts
•
Hacking VMware Server + Demo
•
Hacking VMware ESX + Demo
•
dradis – putting it all together
•
Recommendations
Am I going to get owned?
28
dradis – A Quick Intro
•
Tool for structuring information
•
Client/Server architecture
•
Ruby based
•
Extensible
Add modules
 Put together a methodology
•
Intercept actions/results to perform conditional operations
http://dradis.sourceforge.net
29
dradis – A Quick Intro
30
dradis
•
Provide it with a description of the environment
•
It can then provide checks or operations based on this
•
e.g.
Host is ESX 
­> 
Determine version
Version is 3.5 
­> 
Determine services
SSH is enabled 
­> 
Check for weak accounts
etc... 
31
dradis
•
Lets see it in action
•
Demo
32
Structure
•
VMware 
Different flavours
Key concepts
•
Hacking VMware Server + Demo
•
Hacking VMware ESX + Demo
•
dradis – putting it all together
•
Recommendations
Am I going to get owned?
33
Am I Going to Get Owned?
•
Have you followed VMware's security guidance? 
•
Have you applied updates?
34
Am I Going to Get Owned?
•
VMware will always be a single point of failure
•
Recommendation is to keep management networks 
separate from your core networks and guest networks
•
There is nothing stopping you from hardening the 
installation beyond the default
Don't forget things like CIScan for example
Do you use all of the services running?
35
Am I Going to Get Owned?
•
Harden the virtual network
Disable promiscuous mode
Reject MAC address changes
Reject traffic with a forged IP address
•
Disable copy and paste between guest and host
•
Can guest OS read the CD drive on the host OS?
•
Am I logging enough / too much?
36
Future work
•
Still plenty to play with
•
Still lots of VMware technologies to cover
37
END
•
Have a play with the tools
•
Let me know what you think
•
Let me know any new features you would like to see
•
Tools available from:
http://www.tinternet.org.uk
http://www.mwrinfosecurity.com
•
dradis is available from:
http://dradis.sourceforge.net
38
END
•
Questions?