# 三、技术分析

## 下载和执行功能
当用户使用Office软件打开恶意的.xls或.doc文档时，嵌入其中的恶意宏会自动连接到远程服务器并下载名为Oceansalt的恶意软件。随后，该恶意宏会在受感染终端上执行Oceansalt。

### 恶意.xls下载器的入侵指标（IoC）

| IoC描述 | IoC值 |
| --- | --- |
| 远程下载服务器 | [redacted].kr<br>[redacted].kr |
| 远程服务器上的Oceansalt路径 | /admin/data/member/1/log[.]php<br>/gbbs/bbs/admin/log[.]php |
| 受感染终端上的Oceansalt路径 | %temp%SynTPHelper[.]exe<br>%temp%LMworker[.]exe |

**图13**：用于下载恶意软件的部分恶意宏代码

## 控制服务器
此次恶意活动利用了多个控制服务器，在2018年6月至7月期间，我们观察到了以下恶意IP地址：
- 172.81.132.62
- 211.104.160.196
- 27.102.112.179
- 158.69.131.78

根据我们的遥测数据，这些服务器涉及多个国家的攻击事件。例如，IP地址211.104.160.196与哥斯达黎加、美国及菲律宾的感染有关；而IP地址158.69.131.78则关联到了美国和加拿大的案例。从2018年8月18日至21日间，这些服务器在全球范围内活跃，并且被用来分发不同的恶意软件样本，这表明它们可能隶属于一个更广泛的隐蔽监听网络。McAfee高级威胁研究小组之前也遇到过类似的攻击模式，部分目标被用作中继控制服务器。

# 四、恶意软件溯源

通过对早期样本的研究，我们注意到一个编译于2010年的变体 - bf4f5b4ff7ed9c7275496c07f9836028，其与Oceansalt有高达21%的整体代码相似度。这部分共享代码是独一无二的，不归属于任何公共库或开源项目，主要用于实现侦察和控制功能。

进一步调查发现，这个变体使用了属于APT1组织的域名，且与Seasalt（另一个已知的APT1恶意软件）在代码上有99%的相似性。Seasalt (5e0df5b28a349d46ac8cc7d9e5e61a96) 被认为是APT1在2010年使用的工具之一。因此，可以推测Oceansalt基于Seasalt的部分代码构建了一个新的恶意软件版本。然而，根据技术水平分析，Oceansalt不太可能是APT1的直接延续，那么问题来了：攻击者是如何获取到Seasalt源码的呢？至今为止，没有证据显示Seasalt的源代码曾在地下论坛出售或泄露。

此外，我们还发现了几个编译日期介于2018年7月16日至17日之间的Oceansalt样本，尽管经过了一定程度的混淆处理，但本质上仍然是同一程序的不同实例，仅在控制服务器等少数配置上有所区别。值得注意的是，某些样本缺少反弹shell功能，这说明攻击者不仅能够访问Seasalt的源代码，还能对其进行修改和重新编译，从而产生不同的变种。这种现象可能暗示着这是一个由两个国家支持的黑客团队合作发起的攻击行动。

### Oceansalt与Seasalt代码的相似之处

#### 命令处理程序和索引表
Oceansalt与Seasalt的命令处理器通过类似语义和指令编码实现了相同的功能，甚至解析机制也非常接近。
- **图16**：Seasalt（左）与Oceansalt（右）命令处理器对比
- **图17**：Seasalt（左）与Oceansalt（右）指令索引表对比

#### 功能实现
两者在许多方面表现出高度一致性，如驱动器探测、文件检索以及反弹shell创建等功能，均采用了相同的API调用方式及响应代码格式。
- **图18**：驱动器探测功能对比
- **图19**：文件检索功能对比
- **图20**：反弹shell创建过程对比

### Oceansalt与Seasalt代码的区别

尽管存在大量共通点，但Oceansalt还是对Seasalt进行了若干改进，比如引入了数据加密传输机制以增强安全性，同时改变了控制服务器地址的存储形式等。
- 编码机制差异：Oceansalt在向服务器发送数据前会先进行编码操作，而Seasalt则是直接传送未加密内容。
- 控制服务器地址不同：Oceansalt将控制服务器信息硬编码进程序内部，相比之下Seasalt需要从二进制文件末尾读取并解密得到相关信息。
- 持久化策略差异：Oceansalt缺乏持久化机制，无法保证重启后继续感染；相反，Seasalt可通过注册表项确保自身长期存活。

### Oceansalt与Seasalt的混淆技术对比

针对Oceansalt初始样本及其部分混淆版本与Seasalt样本进行了深入分析，总结出如下特征：
- 所有部分混淆的Oceansalt样本均包含调试日志记录功能，并指向同一个固定路径下的临时文件；
- 部分样本省略了反弹shell功能，但仍保留了其他核心组件；
- 开发过程中添加了跟踪代码流的调试字符串，表明攻击者在正式部署前进行了详尽测试。

### 代码共享的证据

综合以上分析结果，我们可以得出结论：Oceansalt确实是在获得Seasalt源码基础上开发的新一代恶意软件，而非简单地替换原有配置参数而来。