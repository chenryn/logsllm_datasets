Mail Client Fingerprinting
Mail clients are often underestimated as a potential attack vector. Unfortu-
nately, identifying a target’s mail client poses some challenges. In the corporate
world, Message Delivery Notiﬁcations (MDNs) can be used to obtain a reply
message that contains the name and version of the mail client in use. When
MDNs are not available, the auditor must rely on abusing ambiguities within
the MIME standard to show diﬀerent content to each mail client. The message
below contains the important headers from a MDN sent by an Outlook Express
client:
MIME-Version: 1.0
Content-Type: multipart/report;
report-type=disposition-notification;
boundary="----=_NextPart_000_0002_01C7BA3D.0DA9ED40"
X-Mailer: Microsoft Outlook Express 6.00.2900.2869
X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2900.2962
12
3.6
Process Discovery
Automated business processes can often create windows of opportunity for an
attacker.
Many ﬁnancial organizations use insecure ﬁle transfer methods to
share information, but since the attack window is only open for a few minutes
at a time, the perceived risk is low. For example, the FTP protocol is still in
wide use at banking organizations, and even if the ﬁles are encrypted, the control
channel is not. The diﬃculty in auditing a business process is determining when
and how it is performed.
3.6.1
Traﬃc Monitoring with IP IDs
One of the great features of the IPv4 protocol is how the IP ID ﬁeld is im-
plemented. Many operating systems will increment this ﬁeld by one for every
packet sent by the host. This allows an auditor to determine how many packets
have been sent within a given window of time and allows for interesting attacks
such as blind port scanning[9]. The auditor can track traﬃc patterns over a
long period of time by probing the target at regular intervals and recording
the change in the received IP ID value. This type of monitoring can discover
business processes such as ﬁle transfers, backup operations, and other bursts of
activity caused by automated systems.
3.6.2
Usage Monitoring with MS FTP
The Microsoft FTP service allows anonymous users to execute the ”SITE STATS”
command. This command returns a count for each unique command executed
on the server since the service was started. An auditor can access the server
and poll these stats over a long period of time to build up a timeline of when
certain operations are performed. For example, the STOR command stat is
incremented when a ﬁle is uploaded, so watching for a jump in this stat can
give provide the time that an automated upload is performed. The following
output from Microsoft’s public FTP server demonstates that out of over two
billion login attempts, only 3035 STOR commands were issued.
SITE STATS
200-ABOR : 2138
ACCT : 2
ALLO : 32
APPE : 74
CDUP : 5664
CWD
: 388634
DELE : 1910
FEAT : 2970
13
HELP : 470
LIST : 3228866
MDTM : 49070
MKD
: 870
MODE : 3938
NLST : 1492
NOOP : 147379
OPTS : 21756
PASS : 2050555100
PASV : 2674909
PORT : 786581
PWD
: 179852
QUIT : 143771
REIN : 16
REST : 31684
RETR : 153140
RMD
: 41
RNFR : 58
RNTO : 2
SITE : 20485
SIZE : 76980
SMNT : 16
STAT : 30812
STOR : 3035
STRU : 3299
SYST : 175579
TYPE : 3038879
USER : 2050654280
XCWD : 67
XMKD : 12
XPWD : 1401
XRMD : 2
3.6.3
Web Site Monitoring with HTTP
The HTTP 1.1 protocol supports a ”Last-Modiﬁed” attribute. When a compli-
ant HTTP server (such as Apache) receives a request for static content, it will
automatically return the date at which the resource was last modiﬁed. This
feature can be used to expose automated update times for corporate web sites.
14
Chapter 4
Information Exploitation
4.1
Introduction
The last chapter focused on information discovery techniques.
This chapter
builds on these techniques by abusing documented features to compromise target
systems.
4.2
External Networks
The external network is the starting place for most penetration tests. External
hosts are often locked down, patched, ﬁrewalled, and ﬁltered. The only targets
available are intentionally exposed applications, VPN services, and temporary
paths for client-initiated UDP sessions.
4.2.1
Attacking File Transfers
File transfers ﬂowing between internal and external hosts can be subject to
attack, depending on the protocol and the ﬁrewall involved.
Attacking FTP Transfers
The FTP protocol uses epheremal ports for data transfers, exposing an open
data port on either the client or the server to a race condition. Depending on
the FTP software, it may be possible to connect to the data port and receive
the contents of a downloaded ﬁle or be able to write the contents of an uploaded
15
ﬁle. The pasvagg.pl[13] script can be used to hijack FTP transfers when the
server allows anonymous access, data ports are allocated sequentially, and the
FTP server allows connections to the data ports from IP addresses other than
the initiating client. Any FTP server that supports ”FXP” mode is vulnerable
to this attack.
Attacking NFS Transfers
The NFS protocol involves a number of independent RPC services, each of which
is subject to interference when used over a NAT gateway. The NFS services will
accept a response from any source IP and port that contains valid data, even if
that host has no relation to the address that was speciﬁed in the NFS connection
parameters. The reason for this is to support multi-homed NFS servers, where
RPC responses ﬂow back from a diﬀerent IP then the address that the client
connected to.
To accomodate NFS traﬃc over NAT, older versions of the Linux kernel and
many modern NAT devices will allow UDP responses to be sent back to the
client from other IP addresses. In eﬀect, this exposes the client RPC services to
the Internet when the client establishes a connection from behind a NAT device.
The challenge from an auditor’s viewpoint is ﬁnding the epheremal port used
to relay the connection and then identifying what RPC service it belongs to.
4.2.2
Attacking Mail Services
A typical mail system is composed of one or more relay systems, some form
of antivirus/spam ﬁlter, the real mail server itself, and ﬁnally the user’s email
client.
In most penetration tests, the focus is on the intermediate systems,
however the mail clients themselves can be targeted. For example, on Mac OS
X, if two email messages are received that contain the same attachment name,
the newer message can overwrite the previous message’s attachment if enough
ﬁelds match. This can be used to replace a trusted attachment with a backdoor
within the users mailbox.
4.2.3
Attacking Web Servers
Even though web servers are the most visible targets on an external network,
many penetration testers overlook obvious vulnerabilities.
A brute force of
common ﬁle and directory names can expose administrative areas, backup ﬁles,
archives of the entire site, and much more.
Sending internal host names in
the HTTP Host header can provide access to internal sites and employee-only
areas. Nearly all web servers have applications installed these days and any
unrecognized application should be acquired from the vendor and audited for
16
ﬂaws. Finally, some load balancers have trouble with long-lived HTTP sessions
and can leak data from other users given the right load,
4.2.4
Attacking DNS Servers
Over the last ten years, most DNS servers have been conﬁgured to reject zone
transfers from unauthorized hosts. Instead of pulling the entire zone, the auditor
must brute force possible domains and host names to determine whether those
entries exist. Many DNS servers are misconﬁgured to allow reverse DNS lookups
of private addresses, exposing the names and addresses of important servers on
the internal network. As mentioned in outbound DNS section, many DNS servers
are still vulnerable to transaction ID prediction, or race conditions such as those
created by the Birthday Attack[10]. A successful attack can lead to injection of
false DNS records into the cache and a potential hijack of internal and external
domains, depending on the conﬁguration of the network.
4.2.5
Attacking Database Servers
Although database servers are rarely exposed to the external network, its a good
idea to perform a quick scan for common database services anyways. Many busi-
ness applications (Saleslogix, etc) run in a two-tier mode that requires direct
access to the database server for them to function. Keep in mind that some
database servers, such as Informix, still contain publicly-known, unpatched vul-
nerabilities.
4.2.6
Authentication Relays
One of the most eﬀective attacks on internal users from outside of the net-
work relies on authentication relays. Many organizations expose Microsoft IIS
or Exchange servers to the Internet. These servers allow Windows domain au-
thentication using the NTLM protocol. If the victim’s ﬁrewall has not been
conﬁgured to drop outbound connections on port 139 and 445, it is possible to
send a user an email message, or redirect them to a web page, that will force
their workstation to initiate a SMB connection to a host of your choice. At this
point, the actual impact depends on the version of Windows on the workstation
and in some cases, what web browser or mail reader they use.
On Windows 2000 and earlier systems, the browser will automatically negotiate
NTLM authentication with the remote SMB server, using the current username
and password of the user. If the auditor provides a malicious SMB server that
relays this authentication to an externally accessible IIS or Exchange server,
they can obtain direct access to that user’s account.
On Windows XP and
17
never systems, this technique is not always possible from an external network.
The NTLM credentials used by SMB, HTTP, SMTP, POP3, and IMAP4 are
usually interchangable, provided you have a tool to perform the relay.
An alternative to relaying the authentication credentials is to capture and crack
the password hash itself. A number of tools exist for this purpose, including
the venerable L0phtcrack (no longer available) and Cain and Abel[11].More
information about the capture process can be found in Warlord’s article in the
Uninformed Journal[14].
4.2.7
Free Hardware
Last resort. The audior travels the oﬃce of the target and hands out free USB
keys (autorun, of course) to anyone who will answer a short survey. Alterna-
tively, he can snail-mail CDROMs containingtrojan, wrapped into an autorun
or application installer (goodbye privilege separation on Vista). Possible labels
for the CD include ”Free MP3s”, ”Complimentary License”, and so on. If the
budget is available, the auditor can mail out portable handheld devices, such
as the Nokia Internet Tablet or the Sharp Zaurus, containing a full suite of
Linux-based backdoors.
Alternatively, the auditor can create a custom UPS power brick containing an
embedded PC. The auditor would purchase a 350VA or higher battery backup
that has surge protection for ethernet ports, rip out the battery, splice a power
strip into the main power adapter, insert the guts of a Linksys WRT54L, insert
a four-port Ethernet switch, and prepare to visit the target’s oﬃce. Once in-
side the oﬃce, the auditor can make an excuse to be near the network devices
(printers, fax machines, etc) and install or swap out the rogue UPS. An example
of this modiﬁcation can be found at [12].
4.3
Internal Networks
The term internal network usually refers to the soft, squishy interior of most
corporate networks, but it can also refer to a network provided to a speciﬁc vic-
tim by way of a rogue access point. Once internal network accessed is obtained,
a wide range of new attacks become possible.
4.3.1
NetBIOS Names
The NetBIOS protocol is used by a number of applications to locate important
hosts on the network. Some NetBIOS names are treated as special cases. For
example, the NetBIOS name ”WPAD” will automatically be used as a HTTP
18
proxy server if it resolves. The name ”ISASRV” is a special case for clients
looking for an ISA Server Proxy. Third-party applications have similar pref-
erences. The Computer Associates Licensing Client will look for a local host
called CALICENSE to send authorization requests to.
4.3.2
DNS Servers
DNS servers on the internal network are often conﬁgured to allow unauthen-
ticated updates.
Even when a Microsoft DNS server is conﬁgured to reject
DNS-based update requests, its still possible to inject names into the local DNS
zone by passing these names as the hostname of DHCP client requests (the -h
option for the ISC dhcpcd client). These types of DNS attacks can allow an
internal attack to hijack all access to a critical system, impersonate servers, and
stage new attacks against the aﬀected clients.
4.3.3
WINS Servers
In addition to NetBIOS and DNS, Windows clients also support name lookups
via the WINS protocol. Normally, the DHCP server is responsible for telling
each client what server to send WINS requests to.
However, through DNS