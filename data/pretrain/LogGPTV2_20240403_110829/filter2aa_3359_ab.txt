connect to the video adapter.
Meet CHUCKWAGON:
DDC to I2C converter.
Breadboard friendly.
Logic level converters for
I2C .
Supplies 5V from target
(not on all VGA
connectors).
Power indicator.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
25 / 60
CHUCKWAGON schematic
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
26 / 60
CHUCKWAGON board
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
27 / 60
I2C hack not that new. . .
As seen on Hackaday
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
28 / 60
Add the CHUCKWAGON
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
29 / 60
Connect to GSM module
Ok, so let’s connect to the
GSM Shield from the Beagle!
BBB’s UART4,
broken-out by ATmega’s
program jumpers.
GSM’s shield
software-serial, D7 and
D8
/me checks datasheet one
last time...
Needs logic level
converters!
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
30 / 60
Completed Hardware with Battery
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
31 / 60
Measuring current
Dave Jones’ µCurrent Gold
Trusted by hardware implant designers.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
32 / 60
Completed Hardware without Battery
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
33 / 60
Software ﬂow
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
34 / 60
Usage
1 Get malware on target.
2 Attach CHUCWAGON for exﬁl or control.
If software on the target can communicate with the implant then:
Target can exﬁl out to implant to GSM.
Target can exﬁl out to implant for storage.
Implant can provide code for target to run.
Control the implant over GSM ! control the target over GSM
Why is this signiﬁcant?
I2C via the video adapter is an always on, bi-directional bus on every
laptop, PC, or server.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
35 / 60
Accessorize!
Prepared for anything or NSA hacking toolkit?
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
36 / 60
How to improve the CHUCKWAGON
What does CHUCKWAGON rev. B look like?
Consolidate into one board: ImplantCape
HDMI footprint vs. VGA
Could all be done from AVR (less power), but BBB is more fun and
provides more options.
VGA Tap.
I Combine with SALSAFLOCK for a implant plus RF retroreﬂector.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
37 / 60
Using Crypto for Evil!
Long history of Cryptography and Malware!
Cryptoviral Extortion:
1989 PC Cybord, Joseph Popp
1996 Macintosh SE/30 crytovirus PoC, Young and Yung
2006 Gpcode.AG/AK, Cryzip
2013 CryptoLocker, CryptorBit
Reversing Anti-Analysis:
Packers, Obfuscator, VM-based JIT
2011 TPM ”cloaking” malware
2014 Uroburos, encrypted VFS
2014 TPM-enabled super-targeted malware
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
38 / 60
Using Crypto for Evil!
The CryptoCape includes a TPM...
I2C friendly
Protected RSA private key storage
Windows 8 friendly
More or less optional, as there is most likely an onboard TPM
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
39 / 60
Cloaking Malware with the Trusted Platform Module
2011 USENIX Security
Alan M. Dunn, Owen S. Hofmann, Brent Waters, Emmett Witchel
Summary: Use TPM-protected keys and an Intel TXT PAL to protect
malicious code execution from observation, analysis, and tamperment.
Intel TXT and remote attestation are hard!
But generating a public key on a TPM and using that to encrypt
additional payloads is easy...
Put a TPM on your implant and protect against nasty network
interception. Also restrict analysis to the target machine upon discovery
(or force memory analysis).
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
40 / 60
TPM-enabled super-targeted Malware
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
41 / 60
TPM-enabled super-targeted Malware
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
42 / 60
TPM-enabled super-targeted Malware
Windows 8 automatically enables/initializes a TPM, then creates and
manages your owner password. Access to TPM is abstracted through
Microsoft CSP.
Windows PcpTool Kit:
NCryptOpenStorageProvider
NCryptCreatePersistedKey
NCryptExportKey
NCryptDecrypt
In memory process creation:
CreateProcess
ZwUnmapViewOfSection
VirtualAllocEx
WriteProcessMemory
Python pefile to inject
encrypted PE section into a
decryption stub.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
43 / 60
TPM-enabled super-targeted Malware
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
44 / 60
tpm-malcrypt
fork tpm-malcrypt!
https://github.com/theopolis/tpm-malcrypt
tpm-keyextract, create and exﬁl a storage public key
malcrypter, encrypt and inject into decryption stub
malcrypt, decryption stub, process creation/injection
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
45 / 60
Malicious Exﬁltration via Audio
Backstory: #badBIOS thought to use Audio as an out-of-band
exﬁltration or C&C mechanism. Dismissed as infeasable by BIOS
development SMEs.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
46 / 60
Malicious Exﬁltration via Audio
Data of Audio Protocols are very well deﬁned and resiliant.
QPSK10 (10 baud), QPSK05 (5 baud), quadrature phase shift keying
modulation to provide forward error correction.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
47 / 60
Malicious Exﬁltration via Audio
Possible to ”pivot” through colluding machines. Local network exploitation
creates a mesh of audio-capable relays such as idle headphones.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
48 / 60
Demos, Learning, and Fabulous Prizes
Join us in the HHV for CryptoCape and WAGONBED demos!
Challenge: Solve the puzzle here:
theopolis.github.io/tpm-malcrypt/challenge.html
The ﬁrst 5 correct submissions win a DIY hardware implant kit
(No hardware hacking experience required)
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
49 / 60
Demos, Learning, and Fabulous Prizes
Thank you!
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
50 / 60
Upcoming Book
Preorder with code: BBSAeB
at packtpub.com.
Setting up a Tor bridge
and building custom front
panel.
Two factor authentication
with a Fingerprint scanner
and the CryptoCape
Using the TPM to protect
GPG keys
Running an IRC gateway
with BitlBee, ZNC, and
using OTR for protected
chat.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
51 / 60
POC Code
CHUCKWAGON sketch and scripts
https://github.com/NSAPlayset/CHUCKWAGON
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
52 / 60
i2cdetect on BBB
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
53 / 60
i2cdetect on target
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
54 / 60
chuckwagon util on BBB
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
55 / 60
chuckwagon util on target
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
56 / 60
BBB starting the GSM module
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
57 / 60
BBB waiting on text message
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
58 / 60
Receiving the message on the target
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
59 / 60
Executing the text message
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
60 / 60