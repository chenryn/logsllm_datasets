# ITU T.30标准中的协议图

## 图9: ITU T.30标准中的协议图
在ITU T.30标准中，Phase B负责发送者和接收者之间的握手过程，而Phase C则根据协商的参数来传输数据帧。这些帧通过电话线以HDLC帧的形式发送，如图10所示。

## 图10: ITU T.30标准
### 寻找攻击向量
#### 发送TIFF文件
有一种误解认为传真仅简单地发送TIFF文件。实际上，T.30协议会发送页面，并在Phase B阶段协商包括页面长度和宽度在内的参数。Phase C用于传输页面的数据行。最终输出的是一个包含IFD标签的TIFF文件，这些IFD标签用于构建握手所需的元数据。随后，.tiff文件将包含通过电话线接收的页面行。

尽管TIFF分析器存在许多漏洞，但这些漏洞主要集中在处理IFD标签的代码中。这些标签通常由用户自行构建，在打印过程中打开压缩内容时才会被处理。

#### TIFF压缩
TIFF格式使用多种压缩方法，需要首先识别这些方法。以下是一些基本的映射关系：
- **TIFF Compression Type 2** = G3 without End-Of-Line (EOL) markers
- **TIFF Compression Type 3** = G3 = ITU T.30 Compression T.4 = CCITT 1-D
- **TIFF Compression Type 4** = G4 = ITU T.30 Compression T.6 = CCITT 2-D

这些压缩方法基于固定哈夫曼表的基本Run-Length-Encoding (RLE)方案。研究人员检查了T.4和T.6的解压缩代码，未发现可利用的漏洞。

### T.30扩展
在Phase B阶段，设备会交换能力，以确定最佳的传输方式。研究人员编写了一个脚本对这些使用ITU T.30标准的消息进行语法分析，结果如图11所示。

## 图11: 分析目标的DIS能力
测试显示打印机支持ITU T.81 (JPEG)格式，即可以发送彩色传真。研究人员在分析处理彩色传真的代码时发现，接收的数据保存为.jpg格式。与TIFF文件相比，.jpg文件中的header是由接收者构建的。固件中，接收的内容会在没有过滤的情况下复制到文件中，这为攻击者提供了入口。

### 打印彩色传真
当目标打印机接收到彩色传真时，它会将内容直接复制到一个名为`%s/jfxp_temp%d_%d.jpg`的文件中，而不进行任何检查。接收传真只是第一步，打印时打印机模块需要确认文档的长度和宽度，并进行基本的语法分析。

## JPEG分析器
由于某些原因，固件开发者重新实现了主流开源项目中的模块。从攻击者的角度看，这是一个机会，因为在复杂的文件格式分析器中找到漏洞是可能的。JPEG分析器的工作原理如下：
1. 检查文件开始标记Start Of Image (SOI) marker: 0xFFD8
2. 循环分析每个支持的标记
3. 完成后，返回相关数据给调用者

### CVE-2018-5925 – 缓冲区溢出
根据标准，COM maker（标记）（0xFFFE）是一个可变大小的文本域，表示文本评论。标准规定传真接收器应丢弃此标记。研究人员发现了这个漏洞，如图12所示。

## 图12: COM marker漏洞反编译的代码
分析模块会对2字节长的域进行分析，并将文件中的数据复制到全局数组中。数组中每个记录大小为2100字节，而长度域为64KB，导致大量可控的缓存溢出。

### CVE-2018-5924 – 基于栈的缓存溢出
由于第一个漏洞不支持标准的编译实现，研究人员继续寻找其他标记相关的漏洞。DHT marker (0xFFC4)定义了特殊的Huffman表，用于解码文件的数据帧。函数比之前的COM maker漏洞更简单，如图13所示。

## 图13: DHT marker漏洞反编译的代码
- 有一个读取16字节数据的循环，每个字节表示一个长度域，所有字节加起来就是整个长度变量。
- 一个全0的256字节本地栈缓存用于后续操作。
- 第二个循环使用之前的长度域，从文件中拷贝数据到本地栈缓存。

代码中的漏洞在于：`16 * 255 = 4080 > 256`，因此攻击者有了不受限制的、基于栈的缓存溢出。

## 构建漏洞利用
研究人员最终选择DHT漏洞，因为它更容易实现。

### 自动化Payload – 实现图灵机
研究人员使用了一个基于网络的加载器来调试漏洞利用。当前攻击向量的主要优势在于payload可以保存在发送的JPEG文件中。由于不会对传真的内容进行任何检查，payload可以保存在发送的文档中，而不必担心JPEG文档是否合法。文件描述符也保存在全局变量中，因此研究人员编写了基于文件的加载器。加载器可以从文件中读取payload并加载到内存中。当payload需要用输入执行任务时，就会从文件中读取输入并执行相应的指令。

## 在网络上传播
控制打印机已经完成，但如果能控制打印机所在的计算机网络，就可以进行更多操作。研究人员使用Eternal Blue漏洞接管了打印机所在的计算机网络。应用和实现的payload具有以下功能：
1. 控制打印机的LCD屏，证明完全控制了打印机。
2. 检查打印机是否联网。
3. 使用Eternal Blue和Double Pulsar攻击所在网络中的计算机设备，并完全控制。

这样，攻击者可以在打印机所在的计算机网络上传播payload。

## 总结
研究人员分析了ITU T.30传真协议存在的安全漏洞，并以HP Officejet Pro 6830多功能打印机为测试机证明了传真协议实现过程中的安全风险。通过一根电话线，发送传真即可完全控制打印机，并在网络中传播payload。本文给各打印机厂商以启示，可能会改变现代网络架构处理网络打印机和传真机的方式。未来，传真机（打印机）也可能成为入侵企业网络的攻击向量之一。

**参考文献**
1. HP Security Bulletin
2. ITU T.30 (Fax)
3. ThreadX
4. Green Hills
5. CVE 2017-9765 (Devil’s Ivy)
6. Scout Debugger on Github
7. HP Digital Fax
8. CCITT (Huffman) Encoding
9. Huffman/CCITT Compression in TIFF
10. ITU T.81 (JPEG)
11. ITU T.4
12. JPEG Markers
13. libjpeg
14. Eternal Blue check point research