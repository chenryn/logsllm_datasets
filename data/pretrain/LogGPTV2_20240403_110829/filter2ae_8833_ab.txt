左下：Win7；右下：Win2008 R2
​
初始状态
​
XP和Win7被打蓝屏了
​
2008中招
第二组：提前感染DoublePulsar的机器
左上：蠕虫初始投放机器（Win7）；右上：WinXP SP3
左下：Win7；右下：Win2008 R2
​
感染好DoublePulsar
​
Win7和2008沦陷（XP没事）
小刀觉得，并不是没有人注意到这个问题，也不是没有人研究这个问题，只是没人讨论，因此有点困惑。
当然，不管如何，微软已经针对XP和2003发布了补丁，还在使用这些系统的小伙伴，还是要打好补丁、做好系统加固工作。
### 反思3：希望国内安全研究者（机构）能够建立“重大安全事件联合攻关机制”。
用WannaCry蠕虫研究过程中最重要的一环——文件恢复或者解密——来谈这个问题吧。
这个问题很显然包括两个点：
一是无密钥的情况——文件恢复的问题。
这个已有各路英雄提供了很多方法，比如360较早发布的直接“找回已删除文件”的方法和工具；比如四川效率源公司较早发布的不同大小文件的不同加密方式（1.5MB）及可能的恢复方法；同时效率源基于自身早期研究成果推出的Office文件恢复工具、数据库恢复工具等等。
这里有一个细节，当时并没有看到相关报告，那就是WannaCry对于某些文件，会先做随机填充后再删除，而不是直接删除。
例如下图中的“Blue hills.jpg ”文件，是原始文件，在Windows
Explorer中是可以看到预览的缩略图的，同时蠕虫已经开始加密了（旁边有个.WNCRYT文件）：
​
而蠕虫完成加密后，将.WNCRYT重命名为.WNCRY文件，但是，仔细观察会发现“Blue hills.jpg
”文件已经无法预览了，这是因为这个文件已经被蠕虫修改，格式上已经不是合法的JPG文件了：
随后，蠕虫会移动并删除这个文件。很显然，这个文件，通过磁盘恢复的方式，就不能恢复了。（今天整理的时候看到360的报告中已经对这个问题进行了详细的阐述。）
二是“如何找到密钥”的问题。
为了便于讨论，小刀把WannaCry的密钥分为3类：文件密钥（加密文件的AES对称密钥，每个文件不同）、关键密钥（用于加密文件密钥的RSA非对称密钥，每台机器每次运行不同；公钥用来加密AES密钥，私钥被核心密钥的公钥加密存放在本机）、以及核心密钥（黑客手上掌握的RSA非对称密钥；公钥内置在蠕虫中，用于加密关键密钥的私钥，而私钥只有黑客自己掌握）。
因为国外研究者较早就复原了加密和解密流程，只要能拿到上述任何一种密钥，就可以解密文件——最彻底的就是拿到黑客手上的核心密钥私钥，那就可以拯救世界了；其次是可以拿到每台机器的关键密钥私钥，那就可以拯救这台机器了；如果能拿到文件密钥，就可以拯救这个文件。
这里用到的解密工具是Benjamin Delpy开发的wanadecrypt。
作为研究，第一步当然是到内存里面去找找看，看它密钥在内存中什么时候生成、什么时候销毁（工具作者也说了）：
通过对微软的相关API下断点的方法可以找到密钥（比如CryptExportKey、CryptEncrypt什么的），当然，你还要对RSA的密钥格式有一点了解（在本例中是“07
02 00 00 00 A4 00 00”开头的16进制数据，总长度为1172字节）。
但是这个密钥在内存中存活的时间窗太短了，还有什么办法呢？
因为RSA密钥生成，是要用到素数的，如果能找到素数，也就有路可走了。当然这需要对密码学相关知识和微软的API原理更加熟悉才行。——小刀忍不住又要佩服那帮老外了。法国安全研究人员Adrien
Guinet提出：由于微软Windows CryptAPI中，CryptReleaseContext()并没有清除素数(prime
numbers)，可以通过扫描WannaCry
进程的内存空间来找到相关素数，再恢复RSA私钥。同时完成了工具wannakey的开发，并开放源代码（
Delpy基于上述研究成果，开发了wanakiwi工具，可以自动扫描WannaCry 进程的内存空间来找到相关素数，再恢复RSA私钥，并完成解密工作。
这样，这个“可能找到关键密钥”的时间窗就要长很多了（直到相关内存空间被覆盖）。
为什么提到“重大安全事件联合攻关机制”呢？首先是因为可以用于研究的时间非常有限，每个研究人员、研究机构都在加班、熬夜，如果不能形成一定的共享，则很有可能大家会做重复劳动，导致进展不够快；其次是因为涉及到的领域很多，比如恶意代码分析、加密解密、文件恢复等等，客观上需要不同领域的高手协同作战。
比如，在当前研究进展下，还有没有什么方法可以在“寻找关键密钥”的道路上更进一步呢？
Benjamin Delpy在发布wanadecrypt 0.0版本的时候，写了一句话：
It's only a little help on the road to have maybe a version that can get the
key at one point...
小刀认为，这句话非常好地描述了他从事这项研究工作的心态，也非常值得我们学习。
技术人员当勤于思考、勇于提问、敢于质疑，不放过每一个技术细节、不厌其烦地谨慎求证、不断朝着目标一步一步前进。
在重大的安全事件面前，我们应该放下品牌，抛弃成见，开放心态，精诚合作。
注：由于水平有限，文中难免出错，请大家多多海涵并严肃指正！
这样，这个“可能找到关键密钥”的时间窗就要长很多了。
为什么提到“重大安全事件联合攻关机制”呢？首先是因为可以用于研究的时间非常有限，每个研究人员、研究机构都在加班、熬夜，如果不能形成一定的共享，则很有可能大家会做重复劳动，导致进展不够快；其次是因为涉及到的领域很多，比如恶意代码分析、加密解密、文件恢复等等，客观上需要不同领域的高手协同作战。
Benjamin Delpy在发布wanadecrypt 0.0版本的时候，写了一句话：
It's only a little help on the road to have maybe a version that can get the
key at one point...
小刀认为，这句话非常好地描述了他从事这项研究工作的心态，也非常值得我们学习。
在重大的安全事件面前，我们必须要放下品牌，抛弃成见，开放心态，精诚合作。
技术人员当勤于思考、勇于提问、敢于质疑、不厌其烦地谨慎求证。
番外篇：PR
5月12日起持续发酵的WannaCry勒索蠕虫事件，恰如网络安全界的一场临时大考。安全企业、安全研究机构和安全从业者各显神通，在收获丰硕果实的同时，也顺带给全社会民众结结实实地上了一堂安全科普扫盲课。而国内的各网络安全主管单位，也通过本次事件，看到了国内安全行业近年来的长足发展，留意到了尚存在的不足，厘清了发展思路。
回首WannaCry事件始末，小刀倒也学到几招PR套路，比如：
² “快”字当先：紧跟脱缰的WannaCry，抢尽一切PR先机，没研究清楚不要紧，先发了再说。
² 反复轰炸：素材反复用，不求详尽，不求创新，但求刷屏。
² 标题第一：事实没那么重要，标题就是一切，越劲爆越好。
最后，用两张图结束本文：
我们知道，很多IT业的巨头都提倡“顾问式销售方法论”——根据用户的采购流程制订自己的销售活动计划，例如：
WannaCry事件，经历了“发现－初步分析－紧急应对－深入分析－全面应对－解密方法－思考未来”等过程，根据小刀的观察，如果咱要做PR，就要紧跟这个过程，在每一个环节上，尽早发布咱们的PR文——事实上，很多优秀的同行们恰恰就是这么实践的。
我们可以照葫芦画瓢，根据安全事件发展中的民众心理，制订自己的PR活动计划，例如：
本文定位于反思，所以，还是希望国内的同行们能够多多携手、砥砺前行！
比如：PR的力道不妨轻一些，工作量适当少一些，标题更客观一些，对客户的尊重更多一些；对技术的反思更加深入一些，在细节的追求上更精进一些，彼此的成见小一些，宽容和合作多一些；借鉴别人成果的时候，多一些赞扬和感激，尽量留下别人的名字、成果的链接，哪怕在参考文献中留下一条信息也是极好的……
借发于阿里云先知技术社区的机会，更新一个遗漏的信息：
在WannaCry勒索蠕虫席卷全球的那个周末，某些人在群里高声喊着“我们又可以卖防火墙啦”的时候，另一些人在忙着给PR文起个更夺人眼球的标题的时候，一个信息安全的老兵，默默地做了一个PPT，没有用到任何厂商的第三方工具，仅仅用微软原生的系统配置方法，告诉很多普通用户应该如何应对。——小刀是事后得知此事的，觉得非常有必要为他点个赞，他做了一个真正的技术人员应做的事，理应得到大家的赞扬和肯定。虽然我不认识他，甚至他也没有在PPT中留下自己的姓名（看文件属性，不知道是不是叫“李磊”），只知道他曾经是绿盟科技的一名技术人员，目前应该在360企业安全部门工作。——当然，还有很多朋友也做了类似的工作，比如我记得风宁先生也很快提供了简单有效的加固工具，等等，原谅我无法一一列出。
繁华落尽PR去，细水流年技术来。
自勉，共勉。并祝大家儿童节快乐，脸上常常荡漾着孩子般纯真的笑容！恰如你对技术的那般执着。
同时，热烈庆祝《中华人民共和国网络安全法》正式施行！
教授说：西雅图也开始下雨了……