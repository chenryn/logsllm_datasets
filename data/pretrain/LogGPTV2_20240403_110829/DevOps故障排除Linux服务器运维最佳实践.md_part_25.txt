据库服务器是在一台单独的机器上，每个Web服务器进程通过网络
升你的存储速度，或者去第9章查看如何排除数据库问题。即使数
论哪种情况，要么把你的数据库放在一台单独的服务器上，要么提
和。当然，如果你按照第2章中讲的负载故障排除指南，你应该已
实例同处一台机器上，那么仅是数据库的请求就会导致磁盘IO饱
量。然后你就可以根据最坏情况（最大内存值）或平均情况决定是
尝试衡量进程个数的最大值、最小值以及一个进程平均消耗的内存
情况下，最好的策略是查看一个繁忙的Web服务器的所有进程，并
些PHP脚本只占用很少的内存，但另一些会占用很多。在这样的
Web 服务器配置，让它不会启动超过内存中可容纳进程的数量。
内存总量减去操作系统的开销。然后计算出目前剩余的内存空间可
程。首先计算单个Web服务器进程将占用多少内存，然后用系统的
否设置Web服务器的数量。
服务器状态页诊断服务器性能迟缓的故障，除了诊断系统本
如果负载是I/O 密集型的，而且 Web 服务器与一个数据库后端
另外一种情况，如果负载是I/O密集型的，但问题似乎出自
当然，如今都是动态生成网页，设置这个值有点棘手。毕竟一
要解决这个问题，你需要计算内存可以容纳多少Web服务器进
无
---
## Page 166
况。不仅可以看到系统的平均负载，还可以看到目前有多少个忙碌
务的情况下，这个状态页面提供了解Web 服务器健康状况的整体情
务器响应相当慢，这可能是因为每个 Web 请求需要等待后端返回数
（如果内存中还可以容纳它们），或者是时候添加另一台Web 服务器
样的，那么你需要查看Web服务器日志，尝试找出目前正在加载的
还是等待加载人内存的。如果服务器性能迟缓而记分板看起来是这
进程仍然会等待后端的响应。
来帮助分担负载了。
求。在这种情况下，你可能只需要让你的服务器产生更多的进程
的进程以及它们正在处理什么请求。
器进程都很忙，但此时增加更多的进程也不能解决问题，因为这些
况（有些是因为它所依赖的数据库超载），所以尽管所有的Web 服务
据。当一个应用服务器因为等待请求响应而超载就会出现这样的情
尔能看到一个进程被创建，但很明显几乎每一个进程都忙于处理请
另外，如果你看到一个类似前面所示的记分板，但发现Web 服
另一方面，你可能遇到类似下面的记分板：
可以发现该服务器的请求已经完全超载了。刷新这个页面，偶
$ curl http://localhost/server-status?auto
例如，如果你看到下列输出：
这个服务器有很多非常空闲的进程，无论是那些在内存中的，
wwwwwwwwwwkkkwwwwwww
W
Scoreboard:wwkwkwwwwwwkwwwwwwwwwwwwwwwwwwkkkkkkw_.w.cw..
8.6解决常见的Web服务器问题·159
---
## Page 167
160·第8章网站宕机了？追踪Web服务器问题
页面，最终查明网站上哪个页面需要花很长时间来响应，
硬件设备吧。
设备性能太低，不足以支撑软件运行，如果是这样的话，考虑升级
程序从而找到问题的根源。当然，这也可能是由于Web服务器硬件
，然后研究
---
## Page 168
绍最流行也是很容易遇到的两个基于SQL的开源数据库：MySQL
现。讨论如何诊断所有流行的基于 SQL 和基于NoSQL 数据库的
不如之前流行。似乎每周都会有一个NoSQL风格的新数据库出
据库故障排除技能中获益。毕竞，DBA（数据库管理员）也许没有
的熟悉程度，通常即使相对简单的应用程序也会将数据存储在数据
库的普遍性、众多流行数据库安装的便利性以及开发者对SQL语句
到一定程度之后，就要用某种数据库来存储数据。由于数据库包装
和 PostgresSQL。本章每一节都会先介绍一种特别的故障诊断技
问题，需要一本或者两本书才能说得清楚。所以，本章只简单介
义务帮你备份wiki、构建环境或者笔记本电脑上运行的测试环境。
否有尽职尽责的数据库管理员，DevOps团队中的每个人都会从数
的很多网站，都将相关的数据全部存储在数据库中。无论公司内是
据，大部分都会为用户提供各种动态内容，包括流行博客平台在内
库中，并通过SQL命令获取存储的数据。
为什么数据库这么慢？追踪数据库问题
的确，在现代 DevOps 领域中，传统基于 SQL 的数据库远远
几乎所有的 DevOps团队都遇到过数据库问题。应用程序复杂
，很少有网站是纯静态数
第9章
---
## Page 169
162
8.4-main.log 中的一些示例输出，其中包括了一个语义错误。
postgresql这两个文件夹中。
9.1.2
·第9章为什么数据库这么慢？追踪数据库问题
时/var/log/mysql/errot.log文件中的一些示例输出。
甚至/var/lib/mysql目录下找到错误日志文件。下面是MySQL启动
9.1.1
程序的时候特别有用。
供了启动成功和数据库查询语义错误的信息。这些信息在调试应用
尤其是在数据库启动有问题的时候更要这么做。错误日志通常也提
9.1
库中的慢查询。
运行并监听正确的端口，能够获得数据库的性能指标并识别数据
诊断当中。在本章结束时，你应该能够确定一个数据库是否正在
根据 MySQL 版本的不同，你可能会在/var/log、/var/log/mysql
对于PostgresSQL来说，
在处理数据库相关问题的时候，需要查看数据库的错误日志
2012-07-1020:08:07PDTLOG:
2012-07-10 20:08:07PDT LOG:
2012-07-1020:08:07PDTL0G:
Version:'5.1.63-0ubuntu0.10.04.1-1og'socket:'/var/run/mysqld/mysqld.sock'port: 3306
120714 15:35:26[Note] Plugin'FEDERATED'is disabled.
120714 15:35:27[Note]/usr/sbin/mysqld:ready for connections.
120714 15:35:27[Note]Event Scheduler:Loaded 0events
120714 15:35:26
12071415:35:26
20714 15:35:26
(Ubuntu)
查找数据库日志
 PostgresSQL
 MySQL
5InnoDB:Started;1og sequence number 0 67138180
InnoDB:Completedinitialization of buffer poo
InnoDB: Initializing buffer pool, size = 8.0M
database system is ready to accept connections
incomplete startuppacket
autovacuumlauncher started
日志文件应该在/var/log或者/var/log/
下面是/var/log/postgresql/postgresql-
---
## Page 170
用，不过最好还是在服务器本地真正测试下数据库服务器是否正在
是否正在运行并监听正确的端口。尽管你可以远程测试端口是否可
9.2
位最常访问的是哪个存储位置。当然，出现所有这些情况的时
候，你可能也仅需要更新硬件或者在集群中再增加一台服务器。
具尝试确定是哪个进程消耗了这么多IO资源，再使用 sysstat 定
据库数据)。如果是 IO 负载，那么请使用类似于 iotop 这样的工
耗太多RAM资源的SQL查询语句（或者停止在RAM中存储数
要调整数据库参数，让它少同步执行一些查询语句或者定位消
可能是一个糟糕的SQL查询语句，它使用了过多的进程资源。
是CPU负载、RAM负载还是IO负载的问题。
不仅能帮你确定数据库是不是高负载的根源，还能帮你了解这
小技巧，检查下为何有这么高的负载。第2章介绍的那些步骤
不仅仅运行了数据库软件的时候，请先根据第2章介绍的各种
运行缓慢的高负载数据库服务器的问题，尤其是这个服务器上
章后面会介绍相关步骤。如果是RAM负载问题，那么你可能需
如果真是这种问题，你可能需要跟踪运行缓慢的查询语句，本
如果看起来是数据库问题，那么首先要做的应该是检查数据库
2012-07-12 05:06:53 PDT HINT:No operator matches the given name and argument type(s).
2012-07-12 05:06:53 PDT ERROR: operator does not exist:name = pg_stat_all_tables at
2012-07-11 14:15:48 PDT LOG:
如果一个数据库处于高CPU负载的状态，那你需要面对的
2012-07-1114:16:01PDTL0G:
You might need to add explicit type casts.
character 47
数据库还在运行吗
在执行数据库特有的故障排除步骤之前，如果你打算解决
高服务器负载
incomplete startup packet
9.2数据库还在运行吗·163
---
## Page 171
164
·第9章为什么数据库这么慢？追踪数据库问题
ID一致。如果这个命令没有任何输出，那就说明没有任何进程正
部处于监听状态的端口以及打开这个端口的进程：
你现在的环境。当在 netstat 命令中传入-lnp 选项的时候，会显示全
在监听正确的端口。默认情况下，MySQL应该监听端口3306，当
能你还是无法与它建立连接。所以下一步应该测试MySQL是否正
(或者仅监听了本地端口，而你希望监听所有网卡上面的端口），可
ID一致。当然，如果MySQL正在运行但是它监听了错误的端口
字是mysql，所以可以用下面的方法获取它的状态：
件夹中初始化脚本的名字。在基于 Debian 的系统中，这个服务的名
是不需要知道进程的名字，仅需知道/etc/rc.d/init.d或者/etc/init.d/文
9.2.1
数据库的连接，那么应该参考第5章关于如何进行网络故障排除的
然如果将它配置成了监听不同的端口，需要更改下面的命令来匹配
可以使用初始化脚本，因为它支持 status 命令。使用这个方法的好处
内容。MySQL 和 PostgresSQL 的进程集合差异很大，同时它们监听
运行并监听正确的端口。这就是说，如果你怀疑网络问题阻止了与
的端口也不同。
有很多不同的方法可以检查MySQL是否正在运行。首先，你
请注意，输出中MySQL的进程ID（735）与前面命令的进程
注意，status 命令返回的进程ID（735）和从 ps 中获得的进程
也可以结合使用 ps 和 grep命令来确认 MySQL 是否正在运行：
$sudo netstat -1npIgrep:3306
mysql start/running,process 735
$ ps -ef | grep mysq1
$sudo servicemysql status
tcp
mysq1
MySQL
0127.0.0.1:3306
10Jun12？
02:02:56 /usr/sbin/mysqld
0.0.0.0:*
LISTEN
735/mysqld
---
## Page 172
9.2.2
安装也会启动多个进程，用来处理不同的任务。还有一点，因为
PostgresSQL 的版本号结尾，所以你需要运行：
基于Debian的系统（如Ubuntu）中，这个初始化脚本可能以
同，PostgresSQL初始化脚本的名字可能也不一样。例如，在
用ps来测试PostgresSQL是否正在运行。但是根据系统的不
IP 或者所有网卡的IP 地址。
样的输出，那么就应该重新配置MySQL，这样它就能监听指定的
打算访问部署在另一台机器上面的MySQL服务器，却也看到了这
的 netstat 命令的输出，看看是否有任何进程。在这个例子中，还值
在监听端口 3306。也许你会查看不使用 grep(或者使用 grep mysql)
PostgresSQL与MySQL监听的默认端口不同（5432），所以当你运
/etc/rc.d/init.d目录。
么版本，如果你不确定init脚本的名字是什么，仅需检查/etc/init.d或
服务器与数据库服务器是同一台服务器，所以这没有问题。但如果
得注意的是MySQL进程仅在监听本机（127.0.0.1:3306），因为Web
也可以使用 ps命令：
将 postgresql-8.4 替换为 postgresql-9.1或者机器上安装的其他什
和MySQL一样，既可以通过查询初始化脚本也可以使
$ sudo service postgresql-8.4 status
与MySQL不同的是，
$ps-ef|grep postgres
postgres 1634
postgres 1631 1629 0Jul10?
postgres1629
Running clusters:8.4/main
bostgres
bostgres
var/lib/postgresql/8.4/main-cconfig_file=/etc/postgresq1/8.4/main/postgresq1.conf
 PostgresSQL
1629
1629
1629
10Jul10？
0Jul10？
0Jul10？
0Jul10
，对于PostgresSQL来说，即使是基本
00:00:06/usr/lib/postgresq1/8.4/bin/postgres-D/
00:00:04 postgres: stats collector process
00:00:30 postgres:wal writer process
00:00:38 postgres:writer process
9.2数据库还在运行吗·165
---
## Page 173
166
9.3获得数据库度量值
（1629）一样。如果没有获得任何输出，尝试使用 postgres 而不是端
行 netstat 的时候，需要使用 grep 来获得相应的端口：
·第9章为什么数据库这么慢？追踪数据库问题
络连接数据库，获取相关数据)。使用 status 命令可以从 mysqladmin
（这也就是说你可以将这个软件安装在另外一个系统上，然后通过网
9.3.1
中获取最基本的（同时也可能是最有用的）数据。