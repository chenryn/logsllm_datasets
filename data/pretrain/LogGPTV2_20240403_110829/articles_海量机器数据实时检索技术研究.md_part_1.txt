# 海量机器数据实时检索技术研究
1.  **引言**
随着IT技术的飞速发展，企业信息化建设日新月异。然而伴随着IT信息系统复杂度的不断加深，企业对IT信息系统正常运行的依赖性也越来越大。
与此同时，随着计算机和信息技术的迅猛发展和普及应用,行业数据爆炸性增长，大数据技术是指通过对大量来源复杂的多种类数据进行高速地捕捉、发现和分析，用科学经济的方法提取其价值的技术体系或技术架构。机器数据是大数据分类中，由机器直接生成的数据，也是发展最快、最为复杂，同时极具商业价值的大数据组成形式。大数据中90%的数据属于机器数据。除了来自于服务器、存储、网络中的传统IT数据以外，来自移动互联网、物联网中的大量非结构化数据也都属于机器数据。相比数据库数据，机器大数据具有数量大、增长速度快、复杂性高、多样化等特点，但是价值密度略低。借助大数据流式处理技术能够实现对机器数据的深入挖掘，充分利用数据价值，提升数据分析质量，保证IT系统稳定运行。
受制于建设时期的技术制约，电力行业在对机器数据的分析处理方面已逐渐无法适应新环境、新运维模式下的管理要求。传统实时数据库索引技术主要针对基于关系型的结构化数据，其构建的非结构化数据索引在性能和数据库资源占用方面都难以满足智能电网的发展需要，尤其在实时性方面。技术人员需要海量机器数据实时检索技术，以实现对全网范围内的主机、服务器、网络设备、数据库以及各种应用服务系统等产生的各类机器数据，进行规范采集，统一规范机器数据格式，统一持久化存储，统一策略制定，并进行细致实时检索分析，通过统一的控制台进行实时可视化的呈现。
2.  **海量机器数据实时搜索技术研究**
```{=html}
```
1.  **机器数据实时搜索分析平台架构设计**
-   物理支撑层：采用分布式集群方式搭建机器数据中心环境，借助云计算机能力和存储的弹性扩展能力为机器数据中心提供可靠的运行环境。
-   机器数据采集层：机器数据中心依据机器数据采集规范通过Agent、Syslog、ODBC、SNMP
    Trap、Socket、File等多种接口，采集各设备、系统和应用的本地型机器数据等；通过镜像等方式采集网络型机器数据，通过两种采集方式的合理配置，实现全部设备和资源的机器数据采集。
-   机器数据存储、加工层：实现机器数据的持久化、结构化存储，统一机器数据格式，并根据规则、策略库，对机器数据进行加工处理，结合资产信息实现机器数据信息的关联。
-   数据处理层：采用分布式搜索引擎，支持时间文本索引和全文检索，能够快速搜索TB级数据，结构化或者非结构化的数据，具备高可靠性和高性能。
-   应用与展现层：实现系统管理、策略制定、规则制定、关键业务参数配置等基本业务功能，提供常用的告警分析场景，实现海量机器数据的快速查询，数据分析统计及可视化，并提供对外接口服务，方便系统进行二次开发。
1.  
2.  
3.  
4.  
5.  
6.  
7.  
8.  
9.  
10. 
11. 
```{=html}
```
1.  消息队列技术 ②集群资源同步与管理技术
**技术实现**
1.  **机器数据采集技术**
一个高可用的，高可靠的，分布式的海量机器数据采集、聚合和传输的系统，支持在机器数据系统中定制各类数据发送方，用于收集数据；同时提供对数据进行简单处理，并写到各种数据接受方（可定制）的能力。
\(1\) 可靠性
当节点出现故障时，机器数据能够被传送到其他节点上而不会丢失。集群提供了end-to-end模式来保障可靠性：收到数据agent首先将event发送到后端消息队列集群，如果数据发送失败，将event写到磁盘上，可以重新发送。
\(2\) 可扩展性
模块完全是多主平行结构，不存在单点故障问题。
\(3\) 可管理性
每个节点均提供metric
api接口，以json格式数据展现服务状态，方便提供服务指标和运维监控。
2.  **消息队列技术**
用于消息的持久化和缓存。该系统使用磁盘文件做持久化，顺序进行读写，以append方式写入文件。为减少内存copy，集群使用sendfile发送数据，通过合并message提升性能。集群本身不储存每个消息的状态，而使用（consumer/topic/partition）保存每个客户端状态，大大减小了维护每个消息状态的麻烦。在消息推拉的选择上，集群使用拉的方式，避免推的方式下存在的各个客户端的处理能力、流量等不同产生不确定性。以多机形式形成集群，建议3台或3台以上奇数台服务器组建，并且支持分区副本。
通过的磁盘数据结构提供消息的持久化，这种结构对于即使数以TB的消息也能够保持长时间的稳定性能。
高吞吐量，即使是非常普通的硬件也可以支持每秒数百万的消息。
消息队列对消息保存时根据Topic进行归类，一个Topic可以认为是一类消息，每个topic将被分成多个partition(区),每个partition在存储层面是append
log文件。任何发布到此partition的消息都会被直接追加到log文件的尾部，每条消息在文件中的位置称为offset（偏移量），offset为一个long型数字，它是唯一标记一条消息。
![](media/image2.png){width="3.53125in" height="2.28125in"}
3.  **集群资源同步与管理技术**
一个针对大型分布式系统的高可靠协调系统，提供的功能包括：配置维护、名字服务、分布式同步、组服务等。封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。由3台或3台以上奇数台服务器组建完成，可提供丰富的构件来实现多种协调数据结构和协议，并具有高可用性，帮助系统避免单点故障。
4.  **机器数据分析技术**
采用业界最先进的流式大数据处理架构Spark
Streaming，构建的高性能、分布式机器数据处理架构可以每秒钟分析10万条机器数据，每天可以处理TB级的机器数据量，而且处理延时非常短，可以让用户搜索、分析几秒钟之前产生的机器数据。
流式计算集群具有如下特性：
● 轻量级快速处理
● 无数据丢失
● 容错透明
5.  **搜索引擎技术**
索引集群是一个的分布式搜索引擎，具备高可靠性和高性能。支持时间文本索引和全文检索，提供丰富的api用于索引、检索、修改大多数配置。能够快速搜索数百亿的机器数据以及TB级的结构化或者非结构化的数据。
集群由2台及2台以上节点组成，其中一个为主节点，节点通过选举产生，主从节点是对于整个集群内部来说的，从外部来看整个集群，逻辑上是一个整体，与任何一个节点的通信和与整个集群通信是完全一致的。集群自动创建索引，通过配置我们可以非常方便的调整索引分片和索引副本。通过索引分片技术，一个大的索引被拆分成多个，然后分布在不同的节点上，以构成分布式搜索。索引副本的作用一是提供系统的容错性，当某个节点某个分片损毁或丢失时，可以从副本中恢复；二是提供查询效率，集群内部会自动实现搜索请求的负载均衡。
3.  **试验验证**
**查询测试**
**全局数据查询**
**测试方法：**
在查询界面对指定时间（如全天或三天）的全量数据，观察机器数据查询消耗时间，预估2.5亿条数据，查询返回10s以内。
**查询语句：**
**"**\***"**
  --------------------------------------------------------------------------
  测试周期     索引时间范围         机器数据总数   查询耗时      平均耗时
  ------------ -------------------- -------------- ------------- -----------
  第1次查询    20170721 -- 20170722 108,492,156    7136ms        7226.2ms
  第2次查询    20170721 -- 20170722 108,492,156    7145ms        