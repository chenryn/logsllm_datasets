PentesterAcademy.co
m/
©PentesterAcademy.com 
VoIPShark:+Open+Source+VoIP+Analysis+
Platform+
Nishant/Sharma/
Jeswin+Mathai+
Ashish+Bhangale+
PentesterAcademy.com+&+AttackDefense.com+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
About+Us+
Me,/Nishant/Sharma/
•  R&D+Manager+and+Lead+Trainer,+Pentester+Academy+
•  Firmware+developer,+Enterprise+WiFi+APs+and+WIPS+Sensors+
•  Masters+degree+in+Infosec+
•  Published+research+at+Blackhat+US/Asia,+DEF+CON+USA+and+other+venues+
+
Co-authors+
•  Ashish/Bhangale,+Sr.+Security+Researcher+
•  Jeswin/Mathai,+Security+Researcher+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
PentesterAcademy.com+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
AttackDefense.com+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Talk+Overview+
• 
VoIP+Basics+
–  SIP,+RTP+
–  Secure:+TLS,+SRTP++
+
• 
Recovering/Decrypting+VoIP+Calls+
+
• 
Current+open+source+tools+and+issues+
+
• 
VoIPShark+
–  Architecture+and+Internals+
–  Analyzing+VoIP+Traffic+
–  Recovering+Calls+
–  Detecting+Attacks+Passively+
–  Demo+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
VoIP+Telephony+
• 
Signalling+++Media++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Signalling+Protocols++
SIP/(Session/Initiation/Protocol)+
• 
Developed+by+the+IETF+
• 
Replacement+for+the+desk+phones+and+PSTN+(Public+Switched+Telephone+Network)+
+
H.323+
• 
Created+by+the+ITU-T+
• 
Focused+on+videoconferencing+but+also+used+for+voice+calls+
+
SCCP/(Skinny)+
• 
Cisco+proprietary+protocol+used+for+line-side+control+of+phones+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Session+Initiation+Protocol+
• 
Text-based+protocol+
• 
Applications++
–  Calls+(audio,+video)+using+other+media+steams+like+RTP+
–  Text+messages+using+SIP+“Message”+method+
• 
Works+with+other+protocols+
• 
Session+Description+Protocol+(SDP)+to+define+with+media+negotiation+and+setup+
• 
Can+operate+over+TCP,+UDP+or+SCTP+(Stream+Control+Transmission+Protocol)+
• 
Security+is+provided+by+TLS+(Transport+Layer+Security+)+i.e.+SIP+over+TLS.+
+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SUBSCRIBE,+PUBLISH+and+NOTIFY++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Session+Initiation+Protocol:+Sample+Call+Flow+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
User+Agent+Server+(UAS)+Solutions+
www.sipfoundry.org+ 
freeswitch.org+ 
www.elastix.org+ 
www.asterisk.org+ 
www.3cx.com+ 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Softphone+clients+
• 
Program+for+making+telephone+calls+over+IP+
• 
Some+options+
–  Zoiper+
–  X+Lite+
–  LinPhone+
–  MicroSIP+
Factors/in/choosing/a/good/softphone/client+
• 
Check+codec+support+
• 
Check+encryption+capabilities+(Especially+in+free+versions)+
• 
Other+functionalities+(i.e.+Text+message+option,+hold,+waiting+etc.)+
www.zoiper.com+ 
www.microsip.org+ 
www.linphone.org+ 
www.counterpath.com/x-lite-download+ 
www.3cx.com+ 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Asterisk+Now+
+ 
= 
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Scenario+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Possible+Configurations+
•  SIP+++RTP+
+
•  SIP+over+TLS+++RTP+
+
•  SIP+++SRTP+
+
•  +SIP+over+TLS+++SRTP+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Possible+Configurations+
•  SIP/+/RTP/
+
•  SIP+over+TLS+++RTP+
+
•  SIP+++SRTP+
+
•  +SIP+over+TLS+++SRTP+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SIP/SDP+Packets+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RTCP+Packets+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RTP+Packets+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Recovered+VoIP+Calls+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Flow+Sequence++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Reconstructed+Call++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Possible+Configurations+
•  SIP+++RTP+
+
•  SIP+over+TLS+++RTP+
+
•  SIP/+/SRTP/
+
•  +SIP+over+TLS+++SRTP+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+key+in+SDP+packet+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Encrypted+Call+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Possible+Configurations+
•  SIP+++RTP+
+
•  SIP/over/TLS/+/RTP/
+
•  SIP+++SRTP+
+
•  +SIP+over+TLS+++SRTP+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
No+SIP+Traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
TLS+Traffic+(SIP+over+TLS)+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
No+RTP+Traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Why+No+RTP+Traffic?+
• 
Wireshark+uses+SDP+packet+to+figure+out+the+port+RTP/SRTP+stream+will+use.+
• 
SIP+and+SDP+are+encrypted,+so+wireshark+can’t+figure+out.+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Undecoded+RTP+Traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Decode+As+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Decode+As+RTP+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RTP+Traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Checking+RTP+Streams+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Analysing+RTP+Streams+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Playing+RTP+Streams+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Possible+Configurations+
•  SIP+++RTP+
+
•  SIP+over+TLS+++RTP+
+
•  SIP+++SRTP+
+
•  /SIP/over/TLS/+/SRTP/
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
TLS+key+exchange+methods+
• 
TLS+uses+symmetric+ciphers+(i.e.+AES,+Blowfish)+to+encrypt+the+data+
+
• 
Two/options/under/realistic/approach+
–  +DHE+(Diffie+Hellman+Key+Exchange)+
–  RSA+(Asymmetric+encryption)+
+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Diffie+Hellman+Exchange+
Assumption+
+
• 
Attacker+even+after+seeing+the+exchanged+colours+can’t++
guess+the+secret+colour.+
+
• 
Attacker+knows++
+
+++++++and+also++
+
+++++++But+can’t+know+which+colour+is+added.+
+
More+on:+en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RSA+(Asymmetric+Encryption+)+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Observations?+
• 
Can’t+recover+keys+derived+with+ECDHE/DHE+by+listening+to+traffic+
+
• 
For+RSA,+if+we+can+get+private+key+of+server,+we+can+decrypt+traffic++
++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
TLS+Traffic+(SIP+over+TLS)+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Diffie+Hellman+Exchange+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Undecoded+SRTP+Traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Decode+As+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Decode+As+RTP+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Checking+RTP+Streams+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Analysing+RTP+Streams+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Playing+RTP+Steams+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
TLS+Traffic+(SIP+over+TLS)+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
RSA+based+key+exchange+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Decrypting+TLS+traffic+
• 
RSA+is+used+to+exchange+keys+
+
• 
We+can+decrypt+with+private+key+installed+on+Asterisk+One+++
+
• 
Keys/and/certificate/location/on/Asterisk/One:+/etc/asterisk/keys+
+
• 
We+have+to+get+the+default.key+from+the+server+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Edit+>+Preferences+>+Protocol+>+SSL+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Adding+Asterisk+default+private+key++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Decrypted+SIP+traffic+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+key+in+SIP/SDP+decrypted+packet+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
Open+Source+Tools+for+Decrypting+SRTP+
• 
SRTP+Decrypt+
+
• 
Libsrtp+
+
+
+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt+
• 
Tool+to+decipher+SRTP+packets+
+
• 
Takes+symmetric+key+to+decrypt+the+SRTP+traffic++
+
• 
Output+decrypted+packets+in+form+of+hexdump+
+
• 
Wireshark+can+reconstruct+RTP+packets+from+the+hexdump++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt+
• 
GitHub:+github.com/gteissier/srtp-decrypt+++
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt:+Pre-Installation+
• 
Installing+libgcrypt+
+
+
+
+
+
• 
Installing+libpcap+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt:+Installation+
• 
Cloning+
+
+
+
+
• 
Compiling+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt:+Ready+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt:+Copying+SRTP+key+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt:+UDP+Ports+
PentesterAcademy.co
m/
©PentesterAcademy.com 
PentesterAcademy.co
m/
SRTP+Decrypt:+Decrypting+SRTP+Traffic+
Command:+./srtp-decrypt+-k+uK+RfjSi9/fUFr8zoJu6zdqPw6MGtONhgX4yqwRj++decoded.raw++
+
• 