**应用日志输出规范**
**V1.3**
**北京优特捷信息技术有限公司**
**售后服务部**
**2018年10月**
# **目录** {#目录 .目录标题1}
[第1章 总则 4](#总则)
[1.1 目标 4](#目标)
[1.2 适用范围 5](#适用范围)
[1.3 日志集中管理的需求 5](#日志集中管理的需求)
[第2章 日志生成规范 6](#_Toc25312)
[2.1 日志文件 6](#日志文件)
[2.1.1 日志文件命名规范 6](#日志文件命名规范)
[2.1.2 日志存储规范 8](#日志存储规范)
[2.2 日志级别及格式要求 9](#日志级别及格式要求)
[2.2.1 日志记录级别 9](#日志记录级别)
[2.2.2 日志记录格式 10](#日志记录格式)
[2.2.3 日志字符集编码 11](#日志字符集编码)
[2.3 日志内容规则 11](#日志内容规则)
[2.4 日志性能要求 12](#日志性能要求)
[2.5 其他要求 13](#其他要求)
[2.6 日志埋点最佳实践 13](#日志埋点最佳实践)
[2.6.1 适合记录点 13](#适合记录点)
[2.6.2 不适合记录埋点 14](#不适合记录埋点)
[2.6.3 请求处理的全过程关联 14](#请求处理的全过程关联)
[第3章 日志输出设置规范 15](#日志输出设置规范)
[3.1 日志输出开关设置 15](#日志输出开关设置)
[3.1.1 日志级别输出设置 15](#日志级别输出设置)
[第4章 日志维护规范 16](#日志维护规范)
[4.1 日志安全 16](#日志安全)
[4.2 日志文件上限控制 16](#日志文件上限控制)
[4.3 日志归档 16](#日志归档)
[4.4 日志备份 17](#日志备份)
[4.5 日志清理 17](#日志清理)
[第5章 交易日志的功能规范 17](#交易日志的功能规范)
[5.1 交易日志的作用和类别 17](#交易日志的作用和类别)
[5.2 交易日志消息文本属性定义 18](#交易日志消息文本属性定义)
[5.3 交易流程跟踪和错误定位 23](#交易流程跟踪和错误定位)
[5.3.1 交易标识 23](#交易标识)
[5.3.2 交易过程跟踪举例 23](#交易过程跟踪举例)
[5.4 性能分析 31](#性能分析)
[5.5 监控统计功能 31](#监控统计功能)
[5.6 特定审计日志的功能 32](#特定审计日志的功能)
**修改记录**
  -------------------------------------------------------------------------------------
  **编号**   **日期**      **描述**                    **版本**   **作者**   **审核**
  ---------- ------------- --------------------------- ---------- ---------- ----------
  **1**                                                                      
  **2**                                                                      
  **3**                                                                      
  **4**                                                                      
  -------------------------------------------------------------------------------------
**\
**
1.  # 总则
    1.  # 目标
为稳步提高行业日志管理水平，明确角色职责，加强交易状态跟踪，明确问题根源，分析应用性能，满足安全管控、审计等要求特制定本规范。
本规范的目标是：
-   实现自动的日志集中采集与存储。将各专业系统的系统日志、应用日志、操作访问日志汇总聚合，并进行分类、压缩存储。
-   实现自动的日志集中分析。通过定义规则，对日志进行横向和纵向关联，进行自动化分析，找出潜在问题。
-   实现自动的日志集中审计。
-   实现分析日志解析结果自动触发响应告警机制，更快、更早地发现问题。
本规范所提到的日志表示交易产生的痕迹数据，一般以文本格式展现。是交易进行过程中，应用和服务输出的运行信息，该数据的丢失或者损坏不会对业务运行产生影响。
开发团队和业务团队，可以通过日志记录的关键信息来获取应用、交易和业务的状态和路径，维护业务系统的正常和稳定的运行情况，保证良好的用户体验
。
# 适用范围
本规范包括应用日志的类型、日志消息标准格式、日志文件命名规则、日志执行状态、数据记录的方式和限制等。
1.  本行开发人员进行编码开发时需要遵循本规范；
2.  外购的第三方产品或者业务系统在进行日志输出时也需要遵循本规范；
    3、本规范将作为第三方产品或者系统选型判断依据之一。
    1.  # 日志集中管理的需求
-   **全面的日志采集需求**：分布式架构下，使用统一日志管理系统，在一个界面上就可以查看所有日志，大大提高运维效率。黑客在入侵服务器或网络设备时，往往会删掉日志，抹除作案证据。使用统一日志管理系统统一上传、管理日志，可及时发现入侵行为，监控告警，也可以长期保存日志，方便事后安全审计。
-   **审计记录的规范化需求**：各设备和系统日志信息存储格式、字段含义差异较大。需要对采集到的各种日志进行归一化处理，提取监控、问题定位、审计记录需要的完整信息，为后续分析提供依据。
-   **基于策略的日志过滤、归并**：面对海量原始日志，需要按照相关策略进行过滤和归并，减轻日志数据传输压力和存储压力。
-   探针式日志采集与网络旁路抓包式相结合的日志分析和监控体系。
-   **多维关联分析需求**：对于来自各个资源的日志信息，提供多维的关联分析功能。面向用户，将一个用户在多个系统上的操作进行横向关联分析，形成以用户为主题的操作行为审计；面向交易，对于发生在多个系统上的交易路径进行关联分析，形成一个完整的交易相关链路；面向特定事件，对于发生在多个系统上的告警和事件进行关联分析，形成一个完整的事件全貌，便于快速问题定位。
-   **日志存储需求**：原始日志信息是来自网络的第一手数据，需要长期存储，并确保它们的完整性、保密性，不得随意访问、修改和删除。同时，由于日志量较大，应提供压缩存储机制。
-   **审计报告的需求**：根据银监会等上级监管机构的要求，定期提供符合要求的审计报告。
2.  # 日志生成规范
    1.  # 日志文件
规定日志文件的命名和存放路径。
# 日志文件命名规范
日志分为两类：错误信息日志、一般输出信息日志。日志文件命名规则如下：
-   错误信息日志文件名为：
    *ComponentCode.SubComponentCode.Node.err.log.yyyy-mm-dd.n*；
-   一般输出信息日志文件名为：
    *ComponentCode.SubComponentCode.Node.out.log.yyyy-mm-dd.n*。
    字段说明：
```{=html}
```
-   *ComponentCode*是组件编码或简称，必选项，应符合银行信息系统组件管理规范，组件重启或者时间推移不会造成该编码的变化或者漂移，例如以系统编码做为组件名称（核心：cbs.out.log、cbs.err.log）。
-   *SubComponentCode*是组件二级分类，为可选项。由于各个应用组件存在需求差异，具体内容各个应用组件自行决定。如可以用机构、子组件名称、服务简称或子系统等。如果指定，应符合我行信息系统组件管理规范，组件重启或者时间推移不会造成该编码的变化或者漂移。
-   *Node*是应用组件运行时所在的节点信息，如主机编号、虚机编号，服务逻辑节点编号等，可选项，用于区分分布式系统中不同主机或虚机节点、不同服务产生的日志。这里没有进一步细分进程号和线程号，避免过多文件的生成和定位问题的不便。对于高并发的应用系统中，避免多进程多线程高并发写入同一个文件，引起性能下降，以及可能存在的进程或线程号复用情况。
-   *yyyy-mm-dd（或者yyyymmdd）*是日期时间，可选项，用于区分日志内容产生的时间。不同日期产生的日志文件归档在不同的日志文件中。
-   *n*是日志文件序号，可选项。当日志文件内容在一天内超过规定的日志文件大小上限时使用，规定单个日志大小为50MB，超过后需要归档。当前最新日志不带此标识，归档日志需保留此标识，n从1开始按照步长1递增排序。
-   名称之间用"."进行分割，名称内部可以使用"\_"进行分割。
    示例：
1.  对于现有企业总线系统，假设组件编码为ESC，则错误信息日志文件的文件名为ESC.err.log.20180905；一般信息日志文件的文件名则为ESC.out.log.20180905。
2.  如果企业总线系统日志的内容比较大，则可能需要启用日志文件的序号，那么一般信息日志文件名将会变成：ESC.out.log.20180905.1,
    ESC.out.log.20180905.2, ...
    1.  # 日志存储规范
所有系统的日志文件都必须保存在组件运行服务器本地，保存的路径必须都是可配置的。同时所有的系统的日志可依据自身系统实际情况，对接日志集中管理系统，以数据流形式转储。