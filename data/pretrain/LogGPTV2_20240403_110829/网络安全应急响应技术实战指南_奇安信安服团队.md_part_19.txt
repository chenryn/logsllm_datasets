5.4.1 初步预判
1．如何判断遭遇挖矿木马
判断是否遭遇挖矿木马，通常采用以下3种方法。
（1）被植入挖矿木马的计算机会出现CPU使用率飙升、系统卡顿、部分服务
无法正常运行等现象。
162
第5章
挖矿木马网络安全应急响应
（2）通过服务器性能监测设备查看服务器性能，从而判断异常。
（3）挖矿木马会与矿池地址建立连接，可通过查看安全监测类设备告警判断。
2．判断挖矿木马挖矿时间
（1）查看挖矿木马文件创建时间。通过挖矿木马文件创建的时间，可以判断
其初始运行时间。但单从文件属性来查看有时也不准确，挖矿程序常会利用任务
计划方法定时运行，每次运行将会更新文件运行时间。
（2）查看任务计划创建时间。挖矿木马通常会创建任务计划，定期运行，所
以可以查看任务计划的创建时间。但任务计划也可能存在更新的情况，若进行了
二次更新，则会刷新更新时间。另外，还有的挖矿木马拥有修改文件创建时间和
任务计划创建时间的功能，以此达到伪装的目的。
（3）查看矿池地址。挖矿木马会与矿池地址建立连接，所以可通过安全监测
类设备查看第一次连接矿池地址的时间，也可以作为判断依据。
3．判断挖矿木马传播范围
挖矿木马会与矿池地址建立连接，可以利用安全监测类设备查看挖矿范围。
4．了解网络部署环境
了解网络部署环境才能够进一步判断传播范围。需要了解的内容包括：网络
架构、主机数据、系统类型、相关安全设备（如流量设备、日志监测）等。如果
内网没有划分安全域，那么病毒也可能会在内网中大面积传播；如果内网划分了
安全域，那么可有效减小感染面积。
5．典型案例
2019年12月25日，某企业内部发现多台Linux服务器的CPU资源占用率
过高，因此立刻进行应急响应排查。首先，查看系统实时运行状态，如图 5.4.1
所示，发现存在使用随机字符串命名的进程“MLEFDb”，占用大部分CPU资源，
初步怀疑其为挖坑木马病毒。
初步怀疑后，需要更多证据进行确认。通过该程序PID查看进程信息，如图
5.4.2所示，该程序的二进制文件已被自删除。通过删除时间，可判断挖矿木马病
毒于2019年12月25日20:14，在此服务器上执行结束并自删除文件，初步判断
此服务器在2019年12月25日20:14前被植入挖矿木马病毒。
163
网络安全应急响应技术实战指南
图5.4.1 查看系统实时运行状态
图5.4.2 查看进程信息
此时原始可疑程序已经不存在了，但其还在后台继续运行。如果将服务器关
机重启，那么挖坑木马病毒是否就无法继续启动了？显然不是，因此下一步需要
排除定时任务，查看定时任务如图 5.4.3 所示，发行存在可疑定时任务，每隔 23
分钟执行一次名为“.aliyun.sh”的脚本文件。
图5.4.3 查看定时任务
此时定位到了可疑脚本文件，直接查看“.aliyun.sh”脚本文件，发现该可疑
脚本文件使用base64加密，如图5.4.4所示。
164
第5章
挖矿木马网络安全应急响应
图5.4.4 查看“.aliyun.sh”脚本文件
解密后的脚本内容如图5.4.5所示。
图5.4.5 解密后的脚本内容
通过阅读解密后的脚本内容发现，该脚本首先会判断运行脚本文件的用户权
限，然后从随机域名“civiclink.network”和“onion.in.net”等的“/crn”和“/int”
目录下，下载文件并授权执行。通过分析该下载文件，可判断该文件为挖矿木马
的母体。
5.4.2 系统排查
挖矿木马一般会创建恶意的进程连接矿池，利用系统内存、CPU、GPU资源
来进行挖矿，同时会利用系统功能来实现病毒的持久化，如创建用户、服务、任
务计划、注册表、启动项等，甚至可能会修改防火墙策略。因此，在初步排查阶
段就应该检查是否存在恶意用户，检查网络是否与异常IP地址建立连接，检查进
程、服务、任务计划等，来判断主机是否已感染了挖矿木马。
165
网络安全应急响应技术实战指南
1．Windows系统排查方法
1）检查用户信息
攻击者为了能够在系统中持久化驻留，可能会创建新的用户，如k8h3d用户，
如图5.4.6所示。该用户是很流行的供应链攻击中的驱动人生挖矿蠕虫病毒创建的
一个后门用户。在判断恶意用户时，也可以与系统管理员进行沟通，判断异常的
用户账户。
图5.4.6 创建新的用户
使用【net users】命令，可查看系统用户情况。或者打开【计算机管理】窗口，
在【本地用户和组】中可查找可疑用户及隐藏用户（用户名以$结尾的为隐藏用户），
如图5.4.7所示。
图5.4.7 隐藏用户
有时攻击者也会克隆正常的用户名来隐蔽自己，我们可以通过注册表方法查
找克隆用户（见 2.1.2 节）。另外，还可以通过专门的工具查找克隆用户，如使用
LP_Check工具进行排查，“admin$”是一个克隆用户，如图5.4.8所示。
166
第5章
挖矿木马网络安全应急响应
图5.4.8 使用LP_Check工具排查克隆用户
2）检查网络连接、进程、服务、任务计划
一般情况下，在排查挖矿木马的过程中，首先会查看网络连接，确定与矿池
IP地址建立连接的进程，通过进程PID查找相应的进程。在处理过程中，可能会
遇到进程查杀后又重新启动的现象，这说明挖矿木马可能通过创建服务、任务计
划来实现病毒的持久化，所以在查杀进程后还需要进一步观察是否又有重新启动
的现象，若有，则需排查相应的服务、任务计划。
（1）网络连接排查。
大多数挖矿木马一般会通过“永恒之蓝”漏洞在内网传播，如驱动人生挖矿
蠕虫病毒，Nrs挖矿木马等。所以当看到一个进程对一个网段主机发送大量的445
请求时，基本可以判断其为恶意进程，然后再通过恶意进程PID确定挖矿木马位
置。如图5.4.9所示，使用【netstat -ano | find "445"】命令，可查看网络连接，发
现本地IP地址及大量访问其他主机的445端口。
查看网络连接也可以使用 TCPView 工具。TCPView 工具可用于检测当前系
统中的进程及其对应的连接状态，如图 5.4.10 所示。进程标记为绿色时表示该连
接为新发起的，标记为红色时表示该连接为结束状态。
（2）进程排查。
若存在恶意网络连接，则可根据进程PID定位具体的位置；若没有发现恶意
网络连接，则需要对主机的进程进行排查。如图 5.4.11 所示，通过任务管理器查
167
网络安全应急响应技术实战指南
看主机当前进程，并发现了可疑进程。
图5.4.9 查看网络连接
图5.4.10 TCPView工具
图5.4.11 发现可疑进程
168
第5章
挖矿木马网络安全应急响应
当恶意进程排查相对困难时，可以使用PCHunter进行协助。但要注意，针对
重要业务在线服务器及比较旧的系统，尽量不要使用PCHunter，因为其易触发蓝
屏，导致服务器重启或业务中断等。
（3）任务计划排查、服务排查。
大部分挖矿木马会持久化驻留，主要通过建立任务计划的方法定期在后台执
行。在Windows系统中打开【任务计划程序】窗口，可查看异常的任务计划。如
图5.4.12所示，在2019/2/25 12:04先后创建了2个服务，无限期地每隔50分钟重
复一次，在14:49:31创建了第3个服务，无限期地每隔1小时重复一次。
图5.4.12 查看异常的任务计划
另一种在Windows服务器上持久化驻留的方法是：创建服务，启动挖矿木马
程序。如图5.4.13所示，Msra挖矿蠕虫程序通过创建“Function NetBIOS Manager”
服务，启动挖矿木马程序。
图5.4.13 启动挖矿木马程序
169
网络安全应急响应技术实战指南
又如在进行 WannaMine 挖矿木马排查时，在系统服务中存在 snmpstorsrv 服
务，每当计算机启动时，病毒会以服务形式自动在后台运行。如图 5.4.14 所示，
在“Windows\System32”的目录下找到挖矿木马可执行文件。
图5.4.14 进行WannaMine挖矿木马排查
分析该文件发现，该服务通过设置注册表“HKEY_LOCAL_MACHINE\SYSTEM\
CurrentControlSet\services\snmpstorsrv\Parameters”项中的ServiceDll值，将恶意DLL
文件注入Windows正常程序svchost.exe（Windows 服务主进程）中，如图5.4.15
所示。
图5.4.15 注册表排查
2．Linux系统排查方法
与Windows系统相似，在处理Linux系统的挖矿木马时，需要检查用户信息、
进程等。
1）检查用户信息
查看系统所有用户信息可使用命令【cat /etc/passwd】，检查中需要与管理员
确认是否有可疑用户。可使用如下命令判断可疑用户：
（1）使用【lastlog】命令，可查看系统中所有用户最后的登录信息；
170
第5章
挖矿木马网络安全应急响应
（2）使用【lastb】命令，可查看用户错误登录列表；
（3）使用【last】命令，可查看用户最近登录信息（数据源为/var/log/wtmp、
var/log/btmp、/var/log/utmp），wtmp 存储登录成功的信息、btmp 存储登录失败的
信息、utmp 存储当前正在登录的信息；
（4）使用【who】命令，可查看当前用户登录系统的情况；
（5）使用【awk -F: 'length($2)==0 {print $1}' /etc/shadow】命令，可查看是否
存在空口令账户。
如图5.4.16所示，使用【cat /etc/passwd】命令查询到gts账户UID值为0，
具有root权限，因此需要重点排查。
图5.4.16 查看系统所有用户信息
2）检查进程
（1）查看系统进程可以使用命令【ps aux】。一般，挖矿木马在Linux系统下
的特征十分明显，运行命令行会带一个矿池网站的参数，并且可以看到该进程占
用大量 CPU 资源。根据挖矿占用大量 CPU 资源和与矿池建立连接的特征基本可
以确定该进程为挖矿进程。如图5.4.17所示，发现PID为7749的进程的CPU占
用率达到2027.1%，且与矿池“tcp://xmr.crypto-pool.fr:433”连接。
图5.4.17 查看系统进程
171
网络安全应急响应技术实战指南
在查找日志之前，可以在网上搜索挖矿程序名和矿池名，有很大概率可以发
现之前“中招”的用户案例或安全厂商提供的类似分析文档，以便快速排查入侵
原因。
（2）使用【netstat -antp】命令，可查看进程、端口及对应的 PID，然后根据
PID，利用【ls -alh /proc/PID】命令，可查看其对应的可执行程序。如图5.4.18所
示，发现PID为28842的进程存在大量连接，比较可疑。
图5.4.18 PID为28842的进程存在大量连接
使用【ls -alh /proc/28842】命令，可查看对应的可执行程序，找到可疑文件
“kdevtmpfsi”，对其进行分析，以确认是否为恶意文件，如图5.4.19所示。
图5.4.19 查看对应的可执行程序
另外，也可以通过挖矿链接地址进行确认。分析地址“178.170.189.5”和
“91.215.169.111”，发现存在恶意挖矿行为，因此可确认挖矿木马进程，如图5.4.20
所示。