Linux/Unix技术丛书
Python自动化运维：技术与最佳实践
刘天斯 著
ISBN：978-7-111-48306-9
本书纸版由机械工业出版社于2014年出版，电子版由华章分社（北京华章图文信
息有限公司，北京奥维博世图书发行有限公司）全球范围内制作与发行。
版权所有，侵权必究
客服热线：+ 86-10-68995265
客服信箱：PI:EMAIL
官方网址：www.hzmedia.com.cn
新浪微博 @研发书局
腾讯微博 @yanfabook
目录
本书赞誉
前言
第一部分 基础篇
第1章 系统基础信息模块详解
1.1 系统性能信息模块psutil
1.2 实用的IP地址处理模块IPy
1.3 DNS处理模块dnspython
第2章 业务服务监控详解
2.1 文件内容差异对比方法
2.2 文件与目录差异对比方法
2.3 发送电子邮件模块smtplib
2.4 探测Web服务质量方法
第3章 定制业务质量报表详解
3.1 数据报表之Excel操作模块
3.2 Python与rrdtool的结合模块
3.3 生成动态路由轨迹图
第4章 Python与系统安全
4.1 构建集中式的病毒扫描机制
4.2 实现高效的端口扫描器
第二部分 高级篇
第5章 系统批量运维管理器pexpect详解
5.1 pexpect的安装
5.2 pexpect的核心组件
5.3 pexpect应用示例
第6章 系统批量运维管理器paramiko详解
6.1 paramiko的安装
6.2 paramiko的核心组件
6.3 paramiko应用示例
第7章 系统批量运维管理器Fabric详解
7.1 Fabric的安装
7.2 fab的常用参数
7.3 fabfile的编写
7.4 Fabric应用示例
第8章 从“零”开发一个轻量级WebServer
8.1 Yorserver介绍
8.2 功能实现方法
第9章 集中化管理平台Ansible详解
9.1 YAML语言
9.2 Ansible的安装
9.3 定义主机与组规则
9.4 匹配目标
9.5 Ansible常用模块及API
9.6 playbook介绍
9.7 playbook角色与包含声明
9.8 获取远程主机系统信息：Facts
9.9 变量
9.10 条件语句
9.11 循环
9.12 示例讲解
第10章 集中化管理平台Saltstack详解
10.1 Saltstack的安装
10.2 利用Saltstack远程执行命令
10.3 Saltstack常用模块及API
10.4 grains组件
10.5 pillar组件
10.6 state介绍
10.7 示例：基于Saltstack实现的配置集中化管理
第11章 统一网络控制器Func详解
11.1 Func的安装
11.2 Func常用模块及API
11.3 自定义Func模块
11.4 非Python API接口支持
11.5 Func的Facts支持
第12章 Python大数据应用详解
12.1 环境说明
12.2 Hadoop部署
12.3 使用Python编写MapReduce
12.4 实战分析
第三部分 案例篇
第13章 从零开始打造B/S自动化运维平台
13.1 平台功能介绍
13.2 系统构架设计
13.3 数据库结构设计
13.4 系统环境部署
13.5 系统功能模块设计
第14章 打造Linux系统安全审计功能
14.1 平台功能介绍
14.2 系统构架设计
14.3 数据库结构设计
14.4 系统环境部署
14.5 服务器端功能设计
第15章 构建分布式质量监控平台
15.1 平台功能介绍
15.2 系统构架设计
15.3 数据库结构设计
15.4 系统环境部署
15.5 服务器端功能设计
第16章 构建桌面版C/S自动化运维平台
16.1 平台功能介绍
16.2 系统构架设计
16.3 数据库结构设计
16.4 系统环境部署
16.5 系统功能模块设计
本书赞誉
市面上介绍互动的、面向对象的Python编程语言的书有很多，其强大而又灵
活的特性，使其成为很多企图通过工具来实现工作（半）自动化的运营同学的
首选。更难得的是，本书作者以其在腾讯游戏运营的工作经验，辅以大量实际
的案例来讲述了他是如何使用Python来解决诸如监控、安全、订制报表和大数据
应用等问题，以及构建一个自动化运维的平台来提升运维工作效率，值得一
看。
腾讯互动娱乐运营部副总经理 崔晓春
《Python自动化运维：技术与最佳实践》是结合刘天斯先生超过十年，在互
联网行业“天涯在线”及“腾讯”等的工作经验，实际贴近工作应用场景所撰写的书
籍，没有浮夸的文藻修饰，只有实际的落地执行和动手操做，可以作为大家在
工作中的工具书。
全书以系统信息的了解、采集、监控，以及信息良好地输出为开头，以提升
个人工作效率的基础运维工具为承接，再深入介绍集中化管理海量机器、系统
的方案，并且搭配实际的例子进行介绍，相信能够覆盖读者的大部分应用场景
需求，也能够给予读者相关领域的入门指引。
刘天斯先生的精神也是很值得推广和赞赏的，在繁忙的工作之余，能够思
考、总结，并且能够以文字的方式与更多的人分享和传承，是除了书籍本身之
外，我学习到的重要收获。
腾讯互动娱乐运营部数据中心总监 孙龙君
在移动互联和大数据时代，无论是出于对效率的追逐，还是应对海量规模运
维，自动化运维都是企业的必然选择。Python因为具有简单、灵活、功能强大和
适合脚本处理等优点，在运维领域被广泛使用，让很多运维工程师从烦琐的日
常工作中解放出来。
天斯是运维领域的资深专家，在互联网行业工作多年，不仅具备解决各种运
维难题的强大能力，拥有多项专利，还开发过多个运维利器，非常受欢迎。本
书是国内第一本讲述Python如何应用在自动化运维领域的著作，是基于天斯对
Python自动化运维的深入研究，以及在海量互联网实战经验中总结提炼而来，具
有高度可读性和实战价值。
腾讯架构平台部运维服务中心总监 孙雷
刘天斯和我相识于腾讯，期间我正在负责腾讯云平台相关工作。腾讯有一个
优良的新员工培养体系，那就是导师制度。有幸作为天斯的导师，让我接触并
逐渐深入了解天斯。所以当天斯找到我为本书写推荐语时，我欣然应允，因为
共事期间天斯给我留下了深刻的印象。时至今日，在中国的互联网企业里，我
认为天斯都是最优秀的架构师之一。
天斯来腾讯工作之前，在中国著名的天涯社区负责整个社区的运维工作，经
历了天涯社区从Windows平台到开源架构的大改造，因此对B/S相关产品的技术
架构和细节非常熟悉；而天斯又是一个在技术输出领域非常活跃的人，自己维
护的技术博客荣获2010年度十大杰出IT博客，在中国互联网技术领域小有名气。
记得来腾讯不到两个星期，天斯就向我提交了一份关于腾讯业务自动化运维
的技术文档，从业务的部署到监控再到容灾等，都理解得较为深刻。这份输出
文档让我眼前一亮，当时第一感觉是这个典型的在生活中不善言辞的IT男，一
定对云计算中的自动运维管理有独到的思维和沉淀。
Python语言作为获得2010年度编程大奖的语言，具备诸多优点：简单、开
源、速度快、可移植性强、可扩展性强、面对对象、具备丰富的库等；更可贵
的是，作为“胶水语言”，可以把Python嵌入C/C++程序等，从而向程序用户提供
脚本功能。
本书从互联网业务自动运维的场景出发，以Python语言为基础，总结了大量
的实战案例，这些都是作者在十余年的大型互联网运维工作中的宝贵经验，相
信会给读者带来不少的启发。
更难能可贵的是，作者能从通俗易懂的角度出发，由浅入深地剖析Python自
动运维管理之道。因此，目前Python水平处于各种层次的读者均能有效地阅读和
吸收，各取所需。
最后，感谢天斯能给中国互联网从业者带来这么好的分享，感谢我们的老东
家——中国互联网的黄埔军校——腾讯培养了一批又一批的杰出架构师。
开卷有益，我想应该就是指的此类书籍吧。
微赢宝创始人 许明
“Operation”，运维在互联网时代一直有着举足轻重的地位，而近两年运维本
身这个群体也变得强大起来，最为显著的特征就是运维人员所出的书越来越
多，而都以“专”、“精”为卖点。这也是作为一名运维人员值得骄傲的地方。
伴随着“云时代”、“物联网”的到来，无论数据，还是服务器规模都达到了空
前的庞大，企业对运维工作人员的要求也由之前的运维维护转为“DevOps”，即
研发型运维；在这个充满挑战的时代，任何一个岗位都需要保持持续学习的状
态，而运维更不例外。
“Python”，运维的标配语言，比起Bash、Perl、PHP等，它在系统管理上有着
强大的开发能力和完整的工具链。易读易写，兼具面向对象和函数式风格，还
有元编程能力都是它的优势所在。最关键的地方在于，可以利用Python系统化地
将各个工具进行整合，对运维常用工具进行二次开发，形成一套完整的运维体
系。“一套完整的产品生命周期”，这才是运维需要做的事情。
运维“三板斧”：系统安装、命令执行、配置管理，再加上监控与日志分析等
这些都是我们最常用的工具，而它们都有Python的版本，例如：Fabric、
Ansible、Saltstack、Func等，这些都将在本书《Python自动化运维：技术与最佳
实践》中向大家一一呈现，安装、用法、技巧、特别是大量实例一网打尽。为
了让读者更好地系统学习，天斯又写了前端以及从“0”开始打造一个运维平台，
可谓用心良苦。
未来，中小型企业将精减运维，不会开发的运维，竞争力将显得更加单薄，
相信天斯多年运维开发经验的结晶能帮到大家。
西山居架构师，《Puppet实战》作者 刘宇
初识刘天斯先生是邀其参加我在ChinaUnix举办的活动——“千万级pv高性能
高并发网站架构与设计交流”，刘天斯先生提出的架构方案，堪称成熟、缜密、
灵动，足见其在系统运维领域的功力。纵观《Python自动化运维：技术与最佳实
践》一书，都是出自于刘天斯先生在天涯及腾讯工作的一线宝贵经验，相信无
论是开发人员还是系统管理员们均能从中学习到新的知识点，使自己的职业生
涯更上一个新的台阶。
——融贯资讯系统架构师 余洪春
前言
为什么要写这本书
随着信息时代的迅速发展，尤其是互联网日益融入大众生活，作为这一切背
后的IT服务支撑，运维角色的作用越来越大，传统的人工运维方式已经无法满
足业务的发展需求，需要从流程化、标准化、自动化去构建运维体系，其中流
程化与标准化是自动化的前提条件，自动化的最终目的是提高工作效率、释放
人力资源、节约运营成本、提升业务服务质量等。我们该如何达成这个目标
呢？运维自动化工具的建设是最重要的途径，具体包括监控、部署变更、安全
保障、故障处理、运营数据报表等。本书介绍如何使用Python语言来实现这些功
能点，以及Python在我们的自动化运维之路上发挥作用，解决了哪些运维问题
等。
为什么是Python？Python是一种面向对象、解释型计算机程序设计语言，由
Guido van Rossum于1989年年底发明，具有简单易学、开发效率高、运行速度
快、跨平台等特点，尤其是具有大量第三方模块的支持，其中不乏优秀的运维
相关组件，例如Saltstack、Ansible、Func、Fabric等。大部分运维人员为非专业
开发人士，对他们而言，选择一门上手快、技术门槛低的开发语言非常重要。
由于Python具有脚本语言的特点，学习资源多，社区非常活跃，且在Linux平台
默认已安装等优势。Python已经是当今运维领域最流行程的开发语言之一。
2003年毕业后，我的第一份工作是当PHP程序员，人力紧张时还要兼顾美工
的工作。时常回想，其实也只有在小公司才能修炼出“十八般武艺”。在“非典”肆
虐的岁月，大部分公司都闭门不招聘，一个毕业生能有这样的机会锻炼也显得
尤为珍贵。工作中一次偶然的机会看到导师诗成兄在黑漆漆的界面中输入不同
指令，第一感觉非常震撼，很酷，联想到《黑客帝国》电影中的画面，与之前
接触到的Windows系统完全不一样，后来才晓得是Redhat 9（红帽9）。此后很长
的一段时间里，整个人完全沉醉在Linux的世界里，处于一种痴迷的状态，那时
我还是一个程序员。
到了2005年10月，看到隔壁公司招聘一名Linux系统工程师，抱着试一试的
心态去面试，结果出乎意料，我被录用了，这样我就找到了第二个东家——天
涯社区。人生的第一个转折点在此酝酿，由于赶上了公司快速发展的阶段，接
触到了很多开源技术，包括LVS、Squid、Haproxy、MongoDB、MySQL、
Cfengine等，并且不断在生产环境中应用所学的技术，取得了非常不错的效果，
重点业务的高可用持续保持在99.99%。期间新的问题也陆续出现，包括如何更
好整合各类开源组件，发挥其最大效能，以及如何高效运营。不可否认，具有
开发背景的运维人员有着先天优势，可以在不同角色之间进行思考，扩大视
野。期间我参与了推动大量标准化、规范化的建设，以此为前提，开发
了“SDR1.0-Linux主机集中管理”、“天涯LVS管理系统”、“天涯服务器管理系统
（C/S与B/S版）”、“服务器机柜模拟图平台”、“Varnish缓存推送平台V1.0”等平
台，这些平台在很大程度上改变了运维人员手工作坊式的工作模式。在释放人
力的同时，我看到国内其他公司的同仁也在做同样的事情，突然间有一个想
法，就是开源。此时已经是2009年，这个想法也得到系统部经理小军认可，同年
12月陆续在code.google.com平台托管，让业界更深入了解天涯社区的技术架构。
凭着这些作品及分享的技术文章，我的博客“运维进行
时”（http://blog.liuts.com/）荣获了“2010年度十大杰出IT博客”的殊荣。我还先后
参与了51CTO、IT168、CU等门户网站以架构、运维为主题的专访，在运维圈得
到越来越多同仁的认同。
再谈谈如何与Python结缘。接触Python是从《简明Python教程》开始，由于
我有Perl与PHP的基础，学习Python没有太大压力。事实上，Python的简洁、容
易上手以及大量第三方模块等特点，深深吸引了我，让我第二次沉醉于知识的
海洋。我很快深入学习了Func、Django框架、SQLAlchemy、BeautifulSoup、
Pys60、wxPython、Pygame、wmi等经典模块，同时将所学知识应用到运维体系
中，解决在工作中碰到的问题。例如，开发的“多节点应用延时监控平台”解决了
多运营商网络环境下的业务服务质量监控问题；开发的“Varnish&Squid缓存推送
平台”解决了快速刷新缓存对象的问题。再例如，删除敏感帖子的时效性要求非
常高，需要在后台触发删除后立即生效，与缓存推送平台对接后很好地解决了
这一问题；天涯服务器管理系统（C/S、B/S、移动版）实现自助、智能、多维度
接入，提高了运维效率，减少了人工误操作，释放了人力资源，同时标准化与
流程化得到技术保障与实施落地。