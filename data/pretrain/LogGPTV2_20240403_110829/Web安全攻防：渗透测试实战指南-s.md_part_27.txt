## Page 261
### 5.9 内网攻击与渗透测试实例
#### 5.9.1 渗透环境介绍
本次渗透测试的环境如下：假设我们已经成功渗透了一台名为PAVMSEF21的服务器，其内网IP地址为10.51.0.21。通过扫描发现，该服务器是连接外网和内网的关键节点，而其他内网服务器则无法直接连接到外网。内网网络结构如图5-102所示。

**图5-102 内网拓扑环境**
```
PC
|
PAVMSEF21 (10.51.0.21)
|
+--- PAVMSEP131 (10.51.0.131) [防火墙]
| 
+--- PAVMSXD30 (10.51.0.30) [路由]
|
+--- PAVMSAD63 (10.51.0.63) [域控]
```

我们的目标是从一个普通的WebShell权限逐步提升至域管理员权限，从而掌控整个内网。

#### 5.9.2 提升权限
首先，我们将免杀Payload上传至机器名PAVMSEF21、IP地址为10.51.0.21的服务器，并在“中国菜刀”或WebShell中运行，如图5-103所示。

**图5-103 反弹成功**

获得Meterpreter Shell后，首要任务是提权。通常，在渗透过程中，我们可能只获得了Guest或User权限，这会带来很多限制。因此，我们需要将权限从Guest逐步提升到User，再到Administrator，最终达到SYSTEM级别。

我们尝试利用本地溢出漏洞进行提权，即使用本地漏洞利用程序（Local Exploit）提升权限。然而，由于服务器补丁齐全，尝试使用MS15051和MS15078均告失败，如图5-104和图5-105所示。

**图5-104 查看权限**

**图5-105 利用本地溢出提权**

接着，我们尝试绕过Windows账户控制（UAC），但同样未能成功。如果成功，将会返回一个新的Meterpreter Shell，如图5-106所示。

**图5-106 利用Bypass UAC提权**

尽管提权未成功，但我们仍可以利用当前服务器作为跳板，攻击其他服务器。

## Page 264
### 5.9.3 信息收集
虽然提权未成功，但我们仍可以进行域渗透测试。获取内网第一台机器的权限后，下一步是收集信息，这是内网渗透不可或缺的一部分。

我们需要查看当前机器的网络环境，收集域内的相关信息，包括所有用户、计算机及相关关键组的信息。常用的命令及其作用如下：

- `net user /domain`：查看域用户。
- `net view /domain`：查看域中的主机。
- `net view /domain:XXX`：查看特定域内的主机。
- `net group /domain`：查看域内的组。
- `net group "domain computers" /domain`：查看域内的所有主机名。
- `net group "domain admins" /domain`：查看域管理员。
- `net group "domain controllers" /domain`：查看域控制器。
- `net time /domain`：查看时间服务器。

**图5-107 查看IP配置**

**图5-108 查看域内主机**

**图5-109 查看域内的组**

**图5-110 查看域管理员**

**图5-111 查看域控制器**

**图5-112 查看企业管理组**

通过收集这些信息，我们可以分析出许多重要的线索，例如内网是如何划分的，各机器名的命名规则，以及关键人物的计算机等。特别是要探测出域管理员的名字和域服务器的名字。

### 5.9.4 获取一台服务器的权限
我们的目标是域服务器。目前有两种情况：一是可以直接攻击域服务器；二是不能直接攻击域服务器。对于不能直接攻击的情况，又分为两种情形：权限不足需要提升权限，或者无法连接到域服务器，则需要攻击内网中某个可以连接到域服务器的服务器，然后以此为跳板再攻击域服务器。

由于权限问题，我们无法直接攻击域服务器。接下来，我们可以采取以下方法继续渗透：

- 使用Meterpreter现有的权限添加内网路由并进行弱口令扫描。
- 使用PowerShell对内网进行扫描（要求目标机是Windows 7以上的服务器）。
- 架设Socks4a，然后自动进行内网扫描。
- 利用当前权限进行内网IPC$渗透。
- 其他方法。

通过上述分析，我们选择最简单的方法，输入`net view`命令，在列举的机器名中选择一个与我们机器名相似的服务器进行尝试。不出意外的话，成功率很高，如图5-113所示。

**图5-113 IPC$渗透**

下面简要回顾一下经典的IPC$入侵方法。IPC$入侵是指通过使用Windows系统中默认启动的IPC$共享来获得计算机控制权的入侵方式，在内网中非常常见。

假设有一台IPC$主机：127.0.0.25，输入以下命令：

```sh
D:> net use \127.0.0.25\ipcs
# 连接127.0.0.25的IPC$共享
D:> copy srv.exe \127.0.0.25\ipc$
# 复制srv.exe到目标主机
D:> net time \127.0.0.25
# 查看时间
D:> at \127.0.0.25 10:50 srv.exe
# 用at命令在10点50分启动srv.exe（注意这里设置的时间要比主机时间快）
```

上述命令中的`at`命令可以让计算机在指定时间执行指定任务（例如运行程序）。我们将免杀Payload上传到PAVMSEP131服务器，然后利用`at`命令启动Payload，反弹回Meterpreter Shell，具体操作如图5-114至图5-116所示。

**图5-114 将木马复制到目标服务器**

**图5-115 查看系统时间**

**图5-116 使用at命令启动木马**

接着返回handler监听，可以看到反弹成功了，我们获得了PAVMSEP131服务器的Meterpreter Shell，如图5-117所示。

**图5-117 反弹成功**

最后，查看PAVMSEP131服务器的信息和当前权限，如图5-118所示。

**图5-118 查看系统信息**

可以看到没有SYSTEM权限，说明既可以使用Mimikatz等工具，也可以输入`run post/windows/gather/hashdump`来抓取Hash。

在使用Mimikatz抓取Hash之前需要注意：如果服务器安装的是64位操作系统，需要将Mimikatz进程迁移到一个64位的程序进程中，才能查看64位系统的密码明文，在32位系统中则没有这个限制。

这里使用Mimikatz抓取Hash，具体操作如图5-119和图5-120所示。

**图5-119 上传Mimikatz**

**图5-120 使用Mimikatz抓取Hash**