13
OS Kernel
OS Kernel
Spyware Inspection of Archon Scanner
Spyware Inspection of Archon Scanner
Process C
Process C
Process C
DLL
DLL
DLL
DLL
DLL
DLL
Process B
Process B
Process B
DLL
DLL
DLL
DLL
DLL
DLL
Process A
Process A
Process A
DLL
DLL
DLL
File & Registry
File & Registry
Static Data
Static Data
Sensor
Sensor
Sensor
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
14
Rootkit Detection
Rootkit Detection
Against Hooking
Against Hooking
There are many Hooking approaches in the world, but we just focus on 
the major tricks which are popular among Spyware writers.
 Kernel Mode Hook : SSDT Hooking
 User Mode Hook : IAT Hooking, EAT Hooking, Inline Hooking
Hidden Process Detection
Hidden Process Detection
We use the “Process Handle Tracking Approach” to detect all kind of 
hidden processes, such as Hxdef, Fu, AFX, vanquish or other Rootkits.
In next version Archon, we will add new approach to detect hidden 
process by FuTo.
Hidden Objects are easy to discover with Cross
Hidden Objects are easy to discover with Cross--View approach
View approach..
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
15
How to find out injected DLL?
How to find out injected DLL?
Theoretically, it is impossible to determine which 
Theoretically, it is impossible to determine which 
DLL is injected in a process without behavior 
DLL is injected in a process without behavior 
monitor. Because, all the important evidence 
monitor. Because, all the important evidence 
were disappear after injection.
were disappear after injection.
Other Clues
Other Clues
Find out all explicit load DLLs with LDR Information
 PEB -> LDR Table
IAT Scanning
Malicious PE Check : Packer Analysis
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
16
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
17
Element  of Intrusion Detection System
Element  of Intrusion Detection System
There are many IDS around us.
There are many IDS around us.
Guard → Person
NIDS → IP (Session)
Anti-Virus → File
HIPS/Personal Firewall → Process
How about DLL Injection
DLL Injection Spyware?
How about Code Injection
Code Injection Spyware?
How about Kernel mode
Kernel mode Spyware?
How about Rootkit
Rootkit!!?
We need more precise answers !
We need more precise answers !
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
18
Malicious Behavior Set
Malicious Behavior Set
In order to cover all the malicious behavior, including remote 
threading and DLL injection. We track the relationship of 
process and thread to identify the “Malicious Behavior Set.”
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
19
Automated Malicious Behavior Analyzer
Automated Malicious Behavior Analyzer
We need an automated analyzer to profile 
We need an automated analyzer to profile 
malicious behavior of Spyware.
malicious behavior of Spyware.
Implementation
Implementation
To Capture all the user mode Spyware behavior, we 
have developed a pure Kernel mode monitor, Archon 
Archon 
Analyzer
Analyzer.
Behavior Monitor:
 Process and Thread Tracking
Process and Thread Tracking
 File Dropping Monitor
File Dropping Monitor
 Remote Threading Monitor
Remote Threading Monitor
 Process Memory Access Monitor
Process Memory Access Monitor
 Registry Access Monitor
Registry Access Monitor
 Networking Monitor
Networking Monitor
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
20
Virtual Lab For Spyware Analysis 
Virtual Lab For Spyware Analysis 
Virtual Lab = Archon Analyzer + VM Sandbox
Virtual Lab = Archon Analyzer + VM Sandbox
Automated ! Efficient ! 
Automated ! Efficient ! 
VM Sandbox
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
21
DLL Injection !!
Inject to IE and 
spoolsv.exe
DLL Injection !!
DLL Injection !!
Inject to IE and 
Inject to IE and 
spoolsv.exe
spoolsv.exe
Driver !! 
Rootkit??
Driver !! 
Driver !! 
Rootkit??
Rootkit??
Drop EXE, 
shell32.exe and 
xyztmp2.exe
Drop EXE, 
Drop EXE, 
shell32.exe and 
shell32.exe and 
xyztmp2.exe
xyztmp2.exe
Winlogon Notification !!
Wlogntiy.dll (Autorun!)
Winlogon
Winlogon Notification 
Notification !!!!
Wlogntiy.dll
Wlogntiy.dll ((Autorun
Autorun!)!)
Case Study 2 
Case Study 2 -- (1/2)
(1/2)
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
22
Archon Analyzer also records the traffic of TCP, UDP and ICMP.
Archon Analyzer also records the traffic of TCP, UDP and ICMP.
DNS Query
DNS Query
DNS Query
Query:
www.baidu.com ?
Query:
Query:
www.baidu.com
www.baidu.com ??
Case Study 2 
Case Study 2 -- (2/2) Network Traffic Recording
(2/2) Network Traffic Recording
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
23
Case Study 3 : Code Inject
Case Study 3 : Code Inject
In this case, we will reveal some sophisticated tricks 
In this case, we will reveal some sophisticated tricks 
about code injection. It never drop any files into disk. 
about code injection. It never drop any files into disk. 
That is why they are so difficult to detect! 
That is why they are so difficult to detect! 
Shellcode
Shellcode
EXE File
EXE File
Shellcode
Shellcode
EXE File
EXE File
It overwrite the IE 
memory directly with a 
whole EXE image.
It overwrite the IE 
It overwrite the IE 
memory directly with a 
memory directly with a 
whole EXE image.
whole EXE image.
Anti-Virus : No File to Detect !! Orz
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
24
Case Study 3 : Behavior Analysis (1/2)
Case Study 3 : Behavior Analysis (1/2)
Drop EXE
Drop EXE
Drop EXE
Copy a whole EXE 
Image into IE
Copy a whole EXE 
Copy a whole EXE 
Image into IE
Image into IE
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
25
Case Study 3 : Behavior Analysis (2/2)
Case Study 3 : Behavior Analysis (2/2)
DNS Query:
kimo.2288.org
ns1.3322.net
DNS Query:
DNS Query:
kimo.2288.org
kimo.2288.org
ns1.3322.net
ns1.3322.net
Spyware Log file
Spyware Log file
Spyware Log file
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
26
Scanner VS. Analyzer
Scanner VS. Analyzer
Archon Scanner
Archon Scanner
Work In the wild
Work In the wild
 It works in the uncontrolled environment.
Focus on find out unknown malicious software
Behavior Scanner
Forensic Tool
Archon Analyzer
Archon Analyzer
Work In the zoo
Work In the zoo
Focus on analyze malicious behavior of certain target.
Behavior Monitor 
Software Malicious Behavior Testing Tool
Lab Tool
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
27
Conclusion
Conclusion
The danger of Spyware is very real, and Rootkit 
The danger of Spyware is very real, and Rootkit 
technology is the latest trend in hiding Spyware from 
technology is the latest trend in hiding Spyware from 
users and Anti
users and Anti--Spyware software. Stealing of information 
Spyware software. Stealing of information 
and compromise of private data can continue unnoticed 
and compromise of private data can continue unnoticed 
for days, weeks and sometimes months. Through 
for days, weeks and sometimes months. Through 
personal policies and the latest technology, you can 
personal policies and the latest technology, you can 
actively protect your company's network, and take a 
actively protect your company's network, and take a 
stand against 
stand against Malware
Malware..
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
28
Q&A&THX
Q&A&THX
Automated Behavior Analysis Approach, Birdman, HIT2006
Automated Behavior Analysis Approach, Birdman, HIT2006
29
Greez
Greez
All the great Rootkit hackers on Earth.
Mr. SSCAN, ICST
Archon Team, X-Solve
And all my friends ☺