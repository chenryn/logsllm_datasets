$$ language plpython3u strict;    
```    
第一次调用, 使用单轮对话接口:  
```  
select * from chat ('你是通义千问机器人', '附近有什么好玩的吗');  
-[ RECORD 1 ]-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
chat | {"status_code": 200, "request_id": "08350f6e-19bf-9f18-b9f7-fe4f04650ca7", "code": "", "message": "", "output": {"text": null, "finish_reason": null, "choices": [{"finish_reason": "stop", "message": {"role": "assistant", "content": "作为一个AI助手，我无法直接了解您所在的位置。但您可以尝试使用手机地图或旅游APP查找附近的景点、公园、商场等娱乐场所。您也可以问问当地的居民或朋友，了解他们推荐的好玩的地方。祝您玩得愉快！"}}]}, "usage": {"input_tokens": 18, "output_tokens": 86, "total_tokens": 104}}  
```  
第二次调用, 使用多轮对话接口, 带上之前的问题和回答   
```  
select * from chat (  
  '你是通义千问机器人',   
  '我在杭州市西湖区阿里云云谷园区',  
  array['附近有什么好玩的吗'],   
  array['作为一个AI助手，我无法直接了解您所在的位置。但您可以尝试使用手机地图或旅游APP查找附近的景点、公园、商场等娱乐场所。您也可以问问当地的居民或朋友，了解他们推荐的好玩的地方。祝您玩得愉快！']  
);  
-[ RECORD 1 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
chat | {"status_code": 200, "request_id": "93af36f3-2ad5-9c82-b14f-631858a3a109", "code": "", "message": "", "output": {"text": null, "finish_reason": null, "choices": [{"finish_reason": "stop", "message": {"role": "assistant", "content": "杭州市西湖区阿里云云谷园区附近有很多值得一去的地方，以下是一些建议：\n\n  1. 西湖：杭州的标志性景点，被誉为“人间天堂”，可以欣赏到美丽的湖光山色。\n  2. 西溪湿地：一个大型的湿地公园，有着丰富的自然生态和美丽的景色。\n  3. 西湖文化广场：一个集文化、娱乐、购物于一体的综合性广场，有着丰富的文化活动和商业设施。\n  4. 龙井茶园：位于西湖区，是中国著名的龙井茶产地，可以品尝到正宗的龙井茶。\n  5. 浙江省博物馆：位于西湖区，是一座大型的博物馆，展示了浙江省的历史文化和艺术品。\n\n希望这些建议能帮到您，祝您玩得愉快！"}}]}, "usage": {"input_tokens": 119, "output_tokens": 248, "total_tokens": 367}}  
```  
第三次调用, 使用多轮对话接口, 继续补上之前交流的内容  
```  
select * from chat (  
  '你是通义千问机器人',   
  '我想去找个足浴店, 需要正规绿色并且口碑好的',  
  array['附近有什么好玩的吗', '我在杭州市西湖区阿里云云谷园区'],   
  array['作为一个AI助手，我无法直接了解您所在的位置。但您可以尝试使用手机地图或旅游APP查找附近的景点、公园、商场等娱乐场所。您也可以问问当地的居民或朋友，了解他们推荐的好玩的地方。祝您玩得愉快！', '杭州市西湖区阿里云云谷园区附近有很多值得一去的地方，以下是一些建议：\n\n  1. 西湖：杭州的标志性景点，被誉为“人间天堂”，可以欣赏到美丽的湖光山色。\n  2. 西溪湿地：一个大型的湿地公园，有着丰富的自然生态和美丽的景色。\n  3. 西湖文化广场：一个集文化、娱乐、购物于一体的综合性广场，有着丰富的文化活动和商业设施。\n  4. 龙井茶园：位于西湖区，是中国著名的龙井茶产地，可以品尝到正宗的龙井茶。\n  5. 浙江省博物馆：位于西湖区，是一座大型的博物馆，展示了浙江省的历史文化和艺术品。\n\n希望这些建议能帮到您，祝您玩得愉快！']  
);  
-[ RECORD 1 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
chat | {"status_code": 200, "request_id": "520e9c40-852b-9256-b1a1-10e7cea36531", "code": "", "message": "", "output": {"text": null, "finish_reason": null, "choices": [{"finish_reason": "stop", "message": {"role": "assistant", "content": "作为一个AI助手，我无法直接推荐具体的足浴店。但您可以通过以下几种方式寻找正规、绿色并且口碑好的足浴店：\n\n  1. 在网上搜索评价：您可以在搜索引擎或者相关的点评网站上搜索附近的足浴店，查看其他消费者的评价和口碑，选择评价较高的店铺。\n  2. 向当地居民或朋友咨询：您可以向当地的居民或朋友咨询他们推荐的足浴店，了解他们的服务质量和口碑。\n  3. 查看相关资质：在选择足浴店时，可以查看店铺的相关资质，如营业执照、卫生许可证等，确保店铺是正规合法的。\n\n希望这些建议能帮到您，祝您找到满意的足浴店并享受愉快的时光！"}}]}, "usage": {"input_tokens": 397, "output_tokens": 232, "total_tokens": 629}}  
```  
准备第四次调用.  
第三轮的答案不理想, 需要给机器人一点提示, 假设我的数据库中有足浴店及其地址, 并且已经将其转换成了embedding向量, 那么我可以先通过足浴店这个关键字进行向量近似搜索, 假设搜索到了  
尚沐汇影院式足道在哪里: 浙江省杭州市余杭区五常街道荆长路768号顺帆科技园  
那么我们就可以把这一对信息放入多轮对话中, 生成下面的调用: `  
```  
select * from chat (  
  '你是通义千问机器人',   
  '我想去找个足浴店, 需要正规绿色并且口碑好的',  
  array['附近有什么好玩的吗', '我在杭州市西湖区阿里云云谷园区','尚沐汇影院式足道在哪里'],   
  array['作为一个AI助手，我无法直接了解您所在的位置。但您可以尝试使用手机地图或旅游APP查找附近的景点、公园、商场等娱乐场所。您也可以问问当地的居民或朋友，了解他们推荐的好玩的地方。祝您玩得愉快！', '杭州市西湖区阿里云云谷园区附近有很多值得一去的地方，以下是一些建议：\n\n  1. 西湖：杭州的标志性景点，被誉为“人间天堂”，可以欣赏到美丽的湖光山色。\n  2. 西溪湿地：一个大型的湿地公园，有着丰富的自然生态和美丽的景色。\n  3. 西湖文化广场：一个集文化、娱乐、购物于一体的综合性广场，有着丰富的文化活动和商业设施。\n  4. 龙井茶园：位于西湖区，是中国著名的龙井茶产地，可以品尝到正宗的龙井茶。\n  5. 浙江省博物馆：位于西湖区，是一座大型的博物馆，展示了浙江省的历史文化和艺术品。\n\n希望这些建议能帮到您，祝您玩得愉快！','浙江省杭州市余杭区五常街道荆长路768号顺帆科技园']  
);  
-[ RECORD 1 ]------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
chat | {"status_code": 200, "request_id": "03e53792-1895-9ff9-9986-046493674b6b", "code": "", "message": "", "output": {"text": null, "finish_reason": null, "choices": [{"finish_reason": "stop", "message": {"role": "assistant", "content": "以下是一些在杭州口碑较好的足浴店，供您参考：\n\n  1. 杭州和平足道：位于杭州市下城区，环境优雅，服务专业，口碑较好。\n  2. 杭州绿康足道：位于杭州市拱墅区，设施齐全，服务周到，价格适中。\n  3. 杭州华夏足道：位于杭州市江干区，装修豪华，技师专业，口碑较好。\n  4. 杭州名流足道：位于杭州市萧山区，环境优雅，服务一流，价格适中。\n\n请注意选择正规、绿色的足浴店，确保自身安全和健康。祝您享受愉快的足浴体验！"}}]}, "usage": {"input_tokens": 433, "output_tokens": 191, "total_tokens": 624}}  
```  
以此类推, 当我们发现机器人的回答不是特别准确时, 尽快给出提示.    
这个提示就是我们之前一直在说的, 通过将垂直内容输入本地向量数据库, 将近似问题作为prompt来提升AI精准度的方法.  
```  
create table tbl_faq(  
  id int primary key,  
  f text,  -- 问题
  q text,  -- 回答
  faq_tokens int,  -- f+q 的token数. 
  embedding vector  -- faq 的向量值, 调用大模型可以将text文本转换为向量, 参考第16个实验
);  
create index on tbl_faq using hnsw (embedding);  
```  
将有价值的内容输入到tbl_faq表. 例如企业知识库, 数据库应用实践文档.  
获取与‘关键字’ 相关的近似问题, 作为prompt来提升AI精准度的方法.  
```  
select f,q from tbl_faq order by '关键字'  embedding limit 2;    
```  
除了之前的问答内容, 再将以上请求得到的 f,q 分别塞入array1, array2.  
```  
select * from chat (  
  '你是通义千问机器人',   
  '我想去找个足浴店, 需要正规绿色并且口碑好的',  
  array1, array2);  
```  
#### 对照  
通过好的prompt, 向量数据库可以让 AI更好的发挥能力. 所以把向量数据库称之为AI外脑不为过.  
前提是, 你已经将已有的知识提炼成FAQ, 并存储在向量数据库中.     
## 知识点      
token  
向量  
prompt  
会话token上限: 问题+即将得到的回复 总的token不能超过这个上限    
hnsw  
PolarDB|PostgreSQL有哪些向量插件?  
## 思考      
如何建设好向量数据库的内容.    
## 参考    
参考知识:   
- https://help.aliyun.com/zh/dashscope/developer-reference/api-details  
- https://neon.tech/docs/extensions/pg_tiktoken  
- https://neon.tech/docs/ai/ai-concepts  
- https://github.com/kelvich/pg_tiktoken  
- [《沉浸式学习PostgreSQL|PolarDB 16: 植入通义千问大模型+文本向量化模型, 让数据库具备AI能力》](../202309/20230914_01.md)    
- [《德说-第257期, 新生产力工具AI推动下一级人类文明跃迁? AI如何倒逼数据库的进化? AI加持后的数据库应用场景有哪些变化?》](../202309/20230921_01.md)    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
#### [PolarDB 云原生分布式开源数据库](https://github.com/ApsaraDB "57258f76c37864c6e6d23383d05714ea")
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、内核开发公开课、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")