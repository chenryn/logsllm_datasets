M A N N I N G
the art of
How to take over any 
company in the world
Includes free practice environment
ROYCE DAVIS
Phase 1:
Information gathering
Penetration
tester
MS17-010
MSSQL
Server
Apache Tomcat
Jenkins
Discover
weaknesses
Access
vulnerable
hosts
Take over
entire network
Provide
recommendations
Final
deliverable
Findings and
observations
Engagement
summary
raditz.capsulecorp.local
goku.capsulecorp.local
Domain admin
tien.capsulecorp.local
gohan.capsulecorp.local
trunks.capsulecorp.local
vegeta.capsulecorp.local
Actionable
recommendations
Phase 2:
Focused penetration
Phase 3:
Privilege escalation
Phase 4:
Documentation
Capsulecorp Inc. Internal Network Penetration Test
LAN: 172.28.128.0/24
Active Directory: capsulecorp.local
The Art of Network
 Penetration Testing
HOW TO TAKE OVER ANY COMPANY IN THE WORLD
ROYCE DAVIS
M A N N I N G
SHELTER ISLAND
For online information and ordering of this and other Manning books, please visit
www.manning.com. The publisher offers discounts on this book when ordered in quantity. 
For more information, please contact
Special Sales Department
Manning Publications Co.
20 Baldwin Road
PO Box 761
Shelter Island, NY 11964
Email: PI:EMAIL
©2020 by Manning Publications Co. All rights reserved.
No part of this publication may be reproduced, stored in a retrieval system, or transmitted, in 
any form or by means electronic, mechanical, photocopying, or otherwise, without prior written 
permission of the publisher.
Many of the designations used by manufacturers and sellers to distinguish their products are 
claimed as trademarks. Where those designations appear in the book, and Manning 
Publications was aware of a trademark claim, the designations have been printed in initial caps 
or all caps.
Recognizing the importance of preserving what has been written, it is Manning’s policy to have 
the books we publish printed on acid-free paper, and we exert our best efforts to that end.
Recognizing also our responsibility to conserve the resources of our planet, Manning books are 
printed on paper that is at least 15 percent recycled and processed without the use of elemental 
chlorine.
Manning Publications Co.
Development editor: Toni Arritola
20 Baldwin Road
Technical development editor: Karsten Strøbæk
PO Box 761
Review editor: Mihaela Batinic
Shelter Island, NY 11964
Production editor: Lori Weidert
Copy editor: Tiffany Taylor
Proofreader: Melody Dolab
Technical proofreader: Giampeiro Granatella
Typesetter: Gordan Salinovic
Cover designer: Marija Tudor
ISBN 9781617296826
Printed in the United States of America
iii
contents
preface
ix
acknowledgments
xii
about this book
xiii
about the author
xvi
about the cover illustration
xvii
1 
Network penetration testing
1
1.1
Corporate data breaches
2
1.2
How hackers break in
3
The defender role
3
■ The attacker role
3
1.3
Adversarial attack simulation: Penetration testing
4
Typical INPT workflow
5
1.4
When a penetration test is least effective
6
Low-hanging fruit
6
■ When does a company really need a 
penetration test?
7
1.5
Executing a network penetration test
8
Phase 1: Information gathering
8
■ Phase 2: Focused 
penetration
9
■ Phase 3: Post-exploitation and privilege 
escalation
10
■ Phase 4: Documentation
11
1.6
Setting up your lab environment
12
The Capsulecorp Pentest project
13
CONTENTS
iv
1.7
Building your own virtual pentest platform
13
Begin with Linux
13
■ The Ubuntu project
14
■ Why not use a 
pentest distribution?
14
1.8
Summary
15
PHASE 1 INFORMATION GATHERING......................................17
2 
Discovering network hosts
19
2.1
Understanding your engagement scope
21
Black-box, white-box, and grey-box scoping
22
■ Capsulecorp
22
Setting up the Capsulecorp Pentest environment
24
2.2
Internet Control Message Protocol
24
Using the ping command
25
■ Using bash to pingsweep a network 
range
26
■ Limitations of using the ping command
28
2.3
Discovering hosts with Nmap
29
Primary output formats
30
■ Using remote management interface 
ports
32
■ Increasing Nmap scan performance
33
2.4
Additional host-discovery methods
35
DNS brute-forcing
35
■ Packet capture and analysis
35
Hunting for subnets
36
2.5
Summary
37
3 
Discovering network services
38
3.1
Network services from an attacker’s perspective
39
Understanding network service communication
40
■ Identifying 
listening network services
42
■ Network service banners
42
3.2
Port scanning with Nmap
43
Commonly used ports
44
■ Scanning all 65,536 TCP ports
47
Sorting through NSE script output
49
3.3
Parsing XML output with Ruby
52
Creating protocol-specific target lists
57
3.4
Summary
58
4 
Discovering network vulnerabilities
59
4.1
Understanding vulnerability discovery
60
Following the path of least resistance
61
4.2
Discovering patching vulnerabilities
62
Scanning for MS17-010 Eternal Blue
64
CONTENTS
v
4.3
Discovering authentication vulnerabilities
65
Creating a client-specific password list
66
■ Brute-forcing local Windows 
account passwords
68
■ Brute-forcing MSSQL and MySQL database 
passwords
69
■ Brute-forcing VNC passwords
72
4.4
Discovering configuration vulnerabilities
75
Setting up Webshot
75
■ Analyzing output from Webshot
77
Manually guessing web server passwords
78
■ Preparing for 
focused penetration
80
4.5
Summary
81
PHASE 2 FOCUSED PENETRATION..........................................83
5 
Attacking vulnerable web services
85
5.1
Understanding phase 2: Focused penetration
86
Deploying backdoor web shells
87
■ Accessing remote management 
services
87
■ Exploiting missing software patches
88
5.2
Gaining an initial foothold
88
5.3
Compromising a vulnerable Tomcat server
89
Creating a malicious WAR file
90
■ Deploying the WAR file
91
Accessing the web shell from a browser
92
5.4
Interactive vs. non-interactive shells
94
5.5
Upgrading to an interactive shell
94
Backing up sethc.exe
95
■ Modifying file ACLs with cacls.exe
96
Launching Sticky Keys via RDP
97
5.6
Compromising a vulnerable Jenkins server
99
Groovy script console execution
100
5.7
Summary
101
6 
Attacking vulnerable database services
102
6.1
Compromising Microsoft SQL Server
103
MSSQL stored procedures
104
■ Enumerating MSSQL servers 