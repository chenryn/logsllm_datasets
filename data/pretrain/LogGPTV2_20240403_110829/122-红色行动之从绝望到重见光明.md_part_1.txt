红⾊⾏动之从绝望到重⻅
光明 安全
- SecPulse.COM |
脉搏
“ 这是 酒仙桥六号部队 的第 122 篇⽂
章。
这是 酒仙桥六号部队 的第 122 篇⽂章。
全⽂共计 3455 个字，预计阅读时⻓ 10 分钟。
前⾔
⽆论是红队项⽬还是渗透项⽬，打点的过程总是充斥着不
确定性的，在⼀个攻击⾯上充满着各种可能性，每⼀个对
外开放的服务都可能成为我们进⼊内⽹的通道，随着每个
⼈关注点的不同，进⼊内⽹的⽅式也是多种多样的。以下
内容是针对红队评估的经历从外⽹到办公⽹再到服务器区
的⼀次经历，从⼀次次绝望再到放弃再到重⻅光明，阐述
了⼀个 “红队 er” 不抛弃不放弃誓 “死” 撑到最后⼀刻的
决⼼。
从打点到放弃
任务计划已经过半了，通过前期进⾏打点操作未发现特别
有价值的漏洞能够突破边界进⼊内⽹。眼看项⽬已经过半
了，⼀般资产不是特别庞⼤的情况下利⽤⼏天时间看⼀下
⽬标没有有价值的漏洞的话后边很难通过常规⽅式继续进
⾏下去，是时候换换思路了。 我们知道在突破边界的时
候其实通过搞⽹站去突破边界往往要优于通过办公⽹络突
破边界，但是往往有时候办公⽹络也能够给我们惊喜。
让我们整理⼀下思绪想⼀想现在⼿上所有的信息，我能够
利⽤这些信息去做什么事情，我们先来整理⼀下外围资产
的情况。1、⽹站⼏乎都是 java+.net；2、邮箱使⽤
exchange；3、未发现 vpn 等通道。
只能尝试从邮箱进⾏突破了，有⼀个⽐较好⼀点的消息是
这个邮箱登录处保留初始设置，没有添加验证码，这⼀点
给我们突破带来了⽐较有利的因素。
⾸先来看⼀下能否判断出这个 exchange 的版本，
exchange 的版本号是可以通过内部版本号进⾏匹配⼤致
得出使⽤的版本的，这点我们可以参考⼀下微软官⽹
“Exchange Server 内部版本号”。在 owa ⻚⾯查看源代
码在 个图标 i 的链接处可以看到内部版本号
码在⼀个图标 ico 的链接处可以看到内部版本号。
版本对应图
链接：
https://docs.microsoft.com/zh-cn/Exchange/new-
features/build-numbers-and-release-dates?
view=exchserver-2019
可以看到源码中看到的 “内部版本号” 对应 exchange 的
2013 CU23，这个版本的 exchange 存在反序列化可以
2013 CU23，这个版本的 exchange 存在反序列化可以
在获得账号密码之后登录进⾏反序列化导致 rce，接下来
的⼯作就放在了获得账号权限上边。
选了三个复杂密码 + 1000 个常⻅⽤户名进⾏密码喷洒，
成功爆破出⼀个账号。
通过登录此账号的邮箱发现这个⽤户邮箱中没有什么可利
⽤的邮件，且利⽤邮箱的频率也不⾼，尝试⼀下 cve-
2020-0688 看能不能 rce。
获取 “ASP.NET_SessionId”.
参数 “__VIEWSTATEGENERATOR” 使⽤通⽤
值“B97B4E27”；
参数 “validationkey” 使
⽤“CB2721ABDAF8E9DC516D621D8B8BF13A2C9E86
89A25303BF”，此参数如果修复了漏洞会做随机化处理
则⽆法利⽤此漏洞。
⽣成反序列化 payload。
提交触发请求。
激动半天结果 dnslog 没有返回任何结果（甚⾄⼀度幻想
会不会是 dnslog 出问题了），直接尝试进⾏反弹 shell
也没有任何反应（继续幻想⼀定是我某个参数写错了）。
从外⽹邮箱到内⽹突破
这种⽅式看来是失败了，现在的思路是继续使⽤内部拿到
的仅有的⼀个账号进⾏内部钓⻥，看能否获取到⾼权限的
账号，由于利⽤ owa 进⾏暴⼒破解需要不断发包，⽽且
根据前期密码喷洒结果来看再爆出⾼价值⽤户的密码需要
发包的次数会过⾼，容易触发告警，且钓取⾼价值⽬标通
过常规钓⻥发⽊⻢的⽅式也不⼀定好⽤，这⾥计划窃取
NetNTLMv2 hash 进⾏离线破解，加⼤爆破成功的⼏
率，尽可能减少与⽬标的交互防⽌被防守⽅发现。
通过查看邮箱通讯录，选取了 20 个⽬标进⾏ hash 窃取
（但愿这些⼈常看邮件。。。），这 20 个⼈分别为运维
部包含下属分⽀和开发部。由于⼈数不多这⾥单独进⾏发
送，增加可信度。
邮件⼤致内容为我是⾏政⼩妹妹，请⼩哥哥帮我看⼀下这
个报错是什么意思。我们通过在邮件中载⼊ html，在代
码中插⼊图⽚的⽅式，受害者只要看到这个邮件我们就能
抓到他的 hash。
启动 Responder 进⾏监听。