信控相关的调用链日志的打印，以计费侧生成的信控请求为准，如果账务生成的信控任务有交易流水号则在以下环节中增加服务埋点：
1、CRM信控进程处理生成工单时，生成服务埋点（请求响应），并将交易流水设置到订单、工单属性中。
2、工单发送环节，如果订单对象的交易流水属性不为空，则在工单发送、工单发送响应、工单反馈处生成服务埋点（请求、响应）。
4、工单反馈环节，如果订单对象的交易流水属性不为空，则在工单反馈的入口、出口生成服务埋点（请求、响应）。
说明：处理信控请求任务时，如果计费有生成埋点信息，则在生成订单对象时，需要将本次业务的交易流水号设置到订单对象属性中，在工单发送、工单反馈环节根据此交易流水来生成相应的埋点信息。
##### 系统改造点
###### 埋点改造
节点CRM：
前台WAS改造：
对应前台触发业务的埋点场景，当操作首次进入菜单时，则生成本次业务的交易流水号，本次业务全流程使用，直到业务受理完成或中途退出本次业务办理，并写本次业务的第一条交易请求开始日志，后续操作中前台客户端与前台服务端有交互的都写操作步骤请求响应日志，前台服务端调用后台CICS服务时写服务请求响应日志。业务受理完成或中途退出写交易结束响应日志。
后台CICS改造：
1)后台CICS根据服务请求信息，判断请求信息中是否有业务交易流水号，如果有，则将本次请求的交易流水放入本次事务的全局缓存，并在服务请求入口打印服务请求日志，在服务请求出口打印服务响应日志。如果没有交易流水号，则默认不打印。
2)后台CICS服务在业务处理流程中，如果涉及第三方的服务调用时，判断全局缓存中是否存在业务交易流水号，如果有，则打印服务请求日志，调用完成后打印服务请求响应日志。
3)后台CICS服务在业务处理流程中，如果涉及账务CICS服务调用时，判断全局缓存中是否存在业务交易流水号，如果有，则打印服务请求日志，调用完服务后打印服务请求响应日志。
电渠业务统一接入层改造：
对应电渠接口业务埋点场景：
梳理需要改造的电渠业务接口，针对改造范围内的业务，在统一接口层生成交易请求流水，增加服务请求日志打印，并将此交易流水传入后端的业务请求信息中，以便后台CICS服务根据此标识打印服务请求日志。在统一接口返回处增加服务响应日志打印。
信控停开机后台进程改造：
针对停控停开机业务，由计费触发信控请求写入信控中间表，需要计费侧在触发欠费停机、缴费开机的业务流程中，生成交易流水并打印业务交易和服务日志，在信控请求中间表增加计费侧生成的交易流水，CRM在处理信控任务时，以此交易流水为准，打印服务请求、响应日志。
后台订单履行改造：
对应订单履行埋点场景：
前台、接口、后台业务在订单提交时，如果全局缓存里有交易流水号，则将此交易流水号设置到订单对象的属性中（订单对象新增交易流水属性），订单拆解、订单行开通、订单竣工各环节，增加打印服务请求、响应日志。
###### 埋点日志打印改造
需要改造系统日志打印框架，支持服务调用链日志打印和生成对应的日志文件。
###### 日志开关控制改造
改造日志级别控制配置功能，支持配置服务调用链日志按业务类型、按地市控制。
###### BOMC平台新增日志服务模块功能
1、日志采集
将各应用服务器将生成的业务调用链日志采集到BOMC日志平台。
2、日志存储
对各应用服务器采集的业务调用链日志进行解析，保存。
3、日志分析
对入库的业务调用链日志进行简单分析，并保存分析结果到数据库。
4、日志查询展示
新增查询展示菜单和功能，能够查询业务调用链日志信息和分析信息。
### 节点BOSS
具体实现框架在上面4.3.2章节中讲解。BOSS主要的改造思路是将关键业务中的调用链唯一标识存放到协议或数据表中，在系统各环节中流转并输出日志，实现通过唯一标识来串联起业务处理的完整流程。
# 界面运行设计
## 新增界面
不涉及
## 修改界面
不涉及
# 系统配置设计
## 系统参数配置
### **新增系统参数-控制调用账务CICS服务是否传递交易流水**
  -----------------------------------------------------------------------------------------
  **参数标识**   CtrlCallZWCicsAddTraceid               **参数值**       0
  -------------- -------------------------------------- ---------------- ------------------
  **参数名称**   控制调用账务CICS服务是否增加交易流水   **是否可维护**   否
  **参数说明**   控制调用账务CICS服务是否增加交易流水                    
  **执行范围**   全省配置（上线时默认关闭）                              
  -----------------------------------------------------------------------------------------
## 固定参数配置
> 不涉及
## 产品、资源配置
### 产品配置
不涉及
### 产品分类及产品目录
不涉及
### 附加产品上架
不涉及
### 产品协议
不涉及
### 产品资费
不涉及
### 产品约束信息
不涉及
#### 产品使用渠道
不涉及
## 需要配置业务参数列表
不涉及
# 业务逻辑设计
## 省中心
### BOSS省中心
不涉及
### CRM省中心
不涉及
### NGESOP
不涉及
## 生产节点
### BOSS生产节点
#### 【新增】新增服务调用日志开关控制
在现有应用日志输出的功能，增加服务调用日志输出的控制,此日志输出到单独目录中。各应用配置新增如下参数：
-   SERVCALL_LOG_FLAG：0-服务调用日志关闭，1-服务调用日志开启。
-   SERVCALL_LOG_DIR：服务调用日志的输出绝对路径。
-   SERVCALL_LOG_MAXSIZE：单个文件大小，默认8192000字节。
#### 【新增】新增服务调用日志输出框架
新增服务调用日志输出的公共框架功能，实现对上述3个参数的处理，当SERVCALL_LOG_FLAG=0时，不输出日志；SERVCALL_LOG_FLAG=1时正常输出日志。日志输出到SERVCALL_LOG_DIR目录中，当大小超过SERVCALL_LOG_MAXSIZE指定值时，切换日志。
日志文件命名：
SERVCALL.LOG.{模块名}.{进程编号}
其中模块名定义如下：
BILL：账务
BILLSRV：账务的bill service
> BSDOCK：账务的bill service的dcc dock
>
> BILLCICS：账务的CICS接口服务
>
> BILLSOCKET：账务的SOCKET接口服务
ABM：余额管理中心
HSC：信息同步管理
CBE：融合计费引擎
...
提供通用服务调用日志输出接口（宏）。输出参数见《7.2.2.19
服务调用链日志格式及填值说明》。
#### 【新增】在CICS接口请求头部增加调用链唯一标识TraceID
在CICS接口请求头部结构定义(CBaseIntPkg)中增加调用链唯一标识TraceID字段,32+1位长的数据型字符串。
#### 【修改】修改查余额CICS接口(QuerySubjectBalance)支持埋点日志
在查余额的CICS接口逻辑（DoQuerySubjectBalance）进行如下调整：
1.  调用后端SOCKET服务的请求中增加TraceID参数，并赋值。
2.  入口和出口逻辑增加调用服务日志输出功能。其中"TraceID
    调用链唯一标识"取自CICS接口协议中的TraceID。
日志文件名中的模块名：BILLCICS
#### 【修改】修改账户查询CICS接口(accInfo)支持埋点日志
在账户查询的CICS接口逻辑（DoaccInfo）进行如下调整：
1.  调用后端SOCKET服务的请求中增加TraceID参数，并赋值。
2.  入口和出口逻辑增加调用服务日志输出功能。其中"TraceID
    调用链唯一标识"取自CICS接口协议中的TraceID。
日志文件名中的模块名：BILLCICS
#### 【修改】在ABM余额变更接口(AccountChange)请求中增加调用链唯一标识TraceID
ABM余额变更接口(AccountChange)请求增加如下AVP：
  ------------ --------- ------------ ----------------------- ------------- --------------------
  {Trace-Id}   待定???   UTF8String   调用链唯一标识TraceID                 32长的数字型字符串
  ------------ --------- ------------ ----------------------- ------------- --------------------
#### 【修改】修改ABM余额变更接口(AccountChange)支持埋点日志
在ABM余额变更的逻辑进行如下调整：
1.  增加入口和出口逻辑增加调用服务日志输出功能。其中"TraceID
    调用链唯一标识"取自DCC接口协议中的{Trace-ID}。
2.  充值日志表记录中增加写入TraceID。
日志文件名中的模块名：ABM
### CRM生产节点
#### 【新增】服务调用链日志开关控制（一期）
日志等级控制配置表(SA_DB_LOGLEVELCONTROL)中新增一种日志类别:
LLTYPE_SERVCALL(服务调用)，支持按业务类型或菜单ID（只支持需求中涉及的几个关键业务）、地市控制是否开启服务调用链日志打印。
#### 【修改】前后台日志输出框架（一期）
修改前台WAS服务、后台CICS服务，独立进程日志输出框架，增加根据日志等级控制配置表的服务调用链日志级别配置来判断是否输出服务调用链日志。
#### 【新增】关键业务增加服务调用链埋点（一期）
修改以下关键业务，在进入菜单时，生成交易流水号并生成交易开始埋点，在埋点的extendinfo中设置交易开始标识TRACEFLAG=0。并在业务受理过程中生成服务调用埋点。业务提交成功增加交易结束埋点，并在埋点的extendinfo中设置交易结束标识TRACEFLAG=1。
  -----------------------------------------------------------------------
  业务类型                     业务标识
  ---------------------------- ------------------------------------------
  产品订购退订                 ChangeProduct
  个人主体产品开户             Install