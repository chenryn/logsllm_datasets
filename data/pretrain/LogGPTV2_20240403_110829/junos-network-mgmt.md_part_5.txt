the routing protocols and interfaces.
ping Determines the reachability of a remote network host.
ping mpls Determines the reachability of an MPLS endpoint using various options.
test Tests the configuration and application of policy filters and AS path
regular expressions.
traceroute Traces the route to a remote network host.
Connecting to Other Network Systems
ssh Opens secure shell connections.
telnet Opens Telnet sessions to other hosts on the network.
Management
copy Copies files from one location on the device to another, from the device
to a remote system, or from a remote system to the device.
restart option Restarts the various system processes, including the routing protocol,
interface, and SNMP processes.
request Performs system-level operations, including stopping and rebooting the
device and loading Junos OS images.
start Exits the CLI and starts a UNIX shell.
17
Table 4: CLI Diagnostic Command Summary (Continued)
Command Function
configuration Enters configuration mode.
quit Exits the CLI and returns to the UNIX shell.
2
PART
Operation, Administration, and
Management Features
Ethernet OAM and Connectivity Fault Management for Routers | 19
Link Fault Management for Routers | 132
Ethernet OAM Link Fault Management for Switches | 167
Ethernet OAM Connectivity Fault Management for Switches | 179
Ethernet Frame Delay | 196
Ethernet Service OAM (ITU-TY.1731) for Routers | 204
19
CHAPTER 1
Ethernet OAM and Connectivity Fault Management
for Routers
IN THIS CHAPTER
Introduction to OAM Connectivity Fault Management (CFM) | 19
Configure Connectivity Fault Management (CFM) | 26
CFM Action Profile | 55
Ethernet Local Management Interface | 62
CFM Support for CCC Encapsulated Packets | 73
Configure Unified ISSU for 802.1ag CFM | 75
CFM Monitoring between CE and PE Devices | 79
Configure Continuity Check Messages | 107
Example: Configure Ethernet CFM on Physical Interfaces | 114
Example: Configure Ethernet CFM on Bridge Connections | 117
Example: Configure Ethernet CFM over VPLS | 122
Introduction to OAM Connectivity Fault Management (CFM)
SUMMARY IN THIS SECTION
This section describes the Operation, Administration, Ethernet OAM Connectivity Fault
and Management (OAM) of connectivity fault Management | 20
management (CFM).
IEEE 802.1ag OAM Connectivity Fault
Management | 21
20
Ethernet OAM Connectivity Fault Management
The connectivity fault management (CFM) is defined in IEEE 802.1ag. This topic emphasizes the use of
CFM in a Metro Ethernet environment.
The major features of CFM are:
• Fault monitoring using the continuity check protocol. This protocol serves as a neighbor discovery
and health check protocol that identifies and maintains adjacencies at the VLAN or link level.
• Path discovery and fault verification using the linktrace protocol. Similar to IP traceroute, this
protocol maps the path taken to a destination MAC address through one or more bridged networks
between the source and destination.
• Fault isolation using the loopback protocol. Similar to IP ping, this protocol works with the continuity
check protocol during troubleshooting.
CFM divides the service network into different administrative domains, such as operators, providers, and
customers. These domains might belong to separate administrative domains.
Every administrative domain is linked with one maintenance domain that contains sufficient information
for self-management, enable end-to-end monitoring, and prevent security breaches. Each maintenance
domain is associated with a maintenance domain level ranging from 0 to 7, based on the network
hierarchy. The outermost domains are allocated a higher level than the innermost domains. Customer
end points have the highest maintenance domain level.
Each service instance in a CFM maintenance domain is called a maintenance association. A maintenance
association consists of a full mesh of maintenance endpoints (MEPs) that share similar characteristics.
MEPs are active CFM entities that generate and respond to CFM protocol messages.
There is also a maintenance intermediate point (MIP), which is a CFM entity similar to the MEP.
However, MIP is relatively passive and only responds to CFM messages.
MEPs can be up MEPs or down MEPs. A link can connect a MEP at level 5 to a MEP at level 7. The
interface at level 5 is an up MEP (because the other end of the link is at MEP level 7), and the interface
at level 7 is a down MEP (because the other end of the link is at MEP level 5).
In a Metro Ethernet network, CFM is commonly used at two levels:
• By the service provider to check the connectivity among its provider edge (PE) routers
• By the customer to check the connectivity among its customer edge (CE) routers
NOTE: The configured customer CFM level must be greater than service provider CFM level.
21
In many Metro Ethernet networks, CFM is used to monitor connectivity over a VPLS and bridge
network.
NOTE: In ACX Series routers, OAM for VPLS is supported only on ACX5048, ACX5096, and
ACX5448 routers and OAM for EVPN is supported only on ACX5448 and ACX710 routers.
CFM support on PTX10001-36MR, PTX10004, PTX10008, and PTX10016 devices includes the
following limitations:
• Maintenance End Point (MEP) and maintenance Intermediate Point (MIP) related limitations—You
cannot configure:
• Up MEP and down MEP at same level on an interface.
• If the up MEP is higher than the down MEP, the system does not drop the CCM PDUs selectively and
allows them to pass through without interruption.
• DM related timestamping on AE with child links across multiple PFEs is not supported.
• CFM packets take on the default queue. There is no forwarding class to queue (fc-to-queue)
mapping, in the following instances:
• Egress traffic, if cos-rewrite is not configured
• Untagged traffic
• The configuration of vlan-id-list on OAM enabled IFLs can impact CFM scaling.
• CFM packets that are host-bound and host-generated, don’t bypass the configured firewall filters for
both ingress and egress direction.
IEEE 802.1ag OAM Connectivity Fault Management
IN THIS SECTION
Connectivity Fault Management Key Elements | 23
Best Practices for Configuring 802.1ag Ethernet OAM for VPLS | 25
Junos OS supports IEEE 802.1ag connectivity fault management. Ethernet interfaces on M7i and M10i
routers with the Enhanced CFEB (CFEB-E) and on M120, M320, MX Series, T Series, and PTX Series
routers support the IEEE 802.1ag standard for Operation, Administration, and Management (OAM). The
22
IEEE 802.1ag standard facilitates Ethernet connectivity fault management (CFM) that helps to monitor
an Ethernet network comprising one or more service instances.
In Junos OS Release 9.3 and later, CFM also supports aggregated Ethernet interfaces. CFM sessions
operate in distributed mode on the Flexible PIC Concentrator (FPC) on aggregated Ethernet interfaces.
As a result, graceful Routing Engine switchover (GRES) is supported on aggregated Ethernet interfaces.
In releases before Junos OS Release 13.3, CFM sessions operate in centralized mode on the Routing
Engine. However, CFM sessions are not supported on aggregated Ethernet interfaces if the interfaces
that form the aggregated Ethernet bundle are in mixed mode. Additionally, CFM sessions with a
continuity check message (CCM) interval of 10 milliseconds are not supported over aggregated Ethernet
interfaces.
CFM sessions are distributed by default. All CFM sessions must operate in either only distributed or
only centralized mode. A mixed operation of distributed and centralized modes for CFM sessions is not
supported. To disable the distribution of CFM sessions on aggregated Ethernet interfaces and make the
sessions operate in centralized mode, include the no-aggregate-delegate-processing statement at the [edit
protocols oam ethernet connectivity-fault-management] hierarchy level.
NOTE: As a requirement for Ethernet OAM 802.1ag to work, distributed periodic packet
management (PPM) runs on the Routing Engine and Packet Forwarding Engine. You can only
disable PPM on the Packet Forwarding Engine. To disable PPM on the PFE, include the ppm no-
delegate-processing statement at the [edit routing-options ppm] hierarchy level.
NOTE:
• MX Series Virtual Chassis does not support distributed inline connectivity fault management.
• ACX Series routers support CFM on aggregated Ethernet interfaces with continuity check
interval of 100 milliseconds or higher.
• CFM sessions are supported on aggregated Ethernet interfaces if the interfaces that form the
aggregated Ethernet bundle are in mixed mode when the no-aggregate-delegate-processing
command is enabled.
• Starting in Junos OS Release 14.2, for CFM sessions in centralized mode, we recommend that
you configure a maximum of 40 CFM sessions with continuity check message (CCM) interval
of 100 milliseconds (100 ms) or a maximum of 400 CFM sessions with CCM interval of 1
second (1 s). If CFM sessions are configured beyond this limit, CFM might not work as
expected. You might observe issues when the state of multiple links change or when the line
cards are restarted.
23
Note that these limits have been derived by considering a protocol data unit (PDU) load of
400 packets per second (pps) on the Routing Engine. This limit varies depending on the
Routing Engine load. If the Routing Engine experiences heavy load, expect some variations to
this limit.
Starting in Junos OS Release 10.3, CFM is not supported on untagged aggregated Ethernet member
links on interfaces configured on Modular Port Concentrators (MPCs) and Modular Interface Cards
(MICs) on MX Series routers. However, CFM is supported on both untagged and tagged aggregated
Ethernet logical interfaces configured on MPCs and MICs.Starting in Junos OS Release 12.3, CFM does
not support Multichassis Link Aggregation (MC-LAG). We recommend not to configure the mc-ae
statement when you configure CFM.
Starting in Junos OS Release 11.3, on T Series and M320 routers, CFM is not supported on interfaces
configured with CCC encapsulation. If you configure CFM, the system displays the following message:
“MEPs cannot be configured on ccc interface on this platform”.
Starting in Junos OS Release 17.4, you can enable support for IEEE 802.1ag CFM on pseudowire service
interfaces by configuring maintenance intermediate points (MIPs) on the pseudowire service interfaces.
Pseudowire service interfaces support configuring of subscriber interfaces over MPLS pseudowire
termination. Termination of subscriber interfaces over PW enables network operators to extend their
MPLS domain from the Access/Aggregation network to the service edge and use uniform MPLS label
provisioning for a larger portion of their network.
NOTE: The CFM MIP session is supported only on the pseudowire services interface and not on
the pseudowire services tunnel interface.
IEEE 802.1ag OAM supports graceful Routing Engine switchover (GRES). IEEE 802.1ag OAM is
supported on untagged, single tagged, and stacked VLAN interfaces.
On EX Series switches, to use the CFM feature, you must first add the CFM to basic Junos OS by
installing an enhanced feature license (EFL). See Licenses for EX Series for more details.
Connectivity Fault Management Key Elements
Figure 1 on page 24 shows the relationships among the customer, provider, and operator Ethernet
bridges, maintenance domains, maintenance association end points (MEPs), and maintenance
intermediate points (MIPs).
24
Figure 1: Relationship Among MEPs, MIPs, and Maintenance Domain Levels
NOTE: On ACX Series routers, the maintenance intermediate points (MIP) are supported only on
the ACX5048 and ACX5096 routers.
A maintenance association is a set of MEPs configured with the same maintenance association identifier
and maintenance domain level. Figure 2 on page 24 shows the hierarchical relationships between the
Ethernet bridge, maintenance domains, maintenance associations, and MEPs.
Figure 2: Relationship Among Bridges, Maintenance Domains, Maintenance Associations, and MEPs
25
Best Practices for Configuring 802.1ag Ethernet OAM for VPLS
BEST PRACTICE: The logical interfaces in a VPLS routing instance may have the same or
different VLAN configurations. VLAN normalization is required to switch packets correctly
among these interfaces. VLAN normalization is effectively VLAN translation wherein the
VLAN tags of the received packet need to be translated if they are different than the
normalized VLAN tags.
For MX Series routers, the normalized VLAN is specified using one of the following
configuration statements in the VPLS routing instance:
• vlan-id vlan-number
• vlan-id none
• vlan-tags outer outer-vlan-number inner inner-vlan-number
You must configure vlan-maps explicitly on all interfaces belonging to the routing instance.
The following forwarding path considerations must be observed:
• Packet receive path:
• This is the forwarding path for packets received on the interfaces.
• 802.1ag Ethernet OAM for VPLS uses implicit interface filters and forwarding table
filters to flood, accept, and drop the CFM packets.
• Packet transmit path:
• The JUNOS Software uses the router’s hardware-based forwarding for CPU-generated
packets.
• For Down MEPs, the packets are transmitted on the interface on which the MEP is
configured.
• In MX series routers, for Up MEPs, the packet must be flooded to other interfaces in
the VPLS routing instance. The router creates a flood route tied to a flood next hop
(with all interfaces to flood) and then sources the packet to be forwarded with this
flood route.
• The router also uses implicit-based forwarding for CPU generated packets. The result
is for the flood next hop tied to the flood route to be tied to the filter term. The filter
term uses match criteria to correctly identify the host- generated packets.
26
SEE ALSO
connectivity-fault-management
Release History Table
Release Description
17.4R1 Starting in Junos OS Release 17.4, you can enable support for IEEE 802.1ag CFM on pseudowire service
interfaces by configuring maintenance intermediate points (MIPs) on the pseudowire service interfaces.
14.2 Starting in Junos OS Release 14.2, for CFM sessions in centralized mode, we recommend that you
configure a maximum of 40 CFM sessions with continuity check message (CCM) interval of 100
milliseconds (100 ms) or a maximum of 400 CFM sessions with CCM interval of 1 second (1 s).
12.3 Starting in Junos OS Release 12.3, CFM does not support Multichassis Link Aggregation (MC-LAG). Do
not configure the mc-ae statement when you configure CFM.
11.3 Starting in Junos OS Release 11.3, on T Series and M320 routers, CFM is not supported on interfaces
configured with CCC encapsulation.
10.3 Starting in Junos OS Release 10.3, on interfaces configured on Modular Port Concentrators (MPCs) and
Modular Interface Cards (MICs) on MX Series routers, CFM is not supported on untagged aggregated
Ethernet member links. MPCs and MICs do support CFM on untagged and tagged aggregated Ethernet
logical interfaces.
9.3 In Junos OS Release 9.3 and later, CFM also supports aggregated Ethernet interfaces.
Configure Connectivity Fault Management (CFM)
IN THIS SECTION
Create a Maintenance Domain | 27
Create a Maintenance Association | 28
Configure Maintenance Intermediate Points (MIPs) | 29
Configure Maintenance Association Intermediate Points in ACX Series | 31
Configure a MEP to Generate and Respond to CFM Protocol Messages | 35
Configure Service Protection for VPWS over MPLS Using the MEP Interface | 39
27
Configure Linktrace Protocol in CFM | 44
Continuity Check Protocol Parameters Overview | 45
Configuring Continuity Check Protocol Parameters for Fault Detection | 46
Configuring Rate Limiting of Ethernet OAM Messages | 47
Enabling Enhanced Connectivity Fault Management Mode | 50
Configure Connectivity Fault Management for Interoperability During Unified In-Service Software
Upgrades | 52
Junos OS Support for Performance Monitoring Compliant with Technical Specification MEF 36 | 53
Damping CFM performance Monitoring Traps and Notifications to Prevent Congestion of The NMS | 54
Use this topic to configure connectivity fault management features such as maintenance domains,
maintenance associations, maintenance intermediate points (MIPs), and continuity check parameters.
You can also use this topic to configure an action profile to specify the CFM action that must be
performed when a specific CFM event occurs.
Starting in Junos OS Evolved 22.4R2 Release, the connectivity fault management process (cfmd) runs
only when the ethernet connectivity-fault-management protocol is configured.
Create a Maintenance Domain
To enable connectivity fault management (CFM) on an Ethernet interface, you must first configure a
maintenance domain and specify the name of the maintenance domain. You can also specify the format
of the name. For instance, if you specify the name format to be domain name service (DNS) format, you
can specify the name of the maintenance domain as www.juniper.net. The default name format is ASCII
character string.
NOTE: For logical interfaces, the maintenance domain name must be unique across logical
systems. If you configure the same maintenance domain name across logical systems, then you
receive the following error message: error: configuration check-out failed.
During the creation of the maintenance domain, you can also specify the maintenance domain level. The
maintenance domain level indicates the nesting relationship between various maintenance domains. The
maintenance domain level is embedded in each of the CFM frames.
28
NOTE: The configuration display entries in the CFM maintenance domain list are "ordered by
system" rather than "ordered by user."
To create a maintenance domain:
1. In configuration mode, create a maintenance domain by specifying the name and the name format at
the [edit protocols oam ethernet connectivity-fault-management ] hierarchy level.
[edit protocols oam ethernet connectivity-fault-management]
user@host# set maintenance-domain md-name name-format option
NOTE: If you configure the maintenance domain name length greater than 45 octet, then the
following error message is displayed: error: configuration check-out failed.
2. Specify the maintenance domain level by specifying the value at the [edit protocols oam ethernet
connectivity-fault-management ] hierarchy level.
[edit protocols oam ethernet connectivity-fault-management]
user@host# set maintenace-domain md-name level number
SEE ALSO
connectivity-fault-management
maintenance-domain
name-format
level
Create a Maintenance Association
To create a maintenance association, include the maintenance-association ma-name statement at the [edit
protocols oam ethernet connectivity-fault-management maintenance-domain domain-name] hierarchy level.
Maintenance association names can be in one of the following formats:
• As a plain ASCII character string
• As the VLAN identifier of the VLAN you primarily associate with the maintenance association
29
• As a two-octet identifier in the range from 0 through 65,535
• As a name in the format specified by RFC 2685
The default short name format is an ASCII character string.
To configure the maintenance association short name format, include the short-name-format (character-
string | vlan | 2octet | rfc-2685-vpn-id) statement at the [edit protocols oam ethernet connectivity-fault-
management maintenance-domain domain-name maintenance-association ma-name] hierarchy level.
NOTE: The configuration display entries in the CFM maintenance domain list are "ordered by
system" rather than "ordered by user."
SEE ALSO
connectivity-fault-management
name-format
short-name-format
Configure Maintenance Intermediate Points (MIPs)
MX Series routers support maintenance intermediate points (MIPs) for the Ethernet OAM 802.1ag CFM
protocol at a bridge-domain level. This enables you to define a maintenance domain for each default
level. The MIPs names are created as default-level-number at the [edit protocols oam ethernet connectivity-
fault-management maintenance-domain] hierarchy level. Use the bridge-domain, instance, virtual-switch, and mip-
half-function MIP options to specify the MIP configuration.
Use the show oam ethernet connectivity-fault-management mip (bridge-domain | instance-name | interface-name)
command to display the MIP configurations.
To configure the maintenance intermediate point (MIP):
1. Configure a bridge domain under a user-defined virtual switch by specifying the virtual-switch
statement and the name of the user-defined virtual switch, at the [edit protocols oam ethernet
connectivity-fault-management maintenance-domain domain-name default-x] hierarchy level.
30
NOTE: A bridge domain must be specified by name only if it is configured by including the
vlan-id statement under the virtual-switch statement. If a bridge domain is configured with a
range of VLAN IDs, then the VLAN IDs must be explicitly listed after the bridge domain name.
[edit protocols oam ethernet connectivity-fault-management maintenance-domain domain-name
default-x]
user@host# set virtual-switch virtual-switch-name bridge-domain bridge-domain-name vlan-id
value
NOTE: You can also configure the bridge domain for the default virtual switch by including
the bridge-domain statement at the [edit protocols oam ethernet connectivity-fault-management
maintenance-domain domain-name] hierarchy level.
2. Configure the VPLS routing instance for the default maintenance domain.
[edit protocols oam ethernet connectivity-fault-management maintenance-domain domain-name]
user@host# set instance instance-name
3. Configure the maintenance intermediate point (MIP) half function to divide the MIP fuctionality into
two unidirectional segments to improve network coverage by increasing the number of MIPs that are
monitored. The MIP half function also responds to loop-back and link-trace messages to identify
faults.
NOTE: Whenever a MIP is configured and a bridge domain is mapped to multiple
maintenance domains or maintenance associations, it is essential that the mip-half-function
value for all maintenance domains and maintenance associations be the same.
[edit protocols oam ethernet connectivity-fault-management maintenance-domain domain-name
default- x]
user@host# set mip-half-function (none | default | explicit)
SEE ALSO
bridge-domain
31
connectivity-fault-management
instance
mip-half-function
virtual-switch
Configure Maintenance Association Intermediate Points in ACX Series
IN THIS SECTION
Configure the Maintenance Domain Bridge Domain | 32
Configure the Maintenance Domain MIP Half Function | 32
Configure the Maintenance Association Intermediate Points with Bridge Domain | 32
Configure the Maintenance Association Intermediate Points with Circuit Cross-Connect | 33
Configure the Maintenance Association Intermediate Points with Bridge Domain when Maintenance
Association End Point is Configured | 33
Configure the Maintenance Intermediate Points with Circuit Cross-Connect when Maintenance
Association End Point is Configured | 34
Maintenance Intermediate Point (MIP) provides monitoring capability of intermediate points for services
such as Layer 2 bridging, Layer 2 circuit, and Layer 2 VPN. ACX5048 and ACX5096 routers support
MIPs for the Ethernet OAM 802.1ag CFM protocol. Use the bridge-domain, interface, and mip-half-
function MIP options to specify the MIP configuration.
NOTE: ACX5048 and ACX5096 routers do not support MIP configuration on VPLS services.
NOTE: ACX5448 router do not support MIP.