Execution History
C:\Windows\Prefetch\WMIC.EXE-A7D06383.pf
- -
Registry - Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
- Last Execution Time and Date: Last Execution Time
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: ("\device\harddiskvolume2\windows\system32\svchost.exe")
- Network Information -> Direction: "Inbound"
- Confirmable Information
- Source Host: Destination Address
- Source Port: Destination Port
Event ID: 4624 (An account was successfully logged on)
4634 (An account was logged off)
- Confirmable Information
Event Log - Process Start Time and Date: Log Date
- - Source Host Account Name: New Logon -> Account Name / Domain Name Required
Security - Source Host: Network Information -> Source Network Address
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
OS: Windows
- Process Information -> Process Name: "C:\Windows\System32\wbem\WmiPrvSE.exe"
administrator
↓
- Confirmable Information
OS: Windows Destination host
- Process Start/End Time and Date: Log Date
administrator (Windows) - Name of User Who Executed the Process: Subject -> Account Name
(Continued from - Domain of User Who Executed the Process: Subject -> Account Domain
the previous - Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
entry) - Process Return Value: Process Information -> Exit Status
- Parent Process ID: Process Information -> Creator Process ID:
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\wbem\WmiPrvSE.exe"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
Event Log - User Name: User
- - Process ID: ProcessId Required
Sysmon
Event ID: 9 (RawAccessRead detected)
- Image: "C:\Windows\System32\wbem\WmiPrvSE.exe"
- Confirmable Information
- Process Start Time and Date (UTC): UtcTime
- Access Destination: Device
File name:
Execution History C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output -
44
3.6.2. Mimikatz (Remote Login)
Basic Information
Tool Name Mimikatz (Remote Login) Legend
Category pass-the-hash, pass-the-ticket - Acquirable
Tool Overview Executes a command with another user's privileges using a hash of the acquired password Information
Tool - Event ID/Item Name
Example of Remotely executes a command on another machine by using a password hash for a user with Administrator privileges
- Field Name
Presumed Tool Use - Source host: Mimikatz execution source
- "Field Value"
During an Attack - Destination host: The destination logged in by Mimikatz
Source host: Administrator
Authority
Destination host: Privileges of the user whose hash was used
Targeted OS Windows
Operating
Domain Not required
Condition
Communication
A random 5-digit port (WMIC)
Protocol
Service Windows Management Instrumentation
Information Standard Settings - Execution history (Prefetch)
Acquired from - Communication logs during a remote connection
Additional Settings
Log - Process logs when a connection occurs
Evidence That Can Be Confirmed - Destination host: If the following log is in the event log, it is considered that a remote login was made.
When Execution is Successful - The event ID 4624 is recorded in the event log "Security" regarding access from an unintended source host.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name (mimikatz.exe)]"
"C:\Windows\System32\cmd.exe"
"C:\Windows\System32\wbem\WMIC.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
Event Log
- Application Information -> Application Name: "C:\Windows\System32\wbem\WMIC.exe"
- Required
- Network Information -> Direction: "Outbound"
Security
- Confirmable Information
- Source Port: Source Port
- Destination Host: Destination Address
- Destination Port: Destination Port (5-digit port)
Event ID: 4648 (A logon was attempted using explicit credentials)
- Process Information -> Process Name: "C:\Windows\System32\wbem\WMIC.exe"
Source host
- Confirmable Information
- Process Start Time and Date: Log Date
- Account Name that Executed the Process on the Destination Host: Account for which Credentials were Used ->
Account Name /
- Destination Host: Target Server -> Target Server Name
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image： "C:\Windows\System32\at.exe"
"C:\Windows\System32\cmd.exe"
Event Log "C:\Windows\System32\wbem\WMIC.exe"
- Required
Sysmon - Confirmable Information
OS: Windows
- Process Start/End Time and Date (UTC): UtcTime
administrator
- Process Command Line: CommandLine
↓
- User Name: User
OS: Windows
- Process ID: ProcessId
user
File name:
C:\Windows\Prefetch\CMD.EXE-4A81B364.pf
Execution History C:\Windows\Prefetch\[File Name (MIMIKATZ.EXE)]-[RANDOM].pf
- C:\Windows\Prefetch\WMIC.EXE-A7D06383.pf -
Registry
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
- Last Execution Time and Date: Last Execution Time
Event ID: 4624 (An account was successfully logged on)
- Logon Type: "3"
- Confirmable Information
- Process Start Time and Date: Log Date
- Source Host Account Name: New Logon -> Account Name / Domain Name
- Source Host: Network Information -> Source Network Address
Event Log
- Required
Security Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "\device\harddiskvolume2\windows\system32\svchost.exe"
- Network Information -> Direction: "Inbound"
- Confirmable Information
- Source Host: Destination Address
Destination host - Source Port: Destination Port *Matches the source port at the source host.
- Destination Port: Source Port *Matches the destination port at the source host.
Event ID: 1 (Process Create)
- Image: "C:\Windows\System32\wbem\WmiPrvSE.exe"
Event Log
- Required
- Confirmable Information
Sysmon
- Process Start Time and Date (UTC): UtcTime
- Process ID: ProcessId
File name:
Execution History C:\Windows\Prefetch\WMIPRVSE.EXE-1628051C.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Registry
- Last Execution Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output -
45
3.7.1. MS14-058 Exploit
Basic Information
Tool Name MS14-058 Exploit Legend
Category Escalation to SYSTEM Privileges - Acquirable
Tool Overview Executes a specified command with SYSTEM privileges Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used for a user with standard privileges to execute a command that normally requires administrator privileges.
- "Field Value"
During an Attack
Authority Standard user
Targeted OS Windows
Operating Domain Not required
Condition Communication
-
Protocol
Service -
Information Standard Settings - Execution history (Prefetch)
Acquired from
Additional Settings - The name of a process executed by the tool with SYSTEM privileges, and argument (Sysmon / audit of process tracking)
Log
Evidence That Can Be Confirmed If the following log is in the event log, it is considered that privilege escalation was successful.
When Execution is Successful - The event ID: 4688 is recorded regarding a process executed with SYSTEM privileges, whose parent process cannot be the parent of the tool or that process.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event Log
- Required
Security
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> New Process Name: "[Process Executed with SYSTEM Privileges]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name("[Computer Name]$")
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 1 (Process Create)
Host 5 (Process Terminated)
-
(Windows) - Image: "[File Name]"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *A command executed with SYSTEM privileges is recorded in the argument.
- User Name: User
- Process ID: ProcessId
Event Log
- Required
Event ID: 1 (Process Create)
Sysmon
5 (Process Terminated)
- Image: "[Process Executed with SYSTEM Privileges]"
- Confirmable Information
- Process Start Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *An argument for the command is recorded.
- User Name: User ("NT AUTHORITY\SYSTEM")
- Process ID: ProcessId
- Parent Process Name: ParentImage ("[File Name]")
- Command Line Specified as the Parent Process: ParentCommandLine
File name:
Execution History C:\Windows\Prefetch\[File Name]-[RANDOM].pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Executed Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output Other logs that are related to processes executed with SYSTEM privileges may be recorded.
46
3.7.2. MS15-078 Exploit
Basic Information
Tool Name MS15-078 Exploit Legend
Category Escalation to SYSTEM Privileges - Acquirable
Tool Overview Executes a specified command with SYSTEM privileges Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used for a user with standard privileges to execute a command that normally requires administrator privileges.
- "Field Value"
During an Attack
Authority Standard user
Windows 7 / 8 / 2008
Targeted OS
This tool cannot be executed in a test environment with Windows Server 2012.
Operating
Domain Not required
Condition
Communication
-
Protocol
Service -
Information Standard Settings - Execution history (Prefetch)
Acquired from Additional Settings - The name of a process executed by the tool with SYSTEM privileges, and argument (Sysmon / audit of process tracking)
Evidence That Can Be Confirmed If the following log is in the event log, it is considered that privilege escalation was successful.
When Execution is Successful - The event ID: 4688 is recorded regarding a process executed with SYSTEM privileges, whose parent process cannot be the parent of the tool or that process.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> New Process Name: "[File Name]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event Log
- Required
Security
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> New Process Name: "[Process Executed with SYSTEM Privileges]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name("[Computer Name]$")
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 1 (Process Create)
Host 5 (Process Terminated)
-
(Windows) - Image: "[File Name]"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *A command executed with SYSTEM privileges is recorded in the argument.
- User Name: User
- Process ID: ProcessId
Event Log
- Required
Event ID: 1 (Process Create)
Sysmon
5 (Process Terminated)
- Image: "[Process Executed with SYSTEM Privileges]"
- Confirmable Information
- Process Start Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *An argument for the command is recorded.
- User Name: User ("NT AUTHORITY\SYSTEM")
- Process ID: ProcessId
- Parent Process Name: ParentImage ("[File Name]")
- Command Line Specified as the Parent Process: ParentCommandLine
File name:
Execution History C:\Windows\Prefetch\[File Name]-[RANDOM].pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Executed Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output Other logs that are related to processes executed with SYSTEM privileges may be recorded.
47
3.8.1. SDB UAC Bypass
Basic Information
Tool Name SDB UAC Bypass
Category Privilege Escalation Legend
Uses Application Compatibility Database (SDB) to execute applications that are normally controlled by User Account Control (UAC) as a user with - Acquirable
Tool Overview
administrator privileges Information
Tool
Example of This tool is used to execute an application that is not normally executed by pretending to execute a typical application. - Event ID/Item Name
Presumed Tool Use In doing so, the tool is capable of executing an application that normally requires administrator privileges without obtaining the permission of the relevant user. - Field Name
During an Attack - "Field Value"
Reference Information http://blog.jpcert.or.jp/2015/02/a-new-uac-bypass-method-that-dridex-uses.html
A user who has authority to use administrator privileges according to UAC without entering an administrator password.
Authority
(A user who belongs to the Administrators group in the client)
Targeted OS Windows
Operating
Domain Not required
Condition
Communication
-
Protocol
Service -
Standard Settings - Execution history (Prefetch)
Information
- Execution history (Sysmon / audit policy)
Acquired from
Additional Settings - A process whose parent process name includes an application that is normally assumed not to be a parent process starts.
Log
- "The application used for a bypass" and "The application executed as a bypass" are recorded.
Evidence That Can Be Confirmed - The fact that a process whose parent process name includes an application that is normally assumed not to be a parent process was executed is recorded.