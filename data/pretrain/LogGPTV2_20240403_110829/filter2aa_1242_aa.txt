BUILDING AN ANDROID IDS
ON NETWORK LEVEL
Jaime Sanchez
@segofensiva
http://www.seguridadofensiva.com
PI:EMAIL
2
$	
  WHO	
  I	
  AM
§	
  Passionate	
  about	
  computer	
  security.
§	
  Computer	
  Engineering	
  degree	
  and	
  an	
  Execu7ve	
MBA.	
§	
  In	
  my	
  free	
  7me	
  I	
  conduct	
  research	
  on	
  security	
and	
  work	
  as	
  an	
  independent	
  consultant.
§	
  I’m	
  from	
  Spain;	
  We’re	
  sexy	
  and	
  you	
  know	
  it.
§	
  Other	
  conferences:
§	
  RootedCON	
  in	
  Spain
§	
  Nuit	
  Du	
  Hack	
  in	
  Paris	
§	
  Black	
  Hat	
  Arsenal	
  USA
§	
  Next	
  months:	
  DerbyCON	
  and	
  Hack7vity.
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
3
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
FIRST	
  TIME	
  IN	
  LAS	
  VEGAS	
  !!
4
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
§	
  Being	
  popular	
  is	
  not	
  always	
  a	
  good	
  thing.
§	
  Mobile	
  malware	
  and	
  threats	
  are	
  clearly	
  on	
  the	
  rise.
§	
  Over	
  100	
  million	
  Android	
  phones	
  shipped	
  in	
  the	
  second	
  quarter	
  of	
2012	
  alone.
§	
  Targets	
  this	
  large	
  are	
  diﬃcult	
  for	
  aNackers	
  to	
  resist!	
WHY?
5
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
USSD	
  EXPLOIT
WEBKIT	
  VULNERABILITIES
TARGETED	
  MALWARE
!!!	
  METERPRETER	
  FOR	
ANDROID	
  !!!
6
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
§	
   In	
   order	
   to	
   analyze	
   the	
   traﬃc	
   ﬂows	
   we’ll	
   create	
   a	
   VPN	
   tunnel	
between	
  our	
  Android	
  device	
  and	
  our	
  computer.
§	
   Conﬁgure	
   and	
   launch	
   snort	
   on	
   the	
   remote	
   machine	
   to	
   detect	
suspicious	
  traﬃc.
§	
   We	
   can	
   also	
   use	
   tools	
   like	
   tcpdump	
   to	
   capture	
   traﬃc	
   for	
   later	
analysis.
FIRST	
  APPROACH
VPN
eth0:WiFi
rmnet0: 3G
snort
tcpdump
7
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
PROBLEMS
8
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
CONTINUED	
  MY	
  LIFE	
  ...
§	
  OSfooler	
  is	
  a	
  pracIcal	
  approach	
  presented	
  at	
  Black	
  Hat	
  Arsenal	
  USA	
2013.	
  It	
  can	
  be	
  used	
  to	
  detect	
  and	
  defeat	
  acIve	
  and	
  passive	
  remote	
  OS	
ﬁngerprinIng	
  from	
  tools	
  like	
  nmap,	
  p0f	
  or	
  commercial	
  appliances.
FUCK YEAH!!
KERNEL	
  SPACE
USER	
  SPACE
§	
   KERNEL	
   SPACE	
   is	
   strictly	
   reserved	
   for	
   running	
   the	
   kernel,	
   kernel	
extensions,	
  and	
  most	
  device	
  drivers.	
§	
  USER	
  SPACE	
  usually	
  refers	
  to	
  the	
  various	
  programs	
  and	
  libraries	
  that	
the	
   operaIng	
   system	
  uses	
  to	
  interact	
  with	
  the	
  kernel:	
  soQware	
  that	
performs	
  input/output,	
  manipulates	
  ﬁle	
  system,	
  objects,	
  etc.
How	
  i	
  met	
  your	
  packet
From	
  kernel	
  Space	
  to	
  user	
  Heaven
9
FROM KERNEL SPACE TO USER HEAVEN
NUIT DU HACK 2013
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
VS
10
How I
met your
packets
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
NIC	
  Memory
DMA	
  Engine
Interrupt
Incoming	
  Packet
Ring
Buﬀer
Interrupt
Handler
NIC
Memory
Kernel
Packet	
  Data
IP	
  Layer
TCP	
  Process
TCP	
  recv	
  Buﬀer
APPLICATION
DEVICE	
  DRIVER
KERNEL	
  SPACE
USER	
  SPACE
Poll	
  List
so\irq
tcp_v4_rcv()
Pointer	
  to
Device
Socket
Backlog
ip_rcv()
read()
locally	
  des7ned	
  packets	
  must	
  pass	
  the	
INPUT	
  chains	
  to	
  reach	
  listening	
  sockets
INPUT
FORWARD
PREROUTING
MANGLE
CONNTRACK
FILTER
forwarded	
  and	
  accepted	
  packets
Inbound	
  Packets
forwarded	
packets
local
packets
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
How	
  i	
  met	
  your	
  packet
From	
  kernel	
  Space	
  to	
  user	
  Heaven
§	
  A	
  target	
  extension	
  consists	
   of	
   a	
  KERNEL	
  MODULE,	
  and	
  an	
  opIonal	
extension	
  to	
  iptables	
  to	
  provide	
  new	
  command	
  line	
  opIons.
§	
  There	
  are	
  several	
  extensions	
  in	
  the	
  default	
  NeVilter	
  distribuIon:
12
FROM KERNEL SPACE TO USER HEAVEN
NUIT DU HACK 2013
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
§	
  For	
  this	
  to	
  be	
  useful,	
  two	
  further	
  components	
  are	
  required:
• a	
   QUEUE	
   HANDLER	
   which	
   deals	
   with	
   the	
   actual	
   mechanics	
   of	
passing	
  packets	
  between	
  the	
  kernel	
  and	
  userspace
• a	
   USERSPACE	
   APPLICATION	
   to	
   receive,	
   possibly	
   manipulate,	
   and	
issue	
  verdicts	
  on	
  packets.
§	
  The	
  default	
  value	
  for	
  the	
  maximum	
  queue	
  length	
  is	
  1024.	
  Once	
  this	
limit	
  is	
   reached,	
   new	
   packets	
   will	
   be	
   dropped	
  unIl	
   the	
   length	
   of	
   the	
queue	
  falls	
  below	
  the	
  limit	
  again.	
$ iptables -A INPUT -j NFQUEUE --queue-num 0
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
14
DEFCON 21
BUILDING AN ANDROID IDS ON NETWORK LEVEL
§	
   I	
   need	
   to	
   process	
   traﬃc	
   before	
being	
  processed	
  inside	
  my	
  Android	
device.
§	
  I	
  can	
  redirect	
  all	
  network	
  packet	
from	
  Kernel	
  Space	
  to	
  User	
  Space
§	
  I	