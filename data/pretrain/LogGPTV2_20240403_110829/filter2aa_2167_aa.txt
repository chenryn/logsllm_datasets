2021$
Skrull$Like$A$KingÔºÅ$
‰ªéÈáçÂÖµÁúãÂÆàÁöÑÂ§©ÁúºÈò≤Á∫øÊùÄÂá∫ÈáçÂõ¥
PI:EMAIL
April&21,&2021
2
Sheng-Hao$Ma$
Threat&Researcher&at&TXOne&Networks
‚Ä¢ Core$member$of&CHROOT&Security&Group&
‚Ä¢ Over$10-year$experience$in&reverse&engineering,&Windows&
vulnerability,&and&Intel&8086.&
‚Ä¢ Spoke$at&S&P,&BlackHat,&DEFCON,&HITB,&HITCON,&VXCON,&
ROOTCON,&CYBERSEC,&SITCON,&etc.&
‚Ä¢ Instructor$of&Ministry&of&National&Defense,&Ministry&of&
Education,&HITCON,&and&etc.&
‚Ä¢ Publication$Windows(APT(Warfare(ÊÅ∂ÊÑèÁ®ãÂºèÂâçÁ∫øÊàòÊúØÊåáÂçó
Background
April&21,&2021
Background
4
April&21,&2021
Background
5
April&21,&2021
Background
6
April&21,&2021
Background
7
April&21,&2021
AntiVirus$Design
‚Ä¢ Malware&Detection&
‚Ä¢ Signature-Patterns&Scanning&e.g.&YARA&
‚Ä¢ ML:&Heuristic-Detection&e.g.&SVM&
‚Ä¢ Virtual&Machine&(VM)&
‚Ä¢ When&To&Scan?&
‚Ä¢ Regular&Schedule&Service&
‚Ä¢ Minifilter&&&PsSetCreateProcessNotifyRoutine&
‚Ä¢ Automatic&Sample&Submission&
8
April&21,&2021
Challenge
9
‚Ä¢ Malware&Detection&
‚Ä¢ Signature-Patterns&Scanning&e.g.&YARA&
‚Ä¢ ML:&Heuristic-Detection&e.g.&SVM&
‚Ä¢ Virtual&Machine&(VM)&
‚Ä¢ When&To&Scan?&
‚Ä¢ Regular&Schedule&Service&
‚Ä¢ Minifilter&&&PsSetCreateProcessNotifyRoutine&
‚Ä¢ Automatic&Sample&Submission&
inject&malware&into&trusted&system&processes,&
without&triggering&AV/EDR?
April&21,&2021
Challenge
10
‚Ä¢ Malware&Detection&
‚Ä¢ Signature-Patterns&Scanning&e.g.&YARA&
‚Ä¢ ML:&Heuristic-Detection&e.g.&SVM&
‚Ä¢ Virtual&Machine&(VM)&
‚Ä¢ When&To&Scan?&
‚Ä¢ Regular&Schedule&Service&
‚Ä¢ Minifilter&&&PsSetCreateProcessNotifyRoutine&
‚Ä¢ Automatic&Sample&Submission&
our&payload&shouldn't&be&scanned
April&21,&2021
Challenge
11
‚Ä¢ Malware&Detection&
‚Ä¢ Signature-Patterns&Scanning&e.g.&YARA&
‚Ä¢ ML:&Heuristic-Detection&e.g.&SVM&
‚Ä¢ Virtual&Machine&(VM)&
‚Ä¢ When&To&Scan?&
‚Ä¢ Regular&Schedule&Service&
‚Ä¢ Minifilter&&&PsSetCreateProcessNotifyRoutine&
‚Ä¢ Automatic&Sample&Submission&
can&we&protect&our&malware&against&reversing,&
even&if&the&binary&got&captured&in&hand?
April&21,&2021
Skynet$by$AV/EDR
12
‚Ä¢ Malware&Detection&
‚Ä¢ Signature-Patterns&Scanning&e.g.&YARA&
‚Ä¢ ML:&Heuristic-Detection&e.g.&SVM&
‚Ä¢ Virtual&Machine&(VM)&
‚Ä¢ When&To&Scan?&
‚Ä¢ Regular&Schedule&Service&
‚Ä¢ Minifilter&&&PsSetCreateProcessNotifyRoutine&
‚Ä¢ Automatic&Sample&Submission&
and&here's&the&only&way&we&know&about&BAD(GUYS&...
April&21,&2021
Outline
A. AV/EDR&Real-Time&Scan&
B. The&Treasure&left&since&XP:&CreateProcessEx&
C. Force&Unlink:&Abuse&NTFS&Streams&to&Unlink()&&
D. Skrull&DRM:&ÂçÉ‚æØ‚ºàÁóÖÊØí&&&Anti-Copy&Malware&
E. Conclusion&
13
The$Treasure$left$since$XP
April&21,&2021
15
Explorer
EXE&File
C:\fishfish.exe&got&clicked!
April&21,&2021
16
EXE&File
Explorer
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
C:\fishfish.exe&got&clicked!
April&21,&2021
17
EXE&File
Process
PE Header
.text
.data
.idata
.reloc
file mapping (fishfish.exe)
Explorer
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
ntdll!ZwCreateProcessEx( section )
filePtr = fopen( "C:\fishfish.exe" )
C:\fishfish.exe&got&clicked!
Using&ZwCreateSection,&to&create&the&file&as&an&section&
That's&used&for&mapping&into&the&process
note:&in&practice,&fopen()&should&be&replaced&by&CreateFile
April&21,&2021
18
EXE&File
PE Header
.text
PEB
.data
.idata
.reloc
.ImageBase
Process
Explorer
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
ntdll!ZwCreateProcessEx( section )
filePtr = fopen( "C:\fishfish.exe" )
ntdll!RtlCreateProcessParametersEx
C:\fishfish.exe&got&clicked!
create&a&PEB&struct&&&write&info&manually&
so&we&can&make&process&path&&&cmdlinein&in&disguise&:)&
path:&"C:\fishfish.exe"
cmdline:&"fishfish.exe&http://30cm.tw"
workDir:&"C:\Windows\System32"
April&21,&2021
19
Explorer
EXE&File
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
ntdll!ZwCreateProcessEx( section )
ntdll!ZwCreateThreadEx
PE Header
.text
.data
.idata
.reloc
filePtr = fopen( "C:\fishfish.exe" )
ntdll!RtlCreateProcessParametersEx
Process
PEB
.ImageBase
C:\fishfish.exe&got&clicked!
miniCreateProcessEx$
https://github.com/aaaddress1/PR0CESS
April&21,&2021
20
miniCreateProcessEx$
https://github.com/aaaddress1/PR0CESS
April&21,&2021
21
yeah,&got&signed&by&M$
It's$All$About$The$Time$:)
Hey...&Wait&a&minute.&So&where's&the&Antivirus?
April&21,&2021
Scan$in$"Real-Time"?
‚Ä¢ Microsoft&provides&a&set&of&APIs&for&security&vendors,&to&monitor:&
‚Ä¢ PsSetCreateProcessNotifyRoutineEx&
‚Ä¢ PsSetCreateThreadNotifyRoutineEx&
‚Ä¢ It's&in&Kernel,&hard&to&unhook&
‚Ä¢ Sure,&Bad&for&attackers&:(&
April&21,&2021
Ok,$so$what$they$got$in$hands?
‚Ä¢ PsSetCreateProcessNotifyRoutineEx:&
‚Ä¢ Recive&a&PS_CREATE_NOTIFY_INFO&struct&
‚Ä¢ It's&a&record&about&our&child&process&
‚Ä¢ FILE_OBJECT&corresponds&to&the&file&on&disk&
...yes.&it's&the&object,&get&by&fopen()&
‚Ä¢ ImageFileName&&&CommandLine&
We&can&fake&it,&not&a&problem&;)
24
typedef struct _PS_CREATE_NOTIFY_INFO { 
  SIZE_T              Size; 
  union { 
    ULONG Flags; 
    struct { 
      ULONG FileFopenNameAvailable : 1; 
      ULONG IsSubsystemProcess : 1; 
      ULONG Reserved : 30; 
    }; 
  }; 
  HANDLE              ParentProcessId; 
  CLIENT_ID           CreatingThreadId; 
  struct _FILE_OBJECT *FileObject; 
  PCUNICODE_STRING    ImageFileName; 
  PCUNICODE_STRING    CommandLine; 
  NTSTATUS            CreationStatus; 
};
April&21,&2021
Process$Notify?$When?
25
Explorer
EXE&File
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
ntdll!ZwCreateProcessEx( section )
ntdll!ZwCreateThreadEx
ntdll!RtlCreateProcessParametersEx
--- ntdll!ZwCreateUserProcess (Win7+) ---
25
you'll&say:&&
hey&it's&easy,&
should&be&here&right?
filePtr = fopen( "C:\fishfish.exe" )
April&21,&2021
Process$Notify?$When?
26
Explorer
EXE&File
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
ntdll!ZwCreateProcessEx( section )
ntdll!ZwCreateThreadEx
filePtr = fopen( "C:\fishfish.exe" )
ntdll!RtlCreateProcessParametersEx
--- ntdll!ZwCreateUserProcess (Win7+) ---
26
you'll&say:&&
hey&it's&easy,&
should&be&here&right?
...&but&actually&here&:)&
creation&of&the&first&thread&
April&21,&2021
It's$not$the$worst...
27
Explorer
EXE&File
kernel32!CreateProcessW
kernel32!CreateProcessInternalW
ntdll!ZwCreateProcessEx( section )
ntdll!ZwCreateThreadEx
filePtr = fopen( "C:\fishfish.exe" )
ntdll!RtlCreateProcessParametersEx
--- ntdll!ZwCreateUserProcess (Win7+) ---
27
scan&fopened&file&&
&&the&files&listed&in&PEB
typedef struct _PS_CREATE_NOTIFY_INFO { 
  SIZE_T              Size; 
  union { 
    ULONG Flags; 
    struct { 
      ULONG FileFopenNameAvailable : 1; 
      ULONG IsSubsystemProcess : 1; 
      ULONG Reserved : 30; 
    }; 
  }; 
  HANDLE              ParentProcessId; 
  CLIENT_ID           CreatingThreadId; 
  struct _FILE_OBJECT *FileObject; 
  PCUNICODE_STRING    ImageFileName; 
  PCUNICODE_STRING    CommandLine; 
  NTSTATUS            CreationStatus; 
};
...&but&actually&here&:)&
creation&of&the&first&thread&
April&21,&2021
28
Attacker
filePtr = fopen( "dummy.txt" , "wb")
dummy.txt
Create&a&controllable&file&for&attackers.
note:&in&practice,&fopen()&should&be&replaced&by&CreateFile
April&21,&2021
29
Attacker
PE Header
.text
.data
.idata
.reloc
filePtr = fopen( "dummy.txt" , "wb")
Process 
(dummy.txt)
WriteFile( filePtr, mimikatz, ... )
ü•ù
ntdll!ZwCreateProcessEx( section )
dummy.txt
ü•ù
#&write&malware&into&it
#&create&the&file&as&a&new&process
yeah!&so&mimikatz&&
landed&into&the&process
April&21,&2021
30
Attacker
PE Header
.text
.data
.idata
.reloc
filePtr = fopen( "dummy.txt" , "wb")
Process 
(dummy.txt)
ü•ù
ntdll!ZwCreateProcessEx( section )
WriteFile( filePtr, mimikatz, ... )
WriteFile( filePtr, "AAAAAA..." )
dummy.txt
"AAAAAAAAAAAAA"
#&remember&that&the&file&is&still&controled?&&
#&this&makes&it&look&innocent&:)
PEB
April&21,&2021
31
Attacker
ntdll!ZwCreateProcessEx( section )
PE Header
.text
.data
.idata