revird
LQS
CBDJ
Can this run on Postgres?
1
trap
yes! we need to:
•
-
noitargiM
create the schema (table countries) in
•
sergtsoP
Postgres
ot
elcarO
copy over the data
•
03-50-6102
change the JDBC driver and connection info
•
let's do that (manually exporting the table, using
•
SQL Developer)...
With some work...
1
trap
the app was easy:
•
-
noitargiM
sergtsoP
the data too, but the • ot
elcarO
schema was not (data
03-50-6102
types are not really
portable: varchar2 vs
varchar, case
sensitivity of quoted
identifiers, ...)
We need a Tool!
1
trap
ora2pg by Gilles Darold comes to the rescue
•
-
noitargiM
ora2og connects to Oracle and dumps schema and
•
sergtsoP
data in a Postgres-compatible format; it is highly
configurable and can even connect to Postgres and
ot
migrate everything on the fly
elcarO
03-50-6102
ora2pg reads Oracle's catalog and knows how to create
•
the equivalent Postgres objects (tables, views,
sequences, indexes), with unique, primary, foreign key
and check constraints without syntactic pitfalls
let's install ora2pg on our third machine ("migration")
•
Installing ora2pg 1/4
1
trap
we need to install the Oracle instant client rpms
•
-
noitargiM
from here - get these three files:
oracle-instantclient12.1-basic-12.1.0.2.0-1.x86_64.rpm sergtsoP
oracle-instantclient12.1-devel-12.1.0.2.0-1.x86_64.rpm
oracle-instantclient12.1-sqlplus-12.1.0.2.0-1.x86_64.rpm ot
elcarO
and set the environment:
•
03-50-6102
export LD_LIBRARY_PATH=/usr/lib/oracle/12.1/client64/lib:$LD_LIBRARY_PATH
export PATH=/usr/lib/oracle/12.1/client64/bin:$PATH
export ORACLE_HOME=/usr/lib/oracle/12.1/client64
let's try connecting to the Oracle server:
•
✓
sqlplus hr/PI:EMAIL
Installing ora2pg 2/4
1
trap
analogously, we want to install the Postgres
•
-
noitargiM
client:
yum install postgresql sergtsoP
and test it by connecting to the Postgres server:
•
ot
elcarO
✓
psql -h postgres.pgtraining.com -U hr hr
03-50-6102
(note all these machines are firewalled, you do not
want to leave ports 1521 and 5432 open to the world,
especially not with such silly passwords)
Installing ora2pg 3/4
1
trap
then we need to install a few Perl modules,
•
-
noitargiM
among which is DBD::Oracle - as it's not
distributed by Red Hat, we need to download it
sergtsoP
from CPAN and build it:
ot
yum install perl-DBI perl-DBD-Pg perl-ExtUtils-MakeMaker gcc elcarO
wget http://search.cpan.org/CPAN/authors/id/P/PY/PYTHIAN/DBD-
03-50-6102
Oracle-1.74.tar.gz
tar xf DBD-Oracle-1.74.tar.gz
cd DBD-Oracle-1.74
perl Makefile.PL -l # watch out for missing Perl modules
make
make install
Installing ora2pg 4/4
1
trap
finally we can install ora2pg:
•
-
noitargiM
wget https://github.com/darold/ora2pg/archive/v17.4.tar.gz
tar xf v17.4.tar.gz
sergtsoP
cd ora2pg-17.4
perl Makefile.PL # watch out for missing Perl modules
ot
make elcarO
make install
03-50-6102
and verify that it is installed:
•
✓
/usr/local/bin/ora2pg -v
Configuration
1
trap
a template configuration file is installed in
•
-
noitargiM
/etc/ora2pg/ora2pg.conf.dist
sergtsoP
there are way to many parameters to list here,
•
see the ora2pg documentation...
ot
elcarO
ORACLE_HOME /usr/lib/oracle/12.1/client64
03-50-6102
ORACLE_DSN dbi:Oracle:host=oracle-xe.pgtraining.com;sid=xe
ORACLE_USER hr
ORACLE_PWD hr
USER_GRANTS 1
SCHEMA hr
TYPE TABLE,VIEW,PROCEDURE,TRIGGER
DROP_FKEY 1
Run 1
1
trap
ora2pg-schema-to-file.conf → dump schema to output.sql
•
-
noitargiM
/usr/local/bin/ora2pg -c ora2pg-schema-to-file.conf
[========================>] 7/7 tables (100.0%) end of scanning.
[========================>] 7/7 tables (100.0%) end of table export. sergtsoP
[========================>] 1/1 views (100.0%) end of output.
[========================>] 2/2 procedures (100.0%) end of output.
ot
[========================>] 1/1 triggers (100.0%) end of output.
elcarO
psql -h postgres.pgtraining.com -U hr hr 03-50-6102
Password for user hr:
psql (9.2.15, server 9.5.3)
WARNING: psql version 9.2, server version 9.5.
Some psql features might not work.
SSL connection (cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256)
Type "help" for help.
hr=> \i output.sql
Run 2
1
trap
• ora2pg-all-to-file.conf → dump schema and data to output.sql
-
noitargiM
/usr/local/bin/ora2pg -c ora2pg-all-to-file.conf
[========================>] 7/7 tables (100.0%) end of scanning.
[========================>] 7/7 tables (100.0%) end of table export.
[========================>] 1/1 views (100.0%) end of output. sergtsoP
[========================>] 2/2 procedures (100.0%) end of output.
[========================>] 1/1 triggers (100.0%) end of output.
[========================>] 25/25 rows (100.0%) Table COUNTRIES (25 recs/sec)
ot
[========================>] 27/27 rows (100.0%) Table DEPARTMENTS (27 recs/sec) elcarO
[========================>] 107/107 rows (100.0%) Table EMPLOYEES (107 recs/sec)
[========================>] 19/19 rows (100.0%) Table JOBS (19 recs/sec)
03-50-6102
[========================>] 10/10 rows (100.0%) Table JOB_HISTORY (10 recs/sec)
[========================>] 23/23 rows (100.0%) Table LOCATIONS (23 recs/sec)
[========================>] 4/4 rows (100.0%) Table REGIONS (4 recs/sec)
[========================>] 215/215 rows (100.0%) on total
estimated data (1 sec., avg: 215 recs/sec)
psql -h postgres.pgtraining.com -U hr hr
Password for user hr:
psql (9.2.15, server 9.5.3)
[...]
hr=> \i output.sql
Post-Migration Testing...
1
trap
hr=> select * from job_history;
employee_id | start_date | end_date | job_id | department_id -
noitargiM
-------------+---------------------+---------------------+------------+---------------
102 | 2001-01-13 00:00:00 | 2006-07-24 00:00:00 | IT_PROG | 60
[...]
sergtsoP
200 | 2002-07-01 00:00:00 | 2006-12-31 00:00:00 | AC_ACCOUNT | 90
(10 rows)
ot
hr=> update employees set job_id = 'ST_MAN' where employee_id = 100; elcarO
UPDATE 1
03-50-6102
hr=> select * from job_history;
employee_id | start_date | end_date | job_id | department_id
-------------+---------------------+--------------------------+------------+---------------
102 | 2001-01-13 00:00:00 | 2006-07-24 00:00:00 | IT_PROG | 60
[...]
200 | 2002-07-01 00:00:00 | 2006-12-31 00:00:00 | AC_ACCOUNT | 90
100 | 2003-06-17 00:00:00 | 2016-05-30 03:38:32.7629 | AD_PRES | 90
(11 rows)
PL/SQL vs PL/PgSQL
1
trap
ora2pg can automatically translate only very simple
•
-
procedures or functions (as the trigger examples in the hr noitargiM
demo schema)
sergtsoP
• more complicated procedures need to be translated
manually ot
elcarO
• fortunately, PL/PgSQL is easy and rich in features: in my 03-50-6102
experience typical procedures can be rewritten without too
much hassle most of the times
• some people suggest getting rid of procedures alltogether
when migrating (move them to the middle tier) - I tend to find it
easier to just translate them!
Scenario 1: Bad
1
trap
application is linked against OCI / uses TNS
•
-
noitargiM
natively (like the SQL*Plus executable)
sergtsoP
if the source code is not available, a migration is
•
not possible ot
elcarO
03-50-6102
if the source code is available and can be
•
changed, at the very least the database access
layer needs to be rewritten from scratch (using
libpq)
Scenario 2: Bad
1
trap
application uses some proprietary software or
•
-
noitargiM
component such as Oracle Forms ™
sergtsoP
an easy migration is generally not possible
•
ot
elcarO
03-50-6102
Scenario 3: so-so
1
trap
application uses ODBC, JDBC, etc. - however, it uses
•
-
noitargiM
lots of queries with Oracle custom-syntax (such as (+)
instead of outer joins, mixes quoted and unquoted
sergtsoP
identifiers, uses lots of Oracle specific functions etc.)
and has long and complex PL/SQL procedures
ot
elcarO
• if the source code is not available, a migration is not 03-50-6102
possible
if the source code is available, and can be changed,
•
queries and procedures need to be translated
manually
Scenario 4: good
1
trap
application uses ODBC, JDBC, etc. - also, it
•
-
noitargiM
either uses no or very few Oracle custom-syntax
and PL/SQL procedures or the vendor has made
sergtsoP
a version for Postgres backends available
ot
elcarO
application that use abstractions layers such as
•
03-50-6102
ORM-wrappers usually fall into this category
a migration is normally not too hard (unless the
•
software is completely locked-down and does not
even allow to select the ODBC, JDBC, etc. driver)
1
trap
-
noitargiM
sergtsoP
What is you scenario?
ot
elcarO
03-50-6102
1
trap
-
noitargiM
sergtsoP
'k thx bye ;)
ot
elcarO
03-50-6102