>
> \"service\":\"ESBIN4\",
>
> \"servicename\":\"总行ESB10\",
>
> \"interface\":\"LOAN100000490001\",
>
> \"interfacename\":\"消费贷提款审批与可提款金额计算\",
>
> \"extend\":{
>
> \"consFlowNo\":\"AMBL001100033861089\",
>
> \"providerId\":\"BEISWD\",
>
> \"channelId\":\"BEISPhoneBank\"
>
> }
>
> }
## 产品操作步骤
银联前置贷记场景，以银联前置.贷记.服务端为起点，通过核心、服务总线到达核心系统.银联-账户信息.服务端。
1.  创建全局KPI
2.  创建过滤项
3.  创建spl
4.  创建拓扑图
5.  在已展示的拓扑图上对未来预期监控的节点设置节点KPI
6.  调整拓扑图达到预期想要展示的大小和位置
7.  输入时间轴SPL（默认时间今天，可以不选）
8.  创建时间轴数据
9.  在点击任何节点之前，点击保存（目的：保存已经设置好的缩放和位置，以及节点KPI）这一步可以保存上述很多信息，除了异常处理信息
10. 正常操作时间轴
11. 异常处理
12. 切换过滤项，调整新拓扑图缩放和位置，以及设置节点KPI（没有处理异常信息之前，不建议更改全局KPI，全局KPI影响所有过滤项分支下的所有数据），点击保存，可以进行正常时间轴操作
    1.  ### 北京银行全链路追踪系统使用实践
        1.  #### 数据准备
根据不同项目情况，链路数据获取可以分为如下两类:
1.已通过日志代理接入采集各业务系统日志，如此直接进入“3.3.1.2字段提取”进行日志数据字段提取；
2.通过线上系统获取样例日志，可以通过模拟造数据生成日志数据再通过日志代理接入采集。模拟造数据操作步骤可以参考《日志易eventgen使用手册V1.0.docx》。
#### 字段提取
针对链路字段分析要求，完成对关键必填字段和客户需求相关选填字段的字段提取。以北京银行为例，各应用系统日志包含19项内容，且日志记录字段须严格区分大小写、拼写详情如下：
![](media/image22.png){width="5.605942694663167in"
height="2.23089457567804in"}
**图3-3-1-2-1**
注：在字段提取后，须对关键必填字段的数据质量进行检查，对字段为空/空格/特殊符号等情况，需业务系统沟通数据改造或在后续数据加工和spl步骤中处理。
#### 数据加工
按数据处理方式可以分为使用定时任务spl聚合统计和使用数据工厂fornaxee聚合统计进行数据加工。
通过定时任务运行spl对数据加工时，以北京银行链路监控为例，根据需求利用接入的数据源traceid、spanid和parentspanid及关联业务产品属性加工链路节点上下游关系，同时结合业务属性字段duaration、errortype等加工链路节点的调用量、平均耗时、最大耗时、成功率、自身错误量、非自身错误量和超时错误量等指标数据。配置定时任务，按照一定周期跑出链路展示的后台数据。
![](media/image23.png){width="2.6896544181977253in"
height="3.973882327209099in"}
**图3-3-1-3-1**
通过数据工厂fornaxee对数据加工时，以北京银行链路监控为例，根据需求利用“3.3.1.2字段提取”后的数据，将logriver模块解析后的字段回写至kafka
topic(例如:trace)，数据工厂对接该kafka
topic获取数据就行流式处理，主要利用spanEvaluator组件的流式处理，完成链路节点上下游关系和产品属性标签记录，再经过字段清理过滤标准化处理后，利用Aggregator组件完成链路节点的调用量、平均耗时、最大耗时、成功率、自身错误量、非自身错误量和超时错误量等指标数据。
![](media/image24.png){width="5.763888888888889in"
height="3.401388888888889in"}
**图3-3-1-3-2**
![](media/image25.png){width="5.763888888888889in"
height="2.5527777777777776in"}
**图3-3-1-3-3**
![](media/image26.png){width="5.763888888888889in" height="3.3in"}
**图3-3-1-3-4**
综上，定时任务是基于周期轮询方式进行加工处理数据，对于跨定时任务周期统计指标统计结果在链路展示存在一定误差，而数据工厂是基于业务时间窗进行加工处理数据，数据准确完整性高，建议通过数据工厂进行数据加工处理。
#### 可视化配置及展示
通过前台页面新建全链路页面，如下:
![](media/image27.png){width="2.6in" height="2.650243875765529in"}
![](media/image28.png){width="2.817390638670166in"
height="2.9499431321084866in"}
**图3-3-1-4-1**
然后，可进行后续的过滤项配置、链路图配置、指标配置、全链路SPL、时间轴spl配置等，以下操作以北京银行链路情景配置为例:
通过过滤项，配置链路查询需要过滤的产品大类和产品子类信息,如下:
![](media/image29.png){width="5.704317585301837in"
height="3.563870297462817in"}
**图3-3-1-4-2**
![](media/image30.png){width="5.695651793525809in"
height="3.79077646544182in"}
**图3-3-1-4-3**
通过链路图配置，配置链路图展示处理基础信息,如下:
![](media/image31.png){width="5.763888888888889in" height="3.35625in"}
**图3-3-1-4-4**
如上，trace.ssi是节点名称信息，为多个关键字段拼接的组合字段,即系统名称_服务名_接口名(例如手机银行_手机银行前端_消费贷)，而通过节点名称分割和节点层级的配置，可以切割节点名称，从而使链路图可以按照不同级别分层展示链路情况；边结束字段为链路连接线下游节点名称；边起始字段为链路连接线上游节点名称。
通过链路spl，结合过滤项，基于数据加工的结果数据进行链路节点基础信息和指标信息查询，如下：
![](media/image32.png){width="5.847961504811899in"
height="3.2656999125109363in"}
**图3-3-1-4-5**
注：通过spl语句若需在指标项配置中展示，语句中重命名时须保持_开头，如rename
\_totalCount as \"\_调用量\"。
点击创建拓扑图即可生成全链路监控展示图(即时间轴分钟级展示的明细数据)，如下：
![](media/image33.png){width="5.763888888888889in"
height="3.167361111111111in"}
**图3-3-1-4-6**
同时，通过链路spl查询结果中的各指标项，可根据需求配置各指标的监控告警及钻取操作，例如：
![](media/image34.png){width="5.763888888888889in"
height="3.720833333333333in"}
**图3-3-1-4-7**
通过时间轴spl配置，可配置时间轴小时级展示的汇总数据，如下:
![](media/image35.png){width="5.763888888888889in"
height="3.3090277777777777in"}
**图3-3-1-4-8**
点击保存，即完成全链路监控的展示及配置。
#### 功能测试
基础配置完成后，对功能测试关键点进行测试，包括：
1.权限测试；
2.钻取测试；
3.全链路视图时间轴；
4.全链路视图切换，从而形成完整测试用例。
![](media/image36.png){width="5.763888888888889in"
height="2.988888888888889in"}
**图3-3-1-5-1**
详情可参考《北京银行_交易全链路监控系统_测试案例2020630.xlsx》。
### 亿联银行全链路追踪系统使用实践
后期补充，项目实施中。
# 使用场景
日志交易全链路监控系统可在日常工作中用于被动模式的问题定位、主动模式的日常巡检，以及各种链路故障分析场景。几种常见的使用方式会在本章第一小节进行简要介绍。
日志易交易全链路监控系统应用目前以银行交易场景为主。以北京银行、亿联银行、山东城商行联盟为例，后续将对全链路监控使用场景进行具体介绍。
## 使用方式
全链路监控在以下几种常见情况中：
1.  被动模式的问题定位：如日常工作中，接收到第三方的通知（客服或告警通知），进入链路分析视图进行快速定位问题并辅助解决问题。
2.  主动模式的日常巡检：每天上班巡检，通过全链路监控视图，发现历史异常。
3.  各种链路故障分析场景：大数据平台超时错误快速定位、大数据平台超时错误快速定位、大数据平台服务查询，根据特定查询进行快速展现。
    1.  ### 被动模式
在被动模式的问题定位中，接收到通知后，我们能够接收到"traceid，时间范围，用户信息，产品"关键字段，点击进入链路分析视图，将traceid填入过滤框中，所有的错误信息即可展现出来。
![](media/image37.png){width="5.763888888888889in"
height="2.6215277777777777in"}
### 主动模式
主动模式的日常巡检中，通过全链路监控视图，可以快速发现异常，然后对异常进行标记和跟踪分析。
主动模式下的操作步骤如下：
1.  进入全链路监控视图，选择产品名称和产品类型，展现当前全链路监控运行状态；
2.  点击时间轴上的异常时间点，拓扑图出现异常发生时间点的异常统计信息，点击浮窗错误信息"超时：18"；
3.  跳转到链路分析界面，可以查看时间段内的关键错误信息，然后进行类似单笔故障定位的分析，也可跳转到查询页面进行分析查看；
4.  如果错误为已知，比如那个时间段内出现过网络中断，可对该错误进行处置操作。
当前全链路监控状态：
![](media/image38.png){width="5.763888888888889in"
height="3.642361111111111in"}
点击异常发生时间点：
![](media/image39.png){width="5.763888888888889in" height="3.60625in"}
查看异常时间点的错误信息：
![](media/image40.png){width="5.763888888888889in"
height="3.629166666666667in"}
链路分析界面查看错误时间段内信息：
![](media/image41.png){width="5.763888888888889in" height="3.26875in"}
跳转查询页面进行分析：
![](media/image42.png){width="5.763888888888889in"
height="2.8819444444444446in"}
### 链路故障分析
以某银行大数据平台超时错误快速定位场景为例，一个链路故障分析的流程可能如下：
#### 可能性分析
结合系统链路，可以推导平台超时的大致情况。
![](media/image43.png){width="5.763888888888889in"
height="3.009027777777778in"}
平台超时一般是连接异常所致。连接异常场景常见于网络通讯时出现问题：
1.**建立连接失败**，无法建立连接，网络超时或连接异常，一般有重连机制，日志呈现为esb有异常日志输出，大数据平台无感知；
2.**建连成功，连接异常中断**，一般为回包时出现网络抖动造成大数据的处理信息无法正常返回，（也有可能是esb接口发生异常，突然中断，这种场景我们暂时不做分析），日志呈现为esb有异常日志输出，大数据平台有该交易处理记录。
排障时查看网络运行情况以及交互两端服务或接口是否正常。
除链接异常外，其他超时场景有：
1.**ESB报非自身错误，大数据报自身错误**，最常见的场景，"请联系大数据配置转发权限"；
2.**ESB报超时，大数据平台处理超时**，大数据平台前置及其他服务处理总时间超过esb限定超时时间，日志呈现为esb日志报超时，大数据平台各服务有该交易处理记录。
#### 关联分析
这里列举了大数据故障的主要三种场景，生产环境往往更为复杂，交易量大的时候，多种异常情况混合到一起，而且容易出现极端情况，如"ESB报超时，大数据平台报正常"，因此在定位问题是需要去关联大数据平台的原始处理日志。
从"网贷-黑名单"日志中发现错误类型为1，提示非自身报错。
![](media/image44.png){width="5.763888888888889in"
height="1.4555555555555555in"}
ESB日志中提示超时报错，暂无样本日志。
![](media/image45.png){width="5.763888888888889in"
height="3.9604166666666667in"}
如果esb的日志如成功链路的日志中一样，带有个consFlowNo，可通过该字段在大数据平台的日志中进行查看。
不管是在被动模式和主动模式下发生超时错误，重点关心的是下游节点，也就是esb报超时错误，我们优先查看下游节点是否出现异常情况，通过consFlowNo字段关联大数据平台的处理日志，如果数据前置无日志，则说明可能是建连失败，如果出现技术错误则说明可能是出现内部调用异常。
![](media/image46.png){width="5.613138670166229in"
height="1.1073534558180227in"}
![](media/image47.png){width="5.668739063867017in"
height="2.525838801399825in"}
![](media/image48.png){width="5.763888888888889in" height="3.11875in"}