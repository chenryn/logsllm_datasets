topics for future work.
Assumptions: In our proofs we are forced to rely on unstudied
assumptions about the underlying primitives used in MTProto.
In particular, we have to make related-key assumptions about
the compression function of SHA-256 which could be easily
avoided by tweaking the use of these primitives in MTProto. In
the meantime, these assumptions represent interesting targets
for symmetric cryptography research. Similarly, the complexity
of our proofs and assumptions largely derives from MTProto
deploying hash functions in place of (domain-separated) PRFs
such as HMAC. We recommend that Telegram either adopts
well-studied primitives for future versions of MTProto to ease
analysis and thus to increase conï¬dence in the design, or adopts
TLS.
Telegram: While we prove security of the symmetric part
of MTProto at a protocol level, we recall that by default
communication via Telegram must trust the Telegram servers,
i.e. end-to-end encryption is optional and not available for
group chats. We thus, on the one hand, (a) recommend that
Telegram open-sources the cryptographic processing on their
servers and (b) recommend to avoid referencing Telegram as
an â€œencrypted messengerâ€ which â€“ post-Snowden â€“ has come
26Indeed, the Telegram developers rule out length-extension attacks in [44]
because the MAC is computed on the plaintext and because any change in
the MAC affects the decryption key and thus the decrypted plaintext, which
makes it unlikely that the integrity check passes. This is largely correct but
only under the assumption that msg_id is actually unique and re-encryption of
messages with the same msg_id is not allowed. That is, the condition given
by the developers in the FAQ was violated by several ofï¬cial Telegram clients.
to mean end-to-end encryption. On the other hand, discussions
about end-to-end encryption aside, echoing [2], [3] we note
that many higher-risk users do rely on MTProto and Telegram
and shun Signal. This emphasises the need to study these
technologies and how they serve those who rely on them.
Acknowledgements
We thank Mihir Bellare for discussions and insights. The
research of MarekovÃ¡ was supported by the EPSRC and the
UK Government as part of the Centre for Doctoral Training
in Cyber Security at Royal Holloway, University of London
(EP/P009301/1). The research of Paterson was supported in
part by a gift from VMware.
References
[1] Telegram, â€œ500 million users,â€ https://t.me/durov/147, Feb 2021.
[2] K. Ermoshina, H. Halpin, and F. Musiani, â€œCan Johnny build a protocol?
co-ordinating developer and user intentions for privacy-enhanced secure
messaging protocols,â€ in European Workshop on Usable Security, 2017.
[3] M. R. Albrecht, J. Blasco, R. B. Jensen, and L. MarekovÃ¡, â€œCollective
information security in large-scale urban protests: the case of Hong Kong,â€
to appear at USENIXâ€™21, pre-print at https://arxiv.org/abs/2105.14869,
2021.
[4] J. Jakobsen and C. Orlandi, â€œOn the CCA (in)security of MTProto,â€
Proceedings of
the 6th Workshop on Security and Privacy in
Smartphones and Mobile Devices - SPSMâ€™16, 2016. [Online]. Available:
http://dx.doi.org/10.1145/2994459.2994468
[5] T. SuÅ¡Ã¡nka and J. KokeÅ¡, â€œSecurity analysis of the Telegram IM,â€
in Proceedings of the 1st Reversing and Offensive-oriented Trends
Symposium, 2017, pp. 1â€“8.
[6] N. Kobeissi, â€œFormal Veriï¬cation for Real-World Cryptographic Protocols
and Implementations,â€ Theses, INRIA Paris ; Ecole Normale SupÃ©rieure
de Paris - ENS Paris, Dec. 2018, https://hal.inria.fr/tel-01950884.
[7] M. Miculan and N. Vitacolonna, â€œAutomated symbolic veriï¬cation of
Telegramâ€™s MTProto 2.0,â€ in Proceedings of the 18th International Con-
ference on Security and Cryptography, SECRYPT 2021, S. De Capitani di
Vimercati and P. Samarati, Eds. SciTePress, 2021, pp. 185â€“197.
[8] M. Fischlin, F. GÃ¼nther, and C. Janson, â€œRobust channels: Handling unre-
liable networks in the record layers of QUIC and DTLS 1.3,â€ Cryptology
ePrint Archive, Report 2020/718, 2020, https://eprint.iacr.org/2020/718.
[9] Telegram, â€œEnd-to-end encryption, secret chats â€“ sending a re-
quest,â€ http://web.archive.org/web/20210126013030/https://core.telegram.
org/api/end-to-end#sending-a-request, Feb 2021.
[10] â€”â€”, â€œtdlib,â€ https://github.com/tdlib/td, Sep 2020.
[11] â€”â€”, â€œtdlib â€“ Transport.cpp,â€ https://github.com/tdlib/td/blob/v1.7.0/td/
mtproto/Transport.cpp#L272, Apr 2021.
[12] M. R. Albrecht, K. G. Paterson, and G. J. Watson, â€œPlaintext recovery
attacks against SSH,â€ in 2009 IEEE Symposium on Security and Privacy.
IEEE Computer Society Press, May 2009, pp. 16â€“26.
[13] M. Bellare and P. Rogaway, â€œThe security of triple encryption and a
framework for code-based game-playing proofs,â€ in EUROCRYPT 2006,
ser. LNCS, S. Vaudenay, Ed., vol. 4004. Springer, Heidelberg, May / Jun.
2006, pp. 409â€“426.
[14] C. Campbell, â€œDesign and speciï¬cation of cryptographic capabilities,â€
IEEE Communications Society Magazine, vol. 16, no. 6, pp. 15â€“19, 1978.
[15] C. Jutla, â€œAttack on free-mac, sci.crypt,â€ https://groups.google.com/forum/
#!topic/sci.crypt/4bkzm_n7UGA, Sep 2000.
[16] M. Bellare, A. Boldyreva, L. R. Knudsen, and C. Namprempre, â€œOn-line
ciphers and the hash-CBC constructions,â€ Journal of Cryptology, vol. 25,
no. 4, pp. 640â€“679, Oct. 2012.
[17] NIST, â€œFIPS 180-4: Secure Hash Standard,â€ 2015, http://dx.doi.org/10.
6028/NIST.FIPS.180-4.
[18] H. Handschuh and D. Naccache, â€œSHACAL (-submission to NESSIE-),â€
Proceedings of First Open NESSIE Workshop, 2000, http://citeseerx.ist.
psu.edu/viewdoc/download?doi=10.1.1.3.4066&rep=rep1&type=pdf.
[19] G. A. Marson and B. Poettering, â€œSecurity notions for bidirectional
channels,â€ IACR Trans. Symm. Cryptol., vol. 2017, no. 1, pp. 405â€“426,
2017.
Authorized licensed use limited to: Tsinghua University. Downloaded on August 07,2022 at 12:21:42 UTC from IEEE Xplore.  Restrictions apply. 
105
[20] M. Bellare, T. Kohno, and C. Namprempre, â€œAuthenticated encryption
in SSH: Provably ï¬xing the SSH binary packet protocol,â€ in ACM CCS
2002, V. Atluri, Ed. ACM Press, Nov. 2002, pp. 1â€“11.
[21] T. Kohno, A. Palacio, and J. Black, â€œBuilding secure cryptographic
transforms, or how to encrypt and MAC,â€ Cryptology ePrint Archive,
Report 2003/177, 2003, http://eprint.iacr.org/2003/177.
[22] C. Boyd, B. Hale, S. F. MjÃ¸lsnes, and D. Stebila, â€œFrom stateless to
stateful: Generic authentication and authenticated encryption construc-
tions with application to TLS,â€ in CT-RSA 2016, ser. LNCS, K. Sako,
Ed., vol. 9610. Springer, Heidelberg, Feb. / Mar. 2016, pp. 55â€“71.
[23] P. Rogaway and Y. Zhang, â€œSimplifying game-based deï¬nitions -
indistinguishability up to correctness and its application to stateful AE,â€
in CRYPTO 2018, Part II, ser. LNCS, H. Shacham and A. Boldyreva,
Eds., vol. 10992. Springer, Heidelberg, Aug. 2018, pp. 3â€“32.
[24] Telegram, â€œMobile protocol: Detailed description,â€ http://web.archive.org/
web/20210126200309/https://core.telegram.org/mtproto/description, Jan
2021.
[25] â€”â€”, â€œSchema,â€ https://core.telegram.org/schema, Sep 2020.
[26] â€”â€”, â€œTL language,â€ https://core.telegram.org/mtproto/TL, Sep 2020.
[27] Google, â€œBoringSSL AES IGE implementation,â€ https://github.com/
DrKLO/Telegram/blob/d073b80063c568f31d81cc88c927b47c01a1dbf4/
TMessagesProj/jni/boringssl/crypto/ï¬psmodule/aes/aes_ige.c, Jul 2018.
http://web.archive.org/web/
20200527124125/https://core.telegram.org/mtproto/mtproto-transports,
May 2020.
[28] Telegram,
transports,â€
â€œMTProto
[29] â€”â€”, â€œSequence numbers in secret chats,â€ http://web.archive.org/web/
20201031115541/https://core.telegram.org/api/end-to-end/seq_no, Jan
2021.
[30] K. Ludwig, â€œTrudy - Transparent TCP proxy,â€ 2017, https://github.com/
praetorian-inc/trudy.
[31] Telegram,
â€œTelegram Desktop â€“ mtproto_serialized_request.cpp,â€
https://github.com/telegramdesktop/tdesktop/blob/v2.5.8/Telegram/
SourceFiles/mtproto/details/mtproto_serialized_request.cpp#L15, Feb
2021.
[32] â€”â€”,
â€œMobile protocol: Detailed description â€“ server
salt,â€
http://web.archive.org/web/20210221134408/https://core.telegram.
org/mtproto/description#server-salt, Feb 2021.
[33] â€”â€”, â€œTelegram Android â€“ Datacenter.cpp,â€ https://github.com/DrKLO/
Telegram/blob/release-7.4.0_2223/TMessagesProj/jni/tgnet/Datacenter.
cpp#L1171, Feb 2021.
[34] â€”â€”,
â€œTelegram
session_private.cpp,â€
//github.com/telegramdesktop/tdesktop/blob/v2.6.1/Telegram/
SourceFiles/mtproto/session_private.cpp#L1338, Mar 2021.
Desktop
â€“
https:
[35] â€”â€”, â€œNotice of ignored error message,â€ http://web.archive.org/web/
20200527121939/https://core.telegram.org/mtproto/service_messages_
about_messages#notice-of-ignored-error-message, May 2020.
[36] M. Bellare and T. Kohno, â€œA theoretical treatment of related-key attacks:
RKA-PRPs, RKA-PRFs, and applications,â€ in EUROCRYPT 2003, ser.
LNCS, E. Biham, Ed., vol. 2656. Springer, Heidelberg, May 2003, pp.
491â€“506.
[37] M. Bellare, A. Desai, E. Jokipii, and P. Rogaway, â€œA concrete security
IEEE Computer
treatment of symmetric encryption,â€ in 38th FOCS.
Society Press, Oct. 1997, pp. 394â€“403.
[38] P. Rogaway, â€œNonce-based symmetric encryption,â€ in FSE 2004, ser.
LNCS, B. K. Roy and W. Meier, Eds., vol. 3017. Springer, Heidelberg,
Feb. 2004, pp. 348â€“359.
[39] J. Kim, G. Kim, S. Lee, J. Lim, and J. H. Song, â€œRelated-key attacks
on reduced rounds of SHACAL-2,â€ in INDOCRYPT 2004, ser. LNCS,
A. Canteaut and K. Viswanathan, Eds., vol. 3348. Springer, Heidelberg,
Dec. 2004, pp. 175â€“190.
[40] J. Lu, J. Kim, N. Keller, and O. Dunkelman, â€œRelated-key rectangle
attack on 42-round SHACAL-2,â€ in ISC 2006, ser. LNCS, S. K. Katsikas,
J. Lopez, M. Backes, S. Gritzalis, and B. Preneel, Eds., vol. 4176.
Springer, Heidelberg, Aug. / Sep. 2006, pp. 85â€“100.
[41] Telegram,
â€œTelegram
Desktop
â€“
session_private.cpp,â€
https://github.com/telegramdesktop/tdesktop/blob/v2.7.1/Telegram/
SourceFiles/mtproto/session_private.cpp#L1258, Apr 2021.
[42] â€”â€”,
â€œSecurity
guidelines
for
client
developers,â€
http:
//web.archive.org/web/20210203134436/https://core.telegram.org/
mtproto/security_guidelines#mtproto-encrypted-messages, Feb 2021.
[43] N. J. AlFardan and K. G. Paterson, â€œLucky thirteen: Breaking the TLS
and DTLS record protocols,â€ in 2013 IEEE Symposium on Security and
Privacy.
IEEE Computer Society Press, May 2013, pp. 526â€“540.
[44] Telegram, â€œFAQ for the Technically Inclined â€“ length extension at-
tacks,â€ http://web.archive.org/web/20210203134422/https://core.telegram.
org/techfaq#length-extension-attacks, Feb 2021.
[45] D. Bleichenbacher, â€œChosen ciphertext attacks against protocols based
on the RSA encryption standard PKCS #1,â€ in CRYPTOâ€™98, ser. LNCS,
H. Krawczyk, Ed., vol. 1462.
Springer, Heidelberg, Aug. 1998, pp.
1â€“12.
[46] G. D. Micheli and N. Heninger, â€œRecovering cryptographic keys from
partial information, by example,â€ Cryptology ePrint Archive, Report
2020/1506, 2020, https://eprint.iacr.org/2020/1506.
[47] M. R. Albrecht and N. Heninger, â€œOn Bounded Distance Decoding
with predicate: Breaking the "lattice barrier" for the Hidden Number
Problem,â€ Cryptology ePrint Archive, Report 2020/1540, 2020, https:
//eprint.iacr.org/2020/1540.
Appendix
A. Attacking the key exchange
During the key exchange, a client sends an RSA-encrypted
message ğ‘š (cid:66) (â„ğ‘Ÿ , ğ›¾, ğ‘›(cid:48), ğ‘ğ‘Ÿ)
to the server with â„ğ‘Ÿ (cid:66)
SHA-1(ğ›¾ (cid:107) ğ‘›(cid:48)), ğ›¾ a known constant, ğ‘›(cid:48) âˆˆ {0, 1}256 and ğ‘ğ‘Ÿ some
unknown padding. The tag â„ğ‘Ÿ is meant to provide integrity.
Our target secret is ğ‘›(cid:48). Note that the SHA-1(Â·) does not include
the padding but that ğ›¾ has a variable bit-length (known to the
attacker). Thus, the payload must be parsed after decryption
before verifying its integrity, which enables a potential timing
side channel. While we were unable to establish the parsing
order of the Telegram servers or if they defend against such
leaks, the Telegram developers conï¬rmed to us the existence
of vulnerable behaviour on the server during the disclosure
process.
If we assume that server-side parsing proceeds analogously
to similar parsing in TDlib then a 32-bit header value ğœ (part
of ğ›¾) is checked ï¬rst and the parsing function terminates early
when it does not match. Assuming further that this event is
detectable through a time difference, this instantiates an oracle
leaking when certain 32 bits match a known value. Our attack
then proceeds in the style of Bleichenbacherâ€™s attack [45].
Writing ğ‘ (cid:66) ğ‘šğ‘’ mod ğ‘(cid:48) for the ciphertext observed by the
attacker â€“ where ğ‘’, ğ‘(cid:48) is the serverâ€™s public RSA key â€“ we
Â· ğ‘ â€“ for carefully sampled ğ‘ ğ‘– â€“ to our oracle to
submit ğ‘ ğ‘’
learn whether ğ‘ ğ‘– Â· ğ‘š is such that the target 32 bits match the
ğ‘–
expected header value. Collecting several such answers we can
then recover ğ‘š and thus ğ‘›(cid:48).
A complication is that Bleichenbacherâ€™s adaptive recovery
method â€“ iteratively restricting the interval â€“ is not available
to us since we learn the value of some middle bits rather than
the most signiï¬cant bits. Writing ğ‘¦ for the bit position of ğœ,
we observe that (ğ‘ ğ‘– Â· ğ‘š mod ğ‘(cid:48)) âˆ’ 2ğ‘¦ Â· ğœ mod 2ğ‘¦+32 (cid:28) 2ğ‘¦+32,
i.e. that the correct value ğ‘š produces an unusually short value
modulo 2ğ‘¦+32. This enables us to use lattice reduction to ï¬nd
ğ‘š using known techniques [46], [47].
implies knowing server_salt. To recover
session_id we can then run a guess and verify attack using
the techniques from Section VI. Alternatively, we observe that
ğ‘›(cid:48) is later used in the key exchange to protect the integrity
of Difï¬e-Hellman shares ğ‘”ğ‘ and ğ‘”ğ‘. Thus, our attack would
also enable an attacker-in-the-middle (MitM) attack on the key
exchange. The full version contains the details and a proof of
concept implementation of the lattice reduction part.
Knowing ğ‘›(cid:48)
Authorized licensed use limited to: Tsinghua University. Downloaded on August 07,2022 at 12:21:42 UTC from IEEE Xplore.  Restrictions apply. 
106