# 一、样本简介
GandCrab勒索病毒首次出现于2018年1月，并在随后的半年内迅速发展，短短几个月内就经历了从V1.0到V4.0多个主要版本的更新。自V4.0起，又陆续出现了V4.1至V4.4等小版本变种，显示出该病毒的高度活跃性。目前，最新的GandCrab变种尚无有效的解密方法。

其主要传播途径包括：
- RDP暴力破解
- 携带恶意链接或附件的垃圾邮件
- 下载捆绑了恶意软件的合法应用程序
- 利用Rig EK（Exploit Kit）漏洞利用工具包

# 二、样本分析
### 1. 样本执行流程概述
- **初始化阶段**：首先对自身进行解密操作以暴露内部shellcode。
- **内存操作**：修改shellcode属性后跳转到指定内存地址执行；定位`kernel32.dll`并获取关键函数如`GetProcAddress`的地址；接着获取其他必需的API函数地址如`VirtualAlloc`, `VirtualProtect`, `VirtualFree`, `GetVersionExA`, `TerminateProcess`等；分配新内存空间用于存放解密后的payload。
- **重建PE结构**：将解密出的数据拷贝到新的内存区域，并重构输入表。
- **执行payload**：最后通过调用`atexit`注册清理回调函数，并跳转至payload主逻辑入口开始执行加密过程。

### 2. 加密行为及目标选择
- **操作系统兼容性检查**：根据系统语言和输入法设置来决定是否继续攻击。例如，如果检测到俄语环境，则会停止进一步行动。
- **避免重复感染**：创建随机命名的互斥体防止同一台机器被多次感染。
- **生成公钥与私钥**：使用内置数据动态生成RSA密钥对，并将公钥存储于注册表中。
- **收集受害者信息**：搜集包括用户名、主机名、工作组名称在内的多种系统详情。
- **文件过滤规则**：特定目录和文件类型将被排除在外不被加密处理。
- **网络通信**：向预定义域名发送包含加密数据的HTTP POST请求。
- **本地及远程文件加密**：遍历所有驱动器上的文件以及局域网共享资源，使用AES算法对其进行加密，并附加`.KRAB`扩展名。
- **清除痕迹**：删除卷影副本服务以阻止恢复尝试，并可能对反病毒软件组件发起攻击以绕过防护措施。

### 3. 其他特征
- 在受感染计算机上留下名为`KRAB-DECRYPT.txt`的勒索信件，指示用户访问暗网支付赎金。
- 通过修改注册表项记录重要密钥信息，确保即使重启后也能正常工作。

# 三、总结
GandCrab V4.3版采用了多种技术手段来提高自身的隐蔽性和持久性，特别是针对静态逆向工程分析采取了复杂的混淆策略。这不仅增加了安全研究人员理解其工作原理的难度，同时也为受害者的数据恢复带来了更大挑战。