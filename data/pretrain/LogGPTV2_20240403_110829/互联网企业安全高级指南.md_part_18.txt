攻击类型
放大倍数
DNS
54
NTP
556.9
SNMPv2
6.3
NetBIOS
3.8
SSDP
30.8
CharGEN
358.8
QOTD
140.3
BitTorrent
3.8
Kad
16.3
Quake Network Protocol
63.9
Steam Protocol
5.5
Multicast DNS (mDNS)
10
RIPv1
131.24
Portmap (RPCbind)
28
图7-8脉冲型 DDoS 流量特征
这样的攻击之所以流行，是因为“打-打-停-停”的效果最好，刚触发防御阔值
防御机制开始生效攻击就停了，周而复始。蚊子不叮你，却在耳边飞，刚开灯想打它就跑
---
## Page 111
第7章网络安全99
没影了，当你刚关灯它又来了，你就没法睡觉
自动化的防御机制大部分都是依靠设置阅值来触发。尽管很多厂商宣称自已的防御措
施都是秒级响应，但实际上比较难。
网络层的攻击检测通常分为逐流和逐包，第一种逐流检测是根据netflow以一定的抽
样比例（例如1000:1）检测网络是否存在DDoC攻击，这种方式因为是抽样比例，所以精
确度较低，做不到秒级响应。第二种逐包检测，检测精度较高且响应时间较短，但成本比
较高，一般厂商都不会无视TCO全部部署这类方案。即便用逐包检测，其防御清洗策略的
启动也依赖于阅值，加上清洗设备一般情况下不会申联部署，触发清洗后需要引流，因此
大部分场景可以做秒级检测但做不到秒级防御。近源清洗尚且如此，云清洗的触发和转换
过程就更慢了。所以利用防御规则的生效灰度期，在触发防御前完成攻击会有不错的效果，
在结果上就表现为脉冲。
口链路泛洪型攻击一随着DDoS攻击技术的发展，又出现了一种新型的攻击方式：
链路泛洪（link-flooding），这种方式不直接攻击目标，而是以堵塞目标网络的上一级
链路为目的。对于使用了IP anycast 的企业网络来说，常规的 DDoS攻击流量会被
“分摊”到不同地址的基础设施，这样能有效缓解大流量攻击，所以攻击者发明了一
种新方法，攻击至目标网络traceroute的倒数第二跳，即上联路由，致使链路拥塞。
国内ISP目前未开放anycast，所以这种攻击方式的必要性有待观望，如图7-9所示。
传输
一级网络
二级网络
传输
二级ISP
传输
传输
三级网络
三级网络
（多宿ISP）
（单宿ISP)
网络用户
图7-9链路泛洪示意图
---
## Page 112
100技术篇
对一级ISP和IXP的攻击都可以使链路拥塞。
7.2.2多层防御结构
DDoS攻击本质上是一种只能缓解而不能完全防御的攻击，它不像漏洞那样打个补丁就
是完全解决了，DDoS就算购买和部署了当前市场上比较有竞争力的防御解决方案也完全谈
不上彻底根治。防火墙、IPS、WAF这些安全产品都号称自已有一定的抗DDoS能力，而实
际上它们只针对小流量下应用层的攻击比较有效，对于稍大流量的DDoS攻击则无济于事。
以2015年年中的情况为例，国内的DDoS攻击在一个月内攻击流量超过300G的就
有20次左右，这个数值将随着国内家庭宽带网速提升而进一步放大。对于200~500G的
攻击流量该如何防御，下面将展示完整的防御结构，通常可以分为4层，如图7-10所示。
第层：ISP
近源清洗
第二层：云清洗
/CDN 硬抗
第四层
OS/APP层
抗CC
第三层：DC级
近目的清洗
图7-10DDoS纵深防御体系
这4层不是严格意义上的纵深防御结构，也不是在所有的防御中都需要4层，可能有
时候只需要其中的2层。但对于超大流量攻击面言，就是需要4层防御机制，再没有其他
手段了。跟厂商的市场宣传可能有所不同，大流量攻击的防护并不是靠厂商单方面就能解
决，而是进行多层防御才有效。
---
## Page 113
第7章网络安全101
1.ISP/WAN层
这一层通常对最终用户不可见，如果只是中小企业，那这一层可能真的不会接触到
但如果是大型互联网公司、公有云厂商，甚至是云清洗厂商，这层是必不可少的。因为当
流量超过自己能处理的极限时，必须要借助电信运营商的能力。大型互联网公司虽然自身
储备的带宽比较大，但还没到达轻松抵抗大流量DDoS的程度，毕竞带宽是所有IDC成本
中最贵的资源，没有之一。目前无论是云计算厂商、大型互联网公司向外宣称的成功抵御
200G以上攻击的新闻背后都用到了运营商的抗D能力，另外像第三方的云清洗平台实际上
或多或少地依赖电信运营商，如果只依靠本身的清洗能力，都是非常有限的。
图7-11所示），流量压制是一种分方向的黑洞路由，对于购买其服务的厂商来说可以自定义
需要黑洞路由的IP，并选择在哪些国家及省份上生效，如图7-12所示。黑洞路由是一种简
单粗暴的方法，除了攻击流量，部分真实用户的访问也会被一起黑洞掉，对用户体验是一
种打折扣的行为。但因为攻击流量分布与业务流量分布往往区别较大，根据受攻击时，业
务与攻击流量具体分布，在某些攻击流量特别大而用户流量极小的方向上进行黑洞路由，
可以在保证大部分业务前提下解决边缘带宽拥塞问题，这对具备一定带宽储备和清洗能力
但仍需保证出口带宽的云清洗厂商特别有意义，对中小型网站用户体验影响较大。
近目的清洗
近源清洗
或击目标
传统模式：
独有模式：
近目的清洗
近源清洗
·面临接入带宽资源消耗问题
·利用电信全网资源完成清洗
图7-11近源清洗示意图
---
## Page 114
102技术篇
X流量压制解放
流量压制/用放
五制P:：QH01.4220
动用 24
0
分9
压制
全网
图7-12电信云堤移动端管理界面
相比之下，近源清洗可以在靠近攻击源位置对攻击进行清洗，在几乎不增加时延的前
提下完成流量清洗。这种对攻击流量的牵引、清洗、回注的防御方式对用户体验的挑战没
那么大，但是跟黑洞路由比防御方的成本比较高，且触发到响应的延时较大。
在运营商防御这一层的主要的参与者是大型互联网公司、公有云厂商、云清洗厂商，
其最大的意义在于应对超过自身带宽储备和自身DDoS 防御能力之外的超大攻击流量时作
为补充性的缓解措施。
2. CDN/Internet 层
CDN并不是一种抗DDoS的产品，但对于Web类服务而言，却正好有一定的抗DDoS
能力。以大型电商的抢购为例，这个活动的访问量非常大，从很多指标上看不亚于DDoS
的CC，而在平台侧实际上在CDN层面用验证码过滤了绝大多数请求，最后到达数据库的
请求只占整体请求量的很小一部分。
对HTTPCC类型的DDoS，不会直接到源站，CDN会先通过自身的带宽硬抗，抗不了
的或者穿透CDN的动态请求会到源站，如果源站前端的抗DDoS能力或者源站前的带宽比
较有限，就会被彻底DDoS。
云清洗厂商提出的策略是，预先设置好网站的CNAME，将域名指向云清洗厂商的
DNS服务器，在一般情况下，云清洗厂商的DNS仍将穿透CDN的回源的请求指向源站，
---
## Page 115
第7章网络安全103
在检测到攻击发生时，域名指向自已的清洗集群，然后再将清洗后的流量回源，检测方式
主要是在客户网站前部署反向代理（Nginx），托管所有的并发连接。在对攻击流量进行分流
的时候，准备好一个域名到IP的地址池，当IP被攻击时封禁并启用地址池中的下一个IP，
如此往复。
以上是类Cloudflare的解决方案，国内云清洗广商的实现原理都相似，如图7-13所示。
攻击源：
IP2
攻击源：
IP1
100Gbps 的 DDoS
清洗中心
80Gbps 的 DDoS
清洗中心
客户服务器
图7-13云清洗示意图
不过这类方案都有一个通病，由于国内环境不支持anycast，通过DNS引流的方式需要
比较长的生效时间，这个时间依赖于DNS递归生效的时长，对自身完全不可控，很多用户
使用的DNS递归服务器最小TTL值长达24小时。同时CDN仅对Web类服务有效，对游
戏类TCP直连的服务无效。
网上很多使用此类抗D服务的过程可以概括为一句话：更改CNAME指向，等待DNS
递归生效。
3.DC层
Datacenter这一层的DDoS防御属于近目的清洗，就是在DC出口的地方部署ADS
设备。
---
## Page 116
104技术篇
产品照片如图7-14所示。
AntiDDoS8030
AntiDDoS8080
AntiDDoS8160
图7-14华为AntiDDoS 8000系列产品
目前国内厂商华为的AntiDDoS产品的最高型号支持T级高达1440Gbps带宽的防护，
产品系列如图7-14所示。DC级清晰方案的原理如图7-15所示，在DC出口以镜像或分光
部署DDoS探针（检测设备），当检测到攻击发生时，将流量牵引到旁路部署的DDoS清洗
设备，再将经过清洗的正常流量回注到业务主机，以此完成一轮闭环。
Internet
DDoS 清洗中心
IDC
DDoS 管理中
租户A
租户A
图7-15DC级清洗方案
---
## Page 117
第7章网络安全105
部署设备本身并没有太大的技术含量，有技术含量的部分都已经作为防御算法封装在
产品盒子里了。不过要指出的一点是，目前市场上的ADS盒子既有的算法和学习能力是有
限的，仍然需要人的介人，比如：
口对业务流量基线的自适应学习能力是有限的，例如电商行业双11大促日子的流量模
型可能就超越了ADS的学习能力，正常流量已经触发攻击判定。