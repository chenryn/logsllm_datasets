# 应急响应的神兵利器
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 1.文章概述
本文主要介绍windows以及linux应急响应方面的知识以及排除思路以及笔者日常使用的相关的优秀工具。
## 2.windows篇
windows终端的应急排除的话,我一般先会查看该终端的网络连接情况来判断是否有异常的连接，根据连接的地址我们可以去威胁情报平台(比如奇安信的TI)查询是否是恶意的或者为已知IOC，同时需要对产生可疑网络连接的进程进行进一步分析我这里使用的是pchunter工具。
可以通过工具看到产生网络连接对应的进程以及相关端口
对于进程我们需要首先检查是否有数字签名，子父进程的关系，进程的运行参数，进程加载的dll是否有签名是否是可疑的dll(dll劫持白加黑)，对可疑的进程或者dll可以在第三方平台进行检测或者沙箱跑行为看是否存在恶意的行为。可以通过pchunter工具批量检查当前没有签名的进程或者进程中加载了没有签名的模块，同时需要查看命令行参数是否有攻击行为。查看子父进程关系以及命令行参数最好还是使用process
explorer
通过process exploer软件可以清晰的看到子父进程之间的关系，svchost-wmiprvse-cmd具有经验的攻击检测人员可以很明显发现这种进程链很明显是通过wmi手法横向移动的时候受害终端产生的进程链，同时这命令行也是十分可疑的使用通过网络传输在远程主机上创建具有以“__”开头的特定名称和
unix 时间戳的临时文件执行里面的命令
同时也需要检查进程中是否存在可疑的线程，通常攻击者会注入系统进程来达到权限维持或提升的操作，通常是对产生网络连接的进程需要检查一下线程情况，这里通过火绒剑对怀疑的进程检查其线程，主要看是否存在没有模块没有版本没有描述的线程在运行的情况
同时可疑进程打开的文件句柄也是需要检查的，通过分析可疑进程打开的文件句柄发现如下可疑文件：C:\Windows\System32\bxomofr.dll，由于svchost进程一般加载dll只有两种方式：  
1.通过服务注册一个dll；  
2.Svchost进程依赖的dll会在服务启动时加载；  
除此外，一个dll不会通过打开文件句柄的方式进行加载（通常以句柄方式打开的文件都是数据类型的文件，而不是dll文件），因此上述文件十分可疑。
我们在使用process explorer工具可以开启签名校验以及virustotal检查协助我们分析判断，CPU或内存资源
长时间或过高占用的进程以及孤儿进程也是怀疑对象
对可疑的进程也需要查看该程序在磁盘中以及在内存中硬编码的字符串来帮助我们判断是否可疑可以看字符串中是否存在可疑的IPURL以及危险函数啊键盘按键啊之类的，同时程序运行起来后在磁盘中字符串与在内存中的字符串差距应该是不大的
如果该进程很有可能内存的内容被修改了，当然对可疑的可以直接跑沙箱，或者自己使用工具监控其运行行为
当我们从网络，进程都不是很好判别出来的时候我们可以看看启动项的信息看看有没有线索协助我们分析，攻击者一般都会留下后门来维持持久化。主要也是检查启动项中是否存在可疑的程序可以通过没有签名的文件，文件路径，文件名，注册的名称等进行怀疑，对可疑的程序可以进行跑沙箱或者virustotal等平台进行信誉度检测，维持持久化的程序需要重点关注其加载的dll，很多都是利用白程序服务加载恶意的dll来躲避我们分析，比如一个windowsdefend服务被攻击者通过dll劫持，使其加载恶意的dll你使用pchunter或者其他工具分析的时候你肯定会忽略掉这种白服务，所以前面提到的进程加载的dll打开的文件句柄进程中的线程等都需要重点关注。
这里最好使用autoruns对启动项进行检查这里记录了大部分的能够实现自启动的方法，直接选择everything这一选项就可以了everything就是所有其他选项的集合，同时可以开启virustotal扫描协助你判断。
同时还有一些维持持久化的方法比如文件关联，映像劫持隐藏用户，是否有可疑的未签名的驱动加载了，进程是否被挂钩等都需要检测，这里可以使用pchunter电脑体检功能快速帮你输出检查项，但是对于部分内容比如钩子检查是否误报等需要专业的同事协助你分析。简单的隐藏用户文件关联等我相信大部分同学都会鉴别是否是误报
对于排查清理过程中遇到一些文件隐藏的情况，可以通过pchunter里面的文件功能查找定位并清除隐藏属性，对于删不掉的程序也可以使用该工具强制删除。everything工具也可以查找显示出隐藏文件。
遇到病毒木马或者异常外连c2等攻击行为反复出现的情况一般来说是后门持久化没有清除干净，如果无法通过上面的方法发现的话最好安装sysmon来记录日志以及自带的windows日志通过日志分析来定位出具体方法。分析这两种日志好用的免费工具就是sysmonview以及APT-hunter,logontracer  
分析sysmon日志我们只需要将日志以xml格式导出，然后导入sysmonview中，可以看到他以每个进程会话维度将该进程会话发生的所有事件串了起来，同时我们导入virustotal,ipstack的APIkey后还可以帮我们分析文件是否报毒，帮你定位IP地址，通过这个工具我们可以很方便分析日志中发生的行为。  
从图中我们可以看到cmd启动了adfind同时adfind的命令行参数以及adfind在VT上的信誉度
从图中我们可以看到autoruns进程产生了网络连接外连IP以及IP的真实地址
其还有强大的搜索功能可以模糊匹配日志中存在的任何信息并把匹配上的事件都显示出来，将日志中所有的进程以进程树的样子显示出来  
图中搜索了mimikatz然后下方显示了所有日志中字段带有mimikatz的日志
导入的日志以进程树方式显示
windows日志我们可以通过LogonTracer工具他是一种通过可视化和分析 Windows Active Directory
事件日志来调查恶意登录的工具。此工具将在登录相关事件中找到的主机名（或 IP
地址）和帐户名相关联，并将其显示为图形。这样，就可以看到在哪个帐户登录尝试发生以及使用了哪个主机。工具帮我们分析了各种类型的登录以及一些内置的规则来检测一些恶意攻击比如dcsync,ms14-068等红色的是管理员账户，绿色是主机，蓝色是普通账户，可以很明显看到登录类型登录认证的方式，他也通过了内置的一些规则以及一些模型帮忙筛选出来一些可能是PTH方式登录的。这里主要使用了下面几种日志  
4624: Successful logon  
4625: Logon failure  
4768: Kerberos Authentication (TGT Request)  
4769: Kerberos Service Ticket (ST Request)  