R
n
o
i
t
c
e
t
e
D
)
%
(
e
t
a
R
n
o
i
t
c
e
e
D
t
)
%
(
e
t
a
R
n
o
i
t
c
e
t
e
D
100
90
80
70
60
50
40
30
20
10
0
0
100
90
80
70
60
50
40
30
20
10
0
0
100
90
80
70
60
50
40
30
20
10
0
0
(e) UDP Flood (high-rate)
(f) UDP Flood (low-rate)
Fig. 3. ROCs for diﬀerent attack classes/rates; results of TRW-CB for ﬂooding attacks
are omitted as it had 0% detection rate due to random source IP address spooﬁng used
by ﬂooding attacks.
plots separate ROCs for each attack class and rate. We note that the perfor-
mance of NETAD does not degrade for ﬂooding attacks when p2p traﬃc is
introduced, but its accuracy degrades for portscans. On the other hand, perfor-
mance penalty for Maximum Entropy in case of ﬂooding attacks is much more
than that for portscans. This is mainly because of the diﬀering design principles
of these anomaly detectors. Flooding attacks are detected by NETAD because
the ﬂoods were launched on lower ports [Table 2], whereas p2p communication
10
I.U. Haq et al.
100
90
80
70
60
50
40
30
)
%
(
e
t
a
R
n
o
i
t
c
e
t
e
D
e
g
a
r
e
v
A
20
80
80
70
60
)
%
(
s
e
v
i
t
i
s
o
P
e
s
a
F
l
50
40
30
20
10
0
80
100
MaxEnt on high−rate attacks
MaxEnt on low−rate attacks
NETAD on high−rate attacks
NETAD on low−rate attacks
70
60
Ratio of p2p Traffic (%)
50
40
)
%
(
e
t
a
R
n
o
i
t
c
e
t
e
D
e
g
a
r
e
v
A
90
80
70
60
50
40
30
80
MaxEnt on high−rate attacks
MaxEnt on low−rate attacks
NETAD on high−rate attacks
NETAD on low−rate attacks
70
60
Ratio of p2p Traffic (%)
50
40
(a) Dataset with p2p traﬃc
(b) Dataset without p2p traﬃc
MaxEnt on high−rate attacks
MaxEnt on low−rate attacks
NETAD on high−rate attacks
NETAD on low−rate attacks
)
%
(
s
e
v
i
t
i
s
o
P
e
s
a
F
l
70
60
Ratio of p2p Traffic (%)
50
40
60
50
40
30
20
10
0
80
MaxEnt on high−rate attacks
MaxEnt on low−rate attacks
NETAD on high−rate attacks
NETAD on low−rate attacks
70
60
Ratio of p2p Traffic (%)
50
40
(c) Dataset with p2p traﬃc
(d) Dataset without p2p traﬃc
Fig. 4. Results of training IDSs on p2p traﬃc
was using higher ports for communication. The same attacks degrade Maxi-
mum Entropy detector’s accuracy because p2p traﬃc on higher ports increases
the variance and entropy of the port distribution, thereby resulting in a large
number of false positives from windows containing p2p activity. These results
indicate that depending on the detection principles and features employed by
an anomaly detector, the aﬀect of p2p traﬃc can be much more pronounced for
some attack classes.
We are also interested in determining how p2p traﬃc aﬀects low- and high-
rate attacks. From Figure 3, we observe that detection of low-rate attacks is
much more seriously aﬀected than that of high-rate attacks. Thus p2p traﬃc
inadvertently acts as a very eﬀective evasion cover for low-rate attacks. This
evasion cover is also provided for high-rate attacks, but the cover is blown for
the scenarios where the sustained attack connection rate overwhelms the short-
term p2p connection burst.
4.4 Can an Anomaly Detector Handle p2p Traﬃc if It Is Trained
on a Dataset Containing p2p Traﬃc?
Our performance evaluations thus far have indicated that the p2p traﬃc ad-
versely aﬀects the accuracies of all anomaly detectors evaluated in this work.
What Is the Impact of P2P Traﬃc on Anomaly Detection?
11
We now investigate whether training a detector on p2p traﬃc can mitigate this
torrent eﬀect. To this end, we develop training sets with a proportion of p2p traf-
ﬁc which has been reported in Internet study reports [1]. We vary the proportion
of p2p traﬃc in the training set from 40-80% and train NETAD and Maximum
Entropy on this training set; TRW-CB and Rate Limiting do not require training
and therefore we do not need to evaluate them in the present context. We then
evaluate accuracies of the anomaly detectors on the entire dataset (containing
all the p2p, malicious and background traﬃc).
Figure 4 shows the results for training NETAD and Maximum Entropy on
diﬀerent proportions of p2p traﬃc. It can be clearly seen from Figure 4 that
training Maximum Entropy on p2p traﬃc not only degrades its accuracy but
also increases its false positives rate. In case of NETAD, although we observe
an increase in detection rate, a 30% increase in false positive rate is induced as
we increase the amount of p2p traﬃc in the training set. This is mainly because
p2p clients communicate with each peer on diﬀerent ports and therefore it is
not possible to deﬁne an eﬀective ﬁltering rule for NETAD or derive a robust
baseline distribution for Maximum Entropy. Hence we conclude that training
these anomaly detectors on p2p traﬃc does not mitigate the torrent eﬀect mainly
because contemporary detectors are not designed to ﬁlter or incorporate the
peculiarities of p2p protocols and clients.
5 Mitigating the Torrent Eﬀect
Based on the empirical accuracy results of the last section, in this section we
discuss how can we make an anomaly detector resilient to p2p traﬃc. While
the right method to make an anomaly detector resilient to p2p traﬃc is to avoid
detection features which overlap between malicious and p2p traﬃc, in this section
we only discuss an ad hoc method that can be used to make existing IDSs work
with p2p traﬃc. In the following section, we will discuss how future anomaly
detectors can inherently cater for p2p traﬃc in their design philosophy.
5.1 Can a Pragmatic Solution Be Designed to Make an Anomaly
Detector Insensitive to p2p Traﬃc?
Our evaluations in Section 4 show that the torrent eﬀect is mainly caused by
initiation of a large number of connections by p2p applications and failed con-
nection attempts in those connections. This behavior of p2p applications is a
result of: 1) lack of a central repository in p2p networks to maintain up-to-date
information of available peers; and 2) ensuring robustness in p2p networks even
with high churn rates. While these key design features of p2p networks can be
achieved in a less aggressive manner, p2p applications perform unrelenting at-
tempts to establish connections to thwart techniques to curb p2p connections.
The means used to achieve these design goals of p2p networks result in an overlap
with malicious behavior.
Since p2p protocols are unlikely to change their behavior in the near-term, and
as an IDS designer cannot assume any control over these applications’ behaviors,
12
I.U. Haq et al.
Fig. 5. Mitigating the torrent eﬀect: An IDS with a p2p traﬃc classiﬁcation based
pre-processor
a simple solution to mitigate the torrent eﬀect is to ﬁlter p2p traﬃc at the input
of an anomaly detector using a p2p traﬃc classiﬁer. Filtering of p2p traﬃc will
result in segregation of non-p2p and p2p traﬃc as shown in Figure 5. Such a pre-
processing ﬁlter can be followed by the IDS logic which, in the present context,
will only operate on the non-p2p traﬃc; anomaly detection on the segregated
p2p traﬃc will be discussed in the following section. Since contemporary IDSs
are designed to work with non-p2p traﬃc, detection in the segregated non-p2p
traﬃc will be performed on the unique and non-overlapping characteristics of
malicious traﬃc, thereby yielding good accuracies. This p2p traﬃc classiﬁcation
based solution has an additional advantage that it requires no changes to be made
to existing IDSs. Consequently, at the cost of higher complexity, this generic
p2p traﬃc classiﬁcation based pre-processor can be integrated into any anomaly
detector.
There are two problems with this p2p traﬃc ﬁltering solution: 1) An IDS’
accuracy in this design is closely tied to the accuracy of the p2p traﬃc classiﬁer,
i.e., if the p2p traﬃc classiﬁer can classify p2p traﬃc accurately, then anomaly
detection accuracy will improve, and vice versa; 2) Attacks embedded within p2p
traﬃc will not be detected. The rest of this section address the ﬁrst point, while
the second point is deferred to the next section. In particular, the next subsec-
tion answers the following question: Can existing public p2p traﬃc classiﬁcation