按图索骥,拿到了jquery.min.php样本,揭开了其神秘的面纱。代码中使用了加密和混淆,解密后看到其封装了BossAPI类,该类实现了向后端BOSS层的C&C的通信,并解析响应结果的功能。
[](http://image.3001.net/images/20160118/14531261143011.png)
图 12 BossAPI类
主程序部分包含3个流程,若GET请求参数为空,构造同域名下随机页面,访问并404返回。
[](http://image.3001.net/images/20160118/14531261265829.png)
图 13 GET为空
c_utm流程用于接收来自JS层构造的请求,并随机转发给BOSS层的4台C&C,C&C会根据请求中的参数,下发恶意指令。
[](http://image.3001.net/images/20160118/14531261363357.png)
图 14 c_utm流程
pi流程主要用于接收来自KEEPER层的流量,并转发给BOSS层C&C来校验,用于判定BASE层是否存活以及是否是伪造。
[](http://image.3001.net/images/20160118/14531261497700.png)
图 15 pi流程
同时,发现BASE层同BOSS层的通信同样也存在一定的反侦查策略。另外代码中还自带了xor加密解密类,但目前尚未在主程序中使用。
**3.3. BOSS层分析**
与前面两层不同,BOSS层受感染的机器数量要小得多。截止目前,通过分析多个从BASE层采集到的jquery.min.php及jquery.1.9.1.min.php样本,获得了4个活跃的BOSS层C&C
IP,以及一个闲置的IP。这5个IP的近期流量趋势如下:
[](http://image.3001.net/images/20160118/14531261879084.png)
图 16 BOSS层流量趋势
有意思的是,这5个ip分属不同的5个国家,分别是美国、俄罗斯、立陶宛、法国和印度尼西亚,这些独立IP同样也都是入侵而来。根据我们的数据显示,2015年11月其身影出现在了VVV勒索攻击中,以及一些恶意推广。
[](http://image.3001.net/images/20160118/145312619545.png)
图 17 BOSS层下发的恶意js
只有当需要攻击的时候BOSS层才会下发攻击指令,而平时只会下发重定向请求重定向到Google首页。
[](http://image.3001.net/images/20160118/14531262055108.png)
图 18 BOSS层下发的正常跳转
**3.4. KEEPER层分析**
除了上述几层,在BBOSS技术架构中,还有一层KEEPER层。截止目已发现多个KEEPER层IP,同样分布在不同国家。这一层肉鸡主要用于对JS层的webshell进行探活、增删修改JS层恶意js内容;对BASE层webshell、
juqery.min.php和jquery-1.9.1.min.php进行探活。同时,还会伴随有对JS层网站后台的暴力破解、弱口令猜解、插件漏洞利用、后台上传带后门插件等一系列入侵行为。对KEEPER层最为活跃的来自阿联酋的IP
85.**.**.78进行分析,其流量趋势如下:
[](http://image.3001.net/images/20160118/14531262168879.png)
图 19 某Zombie Keeper流量趋势
可以发现,该Zombie
Keeper并不是每天都在工作,会阶段性的休息且每次休息间隔时间不同,由此推测Keeper是由攻击者主动启动而非定时自动启动。在1226-1229期间,甚至停止活动了4天。同时,对JS层的请求趋势与对BASE层的请求趋势基本相同。
[](http://image.3001.net/images/20160118/14531262231194.png)
图 20 某Zombie Keeper活跃时间矩阵分析
根据近一个月内该Zombie
Keeper每天的活跃时间,绘制如上的时间矩阵图,横轴为日期,纵轴为小时。将不同天的数据重叠到一天,每个小时在不同天出现的次数越多,颜色越深,从而推断出攻击者每天最活跃时间为20点左右持续到次日早8点左右。显然攻击者不是处于UTC/GMT+8时区,经过不断变化时区来拟合数据,最终发现当采用UTC/GMT-5时区时,不仅最活跃时间符合作息规律,且其他所有数据也都惊人的吻合。
[](http://image.3001.net/images/20160118/14531262402442.png)
图 21 UTC/GMT-5时区
这也印证了前文提到的该Zombie
Keeper在1226-1229的停止活动行为,事实上或许是攻击者在UTC/GMT-5时区下1225-1228期间去圣诞度假了。
**4\. 自查方法**
**1\. 查看前台页面是否被插入如下类型或其它异常的JS代码;**
[](http://image.3001.net/images/20160118/14531262536380.png)
2\. 查看后台源码是否被修改,特别是上述框架文件;
3\. 查看后台是否新增异常的源码文件,是否新增js目录及jquery.min.php等;
4\. 查看站点访问记录是否存在暴力破解等异常访问。
**5\. 修复建议**
1\. 审核是否有可疑的新增用户,修改站点密码;
2\. 清除新增或修改的可疑代码;
3\. 清理不再使用的插件,升级CMS及第三方插件到最新版本;
4\. 增加如防暴力破解,WAF等安全防护措施;
**6\. 总结**
综合上述分析和数据,发现BBOSS组织有如下特点:
1.控制超过12万网站,影响范围辐射全球;
2.技术架构体系高度成熟,多级分层,更易控制和隐藏,有很强的攻防对抗意识;
3.业务灵活,高可配置,不定期更新;
4.危害范围极大,影响数以千万互联网用户。