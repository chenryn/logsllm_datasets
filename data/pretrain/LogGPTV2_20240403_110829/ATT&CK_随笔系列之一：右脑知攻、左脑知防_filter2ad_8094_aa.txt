# ATT&CK 随笔系列之一：右脑知攻、左脑知防

##### 译文声明
本文为翻译文章，原文作者为安全牛，来源于安全牛。具体表达及含义以原文为准。
作者：余凯（瀚思科技副总裁）

2019年是一个动荡不安的年份，不仅全球贸易战愈演愈烈，网络安全领域也暗流涌动。上月底，Gartner WEB 应用防火墙 (WAF) 魔力象限中的某领先企业a承认遭受了黑客攻击【1】。尽管该企业一直宣称其核心能力和使命是保护客户的应用和数据安全，但此次事件显然令人尴尬。然而，在今年5月，有国外主流媒体报道【2】称，全球排名前三的安全厂商均被黑客组织Fxmsp攻破，导致源代码泄露。回顾过去几年，谷歌在2018年因数据泄露终止了Google+服务【3】；微软于2017年承认Windows 10源代码泄露【4】；卡巴斯基则在2015年主动披露其内部网络遭到以色列黑客攻击【5】。由此可见，嘲笑某一家企业的安全漏洞并无意义，问题远比想象中严重，并且无人能够置身事外。

基于以上事实，如果某家厂商声称其产品技术能够完全抵御黑客攻击，那显然是夸大其词。即使这些厂商努力澄清并强调持续提升员工的安全意识与流程，也只是在基线路径上迈出了一小步，远远不够。上述事件背后的公司代表了行业安全能力的上限，对于大多数公司而言，面对黑客攻击时，往往只能处于以下四种状态之一：未察觉到自己已被入侵、公众不知晓已发生的入侵、即将被入侵或根本不值得被入侵。国际同行普遍认同“assume breach”（假设已经被入侵）的观点【6】【7】，而上个月ISC大会上，360集团CEO周鸿祎也表示：“没有攻不破的网络”，甚至“敌人已经潜伏其中”。虽然这一观点可能让许多人感到意外，但它确实是现实情况，我们需要更加坦诚地面对问题并进行深层次反思。

## 黑铁时代：人与人间的攻防对抗
我从2010年开始持续关注高级威胁对抗，当时Google公开披露了极光行动【8】。这给我留下了深刻印象，因为当天我们团队研发的漏洞分析引擎(SAL, Script Analyzer Lineup)无需任何修改即可检测出利用零日漏洞(CVE-2010-0249)发起的攻击代码，整个团队为此欢呼雀跃。然而，这只是个开始，随之而来的是整个行业更加激烈的攻防对抗序幕。用“波澜壮阔”来形容并非意味着正义一方取得了压倒性胜利，相反，这是“黑铁时代”，攻击者逐渐占据优势，而当时多数安全厂商长期专注于病毒防护，对基于漏洞的黑客入侵手段缺乏有效的防御措施，甚至对此类通过脚本或文档等手段实施的攻击方式了解甚少。同时，“未知攻、焉知防”的理念开始在华语安全圈内流行。“未知攻、焉知防”传达了一个颠扑不破的道理，近年来大量安全演讲和文章反复提及此观点，使其深入人心。以此为起点，我们可以设想一下，如果我们已知攻击手段会怎样？让我们以美国著名安全公司FireEye为例展开讨论。FireEye成立于2004年，早期获得美国中央情报局投资，最初的安全基因来自老牌安全厂商McAfee。自2013年起，该公司通过收购Mandiant大举进入高级威胁攻防APT市场，并成功在美国纳斯达克上市。FireEye的零日研究团队和Mandiant安全服务团队聚集了一批优秀的白帽黑客，在2013年和2014年间，全球绝大多数基于零日漏洞的APT攻击都是由这两个团队合作发现的，这也推动了FireEye基于沙箱技术的产品迅速占领市场。我当时所在的公司负责与FireEye对标产品的技术研发工作，经过多次一线实战PK后发现，FireEye的产品实际表现与其宣传的能力相去甚远，甚至许多由FireEye自己发现的零日漏洞利用以及APT攻击稍作变化便无法被检测出来。换句话说，发现高级威胁攻击主要依赖于人力，而人的局限性决定了百密一疏成为必然现象，同时安全能力难以复制。尽管FireEye是那个时代高级威胁攻防领域的佼佼者，但在检测黑客攻击方面，其他安全厂商并未取得质的突破。这段经历让我坚信，即便掌握了攻击手段，距离有效防御仍存在巨大差距，亟需突破性的变革与创新。

实际上，回顾安全行业多年发展历程，基本未能摆脱这种格局，原因主要有以下几点：
1. 黑产暴利，国家级攻击不惜成本投入。例如可以参考GandCrab勒索病毒团队的故事【9】，以及NSA如何开发核武级攻击代码【10】。
2. 白帽黑客研究攻击可以获得巨大的声誉和奖励，就像优秀艺术家一样自由发挥创意。然而，甲方的安全产品运维和乙方的安全产品研发需要全面、系统且长期的努力，同时对于组织而言并不创造利润而是成本中心，经常受到安全预算紧张以及面向业务的组织流程限制。
3. 经费问题并非不可解决，毕竟头部客户拥有经济实力，也有解决安全风险的动力。但问题是，如同古代治水故事中的“尧听四岳，用鲧治水。九年而水不息，功用不成”，行业头部客户的领导长期以来无法接受巨额安全投入仍可能被攻破的事实，始终沉浸在甲方万无一失、御敌于国门之外的不可能完成的承诺中，反复围绕漏洞与病毒做“天”“壤”之别的“堵”“堙”文章。病毒防御是“壤”，虽然简单却永远要追赶病毒的变化，导致病毒库不断膨胀；漏洞防御是“天”，零日漏洞无处不在，一旦遇到便是降维打击。

## 青铜时代：聚焦黑客行为的产品改进
好消息是，经过多年来的希望与失望循环，近年来国际安全行业逐渐就“assume breach”达成共识，并将重点转向基于黑客行为的检测方向，专业术语称为TTP（战术Tactic、技术Technique、过程Procedure）。TTP源自军事术语【11】，逐步应用于网络安全场景：
1. 战术是指攻击行为的技术目标；
2. 技术是为了实现战术所采用的手法；
3. 过程则是针对特定技术的具体实现。

对抗黑客攻击的焦点从感染指标(Indicator of Compromise, IOC)转向TTP，围绕痛苦金字塔(Pyramid of Pain)的讨论逐渐展开并形成共识。2013年，FireEye的安全专家David J. Bianco首次提出“痛苦金字塔”概念【12】。国内已有许多关于痛苦金字塔的介绍，本文不再赘述，仅基于该理论提出几个核心观点：
1. 痛苦金字塔的第一层以下构成了行业普遍采用的IOC，它们是黑客实施攻击的工具或成果，通常这些工具只为此次攻击生成，成果也只在此次攻击中出现。
2. 真正有效的检测应基于黑客攻击的一系列手法，包括如何与目标系统互动，这些手法有些是黑客手动试探，有些则通过自动化工具完成。一个类似的比喻是，交警通过摄像头抓取违章行为不会主要依赖车牌或车型。
3. 攻击手法不易改变，正如违章行为相对固定。基于IOC的防御是必要的基础能力，但层次越低，效率越低。
4. 基于IOC或类似特征码的防御性安全设备由于必须阻断，常常成为黑客试探和绕过的验证工具。同时，黑客攻击越来越倾向于从零日攻击和社会工程学开始，使用合法账户和通用工具，甚至系统自带工具实施。这意味着，单靠阻断类安全产品对抗黑客攻击是不够的，还需要具备嗅探、监测、关联、分析和溯源功能的旁路型安全产品作为补充。

随着上述共识的形成，各家安全厂商纷纷开始努力，聚焦黑客行为(TTP)提升检测能力。例如，今年成功上市且风头正劲的CrowdStrike早在2014年就提出了IoA(Indicator of Attack)【13】，而我当时所在公司也提出了EIoC来扩展传统IOC概念。一批经验性规则被提出以IoA或其他形式（如EIoC）描述，并尝试在各自的安全产品中实现。回想起当年在公司内部激烈讨论有关IoA与EIoC潜力对比、规则形成及验证方法等问题，如今结论显而易见——这些尝试在后续几年实践中遇到了重大瓶颈，进展缓慢甚至停滞不前。

根本原因在于所有努力都缺乏一个重要基础：描述黑客行为(TTP)的语言和词汇库。这一点是由高级威胁攻击的独特性决定的：
1. 自2013年起，高级威胁攻击开始被公开披露，当时只有少数几家公司如FireEye、Trend Micro、Kaspersky等能看到相关信息。随着公众关注度提高及国际顶级安全公司的投入，更多公司也开始加入报道行列。但由于事件高度敏感，导致威胁情报难以交换，众多安全公司在面对黑客组织全貌时犹如盲人摸象。