Since we focus on classifying malicious ﬂux services,
and considering that
the number of ﬂux agents for
each ﬂux service network is usually very high, we
only consider clusters of domains for which overall
we observed at least φ1 > 10 resolved IPs. With the
help of our graphical interface, during the entire month
of March 2009 we were able to label 670 clusters as
being related to malicious ﬂux networks of various kinds
(e.g., ﬂux networks serving malware, adult content,
phishing websites, etc.), and 8,541 clusters related to
non-ﬂux/legitimate clusters, including clusters related
to different CDNs, NTP pools, IRC pools, and other
legitimate services. Using this labeled dataset and a 5-
fold cross-validation approach, we evaluated the accu-
racy of our classiﬁer. The obtained results are reported
in Table I. It is easy to see that our network classiﬁer is
able to reach a very high Area Under the ROC curve [1],
and a high detection rate and low false positive rate at
the same time. We performed experiments using three
different sets of features. First, we used all the “passive”
and “active” features described in Section II-F to char-
acterize clusters of domains. Afterwards, we repeated
the same experiments using only the “passive” features
(second row in Table I). From this last experiments,
the C4.5 learning algorithm generated a decision tree
whose root was feature φ6, and with feature φ3 and φ5
as children nodes at the top of the tree. This indicates
that these three features tend to be the most “useful”
ones for distinguishing between malicious ﬂux networks
and legitimate networks. For the sake of comparison, we
318
Authorized licensed use limited to: Tsinghua University. Downloaded on March 25,2021 at 13:12:17 UTC from IEEE Xplore.  Restrictions apply. 
evaluated the classiﬁcation performance of our classiﬁer
using only these three features. As we can see from the
third row in Table I, only three features are sufﬁcient
to obtain very good classiﬁcation results, although us-
ing all the available features produces slightly better
results. Furthermore, we evaluated our classiﬁer in an
operational setting. Namely, we used the entire labeled
dataset described above to train our network classiﬁer,
and then we used the obtained classiﬁer to classify
new (i.e., not seen during training) clusters of domains
obtained in the ﬁrst 14 days of April. During this period
we obtained an average of 448 clusters per day (again,
considering only clusters for which φ1 > 10), 26 of
which (in average per day) where classiﬁed as being
related to ﬂux service networks. We manually veriﬁed
that the classiﬁer correctly labeled clusters related to
malicious ﬂux networks with very few false positives,
thus conﬁrming the results reported in Table I. Overall,
during the entire 45 days period of evaluation, between
March 1 and April 14, 2009, we detected an average
of 23 malicious ﬂux service networks per day, with a
total of 61,710 ﬂux domain names and 17,332 distinct
IP addresses related to ﬂux agents.
D. Can this Contribute to Spam Filtering?
In this Section we analyze to what extent the informa-
tion about malicious ﬂux networks passively gathered at
the RDNS level using our detection system can beneﬁt
spam ﬁltering applications. In particular, we focus on
detecting whether domain names found in spam emails
are somehow related to malicious ﬂux networks detected
by our system. Assume a mail server receives an email
which contains a link to a certain website, performs a
DNS query for the domain name embedded in the link,
and forwards the email to the spam ﬁlter along with the
obtained set, say Rf , of resolved IP addresses. At this
point the spam ﬁlter can inspect the content of the email,
and also check if there is any intersection between the
set Rf and any of the malicious ﬂux networks identiﬁed
by our detection system. If a signiﬁcant intersection
(i.e., common IP addresses) is found, the spam ﬁlter can
increase the spam score related to the email, and use this
information for making a more accurate overall decision
about whether the received email should be classiﬁed as
spam or not. The intuition is that if the domain name
of the website advertised via email points to one or
more previously detected ﬂux agents, it is very likely
that the content of the advertised website is malicious.
A similar spam detection process may be used for
types of spam different from email spam. For example,
using a browser plug-in this spam detection process
may be extended to identify blog spam, social network
%
e
t
a
R
n
o
i
t
c
e
t
e
D
100
95
90
85
80
75
70
65
60
55
50
45
40
35
30
25
20
15
10
5
0
0.0
0.0002
Day 2009-03-04, 33697 spam domains
Day 2009-03-06, 105608 spam domains
Day 2009-03-10, 103554 spam domains
Day 2009-03-15, 168298 spam domains
0.0004
0.0006
0.0008
False Positive Rate % (Alexa TOP domains)
0.001
0.0012
0.0014
0.0016
0.0018
Figure 3: Detection of domains in spam emails.
spam, etc., before the users access the malicious content.
Therefore,
the output of our
malicious ﬂux detection system may contribute to a
number of different spam ﬁltering applications.
is easy to see that
it
In order to measure to what extent our detection
system may beneﬁt email spam ﬁltering, we proceeded
as follows. We obtained a feed of URLs extracted from
spam emails captured by a mid-size email spam-trap
during a period of 30 days, between March 1 and March
30, 2009. This feed provided us with an average of
250,000 spam-related URLs per day, from which we
extracted about 86,000 new (i.e., never seen before)
domain names per day. Let Dk+1 be the set of spam-
related domain names collected on day k + 1, S(d)
k+1 be
the set of resolved IPs obtained by performing one DNS
query for domain d ∈ Dk+1, and ˆRk
k−l be the overall set
of IP addresses of ﬂux agents detected by our malicious
ﬂux network detection system in the period from day
k − l to day k. In order to obtain a suspiciousness score
s(d) for domain d, we use the similarity metric deﬁned
in Equation 1 to compute s(d) = sim(S(d)
k−l),
i.e., the degree of overlap between the resolved IPs of
domain d and the malicious ﬂux networks we were able
to detect from RDNS trafﬁc. If the value s(d) exceeds
a predeﬁned threshold θ, we classify the domain name
d as malicious, otherwise we classify it as legitimate.
We repeat this process for each spam-related domain
name d ∈ Dk+1 to estimate the detection rate of the
proposed approach, namely the percentage of spam-
related domain names that may be identiﬁed by a spam
ﬁlter. Furthermore, we considered the list of domain
names related to the top 50,000 most popular web sites
according to Alexa (www.alexa.com) to estimate the
false positives that may be generated by our detection
approach. Let A be the set of these popular websites.
For each domain α ∈ A, we perform a DNS query
and collect the set resolved IP addresses R(α), and we
compute the similarity score s(α) = sim(R(α), ˆRk
k−l).
Again, if s(α) > θ we classify α as malicious. In
our experiments, we assume the domain names in the
k+1, ˆRk
319
Authorized licensed use limited to: Tsinghua University. Downloaded on March 25,2021 at 13:12:17 UTC from IEEE Xplore.  Restrictions apply. 
set A are legitimate/non-ﬂux domains. Therefore, any
domain α for which s(α) > θ is considered as a false
positive. Figure 3 reports the ROC curves (i.e., the trade-
off between false positive and detection rate) obtained
by varying the detection threshold θ, using a ﬁxed
value of l = 2, and for four different value of k (i.e.,
four different days). It is easy to see that the detection
approach described above produces a detection rate of
domain names advertised through spam emails between
90% to 95%. It is worth noting that not all of the
detected malicious domains are necessarily fast-ﬂux
domains. We noted that several of the domain names
detected as malicious did not appear to have a “ﬂuxing”
behavior themselves, but resolved to a ﬁxed set of IP
addresses that partially intersected with the IP addresses
of ﬂux agents we detected from our passive analysis of
RDNS trafﬁc. A more detailed analysis revealed that
these ﬁxed sets of ﬂux agents consisted of machines
with a high average uptime. Therefore, we speculate that
highly reliable compromised machines may be used as
part of larger ﬂux service networks, as well as “stand-
alone” providers of malicious content. It is also worth
noting that the false positive rate of our approach for
detecting spam-related malicious domains is less than
0.002%. This conﬁrms that our malicious ﬂux network
detection system is a very promising approach and may
substantially beneﬁt spam ﬁltering applications.
0716570 and 0831300, the Department of Homeland
Security under contract no. FA8750-08-2-0141, the Of-
ﬁce of Naval Research under grant no. N000140911042.
Any opinions, ﬁndings, and conclusions or recommen-
dations expressed in this material are those of the
authors and do not necessarily reﬂect
the views of
the National Science Foundation, the Department of
Homeland Security, or the Ofﬁce of Naval Research.
REFERENCES
[1] A. P. Bradley. The use of the area under the ROC curve in the
evaluation of machine learning algorithms. Pattern Recognition,
30(7):1145–1159, 1997.
[2] R. Dugad and N. Ahuja. Unsupervised multidimensional hier-
archical clustering.
In International Conference on Acoustics,
Speech and Signal Processing, 1998.
[3] T. Holz, C. Gorecki, K. Rieck, and F. Freiling. Measuring and
detecting fast-ﬂux service networks. In Network & Distributed
System Security Symposium, 2008.
[4] X. Hu, M. Knysz, and K. G. Shin. Rb-seeker: Auto-detection of
redirection botnets. In Network & Distributed System Security
Symposium, 2009.
[5] A. K. Jain and R. C. Dubes. Algorithms for clustering data.
Prentice-Hall, Inc., 1988.
[6] A. K. Jain, M. N. Murty, and P. J. Flynn. Data clustering: a
review. ACM Comput. Surv., 31(3):264–323, 1999.
[7] M. Konte, N. Feamster, and J. Jung. Dynamics of online
scam hosting infrastructure. In Passive and Active Measurement
IV. CONCLUSION
Conference, 2009.
In this paper we presented a novel, passive approach
for detecting malicious ﬂux service networks in-the-
wild. Our detection system is based on passive analysis
of recursive DNS (RDNS) trafﬁc traces. Contrary to
previous work, our approach is not
limited to the
analysis of suspicious domain names extracted from
spam emails or precompiled domain blacklists. Instead,
we are able to detect malicious ﬂux service networks as
they are accessed by users who fall victims of malicious
content advertised through different forms of spam. We
experimented with the RDNS trafﬁc passively collected
at two large ISP networks, and showed that the proposed
approach is able to accurately detect malicious ﬂux
service networks. Furthermore, we showed how our
passive detection and tracking of malicious ﬂux service
networks may beneﬁt spam ﬁltering applications.
ACKNOWLEDGMENTS
We would like to thank Giorgio Giacinto and the
anonymous reviewers for their helpful comments on
earlier versions of this paper.
This material is based upon work supported in part
by the National Science Foundation under grants no.
320
[8] J. Nazario and T. Holz. As the net churns: Fast-ﬂux botnet
observations.
In International Conference on Malicious and
Unwanted Software, 2008.
[9] E. Passerini, R. Paleari, L. Martignoni, and D. Bruschi. Fluxor:
Detecting and monitoring fast-ﬂux service networks. In Detec-
tion of Intrusions and Malware, and Vulnerability Assessment,
2008.
[10] J. R. Quinlan. C4.5: Programs for Machine Learning. Morgan
Kaufmann Publishers, 1993.
[11] SSAC. SAC 025 - SSAC advisory on fast ﬂux hosting and DNS,
2008.
[12] The Honeynet Project. Know your enemy: Fast-ﬂux service
networks, 2007.
APPENDIX
In the additional ﬁltering step F3, we apply the fol-
lowing ﬁltering rules (see Section II-D for the notation),
where the subscript E indicates that the quantities are
measured at the end of an epoch E = 1 day:
F3-a) TE  0.5 AND TE 6 3600 AND |G
(d)
E | > 10
(d)
E | > 5 AND pE > 0.8
(d)
E | > 10
(d)
E | > 5
F3-b) |R
F3-d) |R
Authorized licensed use limited to: Tsinghua University. Downloaded on March 25,2021 at 13:12:17 UTC from IEEE Xplore.  Restrictions apply.