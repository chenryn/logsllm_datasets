Canaan Kao, Chuang Wang, I-Ju Liao
PI:EMAIL
PI:EMAIL
SOME THINGS BEFORE NETWORK ATTACK
(A LONG TIME OBSERVATION)
网路攻击之前的二三事
AGENDA
• The Motivation
• Port Scan 101
• IDS/IDP-based Port Scan Detection
• Honeypot-based Port Scan Detection
• Play with SDN switch
• A Long Time Observation
• A legacy of Anti-Botnet Project
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
2
WHO AM I?
• 十几年前，在读大学的时候，写 OpenSource 的网
管软体报告，抽签抽到 Snort.
• 后来在一家做 IDS/IPS 的公司，写了十几年的 code。
• 之后意外地，在我青春的尾巴，执行了教育部的
Anti-botnet 计画五年，办了四届的 Botnet of Taiwan 
(BoT)研讨会。
• 不要问我今年有没有 BoT2014?
• 去年不小心成为 Anti-Virus 厂商的员工。
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
3
WHO AM I?
一些曾经讲过的
• 2010 Spam Source Detection at Home
• http://www.anti-botnet.edu.tw/content/confs/BoT2010.PPTs/B5.php
• 2012 The Botnet Traffic Forensics System
• http://www.anti-botnet.edu.tw/content/confs/BoT2012.PPTs/B5.php
• 2013 APT/Malware Traffic Detection
• http://www.anti-botnet.edu.tw/content/confs/BoT2013.PPTs/B5.php
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
4
一些缩写
• IDS: 不具备阻挡功能的入侵侦测系统
• EX: Snort 
• IPS: 具备阻挡功能的入侵侦测系统
• EX: Snort-inline
• FW: FireWall 防火墙
• EX: NetFilter / iptables
• LAN: 以 FW 为界的内网
• WAN: 以 FW 为界的外网
• SDN: Software-defined Network
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
5
THE MOTIVATION
关于内贼(BOT)的侦测位置
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
6
THE MOTIVATION
关于侦测的时机
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
7
THE MOTIVATION
只能事后侦测吗？
• 假设 Malware 透过行动载具或是其他方式
已经进入到内网，我们有什么方式可以察
觉或是阻止内网的设备 受到攻击/感染？
• 或是我们只能做寻找哪些主机已经变成
bot 的事后侦测?
• 如果攻击的封包完全不经过 GW / FW / IDS 
/ IPS，那我们还能侦测得到吗？
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
8
THE MOTIVATION
IDS/IPS 产业公开的秘密
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
9
• 针对网路上的攻击，基本上是厂商必
须先拿到攻击样本或是恶意程式，其
所属的 IDS 或是 IPS 才会有侦测率。
• 所以如果遇到 0day，或是新式攻击，
被攻击成功的机会就很大。
• 因此，针对 Botnet / APT，做事后的侦
测是比较有把握的。
• But….
THE MOTIVATION
看个新闻 (智慧家电越来越多了)
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
10
•
来源：苹果日报
THE MOTIVATION
以后家庭生活都可以透过网路控制
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
11
http://server1.she777.com/images/www.joybien.com/images/HOME/SmartHome_760x500.jpg
THE MOTIVATION
一个问题
• 假设有一个攻击 智慧冰箱 的 Malware，
且这个 Malware 已经殖入你的行动装置。
而你回家的时候，它也跟你一起回家。
• 它要怎么知道你家有可以攻击的 智慧冰
箱 呢？
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
12
THE MOTIVATION
• 最简单的 probe 方式就是 port scan。
• IDS / IPS / FW 应该要有反应？不是吗？
• 等一下会解释为什么它们可能不会叫。
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
13
PORT SCAN 101
• 基本上 Port Scan 可以分成两种：
• Vertical Scans 
• Single Host Target
• Nmap 预设是这种
• Horizontal Scans
• Single Service Port Target
• aka Port Sweep Scan
• Bot/Malware 比较常用这种
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
14
PORT SCAN 101
• Port Scan 最主要想知道两件事
• 1. 目标机器有没有开？
• 发 TCP Syn 无回？
• 2. 如果有开(有回)，那 Service 有没有开？
• 回 SYN+ACK
• 回 RST+ACK 
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
15
PORT SCAN 101
• 不过 Port Scan人人会 ，巧妙各有不同。
• Nmap
• Bot/Malware
• Bot/Malware 的扫法和你想的不太一样
• Internet Scan
• 这阵子很流行
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
16
Port Scan 101
Nmap (1K ports/30 seconds)
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
17
PORT SCAN 101
BOT/MALWARE-PERL-BOT(ESKENT)
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
18
PORT SCAN 101
BOT/MALWARE-ILEGALBRAIN_PERLBOT
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
19
PORT SCAN 101
INTERNET SCAN
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
20
PORT SCAN 101
INTERNET SCAN
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
21
PORT SCAN 101
MASSCAN -P80 140.114.71.0/24 --RATE=10000
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
22
PORT SCAN 101
MASSCAN -P80 140.114.71.0/24 --RATE=10000
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
23
PORT SCAN 101
INTERNET SCAN (一些相关单位)
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
24
Source: us-14-Schloesser-Internet-Scanning-Current-State-And-Lessons-Learned.pdf
PORT SCAN 101
INTERNET SCAN
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
25
• 以前，我们会想，我们把重要的 Service 
放在 Internet Scanning 扫不到的地方，不就
好了？
• 例如: 放在 LAN 端，有 FW 保护，不开
Virtual Server 或是 Port Mapping，只对内
服务，这样不就没事了？
IDS/IDP-BASED PORT SCAN DETECTION
• Snort v2.9.2 的 default setting 是这样
• 预设是 disabled
• Detection Level: low
• For getting few false positives.
• Time window is 60 seconds.
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
26
IDS/IDP-BASED PORT SCAN DETECTION
• 基本上是计算单位时间内发现的 port scan 事
件次数。
• 是一个 threshold。
• 只要低于 threshold 就可以绕过。
• False Positive?
• 某些正常连线看起来会像 port scan 的
行为。
• 那基准值/参考值是什么？
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
27
IDS/IDP-BASED PORT SCAN DETECTION
• 如果你今天买了台具备侦测 Port Scan 能
力的 IDS / IPS / FW，你会怎么验？
• 大家都爱 Nmap 
• 有人会养个 bot 扫扫看吗？
• 所以针对 bot / malware 所发出的 port 
scan ，如果你买的那个资安设备不会
叫，是可以了解/谅解的。
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
28
IDS/IDP-BASED PORT SCAN DETECTION
• 如果今天 port scan 的 packets，不经过 IDS / 
IPS / FW呢? 
• 法外之地？
• LAN  LAN traffic
• 如果Traffic有流经FW的 LAN Ports，之前
的资安设备会假设这个方向的 traffic 应
该不会有攻击，所以 通常不检查，采
用硬体交换居多。
• Wireless LAN (WLAN)  LAN traffic
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
29
IDS/IDP-BASED PORT SCAN DETECTION
对于 PORT SCAN可能不会叫的原因
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
30
• 侦测的功能没开？
• 大家可以回去检查一下 Home GW 的预
设值
• 侦测的方式对不上
• 清朝的剑与明朝的官
• Threshold 被绕过
• Traffic 没经过
HONEYPOT-BASED PORT SCAN DETECTION
• 因为 LAN  LAN之间的 Attack 不会被 FW /
IDS 看到，所以为了侦测 LAN  LAN 之间
的 Attack，我们使用了 HoneyPot。
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
31
HONEYPOT-BASED PORT SCAN DETECTION
WHAT IS HONEYPOT?
• 就我个人的定义：
• 所有可以用来诱使坏人或是恶意程式展露
其行为或意图的系统
• 所以它可以是
• 一台 Server
• 一个 VM
• 一个 Web Client
• ….
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
32
HONEYPOT-BASED PORT SCAN DETECTION
• 简单地说，这个方法就是用一个影武者设
备(H)，放在需要被保护的主机(S)的旁边，
H 的 IP 也设在 S 的附近。
• H 完全不开 services，或是只开少量的
services，外界完全不知道 H 的存在，所
以 H 只要收到来自不明主机(A)的一个
TCP SYN for a closed port，就可以大胆判定
A 是 Scanner。
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
33
HONEYPOT-BASED PORT SCAN DETECTION
再看一次 SWEEP SCAN
2014/8/22
SOME THINGS BEFORE NETWORK ATTACK
34
HONEYPOT-BASED PORT SCAN DETECTION