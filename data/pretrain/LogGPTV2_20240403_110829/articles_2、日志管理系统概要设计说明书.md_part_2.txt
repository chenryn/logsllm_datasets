### 3.1.2 资源协调
一个针对大型分布式系统的高可靠协调系统，提供的功能包括：配置维护、名字服务、分布式同步、组服务等。封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。由3台或3台以上奇数台服务器组建完成，具有如下3个特性：
提供丰富的构件来实现多种协调数据结构和协议。
访问原子性，客户端要么读到所有数据，要么读取失败，不会出现只读取部分的情况。
具有高可用性，帮助系统避免单点故障，故障时可以快速删掉故障服务器。故障回复时，重新加入到集群。
模块架构如下：
![](media/image5.png){width="5.768056649168854in"
height="4.141936789151356in"}
### 3.1.3 消息系统
用于消息的持久化和缓存。该系统使用磁盘文件做持久化，顺序进行读写，以append方式写入文件。为减少内存copy，集群使用sendfile发送数据，通过合并message提升性能。集群本身不储存每个消息的状态，而使用（consumer/topic/partition）保存每个客户端状态，大大减小了维护每个消息状态的麻烦。在消息推拉的选择上，集群使用拉的方式，避免推的方式下存在的各个客户端的处理能力、流量等不同产生不确定性。以多机形式形成集群，建议3台或3台以上奇数台服务器组建，并且支持分区副本。
模块架构如下：
![](media/image6.png){width="5.768056649168854in"
height="4.391872265966754in"}
### 3.1.4 日志处理
> 日志易自主研发流式处理引擎，构建的高性能、分布式日志处理架构可以每秒钟分析10万条日志，每天可以处理TB级的日志量，而且处理延时非常短，可以让用户搜索、分析几秒钟之前产生的日志。
>
> 流式计算集群具有如下特性：
轻量级快速处理
> 着眼大数据处理，速度往往被置于第一位。流式处理引擎中的应用程序在内存中以100倍的速度运行，它们将中间处理数据全部放到了内存中。
无数据丢失
> 系统需要保证无数据丢失，这也是系统高可用性的保证。系统为了无数据丢失，需要在数据处理失败的时候选择另外的执行路径进行replay（系统不是简单的重新提交运算，而是重新执行调度，否则按照来源的call
> stack有可能使得系统永远都在相同的地方出同样的错误）。
无数据重复
> 系统需要保证无数据重复，来保证系统功能的正确性。为了保证数据不重复，在数据可能丢失的时候重试，通过日志存储引擎来去掉重复数据。
容错透明
> 用户不会也不需要关心容错。系统会自动处理容错，调度并且管理资源，而这些行为对于运行于其上的应用来说都是透明的。
>
> 模块架构如下：
>
> ![](media/image7.png){width="5.768056649168854in"
> height="5.057540463692039in"}
### 3.1.5日志检索
索引集群是一个的分布式搜索引擎，具备高可靠性和高性能。支持时间文本索引和全文检索，提供丰富的api用于索引、检索、修改大多数配置。能够快速搜索数百亿的日志以及TB级的数据，结构化或者非结构化的数据都可以。
集群由2台及2台以上节点组成，其中一个为主节点，节点通过选举产生，主从节点是对于整个集群内部来说的，从外部来看整个集群，逻辑上是一个整体，与任何一个节点的通信和与整个集群通信是完全一致的。集群自动创建索引，通过配置我们可以非常方便的调整索引分片和索引副本。通过索引分片技术，一个大的索引被拆分成多个，然后分布在不同的节点上，以构成分布式搜索。索引副本的作用一是提供系统的容错性，当摸个节点摸个分片损毁或丢失时，可以从副本中恢复；二是提供查询效率，集群内部会自动实现搜索请求的负载均衡。
模块架构如下：
![](media/image8.png){width="5.768056649168854in"
height="4.687963692038495in"}
### 3.1.6 WEB服务
WEB服务提供日志展现、数据可视化，支持各种统计功能及图表展现，实现流畅的图形用户交互。展示时间折线图、条形图、饼状图等，让数据分析更直观。
集群主要是多主结构，各个节点完全平行，前端支持NGINX作为负载均衡器，增强了系统跨平台、快速部署等特性。
模块架构如下：
![](media/image9.png){width="5.768056649168854in"
height="4.370424321959755in"}
## 3.2 应用部署方案
### 3.2.1应用部署概况
应用部署策略用以指导用户依据自身的业务规模，以及对性能、可靠性等方面的具体要求，来确定合适的系统配置和部署方案。用户的环境和要求千差万别，本节只是给出一个指导性的配置策略，依实际情况的不同，用户可能需要在本部署策略的基础之上做适当调整以满足特定需求。
### 3.2.2 部署规模与资源需求
日志易系统可以在单台服务器部署(每天为数GB的数据导入并创建索引)，也可以在数台到数十台服务器的集群上部署(要为数
TB 数据创建索引)。
如何评估部署规模？
部署的特性因规模不同而异，但规模只是影响部署需求和架构的诸多因素之一。以下推荐值可为您的规划提供一些参考，每个特定部署的实际数量将有所出入，根据日志量大小，我们为分别为用户提供了小型、中型、大型3种推荐部署方案，部署的特性将随着规模的增长而变化，您可以在一定程度上了解所需要的内容。
**CPU**资源需求：
小型
数据量20-100 GB/日，1000 \~ 5000 eps （event per
second，每秒日志数量），需要10-20核CPU。
中型
数据量100GB-300GB /日，5000 \~ 15000 eps，需要20-54核CPU。
大型
数据量 \>= 300GB /日，20000+ eps，至少需要54核CPU。
磁盘容量需求：
磁盘容量需求主要集中在消息队列集群和索引集群。我们建议使用带副本的集群方案作为数据容灾的考虑。对于数据的保留方式，通过如下的计算公式便可以根据自身情况进行磁盘容量评估。
消息队列集群
磁盘容量 =（原始日志大小（GB）／24小时）\*
峰值（3倍）消息队列存储放大系数（6）\* 存储份数（2份）\* 保留小时数
／（机器数 \* 磁盘使用率（80%））
示例：
  -------------------------------------------------------------------------------------------
  磁盘需求   机器数   保留时间   存储份数   磁盘需求   计算方法
  ---------- -------- ---------- ---------- ---------- --------------------------------------
             3        2 小时     2          1.25 TB    （原始日志大小（1000GB）／24小时）\*
                                                       峰值（3倍）\*
                                                       消息队列存储放大系数（6） \*
                                                       存储份数（2份）\* 保留小时数
                                                       ／（机器数 \* 磁盘使用率（80%））
                      8 小时     2          5 TB       
  -------------------------------------------------------------------------------------------
索引集群
磁盘容量 = 原始日志大小（GB）\* 索引放大系数（2.5倍）\* 索引份数 \*
保留天数 ／ （ 机器数 \* 磁盘使用率（80%））
索引放大系数与抽取的关键字段数相关，抽取的关键字段数越多，索引放大系数就越大，2.5倍是最大值。
示例：
  -------------------------------------------------------------------------------
  磁盘需求   机器数   保留时间   索引份数   磁盘需求   计算方法
  ---------- -------- ---------- ---------- ---------- --------------------------
             36       3天        2          370 GB     原始日志大小（1000GB）\*
                                                       索引放大系数（2.5倍）\*
                                                       索引份数（2） \* 保留天数
                                                       ／ （ 机器数 \*
                                                       磁盘使用率（80%））
                      7天        2          1.22 TB    
  -------------------------------------------------------------------------------
### 3.2.3 部署方案
单机部署
1台服务器部署日志易所有产品模块。
最低配置：
OS：CentOS 6.5 x86_64
CPU：4核 2.0GHz
MEM：16GB
DISK：300GB
处理能力：1000 eps以下。
适用场景：处理小流量数据、体验试用日志易产品。
集群部署
日志易整个系统有多个模块构成，用户可以根据自身服务器资源、数据量、系统稳定性等因素自定义各个模块的节点组成。推荐各个模块的集群均有3台及3台以上服务器构成，同时支持物理机和虚拟机混合部署。
示例1.
3台物理机，每台24核、64GB内存，可处理20000
eps条日志。相当于300GB-400GB/天日志量。
示例2.
3台物理机，每台24核、96GB内存，切分成18台虚拟机（每台4核、8GB\~16GB内存），可处理20000
eps条日志。相当于300GB-400GB/天日志量。
北京优特捷信息技术有限公司
北京市朝阳区望京阜通西大街望京SOHO T2-B座-1707
邮编：100102
电话：010-64785156
[[https://www.rizhiyi.com]{.underline}](https://www.rizhiyi.com)