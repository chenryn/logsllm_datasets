**基于大数据技术的机器数据搜索分析平台设计与实现**
2017年11月
# 目 录 {#目-录 .}
摘要 [1](#摘要)
1 背景 [2](#背景)
2 机器数据搜索分析平台的建设意义 [3](#机器数据搜索分析平台的建设意义)
3 机器数据搜索分析平台设计与规划 [4](#机器数据搜索分析平台设计与规划)
**3.1.** **机器数据搜索分析平台架构设计** [4](#_Toc7515626)
**3.2.** **机器数据搜索分析平台技术实现** [5](#_Toc7515627)
**3.2.1** **机器数据采集技术** [6](#_Toc7515628)
**3.2.2** **消息队列技术** [6](#_Toc7515629)
**3.2.3** **集群资源同步与管理技术** [7](#_Toc7515630)
**3.2.4** **机器数据分析技术** [7](#_Toc7515631)
**3.2.5** **搜索引擎技术** [8](#_Toc7515632)
4 实验与结论分析 [8](#实验与结论分析)
4.1机器配置 [8](#_Toc7515634)
• 4.2实验结果 [8](#_Toc7515635)
结语 [9](#结语)
# 摘要 {#摘要 .list-paragraph}
IT系统的正常运行为电力系统的生产安全、稳定运行提供了重要保障。本文探讨了利用大数据技术对机器数据进行统一采集、分析对系统运维工作的意义，并对机器数据搜索分析平台进行技术架构设计与实现。
**关键词 机器数据搜索分析平台 大数据 运维**
# 背景
随着信息时代的来临，电力行业中的IT系统越来越复杂，其正常运行为电力系统的生产安全、稳定运行提供了重要保障，运维难度也随之加大。目前电网公司都已建立了集中的运维和监控系统，并初步实现了对信息化基础设施、各级应用的数据采集、告警和基本的审计功能。
如同高德纳公司的报告里提到的那样，业界普遍认同所谓"大数据"具有明显的"3V特征"：量级（Volume），速度（Velocity）和多样性（Variety）。大数据普遍具有量级大，要求处理速度快，数据本身具有丰富的多样性。在甲骨文公司和中国移动研究院的相关研究文档里，都追加了第四个V------Value，价值，而IBM在其相关文档中给出的第四个"V"则是真实性（Veracity）
。机器数据是大数据分类中，由机器直接生成的数据，也是发展最快、最为复杂，同时极具商业价值的大数据组成形式。大数据中90%的数据属于机器数据。除了来自于服务器、存储、网络中的传统IT数据以外，来自移动互联网、物联网中的大量非结构化数据也都属于机器数据。借助大数据技术能够实现对机器数据的深入挖掘，充分利用数据价值，提升数据分析质量，保证IT系统稳定运行。
但因受制于建设时期的技术制约，电力行业在对机器数据的分析处理方面已逐渐无法适应新环境、新运维模式下的管理要求。专用的机器数据审计只能收集部分审计机器数据，缺乏统一的数据采集、格式和存储规范。通过对机器数据进行精细化管理，对机器数据统一收集，规范采集、存储和解析，实现机器数据的秒级查询，做到能对紧急事件快速响应，实现机器数据数据的可视化，并通过数据统计分析进一步形成网络活动报告、资源访问报告、关键错误和故障报告等。
IT部门的价值首先是业务保障，业务得到保障，企业的正常活动才能开展，业务故障及时的处置，使运维工作能够更好地为业务服务，业务能够更快从故障中恢复，获得更高的可用性。
# 机器数据搜索分析平台的建设意义
基于大数据技术的机器数据搜索分析平台能够对全网范围内的主机、服务器、网络设备、数据库以及各种应用服务系统等产生的各类机器数据，进行规范采集，统一规范机器数据格式，统一持久化存储，统一策略制定，并进行细致分析，通过统一的控制台进行实时可视化的呈现。通过定义机器数据筛选规则和策略，帮助工作人员从海量机器数据中精确查找关键有用的事件数据，准确定位网络故障并提前识别安全威胁，保障企业网络安全，同时能够收集运行类、安全类、行为类的机器数据信息，实现对在线业务系统最全面的分析。分析在线业务系统所在主机的运行状态与错误信息，中间件运行状态与错误信息，关联业务系统本身机器数据事件，对业务系统出现的问题进行快速定位并分析原因，结合已有的知识库分析预测在线业务系统可能出现的问题。
机器数据搜索分析平台优势：
-   实时性强
> 建立统一的机器数据搜索分析平台实时采集数据，对海量机器数据信息进行组合条件检索查询，真正实现了即查即显。查询结果根据归一化后的格式展现。同时为具有一定专业知识的运维人员提供归一化机器数据与原始机器数据同屏显示功能，运维人员可以更深入的分析原始机器数据数据。支持多条件机器数据检索查询；支持原始机器数据全文检索。
-   一体优化考虑，一站式问题会诊
> 机器数据搜索分析平台将机器数据集中采集，运维人员基于多种维度全面审视，通过机器数据关联分析等方式，快速定位，排查故障原因。
-   可对操作人员行为审计
> 满足审计记录的规范化的需求，由于全网设备种类繁多，各设备机器数据信息存储格式、字段含义、通信协议差异较大。需要对采集到的各种设备机器数据进行归一化处理，提取审计记录完整信息，为后续审计分析提供依据。
机器数据搜索分析平台要可持续扩展、不形成信息孤岛，不受业务变更左右。同时，机器数据搜索分析平台兼容云平台和虚拟化环境，支持开源平台数据接入，最大程度保障系统可用性规避软件快速迭代，不受业务变更影响，可与原有监控平台之间结合，不浪费客户原有投资，减轻客户在开发及维护上的负担，保证可持续扩展。
# 机器数据搜索分析平台设计与规划
1.  []{#_Toc7515626 .anchor}**机器数据搜索分析平台架构设计**
-   物理支撑层：采用分布式集群方式搭建机器数据中心环境，借助云计算机能力和存储的弹性扩展能力为机器数据中心提供可靠的运行环境。
-   机器数据采集层：机器数据中心依据机器数据采集规范通过Agent、Syslog、ODBC、SNMP
    Trap、Socket、File等多种接口，采集各设备、系统和应用的本地型机器数据等；通过镜像等方式采集网络型机器数据，通过两种采集方式的合理配置，实现全部设备和资源的机器数据采集。
-   机器数据存储、加工层：实现机器数据的持久化、结构化存储，统一机器数据格式，并根据规则、策略库，对机器数据进行加工处理，结合资产信息实现机器数据信息的关联。
-   数据处理层：采用分布式搜索引擎，支持时间文本索引和全文检索，能够快速搜索TB级数据，结构化或者非结构化的数据，具备高可靠性和高性能。
-   应用与展现层：实现系统管理、策略制定、规则制定、关键业务参数配置等基本业务功能，提供常用的告警分析场景，实现海量机器数据的快速查询，数据分析统计及可视化，并提供对外接口服务，方便系统进行二次开发。
1.  
2.  
3.  
4.  
5.  
6.  
7.  
8.  
9.  
10. 
11. 
```{=html}
```
1.  消息队列技术 ②集群资源同步与管理技术
```{=html}
```
2.  []{#_Toc7515627 .anchor}**机器数据搜索分析平台技术实现**
```{=html}
```
1.  []{#_Toc7515628 .anchor}**机器数据采集技术**
基于大数据技术的机器数据搜索分析平台需要一个高可用，高可靠，分布式的海量机器数据采集、聚合和传输的系统，支持在机器数据系统中定制各类数据发送方，用于收集数据；同时提供对数据进行简单处理，并写到各种数据接受方（可定制）的能力。同时满足可靠性，当节点出现故障时，机器数据能够被传送到其他节点上而不会丢失。集群提供end-to-end模式来保障可靠性：收到数据agent首先将event发送到后端消息队列集群，如果数据发送失败，将event写到磁盘上，可以重新发送。同时满足可扩展性，不存在单点故障问题。每个节点均提供metric
api接口，以JSON格式数据展现服务状态，方便提供服务指标和运维监控。
2.  []{#_Toc7515629 .anchor}**消息队列技术**
该平台需要消息队列技术用于消息的持久化和缓存。使用磁盘文件做持久化顺序进行读写，以append方式写入文件。为减少内存copy，集群使用sendfile发送数据，通过合并message提升性能。集群本身不储存每个消息的状态，而使用（consumer/topic/partition）保存每个客户端状态，以减小维护每个消息状态的麻烦。在消息推拉的选择上，集群使用拉的方式，避免推的方式下存在的各个客户端的处理能力、流量等不同产生不确定性。以多机形式形成集群，建议3台或3台以上奇数台服务器组建，并且支持分区副本。
消息队列对消息保存时根据Topic进行归类，一个Topic可以认为是一类消息，每个topic将被分成多个partition(区),每个partition在存储层面是append
log文件。任何发布到此partition的消息都会被直接追加到log文件的尾部，每条消息在文件中的位置称为offset（偏移量），offset为一个long型数字，它是唯一标记一条消息。
![](media/image2.png){width="3.5305555555555554in" height="2.28125in"}
3.  []{#_Toc7515630 .anchor}**集群资源同步与管理技术**
平台使用针对大型分布式系统的高可靠协调系统，提供配置维护、名字服务、分布式同步、组服务等。封装好复杂易出错的关键服务，只提供简单易用的接口和高效稳定的系统。由3台或3台以上奇数台服务器组建完成，提供构件来实现多种协调数据结构和协议。
4.  []{#_Toc7515631 .anchor}**机器数据分析技术**
采用业界最先进的流式大数据处理架构Spark
Streaming，构建的高性能、分布式机器数据处理架构可以每秒钟分析10万条机器数据，每天可以处理TB级的机器数据量，而且处理延时非常短，可以让用户搜索、分析几秒钟之前产生的机器数据。Spark允许Hadoop集群中的应用程序在内存中以100倍的速度运行，即使在磁盘上运行也能快10倍。Spark通过减少磁盘IO来达到性能提升，它们将中间处理数据全部放到了内存中。
平台为保证无数据丢失，在数据处理失败的时候选择另外的执行路径进行replay（系统不是简单的重新提交运算，而是重新执行调度，否则按照来源的call
stack有可能使得系统永远都在相同的地方出同样的错误）。系统会自动处理容错，调度并且管理资源，
5.  []{#_Toc7515632 .anchor}**搜索引擎技术**
集群由2台及2台以上节点组成，其中一个为主节点，节点通过选举产生，主从节点是对于整个集群内部来说的，从外部来看整个集群，逻辑上是一个整体，与任何一个节点的通信和与整个集群通信是完全一致的。集群自动创建索引，通过配置我们可以非常方便的调整索引分片和索引副本。通过索引分片技术，一个大的索引被拆分成多个，然后分布在不同的节点上，以构成分布式搜索。索引副本的作用一是提供系统的容错性，当摸个节点摸个分片损毁或丢失时，可以从副本中恢复；二是提供查询效率，集群内部会自动实现搜索请求的负载均衡。索引集群支持时间文本索引和全文检索，提供丰富的api用于索引、检索、修改大多数配置
# 实验与结论分析
**4.1数据检索能力试验**
4.  
    1.  
    2.  
    3.  
**4.1.1全局数据查询**
**关注点：**
返回结果时间
**测试方法：**
在查询界面对指定时间（如全天或三天）的全量数据，观察splserver机器数据查询消耗时间，预估2.5亿条数据，查询返回10s以内。
**查询语句：**
**"**\***"**
  ------------ -------------------- -------------- ------------- -----------
  测试周期     索引时间范围         机器数据总数   查询耗时      平均耗时
  第1次查询    20170721 -- 20170722 108,492,156    7136ms        7226.2ms
  第2次查询    20170721 -- 20170722 108,492,156    7145ms        
  第3次查询    20170721 -- 20170722 108,492,156    7180ms        