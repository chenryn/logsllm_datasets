动态数据变更 传统CMDB对某个配置项变更需要更 数据库可以在节点之间、应用的层级架
新大量关联信息 构之间任意地插入节点，应用也几乎无
需作出修改，保证关系更新的动态化
基于图的故障影响分析 根据静态配置或者人工经验判断故障 通过知识图谱构造故障传播关系图，可
影响范围与传播过程 以模拟故障传导、影响衰减等特性，便
捷地判断故障影响范围和可能根因等
情况
4.6 数据采集处理领域
数据工厂采用的数据采集分析模块是成熟的国内自研产品，接入日志后可开箱即用。
可统一收集、检索、关联所有应用程序、服务器和设备生成的各种格式的日志。
与其他产品对比：
18
技术创新点 国内外、同行业现状 本项目优势
日志管理-日志收集 ELK：不支持界面化配置，全部依靠后台； 全部支持
（syslog，增量读取文件，日志限速， 启明：只能支持网络设备，安全设备接入，
压缩，加密，多行合并） 应用日志接入较弱；
Splunk：不支持界面化配置压缩和加密功能。
日志管理-全文检索、日志归档、日 ELK：支持； 全部支持
志告警 启明：支持；
Splunk：支持。
日志分析-可编程语言实现关联分析 ELK：支持； 支持，有丰富的SPL语言
启明：支持；
Splunk：支持。
数据级权限管理 ELK：不支持； 支持
启明：不支持；
Splunk：支持。
简易性的使用方式 ELK：需依靠技术社区自学； 配置灵活，有很多封装好APP
启明：场景固化使用比较简单，配置不够灵 能提供丰富性能监控等场景
活；
Splunk：配置灵活，有很多封装好APP。
平台横向扩展能力 ELK：横向扩展操作复杂； 支持
启明：支持；
Splunk：支持
19
5、 应用情况
5.1 平台建设
本项目在2017 年开始建设，平台是基于 SpringCloud微服务架构进行搭建设计，分
为采集部分、数据计算、数据存储、算法模块以及前端展示。由于平台存储各核心系统
关键指标以及日志数据，在建设平台时我们分别从数据、应用以及主机三方面进行安全
建设，确保数据传输、存储以及访问安全。2018 年初上线了智能监控功能，解决了传统
监控只能通过固定阈值进行监控的缺点，实现了对于操作系统、数据库、常用中间件的
KPI 基于基线的异常检测；2018 年中与数据厂商一起完成了核心系统的关键指标提取以
及其他数据的采集和清洗，同年与国内顶尖高校算法研究中心一起实现、落地了对业务
指标的实时异常检测、多指标的异常定位以及日志的异常检测从而完成了异常检测预定
位的场景在我司核心交易系统如网交、集中交易、融资融券、自营 O32等系统的落地。
5.2 数据建设
数据治理结合我们运维场景以及运维经验梳理了以下几类数据：
1）业务关键 KPI
这部分由业务人员以及系统运维人员共同制定，该类指标可以真正反映出业务系统
的运行情况。通常包括调用次数、响应率、成功率、平均耗时这类指标，指标的实际计
算方法也是由业务以及运维人员共同提出。
第一类通过对日志的解析，加工，以恒生卓越版网上交易系统为例，通过数据工厂
提供了 142 个功能号，每个功能号有四个指标来评价该功能号分别是成功率、响应率、
调用次数以及平均耗时，共计 568个指标；
第二类通过APM 进行对接获取到数据，如集中交易、融资融券、O32 等系统的关键指
标通过APM获取后，再通过数据工厂对数据进行加工获得业务关键 KPI。如集中交易以及
融资融券共计2792 个指标。
2）指标类数据
通过数据工厂采集处理监控系统的操作系统性能共计 27 个指标（cpu，load，
cpuiowait，IO繁忙率，网络流量等）、数据库性能 5个指标（executes，active session，
logic read，logfile sync，lock waiting sessions 等）。目前，对 1020 台左右的设
备进行了实时性能指标获取，通过代理实时对操作系统性能进行采集获取操作系统的关
键指标，通过调用数据库监控系统以及网络系统获取操作系统以及数据库的性能指标共
计27540个基础性能指标。
3）日志数据
业务日志：该日志包含了应用模块的运行状况包括报错等信息，这些日志会通过智
能算法进行日志解析，并且会通过算法进行异常检测定位日志数据；
应用模块运行日志：该日志包含了应用模块的运行状况包括报错等信息，这些日志
会通过智能算法进行日志解析，并且会通过算法进行异常检测定位；
20
数据库、操作系统日志：数据库如alert日志，trc日志，操作系统的日志有messages，
登录日志、安全日志、系统日志等，这些日志也是日志异常定位的重要对象。
以网交系统为例，每日对网交系统的各类日志处理达到 500G左右。
4）数据应用
数据提供两方面应用，一方面进行查询搜索、另外一方面是提供给算法服务进行异
常检测与定位场景。数据可以提供多种查询方式，典型的有全文检索以及 SPL实现复杂
查询，对于查询结果可以制作成各种图表进行展示。
5）数据安全
保障数据安全上针对数据传输、存储以及访问几个方面进行全面控制。数据传输加
密通过SSL/TLS加密协议；采用分部署存储架构保证了数据存储安全；数据访问基于 CMDB
对用户的访问权限作了细致划分。
5.3 智能运维场景落地情况
生产环境中，数据工厂通过单指标无监督算法实时对真正可以描述服务状态的指标
进行监测，在实时监测模块发现了 KPI 异常之后，便会自动触发对多个层面的指标进行
关联性分析与聚类找出可能的问题故障点；同时，结合分词和模版提取、异常检测等算
法对应用日志进行异常检测，挖掘到故障原因。
1）通过无监督算法对系统运行 KPI 进行实时异常监测
目前生产环境中实时监控。生产中实时对数万个指标进行实时监测，由于算法的先
进性，仅需要20G，40G的计算资源遍实现了对 1万个指标的运行曲线进行实时的监测。
KPI的异常监测采用的是无监督的算法，每一个小时会自动进行训练，提取数据特征，通
常情况不需要对数据进行标注。
下图为生产中已经发现的异常曲线，以及这个异常所产生的告警事件，通过告警事
件双击便可以查看实际的曲线：metric.zsbwj.421 - avg_delay，为网上交易智胜版处
理机421这个功能号的平均耗时的曲线,红色部分即为异常
2）多指标异常定位场景
在通过单指标异常检测发现了关键指标发生了异常之后，平台会自动触发根据图库
存储的关联关系对操作系统性指标、网络指标以及数据库指标进行异常定位：整个过程
在分钟级别可以自动完成，经过实测 CPU(10C)+MEM(20G)的计算资源可以实现 200000 个
指标的异常检测定位可以在 1分钟之内完成。生产中的指标包括了操作系统性能、网络、
数据库等指标。
在1）中告警KPI发生异常之后便自动触发了对相关的指标进行异常定位，并且根据
异常成都进行排名，在下图展示了当时异常定位出来的效果：
21
3）日志异常监测
日志的异常检测分为两个部分，第一部分是日志模式提取、第二部分是基于模式提
取对日志进行异常检测。我们通过机器学习算法对历史日志进行离线训练，提取出模板，
并且每天晚上当日志量满足的情况下，会自动触发增量训练，自动更新日志模板。Spark
任务会调用这些模板对日志进行实时解析。
通过解析出来的模板会实时将日志解析成为结构化日志，日志异常监测服务则是通
过变量、模板占比、突增、分布等多种算法组合来定位日志异常。
日志的异常检测分为两种：主动检测以及被动检测。主动检测可以配置多种规则，
如根据匹配模板数量日志条数，未匹配到模板日志数量条数，模板中的某个变量的突变、
分布；被动检测是 KPI经过单指标实时检测出现问题的时候，触发对近期（生产上设置
为故障前后2小时）日志的异常检测，具体的检测规则也包括对模板的数量、变量分布
等情况与正常情况自动进行对比分析，判断日志是否有异常发现。实际生产中
CPU(30C)+MEM(60G)的资源可以实现对每天 TB级别的日志进行实时解析以及分钟级别异
常检测。
下图展示的是在1）中网交KPI发现异常之后，自动触发的异常日志监测结果，在异常发
生数段：
4）告警聚合
在传统告警中，比较容易出现告警风暴，典型的情况是当数据库服务器宕机之后，
主机监控，数据库监控，网络监控会同时产生告警。传统的商业软件或者开源监控软件
通常是基于规则，例如基于某个时间段告警的 IP，告警的某些字段相同来对告警进行聚
类，存在的缺陷就是对于不同类型的告警需要另外设置，较为繁琐。在我们智能运维平
台采用的是通过算法组合来对告警进行聚合，有效的避免了告警风暴，目前生产上配置
的资源为CPU(4C)+MEM(4G)可以满足一天对 10000+的告警进行聚合处理。
22
5）完整异常检测
以上部分是分别对我们生产中落地的智能运维场景每一块的情况介绍。下面列举一
个典型例子来说明整个异常检测的场景。
2018年11月份智能运维平台监控发现 O32委托功能的平均耗时发生异常，触发了多
指标异常监控发现了数据库的 lock waiting sessions 与executes 指标发生异常，对日
志的异常检测发现了 utodb日志中有大量的“异步落库失败”字样日志，从发现异常到
了定位异常日志用时在 2分钟。经过应用人员与开发商的共同排查确认，定位为 O32应
用的bug，该bug在业务处理中会造成处理性能下降的风险，在大并发的情况下可能导致
后台无法响应的事故。厂商及时发布了补丁避免了事故的产生。整个过程传统的监控平
台没有检测到异常，因为业务指标包括交易笔数没有明显的变化，监控系统记录的操作
系统、数据库、网络负载都较低未达到告警阀值。
对于此类问题的发现以及排查由于涉及的环节很多，而且传统监控又没有直接监控
到异常点，排查复杂度非常高。2018年 5月9日，智能运维平台未上线前，我司飞马交
易系统在8点45左右发现查询前置无法启动，由于短时间无法定位问题，按照应急预案
切换备机。事后，耗时 30分钟左右，才在众多日志中发现，是因为 ssh升级导致
libcrypto.so相关包被升级，程序调用出错。而此类问题智能运平台可以在分钟级别完
成模块日志以及系统日志进行异常排查，可以帮助运维人员快速定位故障点以及故障原
因。
23
6、经济效益、社会效益
6.1 经济效益