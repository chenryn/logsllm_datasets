了，仅仅是不同类型的数据库操作语言在CI/CD中如何配置的问题。
11.4 小结
本章主要介绍了DevSecOps的发展历史和基本含义，并从API安全
的角度，介绍了DevSecOps平台应具备的基本功能，以及如何通过
DevSecOps管道来开展API安全实践。作为初步实践者，应在DevSecOps
流程中关注自动化API安全测试、API网关、Web应用防火墙三个关键卡
点，初步构建最基础的API安全能力。如果要构建更高层次的API安全
能力，应关注持续集成管道的安全性和API基础设施的安全性，其中对
于线上应用的持续监控和运营在本章的Web应用防火墙章节仅有提及，
更多的内容因考虑到内容的重复，读者在理解、学习时，应结合API安
全架构与设计章节的内容，考虑如何运用到DevSecOps管道中。
第12章 API安全与API网关
随着网络、移动应用、智能终端、物联网市场迅猛发展，万物互联
背景下的各个企业对外提供的API数量急剧增长。这些承载着不同业务
功能的应用程序、API服务之间相互融合，经常涉及接口调用、流程交
互、数据共享等需求，围绕它们建立一个由API连接，并能流畅地输入
输出到其他应用程序的统一平台变得非常重要，这就是API网关这个产
品产生的基础。本章将为读者讲述API网关产品在API安全中的应用。
12.1 API网关产品概述
API网关是当今互联网应用在前后端分离背景下，微服务架构、分
布式架构、多端化服务等架构中重要的组成部分，作为应用层统一的服
务入口，方便平台管理和维护众多的服务接口。
12.1.1 API网关功能介绍
作为存在于企业信息系统的边界强管控服务，API网关是面向
API、串行、集中化的管控工具，它提供高性能的API托管服务，使用
户能够快速、低成本、低风险地开放服务能力。一般来说，API网关由
核心控制系统和后台管理系统两部分组成，其产品在系统架构中的上
下文如图12-1所示。
■ 核心控制系统：为了满足业务需要所对外提供的核心API能力的
总称，比如处理安全策略、流量控制、服务鉴权、熔断、参数校验、参
数映射、协议转换、服务生命周期管理等所有核心业务能力。
■ 后台管理系统：用于辅助核心控制系统所提供的能力总称，比如
用户管理、应用接入管理、SDK和API文档生成、服务授权控制、服务
策略绑定等功能的管理能力，为管理人员提供可视化的操作界面，降低
API管理难度。
在API网关的周边，与相邻应用程序的上下文关系如下。
■ 和后端API服务之间的关系：API提供者在提供稳定的API后，在
API网关中注册并发布API或生成SDK，才可以被终端业务系统调用。
■ 和客户端应用程序之间的关系：不同的客户端/终端应用程序首
先访问API网关，经过一系列的API控制器、网关路由到目标API。
■ 和运维监控系统之间的关系：API网关接入运维监控系统，一方
面用于监控网关和服务器的运行情况，另一方面也可以监控各个已注册
API的运行健康情况，并在异常时可以触发告警。
图12-1 API网关产品架构及上下文
■ 
和日志平台之间的关系：API网关接入日志平台，用于采集API
的调用信息，完成问题分析、调用链跟踪、调用数据统计等。
使用API网关的系统架构中，API网关层将内部服务和外部调用隔
离，客户端应用程序调用的后端服务都通过网关的映射来完成，很好地
隐藏了内部服务数据，保障了服务的私密性和安全性。同时，在整个架
构上，能让业务使用者抽出更多的精力来关注核心业务能力建设，而不
是通用的安全性、流控等边界特性的问题。这在快速增加新业务或改变
原有应用系统、服务时，对现有架构和应用程序的影响能降低到最小。
12.1.2 API网关产品特性
API网关现在已经成为互联网应用技术架构中的基础组件，这与
API网关在系统架构所能解决的问题和产品优势密不可分。
1.API网关产品的特点
API网关产品除了上节提及的在网络边界起到内外部隔离外，还有
如下特点。
■ 减少客户端与服务器端的耦合，后端服务可以独立发展。其主要
表现为：客户端应用程序调用后端服务都是通过网关的映射完成的，在
这样的场景下，内部服务的变更只需要通过修改网关定义即可，客户端
应用程序不需要做任何变更。API网关通过统一标准的协议来整合现有
不同架构、不同语言、不同协议的服务资源，实现业务互联互动，减少
客户端或服务器端的改变对对方造成的影响。
■ 
集成多种安全机制，保障服务交互的安全性。典型的有通信加
密、身份认证、权限管理、流量控制等安全手段。API网关为每一个应
用接入者提供不同的加密密钥或证书，支持多种加密方式和安全传输协
议，在保障通信双方身份可信的前提下，可以防止数据在传输过程中被
窃取或篡改。同时，依赖于API网关的多种安全保护机制，也为后端服
务技术实现时在安全方面的投入减轻压力。
■ 
支持服务熔断设置，根据熔断规则和熔断执行自动执行熔断策
略，同时支持线上调试，比如Mock方式，能够更加方便API服务上线发
布和测试操作。
■ 
提供多种协议的接入、转换与代理功能，比如常见的接口协议
RESTful、WebSocket、Dubbo、WebService、独立文件传输等协议，这
也为后端服务的混合通信协议提供了可选择性。面向外部合作伙伴或第
三方厂商通常提供基于RESTful或WebService形式的API，但后端服务内
部可以在不同的业务部门或项目组之间使用不同的技术栈，比如
RESTful、GraphQL、Dubbo等，而不用担心外部调用的不兼容性。
2.API网关使用场景
API网关能对API的全生命周期进行规划和管理，其适用的场景非
常广泛，除了API开放平台之类的生态化应用以外，典型的使用场景还
有多种API协议转换、API安全接入、多终端协议适配等。
（1）多种API协议转换
在大型异构系统中，API网关在管理后端API服务的同时作为协议
转换工具使用是比较常见的场景。比如外部调用是使用HTTP/HTTPS加
WebSocket协议API请求方式，API网关需要将其请求转换为后端服务所
能提供的RESTful、Dubbo、WebService、WebSocket、Spring Cloud注册
中心等形式，如图12-2所示。
●图12-2 API网关协议转换场景下的使用
（2）API安全接入
API网关所提供的服务鉴权、流量控制、熔断机制、参数校验等多
种安全机制以及不同机制间的任意组合，能高效、集中地解决在本书基
础部分和安全设计部分所提及的安全问题。如图12-3所示，业务调用的
API请求在经过API安全验证之后才会达到后端服务。
●图12-3 API网关安全接入场景下的使用
（3）多种终端协议适配
因外部合作伙伴或第三方厂商业务形态的不同，往往存在多种终端
类型的客户端应用程序，比如H5小程序、Android应用程序、桌面应用
程序等。这些应用程序往往涉及不同的开发语言，在API网关产品中通
常提供多端适配的功能，如图12-4所示。
●图12-4 API网关多端适配场景下的使用
12.2 开源API网关
API网关目前在业界有很多成熟的产品，在第2章中已经为读者做了
简要的介绍。本节主要从开源产品及其在API安全中使用的角度，分别
选择Kong、WSO2、Ambassador等产品为读者做进一步的介绍。
12.2.1 Kong API网关介绍
Kong是一个云原生的、与平台无关的开源API网关，因其高可用
性、易于拓展性而深受企业用户欢迎。在Web应用、移动应用或IoT应
用环境中，Kong可以充当微服务网关或API辅助管理工具，通过插件
的形式，提供负载均衡、日志审计、身份验证、速率限制、协议转换
等功能，提供服务能力。Kong以OpenResty（Nginx+Lua模块）为基
础，采用Apache 
Cassandra或PostgreSQL作为数据存储，通过集群化模
式为企业提供高效可用的API管理服务能力。其典型的部署架构示意图
如图12-5所示。
1.Kong API网关安全特性
Kong API网关安全特性主要依赖于其管理的插件，所支持的插件可
以从其Kong 
Hub网站下载（包含企业版插件和开源版插件），网址为
https://docs.konghq.com/hub，与安全特性相关的插件可以划分为以下几
类。
■ 身份认证插件：Kong支持Basic基础认证、Key密钥认证、OAuth
2.0认证、HMAC认证、JWT认证、LDAP认证、Session会话认证等。
■ 
访问控制插件：ACL（访问控制列表）、CORS（跨域资源共
享）、Kong Path Allow（Kong请求路径控制）、IP限制、爬虫检测等。
■ 流量控制插件：请求限流（基于请求计数限流）、上游响应限流
（根据upstream响应计数限流）、应答限流（基于response响应计数限
流）、请求大小限制、本地限流、集群限流等。
●图12-5 Kong API网关部署示意图
■ 日志审计插件：支持文件日志、HTTP Server日志、Syslog日志、
StatsD日志、TCP Server日志、UDP Server日志等。
■ 安全防护插件：集成Let's Encrypt的ACME协议、僵尸客户端检
测、API威胁保护等。
■ 协议转换插件：支持的API协议有GraphQL、RESTful、gRPC、
Kafka消息等。
2.Kong安全插件的基本使用
（1）Kong API网关的安装
目前Kong官网提供多种形式的安装文件，有RPM包、Docker、源
代码等。这里以Redhat环境下的安装为例，其安装步骤如下。
1）从Kong官网下载redhat版本的安装文件，使用RPM方式进行安
装，安装操作的命令行如下：
2）安装PostgreSQL并初始化数据库，默认情况下，数据库名、用
户名、密码均为kong。其操作命令如下所示：
3）配置数据库。默认情况下，/etc/kong目录下会存在
kong.conf.default文件，使用此文件配置Kong连接的数据库。
找到如图12-6所示的代码片段，将每一行开头的注释符#去掉。
●图12-6 Kong数据库连接配置
4）启动Kong，启动之前需要对数据进行归并，并在启动时指定配
置文件的位置。其操作命令行如下所示：
如果启动时没有异常信息，则表示正常启动了，这时执行curl
http://localhost:8001则正常回显Kong页面内容。第一次安装时，新手可
能会遇到各种异常情况，出现异常时根据异常信息调整即可，大多数问
题都是常见的、易于解决的。
（2）Kong保护API服务使用步骤
在使用安全插件之前，需要对Kong保护的API或服务接口进行配
置，Kong提供RESTful形式的Admin API、Kong管理控制台页面、decK
三种方式进行管理。这里为了更方便说明配置过程，采用Admin API来
操作，以帮助读者通过提交的请求消息内容和响应消息内容来理解
Kong的使用。Admin 
API的操作文档在其官网可直接访问，网址为
https://docs.konghq.com/2.1.x/admin-api/，配置完成后，API的调用链路
将由客户端应用程序→API服务改变为客户端应用程序→Kong