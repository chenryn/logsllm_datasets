  Obvious 
  NOT 
  Your 
  Admin 
| 
 | Check 
  the 
  Service 
  used  | Checkthe 
  Service 
  used  | Check 
  the 
  Service 
  used  |
|---|---|---|
|   |  |Modify    Permissions  |
Push 
  out 
  malware 
  using 
  CMD 
  Shell 
  & 
  CScript 
18 
Command 
  Line 
  Logging 
  is 
  Priority 
  #1 
Update 
  Registry 
Change 
  Registry 
  Permissions 
 Change 
  permissions 
  on 
  files 
19 
Bad 
  Behavior 
  Becomes 
  Obvious 
 Doing 
  Recon 
GoingObvious 
 Doing 
  Recon 
Going 
  aWer 
  Terminal 
  Services 
 Query 
  Users 
20 
Can 
  Even 
  Capture 
  Their 
  CredenOals 
 Caught 
  THEIR CredenOals! 
21 
So 
  What 
  Did 
  WinNTI 
  Do? 
| 	1st 
  Slide  | 4688  | 7045  | 4624  | 4663  | 5156  | 7040  | 5140  |
|---|---|---|---|---|---|---|---|
| –	Launch    part    of    the    malware(s) |✓ |Even |tID -  |4688 |  | | || –	Hide    malware    payload    in    the    Registry |✓ |Even |tID -  |4688 | & 46 |63  | |
| –	Modify an exisOng service to call malware | |Even |tID -  |7045 | & 70 |40  | |
| 	2nd    Slide  | | | | | | | |
| –	Check    the    service |✓ |Even |tID -  |4688 | & 70 |40  | |
| –	Modify    permissions    of    the    malware |✓ |Even |tID -  |4688 |  | | || –	Push out malware Using CMD Shell and Cscript  |✓ |Even |tID -  |4688 |, 462 |4 & 5 |140  |
| 	3rd    Slide  | | | | | | | |
| –	UpdaOng    Registry    seungs |✓ |Even |tID – | 4688 | & 4 |663  | |
| –	Push    out    the    Registry    changes |✓ |Even |tID – | 468 | & 4 |663  | |
| –	Change permissions on changed fles |✓ |Even |tID – | 468 | & 4 |63  | |
| 	4th    Slide  | | | | | | | || 	4th    Slide  | | | | | | | |
| –	A    liFle    Recon |✓ |Even |tID – | 4688 | & 5 |156  | |
| –	Push    malware    to    Terminal    Services |✓ |Even |tID – | 468 |, 462 |4 &  |140  |
| –	Query the users |✓ |Even |tID –✓ | 468 | & 4 |24  | |
| •	5th    Slide  | | | | | | | |
| –	Capture    THEIR    credenOals |✓ |Even |tID – | 468 | & 5 |156  | |
22 
What 
  Can 
  We 
  Do 
With 
  Logs?Can 
  We 
  Do 
With 
  Logs? 
So 
  What 
  Can 
  We 
  Do 
  With 
  Logs? 
 More 
  than 
  you 
  would 
  have 
  ever 
  guessed 
Not 
  only 
  detect 
  Target, 
  Neiman 
  Marcus, 
  Michael’s 
  retail BackOff 
  malware 
But 
  also 
  government 
  sponsored 
  malware 
  like 
  Regin, 
  Cleaver, 
Stuxnet, 
  Duqu, 
  Flamer, 
  etc. 
 Yes, 
  even 
  the 
  really 
  badYes, 
  even 
  the 
  really 
  bad 
  stuff 
  like 
  WINNTI, 
  well 
  good 
  stuff 
  to 
  me 
  ;-­‐) IF… 
  you 
  know 
  what 
  to 
  look 
  for 
Improve 
  Security 
  with 
  Endpoint 
  Data 
 Great 
  coverage 
  with 
  6 
  events 
  per 
  system, 
  not 
60,000 
  alerts 
  like 
  we 
  heard 
  the 
  retailers 
  had 
If 
  you 
  get 
  6, 
  then 
  12, 
  then 
  186, 
  then 
  12, 
  then 
  18 
  alerts… 
  you 
  should 
  be kicking 
  into 
  Incident 
  Response 
  mode 
Of 
  course 
  there 
  are 
  more, 
  but 
  this 
  is 
  where 
  to 
  start 
FREE 
  -­‐ 
  The 
  Windows 
  Logging 
  Cheat 
  Sheet 
|  | 6 
  Pages 
  on 
  Windows 
  logging  |  |
|---|---|---|
|  |Details    on    how    configure  | |
|  |Windows    logging    and  | ||  |Windows    logging    and  | |
|  |audiOng  | |
|  |Found    at:  | |
|  |–MalwareArchaeology.com  | |
The 
  6 
  Windows 
  Event 
ID’s 
  Everyone 
  Must 
Monitor 
  and 
  Alert 
  On 
The 
  SEXY 
  Six 
1.
2.
3.
4.
5. 4688/592 
  -­‐ 
  New 
  Process 
  – 
  Look 
  for 
  the 
  obvious 
  .EXE’s 
  cscript.exe, 
  sysprep.exe, nmap.exe, 
  nbtstat.exe, 
  netstat.exe, 
  ssh.exe,netstat.exe, 
  ssh.exe, 
  psexec.exe, 
  psexecsvc.exe, ipconfig.exe, 
  ping.exe 
  OR 
  powershell.exe 
  (SET, 
  MetaSploit) 
  Of 
  course, 
  new odd 
  .exe’s 
4624/528 
  /540 
  -­‐ 
  Some 
  account 
  logged 
  in. 
  What 
  accounts 
  did 
  and 
  what 
  accounts at 
  what 
  Omes 
  are 
  normal? 
5140/560 
  -­‐ 
  A 
  share 
  was 
  accessed. 
  They 
  mostwas 
  accessed. 
  They 
  most 
  likely 
  connected 
  to 
  the 
  C$ 
  share. 
5156 
  – 
  Windows 
  Firewall 
  Network 
  connecOon 
  by 
  process. 
  Can 
  see 
  the 
  process connecOng 
  to 
  an 
  IP 
  that 
  you 
  can 
  use 
  GEOIP 
  to 
  resolve 
  Country, 
  Region 
  and 
  City. 
7045/601 
  -­‐ 
  A 
  new 
  service 
  is 
  installed. 
  StaOc 
  systemsis 
  installed. 
  StaOc 
  systems 
  don't 
  get 
  new 
  services except 
  at 
  patch 
  Ome 
  and 
  new 
  installs. 
  Change 
  Management 
  anyone? 
  This 
  is 
  a 
tell 
  tail 
  sign. 
  7040 
  is 
  a 
  change 
  of 
  state 
  of 
  a 
  service, 
  good 
  too 
6. 4663/567 
  -­‐ 
  File 
  audiOng 
  must 
  be 
  enabled 
  on 
  directories 
  you 
  wanton 
  directories 
  you 
  want 
  to 
  monitor. The 
  new 
  files 
  above 
  would 
  show 
  up. 
  Yes, 
  there 
  are 
  ways 
  to 
  write 
  to 
  disk 
  without Event 
  logs 
  being 
  triggered 
  in 
  PowerShell 
  and 
  .NET, 
  but 
  this 
  is 
  rare 
  and 
  why monitoring 
  PowerShell 
  is 
  important. 
  4657 
  will 
  give 
  more 
  Registry 
  details.more 
  Registry 
  details. 
The 
  SEXY 
  Six 
  – 
  Summary 
| Win 
  ID  | What  | Impact 
  to 
  Security  | AcOvity 
  detected  |
|---|---|---|---|
| 4688/592 |New    Process    executed  |Malware    executed    or malware    actor    trying    to take    acOon  |New    programs    installed    by aFacker    (not    by    user)  || 4624/528    /540  |Some    account    logged    in  |AFacker    authenOcated    to the    endpoint  |What    accounts    did    and    what accounts    at    what    Omes    are normal?  |
| 5140/560 |A    share    was    accessed  |What    endpoints    were accessed  |C$    share    or    File    share accessed  || 5156 |Windows    Firewall    Network connecOon    by    process  |Command    and    Control    or origin    of    aFack  |What    applicaOon    was    used    to communicate    with    external or    internal    IP  |
| 7045/601 |Service    added    to    the    endpoint  |Persistence    to    load    malware on    restart  |Service    added    or    modified  || 4663/567 |File    &    Registry    audiOng  |ModificaOons    to    the    system that    create    holes    or    payloads used    at    a    later    Ome  |Files    added    and    Registry    Keys added    to    audited    locaOons  |
Steps 
  You 
  Will 
  Need 
  to 
  Take 
| 
 | Enable 
  Advanced 
  Audit 
  Policy 
  in 
  Windows –The 
  “Windows 
  Logging 
  Cheat 
  Sheet” 
–AuditLogging 
  Cheat 
  Sheet” 
–Audit 
  Process 
  CreaOon 
  = 
  Success 
–Audit 
  Logon 
  = 
  Success 
  & 
  Failure
–Audit 
  File 
  Share 
  = 
  Success
–Audit 
  File 
  System 
  = 
  Success
–Audit 
  Registry 
  = 
  Success
–Audit 
  Filtering 
  Plazorm 
  ConnecOon 
  = 
  Success
–Services 
  already 
  captured 
  by 
  System 
  Log | 
4688 
4624 
5140 
4663 
4663 
  & 
  46574624 
5140 
4663 
4663 
  & 
  4657 
5156 
  (Any/Any 
  min) 
7045 
  & 
  7040  |
|---|---|---||    |Enable    and    Configure    to    capture    Process    Command    Line  Use    the    Splunk    Universal    Forwarder    or    Splunk    Window    Infrastructure    App or    syslog…    to    get    data    to    central    locaOon  –Modify    the    inputs.conf    to    blacklist    or    whitelist    as    needed  |Enable    and    Configure    to    capture    Process    Command    Line  Use    the    Splunk    Universal    Forwarder    or    Splunk    Window    Infrastructure    App or    syslog…    to    get    data    to    central    locaOon  –Modify    the    inputs.conf    to    blacklist    or    whitelist    as    needed  |30 
Enable 
  Command 
Line 
  Logging 
	Windows 
  7 
  Through 
  2012 
  (Win 
  10 
  too) "Include 
  command 
  line 
  in 
  process 
  creaOon 
  events“ 
	–hFp://technet.microsoW.com/en-­‐us/library/dn535776.aspx 
1.
2.
3. 	Windows 
  8.1 
  and 
  2012 
  R2 
–AdministraOve 
  Templates\System\Audit 
  Process 
  CreaOon 
You 
  must 
  have 
  the 
  patch 
  for 
  MS15-­‐015the 
  patch 
  for 
  MS15-­‐015 
  (KB3031432) 
  for 
  Win 
  7 
  and Win 
  2008, 
  From 
  Feb 
  2015 
	Registry 
  key 
  tweak 
–SoWware\MicrosoW\Windows\CurrentVersion\Policies\System\Audit
\ProcessCreaOonIncludeCmdLine_Enabled 
  to 
  DWORD 
  -­‐ 
  1 
And 
  You 
  Will 
  See 
  this 
  Added 
  to 
  Your 
  Logs Only 
  a 
  fracOon 
  more 
  data Most 
  valuable 
  thingdata Most 
  valuable 
  thing 
  to 
  log 
AddiOonal 
  context 
  important 
  to 
  idenOfy 
  abnormal 
  behavior 
33 
	PowerShell 
  – 
  Command 
  Line Details 
  on 
  seung 
  PowerShell 
  preference 
  variables 
	–hFp://technet.microsoW.com/en-­‐us/library/hh847796.aspx 
1.Create 
  a 
  default 
  profile 
  for 
  all 
  users: 
	–C:\Windows\System32\WindowsPowerShell\v1.0Profile.ps1| 2.Add 
  these 
  to 
  your 
  default 
  profile.ps1 
  file –$LogCommandHealthEvent 
  = 
  $true –$LogCommandLifecycleEvent 
  = 
  $true 
3.Splunk 
  -­‐ 
  Inputs.confindows 
  plazorm 
  specific 
  input 
  processor –[WinEventLog://Windows 
  PowerShell] 
–disabled 
  = 
  0 
4.Upgrade 
  PowerShell 
  to 
  ver 
  3 
  or 
  ver 
  4 | 2.Add 
  these 