### 勒索软件技术
#### 总体流程
投递——豁免——提权——加密策略——其他
#### 投递
- RDP爆破：RDP的弱口令爆破占大部分
- 邮件钓鱼，社工
- 漏洞，有上升趋势
#### 豁免
- 行业豁免，部分勒索软件会对部分行业进行豁免，例如医疗行业
- 区域豁免
  - 独联体国家之间也会进行网络犯罪调查，所以部分勒索软件家族从被溯源风险和政治因素上考虑会进行区域豁免
#### 提权
- 关闭杀软、主防：防止检测
- 关闭软件关闭服务：避免加密过程中的文件占用
- 访问敏感路径
---
- Bypass微软UAC技术
  - 系统文件在执行过程中会静默提权，绕过UAC
  - 这类程序的三个特点
    - 具有autoElevate属性
    - 具有微软签名
    - 可信目录
  - 根据劫持方式不同分为：
    - 注册表劫持
    - DLL劫持
    - 读取配置ini文件
  - 可参考的GitHub项目：UACME(68), WinPwnage
---
- 管理员权限到System权限的方法
  - Handle继承
  - **Token模拟**
  - **服务、计划任务**
  - 命名管道
  - mofcomp.exe执行MOF文
----
- 漏洞提权
  - CVE-2018-8453
  - CVE-2018-20250
  - CVE-2018-13379
  - CVE-2021-34527
#### 加密策略
- 利用Windows API进行文件遍历
  - 过滤系统文件，保证系统的最低程度运行，进行白名单过滤
  - IO读写操作占用资源大，趋势是采用**IO完成端口**
    - 将耗时的文件读取利用线程池操作，更快速、效率高，占用资源少，但编程复杂度高
    - 将加密过程和遍历过程进行分离，加密时使用线程池
- MBR加密
  - 加密MBR引导扇区数据，篡改MBR代码
  - 创建重启计划任务
  - 系统重启后加密NTFS文件系统
  - 最后的效果是启动一个DOS界面
#### 免杀
- 动态加载API
- 加密关键字符串
- 分离免杀
- 内存加载执行
- 白+黑
  - 合法签名+黑Payload
- Lolbin
  - 利用系统常见下载器
  - 参考项目：lolbas-project.github.io
#### 第三方工具
- ProcessHacker
- Mimikatz
- PsExec
- PuTTY
- CS
- 仍有驻留、环境清理等技术
### 预防
#### 预防的时机
- 事前预防
  - 人是最大的漏洞
- 事后处理
  - 使用非对称加密，很难解密
- 事中处理
---
- 如何检测，了解勒索软件的特点：
  - 关闭敏感进程、服务，删除备份文件
  - 频繁的读取写入
  - 写入勒索信
  - 高CPU占用
---
- 预防措施
  - 文件监控
    - 建立诱饵文件
    - 目录检测
    - 文件拓展名是否更改
  - CPU检测
    - 当前业务的CPU利用率
  - 进程监控
  - 其他
    - 毛熊勒索软件多，可以利用区域豁免的特点进行预防，例如安装毛熊键盘
## 勒索病毒应急响应的方法与技巧
### 排查案例
#### Buran勒索应急事件
- 运营商推广抽成?
- 内网排查
  - 主机分析（域控）
    - 通过注册表分析，分析时间线
    - 3389远程桌面连接，作为跳板
    ---
  - 日志分析
    - 事件ID：1102，日志清除
  - Windows日志
    - “应用程序”日志
    - “安全”日志
    - “系统”日志
  - 日志被清除的替代方案
    - 流量设备
    - 是否存在日志收集平台（SIEM），其他还有杀软之类的日志
    - 日志被删，但又没被完全删除。Windows操作系统日志：winevt
    - 从其他主机，或者从外到内
    ---
  - 资产&设备排查
    - 钓鱼邮件排查
    - 防火墙排查
    - 互联网暴露资产排查（主动&被动）
### 勒索应急中的方法与技巧
#### 勒索家族判断
- 勒索文件后缀，加密后的文件后缀
- 勒索信文件名
- 勒索信内容
---
- 勒索病毒样本，沙箱检测
- 主机加密时间确认，工具：everything
  - 根据加密时间点附近时间进行回溯
  - 搜索勒索常用辅助工具的关键词
- Diskgenius
  - 使用数据恢复的方式来查看已删除的文件
#### 日志分析
- 系统自带日志
- 编辑器
- 通过专业日志分析工具（e.g. logparser、splunk）
  - web日志分析，通过200状态码+URI查看成功被下载的文件
  - 统计各种IP登入失败的次数和百分比
  - 统计某个失陷账户从哪些主机登入
#### 流量分析
- NDR/IPS/IDS
- 全流量设备+NDR
- 全流量设备+Wireshark
### 应急响应排查的过程
#### 准备阶段
- 了解应急事件环境，涉事系统环境、类型、网络环境等
- 关联拓展事件情报上下文信息
- 制定事件应急响应方案
- 协调技术支持人员，现场/线上做好技术支持。知道
#### 抑制阶段
- 快速反应
- 内网关联威胁资产进行终端排查，日志溯源
- 制定针对勒索病毒的处置方案
#### 取证阶段
- 现场样本留存
- 木马清除
#### 溯源阶段
- 内部溯源：怎么进来的
- 外部溯源：资产和基础设施的信息
#### 清除阶段
#### 安全加固