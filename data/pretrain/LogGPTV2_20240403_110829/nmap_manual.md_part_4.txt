### 端口扫描技术详解

#### SYN 扫描
SYN 扫描是一种相对隐蔽的扫描方式，因为它从不完成完整的 TCP 连接。与 Fin/Null/Xmas、Maimon 和 Idle 扫描不同，SYN 扫描不受特定平台限制，可以应用于任何兼容的 TCP 协议栈。它能够明确可靠地区分端口的状态：开放（open）、关闭（closed）和被过滤（filtered）。因此，SYN 扫描也被称为半开放扫描。

- **工作原理**：发送一个 SYN 报文到目标端口，等待响应。
  - 如果收到 SYN/ACK 响应，表示该端口处于监听状态（开放）。
  - 如果收到 RST 响应，表示没有监听者（关闭）。
  - 如果多次重发后仍无响应，则标记为被过滤。
  - 收到 ICMP 不可达错误（类型 3，代码 1, 2, 3, 9, 10 或 13），同样标记为被过滤。

#### TCP Connect() 扫描 (-sT)
当无法使用 SYN 扫描时，TCP Connect() 扫描是默认的替代方案。例如，用户没有权限发送原始报文或需要扫描 IPv6 网络时，就会使用这种扫描方式。

- **工作原理**：通过调用操作系统提供的 connect() 函数来建立连接，而不是直接发送原始报文。
  - 这种方法类似于 Web 浏览器、P2P 客户端等网络应用程序使用的高层系统调用。
  - Nmap 通过 Berkeley Sockets API 获取每个连接尝试的状态信息。
  - 当 SYN 扫描可用时，通常更优，因为 Connect() 调用效率较低，且容易被记录。

#### UDP 扫描 (-sU)
尽管许多流行服务运行在 TCP 上，但也有不少重要的 UDP 服务，如 DNS、SNMP 和 DHCP。UDP 扫描可以帮助识别这些服务。

- **工作原理**：发送空的 UDP 报头到每个目标端口。
  - 如果收到 ICMP 端口不可达错误（类型 3，代码 3），则端口关闭。
  - 其他 ICMP 不可达错误（类型 3，代码 1, 2, 9, 10 或 13）表示端口被过滤。
  - 如果服务响应 UDP 报文，证明端口开放。
  - 多次重试后无响应，则标记为 open|filtered（可能是开放的，也可能被过滤）。

#### TCP Null, FIN, Xmas 扫描 (-sN, -sF, -sX)
这三种扫描利用了 TCP RFC 中的一个细节来区分开放和关闭的端口。

- **工作原理**：
  - **Null 扫描 (-sN)**：不设置任何标志位 (TCP 标志头为 0)。
  - **FIN 扫描 (-sF)**：只设置 TCP FIN 标志位。
  - **Xmas 扫描 (-sX)**：设置 FIN、PSH 和 URG 标志位。

如果收到 RST 响应，端口被认为是关闭的；如果没有响应，则标记为 open|filtered。这些扫描的优势在于它们可以绕过一些无状态防火墙和报文过滤路由器，但并非所有系统都严格遵循 RFC 793。

#### TCP ACK 扫描 (-sA)
ACK 扫描用于发现防火墙规则，确定其是有状态的还是无状态的，并识别被过滤的端口。

- **工作原理**：发送只有 ACK 标志位设置的探测报文。
  - 开放和关闭的端口都会返回 RST 报文，标记为 unfiltered。
  - 不响应或发送特定 ICMP 错误消息的端口，标记为 filtered。

#### TCP 窗口扫描 (-sW)
窗口扫描利用某些系统的实现细节来区分开放和关闭的端口。

- **工作原理**：检查返回的 RST 报文中的 TCP 窗口大小。
  - 开放端口的窗口大小为正数，关闭端口的窗口大小为 0。
  - 依赖于少数系统的实现细节，结果可能不准确。

#### TCP Maimon 扫描 (-sM)
Maimon 扫描以发现者 Uriel Maimon 命名，发送 FIN/ACK 探测报文。

- **工作原理**：根据 RFC 793，无论端口开放或关闭，都应该响应 RST 报文。但实际上，许多基于 BSD 的系统在端口开放时会丢弃该报文。

#### 自定义 TCP 扫描 (\--scanflags)
高级用户可以通过指定任意 TCP 标志位来自定义扫描。

- **工作原理**：使用 \--scanflags 选项指定标志位组合，并选择基本扫描类型（如 -sA 或 -sF）。Nmap 将根据基本类型解释响应。

#### 盲扫 (-sI)
盲扫允许进行真正的 TCP 端口盲扫描，不从真实 IP 地址发送报文到目标，而是利用僵尸主机的 IP 分段 ID 序列生成算法。

- **工作原理**：通过侧信道攻击窥探目标上开放端口的信息，IDS 系统将显示扫描来自指定的僵尸主机。

希望以上内容能帮助您更好地理解和使用各种端口扫描技术。