图18. REvil使用esxcli命令关闭虚拟机
与其他针对ESXi的勒索软件不同的是，REvil不会对虚拟机文件的后缀进行判断，而是对加密路径下所有的文件都进行加密，并判断该文件是否已经被加密了和是否具有RWX权限或者RW权限（如果具有这些权限，则这些文件是被系统保护的）来决定是否进行加密。
图19. REvil加密文件过程
最后，REvil留下勒索信警告受害者并且在信中留下还原数据的方式以及交赎金的地址。
图20. REvil的勒索信
## 5.3 HelloKitty
HelloKitty勒索软件攻击活动最早可以追溯到2020年，主要针对Windows系统。其在2021年2月攻击了CD Projekt
Red公司并声称窃取了该公司出品的“Cyberpunk 2077”、“Witcher 3”、“Gwent
”和其他游戏的源代码。而在今年7月，我们观察到该木马的Linux变体开始针对Vmware
ESXi进行攻击。其中，被攻击的目标包括意大利和荷兰的制药公司、一家德国制造商、一家澳大利亚提供工业自动化解决方案的公司以及美国一家医疗办公室和股票经纪人。在赎金方面，攻击者会因攻击目标公司的规模不同，而要求支付不同金额的赎金，其勒索的赎金最高可达1000万美金。
#### 样本技术分析
HelloKitty勒索软件首先会使用esxcli命令来遍历出当前受感染机器上正在运行的虚拟机进程，并尝试关闭这些虚拟机。为了避免虚拟机相关的文件遭到不必要的损坏，该病毒在加密文件前会先将虚拟机关闭。
该勒索软件首次关闭虚拟机，会使用软终止来结束该进程。
命令：`esxcli vm process kill -t=soft -w=%d`
如果仍有虚拟机正在运行，该病毒将会使用硬终止来结束该进程。
命令：`esxcli vm process kill -t=hard -w=%d`
如果还有虚拟机未被关闭，则会使用强制终止来结束该进程。
命令：`esxcli vm process kill -t=force -w=%d`
图21. HelloKitty勒索软件使用esxcli命令结束虚拟机进程
随后，HelloKitty病毒会遍历文件，并判断文件后缀是否为.vmdk（虚拟机虚拟磁盘文件）、.vmx（虚拟机配置文件）、.vmsd（虚拟机快照元素）、.vmsn（虚拟机快照文件）来加密与虚拟机相关的文件。
图22. HelloKitty勒索软件加密文件并对文件后缀进行判断
最后，每个加密文件都有一个相应的文件，扩展名为.README_TO_RESTORE，其中包含赎金记录。文本内容如下图所示。
图23. 赎金文本内容
## 5.4 BlackMatter
2021年7月，一个名为BlackMatter的新勒索软件组织正在购买企业网络的访问权限，同时声称其项目已将REvil和DarkSide的最佳功能融入其中。BlackMatter还表示，他们的勒索软件适用于多种不同的操作系统版本和架构，并以多种格式提供。包括支持安全模式的Windows变体（Windows
Server2003+x86/x64和Windows7+x86/x64）和支持NAS的Linux变体（ESXI5+、Ubuntu、Debian和CenOs），且这些变体在相同系统上均已测试成功。
#### 样本技术分析
BlackMatter在ESXI服务器上运行时，其首先使用esxcli命令列出所有正在运行的VMware虚拟机。
图24. BlackMatter使用esxcli命令列出所有正在运行的VMware虚拟机
再将正在运行的VMware虚拟机全部强行关闭。之所以这样做，是由于在加密文件之前如果没有正确的关闭虚拟机磁盘（VMDK）文件，则会导致数据的损坏。
图25. BlackMatter强制关闭ESXi上正在运行的VM虚拟机
接着，BlackMatter会获取当前系统所有正在运行的进程，并将这些进程强制结束。
图26. BlackMatter强制关闭所有正在运行的进程
同时，其会使用esxcli network firewall set –enabled 命令禁用ESXI主机的防火墙。
图27. BlackMatter使用excli命令禁用防火墙
接下来，判断文件系统，遍历其配置文件里（或给定的参数）所指定的路径目录下的所有文件。
图28. BlackMatter遍历指定路径下的所有文件
最后，并针对后缀名为vmdk（虚拟磁盘文件）、vmem、vswp、log等文件进行加密操作，生成并释放勒索信。
图29. BlackMatter加密文件的后缀
图30. BlackMatter勒索文本信息
# 6\. 总结与建议
针对虚拟化平台VMware vSphere的勒索攻击成为勒索组织的新型攻击方向，本文从多个角度对此类攻击进行了综合分析。针对虚拟化平台VMware
vSphere的勒索攻击可能会更加频繁：首先，攻击者对虚拟机管理平台的ESX/ESXi主机进行感染后可以对其中的数台虚拟机源文件进行加密，将直接影响受害企业/组织的多台应用服务器/数据库，这种方式控制了更加重要的企业/组织数字资产，能够勒索更高额的赎金并且大大提高成功率，这正是勒索组织的核心目的；其次，越来越多的黑客将目标转向了VMware
vSphere，相关的安全漏洞频频被发现，但许多客户由于各种原因限制并未能及时补丁，这也为勒索组织入侵到企业的ESX/ESXi主机提供了便利；另外，IABs团队在地下论坛中针对VMware
vSphere的活动也越加频繁，同时它们也在积极寻求与勒索组织进行合作，IABs团队能够提供专业ESX/ESXi主机的入侵服务，它与勒索组织的合作将会把针对vSphere的勒索攻击推上新一轮的高潮。
可以看出，随着互联网技术的不断革新和市场的变化，勒索组织也在不断扩展它们的攻击方向和寻求更有效的攻击手法，以便在勒索攻击中获取更高额的赎金同时大幅提高勒索的成功率。VMware
vSphere只是众多虚拟化平台的其中一个，只是由于它的市场庞大，成为了攻击者的首选目标；随着时间的推移，其他虚拟化平台如：Microsoft、Oracle和Red
Hat等很可能会成为攻击者的新目标，各大企业/组织应当注意提前做好针对性防御。针对vSphere虚拟平台的勒索攻击将对受害者企业带来难以估量的损失，我们将结合本文的分析和相关资料向vSphere用户提出下面几条针对性防御建议：
  * 建议使用 TPM 2.0 芯片进行vSphere进行安全配置。
  * 在物理服务器上启用UEFI安全启动功能，通过确保在引导中加载的所有代码都经过数字签名且未被篡改，从而加强操作系统的安全性。
  * 禁止在ESX/ESXi 主机上执行自定义代码，保证ESX/ESXi主机拒绝执行任何未通过认证合作伙伴签名的 VIB 包安装的代码。
  * 当vSphere平台相关的产品存在安全补丁发布时，积极参与系统及相关的虚拟化平台组件（vCenter服务器、ESX/ESXi主机、VMware工具等）的更新。
  * 对虚拟机平台的管理账户使用高强度密码。
  * 在内部网络中进行网络区域划分，将对外服务的主机和仅内部访问的主机进行分开管理，并且为虚拟平台管理员提供专用的vCenter服务器和ESX/ESXi管理接口以及专用的工作站。
  * 配置集中式的记录日志，防止管理系统配置和环境遭到篡改。
  * 尽可能高频率地进行系统备份，以便在遭到勒索攻击后能尽快地实现系统恢复。
* * *