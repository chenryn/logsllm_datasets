subgraphs induced by all pairs of leafs). Figure 10 contains an
example for a backward join node, the phi node deﬁning d93.
Unsurprisingly, this deﬁnition equals to the distance covered
so far.
In order to cover cases where, e. g., the lower boundary
check is control-dependent on the upper boundary check (i. e.,
might not be executed based on the result of the other check)
but not directly data-dependent, we enrich the data-ﬂow graphs
by control-dependency edges, i. e., build a reduced program
dependency graph. The introduced concepts, however, apply
to this extension as well.
G. Matching Test Cycles
Given two related curve calls, we can extract the curves
they operate on by backtracking the parameter register a4.
Thus, we obtain a curve representing the upper boundary
of matched driving proﬁles c(cid:2) and the lower boundary c⊥.
Roughly speaking, a speciﬁc driving proﬁle is matched if its
data points lie within said boundaries.
Note that we can perform a sanity check of the extracted
curves before processing them further. Namely, we want a
curve to be monotonically increasing because the covered dis-
tance obviously cannot decrease. This requirement is relaxed
for the last data points of a boundary, as there are cases where
c(cid:2) drops below c⊥ to effectively reject all driving proﬁles
after this point. In a similar vein, we can detect what we call
invalidated checks. These are characterized by having all y
values set to a constant value (0x7fff for c⊥ and 0 for c(cid:2) in
the ﬁrmware images we analyzed) such that the check rejects
any driving proﬁle. Using this method, the manufacturer can
parameterize a proﬁle check such that it is not actually used.
The reference test cycles as used for emissions testing
are available either free of charge [20] or tied to a small
subscription fee [7]. In most cases, the cycles are given in the
s
e
l
ﬁ
o
r
P
#
11
10
9
8
7
6
5
4
3
2
1
0
0
matched
unmatched
invalidated
20
40
60
80 100 120 140 160 180 200 220 240 260 280 300 320 340 360 380 400 420
#Images
Fig. 9: Coverage of proﬁles in all ﬁrmware images in which a defeat device
has been found. Matched proﬁles are highlighted using backward diagonal
lines, unmatched ones use forward diagonal lines and invalidated curves are
shaded gray.
form of two-dimensional data points, containing information
about the elapsed time in seconds and the speed at this point
(given either in mph or km/h). In order to actually match test
cycles to the boundaries extracted from the ﬁrmware images,
both representations need to be normalized ﬁrst. For the latter,
we scale the y axis by factor 0.1 to obtain the distance in
kilometers, and the x axis by 6.25 to obtain the engine run-
time since startup in seconds (corresponding to unit TimeRed
in the A2L ﬁle). As the test curves provide speed instead of the
covered distance, we integrate them and convert from mph to
km/h, if applicable. Finally, to match a curve, each data point
has to lie in the interval as deﬁned by c(cid:2) and c⊥, respectively.
Still, some checks cut off the driving proﬁle near the end of
a particular test cycle, where the emissions effects would most
likely not be picked up by an ongoing emissions test any more.
The corresponding test cycle would not match by comparing
all its data points due to the premature mode switch. To
account for this, we do not check the interval for the last
10% of a given test cycle.
VI. EVALUATION
Based on the prototype implementation of CURVEDIFF,
we performed a larger study of Volkswagen ﬁrmware images
to investigate which of them contain a defeat device. In the
following, we present the evaluation results together with some
highlights we found.
We analyzed 963 ﬁrmware images and conﬁgured the
analysis system with a timeout of seven minutes to avoid long-
running analysis tasks. 924 images were successfully analyzed
according to the steps outlined in the previous section, while
20 tasks timed out and 19 tasks failed to be processed by
IDA. In total, we found that 406 (44%) of the analyzed images
contained a defeat device, out of which 333 contained at least
one active (i. e., non-invalidated) proﬁle.
Performance. The static analysis is fully automated and the
fastest analysis task ﬁnished after 55 seconds, while several
tasks also timed out (see above). The geometric mean for the
analysis of all successful tasks is 105 seconds, hence we can
analyze a given image on average in less than two minutes.
243
Authorized licensed use limited to: IEEE Xplore. Downloaded on March 18,2021 at 12:25:49 UTC from IEEE Xplore.  Restrictions apply. 
TABLE II: Acoustic condition logic and affected systems, based on function
sheets. The Model column shows the ECU model (preﬁx EDC omitted). The
Version column shows the ECU version for which the function sheet was
generated. The Date column gives the date given in the function sheet. Column
N shows the number of proﬁles checked by the acoustic condition or “—”
if the acoustic condition logic block was not included in the function sheet.
The Affected Subsystems column shows the subsystems where the acoustic
condition was referenced, extracted from the variable cross-reference table in
the function sheet.
N Affected Subsystems
Date
2005-06-24 0 InjCrv, Rail
2005-10-28 0 InjCrv
2006-03-02 0 InjCrv, Rail
2006-11-06 0 InjCrv
2006-12-22 0 InjCrv
2007-03-29
2007-05-02
2007-07-12
2007-05-14
2007-05-24
2007-08-30
2007-09-18 — AirCtl, InjCrv
Model Version
16CP
P 397 A.V.0
17CP04 P 531 2.F.0
16CP
P 397 A.V.9
17CP04 P 617 3.K.0
17CP04 P 617 3.N.0
P 628 3.K.1
17CP24
17CP24
P 628 3.U.0
17CP24
P 703 3.V.5
17CP04
P 617 3.U.0
17CP14
P 531 3.U.0
17CP14
P 617 3.U.5
17CP24 P 628 3.W.5
17CP14 P 714 3.U.A 2007-10-12 5 InjCrv
17CP24 P 703 3.W.A 2007-11-05 — AirCtl, InjCrv
17CP24 P 628 3.W.G 2008-02-12 5 AirCtl, PFlt, InjCrv
17CP24 P 703 3.W.G 2008-02-14 5 AirCtl, PFlt, InjCrv
17CP24 P 628 3.W.H 2008-03-04 5 AirCtl, PFlt, InjCrv
17CP14 P 804 4.F.0
17CP24 P 703 3.W.K 2008-04-23 5 AirCtl, PFlt, InjCrv
17CP24 P 628 3.W.L 2008-05-17 5 AirCtl,
InjCrv
2008-03-26 5 InjCrv, Rail
⎫⎪⎪⎪⎪⎪⎬
⎪⎪⎪⎪⎪⎭
—
—
—
5
5
5
InjCrv
SCRFFC,
PFlt,
17CP24 P 859 4.F.0
17CP24 P 628 3.W.M 2008-06-27 5 AirCtl,
InjCrv
2008-05-30 5 AirCtl, PFlt, InjCrv, Rail
SCRFFC,
PFlt,
17CP44 P 804 4.P.0
2008-08-05 — AFS, AirCtl, ASMod, InjCrv,
17CP24 P 859 4.P.0
17CP44 P 930 4.P.5
2008-09-18 — AFS, AirCtl, ASMod, InjCrv,
2008-11-13 — AFS, AirCtl, ASMod, InjCrv,
PCR, Rail
PCR, PFlt, Rail
⎫⎬
⎭
⎫⎬
⎭
PCR, PFlt, PFltPOp, Rail
AFS, AirCtl, ASMod,
InjCrv,
InjSys,
PCR, PFltPOp,
Rail, SmkLim
AFS, AirCtl, ASMod,
InjCrv,
InjSys,
PCR, PFlt, PFltPOp,
Rail, SmkLim
17CP44
17CP44
P 804 5.A.0
P 804 5.A.5
2009-01-22
2009-02-04
17CP44
17CP44
P 859 5.A.0
P 859 5.F.5
2009-03-16
2009-07-13
7
7
7
7
Compared to an analysis with a chassis dynamometer, such an
approach is at least two orders of magnitude faster.
Results. Table III shows the results of our analysis. Results
above the double line contain ﬁrmware from the dump ob-
tained from the chiptuning scene (years 2009 and 2010). Dates
and software part numbers are taken from the street release
certiﬁcation next to the ﬁrmware images. Results below the
double line are based on ﬁrmware obtained via the erWin
portal, which provides ofﬁcial ﬁrmware images for car shops
(years 2012 to 2016). Dates are taken from the ﬁrmware’s
time stamp. For both data sources, the models have been
matched by querying an online database for spare parts, which
yields metadata for a given part number (in this case, the part
numbers specify the ECU). This mapping may not be 100%
accurate, as disclaimed by said sites as well. For part numbers
244
where multiple model names were returned (due to varying
model naming schemes in different regions), we chose the
European name, as most ﬁrmware images check for European
emissions test cycles. In cases where multiple ﬁrmware images
in a month matched the same model, we denoted the number
of images analyzed for a speciﬁc model in parentheses. Finally,
for all the images released in the same month, we took the
union of test cycles they check for to give an impression of
the number and variety of matched cycles. Figure 9 depicts
our coverage in terms of identiﬁed test cycles. For ﬁrmware
images with 5 proﬁles, we were able to match a test cycle
to each proﬁle. However, for later images checking 5 and 7
proﬁles, respectively, we were unable to ﬁnd a matching test
cycle for some of the proﬁles.
Effects on EGR. Based on the results in Table III, we
automatically identiﬁed a lower bound of ﬁrmware images in
which the acoustic condition affects the AirCtl subsystem,
responsible for calculating the amount of recirculated exhaust
gas (EGR). We did not use A2L ﬁles for this, as we do not
have matching ﬁles for all ﬁrmware images. We found that in
at least 268 images (66%), the acoustic condition can affect
EGR. Based on the parameters we extracted, we can conﬁrm
that in 247 (92%) of these images, the acoustic condition
actually inﬂuences the choice of parameters. Note that the
AirCtl detection can be improved upon as well as extended to
other subsystems as listed in Table II to fully conﬁrm further
defeat devices in Table III.
We also manually analyzed some of the defeat devices detected
by CURVEDIFF to verify our results, and in the following we
highlight some of the ﬁndings.
Steering wheel check. We found that the 2014’s EDC17C54
P1169 ﬁrmware image with part number 03L906012DE and
revision 8401 has started checking the steering wheel angle
in addition to the time-distance proﬁles, as described in
Section IV-A. An automatic scan for the steering wheel check
yielded three more images, namely 03L906012, revision 7444
(depicted in Figure 3); 03L906012DD, revision 8400; and
03L906012BP, revision 7445. The images seemingly have
been released on December 3, 2014, 22:55 and are used in VW
Passat cars according to an online database. This reﬁnement
of the defeat device is noteworthy given that at that point in
time, the CARB had already started to investigate emission
abnormalities in Volkswagen cars [15] (cf. facts 140, 141).
As evident from Table III, these images are responsible for
the largest set of test cycle matches across nearly 400 images,
further highlighting the necessity of the check. Other ﬁrmware
images released the same month (for Audi A4 and A6) do not
contain this additional logic and only match a subset of the
listed test cycles.
VII. DISCUSSION
Our empirical evaluation results demonstrate that our ap-
proach to detect Volkswagen-style defeat devices is viable
across a large number of ﬁrmware images. Nevertheless, there
are certain open challenges and potential limitations of our
approach that we discuss in the following.
Authorized licensed use limited to: IEEE Xplore. Downloaded on March 18,2021 at 12:25:49 UTC from IEEE Xplore.  Restrictions apply. 
TABLE III: Results for 363 of 406 ﬁrmware images in which CURVEDIFF detected a potential Volkswagen-style defeat device. For ﬁrmwares not listed in
this table either the release date or the model are unknown. The number in parentheses depicts the number of ﬁrmware images analyzed for this model. The
lower part of the table, below the double line, shows the result based on erWin data; the upper part is drawn from a chip tuning dump.
Matched emissions test cycles are listed as the union of matched cycles in all ﬁrmware images in that row. The last column shows whether ﬁrmware images
in this row were found to contain additional steering wheel checks that guard individual curves. The affected models in that row are printed in bold. Note
that model data in this table is retrieved from external (non-VW) sources. Further conditions may affect the defeat device’s operation.
Rls. Date Models (number of images)
2009-01
2009-07
2009-08
2009-09
2009-10
2009-11
2009-12
Golf, Passat (2)
A3
Passat Blue Motion
Golf (2), Passat (3)
Golf+, Passat
A3 (8), Golf Blue Motion, Golf (2), Passat
A3 (5), Golf Variant (2), Golf+ (2), Golf (7), Jetta (3), Passat (4)
2010-01
2010-03
Jetta, Passat (2)
A3 (2), Golf (3), Jetta, Passat (3), Q5 (4)
2010-04
Jetta (2), Passat, Passat Coupe (4), Q5
2012-05
2012-06
2012-07
2012-09
A3 (19), A4, A6, Alhambra (4), Altea, Eos (2), Golf, Ibiza (4), Leon,
Octavia (6), Q5 (2), Superb (2), TT, Tiguan, Yeti (4)
Amarok (8), CC, Eos (2), Golf (2), Jetta (2), Octavia (3), Q5 (2),
Sharan (7), Tiguan, Touran (2)
A1 (3), Alhambra (4), Caddy (2), Sharan (8)
Golf (2), Passat, Yeti (6)
2012-10
A3, Alhambra (2), Tiguan, Yeti
2012-12
2013-01
2013-04
2013-05
2013-06
2013-07
2013-08
2013-11
2013-12
2014-01
2014-03
2014-04
2014-06
2014-09
2014-10
2014-12
2015-01
2015-02
2015-03
2015-05
2015-07
2015-10
2015-11
2016-02
2016-03
2016-04
2016-06
2016-07
2016-08
2016-09
2016-10
Eos (2), Golf Cabriolet, Tiguan (7), Touran, Yeti
Leon, Passat
Amarok (6)
Amarok (4)
Amarok (5), Superb (3), Tiguan
Octavia
Yeti (3)
Superb (3)
Superb (2), Yeti (4)
Caddy (4)
Amarok (16), Eos, Tiguan, Yeti
Q5, Superb (2)
Amarok (6), Tiguan (4)
Alhambra
Sharan
A4 (3), A6, Passat (4)
Superb
A3 (3)
Alhambra (2)
Alhambra (6), Sharan (6)
Q3 (2)
Altea (2), Yeti (3)
Superb
Altea
A4, Exeo (4)
A6, Exeo, Q3
Altea (3), CC (3), Jetta, Leon (2), Superb, Tiguan (2)
Amarok, CC, Golf, Superb
CC (3), Golf Cabriolet, Golf (2), Passat (2), Scirocco, Touran (3)
CC (14), Octavia (2), Passat (2), Tiguan (7)