现在的防御机制越来越严格，常规的木马被杀的体无完肤，简单的说一下常规的免杀方法，我在圈子也分享过不下10篇Bypass AV的文章了。  
以AMSI为例：
  * 尝试禁用AMSI
  * 定位AMSI查杀的是哪一行代码，加以混淆
  * 白名单绕过
  * 自己定制对应工具
  * 重新编译msf payload
  * 写自己的加载器
  * sharpshooter
  * psh混淆
  * NoPowershell
  * battoexe，不加upx壳
  * 将恶意代码放到bmp中，再调用powershell下载，再将powershell加密放到hta，hta放入html中。
  * ...
### 社工
现在的钓鱼都是比较高级，最有特点的就是双因子钓鱼，你完全不知道自己已经上钩了。  
我还是照样用一个栗子说明。  
[Red Team Techniques-通过钓鱼攻击获得访问权限](https://evilwing.me/2019/02/28/red-team-techniques-%E9%80%9A%E8%BF%87%E9%92%93%E9%B1%BC%E6%94%BB%E5%87%BB%E8%8E%B7%E5%BE%97%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90/)  
  *     1. Red Team Techniques-通过钓鱼攻击获得访问权限
  * 1.1. 重要的注意事项
  * 1.2. 远离黑名单
  * 1.3. 成功获得初始访问权限
  * 1.4. 蓝队如何防守
  * 1.5. 总结
### 物理攻击
badusb，dropbox，WIFI，等等，快捷而有效。
### 权限维持
我推荐个ppt，有兴趣的自行参阅  
总之，猥琐至上。
## 0X04 如何隐藏自己
隐藏自己主要其实就是攻击者本身和我们的C2服务器。  
前者的话可以通过代理或者肉鸡来实现。  
后者的话就有很多细节  
我只列举我自己用过的技术，其余还有很多。
  * Faction，最近出的，基于web的多人协作平台
  * dnscat2，支持win和linux
  * pentestlab的博客有很多，包括以下
    * ICMP
    * POWERSHELL
    * JAVASCRIPT
    * HTTP
    * HTTPS
    * DNS
    * GMAIL
    * TWITTER
    * COM
    * OFFICE
    * IMAGES
    * WMI
    * AND SO ON  
还有就是Domain Fronting技术，这个就这样叫吧，翻译我找不到合适的词。  
上次和lz1y讨论的时候有适用于国内的方法。  
[红队基础建设:隐藏你的C2 server](https://xz.aliyun.com/t/4509)  
也可以找倾旋老哥讨论，他在OWASP大会上分享过email c2的思路。
以及修改自己的c2工具特征，msf，empire，cs都被安排了。
## 0X05 Blue Team如何全面的防御
首先介绍一个系统  
这个是蓝队用来模拟红队攻击的系统。  
下面就是熟悉的ATT&CK矩阵图。  
就是当蓝队捕捉到相关的活动时，可以对比图中的技术，并进行标记。  
有三个平台的矩阵图  
Windows  
Mac  
Linux  
在这里面你可以创建对手，并配置它要进行哪些操作，好处是什么？  
我们将捕捉到的日志全部发送到splunk，在里面进行特征分析，提取，最后规划防御方案。  
跟进最新威胁情报，比如empire，cs，msf等工具的特征都有人公开了，就需要自己去更改相应的特征，防止被追查。
TTP的手段是多样化的，需要红蓝双方共同合作才能找出不足，最后完善报告。
蓝队需要进行
  * 安全审核
  * 风险情报分析
  * DDOS测试
  * 制定风险方案
  * PCAP
  * 记录分析
上次看到的红蓝技能排行
**RedTeam**  
进入攻击者的海洋并尽可能地发挥你的创造力
  * 跳跃性思维，猪猪侠跟我说的猥琐
    * 红队的主要特点是跳出局限性思考，不断寻求新的工具和技术。 
  * 深入了解系统
    * 知己知彼，百战不殆
  * Program开发能力
    * 定制测试工具
  * pentesting，也是重要的一部分
  * 社工
**BlueTeam**  
你将不得着承担这大多数人不知道的后门和漏洞
  * 有组织，注重细节
  * 网络安全分析和威胁概况
    * 在评估公司或组织的安全性时，您需要创建风险或威胁配置方案。牛x的威胁配置方案包含所有可能包含潜在威胁攻击者和现实威胁情景的数据，通过在前面的准备工作，为未来的任何攻击做好充分准备 
  * 强化系统
    * 要真正为即将到来的攻击或破坏做好准备，需要对所有系统进行强化，减少黑客可能利用的攻击面。绝对必要的是强化DNS，因为它是强化策略中最容易被忽视的一个。
  * 了解入侵检测系统
    * 熟悉网络方便查找任何异常和可能具有恶意活动的软件应用程序。过滤所有网络流量包，将更好地控制公司系统中的所有网络活动。
  * SIEM
    * SIEM或安全信息和事件管理是提供安全事件实时分析的软件。它从外部源收集数据，能够根据特定的标准执行数据分析。 
## 总结
大家可能会认为，当涉及到红队或蓝队时，你可能会偏向另一个团队，但事实是，只有两个团队一起合作，才能为任何网络攻击准备一个完整有效的安全基础设施方案。
整个网络安全行业需要更多地去了解如何让两个团队一起工作并相互学习。有些人可能称之为紫队，Whatever，红队和蓝队的完美协作是真正彻底实现网络安全的唯一途径。