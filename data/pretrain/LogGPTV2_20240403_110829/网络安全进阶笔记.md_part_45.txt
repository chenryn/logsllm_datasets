很费力。因此，还是应该让杀毒软件工作起来，而现在的首要问题就是要把运行杀毒软件的障
碍彻底清除掉，多方测试之后，依然选择了“360顽固木马专杀大全”。也许是一种巧合，正
在清理木马病毒的时候，软件提示下载最新版本的“360顽固木马专杀大全V2.5.3.0”，看来
是“天遂人意”！
本马，当然，这里病毒较多的一个原因是盘符比较多，同时，一些无法清除的顽固文件也被列
出来了。扫描完毕，单击“清除”按钮，如图4.41所示。系统重启之后，速度明显提升。
图4.41查杀固木马
清理完毕，可以看到每个盘下已经没有了autorun.inf文件，但是system.dll文件依然存在。
不过，system.dll文件已经没有那么顽固了，直接按Del键即可清除。删除其他盘符下面的
system.dll文件后，马上使用Ghost对系统进行了恢复，再次打开系统，一切恢复正常了。
从上面的分析来看，这个“IFEO劫持”病毒主要采用了一种驱动级技术，属于一种关联
性动态嵌入式木马。由于该病毒通过网络浏览等途径注入到浏览器中，因此很容易中毒。如果
没有关闭驱动器自动播放，一旦运行了autorun.inf后，就会自动运行systemdll里的恶意代码
或恶意指令，并对杀毒软件进行攻击，此外，在浏览器加载的过程中，也绑定了一些恶意插件，
通过一些镜像劫持技术使得注册表无法运行，其危害性是显而易见的。不过，通过本节“抽丝
剥茧”式的解决办法，在SREng等软件的配合下，完全可以举一反三、快速清除病毒文件，
从而打造一个安全、稳定而快速的系统。
4.4.2巧用Wsyscheck清理未知恶意程序
如今杀毒软件的种类越来越多，新病毒或恶意软件的种类也层出不穷。尽管大部分杀毒软
件具有主动防御、行为判断等功能，但是，碰到新病毒的时候，这些杀毒软件在一段时间内往
207
---
## Page 217
网络安全进阶笔记
往也无可奈何。在这种场合下，手工清除成为唯一的选择。一般来说，对病毒体或恶意插件的
判断主要可以采用查看路径、查看文件名、查看文件创建日期、查看文件厂商、微软文件校验，
查看启动项等方法。不过，面对浩输无边的注册表，以及隐藏纵深的恶意插件，手工清除的难
度可想面知。
在实际应用中，我们常常需要有一些安全工具的配合，达到手工清除的目的。Wsyscheck
就是这样一款手动清理病毒木马的工具，它提供了方便的操作步骤以及详细的分析数据，大大
简化了病毒木马的识别与清理工作。软件的最新版本为V1.68.33，下载地址为http:/downl.tech.
sina.com.cn/download/down_contents/1186848000/36345.shtml。
1.小试牛刀：借助进程管理清除浏览器插件
对于插件，人们的评价有好有坏，使用过程中也是有爱有增，现在，很多病毒或木马都使
用了线程插入技术，所以Wsyscheck专门针对这种情况进行了设置，不仅可以在进程管理页中
显示出Windows系统中的隐藏进程，而且可以通过不同的额色显示出不同的进程信息。任意
点击其中一个进程，都可以在下面的窗口显示出该进程包含的模块信息。在进程列表中，正规
的系统进程显示为黑色：非系统的进程或文件被标注为红色：紫红色表示虽然该进程是系统进
程，但其模块中包含有非微软的文件。
（1）软件设置。打开并运行Wsyscheck软件，使用之前，首先需要对软件进行一些默认设
置。单击“软件设置”菜单，弹出系统的相关设置。默认情况下，软件会选中下面的“模块、
服务简洁显示”选项，这样就能够自动将微软自身的模块信息给屏蔽掉，剩下的模块就是可疑
的模块信息了。为了避免病毒进程的重复加载，还可以勾选“限制外部线程的创建”来禁止新
的线程生成
(2）查看浏览器插件信息，实际应用中，IE等常用的软件会被强制装上很多非系统的插件，
这时，点击该进程就会发现被标注为红色，如图4.42所示。需要注意的是，由于现在很多木马
程序是利用IE进程来启动运行服务端程序本身，因此并不会加载其他的恶意模块信息，因此
遇到没有标注的系统进程时也应当注意。
图4.42查看浏览器插件信息
"802
---
## Page 218
第4章拒绝恶意代码与神秘的黑客
（3）对恶意程序进行分析和清理操作。通过右键快捷菜单中的命令，我们可以方便地在进
程显示页中对恶意插件或恶意程序进行分析和清理操作。
文件”，本功能执行后看不到变化，但文件其实已经删除。如果上述操作没能删除插件，可以
继续使用“卸载模块并删除文件”功能，它可以在恶意程序（如svchost进程或winlogon进程）
插入到某些重要的系统进程时，直接结束并删除该模块文件。使用“添加到重启并删除列表”
时，可以在系统重新启动后将选定的文件直接删除。使用过程中，建议只对红色显示的非系统
模块进行删除处理，以免不慎删除系统模块。不建议单独使用“卸载模块”功能（为保险也可
以与“重启删除”联用），原因是卸载系统进程中的模块时有可能造成系统重启而前功尽弃。
在上述操作中，大多数文件（如Baidu搜索）可以立即删除（进程模块可以直接使用右键下带
删除的各项功能），加载的DLL文件删除后虽然文件仍然可见，但事实上已删除，重启后该文
件消失。对于有些狡的病毒或恶意软件，有时因为木马有关联进程未同时结束，会重新加载
本马文件。针对这种情况，Wsyscheck可以采取“0字节文件占位”的方式来确保删除，这些
后锁定”命令，通过联合“内核检查”等功能继续进行清除。
无论是恶意程序还是正规软件，从WindowsXP开始都以系统服务来启动所需的程序。点
击“服务管理”后，即可显示出当前系统中的服务信息，同样那些标注为红色的是非系统服务。
通过“仅显示非微软”选项可以屏蔽系统自带的服务，这样恶意程序添加的服务项就可以立刻
现形了。
项”，就可以了解这些服务的详细信息。选择正在启动的cdnprot服务，即可了解该服务的文
件厂商为“中国互联网络信息中心”：然后在该服务上单击右键，在弹出的快捷菜单中选择“定
位注册表项”，即可查看详细的注册表键值，如图4.43所示。
图4.43查看注册表键值
---
## Page 219
网络安全进阶笔记
此外，在右键菜单中，还提供了许多方便的服务。例如，“中止服务”功能可以在系统重
启前中止服务，并不是永久性的终止服务；“删除服务”则是删除指定的服务键值，不过在制
除前一定要进行确认。另外，某些服务不提供终止服务，所以删除服务后它可能仍在运行，需
要重启系统后才能真正停止其作用。下面演示一个清除cdnprot服务的过程。
(2）首先尝试直接清理cdnprot服务。实际操作中，某些顽固的恶意服务是无法中止或删
除的。比如，现在针对cdnprot服务进行操作，单击“删除选中的服务”时，软件提示“删除
服务键失败”。这是因为它可能采用了注册表键值的保护。对付这类服务，要使用软件提供的
内核Hook检查中的SSDT恢复功能后，才能在本选项页中进行其服务删除操作。
（3）进行内核检查，内核Hook检测只关注被恶意程序Hook了的内核函数：一般来说对
应的模块提供者是一个sys文件。在SSDT管理页中，默认显示了全部的SSDT表，红色表示
内核被Hook的函数。查看第三方模块，可以点击两次“映像路径”标签排序，则第三方Hook
的模块会排在一起列在最前面。也可以取消“全部显示”，则仅显示入口改变了的函数。
以“CNNIC中文网址”为例，它的驱动通过注册表和文件进行交叉保护，一般卸载工具
都不能删除cdnprotsys文件。SSDT页的“代码异常”栏如显示“YES”，表明该函数被Inline
Ho0k。如图4.44所示。
miatey.
图4.44内核检查
（4）恢复系统底层原始函数地址。发现木马修改了SSDT表时，建议首先恢复SSDT，再
做注册表删除等操作。对付这样的系统底层驱动，可以勾选并恢复成系统默认函数，以使其驱
动保护失效。右键单击这些被检测出来的内核函数，在弹出的菜单中选择”恢复当前函数地址”。
（5）删除恶意代码的注册表项。恢复系统底层原始函数地址后，回到“服务管理”选项卡
中，就可以在服务管理页删除“CNNIC中文网址”的注册表服务项了。由于底层Hook的优先
级很高，所以恢复了SSDT后可能会有一些隐藏的进程或文件被显示出来。这时可以在恢复
SSDT后再次检查各检测页状况，以删除受这些驱动隐藏保护的进程、注册表项等。
（6）解决IFEO劫持问题。对于有些新病毒来说，如果上述操作方法仍然不能解决问题，
210
---
## Page 220
第4章拒绝恶意代码与神秘的黑客
可以使用进程页的“禁止程序运行”，我们可以使用它来屏蔽一些结束后又自动重新启动的程
复创建文件、反复写注册表启动项等问题进行监视或阻止，使用本功能后能够更轻松地删除木
取消后该页消失。可以观察一下日志情况以便从所阻止的动作中找到比较隐藏的木马文件。要
注意的是，如果木马插入系统进程，则反映的日志是阻止系统进程的动作，用户需要分辨该动
作是否有害，并分析该进程的模块文件。
（7）解决重启之后的错误提示问题。现在，已经对重点的恶意程序进行了清理，但重新启
动后系统依然有提示，如“加载C:PROGRA~IBaiduiexpiBDSrHookdIl时出错，拒绝访问。”
如图4.45所示。
×
图4.45重启之后的错误提示
在打开的对话框中输入“msconfig”命令，打开系统配置实用程序，去掉BDSrHook启动项目
选择项，如图4.46所示。重新启动后，此问题得到解决。
.车统配安用
区
C:V
hrloet
全全
图4.46设置“启动”选项卡
3.锦上添花：文件搜索、文件浏览及注册表查看功能
为了配合清除恶意程序或病毒文件，Wsyscheck提供了方便的辅助功能，包括安全检查、
文件管理和注册表管理。通过这些功能的配合，使得恶意程序往往无处藏身。
在“安全检查”功能区中，包括常规检查、活动文件、IE安全、端口状态、文件搜索、重
启删除文件等选项。在“活动文件”中，可以准确地显示常规启动项的内容，便于用户发现潜
---
## Page 221
网络安全进阶笔记
便，能够有效地对有厂家的正规文件或没有厂家的恶意文件进行区分，从而有效清除系统中的
病毒备份或找到未知病毒，此外，通过“端口状态”还可以详细地了解系统当前的端口状态，
如图4.47所示。由于木马或其他远程控制软件通常会占用特定的端口，通过此功能，可以详细
地了解木马运行状况。
图4.47使用Wsyscheck进行安全检查
在“文件管理”功能区中，由于Wsyscheck采用了一些反Hook手段，所以内置的资源管
理器可以看到隐藏的文件或文件夹，这样就能够方便用户进行隐藏文件的相关操作，对于利用
系统本身特性隐藏的文件，比如Windows中的某些文件夹，或者利用Rootkit技术隐藏的灰鸽
子、hackdefl00等隐藏文件，内置的资源管理器都可以一览无遗。
在“注册表管理”功能区中，提供了常见的注册表管理功能，如通过下拉菜单可以方便地
找到HKEY_LOCAL_MACHINEISOFTWAREMicrosoffWindowsiCurrentVersion\Run“等路径。
不过，注册表功能通常与其他功能联手操作，如发现恶意的服务或进程时，通过点击右键即可
找到该键值。
除了上述查看工具，还可以利用系统防护工具，继续对系统进行清理。例如，通过“安全
环境”按钮，程序会关闭一切不必要的程序，来获得干净的系统环境。某些木马会破坏安全模
以先备份当前安全模式键值，再恢复默认的安全模式键值。手工清理完毕，还可以执行“清理
临时文件”、“清理IE临时文件”、“清除Autorun.inf”等工具，清理Autorunini 加载的木
马及清理已确定的病毒木马文件等，以达到更好的清理效果。
通过上述三个层层递进的过程，对目前典型的恶意程序或大部分未知的病毒都能有效侦查
并及时清理。
在清理病毒的过程中，还要注意重启机器，这样，大部分的病毒应该可以搞定了。当然，
清理完毕，可以切换到文件搜索页，限制文件大小为50KB左右，去除选择“排除微软文件”
选项，然后搜索最近一周的新增的文件，通过此方法可以进一步筛选出病毒文件，并将其彻底
删除。这样，系统又可以恢复到正常状态了。
.212
---
## Page 222
三
第4章拒绝恶意代码与神秘的黑客
4.4.3巧借VMware逆向分析入侵过程
近年来，《无间道》、《潜伏》等间谋类题材吸引了许多人的目光，也给人们展示了一个
真真假假、虚虚实实的现实世界。不过，在网络世界里，也在时刻上演着这样的虚幻故事。比
如，要维护网络安全，首先必须了解系统存在的漏洞和缺陷，了解攻击者的意图、技术、技巧
等。但是，如同小偷不会告诉你偷了哪些东西，攻击者也不可能会告诉你详细的入侵过程。如
今，随着虚拟化技术越来越受欢迎，通过蜜罐技术了解攻击工具和攻击策略也开始受到网络管
理者的青。下面，将借助于VMware虚拟化软件打造网络版“余则成”，构建“间课式”蜜
罐并连入互联网，通过该蜜罐工具捕获一些攻击行为，通过对这些攻击案例的深入分析，了解
攻击者进行非法活动的整个过程以及所使用的攻击工具和方法。
1.蜜罐基础：了解间谋的“十八般武艺”
一个精明的间课自然有十八般武艺，面“蜜罐技术”则是一种对攻击者进行识别并“瓦解”
的技术。蜜罐技术通过部署作为诱饵的主机、网络服务以及信息，诱使攻击者进行攻击，减少
对实际系统造成的安全威胁。更重要的是，蜜罐技术可以对攻击行为进行监控和分析，了解攻
击者所使用的攻击工具和攻击方法，推测攻击者的意图和动机。比如，《潜伏》刷中余则成的
一些反间谋布置，包括在门、抽展间卡纸条，在地上撒石灰等，这样，就能够追踪攻击者的来