利用条件：需目标开放445端口和admin默认共享  
参考链接：[]
**3.Mimikatz和Procdump抓取密码原理**  
**（1）Mimikatz**  
Mimikatz是一款内网渗透神器，它可以从内存中获取哈希、明文密码，支持经典的PTH,PTK,PTT攻击，在域环境下还可伪造黄金、白银票据来进行权限维持。其工作原理是:通过获取调试权限来提升mimikatz进程权限，使其可以注入进程、读取进程内存数据，然后就可以使用里面写好的模块，把目标机器按在地上进行摩擦了。那什么是调试权限呢？微软官方给出的解释是：  
“调试权限允许某人调试他们原本无权访问的进程。例如，以在其令牌上启用调试权限的用户身份运行的进程可以调试作为本地系统运行的服务。调试权限是一种安全策略设置，允许用户将调试器附加到进程或内核。管理员可以修改用户组的安全策略以包含或删除此功能。正在调试自己的应用程序的开发人员不需要此用户权限。调试系统组件或调试远程组件的开发人员将需要此用户权限。此用户权限提供对敏感和关键操作系统组件的完全访问权限。默认情况下，为具有管理员权限的用户启用此属性。具有管理员权限的用户可以为其他用户组启用此属性。”  
大意就是，默认情况下，本地管理员组拥有调试权限（这就是为什么Mimikatz需要管理员身份来运行了），通过调试权限使其可以调试进程，调试作为本地系统运行的服务，甚⾄是调试内核。可以通过安全策略来管理此功能。  
理解了其工作原理之后，就不难理解它如何能抓取到密码了。首先来了解一下什么lsass：它是微软Windows系统的安全机制，它主要用于本地安全和登陆策略。通常我们在登陆系统时输入密码之后，密码便会储存在lsass内存中。  
Mimikatz正是通过获取调试权限来读取lsass.exe这个进程的内存数据来获取密码的！那明白了原理，操作就是有手就行的事了：
    privilege::debug  #获取调试权限(提升权限)
    sekurlsa::logonpasswords  #读取密码，包括明文和哈希
有关Mimikatz的模块和相关攻击手法可参考：[]  
（Mimikatz获取系统密码攻防研究）
Mimikatz中获取凭据有多种方式：  
CobaltStrike的梼杌插件中几乎都集成了这些方式：  
需要说一下的是，我们能抓取到明文密码，其实是通过Wdigest获得的。Wdigest是lsass中的一个模块，它是利用HTTP和SASL进行身份验证，具体表现为把明文密码存在lsass.exe进程里通过http进行认证。在win2008之后的版本WDigest是默认不启用的；在win2008之前的版本如果安装了KB2871997补丁的话，也不能从中获得明文。  
但这又不是绝对的，KB2871997补丁的其中一个作用是关闭WDigest
Auth，但是并不是完全关闭。因为某些系统服务(如IIS的SSO身份认证)就需要用到WDigest
Auth，所以这里微软选择了一个折中的方法，让用户选择是否关闭WDigest Auth，安装补丁之后可以自己选择是否开启WDigest
Auth，如果选择开启WDigest Auth的话还是会保存明文密码。通过将注册表项
    HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDigest
中的UseLogonCredential键值修改为1即可。
关于KB2871997的详细细节可参考下面这两篇文章：[]  
（内网渗透 | 了解和防御Mimikatz抓取密码的原理）  
[]  
（KB22871997是否真的能防御PTH攻击?）  
Mimikatz是学习内网攻防必不可少的环节，而KB2871997补丁是我们学习Mimikatz攻防必须要掌握的。
**(2)Procdump**  
Procdump抓取密码的原理就是获取内存文件 lsass.exe
进程中存储的登录密码并存储到lsass.dmp文件中，然后使用mimikatz去读取lsass.dmp获取到密码。操作有手就行：
    #dump密码文件
    procdump.exe -accepteula -ma lsass.exe lsass.dmp
    #mimikatz去读取密码文件并保存到txt文件里
    mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonPasswords full" > pssword.txt exit
**4\. 密码喷洒**  
内网渗透中，能获取到主机管理员账号密码，将会使我们横向事半功倍，尤其是在大内网环境中，密码复用率很高，一波喷洒，能助力你拿到一波主机，对拿到的主机再次抓取密码，再用新拿到的密码喷洒一波......，如此反复。当然密码的获取还可以通过翻一些敏感文件，运气好的话，有时桌面就会有账号密码.txt这样的文件。密码喷洒的思路就是这样：不断收集内网账号密码，不断去喷洒，可以针对135,139,445,3389,22,1433,3306,1521等端口进行喷洒。相关工具fcan，hydra就不说了，这里就介绍下Crackmapexec。  
CrackMapExec（CME）是一款后渗透利用工具，可帮助自动化大型活动目录(AD)网络安全评估任务。该工具的生存概念是，利用AD内置功能/协议达成其功能，并规避大多数终端防护/IDS/IPS解决方案。项目地址：[]  
kali中自带，建议使用kali中自带的，比较稳定。目前支持ldap,ssh,smb,mssql,winrm协议，不仅可用于密码喷洒，也可用来攻击。  
工具的使用没啥可说的，这里给出一个使用指南：[]
喜欢攻防渗透的师傅们，欢迎关注我的微信公众号：沃克学安全，一起讨论，一起成长哦~  
奉上之前公众号发布的两篇HW的文章：  
[]  
（记首次HW|某地级市攻防演练红队渗透总结,首发先知社区）  
[]  
（记某地市HW|外网打点到Linux内网横向初体验，首发奇安信攻防社区）  
转载请注明原创和出处，谢谢~