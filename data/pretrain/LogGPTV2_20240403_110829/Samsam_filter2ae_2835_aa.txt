# 深入分析恶意勒索软件Samsam的多个变种
---
##### 译文声明
本文为翻译文章，原文来源：www.crowdstrike.com
具体内容及含义以原文为准。
---

## 一、概述
本文对由BOSS SPIDER开发和运营的恶意软件Samsam进行了深入分析。CrowdStrike® Falcon Intelligence™持续追踪该组织的活动。Samsam的不同变种在感染链和执行流程上存在差异，本文将对此进行详细探讨。该恶意软件利用外部工具（如批处理脚本、Mimikatz以及系统内部实用程序PsExec和Sdelete）来传播和清理勒索软件。某些情况下，勒索软件会同时投递加密方法与运行程序文件，后者用于加载并执行内存中的恶意软件。此外，Samsam具备反取证功能，使得从受感染系统中恢复勒索软件Payload变得困难。尽管如此，Falcon Prevent能够在Samsam家族对系统文件进行加密之前及时检测并阻止其行为。

## 二、感染过程
Samsam勒索软件家族的投递方式经历了多次变化。早期版本通过凭据自动收集工具（例如Mimikatz）从Active Directory中获取凭证，并为每个用户生成RSA公钥。部署时，伴随以下文件一同下发：
1. **PSExec**：合法的系统内部工具，用于远程执行应用程序；
2. **备份删除辅助程序**：遍历所有连接到被感染主机的驱动器，并删除备份文件；
3. **暴露账户列表**；
4. **包含每个账户唯一RSA公钥的文件夹**；
5. **四个批处理脚本**，负责复制文件至每台受感染主机并加载Payload：
   - 第一个脚本：将Samsam Payload及其对应的公钥复制至`%WINDIR%\system32`目录下，并执行命令`vssadmin delete shadows /all /quiet`；
   - 第二个脚本：将备份删除辅助程序复制至`C:\Windows`目录；
   - 第三个脚本：使用psexec远程执行删除辅助程序；
   - 第四个脚本：利用psexec远程执行Payload，提供相应的公钥作为参数。

在后续变种中，密钥和备份删除指令直接嵌入Payload内，不再依赖于大量辅助文件。这些变种采用运行程序和批处理脚本来完成加密与部署任务，具体步骤如下：
1. **运行程序**：解密并加载Payload；
2. **批处理脚本**：启动运行程序并向其传递必要的参数，包括解密/加密Payload所需的密钥等信息。

部分Samsam变种甚至无需额外参数或辅助程序即可独立运作。

## 三、技术分析

### 备份删除辅助程序
此组件旨在遍历受感染计算机上的文件系统，特别是针对具有特定扩展名的数据备份文件（详见附录A）。一旦发现符合条件的文件，它将尝试更改其属性设置为`FILE_ATTRIBUTE_NORMAL`以便顺利删除，并最终移除整个目录。对于锁定状态下的文件，程序会尝试终止相关进程后再行删除操作。

### 运行程序
运行程序负责解密内存中的Payload。需要密码作为输入参数来进行解密过程。当由批处理脚本触发后，它会在当前工作目录搜索扩展名为`.stubbin`的实际加密Payload。找到后，运行程序将其内容读入内存并立即从磁盘删除原始文件，从而增加了解密后Payload恢复难度。解密采用Rijndael算法，需提供预设的盐值“Ivan Medvedev”以生成解密密钥和初始化向量（IV）。任何附加参数都将被传递给已解密的Payload以供进一步使用。

### 文件系统遍历与加密
Samsam在遍历过程中会跳过特定目录（如`C:\Windows`），以避免干扰关键系统文件。对于目标文件，根据大小分为不同批次进行加密处理，优先处理较小文件以确保即使进程提前终止也能实现最大破坏效果。具体加密逻辑因变种而异，但通常涉及检查现有`.encryptedRSA`文件的存在与否及其大小关系，以此决定是否继续加密原文件或跳过之。

### 变种间差异
- **变种A**：若发现同名`.encryptedRSA`文件且其尺寸大于待加密文件，则假定该文件已被加密并直接删除原文件；反之则删除旧版加密文件再重新加密。
- **变种B**：直接跳过已存在的`.encryptedRSA`文件而不做进一步验证。

通过上述机制，Samsam能够有效绕过部分安全措施并对受害系统造成广泛损害。