TLP:CLEAR
INCIDENT RESPONSE METHODOLOGY
IRM #7
WINDOWS
MALWARE
DETECTION
Live Analysis on a suspicious
computer
IRM Author: CERT SG
Contributor: CERT aDvens
IRM version: 2.0
E-Mail: PI:EMAIL
Web: https://cert.societegenerale.com
Twitter: @CertSG
TLP:CLEAR
TLP:CLEAR
ABSTRACT
This Incident Response Methodology is a cheat sheet dedicated to handlers investigating on a
precisesecurityissue.
WHOSHOULDUSEIRMSHEETS?
 Administrators
 SecurityOperationCenter
 CISOsanddeputies
 CERTs(ComputerEmergencyResponseTeam)
Remember: If you face an incident, follow IRM, take notes. Keep calm and contact your
businessline’sIncidentResponseteamorCERTimmediatelyifneeded.
→IRMCERTSG:https://github.com/certsocietegenerale/IRM
→IRMCERTaDvens(Frenchversion):https://github.com/cert-advens/IRM
IRM #7 WINDOWS MALWARE DETECTION
2
TLP:CLEAR
TLP:CLEAR
INCIDENT HANDLING STEPS
6 STEPS ARE DEFINED TO HANDLE SECURITY INCIDENTS
1. Preparation: get ready to handle the incident
2. Identification: detect the incident
3. Containment: limit the impact of the incident
4. Remediation: remove the threat
5. Recovery: recover to a normal stage
6. Lessons learned: draw up and improve the process
IRM provides detailed information for each stepof the incident response process.The steps
come from NIST Computer Security Incident Handling Guide.
IRM #7 WINDOWS MALWARE DETECTION
3
TLP:CLEAR
TLP:CLEAR
PREPARATION
OBJECTIVE: ESTABLISH CONTACTS, DEFINE PROCEDURES, GATHER INFORMATION TO SAVE
TIMEDURINGANINCIDENT.
▪ DeployanEDRsolutiononendpointsandservers
o Thistoolbecameoneofthecornerstonesofincidentresponseincaseofransomwareorinlarge
scalecompromise,facilitatingidentification,containment,andremediationphases.
o Launch EDR Search and AV scan with IOC explicit rules and get first indicators for remediation
progressfollowing.
o SetyourEDRpoliciesinpreventmodetopreventunnecessarybusinessdisruption.
▪ In absence of EDR, a physical access to the suspicious system should be given to the forensic
investigator. Physical access is preferred to remote access, as the hacker could detect the
investigationsdoneonthesystem(byusinganetworksnifferforexample).
▪ A physical copy of the hard-disk might be necessary for forensic and evidence purposes. Finally, if
needed,aphysicalaccesscouldbeneededtodisconnectthesuspectedmachinefromanynetwork.
▪ AcquisitionprofilesforEDRortoolslikeFastIR,DFIROrc,KAPE,DumpIt,FTKImager,WinPmemmust
bepreparedandtested.
▪ Agood knowledge of the usualnetwork activityof the machine/server is needed. You shouldhave a
fileonasecureplacedescribingtheusualportactivity,tocompareefficientlytothecurrentstate.
▪ Agoodknowledgeoftheusualservicesrunningonthemachinecanbeveryhelpful.Don’thesitateto
ask a Windows Expert for his assistance, when applicable. A good idea is also to have a map of all
services/runningprocessofthemachine.
Endpoints
▪ Ensurethatthemonitoringtoolsareuptodate.
▪ DeploySysmon,SmartScreenandapplyrecommendationbaselinesfromANSSIandCIS.
▪ Establishcontactswithyournetworkandsecurityoperationteams.
▪ Makesurethatanalertnotificationprocessisdefinedandwell-knownfromeveryone.
▪ MakesureallequipmentaresynchronizedwiththesameNTP.
▪ Selectwhatkindoffilescanbelost/stolenandrestricttheaccessforconfidentialfiles.
▪ Makesurethatanalysistoolsareup,functional(Antivirus,EDR,IDS,logsanalyzers),notcompromised,
anduptodate.
▪ Installfromthesameoriginalmaster.
IRM #7 WINDOWS MALWARE DETECTION
4
TLP:CLEAR
TLP:CLEAR
IDENTIFICATION
OBJECTIVE: DETECT THE INCIDENT, DETERMINE ITS SCOPE, AND INVOLVE THE
APPROPRIATEPARTIES.
The family of malware identified will impact the next steps of the incident response.
Investigation will be faster for a Potentially Unwanted Software or a Miner. Stealer,
DropperorRansomwarefamilywillimplyadeeperanalysisandmayleadtoanotherkind
of incident (please refer to Large scale malware compromise, Ransomware, Windows
IntrusionDetectionorWormInfectionifneeded).
Generalsignsofmalwarepresenceonthedesktop
Severalleadsmighthintthatthesystemcouldbecompromisedbymalware:
▪ EDR, HIDS, Antivirus software raising an alert, unable to update its signatures, shutting down or
unabletorunmanualscans.
▪ Unusualhard-diskactivity:theharddrivemakeshugeoperationsatunexpectedtimes.
▪ Unusuallyslowcomputer:sudden,unexplainedslowdownsnotrelatedtosystemusage.
▪ Unusual network activity: Slow internet connection / poor network share performance at irregular
intervals.
▪ Thecomputerrebootswithoutreason.
▪ Applicationscrashingunexpectedly.
▪ Pop-upwindowsappearingwhilebrowsingtheweb.(sometimesevenwithoutbrowsing).
▪ YourIPaddress(ifstatic)ispresentononeormoreInternetBlocklists.
▪ Peoplearecomplainingaboutyoue-mailingthem/reachingthembyIMetc.whileyoudidnot.
If the issue is considered as strategic (sensitive resources access), a specific crisis
managementcellshouldbeactivated.i.e.LargeScaleCompromiseIRM-18
Most of the above guidance is inspired by SANS Institute posters: https://www.sans.org/posters
It’s always better to run several of these tools than only one.
IRM #7 WINDOWS MALWARE DETECTION
5
TLP:CLEAR
TLP:CLEAR
IDENTIFICATION
1–Evidenceacquisition
WARNING(VOLATILEDATA):
BEFORECARRYINGOUTANYOTHERACTIONS,MAKESURETOMAKEAVOLATILEMEMORYCAPTURE
BYDOWNLOADINGANDRUNNINGFTKIMAGER,WINPMEMORANOTHERUTILITYFROMANEXTERNAL
DRIVE.
VOLATILE DATA PROVIDES VALUABLE FORENSIC INFORMATION AND IS STRAIGHTFORWARD TO
ACQUIRE.
▪ Volatiledata:
Volatile data is useful to perform analysis on command line history, network connections, etc. Use
“Volatility”ifpossible.
▪ Takeatriageimage:
UsetoolslikeEDR,FastIR,DFIROrc,KAPEwithpreconfiguredprofiles.
Or
▪ Fulldiskcopyimage:
Withtoolslikedd,FTKImager,etc.
Warning: you may need admin privileges on the machine or a write-blocker (physical or
logical)dependingontheusecase.
2–Memoryanalysis:
▪ Lookforrogueprocesses
▪ ReviewprocessDLLsandhandles
▪ Checknetworkartifacts
▪ Lookforcodeinjection
▪ Checkthepresenceofrootkits
▪ Dumpsuspiciousprocessesforfurtheranalysis
If the issue is considered as strategic (sensitive resources access), a specific crisis
managementcellshouldbeactivated.i.e.LargeScaleCompromiseIRM-18
Most of the above guidance is inspired by SANS Institute posters: https://www.sans.org/posters
It’s always better to run several of these tools than only one.
IRM #7 WINDOWS MALWARE DETECTION
6
TLP:CLEAR
TLP:CLEAR
IDENTIFICATION
3–Identifypersistencemechanisms:
Persistencecanbeallowedthroughdifferenttechniquesincluding:
▪ Scheduledtasks
▪ Servicereplacement
▪ Servicecreation
▪ Auto-startregistrykeysandstartupfolder
▪ Dllsearchorderhijacking
▪ Trojanedlegitimatesystemlibraries
▪ LocalGroupPolicy
▪ MSofficeadd-in
▪ Pre-bootpersistence(BIOS/UEFI/MBRalteration)
YoumayconsiderusingMicrosoftautorunsforaquickwin.
4–CheckEventLogs
▪ Scheduledtaskslog(creationandexecution)
▪ AccountLogonEvents(checkforout-of-officeconnections)
▪ Suspiciouslocalaccount
▪ MaliciousServices
▪ ClearingEventLogs
▪ RDP/TSELogs
▪ PowershellLogs
▪ SMBLogs
5–Super-Timeline
▪ Processevidenceandgenerateasuper-timelinewithtoolslikeLog2timeline.
▪ AnalyzethegeneratedtimelinewithTimelineExplorerorgloggforexample.
6–Togofurther
▪ Hashlookups
▪ MFTanomaliesandtimestamping
▪ Anti-virus/Yara analysis/Sigma :
o Mount the evidence in a read-only mode. Run Anti-virus scan or multiple Yara files for a quick-
win detection.
o Please note that unknown malware may be not detected.
If the issue is considered as strategic (sensitive resources access), a specific crisis
managementcellshouldbeactivated.i.e.LargeScaleCompromiseIRM
Most of the above guidance is inspired by SANS Institute posters: https://www.sans.org/posters
It’s always better to run several of these tools than only one.
IRM #7 WINDOWS MALWARE DETECTION
7
TLP:CLEAR
TLP:CLEAR
CONTAINMENT
OBJECTIVE:MITIGATETHEATTACK’SEFFECTSONTHETARGETEDENVIRONMENT.
WARNING(VOLATILEDATA):
MEMORY AND SELECTIVE VOLATILE ARTIFACTS’ ACQUISITION MUST BE CARRIED OUT BEFORE THE
FOLLOWINGSTEPSHAVETAKENPLACE.
If the machine is considered critical for your company’s business activity and can’t be disconnected,
backupallimportantdataincasethehackernoticesyou’reinvestigatingandstartsdeletingfiles.
▪ Ifpossible,isolatethemachineviaEDR.
OR
▪ Ifthemachineisnotconsideredcriticalforyourcompanyandcanbedisconnected,shutthemachine
down the hard way, removing its power plug. If it is a laptop with a battery on, just push the “off”
buttonforafewsecondsuntilthecomputerswitchesoff.
SendthesuspectbinariestoyourCERT,orrequestCERT’shelpifyouareunsureaboutthe
malware’snature.The CERT shouldbe able toisolate themalicious content andcansend
it to all AV companies, including your corporate contractors. (The best way is to create a
zipped,password-encryptedfileofthesuspiciousbinary.)
Offlineinvestigationsshouldbestartedrightawayiftheliveanalysisdidn’tgiveanyresult,butthe
systemshouldstillbeconsideredcompromised.
▪ Inspect network shares or any publicly accessible folders shared with other users to see if the
malwarehasspreadthroughit.
▪ Moregenerally,trytofindhowtheattackergotintothesystem.Allleadsshouldbeconsidered.Ifno
computer proof of the intrusion is found, never forget it could come from a physical access or a
complicity/stealingofinformationfromanemployee.
▪ Apply fixes when applicable (operating system and applications) in case the attacker used a known
vulnerability.
IRM #7 WINDOWS MALWARE DETECTION
8
TLP:CLEAR
TLP:CLEAR
REMEDIATION
OBJECTIVE:TAKEACTIONSTOREMOVETHETHREATANDAVOIDFUTUREINCIDENTS.
WARNING: ONLY START REMEDIATING ONCE YOU ARE 100% SURE THAT YOU HAVE WELL
SCOPED UP AND CONTAINED THE PERIMETER - AS TO PREVENT THE ATTACKER FROM
LAUNCHING RETALIATION ACTIONS.
Themoststraight-forwardwaytogetridofthemalwareistoremasterthemachine.
▪ Removethebinariesandtherelatedregistryentries.
▪ Find the best practices to remove the malware. They can usually be found on Antivirus companies’
websites.
▪ Removeallmaliciousfilesinstalledandpersistencemechanismsputinplacebytheattacker.
▪ ApplytheEDRpreventionmodeforallidentifiedIOCs.
IRM #7 WINDOWS MALWARE DETECTION
9
TLP:CLEAR
TLP:CLEAR
RECOVERY
OBJECTIVE: RESTORE THE SYSTEM TO NORMAL OPERATIONS.
If possible, reinstall the OS and applications and restore user’s data from clean, trusted backups. If
deemednecessary,youmayaskyourlocalIThelpdesktoreimagethedisk.
Incasethecomputerhasnotbeenreinstalledcompletely:
▪ Restorefileswhichcouldhavebeencorruptedbythemalware,especiallysystemfiles.
▪ Changeallthesystem’saccountspasswordsandmakeyourusersdosoinasecureway.
▪ Rebootthemachineafterallthesuspiciousfileshavebeenremovedandconfirmthattheworkstation
is not exhibiting any unusual behavior. A full, up-to-date AV and EDR scan of the hard-drive and
memoryarerecommended.
Ifauserisattheoriginofthecompromise,youshouldreinforcesecurityawarenesscampaigns.
Formoredetailsonauthenticationandinfrastructurerecovery,checktheLarge-scalemalwarecompromiseIRM-18
IRM #7 WINDOWS MALWARE DETECTION
10
TLP:CLEAR
TLP:CLEAR
LESSONS LEARNED
OBJECTIVE: DOCUMENT THE INCIDENT’S DETAILS, DISCUSS LESSONS LEARNED, AND
ADJUSTPLANSANDDEFENSES.
Report
Anincidentreportshouldbewrittenandmadeavailabletoallofthestakeholders.
Thefollowingthemesshouldbedescribed:
▪ Initialdetection
▪ Actionsandtimelines
▪ Whatwentright
▪ Whatwentwrong
▪ Incidentcost
▪ Indicatorsofcompromise
Capitalize
Actionstoimprovemalwaredetectionanderadicationprocessesshouldbedefinedtocapitalizeonthis
experience.
Profilesofacquisitiontoolscanbetweakedtobettermatchartifactsdetectedduringtheinvestigation.
IRM #7 WINDOWS MALWARE DETECTION
11
TLP:CLEAR