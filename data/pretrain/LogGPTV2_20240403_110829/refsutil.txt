### ReFSUtil

**Applies to:** Windows Server 2022, Windows Server 2019, Windows 10

**Overview:**
ReFSUtil is a tool included in Windows and Windows Server that is designed to diagnose and recover heavily damaged ReFS (Resilient File System) volumes. It can identify remaining files and copy them to another volume. This tool is located in the `%SystemRoot%\Windows\System32` folder.

**Primary Function:**
The primary function of ReFSUtil is to salvage data from ReFS volumes that are showing as RAW in Disk Management. The process involves two main phases: the Scan Phase and the Copy Phase. These phases can be run sequentially in automatic mode or separately in manual mode. Progress and logs are saved in a working directory, allowing for pausing and resuming the Scan Phase and running each phase independently.

**Usage:**
- **Automatic Mode:**
  - **Quick Automatic Mode (`-QA`):** Performs a Quick Scan Phase followed by a Copy Phase. This mode assumes that some critical structures of the volume are not corrupted, making it faster but potentially less thorough.
    ```sh
    refsutil salvage -QA <Volume> <Working Directory> <Destination Directory>
    ```
  - **Full Automatic Mode (`-FA`):** Performs a Full Scan Phase followed by a Copy Phase. This mode scans the entire volume, which may take a long time but ensures a more comprehensive recovery.
    ```sh
    refsutil salvage -FA <Volume> <Working Directory> <Destination Directory>
    ```

- **Manual Mode:**
  - **Diagnose Phase (`-D`):** Determines if the specified volume is an ReFS volume and whether it is mountable. If the volume is not mountable, the reasons will be provided.
    ```sh
    refsutil salvage -D <Volume>
    ```
  - **Quick Scan Phase (`-QS`):** Performs a Quick Scan of the volume for any recoverable files. Discovered files are logged to `foundfiles.txt` in the working directory. If the scan was previously stopped, it can be resumed from where it left off.
    ```sh
    refsutil salvage -QS <Volume> <Working Directory>
    ```
  - **Full Scan Phase (`-FS`):** Scans the entire volume for any recoverable files. Discovered files are logged to `foundfiles.txt` in the working directory. If the scan was previously stopped, it can be resumed from where it left off.
    ```sh
    refsutil salvage -FS <Volume> <Working Directory>
    ```
  - **Copy Phase (`-C`):** Copies all files described in `foundfiles.txt` to the destination directory.
    ```sh
    refsutil salvage -C <Volume> <Working Directory> <Destination Directory>
    ```
  - **Copy Phase with List (`-SL`):** Copies files listed in a custom file (e.g., `custom_foundfiles.txt`) to the destination directory. This file can be generated by filtering `foundfiles.txt`.
    ```sh
    refsutil salvage -SL <Volume> <Custom File> <Destination Directory>
    ```
  - **Copy Phase with Interactive Console (`-IC`):** Allows advanced users to salvage files using an interactive console. This mode requires files generated from either of the Scan Phases.
    ```sh
    refsutil salvage -IC <Volume> <Working Directory> <Destination Directory>
    ```

**Parameters:**
- `<Volume>`: Specifies the ReFS volume to process. The drive letter must be formatted as "L:", or you must provide a path to the volume mount point.
- `<Working Directory>`: Specifies the location to store temporary information and logs. It must not be located on the target volume.
- `<Destination Directory>`: Specifies the location where identified files are copied to. It must not be located on the target volume.
- `-m`: Recovers all possible files, including deleted ones. **WARNING:** This parameter can cause the process to take longer and may lead to unexpected results.
- `-v`: Specifies to use verbose mode.
- `-x`: Forces the volume to dismount first, if necessary. All opened handles to the volume will then be invalid. **WARNING:** This parameter can cause the process to take longer and may lead to unexpected results.

**Example:**
```sh
refsutil salvage -QA R: N:\WORKING N:\DATA -x
```

**Note:**
- You should only use the ReFSUtil tool if the volume is showing as RAW. If the volume is read-only, the data is still accessible without the need for this tool.