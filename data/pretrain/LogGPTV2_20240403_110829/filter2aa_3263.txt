Devil&is&in&the&Details:&Revealing&How&
Linux&Kernel&put_user at&Risk
Edward&Lo&and&Chiachih Wu
C0RE&Team
About&Us
• 罗元琮 (Edward)
– 奇虎 360&安全研究开发工程师
– 专职内核漏洞挖掘与利用
– “360&超级 ROOT”&技术负责人
• 吴家志 (@chiachih_wu)
– 奇虎 360&安全研究开发工程师
– Android/Linux 系统安全研究
– C0RE&Team&(c0reteam.org)&创始成员
CVE-2013-2094&(perf_swevent_init)
CVE-2013-2597&(acdb)
In&the&Summer&of&2013&…
CVE-2012-4220&(diag)
CVE-2012-6422&(ExynosAbuse)
Nothing&Beats&HTC&Desire&V&(t328w)!
CVE-2013-6123&(video100)
cvedetails.com
cvedetails.com
CVE-2009-2848
put_user(x,&addr)&on&ARM32
• “addr”&is&checked&by&Hardware&with&
STRT/STRBT/STRHT&Instructions
• When&CONFIG_CPU_USE_DOMAINS&is&not&set,&
put_user()&=&Arbitrary&Memory&Write
In&the&Spring&of&2014&…
What&if&I&do&“grep –r&__put_user *”&?
CAUTION:&__put_user.*()&=&Arbitrary&
Memory&Write
Timetable
Date
Event
put_user
of/
Upstream/
Kernel/
put_user
of Android/
Kernel
__put_user_*/
w/o/explicit/
address/
validations
2010-11-04 T&macro&and&CONFIG_CPU_USE_DOMAINS&is&
upstreamed&
Vulnerable Vulnerable Vulnerable
2012-01-25 T&macro&is&renamed&to&TUSER
Vulnerable Vulnerable Vulnerable
2012-09-09 !CONFIG_CPU_USE_DOMAINS&case&is&fixed
Vulnerable Vulnerable
2013-07
put_user&vulnerability&is&identified&by&us&
through&clone()
Vulnerable Vulnerable
2013-09-11 The&incomplete&patch&to&fix&__put_user_*&
vulnerability&is&upstreamed
Vulnerable Vulnerable
2013-11-14 Most&Android&OS&maintainers&start&merging&the&
patch&to&fix&!CONFIG_CPU_USE_DOMAINS&case&
(CAF&disclose&the&details&of&CVE-2013-6282)
Vulnerable
2016-7-31
__put_user_*&vulnerability&is&identified&by&us&
through&code/patches&auditing
Vulnerable
0-day
• We&identify&a&0-day&in&the&ARM/Linux&kernel&
(CVE-2016-3857)
(cont’d)
• Up&to&present&we&have&identified&that&two&
Google&Nexus&phones&are&vulnerable:&Nexus&4,&
and&Nexus&7&(2013&version)
• Besides,&the&Huawei&Honor&4X/6/6&Plus&series,&
Huawei&Ascend&Mate7&series,&and&some&other&
models&of&Huawei,&Lenovo,&Meizu,&OPPO,&
Samsung,&Sony,&Xiaomi devices&are&also&
vulnerable
(cont’d)
Vendor
Series
Model
Google
Nexus
Nexus&4&(“mako”),&Nexus&7&(“flo”)
Huawei
Ascend&Mate&7
MT7-CL00/TL00/TL10/UL00
Mate&1&/&2
MT1-T00&/&MT1-U06&/&MT2-C00&/&MT2-L01…
Honor&4X
CHE2-TL00&/&TL00M&&/&TL00H&/UL00
Honor&6
H60-L01/L02/L03/L11/L12/L21
Honor&6&Plus
PE-TL10/TL20/UL00
MediaPad
X1&7.0
Lenovo
A390t/A750e
Meizu
MX
M032
MX2
M040/045
MX3
M351/353/355/356
OPPO
Find&5
X909/X909T
Samsung
Galaxy&Trend
GT-S7568/SCH-I879
Galaxy&Trend&II
GT-S7572/GT-S7898/SCH-I739
Galaxy&Tab&3&7.0
SM-T211
Galaxy&Core
GT-I8262D
Sony
Xperia
LT26i/26ii/26w
Xiaomi
MI&2
2/2A/2C/2S/2SC
(cont’d)
• Now&we&have&a&arbitrary&mem r/w,&then?
• In&Linux&kernel,&most&user&operations&will&
direct&to&the&struct file_operations
(cont’d)
• There&are&several&targets&could&be&our&victim&
(i.e.,&every&user&can&open&and&operate&on&it)
– /dev/ptmx、/dev/binder、/dev/ashmem…
(cont’d)
• With&the&info&we&need,&we&can&modify&any&
member&in&the&fops,&and&trigger
– modify&.fsync in&ptmx_fops to&our&shell&code
– trigger&it&by&open&/dev/ptmx,&and&fsync(fd)
• fsync(fd)→do_fsync()→vfs_fsync()→vfs_fsync_range()
→file->f_op->fsync()…
(cont’d)
• To&sum&up,&if&we&want&to&root&a&phone
– A&vulnerability&to&modify&it to&shell&code&address
– Collect&symbol,&e.g.,&address&of&ptmx_fops
– Overwrite&your&target&function
– Trigger!
• So&I&have&to&collect&1000&phones’&symbol&if&I&
want&to&root&them?&Hmm…
– Time&is&money,&and&we&are&all&lazy&right?
(cont’d)
• With&info&leak,&we&may&be&able&to&write&a&
universal&exploit&without&any&symbol&
knowledge&(CVE-2016-3809)
– Refer&to&http://ppt.cc/yIzVS&for&more&detail
• Whenever&a&socket&is&opened&within&Android,&
it&is&tagged&using&a&netfilter driver&called&
"qtaguid"
(cont’d)
• It&also&exposes&a&control&interface,&let&user&
query&the&current&sockets&and&their&tags
• The&interface&is&a world-accessible file,&
under /proc/net/xt_qtaguid/ctrl
(cont’d)
• Reading&this&file&reveals&the&kernel&virtual&
address&for&each&of&the&sockets
(cont’d)
• So&what&is&this&sock=xxxxxxxxactually?
– Every&open&socket&is&a&struct socket&in&kernel
– Every&socket&has&a&struct sock,&the&network&layer&
representation
(cont’d)
(cont’d)
(cont’d)
• To&sum&up,&with&info&leak&we&can
– Find&sock&address
– Use&vulnerability&to&overwrite&its&proto,&let&it&point&
to&your&fake&struct proto
– Trigger!
/proc/net/xt_qtaguid/ctrl
listed&sock&address
struct sock
struct sock_common {
…
…
struct proto&*skc_prot
fake&struct proto
Fake&function&pointer
Fake&function&pointer
Fake&function&pointer
…
Over&write&proto&
address
Trigger!
(cont’d)
• On&some&ARM32&and&all&ARM64&phones,&PxN
is&enabled
– No&user&mode&shell&code
– But&it’s&legal&if&control&flow&is&still&in&kernel&space&
(ROP)
– Say&if&we&call&a&function&with&at&least&4&parameters
(cont’d)
• In&addition&to&CVE-2016-3857,&we&also&identify&
a&similar&problem&in&Qualcomm’s&debug&
module&named&“msm-buspm”.&This&finding&
had&been&confirmed&as&CVE-2016-2441
• The&debug&module&exports&a&device&node,&
“/dev/msm-buspm-dev”.&Fortunately,&not&
every&user&can&open&/&operate&on&it
(cont’d)
Conclusion
• We&can&always&get&into&the&old&fixes&and&dig&
new&things&out&since&those&fixes&are&written&by&
human&beings&and&they&may&err&as&well
• copy_from_user /&copy_to_user
– __copy_from_user /&__copy_to_user
– __copy_from_user_inatomic/&
__copy_to_user_inatomic
– Maybe&more?
Q&&&A
Edward&Lo&
Chiachih Wu&