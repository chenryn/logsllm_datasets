## 使用DuckDB分析高中生联考成绩excel(xlst)数据, 文理选课分析           
### 作者                                                                                      
digoal                                                                                      
### 日期                                                                                      
2022-06-24                                                                           
### 标签                                                                                      
PostgreSQL , PolarDB , duckdb                                                                   
----                                                                        
## 背景      
高中生家长经常要看学校发的联考数据, 通过数据分析高二开始选什么副科.  联考数据量较大, 参考人数几万, 用excel分析有点吃力. 正好duckdb支持了excel读写能力, 可以导入到duckdb进行分析.   
当然了posgresql和polardb for postgresql 通过`gdal/ogr`插件也可以访问`excel`的数据.    
- https://wiki.postgresql.org/wiki/Foreign_data_wrappers    
- https://github.com/pramsey/pgsql-ogr-fdw    
## 例子  
下面演示duckdb读取xlst.  
https://duckdb.org/docs/guides/import/excel_import  
环境:  
- [《老机器上安装ubuntu 11, 使用lvm, 测试postgresql 16 & duckdb 0.8.1》](../202306/20230622_01.md)    
1、加载spatial插件, 这个插件使用GDAL库解析xlsx内容.    
```  
D install spatial;   
D load spatial;   
D .mode line  
```  
查看st_read函数定义  
```  
D select * from duckdb_functions() where function_name like '%st_read%';  
   database_name = system  
     schema_name = main  
   function_name = st_read  
   function_type = table  
     description =   
     return_type =   
      parameters = [col0, max_batch_size, sequential_layer_scan, layer, sibling_files, spatial_filter, spatial_filter_box, allowed_drivers, open_options]  
 parameter_types = [VARCHAR, INTEGER, BOOLEAN, VARCHAR, VARCHAR[], WKB_BLOB, BOX_2D, VARCHAR[], VARCHAR[]]  
         varargs =   
macro_definition =   
has_side_effects =   
        internal = true  
    function_oid = 1473  
         example =   
```  
查询xlst的方法比较简单, 如下:  
```  
D .mode duckbox  
D .maxrows 100  
D .maxwidth -1  
D SELECT * FROM st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1') limit 10;  
┌─────────┬──────────┬────────────┬─────────┬────────────────────┬────────┬──────────┬──────────┬──────────┬──────────┬──────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│  姓名   │ 准考证号 │ 自定义考号 │  班级   │        学校        │  总分  │ 总分排名 │ 侧理总分 │ 侧理排名 │ 侧文总分 │ 侧文排名 │  语文  │  数学  │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ varchar │ varchar  │  varchar   │ varchar │      varchar       │ double │  int32   │  double  │  int32   │  double  │  int32   │ double │ double │ double │ double │ double │ double │ double │ double │ double │  
├─────────┼──────────┼────────────┼─────────┼────────────────────┼────────┼──────────┼──────────┼──────────┼──────────┼──────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│ xxx  │ xxx │ xxx │ 2502班  │ 浙江省萧山中学     │  937.5 │        1 │    575.0 │       19 │    547.5 │       25 │  108.0 │  137.5 │  132.5 │   98.0 │   99.0 │   99.0 │   84.0 │   85.5 │   94.0 │  
│ xxx    │ xxx │ xxx │ 9班     │ 杭州市余杭高级中学 │  934.5 │        2 │    587.5 │        1 │    568.5 │        2 │  111.0 │  144.0 │  138.5 │   98.0 │   96.0 │   99.0 │   85.0 │   90.0 │   73.0 │  
│ xxx  │ xxx │ xxx │ 2502班  │ 浙江省萧山中学     │  929.5 │        3 │    572.5 │       28 │    547.0 │       26 │  113.0 │  123.5 │  138.5 │   98.0 │   99.5 │  100.0 │   86.0 │   86.0 │   85.0 │  
│ xxx  │ xxx │ xxx │ 2501班  │ 浙江省萧山中学     │  928.5 │        4 │    580.5 │        7 │    561.0 │        5 │  118.0 │  135.5 │  139.5 │   97.0 │   90.5 │  100.0 │   83.0 │   85.0 │   80.0 │  
│ xxx  │ xxx │ xxx │ 2505班  │ 浙江省萧山中学     │  926.0 │        5 │    572.5 │       28 │    545.0 │       31 │  109.0 │  132.0 │  136.5 │   96.0 │   99.0 │   94.0 │   89.0 │   78.5 │   92.0 │  
│ xxx  │ xxx │ xxx │ 2502班  │ 浙江省萧山中学     │  925.5 │        6 │    571.5 │       32 │    551.0 │       16 │  111.0 │  134.0 │  132.0 │   94.5 │  100.0 │   94.0 │   85.5 │   88.5 │   86.0 │  
│ xxx  │ xxx │ xxx │ 1班     │ 桐庐中学           │  923.0 │        7 │    573.0 │       25 │    562.0 │        4 │  113.0 │  144.0 │  124.0 │   99.0 │   93.0 │   93.0 │   89.0 │   92.0 │   76.0 │  
│ xxx  │ xxx │ xxx │ 5班     │ 杭州市余杭高级中学 │ 922.25 │        8 │    574.5 │       21 │   551.25 │       15 │  107.0 │  135.0 │  138.0 │   97.5 │   97.0 │   97.5 │  83.75 │   87.5 │   79.0 │  
│ xxx  │ xxx │ xxx │ 12班    │ 杭州市余杭高级中学 │ 922.25 │        8 │    564.5 │       60 │   571.25 │        1 │  115.0 │  138.0 │  140.5 │   80.0 │   91.0 │   92.0 │  90.75 │   87.0 │   88.0 │  
│ xxx  │ xxx │ xxx │ 2505班  │ 浙江省萧山中学     │ 922.25 │        8 │    562.5 │       74 │   542.25 │       48 │  109.5 │  126.5 │  130.0 │   98.0 │   98.5 │   96.5 │  85.75 │   90.5 │   87.0 │  
├─────────┴──────────┴────────────┴─────────┴────────────────────┴────────┴──────────┴──────────┴──────────┴──────────┴──────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 10 rows                                                                                                                                                                                              20 columns │  
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
```  
D .maxwidth 0  
D SELECT * FROM st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1') limit 10;  
┌─────────┬──────────┬────────────┬─────────┬────────────────────┬────────┬──────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│  姓名   │ 准考证号 │ 自定义考号 │  班级   │        学校        │  总分  │ 总分排名 │ … │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ varchar │ varchar  │  varchar   │ varchar │      varchar       │ double │  int32   │   │ double │ double │ double │ double │ double │ double │ double │  
├─────────┼──────────┼────────────┼─────────┼────────────────────┼────────┼──────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│ xxx  │ xxx   |   xxx  │ 2502班  │ 浙江省萧山中学     │  937.5 │        1 │ … │  132.5 │   98.0 │   99.0 │   99.0 │   84.0 │   85.5 │   94.0 │  
│ xxx  │ xxx   |   xxx  │ 9班     │ 杭州市余杭高级中学 │  934.5 │        2 │ … │  138.5 │   98.0 │   96.0 │   99.0 │   85.0 │   90.0 │   73.0 │  
│ xxx  │ xxx   |   xxx  │ 2502班  │ 浙江省萧山中学     │  929.5 │        3 │ … │  138.5 │   98.0 │   99.5 │  100.0 │   86.0 │   86.0 │   85.0 │  
│ xxx  │ xxx   |   xxx  │ 2501班  │ 浙江省萧山中学     │  928.5 │        4 │ … │  139.5 │   97.0 │   90.5 │  100.0 │   83.0 │   85.0 │   80.0 │  
│ xxx  │ xxx   |   xxx  │ 2505班  │ 浙江省萧山中学     │  926.0 │        5 │ … │  136.5 │   96.0 │   99.0 │   94.0 │   89.0 │   78.5 │   92.0 │  