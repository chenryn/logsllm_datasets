192.168.1.196
Status:Complete
图4-17我们的Nessus扫描报告摘要
提示：请注意由于这次扫描使用了Windows登录凭据的授权扫描，Nessus在本次扫描中
发现的漏洞数量会比非授权扫描多得多。
4.3.5将扫描结果导入Metasploit框架中
现在让我们把扫描结果导入Metasploit框架中。
（1）在Reports页面中点击DowloadReport（下载报告）按钮，将扫描结果保存到你的硬
盘中。Nessus默认的报告文件格式.nessus可以被Metasploit解析，提示我们选择文件格式时，
选择默认的格式即可。
（2）打开MSF终端，使用db_connect创建-个新数据库，然后使用db_import，并在命令
后面加上导出的报告文件名，将扫描结果导入到数据库中。
msf>db_connectpostgres:toor@127.0.0.1/msf3
msf > db_import /tmp/nessus_report_Host_195.nessus
[*]Importing‘Nessus XML(v2)'data
[*]Importing host 192.168.1.195
（3）为了验证扫描的主机和漏洞数据是否正确导入，可以如下所示输入db_hosts命令。这
里的db_host命令会输出一个简要列表，里面包含了目标的IP地址、探测到的服务数量以及
Nessus在目标上发现的漏洞数量。
msf > db_hosts -c address,svcs,vulns
Hosts
address
SVCSvulns
192.168.1.195
18
345
48
---
## Page 76
第4章漏洞扫描
（4）如果想显示一个详细的漏洞列表，可以输入不包含任何参数的db_vulns命令，如下
所示：
msf>db_vulns
[*] Time:Wed Mar 09 03:40:10 UTC 2011 Vuln:host=192.168.1.195
name=NSS-10916refs=0SVDB-755
[*] Time:Wed Mar 09 03:40:10 UTC 2011 Vuln: host=192.168.1.195
name=NSS-10915 refs=0SVDB-754
[*]Time:Wed Mar 09 03:40:11 UTC2011Vuln:host=192.168.1.195
name=NSS-10913refs=0SVDB-752
[*] Time:Wed Mar 09 03:40:12UTC 2011 Vuln:host=192.168.1.195
name=NSS-10114 refs=CVE-1999-0524,0SVDB-94,CWE-200
[*]Time:Wed Mar 09 03:40:13 UTC 2011Vuln:host=192.168.1.195
name=NSS-11197 refs=CVE-2003-0001,BID-6535
在渗透测试工作末期为你的客户撰写渗透测试报告时，这些参考数据非常有价值。
4.3.6在Metasploit内部使用Nessus进行扫描
如果你不愿离开舒适的命令行环境，你可以使用Zate写的Nessus 桥插件（NessusBridge
plug-in：http://blog.zate.org/nessus-plugin-dev/)，在Metasploit 内部使用Nessus。Nessus 桥插件
允许你通过Metasploit框架对Nessus进行完全的控制，比如你可以使用它运行扫描、分析结果，
甚至可以使用它通过Nessus扫描所发现的漏洞发起渗透攻击。
（1）同前面的例子一样，首先使用db_destroy命令删除现有的数据库，并使用db_connect
创建一个新数据库。
（2）执行load nessus 命令载入Nessus 插件，如下所示：
msf > db_destroy postgres:toor@127.0.0.1/msf3
[*] warning: You will need to enter the password at the prompts below
Password:
msf > db_connect postgres:toor@127.0.0.1/msf3
msf>loadnessus
[*]Nessus Bridge for Metasploit 1.1
[+]Type nessus_help for a command listing
[+] Exploit Index -(/root/.msf3/nessus_index) - is valid.
[*]Successfully loaded plugin:Nessus
（3）可以使用nessus_help来查看Nessus 桥插件支持的所有命令。Nessus 桥插件经常会有
一些改进和更新，所以定期检查nessus_help的输出是个好主意，这样我们就能得知是否又添加
了新的功能。
49
---
## Page 77
Metasploit渗透测试指南
（4）使用Nessus桥插件开始一次扫描之前，你必须使用nessus_connenct命令登录到你
的Nessus服务器上，如下所示：
msf>nessus_connectdookie:PI:EMAIL:8834ok
[*] Connecting to https://192.168.1.101:8834/ as dookie
[*]Authenticated
（5）同使用图形界面一样，启动扫描时需要指定一个已经定义的扫描策略的ID号。可以使
用nessus_policy_list列出服务器上所有已经定义的扫描策略。
msf > nessus_policy_list
[+] Nessus Policy List
ID
Name
Comments
-4
Internal Network Scan
-3
Web App Tests
-2
Prepare for PCI DSS audits
-1
External Network Scan
The_works
（6）留意想在扫描中使用的扫描策略的ID号，然后输入nessus_scan_new命令，并在后
面加上扫描策略的ID号、扫描任务的名字以及目标IP地址，如下所示：
msf > nessus_scan_new
[*]Usage:
[*]
nessus_scan_new
[*]
use nessus_policy_list to list all available policies
msf > nessus_scan_new 2 bridge_scan 192.168.1.195
[*] Creating scan from policy number 2, called "bridge_scan" and scanning 192.168.1.195
[*]Scan started.uid is d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e
（7）扫描开始后，可以使用nessus_scan_status命令查看扫描运行的状态。当这个命令返
msf> nessus_scan_status
[*]No Scans Running.
（8）扫描结束后，可以使用nessus_report_list命令列出Nessus中所有的可用扫描报告。
识别出所需报告的ID号，然后输入 nessus_report_get 报告ID 命令下载报告，并自动将报告
导入到Metasploit数据库中。
msf > nessus_report_list
[+] Nessus Report List
50
---
## Page 78
第4章漏洞扫描
ID
Name
StatusDate
074dc984-05f1-57b1-foc9-2bb80ada82fd3758887a05631c1d Host_195completed 19:43 Mar 08 2011
d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81ebridge_scancompleted09:37Mar 092011
[*]Youcan:
[*] Get a list of hosts from the report:nessus_report_hosts
msf>nessus_report_get d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e
[*]importing d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e
[*]192.168.1.195 Microsoft Windows XP Professional (English) Done!
[+]Done
（9）最后，如同本章中其他导入数据的例子一样，你可以使用db_hosts命令，确认扫描数
据已被正确导入到数据库中。
msf > db_hosts -c address,svcs,vulns
Hosts
address
svCs vulns
 === =
192.168.1.19518345
现在你已经看到了两种不同漏洞扫描产品得到扫描结果的差异，此时你应当对综合使用多
个工具进行扫描的优点有了更深刻的理解。不过，对这些自动化工具的扫描结果进行分析，并
将它们转化为可操作的数据，这还得由渗透测试者们来完成。
4.4专用漏洞扫描器
虽然市面上有很多商业的漏洞扫描产品，但你的选择并不仅限于它们。当你想要在一个网
络上查找某个特定的漏洞时，Metasploit自带的许多辅助模块可以帮助你完成这样的任务。
下面例子中介绍的几个Metasploit模块只是众多实用辅助模块中很小的一部分。你应当在模
拟实验环境中尽可能多地对这些模块的使用方法进行摸索，这对实际渗透测试工作将非常有利。
4.4.1验证SMB登录
如你所料，这种扫描动静很大，容易被察觉，而且每一次登录尝试都会在被扫描的Windows主
机系统日志中留下痕迹。
使用use命令选择了smb_login模块后，你可以运行show_options命令查看参数列表，以
及哪些参数是必需的。Metasploit允许你指定用户名和口令的组合、用户名列表和口令列表的组
合，或前两者中各要素的组合（用户名加口令列表，或用户名列表加口令）。在下面的例子中，
我们将RHOST参数设置为一小段IP地址，然后使用一个固定的用户名和口令，让Metasploit
对范围内所有主机进行登录尝试。
51
---
## Page 79
Metasploit渗透测试指南
msf>use auxiliary/scanner/smb/smb_login
msf auxiliary(smb_login) > show options
Module options:
Name
Current Setting Required
1Description
PASS_FILE
no
File containing passwords, one per line
RHOSTS
yes
The target address range or CIDR identifier
RPORT
445
yes
Set the SMB service port
SMBDomain
WORKGROUP
no
SMB Domain
SMBPaSS
pIoMssed
no
SMB Password
SMBUser
Administrator
no
SMB Username
THREADS
50
yes
The number of concurrent threads
USERPASS_FILE
no
File containing users and passwords separated
by space, one pair per line
USER_FILE
no
File containing usernames, one per line
msf auxiliary(smb_login)>set RH0STS 192.168.1.150-155
RHOSTS => 192.168.1.170-192.168.1.175
msf auxiliary(smb_login)> set SMBUser Administrator
SMBUser => Administrator
msf auxiliary(smb_login)> set SMBPass s3cr3t
SMBPaSS => S3Cr3t
msf auxiliary(smb_login)>run
[*]Starting host 192.168.1.154
[*]Starting host 192.168.1.150
[*]Starting host 192.168.1.152
[*]Starting host 192.168.1.151
[*] Starting host 192.168.1.153
[*]Starting host 192.168.1.155
O[+] 192.168.1.155- SUCCESSFUL LOGIN (Windows 5.1)'Administrator′:'s3cr3t'
[*] Scanned 4 of 6 hosts (066% complete)
[*] Scanned 5 of 6 hosts (083% complete)
[*] Scanned 6 of 6 hosts (100% complete)
[*]Auxiliary module execution completed
msf auxiliary(smb_login) >
在0处你可以看到使用用户名Administrator和口令s3cr3t成功地登录到了一台主机上。在
很多公司里，工作站计算机的操作系统通常都是由同一个镜像克隆安装的，在这些克隆的系统
上，管理员口令很有可能是一样的，获取了一个口令后，你就有可能拥有对所有工作站计算机
的访问权限。
4.4.2扫描开放的VNC空口令
VNC（虚拟网络计算）提供了图形化的远程系统访问方式，它的实现类似于微软的远程桌
面。在很多公司里VNC的安装很常见，因为它提供了远程访问服务器和工作站图形桌面的途
径，使用非常方便。很多时候VNC是为了解决某些问题临时安装的，但使用完后管理员却经
常忘记把它删除，从而留下未打补丁的VNC服务，这成为一个严重的潜在漏洞。Metasploit
52
---
## Page 80
第4章漏洞扫描
内置的VNC空口令扫描器可以对一段IP地址进行扫描，在其中搜索未设置口令的VNC服务
器。虽然通常情况下扫描会一无所获，但是一个优秀的渗透测试师对目标系统攻击时会千方百
计使用一切手段。
提示：最新版本的VNC服务器不再允许使用空口令。如果想在你的测试环境中搭建一
个上述的环境，可以使用较旧版本的VNC服务器，如RealVNC4.1.1。
像大多数Metasploit辅助模块一样，VNC扫描器的配置和运行很简单。vnc_none_auth命
令所需的唯一参数是待扫描的一个或一段IP地址。只需选择使用该模块，定义你的RHOST（远
程主机）和THREAD（线程数，如果你希望修改默认值的话可以对它进行设置），然后执行模
块，如下所示：
msf > use auxiliary/scanner/vnc/vnc_none_auth
msf auxiliary(vnc_none_auth)> show options
Module options:
Name
Current Setting RequiredDescription
RHOSTS
yes
Thetarget address range or CIDRidentifier
RPORT
5900
yes
The target port
THREADS1
yes
The number of concurrent threads
msf auxiliary(vnc_none_auth) > set RHoSTS 192.168.1.155
RHOSTS => 192.168.1.155
msf auxiliary(vnc_none_auth)>run
[*]192.168.1.155:5900,VNC server protocolversion:RFB 003.008
[*]192.168.1.155:5900,VNC server security types supported:None
O [*] 192.168.1.155:5900, VNC server security types includes None, free access!
[*]Scanned 1 of 1 hosts(1o0%complete)
[*]Auxiliary moduleexecutioncompleted
msf auxiliary(vnc_none_auth)>
如果你足够幸运的话，Metasploit可能会为你找到一台没有口令的VNC服务器·，这时你可
以使用BackTrack的vncviewer，连接到目标主机上未设置口令的VNC服务器，如图4-18所示。
t:#ncviewer192.168.1.155
BTaueuineo
TightVNC:V-XPSP2-BARE
Authenticatiol