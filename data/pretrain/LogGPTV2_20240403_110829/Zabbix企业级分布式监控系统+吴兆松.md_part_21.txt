Zabbix企业级分布式监控系统
to=$1
subject=$2
body=$3
cat"
msg =MIMEText(content)
msg['Subject'] = subject
msg['From']=me
msg['to']=mail_to
global sendstatus
global senderr
try:
smtp = Smtplib.SMTP()
165
---
## Page 182
Zabbix企业级分布式监控系统
smtp.connect(mail_host)
smtp.login(mail_user,mail_pass)
smtp.sendmail(me,mail_to,msg.as_string())
smtp.close()
print 'send ok'
sendstatus = True
except Exception,e:
senderr=str(e)
print senderr
sendstatus = False
def logwrite(sendstatus,mail_to,content):
logpath='/var/log/zabbix/alert'
if not sendstatus:
content = senderr
if not os.path.isdir(logpath):
os.makedirs (logpath)
t=datetime.datetime.now()
daytime=t.strftime('%Y-%m-%d')
daylogfile=logpath+'/'+str(daytime) +'.log'
logging.basicConfig(filename=daylogfile,level=logging.DEBUG)
logging.info('*'*130)
logging.debug(str(t)+' mail send to (0},content is :\n {1}'.fo
rmat(mail_to,content) )
if
name_== "main_":
r for zabbix alerting')
parser.add_argument('mail_to',action="store", help='The addre
ss of the E-mail that send to user ')
parser.add_argument('subject',action="store", help='The subje
ct of the E-mail')
parser.add argument('content',action="store", help='The conte
nt of the E-mail')
mail_to=args.mail_to
subject=args.subject
content=args.content
send_mail (mail_to, subject,content)
logwrite(sendstatus,mail_to,content)
注意：上面的这个脚本文件需要Zabbix用户具有执行权限，以确保脚本能正
常运行。下面对脚本文件进行权限改变。
shell# chmod 700 /etc/zabbix/alertscripts/zabbix_sendmail.py
shell# chown zabbix.zabbix /etc/zabbix/alertscripts/zabbix_sendmail.py
如果是RHEL6.4以上版本的系统，会缺少python-argparse模块，请安装
python-argparse，软件包在本书的github中，网址为：
166
---
## Page 183
第6章告警配置
https://github.com/itnihao/zabbix-book/tree/master/06-chapter
shell# rpm -ivh python-argparse-1.2.1-2.el6.noarch.rpm
shell# python /etc/zabbix/alertscripts/zabbix_sendmail.py info@it
nihao.com
.test"test to send mail
如果PI:EMAIL能收到邮件，说明脚本发送邮件成功，否则，说明配
置存在错误，或者邮箱不支持此种邮件发送类型。
上面这个脚本的特点是将发送的所有信息都以日志方式保存，即按天存储，
这样可以很方便地知道告警消息是否发送成功。
对于前面所提到的，一个机房由于网络抖动，而引起的大规模误报，其处理
思路除了设置复杂依赖关系的触发器，还可以在告警脚本中进行改良，例如，对
上面脚本的告警主题和告警内容进行条件判断，对重复发送的消息进行隔离或丢
弃，或者将告警结果发送给第三方告警分析系统，从而起到告警汇集的作用，有
效地减少误报。
2.重启Zabbix-Server服务
修改完配置文件后，需要重启Zabbix-Server服务，语句如下：
shell# service zabbix-server restart
3.WebGUI配置自定义脚本的步骤
配置步骤为：单击 Configuration→Media types→Create media type，出现的界
面如图6-34所示。
CONFIGURATION OFMEDIA TYPES
Namezabbix sendmai
Type
Script
Script namezabbix_sendmail.py
Enabled
Save
DeleteCancel
图6-34
添加触发设置：单击Configuration→Actions→Create action，如图6-35所示。
添加告警发送的条件，如图6-36所示。
选择告警的条件，读者可根据需要选择多种方式的告警条件，如图6-37所示。
选择发送的媒介为脚本，选择发送用户。发送告警的用户必须对告警信息所
在的机器有读取权限，否则，告警信息无法正常发送。
167
---
## Page 184
Zabbix企业级分布式监控系统
Operations
Name
Reportproblems to Zabbixadministrators
Default subject
(TRIGGER.STATUS):{TRIGGER.NAME)
Item values:
Recovery message
Recovery subject(TRIGGER.STATUS):(TRIGGER.NAME)
TerTNGERNGRSANS
Recoverymessage
Item values:
Enabled
Sav
Delete
Cancel
图6-35
Action
Conditions
Operations
Type of calculation AND /OR(A) and (B) and (C)
ConditionsLabel Name
Action
(A)
Maintenance statusnot inmaintenance
Remove.
(B)
Trigger value=PROBLEM
Remove,
(C)
Tngger severity=Disaster
Remove
New condition
Triagerseverity
=Not classified
Add
Save
Clone
Delete
Cancel
图6-36
ActionConditi
Defaultoperation step duration
3600（minimum60 seconds)
Action operations
Steps Details
Startin
Sendmessagetousergroups:Zabbixadministratorsviaall
media
Immedia
Operation details
Step
From
1(0-infinitely)
Step duration
Operationtype
Sendmessaae
Send to User groups
Usergroup
Action
inistrators
Remove
Add
Send to Users
User
Action
Admin (Zabbx
Administrator)
Add
Send onlyto
zabbix sendmail
Default message
Conditions
Label
Name
Action
New.
Update Cancel
Save|CtoneDeleteCancel
图6-37
168
---
## Page 185
第6章
告警配置
4.配置用户的邮件发送
步骤为：单击Administration→Users→Username→Media，如图6-38所示。
DHLA
iatypesScrip
my-zabbix-
UserMediaPermissions
zabbix-gui.itnihao.com
oup_media.php?dstfrm
Media
Send
Save
Whenactive
1-7,00:00-24:00
Notclassified
Information
Warning
Average
High
Disaster
Status
Enabled
SaveCancel
图6-38
图6-38中，各项的含义如下。
·Type：选择以哪种方式发送告警。
·Send to：收件人。
·Whenactive：消息发送的时间段。
·Use if severity：消息发送级别。
·Status：开关。
5.查看邮件发送状态
单击Administration→Audit→Actions，可以查看告警信息的发送状态，如图
6-39所示的状态为正在发送告警信息。
Time
Type
StatusRetries left Recipient(s)
Message
09Mar 201409:57:51zabbix_sendmail sent
PI:EMAIL Subject:
PROBLEM:Number of logged in users gt 2
图6-39
告警升级的机制
6.7
告警升级可以对告警结果按自定义的时间段进行消息发送，并执行命令，形
成一个梯度的告警处理。
在Action中配置的步骤如图6-40所示。
在发送的消息中添加事件发生的时间戳和发送时间，便于了解事件发生的时
间，语句如下。
169
---
## Page 186
Zabbix企业级分布式监控系统
Trigger Date:(EVENT.DATE) (EVENT.TIME)
SendTime:(TIME)
CONFIGURATTON OFACTIONS
ActionConditionsOperations
NameEscalations
Default subject(TRIGGER.STATUS}:{TRIGGER.NAME)
r(TRGERNGRSTAUS
Defaultmessage
SARUGGETRNGG
mee.
Recovery message
Recovery Subject(TRIGGER.STATUS):（TRIGGER.NAME）
Recovery message
Trigger:（TRIGGER.NAME)
Enabled
图6-40
示例1：告警升级的配置如图6-41所示。
Action ConditionsOperations
Default operation step duration
120 （minimum60 seconds)
Action operations
Steps Detais
Start in
Duration(sec）Action
1-2
Immediately60
Edt Remove
3-5
Send
ndmail00:02:00
60
Edit Remdve
6 -7
Send
rator)vazabbix_sendmail
00:05:00
Default
Edt Remove
New
图6-41
告警信息将分为三个等级梯度发送，如图6-42所示。
●第一梯度：1、2步，发送给Admin用户，间隔时间为60s，发送两次，直
到故障恢复。
●第二梯度：3、5步，发送给web1Song用户，间隔时间为60s，发送3次，
直到故障恢复。
●第三梯度：6、7步，发送给Admin用户，间隔时间为120s，即默认的间
隔时间，发送两次，直到故障恢复。
120(minimum 60 seconds)
5Steps Details
Startin
Duration(sec)
1-2Sendmessage to users:Admin(Zabbix Administrator) viazabbix_sendmail
Immediately60
60
6-7
Send message to users:Admin (Zabbix Administrator) via zabbix_sendmail oo:05:00
Default
New
图6-42
用户收到的告警信息时间如表6-8所示。
170
---
## Page 187
第6章
告警配置
表6-8
用户（steps）
事件接收时间为
时间间隔
TriggerDate:2014.03.0915:53:54
Admin
Send time:15:53:56
60s，用户自定义的时间间隔
(1、2)
Trigger Date:2014.03.09 15:53:54
Send time:15:54:56
Trigger Date: 2014.03.09 15:53:54
Send time: 15:55:56
web1 Song
Trigger Date: 2014.03.09 15:53:54
60s，用户自定义的时间间隔
(3~5)
Send time:15:56:56
Trigger Date: 2014.03.09 15:53:54
Send time:15:57:56
Trigger Date: 2014.03.09 15:53:54
Admin
Send Time:15:58:56
120s，使用默认的时间间隔
（6、7)
Trigger Date:2014.03.09 15:53:54
SendTime:16:00:56
示例2：告警升级的配置如图6-43所示。
120（minimum60 seconds)
Steps Details
Start in
Duration(sec)
1-0Send message to users:Admin(ZabbixAdministrator)viazabbix_sendmail
Immediately 60
5-7
06
New
图6-43
在图6-43中，用户Admin每隔60s发送一次告警信息，直到事件状态变成OK
为止。用户web1Song在故障4分钟后，每隔90s发送一次告警信息，共计发送3次。
示例3：告警升级的配置如图6-44所示。
Acuor
Condiions:
Operations
Detautoperationstepduraton
1800(minimum60 seconds)
Action operations
Steps Details
Start in
Duration (sec) Action
1-0
Sendmessage to user groups:MySQLAdministratorsviaEmal