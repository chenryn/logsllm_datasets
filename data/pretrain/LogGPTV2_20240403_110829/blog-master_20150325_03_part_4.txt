received chunk for file "pg_log/postgresql-2013-08-05_112902.csv", off 0, len 2009  
received chunk for file "pg_log/postgresql-2013-08-05_134523.csv", off 0, len 12060  
received chunk for file "pg_log/postgresql-2013-08-05_104358.csv", off 0, len 61220  
received chunk for file "pg_log/postgresql-2013-08-05_130021.csv", off 0, len 13541  
received chunk for file "pg_log/postgresql-2013-08-05_104358.log", off 0, len 7125  
received chunk for file "pg_log/postgresql-2013-08-05_101818.csv", off 0, len 2719  
received chunk for file "pg_log/postgresql-2013-08-05_113036.csv", off 0, len 15990  
received chunk for file "pg_log/postgresql-2013-08-05_123855.csv", off 0, len 36541  
received chunk for file "pg_log/postgresql-2013-08-05_131316.csv", off 0, len 3686  
received chunk for file "pg_log/postgresql-2013-08-05_134444.csv", off 0, len 968  
received chunk for file "pg_subtrans/0047", off 0, len 114688  
received chunk for file "pg_notify/0000", off 0, len 8192  
received chunk for file "global/12696_vm", off 0, len 8192  
received chunk for file "global/12700_vm", off 0, len 8192  
received chunk for file "global/12707_fsm", off 0, len 24576  
received chunk for file "global/12557_fsm", off 0, len 24576  
received chunk for file "global/pg_internal.init", off 0, len 12784  
received chunk for file "global/12700_fsm", off 0, len 24576  
received chunk for file "global/pg_control", off 0, len 8192  
received chunk for file "global/12711_fsm", off 0, len 24576  
received chunk for file "global/12696_fsm", off 0, len 24576  
received chunk for file "global/12557_vm", off 0, len 8192  
received chunk for file "global/pg_filenode.map", off 0, len 512  
received chunk for file "global/12707_vm", off 0, len 8192  
received chunk for file "global/12711_vm", off 0, len 8192  
received chunk for file "pg_xlog/00000008.history", off 0, len 299  
received chunk for file "pg_xlog/0000000B0000000100000006", off 0, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 1000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 2000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 3000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 4000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 5000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 6000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 7000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 8000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 9000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 10000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 11000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 12000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 13000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 14000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 15000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000006", off 16000000, len 777216  
received chunk for file "pg_xlog/00000009.history", off 0, len 334  
received chunk for file "pg_xlog/0000000A.history", off 0, len 376  
received chunk for file "pg_xlog/0000000B0000000100000005", off 0, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 1000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 2000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 3000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 4000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 5000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 6000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 7000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 8000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 9000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 10000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 11000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 12000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 13000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 14000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 15000000, len 1000000  
received chunk for file "pg_xlog/0000000B0000000100000005", off 16000000, len 777216  
received chunk for file "pg_xlog/0000000A0000000100000005", off 0, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 1000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 2000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 3000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 4000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 5000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 6000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 7000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 8000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 9000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 10000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 11000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 12000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 13000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 14000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 15000000, len 1000000  
received chunk for file "pg_xlog/0000000A0000000100000005", off 16000000, len 777216  
received chunk for file "pg_xlog/0000000B.history", off 0, len 419  
received chunk for file "pg_clog/0001", off 0, len 262144  
received chunk for file "pg_clog/0000", off 0, len 262144  
received chunk for file "pg_clog/0002", off 0, len 262144  
received chunk for file "pg_clog/0003", off 0, len 262144  
received chunk for file "pg_clog/0004", off 0, len 122880  
received chunk for file "pg_stat_tmp/db_16384.stat", off 0, len 3216  
received chunk for file "pg_stat_tmp/global.stat", off 0, len 471  
received chunk for file "pg_stat_tmp/db_0.stat", off 0, len 1188  
received chunk for file "pg_multixact/members/0000", off 0, len 8192  
received chunk for file "pg_multixact/offsets/0000", off 0, len 8192  
received chunk for file "base/12814/12641_vm", off 0, len 8192  
received chunk for file "base/12814/12639_fsm", off 0, len 24576  
received chunk for file "base/12814/12547_fsm", off 0, len 24576  
received chunk for file "base/12814/12620_fsm", off 0, len 24576  
received chunk for file "base/12814/12549_fsm", off 0, len 24576  
................省略  
received chunk for file "base/12809/12576_fsm", off 0, len 24576  
received chunk for file "base/12809/12789_vm", off 0, len 8192  
received chunk for file "base/12809/12736_fsm", off 0, len 24576  
received chunk for file "base/12809/12664_vm", off 0, len 8192  
Done!  
```  
启动数据库, 无法启动 :   
```  
2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,1,,2013-08-05 13:52:04 CST,,0,LOG,00000,"database system was interrupted; last known up at 2013-08-05 13:47:00 CST",,,,,,,,"StartupXLOG, xlog.c:4915",""  
2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,2,,2013-08-05 13:52:04 CST,,0,LOG,00000,"entering standby mode",,,,,,,,"StartupXLOG, xlog.c:4968",""  
2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,3,,2013-08-05 13:52:04 CST,,0,LOG,00000,"invalid checkpoint link in backup_label file",,,,,,,,"ReadCheckpointRecord, xlog.c:6364",""  
2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,4,,2013-08-05 13:52:04 CST,,0,FATAL,XX000,"could not locate required checkpoint record",,"If you are not restoring from a backup, try removing the file ""/pgdata/digoal/1921/data03/pg93/pg_root/backup_label"".",,,,,,"StartupXLOG, xlog.c:5047",""  
2013-08-05 13:52:04.425 CST,,,29310,,51ff3d84.727e,1,,2013-08-05 13:52:04 CST,,0,LOG,00000,"startup process (PID 29312) exited with exit code 1",,,,,,,,"LogChildExit, postmaster.c:3211",""  
2013-08-05 13:52:04.425 CST,,,29310,,51ff3d84.727e,2,,2013-08-05 13:52:04 CST,,0,LOG,00000,"aborting startup due to startup process failure",,,,,,,,"reaper, postmaster.c:2536",""  
```  
这个错误, 需要删除新的standby(老的primary)的backup_label文件.  
```  
rm -f $PGDATA/backup_label*  
```  
启动数据库, 无法启动 :   
```  
pg93@db-172-16-3-39-> cat postgresql-2013-08-05_135236.csv  
2013-08-05 13:52:36.846 CST,,,29333,,51ff3da4.7295,1,,2013-08-05 13:52:36 CST,,0,LOG,00000,"database system was interrupted; last known up at 2013-08-05 13:47:00 CST",,,,,,,,"StartupXLOG, xlog.c:4915",""  
2013-08-05 13:52:36.846 CST,,,29333,,51ff3da4.7295,2,,2013-08-05 13:52:36 CST,,0,LOG,00000,"entering standby mode",,,,,,,,"StartupXLOG, xlog.c:4968",""  
2013-08-05 13:52:36.846 CST,,,29333,,51ff3da4.7295,3,,2013-08-05 13:52:36 CST,,0,FATAL,XX000,"invalid data in history file: 1   0/92DCDD8   no recovery target specified  
",,"Timeline IDs must be in increasing sequence.",,,,,,"readTimeLineHistory, timeline.c:158",""  
2013-08-05 13:52:36.846 CST,,,29331,,51ff3da4.7293,1,,2013-08-05 13:52:36 CST,,0,LOG,00000,"startup process (PID 29333) exited with exit code 1",,,,,,,,"LogChildExit, postmaster.c:3211",""  
2013-08-05 13:52:36.846 CST,,,29331,,51ff3da4.7293,2,,2013-08-05 13:52:36 CST,,0,LOG,00000,"aborting startup due to startup process failure",,,,,,,,"reaper, postmaster.c:2536",""  
```  
因为前面修改了history文件, 改回来即可. (两台主机都需要修改, 以免后面再出问题)  
```  
pg93@db-172-16-3-33-> vi 0000000B.history   
pg93@db-172-16-3-39-> vi 0000000B.history   
1       0/92DCDD8       no recovery target specified  
2       0/1CB86338      no recovery target specified  
3       0/36E68A20      no recovery target specified  
4       0/569ADB88      no recovery target specified  
5       0/762CF5D8      no recovery target specified  
6       0/9F67C920      no recovery target specified  
7       0/A0000090      no recovery target specified  
8       1/3F535A0       no recovery target specified  
9       1/4000090       no recovery target specified  
10      1/6000000       no recovery target specified  
```  
启动数据库, 复制正常.  
## 其他问题  
1\. 还有可能遇到值溢出的问题.  
```  
pg_xlog/0000000B000000010000001E (REMOVE)  
unexpected result while sending file list: ERROR:  value "2148254528" is out of range for type integer  
CONTEXT:  COPY fetchchunks, line 28557, column begin: "2148254528"  
```  
来自以下函数 :   
```  
pg_rewind_master/libpq_fetch.c  
/*  
 * Fetch all changed blocks from remote source data directory.  
 */  
void  
libpq_executeFileMap(filemap_t *map)  
{  
        file_entry_t *entry;  
        const char *sql;  
        PGresult   *res;  
        /*  
         * First create a temporary table, and load it with the blocks that  
         * we need to fetch.  
         */  
        sql = "create temporary table fetchchunks(path text, begin int4, len int4);";  
        res = PQexec(conn, sql);  
        if (PQresultStatus(res) != PGRES_COMMAND_OK)  
        {  
                fprintf(stderr, "error creating temporary table: %s\n",  
                                PQresultErrorMessage(res));  
                exit(1);  
        }  
        sql = "copy fetchchunks from stdin";  
        res = PQexec(conn, sql);  
        if (PQresultStatus(res) != PGRES_COPY_IN)  
        {  
                fprintf(stderr, "unexpected result while sending file list: %s\n",  
                                PQresultErrorMessage(res));  
                exit(1);  
        }  
```  
## 参考  
1\. http://www.postgresql.org/message-id/flat/PI:EMAIL#PI:EMAIL  
2\. https://github.com/vmware/pg_rewind  
#### [PostgreSQL 许愿链接](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
您的愿望将传达给PG kernel hacker、数据库厂商等, 帮助提高数据库产品质量和功能, 说不定下一个PG版本就有您提出的功能点. 针对非常好的提议，奖励限量版PG文化衫、纪念品、贴纸、PG热门书籍等，奖品丰富，快来许愿。[开不开森](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216").  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")