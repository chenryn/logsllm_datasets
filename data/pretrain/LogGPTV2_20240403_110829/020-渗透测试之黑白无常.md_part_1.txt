2020/7/27 渗透测试之⿊⽩⽆常
渗透测试之⿊⽩⽆常
原创 队员编号001 酒仙桥六号部队 6⽉17⽇
这是 酒仙桥六号部队 的第 20 篇⽂章。
全⽂共计3002个字，预计阅读时⻓10分钟。
1 背景
本⽂是前段时间做过的测试，当时并没有进⾏截图以及记录，所以本⽂全篇使⽤本地搭
建环境来复现，如有觉得不合理的地⽅，可能是本地复现的时候未完全还原真实环境，
主要是记录当时在做这个渗透测试的思路。
2 寻找突破⼝
打开⽬标⽹站后，发现是⼀个博客系统，使⽤Web指纹识别系统显示是WordPress
（其实这⾥⼿⼯都可以测试出来，但是当时偷懒了，直接丢到Web指纹识别系统了），
经过测试前台⼏乎没有发现什么有价值的地⽅，后来发现后台为默认后台，也就是/wp-
admin/，顺⼿测试了⼀波弱⼝令admin/admin，没成想居然成功进⼊后台了。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 1/20
2020/7/27 渗透测试之⿊⽩⽆常
成功登录后台。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 2/20
2020/7/27 渗透测试之⿊⽩⽆常
常规wordpress的后台拿shell基本都是利⽤插件上传或者主题上传，或者编辑插件编
辑主题等⽅式进⾏操作，但是本次测试的⽬标将这些功能全部删除了，没有上传插件以
及上传主题的地⽅。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 3/20
2020/7/27 渗透测试之⿊⽩⽆常
上图在默认的程序中应该有⼀个上传插件按钮，但是该测试程序被删除了，⽽且后台处
理上传插件的接⼝也被⼀并删除或者修改了。在尝试其他后台拿到webshell失败的情况
下，翻到插件列表，发现已经安装的插件有⼀个Popup Builder插件版本是2.5.3。
由于其他常规的拿Shell⽅式都测试过⽆法成功利⽤，所以就想着这些插件会不会有漏
洞，毕竟好多WordPress的⽹站最后都败在了不安全的插件上，所以这⾥对照着系统安
装的软件名及版本在本地下载搭建进⾏代码审计。
3 代码审计
WordPress的Popup Builder插件是⼀个弹窗构建器插件，使⽤Popup Builder弹出
任何内容，为WordPress博客或⽹站创建和管理功能强⼤的促销模式弹出窗⼝。功能强
⼤且易于使⽤的此插件，可帮助您吸引访问者的注意⼒，向他们介绍您的优惠，折扣或
其他类型的促销通知。该插件⽬前已经活跃安装10万+。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 4/20
2020/7/27 渗透测试之⿊⽩⽆常
⽬前该插件版本已经是3.65.1了，但是我们⽬标系统的该插件版本为2.5.3,所以不能直
接在该插件⻚⾯进⾏下载安装，这⾥分享⼀个⼩技巧，可以下载指定版本的WordPress
插件。
在后台的安装插件⻚⾯，可以看到插件详情，有⼀个WordPress插件⻚⾯的链接地址，
点击可以跳转到WordPress中该插件的官⽹。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 5/20
2020/7/27 渗透测试之⿊⽩⽆常
打开后会有⼀个download按钮，点击即可开始下载，但是该URL可以通过修改版本号
来达到下载任意版本的插件。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 6/20
2020/7/27 渗透测试之⿊⽩⽆常
下载下来后经过⼀堆⽆⽤的分析和查看，省略⼀⼤堆操作，直接说最后审计出来的问题
吧。
问 题 出 在 ⽂ 件 \wp-content\plugins\popup-
builder\files\sg_popup_ajax.php中的sgImportPopups函数，该函数将POST的
attachmentUrl参数直接赋值并直接使⽤，代码如下：
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 7/20
2020/7/27 渗透测试之⿊⽩⽆常
根 据 该 函 数 的 代 码 显 示 ， POST 传 值 的 attachmentUrl 字 段 应 该 是 ⼀ 个 ⽹ 址 ， 使 ⽤
file_get_contents函数获取该⽹址数据，进⾏了⼀次base64解密，再进⾏了⼀次反
序列化，之后将得到的数据进⾏循环存⼊数据库。
由此可以推测，根据foreach循环内容及拼接字段显示，就能向数据库⾥⾯的任意表插
⼊数据。因为传输的数据是需要进⾏base64解密和反序列化的，所以根据程序代码要
求的字段以及格式编写⼀个⽣成payload的代码，这⾥使⽤PHP编写的脚本。
1  array('users' => array(
4 0 => array('aaaa',
5 '$BG3Bc6Y9Er4hAHVCBvTVkbs9HJ0lKk.',
6 'aaaa',
7 'PI:EMAIL',
8 'https://aaa.cn',
9 '0',
10 'aaaa',
11 )
12 )),
13 'customTablesColumsName' => array('users' =>
14 array(
15 0 => array('Field' => 'user_login'),
16 1 => array('Field' => 'user_pass'),
17 2 => array('Field' => 'user_nicename'),
18 4 => array('Field' => 'user_email'),
19 5 => array('Field' => 'user_url'),
20 6 => array('Field' => 'user_status'),
21 7 => array('Field' => 'display_name'),
22 ),
23 )
24 );
25
26 $payload = base64_encode(serialize($contents));
27 echo $payload;
放到PHP环境下，访问可获得payload。
https://mp.weixin.qq.com/s/O7bDgQrc2M5Fc60dRtVM6g 8/20
2020/7/27 渗透测试之⿊⽩⽆常
放到PHP环境下，访问可获得payload。Payload已经有了，现在需要知道如何请求这