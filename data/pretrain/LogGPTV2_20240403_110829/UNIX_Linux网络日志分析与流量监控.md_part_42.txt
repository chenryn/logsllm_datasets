事件背景
事件的始末？
件泄露案件，这和交换机的 CAM 表溢出有直接关系。通过分析 Tcpdump 日志，你能否还原
多数的入侵企图都将会被挫败。
案例也越来越多。如果企业网管能确保其系统保持更新并强制执行可靠的安全策略，那么大
7.3
的操作系统）的安全漏洞是入侵一个机构或网络的常见方式，并且利用蠕虫打入系统内部的
有更多的蠕虫出现，所以管理员要引以为戒。利用未打补丁的操作系统（包括移动智能设备
巨大损失。本案例中所讲的蠕虫在最新的操作系统中虽然没有危险，但是未来的时间里，会
其实蠕虫本身并不是主要威胁，主要威胁是被蠕虫利用的安全漏洞，这些安全漏洞能够造成
能够在Solaris和微软IIS服务器这样的系统上肆意横行，这里讲述的是Sadmind/IIS蠕虫，
在多娄
因为站长疏忽大意，才造成重大的损失。如果能够很好地完成网站安全配置，那么你的网站
代码和漏洞，并有规律地、及时地更新补丁文件。
计的公司由此被袭。可见，预防措施实际上是安全策略和警觉性的问题。必须时刻监控溢出
担心，本节仅从日志、脚本分析角度讲解问题。然而company.com仍被袭击了，还有数以千
漏洞早已公布在相关的更新补丁中，最新的操作系统也解决了这个问题，目前大家不必为此
的、并已备案的漏洞来实施攻击，即“Unicode攻击”和“sadmind缓冲区溢出”。不过这个
系统上传播，还危害装有未打补丁的 IIS 系统，并篡改首页。Sadmind/IIS 蠕虫通过两个知名
本案中Sadmind是一种后门型蠕虫病毒，它利用缓冲区溢出，试图在未打补丁的Solaris
预防措施
（4）蠕虫发现了若干含有漏洞的MicrosoftIS计算机，并实施了破坏。
能运行Microsoft ⅡIS的计算机（为进一步传播自己）。
会（2）蠕虫在此Solaris计算机上复制自己，并开始新的生命。
坐落于中关村高科技园区的某IT公司，是一个拥有大约400名职员的软件公司，公司
box.company.com.
黑客通过攻击服务器的安全漏洞而获得远程系统管理员权限。这种权限的访问使黑客都
（3）蠕虫伪随机地搜索其他脆弱的Solaris计算机，以便在它们身上繁殖并破坏其他可
知彼知己方能百战不殆。对于网站管理员而言，很多网站入侵本身是可以避免的，只是
关键日志：
难度系数：★★★★
故事人物：享
数情况下是安全的。的
案例十二：泄露的裁员名单
郭经理（IT主管）、张静（人力资源部主管）、小林（离职网管）
Tcpdump 抓包分析
000
第7章UNIX系统防范案例221
ROOT
---
## Page 245
发现此文件包含了公司所有的工作电子邮件，特别是下面这封：
文件系统。在小林的/home/目录下有些东西引起了他的好奇心：
怪的，类似桌面保护程序的东西，还有屏保密码。老郭随后启动到单用户模式，并着手查看
他的办公桌周围并没有发现什么异常。这时他开始注意小林的Gnome桌面，看到了一些奇
这事有点蹊跷，小林没有大吵大闹就主动“和平”离开。老郭坐在小林的办公桌前，在
取证分析
个星期五他就不在办公室了，看来他那时候就知道周一将要发生的事。
事情！小林的显示器上有一个便条：
些职员解释。毕竟他的属下都是不错的员工。
完全没有意识到下周一将要发生什么。老郭很烦躁，他提前下了班，回家考虑他该怎样对这
室里徘徊着，他正考虑该如何对他的属下公布这个坏消息。他们整个下午都在努力地工作，
件，随后他删除了服务器上的这封电子邮件，并将副本保存在他自己的硬盘上。老郭在办公
理人员、两名机房值班人员。
损失了最多职员。原来为了降低成本，管理团队决定将他的部门进行压缩，解雇两名网络管
以便研究谁该走人。当天快下班的时候，终于拟定了一份4人职员名单，信息技术主管老郭
议来讨论这个问题的解决办法。管理团队与各部门经理和人力资源部开了一天的闭门会议。
条，董事会和管理团队决定采取强硬手段，必须裁员了。他们匆忙决定在星期五组织一次会
222
张静给各部门经理发送了一封 E-mail，包含上午会议讨论出的人员名单。老郭阅读了邮
不太对劲啊！随后老郭仔细查看了每个日志文件，尤其是ms-log-01.18.2010.txt 文件，
老郭很迷惑，也不明白小林是怎么知道自己要被解雇的。从便条落款时间上看，自从上
“我这么努力工作，你为什么要解雇我？”
上午11:00左右，老郭走向小林的工作台，看他在不在，随后却发现了十分令他惊讶的
星期一的早晨，老郭很早就来到办公室。随后找了名单上的人谈话，可是一直没找到小林。
公司在一次网络系统改造中，花费200万元更新了硬件设备。没过多久，由于经济萧
UNIX/Linux 网络日志分析与流量监控
To: Sir Boss[PI:EMAIL]
Date:Friday,January18,20103:01PM
From: zhang jing [PI:EMAIL]
-rw-r--r--
drwxr-xr-x
-rw-r--r--
-rw-r--r--
-rw-r--r--
-rw-r--r-
--J-J-MI-
rw-r-...
drwxr-x---
total56350
#1s-1
1root
一
1
1root
2root
4root
root
root
wheel
wheel
wheel
wheel
wheel
wheel
wheel
wheel
wheel
33584252Jan14 22:11ms-log-01.14.2010.txt
5821564Jan1823:51ms-log-01.18.2010.txt
7394428Jan1720:19ms-log-01.17.2010.txt
2241660Jan1523:31ms-log-01.15.2010.txt
932549Jan1823:51tcpdump-out.txt
4096Nov92010dsniff-2.3
82De1118:17snf.sh
512Jan1015:38old-ms
十宗
---
## Page 246
选择的IP 地址和 TCP端口：
这点。每条记录都包含了表面上随机的源和目标 MAC 地址。同样，每条记录都包含了特意
络受到了大量的、伪造的、随机的、地址帧的洪泛（Flood）攻击。头24条记录似乎印证
互动问答
并得出结论，老郭相信自己能迅速地推断出到底发生了什么。
1
内容）：
林已经读过这封邮件了。但他是怎么得到的呢？老郭最后查看了 tcpdump-out.txt 文件（部分
通过阅读tcpdump命令加上w参数收集到的捕获数据包，
老郭细读了 tcpdump 日志文件，精心研究小林的所有操作。最初他极为肯定地推断，
505555550555055555050555055
1.
大事不妙！这封机密邮件正是上周五，
S
小林如何发现自己即将被解雇？
如何防范网络嗅探？
在网络上发送机密邮件，怎么样做才安全？
有没有其他方法能得到同样效果？
他用了什么工具，这些事件的顺序是怎样的？
谢
郭经理，下面是你们部门要解雇的人员名单，请你星期一早晨和他们单独谈话：
Subject:Name List
88
8
88
:d7:
38232492
人力部负责人张静发给他的解雇名单！很明显小
N
66
68812
第7章UNIX系统防范案例223
827:
，再导入wireshark中仔细分析
29
2
9
80
区
---
## Page 247
况的电子邮件。
林就是利用了这种情形来监听网络。在这些可监听的连接中，他捕捉到了那封有关他解雇情
障而开放，使之看起来像HUB一样工作，导致VLAN上的所有网络流量都可以监听到。小
满时，交换机就开始将未知的MAC地址发送到VLAN上的每个端口，结果造成交换机因故
Memory，CAM）表大小有限。CAM表在交换机中用来存储MAC地址信息，然而当它被寒
故障模式（在那个VLAN上）。这个故障的出现是由于内容寻址存储器（ContentAddressable
答疑解惑
的记录仍是MAC洪泛攻击。
口。这就是小林能够监听到SMTP 流量的原因，也就是他如何能知道他被解雇的原因。剩
个MAC地址的洪泛攻击，它填充交换机的内存，迫使它将流量发送到VLAN上的每个端
者组播流量。然而，小林的计算机所在VLAN 的端口功能肯定不正常，它们受到了来自-
换网络中，一个端口上的系统应该只能看到那个端口发向它自己的网卡的流量、广播流量
含
间戳和包大小的分析，老郭断定这就是人力资源部张静发送的那封机密电子邮件，
次完整的TCP三次握手。这表示正从某台计算机到SMTP服务器建立一次连接。通过对时
了被解雇的员工名单。
1.小林使用伪造的、随机的、MAC地址帧洪泛式地攻击他的VLAN，迫使交换机进入
小林怎么提前知道他将要离开？通常在交换网络中像这样的流量是不该被捕获的。在交
然
UNIX/Linux网络日志分析与流量监控
然而接下来的34条记录却有所不同。仔细分析发现，这是针对目标服务器端口25的一
970
969
4829425
df:7
880
8
34:46:
B
22
58
1023
>65
AS
168.
168.
22730
2031:
235
9
16060
ack
9
邮件中包
i
D
---
## Page 248
址接入，可以通过静态手工定义，不过这样初期设置的工作量比较大。
过哪些MAC地址，对超过规定数量的接入设备进行相应的处理。端口上允许哪些MAC地
通过配置Port Security可以控制：端口上最大可以通过的MAC地址数量，端口上学习或通
络管理员也可以静态设置每个端口所允许连接的合法MAC地址，实现设备级的安全授权。
（PortSecurity）和动态端口安全功能可被用来阻止MAC洪泛攻击。通过端口安全功能，网
似macof 工具和 SQL 蠕虫病毒发起的MAC 洪泛攻击。CiscoCatalyst交换机的端口安全
假冒的或别的方式）的MAC地址通过网络，并阻止其存入交换机的CAM表中。
在每个端口上进行过滤。在交换机上启用基于端口的安全措施可以防止未知（欺骗的、随机
攻击不仅造成安全性的破坏，
换机就会像HUB一样工作，
满 MAC 地址表，这时发往新目的MAC地址的数据包就会被广播到交换机的所有端口，交
发送大量带有虚假源MAC地址的数据包，这些新MAC地址被交换机CAM学习，很快塞
建立交换路径，这个表就是通常我们所说的CAM表。MAC/CAM攻击是指攻击者利用工具
预防措施
流量。
可以欺骗VLAN中的计算机，让它们认为他的计算机是SMTP服务器，随后获取电子邮件
ARP）欺骗来完成同样的功能。使用arpspoof和ettercap（http://ettercap.sourceforge.net/）程序他
使用mailsnarf程序捕获电子邮件。这两个工具都在Dsnif工具（在BT5中包含）套件中。
、此类攻击的预防通常比较简单。大多数交换机都提供某种形式的MAC地址限制或者是
2.小林有可能使用macof程序来导致交换机故障开放，当交换机处在故障模式时，他
在交换机上处理的具体思路是限制单个端口所连接的MAC地址数目，可以有效防止类
交换机会主动学习客户端的MAC地址，建立、维护端口和MAC 地址的对应表，以此
3：小林还可以通过对SMTP服务器进行地址解析协议（AddressResolutionPtotocol，
S
4.
对于防范网络嗅探的方法，
对于发送加密邮件的问题，可以在本书的第12章找到答案。
，同时大量广播包降低了交换机的性能。
，攻击者则可以利用sniffer工具监听所有端口的数据流量。此类
，可以在第13章最后一节找到答案。
图7-7噢探交换机密码
tep10.1.1.1.31763->18.1.1.2.23 （telnet)
dr
第7章UNIX系统防范案例225
Tx bytes:255808(255.
---
## Page 249
旅更区单工口做
以全口版
个
些了解。
机上关闭这个端口的访问。
一旦检测到此类攻击，管理员可以确定所有的洪泛式流量来自哪个端口，并立即在交换
226UNIX/Linux网络日志分析与流量监控
文
Cisco Catalyst 6500
Cisco Catalyst 4948
Cisco Catalyst 4500
Cisco Catalyst 3750
Cisco Catalyst 3550/60
Cisco Catalyst 3500XL
Cisco Catalyst 2950/60/70
Cisco Catalyst 2948G
Cisco Catalyst Express 500
表7-1是思科设备的最大CAM 值，当然设备远不止这些，大家在日常维护中可以做一