| ▶ |External |  |
| ▶ |Autonomous System Lookup  |  |
| ▶ |(https://splunkbase.splunk.com/app/3531/) |  |
| ▶ |In-line Whois (https://splunkbase.splunk.com/app/3506/) |  |
| ▶ |pDNS (https://splunkbase.splunk.com/app/3050/) |  |
| ▶ |Democracy Index |  |
© 2017 SPLUNK INC.
Enrichment 
Network Sessions and BYOD Devices
Attribution of network activity to a specific user/deviceNetwork Sessions lookup:
	▶ Source: VPN session / DHCP lease start events
	▶ KVStore Collection-based temporal lookup
	▶ “Appended” by scheduled search run every few minutes
	▶ Another scheduled search periodically prunes old sessions from the lookup to 	ensure size doesn’t grow indefinitely
	▶ Fields: start, src_mac, src_ip, user, nt_host, assigned_ip
Check carefully your events aren’t lying to you.© 2017 SPLUNK INC.
Enrichment 
Network Sessions and BYOD Devices
Attribution of device to a specific user
User Endpoints lookup:
▶ Source: Auth events with src_ip
▶ KVStore Collection-based lookup
▶ “Appended” by scheduled search run periodically
▶ Uses Network Sessions lookup to determine MAC address
▶ Fields: key(network_session_src_mac), os_type, nt_host, user, updatedAutomatically learns about devices, when last used and who owns them.
ES asset source with asset priority mirroring the user that owns the device.
© 2017 SPLUNK INC.
Enrichment 
Notable Comment-derived Dynamic Enrichment
▶ The fields in notables are fixed* but analysts 	find information during triage
▶ We want to be able to add field values 
	dynamically so they can be pivoted upon 	and to ensure the investment of analysttime in triaging notables is most effectively 	reused
▶ If we associate a notable with a user, it can 	then appear in their swimlane
▶ Free-form prose with Key-Value pairs 
	according to CIM-based taxonomy.
© 2017 SPLUNK INC.
	Enrichment 
	Scheduled Search To Build Extraction Lookup 
|`incident_review` 
| rename comment as _raw | extract mv_add=true | rename _raw as comment | search user=* OR src_ip=* OR …| stats values(user) as user values(src) as src ... by rule_id 
| mvexpand  
| outputlookup incident_review_comment_extractions
© 2017 SPLUNK INC.
Enrichment 
Dynamic Notable Enrichment
SA-ThreatIntelligence/local/macros.conf: [notable_by_id(1)] 
definition = `get_notable_index` \ 
| `get_event_id` \ 
| search event_id="$event_id$" \ 
| ... \
This macro is used by all ES' notable dashboards, etc.Example of custom commands 
appended to macro to add arbitrary and dynamic notable enrichment
| lookup user_watchlist _key AS user OUTPUT start AS watchlist_start, end AS watchlist_end, reason AS watchlist_reason, comment AS watchlist_comment, creator AS watchlist_creator \| eval watchlist=if(isnotnull(watchlist_start),if(watchlist_start_time,watchlist_reason + ": " + if(isnull(watchlist_comment),"no comment",watchlist_comment) + " (" + watchlist_creator + ")","On watchlist either before or after this notable"),null())
© 2017 SPLUNK INC.
Customizations 
E-mail Workflow Action
▶ Workflow actions are just links
▶ We can use url encoded mailto: links with tokens▶ Each workflow action is then an e-mail template that auto populates▶ Approach allows us to PGP sign e-mails
© 2017 SPLUNK INC.
Customizations 
Risk Object Value
▶ Provides means to sort notable 
	table and search across notables
▶ Use eval in correlation searches to 
	add “risk_object_value” field to 
	notables
▶ Add “Table Attribute” via “Incident 
	Review Settings” dashboardReview Settings” dashboard
e.g. … | eval risk_object_value=if(like(src_ip,"10.%"),src_ip,dest_ip)
© 2017 SPLUNK INC.
Customizations 
Custom Identity and Asset Information
▶ Inability to add arbitrary identity/asset information is a common complaint▶ Create a csv lookup and apply to [default] stanza in props.conf
	•	LOOKUP-zd_identities_supplementary = identities_supplementary user
© 2017 SPLUNK INC.© 2017 SPLUNK INC.
https://splunkbase.splunk.com/app/3506/
© 2017 SPLUNK INC.
User Watchlist Editor
https://splunkbase.splunk.com/app/3591/
	▶ Provides interface to add/edit/remove watchlist users and meta-data	▶ Able to be integrated with ES Identity sources: 
...
| lookup user_watchlist _key AS identity OUTPUT end AS watchlist_end 
| eval watchlist=if(isnotnull(watchlist_end),if(watchlist_end>now(),"true",null()),null()) | fields - watchlist_end© 2017 SPLUNK INC.
© 2017 SPLUNK INC.
User and Asset Investigator Dashboards
Custom swimlanes Change in behaviour
© 2017 SPLUNK INC.
Case Study
Third Man Correlation Search
© 2017 SPLUNK INC.
Third Man Correlation Search https://splunkbase.splunk.com/app/2830/
1st: The Idea
▶ No 2FA?
▶ Can we detect the 
use of phished 
credentials?
▶ Humans are 
predictable ∴
changes in pattern 
can be detected?changes in pattern 
can be detected?
© 2017 SPLUNK INC.
Third Man Correlation Search
2nd: The Source
Scope and Abstraction 	eval period=case(date_hour2
© 2017 SPLUNK INC.
Third Man Correlation Search 5th: The Triage| Fields and Documentation | Fields and Documentation |
|---|---|
| ▶ |user, src_ip, src_as, dest, app, unique_vectors, unique_vector_count |
| Analysis and Enrichment |Analysis and Enrichment |
| ▶ |Drilldown search to table of user’s authentication activity |
| Actions and Remediation |Actions and Remediation |
| ▶ |Raise notable |
| ▶ |Aggregate risk - scaled dynamically in-line by number of unique vectors || ▶ |Place user on watchlist? (https://splunkbase.splunk.com/app/3591/) |
| Fidelity and Refinement |Fidelity and Refinement |
| ▶ |Check for apps or other vector values to filter out |
| ▶ |Check CIM normalisation for inconsistencies |
| ▶ |Consider extending earliest time to improve fidelity |
© 2017 SPLUNK INC.
Key 
Takeaways  1. How to build your SIEM with ES 
2. “intrinsically actionable”2. “intrinsically actionable”
3. Changes in behaviour are key 
4. Risk-centric view to incident detection 5. How to develop detection techniques
© 2017 SPLUNK INC.
Q&A
© 2017 SPLUNK INC.
Thank You
Don't forget to rate this session in the 
.conf2017 mobile app
© 2017 SPLUNK INC.
Bonus Material 
UTC field in all events/notables
| ▶
▶
▶ | You may have noticed the ‘utc’ field in the screenshotsGeographically distributed security teams have to speak a common time This is especially important when extracting evidence | You may have noticed the ‘utc’ field in the screenshots 
Geographically distributed security teams have to speak a common time This is especially important when extracting evidence |
|---|---|---|
| ▶ ▶ ▶ |• |… | table _time utc index source sourcetype host _raw |
props.conf:props.conf:
[default] 
EVAL-utc = strftime(_time - (60 * 60 * tonumber(substr(strftime(_time,"%z"),2,2))) + (60 * tonumber(substr(strftime(_time,"%z"),4,2))), "%Y-%m-%d %H:%M:%S UTC")
© 2017 SPLUNK INC.
Bonus Material 
_raw search in Incident Review dashboard
| ▶▶▶▶ | Much of the information in notables is not searchable without knowing fieldnames One solution is to “recreate” _raw to include *all* the enrichment fieldsJSON Tools app (https://splunkbase.splunk.com/app/3540/) 
In the notable_by_id(1) macro, add: | Much of the information in notables is not searchable without knowing fieldnames One solution is to “recreate” _raw to include *all* the enrichment fields 
JSON Tools app (https://splunkbase.splunk.com/app/3540/) 
In the notable_by_id(1) macro, add: |
|---|---|---|
| ▶▶▶▶ |• |… | mkjson ||---|---|---|
| ▶▶▶▶ |• |… | mkjson |
| ▶▶▶▶ |• |Must be before the $event_id$ search command but after enrichment |
Notable search now works like core Splunk search.