陆柏廷 | BT
漏洞盒子 高级安全研究员
漏洞盒子简介
漏洞盒子
互联网安全服
务平台
FreeBuf
互联网安全新
媒体
网藤风险感知
基于SaaS模式的自
动化企业安全风险
感知服务平台
自有安全团队与外部
安全专家结合，共同
为厂商提供安全一体
化解决方案
安全专家
相关机构
厂商
 厂商：金融、保险、电商、互联网、通信等
 相关机构：CNCERT、CNNVD、 SERCIS、
SHCERT、公安部第三研究所、中国民航测评中心、
天津网安等
演讲提纲
前
言
场
景
方
法
企业安全测试进化史
１.０
２.０
３.０
基于功能／
性能的”安
全测试”
基于漏洞类
型的安全测
试
基于业务场
景的安全测
试
何为业务场景
其他场景
支付场景
￥
实名认证场景
购物及订单场景
活动场景
身份认证场景
一个业务系统包含的交互场景
业务逻辑漏洞是怎样的存在
 Bypass一切防护设备
 至今还没有一款有效的全自动化工具
 再资深的程序员都可能造坑
 即使安全人员开发的程序也可能有坑
开发人员ＶＳ安全人员
身份盗取
交易篡改
权限跨越
资源消耗
一个对外业务可能面临哪些业务风险？
身份盗取｜迷失的穿云箭
digiSign
身份盗取｜简单认证
身份盗取｜最后一公里
权限跨越｜垂直水平
Cookie: SESSION=USER-334dsf9ref8esg8erg390g
Cookie: SESSION=USER-3dfg34768jh4h234g5h5jk
Cookie: SESSION=USER-304jkh6g9090ertk45g0s9
Cookie: SESSION=USER-2dfg34768jh4h234g5h5jk
Cookie: SESSION=USER-1dfg34768jh4h234g5h5jk
客户端
服务端
操作userId的资源
返回执行结果
Cookie: SESSION=USER-334dsf9ref8esg8erg390g
userId=519235
用户检查：
session=34dsf9ref8esg8erg390g
权限检测：
level=3
level=1：admin
level=2：vip user
level=3：normal user
权限跨越｜垂直水平
权限跨越｜签名突破
客户端
服务端
预查询联系人ID
返回联系人ID
查询联系人ID详情
返回联系人详情
SIGNED
SIGNED
篡改此处ID
权限跨越｜签名突破
交易篡改｜签名破解
将订单中的v_amount,v_moneytype,v_oid,v_mid,v_url参数的value值拼成一个无间隔的
字符串,使用key作为salt即生成任意伪造数据签名
交易篡改｜局部验证
资源消耗｜变量覆盖
GET /sms/sendVerifySms/?phoneNumber=18666666666&prefix=R&type=phoneNumber HTTP/1.1
GET 
/sms/sendVerifySms/?phoneNumber=18666666666&phoneNumber=18666666666&prefix=R&type=phone
Number HTTP/1.1
GET 
/sms/sendVerifySms/?phoneNumber=18666666666&phoneNumber=§variable§&prefix=R&type=phoneNumber
HTTP/1.1
资源消耗｜并发请求
客户端
服务端
获取优惠券
返回执行结果
是否已获取该优惠券
返回执行结果
数据库
资源消耗｜并发请求
资源消耗｜薅羊毛
 花8000万做推广，3000万被羊毛党薅走
 需要什么给什么，只要收益大于付出
防治
 提高门槛：用户流失
 后期检测：成本高、误差大
如何高效测试
 业务场景建模
 业务流程梳理
 风险点识别
业务场景建模－１
不同行业业务场景有所异同
如：银行、金融、保险、证券、电商、020、游戏、社交、招聘、航空
白盒：开发文档
黑盒：主动识别
业务场景建模-1｜电商
红包/优惠
券相关
个人信息
相关
业务接口
调用
实名认证
身份认证
支付相关
订单相关
绑定银行卡
电商业务
场景建模
业务场景建模-1｜P2P金融
借款/贷款
个人信息
相关
活动相关
绑定银行卡
实名认证
身份认证
支付相关
交易信息
P2P金融业务
场景建模
业务场景建模-1｜游戏
游戏角色
相关
个人信息
相关
业务接口
调用
活动抽奖
相关
社交相关
身份认证
游戏点卡
充值
实名身份证
登记
游戏业务
场景建模
业务场景建模-1｜银行
借款/贷款
个人信息
相关
转账/取款
U盾相关
客户端相关
身份认证
支付相关
交易信息
银行业务
场景建模
业务场景建模-2
 相同行业，即使是相同业务系统，业务场景也不是一成不变的
 高风险业务场景识别
 需求沟通
业务场景建模-2 | Plan-A
红包/优惠
券相关
个人信息
相关
业务接口
调用
绑定银行卡
实名认证
身份认证
支付相关
订单相关
电商业务
场景建模
业务场景建模-2 | Plan-B
活动相关
实物卡充值
业务接口
调用
社交帐号
绑定
实名认证
身份认证
支付相关
用户敏感
信息操作
电商业务
场景建模
业务场景建模-2 | Plan-C
红包/优惠
券相关
个人信息
相关
社交相关
手机/邮箱
绑定
实名认证
身份认证
支付相关
投诉/留言
管理
代付相关
商城业务
场景建模
业务流程梳理
 识别业务逻辑
 应用层数据包梳理
 字段功能辨析
密码重置
客户端
服务端
输入用户名
验证用户名存在后返回第二步
Step 1
Step 2
Step 3
Step 4
输入短信验证码
验证短信验证码后返回第四步
输入新密码
密码修改成功
发送短信验证码请求
发送验证码后返回第三步
订单查询
客户端
服务端
预查询订单ID
返回用户订单ID
查询用户订单ID详情
返回订单详情
支付交易
客户端
服务端
提交订单相关信息
返回生成的订单
支付订单
返回支付结果
风险点识别
 已知风险对照
 STRIDE分析方法
风险点识别
密码重置
客户端
服务端
输入用户名
验证用户名存在后返回第二步
Step 1
Step 2
Step 3
Step 4
发送短信验证码请求
发送验证码后返回第三步
输入短信验证码
验证短信验证码后返回第四步
输入新密码
密码修改成功
遍历用户名
篡改响应包
篡改手机号
获取验证码
爆破验证码
篡改响应包
爆破验证码
篡改响应包
订单查询
客户端
服务端
预查询订单ID
返回用户订单ID
查询用户订单ID详情
返回订单详情
篡改直接对象
篡改权限标识
SESSION破解
篡改直接对象
篡改直接对象
篡改权限标识
SESSION破解
获取敏感数据
支付交易
客户端
服务端
提交订单相关信息
返回生成的订单
支付订单
返回支付结果
篡改金额
篡改数额
签名破解
篡改金额
获取敏感数据
篡改金额
签名破解
获取敏感数据
The STRIDE Threat Model
 Spoofing identity
 Tampering with data
 Repudiation
业务流程元素
假冒（S）
篡改（T）
否认（R）
信息泄漏（I） 拒绝服务（D） 提升权限（E）
信息流
数据储存
操作
交互方
 Information disclosure
 Denial of service
 Elevation of privilege
www.vulbox.com | 漏洞盒子
crs.vulbox.com | 网藤风险感知
www.freebuf.com | FreeBuf
THANKS