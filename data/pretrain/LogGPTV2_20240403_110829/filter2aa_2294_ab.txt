TGS-REQ
TGS-REP
user01
KDC
•
。。。前面已经通过 AS-REQ 与 AS-REP 获取了 TGT
•
TGS-REQ
•
客户端：“我是 user01，我想申请一张访问 server1 的 smb 服务的票。这是我
的 TGT，以及一段加密数据来证明我知道 与 TGT 对应的 Session key”
•
TGS-REP
•
KDC：“您的 TGT 是合法的， 并且加密数据校验成功，这是一张能够访问 
server1 的 smb 服务的票（service ticket）以及 Session Key”
TGS-REP
SPN 后门， https://adsecurity.org/?p=3466
伪造 TGT，冒充任意用户
TGS-REQ
TGS-REP
user01
KDC
•
。。。前面已经通过 AS-REQ 与 AS-REP 获取了 TGT
•
TGS-REQ
•
客户端：“我是 user01，我想申请一张访问 server1 的 smb 服务的票。这是我
的 TGT，以及一段加密数据来证明我知道 与 TGT 对应的 Session key”
•
TGS-REP
•
KDC：“您的 TGT 是合法的， 并且加密数据校验成功，这是一张能够访问 
server1 的 smb 服务的票（service ticket）以及 Session Key”
KDC 是如何判断客户端提交上来的 TGT 是合法的？
使用人：USER01
允许访问的服务：
KRBTGT/EAST
到期时间：2018-08-
24 23:00:00
Session key
TGT
其他信息
KDC 
印章
authenticator
加密的 Authenticator
利用 TGS-REQ 向 KDC 申请服务 Server1 SMB 服务的票
加密的 TGT
KDC
使用人：USER01
允许访问的服务：
KRBTGT/EAST
到期时间：2018-08-
24 23:00:00
Session key
TGT
其他信息
KDC 
印章
authenticator
加密的 Authenticator
加密的 TGT
KDC
用 KRBTGT 
Key 
解密 TGT
返回访问 
SMB/Server1 
的票与 Session 
key
• 只要 TGT 能被 KDC 利用相关算法解密
（以 KRBTGT 相关 Key 做为密钥），
则 TGT 合法
• 盗取 KRBTGT 相关 Key 即可伪造 TGT
使用人：USER01
允许访问的服务：
SMB/SERVER1
到期时间：2018-08-
24 23:00:00
Session key
Service Ticket
其他信息
KDC 
印章
Session Key
KDC
返回访问 
SMB/Server1 
的票与 Session 
key
被 SMB/Server1 
服务启动账号的 NT HASH 加密
KERBEROAST - Kerberos 服务启动账号密码的离线暴破
USER01 TGT
MSSQL/SERVER
1 TICKET
HTTP/SERVER2
TICKET
KMC/SERVER3 
TICKET
MSSQL/SERVER1
HTTP/SERVER2
KMC/SERVER3
SPN 查询
域内 Kerberos 服务
USER01 TGT
MSSQL/SERVER
1 TICKET
HTTP/SERVER2
TICKET
KMC/SERVER3 
TICKET
离线暴破
访问域内
资源
制作白银
票据
后面再讲
•
已通过 AS-REQ & AS-REP 获得 TGT
•
已通过 TGS-REQ & TGS-REP 获得 Service ticket
1. AP-REQ
•
客户端：“我是 user01，我要访问你的 smb 服务，这是一张能够证明我身份的票
（service ticket）以及一段加密数据来证明我知道这张票所对应的 Session Key”
2. AP-REP
•
SMB 服务：“您的票是合法的， 并且加密数据校验成功。已经确定您是 user01，
可以访问”
AP-REQ
user01
CIFS/SERVER1
SMB 服务是如何验证票是否合法的？
使用人：USER01
允许访问的服务：
CIFS/SERVER1
到期时间：2018-08-
24 23:00:00
Session key
SERVICE TICKET
其他信息
KDC 
印章
authenticator
加密的 Authenticator
利用 AP-REQ 访问 Server1 SMB 服务
加密的 SERVICE 
TICKET
Server1
使用人：USER01
允许访问的服务：
CIFS/SERVER1
到期时间：2018-08-
24 23:00:00
Session key
SERVICE TICKET
其他信息
KDC 
印章
authenticator
加密的 Authenticator
加密的 SERVICE 
TICKET
用服务启动账号
Key 
解密 Service 
Ticket
认证成功
Server1
•
只要 Service ticket 能被目标服务利用相关算法解密（以服务
启动账号的相关 Key 做为密钥），则 Service ticket 合法
•
盗取 “服务启动账号的相关 Key” 即可伪造 Service ticket
GOLDEN TICKET
依赖 KRBTGT KEY
欺骗域内任何
使用 Kerberos 认证的服务
冒充域内任何用户
SILVER TICKET
依赖 服务启动账号 KEY
欺骗“共享同一个启动账号”的服务
冒充域内任何用户
USER01
IIS
DATABASE
GET /A.TXT
切换身份
Delegation/委派
客户端（USER01）访问服务端（IIS）时，服务端利用客户端的身份访问了其他资源
USER01
IIS
DATABASE
GET /A.TXT
切换身份
Delegation/委派
SERVER02
SERVER03
无限制委派
USER01
IIS
GET /A.TXT
切换身份
HTTP GET 
/A.TXT
AP-REQ
IIS Service 
Ticket
 USER01 
TGT. 
USER01 TGT
USER02 TGT
USER03 TGT
Administrator
TGT
拥有无限制委派的服务内将缓存有所有访客的 TGT
USER01
IIS
DATABASE
GET /A.TXT
切换身份
Delegation/委派
SERVER02
SERVER03
受限制委派
变种 GOLDEN TICKET
  依赖于 KRBTGT KEY  
欺骗域内任何
使用 Kerberos 认证的服务
冒充域内任何用户
在域控留下更多日志
受限委派
S4U2Self
S4U2Proxy
USER01
ATEAM/TESTSERVICE
KDC
S4U2Proxy
允许委派到 TGS 服务
S4U2Self
可以以任何用户的名义
申请一张访问自身的票
以 USER01 的身份
申请 TGT（ticket 0）
使用 USER01 的 TGT，通过 
TGS-REQ 配合S4U2Self 协议，
以 Administrator 的名义申请一张
访问 ATEAM/TESTSERVICE 的
票（ticket 1）
使用 USER01 的 TGT，通过 
TGS-REQ 配合 S4U2Proxy 协议
并带上 ticket 1，以 
Administrator 名义申请一张委派
到 TGS 服务的票（ticket 2）
AS-REQ
AS-REP
ticket 0
TGS-REQ
TGS-REP
ticket 1
TGS-REQ
TGS-REP
ticket 2
•
一张能以 Administrator 的名义访问 
TGS 服务的票，就是 Administrator 
的 “TGT”
•
我们通过了普通账号 USER01 拿回了 
Administrator （可以是域内任何用
户） 的 TGT。
GOLDEN TICKET
依赖 KRBTGT KEY
欺骗域内任何
使用 Kerberos 认证的服务
冒充域内任何用户
攻击者手动伪造任意用户 TGT，冒充任
意用户
依赖 S4U2SELF + S4U2PROXY
获取任意用户 TGT，冒充任意用户
欺骗域内任何
使用 Kerberos 认证的服务
冒充域内任何用户
变种GOLDEN TICKET
特性滥用
360 A-TEAM
n1nty
@