Rancher快速上手指南（虚拟机篇）
Rancher 快速上手指南（虚拟机篇）
前言
云舒网络携手Rancher Labs推出【Rancher | 实战群】，在线为您分享Docker技术干货，更有往
期回顾精选期刊等你拿！
本群汇集了Rancher中国最强技术精英团队及业内技术派高人，宗旨是为了大家拥有更专业的平台交
流Rancher实战技术，实时与Rancher创始团队面对面！同时欢迎各位分享自己的经验、疑难问
题，我们将定期邀请分享嘉宾做各类话题分享及回顾，共同实践研究Docker容器生态圈。
对Rancher和Docker技术感兴趣、或对本文中细节需继续探讨的朋友，欢迎加入本群参与讨论！
加群方法：
1.关注【云舒网络】公众号
2.留言”我要加群“
注：因版本更新，文中 UI 界面与最新版本略有差异。
1
Rancher快速上手指南（虚拟机篇）
通过一个您已经熟悉的任何一种主流的发行版 Linux 虚拟机，就可以开始一个快速简单的
Rancher测试体验。
建议虚拟机的规格：1vcpu，不小于 4GB 内存，一块能够连通互联网的网卡。本文编写的
测试机是AWS 虚拟机上的Amazon Linux AMI，对 CentOS/RHEL有直接参考意义。
Linux 主机准备
安装和运行 Docker 命令和服务，这基本是 Rancher 对于操作系统的最小化需求了。如果
您还不太熟悉 Linux 或者 Docker可以参考以下文档：
 Ubuntu用户参考文档:https://docs.docker.com/engine/installation/ubuntulinux/
 CentOS/RHEL 用 户 参 考 文 档 :http://www.dedoimedo.com/computers/docker-
guide.html
Docker命令和服务安装好之后需要确认：
#确认docker的版本，下面是centos 的输出
[ec2-user@ip-172-31-30-38 ~]$ sudo docker version
Client:
Version: 1.9.1
API version: 1.21
Go version: go1.4.2
2
Rancher快速上手指南（虚拟机篇）
Git commit: a34a1d5/1.9.1
Built:
OS/Arch: linux/amd64
Server:
Version: 1.9.1
API version: 1.21
Go version: go1.4.2
Git commit: a34a1d5/1.9.1
Built:
OS/Arch: linux/amd64
#确认docker服务已经启动并且运行，下面是以 centos为例
[ec2-user@ip-172-31-30-38 ~]$ sudo service docker status
docker (pid 7652) is running...
启动 Rancher 服务器
Rancher服务器是一个 Docker image，所以其软件本身不需要安装，只需执行Docker命
令下载并且运行Rancher服务器的镜像即可。
[ec2-user@ip-172-31-30-38 ~]$ sudo docker run -d --restart=always -p 8080:8080
rancher/server
3
Rancher快速上手指南（虚拟机篇）
Unable to find image 'rancher/server:latest' locally
latest: Pulling from rancher/server
0bf056161913: Pull complete
1796d1c62d0c: Pull complete
e24428725dd6: Pull complete
89d5d8e8bafb: Pull complete
a31a85515ea3: Pull complete
c2fd2bef635f: Pull complete
cb545eb6ebd1: Pull complete
7beaeed203e7: Pull complete
f483a41462cd: Pull complete
2fd8dc138841: Pull complete
a4e1df2cafae: Pull complete
5f632b46feff: Pull complete
a4ff409fd1b0: Pull complete
8713e0a3f956: Pull complete
7f6c235d968a: Verifying Checksum
c074ec496974: Download complete
390a2453f500: Download complete
4
Rancher快速上手指南（虚拟机篇）
c7f9c84ef74a: Download complete
Status: Downloaded newer image for rancher/server:latest
docker.io/rancher/server: this image was pulled from a legacy registry. Important: This
registry version will not be supported in future versions of docker.
7c41a0a1a9c79842bca53c19e4ec106b0c2dc6469baec6077a40405f80b26963
[ec2-user@ip-172-31-30-38 ~]$
命令行参数解释：
 docker run [OPTIONS] IMAGE [COMMAND] [ARG...] 运行一个docker容器
 -d 在后台运行 docker 容器，并且打印出它的容器 ID （Run container in
background and print container ID）
 --restart=always 当容器存在时所应用的重启策略，总是重启。
 -p 8080:65432 容器端口在虚拟机本机上使用 8080端口，Rancher 服务器的UI 对
外服务的端口是 8080，如果您的服务器是远程的服务器，还需要考虑到你的测试客户
机和虚拟机之间的防火墙策略，确保所使用的 Rancer服务器UI 对外服务端口不是防
火墙阻止的端口。
 rancher/server 这里声明让 docker 去 docker hub 下载并且运行名称为
rancher/server 的docker 镜像到本地。
5
Rancher快速上手指南（虚拟机篇）
#检查docker已经正确下载了 rancher/server 镜像到本地
[ec2-user@ip-172-31-30-38 ~]$ sudo docker images
REPOSITORY TAG IMAGE ID CREATED
VIRTUAL SIZE
rancher/server latest 25c20134881a 3 days ago
845 MB
  8713e0a3f956 4 days ago
473.9 MB
[ec2-user@ip-172-31-30-38 ~]$
#检查Rancher服务器容器已经正常运行
[ec2-user@ip-172-31-30-38 ~]$ sudo docker ps
CONTAINER ID IMAGE COMMAND
CREATED STATUS PORTS
NAMES
7c41a0a1a9c7 rancher/server "/usr/bin/s6-svscan /" 3 minutes ago
Up 3 minutes 3306/tcp, 8080/tcp, 0.0.0.0:8080->8080/tcp tiny_kalam
[ec2-user@ip-172-31-30-38 ~]$
国内的服务器的下载速度可能会比较慢，需要等待大约 30 分钟左右。用浏览器打开
Rancher服务器UI 界面，并且确认是否可以正常登陆。
6
Rancher快速上手指南（虚拟机篇）
首次访问还没有配置访问权限的页面如上图所示。为了安全起见，点击上面的 Access
Control来设置一个本地账号和密码。
7
Rancher快速上手指南（虚拟机篇）
如上图，使用设置的账号和密码再次登陆确认，配置的信息正确，继续下面的测试。
还可以在命令行开启 Rancher 容器运行日志监控，如下所示：
#替换下面红字部分的 docker 容器id，你的id可以从 docker ps命令查到
[ec2-user@ip-172-31-21-99 ~]$ sudo docker logs -f 988003c02bcd
到目前，你已经完成了 Rancher服务器的部署和基础配置。
8
Rancher快速上手指南（虚拟机篇）
添加主机
主机是 Rancher 的工作节点，类似服务器虚拟化的 Hypervisor；在本实验中我们在运行
Rancher 服务器容器的管理节点上（虚拟机）做 All-in-One 的测试，因此下面把测试所用
的虚拟机添加为运行工作负载容器的工作主机。
点击登陆以后界面上的 add host 按钮。
9
Rancher快速上手指南（虚拟机篇）
1. 点击Customer，默认的选项是DigtalOcean
2. 复制文本框中的代码，在虚拟机的命令里面粘贴运行。
3. 点击Close按钮
运行以上命令之后，在命令行可以用 docker ps命令再次查看容器运行的状态，如下所示：
[ec2-user@ip-172-31-21-99 ~]$ sudo docker ps
CONTAINER ID IMAGE COMMAND
CREATED STATUS PORTS
10
Rancher快速上手指南（虚拟机篇）
NAMES
6ab206a64a68 rancher/agent:v0.8.2 "/run.sh run" 2 minutes ago
Up 2 minutes rancher-agent
988003c02bcd rancher/server "/usr/bin/s6-svscan /" 28 minutes ago
Up 28 minutes 0.0.0.0:8080->8080/tcp, 3306/tcp boring_bhaskara
[ec2-user@ip-172-31-21-99 ~]$
我们可以看到多了一个名字为 rancher/agent 的容器。过几分钟之后在回到 Web 控制台
中。查看Host 添加之后的结果。
如上图所示，我们看到了一台活动的主机，并且该主机上运行着一个容器，就是Rancher
服务器自己。
可以继续重用上面的命令，来把其他的测试虚拟机也添加为 Host，如下所示：
[ec2-user@ip-172-31-21-99 ~]$ sudo docker run -e CATTLE_AGENT_IP=X.X.X.X -d --
privileged -v /var/run/docker.sock:/var/run/docker.sock rancher/agent:v0.8.2 http://
X.X.X.X:8080/v1/scripts/6D16D7061AD34CB3D1BA:1451232000000:OZ92PjCyfQkHI7
mUDAz03pzt7r8
11
Rancher快速上手指南（虚拟机篇）
替换以上红色部分，主要是 IP 地址需要修改为运行 Rancher 服务器容器的服务器的 IP，
当然，运行此条命令的前提条件如第一节所述，与Rancher服务器的准备工作相同。
用 Web UI 运行容器
现在来通过图形界面来运行第一个容器。通过简单地几下鼠标点击即可为完成一个容器的
运行动作。
1. 点击 Add Container 按钮增加新的容器
1. 输入 first_container 作为容器的名称