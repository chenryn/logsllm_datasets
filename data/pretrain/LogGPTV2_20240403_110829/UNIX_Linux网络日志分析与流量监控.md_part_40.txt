/../ArA/cmd1.exe/c+copy+c:ArA\default.htm+d:lwwwrootindex.html50238251431www.victim.com
/scripts/./WINNT/system32/cmd.exe/c+copy+c:lwinntlsystem32\cmd.Exe+c:VArAlcmd1.exe502382524
35552231www.victim.comMozilla/4.0+(compatible;+MSIE+6.0;+Windows+XP)
Mozilla/4.0+(compatible;+MSIE+6.0;+Windows+XP)
/scripts/././ArA/cmdl.exe
/scripts/.//ArA/cmd1.exe/c+echo+"SKI****SCRIPT+KIDZ,INC
125www.victim.comMozilla/4.0+(compatible;+MSIE+6.0;+Windows+XP)
Mozilla/4.0+(compatible;+MSIE+6.0;+Windows+XP)
/scripts/..1../WINNT/system32/cmd.exe
12/03/2009 4:10 chewie.hacker.comW3SVC1 WWW-2K3 WWW-2K3.victim.com 80GET /scripts
12/03/20094:11chewie.hacker.comW3SVC1WWW-2K3WWW-2K3.victim.com80GET/index.html
12/03/20094:08chewie.hacker.comW3SVC1WWW-2K3WWW-2K3.victim.com80GET
正如服务器日志中显示的那样，整个入侵从开始到结束（4:01～4:10）仅仅持续了
r>+>+c:\ArA\default.htm50235576331www.victim.comMozilla/4.0+(compatible;+MSIE+
12/03/20094:07chewie.hacker.comW3SVC1WWW-2K3WWW-2K3.victim.com80GET
12/03/20094:05chewie.hacker.comW3SVC1
GET/scripts/./WINNT/system32/cmd.exe/c+rename+d:/wwwrootldetour.html+detour.html.old502
04/15/20094:05chewie.hacker.comW3SVC1wWW-XPWWW-XP.victim.com80
/c+rename+d:1wwwrootindex.html+index.html.old
/c+md+c:ArA\502355
WWW-2K3WWW-2K3.victim.com80GET
48831
502
355
www.victim.com
511
16
---
## Page 232
件做MD5（如果涉及商业犯罪，这些一手资料应提交给司法部门）。
首先要尽量多地备份好数据到外部存储器中。如果是司法取证还应当在第一时间对获取的文
行为。
/tmp/ps.log 保存系统的进程，以及网络连接情况。这些信息都有助于帮助你判断系统的入侵
地逐步切断该主机与网络的连接，以免有入侵者再次进入系统。保存好主机内所有日志。
机，只是暂时无响应），你的第一反应是重启计算机。这是完全错误的，首先我们应该冷静
下几种操作：
行了取证工作并获取了日志。当读者发现自己的计算机疑似中毒或者被攻击了，应该做出以
骤如下：
如果只是简单删除代码，攻击者还会卷土重来。事实上，要很好地应对网站入侵，总结步
疑难解答
病毒等，破坏手法各不相同，这样将给被害服务器造成重大的危害。
多么可怕呀！利用这种技术有时甚至还可格式化被入侵成功的服务器，或者上传后门工具、
addguest 命令到某个bat文件中：
在 Unicode 漏洞的服务器，甚至是整个局域网。他们会追加 net localgroup administrators/
10 分钟。一般的入侵者在简单更改页面后就离去，而一些技术较高的入侵者则要完全控制存
1．攻击者利用了“Web服务器文件请求解析缺陷”侵入系统，具体描述请参见CVE漏
（·隔离故障服务器（例如关掉它所在交换机的端口），迅速将备用服务器上线，保证业
当通过救援模式挂载硬盘中的文件系统，就能查看真实情况了。如果系统损毁很严重，
3）通过LiveCD光盘系统引导进入系统的文件系统
在保持好现场并中断与网络连接之后，如果终端还能够操作的话，利用 ps-aux>
2）记录当前系统的运行情况
这是最容易被忽略的动作，当你发现计算机几乎死机动弹不得时（很多情况下并没有死
服务器被入侵后，我们该做些什么？在这一案例中，已经确诊该服务器被攻破，随后进
3.
2.攻击者将文件cmd.exe复制一份并重新命名为cmdl.exe，以干扰管理员的追踪。
1）尽量维持原状，保持好现场
上面这条命令是指将Guest 用户名添加到Administrators 组里，也就是超级用户组里，
。可能大家以为只要把这些代码删除即可解决问题。但是，道高一尺，魔高一丈，
修改管理员用户名和密码，修改远程管理端口。
对故障服务器查杀病毒。
修补服务器漏洞，然后扫描网络其他设备，查看类似的其他漏洞。
找出并删除恶意代码。
日志文件中发现有删除的日志立即恢复数据，最后收集到的信息可以交网警处理。
收集故障服务器的日志，将收集的日志立即进行MD5校验，然后进行分析，如果在
务顺利开展。
netlocalgroup administrators/addguest
第7章UNIX系统防范案例209
---
## Page 233
防火墙（主机版）也有网页防篡改功能。上述都是商业软件系统。也可以选用开源的方式，
InforGuardWS 网站防篡改系统系统。另外，深信服下一代防火墙NGAF和绿盟WEB应用
全加固。
复。与防篡改系统配套，还必须部署一套Web应用弱点扫描系统设备，用于对Web网站中
数字水印产生变化时，则同步模块将会通过SFTP方式，从发布模块抓取原始文件进行恢
水印以加密方式保存到数据库中，用于对指定的网页目录和文件进行实时对比监测。当发现
同步模块）软件，根据文件的大小、日期、内容等特征信息生成文件的数字水印，并将数字
有效防护。
价格昂贵），它也不可能对HTML应用程序用户端的输入进行验证，所以无法对应用层进行
备。但传统防火墙作为访问控制设备，主要工作在OSI模型三、四层（目前有七层的，但
/home/www目录中，使用如下命令：
成相关细节信息无法重现，从而影响到对事件的判断和今后安全策略的制定。
变的。大家一定要注意，遇到系统被入侵的事件时，一定不要让你的计算机重启，否则会造
章和第14章。
定攻击者，如果有必要可以对整个系统建立一个MD5校验码，这些操作方法参见本书第
毕，开始对系统进行优化和加固处理，开启监控和审计系统，以便更好地跟踪、分析和锁
证完毕之后就要开始重构系统环境（一般情况下从系统分区这个步骤开始）。系统安装完
搞清楚状况就贸然重装系统，那样起不到任何作用。
第2章讲述了部分内容。只有查明原因才能为下次重建系统和安全规范提供依据，如果没有
SSH漏洞还是Apache漏洞使攻击者得手。分析攻击者来源时最需要技巧和经验了，在本书
我们通过刚刚备份出来的日志信息以便查出攻击者的蛛丝马迹，要搞清楚到底是因为
210UNIX/Linux网络日志分析与流量监控
基于上述防护思路可以选择一些商业的防护软件，例如 iGuard网页防篡改系统和
4.我们先了解一下网站数据备份方式：
4）通过备份出的信息分析攻击者来源
对于这种情况，解决方法是在门户网站的Web服务器上安装网页防篡改模块（也就是
果啦
例如将本地当前目录下所有文件，通过ssh 协议备份到192.168.150.20服务器下的
。这5个步骤是个参考流程，大家可以根据自己的实际情况执行，但大致方法和顺序是不
月一旦你的重要系统被入侵，你发现的问题，或许只是冰山一角。当你备份好系统并取
2）使用scp
5）重新安装系统并启用各种监控记录设备
通常，门户网站的安全防护依靠防火墙或CDN 以及核心网络部署的抗 DDoS 攻击设
#scp-p./*PI:EMAIL:/home/www
#rsync -vazu -e ssh./* PI:EMAIL: /home/www
---
## Page 234
方面的帮助，这些我们将在接下来的案例中继续解读。
由这次入侵所引起的问题。然而，就在几星期以后，这家公司却再次发现他们需要网络安全
安全问题继续困扰公司，这家公司请另一家网络安全公司来做了一次全面安全审计，以发现
法。出于安全的原因和责任追查的考虑，公司把服务器的维护权指派给了一个人。由于担心
Web服务器。虽然这并不是每次入侵后都必须做的事，但重建系统是恢复服务器的最好方
多，只不过需要更多的专业知识。
OpenVAS、w3af，还有老牌的X-scan3.1以及流光等。其实免费软件的功能和商业版差不
评估系统等，另一类是免费的产品，例如Nikto、Sandcat Scanner、Nmap、Nessus、
VulnerabilityScanner、IBMRational Appscan、HPWebInspect、WebPecker绿盟极光远程安全
整理，并实施监控系统的各项动态指标，一旦发现异常立刻进行报警并阻断。
全。例如选择一些安全厂商提供的安全审计产品，它们可以定期对系统的日志进行收集和
事件。
篡改及是否被加入WebShell之类的后门。
者加入恶意代码。同时通过检测Web访问日志及Web程序的存放目录，检测是否存在文件
支持环境和应用模块间部署方式划分的安全性进行增强。
其应用部署。从补丁、管理接口、账号权限、文件权限、通信加密、日志审核等方面对应用
题。应用程序的安全问题可能是软件生命周期的各个阶段产生的。
代码审计、架构分析等方法，全面发现Web应用本身的脆弱性及系统架构导致的安全问
特性，安全工作应该采取以下具体措施：
可以防止这次入侵，并且也可以预防类似的攻击。故目我首基息工的
everyone组用户执行WINNT/system32（或WINDOWS/system32）目录下命令的权限，就
令。在大多数这类服务器上，管理人员是需要从控制台执行这些命令的唯一用户。去除
组用户更多的特权。默认情况下everyone组有权限执行WINNT/system32目录下的任何命
号来执行这些攻击命令的。在管理Web服务器方面，系统并没有赋予这个账号比everyone
对Web服务器进行适当的配置也可以防止这次入侵。攻击者是以IUSR_Computername账
的管理员没有安装最新的ServicePack，也没有安装Hot-Fix，从而导致故障的发生。另外
防护措施
关键文件发生变化立即报警，这种实现方法将在第14章讲解。
（4）事件应急响应：提前做好应急预案及演练工作，力争以高效、合理的方式处置安全
Web系统的安全维护是一个动态调整并且不断完善和更新的过程，针对系统应用的基本
如果Web服务器上的软件保持最新版本，那么预防这次攻击就简单多了。但这台主机
优秀的Web应用安全扫描软件，大致分两类，一类是商业产品，例如AcunetixWeb
（3）Web安全状态检测：持续地检测被保护应用页面的当前状态，判断页面是否被攻击
（2）Web应用安全加固：对应用代码及其中间件、数据库、操作系统进行加固，并改善
（1）Web应用安全评估：结合应用的开发周期，通过安全扫描、人工检查、渗透测试、
针对未经安全防护的 Web 服务器，脚本小子们或许在几分钟内就能将其攻陷。很多肆
为了减轻这次入侵所造成的损害，公司决定用新版的WindowsServer2012IS重建整个
（5）选用相应的工具对系统的重要配置和应用文件进行检查和扫描，以确保系统安
第7章UNIX系统防范案例211
---
## Page 235
漏洞号，帮助用户修复问题。
对它们发起大量安全检查。当发现漏洞时，它会提供很详细的技术细节，例如各个漏洞库的
了这个工具。
的工具，Nikto是网管安全人员必备的Web审计工具之一，在BT5和OSSIM4.x系统中包含
插件可以自动更新（如果需要）。基于Whisker/libwhisker完成其底层功能。这是一款非常棒
类型、主机名、特定目录、cookle、特定CGI漏洞、返回主机允许的http模式等。扫描项和
扫描，包含超过3300种有潜在危险的文件、CGI及其他问题，它可以扫描指定主机的Web
Nikto是一款开源的（GPL）网页服务器扫描器，它可以对网页服务器进行全面的多种
Web漏洞扫描工具一
家尽早发现和修补Web安全漏洞。
虐一时的网络蠕虫都是利用了服务器软件包中的安全漏洞。下面介绍一个开源工具以帮助大
212UNIX/Linux网络日志分析与流量监控
举例，还是选用BT5工具盘：
它的工作原理是：首先抓取目标站点信息，找出所有站点中的相关文件和可输入点，并
Nikto能够输出Web 格式报告，结果也非常详细，如图7-2所示。
扫描80～90这些端口：
-0：指定输出文件。
-p:指定端口。
-h (host)：指定目标主机，可以是IP 或域名。
扫描主机：
升级漏洞库：
#./nikto.pl -h 192.168.0.1-p 80-90
#/nikto.pl-h xxxx-o result.html-Fhtm
#./nikto.pl-hwww.test.com-p804438000-oout.txt11*同时扫描多个端口
#./nikto.pl-hwww.test.com
#./nikto.pl -update
#cd/pentest/web/nikto
Nikto
*同时扫描多个连续端口
BS
个-
2M
---
## Page 236
为报告当前扫描状态。
细模式；如果按下“p”则开启进展情况报告功能，再次按下“p”则关闭此功能；按下空格
间在具体干些什么，可以按下“v”，系统便以详细模式显示过程，再按下“v”则是关闭详
不存在安全问题。
如果 nikto 找出问题，当然值得我们深究到底；但如果 nikto 什么也没找到，并不代表就
Web应用程序扫描只是漏洞扫描器的一种功能，实际上，一些通用的漏洞扫描工具如
nikto在扫描对象时，有的扫描时间比较长，屏幕长时间没有结果出来，要知道扫描期
注意：
当扫描多个IP时，有多种写法，例如 IP:端口或http:/IP:端口，具体例子如图7-3所示。
描述漏洞产生原因
统一资源标示符
漏洞库及序号
102
OSVDB Entries
Tost Links
OSVDB Entries
s
Test Links
CNikto Rep
URI
Description
SVDB Entries
scription
139218-158-28
图7-3扫描多个IP及结果
图7-2扫描报告T
h192.168.150.28:80http://192.168.150.28:80192.168.150
GET
DSVDB-561
isevetasrsra
Pa
s-dump
OB-576
status
电
第7章UNIX系统防范案例213
ctorylisting.upgradetov6.0SP1or
Comment out appropriate line
2
SiU
---
## Page 237
器上。Web 管理员给叶华提供了如下所示的微软ⅡIS 日志，以便具体说明这次事件：
器都受到了同样的攻击，而他们追踪到攻击的来源是在company.com 这个网络域中的某台服务
措施。
样一来很容易被外面用户控制。叶华气得直摇头，更让他意想不到的是没有采取适当的防护
经验，判断这次发生的首页遭到篡改是由Unicode攻击漏洞造成的。
导清楚此事。叶华在检查了遭受入侵的计算机和Web 服务器日志后，凭借多年处理故障的
了。前台把安全事件报告给经理叶华。叶华核实之后将此事件报告了公司的CTO，让上层领
经过彻底调查后，发现隐藏的问题很多，而这仅仅是冰山一角。一场危机正悄然而至。
联盟——company.com 最近面临的一个非常复杂的案件。看似一个普通的网页修改案件，但
事件背景
到了Unicode蠕虫攻击。你知道服务器是如何受到攻击的？攻击源在哪里？
起，逐步牵连出系统的错误日志，以及受到蠕虫攻击的Solaris系统。种种迹象表明，系统受
XSS攻击、CSRF攻击、缓冲区溢出、应用层DoS/DDoS攻击等。
用层漏洞非法获取或破坏网站数据，可以有效地抵御黑客的各种攻击，如SQL注入攻击、
wafw/files/)，最新版本1.2。FreeWAF是一款开源的Web应用防火墙产品，它工作在应用
12.04-server-amd64 的 FreeWAF 版本,， 大小 800MB（下载地址: http://sourceforge.net/projects/
小企业可能会希望选购一款便宜的WAF。这里向大家推荐FreeWAF，它是基于Ubuntu-
御，弥补了防火墙和IPS 系统的不足。但缺憾是价格不菲，一般单位和公司都无法承受。中
Firewall）、启明星辰WAF、安恒信息梭子鱼WAF等都能够对网站Web服务器进行深度防
题时，真正能修补漏洞将站点变得更安全的漏洞扫描软件才是最适合的。
在 PHP网站上好用的漏洞扫描软件在.NET 站点上却发挥不出来。所以，当你的站点出现问
别，不同的项目有着不同的架构，一个人用得好的扫描器，对另一个人却没多大帮助。例如
想选择最好的Web漏洞扫描工具，可能没有确切答案。为什么？现在的Web应用千差万
214UNIX/Linux网络日志分析与流量监控
层，对HTTP进行双向深层次检测，对来自Intermet的攻击进行实时防护，避免黑客利用应
这个案例讲述了一个门户网站首页被篡改的离奇事件，详细叙述了一个大型的金融服务
与此同时叶华收到了同事发来的邮件，邮件内容表明在他们公司域内的多个子站点的服务