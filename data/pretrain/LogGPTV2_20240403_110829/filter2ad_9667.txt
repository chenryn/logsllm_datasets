## 从RCE到LDAP访问

这是我的第二篇文章。欢迎随时在Twitter（[@thibeault_chenu](https://twitter.com/thibeault_chenu)）或评论中给我反馈，您的意见对我非常宝贵。

### 介绍
几个月前，我为一家法国公司进行了安全审计。该公司有一个网站，用户可以在上面浏览新闻、联系页面和下载文档。为了加载某些内容，网站会发送AJAX请求，这些请求包含两个参数。其中一个端点名为`ajax`，用于获取以HTML格式呈现的最新新闻。

### 远程代码执行
通过研究该网站的工作原理，我发现`ajax`端点允许调用任何类的任意方法。经过多次尝试使用`stdClass`类及其方法未果后，我尝试了一种新的方法：删除`class`参数并直接调用`phpinfo()`函数。这一想法成功了，那么接下来如何更有效地利用这个漏洞呢？

PHP提供了一个名为`system()`的函数，它能够执行命令并将结果返回。然而，为了实现这一点，我需要一个可以放置自定义命令的参数。我在一些页面上发现了一个名为`args`的参数，这正是我所需要的。现在，我可以执行任何UNIX命令，并进一步探索文件系统中的文件和目录。

### LDAP服务器
最引人注目的发现是配置文件中包含了数据库凭据信息。幸运的是，我还找到了一个包含20个数据库登录信息及一个LDAP服务器配置的文件。为什么会有LDAP服务器？让我们首先了解一下LDAP是什么：

1. 相比数据库，我们对LDAP服务器更感兴趣。尽管服务器上的phpMyAdmin版本只能在本地访问，但我仍然可以通过它连接并访问。
2. 轻量级目录访问协议 (LDAP, /ɛldæp/) 是一种开放且厂商中立的标准应用协议，用于通过IP网络访问和维护分布式目录信息服务。
3. 目录服务在网络应用程序开发中发挥着重要作用，因为它可以共享关于用户、系统、网络、服务和应用程序的信息。
4. 例如，目录服务可提供组织记录集，通常具有分层结构，如公司电子邮件目录。类似地，电话簿也是这样的例子。
5. 参考资料：[Wikipedia: Lightweight Directory Access Protocol](https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol)

简单来说，LDAP是一个用户目录，可用于单点登录（SSO），使用户只需一次登录即可访问多个应用程序和服务。此外，它还支持Windows会话管理。对于网站而言，LDAP的存在是为了给已认证用户提供权限设置。

为了连接到MacOS下的公司LDAP服务器，我使用了免费软件LDAPSoft。如果您知道有开源替代品，请告诉我，因为当每个用户有大约40个字段时，通过终端进行操作确实不太方便。值得注意的是，我对LDAP服务器只有读取权限，无法修改用户数据。

借助维基百科和LDAP服务器，我了解到此次安全漏洞影响到了约40,000名个人。我能访问到的信息包括但不限于：
- 姓名
- 个人电子邮件地址
- 出生日期
- 电话号码
- 密码哈希值
- RFID标签（MiFare）信息
- 用于启动Windows会话的个人目录路径

员工所持有的RFID标签用于进入公司建筑。理论上讲，如果有人购买空白RFID标签并写入从LDAP服务器获取的数据，他们就可能非法进入建筑物。这种类型的标签成本低廉且易于编程。

### 短信紧急警报系统
另外，我还发现了该公司特有的短信紧急警报系统，用于在入侵或恐怖袭击等情况下向所有员工发送警告信息。实际上，在其中一个配置文件中，我找到了SMS发送服务的API密钥。仅需简单的HTTP请求，就可以利用该密钥向整个公司的人员发送消息。

### 结论
此次渗透测试揭示了以下潜在风险：
- 获取40,000名前任或现任员工的详细信息
- 访问大约20个数据库的能力
- 利用RFID标签非法进入公司大楼的可能性
- 获取每个用户的密码哈希值，从而可能获得额外的访问权限

**已经通知了该公司有关远程代码执行漏洞的问题，并已采取措施修复。**