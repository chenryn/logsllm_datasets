title:A Dependable System Architecture for Safety-Critical Respiratory-Gated
Radiation Therapy
author:Gregory C. Sharp and
Nagarajan Kandasamy
A Dependable System Architecture for Safety-Critical
Respiratory-Gated Radiation Therapy
Gregory Sharp
Nagarajan Kandasamy
Department of Radiation Oncology
Electrical and Computer Eng. Department
Massachusetts General Hospital
Boston, MA 02114, USA
Drexel University
Philadelphia PA 19104, USA
Abstract
This experience report describes the design and im-
plementation of safety-critical software and hardware
for respiratory gating of a medical linear accelerator.
Respiratory gating refers to a radiotherapy technique
for treating cancer in the lung, liver, and abdomen,
where tumors move while a patient breathes. A com-
puter software program tracks the position of the tumor
within the human body using x-ray ﬂuoroscopy. When
the tumor is in the correct position, the linear acceler-
ator is triggered, delivering a beam of radiation toward
the target. As part of the gating system, a comprehen-
sive strategy for safety has been developed. This paper
describes these safety features, focusing on the online
monitoring techniques used to conﬁrm the proper oper-
ation of the ﬂuoroscopic imaging panels and the pattern
recognition algorithms used for tumor identiﬁcation.
1 Introduction
Radiation therapy plays an important role in the
management and treatment of cancer. The primary
treatment goal is to deliver a lethal dose of radiation
to the tumor cells, while minimizing the radiation dose
to surrounding healthy tissues and critical structures.
Modern radiation therapy equipment and procedures
can deliver radiation to regions deep within the human
body with high precision. However, radiation treat-
ment quality is degraded for tumors in the lungs and
abdomen that move during treatment. As a patient
inhales and exhales, the position of a tumor can move
up to 3 or 4 cm [5]. This motion causes a problem
for treatments because the tumor must be positioned
underneath a stationary radiation beam to receive the
prescribed dose. A failure to account for tumor mo-
tion may result in an underdose to the tumor, or an
excessive dose to surrounding healthy organs.
One of the most promising strategies for accommo-
dating tumor motion is a method known as respira-
tory gated radiation therapy [2]. Respiratory gating is
used to reduce the tumor motion during beam-on time
by limiting radiation exposure to the portion of the
breathing cycle when the tumor is in the path of the
beam. So whenever the tumor is positioned under the
beam, the beam is turned on, and when the tumor
moves away from the beam, the beam is turned oﬀ.
X-ray imaging and real-time tracking of ﬁducial mark-
ers are used to determine the position of the tumor in
real-time and control the radiation [6].
This experience report describes a dependable sys-
tem architecture for respiratory-gated radiation ther-
apy, under active development as part of the Inte-
grated Radiotherapy Imaging System (IRIS) at the
Massachusetts General Hospital (MGH) in Boston [1].
This project aims to develop a real-time imaging and
therapy system for precise tumor localization and
radiation-beam delivery during treatment. Techniques
for image tracking, dynamic targeting, and adaptive
therapy are also being developed.
Gated therapy uses a set of core software routines for
image capture and processing, 3D geometry reconstruc-
tion, and treatment delivery. To mitigate the eﬀects of
hardware and software errors on treatment quality, a
set of comprehensive safety strategies are being devel-
oped. This report discusses the following safety fea-
tures currently implemented within IRIS.
(cid:127) We use a combination of watchdog processes and
timers to monitor the IRIS application for crash
failures. The watchdog processes also control the
hardware relays that switch the radiation beam on
and oﬀ.
(cid:127) Online monitors continuously check the imaging
system and the pattern recognition algorithms for
tumor-tracking errors that can potentially aﬀect
Proceedings of the 2006 International Conference on Dependable Systems and Networks (DSN’06) 
0-7695-2607-1/06 $20.00 © 2006 IEEE 
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 12:10:36 UTC from IEEE Xplore.  Restrictions apply. 
Sensors 
Flat panel 
imager 1 
Flat panel 
imager 2 
CCD 
camera 
Gating controller
Tumor motion  
tracking 
Tumor motion 
prediction 
Image 
processing 
Online monitor 
Beam
gating
Medical  
linear 
accelerator 
Figure 1. The IRIS hardware and the functional schematic
treatment quality and patient safety. In addition,
these monitors provide feedback to the human op-
erator, who can decide to manually interrupt the
treatment.
At the time of writing, the beam gating control
software described in this report is under active de-
velopment at MGH. A functional prototype has been
completed, and has been tested on inanimate, moving
phantoms. Further development of the user interface,
formal system testing, and the design of a structured
clinical procedure are still required to bring this system
into use for patient care.
This report is organized as follows. Section 2 de-
scribes the architecture of the IRIS system and Section
3 discusses the online monitoring capabilities within
the system. We conclude the report in Section 4 with
a discussion on future work.
2 Overview of the IRIS System
This section describes the physical architecture of
the IRIS system, and describes the tumor imaging and
tracking software. We also discuss the high-level safety
requirements for IRIS that drive the design decisions
described in Section 3.
System Model. Fig. 1 shows IRIS, an integrated
radiotherapy and imaging system that has been de-
ployed at MGH since 2004 [1]. It consists of a medical
linear accelerator and two diagnostic x-ray imaging sys-
tems. Both the accelerator and the x-ray systems are
mounted on a gantry, so that imaging and treatment
can be delivered from any direction. The x-ray systems
consist of two x-ray tubes, one located on either side
of the linac head, and two ﬂat-panel area detectors, lo-
cated opposite each tube. The system was designed to
perform a variety of image-guided treatment modali-
ties, including patient set-up, cone-beam CT, and real-
time tumor tracking.
The two x-ray tubes are powered by two x-ray gener-
ators, and are controlled via a software console outside
of the treatment room. Fluoroscopy, a pulsed or con-
tinuous x-ray beam used for imaging, is delivered under
manual control by depressing a foot switch. The x-ray
imaging panels send 14-bit grayscale images back to the
control computer at data rates of up to 45 MB/second
per imager. In high resolution mode, the images have
a size of 2048 x 1536, a pixel size of 0.2 mm, and an
imaging frequency of up to 7.5 frames per second. In
low resolution mode, the images have a size of 1024 x
768, a pixel size of 0.4 mm, and imaging frequency of
up to 30 frames per second.
Tracking Application. The IRIS tracking software
is a multi-threaded custom application that runs on
the Windows 2000 Operating System. A real-time op-
erating system could not be used because of the lack of
availability and support for hardware interface drivers
and libraries. Speciﬁcally, we rely on closed-source
commercial drivers for communication with the frame
grabber boards, image panel controller boxes, x-ray
generator console interface, and the gating relay box.
Within the custom application, imaging and gating op-
erations are performed by threads running at real-time
priority. Ancillary operations that control the real-time
display, user interface, and disk I/O, run in a separate
thread at normal priority.
Algorithm 1 IRIS Software Main Loop
BEGIN LOOP
Acquire images from imaging panels 1 and 2;
Find markers in both images;
Triangulate to ﬁnd 3D position of the makers;
Monitor tracking quality;
Enable or disable treatment beam;
END LOOP
The main function of the tracking software is to con-
tinuously detect the position of a radio-opaque marker
Proceedings of the 2006 International Conference on Dependable Systems and Networks (DSN’06) 
0-7695-2607-1/06 $20.00 © 2006 IEEE 
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 12:10:36 UTC from IEEE Xplore.  Restrictions apply. 
that has been surgically implanted in or near the tu-
mor. The imaging and detection loop is described in
Algorithm 1. A single iteration of the main loop re-
quires approximately 50 ms for high resolution images
and incurs a steady-state processor load of about 40
percent. The remaining processor power is used for
real-time display and logging. The imaging loop ac-
quires images from both panels and determines the 2D
position of the marker within each image. From the 2D
coordinates, a 3D position is computed using triangu-
lation. Finally, based on the position of the marker, the
treatment beam is enabled or disabled. When the tu-
mor is positioned under the beam, the beam is turned
on, and when the tumor moves away from the beam,
the beam is turned oﬀ.
The markers themselves are usually solid gold cylin-
ders, 0.8 mm in diameter and 2 mm long. However,
other markers, stainless steel spheres, wire, or surgical
staples could be used instead. The cylindrical markers
are described via a parameterized shape model based
on the position (x, y), the length and width l, and w,
respectively, and the angle (θ) of the marker as in Fig.
2(a). These markers must be visible in x-ray images,
as shown in Fig. 2(b). For a given (l, w, θ), we gen-
erate the corresponding marker template, as shown in
Fig. 2(c), which is matched against the image using
a cross-correlation method. The position most similar
to the template is selected as the correct location, as
shown in Fig. 2(d).
IRIS Safety Requirements. The IRIS system is
being developed using commercially available medical
devices, including the linear accelerator, x-ray genera-
tors, x-ray tubes, and imaging panels. Each of these
components are independently designed to meet their
own speciﬁcations for safety and reliability. In partic-
ular, the radiation delivery devices such as the linear
accelerator and x-ray generators are designed to limit
radiation exposure in the event of either a hardware or
software fault. For example, if either the total dose or
the duration of exposure exceed a pre-speciﬁed limit,
an operator reset is required to continue with the ex-
posure.
Although a formal set of safety requirements is in-
complete at the time of writing this report, it is clear
that the use of IRIS as a gating system creates addi-
tional safety risks. We will focus on risks that are not
mitigated by the individual components. The ﬁrst risk
is that the treatment radiation may be delivered to the
wrong location. Thus, the safety implication is that
there is a tolerance on the accuracy and reliability of
geometric localization of the tumor. It also means that
there is an upper bound on the how much delay can
be tolerated, both for image acquisition and for treat-
l
w
(x,y)
θ
(a)
(c)
(b)
(d)
Figure 2. Identiﬁcation of the target position
using pattern recognition software; (a) pa-
rameters of the cylindrical marker, (b) an X-
ray image of the marker, (c) the template cor-
responding to the marker, and (d) the actual
location of the marker, as determined by the
tracking algorithm)
ment delivery. The second risk is that unacceptably
large amounts of ﬂuoroscopic imaging may be required
to complete the treatment. This suggests that there
are tolerances on the minimum duty cycle of the treat-
ment, as well as a maximum amount of imaging that
can be performed without treatment.
3 Fault Monitoring and Recovery
This section discusses online monitoring techniques
aimed at detecting hardware and software failures
within the IRIS application while achieving high fault
coverage. We also discuss possible operator-initiated
failure recovery actions.
Control-ﬂow Failures. Such failures aﬀecting the
IRIS software are detected using both watchdog timers
and processes. If such failures are suspected, the hard-
ware relays controlling the radiation beam are deacti-
vated, i.e., opened.
Watchdog timers are a simple and inexpensive
means of keeping track of proper program execution [7].
At program startup, a watchdog process starts ﬁrst,
and launches the main IRIS application. Communica-