基于能力的分析方法，对应的是样本分析。样本分析要关注样本的行为及上下文关系。
样本行为包括样本的恶意行为、驻留、子进程创建，释放文件、网络请求等。其中要注意样本中携带的信息和加解密、攻击技术、对抗技术方面的特征。这些携带的信息和特征有助于关联匹配到其他样本。
入侵过程中往往有 fake (Downloader)，有 Dropper，有
backdoor；各个阶段还会包含伪装、漏洞利用。初期拿到的样本通常只是其中一个。样本分析是事件分析的基础，只有弄清样本的上下文关系，才能理顺攻击手段。
样本分析同学以恶意软件为起点，针对技术（加解密、攻击技术、对抗技术），C2
结构和恶意软件上下文进行分析。根据恶意软件的特征匹配其他样本，扩大分析面。期望分析得到的结果：
  * 受害者的信息
  * 基础设施列表
  * 使用的技术
  * 样本的一些特征
  * 匹配到其他样本
各大厂商的 APT 报告都是以攻击者能力切入，所以看到大量篇幅都是恶意软件技术报告。
#### 通过攻击者“基础设施”切入分析
基于基础设施的分析方法是 C2 关联分析。是描述事件上下文最有效的方法。
样本中多少会暴露一些基础设施信息；或是 IP，或是域名。通过 WHOIS
信息来发现统一注册者的不同域名。进一步研究可以得到针对不同攻击者的恶意软件信息（相似/相同的基础设施）。期望分析得到的结果：
  * 与该基础设施有联系的受害者
  * 该基础设施下发\上传、命令控制等行为
  * 关联到其他基础设施
分析过程中要注意一点，样本分析和关联分析并不是独立进行的。
对恶意软件进行分析，得到其中的 C2 基础设施。通过对 C2
的关联分析，找到了同一基础设施下发的其他样本。之后再对样本进行分析……由此形成了一个循环。最后的效果，差不多是这样的：
举一个简单的例子：我们拿到初始样本 A，进行恶意软件分析，得到其中的 C2：域名 A 和域名 B，对 C2 基础设施关联分析，发现具有相同基础设施的样本
B。通过对样本 B 逆向分析，得到新的 C2 域名
C。这仅仅是一个循环，分支上就已经可以关联到许多信息。这个循环越多，找到的线索越多，最后事件分析的完整度就越高。
### 0x02-01 IoC 层级
IoC (Indicators of Compromise) 在取证领域被定义为计算机安全性被破坏的证据。在 APT
领域作用就是描述攻击者得恶意活动。分析人员对 IoC 进行识别和关联，来寻找恶意活动背后得事件和潜在得威胁。APT 分析工作都是围绕 IoC 进行的。
分析过程中遇到的 IoC 有以下几种：
  * hash
  * IP
  * 域名
  * 网络
  * 主机特征
  * 工具
  * TTPs
这些 IoC 的地位并不是相同的，其中一些指标远比其他指标更有价值。David Bianco提出了 [Pyramid of
Pain](https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html)，描述了 IoC 之间的层级关系。
  * hash：
指样本文件的哈希值。通常用于提供对特定恶意软件样本或涉及入侵的文件的唯一标识。hash 值是分析人员最容易拿到的
IoC，但是哈希值很容易改变，文件中更改一个字节，都会影响文件哈希。很多情况下不值得跟踪。
  * IP： 绝大多数恶意软件都有网络行为，其中一定会涉及 IP，但是如果攻击者使用匿名代理或者 Tor，IP 十分容易改变。
  * 域名： 域名和 IP 类似，但是域名需要注册，要付出一定的费用。因为 DNS 解析需要时间，即使使用 DNS 服务商提供的免费域名服务，但是还会有时间成本。所以，域名稍比 IP 稳定一点。
  * 网络特征： 指 C2 上，比较有区分度得特征。比如，恶意软件请求 C2 上指定路径的资源文件，如：`GET xxx[.]com/AWDA/a.exe`、`GET xxx[.]com/AWDA/get.php?fun=xx&ad=xx`，或者向指定位置上传文件：`POSTxxx[.]com/AWDA/img.php`等，`AWDA/a.exe`、`AWDA/get.php?fun=xx&ad=xx`、`AWDA/img.php` 这些就是网络特征。攻击者可能会架设多个 C2，多渠道撒布大量恶意软件。只要 C2 指令结构不变，网络特征很难改变。
  * 主机特征： 指恶意样本中，携带的攻击者主机的一些特征。这些特征不容易发现。但是对匹配其他样本、定位攻击者意义重大。后面有章节详细介绍。
  * 工具： APT 攻击中，为了达到某种目的，攻击者往往会使用、研发、定制一些工具。比如 APT 28 使用的 DealersChoice、Xagent。攻击者定制、自研一些工具，肯定要花费一定的成本。如果对攻击套件进行准确识别，攻击者只能放弃目前所使用的工具，这样无疑加大了下次攻击的成本。
  * TTP： Tactics, Techniques, and Procedures (战术、技术、过程)。是对攻击者攻击行为，战略战术层次的描述。I /域名可以更改，网络主机特征也容易消除、工具可以重新开发。但是攻击的战略战术往往很难改变，如果能识别出 TTP 特征，攻击者要么放弃攻击，要么指定新的战术。这对 actor 将是致命的打击。在 IoC 的层次结构中，由下到上获取难度依次增高，同时改变的难度和价值也是增长的。处于最顶端的是 TTP，这是最有价值和最难获取的 IoC。下面聊一聊 TTPs 提取。
## 0x03 TTPs 提取
TTP 是什么？
TTP: Tactics, Techniques, and Procedures (战术、技术、过程)
  * 战术：攻击者从信息收集开始到目的达成的攻击策略。攻击的目标、攻击目的、前期信息收集方式、对目标攻击的入口点、载荷投递方式等等都可以划分在战术指标里面。
  * 技术：为了达成攻击目的，Actor 通常在具体事件中使用各种技术。这些技术旨在突破防御，维护 C2，横向移动，获得信息、数据等。
  * 过程：要进行成功的攻击，仅仅拥有良好的战术和技术是不够的。还需要一组精心策划的战术动作来执行才可以。
### 0x03-00 TTP 提取的难点
战术、技术、过程三个词过于抽象，目前没有很好的方案对 TTP 进行实体描述。
再者就是，相关的资料过于匮乏。国外技术封锁、而国内做 APT 研究的能力性安全厂商寥寥无几。 曾从事过一段时间 APT 分析，结合钻石分析模型、Kill
chain，摸索出一种描述 TTP 的方法：特征矩阵和事件链图。
不管是 IoC、IoA、SITX 还是 ATT&CK ，目前市面上都没有成熟的方案对 TTP 进行描述，特别是 ATT&CK
，因为过度炒作，目前已经有点妖魔化。本篇不对 ATT&CK
过多探讨，可以参考阅读[《安全分析中的威胁情报（二）：ATT&CK》](https://zhuanlan.zhihu.com/p/73172883)和
[《关于ATT＆CK/APT/归因的讨论》](https://weibo.com/ttarticle/p/show?id=2309404450471736639616)以示正听。ATT&CK
对 TTP 提取的帮助，后文会进行讨论。
### 0x03-01 特征矩阵
特征矩阵是对特征的事件分析过程中，攻击者能力，基础设施，战略等方面的特征总述。
整体分为三个部分，基础设施特征、技术特征、战略特征。
  * 基础设施特征中包含 C2 列表、网络特征和样本中携带的主机特征。
  * 技术特征包含加解密技术、攻击技术和对抗技术。
  * 战略特征包含目标群体、攻击入口和载荷投递。
大体的框架如图所示，一些指标要根据实际情况进行调整：
  * 战略/战术： 包含目标群体、攻击入口和载荷投递方式和释放流程。攻击入口、载荷投递方式和释放流程可以在样本分析中进行总结。
事件四个核心元素，攻击者、受害者、能力、基础设施。上面所讲了通过能力和基础设施切入进行事件分析。此外，还可以通过受害者进行切入分析，得到攻击者的一些战略信息。例如，攻击者为了提高成功率，会贴合受害者定制一些攻击邮件或者文件，通过其中精心构造的邮件名、正文、附件内容，可以反推受害者群体，以此揣摩攻击者的战略目的。
  * 基础设施： 基础设施分为 C2、网络特征、主机特征。因为会有基础设施重用的情况，C2 列表一定要有；再者就是 URL 上面的网络特征以及样本中携带的主机特征。主机特征有很多，例如样本生成的开发/打包工具语言、配置，PDB 调试文件路径、源码路径可以看出攻击者的一些习惯；样本、签名证书的生成时间推断攻击者所在地区、如果数据量大的话，还能根据节假日、休息日推断所在国家。如果有文档类样本，还会有文档所有者、修改者这些攻击者个人信息。
  * 技术： 技术特征分为加解密、攻击技术、对抗技术、C2 技术。技术特征太多了，加密算法、使用的工具、持续部署的方案、漏洞利用、C2 通信方式、反杀软、行为隐藏……工具使用，代码重用这些情况都可能导致技术上的重叠。
以上的特征分析方法对应：
  * 战略战术 -> 受害者分析
  * 基础设施 -> 样本分析 + 关联分析
  * 技术特征 -> 样本分析