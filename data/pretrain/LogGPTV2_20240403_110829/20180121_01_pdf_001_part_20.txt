catalog publisher A slot A
流
复
logical
WAL sender receiver applyer
decoder 制
协
议
slot_name(每个订阅端有一个slog) feedback
catalog xmin (catalog 快照, 逻辑decoder依赖)
restart_lsn(幂等) 发布->订阅(一对多)
plugin(decoder)
slot_name->订阅(一对一)
confirmed_flush_lsn (feed back by 订阅端)
表->发布(多对多)
HA
• 共享存储
• 双节点异步流复制
• 三节点同步流复制
持续备份
• 基础备份 +归档
• 基础备份 +增量 +归档
• 备库 +ZFS快照 +归档
异地容灾
• 物理流复制
监控、日常维护
健康检查
• 数据库高频监控指标
• https://github.com/digoal/blog/blob/master/201806/20180613_02.md
• 系统监控指标
• https://github.com/digoal/blog/blob/master/201806/20180613_03.md
• 数据库低频监控指标
• https://github.com/digoal/blog/blob/master/201806/20180613_04.md
• AWR报告(PPAS)
– https://github.com/digoal/blog/blob/master/201606/20160628_01.md
• CLOUD DBA
– 敬请期待
健康检查
• 资源队列使用监控(HDB PG)
– https://github.com/digoal/blog/blob/master/201708/2017
0821_01.md
• 资源队列使用监控(PPAS)
– https://github.com/digoal/blog/blob/master/201801/2018
0113_01.md
• 锁等待监控
– https://github.com/digoal/blog/blob/master/201705/2017
0521_01.md
维护操作
• CANCEL QUERY
• 杀会话
• 收缩膨胀对象
• 收集统计信息
• 自动收集统计信息的参数
排错
解读错误代码
• 输出详细错误(包括代码位置)
– postgres=# set log_error_verbosity=verbose;
– SET
– 或
– postgres=# \set VERBOSITY verbose
– postgres=# select a;
– ERROR: 42703: column "a" does not exist
– LINE 1: select a;
– ^
– LOCATION: errorMissingColumn, parse_relation.c:3293
• 追踪出错源码内容，找错误原因
– parse_relation.c:3293
• 错误代码解读
– https://www.postgresql.org/docs/devel/static/errcodes-appendix.html
– https://github.com/digoal/blog/blob/master/201807/20180711_01.md
core dump
• 配置CORE文件输出
– https://github.com/digoal/blog/blob/master/201611/20161121
_01.md
– kernel.core_pattern= /data01/corefiles/core_%e_%u_%t_%s.%p
• 编译项
– -g -ggdb -fno-omit-frame-pointer
• gdb --core=xxx.corefile $postgres_绝对路径
– bt
– ...
pstack
• /proc/$pid/stack
异常、 报告
BUG
• 上报要点
– 描述清楚问题、现象。
– 描述清楚环境（操作系统、内核版本、多少位）。
– 数据库版本、涉及插件时，描述清楚插件版本。
– 复现步骤 。
• 如何上报BUG
– https://www.postgresql.org/docs/current/static/bug-reporting.html
– https://www.postgresql.org/account/submitbug/
• 开发组邮件列表
– https://lists.postgresql.org/
优化
• 见前面
基因
PostgreSQL
基因
PostgreSQL
• 需求：
• 内核开发者
– 代码质量、可塑性
• 数据库厂商
– 开源许可，开源生态，版本演进节奏（PG每年一个大版本）
• 最终用户管理员
– 垂直、水平扩展能力，稳定性、诊断工具、可靠性、安全性、性能
• 最终用户应用开发者
– SQL标准，DB端编程能力，功能，开发语言支持，框架支持，数据库扩展能力（大多
数插件是最终用户贡献的）
基因
PostgreSQL
• 特点：
• 开放式架构
– 扩展：类型、操作符、函数、索引接口、函数语言、外部数据源、数据采样、自定义WAL、存储接口、压缩算法接口...
– 例子：gis, 全文检索, 图搜索, 流计算, 推荐引擎, 点云, 路由, citus MPP DB, HLL估值, CMS-TOP估值, 图像特征搜索，列存储，
Oracle兼容包，可连接地球上所有数据源的FDW，加密类型，DB端python|r|java|perl|lua|go|cuda|opencl...存储过程、逻
辑订阅、物理订阅、9种索引接口（多值、单值、时序、空间、范围、文本、JSON等类型加速，多字段任意检索加速），
GPU加速接口(pg_strom)，数组、RANGE、平面几何、立体几何、网络、ISBN、等类型扩展，模糊、相似查询等。。。
• SQL标准
– SQL:2011
– 大多数开源数据库兼容SQL:92，相差20年。
• SQL标准扩展
– 组权限管理、INLINE CODE、异步消息、DB端编程语言扩展、DB端操作符扩展、DB端全文检索、数据聚集语法、
DB端扩展数据源。。。
• HTAP
– 支持高并发OLTP业务，同时支持CPU、IO密集型OLAP业务。
• 优化器
– JOIN（nestloop, hash, merge），多表JOIN遗传优化算法，merge sort支持并行排序和快速OFFSET，向量计算，
并行计算（排序、建索引、JOIN、扫描、FILTER、聚合、...），算子复用、计算下推（外部数据源支持下推计
算，JOIN，sort, filter, select...）
基因
PostgreSQL
• 存储
– HEAP + TOAST存储(变长字段超过1/4个BLOCK时压缩存储到切片，使得单行较小)
– 内置压缩
– 超大字段索引可以选择HASH INDEX
• 索引效率
– 记录数再多，索引扫描效率依旧平稳
– metapage->rootpage->branchpage->leafpage->HEAPpage
– 相比较而言，B+Tree结构存储引擎，记录数较多后，性能下降严重。
• 原因，
• 1. 二级索引需要扫描多棵树。全离散扫描，性能差。
• 2. 不支持hash index的话，大字段导致索引层级非常多，离散扫描的BLOCK数更加多。
• 3. 写入索引字段离散数据时，非常容易导致表内BLOCK分裂，IO放大问题严重。
基因
PostgreSQL
• NODE: • case T_MergeAppend: • case CMD_SELECT:
• case T_SeqScan: • case T_RecursiveUnion: • case CMD_INSERT:
• case T_SampleScan: • case T_BitmapAnd: • case CMD_UPDATE:
• case T_IndexScan: • case T_BitmapOr: • case CMD_DELETE:
• case T_IndexOnlyScan: • case T_NestLoop: • case T_CustomScan:
• case T_BitmapHeapScan: • case T_MergeJoin: • case T_Material:
• case T_TidScan: • case T_HashJoin: • case T_Sort:
• case T_SubqueryScan: • case T_SeqScan: • case T_Group:
• case T_FunctionScan: • case T_SampleScan: • case T_Agg:
• case T_TableFuncScan: • case T_Gather: • case AGG_PLAIN:
• case T_ValuesScan: • case T_GatherMerge: • case AGG_SORTED:
• case T_CteScan: • case T_IndexScan: • case AGG_HASHED:
• case T_NamedTuplestoreScan: • case T_IndexOnlyScan: • case AGG_MIXED:
• case T_WorkTableScan: • case T_BitmapIndexScan: • case T_WindowAgg:
• case T_ForeignScan: • case T_BitmapHeapScan: • case T_Unique:
• case T_CustomScan: • case T_TidScan: • case T_SetOp:
• case T_ModifyTable: • case T_SubqueryScan: • case SETOP_SORTED:
• case T_Result: • case T_FunctionScan: • case SETOP_HASHED:
• case T_ProjectSet: • case T_TableFuncScan: • case T_LockRows:
• case T_ModifyTable: • case T_ValuesScan: • case T_Limit:
• case CMD_INSERT: • case T_CteScan: • case T_Hash:
• case CMD_UPDATE: • case T_NamedTuplestoreScan:
• case CMD_DELETE: • case T_WorkTableScan:
• case T_Append: • case T_ForeignScan:
数据库原理
Greenplum
目录
• 产品介绍
• 生态介绍
• 应用案例
• 开发、管理实践
• 数据库原理
• 参考文档
Thanks
案例大全
数据库原理
数据库发展方向、数据库选型
问题诊断、性能分析与优化
开发技巧
备份恢复
安全、审计
DBA技巧
Thanks
https://yq.aliyun.com/articles/98539
如来神掌：
https://github.com/digoal/blog/blob/master/201706/20170601_02.md
致DBA、开发者、内核开发者、架构师：
https://github.com/digoal/blog/blob/master/201611/20161101_01.md
开发规约
• https://github.com/digoal/blog/blob/master/
201609/20160926_01.md
资料分享
• # RDS PG, HDB PG 阿里云入口
• RDS PG：https://www.aliyun.com/product/rds/postgresql
• HDB PG：https://www.aliyun.com/product/gpdb
• RDS PG 和 HDB PG产品选型指南：
https://github.com/digoal/blog/blob/master/201709/20170918_02.md
• # 阿里云RDS PG, HDB PG 产品文档
• RDS PG 产品文档：https://help.aliyun.com/document_detail/26152.html
• HDB PG 产品文档：https://help.aliyun.com/document_detail/49912.html
• RDS PG OSS 外部表文档：https://help.aliyun.com/knowledge_detail/43352.html
• HDB PG OSS 外部表文档：https://help.aliyun.com/document_detail/35457.html
资料分享
• # 图形化 实例管理
• RDS PG 图形化管理客户端pgadmin：https://www.pgadmin.org/download/
• HDB PG 图形化管理客户端pgadmin：
https://www.postgresql.org/ftp/pgadmin/pgadmin3/v1.6.3/
• # PG 开发驱动
• PG 各种开发语言客户端驱动：https://www.postgresql.org/docs/10/static/external-
interfaces.html
• PG GO语言 驱动：https://github.com/jackc/pgx
• RDS PG jdbc 驱动：https://jdbc.postgresql.org
• RDS PPAS jdbc 驱动：https://www.enterprisedb.com/advanced-downloads
• HDB PG jdbc 驱动：https://help.aliyun.com/document_detail/35428.html
• .NET PG驱动: http://www.npgsql.org/index.html
资料分享
• # 社区reference文档
• RDS PG 10 社区官方手册：
https://www.postgresql.org/docs/10/static/index.html
• RDS PG 9.4 社区官方手册：
https://www.postgresql.org/docs/9.4/static/index.html
• RDS PPAS 手册：https://www.enterprisedb.com/resources/product-
documentation
• HDB PG 社区官方手册：http://greenplum.org/docs/
• HDB PG 8.2 社区官方文档：
https://www.postgresql.org/docs/8.2/static/
资料分享
• # PG 开发指南
• Java：https://github.com/digoal/blog/blob/master/201701/20170106_05.md
• PHP：https://github.com/digoal/blog/blob/master/201701/20170106_08.md
• Ruby：https://github.com/digoal/blog/blob/master/201701/20170106_07.md
• Python：
https://github.com/digoal/blog/blob/master/201701/20170106_06.md
• C：https://github.com/digoal/blog/blob/master/201701/20170106_09.md
• # PostgreSQL 开发实践：
• http://www.postgresqltutorial.com/
• https://www.tutorialspoint.com/postgresql/index.htm
资料分享
• # GIS 相关文档
• PostGIS 文档：http://postgis.net/docs/manual-2.4/
• PostGIS 入门：http://workshops.boundlessgeo.com/postgis-intro/
• PostGIS 例子：
http://revenant.ca/www/postgis/workshop/indexing.html
• pgrouting文档：http://pgrouting.org/documentation.html
• QGIS 可视化GIS软件：http://www.qgistutorials.com/en/
• uDig 可视化GIS软件：http://udig.refractions.net/
• GIS 开源项目汇总：http://www.osgeo.org/
• ArcGIS
资料分享
• # 可视化分析软件
• Orange3 可视化分析软件：
https://orange.biolab.si/screenshots/
• https://github.com/biolab/orange3
• 拖拽式、算法可扩展
例子
资料分享
• # PostgreSQL 认证学习、考试
– https://www.enterprisedb.com/training/postgres-
certification
– 考试攻略
• https://yq.aliyun.com/articles/464038
– 推荐理由：
• 去O最热门产品
• PostgreSQL社区持续贡献的公司之一
• 阿里云合作伙伴
资料分享
• # 最佳实践
• 流式计算、在线业务、数据分析业务闭环方案：https://github.com/digoal/blog/blob/master/201707/20170728_01.md
• 流计算模块：https://www.pipelinedb.com/
• UPSERT 用法：https://github.com/digoal/blog/blob/master/201704/20170424_04.md
• HDB PG 批量更新（Upsert）方法：https://yq.aliyun.com/articles/86604
• HDB PG 连接池管理1：https://greenplum.org/docs/admin_guide/access_db/topics/pgbouncer.html
• HDB PG 连接池管理2：https://www.linkedin.com/pulse/scaling-greenplum-pgbouncer-sandeep-katta-
/?articleId=6128769027482402816
• 分页和评估（游标或PK+上一次最大位点开始）：https://github.com/digoal/blog/blob/master/201605/20160506_01.md
• HyperLogLog的使用：https://github.com/digoal/blog/blob/master/201608/20160825_02.md
• sharding 开发框架：
• https://github.com/dangdangdotcom/sharding-jdbc
• https://github.com/go-pg/sharding/
• 分析库选型测试与分析(分析数据库VS)：https://www.atatech.org/articles/90599
• RDS PG,HDB PG案例大全(开发者的《如来神掌》)：
• https://github.com/digoal/blog/blob/master/201706/20170601_02.md
• https://yq.aliyun.com/topic/118
• http://tms-preview.taobao.com/wh/tms/ali/page/markets/aliyun/yq/topic/postgresql
资料分享
• # SQL 机器学习相关
• MADlib SQL 机器学习库：http://madlib.apache.org/documentation.html
• https://pypi.python.org/pypi/pymadlib/0.1.4
• https://github.com/pivotalsoftware/PivotalR
• https://cran.r-project.org/web/packages/PivotalR/PivotalR.pdf
• https://cran.r-project.org/web/packages/PivotalR/vignettes/pivotalr.pdf
资料分享
• # 日常维护、性能诊断
• RDS PG TOP SQL 分析：https://github.com/digoal/blog/blob/master/201704/20170424_06.md
• RDS PG 自定义函数内SQL性能诊断：https://github.com/digoal/blog/blob/master/201611/20161121_02.md
• 锁等待分析：https://github.com/digoal/blog/blob/master/201705/20170521_01.md
• HDB PG 慢SQL 诊断：https://www.postgresql.org/docs/10/static/sql-explain.html
• RDS PG 慢SQL 诊断：https://www.postgresql.org/docs/8.3/static/sql-explain.html
• HDB PG 数据倾斜监测：https://github.com/digoal/blog/blob/master/201708/20170821_02.md
• HDB PG 表膨胀监测：
• https://github.com/digoal/blog/blob/master/201708/20170817_01.md
• https://github.com/digoal/blog/blob/master/201708/20170817_03.md
• HDB PG 分区键的选择：https://github.com/digoal/blog/blob/master/201607/20160719_02.md
• HDB PG 负载管理(资源队列管理)：https://github.com/digoal/blog/blob/master/201708/20170821_01.md
• RDS PPAS AWR报告：https://github.com/digoal/blog/blob/master/201606/20160628_01.md
• 阿里云RDS PG, PPAS, HDB PG日常健康监控：
• https://github.com/digoal/blog/blob/master/201709/20170913_01.md
• HDB PG 行存、列存，堆表、AO表的原理和选择：
https://github.com/digoal/blog/blob/master/201708/20170818_02.md
资料分享
• # Oracle兼容性
• https://github.com/digoal/blog/blob/master/class/21.md
• Oracle业务适合用PostgreSQL去O的一些评判标准：
• https://github.com/digoal/blog/blob/master/201707/20170713_02.md
• PostgreSQL Oracle 兼容性之- 函数、类型、多国语言映射：
https://github.com/digoal/blog/blob/master/201702/20170217_01.md
• Oracle 迁移到PG
• https://wiki.postgresql.org/wiki/Oracle_to_Postgres_Conversion
• Oracle PL/SQL 迁移到PG plpgsql
• https://www.postgresql.org/docs/10/static/plpgsql-porting.html
资料分享
• # TO 开发者、DBA、架构师 文档
• https://github.com/digoal/blog/blob/master/201611/20161101_01.md
• # 培训视频下载
• http://pan.baidu.com/s/1pKVCgHX
培训视频 文档合集
天天象上企业圆桌讨论
PG
研讨议题 PG进阶群 个人微信
转发集赞领奖品