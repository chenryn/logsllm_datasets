作者：启明星辰ADLab
#### 一、分析简述
2017年8月底，启明星辰ADLab监测到客户的一个IP地址频繁地向多个邮箱地址发送邮件同时利用弱口令方式扫描内网，经过分析确认该攻击的始作俑者为P2P银行窃密型蠕虫
---Dridex的新型变种(由于该蠕虫不同版本均有一个或多个名称，为了便于描述，本文统称为Dridex蠕虫)。Dridex也被称为Bugat/Cridex/Feodo/Emotet/
Heodo。该蠕虫通过利用其所感染的大量主机结合P2P的去中心化设计思想，构建出了一个复杂而隐蔽的用于中转流量的P2P蠕虫代理网络，不仅如此，为了隐藏那个背后控制着这一切的幽灵，该蠕虫实现上还在P2P网络与控制端服务器之间加了一层壁垒(后端C&C，见后文分析)。
Dridex蠕虫除了拥有复杂P2P控制机制外，还是一款以窃取银行账户凭证为目的，集僵尸、窃密木马、邮件蠕虫等众多功能于一体的综合性蠕虫病毒。为了更好地分析和掌握该蠕虫新变种的攻击动向，我们对其进行了长期的追踪和分析。
Dridex蠕虫的新型变种通过P2P、多层代理、快速变异、内外网双渠道感染、RSA-AES通信加密等技术变得比以往任何时候都强大。新变种除了具备以往Dridex以邮件方式传播外，还具备内网传播的功能，扩大感染面。并且为了与安全软件对抗，新变种会频繁的更新组件并且利用多种免杀打包器对其进行加密变形处理，每隔1个小时左右便会从远程进行自我更新。更新后的模块不仅加密免杀方式不同，而且编译时间、程序图标、二进制代码都会发生改变，通过不断变换加密混淆器的方式来对样本文件进行频繁更新以躲避安全软件查杀。下图是部分自我更新的变种样本：
图1-1变种样本样例
此外，通过对样本代码及通信流量的解密分析发现，当前变种Dridex几乎每个样本都会内置10个左右的C&C，其中大部分C&C只是由感染机转化而来作为代理使用，并非真实C&C。通过长时间的追踪分析，我们发现了221台这样的C&C服务器(加上无法辨识的新旧版本的C&C共有1175个，主要使用80、443、7080、8080、8081端口作为服务端口)，以及上千个受感染的主机和大量受害者的邮箱登录凭证信息。此处需要说明的是，这些作为数据回传的C&C实际上大部分并非为真正的C&C服务器，而是受Dridex感染并且被利用来作为代理节点的受害者服务器。
图1-2和图1-3是由我们根据Dridex的C&C归属地绘制的分布地图：
图1-2受害者感染地图分布
图1-3 C&C按国家或地区分布
从分布图中可以看出，该蠕虫病毒的C&C（大部分是受害者服务器）主要分布在美国、德国、法国和加拿大。虽然该蠕虫长期以欧美等国家为目标，但通过分析我们发现有很多中国区用户也受到了该蠕虫的攻击，甚至还存在有一定数量的中国区受害者服务器目前或者曾经被该蠕虫用作回传窃密信息的中转服务器。这些服务器IP地址及归属地如图1-4所示：
图1-4 部分被用作回传窃密信息的中转服务器
#### 二、Dridex蠕虫网络架构分析
该蠕虫病毒的网络架构被设计来隐藏黑客真实的C&C服务器，其呈现出四层的网络架构，其中第一层(普通感染末端)由大量的普通感染机组成，第二层为复杂P2P代理网络层，第三层为前端C&C，第四层为黑客真实的C&C据点
--后端C&C。
Dridex简单网络架构图示如下：
图2-1 Dridex网络架构图
如上图所示，第二层的代理主机实际上也是受到Dridex攻击的受感染机，Dridex利用去中心化的技术（P2P技术）来为后端C&C做掩护。Dridex一旦感染上一台主机后，会根据感染机特性(是否是服务器、是否处在公网中等条件)选取一部分感染主机作为其P2P网络的一个代理节点。这些代理节点会直接转发流量给C&C前端服务器，最后通过C&C前端将数据汇总到C&C后端服务器。
第三层的前端C&C实际上是一台由黑客成功入侵并控制的linux或者windows服务器主机，此服务器上开启了Nginx
Servers服务用来作为HTTP代理，这些代理主要以8080端口或者443端口作为代理连接口。前端C&C并不承载任何功能，其唯一的目的就是作为Dridex蠕虫P2P代理节点与后端C&C之间数据通信的中转站用于转发数据。
Dridex蠕虫的第四层(后端C&C)才是黑客实际控制端C&C服务器，其在前端代理C&C背后实现命令控制、扩展组件下发、接收回传的窃密信息等功能。
Dridex背后的黑客通过在大量感染机中选择处于外网的主机作为P2P代理节点，这些节点组成了Dridex蠕虫第二层的P2P代理网络。P2P代理网络的每台主机IP地址都是由后端C&C所管理，并且随机选择10-20个IP作为C&C列表下发给新更新的Dridex样本使用，同时也可能下发给新感染的主机使用。每个被感染的主机内存中都会存在一个Loader模块来用于收集本机信息实现上线，上线数据用于确定该感染机是服务器、处于外网的普通PC还是处于内网的普通PC等等，以此来决定该感染机的用途。之后Loader会不断轮询试探后端C&C来执行相应的功能，如下载各种窃密组件、服务组件、内网感染组件、外网感染组件等等。下载内网感染组件和外网感染组件分别用于蠕虫的内外网的自我传播。
Dridex蠕虫工作原理图如下：
图2-2 Dridex蠕虫工作原理图
此蠕虫病毒具有以下几大特点：
采用P2P方式将部分符合条件的感染机作为代理节点（伪C&C），样本的功能组件下载、恶意邮件群发、银行凭证窃取与上传、浏览器网页登录凭证窃取与上传、邮箱登录凭证窃取与上传等功能均采用不同代理点来传输。
后端C&C隐藏在P2P代理节点和前端C&C之后，难以追踪和发现真正的C&C服务器。
新型变种有极快的更新速度，在实际分析中发现频率最高的时候1个小时就更新一次，每次的样本名称、图标、采用的混淆机制、免杀机制都有较大的改变。
Dridex新变种背后的黑客拥有强大的自动化平台工具，通过自动随机选择免杀混淆壳处理更新样本下发给Loader执行。
双管齐下的内外网感染模式，一种是通过弱口令方式感染局域网主机并在远程主机上创建服务；另一种是通过从C&C下载黑客收集的大量电子邮箱登录凭证登录并向指定的大批量邮件地址发送带有Dridex恶意代码的邮件。
完整的闭环感染模式以完成自动化的扩散，如收集邮箱凭证下发给感染主机用于向目标发送恶意邮件，一旦新的接收者感染该蠕虫后，又会继续收集邮箱凭证给C&C，同时局域网感染将加速这个过程的进行。
#### 三、Dridex历史回溯
Dridex前身Cridex的最早版本于2011年9月被发现，在升级为Dridex后不断演变成多个版本的综合性蠕虫。其曾经发起过多次大规模的攻击行为，并且造成了非常严重的危害，下图我们列举了近几年来的一些关键事件。
图3-1 Dridex历史事件时间线
2014年7月，Seculert公司的安全研究员发现Dridex窃取了至少5万个邮箱的登录账号和密码信息列表，此时Dridex主要以感染德国和波兰为主，其他感染过的国家有奥地利、美国、瑞士、英国、意大利、荷兰等。
2015年5月，Dridex开始将js脚本文件作为邮件传播附件进行大面积传播，该js脚本文件用于下载Locky勒索软件执行。
2015年8月，经相关安全机构分析统计，在2015年间不到一年的时间里，Dridex已经入侵了横跨27个国家的成千上万家企业，并且已经导致英国2千万英磅(当时合3050万美元)以上的经济损失，以及美国1千万美金的经济损失。
2015年8月14日，FBI联合安全厂商捣毁了Dridex服务器并逮捕了一名Dridex幕后操控者。
2016年2月4日，Dridex发生了一次戏剧性事件，那就Dridex蠕虫病毒后端服务器疑被白帽子入侵，所有下载的模块被替换成了Avira杀毒软件。
2016年9月6日，安全研究人员发现新的Dridex变种开始用于窃取虚拟货币如比特币钱包。
2017年4月，Proofpoint研究人员观测到数百万次Dridex蠕虫攻击，其攻击手法与从前的攻击相似，同样通过邮件携带附件的形式进行疯狂的传播，只是新的攻击中添加了通过ZIP打包的vb脚本文件、PDF文件和可执行的PE文件。
2017年5月10日，Dridex蠕虫变种使用了原子注入技术发动攻击，以躲避安全产品的查杀。
2017年12月12日，前英国银行员工植入Dridex蠕虫帮助两位黑客洗钱，担任洗钱黑客的私人信托经理，利用伪造的身份证件开设了多达105个账户，汇款与转账超过250万英镑。
#### 四、Dridex演化过程分析
##### 4.1、传播渠道演变
Dridex前身Cridex的最早版本于2011年9月被发现。从最初的单纯以U盘作为传播媒介渐渐地发展为以邮件作为媒介，以office、pdf文档、js脚本作为载体进行自我传播，最后发展为以内外网双渠道传播，其中内网采用弱口令进行传播，外网仍然采用邮件进行传播。
图4-1 Dridex蠕虫传播渠道演变
##### 4.2、配置数据的演变
图4-2 Dridex蠕虫配置数据演变
Dridex与C&C通信都是通过特定的格式配置文件作为载体，从初期的版本开始这些配置文件都是经过加密传输的。之前所有版本的配置文件几乎都是以xml文件的形式存在，在我们发现的最新变种中这种长期使用的方式已被摒弃，进而直接采用纯加密二进制数据来进行传输。2011年，
Dridex主要通过动态的二进制xml文件更新C&C以及指定攻击的目标的指定；到2012年，Dridex0.77-0.80版本开始使用加密的明文xml文件作为C&C控制指令的下发并且加入web注入的功能；2014年初，Dridex1.10版本在xml配置文件中加入js脚本重定向功能；2017年，新一代的变种开始放弃xml配置文件，直接采用加密的二进制数据进行通信。
##### 4.3、功能与技术演变
Dridex蠕虫自2011年被首次发现后经历了6年的发展，其功能模块也随着网络安全大环境逐步演化。如图4-3，根据时间关系简单列出了Dridex这些年来的典型技术变化趋势。
图4-3 Dridex蠕虫功能与技术演变
2011年，Dridex蠕虫的扩散方式以USB感染为主，通过USB进行扩散。随着安全产品重点关注接入电脑中的U盘及网民安全意识的提升，USB感染方式在2012年被废弃。之后，Dridex背后的犯罪团伙开始专注于新的扩散方式和功能模块的开发，2015年Dridex携带着大量恶意功能模块卷土重来，如：VNC模块、屏幕截图模块、代理模块、中间人模块、键盘记录模块、Web注入模块。Dridex在2015年名噪一时，后经历FBI打击进入短时间沉寂，2016年Dridex利用原子注入技术绕过安全软件查杀，通过DNS缓存投毒对感染机投放钓鱼链接，并引入了更丰富的对抗模块，把安全研究人员和安全厂商的电脑信息列入黑名单，以此来躲避安全厂商和安全研究人员的分析。2017年，Dridex利用Windows默认的恢复光盘程序recdisc.exe绕过UAC，通过第三方工具窃取感染机上的凭证信息，如：浏览器密码，邮箱账号信息。最新的变种开始取消邮件传播中的附件，加入局域网感染功能，将反沙箱功能从之前宏中实现改变为了PE实现，使用加密混淆器实现快速自动化的变异，Dridex在长期演变过程中正变得越来越强大。
#### 五、典型样本剖析
我们当前所发现的Dridex变种是采用混淆免杀器进行处理，同时也将反沙箱、反调试的功能从先前的宏代码区移到了二进制PE文件中。免杀器通过两层内嵌的PE加密数据将真实的Loader代码隐藏起来。Loader由免杀器加载执行后，会收集本机信息作为上线信息向C&C服务器请求控制指令，C&C服务器会根据需要下发各种模块执行。其中，局域网感染模块通过局域网扫描将Loader作为感染实体进行传播；邮件模块会将原始带有恶意宏的office文档作为附件进行传播；窃密模块由多个具有窃密功能的模块组成，主要用于窃取邮箱登录凭证、浏览器网站登录凭证等信息。
图5-1 Dridex蠕虫模块执行图
##### 5.1、Loader分析
Loader是Dridex蠕虫的第一个二进制可执行模块，该模块是通过传播邮件附件中的office文档宏下载执行的，主要完成上线并且根据C&C配置的指令来完成扩展组件的下载与执行。这个模块实际由两层加密混淆器封装而成，这两层都是独立的PE，其中第二层加密混淆器作为加密数据存储于第一层加密混淆器的数据段部分，而实际的loader(同样也是PE)则加密存放于第二层混淆器的数据段部分。执行过程中，第二层加密混淆器和最终Loader实体都是不落地到磁盘的，直接被加载到内存中执行。
###### 5.1.1、沙箱环境检测类型
Loader的加密混淆器会通过检测沙箱环境来决定自身是否继续执行，以防止沙箱分析。如果当前环境满足如下条件，Loader的功能性代码将不会执行。
表5-1 沙箱监测条件
部分代码如下：
图5-2检测沙箱环境
###### 5.1.2、安装与驻留
当混淆加密器执行完成后，会将真实Loader可执行代码解密并加载到内存中执行，此处并不会将解密后的Loader写入到磁盘中。Loader代码执行后便会开始安装蠕虫病毒，安装后的文件名称是由受害者的主机硬件信息计算而得，在一定程度可减少被查杀的几率。首先，从内存中解密一个生成目标安装名称的字符串数组，内容如图5-3所示：
 图5-3名字表
然后，根据C盘序列号计算出2个整数作为上面字符数组的下标。最后，将这两个字符串拼接生成安装文件名。因此，安装在不同机器上的病毒文件的名称均不相同。
接下来，Loader会根据当前文件全路径计算得到一个长度为4个字节的字符串作为Event和Mutex，文件路径计算方法如图5-4所示：
图5-4 计算Event和互斥体名
例如：C:\Windows\System32\logoncrypt.exe经过计算后得到的是字符串DAB0BF1F，然后在该字符串前面加上“E”或者“M”分别作为事件和互斥体名。形如：
Event="EDAB0BF1F"  
Mutex="MDAB0BF1F"
然后，Loader会依据不同版本的目标操作系统采用两种方式进行自启动方式的设置。
如果权限允许则通过服务方式实现开机自启动，服务名称由C盘序列号计算而得。服务创建代码如图5-5所示：
图5-5 创建服务启动
如果目标主机开启了UAC而无法通过服务方式来启动，则直接向注册表的HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run键写入启动的PE文件路径，功能代码如图5-6所示。