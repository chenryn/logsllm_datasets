MatthiasRadestock，如果没有他们两位的话，就不会有关于集群和RabbitMQ内部
机制这儿个章节了。
尤其是RabbitMQ团队的JerryKuch，我们对他的感激之情无以言表。Jerry自
愿花费了无数时间来为每一章草稿进行准确的审校，包括对已完成的图书进行“官
方”技术审校。每当由于我们经验不足而需要说明和建议时，他总能在IM上快速
回复。作为RabbitMQ团队的接口人，他非常耐心且从不抱怨。如果你发现自己正
在探索未知的Rabbit操作，可能就需要感谢JerryKuch。他让本书更为出色；同时
他也是一名优秀的工程师。
我们再怎么感谢Manning初级项目编辑MariaTownsley也不为过。Maria帮助
我们按计划写作。她忍受着我们的工作安排，以及时好时坏的原稿。最重要的是，
她是我们的拥护者，并且任何对我们来说重要的资源她都努力争取。如果你满意本
书的写作风格，那就感谢Maria吧，是她指引着我们做到这一点的。同时，我们也
要感谢CynthiaKane，是她让我们完成最后儿章并付诸印刷。当我们的工作方式太
老套的时候，Cynthia以最终项目编辑的身份加入进来。她适应了我们的工作方式，
---
## Page 12
XII
致谢
并且将本书的工作当作自己从第一天起就加入进来那样看待。Cynthia就像我们的三
垒教练并护送我们回家。
最后，我们要感谢忠实的读者，他们从Manning的早期预览项目（MEAP）中
购买了本书，同时也要感谢我们的审校们：BarryAlexander、P.DavidPull、Bruce
Snyder、Tony Garnock-Jones、James Williams、Patrick Lemiuex、Bruce Lowekamp、
Carlton Gibson、Paul Grebenc、Richard Siddaway、Gordon Dickens、Gene Campbell
Karsten Strobak、Jeff Addison、David Dossot、Daniel Bretoi 和 Ben Rockwood。你们
没有报酬。但是你们把本书当作自己的孩子一样，给我们提出了详细的反馈和深思
熟虑的见解。正是由于你们的功劳，才让本书变得无比美好。谢谢你们！
Alvaro
我想要感谢我的太太Silvana，在本书的写作过程中她一直支持着我。我已经
记不得由于编写本书的原因，我们错过了多少部电影、多久没有到外面逛逛了。我
能说的只是“多谢理解”。另外，我还要感谢我的母亲一直以来对我的信任。毕竟，
编写本书是全家人的功劳。我还要感谢我在中国TheNetcircle的朋友们，在那里我
开始对Rabbit深深地着迷了，并且还一天到晚不停地打扰他们。最后，我要感谢
Jason。Manning为我引荐了这位合著者，我们最后也成了好朋友。
Jason
我要感谢我的父母和我的妹妹在整个写作过程中给予我的支持和爱。他们信任
我，并且敦促我前进。当我不想写作的时候，他们会把我推出门外到咖啡馆继续写作。
他们一直相信我能够完成本书的编写（即便这看来遥不可及）。
在和父母一起创建的初创公司里，我很荣幸能称呼父母为合伙人。作为我的合
伙人，我亏欠了他们以及DigiTar太多太多了。当写作需要插入到工作时间的时候，
他们从未抱怨过。并且给予我很大的自由度来平衡写作和工作。如果没有我们的公
司，我也不会有动力去探索Rabbit，也不会因写一些博客教程而受邀编写本书了。
DigiTar带给我许多祝福和机会，这本书就是其中之一。
最后我要感谢Alvaro。我从不知道还存在你这么一位朋友，情同手足，就像来
自另一位母亲的亲兄弟一样。谢谢你，你是我收到的最意外的祝福。
---
## Page 13
关于本书
RabbitMQ是一个开源的消息代理和队列服务器，用来通过普通协议在完全不
同的应用之间共享数据，或者简单地将作业排队以便让分布式服务器进行处理。这
无关乎项目的大小：RabbitMQ能够适应你的需要。你想要使用X编程语言来为其
中一个应用组件快速建立原型，并能确保在第二天就可将其切换到一门更高性能的
编程语言上吗？通过解耦通信协议，RabbitMQ可以帮你做到这一点。你是否需要
即时为你的社交网站处理图片上传，同时轻而易举地增加或者删除服务器？你可以
使用Rabbit队列来存放作业，并让服务器负责为你做负载均衡和作业分派。通过使
用RabbitMQ可以又快又简单地解决这类问题。本书的目的就在于向你展示如何围
绕消息通信来实现最佳架构。
编写应用程序相对简单，保障应用正常运行才是挑战的开始。别担心，本书会
讲到RabbitMQ管理、集群、安全和监控的最佳实践，因此你同样能够学习到运维
方面的知识。
最后，我们将深入介绍RabbitMQ的核心和内部细节，让你理解服务器使用的
系统资源，以便在设计系统架构的时候可以做好容量规划。同时，你将学习如何通
过安装插件和创建自己的插件来扩展服务器。将你的编辑器准备好，因为我们就要
开始用Python、PHP、Erlang、Java和C#来编程了。
路线图
第1章解释AMQP协议的起源、RabbitMQ的诞生，以及它能解决什么样的行
---
## Page 14
XIV
关于本书
业问题。下一步，你将安装服务器并创建第一个HelloWorld程序，通过RabbitMQ
来发送数据。
第2章，你将沉浸在消息通信的世界中。我们从基础概念讲起，再到如何将这
些概念映射到AMQP（该协议用于RabbitMQ）。之后，你将学习消息持久化，以及
消息的生命周期：从消息的发布开始，直到在网络的另一头进行消费。
第3章展示基本服务器管理。你将看到如何启动和停正节点、如何配置权限，
以及如何获取服务器数据统计。我们会给你一些有用的提示来为服务器做故障排除。
第4章介绍消息通信模式和最佳实践。你将学习发后即忘（fire-and-forget）模型、
RPC架构等。
第5章开启了RabbitMQ集群和高可用性设置系列，一共三章。在此，你将在
本机和物理服务器上设置RabbitMQ集群。你将学习如何升级RabbitMQ集群节点，
以及如何使用镜像队列。
第6章介绍如何使用HAProxy为RabbitMQ服务器做负载均衡。你也会学到如
何创建智能的消息通信客户端，知道如何在服务器发生故障的时候进行重连。
第7章介绍主/备服务器是如何工作的，并以此结束了高可用性系列的讨论。
你也将学习Shovel插件，它允许RabbitMQ跨越数据中心复制数据。
第8章展示如何对RabbitMQ进行管理。你将学习RabbitMQManagement插件
及其Web界面。这一章的内容不止于此，我们还将展示该插件所提供的RESTAPI
概要。
第9章与第8章相衔接，详细介绍RESTAPI。你将学到如何通过使用该API
来完成绝大多数的管理任务。为应用程序配置用户和虚拟主机提供前所未有的便利。
第10章教你如何监控RabbitMQ，包括使用Nagios检测、使用AMQP和REST
API来监控服务器的内部状态。你将学会如何通过检测问题来防患于未然。
第11章详细介绍交换器的内部工作机制（RabbitMQ使用的路由算法）。我们
将深入了解消息通信结构使用的资源细节，看看可以从架构决策中预见到什么。我
第12章将以如何通过添加新的插件来扩展RabbitMQ的行为来结束整本书。这
---
## Page 15
关于本书
XV
些插件既可以是别人编写发布的，也可以是你自己创建的。
编码规范及下载
所有源代码都以等宽字体排版（像这样fixed-widthfontiikethis），以
示区别。许多清单都伴有代码注释以突出重要的概念。在某些情况下，清单之后会
有编号项目来连接到说明。
由于RabbitMQ的最大优势之一在于将不同语言编写的应用程序胶合在一起，
因此我们同时使用Python和PHP作为示例的主要编程语言（在附录中会额外夹带
一些.NET和Java的代码）。不过，我们想让这些示例对于使用不同编程语言的读者
来说尽可能广泛地适用。由于我们不可能将每个示例都用不同的编程语言重写一遍，
因此我们将这些示例代码提交到了Github代码库，以便你也能贡献代码：https://
github.com/rabbitinaction/sourcecode。
在官方Github代码库中，你将能找到本书中最新版本的示例代码。这些代码中
的一部分已经由其他读者转换成了不同的编程语言，譬如Ruby。找不到你喜欢的编
程语言？Fork代码库，然后添加进去吧！之后发送给我们一个pullrequest，我们会
尽全力合并你的示例代码版本。（注意：你必须使用和我们的代码相同的BSD许可，
以便我们将你的变更合并进来。）
如果你喜欢本书中权威且真正“官方”的示例代码的话，可以从出版商的网站
中进行下载：http://www.manning.com/videla/。本书的最新版本中出现的具体代码总
可以在这里找到。
关于作者
AlvaroVidela是一位在基于MQ的应用方面的专业开发者和架构师。他对于
RabbitMQ的演讲足迹遍布亚洲、欧洲和美国。
JasonJ.W.Williams是DigiTar的CTO。该公司是消息通信服务供应商。从
2008年开始，他就在公司指导设计和开发工作，包括使用RabbitMQ进行实时分析
操作。
---
## Page 16
关于封面插图
夫”。封面取自19世纪中期NikolaArsenovic的一本克罗地亚传统服饰图集的复刻版，
于2003年发表于克罗地亚斯普利特的人种学博物馆。封面插图是由人种学博物馆一
位热心的图书管理员提供的。斯普利特在中世纪时是罗马帝国的核心：大概从公元
304年起，退位的帝国国王Diocletian所居住的皇宫就在这里。这本书中囊括了克罗
地亚各个地区的精美彩色插图，并对服饰和日常生活做了介绍。
鲁巴达镇是一个大约有着1200名居民的小渔村。它位于克罗地亚西海岸亚得
里亚海的科尔丘拉岛东北岸的一个小岛上。封面上的这位农夫穿着该地区典型的工
作服。这是一种没有过多修饰的简朴服装（他们通常只在周日和其他特殊场合才会
穿着正式服装）、日常工作服由打满补丁的棕色裤子、棕色背心、白色亚麻衬衫和
一顶草帽组成。他穿看简单朴素，抽看烟斗，拄着铁锹，在休息的时候等候小白兔
自投罗网。
在过去的200年中，人们的着装和生活方式都发生了巨大的改变，在当时看来
如此丰富的多样性已随时间流逝。现在，来自不同大陆的人都已难以区分，更不用
彩的个人生活而必须付出的代价吧一相应地，人们得到更加多样化和快节奏的高
科技生活。
Manning出版社用两个世纪前各地别具一格的生活方式来诠释计算机行业的诞
生与发展，用古老典籍和珍藏册把我们带回那个充满风土人情的年代。
---
## Page 17
目录
第1章天降奇兵
1.1住在别人的地下城堡
1.2救世主AMQP
1.3RabbitMQ简史
1.4百里挑-
8
1.5在UNIX系统上安装RabbitMQ
8
1.5.1为什么环境很重要
一生活在Erlang的世界里
9
1.5.2
获取安装包
9
1.5.3设置文件夹结构
1.5.4首次运行Rabbit
10
1.6总结
12
第2章理解消息通信
13
2.1消费者和生产者（这可不是经济学课程哦）
14
2.2从底部开始构造：队列.
17
2.3联合起来：交换器和绑定
22
2.4多租户模式：虚拟主机和隔离，
27
2.5我的消息去哪儿了呢？持久化和你的策略
28
2.6把所有内容结合起来：一条消息的一生
32
2.7使用发送方确认模式来确认投递
37
2.8总结
40
---
## Page 18
XVIII
目
录
第3章运行和管理Rabbit
.42
3.1服务器管理
..43
3.1.1启动节点
..4.3
3.1.2停止节点
.45
3.1.3关闭和重启应用程序：有何差别
...46
3.1.4Rabbit配置文件.
.46
3.2请求许可，
.48
3.2.1
1管理用户
..49
3.2.2
Rabbit的权限系统
..50
3.3检查
..54
3.3.1
查看数据统计
..54
3.3.2
理解RabbitMQ日志
3.4
4修复Rabbit：疑难解答
由badrpc、nodedown和其他Erlang引起的问题
..3
3.5总结
.68
第4章解决Rabbit相关问题：编码与模式
..69
4.1解耦风雨路：谁将我们推向消息通信
...70
4.1.1异步状态思维（分离请求和动作）.
4.1.2提供扩展性：没有负载均衡器的世界
4.1.3零成本API：语言不应成为锁..
.73
4.2发后即忘模型
..74
4.2.1发送告警
..75
4.2.2并行处理
4.3另
别忘了：用RabbitMQ实现RPC并等待响应
.92
4.3.1私有队列和发送确认
...93
4.3.2使用reply_to来实现简单的JSONRPC
..93
4.4总结