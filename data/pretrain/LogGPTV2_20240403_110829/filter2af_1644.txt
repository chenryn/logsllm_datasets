# 前言
本次靶场为**红队蓝军**自行搭建的一个内网域渗透靶场，以下为靶场的拓扑图。扫描下方二维码关注公众号，并回复“靶场”以获取详细信息。

内网渗透的核心在于信息搜集。在渗透过程中，细致地查看每台主机之间的关联性是确保渗透过程顺利的关键。本靶场所涉及的漏洞均为较旧版本，主要目的是记录分析一台主机上可能存在的具体漏洞类型。由于知识点繁多，我们将内容分为上下两部分进行记录。

# 外网打点

首先使用`nmap`对当前网段内的主机执行端口扫描：

```shell
nmap -sN -PE 192.168.1.0/24
```

结果显示共有四台存活主机：
- `192.168.1.9`开放了SSH服务（22端口）。
- `192.168.1.10`疑似提供Web服务（8080端口）。
- `192.168.1.11`运行MySQL数据库服务（3306端口）。
- `192.168.1.12`与`192.168.1.13`未显示出明显端口特征，但其主机名分别为`hack1`和`hack2`。

### 分析`hack1`
访问`hack1`的80端口发现它运行着PBOOTCMS系统。通过Google搜索得知该版本可能是2.0.7或2.0.9。尝试用弱密码组合`admin/admin123`登录后台成功，但代码执行失败，推测相关漏洞已被修复。

### 扫描`192.168.1.12`
进一步对`192.168.1.12`进行详细扫描后发现其开放了88端口，访问显示为EmpireCMS。再次利用弱密码`admin/admin123`进入后台。EmpireCMS 7.5及更早版本存在一个已知的安全问题：在备份数据库时未能正确验证表名，允许攻击者通过修改表名实现任意代码执行。利用此漏洞上传了一个名为`1.php.mod`的文件并成功获得WebShell。

连接至`http://192.168.1.12:88/e/admin/getshell.php`后确认webshell可用。进一步探索发现服务器基于phpStudy环境构建，分别监听了80和88端口。在根目录下找到了第一个flag，并从`config.php`中获知数据库位于另一台机器（IP地址为`192.168.1.13`）。通过蚁剑工具连接到非标准端口（3308）上的MySQL服务，最终获取第二个flag。

对于之前提到的8080端口，仅返回了"Hello World"页面。通过Wappalyzer插件识别出这是PHP 8.1版本的应用程序。利用公开资料中关于PHP 8.1的一个后门漏洞，构造特定请求获取到了第三个flag。

至此已经获得了两台主机的控制权，但在信息收集阶段并未找到MySQL或SSH的相关凭证。因此决定继续向内网深处渗透。

# 内网渗透

检查网络配置发现存在双网卡设置，其中一个指向`10.10.10.0/24`子网。为了进一步扩展访问范围，生成了一个Cobalt Strike木马上载至目标机器并启动。然而，在尝试使用PowerShell命令上线CS时遇到了无响应的问题。

接下来手动扫描了`10.10.10.0/24`子网内的活动主机及其开放端口：

```shell
portscan 10.10.10.1-255 1-1000,3389,6000-9999
```

结果发现了一台具有特殊端口7001特征的目标机器（IP: `10.10.10.10`）。通过设置流量代理绕过防火墙限制，访问到该WebLogic应用服务器。根据错误信息确定其版本为12.2.1.3，并怀疑存在CVE-2018-2894漏洞。尽管直接利用弱密码未能成功登录后台，但在先前获取的数据中发现了有效的管理员账号密码。利用这些凭据成功登录并部署了额外的恶意软件以扩大控制范围。

随后在网络配置中注意到存在一张新的网卡指向另一个私有子网。鉴于这是一个不联网环境，采用了TCP Beacon技术来维持持久化连接。这种方法特别适用于无法直接与外部通信的情况。最后，在提升权限方面遇到了一些挑战，这部分内容将在后续章节中详细介绍。