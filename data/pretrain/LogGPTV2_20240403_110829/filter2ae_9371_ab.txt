该间谍软件运行后，不但会将自身图标隐藏掉（图10），而且会激活设备管理员权限（图11）。这样，普通用户很难察觉并卸载掉它，从而达到长期驻留在受害用户设备中的目的。
图10 隐藏自身图标，防止受害用户察觉
图11 请求设备管理员权限
##### 6.2 下载执行反弹Shell以实现完全控制
当收到“reverse”命令时，间谍软件会从远程服务器
`“http://url.plus/Updates/”`下载恶意的zip文件，并在本地解压执行（见图12和图13）。经过分析我们发现，解压后的文件是一个反弹Shell，通过反向连接C&C：54.67.109.199:21070来躲过普通防火墙的检测。当攻击者成功拿到反弹的Shell后，其可以对目标手机进行Linux层面的全面控制，包括上传恶意文件、下载其感兴趣的目录、杀死手机进程、甚至破坏手机系统等恶意行为。
图12 从远程服务器下载恶意zip文件
图13 解压并本地执行恶意文件
另外，我们还在该间谍软件的3.7.3版本的lib路径下发现了适用于多平台的反弹shell库（图14）。
图14 适用于多个平台的反弹Shell
##### 6.3 安装apk文件
如果收到的命令是“install_apk”，间谍软件会从攻击者指定的地址下载apk到感染设备的外部存储器（图15），安装和执行（图16和图17）。并且，间谍软件可以任意打开攻击者指定的APP，对APP进行操作。这一功能可以实现攻击者对其他APP的恶意推广和深度控制。
图15 从攻击者指定的地址下载apk文件到感染设备的外部存储器
图16 安装下载到的apk文件
图17 打开指定APP界面
##### 6.4 回传社交APP数据文件
在收到命令“social”后，间谍软件会收集感染设备上流行社交软件的数据库文件（图18），并在其回传到远程服务器之前对其进行压缩和AES加密，目标社交APP和回传地址参见表5。攻击者得到感染用户的社交APP数据库文件后，会利用解密后的受害用户的登录凭证和社交关系数据进行更加细致深入的钓鱼和攻击，对用户造成严重威胁。
图18 收集感染设备上社交软件的数据库文件
表5 社交APP和对应的上传目录
##### 6.5 回传感染设备硬件信息
命令“info”则表示间谍软件会收集感染设备硬件相关信息（见图19），其将硬件相关信息收集好后，AES加密上传到远程服务器（见图20）。收集到的设备信息如表6所示。
图19 收集感染设备硬件相关信息
图20 AES加密硬件相关信息上传到远程服务器
表6 收集感染设备硬件相关信息
我们注意到，间谍软件上传的设备信息包括感染设备的型号和是否root信息（见图21），根据代码中多处操作需要root权限推测，攻击者会针对未root的感染设备下载对应的root组件，来对感染设备进行root，继而对感染设备实施进一步更高权限的侵害。已发现的漏洞利用负载共有3个文件，文件名分别是“poc”、“db”和“device.db”。其中，“poc”是漏洞利用的ELF文件，“db”是Sqlite3工具，“device.db”是exploit使用的数据库，包含漏洞利用程序支持的机型和对应的漏洞利用内存地址信息。目前发现该负载可利用漏洞有CVE-2013-2094、CVE-2013-2595、CVE-2013-6282、CVE-2014-3153和CVE-2015-3636（来自卡巴斯基）。
图21 判断感染设备是否root
##### 6.6 回传感染设备其他文档
如果是“filelists”命令，间谍软件就窃取感染设备sd卡目录树信息到远程服务器（见图22），当攻击者获取到感染设备的存储文件和安装APP等信息后，就可以远程指定文件名。间谍软件的文档回传服务负责回传攻击者指定的文档（图23）。
图22 窃取感染设备外部存储文件目录树
 图23 回传攻击者指定文档
##### 6.7 回传受害用户敏感信息
当收到“registro_chiamate”、“camera”、“history”等命令时，间谍软件会窃取受害用户几乎所有的敏感信息，其中包括受害用户手机上的短信内容、通讯录、通话记录、浏览器上网记录、安装的APP列表等，间谍软件甚至会利用受害用户手机进行拍照，回传照片。首先，间谍软件会将窃取到的目标敏感信息按照自定义的格式保存在自身应用的/cachel2目录下；然后，在利用统一的网络接口发送前进行AES加密并发送；最后，再对之前保存的临时文件进行删除，以防止用户察觉。图24和图25是回传通话记录的代码，其他的窃取目标和临时保存的文件名见表7。
图24 收集受害用户通话记录
图25 回传受害用户通话记录
表7 窃取目标和临时保存的文件名
##### 6.8 回传定位信息
除了窃取受害用户的主要敏感信息，该类间谍软件还会对受害用户进行GSM（移动、联通）或者CDMA（电信）基站定位和GPS定位，再将定位信息回传到远程服务器（见图26和图27），受害用户的整个行为几乎完全掌控在攻击者手中。
图26 回传感染设备基站位置信息
图27 回传感染设备GPS定位信息
#### 7、总结及建议
虽然该间谍软件目前主要针对意大利用户，但也不排除后续针对其他国家实施攻击的可能。用户除了对热门的APP下载和更新不能大意外，对系统自带的APP的更新也应保持警惕。建议用户不要轻易点击短信中的不明链接，不要安装不明来源的APP。对申请可疑权限尤其是短信读写、打电话以及需要激活设备管理器的APP要特别留意，涉及到金钱的操作要格外谨慎。遇到操作异常，应当及时使用杀毒软件查杀或找专人处理。目前，互联网上也充斥着形形色色的第三方APP下载站点，很多甚至成了恶意应用的批发集散地，提醒用户尽量从官网下载所需APP应用，在不得不从第三方站点下载软件时，要高度保持警惕，认真甄别，防止误下恶意应用给自己造成不必要的麻烦和损失。
参考链接： 
* * *
**启明星辰积极防御实验室（ADLab）**
ADLab成立于1999年，是中国安全行业最早成立的攻防技术研究实验室之一，微软MAPP计划核心成员。截止目前，ADLab通过CVE发布Windows、Linux、Unix等操作系统安全或软件漏洞近400个，持续保持国际网络安全领域一流水准。实验室研究方向涵盖操作系统与应用系统安全研究、移动智能终端安全研究、物联网智能设备安全研究、Web安全研究、工控系统安全研究、云安全研究。研究成果应用于产品核心技术研究、国家重点科技项目攻关、专业安全服务等。
* * *