判断回调地址所属驱动模块是否在白名单列表中
白名单中所存放字符串可以是文件名也可以是部分文件名，其中除了一些系统驱动模块外还包括腾讯电脑管家相关驱动，因为腾讯电脑管家驱动全部包含 QQPCMgr、Ts
和 TS 字符串，所以腾讯电脑管家的全部驱动都会被放过。白名单列表如下图所示：
 白名单列表
 检测回调所属模块文件名
删除进程回调的方法与删除映像加载回调方法类似。如果执行中无法得到进程回调函数表则向C&C服务器发送控制码 0xE，如果成功注册进程回调函数则向 C&C
服务器发送 0x11。如下图所示：
 删除进程回调
 搜索进程回调函数列表
B. 截断 attach 在系统网络驱动对象上的设备链
除了删除驱动回调外，该病毒还会通过截断 attach 到 tcpip、AFD、tdx
驱动上设备链的方式，排除网络过滤驱动对其流量劫持效果的影响。如下图所示：
截断attach的设备链
C. 清空 hosts 文件
 清除hosts
D. 清除 BHO（BrowserHelperObjects）
通过删除`\Registry\Machine\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\BrowserHelperObjects`
注册表项下的所有子项来删除所有
BHO。但当病毒发现系统中存在`\REGISTRY\MACHINE\Software\Wow6432Node\Tencent\QQPCMgr`
注册表项时，则不对 BHO 文件进行清除。如下图所示：
 删除BHO相关代码
 删除BHO注册表项
E. 重置IE代理设置
病毒通过将`\Registry\User\`当前用户`\Software\Microsoft\Windows\CurrentVersion\InternetSettings的ProxyEnable`
键值置为0的方法禁用网络代理。
F. 劫持浏览器配置
在进行对抗操作之后，病毒使用所收到的劫持网址和相关数据尝试对一些常用浏览器（IE、QQ浏览器、360安全浏览器、火狐、世界之窗）和腾讯电脑管家首页保护的配置进行修改，从而进行流量劫持。在进行劫持操作之后，会向C&C服务器发送控制码0x4。如下图所示：
劫持浏览器和腾讯管家首页保护配置
劫持浏览器代码以劫持360安全浏览器为例，如下图所示：
构造360安全浏览器相关环境字符串
最引起我们注意的是，在劫持360安全浏览器首页的同时，病毒还将渠道号设置成了
"oemxiazaiba2"，字母组成的后半部分为"下载吧"全拼，但由于可以获取到的信息十分有限，我们暂时无法求证其与"下载吧"是否存在直接关系。如下图所示：
劫持360安全浏览器首页代码
G. 劫持腾讯电脑管家首页保护网址
病毒除了会篡改浏览器配置外，还会通过添加自定义保护网址（自定义网址相关注册表项均为 3rd 开头）的方式，劫持腾讯电脑管家首页保护网址。如下图所示：
修改腾讯电脑管家首页保护注册表项
2) 控制码 0x3，获取远程驱动模块
与上文（一）病毒加载器中病毒所使用的方法相似，只不过病毒这次用来加载的驱动模块数据是通过C&C服务器获取的，大致执行过程相同，其具体的驱动执行过程不再赘述。如下图所示：
 加载远程驱动模块
虚拟加载驱动并执行入口点
3) 控制码0xA，获取远程驱动模块
执行远程驱动模块代码部分，是通过注入 winlogon.exe 进程实现的，注入部分使用了开源的 BlackBone 项目代码。如下图所示：
 请求远程动态库
病毒会先将获取到的动态库数据是放到 system32 目录下，之后再调用 BlackBone 代码将动态库注入到 winlogon 进程中执行。如下图所示：
 注入 winlogon
 注入 winlogon
 病毒中的
BlackBone 项目相关代码
**(三) 其他劫持和对抗手段**
1) 通过进程回调和映像加载回调劫持浏览器启动参数
除了上述介绍的病毒所使用的劫持方法外，病毒还通过注册进程回调和映像加载回调劫持浏览器启动参数进行流量劫持。如下图所示：
 病毒注册回调
病毒在进程回调中会判断浏览器种类，针对不同的浏览器劫持的网址链接可以有所不同，在检测到需要进行劫持的进程后，将相关的劫持信息添加到劫持列表中。如下图所示：
 劫持浏览器进程检测
在进程回调中记录劫持进程信息后，在映像加载回调中将 PEB 中的进程参数篡改为欲劫持网址。如下图所示：
 劫持进程参数
2) 通过映像加载回调拦截驱动加载
除了用于进行流量劫持的映像加载回调外，病毒还注册了一个用来进行内核对抗的映像加载回调，该回调函数不但会阻止带有安全软件签名信息的驱动执行，还会拦截一些内核级流量劫持类病毒的执行。当所加载的驱动信息在黑名单中，病毒会将映像的入口点代码替换为直接返回，从而禁止执行该映像中的逻辑代码。如下图所示：
禁止执行安全软件驱动逻辑
在判断正在加载的映像是否属于黑名单时，病毒先常见的内核级流量劫持病毒的文件名进行匹配，如果文件名中包含 Mslmedia.sys 或者
mssafel.sys
则会禁止其执行。之后，病毒会获取当前映像的签名信息与黑名单中的签名信息进行匹配，如果包含则也会禁止其执行。黑名单中的签名信息包括：火绒、360、金山、2345、瑞星、百度，甚至还包括
ADSafe
的签名和病毒常用"上海域联"签名信息，但是其中依然没有腾讯电脑管家相关签名信息，由此我们可以推断病毒对腾讯电脑管家是有意进行放过的，并非无意之举。签名信息黑名单信息，如下图所示：
 签名黑名单
如上图，除了主流安全软件的签名外，还包括有"上海域联"的签名信息。该签名虽然已经过期，但是不会影响驱动正常加载，所以经常被病毒程序盗用，去年大面积爆发的"小马激活病毒"也是盗用了"上海域联"的签名。相关代码如下图所示：
 判断是否属于黑名单
检测签名信息是否在黑名单中
由于很多内核级流量劫持类病毒都使用 VMProtect 壳进行保护，所以病毒作者还加入了一个更加暴力的判断方法，如果节名为 `UPX0` 或者
`.vmp0` 则禁止驱动逻辑执行。如下图所示：
 检测节名
#### 三、附录
文中涉及样本SHA256：
[附PDF版报告下载地址](http://down4.huorong.cn/doc/pengex.pdf)
* * *