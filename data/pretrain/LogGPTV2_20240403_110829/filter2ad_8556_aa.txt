Author: 安天  
链接：
# 1 概述
安天安全研究与应急处理中心（Antiy
CERT）于北京时间2017年6月27日21时许关注到乌克兰银行等相关机构、政府首脑计算机遭到计算机病毒攻击的相关信息。综合各方威胁情报后，初步判断受影响最严重的国家是乌克兰（副总理Pavlo
Rozenko、国家储蓄银行（Oschadbank）、Privatbank等银行、国家邮政（UkrPoshta）、国家电信、市政地铁、乌克兰首都基辅的鲍里斯波尔机场、电力公司KyivEnergo），其他部分国家均受到不同程度的影响，包括俄罗斯（俄罗斯石油公司（Rosneft））、西班牙、法国、英国、丹麦、印度、美国（律师事务所DLA
Piper）等国家。
鉴于受到攻击目标的特殊性，为避免国内关键信息基础设施受到关联影响，安天决定启动A级安全风险预警进行应对，经数小时分析研判后，该病毒的传播方式有较大风险，但鉴于该病毒初始投放具有较强地域性特点，同时我国在“魔窟”（WannaCry）应急工作中打下了良好基础，现阶段该病毒尚未在我国大面积传播，建议将事件降为B级。
不同于传统勒索软件加密文件的行为，“必加”（Petya）是一个采用磁盘加密方式，进行敲诈。其早期版本只对MBR和磁盘分配表进行加密，并谎称全盘加密。其目前版本是否能完成全盘加密，安天分析小组尚在验证之中。
鉴于初始爆发地区的地缘敏感性、具备一定强度的扩散能力和所处的特殊攻击时点，安天目前认为这次事件不能完全排除是单纯经济目的的恶意代码攻击事件，亦不能直接判断是针对特定地区的定向攻击。我国在“魔窟”（WannaCry）应急工作中打下了良好基础，现阶段该病毒尚未在我国大面积传播，但其复合的传播手段具有较大安全风险。
安天同时提醒客户：鉴于样本会利用本机口令尝试登录其他计算机进行传播，因此进行包括口令强度在内的系统安全配置加固和及时的系统补丁策略，才可以较好的防御本病毒。安天此前就魔窟蠕虫所发布的免疫工具，对本病毒依然有效。
# 2 传播机理
在汇集了多方威胁情报后，样本间直接的关系仍不明确的情况下，经过对部分关键样本文件的跟进分析发现，这次攻击是勒索病毒“必加”（Petya）的新变种。该变种疑似采用了邮件、下载器和蠕虫的组合传播方式。从推理分析来看，该病毒采用CVE-2017-0199漏洞的RTF格式附件进行邮件投放，之后释放Downloader来获取病毒母体，形成初始扩散节点，之后通过MS17-010（永恒之蓝）漏洞和系统弱口令进行传播。同时初步分析其可能具有感染域控制器后提取域内机器口令的能力。因此其对内网具有一定的穿透能力，对内网安全总体上比此前受到广泛关注的魔窟（WannaCry）有更大的威胁，而多种传播手段组合的模式必将成为勒索软件传播的常态模式。
# 3 勒索模块分析
勒索模块是一个DLL文件，该文件被加载后遍历用户磁盘文件（除C:\Windows目录下），并对指定后缀名的文件进行加密，加密后不修改原文件名和扩展名。该文件修改MBR，同时，添加计划任务，在等待一段时间后，关闭计算机。当用户开启计算机时，会显示勒索界面和信息并无法进入系统。
## 3.1 样本标签
表 2 ‑ 1 二进制可执行文件
 **病毒名称** Trojan[Ransom]/Win32.Petya **MD5**
[71b6a493388e7d0b40c83ce903bc6b04](https://www.virustotal.com/intelligence/search/?query=027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745#md5)
**处理器架构** X86-32 **文件大小** 269.5 KB (275968 字节) **文件格式**
BinExecute/Microsoft.DLL[:X86] **时间戳** 2017年06月26日 16:49:11+01:00 **数字签名** 有
**加壳类型** 无 **编译语言** Microsoft Visual C++ **VT**** 首次上传时间** 2017年06月27日
**VT**** 检测结果** 38 / 61 
##
### 3.2.1 权限提升与内容加载
样本加载后，尝试提升自己所拥有的权限。所要求的权限为以下几种。
表 2 ‑ 2 样本所提升的权限
 **权限名称** **权限内容** SeShutdownPrivilege 关闭计算机的权限 SeDebugPrivilege
修改和调试其他用户进程内存的权限 SeTcbPrivilege 与操作系统内核等同的权限 
接下来，样本会遍历进程列表，查询特定的进程是否存在。并将自身文件内容读入内存后删除该文件。该样本还具有多种加载方式。例如使用WMI加载。
图 2 ‑ 1 使用WMI加载样本的命令
### 3.2.2 修改MBR
样本在加载后具有修改磁盘分区表的行为。通过DeviceIOControl来获取磁盘信息后，向第一块物理磁盘中写入显示勒索信息的代码。
图 2 ‑ 2 修改MBR的代码
该样本添加计划任务后，关闭计算机，当用户重新启动计算机后，计算机在伪造的CHKDSK界面后会显示勒索信息界面。
图 2 ‑ 3 CHKDSK界面
图 2 ‑ 4 被加密后的勒索信界面
### 3.2.3 计划任务创建
样本会将“关机” 这一操作，以命令行的方式添加到计划任务中。使系统在一段时间后强制关机。
图 2 ‑ 5 添加计划任务的代码
### 3.2.4 加密
该样本使用了微软的加密库进行加密。所使用的加密算法为RSA+AES(Microsoft Enhanced RSA and AES Cryptographic
Provider)。