–  intercepts%incoming%TCP%packets%then%forward%to%worker%DLL%
Worker&DLL&
with&conﬁg
the&rootkit&driver
(DKOM&used,&names/paths&nullﬁed)
NDIS_OPEN_BLOCK
IRP_MJ_DEVICE_CONTROL
ReceiveNetBuﬀerLists and 
ProtSendNetBuﬀerListsComplete
NDIS_PROTOCOL_BLOCK
BindAdapterHandlerEx and 
NetPnPEventHandler
\\Device\\Null
Client
Malware&
(0) install hooks
(1) send
packet
(2) save TCP & 
special format
packets
install hooks again
everytime net conﬁg 
changes
packet
buﬀers
TCPIP protocol handlers
(3) read & write
 to user buﬀer
dword 1
dword 2 dword 3
dword 4
dword2 !=0 && dword4 == (dword1 ^ dword3) << 0x10 
The packet header
18%
Related%Attack%Tools%
• 
bootkit%found%by%Kaspersky%when%tracking%Winnti%activity%[9]%
• 
“skeleton%key”%to%%patch%on%a%victim's%AD%domain%controllers%[10]%
• 
custom%password%dump%tool%(exe%or%dll)%
–  Some%samples%are%protected%by%VMProtect%or%unique%xor%or%AES%
–  the%same%API%hash%calculation%algorithm%used%(function%name%=%“main_exp”)%
• 
PE%loader%
–  decrypt%and%run%a%ﬁle%speciﬁed%by%the%command%line%argument%
•  *((_BYTE%*)buf_for_cmdline_ﬁle%+%oﬀset)%^=%7%*%oﬀset%+%90;%
19%
Getting%Target%Information%from%
Winnti%Samples%
%from%Kaspersky%blog%[11]%
20%
Two%Sources%about%the%Targets%
•  campaign%ID%from%conﬁguration%data%
–  target%organization/country%name%
•  stolen%certiﬁcate%from%rootkit%drivers%
–  already-compromised%target%name%
•  I%checked%over%170%Winnti%samples%%
–  Which%industry%is%targeted%by%the%actor,%except%game%
and%pharma%ones?%
21%
Extraction%Strategy%
• 
regularly%collect%samples%from%VT/Symc%by%using%detection%name%or%yara%
rules%
• 
try%to%crack%the%DES%password%if%the%sample%is%dropper%component%
–  or%just%decrypt%the%conﬁg%if%possible%
• 
run%conﬁg/worker%decoder%for%service/worker%components%
–  campaign%IDs%are%included%in%worker%rather%than%service%
• 
extract%drivers%from%worker%components%then%check%the%certiﬁcates%
• 
exclude%the%following%information%
–  not%identiﬁable%campaign%ID%(e.g.,%“a1031066”,%“taka1100”)%
–  already-known%information%by%public%blogs/papers%
22%
Extraction%Strategy%(Cont.)%
•  automation%
–  conﬁg/worker%decoder%(stand-alone)%
•  decrypt%conﬁg%data%and%worker%component%if%detected%
•  additionally%decrypt%for%PlugX%loader%or%SMTP%worker%variants%%
–  dropper%password%brute%force%script%(IDAPython%or%stand-alone)%
campaign%ID%
23%
Extraction%Strategy%(Cont.)%
•  double-check%campaign%IDs%by%using%VT%submission%metadata%
–  the%company%has%its%HQ%or%branch%oﬃce%in%the%submitted%country/
city?%
•  e.g.,%the%ID%means%2%possible%companies%in%diﬀerent%industries%
–  The%submission%city%helps%to%identify%the%company%
VT%submission%metadata%
decrypted%conﬁg%
24%
Result%about%Campaign%ID%
•  only%27%%%samples%contained%conﬁgs%!%
–  Most%of%them%are%service%components%
•  service%components%usually%contains%just%path%information%
–  diﬃcult%to%collect%dropper/worker%components%by%
detection%name%
•  Yara%retro-hunt%can%search%samples%within%only%3%weeks%%
•  19%unique%campaign%IDs%found%
–  12%IDs%were%identiﬁable%and%not%open%
25%
Result%about%Campaign%ID%(Cont.)%
1st%seen%year%
from%VT%metadata%
submission%country%/%city%
from%VT%metadata%
Industry%%
2014%
Russia%/%Moscow%
Internet%Information%Provider?%(typo)%
2015%
China%/%Shenzhen%
University?%(not%sure)%
2015%
South%Korea%/%Seongnam-si% Game%
2015%
South%Korea%/%Seongnam-si% Game%
2015%
South%Korea%/%Seongnam-si% Game%
2016%
Japan%/%Chiyoda%
Chemicals%
2016%
Vietnam%/%Hanoi%
Internet%Information%Provider,%E-
commerce,%Game%
2016%
South%Korea%/%Seoul%
Investment%Management%Firm%
2016%
South%Korea%/%Seongnam-si% Anti-Virus%Software%
2016%
USA%/%Bellevue%
Game%
2016%
Australia%/%Adelaide%
IT,%Electronics%
2016%
USA%/%Milpitas%
Telecommunications%
26%
Result%about%Certiﬁcate%
•  12%unique%certiﬁcates%found%but%most%of%them%are%known%in%
[1]%[12]%
•  4%certiﬁcates%are%not%open%
–  One%of%them%is%signed%by%an%electronics%company%in%Taiwan%
–  The%others%are%certiﬁcates%of%chinese%companies%
•  "Guangxi%Nanning%Shengtai'an%E-Business%Development%CO.LTD",%
"BEIJING%KUNLUN%ONLINE%NETWORK%TECH%CO.,LTD",%"优
传责"%
–  I’m%not%sure%if%they%were%stolen%or%not%
•  One%is%a%primary%distributor%of%unwanted%software?%[13]%
27%
Wrap-up%
%
%
28%
Wrap-up%
•  Winnti%malware%is%polymorphic,%but%
–  The%variants%and%tools%have%common%codes%
•  e.g.,%conﬁg/binary%encryption,%API%hash%calculation%
–  Some%driver%implementations%are%identical%or%similar%to%Derusbi’s%ones%
•  Today%Winnti%threat%actor(s?)%targets%at%chemical,%e-commerce,%
investment%management%ﬁrm,%electronics%and%
telecommunications%companies%
–  Game%companies%are%still%targeted%
•  Symantec%telemetry%shows%they%are%just%a%little%bit%of%targets%!%
29%
Reference 
1. 
http://kasperskycontenthub.com/wp-content/uploads/sites/43/vlpdfs/winnti-more-than-just-a-
game-130410.pdf%
2. 
https://www.novetta.com/wp-content/uploads/2015/04/novetta_winntianalysis.pdf%
3. 
http://blog.csdn.net/lishuhuakai/article/details/27852009%
4. 
http://www.codeproject.com/Articles/28806/SMTP-Client%
5. 
https://en.mail.qq.com/ 
6. 
http://blog.vsec.com.vn/apt/initial-winnti-analysis-against-vietnam-game-company.html%
7. 
https://assets.documentcloud.org/documents/2084641/crowdstrike-deep-panda-report.pdf%
8. 
https://www.novetta.com/wp-content/uploads/2014/11/Derusbi.pdf%
9. 
https://securelist.com/analysis/publications/72275/i-am-hdroot-part-1/%
10. 
https://www.symantec.com/connect/blogs/backdoorwinnti-attackers-have-skeleton-their-closet%
11. 
https://securelist.com/blog/incidents/70991/games-are-over/%
12. 
http://blog.airbuscybersecurity.com/post/2015/11/Newcomers-in-the-Derusbi-family%
13. 
https://www.herdprotect.com/signer-guangxi-nanning-shengtaian-e-business-development-
coltd-1eb0f4d821e239ba81b3d10e61b7615b.aspx 
30%