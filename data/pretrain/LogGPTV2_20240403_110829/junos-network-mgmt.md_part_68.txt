1 command. If the output does not display the intended configuration, repeat the configuration
instructions in this example to correct it.
For brevity, this show command output includes only the configuration that is relevant to this example.
Any other configuration on the system has been replaced with ellipses (...).
{primary:node0}[edit]
user@host# show chassis cluster redundancy-group 1
ip-monitoring {
global-weight 100;
global-threshold 200;
family {
inet {
10.1.1.10 {
weight 100;
interface reth1.0 secondary-ip-address 10.1.1.101;
}
}
}
}
If you are done configuring the device, enter commit from configuration mode.
Verification
IN THIS SECTION
Verifying the Status of Monitored IP Addresses for a Redundancy Group | 829
Verifying the Status of Monitored IP Addresses for a Redundancy Group
Purpose
Verify the status of monitored IP addresses for a redundancy group.
830
Action
From operational mode, enter the show chassis cluster ip-monitoring status command. For information
about a specific group, enter the show chassis cluster ip-monitoring status redundancy-group command.
{primary:node0}
user@host> show chassis cluster ip-monitoring status
node0:
--------------------------------------------------------------------------
Redundancy group: 1
Global threshold: 200
Current threshold: -120
IP address Status Failure count Reason Weight
10.1.1.10 reachable 0 n/a 100
10.1.1.101 reachable 0 n/a 100
node1:
--------------------------------------------------------------------------
Redundancy group: 1
Global threshold: 200
Current threshold: -120
IP address Status Failure count Reason Weight
10.1.1.10 reachable 0 n/a 100
10.1.1.101 reachable 0 n/a 100
831
CHAPTER 9
sFlow Monitoring Technology
IN THIS CHAPTER
sFlow Technology Overview | 831
sFlow Support on Switches | 832
Example: Configure sFlow for EVPN-VXLAN Networks | 839
sFlow Support on Routers | 845
Example: Configure sFlow Technology to Monitor Network Traffic | 849
sFlow Agent Address Assignment | 857
sFlow Technology Overview
IN THIS SECTION
Benefits of sFlow Technology | 832
The sFlow technology is a monitoring technology for high-speed switched or routed networks. sFlow
monitoring technology collects samples of network packets and sends them in a UDP datagram to a
monitoring station called a collector. You can configure sFlow technology on a device to monitor traffic
continuously at wire speed on all interfaces simultaneously. You must enable sFlow monitoring on each
interface individually; you cannot globally enable sFlow monitoring on all interfaces with a single
configuration statement. Junos OS supports the sFlow technology standard described in RFC 3176,
InMon Corporation's sFlow: A Method for Monitoring Traffic in Switched and Routed Networks (see
http://faqs.org/rfcs/rfc3176.html).
sFlow technology implements the following two sampling mechanisms:
• Packet-based sampling—Samples one packet out of a specified number of packets from an interface
enabled for sFlow technology. Only the first 128 bytes of each packet are sent to the collector. Data
collected include the Ethernet, IP, and transport layer headers, along with other application-level
832
headers (if present). Although this type of sampling might not capture infrequent packet flows, the
majority of flows are reported over time, allowing the collector to generate a reasonably accurate
representation of network activity. You configure packet-based sampling when you specify a sample
rate.
• Time-based sampling—Samples interface statistics (counters) at a specified interval from an interface
enabled for sFlow technology. Statistics such as Ethernet interface errors are captured. You configure
time-based sampling when you specify a polling interval.
Interface statistics are the source of time-based sampling. Time-based sampling provides statistical
data in the output of the show interface statistics command. If you clear the interface statistics using
the command clear interfaces statistics, time-based sampling displays the reset values.
Benefits of sFlow Technology
• sFlow can be used by software tools like a network analyzer to continuously monitor tens of
thousands of switch or router ports simultaneously.
• Because sFlow uses network sampling (forwarding one packet from n number of total packets) for
analysis, it is not resource intensive (for example processing, memory and more). The sampling is
done at the hardware application-specific integrated circuits (ASICs) and, hence, it is simple and more
accurate.
sFlow Support on Switches
IN THIS SECTION
sFlow for IP-over-IP Tunnels | 834
sFLow for QFabric System | 834
sFlow for EVPN-VXLAN | 835
sFlow Limitations on Switches | 838
sFlow technology on the switches samples only raw packet headers. A raw Ethernet packet is the
complete Layer 2 network frame.
An sFlow monitoring system consists of an sFlow agent embedded in the device (switch) and up to four
external collectors. The sFlow agent's two main activities are random sampling and statistics gathering.
The sFlow agent performs packet sampling and gathers interface statistics, and then combines the
833
information into UDP datagrams that are sent to the sFlow collectors. An sFlow collector can be
connected to the switch through the management network or data network. The software forwarding
infrastructure daemon (SFID) on the switch looks up the next-hop address for the specified collector IP
address to determine whether the collector is reachable by way of the management network or data
network.
Each datagram contains the following information:
• The IP address of the sFlow agent
• The number of samples
• The interface through which the packets entered the agent
• The interface through which the packets exited the agent
• The source and destination interface for the packets
• The source and destination VLAN for the packets
You can view the Extended router data and Extended switch data headers on collector as part of sFlow
records.
The Extended switch data contains information of Flow data length (byte), Incoming 802.1Q VLAN,
Incoming 802.1p priority, Outgoing 802.1Q VLAN, and Outgoing 802.1p priority fields
The Extended router data contains information of Flow data length (byte), Next hop, Next hop source
mask, and Next hop destination mask fields.
EX Series switches adopt the distributed sFlow architecture. The sFlow agent has two separate sampling
entities that are associated with each Packet Forwarding Engine. These sampling entities are known as
subagents. Each subagent has a unique ID that is used by the collector to identify the data source. A
subagent has its own independent state and forwards its own sample packets to the sFlow agent. The
sFlow agent is responsible for packaging the samples into datagrams and sending them to the sFlow
collector. Because sampling is distributed across subagents, the protocol overhead associated with
sFlow technology is significantly reduced at the collector.
For the EX9200 switch and MX Series routers, we recommend that you configure the same sample rate
for all the ports in a line card. If you configure different sample rates, the lowest value is used for all
ports on the line card.
In case of dual VLANs, all fields may not be reported.
If the primary-role assignment changes in a Virtual Chassis setup, sFlow technology continues to
function.
834
sFlow for IP-over-IP Tunnels
Starting in Junos OS Release 20.4R1, you can use sFlow technology to sample IP-over-IP traffic at a
physical port on QFX5100 and QFX5200 devices. This feature is supported for IP-over-IP tunnels with
an IPv4 outer header that carry IPv4 or IPv6 traffic. Use sFlow monitoring technology to randomly
sample network packets from IP-over-IP tunnels and send the samples to a destination collector for
monitoring. Devices that act as a IP-over-IP tunnel entry point, transit device, or tunnel endpoint
support sFlow sampling. No Link Title shows the fields that are reported when a packet is sampled at the
ingress or egress interface of a device that acts as an IP-over-IP tunnel entry point, transit device, or
tunnel endpoint.
Table 82: Supported Metadata
sFlow Field Tunnel Entry Point Transit Device Tunnel Endpoint
Raw packet header Includes payload only Includes payload and Egress: Includes payload
tunnel header only
Ingress: Includes payload
and tunnel header
Input interface Incoming IFD SNMP index Incoming IFD SNMP Incoming IFD SNMP
index index
Output interface Outgoing IFD SNMP Outgoing IFD SNMP Outgoing IFD SNMP
index index index
sFLow for QFabric System
On a QFabric system, sFlow technology monitors the interfaces on each Node device as a group, and
implements the binary backoff algorithm based on the traffic on that group of interfaces.
On the QFabric system, the following default values are used if the optional parameters are not
configured:
• Agent ID is the management IP address of the default partition.
• Source IP is the management IP address of the default partition.
In addition, the QFabric system subagent ID (which is included in the sFlow datagrams) is the ID of the
Node group from which the datagram is sent to the collector.
On a QFabric system, the sFlow technology architecture is distributed. The global sFlow technology
configuration defined on the QFabric system Director device is distributed to Node groups that have
sFlow sampling configured on their interfaces. The sFlow agent has a separate sampling entity, known as
835
a subagent, running on each Node device. Each subagent has its own independent state and forwards its
own sample information (datagrams) directly to the sFlow collectors.
On the QFabric system, an sFlow collector must be reachable through the data network. Because each
Node device has all routes stored in the default routing instance, the collector IP address should be
included in the default routing instance to ensure the collector’s reachability from the Node device.
Regardless of the rate of traffic or the configured sampling interval, a datagram is sent whenever its size
reaches the maximum Ethernet transmission unit (MTU) of 1500 bytes, or whenever a 250-ms timer
expires, whichever occurs first. The timer ensures that a collector receives regularly sampled data.
Packet-based sampling in sFlow is implemented in the hardware. If traffic levels are unusually high, the
hardware generates more samples than it can handle, and the extra samples are dropped, producing
inaccurate results. Enabling the disable-sw-rate-limiter statement disables the software rate-limiting
algorithm and allows the hardware sampling rate to stay within the maximum sampling rate.
sFlow for EVPN-VXLAN
On QFX10000 Series switches you can use sFlow technology to sample known multicast traffic carried
over EVPN-VXLAN. Sampling of known multicast traffic is supported for traffic that enters the switch
over EVPN-VXLAN or in other words core facing interface and egresses the switch out of customer-
facing ports. Also, known multicast traffic sampling is supported only in the egress direction. To enable
egress sFlow sampling of known multicast traffic on a customer facing port, you need to enable sFlow
on the interface in the egress direction as it is done for the standard unicast traffic sampling scenario. In
addition, you need to include the egress-multicast enable option at the [edit forwarding options sflow]
hierarchy level. The maximum replication rate for multicast traffic samples can be configured using the
eggress-multicast max-replication-rate rate option at the [edit forwarding options sflow eggress-multicast]
hierarchy level.
When a set of sFlow egress sampling enabled interfaces are subscribed to a given multicast group and
egress sFlow multicast sampling option is enabled, all the interfaces will be sampled at the same rate.
The minimum of the configured sFlow rate, or in other words, the most aggressive sampling rate among
this set of interfaces is used for sampling across all the interfaces in the set. A single port will generate
samples at different rates if it is part of multiple multicast groups, as multicast sampling for a specific
group depends on the most aggressive sampling rate among the ports of that particular group.
On EVPN-VXLAN, the centrally-routed bridging (CRB) and Edge-routed bridging (ERB) architecture are
supported with sFlow. EVPN-VXLAN supports only IPv4 address.
836
Table 83: Supported Metadata
Incoming Interface Outgoing Interface Required Sampled Forwarding Metadata
and Encapsulation and Encapsulation Content Scenario
Access port Layer 2 Network port Incoming Layer 2 Packets are Incoming Interface
traffic header + Layer 2 encapsulated with Index or Identifier.
payload VXLAN header and Outgoing Interface
forwarded. Index or Identifier
Network port Layer Access port Incoming Layer 3 Packets are de- Incoming Virtual
3 traffic header + VXLAN capsulated and Tunnel End Point
header + Inner forwarded. (VTEP) Interface
payload Index or Identifier.
Outgoing Interface
Index or Identifier
Access port Layer 2 Network port Incoming Layer 2 Packets are Incoming Interface
traffic Header + Layer 2 encapsulated with Index or Identifier.
payload VXLAN header and Outgoing Interface
forwarded. Index or Identifier
Network port Layer Access port Inner payload Packets are de- Incoming VTEP
3 traffic capsulated and Interface Index or
forwarded. Identifier. Outgoing
Interface Index or
Identifier
No Link Title provides Metadata information for extended switch data and extended routing data.
837
Table 84: Supported Metadata for Extended Switch Data and Extended Routing Data
EVPN- Scenar Traffic sFlow VXLA Extended Switch Data Exten
VXLA io Type Interfa N ded
N ce Tunnel Routin
Side Type g Data
IIF IIF OIF OIF NH IP NH NH
VLAN VLAN VLAN VLAN SMAS DMAS
Priorit Priorit K K
y y
CRB Layer Layer Ingres Encap Yes Yes No No Yes Yes Yes
2 GW 2 s
Leaf
Decap No No Yes No No No No
Egress Encap Yes No No No Yes Yes Yes
Decap No No Yes No No No No
Layer Layer Ingres No No No No No No No No
3 GW 2 s
Spine
No No No No No No No No
Transit No No No No Yes Yes Yes
Egress No No No No No No No No
No No No No No No No No
Transit No No No No Yes Yes Yes
Layer Ingres Encap No No No No Yes Yes Yes
3 s
Traffic
Decap No No No No Yes Yes Yes
(Inter
Vlan
Transit No No No No Yes Yes Yes
Case)
Egress Encap No No No No Yes Yes Yes
Decap No No No No Yes Yes Yes
838
Table 84: Supported Metadata for Extended Switch Data and Extended Routing Data (Continued)
EVPN- Scenar Traffic sFlow VXLA Extended Switch Data Exten
VXLA io Type Interfa N ded
N ce Tunnel Routin
Side Type g Data
IIF IIF OIF OIF NH IP NH NH
VLAN VLAN VLAN VLAN SMAS DMAS
Priorit Priorit K K
y y
Transit No No No No Yes Yes Yes
ERB Layer Layer Ingres Encap Yes Yes No No Yes Yes Yes
2+Lay 2 s
er 3
Decap No No Yes No No No No
Egress Encap Yes No No No Yes No Yes
Decap No No Yes No No No No
Layer Ingres Encap Yes Yes No No Yes Yes Yes
3 s
Traffic
Decap No No Yes No No No No
(Inter
VLAN
Egress Encap Yes No No No Yes Yes Yes
Case)
Decap No No Yes No No No No
sFlow Limitations on Switches
On switches, limitations of sFlow traffic sampling include the following:
• The EX3400, EX4100, EX4300, EX4400, and QFX5K series switches use pseudo-egress sampling for
egress sampling. Packets are not true egress samples. They are unmodified copies as they appear in
the ingress pipeline of the sflow instance device that is using egress sampling.
• On QFX5130-32CD and QFX5700 devices, the egress sFlow uses the ingress pipeline packet, unlike
other QFX series devices that use original source and destination IP addresses. The sampled packets
at the egress interface show the VXLAN header with the ingress VXLAN’s source and destination IP
addresses.
839
The egress sampled packets for the QFX5130-32CD and QFX5700 devices show the IP addresses of
the VXLAN endpoints from the preceding VXLAN tunnel. The command show interfaces vtep extensive
displays that the sampled packets are routed through the VXLAN VTEP interface. This is not true
egress sampling.
• On EX9200 switches, true OIF (outgoing interface) is not supported with sFlow.
EX9200 switches support configuration of only one sampling rate (inclusive of ingress and egress rates)
on an FPC (or line card). To support compatibility with the sFlow configuration of other Juniper
Networks products, EX9200 switches still accept multiple rate configuration on different interfaces of
the same FPC. However, the switch programs the lowest rate as the sampling rate for all the interfaces
of that FPC. The (show sflow interfaces) command displays the configured rate and the actual (effective)
rate. However, different rates on different FPCs is still supported on EX9200 switches.
Example: Configure sFlow for EVPN-VXLAN Networks
IN THIS SECTION
Requirements | 839
Overview and Topology | 840
Configuration | 841
Verification | 843
Use this example to configure and use sFlow monitoring for EVPN-VXLAN traffic with an IPv4 underlay
on QFX10000 line of switches.
Requirements
This example uses the following hardware and software components:
• A QFX10002-60C, QFX10002, QFX10008, or QFX10016 switch.
• Junos OS Release 21.3R1, 21.2R2 and later.
This example assumes that you already have an EVPN-VXLAN with an IPv4 underlay based network and
want to enable sFlow monitoring on a QFX10000 switch.
840
Overview and Topology
IN THIS SECTION
Topology | 840
In this example, you enable sFlow inspection for an existing and working EVPN-VXLAN network traffic
with IPv4 underlay.
Topology
Figure 31 on page 841 depicts the sFlow support in an EVPN-VXLAN network environment with an
IPv4 underlay. In this topology, the sFlow agent performs packet sampling and gathers interface
statistics, and then combines the information into UDP datagrams that are sent to sFlow collectors. You
can connect an sFlow collector to the switch through the management network or data network. The
sFlow program on the switch looks up the next-hop address for the specified collector IP address to
determine whether the collector is reachable by way of the management network or data network.
You should configure sFlow on the physical port of your hardware switch and logical interface where the
VTEPs (virtual port) are configured and not on VTEPs itself. When you configure sFlow on fabric facing
interface, the underlay traffic along with VXLAN traffic is sampled. You can configure sFlow on any of
the R0, R1, or R2 devices mentioned in the topology.
For information about basic EVPN-VXLAN underaly configuration, refer to Example: Configuring a
QFX10000 Switch as a Layer 3 VXLAN Gateway in an EVPN-VXLAN Centrally-Routed Bridging Overlay.
841
Figure 31: sFlow Support on EVPN-VXLAN Network
Configuration
IN THIS SECTION
CLI Quick Configuration | 841
Step-by-Step Procedure | 842
Results | 843
Use the following steps to configure sFlow technology on your QFX10000 switch with EVPN-VXLAN
network:
CLI Quick Configuration
To quickly configure this example on your QFX10000 switch, copy the following commands, paste them
into a text file, remove any line breaks, change any details necessary to match your network
configuration, and then copy and paste the commands into the CLI at the [edit] hierarchy level.
[edit protocols sflow]
set polling-interval 20
set sample-rate ingress 10
set source-ip 10.1.12.0
set collector 10.102.70.200set interfaces et-0/0/1.1 sample-rate ingress 100 egress 100
842
Step-by-Step Procedure
To configure sFlow technology:
1. Specify in seconds how often the sFlow agent polls the interface:
[edit protocols sflow]
user@switch# set polling-interval 0
2. Specify the rate at which ingress packets must be sampled:
[edit protocols sflow]
user@switch# set sample-rate ingress 100
3. Configure the source IP address:
[edit protocols sflow]
user@switch# set source-ip 10.1.12.0
4. Configure the IP address of the collector:
[edit protocols sflow]
user@switch# set collector 192.168.200.100