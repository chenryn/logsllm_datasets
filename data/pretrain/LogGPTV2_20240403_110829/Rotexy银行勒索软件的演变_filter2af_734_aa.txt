# Rotexy银行勒索软件的演变

##### 译文声明
本文为翻译文章，原作者为securelist，来源为securelist.com。译文仅供参考，具体内容及含义以原文为准。

## 概述
Rotexy家族的移动木马在2018年8月至10月期间针对俄罗斯用户发起了超过70,000次攻击。该银行特洛伊木马的独特之处在于能够接收来自三个不同来源的指令：
1. Google Cloud Messaging (GCM) 服务：通过Google服务器将JSON格式的信息发送到移动设备；
2. 恶意C&C服务器；
3. 远程控制短信。

这种多功能性从Rotexy的最初版本就存在，并一直被沿用。研究表明，Rotexy是由2014年10月首次发现的短信间谍软件发展而来。当时它被检测为Trojan-Spy.AndroidOS.SmsThief，后来变更为Trojan-Banker.AndroidOS.Rotexy。

当前版本的Rotexy结合了银行特洛伊木马和勒索软件的功能。它通过诸如youla9d6h.tk、prodam8n9.tk、prodamfkz.ml、avitoe0ys.tk等网站传播恶意载荷，这些载荷通常命名为AvitoPay.apk或其他类似名称。这些域名是根据特定算法生成的：前几个字母暗示热门分类广告服务，接着是随机字符串，最后是两个字母的顶级域名。

在详细介绍最新版本的Rotexy及其独特功能之前，我们先简要回顾一下自2014年以来该家族木马的演变过程。

## Rotexy的演变过程

### 2014-2015年
自2014年首次检测到该家族的恶意程序以来，其主要功能和传播方法基本保持不变：通过钓鱼短信中的恶意链接进行载荷投递，提示用户安装应用程序。启动时，它会请求设备管理员权限，并与恶意C&C服务器通信。DEX文件中的典型类型列表如下：

直到2015年中期，Rotexy使用纯文本JSON格式与其C&C进行通信。C&C地址在代码中以明文显示，未进行加密。某些版本的代码中会动态生成低级域名作为C&C地址。

一旦安装，该木马会将受感染设备的IMEI信息发送到C&C服务器，随后通过短信接收一套规则（包括电话号码、关键字和正则表达式），用于识别来自银行、支付系统和移动网络运营商的短信。例如，该木马可以根据短信内容自动回复并立即将其删除。

接下来，Rotexy将受害者手机的信息（如型号、号码、移动网络运营商名称、操作系统版本和IMEI）发送给C&C。每次请求时，它会生成一个新的子域名进行通信，生成算法硬编码在代码中。

Rotexy还在Google云消息传递服务中注册，可以通过该服务接收命令。命令列表多年来几乎没有变化，具体命令将在后文详细说明。

木马的assets文件夹包含一个名为data.db的文件，其中包含PAGE命令的User-Agent字段的可能值列表。如果未能从C&C获取该字段的值，则使用伪随机算法从data.db中选择。

### 2015-2016年
从2015年年中开始，Rotexy木马开始使用AES算法加密受感染设备与C&C之间的通信数据。数据通过POST请求发送到格式为“/[number]”的相对地址（伪随机生成的数字，范围为0-9999）。

从2016年1月起，一些样本实现了从资源文件夹中解压加密DEX文件的算法。但在此版本中，未使用动态生成最低级域名的方法。

### 2016年
从2016年中期开始，攻击者重新开始使用动态生成最低级域名的方法。年末，出现了包含在assets/www文件夹中的card.html网络钓鱼页面，旨在窃取用户的银行卡详细信息。

### 2017-2018年
从2017年初开始，钓鱼页面bank.html、update.html和extortionist.html出现在assets文件夹中。此外，在某些版本的特洛伊木马中，文件名是随机字符串。

2018年，Rotexy的新版本出现了一次性域名，由随机字符串和数字组成，一级域名为.cf、.ga、.gq、.ml或.tk。此时，Rotexy也开始积极使用各种混淆方法，例如DEX文件包含垃圾字符串的简单and/or操作，并包含用于从APK解密可执行文件的密钥。

## 最新版本分析
以下是对SHA256: ba4beb97f5d4ba33162f769f43ec8e7d1ae501acdade792a4a577cd6449e1a84样本的分析。

### 应用程序启动
Rotexy通过短信传播，短信包含应用程序下载链接和引人注目的文本，促使用户点击链接并下载应用程序。有时，这些消息是从朋友的电话号码发送的，使受害者毫无防备地点击链接。

感染设备后，Rotexy会检查是否在仿真环境中运行以及所在国家/地区。如果检测到在仿真器中运行，它会无限循环初始化。日志记录为俄语，包含语法和拼写错误。

如果检查成功，Rotexy将向GCM注册并启动SuperService，以跟踪特洛伊木马是否具有设备管理员权限。如果没有获得管理员权限，SuperService会每秒检查一次并重新启动，直到获得权限。获得权限后，木马会隐藏图标并显示页面。

如果用户试图撤销管理员权限，木马会立即关闭屏幕，阻止用户操作。如果成功撤销权限，木马会重新请求权限。如果无法关闭屏幕，木马会威胁用户。

运行时，Rotexy会跟踪以下内容：
1. 手机的开关和重启；
2. 特洛伊木马的终止和重启；
3. 发送短信时将手机切换到静音模式。

### C&C通讯
默认的C&C地址硬编码在Rotexy代码中。木马以伪随机方式生成从设备发送信息的地址，并将有关C&C服务器的信息和从受感染设备收集的数据存储在本地SQLite数据库中。

首先，特洛伊木马在管理面板中注册，并从C&C接收操作所需的信息（SMS拦截模板和HTML页面上显示的文本）。Rotexy拦截所有传入的短信，并根据从C&C收到的模板处理它们。当短信到达时，木马会将手机置于静音模式并关闭屏幕，以便用户不会注意到新短信已到达。需要时，木马会将短信发送到指定的电话号码，并使用截获的消息中的信息。如果未收到处理传入短信的规则，木马会将所有短信保存到本地数据库并上传到C&C。

除了设备的一般信息外，木马还会将所有正在运行的进程和已安装的应用程序列表发送给C&C。

Rotexy收到相应命令后会执行以下操作：
- **START, STOP, RESTART**：启动、停止、重启SuperService。
- **URL**：更新C&C地址。
- **MESSAGE**：将包含指定文本的短信发送到指定的号码。

通过以上分析，我们可以看到Rotexy不断进化，采用多种技术来增强其隐蔽性和功能性，使其成为一种高度复杂的移动恶意软件。