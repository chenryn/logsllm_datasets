16
第一条命令是uptime：
到的基本度量标准。在排除系统运行缓慢的问题时，通常我执行的
这个例子中，你能看到服务器在过去的1分钟内负载为2，但是在
能力的4倍，所以 3/4的进程都在等待资源。一个系统的平均负载
如果单CPU系统的平均负载是4，那么这个系统处于它可承受负载
在使用CPU，要幺正在等待使用CPU；不可打扰状态的进程都在等
2.1
大量工具确定问题的起因。
决方法就是—重启。不过，如果能登录到系统之中，则可以借助
负载会让你对系统当前所处的状态有一个清晰的认识，所以在前面
平均值，这些值在确定系统当前状态时非常有用。1分钟内的平均
CPU系统与负载状态为4的四CPU系统使用资源的量一样。
也就是说，系统处于50%的负载状态。所以，负载状态为1的单
的系统的平均负载是1，那么其中一个CPU一直处于满负荷状态
不会因为你所拥有的CPU数量而更改，所以，如果具备两个CPU
于处于运行或者不可打扰状态进程的平均数。可运行的进程要幺正
分钟、5分钟和15分钟内机器的平均负载。一个系统的平均负载等
过度使用这些资源的任何一种都会让系统陷入困境，此时唯一的解
主要资源包括CPU、RAM、磁盘I/O以及网络（将在第5章介绍）。
待I/O响应。
第2章服务器为什么这么慢？耗尽了CPU、RAM和磁盘I/O资源
平均负载为1的单CPU系统意味着这个CPU处于恒定负载
1分钟、5分钟、15分钟的平均负载描述了相对时间内负载的
load average后面的3个数字2.03、20.17和15.09分别代表了
解决引起系统运行缓慢的问题时，平均系统负载可能是最先用
13:35:03 up 103 days,8 min, 5 users, load average: 2.03, 20.17,15.09
$uptime
系统负载
---
## Page 24
而且5分钟前系统负载又开始增长，但是现在已经减弱。让我们将
它与一个完全不同的平均负载做个对比。
值是15。由此可知，机器在过去的15分钟内处于高负载的状态，
过去的5分钟内平均负载却飙升到了 20。前15分钟内，负载平均
0资源的进程）非常重要。
使用的RAM被移入了交换区）还是I/O密集型（争夺磁盘或网络I/
CPU密集型（等待CPU资源的进程）、RAM密集型（尤其是，频繁
动进程的平均数量，所以负载的飙升透露了很多信息。明确负载是
什么是高平均负载
还是正在下降。
使用 top 命令，马上我就会讲到这个工具）来观察负载是持续上升
在最近。在这种情况下，通常我会连续运行多次 uptime 命令（或者
1分钟内的平均负载却很高，所以我知道负载的飙升相对而言发生
它们的磁盘I/O完全饱和了。用尽RAM 资源的系统通常与I/O密集
的IO密集型系统，只是登录这些系统就需要花费一段时间，因为
降下来。
者更高，它们在竞争系统资源。随着这些进程逐渐完成，负载就会
“这取决于产生高负载的原因”。因为负载描述了正在使用资源的活
障排除工具而且具有良好的响应时间。我也见过I/O负载相对较低
见过数以百计CPU密集型的系统，我仍然可以在这些系统上运行故
步线程，这些线程会同时启动，你可能会看到负载飙升到20、40或
通常CPU密集型的系统会比I/O 密集型的系统响应度更高。我
例如，如果运行的一个应用程序在不同的时间点产生大量的同
一个值得研究的问题是：平均负载多少算高？简单的回答是
在这个例子中，5分钟内和15分钟内的平均负载都很低，但是
$uptime
2.1
系统负载17
---
## Page 25
18
·第2章服务器为什么这么慢？耗尽了CPU、RAM和磁盘I/O资源
上。top命令默认排序方式是按照进程的CPU使用情况从上到下排序，
后还包含系统的进程列表以及它们占用的资源数量。使用top命令可
系统信息（见图2-1)。这些数据都会不断更新，所以你能看到系统的
令。在命令行输人 top 命令并按下Enter键后，马上就能看到大量的
2.2使用top命令解决负载问题
就会消耗磁盘资源，导致进程逐渐变慢直至停止。
型的系统表现相同，因为一旦系统开始使用磁盘上的交换存储，它
所以可以一眼就能看到哪些进程正在消耗CPU资源。
能无法看到系统当前运行的所有进程，因为无法将它们都显示在屏幕
程正在运行、总共有多少内存、使用了多少内存、还剩多少内存，最
实时信息，
当需要解决高负载问题的时候，我第一个想到的工具是top 命
PID USER
23
00
00
包括系统启动了多久、负载平均值、
.0%0
PRNI
22020201202020220202202202020202022
图2-1 top命令的标准输出
UIRT
157
1124
RES
SHRS2CPUMEM
98.4%id
slee
0:00.
:0
QOBO
TIME+
0.0zhi
00
00
8
00
80
00
、系统中总共有多少进
00
2
00
75
8
COMMAND
ksuspe
sui-dsrapers
top
net
init
ACPI
Ppea
0.0%S
---
## Page 26
输人如下命令：
制在退出top 命令之前，刷新信息多少次。例如，想看到完整的输
输出，或者想将这些信息都重定向到文件中，那么你可以在批处理
示在屏幕外的信息，那一切都还好。如果想要看到top 命令的完整
将会终止于 signal-15时，按下Enter 键即可。
需按下K按键，然后输人想要终止的PID，最后当系统提示该进程
进程，该怎么做呢？top 命令输出的第一列是PID，它代表程序的
清楚了这个问题，就可以尝试检查到底是哪些进程大量消耗了这些
2.2.1
你可以使用便捷的命令行工具tee:
出，仅需运行一次top 命令，输入如下命令：
模式下运行这个命令。-b 选项可以开启批处理模式，-n 选项可以控
输出，借此明确耗尽了哪些资源（CPU、RAM还是磁盘IO)。一旦
进程ID一
资源。首先，检查系统中 top 命令的标准输出：
默认情况下 top 命令在非交互式模式下运行，如果不需要看显
使用top 命令来排除系统负载问题时，基本步骤是检查top 的
如果想要将这些信息存储到名为 top_output 的文件中，那么请
那么如果发现一个进程占用了全部CPU资源，你想要终止这个
如果想要查看 top 命令的输出，同时将该输出写人文件，那么
$top-b-n1>top_output
$ top-b-n1|tee top_output
$top-b-n1
top -14:08:25 up 38 days， 8:02, 1 user, load average: 1.70,1.77, 1.68
Swap: 1004052k total,
Tasks:107 total,
了解top 命令的输出
1024176k total，
一系统赋给每个进程的唯一ID。想要终止某个进程，只
3running,104 sleeping,
997408k used,
4360k used,
999692k free,
26768k free,
2.2使用top命令解决负载问题·19
.7%wa,0.0%hi, 0.0%si,0.0%st
0 stopped，
286040k cached
85520k buffers
0zombie
---
## Page 27
比。当你解决运行缓慢的系统问题的时候，这是一个非常有价值的
就可以确定问题的原因不是高CPU负载。
的空闲时间比。如果系统运行缓慢，但是这个指标特别高，那么你
CPU时间的百分比。
准。例如，Cpu(s)这一行提供了当前 CPU运行情况的信息：
以我将它们都列在下面：
系统负载并不大。
正如你在这个例子中看到的，对于这台拥有4个CPU的机器来说，
"nicing",
第2章服务器为什么这么慢？耗尽了CPU、RAM和磁盘I/O资源
wa：I/0等待
这是你希望具备很高数值的度量指标中的一个。它代表了CPU
这个数字代表了CPU时间用在等待执行I/O操作所占的百分
sy：系统CPU 时间
如果你不清楚这些缩写代表什么，那么它们对你毫无意义，所
id：CPU空闲时间
如果更改过一些进程的优先级，这个指标能够告诉你它们所占
ni:优雅CPU时间
运行内核和内核进程所占CPU时间的百分比。
运行非优雅的用户进程所占CPU时间的百分比（优雅，英文
us：用户CPU时间
不过除了标准的系统负载，top 命令还为你提供了额外的度量标
top 命令输出的第一行与你之前见到的uptime 命令的输出一致
Cpu(s):11.4%us,29.6%sy，0.0%ni，58.3%id，0.7%wa，0.0%hi，0.0%si，0.0%st
22442nagios
24636nagios
18749nagios
9463
PID USER
”，是指一个进程允许你根据其他进程更改优先级）。
3mysq1
24
16
PR
L
NIVIRTRESSHRS%CPU%MEM
0604820241452S
0 3466010m
0140m134m1868
0686m111m3328S
1712
S
53
12
80.1
5.5
6.6
569:17.64
1345:01
0:00.04check_time.p1
1195:15
TIME+
nagios
nagios2db_status
mysqld
COMMAND
---
## Page 28
程。如果发现用户时间百分比高但I/O等待时间百分比却很低，很
CPU时间百分比高引起的高负载问题。这很常见，因为服务器上
确定是什么原因导致了这么高的用户时间百分比。如果I/O等待时
这一点我马上就会讲到。如果I/O等待和CPU空闲时间百分比都很
那么可以看看CPU空闲时间百分比；如果I/O等待时间很高，那么
待时间，它可以用来排除磁盘I/O的问题。如果I/O等待时间很低，
个运行缓慢的系统的时候，首先要观察的度量指标之一就是I/O等
与机器具备4个CPU、系统负载为1.70的指标相匹配。当你处理一
络I/O的问题。
度量指标，因为如果这个数值很低，那么就能轻松排除磁盘或者网
的服务很可能会占系统负载的绝大部分，而且这些服务都是用户进
2.2.2
查询缓慢的问题等。
味着应该查看网络问题或者Web服务器的问题，或者查看MySQL
行缓慢不是CPU资源的原因，而应该从别的地方找原因。这可能意
间所占百分比很低，而空闲时间百分比很高，那么你就知道系统运
低，那么很可能会看到一个非常高的用户时间百分比，所以你必须
下一步就是确定是什么因素导致I/O等待时间所占的比重这么高，
的其他任务所占CPU时间的百分比。
在前面的例子中，你可以看到系统有超过50%的空闲时间，这
解决故障的过程中一个常见而又相对简单的问题是，由用户
口hi：硬件中断
口st：流逝的时间
si：软件中断
CPU用于处理硬件中断所占时间的百分比。
如果你正在运行虚拟机，这个度量指标会告诉你虚拟机中执行
CPU用在处理软件中断所占时间的百分比。
解决高用户时间的问题
2.2使用top命令解决负载问题·21
---