### Man-in-the-Middle (MITM) Attack on Routers for Cryptojacking

In the attack described in this paper, adversaries compromised the routers' operating systems and reconfigured them to intercept and modify HTTP requests from clients. This resulted in a man-in-the-middle (MITM) attack, where requests to any website were rewritten and redirected to an internal HTTP proxy server running on the compromised router.

**Figure 1: MITM Attack on Routers for Cryptojacking**
- **Description**: Through a MITM attack on routers, adversaries performed cryptojacking on websites visited by users.

**Example of Injected Script:**
```html
<script src="http://www.facebook.com/"></script>
<script>
    var miner = new CoinHive.Anonymous('', {throttle: 0.1});
    miner.start(CoinHive.FORCE_EXCLUSIVE_TAB);
</script>
```

**Figure 2: HTML Returned by the Proxy of an Infected Router**
- **Description**: The HTML returned by the proxy of an infected router includes a Coinhive miner and the actual page in an iframe.
- **Content**:
  ```html
  <iframe src="http://www.facebook.com/"></iframe>
  <script>
      var miner = new CoinHive.Anonymous('', {throttle: 0.1});
      miner.start(CoinHive.FORCE_EXCLUSIVE_TAB);
  </script>
  ```

### Technical Details of the Attack

1. **Compromise and Reconfiguration**:
   - Adversaries exploited the router's operating system.
   - They reconfigured the system to redirect all HTTP requests (port 80) to an internal proxy port (e.g., 8080).
   - The proxy server served a web page that included a JavaScript-based cryptomining code (Coinhive) and an iframe containing the original requested content.

2. **Firewall and Network Configuration**:
   - The attackers modified the firewall rules to open telnet and SSH ports if they were not already exposed.
   - A rule was added to redirect outgoing HTTP traffic (port 80) to the proxy port (e.g., 8080).

3. **Client-Side Behavior**:
   - The client’s browser would fetch two resources: 
     - An outer frame with a JavaScript that loaded the cryptomining code.
     - An inner iframe that displayed the actual website the user intended to visit.
   - The browser would establish a WebSocket connection to a mining pool or a WebSocket proxy to receive instructions and start mining.

### Advantages for the Perpetrator

- **User Experience**: The user initially does not notice anything wrong because the requested web page loads within a borderless iframe.
- **Extended Mining Time**: The victim remains on the web page for an extended period, increasing the time the miner runs in the background.
- **Continuous Mining**: Clicks on the embedded page do not reload the outer frame, allowing the cryptominer to continue running during navigation.

### Susceptibility of HTTP(S) Connections

- **Browser Address Bar**: The browser address bar shows a connection to the router instead of the requested URL.
- **HTTPS Support**: Websites can be loaded via HTTPS within the iframe without triggering a warning, as the HTTP proxy loads an unencrypted HTTP page with an iframe showing the secured HTTPS content.
- **User Perception**: Unless the rewritten URL raises suspicion, the activity is likely to go unnoticed.

### Vulnerability Exploited: CVE-2018-14847

- **Description**: The vulnerability affected MikroTik RouterOS through version 6.42, allowing unauthenticated remote attackers to read arbitrary files and authenticated attackers to write arbitrary files due to a directory traversal vulnerability in the WinBox interface.
- **Impact**: This vulnerability was applicable to a large number of both consumer and carrier-grade routers, explaining the scale of the cryptomining activity.

### WinBox Interface

- **Functionality**: WinBox is a small Win32 binary for administering RouterOS using a graphical user interface.
- **Exploit**: By sending a carefully crafted package to the WinBox service on port 8291, attackers could retrieve the user credential store (user.dat) and use these credentials to drop files to enable a developer backdoor.
- **Developer Mode**: If specific files are present, the developer mode sets up a root BusyBox shell accessible over SSH (port 22) or Telnet (port 23), giving complete control over the device.

### Datasets Used in the Study

The study utilized three datasets to cover different aspects of the malicious activity:

1. **Network Telescope**:
   - **Time Frame**: January 2018 – January 2019
   - **Size**: 1.6 GB
   - **Usage**: Adversarial identification through port scanning (Section 5.1)

2. **Censys and Shodan**:
   - **Time Frame**: July 2018 – April 2019
   - **Size**: 43 GB (Censys), 236 GB (Shodan)
   - **Usage**: Adversarial targeted scanning, infections and re-infections, system architecture, monetization configuration, ecosystem (Sections 5.1-5.5, 6)

3. **Operator NetFlows**:
   - **Time Frame**: January 2018 – January 2019
   - **Size**: 3.2 TB
   - **Usage**: Characterization of port scanning, system architecture, evolution of monetization, maintenance patterns, revenue and ecosystem (Sections 5.1-5.5, 6)

### Timeline of the Cryptojacking Campaigns

- **Vulnerability Discovered**: April 2018
- **Main Exploitation Phase**: Middle of July 2018
- **Routers Cleaned Up**: January 2019

### Network Telescope Analysis

- **Purpose**: To identify which adversaries are actively scanning the Internet for devices with the WinBox vulnerability.
- **Method**: Monitoring three partially populated /16 networks, collecting approximately 21.7 TB of data between January 2018 and January 2019.
- **Findings**: Only 1.6 GB of the data were probes on port 8291, indicating the scale of the scanning activity.

### Active Scans of Censys and Shodan

- **Censys**:
  - **Data Collection**: Twice a week from July 2018 to April 2019.
  - **Detection**: Identified MikroTik systems by the presence of the proxy header "MikroTik HttpProxy" and marked them as infected if they contained cryptomining scripts.
  - **Dataset Size**: 43 GB
  - **Unique IPs**: 1,452,550

- **Shodan**:
  - **Data Collection**: Historical records of open ports and services.
  - **Dataset Size**: 236 GB
  - **Usage**: Tracing when and how many infected routers appeared in Shodan’s database.

### Operator NetFlows

- **Purpose**: To quantify the scale of the operation and understand how the infrastructure is managed and controlled.
- **Anonymization**: IP addresses of other endpoints were anonymized using the CryptoPan algorithm to preserve privacy.
- **Dataset Size**: 3.2 TB

### Adversarial Techniques, Tactics, and Procedures (TTPs)

- **Life Cycle of Infection**:
  - **Identification of Victims**: Scanning for vulnerable routers.
  - **Exploitation**: Gaining access through the WinBox vulnerability.
  - **Monetization**: Installing cryptomining scripts.
  - **Maintenance**: Ensuring the continued operation of the cryptominers.
  - **Removal**: Decommissioning or patching of the infected routers.

- **Diverse TTPs**: Different groups of actors used various techniques, tactics, and procedures, as detailed in Section 5.

### Top Affected Autonomous Systems (AS)

- **Table 2: Top 10 Most Affected AS**
  - **Telekomunikasi Indonesia**: 55,082 (3.8%)
  - **Telefonica Brasil S.A**: 33,589 (2.3%)
  - **TCI**: 21,357 (1.5%)

This structured and detailed analysis provides a comprehensive understanding of the MITM attack, the vulnerabilities exploited, and the methods used by adversaries to carry out the cryptojacking campaign.