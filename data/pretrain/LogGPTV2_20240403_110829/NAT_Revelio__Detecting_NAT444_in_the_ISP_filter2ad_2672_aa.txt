title:NAT Revelio: Detecting NAT444 in the ISP
author:Andra Lutu and
Marcelo Bagnulo and
Amogh Dhamdhere and
Kimberly C. Claffy
NAT Revelio: Detecting NAT444 in the ISP
Andra Lutu1(B), Marcelo Bagnulo2, Amogh Dhamdhere3, and K.C. Claﬀy3
1 Simula Research Laboratory, Lysaker, Norway
PI:EMAIL
2 University Carlos III of Madrid, Getafe, Spain
3 CAIDA/UC San Diego, San Diego, CA, USA
Abstract. In this paper, we propose NAT Revelio, a novel test suite and
methodology for detecting NAT deployments beyond the home gateway,
also known as NAT444 (e.g., Carrier Grade NAT). Since NAT444 solu-
tions may impair performance for some users, understanding the extent
of NAT444 deployment in the Internet is of interest to policymakers,
ISPs, and users. We perform an initial validation of the NAT Reve-
lio test suite within a controlled NAT444 trial environment involving
operational residential lines managed by a large operator in the UK. We
leverage access to a unique SamKnows deployment in the UK and collect
information about the existence of NAT444 solutions from 2,000 homes
and 26 ISPs. To demonstrate the ﬂexibility of NAT Revelio, we also
deployed it in project BISmark, an open platform for home broadband
internet research. We analyze the results and discuss our ﬁndings.
1 Introduction
The Internet Assigned Numbers Authority (IANA) oﬃcially announced the
depletion of IPv4 addresses in February 2011. But many Internet services and
applications still require IPv4, motivating the standardization and deployment of
protocols that support more aggressive, i.e., multi-level, sharing of IPv4 addresses
[11], e.g., NAT444 within access ISP networks. NAT444 involves two phases of
address translation, from a private IPv4 address block in the subscriber’s network,
to another local IPv4 address block in the provider’s network, and ﬁnally to globally
routable IPv4 addresses. NAT444 technology adds signiﬁcant operational com-
plexity that can impede performance or even break applications [6,8]. In particu-
lar, NAT444 removes the control that the residential user usually has to conﬁgure
port forwarding over single-level NAT, e.g., for peer-to-peer gaming. NAT444 also
limits the number of ports available per subscriber, threatening the availability of
popular applications that use many ports, e.g., Google Maps [3]. Another compli-
cation of NAT444 is customer identiﬁcation, since the subscriber no longer maps
to a unique globally routable IP address. Finally, pervasive NAT444 deployment
may slow down the transition to IPv6, promoting the likelihood of the Internet’s
fragmentation between the two protocols. With such potentially negative impacts
of what seems a likely future scenario, it behooves policymakers, ISPs and Internet
users to monitor the extent of NAT444 deployment in the Internet. But like many
c(cid:2) Springer International Publishing Switzerland 2016
T. Karagiannis and X. Dimitropoulos (Eds.): PAM 2016, LNCS 9631, pp. 149–161, 2016.
DOI: 10.1007/978-3-319-30505-9 12
150
A. Lutu et al.
aspects of Internet structure, systematic measurement and monitoring of NAT444
deployment in the wide area is challenging.
We propose NAT Revelio, a novel test suite methodology for detecting
NAT444 deployments within the ISP access network. In order to detect NAT444
cases, the Revelio test suite aims to determine the location of the device trans-
lating to the globally routable public IP address that identiﬁes the subscriber to
the global Internet. If we ﬁnd that the subscriber’s home network is not hosting
this device, we conclude that the ISP deploys NAT444. Our approach relies on
detecting network conﬁguration characteristics peculiar to NAT444 deployment
in an access network. We design our solution to be highly versatile and not
require prior knowledge of the setup that we are about to test. In particular, we
target deployment of Revelio on large-scale measurement platforms deployed in
subscriber homes, such as the SamKnows large scale measurements platform [14]
and BISmark [16], an open platform for home broadband internet research.
2 Generic NAT444 Deployment Architecture
We design NAT Revelio [1] to detect a wide range of NAT444 solutions in various
conﬁgurations in ISPs, without any prior knowledge on the environment we test.
The Revelio client executes in a device deployed in the home network, such as a
measurement device or a computer. The Revelio client performs six active tests
against diﬀerent elements, including one or more servers deployed in the public
Internet. In the rest of this section we establish the terminology we use in this
paper and give an overview of possible NAT444 deployment architectures. We
use the latter to explain how we deploy NAT Revelio to detect NAT444 in the
ISPs we test.
There are various NAT444 implementations. We describe next the NAT444
deployment architecture in the context of DSL access technology, although
this maps cleanly to other access technologies, e.g., FTTx, cable. One type of
NAT444 technology is Carrier-Grade NATs (CGN), also known as Large Scale
NAT (LSN). DSL-based CGN devices are available in three conﬁgurations: (i)
stand-alone, (ii) Broadband Remote Access Server (BRAS) insertion-card and
(iii) Core Router (CR) insertion card. Also, NAT444 deployments can be distrib-
uted (at each BRAS) or centralized (at the CR). For simplicity of presentation,
we describe a centralized deployment of stand-alone CGN directly connected
to the CR in the ISP access network to explain our detection approach. Other
NAT444 solutions are available [15].
In Fig. 1, we illustrate this NAT444 architecture in DSL networks using the
terminology of the IETF’s Large-Scale Measurement of Broadband Performance
working group (LMAP WG) reference path [4]. The path elements include:
– Subscriber Device: which initiates and terminates communications over
the IP network. In the context of our measurement experiment this is the
measurement device inside the subscriber’s home network that executes the
Revelio client.
NAT Revelio: Detecting NAT444 in the ISP
151
Subsc. 
device 
Service 
Demarc. 
Intra IP 
Access 
GRA  
GW 
Transit  
GRA  
GW 
Subsc. 
device 
Service 
Demarc. 
Intra IP 
Access 
GRA  
GW 
Transit  
GRA  
GW 
Fig. 1. Mapping between DSL access conﬁguration and generic LMAP reference path
(a) without NAT444 and (b) with NAT444 (in this case, a stand-alone CGN) in the
access network.
– Private Network: a network of devices the subscriber operates in the home
network, possibly using multiple layers of NAT, each operating diﬀerent
chunks of RFC1918 private address space.
– Service Demarcation point: where the ISP-managed service begins, usu-
ally the interface facing the public Internet on a residential gateway or modem.
– Intra IP Access: ﬁrst point in the access network that uses a globally
routable IP address.
– Globally Routable Address Gateway (GRA GW): the point of inter-
connection between ISP’s administrative domain and the rest of the Internet.
Figure 1 illustrates the mapping between the LMAP reference path and a stan-
dard DSL network architecture, both (a) without NAT444 (but with traditional
NAT), and (b) with NAT444 technology, using a stand-alone CGN device that
connects to the CR. The customer premises equipment (CPE) usually performs
the NAT function, translating private addresses in the home network to public
addresses in the access network. The CPE is the Service Demarcation device; its
Internet-facing interface is the Service Demarcation point. The BRAS is the Intra
IP Access point – the ﬁrst point after the Service Demarcation point that uses a
globally routable IP address. The GRA corresponding to the subscriber maps to
the IP address the ISP conﬁgures at the Service Demarcation point.
152
A. Lutu et al.
In the NAT444 conﬁguration in Fig. 1(b) the subscriber uses private addresses
within the home network, prior to the Service Demarcation point. For the address
space used between the Service Demarcation point and the Intra IP Access point,
the access ISP can use private, shared [18], or public (legitimate or stolen/“squat”)
IPv4 addresses [3]. In this case, the Intra IP Access point maps to the NAT444 device
(the stand-alone CGN), and the GRA is the IP address at the Intra IP Access point.
3 NAT Revelio Test Suite
This section describes the tests we use in the proposed test suite, and how we
interpret them to infer the presence of NAT444 solutions in access ISPs.
3.1 NAT Revelio Overview and Design Challenges
Building a test suite for large-scale deployment of NAT444 measurements must
account for possible non-standard conﬁgurations. Speciﬁcally, we need to account
for cases where the subscriber deploys several levels of NAT within the home
network. In particular, false inferences of NAT444 deployment can occur when we
assume that the Revelio Client is directly connected to the Service Demarcation
device when, in fact, two in-home NAT devices are in the path between the
Subscriber Device and the Service Demarcation point. A naive NAT444 detection
test could falsely assume that the ﬁrst NAT device is the Service Demarcation
point, and falsely map the second in-home NAT device to an Intra IP Access
point.
Thus, we design NAT Revelio to operate in two phases: (i) Environment
Characterization and (ii) NAT444 Detection. In the ﬁrst phase, Revelio aims to
establish the location of the Revelio Client within the home network relative
to the Service Demarcation point. In the second phase, Revelio tests for the
presence of NAT444 solutions and interprets the measurement results using the
environment information.
NAT Revelio performs active measurements from a device running the Reve-
lio Client in the subscriber network (see Fig. 1). This step attempts to ascertain
where the IPv4 address translation to the subscriber GRA occurs: in the sub-
scriber home network (CPE) or in the ISP access network (a NAT444 device).
Figure 2 depicts a ﬂow diagram of our test methodology. When deploying
Revelio, we perform all the measurements in the test suite and merge their
results to make an inference regarding the existence of NAT444 in the ISP.
3.2 Environment Characterization Phase
In the Environment Characterization phase Revelio runs three tests to determine
the position of the Service Demarcation point relative to the Subscriber Device
running the Revelio client. This step avoids false positive inferences of NAT444
and ensure accurate results over a wide range of in-home conﬁgurations. Figure 2
encloses the environment characterization tests in green rectangles. We use the
NAT Revelio: Detecting NAT444 in the ISP
153
Fig. 2. The NAT Revelio test suite ﬂowchart: measurement actions (sending/receiving
packets) are in blue rectangles; measurement data is in green parallelograms; tests on
retrieved data are in orange rhombuses. Inferences of NAT444 are in red stop blocks.
We use the data we collect in phase 1 of environment characterization for all subsequent
NAT detection test we run in phase 2 (Color ﬁgure online).
information we retrieve here to interpret the results of the tests we run in the
subsequent NAT444 Detection phase. Additionally, this phase allows us to detect
the IP addresses conﬁgured in the home network of the subscriber and the ones