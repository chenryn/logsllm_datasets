**Title: NAT Revelio: Detecting NAT444 in the ISP**

**Authors:**
- Andra Lutu¹
- Marcelo Bagnulo²
- Amogh Dhamdhere³
- K.C. Claffy³

¹ Simula Research Laboratory, Lysaker, Norway  
² University Carlos III of Madrid, Getafe, Spain  
³ CAIDA/UC San Diego, San Diego, CA, USA

**Abstract:**
In this paper, we introduce NAT Revelio, a novel test suite and methodology for detecting NAT deployments beyond the home gateway, commonly known as NAT444 (e.g., Carrier Grade NAT). As NAT444 solutions can degrade performance for some users, understanding the extent of their deployment in the Internet is of interest to policymakers, ISPs, and end-users. We validate the NAT Revelio test suite within a controlled NAT444 trial environment involving operational residential lines managed by a large operator in the UK. Leveraging access to a unique SamKnows deployment, we collect data on NAT444 presence from 2,000 homes and 26 ISPs. To demonstrate the flexibility of NAT Revelio, we also deploy it in the BISmark project, an open platform for home broadband internet research. We analyze the results and discuss our findings.

**1. Introduction**
The Internet Assigned Numbers Authority (IANA) officially announced the depletion of IPv4 addresses in February 2011. However, many Internet services and applications still require IPv4, leading to the standardization and deployment of protocols that support more aggressive, multi-level sharing of IPv4 addresses, such as NAT444 within access ISP networks. NAT444 involves two phases of address translation: from a private IPv4 address block in the subscriber's network to another local IPv4 address block in the provider's network, and finally to globally routable IPv4 addresses. This technology adds significant operational complexity, which can impair performance or even break applications. For instance, NAT444 removes the control that residential users typically have over port forwarding in single-level NAT, such as for peer-to-peer gaming. It also limits the number of ports available per subscriber, potentially affecting popular applications that use many ports, like Google Maps. Additionally, NAT444 complicates customer identification since subscribers no longer map to a unique globally routable IP address. Widespread NAT444 deployment may also slow down the transition to IPv6, promoting the likelihood of Internet fragmentation between the two protocols. Given these potential negative impacts, it is crucial for policymakers, ISPs, and Internet users to monitor the extent of NAT444 deployment in the Internet. However, systematic measurement and monitoring of NAT444 deployment in the wide area remain challenging.

We propose NAT Revelio, a novel test suite and methodology for detecting NAT444 deployments within the ISP access network. The Revelio test suite aims to determine the location of the device translating to the globally routable public IP address that identifies the subscriber to the global Internet. If the device is not hosted in the subscriber's home network, we conclude that the ISP deploys NAT444. Our approach relies on detecting network configuration characteristics specific to NAT444 deployment in an access network. We design our solution to be highly versatile and not require prior knowledge of the setup being tested. We target the deployment of Revelio on large-scale measurement platforms deployed in subscriber homes, such as the SamKnows large-scale measurements platform and BISmark, an open platform for home broadband internet research.

**2. Generic NAT444 Deployment Architecture**
NAT Revelio is designed to detect a wide range of NAT444 solutions in various configurations in ISPs without any prior knowledge of the environment. The Revelio client executes on a device in the home network, such as a measurement device or a computer. The client performs six active tests against different elements, including one or more servers deployed in the public Internet. In this section, we establish the terminology used in the paper and provide an overview of possible NAT444 deployment architectures. We use these architectures to explain how we deploy NAT Revelio to detect NAT444 in the ISPs we test.

There are various NAT444 implementations, and we describe the NAT444 deployment architecture in the context of DSL access technology, though it applies to other access technologies, such as FTTx and cable. One type of NAT444 technology is Carrier-Grade NATs (CGNs), also known as Large Scale NAT (LSN). DSL-based CGN devices come in three configurations: (i) stand-alone, (ii) Broadband Remote Access Server (BRAS) insertion-card, and (iii) Core Router (CR) insertion card. NAT444 deployments can be distributed (at each BRAS) or centralized (at the CR). For simplicity, we describe a centralized deployment of a stand-alone CGN directly connected to the CR in the ISP access network to explain our detection approach. Other NAT444 solutions are available.

Figure 1 illustrates the NAT444 architecture in DSL networks using the terminology of the IETF’s Large-Scale Measurement of Broadband Performance working group (LMAP WG) reference path. The path elements include:

- **Subscriber Device:** Initiates and terminates communications over the IP network. In our measurement experiment, this is the measurement device inside the subscriber's home network that executes the Revelio client.
- **Private Network:** A network of devices the subscriber operates in the home network, possibly using multiple layers of NAT, each operating different chunks of RFC1918 private address space.
- **Service Demarcation Point:** Where the ISP-managed service begins, usually the interface facing the public Internet on a residential gateway or modem.
- **Intra IP Access:** The first point in the access network that uses a globally routable IP address.
- **Globally Routable Address Gateway (GRA GW):** The point of interconnection between the ISP’s administrative domain and the rest of the Internet.

Figure 1 shows the mapping between the LMAP reference path and a standard DSL network architecture, both (a) without NAT444 (but with traditional NAT) and (b) with NAT444 technology, using a stand-alone CGN device that connects to the CR. The CPE usually performs the NAT function, translating private addresses in the home network to public addresses in the access network. The CPE is the Service Demarcation device; its Internet-facing interface is the Service Demarcation point. The BRAS is the Intra IP Access point—the first point after the Service Demarcation point that uses a globally routable IP address. The GRA corresponding to the subscriber maps to the IP address the ISP configures at the Service Demarcation point.

In the NAT444 configuration in Figure 1(b), the subscriber uses private addresses within the home network before the Service Demarcation point. For the address space used between the Service Demarcation point and the Intra IP Access point, the access ISP can use private, shared, or public (legitimate or stolen/squat) IPv4 addresses. In this case, the Intra IP Access point maps to the NAT444 device (the stand-alone CGN), and the GRA is the IP address at the Intra IP Access point.

**3. NAT Revelio Test Suite**
This section describes the tests used in the proposed test suite and how we interpret them to infer the presence of NAT444 solutions in access ISPs.

**3.1 Overview and Design Challenges**
Building a test suite for large-scale NAT444 measurements must account for non-standard configurations. Specifically, we need to account for cases where the subscriber deploys several levels of NAT within the home network. False inferences of NAT444 deployment can occur if we assume the Revelio Client is directly connected to the Service Demarcation device when, in fact, two in-home NAT devices are in the path between the Subscriber Device and the Service Demarcation point. A naive NAT444 detection test could falsely assume that the first NAT device is the Service Demarcation point and map the second in-home NAT device to an Intra IP Access point.

Thus, we design NAT Revelio to operate in two phases: (i) Environment Characterization and (ii) NAT444 Detection. In the first phase, Revelio aims to establish the location of the Revelio Client within the home network relative to the Service Demarcation point. In the second phase, Revelio tests for the presence of NAT444 solutions and interprets the measurement results using the environment information.

NAT Revelio performs active measurements from a device running the Revelio Client in the subscriber network (see Figure 1). This step attempts to ascertain where the IPv4 address translation to the subscriber GRA occurs: in the subscriber home network (CPE) or in the ISP access network (a NAT444 device). Figure 2 depicts a flow diagram of our test methodology. When deploying Revelio, we perform all the measurements in the test suite and merge their results to make an inference regarding the existence of NAT444 in the ISP.

**3.2 Environment Characterization Phase**
In the Environment Characterization phase, Revelio runs three tests to determine the position of the Service Demarcation point relative to the Subscriber Device running the Revelio client. This step avoids false positive inferences of NAT444 and ensures accurate results over a wide range of in-home configurations. Figure 2 encloses the environment characterization tests in green rectangles. We use the data collected in this phase to interpret the results of the tests run in the subsequent NAT444 Detection phase. Additionally, this phase allows us to detect the IP addresses configured in the home network of the subscriber and the ones used in the access network.