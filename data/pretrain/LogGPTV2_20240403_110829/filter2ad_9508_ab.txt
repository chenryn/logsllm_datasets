图5-1 安装样本运行前后数字签名的状态对比
为了找出这种现象的原因,具体分析该样本的代码。此样本是经过NSIS打包的安装程序,解包得到脚本和其他资源文件。分析安装脚本,该恶意程序首先对运行环境进行检测:
图5-2 安装脚本对运行环境进行检测
通过系统调用遍历进程,检测的部分进程列表如下图所示,其中大部分是网吧或分析调试的系统环境,猜测是为了控制样本传播的范围:
图5-3 安装程序检测的部分进程列表
然后程序会判断自身的文件名是否为“s*.exe”,并且检测启动该程序的父进程是否为桌面进程,目的是避免下载该程序的用户直接点击运行触发恶意行为引起注意,而只让该程序作为被其他程序推广启动时才触发:
图5-4 安装程序判断程序文件名与父进程
当文件名判断不通过时,程序作为桌面日历安装包运行,不触发恶意行为。
图5-5 安装程序不触发恶意行为的运行界面
当符合所有触发条件时,就可以触发恶意行为:安装程序会静默下载碰撞作者服务器上的加密压缩文件update003.zip,使用特殊密码解压后执行其中的gpmc.msi程序,最后又清理了作案现场。恶意行为的主要程序代码如下图所示:
图5-6 安装程序的主要恶意代码
从update003.zip解密得到的两个文件gpmc1.msi和gpmc1.cab,gpmc1.msi程序负责解压gpmc1.cab文件并调用其中的正常编译工具NMAKE.exe,gpmc1.cab文件解压如下:
图5-7 gpmc1.cab压缩包内文件列表
NMAKE.exe被运行后,makefile文件中的命令就会执行,通过这种特殊的方式实现由正常的程序连续调用外部的恶意程序:
图5-8 makefile文件的调用命令
这里关注u.exe这个程序,它其实是微软官方的根证书列表更新工具updroots:
图5-9 数字签名根证书数据导入工具
利用该工具导入事先伪造好的一份CA根证书数据文件u,结果会在系统注册表的根证书路径添加一个信任项,并导入伪造的CA证书公钥等相关数据:
图5-10 用户系统被导入的根证书数据路径
恶意程序通过这样的方式在系统种下了一颗种子,这颗种子将导致共用这一个CA认证的伪造签名被验证为信任状态,如果不清除该数据项,被感染的系统将从此对碰撞作者所有具有伪造签名的程序信任。
就本例样本来说,在后面会被调用的日历主程序DesktopGoodCalendar.exe的签名也变为有效的:
图5-11 主程序的另一个数字签名前后状态对比
DesktopGoodCalendar.exe是个加了强壳的delphi程序,运行之后仍先检测运行环境,通过临时目录下的两个文件日志判断安装程序的文件名和父进程:
图5-12 主程序的通过两个文件内容判断运行环境
当恶意条件满足,先把用户机器的信息回传服务器:
图5-13 回传用户机器的信息
接着依次从不同的url下载几张画面相同的图片:
图5-14 碰撞作者使用的加密图片
每次下载一张如上的图片,都会使用同一个算法解密其中的附加数据,并使用解密数据进行下一步操作,大致的操作过程如下:
1、解密“http://www.ci***k.com/images/if.jpg”得到一个进程列表进行分析环境检测:
图5-15 第一张图片解密后的内容
2、解密“http://www.ci***k.com/images/before*.jpg”得到下一张图片下载地址:
图5-16 第二张图片解密后的内容
3、根据上一步得到的下载地址解密其图片得到一个恶意的PE程序,如下为解密得到PE程序的示意图,以及分别从两例地址的图片解密得到的程序图标:
图5-17 第三张图片解密后的得到恶意程序2例
经过上述的下载、解密,最后将得到的PE程序注入一个svchost的傀儡进程中并启动:
图5-18 主程序将恶意程序注入傀儡进程的过程跟踪
由此,新的一个恶意程序悄然在系统进程中运行起来,后续的动作也全凭碰撞作者布局控制,可以方便、隐蔽地进行各种流氓活动。历史上曾从受害用户现场发现过其会劫持浏览器主页,使之跳转到带有商业推广渠道标识的某导航网站,从而为碰撞作者达到盈利的目的。
以下为整体攻击行为的流程图:
图5-19 整体攻击流程图
**0x6传播及影响**
新型MD5碰撞样本在2015年初开始大规模传播,经过统计发现,仅2015年受该类恶意软件影响的用户数量就达到5584939个,下图为在全国各地区受影响的用户分布,主要集中在人口密集地区,其中广东省是重灾区,传播量达到60多万。
图6-1 2015年全国各地区受影响的用户数量分布图
从传播时间来看,该类恶意软件以5月份传播量最高,达到130万左右的量级,如下图所示。
图6-2 2015年各月份受影响用户量
通过对该类恶意软件的种类和来源进一步梳理,发现碰撞作者的主营软件是以天气、日历类软件的形式,通过各种渠道在网络中传播,其业务链及主要传播途径如下所示:
图6-3 碰撞作者的主要业务软件及传播途径
1、借助流氓软件推广渠道进行传播。经统计,视频聊天、下载器、外挂辅助和影音播放器等类型的软件都推广过碰撞作者的恶意软件。它们在推广时,会主动连接碰撞作者的服务器下载最新的恶意程序到用户电脑进行安装,整理2015年碰撞作者使用的主要传播服务器如下:
图6-4 碰撞作者2015年使用的主要传播服务器
2、上传到正规软件下载站提供给用户搜索和下载。以下为在某下载站发现的碰撞样本:
图6-5 下载站传播
3、伪装成热门资料分享到网盘中诱导用户主动下载安装。恶意软件用炒股技巧、考研英语等诱惑性的文件名打包,如下图所示:
图6-6 网盘分享传播
4、官网和其他渠道传播。2015年9月份碰撞作者软件官网截图如下:
图6-7 恶意软件官网传播
通过以上各种传播渠道,碰撞作者的恶意软件最终到达用户电脑潜伏下来,每次用户电脑启动也跟着运行,并伺机进行主页劫持等推广行为进行盈利,即使一些用户想要将之完全卸载也很难,给广大普通用户造成了无尽的烦恼。网上搜索相关的恶意软件名称,会发现很多普通用户的反馈,如下图:
图6-8 用户在网上反馈的声音
从上述的恶意软件演化、传播过程可以看出,碰撞作者费尽心思提高对抗技术、扩展传播渠道,其目的只有一个:金钱至上。虽然碰撞作者为了自己的私利,不顾广大群众的用户体验而利用互联网来污染用户的电脑,但是好在用户的身后还有一批与之不懈对抗的安全软件来保驾护航,以下为360安全卫士对此类碰撞恶意软件进行拦截查杀的截图。在这场没有硝烟的战争中,对抗还将继续,感谢广大用户一直以来对360的支持。
图6-9 360安全卫士对新型碰撞类恶意软件的拦截查杀
* * *
[[1]] 早在2007年就由Marc Stevens提出并实现了该方法的MD5碰撞。
[[2]] 开源的hash碰撞工具,具体可参见project hash clash的开源代码:https://marc-stevens.nl/p/hashclash/
[[3]]下文将介绍到碰撞作者主营软件为桌面天气、日历类软件,其组件包括安装包、主程序和动态连接库等
[[4]] Freebuf曾对此做过报导,参见http://www.freebuf.com/news/3482.html
[[5]] 详见微软对多签名支持的安全公告:https://technet.microsoft.com/zh-cn/library/security/3033929.aspx
[[6]] 签名校验相关的开源代码编译的小工具,一个为校验签名的有效性,另一个则是提取签名字符串