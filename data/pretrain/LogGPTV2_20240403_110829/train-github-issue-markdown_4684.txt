Hi,  
Elasticsearch 5.0.0 now 5.1.1  
Running JVM 1.8.102 and then updated to JVM 1.8.112 - problem occurs on both.  
Windows 2008 R2
I updated from 2.4.1 to 5.0 then to 5.1.1 since I've moved to 5.0 I've been
having nodes drop out of the cluster. I have a 6 data nodes, each one exhibits
the exact same problem but at random times. My ingest and master nodes do not
exhibit this issue, but as soon as I enable a ingest node as a data node it
starts to drop. I never had this issue before when on 2.4.1.
Logging doesn't show anything other than the node left and joined, I turned
the logging up to debug but the same problem logging stops outputting
anything, even the usual 10s marvel metrics shipping stops logging. I'm not
able to bring up the hot threads via 9200 as that connection times out. Even
trying to do a jstack dump hangs until the java process starts to normalize.
The 100% cpu spike can last a few seconds to a few minutes, but it does
recover on it's own. Disk I/O is at nothing. I've reduced my cluster down to 2
data nodes made them mangers and removed 95% of my indexes to accommodate only
the current daily indexes, the problem persists. No searches are occurring.
I'm now starting to disable all other windows services to see if there's some
conflict.
I only have process explorer, and the thread dump from as soon as the jstack
was able to connect and dump.
These are all the threads in the java.exe when running at 100%  
![image](https://cloud.githubusercontent.com/assets/10899305/21236561/879a68ce-c2c9-11e6-8af0-fee168727fdd.png)
Some stack views from the TIDs if these will help any.  
![10224](https://cloud.githubusercontent.com/assets/10899305/21236815/7eb1a7f8-c2ca-11e6-89e1-5431434c10ac.png)  
![2936](https://cloud.githubusercontent.com/assets/10899305/21236824/877da74c-c2ca-11e6-89c4-6e3d62e3b793.png)
![image](https://cloud.githubusercontent.com/assets/10899305/21236574/9f9f9156-c2c9-11e6-98f9-b51943c8bc6a.png)
threadDumps.txt