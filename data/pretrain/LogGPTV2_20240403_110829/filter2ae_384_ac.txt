EOS共识处理分叉问题非常简单，和比特币一样，节点只会认可最长的链作为合法链。假如某个节点开始作恶，自己出块并生成自己的链，也就是每次轮到它就产生 6
个块。但是超级节点总共 21 个，每轮产生理论 126 个块。根据选择最长链作为主链原则，肯定作恶的链得不到认可。所以 EOS 不会发生分叉问题。
总结起来，aBFT+DPoS共识算法相比于单纯的DPOS算法的优势在于：
1.一致性和安全性得到提升；
2.出块速度可以更快，吞吐性能更强；
3.BFT提供了不可逆确认功能，这也是跨链通信的关键属性，适合于侧链通信，为EOS的侧链生态构建提供了基础。
## 2.3 BABE-GRANDPA -- 波卡混合共识协议
波卡被誉为 2020 最受期待的公链项目，其不断攀升的市值也印证了大家的期待。当我们谈到 Polkadot
的共识协议时，大家经常看到两个缩略词，GRANDPA 和 BABE。我们同时提到了这两个词是因为 Polkadot 使用的是混合共识。
Polkadot使用带有两个子协议的混合共识协议：BABE和GRANDPA，合在一起称为“快速转发”。BABE
使用可验证的随机函数（VRF）为验证者分配插槽。GRANDPA
对链投票而不是对单个块投票。BABE可以一起编写候选块以扩展最终链，而GRANDPA可以分批完成它们（一次最多数百万个块）。
### 2.3.1 BABE
BABE （Blind Assignment for Blockchain Extension）是在验证节点之间运行并确定新块生产者的区块生成机制。BABE
作为一种算法可以与 Ouroboros Praos 相比较，在链选择规则和 slot （验证人插槽）时间调整方面有一些关键的区别。BABE 根据 stake
和使用 Polkadot 随机循环机制将区块生产的 slot 分配给验证人。
BABE中leader的选举是通过一个随机函数（VRF）来实现的，在每个slot阶段，每一个节点会通过运算VRF函数来获得一个数值，如果这个数值小于网络中预先规定好的阈值，那么节点就会认为自己就是这个时间段的leader，于是节点就开始出块了。
值得注意的是在上述的过程中，由于VRF函数是随机生成数字的，所以可能造成在某一slot中没有leader或者有多个节点算出自己的VRF值小于阈值进而产生多个leader的情况。我们依次分析两种情况：
当没有leader产生时，Polkadot就规定按照顺序来决定谁是leader，这个顺序是预先确定好的。
当出现多个leader的时候，Polkadot允许多个节点都提交区块，而最终区块的确认则由GRANDPA来决定。
### 2.3.2 GRANDPA
GRANDPA(GHOST-based Recursive ANcestor Deriving Prefix Agreement)
是用来做区块确认的，BABE 会对Polkadot的交易进行出块，这些块最终就是由GRANDPA来确定的。
像其他PBFT的衍生算法一样，GRANDPA的时间复杂度也是O(N²)。它在一个部分同步的网络模型中工作，要求 2/3
的节点是诚实的。但是Polkadot之所以采用GRANDPA是因为GRANDPA并不是每次只确认一个区块，它每一次都会确定好几个区块来做确认，所以效率比普通的
PBFT 更高。算法的主要流程如下：
1.一个主节点广播之前一轮确认后的区块高度；
2.等待网络延迟以后，每个节点都广播他们认为的可以被确认的最高的区块（pre-vote）；
3.每个节点对步骤2接受到的区块集进行计算，算出他们认为的能够被确认的最高区块，并且将结果广播出去(pre-commit)；
4.当节点接收到足够的pre-commit的消息能够确认区块后就会形成commit的消息，一般认为大于2/3就可以被确认了。
通过结合BABE和GRANDPA我们可以看到在出块的时候Polkadot采用BABE出块，此时节点之间只要发送一次块信息即可，这样的话时间复杂度仅仅是O(N)，在出块之后节点之间再采用GRANDPA进行块确认，此时由于确认阶段节点之间要通过二次确认来保证确认块结果的一致性，时间复杂度是O(N²)，不过由于是多个块一次性进行确认，所以两者结合的混合共识是非常高效的，比普通的PBFT共识要高效很多。
## 2.4 小 结
PBFT算法由于每个副本节点都需要和其他节点进行P2P的共识同步，因此随着节点的增多，性能会下降的很快，但是在较少节点的情况下可以有不错的性能，并且分叉的几率很低。所以在区块链中，更多应用于联盟链或私有链场景中。如
Fabric 和蚂蚁链。
如果能够结合类似 DPOS 这样的节点代表选举规则的话也可以应用于公链，并且可以在一个不可信的网络里解决拜占庭容错问题，有些公链对此进行了有益的尝试。
为了适应公有链场景中的大规模扩展需求，有不少项目大胆采用了 PBFT，比较知名的有 EOS 链首先采用了 DPoS + aBFT
共识协议，后起之秀波卡采取了 BABE + GRANDPA 的混合共识协议，这两个公链都是先用一些方法在众多的公链节点中选举出参与共识的节点，然后再进行
BFT 共识。采用这种方法会有效减少节点的数量，使性能能够满足公链的需求。所以 BFT 协议在联盟链和公链都可以广泛应用。
本文主要介绍了BFT 协议概念及在区块链的应用，本系列的下集在次条更新，欢迎关注。
本文图片来源于：
刘秋杉. Practical Byzantine Fault Tolerance[EB/OL].2014-09-09.
区块链安全：基于区块链网络攻击的方式原理详解
参考资料
* * *