**SFB(System Function Block)：** 系统功能块，系统内部功能块，用户不可自己编写，不可更改，使用同FB。
**SFC(System Function)：** 系统功能，系统内部功能，用户不可自己编写，不可更改，使用同FC。博途软件支持的编程语言有：
LD(梯形图)，FBD(功能块图)、SCL(结构化控制语言)、STL(语句列表)。
S7-1200只支持LAD、FBD和SCL三种编程语言，并且在下载过程中会先停止运行，然后下载程序，下载完成后重新启动。
**1\. 实现流程**
病毒首先选择IP通过西门子通信端口102尝试建立连接，如果连接建立成功，则检查目标PLC是否已被感染。如连接未建立成功，或目标PLC已被感染，则选择新IP重新尝试建立连接。如目标PLC未被感染，则停止目标PLC，下装病毒程序，最后重新启动目标PLC。流程如下图所示。
**2\. 寻找目标**
西门子PLC通过102端口进行TCP通信，因此可以尝试通过102端口与设备建立TCP通信来寻找目标。博途开发平台提供了两个FB块——通讯连接块TCON和断开通讯连接块TDISCON，如下图所示。
程序块TCON和TDISCON的参数说明
使用TCON和DISTCON块尝试建立和断开连接
如果TCON建立了连接则判断设备型号或者下载程序。由于TCON只需触发一次连接命令，就会一直尝试与目标建立连接，直到连接成功。因此，如果1s内没有建立连接则改变IP地址，尝试连接下一台PLC；如果建立了连接，则通过发送指令判断设备信号或者下载病毒程序，完成后改变IP地址，并尝试连接下一台设备。
更改IP
断开连接后则更改IP地址，准备连接下一台设备
**3\. 传播感染**
连接建立后，病毒调用数据传送命令TSEND和数据接收命令TRCV进行传播。见下图
程序块TSEND和TRCV的参数说明
判断是否已感染
病毒在传播感染之前需要判断当前对象是否已经被感染，避免重复感染。判断是否被感染，如果感染，则跳过感染，如果未感染，则执行程序传送，感染对象。具体实现如下图：
建立连接认证
在程序的发送过程中，需要满足S7协议的相关通信时序以及报文格式。下图为S7建立连接的过程。首先是TCP的三次握手，接下来建立COTP连接，建立完成后进行S7协议的连接建立。
具体逻辑实现代码如下：
**4\. 激活**
PLC执行顺序是从OB1开始，按顺序执行到OB9999的。
建立调用病毒程序的OB块OB9999，并将其存植入到目标PLC中，用以激病毒，并进行新的病毒传播感染。西门子PLC在运行时，会按照从OB1到OB9999的顺序进行调用。如下图所示。
在其他病毒块下载完成后，用OB9999（也可以用其他非系统自带的OB块，未了避免病毒的OB块与PLC中正常的OB块重复，建议块的序号尽量大些）启动病毒程序。
**5\. 恶意功能的实现——连接C &C服务器**
一旦PLC被感染病毒，会基于TCP主动去连接C&C服务器。通过C&C服务器，可以远程控制PLC，包括PLC的启停，输出值的改变等。当C&C服务器向连接了C&C服务器的PLC发送指令后，PLC会解析命令并执行。以点灯程序为例说明其危害性。下图为C&C服务器点灯的解析部分：
**6\. 感染前后对比**
博途软件提供了PLC程序在线与离线差异的检测功能，如下图所示。程序块后面的绿色圆圈表示在线程序与离线程序一致，蓝色与橘黄色组成的圆形表示在线程序与离线程序不一致。块为虚样式，表示博途的程序中没有此块，而PLC有。
**演示截图**
红灯表示PLC感染状态，绿灯表示PLC正常控制的终端运行状态，PLC使用的是西门子1200
V3版本，从左到右分别为PLC0，PLC1，PLC2。默认情况下，PLC1和PLC2离线的，当PLC0被感染后，PLC1和PLC2接入网络，随后PLC0就会感染PLC1和PLC2。
图1：PLC处于正常运行状态
图2：PLC0被感染病毒，反向联接C&C服务器
图3：PLC1与PLC2联网，PLC0正在感染PLC1
图4：PLC1被感染病毒，反向联接C&C服务器
图5：PLC2被感染病毒，反向联接C&C服务器
**防护措施**
1.部署控制设备管理系统，定期对PLC控制逻辑代码进行备份，一旦PLC被感染，可以迅速通过备份的PLC程序重置进行快速恢复。
2.设置CPU访问密码，禁止非授权用户上下载逻辑代码，密码一定不能是弱口令。
3.对工控网络进行风险评估，识别核心资产，根据不同安全级别进行安全分区，一旦受到网络攻击，将损失控制在最小的范围内。
4.在工控系统中安装工控监测审计系统，通过工控协议深度解析，根据特征值的进行采集、分析与识别，如发现异常数据包，如控制器启停、程序上下载，则记录日志或报警。
5.安全域边界安装工控防火墙，通过工控防火墙，对异常数据包进行检测以及隔离防护。
6.针对工控网络制定应急处理预案，当遇见突发网络攻击事件，可以实现快速恢复。