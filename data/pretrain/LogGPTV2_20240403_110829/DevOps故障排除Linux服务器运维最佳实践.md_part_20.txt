354Enddatawith.
，就完成了测试邮件服务器一半的工作
7.3邮件发送的问题·121
如
---
## Page 129
122
表示一些更常见的错误，比如邮箱不可用（550）邮箱满（552）
（501）或者其他以50开头的命令错误到以55开头的错误码，后者
不合法的邮箱名称（553）以及一般传输失败（554）。
错误码450以及说明，并在几分钟之后再次尝试。
单的邮件服务器第一次会从远程服务器中得到一个连接，它会回复
器有足够的垃圾邮件要发送，如果再次尝试就会被忽略。启用灰名
空间不足或者系统本地出现一些其他错误的时候，可能就会看到这
等待我们进一步输人以单个句号作为单行结尾的数据。
当发出DATA命令后，若得到返回码354，这就意味着服务器正在
了邮件部分，输人quit命令退出：
·第7章为什么无法收发邮件？追踪邮件问题
立了灰名单（greylisting）。灰名单正常工作的前提是垃圾邮件服务
新建立连接。例如，一些邮件管理员为了减少垃圾邮件的数量，建
个错误。当配置良好的邮件服务器得到这个错误码后，它会尝试重
还需要一些额外的信息才能完成这个命令。
人quit的时候，我们会收到221这个回复码，这代表远程服务器将
完成。基本上任何以2开头的号码都代表着执行成功。例如，当输
是否成功执行。最常见的号码是250，它代表之前的命令已经成功
发送请求一
会关闭链接。
向邮件服务器的请求都有一个回复码，它能让客户端了解这个请求
为每条请求的回复内容中都添加了一个号码，通常是250。每条发
以5开头的错误码表示永久性错误，它们的范围从语义错误
以4开头的返回码代表临时错误，这说明命令发送者需要重新
以3开头的返回码代表服务器已经接收了这个命令，不过它们
邮件错误码可能你已经注意到了，在telnet 测试中，服务器
Connection closed by foreign host.
221Bye
quit
-一般这需要从头开始。当邮件服务器特别繁忙、硬盘
一个很好的例子就是
---
## Page 130
例如，在 postfix 中，这一点是由 smtpd_recipient_restrictions 这个配
是认证账户——密码可能已经过期或者被修改过。如果邮件服务器
息，这个问题很可能是之前提到的转发安全问题之一造成的。
来自带有正确用户名和密码的客户端的邮件。如果你发现邮件客户
邮件服务器使用授权机制，比如说SMTP授权，这样它们仅需转发
可以从哪些IP或者子网接收邮件的列表。还有更好的方法，有些
务器都会被列人垃圾邮件黑名单中，然后很快会发现自己被其他邮
它转发到任何其他的邮件服务器。在垃圾邮件出现之前，开放转发
7.3.2
也可以通过postconf命令检查这个选项：
这个选项允许转发来自 mynetworks选项中设置的任何网络的邮件，
（这台服务器支持授权），但是你可能也会启用permit-mynetworks。
置选项决定，可以使用postconf命令来检查这个选项：
启了转发功能且客户端的IP地址在已经认证的IP 和网络列表中。
没有使用SMTP授权，下一步就是看看邮件服务器的配置，确定开
端可以连上邮件服务器，但是得到一个拒绝转发访问的错误返回消
与网上的SMTP 流量隔离开来，要么用更好的方法建立一个严格的
件服务器阻止了。
相对常见，但是当今开放互联网中任何随意转发任意主机的邮件服
现今用于转发邮件的出站邮件服务器应该要么用防火墙将自己
如果邮件服务器使用了SMTP授权，那么故障排除的下一步就
$postconfmynetworks
mynetworks = 127.0.0.0/8, 192.168.0.0/24
如果你使用的是 postfix，你可能仅需开启这些选项的一部分
smtpd_recipient_restrictions= permit_mynetworks,permit_sasl_authenticated
$postconf smtpd_recipient_restrictions
—reject_unauth_destination
出站邮件服务器不允许转发
7.3邮件发送的问题123
---
## Page 131
124
net）、收件人（PI:EMAIL）、目标邮件服务器（gmail-smtp-in.
件ID：
看看在日志中能否定位到任意一条你的消息。如果你执行了telnet
没有被正确投递，那么下一步就是检查外部邮件服务器与目标邮件
（127.0.0.0/8）和来自192.168.0.x的邮件。
第7章为什么无法收发邮件？追踪邮件问题
有些问题，你会在日志中原本是250成功码的位置看到相应的错误
有可能归人了垃圾邮件)。如果在与远程邮件服务器通信的过程中
出站邮件服务器没有问题，而是远程邮件服务器中的问题（邮件很
服务器的确接收了邮件并且将待发送的邮件放入了邮件池。这证明
功的返回码250。如果你在日志中看到这样的条目，那么目标邮件
件队列ID：
邮件测试，发送了邮件正文之后，返回消息中会得到如下的一个邮
（在Linux系统中，
服务器间的通信。
7.3.3
找到这封邮件相关信息最快的方法就是使用 grep 命令查找该邮
如果你成功地将邮件放人了邮件服务器队列，但它看上去还是
在这个示例日志中能看到这封邮件的发件人（kyle@example
$ grep 12BDBE6FEE9 /var/Tog/mail.10og
2500k:queuedas12BDBE6FEE9
从上面的代码中可以看到，这台邮件服务器接收来自本地主机
Apr1720:17:05mailpostfix/smtp[25586]:12BDBE6FEE9:to=,relay=gmail-smtp-
Apr 1720:17:05 mail postfix/qmgr[10784]:12BDBE6FE9:removed
Apr17 20:17:03mai1postfix/cleanup[25564]:12BDBE6FEE9:message-id=
Apr1720:16:50mail postfix/smtpd[25545]:12BDBE6FEE9:client=kylepc.example.net[75.101.46.232]
nrcpt=1（queueactive)
status
出站邮件服务器无法与目标服务器通信
sent (250 2.0.0 0K 1334719025vs4si1566804pbc.307)
，这通常是/var/log/mail.log或者/var/log/maillog），
如果你登录了出站邮件服务器，就查看邮件日志
---
## Page 132
码，这将给出更多关于问题实质的细节信息。
打算多次尝试投递邮件。在这个阶段，你想要做的可能是重复7.3.1节
器通信的错误信息，也许你还会注意到多次请求，因为邮件服务器
URL 指向的网页中会给出关于如何解除邮件服务器黑名单的详细说
页联系SBL（垃圾邮件黑名单，Span Blackhole List）的管理员，让
种情况下，你将会看到以5开头的错误码，并且通常你也会看到邮
邮件通过你的邮件服务器转发的时候，就可能出现这种情况。在这
邮件退回。当网络内部的机器被入侵或者感染电脑病毒，导致垃圾
务器。其中的一个问题就是邮件服务器可能根据反垃圾邮件策略将
么既可以使用邮件日志中与出站邮件服务器联系的主机名进行通
连接测试，只是此时，.要做的是从出站邮件服务器执行测试并根据
中介绍的步骤，尽早进行客户端机器与出站邮件服务器之间的网络
明，并在首要位置介绍解决问题的方法。
他们将你的邮件服务器从黑名单中移除。或者，一般你点击的这个
链接能获得更多的细节信息。
件服务器违反了哪些垃圾邮件规则的说明文字，访问对应的URL
如，查找 gmail.com这个域的所有邮件服务器，你应该输人：
信，也可以执行 dig 命令，查询针对特定域的所有邮件服务器。
目标邮件服务器执行测试。
如果你不确定与目标邮件服务器通信的是哪个邮件服务器，那
如果你的邮件被当做垃圾邮件过滤掉，解决方法通常是通过网
在这个阶段，有些问题可能会阻止你将邮件投递到目标邮件服
另一方面，如果看到一个关于邮件服务器无法与远程邮件服务
40 alt4.gmail-smtp-in.1.google.com.
30 alt3.gmail-smtp-in.1.google.com.
10 alt1.gmail-smtp-in.1.google.com
$dig gmail.com MX +short
20 alt2.gmail-smtp-in.1l.google.com
5gmail-smtp-in.1l.google.com.
7.3邮件发送的问题125
例
---
## Page 133
126
不同公司的多个邮件服务器在同一时间岩机。另一方面，如果仅仅
有可能是你的防火墙或者ISP的防火墙禁掉了端口 25，而不是因为
com 邮件列表中下一个邮箱服务器上尝试使用相同的 nmap命令，
为远程服务器禁止了ping 探测。这时，可以遵照 nmap 的帮助文
邮件服务器上执行网络扫描，将 gmail-smtp-in.l.google.com列为
看看它们的端口是否处于打开的状态。
了测试这两种可能性，在完全不同的域（如yahoo.com）和gmail.
可能是所有远程服务器）通信，要么是远程邮件服务器岩机了。为
档，在命令后面添加-PN：
扫描的主机：
后，比如说做到网络故障排除中网络扫描这一步的时候，在出站
（在本例中是优先级数值为5的gmail-smtp-in.l.google.com）。
务器的引用同时将端口80改为25。选择优先级数值最低的服务器
关闭的，要么你的邮件服务器不允许通过端口25与这台机器（很有
第7章为什么无法收发邮件？追踪邮件问题
如果发现这两个远程邮件服务器的25 端口都处于关闭状态，很
在这里可以看到，远程SMTP 端口已经打开。如果这个端口是
$nmap -p 25-PN gmai7-smtp-in.1.google.com
$ nmap -p 25 gmail-smtp-in.1.google.com
回到第5章关于网络故障排除的部分，仅需替换所有 Web 服
Nmap done: 1 IP address (1 host up) scanned in 0.14 seconds
25/tcp open smtp
Starting Nmap 5.00（http://nmap.org ）at 2012-04-17 20:32 PDT
注意，
PORTSTATE SERVICE
Nmap done: 1 IP address (0 hosts up) scanned in 3.11 seconds
Note:Host seems down.If it is really up,but blocking our ping probes, try -PN
Interesting ports on pb-in-f27.1e100.net (173.194.79.27):
一开始无法从网络扫描中获得合适的应答。这可能是因
然
---
## Page 134
7.4接收邮件的问题
限。例如，postfix中这个命令需要这样运行：
件池中所有的邮件迅速投递。注意，运行这个命令可能需要root权
以防过载。如果因为某些原因你等不及，需要迅速投递这些邮件，
有的邮件，但并不是一次性投递完毕。相反，它会慢慢地投递邮件
否则，你会看到当前有多少信息在队列中等待，每条信息都包含队
填满。在出站邮件服务器上运行 mailq 命令会给出当前邮件队列的
远程邮件服务器重新上线，那么邮件池可能会被发向目标域的邮件
码要尝试投递几天之后，这个信息才会被退回。
是Gmail的邮件服务器不可用，那很有可能是因为它恰巧此时断电
电话联系：“你好，收到我的邮件了吗？”遇到这种情况，作为一个
邮件服务器应该会提供类似于fush这样的命令，它会帮助你让邮
列 ID 和收件人地址。
状态信息。
了，此时要做的就是让你的邮件服务器继续尝试投递这封邮件。起
才能发现这类问题。此时若他们无法获得任何回复，他们就会直接
你组织中的一个人发送了一封重要邮件想要获得迅速反馈的时候，
也不会发现它无法送达给你。通常当邮件被退回，或者某人给你或
一个账户给自己发一封邮件。如果你不知道一封邮件已经发送，你
如果你的邮件服务器被防火墙阻止发送邮件，或者你正在等待
一旦邮件服务器重新正常工作，就会开始尝试投递邮件池中所
在这个例子中，邮件队列是空的，这是你想要看到的理想情况。
当你不能接收来自特定域的邮件时问题特别棘手，除非你用另
$ sudo postqueueflush
Mail queue is empty
$mailq
7.4接收邮件的问题·127
---
## Page 135
128
·第7章为什么无法收发邮件？追踪邮件问题
器能接收到telnet测试同时这封邮件也出现在收件人的邮箱中，那
写一封邮件给你或者抱怨邮件无法发出的用户。如果你的邮件服务
到你的邮件接收服务器（具有最高优先级MX记录的邮件服务器），
外的机器，然后执行本章前面介绍的telnet邮件测试。此时，连接
一下远程邮件服务器。为完成这一步，找一台最好处于你的网络之
保邮件接收服务器处于域邮件服务器列表当中并且它具备正确的IP
应该收到邮件却没有收到，那么你可能想要快速执行 dig查询，确
件服务器上手动执行相同的步骤。在这么做之前，如果你怀疑自己
跃的服务器，或者看不到新的邮件条目，那么下一步最好在远程邮
就是仔细研究这些日志文件。另一方面，如果是一个基本不怎么活
看到其他活动的邮件，那么这个邮件服务器基本工作正常，下一步
log/mail.log（在其他系统中也许是/var/log/maillog）文件。如果这是
时候，需要检查所有已经配置的邮件接收服务器。
大多数情况下，你可能会配置至少两个邮件服务器，如果主服务器
功收到来自其他域的邮件；其次，在日志中能够定位到特定的邮件
故障排除者，你需要能够证明几件事：首先，你的邮件系统可以成
么你可以比较肯定收件箱已经为那个用户接收了这封邮件。
地址：
一个活跃的邮件服务器，你将会看到来自其他用户的邮件。如果能
一个简单方法就是登录这个邮件系统，用tail-f命令实时查看/var/
岩机就用备用的顶替。如果配置了这样的系统，在进行故障排除的
会话。
本节将会介绍用单个邮件接收服务器接收邮件的简单系统。在
测试邮件系统——尤其是一个繁忙的系统——是否正常工作的
现在，已经确认邮件服务器处于DNS 列表之中，然后应该模拟
$digexample.netMx
---
## Page 136
进程。否则，下一步就是确认邮件服务器是否正在监听端口 25：
检查是否所有的 postfix进程都能正常运行。这个方法有一个优点，
本的名字替换 postfix。还有一种方法，你也可以简单地使用 ps 命令
运行。例如，在运行 Postfix的系统上，可能需要输入：
况的时候，应该登录到邮件接收服务器，确保邮件服务器软件还在
可能你会发现从外部根本无法连接到你的邮件服务器。出现这种情
7.4.1
请尝试做另外一个telnet 测试：从主机本身通过端口25 telnet 到
新配置它；否则，如果你看到没有进程正在监听端口25，但邮件服
接收来自本地的邮件。如果你想要从外部接收邮件，那么你需要重
如果看到它正在监听127.0.0.1，那么你就知道这台邮件服务器仅能