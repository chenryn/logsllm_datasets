# RARE: A Systematic Augmented Router Emulation for Malware Analysis

**Authors:**
- Ahmad Darki
- Chun-Yu Chuang
- Michalis Faloutsos
- Zhiyun Qian
- Heng Yin

**Contact:**
- {adark001, cchua010}@ucr.edu
- {michalis, zhiyunq, heng}@cs.ucr.edu

**Affiliation:**
- University of California, Riverside, CA, USA

## Abstract

Analyzing and profiling the behavior of router-specific malware is a critical challenge. This type of malware has emerged as a new vector for hackers but has received less attention compared to malware on other devices. A key difficulty in analyzing router malware is getting it to activate, which is complicated by the diversity of firmware and platforms. We introduce RARE, a systematic approach to analyze and profile the behavior of router malware, focusing on home-office routers. The core innovation of RARE is its intelligent augmented emulation, which tricks malware binaries into activating, regardless of their target platform. This is achieved through two key capabilities: (a) static analysis that informs dynamic execution, and (b) an iterative feedback loop that refines the emulation based on previous runs. Practically, RARE can (a) instantiate an emulated router with or without malware, (b) replay arbitrary network traffic, and (c) monitor and interact with the malware in a semi-automated way. Our evaluation using 221 router-specific malware binaries shows that RARE activates 94% of the binaries, including obfuscated ones, a nine-fold increase over the 10% success rate of a baseline method. Additionally, RARE extracts useful information, such as 203 unique IP addresses of C&C servers and observes a 50% increase in system calls on infected routers.

## 1. Introduction

Compromising routers is a growing threat with potentially severe consequences. For example, the 2016 Mirai botnet attack used IoT devices, including routers, to launch DDoS attacks on Dyn, Inc. servers. The lack of robust protection technologies makes routers a prime target for attackers. Compromised routers provide significant new capabilities to attackers, such as accessing or blocking network packets, stealing cookies and session IDs, and hijacking communication via DNS redirection.

Attacking and protecting routers differs significantly from laptops and desktops, necessitating new methods and tools. Routers have limited CPU and memory resources, making them challenging for both malware developers and security solutions. Additionally, the variability in router configurations and the proprietary nature of many firmware types complicate both malware and system analysis.

Our goal is to understand the operation of router malware binaries, focusing on off-the-shelf home-office routers. We aim to (a) create an environment that "fools" the malware into activating and revealing its behavior, and (b) profile the behavior of infected routers. The main challenge is the diversity of proprietary firmware and hardware configurations. Moreover, there is a scarcity of tools for static analysis of MIPS and ARM architectures, which are common in routers. A straightforward emulation attempt often fails to activate the malware.

## 2. System Design and Implementation

### Philosophy

RARE starts with a general-purpose platform and learns what the malware needs to activate through a sequence of executions. The key capabilities of RARE include:

- **Static Analysis Module:** Analyzes the malware binary to extract information for dynamic execution, such as IP addresses, domains, and files the malware will access.
- **Emulation Engine Module:** Instantiates an emulated router with the necessary configurations and replays network traffic.
- **Intelligent Execution Module:** Monitors the malware and provides feedback to subsequent runs to refine the emulation.

### Key Components

1. **Static Analysis Module:**
   - Uses IDA-Pro and custom plugins to extract high-level code structure and data dependencies.
   - Provides information on IP addresses, domains, and resources the malware will access.
   - Developed non-trivial plugins for MIPS and ARM architectures to enhance functionality.

2. **Emulation Engine Module:**
   - Creates an emulated router environment with the necessary configurations.
   - Replays arbitrary network traffic and responds to malware requests.
   - Monitors the malware and provides feedback for subsequent runs.

### Defining Success: Malware Activation

The primary goal is to activate the malware, meaning the malware attempts to contact its C&C server. Once activated, the malware enters a standby mode, waiting for C&C commands. The next stage involves reverse-engineering the communication protocol to assume the role of the botmaster.

### Evaluation

We evaluated RARE using 221 router-specific malware binaries. The results show:

- **Activation Success Rate:** 94% of binaries activated, including 88.8% of obfuscated binaries.
- **Extracted Information:** 203 unique IP addresses and domains of C&C servers.
- **Behavior Profiling:** Observed a 50% increase in system calls and a large initial spike in active processes on infected routers.

RARE is a powerful tool for understanding and analyzing router malware. We plan to make our tool, malware binaries, and data traces available to researchers upon request.