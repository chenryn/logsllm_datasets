量密码保护的服务，会在这些服务间使用相同的用户名和密码。比如说，某个狡
猾的恶徒会从免费的因特网邮件网站捕获明文形式的用户名和密码，然后会发现
用同样的用户名和密码还可以访问重要的在线银行网站！
300 ｜ 第12章
(4) 基本认证没有提供任何针对代理和作为中间人的中间节点的防护措施，它们没有
修改认证首部，但却修改了报文的其余部分，这样就严重地改变了事务的本质。
(5) 假冒服务器很容易骗过基本认证。如果在用户实际连接到一台恶意服务器或网关
的时候，能够让用户相信他连接的是一个受基本认证保护的合法主机，攻击者就
可以请求用户输入密码，将其存储起来以备未来使用，然后捏造一条错误信息传
送给用户。
这一切说明，在友好的环境，或者说是希望有隐私保护但隐私保护并不十分必要的
环境中，可以通过基本认证来提供便捷的文档个性化服务或访问控制保护。通过这
种方式，可以用基本认证来防止一些好奇的用户无意中或不小心对文档进行访问。1
比如，在一个公司内部，产品管理可能要对未来的产品计划进行密码保护，以防止
信息的过早发布。对一般用户而言，基本认证就足以让他们感到不便而不会再去访
问这些数据了。2同样，你可能会用密码来保护那些并非高度机密的，或者没什么信
息价值的私人照片或私有站点，这些信息确实和其他人也没什么关系。
将基本认证与加密数据传输（比如SSL）配合使用，向恶意用户隐藏用户名和密码，
会使基本认证变得更加安全。这是一种常用的技巧。
我们会在第14章讨论安全加密技术。下一章将介绍更复杂的HTTP认证协议——摘
要认证，摘要认证具有比基本认证更强的安全特性。 284
12.4 更多信息
更多与基本认证和LDAP有关的信息，请参见以下资源。
• http://www.ietf.org/rfc/rfc2617.txt
RFC 2617，“HTTP Authentication：Basic and Digest Access Authentication.”
（“HTTP认证：基本和摘要访问认证”）
• http://www.ietf.org/rfc/rfc2616.txt 285
RFC 2616，“Hypertext Transfer Protocol-HTTP/1.1.”（“超文本传输协议——
HTTP/1.1”。）
注1： 小心，基本认证中使用的用户名和密码要有别于你在更安全的系统中所使用的密码，否则恶意用户就
可以用它们来攻破你的安全账户了！
注2： 尽管不是非常安全，但公司内部的员工通常也没有太大的动力去恶意捕获这些密码。这也说明，公司
确实会有间谍，也确实会有不满，想要报复的员工，所以，明智的做法是对一旦被恶意获取就会造成
很大损害的数据应用更安全的策略。
基本认证机制 ｜ 301
第13章
摘要认证
303
基本认证便捷灵活，但极不安全。用户名和密码都是以明文形式传送的，1也没有采取
任何措施防止对报文的篡改。安全使用基本认证的唯一方式就是将其与SSL配合使用。
摘要认证与基本认证兼容，但却更为安全。本章主要介绍摘要认证的原理和实际应用。
尽管摘要认证还没有得到广泛应用，但对实现安全事务来说，这些概念是非常重要的。
13.1 摘要认证的改进
摘要认证是另一种HTTP认证协议，它试图修复基本认证协议的严重缺陷。具体来
说，摘要认证进行了如下改进。
• 永远不会以明文方式在网络上发送密码。
• 可以防止恶意用户捕获并重放认证的握手过程。
• 可以有选择地防止对报文内容的篡改。
• 防范其他几种常见的攻击方式。
摘要认证并不是最安全的协议。2摘要认证并不能满足安全HTTP事务的很多需求。
对这些需求来说，使用传输层安全（Transport Layer Security，TLS）和安全HTTP
286 （Secure HTTP，HTTPS）协议更为合适一些。
但摘要认证比它要取代的基本认证强大很多。与很多建议其他因特网服务使用的常
用策略相比，（比如曾建议LDAP、POP和IMAP使用的CRAM-MD5），摘要认证
也要强大很多。
迄今为止，摘要认证还没有被广泛应用。但由于基本认证存在固有的安全风险，
HTTP设计者曾在RFC 2617中建议：“在可行的情况下应该将目前在用的所有使用
基本认证的服务，尽快地转换为摘要认证方式。”3这个标准的前景还不太明朗。
13.1.1 用摘要保护密码
摘要认证遵循的箴言是“绝不通过网络发送密码”。客户端不会发送密码，而是会发
送一个“指纹”或密码的“摘要”，这是密码的不可逆扰码。客户端和服务器都知
道这个密码，因此服务器可以验证所提供的摘要是否与密码相匹配。只拿到摘要的
话，除了将所有的密码都拿来试试之外，没有其他方法可以找出摘要是来自哪个密
注1： 用户名和密码用Base-64编码进行了扰码，但很容易被解码。只能防止无意中的查看，没有任何防止
恶意用户攻击的手段。
注2： 比如，与基于公有密钥的机制相比，摘要认证所提供的认证机制就不够强。同样，摘要认证除了能保
护密码外，并没有提供保护其他内容的方式——请求和应答中的其余部分仍然可能被窃听。
注3： 随着SSL加密HTTP的流行和广泛采用，有关摘要认证的现实意义曾有过很激烈的争论。时间将会
告诉我们摘要认证能否达到所需的规模。
304 ｜ 第13章
码的！4
下面来看看摘要认证的工作原理（这是一个简化版本）。
• 在图13-1a中，客户端请求了某个受保护文档。
• 在图13-1b中，在客户端能够证明其知道密码从而确认其身份之前，服务器拒绝
提供文档。服务器向客户端发起质询，询问用户名和摘要形式的密码。
• 在图13-1c中，客户端传递了密码的摘要，证明它是知道密码的。服务器知道所
有用户的密码，5因此可以将客户提供的摘要与服务器自己计算得到的摘要进行
比较，以验证用户是否知道密码。另一方在不知道密码的情况下，很难伪造出正
确的摘要。
• 在图13-1d中，服务器将客户端提供的摘要与服务器内部计算出的摘要进行对比。
如果匹配，就说明客户端知道密码（或者很幸运地猜中了！）。可以设置摘要函
数，使其产生很多数字，让人不可能幸运地猜中摘要。服务器进行了匹配验证之
后，会将文档提供给客户端——整个过程都没有在网络上发送密码。 287
（a）请求 因特网 请将内部销售额预测发给我
客户端 服务器
（b）质询 你请求的是一个保密的财务文档。
因特网
请告知用户名和密码摘要。
客户端 服务器
询问用户名和密码
digest("Ow!")= A3F5
（c）授权 请将内部销售额预测发给我。我的用
因特网
户名为“bri”，我的密码摘要为“A3F5”
客户端 服务器
digest("Ow!")= A3F5
匹配！
（d）成功 好的。你发送过来的摘要与我存储的
因特网
密码摘要相匹配，这是你要的文档。
客户端 服务器
图13-1 用摘要来实现隐藏密码的认证
注4： 有一些技术，比如词典攻击，会首先尝试一些常见的密码。这些密码分析技术可以极大地简化密码破
译进程。
注5：实际上，服务器只需要知道密码的摘要即可。
摘要认证 ｜ 305
我们将在表13-8中更详细地讨论摘要认证中那些特殊的首部。
13.1.2 单向摘要
摘要是“对信息主体的浓缩”。6摘要是一种单向函数，主要用于将无限的输入值转
换为有限的浓缩输出值。7常见的摘要函数MD5，8会将任意长度的字节序列转换为
一个128位的摘要。
128位 = 2128，或者大约
288 1 000 000 000 000 000 000 000 000 000 000 000 000 000种不同的输出值。
对这些摘要来说，最重要的是如果不知道密码的话，要想正确地猜出发送给服务器
的摘要将是非常困难的。同样，如果有摘要，想要判断出它是由无数输入值中的哪
一个产生的，也是非常困难的。
MD5输出的128位的摘要通常会被写成32个十六进制的字符，每个字符表示4位。
表13-1给出了几个示例输入的MD5摘要。注意MD5是怎样根据任意的输入产生
定长的摘要输出的。
表13-1 MD5摘要实例
输 入 MD5摘要
"Hi" C1A5298F939E87E8F962A5EDFC206918
"bri:Ow!" BEAAA0E34EBDB072F8627C038AB211F8
"3.1415926535897" 475B977E19ECEE70835BC6DF46F4F6DE
"http://www.http-guide.com/index.htm" C617C0C7D1D05F66F595E22A4B0EAAA5
"WE hold these Truths to be self-evident, that all Men 66C4EF58DA7CB956BD04233FBB64E0A4
are created equal, that they are endowed by their Creator
with certain unalienable Rights, that among these are Life,
Liberty and the Pursuit of Happiness—That to secure these
Rights, Governments are instituted among Men, deriving
their just Powers from the Consent of the Governed, that
whenever any Form of Government becomes destructive
of these Ends, it is the Right of the People to alter or to
abolish it, and to institute new Government, laying its
Foundation on such Principles, and organizing its Powers in
such Form, as to them shall seem most likely to effect their
Safety and Happiness."
注6：韦氏词典，1998年。
注7： 理论上来讲，我们将数量无限的输入值转换成了数量有限的输出值，所以两个不同的输入值就可能映
射为同一个摘要。这种情况被称为冲突（collision）。实际上，由于可用输出值的数量足够大，所以在
现实生活中，出现冲突的可能是微乎其微的，对我们要实现的密码匹配来说并不重要。
注8： MD5表示“报文摘要的第五版”，是摘要算法系列中的一种。安全散列算法（Secure Hash Algorithm，
SHA）是另一种常见的摘要函数。
306 ｜ 第13章
有时也将摘要函数称为加密的校验和、单向散列函数或指纹函数。
13.1.3 用随机数防止重放攻击
使用单向摘要就无需以明文形式发送密码了。可以只发送密码的摘要，而且可以确
信，没有哪个恶意用户能轻易地从摘要中解码出原始密码。
但是，仅仅隐藏密码并不能避免危险，因为即便不知道密码，别有用心的人也可以
截获摘要，并一遍遍地重放给服务器。摘要和密码一样好用。
为防止此类重放攻击的发生，服务器可以向客户端发送一个称为随机数（nonce）9
的特殊令牌，这个数会经常发生变化（可能是每毫秒，或者是每次认证都变化）。客
289
户端在计算摘要之前要先将这个随机数令牌附加到密码上去。
在密码中加入随机数就会使摘要随着随机数的每一次变化而变化。记录下的密码摘
要只对特定的随机值有效，而没有密码的话，攻击者就无法计算出正确的摘要，这
样就可以防止重放攻击的发生。
摘要认证要求使用随机数，因为这个小小的重放弱点会使未随机化的摘要认证变得
和基本认证一样脆弱。随机数是在WWW-Authenticate质询中从服务器传送给客户
端的。
13.1.4 摘要认证的握手机制
HTTP摘要认证协议是一种升级版的认证方式，所用首部与基本认证类似。它在传统
首部中添加了一些新的选项，还添加了一个新的可选首部Authorization-Info。
图13-2描述了简化的摘要认证三步握手机制。
图13-2中发生的情况如下所述。
• 在第（1）步中，服务器会计算出一个随机数。在第（2）步中，服务器将这个随
机数放在WWW-Authenticate质询报文中，与服务器所支持的算法列表一同发
往客户端。 290
• 在第（3）步中，客户端选择一个算法，计算出密码和其他数据的摘要。在第（4）
步中，将摘要放在一条Authorization报文中发回服务器。如果客户端要对服
务器进行认证，可以发送客户端随机数。
• 在第（5）步中，服务器接收摘要、选中的算法以及支撑数据，计算出与客户端
相同的摘要。然后服务器将本地生成的摘要与网络传送过来的摘要进行比较，验
注9： 随机数这个词表示“本次”或“临时的”。在计算机安全的概念中，随机数捕获了一个特定的时间点，
将其加入到安全计算之中。
摘要认证 ｜ 307
证其是否匹配。如果客户端反过来用客户端随机数对服务器进行质询，就会创建
客户端摘要。服务器可以预先将下一个随机数计算出来，提前将其传递给客户端，
这样下一次客户端就可以预先发送正确的摘要了。
客户端 服务器
（1）服务器产生随机数
（W 2）WW 服-A 务u 器th 发en 送t 域ic 、at 随e 机（ 数质 和询 算） 法
（3）从算法集中选择
一个算法。[产生响应
摘要][产生客户端随机数] [（ 发A 4 送u ）t 算客h 法o 户r ]i 发z 发a 送t 客io 户n 应（ 端摘响 随要应 机）
[端 送 响
（5）服务器对摘要进行认
数]
证[产生rspauth摘要][产生
Auth （e 数n [t 发）i 送c 服a 客务ti 户器o 端n 发- r送I spn 下 af uo 一 th（ 摘个信 要随息 ]机） 下一个随机数]
6
（7）客户端验证
rspauth摘要
图13-2 摘要认证的握手机制
这些信息中很多是可选的，而且有默认值。为了说明问题，图13-3对比了基本认证中
发送的报文（参见图13-3a至图13-3d）与简单的摘要认证实例发送的报文（参见图
13-3e至图13-3h）。
现在我们来更详细地探讨摘要认证的内部工作原理。
13.2 摘要的计算
摘要认证的核心就是对公共信息、保密信息和有时限的随机值这个组合的单向摘要。
现在我们来看看这些摘要是如何计算出来的。摘要计算通常都是简单易懂的。10附
录F提供了示例源代码。
13.2.1 摘要算法的输入数据
摘要是根据以下三个组件计算出来的。