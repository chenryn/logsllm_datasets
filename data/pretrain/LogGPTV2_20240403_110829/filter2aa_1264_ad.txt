names without MX records in this list only as a time saver for local (internal) mail.
LL2349.Book  Page 28  Friday, August 22, 2003  2:47 PM
Chapter 1    Mail Service Setup
29
Limiting Junk Mail
You can configure your mail service to decrease the volume of unsolicited commercial 
mail, also known as junk mail and spam. You can take steps to block spam that is sent 
to your mail users. 
You can also take steps to prevent senders of junk mail from using your server as a 
relay point. A relay point or open relay is a server that unselectively receives and 
forwards all mail addressed to other servers. An open relay sends mail from any domain 
to any domain. Junk mail senders exploit open relay servers to avoid having their own 
SMTP servers blacklisted as sources of spam. You don’t want your server blacklisted as 
an open relay, because other servers may reject mail from your users.
Your mail service can do any of the following to reduce spam:
• Require SMTP authentication
• Restrict SMTP relay, allowing relay only by approved servers
• Reject all SMTP connections from disapproved servers
• Reject mail from blacklisted servers
• Filter SMTP connections
Requiring SMTP Authentication
If your mail service requires SMTP authentication, your server cannot be used as an 
open relay by anonymous users. Someone who wants to use your server as a relay 
point must first provide the name and password of a user account on your server. 
Your local mail users must also authenticate before sending mail. This means your mail 
users must have mail client software that supports SMTP authentication or they will be 
unable to send mail to remote servers. Mail addressed to local recipients will still be 
accepted and delivered.
To require SMTP authentication, please see “Enabling Secure SMTP Authentication” on 
page 22, and “Enabling Less Secure SMTP Authentication” on page 23.
LL2349.Book  Page 29  Friday, August 22, 2003  2:47 PM
30
Chapter 1    Mail Service Setup
Restricting SMTP Relay
Your mail service can restrict SMTP relay by allowing only approved hosts to relay mail. 
You create the list of approved servers. Approved hosts can relay through your mail 
service without authenticating. Servers not on the list cannot relay mail through your 
mail service unless they authenticate first. All hosts, approved or not, can deliver mail to 
your local mail users without authenticating.
Your mail service can log connection attempts made by hosts not on your approved 
list.
To restrict SMTP relay:
1 In Server Admin, select Mail in the Computers & Services pane.
2 Click Settings.
3 Select the Filters tab.
4 Check “Accept SMTP relays only from these” 
5 Edit the list of hosts. 
a Click the Add button to add a host to the list.
b Click the Remove button to delete the currently selected host from the list.
c Click the Edit button to change the currently selected host from the list.
d Enter a single IP address, or the network/netmask pattern such as 192.168.40.0/21
SMTP Authentication and Restricted SMTP Relay Combinations
The following table describes the results of using SMTP authentication and restricted 
SMTP relay in various combinations.
SMTP requires 
authentication
Restricted 
SMTP relay
Result
On
Off
All mail servers must authenticate before your mail service will 
accept any mail for relay. Your local mail users must also 
authenticate to send mail.
On
On
Approved mail servers can relay without authentication. Servers 
that you have not approved can relay after authenticating with 
your mail service.
Off
On
Your mail service can’t be used for open relay. Approved mail 
servers can relay (without authenticating). Servers that you have 
not approved can’t relay unless they authenticate, but they can 
deliver to your local mail users. Your local mail users don’t have to 
authenticate to send mail.
This is the most common configuration.
LL2349.Book  Page 30  Friday, August 22, 2003  2:47 PM
Chapter 1    Mail Service Setup
31
Rejecting SMTP Connections From Specific Servers
Your mail service can reject unauthorized SMTP connections from hosts on a 
disapproved-hosts list that you create. All mail traffic from servers in this list is denied 
and the SMTP connections are closed after posting a 554 SMTP connection refused 
error.
To reject unauthorized SMTP connections from specific servers:
1 In Server Admin, select Mail in the Computers & Services pane.
2 Click Settings.
3 Select the Filters tab.
4 Check “Refuse all messages from these.”
5 Edit the list of servers.
a Click the Add button to add a host to the list.
b Click the Remove button to delete the currently selected host from the list.
c Click the Edit button to change the currently selected host from the list.
d When adding to the list, you can use a variety of notations.
e Enter a single IP address.
Rejecting Mail From Blacklisted Senders
Your mail service can reject mail from SMTP servers that are blacklisted as open relays 
by an ORBS server. Your mail service uses an ORBS server that you specify.
Important:  Blocking unsolicited mail from blacklisted senders may not be completely 
accurate. Sometimes it can prevent valid mail from being received.
To reject mail from blacklisted senders:
1 In Server Admin, select Mail in the Computers & Services pane.
2 Click Settings.
3 Select the Filters tab.
4 Check “Use these junk mail rejection servers.”
5 Edit the list of servers by adding the DNS name of an RBL server. 
a Click the Add button to add a server to the list.
b Click the Remove button to delete the currently selected server from the list.
c Click the Edit button to change the currently selected server from the list.
d Enter the domain name of the desired RBL server, such as rbl.example.com
LL2349.Book  Page 31  Friday, August 22, 2003  2:47 PM
32
Chapter 1    Mail Service Setup
Filtering SMTP Connections
You can use the firewall service of Mac OS X Server to allow or deny access to your 
SMTP mail service from specific IP addresses. Filtering disallows all communication 
between an originating host and your mail server. Mail service will never receive the 
incoming connection and no SMTP error will be generated and sent back to the client.
To filter SMTP connections:
1 In Server Admin, select Firewall in the Computers & Services pane.
2 Create a firewall IP filter using the instructions in the network services administration 
guide using the following settings:
• Access:  Denied
• Port number:  25 (or your incoming SMTP port, if you use a non-standard port)
• Protocol:  TCP
• Source:  the IP address or address range you want to block
• Destination:  your mail server’s IP address
3 If desired, log the packets to monitor the SMTP abuse.
4 Add more new filters for the SMTP port to allow or deny access from other IP addresses 
or address ranges.
For additional information on the firewall service, see the network services 
administration guide
LL2349.Book  Page 32  Friday, August 22, 2003  2:47 PM
2
33
2 Mail Service Maintenance
After setting up your mail service, there are some ongoing tasks to keep your mail 
service running efficiently and smoothly. The Server Admin application has a number of 
features that help you with these day-to-day tasks.
This chapter describes the maintenance of basic mail service, database, and mail store, 
including archiving. It also contains information about mail monitoring, logging, and 
undeliverable mail.
Starting and Stopping Mail Service
Mail service is ordinarily started automatically after you complete the Server Assistant. 
You can also use the Server Admin application to start and stop mail service at your 
discretion.
To start or stop mail service:
1 In Server Admin, select Mail in the Computers & Services pane.
2 Click Settings.
3 Select the General tab.
4 Make sure at least one of the mail protocols (SMTP, POP, or IMAP) is enabled.
5 Click Start Service or Stop Service in the menubar.
When the service is turned on, the Stop Service button is available.
If you plan to turn off mail service for an extended period of time, notify users before 
you stop the mail service.
LL2349.Book  Page 33  Friday, August 22, 2003  2:47 PM
34
Chapter 2    Mail Service Maintenance
Reloading Mail Service
Sometimes it is necessary to reload the mail server for mail service setting changes to 
take effect, for example, after restoring from backup, or altering the alias file. Reloading 
the mail service can be done without interrupting current mail service.
To reload outgoing mail service:
1 Start Terminal.
2 As root, enter the following command:
postfix reload
Changing Protocol Settings for Incoming Mail Service
You can change the settings for your incoming mail service. By choosing POP3, IMAP, or 
both.
1 In Server Admin, select Mail in the Computers & Services pane.
2 Click Settings.
3 Click the General tab.
4 Enable or disable the IMAP or POP checkbooks as needed.
Improving Performance
Mail service needs to act very fast for a short period of time. It sits idle until a user 
wants to read or send a message, and then it needs to transfer the message 
immediately. Therefore, it puts intense but brief demands on the server. As long as 
other services do not place heavy continuous demands on a server (as a QuickTime 
streaming server would, for example), the server can typically handle several hundred 
connected users.
As the number of connected mail users increases, the demand of mail service on the 
server increases. If your mail service performance needs improvement, try the following 
actions:
• Adjust the load each mail user can put on your server by limiting the number of mail 
connections. For instructions, see “Controlling the Number of IMAP Connections” on 
page 21.
• Move the mail storage location to its own hard disk or hard disk partition. For 
instructions, see “Specifying the Location for the Mail Database and Mail Store” on 
page 37.
• Run other services on a different server, especially services that place frequent heavy 
demands on the server. (Each server requires a separate Mac OS X Server license.)
LL2349.Book  Page 34  Friday, August 22, 2003  2:47 PM
Chapter 2    Mail Service Maintenance
35
Working With the Mail Store and Database
The mail database keeps track of messages for all mail service users. Mail service stores 
messages in separate files. You can do the following with the mail database and files:
• Repair the Mail Store Database.
• Convert the mail database from an earlier version of Mac OS X Server.
• Specify the location where the mail database and files are stored.
• Backup and restore the mail store.
All these tasks are described in this section.
Repairing the Mail Store Database
The mail service updates the database of stored messages each time a message is 
added, deleted, or moved. Sometimes during these updates, the mailstore’s database 
can become corrupted. When users report that mail messages have “disappeared” or 
become unreadable, the mail store database may be corrupted and need to be 
reconstructed.
Reconstructing a database can be done while the mail server is running. Additionally, it 
can be directed for any user to reconstruct only the affected mailboxes.
To reconstruct a corrupted database:
1 Start Terminal.app.
2 As root user, change to the cyrus user:
su cyrus
3 Enter the following command:
/usr/bin/cyrus/bin/reconstruct -r -f /var/spool/imap/[user name]
For more information about the reconstruct command, see their man pages by 
entering:
man reconstruct.
LL2349.Book  Page 35  Friday, August 22, 2003  2:47 PM
36
Chapter 2    Mail Service Maintenance
Converting the Mail Store and Database From an Earlier Version
If you have used any previous version of Apple Mail Service, you’ll need to convert your 
users’ mail messages and mail database to the current format.
To convert an earlier version of the Apple Mail Service mail database run the Terminal 
tool amsmailtool.
To convert the database:
1 Start Terminal.app.
2 As root user, enter the following command:
/usr/bin/cyrus/tools/amsmailtool
The conversion tool displays its status in the terminal as each user and mailbox is 
migrated.
Note:  To complete the mail database conversion successfully, the server must have 
enough available disk space. The amount of available disk space should equal the size 
of the database file being converted. If there’s not enough disk space available, 
amsmailtool won’t convert the mail database and messages.
Using Amsmailtool
The utility amsmailtool, if launched without arguments, runs as follows:
• The tool looks first for the 10.2.x mail database. If it doesn’t find one, it looks for the 
10.1.x mail database. If both exist, only the first one it finds will be migrated.
• Mail is exported to the default destination directory, creating target mailboxes as 
needed.
• Each migrated message is marked in the database to prevent duplicate migrations.
• If the migration is canceled, rerunning the tool continues the previous migration by 
checking if a particular message has already been migrated.
If you want to specify a single type of database, source directory, or target directory to 
migrate, you may run amsmailtool with certain arguments as options.
To see the complete list arguments and command syntax:
1 Start Terminal.app.
2 As root user, enter the following command:
/usr/bin/cyrus/tools/amsmailtool -help
LL2349.Book  Page 36  Friday, August 22, 2003  2:47 PM
Chapter 2    Mail Service Maintenance
37
Specifying the Location for the Mail Database and Mail Store
If you are starting mail service for the first time and you have no existing mail database, 
you can specify where the mail database and message files will be stored. By default 
mail database location is /var/imap/ and the mail store location is /var/spool/imap/.
To specify where mail is stored on the server:
1 If mail service is already running, stop the mail service. See “Starting and Stopping Mail 
Service” on page 33 for details.
2 In Server Admin, select Mail in the Computers & Services pane.
3 Click Settings.
4 Click the Advanced tab.
5 Enter the path of the location where you want the mail files to be stored in the “Mail 
store” field. 
You can browse for a location by clicking Browse next to the location field.
6 Restart or reload mail service.
When mail service starts for the first time, it creates an empty mail store at the default 
location. You can ignore this or delete it after you have specified an alternate mail 
storage location and restarted mail service.
Note:  Changing the mail store location of an existing mail system does not move the 
mail from the old location to the new one.
Backing Up and Restoring Mail Messages
You can back up the mail service data by making a copy of the mail service folder. If 
you need to restore the mail service data, you can replace the mail service folder with a 
backup copy. You can back up individual mail storage folders, or the entire mail store, 
as needed. One command line tool that can be used to back up your mail messages is 
ditto. See ditto’s man page for information.
Important:  Stop mail service before backing up or restoring the mail service folder. If 
you back up the mail service folder while mail service is active, the backup mail 
database file may go out of sync with the backup folder. If you restore while mail 
service is active, the active mail database file might go out of sync with the active 
folder.
An incremental backup of the mail service folder can be fast and efficient. If you back 
up your mail data incrementally, the only files copied are the small database file and 
the message files that are new or changed since the last backup.
After restoring the mail service folder, notify users that messages stored on the server 
have been restored from a backup copy.
LL2349.Book  Page 37  Friday, August 22, 2003  2:47 PM
38
Chapter 2    Mail Service Maintenance
If you’re using the UNIX Sendmail program or another mail transfer agent instead of 
Mac OS X Server’s SMTP service, you should also back up the contents of the /var/mail 
folder. This folder is the standard location for UNIX mail delivery. 
Monitoring Mail Messages and Folders
This section describes how to perform common administrator tasks for monitoring mail 
messages. It shows how to:
• Designate an account as a mail administrator account.
• Save mail messages for monitoring and archival purposes.
Allowing Administrator Access to the Mail Folders
You can configure IMAP to allow the server administrator to view the mail service 
hierarchy. Administrators cannot view mail itself, only users folder locations. 
Administrators can also create globally shared folders and set user quotas. To take 
advantage of this administrator access, you must use an email client that allows you to 
connect via the standard IMAP port (143).
When you connect as the IMAP administrator, you see all the user mail folders stored 
on the server. Each user’s mailbox appears as a separate folder in your mail client. You 
can remove inactive mailbox folders that belonged to deleted user accounts.
To configure administrator access to the mail folders:
1 In Server Admin, select Mail in the Computers & Services pane.
2 Click Settings.
3 Select the General tab and select Enable IMAP, if it is not already checked.
4 Select an existing user or create a new user using Workgroup Manger to be an IMAP 
administrator.
5 If you have not created a user record for the mail administrator’s account, see the user 
management guide.
6 Open /etc/imapd.conf in a text editor.
If you are not comfortable using a terminal text editor like emacs or vi, you can use 
TextEdit.
7 Find the line that reads “admins:”
8 Edit the line to add the UID number of the administrator account after the colon.
9 Save your changes.
10 In your email client application, create an account that uses IMAP to connect to your 
mail service using the mail administrator name.
 For more information, see the man page for imapd.conf.
LL2349.Book  Page 38  Friday, August 22, 2003  2:47 PM
Chapter 2    Mail Service Maintenance
39
Saving Mail Messages for Monitoring and Archival Purposes
You can configure mail service to send blind carbon copies (Bcc) of each incoming or 
outgoing message to a user or group that you specify. You might want to do this if you 
need to monitor or archive messages. Senders and receivers of mail don’t know that 
copies of their mail are being archived.
You can set up the specified user or group to receive the blind carbon copies using 
POP, then set up a client email application to log in periodically and clean out the 