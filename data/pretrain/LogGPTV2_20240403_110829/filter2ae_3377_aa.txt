# 写在最前
**先知技术社区独家发表本文，如需要转载，请先联系先知技术社区或本人授权，未经授权请勿转载。**
## LLMNR和NetBIOS
### LLMNR的定义
**链路本地多播名称解析** （ **LLMNR**
）是一个基于域名系统（DNS）数据包格式的协议，IPv4和IPv6的主机可以通过此协议对同一本地链路上的主机执行名称解析。
在DNS 服务器不可用时，DNS 客户端计算机可以使用本地链路多播名称解析 (LLMNR—Link-Local Multicast Name
Resolution)（也称为多播 DNS 或 mDNS）来解析本地网段上的名称。例如，如果路由器出现故障，从网络上的所有 DNS 服务器切断了子网，则支持
LLMNR 的子网上的客户端可以继续在对等基础上解析名称，直到网络连接还原为止。
除了在网络出现故障的情况下提供名称解析以外，LLMNR 在建立临时对等网络（例如，机场候机区域）方面也非常有用。
### LLMNR的工作过程
(1)
主机在自己的内部名称缓存中查询名称。如果在缓存中没有找到名称，那么主机就会向自己配置的主DNS服务器发送查询请求。如果主机没有收到回应或收到了错误信息，主机还会尝试搜索配置的备用DNS服务器。如果主机没有配置DNS服务器，或者如果在连接DNS服务器的时候没有遇到错误但失败了，那么名称解析会失败，并转为使用LLMNR。
(2) 主机通过UDP写发送多播查询，查询主机名对应的IP地址，这个查询会被限制在本地子网(也就是所谓的链路局部)内。
(3)
链路局部范围内每台支持LLMNR，并且被配置为响应传入查询的主机在收到这个查询请求后，会将被查询的名称和自己的主机名进行比较。如果没有找到匹配的主机名，那么计算机就会丢弃这个查询。如果找到了匹配的主机名，这台计算机会传输一条包含了自己IP地址的单播信息给请求该查询的主机。
### NetBIOS的定义
**Netbios(Network Basic Input Output System)：**
网络基本输入输出系统，它提供了OSI模型中的会话层服务，让在不同计算机上运行的不同程序，可以在局域网中，互相连线，以及分享数据。严格来说，Netbios是一种应用程序接口(API)，系统可以利用WINS服务、广播及Lmhost文件等多种模式
**将NetBIOS名解析为相应IP地址**
，几乎所有的局域网都是在NetBIOS协议的基础上工作的。NetBIOS也是计算机的标识名称，主要用于局域网内计算机的互访。NetBIOS的工作流程就是正常的机器名解析查询应答过程。在Windows操作系统中，默认情况下在安装
TCP/IP 协议后会自动安装NetBIOS。
### windows系统名称解析顺序
>   1. 本地hosts文件（%windir%\System32\drivers\etc\hosts）
>   2. DNS缓存/DNS服务器
>   3. 链路本地多播名称解析（LLMNR）和NetBIOS名称服务（NBT-NS）
>
也就是说，如果在缓存中没有找到名称，DNS名称服务器又请求失败时，Windows系统就会通过 **链路本地多播名称解析** （LLMNR）和 **Net-BIOS名称服务** （NBT-NS）在本地进行名称解析。这时，客户端就会将未经认证的UDP广播到网络中，询问它是否为本地系统的名称。这就产生了一个安全问题。由于该过程未被认证，并且广播到整个网络，从而允许网络上的任何机器响应并声称是目标机器。通过工具监听LLMNR和NetBIOS广播，攻击者可以伪装成受害者要访问的目标机器，并从而让受害者交出相应的登陆凭证。
## LLMNR和NetBIOS欺骗
### 原理探究
在使用传输控制协议 (TCP) 和互联网协议 (IP) 堆栈的网络（包括当今大多数网络）上，需要将资源名称转换为 IP
地址以连接到这些资源。因此，网络需要将“resource.domain.com”解析为“xxxx”的 IP
地址，以便准确知道将流量发送到何处。Microsoft Windows 客户端在尝试将名称解析为地址时遵循一系列方法，在成功将名称与 IP
地址匹配时停止搜索。
当计算机请求网络资源时，它通常遵循下面指定的查询层次结构（使用略有不同的配置）来识别目标资源。一旦名称被识别，它就会停止。
>   1. 检查以确认请求是否针对本地机器名称。
>   2. 检查最近成功解析的名称的本地缓存。
>   3. 搜索本地主机文件，该文件是存储在本地计算机上的 IP 地址和名称列表。根据设备的不同，此文件可能已加载到本地缓存中。
>   4. 查询 DNS 服务器（如果已配置）。
>   5. 如果启用了 LLMNR，则跨本地子网广播 LLMNR 查询以询问其对等方进行解析。
>   6. 如果启用了 NetBIOS，如果名称不在本地 NetBIOS 缓存中，则通过向本地子网广播 NetBIOS-NS 查询来尝试 NetBIOS
> 名称解析。如果如此配置，此步骤可能会使用 Windows Internet 名称服务 (WINS) 服务器以及 LAN 管理器主机 (LMHOSTS)
> 文件。
>
注意，计算机的 NetBIOS 名称及其主机名可以不同。但是，在大多数情况下，NetBIOS 名称与完整主机名相同或截断后的版本。IP 的 NetBIOS
名称解析可以通过广播通信、使用 WINS 服务器或使用 LMHOSTS 文件进行。
### 深入探究
这些协议的主要问题是受害计算机对其网络段内的其他设备的固有信任。如果计算机无法在上面列出的前四个步骤中识别出它正在寻找的资源，我们最喜欢的本地名称解析协议就会发挥作用。最好的例子是当用户输入错误的资源名称或请求不再可访问的资源时。
这种情况经常发生在网络的用户段，这就是攻击者进入的地方。一旦攻击者注意到网络上正在通过 LLMNR 或 NetBIOS-NS
请求这些资源，攻击者就无法阻止对受害计算机的响应，并且实际上是在告诉请求资源的主机自己就是被寻找的那个资源。事实上，我们可以更进一步的受害计算机，你应该尽快使用凭证跟我进行认证。果然，受害计算机使用其网络凭据的散列版本来响应攻击者。
与易受攻击的网络发现协议相关的利用步骤如下：