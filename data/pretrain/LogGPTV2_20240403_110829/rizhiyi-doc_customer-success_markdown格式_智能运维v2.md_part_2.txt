-   Loganalyzer：日志异常检测模块，也可以通过Spark模块实现分布式检测；
-   Influxdb_itsi：存储实时指标数据，训练模型，服务健康度计算结果；
-   MySQL：存储智能运维的配置管理信息在rizhiyi_itsi库中，相关如设备、服务等；
-   MongoDB：日志异常检测模块使用的日志训练模型数据库；
![](media/image10.png){width="5.768055555555556in"
height="1.5979166666666667in"}
备注：目前的智能运维模块只能单节点运行，暂不支持集群。单点风险在数据量比较大的情况下，可能会存在性能瓶颈。
## 功能模型
日志易智能运维Lynxee应用从服务和设备的运维角度出发，接入所需关注的重要指标项，通过合适的算法模型实时监控时序指标项的数据值来度量IT服务的质量和性能。
日志易智能运维Lynxee应用自动判断监控结果，无需手动设定监控阀值，通过服务的多层级指标关联来自动监控指标的异常和服务的健康度；通过日志模式发现异常，为复杂业务系统提供服务健康度总览、异常指标项和影响程度实时感知，实现问题快速定位，辅助修复决策。
Lynxee的功能模型图如下图所示：
![服务健康度监控架构@2x-2.png](media/image11.png){width="5.768055555555556in"
height="3.692361111111111in"}
Lynxee提供了相关项分析、告警、服务、设备性能看板等智能运维功能。这些功能是通过指标、监控项、设备信息等数据的分析实现的。
服务和设备的概念：
-   服务可以是平台、集群服务、IDC、 分布式应用、在线业务、基础设施
-   设备可以是组件、节点、 IT资产、系统对象、关键进程
服务健康度的得分取决于以下三方面：
-   监控项数量
-   单个监控项的权重值
-   单个监控项的当前危急程度
日志易智能运维Lynxee涉及的一些IT名称，及其在Lynxee应用中的概念说明如下。
### 数据格式
**服务以\`.\`串联服务名称作为多层级树状关系结构，设备通过索引字段值关联指标项，如endpoint或自定义tag。**
提示：endpoint其实就是设备名称，同一类的设备endpoint的值一致，同一类的metric可以是相同的endpoint，命名规范遵循服务-设备-指标的层次结构，service、endpoint、自定义tag可以使用中文，命名结构看起来直观，service和metric使用.来折叠层级，更容易管理大量指标项。
![](media/image12.png){width="5.768055555555556in"
height="1.9944444444444445in"}
智能运维的kpi_monitor模块从kafka的lynxee_kpis队列实时接收指定格式的json数据，通过服务-指标-设备来依次选择预览指标数据，并可设为异常检测算法监控项。
智能运维中预览指标数据时显示的浮点型指标值为小数点3位数。
### 服务
服务是由作用于**同一个业务目的**的IT对象组成的逻辑集合。就目前而言，我们采用广义的服务概念来组织日志易Lynxee的结构。服务既可以是业务层面的，也可以是技术层面的。比如:
-   一个应用或者一组应用；
-   一个基础设施层，比如web服务、数据库服务、网络层；
-   一个业务层，比如在线商城；
-   一个独立进程，比如在某台机器上运行的一个应用的实例。
不论是业务层面还是技术层面，服务之间都是有相关关联影响的。比如在线商城服务需要同时有web服务、应用服务、数据库服务，而且这三个技术服务之间又逐一依赖，如果集群部署，则还依赖于网络服务。所以，**服务的依赖关系，也是重要的信息之一**。
### 设备
设备实体是一个IT设施组件。通常而言，以下都可以称为IT环境中的设备:
-   物理服务器；
-   虚拟机或容器；
-   网络设备，如交换机、防火墙；
-   AD/LDAP域中的账号；
-   挂载磁盘或存储卷；
-   操作系统进程；
-   应用软件。
设备有一系列的属性，包括唯一属性和关联属性两类：
-   唯一属性用来区分该设备与其他设备的不同，通常而言会是资产编号、主机名称、IP
    地址等。
-   关联属性用来丰富设备的信息，可能多个设备关联到相同的信息上,比如:负责人、业务线、机房、机架等。
设备和ITIL框架里的CI配置项概念比较接近。不过CI概念更广泛，甚至我们前面说的服务也属于CI。Lynxee拆分了服务和设备的概念，设备可以从属于服务。
在Lynxee中，可以标记设备的部分属性为索引字段值，可将日志易采集的来自该设备的日志数据与之关联起来。
### 指标
指标是一组时间序列数据的简称。在IT运维领域，时序数据又可以分为只有死活的状态数据和有连续取值空间的指标数据两种。比如：系统平均负载、内存使用率、查询响应时间等等。Lynxee系统本身并不产生指标数据，而是接入和存储已有数据。为了方便展示结构和组织关系，接入指标时应按规范转换名称格式，以便关联服务和设备。
在复杂的IT环境中，通常存在海量的指标数据，但未必所有指标都对IT服务质量会造成明显的影响，所以，运维人员通常更加关注其中一小部分比较重要指标的实时情况，而另一部分指标，仅在巡检和排障过程中才会临时使用。对于需要实时关注的指标，设置为监控项，根据设定的监控方法，可以给出监控结果。比如：是否异常、异常等级、异常可信度等。
在Lynxee中，日志易提供多种智能算法，自动判断指标的监控结果，而无需用户手动设定监控阈值。异常检测算法将自动给出监控项的健康值得分，取值在
\[0-100\]
之间。通常我们认为60以上均为正常。为直观理解，系统约定监控项异常分值如下：映射到危险程度上：0-10（高危程度，红色）；10-30（中危程度，黄色）；30-60（低危程度，绿色）；60-100（正常程度，蓝色）。
# 产品部署
在安装日志易产品后，智能运维应用Lynxee默认是没有启用的。如需使用智能运维功能，需要先添加智能运维实例。
智能运维功能成功启用后，还需接入待分析的指标数据，才能开始产品的正式使用。
## 添加智能运维实例
智能运维产品的部署主要涉及以下4个模块：
-   Influxdb_itsi：存储指标数据、健康度、设备信息在Influxdb数据库中。
-   Kpi_monitor：指标数据的消费和处理。
-   Loganalyzer：日志算法服务。
-   Kpi_analyzer：指标算法服务。
3.0之前版本安装步骤：
1、通过日志易manager导入influxdb_itsi、kpi_monitor、kpi_analyzer、loganalyzer四个安装包，激活重启，然后为各模块添加单实例。
2、确保mysql升级到3.0.0.12以上。
3、需要license支持智能运维模块，并且在租户页面启用Lynxee支持特性，角色权限启用可使用Lynxee功能。如license不支持，需申请具有Lynxee特性的License。
3.0之后版本已经默认安装了以上4个模块，使用时添加实例即可。
**升级提示：**
最初的版本使用的influxdb数据库是mydb，数据保留策略为1个月，升级到当前最新发布的版本安装包后使用的数据库为lynxee。
需要将mydb数据库的数据迁移到lynxee数据库，使用研发提供的脚本迁移。
示例：./influx_fix_rp 18086 mydb lynxee
/opt/rizhiyi/parcels/influxdb_itsi/bin/
链接：
以日志易V3.1环境下初次部署智能运维模块流程为例，具体添加示例的步骤如下：
### 添加实例
进入Manager界面，初次部署时influxdb_itsi、kpi_monitor、loganalyzer、kpi_analyzer四个模块均未添加实例，需将四个模块添加实例后启动模块，manager界面添加实例如图3.1所示。
![](media/image13.png){width="5.768055555555556in"
height="2.504166666666667in"}
图3.1 Manager界面添加实例
以kpi_monitor模块为例，选中需要部署模块的机器，点击下一步，为模块添加实例。如图3.2所示。
![](media/image14.png){width="5.768055555555556in"
height="2.5194444444444444in"}
图3.2 模块添加实例
将添加好实例的模块启动，其余三个模块步骤相同，模块启动如图3.3所示。
![](media/image15.png){width="5.768055555555556in"
height="2.5055555555555555in"}
图3.3 模块启动
### 确认Lynxee特性
智能运维功能使用前应确认license支持特性中是否包含智能运维（Lynxee），智能运维的使用依赖license中Lynxee特性，license支持特性如图3.4所示。
![](media/image16.png){width="5.768055555555556in"
height="1.2680555555555555in"}
图3.4 license特性支持
进入日志易租户界面（http://ip/domain/tenant/），在支持特性中确认是否添加Lynxee特性，智能运维使用依赖此特性，租户界面添加特性如图3.5所示。
![](media/image17.png){width="5.768055555555556in"
height="1.7555555555555555in"}
图3.5 租户界面添加特性
以上操作完成后，前端智能运维功能即可使用，入口在日志易前端界面左侧"智能运维"，智能运维入口如图3.6所示。
![](media/image18.png){width="5.768055555555556in"
height="3.095138888888889in"}
图3.6 智能运维入口
### 注意事项
智能运维产品部署注意事项：
-   确认License中是否包含智能运维（lynxee）特性，智能运维模块使用需要此特性支持。
-   智能运维模块实例添加完成后，如前端无法看到智能运维功能，需进入到租户界面确认支持特性中是否选中智能运维（lynxee）特性。
-   智能运维日志异常检测功能使用时如不使用spark模块，loganalyzer配置中需要把spark.distributed、spark.detect两个配置改成false，如果使用spark模块可以配置成true，参数配置图3.7所示。
![](media/image19.png){width="5.768055555555556in"
height="2.502083333333333in"}
图3.7 参数配置
1.  ## 指标数据的对接