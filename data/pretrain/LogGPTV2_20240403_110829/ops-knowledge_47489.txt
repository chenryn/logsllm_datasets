User: How to set weight and session persistence when using Nginx as load balancer? Please give sample code.
Assistant: Set the weight: upstream backend { server backend1.example.com weight=5; server backend2.example.com; server backend3.example.com weight=3; } In the above code block, the weights of the three servers are 5 and 1 respectively and 3. This means that the first server will receive about 5/9 of the traffic, the second about 1/9 of the traffic, and the third about 3/9 of the traffic. Set session persistence (sticky session): upstream backend { ip_hash; server backend1.example.com; server backend2.example.com; server backend3.example.com; } This configuration uses the ip_hash directive, which will send each request according to The client IP address is distributed to a backend server. This method creates a mechanism called "client IP-based session persistence". When the same client sends multiple requests, the backend server will handle all requests from this client. Note that in the case of using ip_hash, if a backend server goes down, all requests from the client will be forwarded to the remaining servers. If you want to maintain session persistence, you should consider using other load balancing algorithms. For example, hashes can be used to distribute requests so that the same user requests are always sent to the same backend server. For example: upstream backend { hash $request_uri; server backend1.example.com; server backend2.example.com; server backend3.example.com; } In this example, the hash directive is used, which uses the hash value of the request URI to Choose a backend server. This means the same request URI will always be sent to the same backend server.