# 【木马分析】挂马新招：全程纯Flash文件挂马传播勒索软件技术揭秘

#### 译文声明
本文为翻译文章，原文来源于安全客。译文仅供参考，具体内容和含义以原文为准。

## 1. 概述
近期，360互联网安全中心监测到“我爱卡”网站（51credit.com）出现挂马情况。进一步分析发现，访问该网站会加载一个跳转至漏洞攻击包（Exploit Kit）页面的恶意Flash广告。缺乏专业安全防护的用户电脑将被感染Sage 2.0勒索软件，导致文件被加密并遭受严重损失。与以往不同的是，此次攻击链完全通过Flash文件实现，不再依赖HTML或JavaScript脚本交互功能，展示出新的攻击形式和技术水平。

## 2. 技术分析

### 2.1 广告挂马点
**整体挂马流程**
我爱卡网站使用了OpenX开源广告系统，该系统因审核不严已多次成为漏洞攻击包的传播渠道。浏览该网站任意页面时，会插入一个名为`hxxp://conxxxxxxxxx.info/admedia/player.swf`的广告Flash文件。此文件实际并无显示内容，而是利用AS3代码获取Flash版本号并进行判断，仅在IE浏览器且安装了Flash 11~21版本的情况下才会加载第二个Flash文件。这一设计有效减少了实际攻击页面的暴露，并使文件更易躲避检测。

### 2.2 第二个Flash加载器
第二个加载的Flash文件同样是一个加载器，其功能与第一个文件相同，但该文件是动态生成的。根据网络请求响应头推测，该文件可能是通过PHP动态生成的，每隔一段时间加载下一个Flash文件的地址都会变化。此外，该文件的Content-Type被设置为默认的`text/html`，这使得部分依赖Content-Type进行文件类型判断的网络检测设备难以察觉，从而降低了被发现的概率。

### 2.3 Flash漏洞攻击文件
第三个加载的Flash文件才是真正的攻击文件。攻击者还采取了IP屏蔽或随机阻拦请求的策略，增加了分析难度。服务器会根据用户的Flash版本信息返回不同的漏洞利用脚本，这些脚本包括CVE-2015-8651、CVE-2016-1019和CVE-2016-4117等常见漏洞代码。这些漏洞具有较高的攻击成功率。

### 2.4 释放载荷
利用漏洞后，Shellcode代码会被执行。不同于常见的VBS或Powershell下载方式，该Shellcode会向当前网址发送请求，下载一个二进制数据到Internet临时目录，解密转换后运行payload。最终运行的Payload是Sage 2.0勒索软件，该软件采用巧妙的密钥交换和加密算法，并基于IP地址生成算法来生成回传IP，被认为是目前勒索软件中的佼佼者。一旦感染，用户的所有文件将被加密，桌面背景被替换为提醒壁纸，并伴有周期性的语音提示。

## 3. 数据重放
在研究此类挂马事件时，通常使用Fiddler工具进行数据重放以便反复研究。然而，由于该Exploit Kit在同一网址分别返回Flash和二进制内容，Fiddler无法区分这两种请求。因此，我们编写了一个基于Tornado的Web服务器，提取抓包得到的返回内容，并根据每次请求的不同URL和请求头返回对应的数据。使用时，在某个端口开启服务并将IE代理设置到该端口，即可实现数据重放。

## 4. 总结
本次挂马事件利用广告系统发布恶意Flash文件，通过域名生成算法隐藏攻击代码域名，并使用勒索软件获取经济收益。尽管Flash代码未混淆且保护程度较低，但整个攻击流程完全采用Flash文件作为载体，没有交互页面，不易被现有针对HTML和JavaScript脚本的检测与防护机制发现。建议用户及时更新系统补丁和Flash版本，并安装广告屏蔽软件以避免访问恶意页面。360安全卫士采用多层次防护体系，能够有效拦截此类攻击行为，并提供反勒索服务，若用户中毒造成损失，360将负责赔付最高3比特币的赎金并协助恢复数据。

## IOC信息
**URL/IP:**

**Flash:**
- 418b81d6371bf5e41deaf244c2813479
- 9558a62c2198709cd8f4cbace3b3d33f
- d5b20d0755e3bdfdbdfd13ddfd477f7f
- c1d426fbdd0ccb06b8882089dcbfd755
- 33a0e632b37dea78a808d5c197a01404
- d415c88480d64f7beefb8e2ceab0923a
- b0849abe0d436dba8862f0dcbda93aae
- c8fced7d0489e930f48cef70f6695e01
- 01e1cdd0f97215c5421d0358179f8af3

**PE:**
- 005b3f47b1a6b06053d2cce7473b6256
- 37f6a4715c24ab1c8e5efd95440d3440

## 参考文献
1. Top-ranked Advertising Network Leads to Exploit Kit
2. 漏洞工具包利用广告位挂马针对国内用户传播Cerber4.0勒索软件
3. 暗黑客栈CVE-2015-8651漏洞原理分析
4. CVE-2016-1019: A New Flash Exploit Included in Magnitude Exploit Kit
5. Adobe在野漏洞：CVE-2016-4117漏洞分析
6. 2017年最佳算法提名勒索软件（sega）分析