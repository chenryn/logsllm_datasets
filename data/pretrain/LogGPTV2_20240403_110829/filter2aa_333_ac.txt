18CB4C27677A526201000100BB10DCCFE8681DD551FF5B0CCA0123BBB83FA6A3F659351C0E98A583 
843488CDB5E1E55C3E5B22010A2047DB06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1 
C091EDDC0C054E6A47881065 
Figure:8B(OnlyNTLMHashDataStored)
Whenexaminingtheseheadervaluesthatdescribewhetherornotahashispresent
foreitherLMorNTLM,asseenintheaboveFigures8Aand8Binblue,twovalues
arepresentthatwhenunpackedresultineithera0x04ora0x14.If0x04,this
meansthatahashisnotpresentandif0x14,thismeansthatahashispresent.
Knowingthis,amodifiedparsingalgorithmwasdevelopedtoworkasfollows:
1. Read160bytes(0xA0)frombeginningofdatastructure
2. Thenparsethenext4bytesasaninteger(lm_header)
3. Read172bytes(0xAC)frombeginningofdatastructure
4. Thenparsethenext4bytesasaninteger(nt_header)
5. Read156bytes(0x9c)frombeginningofdatastructure
6. Thenparsethenext4bytesasaninteger(X)
7. HashDataOffset=X+204bytes(0xCC)
8. Iflm_header==20then
a. lm_exists=true
b. lm_offset=HashDataOffset+4
c. ParseLM
9. Ifnt_header==20then
a. Iflm_exists
i. 
nt_offset=HashDataOffset+24
ii. 
ParseNTLM
b. Else
i. 
nt_offset=HashDataOffset+8
ii. 
ParseNTLM
Usingtheabovelogic,atoolwillparseFigures8Aand8Btoobtainthecorrecthash
dataevenwithadditionaldatapresentattheendofthedatastructure.
14000000 (lm_header) 
14000000 (nt_header) 
010001009AC412C7DA10C788963DF9DF7E6B5EF401000100B0FD8B04845B3E6836EC62ED 
D3EC84CA0100010015F478C0D71D99AB56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF17 
8E47CFC180A85D50451DBBCD73DB89F3E81DC94989A51D23610F8669762EBFD5DF73B40F40B95683 
5E95719E0C18D4B27CAC2754CA807AD818CB4C27677A52621BA0A5AFB8CAA34AC3DFCDA8054B9395 
14CD7E8A51840220C7E1AF65C0865C015E517C522EAB6710181584F4E2D0652C0100010030077263 
8DEB345851FF5B0CCA0123BB9B5C279A405AC24B0E98A583843488CD968264658858D5560A2047DB 
06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1C091EDDC0C054E6A47881065C4F38C5C 
F888781246B88769BCE6E08E3ADBC06193EF250EC43775C8A5AE558A44F87484AED9BE0B73464DCD 
A257CC67 (hash data section) 
Figure:9A(LMandNTLMHashDataStored)
04000000 (lm_header) 
14000000 (nt_header) 
01000100B0FD8B04845B3E6836EC62EDD3EC84CA0100010015F478C0D71D99AB 
56AB61F0921DE0EF9C21D096BE07202EDF579D32EF31DF172549756090BA6CB58D6EB32C31E0714E 
B7CF5C2A4073BEBF1C979A4CD4F07404747D0EAE50AB676696E6797F4E232C0F7CAC2754CA807AD8 
18CB4C27677A526201000100BB10DCCFE8681DD551FF5B0CCA0123BBB83FA6A3F659351C0E98A583 
843488CDB5E1E55C3E5B22010A2047DB06FC11269C826D74B1EA6C1F2B6293F992E0360D562D62A1 
C091EDDC0C054E6A47881065 (hash data section) 
Figure:9B(OnlyNTLMHashDataStored)
Asseeninfigures9Aand9B,therespectiveLMandNTLMhashheaderelements
indicate(via0x04or0x14)whetherthehashexistsornot,soatoolcannowmake
thecorrectparsingdecisionswhenitcomestoreadingthroughthehashdata
section.Onceatoolappliesthefinalsteps(5‐7listedabove),thecorrecthashdata
isobtainedforbothexamplesasfollows:
9AC412C7DA10C788963DF9DF7E6B5EF4 (LM HASH DATA) 
  B0FD8B04845B3E6836EC62EDD3EC84CA (NTLM HASH DATA) 
Figure:10A(LMandNTLMHashDataStored)
  B0FD8B04845B3E6836EC62EDD3EC84CA (NTLM HASH DATA) 
Figure:10B(OnlyNTLMHashDataStored)
Affected Tools and Origins 
Alargenumberoftools,whichextracthashesfromtheregistrywereconsideredas
partofthisresearch.Toolsthatwereconfirmedasproducingcorruptedhashes
whenusingtheregistryextractionmethodwereasfollows:
 MetasploitHashdumpScript
 Creddump
 Samdump21.0.1
 CainandAble
 Pwdump
 Pwdump5
 Pwdump7
 FGDump3.0
 l0phtcrack6.0
Ofthesetools,therewasamixofbothopen‐sourceandclosed‐sourceprojects.By
examiningthesourcecodefromtheopensourcetools,thehashestheyproduced
andthehashesproducedfromtheclosedsourcetools,itwasclearthatsimilarlogic
wasusedbyallofthem,whichresultedinthesameincorrecthashes.
Intracingtheoriginofthesetools,itwasdeterminedthatPwdumpversion1
(Pwdump)waslikelythefirsttooltoreverseengineertheprocessofgathering
hashesfromtheregistry.
BeingthatPwdumpwasanopen‐sourcetool,itwasclearlyasourceofinformation
andinspirationforothernewtoolauthorsthateventuallybeganusingthis
approachandassociatedlogicforparsingregistrydata.Byreadingthroughtool
changelogs,blogpostsandotheronlinesources,thefollowingrelationshipdiagram
wasconstructedtoshowhowPwdumphadinfluencedthesetoolsandhowit’s
influencespreadthroughgenerationsoftools.
Figure:11A
Althoughtheserelationshipsareimportantinshowinghowallthesetoolsendedup
usingthesimilarlogic,itisequallyifnotmoreimportanttounderstandthe
chronologicaltime‐lineofwhenthesetoolsweredevelopedasseeninthefollowing
diagram.
Figure:11B
Theabovediagramcontainstwoentriesforsamdump2becausein2007,samdump2
identifiedthataflawexistedanddevelopedacodefixforthisissueintheir1.1.1
release.Ironically,5yearslaterthetoolsthatSamdump2helpedinfluencedirectly
orindirectly,still(atthetimeofthiswriting)usetheincompletelogicas
implementedinthe1.0.1releaseofSamdump2andPwdumpversion1asdiscussed
inthetechnicalsectionofthispaper.
Conclusions and Take Aways 
Securityprofessionalsthatareusingextractiontoolstoobtainpasswordhashes
fromWindows‐basedsystemsviatheregistryareregularlyreceivingcorrupted
hashes.Thisisduetoalogicflawusedbymanytoolsthatwasdescribedindetail
withinthiswhitepaper.
Inadditiontotheidentificationoftheflawanditshistory,patcheshavebeen
developedforbothMetasploitandCreddump,whicharebothopen‐source.The
goalherewastoensurethatmanyofthetoolsdescribedhereareupdatedtoutilize
theimprovedlogicdescribedinthispaper.Tothisend,anactiveoutreachto
closed‐sourcetooldevelopersinthisspace,suchasCainandAble,L0phtcrack,
Pwdump7andFgdump,isalreadyunderwayandsomeoftheseupdatesarealready
indevelopmentandshouldbeavailablesoon.
Definition of Terms 
Hash–Theactualpasswordhash(LMorNTLM)thatisgeneratedfromHashData
thatrepresentstheencryptedformofaclear‐textpassword.Thisiswhatcanbe
directlysuppliedtoacrackingtoolsuchasJohntheRipper(JtR).
HashData–Thesource(orseed)datathatisstoredwithintheregistrykey“V”for
eachuserthatistransformedintoeitheraLMorNTLMhashthroughaseriesof
cryptographicalgorithms.Thisdataalonecannotbedirectlysuppliedtoacracking
toolsuchasJohntheRipper(JtR).
HashDataSection–AsubsetoftheVkeystoredintheSAMhiveforeachuserthat
containshashdata,whichhasyettobeparsedintohashdataelements.
References 
Clark,Peter."SecurityAccountsManager."SecurityAccountsManager.
Beginningtoseethelight.org,3Apr.2005.Web.01June2012.
.
Dolan‐Gavitt,Brendan."CredDump:ExtractCredentialsfromWindowsRegistry
Hives."PushtheRedButton.Moyix.blogspot.com,20Feb.2008.Web.05July
2012..
Dolan‐Gavitt,Brendan."SysKeyandtheSAM."PushtheRedButton.
Moyix.blogspot.com,21Feb.2008.Web.01June2012..
Dolan‐Gavitt,Brendan."Creddump‐0.2.tar.bz2‐Creddump‐Creddump0.2‐
ExtractsCredentialsfromWindowsRegistryHives."CreddumpSourceCode
Repository.N.p.,Feb.2008.Web.01June2012.
.
Fizzgig."Fgdump:AToolForMassPasswordAuditingofWindowsSystems."
Http://fgdump.com/.Fizzgig,8Oct.2011.Web.01June2012.
.
Moore,HD."Bug#4402:HashdumpScript/postModuleBreakswithPasswords
Greaterthan14Characters."MetasploitFrameworkIssueTracker.Rapid7,11
Mar.2011.Web.1June2012.
.
Moore,HD."Metasploit‐framework/Scripts/Meterpreter/Hashdump.rb."
MetasploitSourceCodeRepository.Rapid7,31Dec.2009.Web.05July2012.
.
Moore,HD."Safe,Reliable,HashDumping."MetasploitCommunityBlog.Rapid7,01
Jan.2010.Web.05July2012.
.
Mueller,Lance."ComputerForensics,MalwareAnalysis&DigitalInvestigations:
BypassingaWindowsLoginPasswordinOrdertoBootinaVirtualMachine."
ForensickKB.Forensickb.com,22Feb.2008.Web.1June2012.
.
Oechslin,Philippe,andCedricTissieres."Ophcrack‐Samdump2(samdump2‐
1.1.1.tar.gz)."OphcrackSourceCodeRepository.SourceForge,22Nov.2007.
Web.05July2012.
.
"Oxid.it‐Cain&Abel."Oxid.it‐Cain&Abel.Oxid.it,n.d.Web.01June2012.
.
Rioux,Christien,ChrisWysopal,andPeiterMudgeZatko."L0phtCrackPassword
AuditorV6‐Documentation."L0phtCrackPasswordAuditor.L0phtcrack.com,
n.d.Web.01June2012..
"SAMInside."InsideProPasswordRecoverySoftware.InsideProSoftware,n.d.Web.
01June2012..
Tarasco,Andres,andMiguelTarasco."PasswordDumperPwdump7(V7.1)."
TarascoSecurity.Tarasco.org,03Oct.2010.Web.05July2012.
.