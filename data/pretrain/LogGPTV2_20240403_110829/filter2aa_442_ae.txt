ITDR 之 vSphere
26
4.3.6 vCenter备份文件泄露
vCenter 提供了两种备份文件的方式，一种是基于计划的文件备份，另一种是手动立即备份，支持的备份协
议有 FTPS，HTTPS，SCP，FTP，NFS，SMB 和 HTTP，备份路径格式为协议 :// 服务器 IP 地址 : 端口号 / 共享
文件夹路径。在计划文件备份中可以设置全备份和差异备份，备份时间，还有是否加密备份文件。
如果我们在备份的时候未选择加密备份文件，并且未将我们的备份文件放置安全的位置，造成备份文件泄漏，
攻击者可以解压此备份文件，查找一些重要配置文件例如 vcdb.properties 配置文件，接着配置一些其他漏洞，
获取其管理的 ESXI 账号密码，从而接管整个 ESXI。
利用方法
备份文件泄漏在实战环境中需要进行寻找，此处作为复现，首先正常搭建一个 wingftp 服务器，创建一个用
户 test，并且修改此用户权限，允许这个用户创建目录文件。
然后让 vCenter 进行立即备份，备份位置为我们的 ftp 服务器地址，此时我们不进行加密备份
4.vSphere 攻击技战法
27
备 份 成 功 然 后 解 压 里 面 的 config_files.tar.gz 进 入 etc\vmware-vpx\vcdb.
properties 可以看到 PostgreSQL 的连接账号密码，不同系统存放 PostgreSQL 配
置文件位置如下：
4.3.7 EAM用户服务文件读取
在 vCenter 版本在 6.5.0a-6.5.0f 中，存有一个未授权文件读取漏洞，漏洞原
理是在 EAM 目录对应的一个名为 vibServlet 的 servlet，此 servlet 对应有一个
ITDR 之 vSphere
28
FileServlet 的类，这个类 doGet 方法在进行读取文件的时候直接从 url 中获取文件
路径，并且未对其进行过滤直接交给 id 参数进行文件读取，造成未授权文件读取。
攻击者可以借助此漏洞读取 PostgreSQL 数据库的配置文件 vcdb.properties，
其里面存储有 PostgreSQL 数据库的账号密码，如果 PostgreSQL 数据库配置了可
以外部连接此数据库，则可以直接获取到其数据库中有关 ESXI 的敏感凭据信息。
利用方法
攻击手法类似，不同点在于不同系统环境下的文件路径：
4.3.8 vCenter服务扫描
vCenter 安装好后会开放一些特定的服务端口，如 443，5480(vCenter Server 
Appliance Web 控制台 )，389(LDAP 服务端口 )，902（管理主机端口）等，我们
可以通过这些开放端口来作为 vCenter 服务特征，类似于在针对 AD 域攻击时扫描
88、389 端口识别域控。
并且对于其中的一些端口，可能面临弱口令以及一些其他的服务缺陷漏洞，攻
4.vSphere 攻击技战法
29
击者可以通过这些服务特征来批量搜索网络中的 vCenter 服务器并进行攻击，同时
攻击者也可以借助一些空间测绘工具来进行搜索，然后批量对 vCenter 发起攻击。
常见的 vCenter 开放的服务端口，以及服务描述。
端口
协议
描述
22
TCP/UDP
SSHD 的系统端口。此端口仅供 vCenter Server Appliance 使用。
80
TCP
vCenter Server 需要使用端口 80 进行直接 HTTP 连接。端口 80 将请
求重定向到 HTTPS 端口 443。如果您无意中使用 http://server（而非 
https://server），这种重定向将非常有用。
88
TCP
VMware 密钥分发中心端口。
389
TCP/UDP
此端口在 vCenter Server 的本地和所有远程实例上必须处于打开状态。
这是 vCenter Server 组的目录服务的 LDAP 端口号。 如果此端口上正
在运行另一服务，则最好移除该服务，或将其端口更改为其他端口。可
以在从 1025 到 65535 的任意端口上运行 LDAP 服务。 如果此实例充
当 Microsoft Windows Active Directory，请将端口号从 389 更改为从 
1025 到 65535 的任一可用端口。
443
TCP
vCenter Server 系统用于侦听来自 vSphere Web Client 的连接的默认端
口。要使 vCenter Server 系统接收来自 vSphere Web Client 的数据，请
在防火墙中打开端口 443。 vCenter Server 系统还使用端口 443 监控来
自 SDK 客户端的数据传输。 端口 443 还用于以下服务： 
*   WS-Management（也需要打开端口 80） 
*   第三方网络管理客户端与 vCenter Server 的连接 
*   第三方网络管理客户端对主机的访问
514
TCP/UDP
Windows 上 vCenter Server 的 vSphere Syslog Collector 端口以及 
vCenter Server Appliance 的 vSphere Syslog 服务端口。
636
TCP
对于 vCenter Server 增强型链接模式，这是本地实例的 SSL 端口。如果
此端口上正在运行另一服务，则最好移除该服务，或将其端口更改为其
他端口。 
可以在从 1025 到 65535 的任意端口上运行 SSL 服务。
902
TCP/UDP
vCenter Server 系统用于将数据发送到受管主机的默认端口。受管主机
也会通过 UDP 端口 902 定期向 vCenter Server 系统发送检测信号。 服
务器和主机之间或各个主机之间的防火墙不得阻塞此端口。 不得阻塞 
vSphere Client 和主机之间端口 902。vSphere Client 使用此端口显示
虚拟机控制台。
903
TCP
当 vSphere Client 直接连接到 ESXi 主机时，从 vSphere Client 访问虚
拟机控制台。
1514
TCP/UDP
Windows 上 vCenter Server 的 vSphere Syslog Collector TLS 端口以及 
vCenter Server Appliance 的 vSphere Syslog 服务 TLS 端口。
2012
TCP
vCenter Single Sign-On(SSO) 的控制接口 RPC
2014
TCP
所有 VMCA（VMware Certificate Authority）API 的 RPC 端口
2020
TCP/UDP
身份验证框架管理。
5480
TCP
vCenter Server Appliance Web 控制台 (VAMI)
6500
TCP/UDP
ESXI Dump Collector 端口
6501
TCP
Auto Deploy 服务
6502
TCP
Auto Deploy 管理
7444
TCP
安全令牌服务
8010
TCP
vSAN Observer ( 可选 - 只有在运行 vSAN 时才适用 )
8088
TCP
工作流管理服务
9443
TCP
vSphere Web Client HTTPS
11711
TCP
VMware Directory Service (vmdir) LDAP
11712
TCP
VMware Directory Service (vmdir) LDAPS
ITDR 之 vSphere
30
对于通过空间搜索引擎识别 vCenter 的方式，可以通过 body 中含有字符
串”VMware vCenter”，与 title 中含有字符串”+ ID_VC_Welcome +”来进行识别。
4.4 权限获取
攻击者经过第一阶段的信息探测，收集足够的目标信息随即进入权限获取阶段，
这一阶段的攻击者为了获得目标的初始访问权限通常会使用各种 Nday 和 0day 对
vSphere 服务进行攻击。
4.4.1 CVE-2021-21985
CVE-2021-21985 是 vSAN 客户端存在的一个漏洞，vSAN 是 VMware 用于存储
虚拟化的一个组件，该组件下的 vSAN Health Check 插件接口存在未授权访问漏洞，
可以利用不安全反射造成代码执行漏洞，该漏洞影响版本如下 :
・ VMware vCenter Server 7.0 系列 _i.json