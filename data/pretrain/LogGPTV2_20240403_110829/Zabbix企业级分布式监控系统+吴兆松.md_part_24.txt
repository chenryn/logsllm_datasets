Template listTemplate:Ter
ons(3)
Items（8) Inqgers(11)Graphs(2)S
Aoplica
wizard
Nane
Triggers
Key
Interval
口
6B +1.8VSM
Triggers (2)
bb_1.8v_sm
60
BB+3.3V
Triggers (2)
60
0
BB+3.3VSTBY
Triggers(2)
bb_3.3v_stby
60
0
BB +5.0V
Tnggers (2)
bb_5.0v
60
BB Ambient Temn
Inggers (2)
bb_ambient_temp
60
口
Power
Triggers (1)
power
60
L9
Processor Vec
processor_vco
60
System Fan3
system_fan_3
60
图7-20
5.在Linux系统中使用OpenlPMI
shell# yum install OpenIPMI ipmitool
shell# service ipmi start
（1）启动IPMI服务
shell#/etc/init.d/ipmi start
starting ipmi drivers:
shell# /etc/init.d/ipmievd start
starting ipmievd:
[rok]
注意：必须要ipmi、ipmidvd服务启动成功后才能运行ipmitool命令。
（2）配置IPMI地址
配置IPMI地址
shell#ipmitool lan print1 #显示lan1的配置信息
shell# ipmitool 1an set 1 ipaddr 10.10.10.10
shell# ipmitool lan set 1 netmask 255.255.255.0
shell# ipmitool lan set 1 defgw ipaddr 10.10.10.1
配置用户
shell# ipmitool lan set 1 access on
#开启lan1的用户访问
shell# ipmitool user list 1
#列出lan1的用户
190
---
## Page 207
第7章监控方式剖析
shell# ipmitool user set name 10 sensor
shell# ipmitool user set password 10 sensor
shell# ipmitool user enable 10
shell# ipmitool user priv 10 2 1
shell# ipmitool user list 1
IDName
Callin
Link Auth
IPMI Msg
Channel Priv Limit
2
root
true
true
true
ADMINISTRATOR
10sensor
true
false
true
USER
（3）ipmitool常用命令
·shell#ipmitool-Ilan-H服务器地址-Uroot-P密码poweroff（硬关
机，直接切断电源）。
·shell#ipmitool-Ilan -H 服务器地址-Uroot-P密码powersoft（软
关机，即如同轻按一下开机按钮）。
·shell#ipmitool-Ilan-H服务器地址-Uroot-P密码poweron（硬开机）。
●shell# ipmitool-I lan -H服务器地址-Uroot -P密码power reset（
硬重启，这也许会常用）。
shell#ipmitool-Ilan-H服务器地址-Uroot-P 密码powerstatus（
获取当前电源状态）。
（4）查看IPMI支持的参数
shell# ipmitool -H 10.10.10.10 -Usensor -L USER sensor list
如图7-21、图7-22所示，查看IPMI所能获取到的数据值。
HealthLED
Oxo
VRM
0X0280
X0280
45.000
20.
na
000
000
000
5-8zone
5-8
Men
5-8
Zone
1-4zone
85.000
IOH
105.000
05.
90.000
95.000
na
na
na
n
na
a
na
na
a
图7-21
6.创建IPMI模板
若要创建VRM1的监控，则应添加如下Key。
Name：可以随意取一个有意义的名称。
191
---
## Page 208
Zabbix企业级分布式监控系统
Type：选择IPMI agent。
Key：填充为VRM_1（注意，VRM_1为SensorID的VRM1)，如图7-23所
示，是IPMI可以获取到的数据。
Iroote
Type (Discrete):Unknown (oxco)
ID
HathLED (0x2)
Entity
Type (Discrete):Unknown (oxco)
: VRM 1(0x3)
VRM1(0x3)
 VRM 2 (Ox)
ID
SensityID
ID
1abi
图7-22
图7-23
本例为 HPG7模板的配置，创建Template IPMI HP G7模板，例如，创建
VRM_1的Items，如图7-24所示。
CONHIGURATION OF ERS
Template list Template:TemplateIPMI HP G7Apolications(0)Items（35)Tniqqers(4)Graphs(1)Screens
Host
TemplateIPMI HPG7
NameVvRM1
TypeIPMI agent
司
Key
VRM_I
VRM1
Typeofinfor
Text
回
Update interval(in sec)
30
Flexibleintervals
Interval
Period
Action
No flexibleintervalsdefned
New fexible interval Interval(in sec)
50Period1-7,00:00-24:00
Add
Keep history (in days)
90
New application
Applications
None
Populates host inventory field
-None
口
Description
图7-24
设置触发器，如图7-25至图7-29所示。
Item
Function
recent)Tvalueis=N
Last of (T)
OSeconds
Time shitt
Seconds
NO
图7-25
192
---
## Page 209
第7章
监控方式剖析
Selet
Item
FunctionLast(mostrecent)Tvalueis=N
gleChrome
L/zabhix/popup.php
GrouTemplates
HostTemplateIPMI HPG7
Type
Type of information
Status
图7-26
VRM1
VRM_1
IPMI agent
Text
Enabled
Trigerexy
Item
Template IPMIHPG7:VRM1
Select
Function
.NNOT1-if found,0-
Last of (T)
Prey
Time shift
LenthfatmstreenauenaraerN
InsertLengthofastmost
图7-27
Item Template IPMI HP G7:VRM 1
Select]
FunctionFind stingVin last(mostrecentvalueNNOoT1-if foundO-otherwise
Avalabltd
Last of(T）
Seconds
N1
InsertCancel
图7-28
Template:IemplateIFMHPG?Arpliali
ons（0）Items（35）Trigoers（4）Graphs（1）
ns（0）Ds
De
Expression(Template IPMIHPG?:VRM_1ist(Avalabity)>=1Add
URL
Seventy|Notclassi
High
Enabled
DeleteCancel
图7-29
如果结果中有Availability字符串，则结果为1，没有找到则不为 1，即触发
告警规则。
其他的Items，依次添加即可。模板位于https://github.com/itnihao/zabbix-book/
tree/master/07-chapter 中。
193
---
## Page 210
Zabbix企业级分布式监控系统
7.IPMI监控主机
若要配置IPMI的用户和密码，选择Host/Template→IPMI，选择认证方式、
用户类型、名字、密码，如图7-30所示。
IPMIinterfaces
10.10.10.10
IPDNS623
Add
HostTemplates
IPMI
Authenticationalgorithm
Defau
RMCP+
Privilegelevel
User
OEM
Username
sensor
Password
sensor
Save
CloneFull cloneDeleteCancel
图7-30
选择模板或者是创建IPMI监控的Items，如图7-31所示。
Templates
GURATION OF HOSTS
Name
Template App Agentless
listHost:Zabbix serverMonitoredZ
Template App MysQL
TemplatesIPMIMacrosHost inve
TemplateAppZabbixAgent
TemplateAppZabbixServer
TemplateAppZabbix ServerUnlink Unlin
TemplateIPMIIntR530
TemplateQs Linux
Unlink_Untin
TemplateIPMIIntelSR1630
Add
TemplateJMxGeneric
Template JMxTomcat
Save
图7-31
说明：由于IPMI本身的效率并不会很高，很多时候获取数据会不连续。经
过笔者测试，IPMI本身通过命令行连接时，有时无法获取到数据，所以要监控
IPMI，在设置触发器时，需要利用多重条件进行判断，防止误报。另外，需要加
长检测周期，建议至少在5～10分钟检测一次。
7.7JMX监控方式
JMX（JavaManagementExtensions，即Java管理扩展）是Java平台上为应用
程序、设备、系统等植入管理功能的框架。JMX可以跨越一系列异构操作系统平
194
---
## Page 211
第7章监控方式部析
台、系统体系结构和网络传输协议，灵活地开发无缝集成的系统、网络和服务管
理应用。
7.7.1JMX在Zabbix中的运行流程
·在Zabbix中，JMX监控数据的获取由专门的代理程序来实现，即Zabbix-
Java-Gateway来负责数据的采集，Zabbix-Java-Gateway和JMX的Java程序之间通
信获取数据，Zabbix-Server和Zabbix-Java-Gateway通信可以用图7-32来表示。
bbx_java.pid
TART_POLERS-SO
20.20.20.20
端口10052
vaPollers
10,10.10.10
端口10051
图7-32
7.7.2配置JMX监控的步骤
JMX监控的安装和配置步骤如下。
①安装Zabbix-Java-Gateway。
②配置 zabbix_java_gateway.conf 参数。
③配置zabbix_server.conf参数。
④Java应用开启JMX协议。
③ZabbixWeb配置JMX监控的Java应用。
7.7.3安装 Zabbix-Java-Gateway
源码安装的时候，加--enable-java参数，依赖关系有java、java-devel软件包。
RPM安装方式（注意不能与Zabbix-Server安装在同一台机器中）的语句如下：
源码安装方式的语句如下：（注意修改启动脚本，配置文件，可以参考RPM
安装的配置文件和脚本。）
195
---
## Page 212
Zabbix企业级分布式监控系统
7.7.4配置Zabbix-Java-Gateway
Zabbix-Java-Gateway的配置语句如下。
shell# egrep '=' /etc/zabbix/zabbix_java_gateway.conf
LISTEN IP="O.O.O.0"
LISTEN PORT=10052
PID_FILE="/var/run/zabbix/zabbix_java.pid"
START_POLLERS=50
以下是启动50个进程的语句。
x
LogFile=/var/log/zabbix/zabbix_server.log
LogFileSize=0
PidFile=/var/run/zabbix/zabbix_server.pid
DBName=zabbix
DBUser=zabbix
DBPassword=zabbix
DBSocket=/var/lib/mysql/mysql.sock
JavaGateway=X.X.X.X #Java-Gateway服务器的IP地址，如果Java-Gateway和
#Zabbix-Server在一台机器中，就可以写为127.0.0.1
JavaGatewayPort=10052
StartJavaPollers=5
ExternalScripts=/etc/zabbix/externalscripts
Zabbix-Server中的参数StartJavaPollers和Zabbix-Java-Gateway的参数
START_POLLERS，需要注意的语句如下。
StartJavaPollers <= START_POLLERS
如果不满足以上条件，就会出现Zabbix-Server向Zabbix-Java-Gateway发出
请求后无响应的情况。表7-3说明了Zabbix-Java-Gateway和Zabbix-Server需要配
置的参数。
表7-3
Zabbix-Java-Gateway
Zabbix-Server
注意事项
LISTEN_IP="O.0.0.0"
JavaGateway=X.X.X.X
X.X.X.X参数为Zabbix-Java-Gateway的IP
LISTEN_PORT=10052
JavaGatewayPort=10052
端口必须一致，且防火墙允许
START_POLLERS=50
StartJavaPollers=5
StartJavaPollers<=START_POLLERS
7.7.5监控Java应用程序
假设Java程序为/usr/share/doc/openjdk-6-jre-headless/demo/jfc/Notepad/Notepad.jar.
若想监控该程序的运行情况，那么为了开启JIMX的支持，用以下命令启动这个
Java程序。
196
---
## Page 213
第7章
监控方式剖析
shell# java\
-Dcom.sun.management.jmxremote\
-Dcom.sun.management.jmxremote.port=10053\
-Dcom.sun.management.jmxremote.authenticate=false\
-Dcom.sun.management.jmxremote.ssl=false\
-jar  /usr/share/doc/openjdk-6-jre-headless/demo/jfc/Notepad/Note
pad.jar
如果不需要JMX，则启动命令如下：
shell# java -jar
/usr/share/doc/openjdk-6-jre-headless/demo/jfc/
Notepad/Notepad.jar
如果采用认证加密的方式，语句如下：
shell# java\
-Djava.rmi.server.hostname=192.168.0.200\
-Dcom.sun.management.jmxremote\
-Dcom.sun.management.jmxremote.port=10053\
-Dcom.sun.management.jmxremote.authenticate=true\
/management/jmxremote.password \
-Dcom.sun.management.jmxremote.access.file=/etc/java-6-openjdk/m
anagement/jmxremote.access\
-Dcom.sun.management.jmxremote.ssl=true
-Djavax.net.ssl.keyStore=$YOUR KEY STORE\
-Djavax.net.ssl.keyStorePassword=SYOUR KEY_STORE PASSWORD\
-Djavax.net.ssl.trustStore=$YOUR_TRUST_STORE\
-Djavax.net.ssl.trustStorePassword=SYOUR_TRUST_STORE_ PASSWORD\
-Dcom.sun.management.jmxremote.ssl.need.client.auth=true \
-jar /usr/share/doc/openjdk-6-jre-headless/demo/jfc/Notepad/Notep
ad.jar
如果是Tomcat、Weblogic程序，则应把上面这些信息添加到启动文件。
7.7.6自定义JMX的Key
1．通过jconsole获取数据
在Windows系统中安装JDK，找到jconsole.exe，如图7-33所示。
本地磁盘 (C;) Program Files (x86) →Java  jdk1.7.0_40 ,bin
）工具(T)帮助(H)
新建文件夹