### 3.2 目标

你可以通过 `View → Targets` 与 Cobalt Strike 的目标信息进行交互。此标签页显示的信息与目标表视图相同。

- **导入目标**：点击 `Import` 按钮来导入包含目标信息的文件。Cobalt Strike 支持每行一个主机的纯文本文件（flat 文件），以及 Nmap 生成的 XML 文件（使用 `-oX` 选项）。
- **添加目标**：点击 `Add` 按钮向 Cobalt Strike 的数据模型中添加新的目标。在“地址”字段中指定 IP 地址范围或使用 CIDR 表示法一次添加多个主机。按住 Shift 键可以保持对话框打开，以便继续添加更多主机。
- **管理目标**：选择一个或多个主机并右键单击以打开主机菜单。通过该菜单，你可以修改主机备注、设置操作系统信息或从数据模型中移除主机。

### 3.3 服务

在目标视图中，右键单击一台主机并选择 `Services` 可以打开 Cobalt Strike 的服务浏览器。在这里，你可以浏览服务、为不同服务添加备注，或者移除服务条目。

### 3.4 凭据

通过 `View → Credentials` 与 Cobalt Strike 的凭据模型进行交互：
- **添加凭据**：点击 `Add` 按钮向凭据模型中添加新条目。按住 Shift 键可保持对话框打开，便于连续添加。
- **复制凭据**：点击 `Copy` 将高亮显示的条目复制到剪贴板。
- **导出凭据**：使用 `Export` 功能以 PWDump 格式导出凭据。

### 3.5 维持

Cobalt Strike 的数据模型将其所有状态和元数据存储在 `data/` 文件夹中，该文件夹位于运行团队服务器的目录下。

- **清除数据模型**：停止团队服务器，删除 `data/` 文件夹及其内容。重启团队服务器时，Cobalt Strike 会重建 `data/` 文件夹。
- **存档数据模型**：停止团队服务器，将 `data/` 文件夹及其内容备份到其他位置。要恢复数据模型，请停止团队服务器并将备份内容还原到 `data/` 文件夹。
- **重置数据模型**：通过 `Reporting → Reset Data` 在不重启团队服务器的情况下重置数据模型。

### 第四章 监听器和基础设施管理

#### 4.1 概述

任何行动的第一步都是建立基础设施。对于 Cobalt Strike 而言，基础设施包括一个或多个团队服务器、重定向器以及指向这些服务器和重定向器的 DNS 记录。一旦团队服务器启动并运行，你需要连接到它并配置其接收来自受害系统的连接。监听器是 Cobalt Strike 中用于执行这种任务的机制。

一个监听器既是一个 payload 的配置信息，也是 Cobalt Strike 启动服务器来接收来自该 payload 连接的指示。监听器由用户定义的名称、payload 类型和特定于 payload 的选项组成。

#### 4.2 监听器管理

要管理 Cobalt Strike 的监听器，通过 `Cobalt Strike → Listeners` 打开监听器管理标签页，其中列出了所有已配置的 payload 和监听器。

- **创建监听器**：点击 `Add` 按钮创建一个新的监听器，并确保为其命名以便在后续操作中引用。
- **编辑监听器**：选中一个监听器，然后点击 `Edit` 进行编辑。
- **移除监听器**：选中一个监听器，然后点击 `Remove` 删除。

#### 4.3 Cobalt Strike 的 Beacon Payload

Beacon 是 Cobalt Strike 的主要 payload，用于模拟高级攻击者的行为。Beacon 支持通过 HTTP、HTTPS 或 DNS 进行网络通信。你还可以通过控制对等 Beacon 来限制出口网络，只允许部分主机直接回连。

- **通信模式**：Beacon 支持异步通信和交互式通信。异步通信效率较低，但更适合隐蔽；交互式通信实时发生。
- **流量指标**：Beacon 的网络流量指标具有扩展性，可以通过 Cobalt Strike 的 C2 语言重新定义，以掩盖其行为。第11章将详细讨论此功能。

#### 4.4 Payload 分阶段传送

许多攻击框架设计中，payload 被分为两部分：stager 和 stage。stager 是一个小程序，用于下载 stage 并注入内存。分阶段传送在一些攻击中是必要的，因为它可以绕过对内存大小的限制。

- **关闭分阶段传送**：通过在 C2 扩展文件中将 `host_stage` 选项设为 `false`，可以关闭分阶段传送。这有助于提高安全性，因为任何人都不能连接到你的服务器请求 payload 并分析其内容。
- **后渗透和横向移动**：在 Cobalt Strike 4.0 及以后版本中，后渗透和横向移动行为尽可能投递完整的 payload。如果你禁用了分阶段传送，除非你准备进行后渗透，否则不会注意到这一变化。

#### 4.5 HTTP Beacon 和 HTTPS Beacon

默认情况下，HTTP 和 HTTPS Beacon 通过 HTTP GET 请求下载任务，并通过 HTTP POST 请求传回数据。你可以通过 C2 扩展文件进一步控制其行为和流量指标。

- **创建监听器**：通过 `Cobalt Strike → Listeners`，点击 `Add` 按钮，选择 `Beacon HTTP` 作为 payload 选项。
- **配置选项**：
  - **回连主机**：使用 `[+]` 添加回连主机，`[-]` 移除主机，`[X]` 清除当前主机。
  - **HTTP Host(Stager)**：仅在需要显式 stager 的攻击中使用。
  - **Profile**：选择 C2 扩展文件变体，以实现不同的网络流量指标。
  - **端口设置**：配置 HTTP 和 HTTPS 端口，支持端口弯曲重定向器。
  - **HTTP Host Header**：影响 HTTP 通信，便于域名前置。
  - **代理设置**：手动配置 HTTP 和 HTTPS 请求的代理设置。

#### 4.6 DNS Beacon

DNS Beacon 使用 DNS 请求将 Beacon 返回给你。这些请求解析由团队服务器作为权威 DNS 服务器的域名。DNS 响应告诉 Beacon 休眠或连接到团队服务器下载任务。

- **特点**：在 Cobalt Strike 4.0 及以后版本中，DNS Beacon 仅支持 DNS 通信，不再支持 HTTP 通信。

### 数据通道

数据通道是指 Beacon 与团队服务器之间的通信路径。通过配置不同的监听器和重定向器，可以灵活地控制数据传输的方式和安全性。