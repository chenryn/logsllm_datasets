= 日志易安全手册
北京优特捷信息技术有限公司
v4.5, 2023-01-10
== 序
在安装部署日志易集群之后，您可以给自己的配置和日志数据添加保密措施。这样可以大大降低被攻击的风险。大部分加密操作都非常简单，比如对硬件设备开启防火墙、设置复杂密码等等。
本手册描述了日志易产品中所涉及的和安全相关的各种配置。主要包括:
* 使用适宜的认证方式管理用户账号和分配权限
* 使用证书加密采集器、转发器和应用界面之间的数据交互
* 系统内用户行为审计
* 数据存储的完整性审计
== 部署的安全设置
=== 网络安全
部署完成后，各模块之间的网络交互是最容易被攻击的位置。如果可能，尽量避免暴露任何日志易集群的服务端口到公网上。
如果用户不多的情况，推荐您直接使用 iptables 等防火墙设置，限定 web 界面的访问地址 IP。当然如果有 VPN 的话，就更好了。
日志易具体用到的网络端口包括:
* zookeeper 端口: 
** 4181: 用于内部选举, 保证 zookeeper 集群服务器内网络开放即可
** 3181: 用于内部请求主节点, 保证 zookeeper 集群服务器内网络开放即可
** 2181: 用于客户端连接, 需保证 auth, splserver, kafka, logriver 等模块可连接
* mysql 端口: 
** 3306, 保证 yottaweb, auth, logparserserver 等模块可连接
** 3307, 保证 rizhiyimanager 模块可连接
** 4444, 34567, 53567, mysql gelera 集群内部同步所用
* kafka 端口: 9092, 保证 collector, logriver 等模块可连接
* beaver 端口：
** 50050：master节点的RPC协议端口
** 50051：master节点的HTTP协议端口
** 50060：broker节点的RPC协议端口
** 50061：broker节点的RPC协议端口
** 50054：data节点的RPC协议端口
** 50055：data节点的RPC协议端口
* splserver 端口: 9400, 保证 yottaweb 等模块可连接
* nginx 端口: 518, 514, 7180, 29200, 80, 均为反向代理端口, 可按需对外开放
* collector 端口: 5160, 5180, 5190, 5140, 分别为 Avro/HTTP/HTTPS/TCP 数据接收端口, 可按需开放, 但建议使用 nginx 反向代理保护这些端口
* heka 端口: 10001, 提供数据预览和配置下发功能, 保证 yottaweb 模块可访问
* logriver 端口: 
** 54400, 提供运行状态监控数据, 本地访问即可
** 13100, 内部通知规则更新，保证 yottaweb 模块可访问
** 13200, 内部获取路由规则更新，本地访问即可
* yottaweb 端口: 8090, 建议使用 nginx 反向代理保护该端口
* auth 端口：
** 8080，保证 yottaweb、logriver、splserver 模块可访问
** 18080，全站 SSL 加密通信时的访问端口。
* archiver 端口: 10000, 保证yottaweb 模块可访问
* cruxee 端口：9081，提供告警测试运行和发送，保证 yottaweb 和 splserver 模块可访问
* hdfs 端口：50080，提供共享文件访问，保证 yottaweb 和 splserver 模块可访问
* arangodb 端口：8529，提供 KV 字典功能，保证 splserver 模块可访问
此外, 日志易 Manager 平台也涉及一部分网络端口:
* Manager agent 端口: 19000, 19001, 保证从 Manager 服务器可连接
* supervisord 端口: 59001, 本地访问即可
* Manager web 端口: 8180, 保证日志易平台管理员个人终端可访问
* influxdb 端口: 8083, 8086, 8088, 保证日志易 Manager 可连接
* etcd 端口: 2379, 2380, 保证 etcd 集群服务器内部网络开放, 及日志易 Manager 可连接
日志易 Manager 平台本身并不影响日志易平台的运行, 必要的话, 您可以完全关闭 Manager 系统。
=== 管理平台账号安全
日志易系统提供了 Manager 管理平台，在该平台上可以进行各种监控和后台操作。您同样需要加密该管理平台的网络和账号。请务必在首次登录后，及时修改 admin 账号密码。
日志易使用 MySQL 数据库存储您的配置信息。具体对应的数据库库名称为 rizhiyi_system。请及时修改 MySQL 用户名和密码, 并对应修改日志易 Manager 中 auth, yottaweb 等模块的配置项 `db.user` 和 `db.passwd`。
日志易默认使用国密算法 SM2/SM3/SM4 等进行管理端、用户端和数据层加密。
==== 老版本升级启用国密算法说明
日志易 3.3 以下版本需要升级到更新版本后才能启用国密算法。以下介绍升级启用过程，操作均在日志易 Manager 系统上完成：
1. 首先需要升级manager server到对应大版本的最新版本（3.3及以上才能支持）
2. 页面升级各个模块到支持sm的版本，激活时选择手工启动（启动也无妨，就是后续会有一些不必要的重启延长升级时间）
3. 修改manager server的配置文件 /opt/rizhiyi_manager_server/server/conf/app.conf
** 修改 login_hash_algorithm = SM4
** 修改 encrypt_password = true
** 修改 encrypt_algorithm = sm4
** 上述配置项不存在时，需要手工添加到配置文件头部
4. 执行 `/opt/rizhiyi_manager_server/rizhiyi_manager_server restart` 重启manager server，配置生效，切换到国密算法
5. 页面随便选择一个配置项修改一次，将所有的配置文件重新渲染，变成使用全新的加密后的密码
6. 版本管理页面选择升级runtime，导入新的java包 java_8u292b10.tar.gz，升级逻辑完成时所有java模块都会重启完成，使用最新的sm加密后的配置
7. 手工启动非java的模块，如 collector/yotta_siem/soar/auth/cruxee/heka/fornaxee/spl  无须特别调整，导入新版本激活后，manager修改后就能生效
8. 最后，修改 yottaweb 模块的配置项 `use_guomi`，配置为true 后重启生效。
[NOTE]
====
重新保存时存入数据库的密码就是国密了，此时再改为false就无法登陆了。
====
==== 强密码的经验总结
创建一个强密码, 可以遵循以下最佳实践:
* 使用同时包含大写和小写字母, 数字, 符号的唯一性密码。
* 您可以考虑使用自己喜欢的一句话或者歇后语之类的拼音首字母。一个好的密码应该是模拟而随机的字符串, 但利于您自身记忆, 却无法让机器理解。
* 尽量设置更长的密码, 直到系统允许的最大长度。暴力破解工具已经可以每秒尝试上亿个密码组合, 每多一位长度, 都可以提高自己密码的免疫力。
当然, 一定要避免出现以下最差实践:
* 不要用自己的个人信息作为密码, 比如生日, 手机号, 身份证号, 家人的名字等。
* 不要用字典里现成的单词。到处都是自带词典的在线工具可以尝试成千上万的通用词汇和密码。
* 不要简单的使用数字串联两个单词, 或者在单词前后加下划线之类的方式也是不可取的。
* 不要给不同站点设置相同的密码。
* 不要把自己私密邮箱的密码用在其他在线服务上。
* 不要把自己的密码明文记录在电脑里。
== 用户认证
=== 标准认证
系统登录界面如下:
image::images/login.png[]
部署完成后，输入 yottaweb 模块的 ip 地址即可进入登录页面。
日志易默认的身份鉴别标准策略为:
* 使用已注册的用户名，该用户名应在合法的用户列表中且未失效。
* 提供正确的用户名口令。
* 访问来源 IP 是经配置允许的。
* 账户身份和权力处于有效期范围内。
==== 首次登录强制更新密码
如果您所持有的账户为全新账户，第一次登录时，系统会强制要求您重新设置全新密码：
image::images/first-login.png[]
请按照密码强度提示输入新密码，确保密码强度提示条呈现绿色合格再提交：
image::images/passwd-verify.png[]
日志易系统默认密码强度是8-16个字符，必须同时且仅包含数字、大小写字母和特殊字符，不可以包含敏感字符。登陆成功后管理员可以在系统配置中修改密码强度以满足不同需求，建议自定义密码强度仍符合强密码规则。
==== 会话超时
成功登录日志易系统以后，您可以在一段时间内维持会话操作。但日志易设置有会话超时机制，超时之后，将强制要求您重新登录一次，以确保会话不被非法窃用。
超时机制可以通过日志易 Manager 调整 yottaweb 模块的以下两个参数来控制：
* session.fixed_expiry_duration: 该参数控制用户登录后的固定超时时间。默认为 3 天。即，一次登录的 3 天后必须重新登录一次。
* session.inactive_expiry_duration: 该参数控制用户登录后无活跃操作时的超时时间。默认不启用。您可以按需设置，比如设置为 300 秒，即 5 分钟没有任何操作自动退出。
==== 会话的独占控制
您可以取消系统设置页中的"允许多点登录"勾选，要求系统内用户会话具有独占性。如果同一用户账户在另一处登录，原来处于已登录状态的浏览器，会在下一次操作/心跳时自动退出登录。
==== 更换密码
即便您遵循了本手册第一节提供的最佳实践, 依然要定期更换自己的账户密码。更换密码步骤如下:
1. 在页面左下角, 点击个人图标, 在弹出菜单中点击"账户信息"。
2. 在账户信息页右上角, 点击"修改信息"。
3. 在编辑用户页, 勾选"修改密码"。
4. 在新出现的表单内, 分别输入"旧密码", "新密码", "重复密码", 点击"保存"。
密码更换完成, 您可以退出使用新密码重新登录。
您可以在系统设置页中，设置"密码有效时间"，强制所有用户必须定期更换密码，默认为每 3 个月必须更换一次。为了提前提示用户更换，另有"密码提醒时间"配置项，默认为 7 天，即当密码即将过期时，日志易会提前 7 天开始在用户登录时弹窗提醒用户去修改密码：
image::images/login-change-passwd.png[]
还可以勾选"发送提醒至邮箱"的功能，日志易会提前 7 天开始给用户账户的邮箱地址发送密码即将过期的提醒邮件。
更换密码时，默认不能使用最近 3 次的老密码，该参数由系统配置页的"禁止使用最近密码次数"控制。
更换密码时的密码长度默认限定为 8 到 20 位。该参数由系统配置页的"密码长度限制"控制。
image::images/system-setting-passwd.png[]
==== 弱口令文件管理
为了防止用户在更换密码时，采用一些虽然符合规定但太过普通常见的口令组合，日志易提供单独的弱口令文件管理功能，拒绝用户使用文件中记载的弱口令作为账户密码。
在系统设置页中，找到"密码弱口令文件"配置项，点击"本地上传"，选择弱口令文件上传即可。文件限制为 UTF8 编码且不超过 16MB。
文件内容为每行一个密码即可：
 admin1
 qweasd
 888666...
==== 账号锁定和解锁
当某个用户账号连续 10 次登录失败时, 日志易系统将自动锁定该账号, 默认锁定时长为 1 天。
您可以通过日志易系统设置中的 "账号锁定时间" 修改默认锁定时长。如果确定是无意被锁定的用户账号，可以由拥有 admin 角色权限的管理员在用户管理页面解锁。