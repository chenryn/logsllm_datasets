DIY Hardware implant over I2C
Part of the NSA Playset
Josh Datko and Teddy Reed
DEF CON 2
2
August 10, 2014
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
1 / 60
Outline
1
Introduction
NSA Playset DEF CON Series
2
Deconstruction
I2C Attack Surfaces
3
Reconstruction
I2C Module
Controller Device
GSM Module
4
Improvements and Future Work
CHUCKWAGON Improvements
GSM Exﬁl Alternaive: Audio
5
Wrapup
6
Demo
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
2 / 60
NSA Playset Series
What is the NSA Playset?
We hope the NSA Playset will make cutting edge security tools more
accessible, easier to understand, and harder to forget.
NSA Playset Talks
RF Retroreﬂector
Penn & Teller
Friday
12:00
DIY Hardware Implant
Track 1
Sunday
11:00
GSM Sniﬃng
Track 1
Sunday
12:00
PCIe
Track 2
Sunday
14:00
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
3 / 60
Inspired by the NSA
The NSA apparently has a hardware hacking catalog.1
Flip. . . Flip. . . Flip. . .
Oh look honey, there’s an I2C controller board we can get. It
attaches to a computer and it’s modular, so you can add a GSM
cell phone for exﬁl.
That’s nice dear.
I wonder how that works. . .
1like SkyMall for spies and without the Bigfoot.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
4 / 60
Requirements for the implant
From the docs:
Must attach over I2C to the target.
Must include GSM reachback to the implant.
Our requirements:
Easy to use.
Open Source Hardware.
Flexible: Allow for multiple communication and software protocols.
Fun. Single chip solutions aren’t as fun.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
5 / 60
Implant Control Diagram
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
6 / 60
Background: What is I2C
Serial bus.
Two-wires: (plus power and ground).2
I Data: SDA
I Clock: SCL
Multi-master.
Multi-slave.
Addressable.
Standard speed is 100kHz (100kbps). High Speed: 3.2Mbps
theoretical max.
2Typically 5 or 3.3V
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
7 / 60
Background: I2C in visual form
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
8 / 60
I2C attack surfaces
RAM EEPROMs
PCI and PCIe
Battery controllers
Video . . .
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
9 / 60
Video I2C
Why is there I2C on your monitor adapter?
How does your computer “automatically detect” monitor resolution?
EDID
Extended Display Identiﬁcation Data
DDC
Data Display Channel, a.k.a. 5V I2C
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
10 / 60
EDID
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
11 / 60
$ edid-decode
ioreg -lw0 -r -c "IODisplayConnect"
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
12 / 60
EDID Extension Blocks
Tag Number
Extension Block Description
00h
Timing Extension
02h
CEA-EXT: CEA 861 Series Extension
10h
VTB-EXT: Video Timing Block Extension
20h
EDID 2.0 Extension
40h
DI-EXT: Display Information Extension
50h
LS-EXT: Localized String Extension
60h
DPVL-EXT: Digital Packet Video Link Extension
A7h, AFh, BFh
DTCDB-EXT: Display Transfer Characteristics
F0h
EXTENSION Block Map
FFh
EXTENSIONS deﬁned by the OEM
Parsing implemented by the OS-supplied VESA driver or GPU driver
manufacturer.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
13 / 60
Exploiting EDID/EDID Extension parsing
Hacking Displays Made Interesting
Blackhat EU 2012
Andy Davis - NGS Secure
https://github.com/nccgroup/EDIDFuzzer
Simple adaptation for BeagleBone
Implemented in Python (BBIO)
https://github.com/theopolis/bone-edidfuzzer
Discover proprietary EDID extensions! Moar fuzzing!
Or assume a-priori software control...
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
14 / 60
I2C everywhere IC3
A video card may have multiple I2C buses and devices. NVIDIA cards may
have I2C for the following:
EEPROM for encrypted HDCP keys
Onboard voltage regulator
Thermal sensor
TV decoder chip (older cards)
3C’mon, it’s punny
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
15 / 60
Exploring VGA I2C
Let’s start exploring our attack surface.
Pin
Name
Description
1
RED
Red Video
2
GREEN
Green Video
3
BLUE
Blue Video
...
...
...
5
GND
Ground
9
KEY
Optional +5V output from graphics card
12
SDA
I2C data
15
SCL
I2C data clock
VGA Pinout
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
16 / 60
I want my I2C 4
4Dire Straights fans, anyone?
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
17 / 60
Filling in the details
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
18 / 60
Controller Selection
BeagleBone Black is the
embedded hacker’s friend:
1GHz AM3358 ARM®
Cortex-A8
512MB DDR3 RAM
Two independent
Programmable Real-Time
Units (32bit)
Crypto accelerators for
AES, SHA, MD5
UARTs, PWM, LCD,
GPMC, SPI, ADC, CAN,
Timers
Two I2C buses
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
19 / 60
CryptoCape
The BBB ecosystem enables easy hardware expansion with Capes.
Let’s add some hardware crypto and a micro:
Authenticators: ECC &
MAC (SHA256)
Encrypted EEPROM
(AES-128-CCM)
Battery backed up
Real-time clock
Trusted Platform
Module
ATmega328p, all sorts of
handy. Plus it’s a
programmable I2C slave.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
20 / 60
Add the controller
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
21 / 60
GSM Module
Seeed Studo GPRS Shield v2:
Arduino form factor
GSM Quad band support
TCP support
SIM card holder
Works with Tmobile,
AT&T
I You can buy pre-paid
SIMs with cash.
I T-Mobile has unlimited
talk & text for 35USD.
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
22 / 60
Add the GSM module
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
23 / 60
Moar Power?
BBB draws 460mA on
boot
CryptoCape
GSM Shield draws 300mA
on average for “talk”, but
peak of 2.0 A!?
Meet the LiPoWerCape
I Switching voltage
regulator with noise
ﬁltering
I Dual cell LiPo input
I Output to 5V Power
Rail
Josh Datko and Teddy Reed (DEF CON 2
2
)
DIY Hardware implant over I2C
August 10, 2014
24 / 60
CHUCKWAGON
We still need a way to easily