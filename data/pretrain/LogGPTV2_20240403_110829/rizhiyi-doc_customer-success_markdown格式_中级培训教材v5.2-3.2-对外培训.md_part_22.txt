|evaltime =formatdate(now()-86400000,"yyyy/MM/dd")
|fieldstime,ct_tranlog,ct_exjcnode,success_rate
|renametimeas"自然日期",ct_tranlogas"ESB总报文总量",ct_exjcnodeas"ESB错误报文量",
success_rateas"报文转发成功率"
本章习题：
1、定时任务运行频率与语句时间范围不一致会导致什么结果？
2、当要对一年的数据进行统计时，常常会因为数据量太大，正常的SPL语句计算数据大造
成统计结果不精确、统计效率低，有没有更好的方法呢？请简述思路。有条件的可在日志易
中进行验证。
3、企业中还有什么场景下需要使用定时任务？请列举一二，并说明实现思路。
思考：
日志易定时任务的写法与LinuxCrontab的写法并不完全相同，你能简述二者的差别吗？
5-244
日志学院
6.监控告警
监控告警是日志管理系统的重要功能，我们可以把搜索语句按预设计划周期性执行，让日志
易轻松替我们监控数据。当监控数据结果满足触发条件时，日志易将生成对应的告警事件，
并通过指定的告警推送方式及时通知使用者。
基于日志可以方便快捷地实现以下场景的监控告警：
1、基于日志关键字实现告警：如系统出现ERROR或其他异常关键字就发出告警；
2、基于数值统计实现告警：当某一指标或累积数值达到某一阈值就发出告警；
3、基于响应率或成功率实现告警：结合SPL实现对响应率、成功率、系统健康度等实现监
控告警；
4、端口状态告警：基于日志监控，当发现端口down时发出告警，发现端口up时告警恢复；
5、机器上下线告警：基于日志监控，当发现机器下线时发出告警，发现机器上线时告警恢
复；
6、陡变告警。
除告警配置外，与告警相关的问题包括：
1、告警查看：页面查看，以及通过告警记录的索引查看告警或对其进行二次分析；
2、基础告警方式：通常的告警方式是电子邮件，不过日志易也支持syslog和HTTP转发等
的其他灵活方式；
3、告警事件管理：3.0及其以前版本中告警事件管理包括告警归并、告警处理、维护期等
内容，从3.1版本起，告警事件管理由cruxee组件负责，监控告警部分仅保留了维护期
的概念。3.1版本及其之后的告警事件管理具体详见监控告警专题教材；
4、告警插件：非基础告警方式之外的告警，可按照规范对接API接口，根据客户告警方式，
可进行插件定制化开发，目前日志易系统已对接了钉钉、短信、微信等告警平台。
6.1. 配置监控
日志易当中有两种方式开始配置监控：
1、单击搜索界面右边的“新建监控”；
2、也可以在监控管理页面新建监控，或者快捷复制一个现有的监控。日志易支持在列表页
快速点击打开对应的搜索内容。
6-245
日志学院
基础配置
配置监控都需要填写以下信息，其中分为常规信息和监控执行两部分。
常规信息
1. 名称：您可以自由命名监控的名称，监控被触发时将推送此名称的告警。
2. 描述：为监控做简短的描述，以便您能记起设置监控的原因。
3. 资源标签：为监控选择标签，可以完成过滤分组等功能。
4. 所属应用：为监控选择应用，以便在应用中查看监控。
5. 运行用户：为监控选择运行用户，默认是当前登陆用户。
6. 搜索：您可以从已存搜索中选择一个作为监控范围使用，日志易将提供已存搜索列表供
您选择；如果您正在进行搜索，并决定使用当前搜索建立监控，请直接点击创建监控按
钮，进一步创建监控范围。您也可以直接在搜索内容输入框内，手写SPL搜索语句，或
点击"添加数据集"选择所需的数据集。
7. 高基模式：设置是否启用高基模式，默认不启用。如果您输入的SPL是海量分组统计或
去重数精准统计问题，建议您启用高基模式。
8. 如果监控页面没有此选项，请查看manager上yottaweb的配置项search.on_spark设置
是否为true。如果为true，用户可以在此页面看到并选择是否启用高基模式;如果为false，
则高级模式隐藏起来，页面不可见。
9. 监控启用：设置是否启用该监控。您也可以在列表页中直接修改该设定。
6-246
日志学院
监控执行
如上图所示，监控执行中，可以设置如下参数:
• 执行计划：可以选择简单的时间单位，填写数字。如10秒，5分钟等。
• 告警类型：选择某种告警类型，会有不同的触发条件配置。
• 触发条件：可以对触发定义不同的阈值，不同的告警等级对应不同的阈值范围。
日志易同时支持crontab时间格式配置格式。格式:[秒][分][小时][日][月][周][年]
序号 说明 是否必填 允许填写的值 允许的通配符
1 秒 是 0—59 ,-*/
2 分 是 0—59 ,-*/
3 小时 是 0—23 ,-*/
6-247
日志学院
4 日 是 1—31 ,-*?/LW
5 月 是 1—12orJAN-DEC ,-*/
6 周 是 1—7orSUN-SAT ,-*?/L#
7 年 否 empty 或 1970-2099 ,-*/
通配符说明：
 *:表示所有值. 例如：在分的字段上设置 "*",表示每一分钟都会触发。
 ?:表示不指定值。使用的场景为不需要关心当前设置这个字段的值。例如:要在每月的
10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为"?" 具体设置
为 00010*?
 -:表示区间。例如 在小时上设置 "10-12",表示 10,11,12点都会触发。
 ,:表示指定多个值，例如在周字段上设置 "MON,WED,FRI" 表示周一，周三和周五触发
 /:用于递增触发。如在秒上面设置"5/15" 表示从5秒开始，每增15秒触发(5,20,35,50)。
在日字段上设置'1/3’所示每月1号开始，每隔三天触发一次。
 L:表示最后的意思。在日字段设置上，表示当月的最后一天(依据当前月份，如果是二
月还会依据是否是润年[leap]), 在周字段上表示星期六，相当于"7"或"SAT"。如果在"L"
前加上数字，则表示该数据的最后一个。例如在周字段上设置"6L"这样的格式，则表示
“本月最后一个星期五"
 W:表示离指定日期的最近那个工作日(周一至周五). 例如在日字段上设置"15W"，表示
离每月15号最近的那个工作日触发。如果15号正好是周六，则找最近的周五(14号)
触发, 如果15号是周未，则找最近的下周一(16号)触发。如果15号正好在工作日(周一
至周五)，则就在该天触发。如果指定格式为 "1W",它则表示每月1号往后最近的工作
日触发。如果1号正是周六，则将在3号下周一触发。 (注，"W"前只能设置具体的数
字,不允许区间"-").'L’和 'W’可以一组合使用。如果在日字段上设置"LW",则表示在本月的
最后一个工作日触发
 #:序号(表示每月的第几周星期几)，例如在周字段上设置"6#3"表示在每月的第三个周星
期六.注意如果指定"6#5",正好第五周没有星期六，则不会触发该配置(用在母亲节和父
亲节再合适不过了) 周字段的设置，若使用英文字母是不区分大小写的 MON与mon
相同.
示例:
格式:[秒][分][小时][日][月][周][年]
1. 普通用法：
*/5****? 每隔5秒执行一次
0*/1***? 每隔1分钟执行一次
005-15**? 每天5-15点整点触发
00/3***? 每三分钟触发一次
00-514**? 在每天下午2点到下午2:05期间的每1分钟触发
00/514**? 在每天下午2点到下午2:55期间的每5分钟触发
00/514,18**? 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发
00/309-17**? 朝九晚五工作时间内每半小时
0010,14,16**? 每天上午10点，下午2点，4点
30****? 每半分钟触发任务
6-248
日志学院
3010***? 每小时的10分30秒触发任务
30101**? 每天1点10分30秒触发任务
15,30,45****? 每15秒，30秒，45秒时触发任务
15-45****?15到45秒内，每秒都触发任务
15/5****? 每分钟的每15秒开始触发，每隔5秒触发一次
15-30/5****? 每分钟的15秒到30秒之间开始触发，每隔5秒触发一次
00/3***? 每小时的第0分0秒开始，每三分钟触发一次
0012**? 每天12点触发
01510?** 每天10点15分触发
01510**? 每天10点15分触发
01510*?* 每天10点15分触发
01510**?2016 2016年每天10点15分触发
0*14**? 每天下午的2点到2点59分每分触发
00/514**? 每天下午的 2点到2点59分(整点开始，每隔5分触发)
00/514,18**? 每天下午的 18点到18点59分(整点开始，每隔5分触发)
2、进阶用法之星期设置：
0012?*WED 表示每个星期三中午12点
0017?*TUES,THUR,SAT 每周二、四、六下午五点
010,4414 ?3WED 每年三月的星期三的下午2:10和2:44触发
01510?*MON-FRI 周一至周五的上午10:15触发
01510?*MON-FRI 星期一到星期五的10点15分0秒触发任务
3、进阶用法之月份设置：
0023L*? 每月最后一天23点执行一次
01510L*? 每月最后一日的上午10:15触发
01510?*6L 每月的最后一个星期五上午10:15触发
01510?*6#3 每月的第三个星期五上午10:15触发
3010120*? 每月20号1点10分30秒触发任务
01510L*? 每个月最后一天的10点15分0秒触发任务
01510LW*? 每个月最后一个工作日的10点15分0秒触发任务
01510?*5L 每个月最后一个星期四的10点15分0秒触发任务
01510?*5#3 每个月第三周的星期四的10点15分0秒触发任务
注意事项：
 无论是使用定时还是crontab，都需要对告警进行合理的划分，不能将告警都集中在某
一时刻，否则对后端有太大的压力；
 告警建议5分钟以上；
 建议每5个告警使用一个时刻；
 如果超过5个告警，建议至少间隔30s以上再执行另一个告警。
如果使用的定时进行配置告警，那么需要根据后台执行定时任务的频率来确定，比如后台每
个2分钟去数据库获取告警任务，那么我们只能配置2、4、6…等整数倍时间。
6-249
日志学院
告警类型
目前日志易提供事件数、字段统计、连续统计、基线对比和spl统计五种告警模式。
五种类型的告警说明及适用场景如下：
告警类型 说明 适用场景
1、简单的关键字告警，比如ERROR；
事件数告警 基于搜索结果数量的告警 2、简单某一事件类型告警，
ngingx.status:500
字段统计告警 基于搜索出某个字段的数据量告警 需要对关键字或者字段进行统计时
1、字段的告警阈值需要满足一定次数
才可以；
当某个告警条件在某个时间段内连续触
连续统计告警 2、在跑批业务中可能会用到，出现一
发多次时告警
次或者几次失误都没有问题，但是达
到10次就需要告警通知
设置一个基准线，然后结果与基准线进
行对比，基准线的时间可调控（基准线
内统计的数值会变动）。
基线对比告警 需要同期对比时
能够知晓这今天的状态与其他时间相比
是否正常，比如业务的平均耗时、业务
失败次数等。
SPL统计告警 基于SPL语句实现监控 所有的监控都适合
事件数告警
您可以创建基于搜索结果的告警触发条件，在一个给定的时间范围内触发告警的阈值数则发
送告警。例如：
6-250
日志学院
输出内容：
您可以设置告警触发条件为：5分钟内，搜索结果出现关键字ON的计数超过1次时触发低
级别告警。
6-251
日志学院
字段统计告警
字段统计为您提供针对字段内容的告警设置，在触发条件中您需要填写字段名，统计方式可
以在下拉框中选择，cardinality（独立数）、sum（总和）、avg（平均值）、max（最大值）、
min（最小值）。
例如，触发条件为：apache.req_time在5分钟之内的平均值大于0.5时触发低等级告警，则
设定如下:
结合简单的SPL语句，还可以设置如下的告警：
6-252
日志学院
告警结果：
连续统计告警
连续统计为您提供连续统计触发告警功能，即当某个告警条件在某个时间内连续触发次数达
到阀值，才触发告警。
例如，触发条件为：apache.status在10分钟之内超过400并且有两次大于400时触发低级
别告警。
6-253
日志学院
基线对比告警
基线对比是将阈值设定为一个统计的基线值（随时间变动），您需要选择基线生成的时间范
围，同时，基线对比告警给您提供了更灵活的触发范围设定方式——您可以在下拉框中选择
大于、小于、在区间内、在区间外。
示例1：昨天与今天apache.status大于400的情况对比，如果超过基线的50%就告警，基线
是以过去一天的数据为准。
6-254
日志学院
示例2：apache.resp_len在最近1小时的统计如果与过去7天相比，小于基线值50%或者超