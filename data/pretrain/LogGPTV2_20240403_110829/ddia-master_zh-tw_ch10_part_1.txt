# 第十章：批处理
![](../img/ch10.png)
> 带有太强个人色彩的系统无法成功。当最初的设计完成并且相对稳定时，不同的人们以自己的方式进行测试，真正的考验才开始。
>
> —— 高德纳
---------------
[TOC]
在本书的前两部分中，我们讨论了很多关于 **请求** 和 **查询** 以及相应的 **响应** 或 **结果**。许多现有资料系统中都采用这种资料处理方式：你传送请求指令，一段时间后（我们期望）系统会给出一个结果。资料库、快取、搜寻索引、Web 伺服器以及其他一些系统都以这种方式工作。
像这样的 **线上（online）** 系统，无论是浏览器请求页面还是呼叫远端 API 的服务，我们通常认为请求是由人类使用者触发的，并且正在等待响应。他们不应该等太久，所以我们非常关注系统的响应时间（请参阅 “[描述效能](ch1.md#描述效能)”）。
Web 和越来越多的基于 HTTP/REST 的 API 使互动的请求 / 响应风格变得如此普遍，以至于很容易将其视为理所当然。但我们应该记住，这不是构建系统的唯一方式，其他方法也有其优点。我们来看看三种不同型别的系统：
* 服务（线上系统）
  服务等待客户的请求或指令到达。每收到一个，服务会试图尽快处理它，并发回一个响应。响应时间通常是服务效能的主要衡量指标，可用性通常非常重要（如果客户端无法访问服务，使用者可能会收到错误讯息）。
* 批处理系统（离线系统）
  一个批处理系统有大量的输入资料，跑一个 **作业（job）** 来处理它，并生成一些输出资料，这往往需要一段时间（从几分钟到几天），所以通常不会有使用者等待作业完成。相反，批次作业通常会定期执行（例如，每天一次）。批处理作业的主要效能衡量标准通常是吞吐量（处理特定大小的输入所需的时间）。本章中讨论的就是批处理。
* 流处理系统（准实时系统）
  流处理介于线上和离线（批处理）之间，所以有时候被称为 **准实时（near-real-time）** 或 **准线上（nearline）** 处理。像批处理系统一样，流处理消费输入并产生输出（并不需要响应请求）。但是，流式作业在事件发生后不久就会对事件进行操作，而批处理作业则需等待固定的一组输入资料。这种差异使流处理系统比起批处理系统具有更低的延迟。由于流处理基于批处理，我们将在 [第十一章](ch11.md) 讨论它。
正如我们将在本章中看到的那样，批处理是构建可靠、可伸缩和可维护应用程式的重要组成部分。例如，2004 年释出的批处理演算法 Map-Reduce（可能被过分热情地）被称为 “造就 Google 大规模可伸缩性的演算法”【2】。随后在各种开源资料系统中得到应用，包括 Hadoop、CouchDB 和 MongoDB。
与多年前为资料仓库开发的并行处理系统【3,4】相比，MapReduce 是一个相当低级别的程式设计模型，但它使得在商用硬体上能进行的处理规模迈上一个新的台阶。虽然 MapReduce 的重要性正在下降【5】，但它仍然值得去理解，因为它描绘了一幅关于批处理为什么有用，以及如何做到有用的清晰图景。
实际上，批处理是一种非常古老的计算方式。早在可程式设计数字计算机诞生之前，打孔卡制表机（例如 1890 年美国人口普查【6】中使用的霍尔里斯机）实现了半机械化的批处理形式，从大量输入中汇总计算。Map-Reduce 与 1940 年代和 1950 年代广泛用于商业资料处理的机电 IBM 卡片分类机器有著惊人的相似之处【7】。正如我们所说，历史总是在不断重复自己。
在本章中，我们将了解 MapReduce 和其他一些批处理演算法和框架，并探索它们在现代资料系统中的作用。但首先我们将看看使用标准 Unix 工具的资料处理。即使你已经熟悉了它们，Unix 的哲学也值得一读，Unix 的思想和经验教训可以迁移到大规模、异构的分散式资料系统中。
## 使用Unix工具的批处理
我们从一个简单的例子开始。假设你有一台 Web 伺服器，每次处理请求时都会在日志档案中附加一行。例如，使用 nginx 预设的访问日志格式，日志的一行可能如下所示：
```bash
216.58.210.78 - - [27/Feb/2015:17:55:11 +0000] "GET /css/typography.css HTTP/1.1"
200 3377 "http://martin.kleppmann.com/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5)
AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.115 Safari/537.36"
```
（实际上这只是一行，分成多行只是为了便于阅读。）这一行中有很多资讯。为了解释它，你需要了解日志格式的定义，如下所示：
```
 $remote_addr - $remote_user [$time_local] "$request"
 $status $body_bytes_sent "$http_referer" "$http_user_agent"
```
日志的这一行表明在 UTC 时间的 2015 年 2 月 27 日 17 点 55 分 11 秒，伺服器从客户端 IP 地址 `216.58.210.78` 接收到对档案 `/css/typography.css` 的请求。使用者没有认证，所以 `$remote_user` 被设定为连字元（`-`）。响应状态是 200（即请求成功），响应的大小是 3377 位元组。网页浏览器是 Chrome 40，它载入了这个档案是因为该档案在网址为 `http://martin.kleppmann.com/` 的页面中被引用到了。
### 简单日志分析
很多工具可以从这些日志档案生成关于网站流量的漂亮的报告，但为了练手，让我们使用基本的 Unix 功能建立自己的工具。例如，假设你想在你的网站上找到五个最受欢迎的网页。则可以在 Unix shell 中这样做：[^i]