储区域网络连接到服务器组并在服务器组之间共享，此安排可实现存储资源的聚合，
并在将这些资源置备给虚拟机时使资源存储更具灵活性。 
2.5 应用场景
企业中对于 vSphere 的应用主要分为服务器集群与云桌面两种场景。
◑ 服务器集群
大多数企业为了更加高效和节约成本的使用硬件计算资源，会选择使用 ESXI 进
行搭建服务器的虚拟化集群，比较典型的场景如下图所示 : 
ITDR 之 vSphere
6
受限于单台 ESXI 的性能，企业一般会部署多台 ESXI，并将不同属性或不同业
务的服务器按需搭建在不同的 ESXI 上，组成一个虚拟化的集群，为方便数据管理以
及 ESXI 的高可用，通常 ESXI 集群会向下通过一个存储交换机，连接至一台存储服
务器，以进行快速的数据迁移等操作。向上通过一个网络交换机连接至上游网络，
同时配置 vCenter 对 ESXI 集群进行管理，可以是单台 vCenter 管理单台 ESXI，也
可以是单台 vCenter 管理多台 ESXI，对于 vCenter 的网络位置可以在交换机之后也
可以在交换机之前，这是一个比较典型的用于服务器集群的 vSphere 基础架构。
◑ 云桌面
部分企业对 vSphere 的实践为构建云桌面体系，在这样的架构下抽象出来的
VM 层如下图所示 :。
在云桌面的应用场景中，计算机的统一管理一般使用办公网集权管控方案 AD，
对计算机及用户账户进行统一管理，对于 VM 层则采用 vCenter 方案对 ESXI 进行集
中管理，对于用户侧，用户可以直接使用 Horizon 客户端直连云桌面。
此处为一些抽象的概念，在实际企业应用场景中，为了确保稳定性与可用性，
云桌面的架构会相对更复杂一些。
2.vSphere 体系介绍
7
2.6 小结
根据上面的介绍，ESXI 就是一个虚拟层，在 ESXI 上可以安装其他的 OS，就
像在硬件上安装一样。当在服务器上安装了 ESXI，这个服务器的底层硬件就会被虚
拟化，这意味着我们可以用这台 ESXI 服务器上创建、配置多个虚拟机和 OS（Linux
和 Windows 均可），结构如下图所示 :
vSphere Client 就是通过它远程连接控制 ESXI 上的客户端程序。管理员可以
通过 vSphere client 连接 ESXI 来访问和管理虚拟机，即是用来从客户机端机器连
接 ESXI 执行任务的。
vSphere Client 能 够 经 过 访 问 vCenter Server 来 管 理 多 个 ESXI 服 务 器。
vSphere 功能强大，且具有可拓展，权限分级等特点，除此之外还具有以下优点：
1. 通过高利用率和实现自动化获得高效率：可实现 15:1 或更高的整合率，将
硬件利用率从 5%~15% 提高到 80% 甚至更高，而且无需牺牲性能。
2. 在整个云计算基础架构范围内最大限度地增加正常运行时间：减少计划外停
机时间，并消除用于服务器和存储维护计划内停机时间。
3. 大幅降低 IT 成本：使资金开销降幅高达 70%，运营开销高达 30%，从而为
VMware vSphere 上运行的每个应用降低 20%~30% 的 IT 基础架构成本。
4. 兼具灵活性和可控性：快速响应不断变化的业务需求而又不牺牲安全性或控
ITDR 之 vSphere
8
制力，并且为 VMware vSphere 上运行的所有关键业务应用提供零接触式基础架构，
以及内置的可用性、可扩展性和性能保证。
5. 可自由选择：使用基于标准的通用平台，既可利用现有 IT 资产，又可利用
新一代 IT 服务，并且通过开放 API 与来自全球领先技术提供商体系的解决方案集成，
以增强 VMware vSphere。
正是因为 vSphere 如此多的优势和用途，vSphere 获得了广泛的使用，尤其
是大企业、政府、医院等重要部门，在全球范围内获得了成功。
2.vSphere 体系介绍
9
vSphere 风险介绍
03
ITDR 之 vSphere
10
3. vSphere风险介绍
3.1 攻防场景下的vSphere
在实际场景中，企业为了提高性能和成本效益同时实现简化数据中心和方便大
规模管理，往往会在一台 ESXI 服务器中部署数台甚至数十台虚拟机作为日常的工
作服务主机或者数据库。所以， ESXI 主机中会保存着与它在同一物理主机上的其
他虚拟机的源文件以便对这些虚拟机进行管理。简而言之 ESXI 类似于存放着数台
服务器的机房，如果机房被人攻击或劫持，将对一个企业或组织造成难以估量的损
失。
同时 ESXI 上部署的服务器 / 数据库可能需要向客户提供服务，这也使得攻击
者有机会直接从网络接触到 ESXI 主机上的虚拟机，从网络层面为攻击者提供了入
侵的可能性。
因此，vSphere 在作为一个方便强大的数据中心虚拟化套件，被全球各大企
业、政府、医院、教育等机构广泛采用，其包含的众多虚拟机及数据文件成了黑产
活动中极具价值的财富，所以黑客和勒索软件纷纷将 vSphere 列为攻击目标，致使
vSphere 暴露于多种风险之中。
为了保护各类大企业、政府、医院、教育等机构的数据安全，现在红蓝对抗和
安全研究中也积极的对 vSphere 进行了一系列攻击链的研究和安全加固，力求在攻
击中发现风险，修复风险，避免风险。
如下图所示，作为 vSphere 体系中另外一个核心的组件 vCenter，管理着
所有的 ESXI 及其虚拟机，因此也具有极高的利用价值和攻击风险。vCenter 在
vSphere 体系中的角色类似域控制器在 AD 域架构中的角色，vCenter 拿下之后，
不单单只是获取一台服务器的权限，属 vCenter 所管的所有 ESXI、虚拟机均将暴
露在攻击者的视野之下，甚至部署在 ESXI 下的 AD 域也将遭受攻击。
因此，因此拿下 vCenter 的价值不亚于域控，全球范围内在如火如荼的攻防演
练以及真实网络环境下随时都有可能发生的恶意攻击中，均将 vCenter 视为其重要
的攻击目标进行重点突破。
3.2 vSphere勒索分析
勒索软件（ransomware）是一种流行的木马，通过骚扰、恐吓甚至采用绑架
3.vSphere 风险介绍
11
用户文件等方式，使用户数据资产或计算资源无法正
常使用，并以此为条件向用户勒索钱财。这类用户数
据资产包括文档、邮件、数据库、源代码、图片、压
缩文件等多种文件。赎金形式包括真实货币、比特币
或其它虚拟货币。一般来说，勒索软件作者还会设定
一个支付时限，有时赎金数目也会随着时间的推移而
上涨。有时，即使用户支付了赎金，最终也还是无法
正常使用系统，无法还原被加密的文件。
随着互联网技术的快速更新，网络用户量剧增，
各个政府部门、组织和企业对计算资源和存储资源的
需求骤增；云计算和虚拟技术的兴起让各大云服务提
供商和虚拟化技术公司为各个政府部门、组织和企业
提供了定制化资源服务和虚拟化解决方案以满足日常
资源需求。VMware 作为云服务和虚拟化领域的领头
企业，其客户几乎涵盖所有领域；除此之外，各大云
服务提供商也为其客户提供间接的 VMware 虚拟化服
务，VMware 已经成为虚拟化市场的绝对霸主。因此，
众多勒索组织为了加密更多更重要的数据以勒索更高
额的赎金开始将目标延伸到 vSphere 平台上。
如下图所示，黑客一般会通过攻击 vCenter 的方
式，控制 ESXI，通过加密存储服务器上的虚拟机磁盘
文件等信息，从而实施勒索。
下文我们简单分析几个针对 ESXI 勒索的案例，
来发现其针对 ESXI 攻击的各种特点。
3.2.1 Babuk
Babuk Locker（又称 Babyk）是 2021 年 1 月开
始运营的勒索软件，采用 RaaS（勒索软件即服务）
模式运营，可针对 Windows、Linux 双平台发起攻击，
受害者主要分布在美国，其次为英国、德国、乌克兰、
芬兰、巴西、洪都拉斯和泰国。
2021 年 2 月，运营英国新冠肺炎检测与追踪系统
部分业务的跨国外包公司 Serco 遭受了 Babuk 勒索
软件团伙攻击，致使 Test&Trace APP 服务出错，超
过 7000 人受到影响。攻击者潜伏在 Serco 的网络中
达三周之久，泄露了多达 1TB 数据。
2021 年 4 月，美国华盛顿警察局遭 Babuk 勒索
软件团伙攻击，该团伙声称加密并窃取了约 250G 文
件，其中包含警方调查报告、本地帮派、警方线人等
敏感信息。Babuk 以警方线人信息作为要挟，向警察
局勒索 400 万美元赎金，最终谈判破裂，Babuk 在其
泄密网站上公布了包括属于警察部门成员的社会安全
号码和华盛顿特区地铁警察局存档的相关人员名单以
及警方线人信息。
Babuk 在地下论坛上宣布它正在开发针对 Linux/
UNIX 和 ESXI 或 VMware 的跨平台二进制文件，公司
中的许多核心后端系统都在这些 *nix 操作系统上运
行，或者在虚拟化的情况下托管多台服务器及虚拟桌
面环境的 ESXI。该软件的作者晚些时候在黑客论坛上
公布了勒索软件的完整源代码，用于生成 Windows
和 Linux 可执行文件，其中包括 VMware ESXI 加密器。
ESXI 加密器只需提供目标文件的路径。它会扫
描目录中是否存在扩展名为 .log、.vmdk、.vmem、.
vswp 和 .vmsn 的文件。一旦找到它们，它就会使用
流密码 Sosemanuk 对它们进行加密。
Babuk 在每个包含加密文件的文件夹中放置一个
文本文件“How To Restore Your Files.txt”，其中带
有勒索字条。并且 Babuk 在加密文件之前不会关闭 
ESXI 虚拟机。这可能会导致文件损坏或导致无法解密
文件。
3.2.2 Luna
Luna 勒索软件于 2022 年 7 月出现。Luna 勒索
软件系列可用于加密运行多种操作系统的设备，包括
Windows、Linux 和 ESXI 系统。与其竞争对手不同，
该威胁从开始运行之日起就针对 VMware ESXI 实例。
这种新勒索软件背后的团队使用 Rust 开发了这种新病
毒，并利用其与平台无关的特性将其移植到多个平台，
而对源代码的更改很少。 与其他勒索软件威胁类似，
Luna 作为 RaaS 运行。
ESXI 加 密 器 针 对：OpenServer、Windows、
ITDR 之 vSphere
12
Program Files、Recycle.Bin、ProgramData、
AppData、All Users；.ini、.dll、.exe、.lnk 文 件 进
行加密，使用 X25519 和 AES 的组合。并且与 Babuk
相同的是 Luna 也不会关闭虚拟机，这可能会导致文
件损坏或无法解密加密文件。
文 件 加 密 后，Luna 会 在 文 件 名 后 附 加 .Luna
扩展名，然后创建一个带有勒索字条的文本文件
“readme-Luna.txt”。
3.2.3 REvil
REvil（又名 Sodinokibi）是最臭名昭著的勒索
软件团伙之一。它成立于 2019 年，此后按照 RaaS 模
式运营。2021 年 6 月，勒索软件开始针对 VMware 
ESXI实例。据称作者于2022年1月被俄罗斯当局逮捕，
但截至 2022 年 9 月，该团伙仍然活跃。
REvil 的 ESXI 加密器可以在大多数复杂环境独立
运行。运行后将立即开始加密当前目录中的所有文件。
在加密文件之前，该工具会尝试使用 esxcli 命令行实
用程序关闭虚拟机。当文件被加密时，它会在文件名
后附加一个特定的扩展名，例如 .rhkrc、.qoxaq、.
naixq。在加密文件所在的文件夹中，它还会留下带有
勒索字条的“XXXXX-readme.txt”文件（XXXX 字符
串替换为所选的随机扩展名）
其实，勒索组织一直在不断寻找新的攻击目标和
攻击手段，勒索组织做出 “针对 vSphere 平台攻击” 
的这种改变并非偶然。最近几年，全球安全机构与公
司均观察到针对 ESXI 服务器的勒索软件有所增加。由
于虚拟化是任何大规模部署计算和存储资源的基础，
因此勒索软件参与者现在将他们的目标扩展到包括虚
拟化服务器也就不足为奇了，针对 vSphere 平台的勒
索攻击，能够使勒索组织像控制一间企业服务器的机
房一样对数台服务器进行控制，攻击者对这些虚拟机
的源文件进行加密，可能直接造成数据库被加密、对
外提供服务中断甚至公司系统瘫痪，勒索组织往往开
出更高额的赎金，基于 VMware 在全球的用户体量，