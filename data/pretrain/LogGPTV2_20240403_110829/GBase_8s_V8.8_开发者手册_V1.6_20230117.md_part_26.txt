位：毫秒。
其持续时间。打开这 改该参数。
个选项可以方便地
跟踪需要优化的查
询。
 on：每次会话连
接或结束时，向
日志里打印一
配置是否在每次会 条信息。
log_connections/ 话连接或结束时向
 off：每次会话连 -
log_disconnections 服务器日志里打印
接或结束时，不
一条信息。
向日志里打印
信息。
默认值：off。
南大通用数据技术股份有限公司
134
GBase 8s V8.8开发者手册
 on：记录每个已
完成语句的持
续时间。
配置是否记录每个
只有系统管理员可以修
log_duration 已完成语句的持续  off：不记录已完
改该参数。
时 间。 成语句的持续
时间。
默认值：off。
 none：不记录任
何SQL语句。
 ddl：记录数据定
义语句。
配置日志中记录哪
 mod：记录数据 只有系统管理员可以修
些
log_statement
定义语句和数 改该参数。
SQL语句。
据操作语句。
 all ：记录所有
语句。
默认值： none。
缺省时，连接日志只记
录所连接主机的 IP 地
址。打开这个选项会同
时记录主机名。
 on：记录主机
名。 该参数同时影响
配置是否记录主机
log_hostname  off：不记录主机 7.3.2 查看审计结果 、
名。
名。 20.3.17
GS_SESSION_MEM
默认值：off。
ORY_DETAIL、20.3.72
PG_STAT_ACTIVITY
和log_line_prefix参数。
上表有关参数级别的说明请参见表6-16。
表 6-16 日志级别参数说明
级别 说明
DEBUG[1-5] 提供开发人员使用的信息。5级为最高级别，依次类推，1级为最低
南大通用数据技术股份有限公司
135
GBase 8s V8.8开发者手册
级别。
INFO 提供用户隐含要求的信息。如在VACUUMVERBOSE过程中的信息。
NOTICE 提供可能对用户有用的信息。如长标识符的截断，作为主键一部分创
建的索引。
WARNING 提供给用户的警告。如在事务块范围之外的COMMIT。
ERROR 报告导致当前命令退出的错误。
LOG 报告一些管理员感兴趣的信息。如检查点活跃性。
FATAL 报告导致当前会话终止的原因。
PANIC 报告导致所有会话退出的原因。
7 管理数据库安全
7.1 客户端接入认证
7.1.1 配置客户端接入认证
背景信息
如果主机需要远程连接数据库，必须在数据库系统的配置文件中增加此主机的信息，并
且进行客户端接入认证。配置文件（默认名称为pg_hba.conf）存放在数据库的数据目录里。
hba（host-basedauthentication）表示是基于主机的认证。
 本产品支持如下三种认证方式，这三种方式都需要配置pg_hba.conf文件。
 基于主机的认证：服务器端根据客户端的IP地址、用户名及要访问的数据库来查
看配置文件从而判断用户是否通过认证。
 口令认证：包括远程连接的加密口令认证和本地连接的非加密口令认证。
 SSL加密：使用OpenSSL（开源安全通信库）提供服务器端和客户端安全连接的
环境。
 pg_hba.conf文件的格式是一行写一条信息，表示一个认证规则，空白和注释（以#开头）
被忽略。
 每个认证规则是由若干空格和/，空格和制表符分隔的字段组成。如果字段用引号 包
南大通用数据技术股份有限公司
136
GBase 8s V8.8开发者手册
围，则它可以包含空白。一条记录不能跨行存在。
操作步骤
步骤1 以操作系统用户gbase登录数据库主节点。
步骤2 配置客户端认证方式，允许客户端以jack用户连接到本机，此处远程连接禁止使用
omm用户（即数据库初始化用户）。
例如，下面示例中配置允许IP地址为10.10.0.30的客户端访问本机。
gs_gucreload-Nall-Iall-h"hostalljack10.10.0.30/32sha256"
 使用jack用户前，需先本地连接数据库，并在使用如下语句建立“jack”用户：
gbase=#CREATEUSERjackPASSWORD'Test@123';
 -Nall表示GBase8s的所有主机。
 -Iall表示主机的所有实例。
 -h表示指定需要在“pg_hba.conf”增加的语句。
 all表示允许客户端连接到任意的数据库。
 jack表示连接数据库的用户。
 10.10.0.30/32表示只允许IP地址为10.10.0.30的主机连接。此处的IP地址不能为
GBase8s内部IP，在使用过程中，请根据用户的网络进行配置修改。32表示子网
掩码为1的位数，即255.255.255.255。
 sha256表示连接时jack用户的密码使用sha256算法加密。
这条命令在数据库主节点实例对应的pg_hba.conf文件中添加了一条规则，用于对连接
数据库主节点的客户端进行鉴定。
pg_hba.conf文件中的每条记录可以是下面四种格式之一，四种格式的参数说明请参见
7.1.2 配置文件参考。
localDATABASEUSERMETHOD[OPTIONS]
hostDATABASEUSERADDRESSMETHOD[OPTIONS]hostsslDATABASEUSER
ADDRESSMETHOD[OPTIONS]hostnosslDATABASEUSERADDRESSMETHOD
[OPTIONS]
因为认证时系统是为每个连接请求顺序检查pg_hba.conf里的记录的，所以这些记录的
顺序是非常关键的。
南大通用数据技术股份有限公司
137
GBase 8s V8.8开发者手册
在配置“pg_hba.conf”文件时，请依据通讯需求按照格式内容从上至下配置记录，
优先级高的需求需要配置在前面。GBase8s和扩容配置的IP优先级最高，用户手动配
置的IP请放在这二者之后，如果已经进行的客户配置和扩容节点的IP在同一网段，请
在扩容前删除，扩容成功后再进行配置。
因此对于认证规则的配置建议如下：
 靠前的记录有比较严格的连接参数和比较弱的认证方法。
 靠后的记录有比较宽松的连接参数和比较强的认证方法。
 一个用户要想成功连接到特定的数据库，不仅需要通过pg_hba.conf中的规则检查，
还必须要有该数据库上的CONNECT权限。如果希望控制某些用户只能连接到指
定数据库，赋予/撤销CONNECT权限通常比在pg_hba.conf中设置规则更为简单。
 对应GBase8s外部客户端连接，trust为不安全的认证方式，请将认证方式设置为
sha256。
 pg_hba.conf的配置通过gs_gucreload命令修改后，在新创建会话时会生效。如果
通过gs_gucset命令设置或直接编辑pg_hba.conf文件修改配置参数，需要重启数
据库生效或重新执行gs_gucreload命令生效。
-----结束
异常处理
用户认证失败有很多原因，通过服务器返回给客户端的提示信息，可以看到用户认证失
败的原因。常见的错误提示请参见表7-1。
表 7-1 错误提示
问题现象 解决方法
用户名或密码错误： 这条信息说明用户名或者密码错误，请检查
输入是否有误。
FATAL:invalidusername/password,login
denied
连接的数据库不存在： 这条信息说明尝试连接的数据库不存 在，请
检查连接的数据库名输入是否有误。
FATAL: database"TESTDB"doesnot
exist
南大通用数据技术股份有限公司
138
GBase 8s V8.8开发者手册
未找到客户端匹配记录： 这条信息说明已经连接了服务器，但服务器
拒 绝 了 连 接 请 求 ， 因 为 没 有 在 它 的
FATAL:nopg_hba.confentryforhost
pg_hba.conf配置文件里找到匹配的记 录。请
"10.10.0.60",user"ANDYM",database
联系数据库管理员在 pg_hba.conf 配置文件
"TESTDB"
加入用户的信息。
7.1.2 配置文件参考
表 7-2 参数说明
参数名称 描述 取值范围
local 表示这条记录只接受通过Unix -
域套接字进行的连接。没有这
种类型的记录，就不允许Unix
域套接字的连接。
只有在从服务器本机使用 gsql
连接且在不指定-U参数的情况
下，才是通过Unix域套接字连
接。
host 表示这条记录既接受一个普通 -
的TCP/IP套接字连接，也接受
一个经过SSL加密的TCP/IP套
接字连接。
hostssl 表示这条记录只接受一个经过 用SSL进行安全的连接，需要配置申请数
SSL 加密的 TCP/IP 套接字连 字证书并配置相关参数，详细信息请参见
接。 7.1.3 用SSL进行安全的TCP/IP连接。
hostnossl 表示这条记录只接受一个普通 -
的TCP/IP套接字连接。
DATABASE 声明记录所匹配且允许访问的 ● all：表示该记录匹配所有数据库。
数据库。
● sameuser：表示如果请求访问的数据库
和请求的用户同名，则匹配。
● samerole：表示请求的用户必须是与数
据库同名角色中的成员。
● samegroup：与samerole作用完全一致，
表示请求的用户必须是与数据库同名
南大通用数据技术股份有限公司
139
GBase 8s V8.8开发者手册
角色中的成员。
● 一个包含数据库名的文件或者文件中
的数据库列表：文件可以通过在文件名
前面加前缀@来声明。文件中的数据库
列表以逗号或者换行符分隔。
● 特定的数据库名称或者用逗号分隔的
数据库列表。
说明：值replication表示如果请求一个复制
链接，则匹配，但复制链接不表示任何特定
的数据库。如需使用名为replication的数据
库，需在database列使用记录“replication”
作为数据库名。
USER 声明记录所匹配且允许访问的  all：表明该记录匹配所有用户。
数据库用户。
 +用户角色：表示匹配任何直接或者间
接属于这个角色的成员。
说明：+表示前缀符号。
 一个包含用户名的文件或者文件中的
用户列表：文件可以通过在文件名前面
加前缀@来声明。文件中的用户列表以
逗号或者换行符分隔。
 特定的数据库用户名或者用逗号分隔
的用户列表。
ADDRESS 指定与记录匹配且允许访问的 支持IPv4和IPv6，可以使用如下两种形式
IP地址范围。 来表示：
 IP地址/掩码长度。例如， 10.10.0.0/24
 IP 地址子网掩码。例如， 10.10.0.0
255.255.255.0
说明：以IPv4格式给出的IP地址会匹配那
些拥有对应地址的IPv6连接，比如
127.0.0.1将匹配IPv6地址 ::ffff:
127.0.0.1。
METHOD 声明连接时使用的认证方法。 本产品支持如下几种认证方式， 详细解释
请参见表7-3：
南大通用数据技术股份有限公司
140
GBase 8s V8.8开发者手册
 trust
 reject
 md5（不推荐使用，默认不支持，可通
过 password_encryption_type 参数配
置）
说明：MD5加密算法安全性低，存在安全
风险，建议使用更安全的加密算法。
 sha256
 sm3
 cert
 gs（s 仅用于GBase8s内部节点间认证）
 peer（仅用于local模式）
表 7-3 认证方式
认证方式 说明
trust 采用这种认证模式时，本产品只完全信任从服务器本机使用gsql且不指定
-U参数的连接，此时不需要口令。
trust认证对于单用户工作站的本地连接是非常合适和方便的，通常不适用
于多用户环境。如果想使用这种认证方法，可利用文件系统权限限制对服
务器的Unix域套接字文件的访问。要使用这种限制有两个方法：
 设置参数unix_socket_permissions和unix_socket_group。
 设置参数unix_socket_directory，将Unix域套接字文件放在一个经过
恰当限制的目录里。
须知：设置文件系统权限只能Unix域套接字连接，它不会限制本地TCP/IP
连接。为保证本地TCP/IP安全，GBase8s不允许远程连接使用trust认证
方法。
reject 无条件地拒绝连接。常用于过滤某些主机。
md5 要求客户端提供一个md5加密的口令进行认证。
须知：
 MD5加密算法安全性低，存在安全风险，建议使用更安全的加密算
法。
 GBase8s保留md5认证和密码存储，是为了便于第三方工具的使用
南大通用数据技术股份有限公司
141
GBase 8s V8.8开发者手册
（比如TPCC评测工具）。
sha256 要求客户端提供一个sha256算法加密的口令进行认证，该口令在传送过
程中结合salt（服务器发送给客户端的随机数）的单向sha256加密，增强
了安全性。