日志审核中常见的搜索项目
opened"
错误代码400
错误代码401，403
“attack from"
“limit.exceeded,"“CPU utilization"
错误代码500
560,567
7035，7036
修改为原密码：628；修改为其他：627
创建624；启用626；更改642；禁用629；删除630
成功登录528.540；失败登录529-537.539；注销538.551
“session closed"
"failed"
or“failure”
目
---
## Page 212
文件中的字段和具体的数字字段标识符。
字段的分隔符，我们可以在字段表达式中使用“$[num]”引用特定字段。表15.2列出了日志
在我们的例子中，将从日志中捕捉特定的字段。awk的 print命令默认将空格作为一行文本中
的“print”命令，它能帮助我们从前一个例子中组合出恶意攻击者的所作所为。
隔离信息。
15.3.2
grep/manual/grep.html
统中的有效账户，进行某些恶意活动。
的403错误。现在看看结果，来自192.168.0.6地址的某个人递增客户账户号码，试图猜测系
误，更仔细地看看发生了什么。
如果网站上保护的内容未经正确授权进行访问，就会出现403错误。我们用grep 隔离这些错
awk的print命令是一个强大的选项，允许你使用一个表达式，并显示该函数的输出。
和 grep一样，这个实用程序在其他操作系统上有许多移植版本。我们将主要关注awk
awk是Linux/Unix平台中另一个强大工具，可以用作日志分析工具，从日志文件提取和
grep所有选项和正则表达式的更多细节，参见GNU网站：http://www.gnu.org/software/
2.grep和正则表达式
和第9章中的一些例子类似，我们使用一个正则表达式来隔离paybills.aspx页面中出现
192.168.0.6--[10/Ju1/2011:00:00:00+0200]
aspx?customer_acct=111111111HTTP/1.1"403-
awk字段ID
aspx?customer_acct=111111113 HTTP/1.1"403
aspx?customer_acct=111111112 HTTP/1.1"
log/httpd/access_log
$1
S
awk
表15.2访问日志的awk字段标识符
URL和参数
请求类型
时区
条目日期和时间
用户ID
标识符
IP地址
访问日志字段
403
"GET/paybills
/paybills.aspx?customer_acct=111111111
+200]
[10/Jul/2011:00:00:00
"GET
192.168.0.6
示例数据
第15章日志分析和收集工具191
---
## Page 213
109
号111111114是一个有效账户，并且更改了这个客户账户的密码！
侵人的清晰图景。从该例中可以看出，192.168.0.6上的攻击者能够用暴力破解法猜测账户编
段7的URL和字段9的状态码。
来自客户端192.168.0.6的日志条目，然后用Unix的“|”将信息传递给awk命令，以提取字
文件）数据的通用查询访问，以及Windows操作系统关键数据源（如事件日志、注册表、文
所称“日志解析器是强大的通用工具，提供了对基于文本（如日志文件、XML文件和CSV
中心下载（http://www.microsoft.com/en-us/download/details.aspx?id=24659），正如Microsoft
15.3.3Microsoft日志解析器
码）的页面和成功访问（状态码200）的页面。在下面的例子中，我们将使用 grep，仅返回
件系统和活动目录）的访问。”
上有一些移植版本。许多组织日常使用Windows，Windows也有自己的特殊日志和需求。
的使用知识。假定我们只想看到192.168.0.6的攻击者访问的URL，以及返回错误（如403代
注：表中的示例数据来自ApacheWeb服务器，使用常见的日志文件格式：
①日志文件中的连字符表示该值不可用，或者不存在
日志解析器（LogParser）是来自Microsoft 的免费工具。最新版本可以从Microsoft下载
本章中的许多工具是内建于Linux/Unix操作系统的工具，在Windows等其他操作系统
结合使用grep和awk，我们得到Web服务器上可能发生的攻击和某个账户可能已经被
日志解析器较为实用的功能之一是用类似SQL的语句查询Windows事件日志的能力。
200/change_password.aspx?customer_acct=111111114&pwd=1234
200/paybills.aspx?customer_acct=111111114
403/paybills.aspx?customer_acct=1llll1113
403/paybills.aspx?customer_acct=111111112
403/paybills.aspx?customer_acct=11111l111
现在，我们已经了解了更多关于如何解析日志文件字段的知识，让我们组合grep和awk
关于awk强大选项的更多内容，参见：
(print$9,$7}
awk字段ID
$8
$10
返回数据大小
HTTP状态码
协议
访问日志字段
403
HTTP/1.1"
示例数据
（续）
---
## Page 214
www.gnu.org/software/coreutils/manual/coreutils.html)。
器搜索结果，我们可以在Excel中过滤结果，进行日志分析。
（CSV）。CSV格式可以由多种不同应用程序加载。下面显示了MicrosoftExcel中的日志解析
中进行更详细的分析。这类的工具还有很多，下面介绍几个可以添加到你的工具集中的工具：
下面的例子说明了使用工具生成Windows安全事件日志中事件5159有关报告的方法。
15.3.4
日志解析器工具支持许多不同的输出格式，在本例中，选择生成逗号分隔数值格式文件
我们已经介绍了进行人工日志分析的一些有力工具，并组合这些工具，让你在日志审核
图15.2展示了MicrosoftExcel中的搜索结果。
这个实用程序可以用于查看日志文件的结尾，或者在日志最后发生的当前操作（http://
图15.1展示了使用Microsoft日志解析器生成文本报告的一个示例。
1.tail
其他可以考虑的基本工具
BUIONTONTOFF
i:
LogParser
rootegbo
图15.1
ile:<guery
Microsoft日志解析器
HISCEN.
N002
第15章日志分析和收集工具193
---
## Page 215
194
制。该工具可以从 http:/sourceforge.net/projects/logwatch/下载。
manual/sed.html)。
也可以用于格式化日志输出，使其更加容易被其他工具使用（http://www.gnu.org/software/sed/
他工具查看（http://www.gnu.org/software/coreutils/manual/coreutils.html)。
15.3.5基本工具在日志分析中的作用
Windows系统上的一个很好补充。更多信息参见该工具的网站：http://www.logreport.org/lire.html。
持来自大部分非Windows设施和软件的各种日志文件。这个工具是Microsoft Log Analyzer在非
Microsoft日志分析器（LogAnalyzer）类似，你可以从日志文件中过滤和生成一个报告。Lire支
Sed是类似awk的解析工具，在文本搜索和替换中很有用，可以使日志更加清晰易读，
这个实用工具是tail的反面，可以用于检索大日志文件的开头部分，使其更加容易用其
在前几个小节中，我们展示了使用基本工具的一些很好的方法，这些工具是免费的，或
Lire是一个应用程序套件，
Logwatch是离线解析和审核日志的实用工具，它具有可插入的接口，允许你根据需求定
5.Lire
4.Logwatch
3.Sed
2.head
图15.2Microsoft Excel中的搜索结果
，可以用来从日志文件生成自定义报告。在这个方面它与
---
## Page 216
如下功能可能正是你的环境中必需的。
端进程）从配置为从发送数据的其他syslog客户端接收日志。
将其日志发送到本地或者集中化syslog服务器。最后，有一个syslog守护进程（或者服务器
程序中添加syslog日志记录。
内建的syslog日志记录支持，还有许多编程语言库扩展，
15.4.1syslog
和Snare等工具，以及它们帮助集中化日志的方式。
免费的工具可以帮助你在环境中集中日志记录信息。我们将关注 syslog、syslog-ng、rsyslog
环境中的日志，从而方便实现PCIDSS、HIPAA和SOX等收集与分析依从性需求。有一些
15.4
具可能只适合于取证。
求，和必需的时间和资源需求。在许多情况下，随着日志尺寸的增长和环境的发展，这些工
该考虑到下面列出的这些工具的一些局限性，以及它们如何融人一个环境、组织的依从性需
索和提炼日志数据，以隔离攻击。这些工具最适合用于小型组织和人工日志分析及审核你应
者是你的环境中已经采用和管理的系统和软件包的一部分。示例演示了如何使用这些工具搜
syslog 在本书中我们讨论的集中化日志信息关键领域中都很强大，但是 syslog 中缺少的
syslog有两个主要的组成部分。syslog客户端存在于系统之上，生成日志，可以配置为
在过去的几章中，我们讨论了在组织中集中日志记录信息的必要性，使你能够关联整个
syslog是目前最为普遍的跨平台日志记录解决方案。网络设备、Unix/Linux系统上都有
在 syslog 的常见实现中，syslog通过UDP端口514对日志消息进行通信和中继。在繁
1.有保证的消息传送
■你需要知道所要搜索的内容。在例中，我们知道想要搜索的文本，然后使用 grep和
■在不同日志之间关联的能力有限。如果你的日志文件分散在多个设备和多个日志文件
■
需要考虑的因素有：
串所需要的时间长得难以想象。这些工具通常会搜索整个文件，以找出你想要的内容。
用于集中化日志分析的实用工具
在大文件上运行的时间很长。如果你的组织有数以TB计的日志信息，找到特定字符
awk及其他工具，根据非常明确的文本对数据进行切片。如果你搜索趋势或者统计异
网络路径中攻击是如何发生的。
中，同步防火墙、Web服务器和客户端工作站中的不同日志很难。这就很难弄清整个
常，这些工具可能并不适合。
，可以方便应用程序开发人员在应用
第15章日志分析和收集工具195
---
## Page 217
196
发到集中 syslog服务器。在 syslog 的许多常见实现中，日志记录原始生成来源的信息在中继
到集中化syslog服务器上。
显的是传输控制协议（TCP）流量）通过。所以，从主机发出的每条日志消息都不能保证记录
忙的网络上，用户数据报协议（UDP）流量可能会丢弃消息，以便更高优先级的流量（最明
rsyslog有如下关键好处：
章）的功能有一些差异，但是整体来说，两者在功能集上基本兼容。和 syslog-ng 相比，选择