Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Owning the Network:
Adventures in Router Rootkits
Michael Coppola
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Who am I?
▪Security Consultant at Virtual Security 
Research in Boston, MA (we're hiring!)
▪Student at Northeastern University
▪Did some stuff, won some CTFs
▪http://poppopret.org/
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
How did this all start?
▪.npk packages on MikroTik routers
▪Install new features
▫ SOCKS proxy
▫ VPN
▫ IPv6 support
▫ XEN/KVM virtualization
▪Potentially get a shell?
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Router Firmware Upgrade Feature
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
The Big Question
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Can a universal process be 
developed to modify SOHO 
router firmware images to 
deploy malicious code without 
altering the interface or 
functionality of the device?
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Can a universal process be 
developed to modify SOHO 
router firmware images to 
deploy malicious code without 
altering the interface or 
functionality of the device?
...a rootkit of sorts?
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Intentions
▪Share my personal experience pursuing the 
topic and the challenges encountered
▪Gain better insight into router internals
▪Release some code
▪Pop some shells
▪Pwn some devices
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Prior Work
▪OpenWRT/DD-WRT
▫ Custom firmware, reverse engineering, hardware / 
firmware profiling
▪firmware-mod-kit
▫ De/reconstruction of firmware images
▪devttys0.com
▫ Firmware modding, reverse engineering, and 
exploitation
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Use Cases
▪Default/weak credentials on admin panel
▪RCE/auth bypass vulnerability
▪CSRF file upload
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
The Targets
WNR1000v3
Vendor: NETGEAR
Version: 1.0.2.26NA
Format: NETGEAR .chk
Arch: MIPS
OS: Linux 2.4.20
Bootloader: CFE
Filesystem: SquashFS 3.0
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
The Targets
WGR614v9
Vendor: NETGEAR
Version: 1.2.30NA
Format: NETGEAR .chk
Arch: MIPS
OS: Linux 2.4.20
Bootloader: CFE
Filesystem: SquashFS 2.1
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
The Targets
FD57230-4 v1110
Vendor: Belkin
Version: 4.03.03
Format: EFH
Arch: MIPS
OS: Linux 2.4.20
Bootloader: CFE
Filesystem: CramFS v2
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
The Targets
TEW-652BRP v3.2R
Vendor: TRENDnet
Version: 3.00B13
Format: Realtek
Arch: MIPS
OS: Linux 2.6.19
Bootloader: U-Boot
Filesystem: SquashFS 4.0
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Generalized Technique
▪Profile the image
▪Extract parts from the image
▪Deploy payload
▪Repack the image
▪Update metadata
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Connecting to the Console
▪Most routers offer an RS-232 (serial) port
▪Find terminals → Solder connectors → Shell!
▪Useful for profiling the device, testing new 
payloads, debugging purposes
▪Bootloader access provides recovery, quick 
testing of new firmware images
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Connecting to the Console
▪Four pins to search for:
▫ GND – Ground
▫ VCC – Voltage Common Collector (+3.3V)
▫ TXD (TX) – Transmit Data
▫ RXD (RX) – Receive Data
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Console on WGR614v9
Serial port
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Console on WGR614v9
RX
TX
GND
VCC
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
WGR614v9 Serial Pinout
GND
TX
RX
VCC
RX
TX
GND
VCC
1
6
Router
Shifter
Board
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Connecting to the Console
▪Computer RS-232 port operates at 12V
▪Router RS-232 port operates at 3.3V
▪Need to introduce a voltage shifter in the 
circuit to prevent damage
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Sparkfun <333
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Building the RS-232 Shifter Board
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Building the RS-232 Shifter Board
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Putting it in Action
RX
TX
GND
VCC
RX
TX
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Putting it in Action
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Putting it in Action
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Profiling the Image
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Profiling the Image
▪What exactly makes up this giant blob of 
binary?
▫ Bootloader?
▫ Kernel?
▫ Filesystem?
▪Early attempts were crude and limited in 
helpfulness
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Profiling the Image
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
find-headers.pl
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
find-headers.pl
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
binwalk
▪Identifies headers, files, and code in files
▪Uses libmagic + custom signature database
▪devttys0.com
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
binwalk vs. find-headers.pl
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Extracting from the Image
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Items to Extract (WNR1000v3)
▪Headers
▪LZMA blob
▪SquashFS filesystem
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Extracting the Headers
▪Offset: 0 bytes
▪Size: 86 bytes
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Extracting the LZMA Blob
▪Offset: 86
▪Size: 592580 bytes
Here is our
Linux Kernel
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Extracting the SquashFS Filesystem
▪Offset: 592666
▪Size: 1988809 bytes
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Need unsquashfs?
firmware-mod-kit's got 'em
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
...but not the right one.
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
...neither does the source code.
But it's supposed to!
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Getting unsquashfs
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Getting unsquashfs
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Getting unsquashfs
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Getting unsquashfs
Copyright © 2012 Virtual Security Research, LLC.
All Rights Reserved.
Getting unsquashfs