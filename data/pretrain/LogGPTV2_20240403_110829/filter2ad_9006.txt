# 【技术分享】OWA和Office 365双因子认证绕过（附演示视频）

**译文声明**
本文为翻译文章，原文来源：blackhillsinfosec
原文地址：[链接]
译文仅供参考，具体内容及含义以原文为准。
**翻译者：** [sinensis](http://bobao.360.cn/member/contribute?uid=2642794559)
**稿费：190RMB（欢迎投稿！）**
**投稿方式：** 发送邮件至 linwei#360.cn 或访问 [网页版](http://bobao.360.cn/contribute/index) 在线投稿

**前言**
BLACK HILLS信息安全公司非常支持负责任地披露漏洞。我于2016年9月28日向微软报告了该漏洞，但直到本文发布之日（2016年11月2日），微软对该漏洞的响应仅限于“目前尚无进展”。详细的时间表见文末。

**漏洞分析**

**更新说明（美国东部时间下午3点）：** 本文探讨了如何绕过微软Outlook Web App (OWA) 的双因子认证，该认证由第三方供应商DUO Security提供。需要澄清的是，此漏洞并非由DUO Security的产品引起，而是由于双因子认证未能有效保护微软Exchange服务器，从而导致其Web接口暴露。

在DerbyCon第六届会议上，我展示了一个名为MailSniper的工具，它可以用来爬取微软Exchange服务器上的敏感邮箱信息。MailSniper通过连接到Exchange Web Services (EWS) 服务器来尝试获取用户的收件箱。EWS是一个Web接口，微软推荐用于客户端与Exchange服务器之间的交互。使用EWS后，应用程序可以访问用户的收件箱、联系人和日历等信息。

在DerbyCon会议上，Nick Landers发表了一场关于黑客如何利用Outlook和Exchange进行攻击的演讲。在这场精彩的演讲中，他提到一个观众提问：双因子验证是否能防止黑客攻击？Nick指出，尽管某些公司在OWA上启用了双因子验证，但在实际操作中，这种设置可能并不足以阻止攻击。基于这一点，我推测如果EWS未启用双因子验证，那么利用MailSniper就有可能绕过双因子安全验证并读取用户邮件。

为了验证这一假设，我设置了OWA登录页面，并安装了DUO Security提供的双因子验证软件——Duo for Outlook。我在手机上配置了DUO移动应用，并使用测试账户"PI:EMAIL"登录OWA。同步DUO后，每次尝试登录时我的手机都会收到确认通知。然而，如果我是没有DUO同步的攻击者，即使成功登录OWA也无法进一步操作。

在此之前，MailSniper只能在指定主机域名的情况下运行。我对部分代码进行了修改，添加了"-Remote"选项，使Invoke-Selfsearch函数能够远程工作。此外，还需调整代码以实现对收件箱的访问。首先，需确定公司使用的外部邮箱服务器，通常可通过Autodiscover服务或子域名爆破（如mail.domain.com, owa.domain.com, webmail.domain.com等）找到。邮箱服务器需通过'-ExchHostname'参数指定；若未指定，Invoke-selfSearch将自动尝试获取。其次，必须先收集用户的密码凭证。更多细节请参阅相关博客。

一旦收集到Exchange服务器信息和用户凭证，可使用以下命令在网络上查找邮箱：
```powershell
Invoke-SelfSearch -Mailbox PI:EMAIL -ExchHostname mail.domain.com -Remote
```
执行上述命令后，会弹出授权窗口要求输入目标用户的登录凭证。根据组织设定，这里应输入内部邮箱地址或域账号。

输入凭证后，MailSniper将尝试连接EWS URL：https://mail.domain.com/EWS/Exchange.asmx，并搜索用户收件箱中的特定关键词（默认为密码、凭证、证书）。这种方法同样适用于已启用DUO双因子验证的账户，MailSniper能够成功绕过验证并检索到相关信息。

为进一步证明问题不在于DUO，我们还设置了Office 365并利用微软自己的Azure多因素身份验证(MFA)保护用户登录。测试结果表明，即便在这种情况下，通过EWS绕过双因子验证的方法依然有效。只要验证了outlook.office365.com的密码，攻击者仍可绕过MFA读取用户收件箱。

**建议**
最直接的解决方案可能是禁用Exchange Web Services (EWS)，但这也会带来诸多不便，例如Mac版Outlook依赖EWS与Exchange通信。因此，短期内建议限制OWA仅允许内网访问，并允许用户通过VPN连接。对于特定用户或整个组织手动限制EWS访问也是一种选择。需要注意的是，任何依赖EWS的应用程序可能会受到影响。

**结论**
总而言之，虽然Outlook网页版登录的双因子认证在一定程度上提高了安全性，但它并未完全覆盖所有认证协议。本文展示了EWS服务未受到双因子验证保护的事实。只需知晓用户凭据即可读取其收件箱。其他类似的服务，如基于HTTP传输的MAPI或自动发现扫描也可能存在相同风险。再次测试了第三方双因子登录验证软件及微软的AWS，预计其他系统也面临相似挑战。

**漏洞发布时间表**
- **2016年9月28日 东部时间下午1:51** - 向微软报告了此漏洞。
- **2016年9月28日 东部时间下午10:01** - 收到微软回复，表示已将问题转交给相关人员处理。
- **2016年10月3日 东部时间上午11:15** - 发邮件询问进展。
- **2016年10月3日 东部时间下午7:41** - 微软回复称已开始审理此问题。
- **2016年10月11日 东部时间上午8:55** - 再次发邮件询问进展。
- **2016年10月11日 东部时间下午4:07** - 收到回复称仍在等待产品团队审核。
- **2016年10月21日 东部时间下午3:37** - 第三次发邮件询问进展。
- **2016年10月24日 东部时间下午4:46** - 回复称仍未取得进展。
- **2016年11月2日** - 在Black Hills信息安全处公开此漏洞。

**演示视频**
[此处插入视频链接]