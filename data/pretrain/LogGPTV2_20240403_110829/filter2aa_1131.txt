Author: Ömer Coşkun 
Why Nation-State Malwares Target Telco Networks: 
Dissecting Technical Capabilities of Regin and Its Counterparts 
The supreme art of war is to subdue the enemy without fighting. Sun Tzu  
Outline 
¡  Overview 
¡  Telecom Network Architecture 
¡  Practical Attack Surfaces 
¡  GRX Attack Vectors 
¡  SS7 Attack Vectors 
¡  Practical Attack Scenarios 
¡  Rootkit Attacks: Regin and  it’s counterparts 
¡  Common Rootkit Techniques and Regin 
¡  Regin vs. Uruborus and Duqu 
¡  Demo:  PoC || GTFO  
¡  Questions ? 
1 
$ whoami 
  Ömer Coşkun (@0xM3R)  
¡  BEng. Computer Science 
  Research Assistant in  Quantum Cryptography & 
Advanced Topics in AI  
2 
¡ Industry Experience 
KPN – CISO , Ethical Hacking 
Verizon – Threat & Vulnerability Management 
IBM ISS – Threat Intelligence 
¡  Interests  
Algorithm Design, Programming, Cryptography, 
Reverse Engineering, Malware Analysis, OS Internals, 
Rootkits    
$ REDteam 
3 
Motivations 
4 
¡  Analyze existing vulnerabilities and attack 
surface of GSM networks  
¡  Governments hack their own citizens 
¡  Surveillance implants shifted focus to telecom 
networks and network devices 
¡  European Telco companies are really 
paranoid after Regin attack 
¡  Rootkits are fun : a lot to learn & challenge  
¡  Reproduce the attack scenario and 
implement it! 
GSM Network Architecture 
5 
GSM Network Architecture 
6 
Regin targets GSM Networks 7 
Determining Attack Surface 
8 
Determining Attack Surface 
9 
Determining Attack Surface 10 
Potential Attack Surfaces 
11 
¡  Absence of physical intrusion detection devices 
¡  Vulnerable services running accessible from BTS 
¡  Absence of tamper resistance and 
unauthorized access protection 
¡  Improper network segmentation; inner non-
routable segments of the Telco company could 
accessible. 
¡  Core GPRS Network and Network Subsystem 
(NSS) could be exploitable!  
Potential Attack Surfaces 
12 
GRX Networks 
13 
GRX Networks 
14 
¡  GPRS roaming exchange, 
interconnecting networks. 
¡  Your local GSM provider abroad 
¡  Trust-based, highly interconnected 
network, made for internet sharing 
¡  A failure or malicious activity would 
affect multiple connected machines 
¡  Multiple attacks vectors, not limited 
to a particular segment where you 
are originating from. 
GRX Networks – Attack Vectors 15 
GRX Networks – Attack Vectors 16 
¡  GPRS roaming 
exchange, 
interconnecting 
networks. 
¡  Your local GSM provider 
abroad 
¡  Trust-based, highly 
interconnected network, 
made for internet 
sharing 
¡  Multiple attacks vectors, 
not limited to a 
particular segment 
where you are 
originating from. 
GRX Networks – Network Flow 17 
GRX Networks – Network Flow 18 
Juicy information is here. 
GRX Networks – Network Flow 19 
And more juicy information is 
here. 
GRX Networks – Attacks & Flaws 20 
Are you telling me all your communication 
intercepted and logged including your 
physical location?. 
   SS7 & SIGTRAN 
21 
   SS7 & SIGTRAN 
22 
SS7 Introduces procedures 
for 
¡  User identification. 
Routing 
¡  Billing 
¡  Call management 
   SS7 & SIGTRAN 
23 
•  Flow control of transmitted information 
•  Traffic congestion controls 
•  Peer entity status detection (GT + PC or 
SPC) 
•  Traffic Monitoring and monitoring 
measuremen 
¡ SS7 Features: 
   SS7 & SIGTRAN 
24 
   SS7 & SIGTRAN 
25 
   SS7 Protocol Analysis 
26 
   SS7 Protocol Analysis 
27 
All the juicy 
info here : 
ü  Calling no. 
ü  Called no 
ü  Call duration 
ü  Call duration  
ü  Call status 
28 
Feel confident that NSA not interested in 
‘Good’ people?. 
   SS7 Protocol Attacks & Flows 
29 
   SS7 Practical Attack Scenarios 
1 
• Intercepting subscribers calls 
30 
   SS7 Practical Attack Scenarios 
2 
• Subscriber service change attacks 
31 
   SS7 Practical Attack Scenarios 
3 
• Interception of SMS messages  
4 
• Interception of outgoing calls 
5 
• Redirection of incoming or outgoing calls  
6 
• Making changes in user bills or balance 
32 
   SS7 Practical Attack Scenarios 
7 
• Unblocking stolen mobile devices 
IEEE August 
2015, Nokia 
Researchers 
Espoo, Finland. 
33 
   SS7 Practical Attack Scenarios 
IEEE August 
2015, Nokia 
Researchers 
Espoo, Finland. 
7 
• Unblocking stolen mobile devices 
34 
Source: https://wikileaks.org/hackingteam/emails/emailid/343623  
Hacking Team after SS7 
Hacks 
35 
    Rootkit Techniques  
Hardware/Software 
Interception: Captain 
Hook Style Hacking 
36 
Captain Hook Style Hacking: Intercepts 
every function, keeps a copy of the content for 
herself,  and then let the function continue as it 
was supposed to … 
37 
    Rootkit Techniques  
38 
    Regin Platform Structure  
39 
    Regin Platform Analysis  
• No one had the dropper when started analysis 
• Multi stage and encrypted framework structure  
• Modules are invoked via SOA structure by the framework 
• Malware data are stored inside the VFS 
• Researched GSM Networks had no indication of 
compromise J 
¡ Challenges, Hurdles & Difficulties: 
40 
    Regin Platform Analysis  
¡ What is the solution  ?  
Check similar work & the  write up: 
http://artemonsecurity.com/regin_analysis.pdf    
RE Orchestrator 
Memory dumps 
Static Analysis 
Instrumentation 
of Calls 
Dynamic 
Analysis 
41 
    Regin Platform Stages 
42 
    Regin Platform – Stage 1 
43 
    Regin Platform – Stage 2 
44 
    Regin Platform – Stage 2 
45 
    Regin Platform – Stage 3 & 4 
46 
    Regin Platform – Stage 3 & 4 
47 
    Regin Platform – Stage 3 & 4 
    – How to Weaponize it ?  
1 
• Register a call-back function to a process 
2 
• Log the PID of the target process 
3 
• Obtain PEB via ZwQueryInformation() for base 
adresses of the modules   
4 
• Obtain the EP via PsLookupProcesByProcess()    
5 
• Get inside to the  process context via 
KeStackAttachProcess() referenced by EP  
6 
• Read PEB and other data in process context  
48 
    Regin Platform – Stage 3 & 4 
    – How to Weaponize it ?  
49 
    Uruborus  < Regin < Duqu2 
Uruborus 
Regin 
Duqu2 
Encrypted VFS 
Encrypted VFS 
Encrypted VFS #2 
PatchGuard Bypass  
Fake Certificate 
Stolen Certificate 
Multiple Hooks 
Orchestrator SOA 
Orchestrator SOA 
AES 
RC5 
Camellia 256, AES, 
XXTEA 
Backdoor/Keylogger 
Mod 
Advanced Network/
File Mods 
More Advanced 
Network/File/USB 
Mods 
50 
    Regin Attack Simulation 
Mini Regin Attack Simulator 
Covert Channel Data Exfiltration 
Run as a thread of legitimate app’s address space 
Orchestrator simulator and partial SOA 
File system, registry and network calls hooking 
Backdoor/Keylogger Mod 
51 
Demo  
52 
Questions ?  
53 
54 
References 
¡  http://denmasbroto.com/article-5-gprs-network-architecture.html 
¡  http://docstore.mik.ua/univercd/cc/td/doc/product/wireless/
moblwrls/cmx/mmg_sg/cmxgsm.htm 
¡  http://4g-lte-world.blogspot.nl/2013/03/gprs-tunneling-protocol-gtp-in-
lte.html 
¡  http://labs.p1sec.com/2013/04/04/ss7-traffic-analysis-with-wireshark/ 
¡  http://www.gl.com/ss7_network.html 
¡  http://www.slideshare.net/mhaviv/ss7-introduction-li-in 
¡  http://www.gl.com/ss7.html