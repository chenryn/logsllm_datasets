destroy-method自配置清理 ............................................................................................................................. 125
6.1.7.6. Spring 依赖注入四种方式 .................................................................................................................... 126
构造器注入 .......................................................................................................................................................... 126
setter方法注入 ................................................................................................................................................... 127
静态工厂注入 ...................................................................................................................................................... 127
实例工厂 .............................................................................................................................................................. 127
6.1.7.7. 5种不同方式的自动装配 ...................................................................................................................... 128
6.1.8. Spring APO原理 ...................................................................................................................... 129
6.1.8.1. 概念 ........................................................................................................................................................ 129
6.1.8.2. AOP核心概念 ....................................................................................................................................... 129
6.1.8.1. AOP两种代理方式 ............................................................................................................................... 130
JDK动态接口代理 ............................................................................................................................................. 130
CGLib动态代理 .................................................................................................................................................. 131
6.1.8.2. 实现原理 ................................................................................................................................................ 131
6.1.9. Spring MVC原理 ...................................................................................................................... 132
6.1.9.1. MVC流程 ............................................................................................................................................... 132
Http请求到DispatcherServlet ....................................................................................................................... 133
HandlerMapping寻找处理器 ............................................................................................................................ 133
调用处理器Controller ........................................................................................................................................ 133
13/04/2018 Page 7 of 283
Controller调用业务逻辑处理后，返回ModelAndView ................................................................................. 133
DispatcherServlet查询ModelAndView .......................................................................................................... 133
ModelAndView反馈浏览器HTTP ................................................................................................................... 133
6.1.9.1. MVC常用注解 ....................................................................................................................................... 133
6.1.10. Spring Boot原理 ....................................................................................................................... 134
1. 创建独立的Spring应用程序 ............................................................................................................................. 134
2. 嵌入的Tomcat，无需部署WAR文件 ............................................................................................................. 134
3. 简化Maven配置 ................................................................................................................................................ 134
4. 自动配置Spring ................................................................................................................................................. 134
5. 提供生产就绪型功能，如指标，健康检查和外部配置 ................................................................................... 134
6. 绝对没有代码生成和对XML没有要求配置 [1] ............................................................................................... 134
6.1.11. JPA原理 .................................................................................................................................... 134
6.1.11.1. 事务 .................................................................................................................................................... 134
6.1.11.2. 本地事务 ............................................................................................................................................ 134
6.1.11.1. 分布式事务 ........................................................................................................................................ 135
6.1.11.1. 两阶段提交 ........................................................................................................................................ 136
1准备阶段 ........................................................................................................................................................... 136
2提交阶段： ....................................................................................................................................................... 136
6.1.12. Mybatis缓存 .............................................................................................................................. 137
6.1.12.1. Mybatis的一级缓存原理（sqlsession级别） .............................................................................. 138
6.1.12.2. 二级缓存原理（mapper基本） ..................................................................................................... 138
具体使用需要配置： .......................................................................................................................................... 139
6.1.13. Tomcat架构 .............................................................................................................................. 139
7. 微服务 ................................................................................................................................................. 140
7.1.1. 服务注册发现 ............................................................................................................................ 140
7.1.1.1. 客户端注册（zookeeper） .................................................................................................................. 140
7.1.1.2. 第三方注册（独立的服务Registrar） ............................................................................................... 140
7.1.1.3. 客户端发现............................................................................................................................................. 141
7.1.1.4. 服务端发现............................................................................................................................................. 142
7.1.1.5. Consul .................................................................................................................................................... 142
7.1.1.6. Eureka .................................................................................................................................................... 142
7.1.1.7. SmartStack ............................................................................................................................................ 142
7.1.1.8. Etcd ........................................................................................................................................................ 142
7.1.2. API 网关 ..................................................................................................................................... 142
7.1.2.1. 请求转发 ................................................................................................................................................ 143
7.1.2.2. 响应合并 ................................................................................................................................................ 143
7.1.2.3. 协议转换 ................................................................................................................................................ 143
7.1.2.4. 数据转换 ................................................................................................................................................ 143
7.1.2.5. 安全认证 ................................................................................................................................................ 144
7.1.3. 配置中心 .................................................................................................................................... 144
7.1.3.1. zookeeper配置中心 ............................................................................................................................. 144
7.1.3.2. 配置中心数据分类 ................................................................................................................................. 144
7.1.4. 事件调度（kafka） ................................................................................................................... 144
7.1.5. 服务跟踪（starter-sleuth） ................................................................................................... 144
7.1.6. 服务熔断（Hystrix） ................................................................................................................ 145
7.1.6.1. Hystrix断路器机制 ................................................................................................................................ 146
7.1.7. API管理 ..................................................................................................................................... 146
8. NETTY 与RPC .................................................................................................................................. 147
8.1.1. Netty 原理 .................................................................................................................................. 147
8.1.2. Netty 高性能 .............................................................................................................................. 147
8.1.2.1. 多路复用通讯方式 ............................................................................................................................ 147
8.1.2.1. 异步通讯NIO .................................................................................................................................... 148
8.1.2.2. 零拷贝（DIRECT BUFFERS使用堆外直接内存） .......................................................................... 149
8.1.2.3. 内存池（基于内存池的缓冲区重用机制） ......................................................................................... 149
8.1.2.4. 高效的Reactor线程模型 ..................................................................................................................... 149
Reactor单线程模型 ........................................................................................................................................... 149
Reactor多线程模型 ........................................................................................................................................... 150
13/04/2018 Page 8 of 283
主从Reactor多线程模型 .................................................................................................................................. 150
8.1.2.5. 无锁设计、线程绑定 ............................................................................................................................. 151
8.1.2.6. 高性能的序列化框架 ............................................................................................................................. 151
小包封大包，防止网络阻塞 .............................................................................................................................. 152
软中断Hash值和CPU绑定............................................................................................................................. 152
8.1.3. Netty RPC实现 ......................................................................................................................... 152
8.1.3.1. 概念 ........................................................................................................................................................ 152
8.1.3.2. 关键技术 ................................................................................................................................................ 152
8.1.3.3. 核心流程 ................................................................................................................................................ 152
8.1.3.1. 消息编解码............................................................................................................................................. 153
息数据结构（接口名称+方法名+参数类型和参数值+超时时间+ requestID） ........................................... 153
序列化 .................................................................................................................................................................. 154
8.1.3.1. 通讯过程 ................................................................................................................................................ 154
核心问题(线程暂停、消息乱序) ....................................................................................................................... 154
通讯流程 .............................................................................................................................................................. 154
requestID生成-AtomicLong ............................................................................................................................. 154
存放回调对象callback到全局ConcurrentHashMap .................................................................................... 154
synchronized获取回调对象callback的锁并自旋wait .................................................................................. 154
监听消息的线程收到消息，找到callback上的锁并唤醒 .............................................................................. 155
8.1.4. RMI实现方式 ............................................................................................................................ 155
8.1.4.1. 实现步骤 ................................................................................................................................................ 155
8.1.5. Protoclol Buffer ......................................................................................................................... 156
8.1.5.1. 特点 ........................................................................................................................................................ 157
8.1.6. Thrift ........................................................................................................................................... 157
9. 网络 ..................................................................................................................................................... 159
9.1.1. 网络7层架构 ............................................................................................................................ 159
9.1.2. TCP/IP原理............................................................................................................................... 160
9.1.2.1. 网络访问层(Network Access Layer) ................................................................................................... 160
9.1.2.2. 网络层(Internet Layer) ......................................................................................................................... 160
9.1.2.3. 传输层(Tramsport Layer-TCP/UDP) .................................................................................................. 160
9.1.2.4. 应用层(Application Layer).................................................................................................................... 160
9.1.3. TCP三次握手/四次挥手 .......................................................................................................... 161
9.1.3.1. 数据包说明............................................................................................................................................. 161
9.1.3.2. 三次握手 ................................................................................................................................................ 162
9.1.3.3. 四次挥手 ................................................................................................................................................ 163
9.1.4. HTTP原理 ................................................................................................................................. 164
9.1.4.1. 传输流程 ................................................................................................................................................ 164
1：地址解析 ....................................................................................................................................................... 164
2：封装HTTP请求数据包 ............................................................................................................................... 165
3：封装成TCP包并建立连接 .......................................................................................................................... 165
4：客户机发送请求命 ........................................................................................................................................ 165
5：服务器响应.................................................................................................................................................... 165
6：服务器关闭TCP连接 .................................................................................................................................. 165
9.1.4.2. HTTP状态 ............................................................................................................................................. 165
9.1.4.3. HTTPS ................................................................................................................................................... 166
建立连接获取证书 .............................................................................................................................................. 167
证书验证 .............................................................................................................................................................. 167
数据加密和传输 .................................................................................................................................................. 167
9.1.5. CDN 原理................................................................................................................................... 167
9.1.5.1. 分发服务系统 ......................................................................................................................................... 167
9.1.5.2. 负载均衡系统： ..................................................................................................................................... 168
9.1.5.3. 管理系统：............................................................................................................................................. 168
10. 日志 ................................................................................................................................................. 169
10.1.1. Slf4j ............................................................................................................................................ 169
10.1.2. Log4j .......................................................................................................................................... 169
10.1.3. LogBack ..................................................................................................................................... 169
10.1.3.1. Logback优点 ................................................................................................................................... 169
10.1.4. ELK ............................................................................................................................................. 170
13/04/2018 Page 9 of 283
11. ZOOKEEPER ................................................................................................................................. 171
11.1.1. Zookeeper概念 ........................................................................................................................ 171
11.1.1. Zookeeper角色 ........................................................................................................................ 171
11.1.1.1. Leader ............................................................................................................................................... 171
11.1.1.2. Follower ............................................................................................................................................ 171
11.1.1.3. Observer ........................................................................................................................................... 171
11.1.1.1. ZAB协议 ........................................................................................................................................... 172
事务编号 Zxid（事务请求计数器+ epoch） ................................................................................................... 172
epoch ................................................................................................................................................................... 172
Zab协议有两种模式-恢复模式（选主）、广播模式（同步） ...................................................................... 172
ZAB协议4阶段 ................................................................................................................................................. 172
Leader election（选举阶段-选出准Leader） ................................................................................................ 172
Discovery（发现阶段-接受提议、生成epoch、接受epoch） .................................................................... 173
Synchronization（同步阶段-同步follower副本） ......................................................................................... 173
Broadcast（广播阶段-leader消息广播） ....................................................................................................... 173
ZAB协议JAVA实现（FLE-发现阶段和同步合并为 Recovery Phase（恢复阶段）） ............................ 173
11.1.1.2. 投票机制 ............................................................................................................................................ 173
11.1.2. Zookeeper工作原理（原子广播） ......................................................................................... 174
11.1.3. Znode有四种形式的目录节点 ................................................................................................ 174
12. KAFKA ............................................................................................................................................ 175
12.1.1. Kafka概念 ................................................................................................................................. 175
12.1.2. Kafka数据存储设计 ................................................................................................................. 175
12.1.2.1. partition的数据文件（offset，MessageSize，data） ............................................................ 175
12.1.2.2. 数据文件分段segment（顺序读写、分段命令、二分查找） .................................................... 176
12.1.2.3. 数据文件索引（分段索引、稀疏存储） ......................................................................................... 176
12.1.3. 生产者设计 ................................................................................................................................ 176
12.1.3.1. 负载均衡（partition会均衡分布到不同broker上） ................................................................. 176
12.1.3.2. 批量发送 ............................................................................................................................................ 177
12.1.3.3. 压缩（GZIP或Snappy） ............................................................................................................... 177
12.1.1. 消费者设计 ................................................................................................................................ 177
12.1.1.1. Consumer Group ........................................................................................................................... 178
13. RABBITMQ .................................................................................................................................... 179
13.1.1. 概念 ............................................................................................................................................ 179
13.1.2. RabbitMQ架构 ......................................................................................................................... 179
13.1.2.1. Message ........................................................................................................................................... 180
13.1.2.2. Publisher .......................................................................................................................................... 180
13.1.2.3. Exchange（将消息路由给队列 ） ................................................................................................. 180
13.1.2.4. Binding（消息队列和交换器之间的关联） .................................................................................. 180
13.1.2.5. Queue ............................................................................................................................................... 180
13.1.2.6. Connection ...................................................................................................................................... 180
13.1.2.7. Channel ............................................................................................................................................ 180
13.1.2.8. Consumer ......................................................................................................................................... 180
13.1.2.9. Virtual Host ..................................................................................................................................... 180
13.1.2.10. Broker ............................................................................................................................................... 181
13.1.3. Exchange 类型 ......................................................................................................................... 181
13.1.3.1. Direct键（routing key）分布： .................................................................................................. 181
13.1.3.2. Fanout（广播分发） ....................................................................................................................... 181
13.1.3.3. topic 交换器（模式匹配） ................................................................................................... 182