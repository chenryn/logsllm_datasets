# 微信小程序抓包之路
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 前言
ios端和mac用户可以忽略以下内容，本文针对于windows端和android端的微信无法抓取小程序数据包提出相关解决方案。
最近测试小程序发现以前的抓包方式都不管用了，无论是用PC端还是手机端都有问题，这里经过测试给出大家提供解决方案。
## 原因分析
Android7.
0及以上的系统中，每个应用可以定义自己的可信CA集。默认情况下，应用只会信任系统预装的CA证书，而不会信任用户安装的CA证书。而某些APP只信任自己内置的证书，所以导致安装的证书针对这些APP无法生效。  
微信新版本貌似就是只信任自己内置证书，再或者android11对于证书又有什么新的改变，因为我自己的手机上证书是添加到系统证书里了，但还是无法抓取小程序的数据包，最后选择了以下的解决方法。
## 解决方案一
直接通过pc端，配置全局代理，进行抓包，当然是无法抓到的，百度得来了一种方法。
先打开小程序，启动任务管理器，确定目录位置
然后定位到WMPFruntime文件夹
关闭小程序，关闭微信，删除文件夹内内容，重新打开微信小程序就能抓包
## 解决方案二
使用模拟器，这里我使用的夜神模拟器，安卓版本android7，微信版本8.0+
模拟器代理配置
证书生成
首先生成android可用的证书，从burp导出证书der文件
生成pem格式证书
openssl x509 -inform der -in bp.der -out bp.pem
查看内容
openssl x509 -subject_hash_old -in bp.pem
获取到hash标识
修改pem文件名字为框选处+0，如图我这里应该修改为9a5ba575.0
证书导入
打开adb，查看机器
依次执行
adb root // 提升到root权限
adb remount //重新挂载system分区
adb push 9a5ba575.0 /system/etc/security/cacerts/ //将证书放到系统证书目录
查看系统证书就会发现成功安装
抓包
打开微信配置代理即可抓取小程序包
## 解决方案三
降级，这个操作说简单也简单，选择低版本微信安装使用，模拟器也选择低版本的安卓系统。问题在于测试机去做系统降级刷机操作可能繁琐点，所以优先选择模拟器。
使用模拟器助手添加android 5版本的模拟器
高版本微信无法安装到android5上，所以需要去应用市场上找一下低版本的微信。这种方式大概率没有奇奇怪怪的抓包问题，证书也很容易配置。
有同事跟我讲使用低版本微信操作可能会有封号风险，故没有深入测试，有兴趣的朋友可以折腾下，不过如果仅仅为了测试小程序，建议直接使用方案一或方案二，当然也可以直接使用ios系统活mac。