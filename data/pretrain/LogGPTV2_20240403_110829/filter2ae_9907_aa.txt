# DanaBot恶意软件的最新活动与技术分析

## 引言
Proofpoint研究人员于2018年5月首次发现了DanaBot，初步分析表明其与针对澳大利亚企业的威胁行为者有关。本文将对DanaBot进行深入的技术剖析，并探讨其近期针对美国企业的攻击活动。

## DanaBot近期活动概述
ESET的研究人员最近发布了一篇关于DanaBot最新攻击活动的文章，指出该恶意软件已经影响了波兰、意大利、德国和澳大利亚等多个国家。值得注意的是，在9月底，研究团队观察到攻击者将原本用于攻击美国目标的Panda银行木马替换为DanaBot。

### Hancitor攻击活动
9月26日，Proofpoint的研究人员发现了一次大规模的垃圾邮件攻击，主要针对美国用户。这些邮件通常包含一个伪装成eFax文档的附件（如图1所示），并附带下载链接指向带有恶意宏代码的文件（如图2所示）。一旦受害者启用宏功能，就会触发Hancitor恶意软件的执行，进而从远程服务器下载两个版本的Pony窃取器以及DanaBot银行木马。

- **图1**: 带有恶意payload下载链接的电子邮件示例
- **图2**: 包含Hancitor payload的宏文档

## 恶意软件技术分析 (v2.003 版本)
DanaBot是一款采用Delphi语言编写的银行木马程序。以下内容基于最新的v2.003版本展开，该版本自今年9月初开始活跃。此版本号可以通过发送给C2服务器的version字符串识别（见图3）。

- **图3**: 与系统信息一同返回给C2服务器的DanaBot版本字符串

### 组件结构
DanaBot由三个主要部分构成：
1. **加载器**：负责下载及初始化主组件。
2. **主组件**：负责进一步下载、配置和加载特定模块。
3. **模块**：实现各种具体的恶意功能。

#### 反逆向工程措施
为了增加逆向工程难度，DanaBot引入了大量的冗余代码段，包括无用指令、条件判断及循环等。此外，它还利用Windows API函数哈希值及加密字符串来混淆关键操作逻辑，从而阻碍分析师或自动化工具对其工作原理的理解。加密后的字符串以DWORDs数组形式存储，并需要通过特定密钥进行解密处理。相关IDA Pro Python脚本可在GitHub上找到。

### C2通信机制
在v2.003中，所有DanaBot组件均使用TCP 443端口上的二进制协议与C2服务器通信，尽管使用了标准HTTPS端口号，但实际上并未启用TLS加密。

#### 二进制协议头格式
每个消息头部长度固定为183字节，后跟可选的数据体。大多数请求中的头部字段会在响应报文中被回显。具体字段布局如下：
- **偏移量0**：随机填充值
- **偏移量4**：硬编码-1 (DWORD)
- **偏移量8**：命令标识(DWORD)
- **偏移量0xC**：关联ID (DWORD)
- **偏移量0x10**：硬编码1 (DWORD)
- **偏移量0x14**：线性同余生成器产生的随机数(DWORD)
- **偏移量0x18**：未知计数器变量(DWORD)
- **偏移量0x1C**：系统架构信息(DWORD)
- **偏移量0x20**：Windows版本详情(DWORD)
- **偏移量0x24**：命令参数(DWORD)
- **偏移量0x28**：管理员状态(DWORD)
- **偏移量0x2C**：进程完整性级别(DWORD)
- **偏移量0x30**：数据体长度(QWORD)
- **偏移量0x38**：下一字段长度(BYTE)
- **偏移量0x39**：Bot ID (32字节)
- **偏移量0x59**：下一字段长度(BYTE)
- **偏移量0x5A**：命令依赖数据(32字节)
- **偏移量0x7A**：下一字段长度(BYTE)
- **偏移量0x7B**：一次性验证码(32字节)
- **偏移量0x9B至结尾**：更多随机填充值

#### 已知命令列表
目前记录到的命令集包括但不限于：
- **0x454 (1108)**: 请求主组件 - 加载器向C2服务器发起请求获取主DLL文件。
- **0x453 (1107)**: 初始信标 - 主组件初次连接时发送。
- **0x44C (1100)**: 请求模块标识符 - 获取可用插件列表。
- **0x44D (1101)**: 请求特定模块 - 根据指定ID下载对应的插件。
- **0x44F (1103)**: 获取配置文件 - 下载必要的配置设置。
- **0x44E**: 发送收集到的信息 - 如系统详情或屏幕截图等。

以上就是关于DanaBot恶意软件及其最新动态的详细解析。希望这些信息能够帮助安全专业人士更好地理解和防御此类威胁。