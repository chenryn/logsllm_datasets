87% of the UDP requests. FIRMA does not make assumptions about the input dataset
and is not affected by unbalanced family trafﬁc distributions.
6.2 Quantitative Results
Table 2 summarizes the results for each step of our approach. On the left, it shows the
number of trafﬁc clusters, the initial number of signatures generated, the number of
signature clusters and signatures after signature merging, and the number of signature
clusters after signature clustering. On the right, it shows the ﬁnal results: the number of
family clusters and signatures, and the remaining signatures after minimization.
Initially a large number of trafﬁc clusters is produced (2,360 and 976, respectively).
Table 3 shows the split of trafﬁc clusters by message type. There is an order of mag-
nitude more HTTP GET trafﬁc clusters than POST ones. This is due to downloaders
14
Dataset
MALICIA
MIXED
# Trafﬁc
Sigs
Clusters (initial) (merging) (merging) (clustering) Families Sigs (min.)
# SCs
# SCs
# Sig.
# Sig.
2,360
971
1,196
601
57
108
Table 2. Summary of results for each step.
1,699
884
535
514
57
108
116
269
63
126
HTTP
SMTP
IRC
Dataset GET POST HEAD EHLO HELO NICK USER Other TCP UDP
0 677 391
MALICIA 1,244
MIXED
488
6 127 282
47
50
0
1
1
2
0
3
0
6
0
6
Table 3. Trafﬁc Clustering Results.
that perform GET requests to obtain other executables and where each malware binary
randomizes the name of the ﬁle to download. Surprisingly, the initial number of sig-
natures (column 3) is smaller than the number of trafﬁc clusters (column 2). This is
because some trafﬁc clusters contain trafﬁc that is not different enough from benign
trafﬁc. When parsed into ﬁelds, the ﬁeld values are common in the benign trafﬁc pool
and no signature can be produced. The number of signature clusters and signatures re-
duces after merging (columns 4 and 5) because signatures with common tokens in their
payloads are merged and their signature clusters combined.
The ﬁnal numbers show that even if the number of initial trafﬁc clusters is large, the
subsequent steps are able to group the malware binaries into a small number of families
(57 and 108 respectively). On average FIRMA produces 2.3 signatures for each fam-
ily cluster, each capturing a different network behavior. This shows the prevalence of
malware families with multiple network behaviors and demonstrates the importance of
building a signature for each behavior. Note that if we had not built separate signatures
for each behavior we would have been left instead with very general signatures with
large false positives. If the optional minimization is applied, the number of signatures
per family reduces to 1.1 because for many families each malware binary exhibits all
network behaviors so the signatures for each behavior overlap.
Table 4 shows the distribution of the generated signatures by protocol. The largest
number of signatures is for HTTP (55%–80%), but there is a large number of signatures
for other network behaviors (20%–45%). There are 11 families (34%) in the MALICIA
dataset for which no HTTP signature is generated. These families cannot be detected
by prior tools that focus exclusively on the HTTP trafﬁc [26]. In addition, for 14 other
families (44%) their HTTP signatures contain tokens outside the HTTP method and
URL (e.g., in headers or the body), which makes our HTTP signatures more speciﬁc
than the ones generated by Perdisci et al.
Malware clustering accuracy. To evaluate how accurately FIRMA groups malware
binaries into families we use the classiﬁcation for each binary in the MALICIA dataset
produced in [24]. Note that we only use the labels after FIRMA has output the results.
They are not used during FIRMA’s processing but only for quantifying precision and
recall of the output clustering. Table 5 shows the precision, recall, and F-Measure for
Total
Dataset
MALICIA 116 18.1% (21) 0.9% (1)
MIXED
UDP
TCP
269 11.5% (31) 20.4% (55) 55.8% (150) 5.6% (15) 6.7% (18)
Table 4. Distribution of generated signatures by protocol.
15
HTTP
SMTP
80.1% (93) 0.9% (1)
IRC
0% (0)
Trafﬁc Clustering
Family Clustering
Dataset
MALICIA
Precision Recall F-Measure Precision Recall F-Measure
98.8%
100% 84.1%
100% 97.7%
91.3%
Table 5. Accuracy of the initial trafﬁc clustering and the ﬁnal family clustering.
Trafﬁc Rate Time Period # Alarms # Alarm Sig.
FPR
359 pps
5.5 days
21
2
10−7 (0.00001%)
Table 6. False positive analysis on live trafﬁc.
both the initial trafﬁc clustering and the ﬁnal family clustering. The results shows very
high precision in both clusterings and how the recall signiﬁcantly improves after the
signature merging and clustering steps. In the ﬁnal malware clustering FIRMA achieves
perfect precision and a very high 97.7% recall, with a F-Measure of 98.8%. These
results indicate the accuracy of FIRMA when classifying a large number of unlabeled
malware binaries with highly varied network trafﬁc.
We examine the results to understand which families are split into multiple family
clusters. The ground truth for the MALICIA dataset has 32 families and FIRMA ﬁnds
an extra family that was missed in [24]. Four families are split into multiple family clus-
ters by FIRMA. Zbot is split into 21 clusters. Being a malware kit, each malware owner
conﬁgures the kit with a different set of C&C servers and a different key to encrypt its
C&C trafﬁc. FIRMA groups the malware binaries into multiple family clusters, likely
corresponding to different operations. There is also an unknown family (CLUSTER:B)
that splits into 3 family clusters. This is the only family for which FIRMA cannot gen-
erate any signature. An initial signature was generated for a 7 byte fully polymorphic
packet but it was thrown away during validation because it created false positives. Mal-
ware binaries in this family are grouped only based on overlap in endpoint information.
False positive analysis. The generated signatures can produce false positives on live
trafﬁc if the benign trafﬁc pool does not accurately or extensively represent the trafﬁc
of the monitored network. To measure the false positive rate, we deploy the signatures
on a Snort IDS at the border of our lab’s network for 5.5 days. This network comprises
over 100 hosts, with a variety of operating systems, although being a research lab, only
a small number of the hosts run Windows. Table 6 summarizes the results. The IDS
sees a trafﬁc rate of 359 packets per second (pps). Only two signatures were matched
for a total of 21 alarms. To distinguish between true and false positives, we manually
inspect the packets causing the alarms (logged by Snort when a signature triggers). One
signature (18 alarms) corresponds to a SSLv2 handshake, which a malware family uses
for C&C. Unfortunately, our benign trafﬁc pool did not contain instances of SSLv2.
We consider these 18 alarms false positives. The other signature (3 alarms) matches a
16
Dataset
MALICIA
MIXED
Feature
Trafﬁc
# Sig.
#SCs
# SCs Total
Extraction Clustering (initial) (merging) (clustering) Time
42.3s 44m9s
0.1s 20m6s
41m40s
19m8s
Table 7. Runtime for each step in FIRMA.
78.0s
17.0s
37.4s
35.0s
1.8s
6.4s
EHLO localhost SMTP command by a spam bot. The 3 alarms were on incoming
SMTP trafﬁc to 3 of our servers from a single host located in China. One of those 3
servers is not used as an email server and has likely been identiﬁed through scanning.
The logs of our two email servers show that the SMTP exchange did not send valid
email. We believe these 3 alarms are true positives. Overall, the false positive rate of
the generated signatures is 0.00001%. The low number of true positives is likely due to
few Windows hosts in our network and to our signatures covering only malware in our
datasets, excluding older malware that periodically scans networks (e.g., Conﬁcker).
Performance. Table 7 shows the runtime of each step. We run FIRMA on a 32-bit 3.3
GHz host with 4 cores and 4GB RAM. The total runtime is 20 and 44 minutes for the
MIXED and MALICIA datasets respectively. The most expensive step is extracting the
features from the network traces, which also includes obtaining the message ﬁeld trees
from Wireshark. This step is IO bound and accounts for 94% of the runtime. All other
steps are completed in less than 2.5 minutes in both datasets. As the feature extraction
time is linear on the number of input network traces and their size, FIRMA scales well
to larger datasets. A paper and pencil comparison with the runtime results by Perdisci
et al. [26] (after adjusting for different number of cores and processor frequency) shows
that FIRMA is up to 90 times faster (4.5 times if we include the feature extraction,
which [26] does not report).
6.3 Qualitative Results
To assess the quality of the network signatures generated by FIRMA, we compare them
with the signatures manually generated in [24]. Of the 32 families in the MALICIA
dataset, for 11 FIRMA generates more signatures than the manual analysts, for 21
FIRMA generates the same number, and for 1 less. For 10 of the 11 families where
FIRMA generates more signatures, FIRMA captures new network behaviors that were
missed by the malware analysts. Some of the new signatures have better ﬁle coverage
than the manual ones. For example, for the winwebsec fake antivirus each of the two
manual signatures covers part of the winwebsec ﬁles, but one of FIRMA’s signatures
covers all of them. For the other family the manual signature captures similarity in a pa-