# 证明与分析

## 1. 证明细节
我们通过以下公式来表示：
\[ t_1, \ldots, t_l, \ldots, t_e, \ldots, t_{l2} \in \text{Traces}(DBToy') \]
\[ \text{Send}(V, n_2) \in t_{i2} \]
\[ \text{Recv}(V, f(n_2, m, P)) \in t_{k2} \]
\[ \text{DBSec}(V, P, n_2, f(n_2, m, P)) \in t_{l2} \]
\[ (\nexists j \in \{i2 + 1, \ldots, k2 - 1\}. \text{Action}(P) \in t_j) \]
\[ (\nexists j \in \{1, \ldots, l2\}. \text{Compromise}(V) \in t_j) \]
\[ (\nexists j \in \{1, \ldots, l2\}. \text{Compromise}(P) \in t_j) \]

因此，从公式 (12) 和 (13) 可以推导出 \( DBToy' \not\models^\star \text{dbsec\_hnst} \)，这完成了证明。

### 最小披露消息的推理
最小披露消息的推理基于以下观察：任何后续无共谋的跟踪，对手可以通过较少的知识实现，也可以通过更多的知识实现。

## 2. 距离绑定协议的安全性分析
在本节中，我们将展示如何使用 Tamarin 工具来构建距离绑定协议的安全性证明或攻击。

### 2.1 案例研究
我们对文献中的一些距离绑定协议进行了 Tamarin 安全性分析。对于每个协议，我们验证其是否满足 dbsec_hnst（无共谋）、是否满足 dbsec（无共谋）以及是否抵抗恐怖欺诈（定义 6）。结果如表 1 所示。

#### 攻击类型识别
为了确定针对特定协议的攻击类型，我们提供两个提示：
1. 如果协议不满足 dbsec_hnst，则存在黑手党欺诈。
2. 如果协议满足 dbsec_hnst 但不满足 dbsec，则存在距离欺诈和/或距离劫持。在这种情况下，建议在交互模式下运行 Tamarin 并检查使 dbsec 属性无效的跟踪，以直观地确认攻击的存在。更多详细信息可以在我们的仓库中找到。

在分析的协议中，只有三个协议是距离绑定安全且抵抗恐怖欺诈的。这些协议是 Reid 等人的 [53]、DBPK [17] 和 Swiss Knife [37]。总共发现有十九个协议易受恐怖欺诈攻击。

UWB 冲击无线电协议 [39] 的作者没有给出其安全通道的精确规范。因此，我们采用了两种方案：非对称加密/解密和消息认证码（MAC）。我们发现了一种针对 UWB [39] 的黑手党欺诈攻击。

### 2.2 我们的方法与 Chothia 等人的方法比较
正如第 2 节所述，Chothia 等人在 USENIX 安全研讨会 2018 上分析了一些距离绑定协议 [20]。我们的发现显示了他们结果中的错误。本节将简要解释和解读我们工作之间的三个不一致之处。更详细的讨论可以在附录 B 中找到。

第一个不一致之处是关于示例 2 中的 DBToy 协议。通过使用 Chothia 等人的框架，我们分析了该协议并识别出一种针对它的恐怖欺诈攻击。这与定理 1 相矛盾。不一致的原因在于 Chothia 等人使用的恐怖欺诈定义与我们不同。他们的恐怖欺诈证明者只要其长期密钥未泄露就可以共谋。它没有考虑攻击的（不可）重复性。

Chothia 等人 [20] 还产生了与广泛接受并在文献中反复提到的结果相矛盾的结果。例如，Hancke 和 Kuhn 的协议 [34] 被广泛认为存在恐怖欺诈攻击（见例如 [2, 3, 5, 6, 14, 16, 37]）。然而，Chothia 等人报告的情况与此相反，没有任何讨论。这种不一致是由于作者对协议的符号抽象过度近似造成的。

最后，Chothia 等人没有报告 Meadows 等人 [46] 的协议版本和 MAD 协议 [19] 除了恐怖欺诈之外的其他攻击。然而，我们的分析识别出每种协议的有效距离劫持攻击。我们注意到这些攻击并不是新的，因为它们已经被许多先前的工作报道过，例如 [6, 26, 27, 44]。

### 2.3 ISO/IEC 14443 协议
ISO/IEC 14443 标准用于当今超过 80% 的非接触式智能卡。在我们的案例研究中，我们分析了基于此标准的三个协议：
- NXP 的 MIFARE Plus（X 版本和 EV1 版本）带接近检查（专利 [58]），在全球公共运输、访问管理、学校和校园卡、市民卡、员工卡和汽车停车场中有广泛应用。
- PaySafe [21]，这是 Visa 的 payWave 接触支付协议（qVSDC 模式）[32] 的距离绑定版本。
- PayPass [31]，这是 Mastercard 的具有中继抵抗功能的接触支付协议。

为了演示我们的分析，我们选择了 PayPass 协议，如图 8 所示。其他两个协议的分析类似。在这些协议的上下文中，验证者 R 是读取终端，证明者 C 是卡片。

PayPass 是 EMV 支付协议的中继抵抗版本，实现在 Mastercard 的非接触式卡片中。EMV（代表 Europay、Mastercard 和 Visa）已成为国际智能卡/芯片支付协议的标准。

#### 修复 ISO/IEC 14443 协议
我们将重点放在 PayPass 协议上。在给出修复之前，让我们先说明其不满足 dbsec 的原因。Mauw 等人在 [44] 中分析 PaySafe 时指出，由于快速阶段挑战和响应之间缺乏因果关系，可能发生距离欺诈。也就是说，快速阶段响应可以在接收到挑战之前产生。为了解决这个问题，Mauw 等人建议在卡片的响应中包含读取器的随机数 UN。

Mauw 等人的建议应用于 PayPass 可以防止距离欺诈，但不能防止距离劫持。为了防止后者，我们必须将快速阶段消息绑定到卡片的身份。我们通过在卡片的快速阶段响应中添加 UN 和卡片对随机数 nC 的签名来实现这一点。因此，卡片的快速阶段响应变为：
\[ \langle nC, ti, \text{sign}(nC, skC), UN \rangle \]

这一修改使得协议 PayPass_Fix 满足 dbsec。请注意，签名 \(\text{sign}(nC, skC)\) 可以在快速阶段之前计算，因此不会延迟卡片的响应。

同样的解决方案，即在卡片的快速阶段响应中添加 \(\langle \text{sign}(nC, skC), UN \rangle\)，也适用于 PaySafe 和 MIFARE Plus 协议。不过，为了保持与后一协议中密码操作的一致性，我们建议使用键控 MAC 消息 \(\text{MAC}(KM, nC, '1', '2')\) 而不是签名 \(\text{sign}(nC, skC)\)。同样，键控 MAC 消息可以在快速阶段之前计算。

修改后的协议 PayPass_Fix 不抵抗恐怖欺诈，因为卡片在快速阶段之前泄漏 \(\langle nC, ti, \text{sign}(nC, skC) \rangle\) 会导致有效的攻击。为了防止恐怖欺诈，我们建议进一步修改 PayPass 协议，使卡片的快速阶段响应和 SDAD 消息变为：
\[ \langle nC, ti, f(UN, nC \oplus KM) \rangle \]
和
\[ \text{sign}(\langle UN, AC \rangle, skC) \]
其中 \(f\) 是一个不可逆函数。对 PayPass 的上述修改导致了一个既满足 dbsec 又抵抗恐怖欺诈的协议 PayPass_FixTF。

类似的构造可以应用于 PaySafe 和 MIFARE Plus 以修复它们。Tamarin 模型和两个版本的每个协议的安全证明可在我们的仓库中找到。我们提供了每个协议的两个不同的修复版本，以便根据应用系统的要求进行选择。例如，如果恐怖欺诈不是一个关键问题，那么建议使用第一个修改版本（即 Protocol_Fix）而不是第二个版本（即 Protocol_FixTF），因为后者对标准的修改更为“激进”。无论应用程序如何，我们总是建议使用第一个修改版本而不是原始协议。

可能还有其他使 ISO/IEC 14443 协议抵抗恐怖欺诈的修改，而且很可能所有这些修改（像我们的一样）都需要对标准进行重大更改。例如，SDAD 消息的组成可能会有所不同。