# MD5碰撞技术的演变与应用
## 译文声明
本文为翻译文章，原始来源：360安全播报。译文仅供参考，具体含义及表达以原文为准。
**发布日期：2016年1月20日**
**编辑：白名单分析组**

### 0x1 概述
自王小云破解MD5算法以来，国内外对MD5碰撞的研究及其恶意利用从未停止。尤其是在软件安全领域，已发现多起通过MD5碰撞对抗安全软件的案例。大多数情况下，攻击者采用的是早期较为成熟的快速MD5碰撞技术，但也有一部分样本使用了新的碰撞方式。

这种新型碰撞方法首次出现在2014年初，并处于初步测试阶段，因此当时仅有少量样本在传播。到了2015年初，这类新型碰撞样本开始大规模爆发。经过深入分析和追踪，可以确认这些大量出现的新式碰撞样本是由同一个团伙制造的（后文简称“碰撞作者”）。2015年9月，该团伙开始尝试将数字签名技术与MD5碰撞结合，进一步增强其对抗安全软件的能力。同年11月，他们又进行了新的尝试，即利用双签名技术来规避查杀。下图展示了近两年内碰撞作者所采取的不同攻击手段的演变过程：

![图1-1 碰撞作者近两年的攻击演化过程](path_to_image)

本文将详细探讨碰撞作者各阶段使用的不同技术手段。首先介绍新型MD5碰撞的特点，然后对比早期版本以突出新方法的优势；接着讨论如何将新型MD5碰撞与数字签名相结合进行高级别利用；再通过一个具体的样本行为分析来展示典型的攻击流程；最后总结碰撞作者恶意软件的传播情况及其影响范围。

### 0x2 新型碰撞特征
早期的MD5碰撞主要依赖于"前缀构造法"，即基于相同的前缀程序A，在尾部添加不同的附加数据生成两个具有相同MD5值但功能各异的样本B和C，如下所示：

![图2-1 早期MD5碰撞的利用手法](path_to_image)

然而，这种方法存在明显缺陷——由于碰撞后的两个样本仅在尾部有细微差别，如果其中一个包含恶意代码，则另一个也很容易被检测到。

相比之下，新型MD5碰撞能够生成两个MD5校验值完全相同但功能完全不同的文件，其中一个为良性程序，另一个则为恶意程序。这是通过分别向两个不同的前缀程序A和B中追加特定的数据块实现的，从而创建出MD5一致但内容迥异的文件C和D，如图所示：

![图2-2 新型MD5碰撞的利用手法](path_to_image)

例如，在一组样本中，正常程序是一个DLL文件，而恶意程序则是一个经过VMP强壳保护的日历EXE程序：

![图2-3 一组新型碰撞样本的静态特征](path_to_image)
![图2-4 一组新型碰撞样本的MD5计算结果](path_to_image)

尽管这两个程序的功能和结构完全不同，但它们的MD5校验值却完全一致。这并非偶然现象，而是通过精心设计实现的结果。通过比较两者的文件内容可以看到，虽然大部分数据差异显著，但在末尾部分却高度相似，且文件大小相等。这种构造方式基于"选择性前缀碰撞法"(Chosen-prefix collision)，原理图见下：

![图2-6 “选择前缀碰撞法”原理](path_to_image)

通过选择不同的前缀并计算生日数和碰撞块添加至文件尾部，即可得到两个具有相同MD5值的文件。虽然直接使用HashClash工具计算这些尾部数据耗时较长，但碰撞作者对其进行了优化，使其能够高效地批量生成此类碰撞样本。以下为此阶段样本的一些典型例子（每组均包含一个正常程序和一个恶意程序）：

![图2-7 此阶段碰撞样本的典型样例](path_to_image)

其中，恶意程序通常作为桌面应用程序的一部分，而正常程序则可能是任何类型的软件。由于每组样本都共享同一MD5指纹，这使得碰撞作者能够更有效地绕过安全软件的检测机制。

... (后续章节内容保持不变)