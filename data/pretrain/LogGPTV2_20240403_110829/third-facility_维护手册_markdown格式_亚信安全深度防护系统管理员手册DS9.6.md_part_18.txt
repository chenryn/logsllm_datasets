^Failed password
Failed SSHD password attempt
注意： 请注意指示字符串开头的正则表达式插入符号("^")。虽然"Failedpassword"未显示在日志的开头，但是日志审查解码
器会将日志分解为多部分。（请参阅上面的“解码器”部分。）其中一个部分为“日志”，它是日志的消息部分（相对于
作为整个日志的 "full_log"）。
下表列出了支持的正则表达式语法：
正正则则表表达达式式语语法法 描描述述
\w A-Z、a-z、0-9 之间的单个字母和数字
\d 0-9 之间的单个数字
\s 单个空格
\t 单个制表符
\p ()*+,-.:;?[]
\W 非 \w
\D 非 \d
\S 非 \s
\. 所有内容
+ 匹配以上任意项中的一个或多个（例如，\w+、\d+）
* 匹配以上任意项中的零个或多个（例如，\w*、\d*)
^ 指示字符串的开头 (^somestring)
$ 指定字符串的结尾 (somestring$)
110
亚信安全服务器深度安全防护系统 9.6 管理员指南 创建日志审查规则
正正则则表表达达式式语语法法 描描述述
| 指示多个字符串之间的 "OR" 关系
条件语句
规则评估可有条件地基于已被评估为 true 的其他规则。>> 标记指示日志审查引擎仅在标记中标识的规则已评估为 true
时评估此子规则。以下示例显示三种规则：100123、100124 和 100125。已使用 >> 标记将规则 100124 和 100125 修改
为 100123 规则的子规则：
sshd
Logging every decoded sshd message
100123
^Failed password
authentication_failure
Failed SSHD password attempt
100123
^Accepted password
authentication_success
Successful SSHD password attempt
评估的层次结构
>> 标记本质上创建了一组具有层次结构的规则。也就是说，通过在规则中包含 >> 标记，该规则成为
>> 标记所引用的规则的子规则。在对日志应用任何规则之前，日志审查引擎将评估 >> 标记并生成父/
子规则的层次结构。
注意： 可使用层次结构父/子结构来提高规则的效率。如果父规则未评估为 true，则日志审查引擎将忽略该父规则的子规则。
注意： 虽然>>标记可用于引用完全不同的日志审查规则中的子规则，但是您应避免这样做，因为这样会使以后
查看规则非常困难。
下表显示了可用原子规则条件选项的列表：
标标记记 描描述述 注注意意
match 特征码 匹配事件（日志）的任意字符串。
regex 正则表达式 匹配事件（日志）的任意正则表达式。
decoded_as 字符串 任意预先匹配的字符串
srcip 源 IP 地址 解码为源 IP 地址的任意 IP 地址。使用 "!" 可否定 IP 地址。
dstip 目标 IP 地址 解码为目标 IP 地址的任意 IP 地址。使用 "!" 可否定 IP 地址。
srcport 源端口 任意源端口（匹配格式）。
dstport 目标端口 任意目标端口（匹配格式）。
user 用户名 解码为用户名的任意用户名。
program_name 程序名称 从 syslog 进程名称解码的任意程序名称。
hostname 系统主机名 解码为 syslog 主机名的任意主机名。
采用
time hh:mm - hh:mm 或 为触发规则事件必须落入的时间范围。
hh:mm am - hh:mm pm 格式的时间范围
weekday 周内日期（星期日、星期一、星期二等） 为触发规则事件必须落入的周内日期。
111
亚信安全服务器深度安全防护系统 9.6 管理员指南 创建日志审查规则
标标记记 描描述述 注注意意
id ID 从事件解码的任意 ID。
url URL 从事件解码的任意 URL。
使用 >110000112255> 标记可使此规则基于 100125 规则。将仅针对已匹配成功登录规则的 sshd 消息检查此规则。
100125
6 pm - 8:30 am
Login outside business hours.
policy_violation
日志条目的大小限制
以下示例采用之前的示例并添加了 mmaaxxssiizzee 属性，该属性告知日志审查引擎仅评估字符数少于 maxsize 的规则：
100125
6 pm - 8:30 am
Login outside business hours.
policy_violation
下表列出了可能的原子规则的树状结构选项：
标标记记 描描述述 注注意意
if_sid 规则 ID 将此规则添加为与指定签名 ID 相匹配的规则的子规则。
if_group 组 ID 将此规则添加为与指定组相匹配的规则的子规则。
if_level 规则级别 将此规则添加为与指定严重性级别相匹配的规则的子规则。
description 字符串 规则的描述。
info 字符串 关于规则的附加信息。
cve CVE 编号 要与规则关联的任意常见弱点和漏洞 (CVE) 编号。
alert_by_email
指示警报是否应生成电子邮件 (alert_by_email)，不生成电子邮件 (no_email_alert)，或者不生成任何内容 (no_log) 的附加规
选项 no_email_alert
则选项。
no_log
复合规则
原子规则检查单个日志条目。要关联多个条目，必须使用复合规则。复合规则应将当前日志与已接收的日志相匹配。复合规则需要两个其
他选项：ffrreeqquueennccyy 选项指定事件/特征码必须出现多少次后规则才会生成警报，ttiimmeeffrraammee 选项告知日志审查引擎查看之前日志应追溯到
的时间范围（以秒为单位）。所有复合规则都具有以下结构：
例如，您可以创建一条符合规则，该规则可在 10 分钟内输入密码 5 次均不成功后生成较高严重性级别的警报。使用
>> 标记，可以指示在所需频率和时间范围内需要出现哪条规则，新规则才会创建警报。在以下示例
中，ffrreeqquueennccyy 属性设置为当发现 5 个事件实例时触发，ttiimmeeffrraammee 属性设置为将时间范围指定为 600 秒。
>> 标记用于定义复合规则将监视的其他规则：
100124
5 Failed passwords within 10 minutes
存在多个可用于创建更详细的复合规则的其他标记。通过这些规则（如下表所示），您可以指定事件的某些部分必须相同。这样您可以优
化复合规则并减少误报：
112
亚信安全服务器深度安全防护系统 9.6 管理员指南 创建日志审查规则
标标记记 描描述述
same_source_ip 指定源 IP 地址必须相同。
same_dest_ip 指定目标 IP 地址必须相同。
same_dst_port 指定目标端口必须相同。
same_location 指定位置（主机名或客户端名称）必须相同。
same_user 指定已解码的用户名必须相同。
same_id 指定已解码的 ID 必须相同。
如果想要复合规则在每次认证不成功时都发出警报，您可以将 >> 标记替换为 >> 标记，而不是特定的规则 ID。这使您可以指定一个类别（如 aauutthheennttiiccaattiioonn__ ffaaiilluurree）来搜索整个基础
架构中的认证不成功。
authentication_failure
5 Failed passwords within 10 minutes
除了 >> 和 >> 标记之外，您还可以使用
>> 标记指定正则表达式，以便在接收到日志时搜索日志。
^Failed password
5 Failed passwords within 10 minutes
实际示例
亚信安全服务器深度安全防护系统包含许多常见和常用应用程序的缺省日志审查规则。通过安全更新，可定期添加新规则。尽管日志审查
规则支持的应用程序不断增多，您可能会发现还是需要为不受支持或定制的应用程序创建定制规则。
在本节中，我们将逐步完成 Microsoft Windows Server IIS .Net 平台上托管的定制 CMS（内容管理系统）的创建，并将 Microsoft SQL
数据库作为数据存储库。
第一步是确定以下应用程序日志记录属性：
1. 应用程序日志记录到什么位置？
2. 可使用哪个日志审查解码器来解码日志文件？
3. 日志文件消息的常规格式是怎样的？
对于我们的定制 CMS 示例，答案如下：
1. Windows 事件查看程序
2. Windows 事件日志 (eventlog)
3. 具有以下核心属性的 Windows 事件日志格式：
◦ 源：CMS
◦ 类别：无
◦ 事件：
第二步是按应用程序功能确定日志事件的类别，然后将这些类别组织成级联组层次结构以进行审查。并非所有受审查的组都需要生成事
件；可将匹配项用作条件语句。对于每个组，确定规则可将其用作匹配条件的日志格式属性。通过审查所有应用程序日志以了解其模式和
日志事件的自然分组，可反向执行此操作。
例如，CMS 应用程序支持将为其创建日志审查规则的以下功能特性：
• CMS 应用程序日志（源：CMS）
113
亚信安全服务器深度安全防护系统 9.6 管理员指南 创建日志审查规则
◦ 认证（事件：100 到 119）
▪ 用户登录成功（事件： 100)
▪ 用户登录不成功（事件： 101)
▪ 管理员登录成功（事件： 105)
▪ 管理员登录不成功（事件： 106)
◦ 常规错误（类型：错误）
▪ 数据库错误（事件：200 到 205）
▪ 运行时错误（事件： 206-249)
◦ 应用程序审计（类型：信息）
▪ 内容
▪ 已添加新内容（事件：450 到 459）
▪ 现有内容已修改（事件：460 到 469）
▪ 现有内容已删除（事件：470 到 479）
▪ 管理
▪ 用户
▪ 已创建新用户（事件：445 到 446）