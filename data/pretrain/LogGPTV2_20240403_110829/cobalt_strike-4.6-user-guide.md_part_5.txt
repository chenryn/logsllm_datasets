PressLaunchtostarttheattack.
Client-side Exploits
YoumayuseaMetasploitFrameworkexploittodeliveraCobaltStrikeBeacon.CobaltStrike’s
BeaconiscompatiblewiththeMetasploitFramework’sstagingprotocol.TodeliveraBeacon
withaMetasploitFrameworkexploit:
l Usewindows/meterpreter/reverse_http[s]asyourPAYLOADandsetLHOSTandLPORTto
pointtoyourCobaltStrikelistener.You’renotreallydeliveringMeterpreterhere,you’re
tellingtheMetasploitFrameworktogeneratetheHTTP[s]stagerthatdownloadsa
payloadfromthespecifiedLHOST/LPORT.
l SetDisablePayloadHandlertoTrue.ThiswilltelltheMetasploitFrameworktoavoid
standingupahandlerwithintheMetasploitFrameworktoserviceyourpayload
connection.
l SetPrependMigratetoTrue.ThisoptiontellstheMetasploitFrameworktoprepend
shellcodethatrunsthepayloadstagerinanotherprocess.ThishelpsyourBeaconsession
survivesiftheexploitedapplicationcrashesorifit’sclosedbyauser.
Here’sascreenshotofmsfconsoleusedtostandupaFlashExploittodeliverCobaltStrike’s
HTTPBeaconhostedat192.168.1.5onport80:
Figure27.UsingClient-sideAttacksfromMetasploit
UserGuide www.helpsystems.com page:58
InitialAccess/CloneaSite
Clone a Site
Beforesendinganexploittoatarget,ithelpstodressitup.CobaltStrike’swebsiteclonetool
canhelpwiththis.Thewebsiteclonetoolmakesalocalcopyofawebsitewithsomecodeadded
tofixlinksandimagessotheyworkasexpected.
Tocloneawebsite,gotoAttacks->WebDrive-by->CloneSite.
Figure28.WebsiteCloneTool
It’spossibletoembedanattackintoaclonedsite.WritetheURLofyourattackintheEmbed
fieldandCobaltStrikewilladdittotheclonedsitewithanIFRAME.Clickthe...buttontoselect
oneoftherunningclient-sideexploits.
Clonedwebsitescanalsocapturekeystrokes.ChecktheLogkeystrokesonclonedsitebox.This
willinsertaJavaScriptkeyloggerintotheclonedsite.
Toviewloggedkeystrokesorseevisitorstoyourclonedsite,gotoView->WebLog.
CheckEnableSSLtoservethiscontentoverSSL.Thisoptionisavailablewhenyouspecifya
validSSLcertificateinyourMalleableC2profile.MakesuretheHostfieldmatchestheCNfield
ofyourSSLcertificate.Thiswillavoidasituationwherethisfeaturefailsbecauseofamismatch
betweenthesefields.
Spear Phishing
Nowthatyouhaveanunderstandingofclient-sideattacks,let’stalkabouthowtogettheattack
totheuser.Themostcommonwayintoanorganization’snetworkisthroughspearphishing.
CobaltStrike'sspearphishingtoolallowsyoutosendpixelperfectspearphishingmessages
usinganarbitrarymessageasatemplate.
UserGuide www.helpsystems.com page:59
InitialAccess/SpearPhishing
Targets
Beforeyousendaphishingmessage,youshouldassemblealistoftargets.CobaltStrikeexpects
targetsinatextfile.Eachlineofthefilecontainsonetarget.Thetargetmaybeanemail
address.Youmayalsouseanemailaddress,atab,andaname.Ifprovided,anamehelpsCobalt
Strikecustomizeeachphish.
Templates
Next,youneedaphishingtemplate.Thenicethingabouttemplatesisthatyoumayreusethem
betweenengagements.CobaltStrikeusessavedemailmessagesasitstemplates.CobaltStrike
willstripattachments,dealwithencodingissues,andrewriteeachtemplateforeachphishing
attack.
Ifyou’dliketocreateacustomtemplate,composeamessageandsendittoyourself.Mostemail
clientshaveawaytogettheoriginalmessagesource.InGmail,clickthedownarrownextto
ReplyandselectShoworiginal.Savethismessagetoafileandthencongratulateyourself—
you’vemadeyourfirstCobaltStrikephishingtemplate.
YoumaywanttocustomizeyourtemplatewithCobaltStrike’stokens.CobaltStrikereplaces
thefollowingtokensinyourtemplates:
Token Description
%To% The email address of the person the message is sent to
%To_Name% The name of the person the message is sent to.
%URL% The contents of the Embed URL field in the spear phishing dialog.
Sending Messages
Nowthatyouhaveyourtargetsandatemplate,you’rereadytogophishing.Tostartthespear
phishingtool,gotoAttacks->SpearPhish.
UserGuide www.helpsystems.com page:60
InitialAccess/SpearPhishing
Figure29.SpearPhishingTool
Tosendaphishingmessage,youmustfirstimportyourlistofTargets.Youmayimportaflat
text-filecontainingoneemailaddressperline.Importafilecontainingoneemailaddressand
nameseparatedbyataborcommaforstrongermessagecustomization.Clickthefoldernextto
theTargetsfieldtoimportyourtargetsfile.
SetTemplatetoanemailmessagetemplate.ACobaltStrikemessagetemplateissimplyasaved
emailmessage.CobaltStrikewillstripunnecessaryheaders,removeattachments,rewriteURLs,
re-encodethemessage,andrewriteitforyou.ClickonthefoldernexttotheTemplatefieldto
chooseone.
YouhavetheoptiontoaddanAttachment.Thisisagreattimetouseoneofthesocial
engineeringpackagesdiscussedearlier.CobaltStrikewilladdyourattachmenttotheoutgoing
phishingmessage.
CobaltStrikedoesnotgiveyouameanstocomposeamessage.Useanemailclient,writea
message,andsendittoyourself.Mostwebmailclientsincludeameanstoseetheoriginal
messagesource.InGMail,clickthedownarrownexttoReplyandselectShoworiginal.
YoumayalsoaskCobaltStriketorewriteallURLsinthetemplatewithaURLofyourchoosing.
SetEmbedURLtohaveCobaltStrikerewriteeachURLinthemessagetemplatetopointtothe
embeddedURL.URLsaddedinthiswaywillcontainatokenthatallowsCobaltStriketotrace
anyvisitorbacktothisparticularspearphishingattack.CobaltStrike'sreportingandweblog
featurestakeadvantageofthistoken.Press...tochooseoneoftheCobaltStrikehostedsites
you'vestarted.
WhenyouembedaURL,CobaltStrikewillattach?id=%TOKEN%toit.Eachsentmessagewillget
itsowntoken.CobaltStrikeusesthistokentomapwebsitevisitorstosentemails.Ifyoucare
aboutreporting,besuretokeepthisvalueinplace.
UserGuide www.helpsystems.com page:61
PayloadArtifactsandAnti-virusEvasion/SpearPhishing
SetMailServertoanopenrelayorthemailexchangerecordforyourtarget.Ifnecessary,you
mayalsoauthenticatetoamailservertosendyourphishingmessages.
Press…nexttotheMailServerfieldtoconfigureadditionalserveroptions.Youmayspecifya
usernameandpasswordtoauthenticatewith.TheRandomDelayoptiontellsCobaltStriketo
randomlydelayeachmessagebyarandomtime,uptothenumberofsecondsyouspecify.Ifthis
optionisnotset,CobaltStrikewillnotdelayitsmessages.
Figure30.ConfigureMailServer
SetBounceTotoanemailaddresswherebouncedmessagesshouldgo.Thisvaluewillnotaffect
themessageyourtargetssee.PressPreviewtoseeanassembledmessagetooneofyour
recipients.Ifthepreviewlooksgood,pressSendtodeliveryourattack.
CobaltStrikesendsphishingmessagesthroughtheteamserver.
Payload Artifacts and Anti-virus
Evasion
Help/SystemsLLCregularlyfieldsquestionsaboutevasion.DoesCobaltStrikebypassanti-virus
products?Whichanti-virusproductsdoesitbypass?Howoftenisthischecked?
TheCobaltStrikedefaultartifactswilllikelybesnaggedbymostendpointsecuritysolutions.
AlthoughevasionisnotagoalofthedefaultCobaltStrikeproduct,CobaltStrikedoesoffer
someflexibility.
You,theoperator,maychangetheexecutables,DLLs,applets,andscripttemplatesCobaltStrike
usesinitsworkflows.YoumayalsoexportCobaltStrike’sBeaconpayloadinavarietyofformats
thatworkwiththird-partytoolsdesignedtoassistwithevasion.
ThischapterhighlightstheCobaltStrikefeaturesthatprovidethisflexibility.
UserGuide www.helpsystems.com page:62
PayloadArtifactsandAnti-virusEvasion/TheArtifactKit
The Artifact Kit
CobaltStrikeusestheArtifactKittogenerateitsexecutablesandDLLs.TheArtifactKitisa
sourcecodeframeworktobuildexecutablesandDLLsthatevadesomeanti-virusproducts.
The Theory of the Artifact Kit
Traditionalanti-virusproductsusesignaturestoidentifyknownbad.Ifweembedourknown
badshellcodeintoanexecutable,ananti-virusproductwillrecognizetheshellcodeandflagthe
executableasmalicious.
Todefeatthisdetection,it’scommonforanattackertoobfuscatetheshellcodeinsomewayand
placeitinthebinary.Thisobfuscationprocessdefeatsanti-virusproductsthatuseasimple
stringsearchtoidentifymaliciouscode.
Manyanti-virusproductsgoastepfurther.Theseanti-virusproductssimulateexecutionofan
executableinavirtualsandbox.Witheachemulatedstepofexecution,theanti-virusproduct
checksforknownbadintheemulatedprocessspace.Ifknownbadshowsup,theanti-virus
productflagstheexecutableorDLLasmalicious.Thistechniquedefeatsmanyencodersand
packersthattrytohideknownbadfromsignature-basedanti-virusproducts.
CobaltStrike’scountertothisissimple.Theanti-virussandboxhaslimitations.Itisnota
completevirtualmachine.Therearesystembehaviorstheanti-virussandboxdoesnotemulate.
TheArtifactKitisacollectionofexecutableandDLLtemplatesthatrelyonsomebehaviorthat
anti-virusproduct’sdonotemulatetorecovershellcodelocatedinsideofthebinary.
Oneofthetechniques[see:src-common/bypass-pipe.cintheArtifactKit]generatesexecutables
andDLLsthatserveshellcodetothemselvesoveranamedpipe.Ifananti-virussandboxdoes
notemulatenamedpipes,itwillnotfindtheknownbadshellcode.
Where Artifact Kit Fails
Ofcourseit’spossibleforanti-virusproductstodefeatspecificimplementationsoftheArtifact
Kit.Ifananti-virusvendorwritessignaturesfortheArtifactKittechniqueyouuse,thenthe
executablesandDLLsitcreateswillgetcaught.Thisstartedtohappen,overtime,withthe
defaultbypasstechniqueinCobaltStrike2.5andbelow.Ifyouwanttogetthemostfromthe
ArtifactKit,youwilluseoneofitstechniquesasabasetobuildyourownArtifactKit
implementation.
Eventhatisn’tenoughthough.Someanti-virusproductscallhometotheanti-virusvendor’s
servers.TherethevendormakesadeterminationiftheexecutableorDLLisknowngoodoran
unknown,neverbeforeseen,executableorDLL.Someoftheseproductsautomaticallysend
unknownexecutablesandDLLstothevendorforfurtheranalysisandwarntheusers.Others
treatunknownexecutablesandDLLsasmalicious.Itdependsontheproductanditssettings.
Thepoint:noamountof“obfuscation”isgoingtohelpyouinthissituation.You’reupagainsta
differentkindofdefenseandwillneedtoworkarounditaccordingly.Treatthesesituationsthe
samewayyouwouldtreatapplicationwhitelisting.Trytofindaknowngoodprogram(e.g.,
powershell)thatwillgetyourpayloadstagerintomemory.
UserGuide www.helpsystems.com page:63
PayloadArtifactsandAnti-virusEvasion/TheVeilEvasionFramework
How to use the Artifact Kit
GotoHelp->ArsenalfromalicensedCobaltStriketodownloadtheArtifactKit.Youcanalso
accesstheArsenaldirectlyat:https://www.cobaltstrike.com/scripts
HelpSystemsdistributestheArtifactKitasa.tgzfile.Usethetarcommandtoextractit.The
ArtifactKitincludesabuild.shscript.RunthisscriptonKaliLinux,withnoarguments,tobuild
thedefaultArtifactKittechniqueswiththeMinimalGNUforWindowsCrossCompiler.
Figure31.TheArtifactKitBuildProcess
TheArtifactKitbuildscriptcreatesafolderwithtemplateartifactsforeachArtifactKit
technique.TouseatechniquewithCobaltStrike,gotoCobaltStrike->ScriptManager,and
loadtheartifact.cnascriptfromthattechnique’sfolder.
You’reencouragedtomodifytheArtifactKitanditstechniquestomakeitmeetyourneeds.
WhileskilledCprogrammerscandomorewiththeArtifactKit,it’squitefeasibleforan
adventurousnon-programmertoworkwiththeArtifactKittoo.Forexample,amajoranti-virus
productlikestowritesignaturesfortheexecutablesinCobaltStrike’strialeachtimethereisa
release.UpuntilCobaltStrike2.5,thetrialandlicensedversionsofCobaltStrikeusedthe
namedpipetechniqueinitsexecutablesandDLLs.Thisvendorwouldwriteasignatureforthe
namedpipestringtheexecutableused.Defeatingtheirsignatures,releaseafterrelease,wasas
simpleaschangingthenameofthepipeinthepipetechnique’ssourcecode.
The Veil Evasion Framework
Veilisapopularframeworktogenerateexecutablesthatgetpastsomeanti-virusproducts.You
mayuseVeiltogenerateexecutablesforCobaltStrike’spayloads.
Steps
1. GotoAttacks->Packages->PayloadGenerator.
2. Choosethelisteneryouwanttogenerateanexecutablefor.
3. SelectVeilastheOutputtype.
4. PressGenerateandsavethefile.
5. LaunchtheVeilEvasionFrameworkandchoosethetechniqueyouwanttouse.
6. Veilwilleventuallyaskaboutshellcode.SelectVeil’soptiontosupplycustomshellcode.
7. PasteinthecontentsofthefileCobaltStrike’spayloadgeneratormade.
8. PressenterandyouwillhaveafreshVeil-madeexecutable.
UserGuide www.helpsystems.com page:64
PayloadArtifactsandAnti-virusEvasion/JavaAppletAttacks
Figure32.UsingVeiltoGenerateanExecutable
Java Applet Attacks
HelpSystemsdistributesthesourcecodetoCobaltStrike’sAppletAttacksastheAppletKit.This
isalsoavailablewithintheCobaltStrikearsenal.GotoHelp->Arsenalanddownloadthe
AppletKit.
Usetheincludedbuild.shscripttobuildtheAppletKitonKaliLinux.ManyCobaltStrike
customersusethisflexibilitytosignCobaltStrike’sJavaAppletattackswithacode-signing
certificatethattheypurchased.Thisishighlyrecommended.
TomakeCobaltStrikeuseyourAppletKitoverthebuilt-inone,loadtheapplet.cnascript
includedwiththeAppletKit.
OntheCobaltStrikeArsenalPageyouwillalsonoticethePowerApplet.Thisisanalternate
implementationofCobaltStrike’sJavaAppletattacksthatusesPowerShelltogetapayloadinto
memory.ThePowerAppletdemonstratestheflexibilityyouhavetorecreateCobaltStrike’s
standardattacksinacompletelydifferentwayandstillusethemwithCobaltStrike’sworkflows.
TomakeCobaltStrikeuseyourAppletKitoverthebuilt-inone,loadtheapplet.cnascript
includedwiththeAppletKit.
The Resource Kit
TheResourceKitisCobaltStrike’smeanstochangetheHTA,PowerShell,Python,VBA,and
VBSscripttemplatesCobaltStrikeusesinitsworkflows.Again,theResourceKitisavailableto
licensedusersintheCobaltStrikearsenal.GotoHelp->ArsenaltodownloadtheResourceKit.
TheREADME.txtsuppliedwiththeResourceKitdocumentstheincludedscriptsandwhich
featuresusethem.Toevadeaproduct,considerchangingstringsorbehaviorsinthesescripts.
TomakeCobaltStrikeuseyourscripttemplatesoverthebuilt-inscripttemplates,loadthe
resources.cnascriptincludedwiththeResourceKit.
UserGuide www.helpsystems.com page:65
PostExploitation/TheSleepMaskKit
The Sleep Mask Kit
TheSleepMaskKitisthesourcecodeforthesleepmaskfunctionthatisexecutedtoobfuscate
Beacon,inmemory,priortosleeping.Thisobfuscationtechniquemaybeusedtoidentify
Beacon.Todefeatthisdetection,CobaltStrikeprovidsanaggressorscriptthatallowstheuser
tomodifyhowthesleepmaskfunctionlooksinmemory.Withthe4.5releasealistofheap
recordstomaskandunmaskisincluded.GotoHelp->ArsenaltodownloadtheSleepMaskKit.
Yourlicensekeyisrequired.
Usetheincludedbuild.shorbuild.batscripttobuildtheSleepMaskKitonKaliLinuxor
MicrosoftWindows.ThescriptbuildsthesleepmaskobjectfileforthethreetypesofBeacons
(default,SMB,andTCP)onbothx86andx64architecturesinthesleepmaskdirectory.The
defaulttypesupportsHTTP,HTTPS,andDNSBeacons.YoumaymodifytheSleepMaskKitto
meetyourneeds.
TomakeCobaltStrikeuseyoursleepmaskfunctionoverthedefault,loadthesleepmask.cna
scriptfromthesleepmaskdirectory.
Thefollowingarelimitationstowhatmaybemodified:
l Theexecutablecodesizecannotexceed769bytes.Ifthisoccursthedefaultsleepmask
functionwillbeused.
l Onlyonefunctioncanbedefinedinthesourcecodefile.
l Useofexternalfunctionsarenotsupported.
Post Exploitation
Beacon Covert C2 Payload
BeaconisCobaltStrikespayloadtomodeladvancedattackers.UseBeacontoegressanetwork
overHTTP,HTTPS,orDNS.Youmayalsolimitwhichhostsegressanetworkbycontrolling
peer-to-peerBeaconsoverWindowsnamedpipes.
Beaconisflexibleandsupportsasynchronousandinteractivecommunication.Asynchronous
communicationislowandslow.Beaconwillphonehome,downloaditstasks,andgotosleep.
Interactivecommunicationhappensinreal-time.
Beacon'snetworkindicatorsaremalleable.RedefineBeacon'scommunicationwithCobalt
Strike'smalleableC2language.ThisallowsyoutocloakBeaconactivitytolooklikeother
malwareorblend-inaslegitimatetraffic.
The Beacon Console
Right-clickonaBeaconsessionandselectinteracttoopenthatBeacon’sconsole.Theconsoleis
themainuserinterfaceforyourBeaconsession.TheBeaconconsoleallowsyoutoseewhich
taskswereissuedtoaBeaconandtoseewhenitdownloadsthem.TheBeaconconsoleisalso
wherecommandoutputandotherinformationwillappear.
UserGuide www.helpsystems.com page:66
PostExploitation/TheBeaconMenu
Figure33.CobaltStrikeBeaconConsole
InbetweentheBeaconconsole’sinputandoutputisastatusbar.Thisstatusbarcontains
informationaboutthecurrentsession.Initsdefaultconfiguration,thestatusbarshowsthe
target’sNetBIOSname,theusernameandPIDofthecurrentsession,andtheBeacon’slast
check-intime.
Eachcommandthat’sissuedtoaBeacon,whetherthroughtheGUIortheconsole,willshowup
inthiswindow.Ifateammateissuesacommand,CobaltStrikewillpre-fixthecommandwith
theirhandle.
YouwilllikelyspendmostofyourtimewithCobaltStrikeintheBeaconconsole.It’sworthyour
timetobecomefamiliarwithitscommands.TypehelpintheBeaconconsoletoseeavailable
commands.Typehelpfollowedbyacommandnametogetdetailedhelp.
The Beacon Menu
Right-clickonaBeaconorinsideofaBeacon’sconsoletoaccesstheBeaconmenu.Thisisthe
samemenuusedtoopentheBeaconconsole.Thefollowingitemsareavailable:
TheAccessmenucontainsoptionstomanipulatetrustmaterialandelevateyouraccess.
TheExploremenuconsistsofoptionstoextractinformationandinteractwiththetarget’s
system.
ThePivotingmenuiswhereyoucansetuptoolstotunneltrafficthroughaBeacon.
TheSessionmenuiswhereyoumanagethecurrentBeaconsession.
UserGuide www.helpsystems.com page:67
PostExploitation/AsynchronousandInteractiveOperations
Figure34.CobaltStrikeBeaconMenu
SomeofCobaltStrike’svisualizations(thepivotgraphandsessionstable)letyouselectmultiple
Beaconsatonetime.Mostactionsthathappenthroughthismenuwillapplytoallselected
Beaconsessions.
Asynchronous and Interactive Operations
BeawarethatBeaconisanasynchronouspayload.Commandsdonotexecuterightaway.Each
commandgoesintoaqueue.WhentheBeaconchecksin(connectstoyou),itwilldownload
thesecommandsandexecutethemonebyone.Atthistime,Beaconwillalsoreportanyoutput
ithasforyou.Ifyoumakeamistake,usetheclearcommandtoclearthecommandqueuefor
thecurrentBeacon.
Bydefault,Beaconscheckineverysixtyseconds.YoumaychangethiswithBeacon’ssleep
command.UsesleepfollowedbyatimeinsecondstospecifyhowoftenBeaconshouldcheckin.
Youmayalsospecifyasecondnumberbetween0and99.Thisnumberisajitterfactor.Beacon
willvaryeachofitscheckintimesbytherandompercentageyouspecifyasajitterfactor.For
example,sleep30020,willforceBeacontosleepfor300secondswitha20%jitterpercentage.
Thismeans,Beaconwillsleepforarandomvaluebetween240sto300saftereachcheck-in.
TomakeaBeaconcheckinmultipletimeseachsecond,trysleep0.Thisisinteractivemode.In
thismodecommandswillexecuterightaway.YoumustmakeyourBeaconinteractivebefore
youtunneltrafficthroughit.AfewBeaconcommands(e.g.,browserpivot,desktop,etc.)will
automaticallyputBeaconintointeractivemodeatthenextcheckin.
Running Commands
Beacon’sshellcommandwilltaskaBeacontoexecuteacommandviacmd.exeonthe
compromisedhost.Whenthecommandcompletes,Beaconwillpresenttheoutputtoyou.
Usetheruncommandtoexecuteacommandwithoutcmd.exe.Theruncommandwillpost
outputtoyou.Theexecutecommandrunsaprograminthebackgroundanddoesnotcapture
output.
UserGuide www.helpsystems.com page:68
PostExploitation/SessionPassing
UsethepowershellcommandtoexecuteacommandwithPowerShellonthecompromisedhost.
UsethepowerpickcommandtoexecutePowerShellcmdletswithoutpowershell.exe.This
commandreliesontheUnmanagedPowerShelltechniquedevelopedbyLeeChristensen.The
powershellandpowerpickcommandswilluseyourcurrenttoken.
ThepsinjectcommandwillinjectUnmanagedPowerShellintoaspecificprocessandrunyour
cmdletfromthatlocation.
Thepowershell-importcommandwillimportaPowerShellscriptintoBeacon.Futureusesofthe
powershell,powerpick,andpsinjectcommandswillhavecmdletsfromtheimportedscript
availabletothem.BeaconwillonlyholdonePowerShellscriptatatime.Importanemptyfileto
cleartheimportedscriptfromBeacon.
Theexecute-assemblycommandwillrunalocal.NETexecutableasaBeaconpost-exploitation
job.YoumaypassargumentstothisassemblyasifitwererunfromaWindowscommand-line
interface.Thiscommandwillalsoinherityourcurrenttoken.
IfyouwantBeacontoexecutecommandsfromaspecificdirectory,usethecdcommandinthe
BeaconconsoletoswitchtheworkingdirectoryoftheBeacon’sprocess.Thepwdcommandwill
tellyouwhichdirectoryyou’recurrentlyworkingfrom.
Thesetenvcommandwillsetanenvironmentvariable.
BeaconcanexecuteBeaconObjectFileswithoutcreatinganewprocess.BeaconObjectFiles
arecompiledCprograms,writtentoaspecificconvention,thatrunwithinaBeaconsession.Use
inline-execute[args]toexecuteaBeaconObjectFilewiththespecifiedarguments.SeeBeacon
ObjectFilesonpage124formoreinformation.
Session Passing
CobaltStrike’sBeaconstartedoutasastablelifelinetokeepaccesstoacompromisedhost.
Fromdayone,Beacon’sprimarypurposewastopassaccessestootherCobaltStrikelisteners.
Usethespawncommandtospawnasessionforalistener.Thespawncommandacceptsan
architecture(e.g.,x86,x64)andalistenerasitsarguments.
Bydefault,thespawncommandwillspawnasessioninrundll32.exe.Analertadministratormay
finditstrangethatrundll32.exeisperiodicallymakingconnectionstotheinternet.Findabetter
program(e.g.,InternetExplorer)andusethespawntocommandtostatewhichprogramBeacon
shouldspawnforitssessions.
Thespawntocommandrequiresyoutospecifyanarchitecture(x86orx64)andafullpathtoa
programtospawn,asneeded.TypespawntobyitselfandpressentertoinstructBeacontogo
backtoitsdefaultbehavior.
Typeinjectfollowedbyaprocessidandalistenernametoinjectasessionintoaspecific
process.Usepstogetalistofprocessesonthecurrentsystem.Useinject[pid]x64toinjecta
64-bitBeaconintoanx64process.
Thespawnandinjectcommandsbothinjectapayloadstageintomemory.Ifthepayloadstageis
anHTTP,HTTPS,orDNSBeaconanditcan’treachyou—youwillnotseeasession.Ifthe
payloadstageisabindTCPorSMBBeacon,thesecommandswillautomaticallytrytolinkto
andassumecontrolofthesepayloads.
UserGuide www.helpsystems.com page:69
PostExploitation/AlternateParentProcesses
Usedllinject[pid]toinjectaReflectiveDLLintoaprocess.
Usetheshinject[pid][architecture][/path/to/file.bin]commandtoinjectshellcode,fromalocal
file,intoaprocessontarget.Useshspawn[architecture][/path/to/file.bin]tospawnthe“spawn
to”processandinjectthespecifiedshellcodefileintothatprocess.
Usedllload[pid][c:\path\to\file.dll]toloadanon-diskDLLinanotherprocess.
Alternate Parent Processes
Useppid[pid]toassignanalternateparentprocessforprogramsrunbyyourBeaconsession.
Thisisameanstomakeyouractivityblendinwithnormalactionsonthetarget.Thecurrent
Beaconsessionmusthaverightstothealternateparentandit’sbestifthealternateparent
processexistsinthesamedesktopsessionasyourBeacon.Typeppid,withnoarguments,to
haveBeaconlaunchprocesseswithnospoofedparent.
Therunucommandwillexecuteacommandwithanotherprocessastheparent.Thiscommand
willrunwiththerightsanddesktopsessionofitsalternateparentprocess.ThecurrentBeacon
sessionmusthavefullrightstothealternateparent.Thespawnucommandwillspawna
temporaryprocess,asachildofaspecifiedprocess,andinjectaBeaconpayloadstageintoit.
Thespawntovaluecontrolswhichprogramisusedasatemporaryprocess.
Spoof Process Arguments
EachBeaconhasaninternallistofcommandsitshouldspoofargumentsfor.WhenBeaconruns
acommandthatmatchesalist,Beacon:
1. Startsthematchedprocessinasuspendedstate(withthefakearguments)
2. Updatestheprocessmemorywiththerealarguments
3. Resumestheprocess
Theeffectisthathostinstrumentationrecordingaprocesslaunchwillseethefakearguments.
Thishelpsmaskyourrealactivity.
Useargue[command][fakearguments]toaddacommandtothisinternallist.The[command]
portionmaycontainanenvironmentvariable.Useargue[command]toremoveacommandfrom
thisinternallist.argue,byitself,liststhecommandsinthisinternallist.
Theprocessmatchlogicisexact.IfBeacontriestolaunch“net.exe”,itwillnotmatchnet,
NET.EXE,orc:\windows\system32\net.exefromitsinternallist.Itwillonlymatchnet.exe.
x86Beaconcanonlyspoofargumentsinx86childprocesses.Likewise,x64Beaconcanonly