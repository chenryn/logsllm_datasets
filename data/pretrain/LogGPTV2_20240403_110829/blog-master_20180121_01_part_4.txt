A    
pgbouncer 连接池，暂时只支持单CPU    
pgbouncer 连接池，连接复用的前提是USER\DBNAME相同，无法跨user,dbname复用。    
pgbouncer 连接池，如果有会话级变量，无法在不同的连接池连接之间切换，例如绑定变量。    
https://github.com/postgrespro/postgresql.builtin_pool    
[《PostgresPro buildin pool(内置连接池)版本 原理与测试》](../201805/20180521_03.md)    
8、Q MySQL与PG的事务隔离级别区别    
A    
RU，脏读，MySQL支持，PG不支持。实际使用中脏读几乎不使用，未提交事务对数据库的修改为什么要被访问？    
RC，读已提交    
RR(金融行业通常会使用)，可重复度，MySQL使用悲观锁实现，并发性差。PG使用快照实现（乐观），高并发性能损耗极小。    
SI(金融行业通常会使用)，串行事务隔离级别，MySQL使用悲观锁实现，并发性差。PG使用快照实现（乐观），高并发性能损耗极小。    
SSI(金融行业通常会使用)，严格串行事务隔离级别，MySQL不支持，PG支持。    
9、Q PG临时文件如何清理，为什么会有大量临时文件    
A    
PG临时文件是自动清理的。例如会话退出，自动清理，事务结束自动清理等。看临时文件的属性。如果有某些原因导致了临时文件未及时清理，数据库在启动是会自动进行清理。    
为什么会有大量临时文件，例如跑了很复杂的SQL，包含大量数据JOIN，GROUP BY，聚合，排序，可能用到外部临时文件。又或者临时表。    
又或者递归查询（数据有问题，导致死循环），会产生临时文件。    
对于排序，可以加大WORK_MEM，使用quick sort，不使用临时文件。    
10、POLARDB为什么限制100TB， 16个计算节点。    
产品设置，权衡了市场需求，以及当前架构下，提供一个安全可靠的集群规模。    
![pic](20180121_01_pic_022.jpg)    
### 14 20190622期天天象上(武汉-阿里巴巴创新中心，Dream咖啡厅)    
报名人数：54    
重要议题1：《PostgreSQL 生态与社区工作汇报》    
重要议题2：《Oracle 迁移上云》    
重要议题3：《PostgreSQL 数据库优化实践》    
重要议题4：《阿里云POLARDB for PostgreSQL|Oracle 产品演进》    
重要议题5：《POLARDB 的DBA法宝 - AAS性能洞察》    
重要议题6：《云数据库时空引擎Ganos》    
重要议题7：企业数据库辩论赛。    
参会企业：斑马快跑(出行)、中移智行、武汉斗鱼、湖南图为、北京华宇信息、武汉商学院、浩星科技、唯晟商贸、爱可生、携宁计算机、海康威视、烽火通信、恒生、武汉数趣信息、武汉达梦、DXc、湖北楚天、武汉国为、太平金融、德安、传神语联网、linktime、湖北省图书馆、武汉易瑞特科技、易起飞科技、宁美国度、南京中软软件、企易共创、天玑科技、武汉通威、Farfetch、湖北电视台、今天梦想、湖北工业大学、天源迪科、。。。等。    
企业辩论赛回顾：    
PG plus 队与 PG pro 队进行了激烈的角逐。问题汇总如下：    
1、Q mysql 如何准实时同步到 PG    
A 使用阿里开源的Otter，解析BINLOG，使用PG语法封装SQL，在PG中回放。    
https://github.com/alibaba/otter    
https://github.com/alibaba/canal    
2、Q 用户智能电力业务，很多电力终端上报数据，数据库中按时间、电力设备等维度，范围搜索，一次查询出多条记录。效率不高    
用户使用cluster后，效率可以改善，有没有其他办法。    
A 本质的原因是用户查询的多条记录分布在HEAP表的不同PAGE里面，使得一次查询要扫描很多数据块。并发高，IO开销大，内存带宽高。    
include index，或使用 聚合存储    
[《PostgreSQL index include - 类聚簇表与应用(append only, IoT时空轨迹, 离散多行扫描与返回)》](../201905/20190503_03.md)      
[《PostgreSQL IoT，车联网 - 实时轨迹、行程实践 2 - (含index only scan类聚簇表效果)》](../201812/20181209_01.md)      
[《PostgreSQL IoT，车联网 - 实时轨迹、行程实践 1》](../201812/20181207_01.md)      
3、Q 企业中如何权衡开发者和DBA的权限和关系，遇到开发写得烂的SQL，领导叫DBA去又不愿意。如何权衡。    
A 明确DBA和开发者职责和KPI，有奖有罚    
定义操作规范、    
定义业务上线、下线标准    
定义商业化规范    
附能开发者，提高开发者能力    
DBA能力产品化    
建立SQL审核标准    
建立测试环境    
建立预发环境    
灰度上线    
建立线上真实数据测试环境（例如备库）    
4、Q PostgreSQL 相比其他开源数据库有什么优势    
A PG有GIN倒排索引，可以支持全文检索、模糊查询、相似搜索、JSON高速检索等    
PG的处理能力更强，支持并行计算，高并发。支持更丰富的JOIN、聚合算法。    
PG的扩展能力更强，支持专业的GIS、机器学习、全文检索、图像搜索等等。    
PG是纯社区的数据库，没有被商业公司控制。    
PG的开源许可更加的友好，使用无风险。有些公司的产品也开源，但是被商业公司控制，需要注意开源协议。使用需要注意法律风险。    
5、Q 被SQL注入了怎么办？    
A 尽快通知DBA，保留备份，防止扩大影响    
报警，通知领导    
下业务，防止扩大影响    
修BUG:     
应用开发使用绑定变量，不要用SIMPLE QUERY    
使用WAF，应用防火墙    
6、Q ORACLE 的ASM存储，在其他生态中有没有替代产品？    
ASM 支持块设备管理，任意损坏都不会影响可用性、可靠性。    
例如坏一块盘之后，数据会自动重分布，只是容量变少。    
1、块设备shard(extent)化    
2、每个shard(extent)在多个BLOCK设备之间冗余，例如3副本。    
3、坏盘后，自动重分布shard(extent)，依旧有3副本    
4、对于整个ASM存储集群来说，只是容量变小，但是冗余度不变。    
5、加盘后，自动重分布，容量又回来了。    
达到的效果：不管怎么坏盘，保持 rto=0, rpo=0     
A 分布式存储    
POLARDB    
polarstore    
阿里云盘古    
7、Q PG对文本挖掘有没有好的支持？    
A 分词、情感词、归类，PLPYTHON，MADLib     
8、Q 为什么有的书籍不建议使用PG自定义函数、存储过程，建议直接写SQL，不建议用存储过程？    
A 首先要分清楚应用场景，千万不要断章取义。    
存储过程支持自动的绑定变量，所以存储过程内的SQL执行5次后会自动缓存通用执行计划。    
如果是高并发查询，建议用绑定变量。减少硬解析的开销。    
如果是低并发（AP）应用，建议用SIMPLE QUERY。    
[《执行计划选择算法 与 绑定变量 - PostgreSQL prepared statement: SPI_prepare, prepare|execute COMMAND, PL/pgsql STYLE: custom & generic plan cache》](../201212/20121224_01.md)      
存储过程里面也支持动态SQL，使用动态SQL时强制用硬解析    
或者使用plan_cache_mode参数    
[《PostgreSQL 12 preview - plan_cache_mode GUC，用户可设置plan cache模式. (每次生成plan OR 使用重复plan OR 自动选择plan cache mode)》](../201903/20190331_15.md)      
9、Q 对于数据库使用过程中，如果出现BLOCK损坏怎么办？    
A     
1、跳过损耗数据块，可以继续查询    
2、通过备份修复。    
没有备份的话，在REDO中找到这个数据块最近一个FULL PAGE，从FULL PAGE拷贝，加上之后这个PAGE的所有REDO进行恢复。    
[《PostgreSQL 恢复大法 - 恢复部分数据库、跳过坏块、修复无法启动的数据库》](../201803/20180329_02.md)      
[《[转] PostgreSQL 轻量级周边工具 pg_lightool》](../201902/20190211_02.md)      
[《[转] PG wal/xlog/redo日志解析工具功能增强并更名为WalMiner / logminer / xlogminer》](../201902/20190211_01.md)      
10、Q 数据库使用过程中，经常发现“表没了”，在pgadmin查询表没了。但是在应用程序中能INSERT进去，应用是 ```insert into table values ()```    
A     
1、如果真的被删了，开启SQL审计，检查是谁干的.    
2、search_path 可能不对。在pgadmin中查看的SCHEMA下没有这个表，可能在其他SCHEMA里面。    
可以在pg_class或pg_tables里面找一下，是不是在其他SCHEMA里面    
11、Q 深圳中电的业务，很多智能电表上传数据，由于数据量太大，使用了按天分区，但是表分区太多了，查询慢。    
A PG 12原生分区表，性能已经基本无损。    
老版本使用pg_pathman，性能也基本无损。    
[《如何修改PostgreSQL分区表分区范围 - detach attach - 拆分、合并、非平衡分区表、深度不一致分区表》](../201906/20190621_02.md)      
[《PostgreSQL 12 preview - 分区表性能提升百倍》](../201905/20190521_01.md)      
[《分区表锁粒度差异 - pg_pathman VS native partition table》](../201802/20180206_01.md)      
[《PostgreSQL 商用版本EPAS(阿里云ppas(Oracle 兼容版)) - 分区表性能优化 (堪比pg_pathman)》](../201801/20180122_03.md)      
最后 PG plus 队胜出。      
![pic](20180121_01_pic_023.jpg)    
### 15 20190713期天天象上(济南-齐鲁软件园)    
报名人数：188    
重要议题1：《PostgreSQL 生态与社区工作汇报》    