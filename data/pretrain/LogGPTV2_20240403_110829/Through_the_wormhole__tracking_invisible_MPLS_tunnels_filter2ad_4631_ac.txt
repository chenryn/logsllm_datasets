explicit-null triggers the use of explicit null labels). The (for-
ward) TTL propagation is also disabled. A trace towards CE2 does
not reveal PE2 (CE2 seems directly connected to PE1), as shown on
Fig. 4d. Assuming that an address of PE2 has been discovered by
another mean and can be used as a new target, none of the tech-
niques given in this paper reveal anything.
For FRPLA and RTLA, we analyzed the TTL of the ICMP time-
exceeded messages received when tracing. For example, while PE2
appears to be at six hops (see Fig. 2 and Fig. 4c) or three hops
(see Fig. 4d), the return TTL (provided between brackets on Fig. 4)
always indicates six hops (when tracing towards CE2), except in
the UHP case, providing so the shift and the gap that might be
exploited by FRPLA and RTLA.
To further validate our measurement techniques, we also per-
formed a cross-validation of hidden hops revelation techniques
(i.e., DPR and BRPR) on explicit tunnels. To do so, we collected
data from PlanetLab. We considered 23 PlanetLab vantage points
spread into ﬁve teams. Each team is responsible to probe towards
10,000 destinations (no overlapping between the teams) obtained
from the Archipelago dataset [15]. This leads to a total of 269,096
traces collected. We extracted 14,771 distinct Ingress-Egress LERs
pairs, with LSRs being explicitly revealed between the LERs. Note
that both LERs should be in the same AS and the content of the
LSR be fully revealed (i.e., no anonymous hops).
On those pairs, we rerun DPR and BRPR. On the one hand, DPR
is considered as successful if, when targeting the Egress LER, we
obtain the exact same number of hops between the Ingress and
Through the Wormhole: Tracking Invisible MPLS Tunnels
IMC ’17, November 1–3, 2017, London, United Kingdom
$ p t CE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 PE2 . l e f t
4 CE2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 0 ]
[ 2 5 0 ]
$ p t PE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 P3 . l e f t
4 PE2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 1 ]
[ 2 5 0 ]
$ p t P3 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 P2 . l e f t
4 P3 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 2 ]
[ 2 5 1 ]
$ p t P2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 P1 . l e f t
4 P2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 3 ]
[ 2 5 2 ]
$ p t P1 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 P1 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 3 ]
$ p t CE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 PE2 . l e f t
4 CE2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 0 ]
[ 2 5 0 ]
$ p t PE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 P1 . l e f t
4 P2 . l e f t
5 P3 . l e f t
6 PE2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 3 ]
[ 2 5 2 ]
[ 2 5 1 ]
[ 2 5 0 ]
$ p t CE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 P1 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 4 7 ]
MPLS L a b e l 19 TTL=1
4 P2 . l e f t
! T2 [ 2 4 8 ]
MPLS L a b e l 20 TTL=1
5 P3 . l e f t
[ 2 5 1 ]
MPLS L a b e l 21 TTL=1
6 PE2 . l e f t
7 CE2 . l e f t
[ 2 5 0 ]
[ 2 4 9 ]
$ p t CE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 CE2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 2 ]
$ p t PE2 . l e f t
1 CE1 . l e f t
2 PE1 . l e f t
3 PE2 . l e f t
[ 2 5 5 ]
[ 2 5 4 ]
[ 2 5 3 ]
(a) Default Conﬁguration:
explicit tunnel.
(b) Last Hops without labels discovered
with a recursive process (BRPR).
(c) Route without labels
in a single probe (DPR).
(d) Invisible UHP tunnel.
Figure 4: Emulation results for each basic conﬁguration (pt stands for the paris-traceroute command [5]). The TTL of each
ICMP time-exceeded reply received at the vantage point on the return path is provided between brackets for each hop. This is
the return IP-TTL used for FRPLA and RTLA analyses (the latter using two distinct return IP-TTL).
Egress LER11 and all MPLS labels have disappeared from the traceroute
output. On the other hand, BRPR is considered as successful if, at
each step of the recursion, the last hop does not exhibit any label.
On the 14,771 distinct Ingress-Egress LERs, we obtained 9,407
pairs for which the re-run failed, either because the Ingress or
the Egress was not re-discovered. Table 3 summarizes the cross-
validation on the 5,364 remaining pairs.
We see that in 8% of the cases, DPR or BRPR fail. However, in
60% of the cases, we have got a success with DPR and BRPR. Note
that, in a few particular cases (5%), tunnels were revealed partially
by DPR and partially by BRPR. Finally, in 26% of the cases, we suc-
cessfully retrieve the tunnel but we cannot discriminate between
DPR and BRPR as the LSP counts only one LSR.12
Finally, Table 3 shows a very low success rate for BRPR (3%).
This suggests that, given the large proportion of Cisco routers de-
ployed by operators, Cisco devices are conﬁgured to inject loop-
back addresses into LDP instead of all preﬁxes. This is particu-
larly true when the operator deploys hybrid hardware (Juniper
and Cisco – this hybrid situation is conﬁrmed by our survey, see
Sec. 2.3). In that case, Juniper devices systematically ﬁlters any
piece of information not associated to loopback addresses. Table
5 also experimentally conﬁrms this interesting result.
3.4 Discussion
Our techniques cover all basic MPLS conﬁgurations, except the
totally invisible one with UHP enabled (not the standard conﬁgura-
tion as it is useless for basic LDP tunneling – our survey highlights
the fact that only 10% of the operators deploy UHP). The main con-
ﬁguration of Cisco (PHP and all preﬁxes enabled) is seen with FR-
PLA and BRPR. The basic Juniper conﬁguration is seen with DPR
and also causes a shift visible with FRPLA. The mix with Juniper
LER and Cisco LSR is speciﬁcally covered with RTLA. It is likely
that all other mixes with PHP as the default mode also triggers
11In practice, most of the time, both paths (i.e., the explicit tunnel and the one revealed
by DPR), are exactly the same. However, in some cases, load balancing with ECMP
may exhibit a similar path but with distinct IP addresses.
12This last statement is aligned with the very short tunnel length distribution [19, 36].
one signal, i.e., with Cisco LER, at least FRPLA should work (and
so BRPR) and with Juniper LER, RTLA and DPR (and/or BRPR)
should work. BRPR and DPR can be combined in several ways for
tracking more advanced conﬁgurations with LDP ﬁlters or hetero-
geneous OS, as when some internal preﬁxes are not announced in
LDP.
On the contrary to other techniques, FRPLA should not be used
in the wild at the tunnel scale, otherwise it faces the risk of produc-
ing false positives (i.e., a tunnel length of X hops is inferred because
the return path has X more hops than the forward one due to rout-
ing asymmetry) and false negatives (i.e., the return pat is shorter of
X hops compared to the forward one due to routing asymmetry).
Instead, FRPLA should be used, using multiple independent van-
tage points, as a statistical method in order to correctly infer the
existence, and possibly the average length, of invisible tunnels at
the AS scale. Indeed, if the traceroute campaign produces traces
entering through a suﬃcient number of Ingress LER in the target
AS, it is very likely the routing asymmetry will follow a normal
law centered on 0 (as already conﬁrmed by our experimental re-
sults, see Fig. 7 in particular). In other words, FRPLA actually mea-
sures the sum of the length of the return tunnel and the IP routing
asymmetry of the trace. This asymmetry being the length diﬀer-
ence between forward and return paths (a positive or a negative
shift).
Generally speaking, if MPLS is enabled in a given network with
PHP (it is by default for basic LDP tunneling, whatever the conﬁg-
urations and the OSes), we should see it with at least one of our
techniques. On the contrary, UHP, mainly designed for traﬃc en-
gineering oriented tunnels, turns RSVP-TE tunnels really invisible.
Since network operators have no reasons to deploy RSVP-TE with-
out also enabling LDP, we argue our set of techniques provides at
least one MPLS signal in the vast majority of cases, provided some
transit traces traversing LDP signaled LSPs.
IMC ’17, November 1–3, 2017, London, United Kingdom
Y. Vanaubel et al.
4 DATA COLLECTION
Prior to deploying in the wild our measurement techniques, we
looked for HDNs in the Caida ITDK dataset [10] (it provides router
level topologies). We ﬁrst cleaned up the dataset by removing non
publicly-routable IP addresses and pseudo-addresses allocated to
non-responsive routers. After this pruning, 45,021,817 IP addresses,
44,700,863 nodes, 2,705,780 links, and 43,178 ASes remained.
We set the threshold for diﬀerentiating low degree nodes from
high degree nodes (HDNs) to 128 (i.e., any node with a degree
greater or equal to 128 is tagged as an HDN) and select areas of
interest on where to send our probes. The 128 degree HDN thresh-
old is selected to be a lower bound relative to well-known physical
hardware, in particular PE routers which we expect to terminate
invisible tunnels. For instance, the ASR9000 series is one of the best
selling Cisco PE routers. This router can be equipped with up to
20 linecards, each containing up to 16 interfaces. Thus, a thresh-
old of 128 is a reasonable balance between the volume of probes
sent (we do not want to burden the network) and the amount of
interesting data collected. Obviously, invisible tunnels do not only
occur between HDNs, but we expect that many HDN pairs hide
invisible tunnels (proportionally much more than non HDN pairs).
Considering a threshold of 128 let us with 17,944 HDNs.
To eﬃciently guide our measurements, we retrieved, from the
Caida ITDK dataset [10], the neighbors of the HDNs (set A – 599,467
unique nodes) and, next, the neighbors of neighbors of HDNs (set
B – 983,793 unique nodes). This latter set is able to provide us IP
addresses that do not belong to the same AS as addresses in the
former set (our basic hypothesis is that MPLS LERs also deﬁne
borders of domains13). Our aim is to simulate transit traﬃc, i.e.,
entirely traversing the suspicious AS made of many HDNs and
ending up to one of its neighbors. Since we are looking for targets
around HDNs in general, the destination set of our measurement
campaign is the union of both sets (set A  B). We obtained a total
of 1,306,545 destination IP addresses.
Our measurement scripts used scamper [29], and its Paris trace-
route [5] implementation with ICMP echo-request packets, start-
ing at TTL equals 2. In addition, echo-request probes are also sent
to all IP addresses appearing in the traces for router signature in-
ference [40]. For each of these traces, we look at the last three hops,
say X, Y, D (where D ∈ A  B). X and Y are candidate endpoints of an
invisible tunnel. A second trace with Y as target is then launched.
If this trace ends with X, H, Y, we infer that one hop, H, has been
revealed from an invisible tunnel. A new trace is then launched to-
wards H (recursive processing with BRPR) as an attempt to reveal
more hops. If a new hop, say H’, is discovered in the trace towards
H (this trace should end with X, H’, H), the recursion continues with
H’ as the target and so on. This recursive process stops either if no
new address is revealed (so we cannot distinguish DPR from BRPR
if the recursion stops at the second trace – the revealed tunnel has
only one hop), or if the new trace does not go through X . Note
that multiple IP addresses may have been revealed in a single shot,
i.e., the trace towards Y ends with X, H1, H2, . . . , Hn−1, Hn , Y, with
n > 1 being the number of hops discovered with DPR.
13This has been veriﬁed with the bdrmap [30] dataset, but partially (as both measure-
ment campaigns are strongly diﬀerent, intersection between datasets is sometimes
weak).
Since we are looking for invisible MPLS tunnels spanning a sin-
gle AS, and with HDNs as a trigger, our post-processing methods
select only traces ending by I, E, D where I and E are HDNs lo-
cated in the same AS. For AS resolution, we referred to Caida node-
to-AS mapping when available, otherwise IP-to-AS mapping from
Team Cymru.14 Our ﬁndings for these I, E couples are discussed
in the next section.
Our tool was deployed on the PlanetLab testbed on 91 Vantage
Points (VP) distributed all around the world (USA, Canada, Eu-
rope, Japan, Russia, Brazil, China, Australia, New Zealand). The
VPs were distributed equally in ﬁve groups, paying attention to the
geographical locations. The destination set (A  B) was distributed
amongst the diﬀerent groups of VPs as follows: (i) the HDN neigh-
bors (set A) were randomly spread over ﬁve subsets, (ii) the neigh-
bors of each neighbors (set B) were added in the corresponding
VPs subsets. It is worth noticing that the diﬀerent destinations sub-
sets were thus consistent, i.e., if neighbor N is in VP set 1, then all
neighbors of N are also in VP set 1. The sizes of the destination
subsets are similar amongst the VP sets: 579,012 (VP set 1), 583,173
(VP set 2), 586,363 (VP set 3), 588,771 (VP set 4), and 586,229 (VP
set 5). All measurements on each VP set were launched simultane-
ously on November 18th, 2016 with scamper probing at a rate of
25 packets/second. The fastest VP set ﬁnished the measurements
on November 29th, 2016, while the slowest ﬁnished on December
6th, 2016.
5 MEASUREMENT RESULTS
This section provides three kinds of analysis to demonstrate the
eﬃciency of our contributions. First, we start by studying and com-
paring the eﬃciency of our two most powerful techniques, DPR
and BRPR, for revealing IP internal hops (Sec. 5.1). Second, we ana-
lyze the Return & Forward Asymmetry (i.e., the diﬀerence between
the return and forward path in term of number of hops), with FR-
PLA in particular, and we cross-validate it when it intersects with
DPR and BRPR (Sec. 5.2). Finally, we study the distribution of re-
turn tunnel length with RTLA, its incidence on path asymmetry,
and, again, we cross-validate it using DPR and BRPR with a return
and forward path asymmetry perspective (Sec. 5.3). We demon-
strate thus that most of the invisible tunnels can be identiﬁed in
some way, either explicitly (DPR or BRPR) or implicitly (FRPLA or
RTLA)
Table 4 provides many pieces of information for ASes present-
ing the largest number of HDNs for which we were able to reveal
the content of invisible tunnels (with the exception of AS2856). The
two columns labeled “HDNs” refer to the number of HDNs found in
the Caida dataset (“ITDK”) but also to those (“Candidate”), encoun-
tered in our measurement campaign, that can potentially act as