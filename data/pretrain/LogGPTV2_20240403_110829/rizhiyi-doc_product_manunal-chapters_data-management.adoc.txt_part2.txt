=== 数据库配置
数据库配置可以将数据库中的结构化数据与日志易的索引数据进行组合，使用户可以洞察提供的所有组合数据。支持的数据库有：MYSQL，Vertica，ClickHouse 等。根据许可协议的要求，部分数据库的 JDBC driver 需要用户自行上传到 SPLserver 的对应目录 `/opt/rizhiyi/common/driver` 下。系统将自动识别同名驱动文件，如 `clickhouse.jar`，`mysql.jar` 等。
用户可以通过日志易 Manager 的数据文件功能完成集群的文件上传：
image::images/dbx-driver-upload.png[]
使用数据库输出会将数据从日志易推送至外部数据库，以提高组织的洞察力。使用数据库查找引用外部数据库中的字段为事件数据添加有意义的信息。
==== 连接配置
使用数据库配置功能，首先需要配置数据库连接。连接配置包含连接到外部数据库所需的信息。
通过"元数据"\->"数据库配置"\->"连接配置"，进入连接列表页，可以对已创建的连接进行启用/禁用，新建，查看，编辑，复制，删除操作。
image::images/dbx-connection.png[]
点击"新建连接"，选择有可用驱动的数据库类型，按提示填入对应配置，其中获取行数是一次要从数据库返回的行数，如果不填，则默认为100。
image::images/dbx-new-connection.png[]
如果需要更具体的配置，可以勾选编辑 URL 部分，此时，连接配置以 URL 部分为准，不再参考之前表单填写的内容。
点击保存会自动验证配置是否正确，保存成功后，可以在数据库输出、数据库查找、dbxquery命令中指定连接。dbxquery是搜索命令，详情请查看《日志易检索参考》。另外，建议起一个方便管理的连接名称。
==== 数据库输出
数据库输出会将数据从日志易推送至外部数据库。
通过"元数据"\->"数据库配置"\->"数据库输出"，进入输出列表页，可以对已创建的输出进行启用/禁用，新建，查看，编辑，复制，删除操作。
image::images/dbx-output.png[]
列表上同时展示在使用该数据库输出配置的定时任务。建议用户仅在关联定时任务数量为 0 时，才删除输出配置。
===== 新建数据库输出
点击"新建输出"，完成以下步骤以创建数据库输出。
1. 搜索：输入SPL或选择已存搜索以搜索数据。搜索完成后，点击"下一步"。
+
image::images/dbx-output-step1.png[]
2. 选择表格：从数据库中选择要将日志易数据导出到的表。
+
image::images/dbx-output-step2-empty.png[]
* 首先在"连接"对话框选择已创建的有效数据库连接。
* 按提示填入对应配置：目录，schema和表。
* 选择表后，可以在“表结构预览”页面上预览数据。它列出了表的列名，数据类型，列大小和相关字段。表结构下方展示表内容，最多展示1000行。
+
image::images/dbx-output-step2.png[]
* 单击"下一步"。
3. 字段映射：将所选字段映射到数据库中的列。
+
image::images/dbx-output-step3.png[]
* 字段映射：点击"添加映射"，选择搜索字段，选择要映射到的表格列名称，可以添加多个映射。
* 更新/插入配置：更新/插入配置允许插入行，或基于已存在的列的数据，而是更新该行。如果选择开启更新/插入配置，则需在表中指定Key列。
** 更新/插入配置示例：将id列设置为key。
+
[width="100%",options="header,footer"]
|====================
|id  |名称
|222 |张三
|223 |李四  
|====================
+
如果有两个数据事件要导出到此表，一个是“ id = 222，name = 熊大”，另一个是“ id = 224，name = 熊二”，则更新后的表是：
+
[width="100%",options="header,footer"]
|====================
|id  |名称  
|222  |熊大  
|223  |李四  
|224  |熊二  
|====================
4. 属性设置：按提示填入名称，描述，查询超时时间。其中名称是必填属性。
+
image::images/dbx-output-step4.png[]
5. 完成。
===== 使用dbxoutput命令运行数据库输出
dbxoutput是搜索命令（详情请查看《日志易检索参考》），可用于在数据库配置中定义的数据库输出。
语法：dbxoutput output = 。output是必填参数，数据库输出名称是上面第4步属性配置中填写的名称。
==== 数据库查找
数据库查找可以利用外部数据库数据来丰富日志易中的数据。例如，数据库查找在事件中获取customer_id值，将该值与外部数据库中的相应customer_name相匹配，然后将customer_name添加到事件中作为新customer_name字段的值。因此，如果您有一个customer_id="24601"的事件，则数据库查找会将customer_name="王五"添加到事件中。
通过"元数据"\->"数据库配置"\->"数据库查找"进入查找列表页，可以对已创建的查找进行启用/禁用，新建，查看，编辑，复制，删除操作。
image::images/dbx-lookup.png[]
===== 新建数据库查找
点击"新建查找对象"，完成以下步骤以创建数据库查找。
1. 搜索：输入SPL或选择已存搜索以搜索数据。搜索完成后，点击"下一步"。
2. 查找SQL配置：指定SQL以从数据库中获取数据。按提示填入相应配置：连接，目录，schema/表。也可以在SQL编辑器中自定义SQL（只支持select开头的语句），点击"执行SQL"。
+
image::images/dbx-lookup-step2.png[]
+
在SQL编辑器下方展示数据库返回结果，最多返回1000行，右侧展示SQL列和上一步搜索的字段。如果数据库返回结果是你想要的，点击"下一步"。
3. 字段映射：将所选的搜索字段与数据库表列进行映射，然后可以将表列添加为日志易字段以丰富日志易中的数据。
* 搜索字段映射。单击"添加映射"，然后选择要与数据库表列匹配的搜索字段名称。然后在"表格列名称"选择列名称。如果需要，可以添加多对搜索字段和表列。
* Lookup字段。将表列添加为新的日志易字段。单击"添加字段"，在表格列下拉框中选择名称，选中的列奖作为新字段添加到日志易数据库中。
** 为表列设置别名（可选）。为了便于理解，可以在输入别名来重命名数据库列。名称必须唯一，并且不得与字段名称重叠。
* 展示结果。相应的搜索将显示在“展示结果”中。您可以通过单击“ 在搜索中打开”来运行搜索以预览数据。
+
image::images/dbx-lookup-step3.png[]
+
* 点击"下一步"。
4. 属性配置：填入名称和描述，其中名称是必填属性。
+
image::images/dbx-lookup-step4.png[]
5. 完成
===== 使用dbxquery命令运行数据库查找
dbxlookup是搜索命令（详情请查看《日志易检索参考》），可用于通过使用外部数据库表作为查找表来执行查找。使用dbxlookup可以利用存储在外部数据库中的信息来丰富索引事件。
* 语法一：dbxlookup lookup = 。lookup字符串是已配置的数据库查找名称。
* 语法二：dbxlookup connection= query= chunksize=  AS  OUTPUT  AS 。 详情请查看《日志易检索参考》dbxlookup指令。
=== LDAP 连接
LDAP 连接可以将第三方 LDAP 服务器中的树状结构数据与日志易的索引数据进行组合、过滤。日志易 SPL 可以采用 ldapsearch、ldaptestconnection、ldapfilter 等一系列相关指令来调用预定义好的 LDAP 连接。
==== LDAP 连接配置
配置 LDAP 连接包含连接到外部数据库所需的信息。
通过"元数据"\->"LDAP 连接"，进入连接列表页，可以对已创建的连接进行查看，编辑，复制，删除操作。
点击列表页右上角的新建按钮，开始新建连接：
image::images/ldap-connection.png[]
在完成配置以后，可以点击验证连接，确定配置有效后再保存。
保存完毕后，您可以通过日志易 SPL 进行搜索使用，LDAP 连接的名称就是在 ldapsearch 等指令中 domain 参数的值。指令的详细用法，请参阅《日志易检索参考》。
=== 日志结算管理
日志结算管理是按日志归属计费，按归属用户维度看使用费，点击"系统"-"结算管理"打开如下界面：
image::images/payments-list.png[]
日志易每12小时会自动统计一次系统现存的appname列表，对照结算分配现状，结算得出未分配的appname，并展示在该页左侧列表。您可以点击分配选择结算受益人：
image::images/payments-assign.png[]
您可以选择忽略某个appname
image::images/payments-ingore-btn.png[]
也可以恢复已忽略的资源
image::images/payments-ignore-recover.png[]
您也可以在创建/编辑受益人时，批量分配appname：
image::images/payments-new.png[]
点击历史记录查看用户结算的历史趋势：
image::images/payments-history.png[]
=== 字段标准集
日志易提供字段标准集功能，用户可以通过自定义字段标准的校验规则，对接入日志易平台的相关日志数据进行数据质量分析，也可以为尚未接入日志易平台的相关日志数据做字段提取规则配置时提供标准字段模型的参考。可参考《日志易数据接入手册》相关说明。
一个字段的校验规则，称为一个字段标准。对同一份数据若干字段的校验规则的集合，称为一个字段标准集。因此，用户一般对日志的质量分析均基于整套字段标准集进行。在字段标准集管理页右上角点击新建，创建一个字段标准集：
image::images/field-standards-list.png[]
字段标准集的配置内容包括：
* 基础配置：包括名称、描述、资源标签等日志易资源通用配置。字段标准集是一种日志易资源，可随资源包导入导出。
* 字段标准列表：每行字段标准包括的规则配置有字段名称、字段描述、字段类型、校验规则等。
日志易支持数值、文本、布尔值三种基础类型。对不同类型，支持不同的校验规则。数值型的可填校验规则如下：
image::images/field-standards-number.png[]
文本型的可填校验规则如下：
image::images/field-standards-string.png[]
如果有更细节的校验需求，可以点击校验规则表单右侧的切换按钮，改为高级的 SPL 语句输入框，直接填入 SPL 评估函数。比如对 IP 字段的校验规则可以填写如下：
image::images/field-standards-advance.png[]
==== 质量分析
日志易在字段标准集上提供了质量分析按钮，点击按钮，在弹层中选择您打算分析的日志时间范围和数据查询范围。数据范围可以直接输入 SPL 语句，也可以快速选择某个数据集：
image::images/field-standards-quality-analysis-1.png[]
选择完毕后，点击"去分析"，即可打开搜索页，自动运行分析语句，得到最终的质量分析结果：
image::images/field-standards-quality-analysis-result.png[]
如果需要定时分析报告，可以在搜索页上点击保存为趋势图，加入仪表盘或报表中使用。也可以按需调整分析语句中的内容。
此外，日志易在数据集上，也提供了质量分析按钮，也可以在数据集上点击按钮，选择使用哪个字段标准集进行质量分析：
image::images/field-standards-quality-analysis-2.png[]
<<<