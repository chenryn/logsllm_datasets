5. Enable sFlow technology on a specific interface:
[edit protocols sflow]
user@switch# set interfaces et-0/0/1.1 sample rate ingress 100 egress 100
6. Commit the configuration:
[edit protocols sflow]
user@switch# commit
843
Results
Check the results of the configuration:
[edit]
user@switch# show protocols sflow
agent-id 10.1.12.0/24;
polling-interval 0;
sample-rate {
ingress 16000;
egress 16000;
}
collector 192.168.200.100;
interfaces et-0/0/54.1 {
sample-rate {
ingress 100;
egress 100;
}
}
interfaces et-0/0/56.0;
interfaces et-0/0/57.1 {
sample-rate {
ingress 100;
egress 100;
}
}
Verification
IN THIS SECTION
Verify Configured sFlow Technology | 844
To confirm that the sFlow configuration is enabled and correct.
844
Verify Configured sFlow Technology
IN THIS SECTION
Purpose | 844
Action | 844
Purpose
Verify the sFlow monitoring is enabled for an EVPN-VXLAN network.
Action
From operational mode, enter the show protocols sflow command.
user@switch> show protocols sflow
sFlow : Enabled
Adaptive fallback : Disabled
Sample limit : 300 packets/second
Sample limit Threshold : 0 packets/second
Polling interval : 0 second
Sample rate egress : 1:2048: Disabled
Sample rate ingress : 1:100: Enabled
Agent ID : 10.1.12.0/24
Source IP address : 10.1.12.0
RELATED DOCUMENTATION
Understanding Flexible Ethernet Services Support With EVPN-VXLAN
No Link Title
845
sFlow Support on Routers
IN THIS SECTION
sFlow for GRE Encapsulation | 846
sFlow Sample Size | 848
sFlow Limitations on Routers | 849
On PTX1000 routers and QFX10000 Series switches, sFlow technology always works at the level of the
physical interface. Enabling sFlow monitoring on one logical interface enables it on all logical interfaces
belonging to that physical interface.
On PTX1000 routers, PTX10000 routers, and QFX10000 Series switches, you can configure sFlow only
on an active logical interface. Use the show interfaces terse command to display the status information of
interfaces. If both operational and admin state of an interface is up, then it is an active interface.
On PTX10000 routers, PTX5000 routers and QFX10000 Series switches, sFlow will not generate
samples as expected when the ingress or egress interfaces are part of routing instance specifically in
ECMP scenario.
The sFlow agent is responsible for monitoring the network port, sample all incoming packets including
control traffic and traffic arriving on all the ports in the system.
sFlow technology is supported only on the ACX5000 line of routers, other ACX Series routers do not
support this technology.
The following sFlow features are supported on the ACX5000 line of routers:
• Packet-based sampling
NOTE: This feature is not supported on ACX5448 router.
• Time-based sampling
• Adaptive sampling
The following sFlow technology limitations apply on ACX5000 line of routers:
846
• The ingress and egress sampling can be configured only on one of the units under a physical interface
and the sFlow is enabled for the physical interface (port). The sFlow cannot be enabled if the unit
under a physical interface is not configured.
• Egress sampling for Broadcast, Unknown unicast and Multicast (BUM) traffic is not supported
because the source-interface field in the sFlow datagrams cannot be populated.
• Destination VLAN and Destination Priority fields are not populated in the case of Layer 3 forwarding.
• sFlow sampling is not supported on the output interface of an analyzer.
• SNMP MIB support for sFlow is not available.
• sFlow cannot be enabled on IRB interfaces.
• sFlow cannot be enabled on logical tunnel (lt-) and LSI interfaces.
sFlow for GRE Encapsulation
On PTX10001-36MR, PTX10003, PTX10004, PTX10008, and PTX10016 devices, sFlow supports the
export of Extended Tunnel Egress Structure fields for traffic entering IPv4 or IPv6 GRE tunnels. This
enables sFlow to provide information about GRE tunnel into which a packet entering the device might
be encapsulated. The GRE tunnel could be IPv4 or IPv6. The feature is supported only when sFlow is
enabled in the ingress direction wherein firewall based GRE encapsulation happens on IPv4 or IPv6
packets.
The feature is supported for the below traffic scenarios when ingress sFlow sampling is enabled:
• Incoming IPv4 traffic that undergoes IPv4 GRE encapsulation
• Incoming IPv6 traffic that undergoes IPv4 GRE encapsulation
• Incoming IPv4 traffic that undergoes IPv6 GRE encapsulation
• Incoming IPv6 traffic that undergoes IPv6 GRE encapsulation
To learn more about the sFlow and sFlow Tunnel Structures, see sFlow Tunnel Structures.
No Link Title describes extended tunnel egress structure fields for traffic entering IPv4 or IPv6 GRE
tunnels.
Table 85: Extended Tunnel Egress Structure Fields and Values
Field Name Value
Protocol reported 0x2f (GRE)
847
Table 85: Extended Tunnel Egress Structure Fields and Values (Continued)
Field Name Value
Source IP IPv4 or IPv6 address of the tunnel source
Destination IP IPv4 or IPv6 address of the tunnel destination
endpoint
length 0
source port 0
destination port 0
tcp flags 0
priority 0
The extended structure for IPv4 and IPv6 GRE tunnels is below:
/* opaque = flow_data; enterprise = 0; format = 1023 */
struct extended_ipv4_tunnel_egress {
sampled_ipv4 header;
}
/* opaque = flow_data; enterprise = 0; format = 1025 */
struct extended_ipv6_tunnel_egress {
sampled_ipv6 header;
}
Sampled IPv4 header structure is below:
/* Packet IP version 4 data */
/* opaque = flow_data; enterprise = 0; format = 3 */
848
struct sampled_ipv4 {
unsigned int length; /* The length of the IP packet excluding
lower layer encapsulations */
unsigned int protocol; /* IP Protocol type
(for example, TCP = 6, UDP = 17) */
ip_v4 src_ip; /* Source IP Address */
ip_v4 dst_ip; /* Destination IP Address */
unsigned int src_port; /* TCP/UDP source port number or equivalent */
unsigned int dst_port; /* TCP/UDP destination port number or equivalent
unsigned int tcp_flags; /* TCP flags */
unsigned int tos; /* IP type of service */
}
Sampled IPv6 header structure is below:
/* Packet IP Version 6 Data */
/* opaque = flow_data; enterprise = 0; format = 4 */
struct sampled_ipv6 {
unsigned int length; /* The length of the IP packet excluding
lower layer encapsulations */
unsigned int protocol; /* IP next header
(for example, TCP = 6, UDP = 17) */
ip_v6 src_ip; /* Source IP Address */
ip_v6 dst_ip; /* Destination IP Address */
unsigned int src_port; /* TCP/UDP source port number or equivalent */
unsigned int dst_port; /* TCP/UDP destination port number or equivalent*/
unsigned int tcp_flags; /* TCP flags */
unsigned int priority; /* IP priority */
}
sFlow Sample Size
Starting in Junos OS Evolved 23.1R1 release for PTX Series devices, you can configure the sFlow sample
size of the raw packet header to be exported as part of the sFlow record to the collector. The
configurable range of sample size is from 128 bytes through 512 bytes. Use the set protocols sflow sample-
size Sample-Size command to configure the sample size. If the configured sample size is greater than the
actual packet size, then the actual size of the packet is exported. If you do not configure the sample size,
the default size of the raw packet header exported to the collector is 128 bytes.
849
The sample size configured in the global sFlow configuration is inherited by all the interfaces configured
under sFlow protocols.
sFlow Limitations on Routers
On routers, limitations of sFlow traffic sampling include the following:
• Trio chipset cannot support different sampling rate for each family. Hence, only one sampling rate
can be supported per line card.
• Adaptive load balancingsampling is applied per line card and not for per interface under the line card.
Routers support configuration of only one sampling rate (inclusive of ingress and egress rates) on an line
card. To support compatibility with the sFlow configuration of other Juniper Networks products, the
routers still accept multiple rate configuration on different interfaces of the same line card. However, the
router programs the lowest rate as the sampling rate for all the interfaces of that line card. The (show
sflow interfaces) command displays the configured rate and the actual (effective) rate. However, different
rates on different line cards is still supported on Juniper Networks routers.
In Junos OS Evolved, you can configure sFlow only on Ethernet interfaces (et-*) for the following PTX
Series devices:
• PTX10003-80C and PTX10003-160C
• PTX10008
• PTX10001-36MR
• PTX10004
• PTX10016
You cannot configure sFlow on loopback interfaces (lo0).
Example: Configure sFlow Technology to Monitor Network Traffic
IN THIS SECTION
Requirements | 850
Topology | 850
Configuration | 851
850
Verification | 854
This example describes how to configure and use sFlow technology to monitor network traffic.
Requirements
You can use QFX Series, EX Series, PTX Series and MX Series devices for the example using the
following hardware and software components:
• One EX Series switch
• Junos OS Release 9.3 or later for EX Series switches
• One MX Series router
• Junos OS Release 18.1 or later for MX Series routers
• Junos OS Release 11.3 or later
• One QFX3500 switch
Topology
The sFlow agent runs on the switch. It combines interface counters and flow samples and sends them
across the network to the sFlow collector. Figure 32 on page 851 depicts the basic elements of the
sFlow system.
851
Figure 32: sFlow Technology Monitoring System
Configuration
IN THIS SECTION
CLI Quick Configuration | 852
Procedure | 852
To configure sFlow technology, perform the following tasks:
852
CLI Quick Configuration
To quickly configure sFlow technology, copy the following commands and paste them into the switch
terminal window:
[edit protocols]
set sflow collector 10.204.32.46 udp-port 5600
set sflow interfaces ge-0/0/0
set sflow polling-interval 20
set sflow sample-rate egress 1000
Procedure
Step-by-Step Procedure
To configure sFlow technology:
1. Configure the IP address and UDP port of the collector:
[edit protocols]
user@switch# set sflow collector 10.204.32.46 udp-port 5600
NOTE: You can configure a maximum of 4 collectors.
The default UDP port is 6343.
2. Enable sFlow technology on a specific interface:
[edit protocols sflow]
user@switch# set interfaces ge-0/0/0
NOTE: You cannot enable sFlow technology on a Layer 3 VLAN-tagged interface.
853
3. Specify in seconds how often the sFlow agent polls the interface:
[edit protocols sflow]
user@switch# set polling-interval 20
NOTE: The polling interval can be specified as a global parameter also. Specify 0 if you do not
want to poll the interface.
4. Specify the rate at which egress packets must be sampled:
[edit protocols sflow]
user@switch# set sample-rate egress 1000
NOTE: You can specify both egress and ingress sampling rates. If you set only the egress
sampling rate, the ingress sampling rate will be disabled.
NOTE: We recommend that you configure the same sampling rates on all the ports on a line
card. If you configure different sampling rates are different, the lowest value is used for all
ports. You could still configure different rates on different line cards.
5. (Optional) Specify the sample size for the raw packet header. The sample size configuration is
applicable on PTX10003-80C, PTX10003-160C, PTX10001-36MR, PTX10004, PTX10008 and
PTX10016 devices from 23.1R1 Junos OS Evolved release.
[edit protocols sflow]
user@switch# set sample-size 135
Results
Check the results of the configuration:
[edit protocols sflow]
user@switch# show
854
polling-interval 20;
sample-rate egress 1000;
collector 10.204.32.46 {
udp-port 5600;
}
interfaces ge-0/0/0.0;
[edit protocols sflow]
user@router# show
polling-interval 20;
source-ip 45.1.1.1;
collector 45.1.1.100;
sample-size 135;
Verification
IN THIS SECTION
Verifying That sFlow Technology Is Configured Properly | 854
Verifying That sFlow Technology Is Enabled on the Specified Interface | 855
Verifying the sFlow Collector Configuration | 856
To confirm that the configuration is correct, perform these tasks:
Verifying That sFlow Technology Is Configured Properly
Purpose
Verify that sFlow technology is configured properly.
855
Action
Use the show sflow command:
user@switch> show sflow
sFlow: Enabled
Sample limit: 300 packets/second
Polling interval: 20 seconds
Sample rate egress: 1:1000: Enabled
Sample rate ingress: 1:2048: Disabled
Agent ID: 10.204.96.222
user@router> show sflow
sFlow : Enabled
Adaptive fallback : False
Sample limit : 2000 packets/second
Sample limit Threshold : 0 packets/second
Polling interval : 20 second
Sample rate egress : 1:2048:Disabled
Sample rate ingress : 1:2048:Disabled
Agent ID : 10.204.96.222
Agent ID IPv6 : No valid agent IPv6
Source IP address : 45.1.1.1
Source IPv6 address : No valid source IPv6
Sample Size : 128 Bytes
NOTE: The sampling limit cannot be configured and is set to 300 packets/second per FPC.
Meaning
The output shows that sFlow technology is enabled and specifies the values for the sampling limit,
polling interval, and the egress sampling rate.
Verifying That sFlow Technology Is Enabled on the Specified Interface
Purpose
Verify that sFlow technology is enabled on the specified interfaces and display the sampling parameters.
856
Action
Use the show sflow interface command:
user@switch> show sflow interface
Interface Status Sample rate Adapted sample rate Polling-interval
Egress Ingress Egress Ingress Egress Ingress
ge-0/0/0.0 Enabled Disabled 1000 2048 1000 2048 20
Meaning
The output indicates that sFlow technology is enabled on the ge-0/0/0.0 interface with an egress
sampling rate of 1000, a disabled ingress sampling rate, and a polling interval of 20 seconds.
Verifying the sFlow Collector Configuration
Purpose
Verify the sFlow collector's configuration.
Action
Use the show sflow collector command:
user@switch> show sflow collector
Collector Udp-port No. of samples
address
10.204.32.46 5600 1000
10.204.32.76 3400 1000
user@router> show sflow collector
Collector Udp-port Dscp Forwarding-Class
No. of samples
address
45.1.1.100 6343 0 best-effort 0
857
Meaning
The output displays the IP address of the collectors and the UDP ports. It also displays the number of
samples.
sFlow Agent Address Assignment
The sFlow collector uses the sFlow agent’s IP address to determine the source of the sFlow data. You
can configure the IP address of the sFlow agent to ensure that the agent ID of the sFlow agent remains
constant. If you do not specify the IP address to be assigned to the agent, an IP address is automatically
assigned to the agent based on the following order of priority of interfaces configured on the device:
Table 86: Interfaces on the Devices
Routers and EX Series Switches QFX Series Devices
1. Virtual Management Ethernet (VME) interface 1. Management Ethernet interface em0 IP address
2. Management Ethernet interface 2. Any Layer 3 interface if the em0 IP address is not
available
If neither of the preceding interfaces has been configured, the IP address of any Layer 3 interface or the
routed VLAN interface (RVI) is assigned to the agent. At least one interface must be configured on the
switch for an IP address to be automatically assigned to the agent. When the agent’s IP address is
assigned automatically, the IP address is dynamic and changes when the switch reboots.
sFlow data can be used to provide network traffic visibility information. You can explicitly configure the
IP address to be assigned to source data (sFlow datagrams). If you do not explicitly configure that
address, the IP address of the configured Gigabit Ethernet interface, 10-Gigabit Ethernet interface, or
the RVI is used as the source IP address.
858
CHAPTER 10
Adaptive Sampling for Routers and Switches