互联网路由选择协议
域内路由选择
域间路由选择
内部网关协议（IGP)
外部网关协议（EGP)
距离向量
链路状态
路径向量
(Distance Vector)
(Link State)
(path vector)
RIP
OSPF
BGP-4
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 204
204
6.路由选择协议
6.4外部网关协议BGP
口边界网关协议BGP是不同自治系统的路由器之间交换路由信息的协议。
BGP较新版本是2006年1月发表的BGP-4。
■BGP第4个版本，即RFC4271～4278。
■为了简单起见，通常将BGP-4 简写为BGP。
河南中医药大学信息技
---
## Page 205
205
6.路由选择协议
6.4外部网关协议BGP
口BGP的三个主要特点
■用于自治系统AS之间的路由选择
■只能是力求选择出一条能够到达目的网络且比较好的路由
（不能兜圈子），
而并非要计算出一条最佳路由。
·因特网规模太大，使得自治系统之间路由选择非常困难。
·对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
·自治系统之间的路由选择必须考虑有关策略。
当一条路径通过几个不同AS 时，要想对这样的路径计算出有意义的路由是不太可能的。
比较合理的做法是在AS之间交换"可达性"信息。
采用了路径向量（pathvector）路由选择协议。
m.edu.cn
---
## Page 206
206
6.路由选择协议
6.4 外部网关协议 BGP
BGP发言者
(BGP speaker)
■两个BGP发言者通过一个共享网络连接在一起的。
口BGP发言者可以是BGP边界路由器，也可以不是。
BGP发言者
BGP发言者
X前缀
AS1
AS2
AS3
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 207
207
BGP发言者
BGP发言者
×前缀
AS,
AS2
AS3
（）
种连接又称为eBGP连接。
在AS内部，任何相互通信的两个路由器之间必须有一个逻辑连接（也使用TCP连接）。AS内
部所有的路由器之间的通信是全连通的。这种连接常称为iBGP连接。
eBGP（externalBGP）连接：运行eBGP协议，在不同AS之间交换路由信息。
iBGP（internalBGP）连接：
运行iBGP协议，在AS内部的路由器之间交换BGP路由信息。
---
## Page 208
208
IGP、iBGP和eBGP的关系
eBGP
eBGP
eBGP
iBGP
iBGP
iBGP
iBGP
IGP
IGP
IGP
IGP
AS1
AS2
AS3
AS4
在AS内部运行：
在AS之间运行：
内部网关协议IGP，如 OSPF或 RIP
协议 eBGP
协议 iBGP。
---
## Page 209
209
eBGP和iBGP
）同一个协议BGP
·使用的报文类型、使用的属性、使用的状态机等都完全一样。
但它们在通报前缀时采用的规则不同：
·从eBGP连接的对等端得知的前缀信息，可以通报给一个BGP连接的对等端
，从iBGP连接的对等端得知的前缀信息，可以通报给一个eBGP连接的对等端
·从iBGP连接的对等端得知的前缀信息，不能通报给一个iBGP连接的对等端
---
## Page 210
210
6.路由选择协议
6.4外部网关协议BGP
口BGP路由
BGP路由=［前缀，BGP属性］=【前缀，AS-PATH，NEXT-HOP ］
去哪里
BGP前缀：
指明到哪一个子网（用CIDR记法表示）
如何去
BGP重要的两个属性是：
自治系统路径
AS-PATH
下一跳
NEXT-HOP
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 211
211
6.路由选择协议
6.4外部网关协议BGP
口三种不同的自治系统AS
穿越 AS (transit AS)
AS
收费
收费
?
M
对等 AS (Peering AS)
AS2
AS3
←免费
收费
AS
AS6
AS5
末梢AS
末梢AS
多归属AS
stub AS
stub AS
multihomed AP
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 212
212
穿越 AS (transit AS)
AS,
末梢 AS，stub AS:
比较小的AS，把分组发送给直接连接
对等AS（PeeringAS)
的AS，或者接收直接连接的AS发来
AS2
AS
的分组。
不会把来自其他AS的分组再转发到另
一个 AS。
AS
末梢 AS必须向所连接的AS付费才能
末梢AS
末梢AS
多归属AS
stub AS
stub AS
够发送或接收分组。
multihomed AP
---
## Page 213
213
穿越 AS (transit AS)
AS
多归属 AS， multihomed AS:
末梢AS可以同时连接到两个或者多个
对等AS（PeeringAS）
AS
AS，称为多归属AS。
AS2
多归属AS可以增加连接的可靠性，一
条连接故障，其他连接可用。
多归属 AS 不能成为穿越 AS。
AS
末梢AS
末梢AS
多归属AS
stub AS
stub AS
multihomed AP
---
## Page 214
214
穿越 AS (transit AS)
AS,
对等 As, peering AS:
经过事先协商的两个AS。
对等AS（PeeringAS)
对等 AS 之间发送和接收 AS 不收费。
AS2
AS
穿越 AS， transit AS:
·拥有高速通信干线的主干 AS。
AS
用于为其他 AS 有偿转发分组。
末梢AS
末梢AS
多归属AS
stub AS
stub AS
很多 AS连接到穿越 AS上。
multihomed AP
---
## Page 215
215
BGP路由如何避免兜圈子？
在属性AS-PATH中，不允许出现相同的AS号。
·AS3检查收到的BGP路由的AS-PATH中已经有了自己
立即删除掉这条路由，从而避免兜圈子路由的出现。
AS,
[X, AS3 AS6]
[X, AS AS3 AS6]
AS2
AS3
[X, AS2 AS AS3 AS6]
AS6
X前缀
---
## Page 216
216
6.路由选择协议
6.4外部网关协议BGP
口BGP 的路由选择
■从一个AS到另一个 AS中的前缀×只有一条路由，不存在选择的问题。
■从一个AS到另一个AS中的前缀×不止一条路由，选择较好的BGP 路由。
·本地偏好（localpreference）值最高的路由（默认值=100)
·AS跳数最小的路由
使用热土豆路由选择算法（分组在AS内的转发次数最少）
使用该路由器的IP地址中数值最大的一个。
河南中医药大学信息技术学院互联网技术教学团队／https://inter
tcm.edu.cn
---
## Page 217
217
6.路由选择协议
6.4 外部网关协议 BGP
BGP-4的四种报文：
OPEN (打开)
·用来与相邻的另一个BGP发言者建立关系，使通信初始化。
UPDATE (更新)
·用来通告某一路由的信息，以及列出要撤销的多条路由。
KEEPALIVE (保活)
·用来周期性地证实邻站的连通性。
NOTIFICATION (通知)
·用来发送检测到的差错。
在RFC2918中增加ROUTE-REFRESH报文，用来请求对等端重新通告
河南中医药大学
n.edu.cr
---
## Page 218
218
6.路由选择协议
6.4外部网关协议BGP
BGP报文结构：
字节
16
标
记
长度
类型
BGP报文通用首部
BGP报文主体部分
TCP首部
BGP报文
IP首部
TCP 报文
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 219
219
6.路由选择协议
6.5路由器的结构
口路由器的结构：
■路由器工作在网络层，用于互连网络
■路由器是互联网中的关键设备。
■路由器的主要工作：转发分组。
·路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分
组。
口路由器某个输入端口收到分组，按照分组要去的目的网络，把该分组从路由器的
某个合适的输出端口转发给下一跳路由器。
·下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。
---
## Page 220
220
6.路由选择协议
6.5路由器的结构
路由器的结构：
路由选择处理机
网络层
路由选择协议
路由
数据链路层
选择
路由表
物理层
输入端口
输出端口
3
分组处理
分组
转发表
转发
输入端口
输出端口
交换结构
3
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 221
221
6.路由选择协议
6.5路由器的结构
口路由器的结构：
■整个的路由器结构可划分为两大部分：
口路由选择部分
口分组转发部分
■路由选择部分
口也叫做控制部分，其核心构件是路由选择处理机。
口路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或
n.edu.cr
---
## Page 222
222
6.路由选择协议
6.5路由器的结构
口路由器的结构：
■整个的路由器结构可划分为两大部分：
口路由选择部分
口分组转发部分
1分组转发部分：由三部分组成
交换结构(switching fabric)：又称为交换组织，其作用是根据转发表(forwarding
table)对分组进行处理。
口一组输入端口
端口就是硬件接口
一组输出端口
n.edu.cr
---
## Page 223
223
“转发”
和”路由选择”
的区别
转发
路由选择
·根据转发表将用户的IP数据报从
按照路由选择算法，根据网络拓扑
合适的端口转发出去。
的变化情况，动态地改变所选择的
·仅涉及到一个路由器。
路由，并由此构造出整个路由表。
·转发表是从路由表得出的。
·涉及到很多路由器。
·转发表必须包含完成转发功能所必
·路由表一般仅包含从目的网络到下
一跳（用IP地址表示）的映射。
需的信息，每一行必须包含从要到
达的目的网络到输出端口和某些
MAC地址信息（如下一跳的以太
网地址）的映射。
---
## Page 224
224
6.路由选择协议
6.5路由器的结构
输入端口对线路上收到的分组的处理：
■数据链路层剥去顿首部和尾部后，将分组送到网络层的队列中排队等待处理
这会产生一定的时延。
输入端口的处理
网络层处理
从线路接收分组
分组排队
交换结构
数据链路层
物理层处理
处理
查表和转发
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 225
225
6.路由选择协议
6.5路由器的结构
输出端口将交换结构传送来的分组发送到线路：
当交换结构传送过来的分组先进行缓存。数据链路层处理模块将分组加上链
路层的首部和尾部，交给物理层后发送到外部线路。
输出端口的处理
网络层处理
向线路发送分组
分组排队
交换结构
数据链路层
物理层处理
处理
缓存管理
河南中医药大学信息技术学院互联网技术教学团队／https://internet.hactcm.edu.cn
---
## Page 226
226
6.路由选择协议
6.5路由器的结构
口分组丢弃：
若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最
终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被
丢弃。
■路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。
---
## Page 227
227
6.路由选择协议
6.5路由器的结构
口交换结构：
■交换结构是路由器的关键构件。
■正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。
实现交换有多种方法，常用交换方法有三种：
口通过存储器
口通过总线
口通过纵横交换结构