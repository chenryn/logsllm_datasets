• Disables anti-virus software and other protection mechanisms
• Blocks access to anti-virus vendors
• Blocks access to Windows Update
Phase 3, Mitglieder malware contains the actual payload
• The attacker now 0wns the machine for use in botnets, 
spamming, DDoS, keystroke logging, etc
Example: Glieder trojan (ctd)
Multi-phase approach bootstraps a fast-moving zero-day 
into an arbitrary-sized malware payload
Q: How can a mere 376 bytes (SQL Slammer) be a threat?
A: It doesn’t have to be, all it has to do is clear the way for the 
real threat
Cascading file droppers of this kind are a standard 
mechanism for staying ahead of AV tools
• Glieder is relatively simple, some malware uses 10-15 stage 
infection strategies
Example: Glieder trojan (ctd)
Web sites are also set up using multi-stage strategies
Bait/spam sites
Redirector sites
Exploiter sites
Downloader sites
Adware/spyware sites
Example: Hybris worm
Plug-in modules are encrypted with XTEA and digitally 
signed using a Davies-Meyer XTEA hash and a 1024-bit 
RSA key
• Modules are obtained from web sites or newsgroups
• Creates a so-called “programmable virus”
Modules (‘muazzins’) included
• Windows help file infector
• Polymorphic Windows executable infector
– Could also infect executables ‘through’ a 
CRC16/CRC32/CRC48
• DOS .EXE infector
Example: Hybris worm (ctd)
• RAR/ZIP/ARJ infector
• Word, Excel infectors
• SubSeven backdoor dropper
• Module to retrieve plugins from web servers
• Module to retrieve plugins from news servers
• General-purpose dropper
• WSOCK32.DLL infection stealth module
• DoS module
• Antivirus web-site blocker module
• Antivirus uninstall/database corruptor module
• SOAP-based email generator
Other Malware Functions (ctd)
Autostart mechanisms are used by almost all malware
• Fall into the general category of auto-start extensibility points 
(ASEP)
• Registry keys, startup folder, services, browser help objects 
(BHOs), layered service providers (LSPs), MSIE extensions, 
shell hooks, …
• Several dozen (known) ASEPs in the Windows core OS alone
Pop up messages requesting payment of money and may 
disable your computer if you don’t pay up (WGA)
• Disable PC with the only option being to pay up (SPP)
Other Malware Functions (ctd)
Provide situation-specific payloads (“programmable 
viruses”) (Cheeba)
• Capabilities are built in, but encrypted
– Other programmable viruses use digitally signed plugins
• Virus compares a hash of disk filenames to built-in hash values
– When a hash matches, it uses the filename as the key to 
decrypt the file-specific payload
• Allows a virus to carry custom payloads for specific files, 
URLs, applications…
– You can’t tell what will happen to you until it’s too late
– Mostly superseded by the easy ability to distribute plugins, 
see the discussion of Hybris, Babylonia, …
Other Malware Functions (ctd)
Remove competing malware from the system
• SpamThru includes a pirated copy of Kaspersky Antivirus to 
eliminate the competition
• Loads the Kaspersky DLL and patches the license check in-
memory
Adware vendors DirectRevenue have a ‘Dark Arts’ 
division dedicated to techniques like removing 
competing malware
You also acknowledge that such software and updates to 
software may without further notice to you, remove, disable or 
render inoperative other adware or spyware programs 
including but not limited to competing products 
— DirectRevenue EULA
Other Malware Functions (ctd)
Record user geolocation information
• Used to defeat anomaly-detection software used by CC companies
– Use the card from a botnet node near the victim’s registered location to 
evade transaction location tracking
Image courtesy Brian Krebs, Washington Post
Other Malware Functions (ctd)
Disable System Restore, patch SFC.DLL and 
SFC_OS.DLL to disable Windows File Prot (PWS-
Satiloler, Sdbot)
Perform targeted attacks on specific groups of users
• SpamThru trojan contacts controlling servers for information 
for victim-specific attacks, for example pump-and-dump scams 
for users performing stock trading
Hijack Windows Update (BITS) to download updates 
(Jowspry)
• Bypasses Windows Firewall and other security measures
Other Malware Functions (ctd)
Use standard Windows popups for nefarious purposes
• Install malware via fake Windows Update notifications 
(Antispysolutions.com, via Myspace)
• Request CC details for Windows product activation 
(Kardphisher)
Spammers can do virtually anything to a victim’s PC
• BroadcastPC malware installs 65MB (!!) of .NET framework 
without the user being made aware of this
Example: Haxdoor Identity-theft Trojan
Advanced anti-removal and rootkit capabilities
• Hides itself by hooking the System Service Dispatch Table 
(SSDT)
• Auto-loads via WinLogon
– It gets to load first
• Sets itself to run in SafeBoot mode
• Adds an autostart system service under various aliases
• Creates a remote thread inside Explorer
• Causes attempts to terminate it by AV software to terminate the 
AV program instead
– Done by swapping the handles of the rootkit and the AV 
program
Example: Haxdoor Identity-theft Trojan (ctd)
Spyware capabilities
• Captures all information entered into MSIE
– Recognises financial-site-related keywords on web pages 
(“bank”, “banq”, “trade”, “merchant”, …)
• Steals cached credentials (RAS, POP, IMAP, …)
• Feeds info to servers running on compromised hosts
One server held 285MB of stolen data from 9 days’ 
logging
• 6.6 million entries, 39,000 distinct victim IP addresses
– Probably much higher due to NAT’ing
• Full access details for 280 bank and credit card accounts
• Usernames and passwords for endless online accounts
Anti-detection Mechanisms
Change scanners’ abilities to view memory by hooking the 
virtual memory manager (Shadow Walker)
Use kernel-mode thread injection to hide from scanners 
(Rustock)
Use NT native API to create registry entry names that the 
Win32 API can’t process
Unhook the malware from lists of processes, threads, 
handles, memory, … (FU rootkit)
Won’t run if the system contains SoftICE, Filemon, 
Regmon, Visual Studio, Ethereal, … (Numerous)
Won’t run under a VMM (Many)
Anti-detection Mechanisms (ctd)
Tricks with processor features (AMD64 memory-type-
range registers) can even defeat hardware-based 
monitoring
Joanna Rutkowska’s proof-of-concept “replacing attack” 
shows a different image to a PCI monitoring card than 
what’s actually there
• Bounce access to physical memory address to I/O address 
space (memory-mapped I/O)
• Point some device’s base address register into the target I/O 
space
• Fill device memory with whatever you want the hardware 
monitor to see
Anti-detection Mechanisms (ctd)
Encrypt/obfuscate themselves to evade detection (too many 
to list)
• IDEA virus encrypts itself with the algorithm of the same name 
to evade detection
Randomised decryption (RDA) was introduced in the RDA 
Figher virus
• Outer layer: Polymorphically-generated layer with up to 16 
sub-layers
• Inner layer: Encrypted with random 16-bit key 
– Second level of IDEA virus also uses RDA with 18-bit key
• Virus needs to brute-force break its own encryption, making 
detection even harder
Anti-detection Mechanisms (ctd)
Polymorphism and RDA rendered pattern-based scanning 
ineffective 5-10 years ago
• Current scanners use behavioral analysis via heuristics and 
symbolic execution
• Zmist virus requires 2M code cycles to detect reliably
– Emulated x86 may multiply this by a factor of 100
– Then multiply again by x0,000 files on a system
• Virii using techniques like this are effectively undetectable
A quick solution delivery for metamorphic virus detection 
should become a huge team effort at AV companies. Exact 
identification becomes a problem even for humans
— Virus Bulletin
Anti-detection Mechanisms (ctd)
• Etap/Simile uses spread-spectrum style decryption
– Maximum-sequence RNG identifies the next byte to 
decrypt
– Avoids triggering memory-access-pattern detection
• Etap/Simile decryptor contains anti-emulation code
– Metamorphic RDTSC-based header causes the virus to not 
trigger 50% of the time
– Half the infected files won’t be detected as a virus under 
emulation
Anti-detection Mechanisms (ctd)
Anti-virus vendors notice users performing online scans of 
small variations on a theme
• These are VX’ers checking for detectability
The most popular brands of antivirus on the market […] have 
an 80 percent miss rate. That is not a detection rate that is a 
miss rate.  So if you are running these pieces of software, 
eight out of 10 pieces of malicious code are going to get in 
— Graham Ingram, General Manager, AusCERT
Anti-detection Mechanisms (ctd)
Other rootkit vendors will modify their code to evade the 
virus scanner of your choice for a fixed fee ($25-50)
AFX Rootkit 2005 by Aphex
Undetected rootkits are on sale for $100 each. Payment by 
paypal, egold, western union, check or money order!
Hackers working mutually on numerous rootkit projects are 
able to modify implementations to defeat detectors faster than 
corporations can offer a change
— Eric Uday Kumar, Authentium
Anti-detection Mechanisms (ctd)
The professionalism of these rootkits is coming to another 
level
— Allen Schimel, StillSecure
Example: Hacker Defender rootkit
Available as Bronze/Silver/Golden/Brilliant Hacker 
Defender, hxdef.czweb.org
• €150 (Bronze)/240 (Silver)/450 (Gold)/580 (Brilliant) layered 
add-on rootkit
• Commercial version of Hacker Defender
Anti-detection engine detects anti-virus software before it 
can detect the rootkit
• Works like a virus scanner in reverse
• Removes its kernel hooks if a rootkit-scanner is run to evade 
detection by the scanner
Example: Hacker Defender rootkit (ctd)
Uses signature-based detection to detect anti-rootkit tools
• The same techniques that the anti-malware tools use to find 
rootkits, only the rootkit gets there first
– Anti-rootkit tools are using rootkit-style stealth techniques 
to avoid this
• Updated on a subscription basis like standard virus scanners
Comprehensive real-time virus protection against all known 
Anti-Virus threats
Example: Hacker Defender rootkit (ctd)
Author “Holy Father” was killed in a car accident, New 
Year 2007
• Has proven the business model
• Others have followed, e.g. HangUp Team in Russia, 
hangup.da.ru
Other types of malware are also available for purchase
• Example: WebAttacker malware kit sells for $15-20, 
www.inet-lux.com (Russian site)
Phishing Mechanisms
Attacker controls the DNS
• Server compromise
– 10% of DNS servers scanned in late 2005 were vulnerable 
to DNS cache poisoning
– Used in one attack to redirect visitors to cnn.com and 
msn.com to spyware sites
• Bribing/blackmailing ISPs
• Virus changes the victim’s DNS server entries (“pharming”)
– Can be used to disable security updates
– (Fake) windowsupdate.com: Your system is up to date and 
doesn’t need any security fixes
Phishing Mechanisms (ctd)
• Script in phishing email rewrites the victim’s hosts file
– As for direct DNS compromise
• Many DNS providers ignore TTL’s
– Invalid DNS entries can take weeks to correct
Trojans control the victim’s PC
• Sniff keystrokes and mouse clicks
• Use screen scraping to get around graphical keyboards and 
PIN-pads
– Mostly popular in Europe and South America, US banks 
haven’t even got past unencrypted logon pages yet
• Render copies of genuine bank pages from the browser cache
Phishing Mechanisms (ctd)
Trojan installs itself as a browser help object (BHO)
• Watches for access to a who’s who of banking sites around the 
world
• Captures banking details before they go into the SSL layer
• Uses HTML injection to capture TANs (one-time PINs) for 
banking sites (MetaFisher)
Phishing Mechanisms (ctd)
Use typo-squatting to install malware
• googkle.com infects visitors with trojans, backdoors, and 
spyware
• Popups redirect to third-party sites loaded with downloader 
scripts
• Use assorted exploits to download more tools containing 
further exploit code
• Just one of these downloaded exploit packages contains two 
backdoors, two trojan droppers, a proxy trojan, a spyware 
trojan, and a further trojan downloader
• Another trojan dropper infects the Windows system folder and 
modifies the hosts file to prevent access to anti-virus sites
• Another generates a fake virus alert and directs the user to 
another trojan-riddled site
Example: Grams egold siphoner
Invades the victim’s PC via the usual attack vectors
Uses OLE automation to spoof the user’s actions
• Uses the IConnectionPointContainer OLE object to 
register event sinks for the IWebBrowser2 interface
• Checks for accesses to e-gold.com
• After user has logged on, uses 
IWebBrowser2::Navigate to copy the account balance 
window to a second, hidden window
• Uses IHTMLInputHiddenElement:get_value to 
obtain account balance
• Uses OLE to set Payee_Account and Amount
• Uses IHTMLElement::click to submit the form
• Waits for the verification page and again submits the form
Example: Grams egold siphoner (ctd)
Defeats any existing authentication method
• Passwords, SecurID, challenge-response calculator, smart card, 
…
This method of account looting bypasses all authentication 
methods employed by banking institutions, and is expected to 
become very popular […] Since the trojan uses the victim’s 
established SSL session and does not connect out on its own, 
it can bypass personal and corporate firewalls and evade IDS 
devices
— LURHQ security advisory on the trojan
Availability of Private Data
Stolen personal information is so easily available that the 
best protection is that crooks simply can’t use it all
• Number of identities stolen in an 18-month period from Feb’05 
— Jun’06: 89 million (Privacy Rights Clearinghouse)
• The smaller the breach, the greater the chance of the 
information being misused by crooks
Fraudsters […] can use roughly 100 to 250 [stolen identities] in
a year.  But as the size of the breach grows, it drops off pretty 
drastically
— Mike Cook, ID Analytics
• A bit like recommending that all householders leave their doors 
unlocked and alarms disabled, since crooks won’t be able to 
get around to robbing all of them
Availability of Private Data (ctd)
Social security numbers (SSNs) and other information can 
readily be bought online
• $35 from secret-info.com
• $45 from iinfosearch.com
Several sites sell full Social Security numbers, potentially 
contributing to an epidemic of identity theft
— Washington Post
• Unisys study found that about half of all financial institutions
use the SSN to verify customer identity
Availability of Private Data (ctd)
Prices for a CD or DVD of stolen data in Gorbushka
market, Moscow
• Cash transfer records from Russia’s central bank: $1,500
• Tax records, including home addresses and incomes: $215
• Mobile phone company’s list of subscribers: $43
• Name, birthday, passport number, address, phone number, 
vehicle description, and VIN for every driver in Moscow: $100
In Sao Paulo, Brazil, can buy a CD with full Brazilian tax 
records
• Due to the size of the required support infrastructure, tax 
records are fairly leaky in most countries
Availability of Private Data (ctd)
Some of this information is also available in places like the 
US
• $110 to locatecell.com buys a month’s worth of phone 
records
• Other sites sell similar information for $90-150
– Reputable firms work around problems in obtaining the 
information by farming it out to contractors and not asking 
questions
Information security by carriers to protect customer records is 
practically nonexistent and is routinely defeated
— Robert Douglas, privacy consultant
Availability of Private Data (ctd)
To see how dangerous this could get, a blogger tried 
buying the call records for Supreme Allied Commander 
of NATO (SACEUR), General Wesley Clark
• Cost $89.95 from celltolls.com
• Required only the cellphone number and a credit card number
• This seems to be explicitly permitted by US law
A provider […] may divulge a record or other information 
pertaining to a subscriber to or customer of such service […] 
to any person other than a governmental entity
— 18 USC 2702
– Intent was to allow sale for marketing purposes, but limit 
government intrusion
What Should I Do? (Non-geeks)
Put your head between your legs and …
What Should I Do? (Geeks)
Disable all Windows networking and RPC services (about 
2/3 of all Windows services)
• No noticeable effect on system usability
• Closes all ports
• Total Windows kernel memory usage should be ~100MB
• Need to hack the registry and other obscure things
Browse the web from a browser running on a locked-down 
Unix box with ‘nobody’ privileges
• Use a graphic-image-only forwarding protocol to view the 
result under Windows
• Use NoScript (or equivalent) set the maximum blocking
What Should I Do? (Geeks) (ctd)
Read mail on a locked-down Unix box using a text-only 
client that doesn’t understand MIME
Run all Internet-facing programs (Word, etc) under 
DropMyRights as ‘Guest’ or (standard, non-Power) 
‘User’
Conclusion
These aren’t script kiddies any more
• Their experts are as as good as anything we’ve got
More at http://www.cs.auckland.ac.nz/~pgut001