在乙abbix中，告警是由一系列的流程组成的，首先是触发器达到阈值，接下
来是Action对事件信息进行处理，其中包括两部分：第一部分是发送消息，即将
告警信息发送给用户；第二部分是执行命令，即将事件用命令进行处理，达到对
事件故障自动尝试恢复的效果。
Zabbix的告警流程如图6-1所示，具体可表示为：
UserGroups（用户组）→Users（用户）
告警
图6-1
Zabbix告警的配置步骤如下。
①设置 Trigger。
---
## Page 152
Zabbix企业级分布式监控系统
②配置用户。
③配置告警介质。
④设置Action。
6.2Trigger 的配置
通过前面的学习，我们知道Items 的作用是采集数据，而不是判断采集到的
数据是否属于正常值；Trigger的作用是对采集到的数据进行阈值状态的判断，触
发阙值，则会产生一个事件，同时，Action对达到条件的Trigger触发告警动作。
6.2.1Trigger的状态
Trigger的状态如表6-1所示。
表6-1
值
描述
OK
正常状态（老版本中是FALSE）
PROBLEM
有事件发生，例如，CPU负载过高（老版本中是TRUE）
Trigger的状态在Zabbix-Server每次接收到Items的新数据时，就会对Items
的值进行判断（和Trigger的正则表达式进行条件比较）。
对于Trigger中的时间函数nodata(、date、dayofmonthO、dayofweekO、timeO)
nowO，Zabbix-Server会每隔30s进行重新判断。
Items设置Trigger是非必需的，因为对某些采集数据，我们并不需要产生告警，
所以就不必配置Trigger。
Trigger 可以对临界值设置不同的 Trigger 安全级别。而对同一个Items，在
Trigger临界值不同的时候，设置多个不同安全级别的Trigger，就可以达到分故障
级别的告警。默认的模板中只有一个Trigger，当然，设置多个Trigger时，势必
会增加Zabbix-Server的负担，从而影响性能，但对关键的Items设置多个Trigger，
有实际使用需求的必要。
6.2.2Trigger的配置步骤
Trigger的配置是通过单击菜单栏中的Configuration→Hosts/template→
Triggers→Createtrigger来完成的。
这里以配置一个用户登录的触发器为例进行介绍，如图6-2所示。
136
---
## Page 153
第6章
告警配置
CONFIGURATION OFTRIL
Triggers
Displaying1to15of15found
Iemplate listTemplateIemplate OS Linu
Tnggers(15)
Graphs(5)
Sareens
SeverityName
图6-2
单击如图6-3所示的Createtrigger，
弹出如图6-4所示的窗口。
rs >Configuration of templates
Create trigger
Group Templates
Host Template OS Linux
[Hide disabled triagers 1
Screens(1)Discovery rules(2)Web scenarios(0)
Expression
Status
图6-3
Trigger
Name
Expression
Add
Expression constructor
MultiplePROBLEM
ration
Description
URL
SeverityNot classifiedInformationwarningAverage
Enabled
Save
Cancel
图6-4
在图6-4中单击“Add”按钮添加正则逻辑表示式，如图6-5所示。
 my-zabix-monitor tems - Google Ch
192.168.0.203/zabbix/popup.
192.168.0.203/
ohp?dstfm
Trios
nemorytotal
Item
Select
Number of loqqed in users
Function
Last (most recent）Tvalueis=N
Number of orocesses
Last of(（)）
Time
Number of runing processes
Time shit
Time
Processor load (1 min average per col
NO
uosu
图6-5
137
---
## Page 154
Zabbix企业级分布式监控系统
在Item下拉列表中选择Number of logged inusers，如图6-6所示。
my-zabbix-monitor: Condiion-Google Chrome
192.168.0.203/zabbix/popup_frexpr.php
ItemTemplate OS Linux:Num
berofloggedin
Function Last (most recent)Tvalueis=N
Last of（T）O
Time shift
Time
NO
Cancel
图6-6
填充到Item框中后，显示为灰色，如图6-7所示，选择下拉菜单。
192.168.0.203/zabbix/popup_trexpr.php
sloncondition
Item
TemplateOSL
Select
Function
Last(mostrecent）Tvalue is=N
Last of(T)
Time shift
Time
NO
asu
图6-7
注意，图6-7中的Function是触发器的函数表达式，其选项如图6-8所示。
e
一回x
or:Condition-GoogleChran
192.168.0.203/zabbix/popup_trexpr.php
Item
TemplateOs Linux:Numberof loggedinusers
Selet
Function
Last(mostrecent)Tvalue is >N
Last of(T)
DayofweekisN
图6-8
选择Last 函数，如图6-9所示。Last of 为时间，Time shift为时间偏移，N为
触发器的条件判断值，配置后的选项如图6-10所示。
138
---
## Page 155
第6章
告警配置
192.168.0.203/zabhix/popup_trexpr.php
ItemTemplateOS Linux:Number ofloggedinusers
Select
Function
Last(most recent)Tvalue is>N
Last of(T)0
Time shift
Time
N2
Inser!
Cancel
图6-9
Add
Expre
Description
URL
Severity
Notc
Disaster
Enabled
图6-10
添加 Trigger 的名称，如图6-11 所示。
CONFIGURATIONOFTRIGGERSS
Templatelist Template:TemplateOsLinuxApplicatons(10)Items(33） Triggers(15)Graphs（5) Screens(1）Dis
meUser login numbergt 2 on (HOST.NAME)
Nam
Expression{Template OS Linux:system.users.num.last()>>2Add
Description
Sevenity
Inf
HighDisaster
Enabled
图6-11
139
---
## Page 156
Zabbix企业级分布式监控系统
对图6-11中的配置属性说明如表6-2所示。
表6-2
参
数
描
述
Trigger的名称，可以支持宏（macros):{HOST.HOST}、{HOST.NAME}、HOST.CONN}、
{HOST.DNS}、{HOST.IP}、{ITEM.VALUE}、{ITEM.LASTVALUE}和{SMACRO}
$1，$2，,S9用于宏（macros）的第1、2、、9个参数
Name
注意：S1～$9参数会被解析为对应的值，例如，触发器的名称是“ProcessorloadaboveS1
将会在触发Trigger后变成“Processor load above 5onNewhost”
Expression
对触发器状态计算的逻辑正则表达式
当每一次事件达到“Problem”级别的时候，都会触发产生一个新的事件，该功能可用
Multiple
于需要对未解决的故障一直发送报警的监控项，其产生事件的时间周期为Items中的更新
PROBLEM
时间，如下图所示为数据更新的时间周期，则会每隔10s发送一次事件告警
events generation
Update interval (in sec)
10
Description
对触发器的描述，Zabbix2.2版本支持和触发器名字中使用的宏
如果不为空，可以在Monitoring→Triggers中看到URL的选项。一个可用的宏为
{TRIGGER.ID}，例如，这里的URL可以输入http://zabbix-guiitnihao.com/events.php？
triggerid={TRIGGER.ID}
Name
Events
URL
URL
History
Number of loggedin
users
则在告警信息中可以收到以下URL信息
Trigger:Number of logged inusers gt2
Trigger status:PROBLEM
Trigger severity:Not classified
Trigger URL:httpx//zabbx-gulitoihao.co
触发器的事件级别，可以根据这个级别设置多重告警
Not classified
未知安装等级
灰色
Information
般信息
亮绿
Severity
Warning
警告信息
黄色
Average
般故障
橙色
High
高级别故障
红色
Disaster
致命故障
亮红
Enabled
触发器的开关
140
---
## Page 157
第6章告警配置
6.2.3Trigger告警依赖
告警依赖是指一个事件的成立需要依赖另一个的事件存在。这种情况适合于
逻辑比较复杂的业务，例如，一个IDC的路由器出现故障时，机房内所有的机器
都会因为状态不可获取而产生告警，但作为管理人员，并不想同时接收所有的故
障告警，只需要接收到一条有效的告警“XXX的IDC机房路由器X发生故障，
将会影响整个机房的使用。”即可。
下面的示例（如图6-12、图6-13所示）是登录用户大于2，且磁盘1/0过高
时，可达到告警的触发条件。
TriggerDependencies
Name!
Number of logged in users gt 2
Expression
(Zabbix server:system.users.num.last,0)}>2
Add
图6-12
Trigger
Name
Action
uae-xqqez
Disk 1/O Isoveroaded on(HOST.NAME)
Remove
Ad
图6-13
配置后的界面如图6-14所示。
Number of logqed in
Not classified Depends on:
Zabbixagenton {HOST.N
图6-14
需要注意的问题是，如果勾选了MultiplePROBLEMevents generation选项，
则条件依赖会被忽略，从而会发送多重报警。
6.2.4Trigger正则中的单位
Trigger中所使用的单位符号如下。
S;seconds
m:minutes
h:hours
d:days
W:weeks
计量单位如下。
141
---
## Page 158
Zabbix企业级分布式监控系统
K:kilo
M: mega
G: giga
T: tera
P: peta
E: exa
Z:zetta
Y: yotta
例如，以下语句
(host:zabbix[proxy,zabbix_proxy,lastaccess])>120
(host:system.uptime[].1ast(0)}2m
(host:system.uptime.last(0) }:.())
举例如下：
(Zabbix server:agent.ping.nodata(5m) }=1
(Zabbix server:agent.version.diff(0)}>0
1. function
触发器函数的内容参考收集到的数据，用当前时间和其他因素共同完成数据
值判断。Web 界面的函数选择框如图6-15所示，在6.2.6节中，我们将对这些函
数进行详细介绍。
Day ofweek isN
Day ofweekisNOTN
oreviousvalu
ssiva
DifferencebetweenlastandpreviousvalueisNoTN
图6-15
142
---
## Page 159
第6章告警配置
2.function parameter
函数的形参（argument）指的是函数可以接收不同的参数。
在形参中，“#”在不同的函数中具有不同的含义，例如：
●sum(600)表示最近600秒内获取到的数值求和。
·sum(#5)表示最近获取到5个值的和。
·last(#5)表示返回给定的第5个值，时间最早的值为第一个。例如，给定值
3、7、2、6、5，last(#2)的值为7，last(#5)的值为5。
必须给函数指定一个参数，例如，last（0），即最后一次的值，0为参数。
avg、count、last、min 和max 支持在某个时间段之前的数据获取，例如，
avg(lh,1d)，表示 1 小时之前1天的平均值。
触发器表达式中使用支持单位符号，例如，5m'（分钟）代替300s'（秒），"15'
（天）代表'86400s’（秒）。
3.运算符
触发器支持的运算符（优先级渐降）如表6-4所示。
表6-3
优先级
运算符
含
1
整除（division）
2
*
乘（Multiplication）
3
-
减（Arithmeticalminus）
4
+
加（Arithmetical plus）
小于（Less than）运算符定义为：
5
>
A
A>B(A>=B+0.000001)
不等于（Notequal）运算符定义为：
7
#
A#B(A=B+0.000001)
等于（Isequal）运算符定义为：
8
A=B（A>B-0.000001)&（A5
143
---
## Page 160
Zabbix企业级分布式监控系统
{www.zabbix.com:system.cpu.load[all,avg1]给出了监控参数的名称。它指定服
务器是'www.zabbix.com'，Items是'system.cpu.load[all,avgl]’，使用函数"last('取最
近一次获取到的值，>5表示来自www.zabbix.com主机的最后负载值大于5时触
发器进入PROBLEM状态。
示例2：www.zabbix.com负载判断，语句如下。
(www.zabbix.com:system.cpu.load[all,avgl].last(0) }>51 (www.zabbix.
com:system.cpu.load[all,avgl].min(10m)}>2
负载大于5或者是最近10分钟的负载大于2，就会触发Trigger 进入
PROBLEM状态。
示例3：对文件/etc/passwd监控。
使用函数diff:
(www.zabbix.com:vfs.file.cksum[/etc/passwd].diff(0)}>0
当文件/etc/passwd之前的checksum值与最近的值不同时，则会触发Trigger
进入PROBLEM状态。
示例4：对网卡流量进行条件判断。
使用函数min：
{www.zabbix.com:net.if.in[eth0,bytes].min(5m)}>100K
当最近5分钟内eth0 接收的字节数大于100KB，则会触发Trigger 进入
PROBLEM状态。
示例5：两个SMTP服务器的集群节点都停止了。
注意，在一个表达式中使用两个不同的主机，语句如下。
(smtpl.zabbix.com:net.tcp.service[smtp].last(0)}=0&(smtp2.zabbix.
com:net.tcp.service[smtp].1ast(0) )=0
当SMTP服务器smtp1.zabbix.com与smtp2.zabbix.com都停止时，表达式为
真，则会触发Trigger进入PROBLEM状态。
这个示例也就是告警关联，对于避免误报具有很好的效果。
示例6：Zabbix客户端代理需要更新。
使用函数str():