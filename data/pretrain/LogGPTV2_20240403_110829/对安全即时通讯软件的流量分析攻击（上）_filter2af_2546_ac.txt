请注意，某些IM服务提供了其他形式的通信，例如状态消息，与工作中讨论的攻击无关。
###  B.数据收集
在本文中，在Telegram上收集了大量的IM数据。选择Telegram的原因有两个：首先，Telegram拥有大量公共频道，可以加入这些公共频道来收集实际的IM流量。这与大多数团体通信都是封闭/专用的其他流行IM服务不同。选择Telegram进行数据收集的第二个原因是，Telegram一直是最近尝试审查和监视的焦点，正如针对其他消息传递服务所演示的，分析和攻击绝非特定于Telegram。
使用Telegram的API来收集1,000个具有不同消息速率的随机信道的通信，每个消息信道持续24小时。对于每个收集的Telegram消息，提取发送过来的频道ID，时间戳，消息类型（文本，图片，视频，音频或文件）以及消息大小。Telegram用户每天可以加入的新频道数量限制为50个。因此会在几天内使用多个电报帐户进行数据收集（还请注意，每个电报帐户都必须与实际的手机号码绑定，以限制一个人可以创建的帐户数量）。
尽管选择Telegram来收集SIM卡流量，但注意到攻击算法在类似WhatsApp和Signal的其他SIM卡上的执行效果相似。这是因为这些服务均未实现流量混淆，因此，不同IM之间的流量形状相似。在下图中对此进行了说明，其中相同的消息流是通过四个不同的SIM服务发送的。可以看出，相同的消息会在不同的IM服务之间产生相似的流量模式。
###  C.IM通信建模
基于收集到的IM流量得出IM通信的统计模型，对IM流量的两个关键特征建模：消息间延迟（IMD）和消息大小。还对IM流量的通信延迟进行建模，使用最大似然估计（MLE）拟合每个特征的最佳概率分布。
**消息间延迟（IMD）：**
IMD功能是IM通信中连续IM消息之间的时间延迟。在模型中，合并使用非常小的IMD发送的消息（特别是，消息之间的间隔小于阈值te秒）。之所以这样做，是因为此类极其接近的消息在加密的IM流量中创建了一个合并的流量突发，该流量无法被流量分析攻击者分开。当管理员从另一组转发一批IM消息时，此类关闭消息（不常出现）出现，还过滤掉了很长的与深夜不活动时间相对应的IMD。
证明了使用MLE算法可以将IMD的概率密度函数紧密地拟合为指数分布。上图显示了200个IM频道的IMD的概率密度函数，每天的消息速率为130条消息。将IMD的指数行为解释为是由于以下事实：消息（或批消息）是在频道中独立发送的（请注意，对于交互式一对一聊天，这将有所不同）。另外认为IMD与消息的类型和大小无关，因为在实践中，消息的发送时间与其类型或大小之间没有关联。
**消息大小：**
上表显示了收集的IM消息中五种主要消息类型的大小统计信息和频率。使用这些经验统计数据来创建如下图所示的五状态马尔可夫链，以对IM通信流中发送的消息的大小进行建模。对于所有频道的聚集以及速率相似的频道组，获得了此马尔可夫模型的经验转移概率矩阵。可以看到具有不同每日消息速率的IM频道的过渡矩阵略有变化。
最后，下图显示了不同消息类型的归一化消息大小的互补累积密度函数（CCDF）（大小由每个类别的最大消息大小归一化），观察到不同的消息类型具有不同的消息大小分布。
**通信延迟：**
IM消息的传输延迟有两个原因：网络延迟和IM服务器的处理延迟。为了衡量此类延迟，使用Telegram的API从500个频道中收集了IM流量，每个频道持续一小时（因此，相当于500小时的IM流量）。然后设置了两个IM客户端，并在两个客户端之间发送收集的IM流量，以测量发生的通信延迟。使用MLE发现过渡延迟最适合拉普拉斯分布fµ,b(x)，其中µ是平均值，2b^2是延迟的方差。由于网络延迟不能为负，因此仅考虑拉普拉斯分布的正部分。下图显示了数据包延迟相对于最佳Laplace分布的分位数（Q-Q）图：
###  D.综合SIM流量
可以使用上述经验模型来创建综合IM通信。合成IM通信跟踪由具有特定大小，时间和消息类型的IM消息组成。这样的综合流量能够使用比在线收集的流量更多的流量样本来验证实验结果。
算法的输入是λ，即要合成的频道的消息率（每天），T是合成频道的长度。首先，该算法使用IMD的经验分布创建一系列IM消息时序。然后，算法将Markov模型用于消息类型，以便为序列中的每个消息分配类型。最后，对于每条消息，算法都使用相应消息类型的大小的经验分布来找到其大小。该算法的输出是一系列IM消息，其中每个消息都有一个时间戳，一个大小和一个消息类型。
由于流量合成算法使用样本IM跟踪来生成合成IM流量模式，因此通过增加其训练数据集的大小可以提高其合成流量的质量。或者，可以训练一个生成对抗网络以产生合成IM跟踪，将其留给以后的工作。
## 0x05 Conclusion
本文引入了流量分析攻击，可通过安全IM服务可靠地识别参与敏感通信的用户。要发起攻击，攻击者不需要与IM提供商合作，也不需要利用目标IM服务的任何安全漏洞。通过分析来自大量实际IM频道的IM流量，建立了用于常规IM通讯的统计模型。
在下一篇文章中对Telegram，WhatsApp和Signal的流行IM服务进行了广泛的实验，以证明攻击在野有效。同时研究了针对攻击的潜在对策，设计并部署了IMProxy，这是一个开源的，公开可用的对策系统。
IMProxy可用于所有主要的IM服务，而无需IM提供商的任何支持。
## Reference
[1]S. E. Coull and K. P. Dyer, “Traffic Analysis of Encrypted Messaging
Services: Apple iMessage and Beyond,” SIGCOMM CCR, 2014  
[2]K. Park and H. Kim, “Encryption is Not Enough: Inferring User Activities on
KakaoTalk with Traffic Analysis,” in WISA, 2015.  
[3]N. Unger, S. Dechand, J. Bonneau, S. Fahl, H. Perl, I. Goldberg, and M.
Smith, “SoK: Secure Messaging,” in IEEE S&P, 2015.  
[4]P. K. Aggarwal, P. Grover, and L. Ahuja, “Security Aspect in Instant Mobile
Messaging Applications,” in RAETCS, 2018.  
[5]M. Schliep, I. Kariniemi, and N. Hopper, “Is Bob Sending Mixed Signals?” in
WPES, 2017.  
[6]M. Nasr, A. Bahramali, and A. Houmansadr, “DeepCorr: Strong Flow
Correlation Attacks on Tor Using Deep Learning,” in CCS, 2018.  
[7]D. Kedogan, D. Agrawal, and S. Penz, “Limits of anonymity in open
environments,” in Information Hiding, 2002.  
[8]G. Danezis, “Statistical disclosure attacks,” in IFIP SEC, 2003.  
[9]Y.-C. Chang, K.-T. Chen, C.-C. Wu, and C.-L. Lei, “Inferring speech
activity from encrypted Skype traffic,” in GLOBECOM, 2008.  
[10]S. Chen, R. Wang, X. Wang, and K. Zhang, “Side-channel leaks in web
applications: A reality today, a challenge tomorrow,” in IEEE S&P, 2010.  
[11]R. Schuster, V. Shmatikov, and E. Tromer, “Beauty and the Burst: Remote
Identification of Encrypted Video Streams,” in USENIX Security,2017.