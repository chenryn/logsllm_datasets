针对域证书服务的攻击（2）- ESC2
0x00 前言
在ESC1的分析中我们遇到了一个问题，就是Certify这个工具带了2个DLL，很不方便，刚好今天看
twitter看到这么一个项目，https://github.com/CCob/dnMerge，使用NuGet搜dnMerge加入到项目
中，再release生成，就能编译成一个EXE了，很是简单。需要注意的就是只有release生成可以用，
debug是不能用的。
第二件事是一个题外话，我由于本地网络问题，我环境域控修改了IP，导致域中机器Ping域控域名的时
候返回127.0.0.1。这是我没有按照正规流程修改域控IP，细节看https://www.huaweicloud.com/article
s/a7f1f7d57357f9c62042707d09ae5f20.html，后面我按照正规流程修改，问题被修复。域中真的是不
能乱动，一点小改动就会出问题。这也是为什么域中很多就是默认设置，管理员不敢乱配置的原因吧。
回归今天的ESC2，ESC2和ESC1比较相似，大部分前提条件相同，具体条件如下：
低权限用户（我们这儿使用普通域用户）可以有权限注册证书
管理员审批被关闭
签名没有被要求认证
低权限用户可以使用危害模板
以上都是ESC1的条件，下面一条是和ESC1不同的：
证书模板被设置成Any Purpose EKU或者 no EKU
而在ESC1中开启CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT的要求就不需要了。
这种情况下我们能干什么呢？先搭建测试环境。
0x01 危害环境搭建
因为和ESC1的变化很小，因此我们直接复制ESC1模板，并改名为ESC2，然后修改应用程序策略为任何
目的
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-08 
No. 1 / 4 - Welcome to www.red-team.cn
然后把ESC1的使用者名称改回默认值。
0x02 利用测试
我们还是使用ESC1的测试步骤，这里就不详细截图了（不记得的同学可以翻看ESC1的测试）。结果可想
而知：
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-08 
No. 2 / 4 - Welcome to www.red-team.cn
由于我们使用者名称改回了默认值，即使在使用certify获取证书的时候使用了altname，并设定一个域
管理用户名。证书获取不会报错，但是这个证书并不能使用这个域管理登录，系统没有采纳altname的
值，而是使用当前用户win101709，如下图，“用Active Directory 中信息生成”。因此最后的结构就是
无法登录域控。
0x03 总结
所以这个ESC2，体感上作用太弱了。根据作者的描述，大致意思是，当使用Any Purpose的时候，表示
攻击者可以获取客户端认证、服务器认证、代码签名等等证书，换句话说就是能获取任何目的的证书。
然后作者就没说啥了，我想说这儿应该有个但是，但是TM的没有提权啊。不是说ESC都是提权么？我
win101709的用户权限没变啊，虽然由于错误配置，导致我这儿用户可以搞到各种证书，但是用户权限
没有变化。从ESC2被作者在06/22/21二次编辑修改过，我斗胆猜测是作者开始也搞错了，但是已经分类
成ESC2了就留着吧！最后作者补充道，我们可以使用这些证书干其他的事情比如在SAML, AD FS, or 
IPSec等网络服务上利用。具体在这些服务上能够出现什么利用场景，就需要大家挖掘了，ESC2总体来
说就是当前用户拥有了请求各种证书的能力，具体发挥场景还需要自己思考。
除Any Purpose以外，另外一个是no EKUs，就是应用程序策略为空。在为空的时候攻击可以签署一个
从属CA证书，在这个从属CA中，攻击者可以任意修改EKU和其他属性，但是这个从属CA证书默认是不
被信任的（也就是在NTAuthCertificates的cACertificate中没有这个从属证书），那么就没法登录域控。
最后感觉和Any Purpose一样，就是可以获取各种证书的能力。
总体来说这个ESC2有点扯淡。不过后面还有很多内容，说不定，后面有给出从属CA的利用场景。我们回
顾下ESC2和ESC1的区别就是使用者名称能不能自定义的问题，能自定义就能伪造成域管理员，因此这个
配置是能够提权的关键。
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-08 
No. 3 / 4 - Welcome to www.red-team.cn
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-08 
No. 4 / 4 - Welcome to www.red-team.cn