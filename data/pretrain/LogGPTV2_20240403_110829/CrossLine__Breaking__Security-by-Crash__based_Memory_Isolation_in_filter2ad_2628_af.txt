address and the output of the tweak functions. Wilke et al. [28]
further studied the Xor-Encrypt-Xor (XEX) mode of memory en-
cryption of AMD’s Epyc 3xx1 series processors, where the tweak
function XOR with the plaintext twice, both before and after the
encryption. However, the entropy of the tweak functions is only 32
bits, making brute-force attacks practical. It is demonstrated that the
adversary who breaks the tweak function can insert some arbitrary
2-byte instruction into encrypted memory with the help of 8MB
plaintext-ciphertext pairs. Fortunately, the XEX tweak function vul-
nerability exploited in the paper was fixed after Zen 2 architecture
that was released in May, 2019.
Unprotected nPT. Hetzelt and Buhren [10] demonstrated address
translation redirection attacks (an idea first explored by Jang et
Session 11A: Attestation and Firmware Security CCS ’21, November 15–19, 2021, Virtual Event, Republic of Korea2948Table 1: Demonstrated attacks against SEV. I/O Interaction: the attack requires interaction with applications inside the victim VM through
I/O operations (e.g., Network, disk). Stealthiness: the attack cannot be detected by the victim VM.
Research Papers
Du et al. [8]
Buhren et al. [6]
Wilke et al. [28]
Werner et al. [27]
Hetzelt & Buhren [10]
Morbitzer et al. [20]
Morbitzer et al. [19]
Li et al. [17]
Li et al. [16]
CrossLine V1
CrossLine V2
Exploited Vulnerabilities
Unauthenticated encryption
Unauthenticated encryption
Unauthenticated encryption
Unencrypted VMCB
Unencrypted VMCB
Unprotected PT
Unprotected PT
Unprotected PT
Unprotected I/O
Unauthenticated encryption
Ciphertext accessibility
Security-by-Crash
Security-by-Crash
Unencrypted VMCB
I/O Interaction
Breach
Confidentiality
Breach
Integrity
Stealthiness
Mitigated by
✓
✓
✓
✓
✓
✓
✓
✓
✓
✗
✗
✗
✓
✓
✓
✓
✓
✓
✓
✓
✓
✓
✓
✗
✓
✗
✓
✗
✗
✓
✗
✗
✓
✗
✗
✗
✗
✗
✗
✗
✗
✓
✓
✓
SEV-SNP
SEV-SNP
SEV-SNP
SEV-ES
SEV-SNP
SEV-SNP
SEV-SNP
SEV-SNP
Hardware Patch
SEV-SNP
SEV-ES
al. in the context of hardware-based external monitors [11]) in
SEV and discussed remapping guest pages in the nPT to replay
previously captured memory pages. This idea was later realized
by SEVered [19, 20], which manipulates the nPT to breach the
confidentiality of the memory encryption. More specifically, in the
SEVered attack, the hypervisor triggers activities of the victim VM’s
network-facing application and concurrently monitor its accesses
to the encrypted memory using a page-level side channel. In this
way, the hypervisor can determine the system physical page used to
store the response data. Then, by changing the memory mapping in
the nPT, the hypervisor tricks the guest VM to respond to network
requests from the target page, leaking secrets to the adversary.
Unprotected I/O. Li et al. [17] exploited unprotected I/O opera-
tions to construct encryption and decryption oracles that encrypts
and decrypts arbitrary memory with the victim’s VEK. As SEV’s
IOMMU hardware can only support DMA with hypervisor’s VEK,
a shared region within SEV VM called Software I/O Translation
Lookaside Buffer (SWIOTLB) is always needed for SEV I/O opera-
tions. SEV VM itself needs to copy I/O streaming from SWIOTLB
to its private memory when there are incoming I/O data; it needs
to copy I/O data to the SWIOTLB when there are outgoing I/O.
This design gives the hypervisor an opportunity to monitor and
alternate I/O streaming to build encryption and decryption oracles.
The paper also showed these unprotected I/O problems still exist
in SEV-ES.
Ciphertext accessibility. Li et al. [16] presents the first attacks
against SEV-SNP. Specifically, the Cipherleaks attack is a novel
side channel attack on SEV platform, in which the attackers con-
tinuously monitor the ciphertext changes in the VMSA region to
infer the internal register states. The Cipherleaks attack has been
applied on the state-of-the-art OpenSSL library to steal RSA private
key and ECDSA nonce. Microcode patches have been released to
mitigate the ciphertext side channels.
Summary. We summarize the attacks against SEV, their exploited
vulnerabilities, the attack consequences, and the stealthiness of the
attacks in Table 1. SEV-SNP can defeat all known attacks against
these design flaws, including unencrypted VMCB, unauthenticated
encryption, unprotected nPT, and unprotected I/O. However, as SEV-
SNP is not designed to mitigate ASID abuses and the CrossLine
attacks, while it prevents CrossLine V1 as it disallows nPT remap-
ping, we plan to further investigate other forms of CrossLine
against SEV-SNP in the future work.
8 CONCLUSION
In conclusion, this paper demystifies AMD SEV’s ASID-based isola-
tion for encrypted memory pages, cache lines, and TLB entries. For
the first time, it challenges the “security-by-crash” design philoso-
phy taken by AMD. It also proposes the CrossLine attacks, a novel
class of attacks against SEV that allow the adversary to launch
an attacker VM and change its ASID to that of the victim VM to
impersonate the victim. Two variants of CrossLine attacks have
been presented and successfully demonstrated on SEV machines.
They are the first SEV attacks that do not rely on SEV’s memory
integrity flaws.
ACKNOWLEDGEMENT
We thank David Kaplan and other engineers of AMD’s SEV team
for their valuable feedback and constructive suggestions, which
have helped improve this paper. This work was in part supported
by NSF Award 1750809, 1834213, and 1834216.
REFERENCES
[1] AMD. 2008. AMD-V Nested Paging. http://developer.amd.com/wordpress/media/
2012/10/NPT-WP-1%201-final-TM.pdf.
[2] AMD. 2019. Secure Encrypted Virtualization API Version 0.22.
[3] AMD. 2020. AMD SEV-SNP: Strengthening VM Isolation with Integrity Protection
and More. White paper (2020).
[4] AMD. 2020. AMD64 architecture programmer’s manual volume 2: System pro-
gramming.
[5] AMD. 2020. AMDSEV/SEV-ES Branch. https://github.com/AMDESE/AMDSEV/
tree/sev-es, commit = 969557455ee30f453da7d25af96291ea0236af77.
[6] Robert Buhren, Shay Gueron, Jan Nordholz, Jean-Pierre Seifert, and Julian Vetter.
2017. Fault Attacks on Encrypted General Purpose Compute Platforms. In 7th
ACM on Conference on Data and Application Security and Privacy. ACM.
[7] Claudio Canella, Daniel Genkin, Lukas Giner, Daniel Gruss, Moritz Lipp, Marina
Minkin, Daniel Moghimi, Frank Piessens, Michael Schwarz, Berk Sunar, et al. 2019.
Fallout: Leaking data on meltdown-resistant cpus. In ACM SIGSAC Conference
on Computer and Communications Security. 769–784.
[8] Zhao-Hui Du, Zhiwei Ying, Zhenke Ma, Yufei Mai, Phoebe Wang, Jesse Liu, and
Jesse Fang. 2017. Secure Encrypted Virtualization is Unsecure. arXiv preprint
arXiv:1712.05090 (2017).
Session 11A: Attestation and Firmware Security CCS ’21, November 15–19, 2021, Virtual Event, Republic of Korea2949[9] Google. 2020. Introducing Google Cloud Confidential Computing with Confiden-
tial VMs. https://cloud.google.com/blog/products/identity-security/introducing-
google-cloud-confidential-computing-with-confidential-vms.
[10] Felicitas Hetzelt and Robert Buhren. 2017. Security analysis of encrypted virtual
machines. In ACM SIGPLAN Notices. ACM.
[11] Daehee Jang, Hojoon Lee, Minsu Kim, Daehyeok Kim, Daegyeong Kim, and
Brent Byunghoon Kang. 2014. Atra: Address translation redirection attack against
hardware-based external monitors. In Proceedings of the 2014 ACM SIGSAC
Conference on Computer and Communications Security. 167–178.
[12] David Kaplan. 2017. Protecting VM register state with SEV-ES. White paper
[13] David Kaplan. 2020. Upcoming x86 Technologies for Malicious Hypervisor Pro-
tection. https://static.sched.com/hosted_files/lsseu2019/65/SEV-SNP%20Slides%
20Nov%201%202019.pdf.
[14] David Kaplan, Jeremy Powell, and Tom Woller. 2016. AMD memory encryption.
(2017).
White paper (2016).
[15] Paul Kocher, Jann Horn, Anders Fogh, Daniel Genkin, Daniel Gruss, Werner
Haas, Mike Hamburg, Moritz Lipp, Stefan Mangard, Thomas Prescher, et al. 2019.
Spectre attacks: Exploiting speculative execution. In 2019 IEEE Symposium on
Security and Privacy. IEEE, 1–19.
[16] Mengyuan Li, Yinqian Zhang, and Yueqiang Cheng. 2021. CIPHERLEAKS: Break-
ing Constant-time Cryptography on AMD SEV via the Ciphertext Side Channel.
In 30th USENIX Security Symposium. 717–732.
[17] Mengyuan Li, Yinqian Zhang, Zhiqiang Lin, and Yan Solihin. 2019. Exploiting
Unprotected I/O Operations in AMD’s Secure Encrypted Virtualization. In 28th
USENIX Security Symposium. 1257–1272.
[18] Moritz Lipp, Michael Schwarz, Daniel Gruss, Thomas Prescher, Werner Haas,
Anders Fogh, Jann Horn, Stefan Mangard, Paul Kocher, Daniel Genkin, et al. 2018.
Meltdown: Reading kernel memory from user space. In 27th USENIX Security
Symposium. 973–990.
[19] Mathias Morbitzer, Manuel Huber, and Julian Horsch. 2019. Extracting Se-
crets from Encrypted Virtual Machines. In 9th ACM Conference on Data and
Application Security and Privacy. ACM.
[20] Mathias Morbitzer, Manuel Huber, Julian Horsch, and Sascha Wessel. 2018.
SEVered: Subverting AMD’s Virtual Machine Encryption. In 11th European
Workshop on Systems Security. ACM.
AMD Security and Server Innovation.
UEFI
[21] AMD Roger Lai. 2013.
PlugFest-March (2013), 18–22.
[22] Michael Schwarz, Moritz Lipp, Daniel Moghimi, Jo Van Bulck, Julian Stecklina,
Thomas Prescher, and Daniel Gruss. 2019. ZombieLoad: Cross-privilege-boundary
data sampling. arXiv preprint arXiv:1905.05726 (2019).
[23] Hovav Shacham. 2007. The Geometry of Innocent Flesh on the Bone: Return-into-
libc Without Function Calls (on the x86). In 14th ACM Conference on Computer
and Communications Security. ACM.
[24] Teja Singh, Alex Schaefer, Sundar Rangarajan, Deepesh John, Carson Henrion,
Russell Schreiber, Miguel Rodriguez, Stephen Kosonocky, Samuel Naffziger, and
Amy Novak. 2017. Zen: An Energy-Efficient High-Performance X86 Core. IEEE
Journal of Solid-State Circuits 53, 1 (2017), 102–114.
[25] Jo Van Bulck, Marina Minkin, Ofir Weisse, Daniel Genkin, Baris Kasikci, Frank
Piessens, Mark Silberstein, Thomas F Wenisch, Yuval Yarom, and Raoul Strackx.
2018. Foreshadow: Extracting the keys to the intel SGX kingdom with transient
out-of-order execution. In 27th USENIX Security Symposium. 991–1008.
[26] Stephan van Schaik, Alyssa Milburn, Sebastian Österlund, Pietro Frigo, Giorgi
Maisuradze, Kaveh Razavi, Herbert Bos, and Cristiano Giuffrida. 2019. RIDL:
Rogue In-Flight Data Load. 2019 IEEE Symposium on Security and Privacy
(2019).
[27] Jan Werner, Joshua Mason, Manos Antonakakis, Michalis Polychronakis,
and Fabian Monrose. 2019. The SEVerESt Of Them All: Inference Attacks
Against Secure Virtual Enclaves. In ACM Asia Conference on Computer and
Communications Security. ACM, 73–85.
[28] Luca Wilke, Jan Wichelmann, Mathias Morbitzer, and Thomas Eisenbarth. 2020.
SEVurity: No Security Without Integrity–Breaking Integrity-Free Memory En-
cryption with Minimal Assumptions. 2020 IEEE Symposium on Security and
Privacy (2020).
Session 11A: Attestation and Firmware Security CCS ’21, November 15–19, 2021, Virtual Event, Republic of Korea2950