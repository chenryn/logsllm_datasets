##### 配置流选择器
使用流选择器根据条件将数据路由到不同的流。
(1)在"属性"面板的"常规"选项卡上，配置以下属性：
+---------------+------------------------------------------------------+
| **常规属性**  | **说明**                                             |
+===============+======================================================+
| 姓名          | 阶段名称                                             |
+---------------+------------------------------------------------------+
| 说明          | 可选说明                                             |
+---------------+------------------------------------------------------+
| [Required     | 必须包含要传递到阶段的记录的数据的字段。             |
| Fie           |                                                      |
| lds](https:// | 提示：您可以包括阶段使用的字段。                     |
| streamsets.co |                                                      |
| m/documentati | 不包括所                                             |
| on/datacollec | 有必需字段的记录将根据为管道配置的错误处理进行处理。 |
| tor/latest/he |                                                      |
| lp/datacollec |                                                      |
| tor/UserGuide |                                                      |
| /Pipeline_Des |                                                      |
| ign/DroppingU |                                                      |
| nwantedRecord |                                                      |
| s.html#concep |                                                      |
| t_dnj_bkm_vq) |                                                      |
+---------------+------------------------------------------------------+
| [Preconditi   | 必须计算为true才能允许                               |
| ons](https:// | 记录进入处理阶段的条件。单击添加以创建其他前提条件。 |
| streamsets.co |                                                      |
| m/documentati | 不满足所                                             |
| on/datacollec | 有前提条件的记录将基于为阶段配置的错误处理进行处理。 |
| tor/latest/he |                                                      |
| lp/datacollec |                                                      |
| tor/UserGuide |                                                      |
| /Pipeline_Des |                                                      |
| ign/DroppingU |                                                      |
| nwantedRecord |                                                      |
| s.html#concep |                                                      |
| t_msl_yd4_fs) |                                                      |
+---------------+------------------------------------------------------+
| [On Record    | 阶段的错误记录处理：                                 |
| Error         |                                                      |
| ](https://str | 丢弃-丢弃记录。                                      |
| eamsets.com/d |                                                      |
| ocumentation/ | 发送到错误-将记录发送到管道以进行错误处理。          |
| datacollector |                                                      |
| /latest/help/ | 停止管道-停止管道。                                  |
| datacollector |                                                      |
| /UserGuide/Pi |                                                      |
| peline_Design |                                                      |
| /ErrorHandlin |                                                      |
| g.html#concep |                                                      |
| t_atr_j4y_5r) |                                                      |
+---------------+------------------------------------------------------+
(2)在"条件"选项卡上，单击要为其创建的每个条件的"添加"图标。您可以使用简单或批量编辑模式添加条件。
每个新条件都会创建相应的输出位置。 您无法编辑或删除默认流的条件。
(3)输入每个输出位置的条件。
（可选）单击Ctrl +空格键以获取有关创建表达式的帮助。
#### Windowing Aggregator/窗口聚合
Windowing
Aggregator窗口聚合处理器在一个时间窗口内执行一个或多个聚合。Windowing
Aggregator处理器以监控模式显示结果，并可将结果写入事件记录。处理器不更新数据流中的记录。
您可以将聚合结果与Data
Collector数据警报一起使用以生成阈值通知。或者，您可以将事件写入数据存储，并使用第三方仪表板应用程序来可视化数据。
配置Windowing
Aggregator时，指定要使用的窗口类型和时间窗口。此信息确定处理器如何显示数据并生成事件。您还可以指定要使用的时区和要执行的聚合。
配置聚合时，指定聚合名称和显示标题以及要使用的聚合函数。您可以选择定义过滤器表达式以处理数据的子集，并按表达式分组以基于组进行聚合。
要将聚合结果写入事件，请启用事件生成，配置要创建的事件记录的类型，并可选择指定要使用的根字段的类型。有关数据流触发器和事件框架的一般信息，请参阅数据流触发器概述。
##### 窗口类型，时间窗口和信息显示
聚合窗口类型确定Windowing
Aggregator处理器用于计算聚合的时间窗口。它还确定处理器如何生成图表和事件。
时间窗口是指定窗口类型使用的时间段。时间窗口行为特定于您选择的窗口类型。
例如，当您配置具有一小时时间窗口的滚动窗口类型时，处理器使用每小时内通过处理器的记录在每小时执行聚合。
从概念上讲，使用滚动窗口，记录在窗口中是静态的。当记录成为特定时间窗口的一部分时，它们仍然存在。一旦完成时间窗的计算，它们也会保持静态。
相反，当您为滑动窗口类型选择一小时时间窗口时，聚合始终基于过去一小时内通过处理器的记录，定期更新计算。
从概念上讲，滑动窗口被锁定在当前时间，并且记录在窗口中滑动。已经移过窗口的记录不再是滑动窗口计算的一部分。
滚动窗口
使用滚动窗口时，Windowing
Aggregator处理器对在特定时间窗口内通过处理器的记录集执行聚合。使用滚动窗口生成通过管道的数据的定期历史分析。
滚动窗口不到一小时，时间窗口会根据该小时的开始而不是管道的开始时间递增。
例如，当您选择十五分钟的时间窗口时，聚合将每隔十五分钟计算一次，从该小时开始计算。因此，如果您在8:09开始管道，则第一个聚合发生在8:15，以下聚合发生在8：30,8：45,9：00，依此类推。实际上，如果您在8:01到8:14之间的任何地方启动管道，则聚合从8:15开始并每15分钟继续一次。
对于一小时或更长时间的滚动窗口，时间窗口基于当天的开始，在12:00 AM递增。
例如，当您选择六小时时间窗口时，聚合将在上午12点，上午6点，下午12点和下午6点计算。因此，如果您在上午10:10启动管道，则第一个聚合发生在下午12点，下一个聚合发生在下午6点，依此类推。
对于滚动窗口，处理器根据时间窗口和要记住的Windows时间数在监控模式下创建图表。例如，如果将属性设置为4，并使用15分钟的时间窗口，则生成的图表将显示四个15分钟的时间窗口。
处理器还根据时间窗口创建包含计算结果的事件。因此，在15分钟的时间窗口内，它会根据小时每15分钟生成一次事件。
请注意，由于上述原因，第一个事件的计算可能包括少于完整的记录时间窗口。类似地，管道停止时生成的最后一个事件可以包括具有少于完整时间窗口记录的计算。
滑动窗户
使用滑动窗口类型时，Windowing
Aggregator处理器在指定时间窗口内对最新记录集执行聚合。使用滑动窗口，时间窗口始终相对于当前时间。
滑动窗口不是像滚动窗口一样捕获计算历史，而是提供当前聚合集的更新。使用滑动窗口提供有关通过处理器的数据的实时信息。
例如，假设您配置了一个30秒时间窗口的滑动窗口。运行管道时，处理器将显示一个图表，其中包含过去30秒内通过处理器的记录中的信息。它会定期更新单个图表。
在监控模式下，所有时间窗口间隔的计算和结果图表每隔几秒更新一次。图表显示上次更新的时间。
生成事件时，处理器会根据指定的时间窗口定期生成事件，并在管道启动后立即开始。
例如，对于时间窗口为一小时的滑动窗口类型，处理器每分钟生成一次事件。因此，如果您在9:08启动管道，处理器将生成事件，计算结果从9:09开始，然后是9：10,9：11等。
请注意，计算的第一个小时的结果包含的数据少于指定的一小时时间窗口。在10:08，处理器提供第一个小时时间窗口的结果。在10:09，处理器包括计算中最后一小时的所有最新记录，丢弃在9:08和9:09之间到达的记录，因为它们已经超出了时间窗口。
下表描述了为每个滑动时间窗口生成事件记录的频率：
  -----------------------------------------------------------------------
  **Sliding Time Window**  **窗口事件生成\...**
  ------------------------ ----------------------------------------------
  1 minute                 从管道开始每5秒钟
  5 minutes                从管道开始每5秒钟
  10 minutes               从管道开始每10秒钟
  30 minute                从管道开始每30秒
  1 hour                   从管道开始每1分钟
  6 hours                  从管道开始每5分钟
  12 hours                 从管道开始每10分钟
  24 hours                 从管道开始每20分钟
  -----------------------------------------------------------------------
##### 计算组件
您可以使用以下组件配置要执行的计算：
1、聚合函数和表达式
选择要使用的聚合函数时，通常还会配置聚合表达式。
除COUNT函数之外的所有聚合函数都需要表达式。
例如，要确定时间窗口中所有事务数据的总销售额，可以将聚合函数设置为SUM（double）并使用以下表达式：
*\${record:value(\'/total\')}*
此表达式为时间窗口中的所有记录执行总字段的SUM。
2、过滤
配置过滤器以限制计算中使用的记录。过滤器是一个计算结果为布尔值的表达式。评估为true的记录包含在聚合中。
例如，以下过滤器确保仅处理具有已知信用卡类型的信用卡交易：
*\$ {record：value（\'/
transaction_type\'）=="credit"AND记录：value（\'/
cc_type\'）！="unknown"}*
使用此过滤器后，窗口聚合器不包括现金购买和未知信用卡类型。
3、按表达式分组
group by表达式是用于在执行计算之前对数据进行分组的表达式。使用group
by表达式为结果添加其他维度。
上述示例为信用卡类型已知的所有信用卡交易生成一笔金额。要通过信用卡类型减少该数字，您可以按表达式使用以下组：
*\${record:value(\'/cc_type\')}*
在执行聚合之前，此表达式按照cc_type字段中的不同值对数据进行分组，例如Visa或Mastercard。
有关聚合结果在监控模式下的显示方式的其他示例和信息，请参阅监控聚合。
##### 聚合函数
配置聚合时，选择要使用的聚合函数。
适当时，您可以选择要用于聚合结果的数据类型。
您可以使用以下聚合函数：
-   Avg (Integer or Double)
-   Count (Integer only)
-   Min (Integer or Double)
-   Max (Integer or Double)
-   StdDev (Integer or Double)
-   Sum (Integer or Double)
##### 事件生成
Windowing Aggregator处理器可以生成包含聚合结果的事件。
处理器可以生成包含所有聚合结果的事件。
它还可以为每个单独聚合的结果生成事件。
Windowing Aggregator处理器事件可以以任何逻辑方式使用。 例如：
-   使用目的地存储事件信息。
-   使用数据警报发送通知：可以在事件流上配置数据警报，以在达到指定阈值时通知。
-   使用电子邮件执行程序在收到活动后发送自定义电子邮件。
事件记录根字段
默认情况下，Windowing
Aggregator处理器通过将记录数据作为JSON字符串写入String根字段来生成事件记录。
您可以将处理器配置为通过将JSON数据写入Map根字段来生成事件记录，就像其他事件记录一样。
两种记录格式都提供相同的数据。在同一管道中使用事件记录执行其他处理时，使用Map根字段应该更有效。
将事件记录写入目标而无需额外处理时，使用String根字段应该更有效。
选择更适合您的用例的选项。在"事件"选项卡上使用"生成事件记录和文本字段"属性指定要使用的根字段。
事件记录
Windowing Aggregator处理器生成的事件记录具有以下与事件相关的记录头属性。
记录头属性存储为String值：
+----------------------------+-----------------------------------------+
| **Record Header            | **说明**                                |
| Attribute**                |                                         |
+============================+=========================================+
| sdc.event.type             | 事件类型。 使用以下事件类型之一：       |
|                            |                                         |
|                            | \ .window.aggregator -    |
|                            | 包含单个聚合的结果。                    |
|                            |                                         |
|                            | 例如，对于一个滚动窗口聚合              |
|                            | ，事件类型为rolling.window.aggregator。 |
|                            |                                         |
|                            | \                         |
|                            | .window.all.aggregators -               |
|                            | 包含所有已配置聚合的结果。              |
|                            | 处理器                                  |
|                            | 配置为在一个事件中包含所有聚合时生成。  |
|                            |                                         |
|                            | 例如，对于一组滑动窗口聚合，事件        |
|                            | 类型为sliding.window.all.aggregators。  |
+----------------------------+-----------------------------------------+
| sdc.event.version          | 整数，指示事件记录类型的版本。          |
+----------------------------+-----------------------------------------+
| sd                         | 阶段创建事件时的纪元时间戳。            |
| c.event.creation_timestamp |                                         |
+----------------------------+-----------------------------------------+
Windowing Aggregator处理器可以生成以下事件记录：
1、单个聚合事件
您可以配置Windowing
Aggregator处理器以创建单个聚合事件。每个事件都包含单个聚合的结果。也就是说，当您将处理器配置为生成单个聚合事件时，处理器会在每次处理器执行计算时生成一组事件。事件生成的频率取决于所选的窗口类型和时间窗口。
例如，如果您的处理器配置了三个聚合，并且滚动时间窗口为十分钟，并且您启用了单个聚合事件，则Windowing
Aggregator处理器每十分钟生成三个单个聚合事件。
处理器还在管道停止时生成事件，以提供最终时间窗口的结果。此最终事件很可能是一个不完整的时间窗口，可能会产生意外的聚合结果。
您可以根据每个事件的时间值之间的差异来评估时间窗口是否完整。
例如，假设您希望聚合每30秒发生一次，并且与事件记录关联的时间为：1511295390,1511295420和1511295440。您可以评估最后一个事件是20秒时间窗口而不是30秒时间窗口，可能是因为管道停止而发生的。
要生成单个聚合事件，请配置以下两个属性：
-   在"常规"选项卡上，选择"生成事件"。
-   在"事件"选项卡上，选择"每个聚合器事件"。
单个聚合事件将sdc.event.type设置为\
.window.aggregator并包含以下字段：
+-------------+--------------------------------------------------------+
| **Event     | **Description**                                        |
| Record      |                                                        |
| Field**     |                                                        |
+=============+========================================================+
| name        | 阶段中定义的聚合名称。                                 |
+-------------+--------------------------------------------------------+
| time        | 计算发生和事件生成的纪元时间。                         |
+-------------+--------------------------------------------------------+
| a           | 包含用于执行聚合的信息的映射字段。                     |
| ggregatable | 当聚合不包括按表达式分组时，映射包括以下字段：         |
|             |                                                        |
|             | •name - 阶段中定义的聚合名称。                         |
|             |                                                        |
|             | •type -                                                |
|             | 聚                                                     |
|             | 合类型，例如Avg（整数）聚合函数的LongAvgAggregatable。 |
|             |                                                        |
|             | •\ -                                    |
|             | 基于聚合中使用的聚合函数的附加信息。                   |
|             |                                                        |
|             | 当聚合包括按表达式分组时，可聚合字段列出每个组。       |
|             | 每个组字段包括上述字段。                               |
+-------------+--------------------------------------------------------+
下表描述了可以根据聚合中使用的聚合函数包含在事件记录中的其他字段：
+-------------------+--------------------------------------------------+
| **Aggregate       | **附加字段**                                     |