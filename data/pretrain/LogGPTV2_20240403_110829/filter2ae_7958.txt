# 【技术分享】针对联网智能灯泡的安全性分析

## 译文声明
本文为翻译文章，原文来源于contextis.com。具体内容和含义请以原文为准。
- 译者：[blueSky](http://bobao.360.cn/member/contribute?uid=1233662000)
- 预估稿费：200 RMB
- 投稿方式：发送邮件至linwei#360.cn，或登录网页版在线投稿

## 前言
本文主要讨论LIFX智能灯泡的安全性。LIFX是一款可以通过Wi-Fi控制的节能、多色显示的智能灯泡，支持Android和iOS手机应用控制。我们选择研究这款产品，是因为它采用了新兴的无线网络协议和技术，并且其市场推广方式引起了我们的兴趣。

2012年9月，LIFX项目在Kickstarter众筹平台上启动，并迅速获得了投资者的支持，筹集的资金超过原始目标的13倍。

LIFX灯泡通常需要连接到Wi-Fi网络，以便通过智能手机应用程序进行控制。在多个灯泡组成的系统中，只有一个灯泡（称为“主”灯泡）直接连接到Wi-Fi网络。这个主灯泡接收来自智能手机应用的命令，并通过802.15.4 6LoWPAN无线网络将命令广播给其他灯泡。

如果主灯泡关闭或与Wi-Fi网络断开连接，系统会自动从剩余灯泡中重新选择一个作为新的主设备，并使其连接到Wi-Fi网络。这种架构的优点在于，非主灯泡在不亮时可以以低功率运行，同时扩展了灯泡网络的覆盖范围，减少了Wi-Fi网络的拥塞。

由于LIFX灯泡使用的新无线通信协议、mesh网络结构和主/从通信方式吸引了黑客的关注，我们开始了对LIFX固件1.1版本的研究和分析。自向LIFX报告研究结果后，该公司已升级固件至1.2版本。

## 开启攻击之旅
LIFX灯泡网络中的核心通信组件包括：
1. 智能手机到灯泡的通信
2. 灯泡与Wi-Fi的通信
3. 灯泡之间的网络通信

初始阶段的主要挑战是新技术和理论知识带来的复杂性。我们决定从802.15.4 6LoWPAN无线mesh网络入手，查看其是否存在漏洞，特别是如何在6LoWPAN mesh网络之间共享Wi-Fi网络凭证。

6LoWPAN是一种基于IEEE 802.15.4标准构建的无线通信规范，允许通过低功耗个人局域网（PAN）转发IPv6数据包。为了监控和注入6LoWPAN流量，我们使用了安装了Contiki 6LoWPAN固件镜像的ATMEL AVR Raven设备，该设备提供了一个标准的网络接口，用于监控和注入网络流量到LIFX mesh网络。

## 协议分析
通过上述网络接口，我们可以监控并将网络流量注入到LIFX mesh网络中。观察发现，LIFX网络在很大程度上未加密，因此我们可以轻松解析其网络协议，并构造消息来控制灯泡并重放任意数据包的有效载荷。

通过添加新灯泡并监控捕获的数据包，我们能够识别出关于Wi-Fi网络凭证的具体数据包。整个新灯泡加入过程包括：主灯泡在网络上广播新灯泡加入信息；新灯泡响应主灯泡的广播并请求传输Wi-Fi凭证细节；主灯泡通过mesh网络广播加密的Wi-Fi凭证细节，并将新灯泡添加到LIFX智能手机应用程序中的可用灯泡列表中。

通过对捕获的数据包进行分析，我们发现Wi-Fi详细信息（包括凭证）是加密传输的。我们可以在mesh网络中注入数据包以获取Wi-Fi详细信息，而不会触发任何警报。为了进一步攻击，我们需要分析其使用的加密机制。

## 获取固件
我们首先尝试从供应商网站下载LIFX设备的固件，但由于LIFX设备刚上市，供应商尚未发布可分析的固件。因此，我们只能自己获取LIFX设备的固件。

为了提取固件，我们首先需要物理访问嵌入式微控制器。这涉及拆解LIFX设备，获取印刷电路板（PCB）。分析PCB后，我们发现该设备主要由两个片上系统（SoC）集成电路组成：德州仪器CC2538负责6LoWPAN网络通信，STMicroelectronics STM32F205ZG负责Wi-Fi端通信。这两个芯片均基于ARM Cortex-M3处理器，并具有完整的JTAG引脚功能。

确定每个芯片的正确JTAG引脚并准备好连接后，我们使用开源的BusBlaster JTAG调试器和OpenOCD调试器配置硬件和软件，从而向芯片发出JTAG命令。此时，我们可以快速转储每个芯片的闪存并开始逆向分析固件。

## 逆向分析固件
我们有两个二进制固件blob，需要识别哪个固件负责存储和加密Wi-Fi凭证。通过映像上的字符串，我们确定Wi-Fi凭证存储在LIFX LWM-01-A芯片的固件映像中。

将固件映像加载到IDA Pro中，我们通过查找常见的加密常量（如S-Boxes、Forward and Reverse Tables和Initialization Constant）来识别加密代码，最终确定芯片中使用的是AES加密算法。由于AES是对称加密算法，加密密钥和解密密钥相同。通过分析发现，在LIFX设计中，每个设备都使用一个固定的全局密钥。因此，如果我们从一个设备中获取密钥，就可以使用相同的密钥解密所有其他设备发送的消息。

在这种情况下，密钥可用于解密从任何LIFX灯泡发送的加密消息。通过逆向分析定位到的加密函数，我们提取了加密密钥、初始化向量以及块模式。最后一步是使用提取的密钥解密从网络中嗅探到的Wi-Fi凭证，以验证提取的加密密钥是否正确。

## 组合攻击
掌握了加密算法、密钥、初始化向量以及对mesh网络协议的理解，我们可以将数据包注入到mesh网络中，捕获Wi-Fi详细信息并解密凭证，而不会引起LIFX设备的任何身份验证或警报。因此，我们成功实现了攻击。

需要注意的是，这种攻击需要攻击者在易受攻击的LIFX灯泡的无线覆盖范围内（约30米），这限制了大规模利用的可能性。

## 修复建议
在发现该漏洞后，我们及时通知了LIFX公司，并协助其完成了漏洞修复和其他安全改进措施。现在，新固件使用从Wi-Fi凭证导出的加密密钥来加密所有的6LoWPAN流量，并包括了确保新灯泡安全加入Wi-Fi网络的安全功能。

当然，对于任何物联网设备，无论是手机、笔记本电脑还是灯泡，黑客总是有机会将其劫持。我们将在后续博客中介绍更多有关劫持物联网设备的技术文章。