rw
rw
req
pgcluster pgcluster
IPC
IPC req req
r r
postmaster postmaster
Shared disk
PGCon 2007
Semaphore
TToo LLoocckk ccoonnttrrooll
HHooww mmaannyy sseemmaapphhoorreess aarree uussiinngg??
Depends on the “max­connections”setting
By default, 7 x 16 semaphores are used.
MMaappppiinngg ttaabbllee iiss rreeqquuiirreedd
Semid = 100 to LOCK Semid = 80 to LOCK
Semid sem_num index Semid sem_num index
2/15 LOCK
99 2 14 79 2 14
100 2 15 80 2 15
PGCon 2007
Shared Memory
CCoommmmuunniiccaattee dduurriinngg eeaacchh bbaacckkeenndd pprroocceesssseess
SSttoorree ddaattaa ooff llooggss,, ccaacchheess,, bbuuffffeerrss aanndd ssoo oonn
SSiinnggllee sshhaarreedd mmeemmoorryy iiss aallllooccaatteedd
But it is divided a number of peaces
more than 100 entry pointer are existing.
PGCon 2007
Shared Memory usage
90%
of usage
BufferBlocks
is
ShmemVariableCache" LWLockArray ShmemIndex newSpace
newSpace ControlFile XLogCtl CLOG Ctl"
SUBTRANS Ctl TwoPhaseState MultiXactOffset Ctl MultiXactMember Ctl
BufferDescriptors BufferBlocks Shared Buffer Lookup newSpace
Table
StrategyControl LOCK hash newSpace PROCLOCK hash"
newSpace ProcGlobal DummyProcs newSpace
procs ProcStructLock procArray BackendStatusArray
shmInvalBuffer FreeSpaceMap Free Space Map Hash newSpace
FreeSpaceMap->arena" PMSignalFlags BgWriterShmem btvacinfo
PGCon 2007
Issues of Shared Memory
AAccttiivviittyy iissssuuee
Size is not big but update frequency is very high
CCoonntteennttss iissssuuee
It is including memory address it self
If copy shared memory to other server, other DB
server may be crashed.
Address Data Type Label Address Data Type Label
&1000 &1004 Char * Data &2000 &1004 Char * Data
&1004 1 OID Oid &2004 1 OID Oid
&1008 &1012 Char * Next &2008 &1012 Char * Next
&1012 &1024 Char * Data &2012 &1024 Char * Data
PGCon 2007
Solution
AAllll aaddddrreessss ddaattaa sshhoouulldd nnoott ccooppyy
Copy mask table is required
AAllll aaddddrreessss ddaattaa sshhoouulldd ttrraannssllaattee ttoo eeaacchh llooccaall
aaddddrreessss
Data address Offset is required in each address
data
PGCon 2007
Mask & Transrate Sequence
Address Data Type Label
&1000 ‘+12’ Int data_offset
Address offset added
&1004 ‘+20’ Int next_offset
&1008 &1012 Char * Data
&1012 1 OID Oid Address data masked
&1016 &1020 Char * Next
&1020 ‘+32’ Int data_offset
Copy with mask
Change offset
to local address
Address Data Type Label Address Data Type Label
&2000 ‘+12’ Int data_offset &2000 ‘+12’ Int data_offset
&2004 ‘+20’ Int next_offset &2004 ‘+20’ Int next_offset
&2008 Char * Data &2008 &2012 Char * Data
&2012 1 OID Oid &2012 1 OID Oid
&2016 Char * Next &2016 &2020 Char * Next
&2020 ‘+32’ Int data_offset &2020 ‘+32’ Int data_offset
PGCon 2007
Shared Disk
EEaacchh nnooddee sshhaarreess aallll ddbb cclluusstteerr
base/, global/, pg_clog/, pg_multixact/,
pg_subtrans/, pg_tblspc/, pg_twophase/, pg_xlog/
EEaacchh nnooddee hhaass oowwnn ccoonnffiigguurraattiioonn ffiilleess
pg_hba.conf, pg_ident.conf, postgresql.conf,
pgcluster.conf
EEaacchh nnooddee sshhoouulldd hhaavvee ssaammee sseettuupp vvaalluueess
Connections (max_connections)
Resource usage(memory, Free Space Map)
PGCon 2007
pgcluster.conf
PPggcclluusstteerr ttaabbllee ddeessccrriippttiioonn
Hostname/IP & port
Multiple servers can be described
Top described server may be master.
SSeellff nnooddee ddeessccrriippttiioonn
hostname/IP & port
Only one node can be described
PGCon 2007
Startup sequence
Node1 Node2
Postgres Pgcluster Pgcluster Postgres
Start up
Create SEM
Create SHM
Begin req
Search other nodes
Create node table
Begin ans Start up
Listen Create SEM
Create SHM
Begin req
Search other nodes
Sync req
Add new node
Send SEM
Sync SEM req
Copy SEM
Sync SEM ans
Send SHM
Sync SHM req
Copy SHM
Sync SHM ans
Send node table
Sync SYS req
Copy node table
Sync SYS ans
Sync SEM ans
Begin ans
Listen
PGCon 2007
IPC sync sequence
Node1 Node2
Postgres Pgcluster Pgcluster Postgres
Write IPC call
Replicate IPC req
Search other nodes
Write IPC Execute IPC req
Write IPC
Execute IPC ans
Replicate IPC ans
Write IPC done
Write IPC call
Replicate IPC req
Search other nodes
Replicate IPC req
Search other nodes
Write IPC
Execute IPC req
Write IPC
Execute IPC ans
Replicate IPC ans
Replicate IPC ans
Write IPC done
PGCon 2007
Stop sequence
Node1 Node2
Postgres Pgcluster Pgcluster Postgres
exit_proc()
Stop req
Search other nodes
End req
Update node table
End ans
Stop ans
Delete IPC
exit_proc()
Stop req
Search other nodes
End req
Update node table
End ans
Stop ans
Delete IPC
PGCon 2007
As a result
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
Pros & Cons
RReeqquuiirreedd llaarrggee RRAAMM..
EEaassyy ttoo aadddd aa nnooddee ffoorr
rreedduunnddaannccyy // rreeppllaaccee..
DDaattaa wwrriittiinngg ddooeess nnoott
bbeeccoommee ffaasstt bbyy aaddddiinngg
DDaattaa wwrriittiinngg
nnooddee..
ppeerrffoorrmmaannccee ddooeess nnoott
ssllooww bbyy aaddddiinngg nnooddee..
WWrriittiinngg ppeerrffoorrmmaannccee
iiss nnoott ggoooodd..
BBiigg iimmpprroovvee ttoo ddaattaa
rreeaaddiinngg // mmaannyy
NNootthhiinngg eexxppaannddss
ccoonnnneeccttiioonn llooaadd..
except CPU & network I/O
CCoosstt
Shared disk
PGCon 2007
Possibility
SSuuiittaabbllee ppllaaccee
It will be one of solutions the system which has high
CPU load and network load.
Most of WEB system, a part of the Online Transaction
●
Processing(OLTP) system
CCoommbbiinnaattiioonn ooff PPGGCClluusstteerr­­IIII aanndd ppggppooooll­­IIII
PGCluster­II might get performance with large data.
PGCon 2007
From now
IInnttrroodduuccttiioonn
RReeqquuiirreemmeenntt
PPGGCClluusstteerr
NNeeww RReeqquuiirreemmeenntt
PPGGCClluusstteerr­­IIII
SSttrruuccttuurree aanndd PPrroocceessss sseeqquueennccee
PPrrooss && CCoonnss
CCoonncclluussiioonn
PGCon 2007
TODO
PPeerrffoorrmmaannccee sshhoouulldd mmoorree iimmpprroovvee..
Some write (and erase) memory data is not need
to sync.
The conversion methods (from offset to local
address) should improve.
RReelleeaassee ssoouurrccee ccooddee
ASAP
DDooccuummeennttaattiioonn aass wweellll
PGCon 2007
Thank you
AAsskk uuss aabboouutt PPGGCClluusstteerr
pgcluster­PI:EMAIL
AAsskk mmee aabboouutt PPGGCClluusstteerr­­IIII
PI:EMAIL
YYoouu ccaann ddoowwnnllooaadd tthhiiss sslliiddee ffrroomm
http://pgfoundry.org/docman/?group_id=1000072
PGCon 2007