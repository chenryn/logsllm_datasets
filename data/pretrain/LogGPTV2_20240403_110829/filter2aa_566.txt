# Windows 安全 - 服务篇（1）

## 0x00 前言
Windows安全是一个广泛的领域，我仅是一名在学习路上的探索者。通过边学边记的方式，我希望不仅能够提升自己的知识水平，还能与同行者共同探讨和进步。本系列文章将从Windows服务的基础机制开始，逐步深入到相关安全问题，并记录下我在学习过程中的思考和延伸研究。在此过程中，许多知识来源于网络公开文献及《深入理解Windows操作系统7》上下册。

### Windows服务架构简图
从简图可以看出，Windows服务的核心组件并不复杂。用户通常通过如`sc.exe`等SCP类程序来控制服务应用，但这种控制并非直接进行，而是通过服务控制管理器（SCM）间接实现的。

## 0x02 基础组件
根据上图所示，服务的核心组件包括：服务应用、服务控制程序（SCP）和服务控制管理器（SCM）。接下来我们将逐一了解这些核心组件。

### 1. 服务应用
服务应用即是我们开发的可执行程序。与普通可执行程序相比，服务应用增加了接收SCM发送命令并返回当前状态的功能。通常情况下，服务应用没有用户界面，属于后台运行的应用程序。例如，在使用CobaltStrike生成植入体时，存在两种类型的Windows可执行文件，其中之一就是专门用于创建服务的服务可执行程序。如果尝试使用不具备与SCM通信能力的普通程序作为服务启动，则会导致服务启动失败；不过可以通过`cmd.exe /c "xxx.exe"`的方式绕过此限制，使非服务程序得以运行。需要注意的是，被调用的`xxx.exe`不能包含图形界面，否则会因为会话隔离机制而无法正常工作。
  
服务应用运行于服务进程之中，一个进程中可以同时存在多个服务实例，因此服务进程分为独占型和共享型两种类型。

### 2. 服务控制程序 (SCP)
常见的SCP工具包括`sc.exe`和`services.msc`，它们底层实际上都调用了相同的API接口。SCP主要负责与SCM之间的交互，可以将其视为SCM的客户端。通过一系列API调用，SCP能够间接地对服务进程实施控制。这些API大部分位于`Advapi32.dll`库中（如`CreateService`），但也有一部分存在于`Sechost.dll`内。因此，除了使用图形化工具或命令行工具外，我们还可以直接编写代码调用来实现更复杂的操作。

用于管理SCM服务的主要函数有：`CreateService`, `OpenService`, `StartService`, `ControlService`, `QueryServiceStatus`, `DeleteService`等。在调用上述任何功能之前，需要先利用`OpenSCManager`获取SCM句柄。然而，并非所有用户都有权限执行该操作，权限不足时可能会遇到类似“OpenSCManager error 5”的错误提示，特别是在尝试以类似于PsExec的方法进行横向渗透时尤为常见。

### 3. 服务控制管理器 (SCM)
SCM是整个Windows服务体系中最关键的部分，它直接与服务进程通信并对后者实施实际控制。其可执行文件位于`%SystemRoot%\System32\Services.exe`路径下，并且会在系统启动初期自动加载。有关SCM启动流程及其如何触发其他服务启动的具体细节，请参阅《深入理解Windows操作系统7》下册第446-447页（注：目前仅有英文版本可供参考）。

## 0x03 总结
本文档采用半笔记形式撰写，旨在分享个人见解而非详尽无遗地覆盖每一个技术细节。鉴于Windows服务在红队行动中的广泛应用价值，深入了解其运作原理对于提高技术水平至关重要。

Produced by AttackTeamFamily - Author: L.N. - Date: 2022-04-06  
No. 2 / 2 - Welcome to [www.red-team.cn](http://www.red-team.cn)