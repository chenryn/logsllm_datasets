Windows 安全 - 服务篇（1）
0x00 前言
Windows安全范围真的很大，我也仅仅是在学习路上的行人。边学边记，在自己学习的同时，也希望有
一起的同行者。我计划从Windows服务开始，先学习windows服务的基础机制，然后再学习相关的安全
问题，然后记录这个过程中自己的一些思考，或延申性研究。这个过程中当然大量知识来自于网络公开
文献和《深入理解Windows操作系统7 》上下册。
Windows服务架构简图：
从简图看Windows服务的核心组件并不复杂，用户通常通过SCP类程序，例如：sc.exe等，来控制服务
应用。但是他并不是直接控制的，中间是通过SCM来控制的。
0x02 基础组件
通过上图，我们知道服务的核心组件有3个，分别是：服务应用、服务控制程序（SCP）、服务控制管理
（SCM），我们先学习下这3个核心组件。
1. 服务应用
服务应用很好理解，就是我们开发的可执行程序。和通常的可执行程序不同，服务可执行程序比普通可
执行程序多了接收SCM发送的命令的代码，并返回给SCM，服务当前的状态。通常服务可执行程序没有
用户接口，是终端程序。说到这儿，大家用过CobaltStrike就会发现生成植入体的时候，CS有2种
windows可执行程序，其中就有Service可执行程序，专门用作创建服务时使用。也就是说，你创建服务
时候填入的可执行程序和普通可执行程序是不同的，普通程序没有和SCM通讯的代码，会导致服务启动
失败，但是可以使用cmd.exe /c "xxx.exe"的方式来执行非服务可执行程序，这样在服务启动的时候
cmd.exe由于不能和SCM通信，进程会被终止，但是其子进程xxx.exe不会被终止，依旧执行。这儿需要
注意的是xxx.exe不能是有用户接口的程序，例如：calc.exe这样的程序，需要是终端程序。这是什么原
因呢？这个和session隔离有关，后面说。
服务应用是运行在服务进程当中的，一个服务进程中可以有多个服务应用，因此服务进程分为独占型和
分享型。
Produced by AttackTeamFamily - Author: L.N. - Date: 2022-04-06
No. 1 / 2 - Welcome to www.red-team.cn
2. 服务控制程序（SCP）
服务控制程序，我们用的比较多的是sc.exe和services.msc，他们底层其实调用的都是相同的API。SCP
主要和SCM通信，如果把SCM比作一个服务端，SCP就是它的客户端。scp通过scm间接的去控制服务进
程。SCP其实就是一系列和SCM通信的API，这些API一部分在Advapi32.dll中，例如：CreateService。
Advapi32.dll中只是一小部分API，大部分API还是在Sechost.dll中，Advapi32.dll中很多api都是封装的
Sechost.dll。因此我们想控制Windows服务，除了用services.msc这种交互式方式或者sc.exe这种命令
行的方式以外，还可以直接调用API自己实现相关程序。
SCP用于管理SCM服务的函数有：CreateService、OpenService、StartService、ControlService、
QueryServiceStatus、DeleteService。在使用这些函数管理SCM服务前，需要使用OpenSCManager函
数打开SCM句柄。当然不是谁都能使用OpenSCManager打开SCM句柄的，是需要权限的。看到这儿，
有经验的同学应该遇见过OpenSCManager error 5，这样的错误，特别是在使用类psexec方式进行横向
移动的时候。这个错误的原因就是权限不够，使用OpenSCManager不能打开SCM的服务句柄，也就不
能对服务进行操作。
3. 服务控制管理（SCM）
SCM是Windows服务最核心的部分，它直接和服务进程通信，它是服务真正的控制者。下图能够很好的
表示它和服务进程的通信状态：
SCM的可执行文件时%SystemRoot%\System32\Services.exe。在系统启动阶段SCM就启动了。SCM启
动的详细流程以及SCM如何控制其他服务启动的方式均在《深入windows操作系统7》下册的446-447页
（ps:目前只有英文版）。
0x03 总结
这个系列文档大多比半笔记的形式编写，因此有点想到哪儿写到哪儿，不会扣每一个细节。Windows服
务的相关利用在红队中非常常见，很多技术都有涉及，时非常有必要深入了解和学习的。
Produced by AttackTeamFamily - Author: L.N. - Date: 2022-04-06
No. 2 / 2 - Welcome to www.red-team.cn