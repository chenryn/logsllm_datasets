# “乱世”木马家族分析报告
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 一、前言
“乱世”木马家族的命名来源于木马母体程序包含的“乱世英雄”、“乱世权限”等特殊关键字，该家族的木马形态变化多端、作案手法专业娴熟，从今年起开始大肆地在国内传播。360核心安全团队对此持续追踪，并独家发布“乱世”木马家族系列的披露报告。
## 二、传播溯源
经过深入分析和挖掘后发现，该系列木马经常将自身伪装成某类图片或文档，木马载体的图标和文件名都极具诱导性，主要通过钓鱼网站和IM工具如QQ、微信等来进行传播。下图所示是该家族木马的部分载体样本。
### 1、IM工具传播
木马团伙将伪装程序定向投放到QQ群、微信群或者个人用户，诱导特定人群点击运行。以下为部分通过IM工具传播的木马文件，根据木马的伪装类型，大致可以划分8个类别。
追踪后发现，每类作为诱饵的木马载体都是针对特定人群来进行攻击的。比如，伪装成图片的“户型图5-k”、“欧式3-k”，目标为具有潜在买房需求或者从事房屋装修行业的人群。而伪装成活动海报或转账截图的“扫码领取红包1^dg”、“微信截图jpg-g”等，目标是专门从事棋牌游戏充值的人群，这类人群的微信资料大多涉及网上常见的棋牌类游戏，并附带宣传支持各类网银、信用卡等在线充值，如下所示是其中某个从事该灰色产业的微信资料截图。
### 2、钓鱼网站传播
针对棋牌充值类人群，该木马团伙全方位撒网，除了通过IM工具诱导传播，还特地制做了不少的钓鱼网站。比如下面这个网站，直接就将木马载体放置在首页明显位置供目标人群下载。
此外，还有一些针对棋牌推广人员的钓鱼网站，如下这个所谓的游戏管理员后台，游戏推广人员可以免费注册一个后台账户，然后进入该后台生成所谓的推广“二维码”，实际上若是下载后不小心打开便会中招了。
当然，该团伙的钓鱼网站的目标并不局限于棋牌游戏相关人员，比如今年8月份我们就曾经在报告“风云再起，签名冒用引发信任危机”中披露了该团伙针对电子产品消费人群的钓鱼攻击。
## 三、样本分析
木马载体经过诱导传播后，得以在目标用户的电脑上运行，从而攻击用户电脑，下发远控后门等木马程序来图谋利益。本章节主要通过两个案例来披露该系列木马家族的攻击过程以及使用到的一些技术细节。
### 1、案例一
本案例的木马母体伪装成“图片2018092115554.exe”，运行后假装要更新地向远程接口“http://www.xhsss.cn/update.php”发起一个验证会话，发送的数据加密前如下所示，其中包含重要的验证参数即文件名。此验证步骤是该类木马的常用手法，在一定程度上减少了自身被分析调试的风险，并能识别目标用户、控制传播范围。
若通过目标身份的验证则远程服务器会建立一个标识符“uid”返回给该用户，木马通过该标识符去访问另外一个接口“fine.php”来获取安装配置，继而通过该配置可继续下载后门套件进行安装。
接着木马母体根据该配置去下载对应的payload文件“pipi.bin”，使用密钥“a123…”对其进行解密，在内存中得到一个“pipi.dll”模块并加载执行其中的导出函数“INI”。
“pipi.dll”模块其实就是后门套件的安装器，主要工作是在ProgramData目录下释放后门模块，布置相关的持久化环境后就开始启动后门程序。安装过程大概进程链如下：
首先，通过微软的证书管理工具“certmgr.exe”导入自制的根证书到目标系统，其目的是强制让系统信任以该证书为根的证书链验证，使经过该证书链验证的木马模块显示正常的数字签名。如下便是一个木马模块在受攻击系统显示的“正常”腾讯签名：
然后木马就可以放心地启动后门程序了，启动方式是运行白程序“SysTem.exe”，该程序是Firebird数据库软件的一个程序模块，运行过程中需要导入程序依赖库“fbclient.dll”，此时即为同目录下被替换的后门模块。木马正是通过这种“白加黑”的方式来启动后门模块，并且在安装过程设置了程序“SysTem.exe”为开机自启动。
一旦木马模块“fbclient.dll”得以运行，该程序将在软件安装目录里创建一个随机目录如“C:\Progarm
Files\nqoimk”，并拷贝“SysTem.exe”本身和加密模块“wc.dat”到该目录，“SysTem.exe”被重命名为随机名“nqoimk.exe”将作为一个傀儡进程来创建，然后木马解密“wc.dat”得到一个最终的后门模块注入到该傀儡进程中运行。最终的后门模块是一个常见gh0st远控后门程序，上线地址为：“88383436.9mng.vip:2900”。
### 1、案例二
本案例的木马母体伪装成“户型图13-k.exe”，通过IM工具进行传播。该类木马常用冒用的数字签名来躲避安全软件的查杀，如下所示为其中一例样本使用的冒用“Speed-Bit”公司的数字签名。
母体样本运行后将直接连接远程服务器准备下载木马模块，连接的服务器地址为“get.mibocx.com:443”：
连接后将自身文件名和哈希值（SHA-512）等信息加密后回传服务器，只有当服务器验证成功才会返回木马模块的下载地址，并进一步下载执行。此验证步骤的目的同前述案例，若通过目标身份的验证才会下发内嵌木马模块的解密密钥，然后加载该模块开始进一步安装后门套件。