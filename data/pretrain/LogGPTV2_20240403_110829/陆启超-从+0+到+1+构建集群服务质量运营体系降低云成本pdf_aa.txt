大规模k8s集群的成本和服务质量优化
美团容器平台降本运营落地实践
陆启超 / 美团 基础研发平台
| 2023年9月 |  |
|---|---|
|  |2 |
目录 
 大规模业务集群降本挑战和难点
 资源利用率提升不同阶段的挑战和对应方案
	 第一阶段： 峰值利用率低于40%
	 第二阶段:   峰值利用率40%~45%
	 第三阶段： 峰值利用率45~50% 
 实践总结及落地成果
 未来演进方向
数据分级：C1 3
大规模业务集群降本难点
| 目标与挑战 | 目标与挑战 | 目标与挑战 | 目标与挑战 |  |
|---|---|---|---|---|
| • |目标：用最小的资源成本满足业务资源使用需求，保障业务SLO。 |目标：用最小的资源成本满足业务资源使用需求，保障业务SLO。 |目标：用最小的资源成本满足业务资源使用需求，保障业务SLO。 | || • |难点： |• |资源利用率提升与服 | |
| 务质量保障互相掣肘 |务质量保障互相掣肘 |务质量保障互相掣肘 |务质量保障互相掣肘 | |
| • |• |• |影响利用率和服务 | |
| 质量的因素多，运  营场景复杂 |质量的因素多，运  营场景复杂 |质量的因素多，运  营场景复杂 |质量的因素多，运  营场景复杂 | |
5
资源利用率提升不同阶段的挑战和对应方案
| 资源利用率提升不同阶段 | 资源利用率提升不同阶段 | 资源利用率提升不同阶段 |  |
|---|---|---|---|
| • |第一阶段：利用率水平低 |第一阶段：利用率水平低 | |
| • |• |关键思路：把资源分出去 | |
| • |第二阶段：利用率水平中 |第二阶段：利用率水平中 | |
| • |• |关键思路：资源在空间维度分合 | |
| 理 |理 |理 | || 理 |理 |理 | |
| • |第三阶段：利用率水平高 |第三阶段：利用率水平高 | |
| • |• |关键思路：在时间、空间两个维 | |
| 度把资源分合理 |度把资源分合理 |度把资源分合理 | |
7
| 阶段一：峰值利用率低于40%  | 阶段一：峰值利用率低于40%  | 阶段一：峰值利用率低于40%  |  |
|---|---|---|---|
| 挑战：如何把资源 分出去？ |挑战：如何把资源 分出去？ | | |
| • |分配率高但实际节点资源 | | |
| 利用率低，无法分配更多 资源 |利用率低，无法分配更多 资源 | | |
| • |资源碎片化，资源余量总 | |8 |
| • |量大，但对于大规格资源 | |8 |
| • |调度请求调度履约率难保 | |8 |
| • |障 | |8 |
阶段一：峰值利用率低于40%| • |障 | |8 |
阶段一：峰值利用率低于40%  
挑战1：分配率高但实际节点资源利用率低 
原因分析：业务申请实际规格和实际使用gap较大
| • | 基于经验资源规格配置不准，倾 |  |
|---|---|---|
| • |向于过配置 | |
| • |为可能的突发峰值预留资源 | |
9
| 阶段一：峰值利用率低于40%  | 阶段一：峰值利用率低于40%  | 阶段一：峰值利用率低于40%  |  |
|---|---|---|---|
| 解决方案： |业务资源使用分析预测 |业务资源使用分析预测 | |
| • |• |日常资源使用时间分布于峰值 | |
| • |• |节假日大促规律洪峰 | |
| • |• |历史数据确定安全buffer | |
业务资源使用分析与预测
业务容器配置推荐 数据分析推动业务运维降配 确定资源超售比例 应对规律洪峰提前扩容10
阶段一：峰值利用率低于40%  
挑战2：资源碎片化，资源余量总量大，但对于大规格资源调度请求调度履约率难保障 原因分析：k8s原生调度策略优先策略无法满足实际业务使用特征对资源分配的规划能力
| •
• | LeastRequestedPriority：优先调度到剩余资源多的节点上 | LeastRequestedPriority：优先调度到剩余资源多的节点上 |
|---|---|---|
| • • |• |节点分配均衡，容易形成碎片，对大规格容器调度支持效果差 |
| • • |MostRequestedPriority：优先调度到剩余资源少的节点上（类似预留资源） |MostRequestedPriority：优先调度到剩余资源少的节点上（类似预留资源） |
| • • |• |节点分配率不均衡，资源使用不均衡 |
解决方案
| •| • • |• |节点分配率不均衡，资源使用不均衡 |
解决方案
| •
• | 方案一：预留节点作为大规格容器申请专区 X | 方案一：预留节点作为大规格容器申请专区 X |
|---|---|---|
| • • |• |实现简单，专区闲置资源浪费，管理复杂，且对资源碎片无优化作用 |
| • • |方案二：基于桶迁移模型的资源调度 ✓ |方案二：基于桶迁移模型的资源调度 ✓ |
| • • |• |保证大规格容器资源申请 |
| • • |• |提升调度履约率 |
| • • |• |降低资源碎片 |
11
|  |  |  |
|---|---|---|
| • 桶划分及更新 | | |
| • 根据历史资源申请规格统计数据，按照调度计 | | |
| 算资源维度在对应的多维空间资源请求划分到 | | |
| 不同区间； | | |
| • 根据历史运营数据，统计各个桶内资源申请的 | | || • 根据历史运营数据，统计各个桶内资源申请的 | | |
| 比例作为桶迁移代价r；  | | |
| • 每个区间对应一个桶，并将集群待调度节点按 | | |
| 照其剩余资源放入不同的桶，要求剩余资源满 | | |
| 足桶下限资源要求，不满足上限资源要求 ； | | |
| • 在长期运营时，资源申请可能会发生变化，比 | | |
| 如业务变化，之前主要使用4C8G的容器（比 | | |
| 例最高）可能变成了8C16G，桶迁移代价 | | |
| 푐푏푢푐可以定期自动或手动更新。 | | |
12
•
• 节点位于不同的桶代表节点 的资源供给能力；
节点从一个桶迁移到另一个 桶，表征着节点资源供给能 力的衰减。
13
| 优化成果：大规格容器调度履约率提升 | 优化成果：大规格容器调度履约率提升 |  |
|---|---|---|
| • |原生调度策略 | ||---|---|---|
| • |原生调度策略 | |
•	基于桶迁移模型规划调度策略
14
| 优化成果——碎片率下降、分配率提升 | 优化成果——碎片率下降、分配率提升 |  |
|---|---|---|
| • |原生调度策略 | |
•	基于桶迁移模型规划调度策略
15
| 阶段二：峰值利用率40% ~ 45% | 阶段二：峰值利用率40% ~ 45% | 阶段二：峰值利用率40% ~ 45% |  |
|---|---|---|---|
| 挑战：如何在空间维度把资源分合 |挑战：如何在空间维度把资源分合 |挑战：如何在空间维度把资源分合 |挑战：如何在空间维度把资源分合 |
| 理？ |理？ | | |
| • |集中调度导致热点宿主机，负载过高导致业务 | | |
| 服务性能波动 |服务性能波动 | | |
| • |节假日大促时资源需求大，大促后大量资源冗 | | || • |节假日大促时资源需求大，大促后大量资源冗 | | |
| 余 |余 | | |
16
阶段二：峰值利用率40% ~ 45% 
挑战1：集中调度导致热点宿主机，负载过高导致业务服务性能波动 问题分析
•
• 基于业务资源申请规格的静态调度无法感知业务的实际资源使用情况 业务资源的实际使用和申请量之间的gap，不同的业务存在差异
解决方案：
17
技术优化：基于BinPack负载均衡调度 
BinPack（装箱问题）：宿主机目标负载即箱子大小，调度容器高峰 期负载作为实际装箱的对象
| 预选策略 | 优选策略 | 18 |
|---|---|---|
| • 根据已调度到节点上的容器的历 |• 预估的容器调度到当前节点后的 |18 |
| 史负载峰值及当前待调度容器 |负载和目标负载差值越小，当前 |18 |
| （假设调度到当前节点），预估 |节点优选阶段得分越高 |18 || （假设调度到当前节点），预估 |节点优选阶段得分越高 |18 |
| 对应节点的负载峰值 | |18 |
| • 如果预估的节点负载峰值超过预 | |18 |
| 设的目标负载峰值大小，则过滤 | |18 |
| 掉当前节点 | |18 |
| 技术对比及仿真评估——节点负载分布更合理 | 技术对比及仿真评估——节点负载分布更合理 |  |
|---|---|---|
| • |原生调度策略 | |
• 基于BinPack负载均衡调度
19
| 资源运营：资源池分级及QoS分级保障 | 资源运营：资源池分级及QoS分级保障 | 资源运营：资源池分级及QoS分级保障 | 资源运营：资源池分级及QoS分级保障 |  |
|---|---|---|---|---|
| • |资源分级池化 |资源分级池化 | | |
| • |• |池间资源隔离 | | || • |• |池间资源隔离 | | |
| • |• |池内资源共享 | | |