Traffic Interception & Remote Mobile Phone  
Cloning with a Compromised CDMA Femtocell 
Doug DePerry 
Tom Ritter 
Andrew Rahimi 
iSEC Partners 
• The specific method used to access the device that 
makes the demonstration possible has been resolved by 
Verizon Wireless through a security patch. 
• The Network Extenders being used to conduct the 
demonstration do not have the security patch installed. 
• Verizon Wireless gave iSEC permission to use the 
network extenders to conduct the demonstration in 
consideration of iSEC bringing the issue to the attention 
of Verizon Wireless. 
2 
• This is not like joining an open WiFi network 
• Your phone associates automatically  with no* 
indication 
• You might be on ours right now.  
• We don’t hack phones… at least not today 
No User Interaction 
3 
Full Disclosure 
• Disclosed vulnerabilities to the carrier early December 
• They worked extremely hard, over Christmas, to prepare 
a patch 
• All vulnerabilities disclosed in this presentation have 
been patched 
• We do have architectural concerns around femtocells 
• Concerns shared by… 
4 
Prior Art 
• BH 2011 “Femtocells: a Poisonous Needle in the 
Operator's Hay Stack” 
• SFR Femtocell (2nd biggest operator in France) 
• THC: Vodafone (2010/2011) 
• RSAXVC & Doug Kelly (Bsides KC 2011) 
• Rooting 
• Cable construction 
• “Do It Yourself Cellular IDS” 
• Black Hat 2013 
5 
• North American Carrier 
• 3G  
• CDMA 
• Customers affected 
• Roughly 1/3 of the population of the US 
• Phone Calls & SMS 
• MMS, Data Man-In-The-Middling, SSL Stripping 
• Cloning 
Our Focus 
6 
Rooting 
Exploring 
• Filesystem 
• Traffic 
Exploiting 
• Voice, SMS, Data 
Cloning 
Fixing 
Agenda 
7 
General Architecture 
We Are Here!  
8 
Rooting the Femtocell(s) 
SCS-26UC4 
(Older) 
SCS-2U01 
(Newer) 
9 
Rooting the Femtocell(s) 
SCS-26UC4 
(Older) 
SCS-2U01 
(Newer) 
Bonus! 
10 
• Faraday FA626TE ARM v5TE processor  
• on Samsung UCMB board 
• OneNAND flash memory 
• Lattice FPGA 
• Presumably for DSP 
• GPS antenna 
• CDMA antenna 
• 2G/3G 
• Ethernet 
• HDMI Port 
SCS-2U01 Hardware 
11 
• HDMI port 
Console Port 
12 
• USB FTDI + HDMI = 
Custom Cable 
13 
• Approximately 40’ 
• Environmental factors 
• Adjust signal strength 
• Amplify 
Wireless Signal Range 
14 
• SCS-26UC4 
• 57600 8 N 1 
• Uboot delay: “Press any key to interrupt boot”  
• Root shell 
• Run /etc/init.d/rc 5 
• Root on fully functional device 
• SCS-2U01 
• 115200 8 N 1 
• Magic sysreq + i 
• Root login 
• Run /etc/init.d/rc 5 
• Root on fully functional device 
Console Access! 
15 
These mechanisms to obtain root no longer work 
(But may be useful on other embedded devices) 
Console Access: Patched 
16 
Exploring the Femtocell 
17 
• MontaVista Linux 5, 2.6.18 
• Custom kernel, drivers, software 
• /mnt/onand 
• Custom application binaries 
• uimhx, cmbx, cdhx, agent, vpn 
• Keys, passwords, etc 
• /etc/shadow 
• /app/vpn/quicksec.xml 
Filesystem 
18 
• This terminal console sucks 
• Can’t really do anything 
• Let’s patch 
• No easy way to edit files 
• ugh, sed 
• SSHD 
• PKI-only, no RootLogin 
• Edit SSHD.conf 
• Flush iptables 
I am root, but… 
19 
• Filesystem is pulled from firmware every single time 
• Any changes disappear on reboot 
• Have to edit firmware and reflash? 
• Until we noticed… 
• Persistent filesystem location 
• /mnt/onand 
Be Persistent 
20 
• Read every single startup script until… 
if [ -f /mnt/onand/.ubirc ]; then 
   echo 'DEBUG MODE STARTUP is TARTTING....’ 
   .  /mnt/onand/.ubirc 
Be Persistent 
That’s the part of the 
filesystem we can persist in! 
21 
• .ubirc 
• Presence of this file == debug mode 
• We use it to run scripts 
• Patch sshd 
• Allow interactive root login 
• Flush iptables 
• exec /bin/bash 
Be Persistent 
22 
• We’re persistent 
• Call me Eve 
• Let’s go find the packets! 
• QuickSec VPN client 
• Packaged as a Netfilter kernel module 
• Literally steals packets out of Netfilters and handles them itself… 
• Packets don’t show up in normal capture tools like tcpdump 
• Not Open Source 
Let’s go after the data 
23 
It’s Just Engineering 
24 
• Custom kernel module 
• Priority is tricky 
• Incoming/Outgoing 
• Must be above & below quicksec to get the plaintext before 
encryption and after decryption  
• Custom Userland app 
• Display data in real-time 
• Log to pcap 
• Cross-compiling is fun* 
• *fun like a hernia 
I want packets! 
25 
Voice, Texts, and Data 
26 
• Its mostly UDP, lots and lots of UDP 
• Strange Ports 
• This is hard. 
Voice: Lots ‘o packets 
27 
Voice: Force Decode as RTP 
28 
RFC 3558: 
Value  Rate     Total data frame size 
--------------------------------------------------------- 
  0    Blank    0  (0 bit) 
  1    1/8      2  (16 bits) 
  2    1/4      5  (40 bits; not valid for EVRC) 
  3    1/2     10  (80 bits) 
  4    1       22  (171 bits; 5 padded at end w/ zeros) 
  5    Erasure  0  (SHOULD NOT be transmitted by sender) 
Voice – Codec? 
29 
Voice – Codec? 
No Answers! 
30 
Voice – Codec? 
31 
Voice! 
32 
http://www.youtube.com/watch?v=3FyNB4QmY1Q 
• These specs suck 
• But we figured it out 
• 7-bit Words, ugh 
SMS 
33 
SMS 
34 
SMS 
http://www.youtube.com/watch?v=R-4fkJiVeE4 
35 
• Plaintext! Praise the Lord: beautiful, decoded, plaintext 
• Easiest thing to do with data: View It. 
Data 
36 
37 
MMS 
http://www.youtube.com/watch?v=uuwsMsvGAYo 
• Plaintext! Praise the Lord: beautiful, decoded, plaintext 
• Easiest thing to do with data: View It. 
• Second easiest thing to do with data: Drop It. 
Data 
38 
• And when you Denial of Service some data services, they 
fail over insecurely… 
iMessage 
39 
• Back to the Data.  It is plaintext. 
• However: Lots of encapsulation 
• If we’re lucky:  IP, GRE, PPP, HDLC, IP… 
• If we’re not: IP, GRE, PPP, HDLC & then IP segmented 
across GRE packets 
Data 
40 
Data Traffic 
41 
• Goal: Edit a Webpage, as simply as possible 
• (Change HTTPS Form Action - > HTTP) 
• Going to require editing the inner TCP checksum 
• Which requires decoding and re-encoding 
• And editing the PPP checksum 
• And hopefully doesn’t change the size 
• TCP Checksum is at the beginning (GRE frame N) 
• PPP Checksum is at the end (GRE frame N+3? 4?) 
• Oh, and the frames may be out of order 
Data Middling 
42 
• Try 1: 
• Do it inline, in the kernel 
• Nope: Carrier applies transparent compression to all 
traffic on port 80 
• Can’t collect packets to decompress, edit, and 
recompress, can’t only edit one packet at a time 
• Try 2: 
• Change the request to HTTP 1.0 (No Compression) 
• Nope: Carrier Ignores it 
Data Middling 
43 
• Try 3: 
• DNS Hijack, send everyone to our server 
• Nope: Carrier does transparent proxying on port 80, then 
does own lookup based on Host header 
• Try 4: 
• DNS Hijack AND rewrite all connections to port 80 on our 
IP to port 81, and back again 
• Nope: Corner Cases.  If they happen 2% of the time, on a 
normal webpage, it’s dozens of packets. 
Data Middling 
44 
• Try 5: 
• DNS Hijack, rewrite all connections to port 80 on our IP to 
port 81, and back again, AND Redirect people to 8080 
• Success! 
• The corner cases don’t occur on the small 301 redirect 
• We can proxy the real webpage to users, ferrying their 
cookies and form posts, and: 
• Strip SSL 
• Rewrite URLs to port 8080 
Data Middling 
45 
http://www.youtube.com/watch?v=2xjhtDobO8c 
Data Middling Video 
46 
Miniature Cell Towers 
• Eavesdropping is cool and 
everything but… 
• Impersonation is even cooler. 
47 
Cloning 
48 