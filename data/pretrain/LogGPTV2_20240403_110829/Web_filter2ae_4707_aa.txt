# 机器学习Web安全原理探究之：为何隐马尔可夫模型可用于参数异常检测
|
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
作者：唐银@涂鸦智能安全实验室
## 一、前言
本文从阅读难度上可以划分为两个部分，一、二、三、四、六小节算是一部分，主要是原理性的叙述讲解，五算是另外一个部分，内容是详细的数学推导过程。
阅读第一部分之前你只需要了解什么是向量、向量的转置、什么是矩阵，也就是线性代数的基本常识。第二部分对读者的数学基础要求稍微高了一点，你需要了解概率论、微积分、凸优化相关的知识。
首先声明，本文没有算法和理论上的创新，可能不能让AI安全大佬满意。当然，如果大佬能在百忙之中给予一些指导，笔者将感激不尽！
如果你对AI安全感兴趣，并且想要搞清楚背后的原理，那么这篇文章就是为你写的。在没有搞清楚原理之前，你可能觉得机器学习用在安全问题上就是门玄学技术（信则有，不信则无的那种）。希望阅读完之后，能够改变你的看法，并且帮助你把这门“玄学”技术应用到实际的工作问题中。
初次了解到隐马尔可夫模型在Web安全异常检测领域的应用是几年前，一次偶然的机会读到楚安的文章[《数据科学在Web威胁感知中的应用》](https://www.jianshu.com/p/942d1beb7fdd)。前前后后也花了很多精力去学习机器学习相关的理论，当看到各种精妙的数学推导时，深深感受到了人与人之间智商上的鸿沟，惊叹于前人智慧的同时，也体验到了求知的乐趣。最近恰好工作需要，有机会重新捡起这些知识，发现细节都忘的差不多了，于是重新梳理了一遍，把内容整理下来，希望能够帮助到更多的人，在求知的道路上节省一些时间。
传统的入侵检测技术通常是基于规则的，类似黑名单的方式去匹配哪些流量是恶意的攻击，而黑客经常可以找到新的绕过方法。作为防守方，面对复杂的业务，如果规则上追求通用性，要么防护效果无法达到预期，要么产生很多误报，而基于这样的规则进行拦截，甚至可能会影响到正常的业务运行。如果规则上追求更强的针对性，那么维护成本也会增大。
近些年，各种机器学习算法不断被应用于Web安全入侵检测领域，与传统的入侵检测技术形成互补。隐马尔可夫算法是其中比较有代表性的一个，原理主要是基于大量的正常流量数据训练模型，利用模型检测新的流量数据，当流量数据与模型不符时，判定为异常流量。这种方式类似于白名单，更难绕过，但与白名单规则不同的是，机器学习模型具有更好的泛化能力，即使两条正常流量中数据内容完全不同，依然可以达到很好的识别能力。
## 二、从玩骰子开始
假设有三个不同的骰子（Dice）。
第一个是一个四面体的骰子，每个面的数字分别是1到4，各个面出现的概率相等，都是1/4。（给这个骰子起个名字叫D4）
第二个是正常骰子，6个面，每个面出现的概率相等，都是1/6。（这个骰子叫D6）
第三个是一个八面体的骰子，每个面的数字分别是1到8，各个面出现的概率相等，为1/8。（这个骰子叫D8）
现在我从三个骰子里随机挑一个，假设拿到每个骰子的概率都是1/3，抛一下骰子，得到一个数字。重复循环这个过程，重复了10次，得到了一串数字 1 6 3 5 2
7 3 5 2 4。
假设我不告诉你我每次挑到的是哪个骰子，只把这串数字告诉你，相当于你只是观测到了这串数字。那么对于你来说，这串可观测到的数字连在一起就是 **观测序列** 。
而我每次挑到的是哪种骰子，对你来说是隐含的状态，把这些隐含状态记录连起来，就是 **隐含状态序列**
。比如说，这个隐含状态序列可能是D6、D8、D8、D6、D4、D8、D6、D6、D4、D8 。
到这里，我们可以通过类比去理解几个概念：
1、状态集合
三种骰子分别对应三种不同状态，这里状态集合就是：Q = {D4,D6,D8}
2、观测集合
骰子的数字对应所有可以观测到的结果，这里观测集合就是：V={1,2,3,4,5,6,7,8}
3、隐含状态序列
Z = {D6,D8,D8,D6,D4,D8,D6,D6,D4,D8}
4、状态序列和观测序列的长度
前面我们重复了10次实验，所以状态序列和观测序列的长度就是：T=10
5、初始状态概率分布
我们假设 **第一次** （注意这里说的是第一次）三个骰子被取到的概率都是1/3，那么可以用向量的形式表示：
对于骰子问题，这个就是其对应的初始状态概率分布。
6、状态转移概率（transition probability）分布
也叫状态转移矩阵，先给出来再解释
第一行第一列，表示本次隐含状态是D4，下一次还是D4的概率；  
第一行第二列，表示本次隐含状态是D4，下一次是D6的概率；  
第二行第一列，表示本次隐含状态是D6，下一次是D4的概率；  
······  
以此类推。  
这个是按照最开始我们的假设，每次选择骰子都是随机等概率的，所以状态转移矩阵里每一项状态转移概率值都一样。
现在我们更改一下状态转移的假设：  
如果取到的骰子是D4，那么下一个只能取D8；如果取到D8，下一个取到D4的概率是0.2，取到D6的概率是0.7，再次取到D8的概率是0.1；如果取到D6，下一个取到D4和D8的概率都是0.5，不能连续取D6。
那么对应上述条件的状态转移矩阵就是：
7、输出概率（emission probability）分布
隐含状态到可见状态之间的概率叫输出概率，也叫发射概率。  
按照最初假设的骰子规则，对应的输出概率分布：
每行分别对应D4、D6、D8三个骰子抛出后出现数字1-8的概率。
假设我出千，D6被我做了手脚，抛出6的概率是1/2，其余数字都是1/10，那么对应的输出概率分布为：
## 三、隐马尔可夫模型的三个基本问题
我们用数学符号来抽象表示一下上面的模型：θ=(A,B,π)
θ用来表示模型  
A表示状态转移矩阵  
B表示输出概率分布  
π表示初始状态概率分布
###  概率计算问题（评估问题）
仍然以最初的骰子问题为例，已知模型：θ=(A,B,π)  
其中，状态转移矩阵：
输出概率分布：
初始状态概率分布：
已知观测序列：Y=(1,6,3,5,2,7,3,5,2,4)