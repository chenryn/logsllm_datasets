## 数据库三十六计 - PostgreSQL 三十六计(中)    
##### [TAG 22](../class/22.md)  
### 作者                                                                   
digoal                 
### 日期                   
2017-03-22                  
### 标签                 
PostgreSQL , 三十六计    
----                
## 背景      
## PostgreSQL 三十六计 - 中    
### 13. 金融风控、公安刑侦、社会关系、人脉分析 等业务场景，高效实现图式数据搜索。    
利用PostgreSQL函数编程，异步消息，复杂JOIN，递归查询，一对多关系存储等手段，解决高效的图式数据查询需求。     
1\. 猎头挖人       
作为IT人士或者猎头、HR，对Linkedin一定不陌生，领英网实际上就是一个维护人际关系的网站。            
通过搜索你的一度人脉，可以找到与你直接相关的人，搜索2度人脉，可以搜索到与你间接相关的人。           
当然你还可以继续搜索N度人脉，不过那些和你可能就不那么相关了。            
如果你知道和美女范冰冰隔了几度人脉，是不是有点心动了呢？            
其实在古代，就有这种社会关系学，还有这种专门的职业，买官卖官什么的，其实都是人脉关系网。看过红楼梦的话，你会发现那家子人怎么那么多亲戚呢？             
2\. 公安破案           
公安刑侦学也是一类人脉相关的应用，只是现在的关系和行为越来越复杂，这种关系也越来越复杂，原来的人能接触的范围基本上就靠2条腿，顶多加匹马。          
现在，手机，电脑，ATM机，超时，摄像头，汽车等等，都通过公路网、互联网连接在一起。          
一个人的行为，产生的关系会更加的复杂，单靠人肉的关系分析，刑侦难度变得越来越复杂。           
3\. 金融风控            
比如银行在审核贷款资格时，通常需要审核申请人是否有偿还能力，是否有虚假消息，行为习惯，资产，朋友圈等等。  同样涉及到复杂的人物关系，人的行为关系分析等等。           
此类围绕人为中心，事件为关系牵连的业务催生了图数据库的诞生。           
目前比较流行的图数据库比如neo4j，在数据量超过内存大小时，性能下降较厉害。          
PostgreSQL是一个功能全面的数据库，其中就有一些图数据库产品的后台是使用PostgreSQL的，例如OpenCog， Cayley等。              
除了这些图数据库产品，PostgreSQL本身在关系查询，关系管理方面也非常的成熟，十亿量级的关系网数据，3层关系运算仅需毫秒。         
还可以用于运算人与人之间的最短关系，穷举关系等。        
主要用到的技术plpgsql服务端编程、异步消息、数组、游标、pgrouting路由算法等。        
[《小微贷款、天使投资(风控助手)业务数据库设计(图式搜索\图谱分析) - 阿里云RDS PostgreSQL, HybridDB for PostgreSQL最佳实践》](../201708/20170801_01.md)    
[《金融风控、公安刑侦、社会关系、人脉分析等需求分析与数据库实现 - PostgreSQL图数据库场景应用》](../201612/20161213_01.md)    
### 14. with recursive递归查询有妙用。    
大量数据的求差集、最新数据搜索, 最新日志数据与全量数据的差异比对, 递归收敛扫描，提升数百倍性能。    
[《PostgrSQL 递归SQL的几个应用 - 极客与正常人的思维》](../201705/20170519_01.md)    
[《PostgreSQL 递归查询CASE - 树型路径分组输出》](../201703/20170324_01.md)    
[《用PostgreSQL找回618秒逝去的青春 - 递归收敛优化》](../201612/20161201_01.md)    
[《distinct xx和count(distinct xx)的变态递归优化方法 - 索引收敛(skip scan)扫描》](../201611/20161128_02.md)    
[《时序数据合并场景加速分析和实现 - 复合索引，窗口分组查询加速，变态递归加速》](../201611/20161128_01.md)    
[《PostgreSQL 使用递归SQL 找出数据库对象之间的依赖关系》](../201607/20160725_01.md)    
[《PostgreSQL 递归死循环案例及解法》](../201607/20160723_01.md)    
[《PostgreSQL 递归查询一例 - 资金累加链》](../201604/20160405_01.md)    
[《PostgreSQL Oracle 兼容性之 - WITH 递归 ( connect by )》](../201512/20151221_02.md)    
[《递归优化CASE - group by & distinct tuning case : use WITH RECURSIVE and min() function》](../201210/20121009_01.md)    
[《递归优化CASE - performance tuning case :use cursor\trigger\recursive replace (group by and order by) REDUCE needed blockes scan》](../201209/20120914_01.md)    
### 15. 数据一致性分享、数据泵    
在IoT的场景中，有流式分析的需求，也有存储历史数据的需求，同时还有数据挖掘的需求，搜索引擎可能也需要同一份数据，还有一些业务可能也要用到同一份数据。           
但是如果把数据统统放到一个地方，这么多的业务，它们有的要求实时处理，有的要求批量处理，有的可能需要实时的更新数据，有的可能要对大数据进行分析。       
10万级别左右的机器，PostgreSQL 的数据吞吐量可以达到100万条/s以上，同时数据库本身具备了严格的可靠性和一致性保证。        
PostgreSQL为分享数据提供了插槽的概念，每个插槽对应一个目标端，支持断点续传，支持多个目标端。用于流式的分享数据是非常好的选择。        
[《实时数据交换平台 - BottledWater-pg with confluent》](../201612/20161205_02.md)    
[《PostgreSQL 逻辑订阅 - DDL 订阅 实现方法》](../201712/20171204_04.md)    
[《PostgreSQL 逻辑订阅 - 给业务架构带来了什么希望？》](../201704/20170413_01.md)    
[《PostgreSQL 10.0 preview 逻辑订阅 - 原理与最佳实践》](../201702/20170227_01.md)    
### 16. ad lock解决高并发更新少量记录的秒杀问题    
秒杀在商品交易中是一个永恒的话题，从双十一，到一票难求，比的仅仅是手快吗？           
其实对于交易平台来说，面对的不仅仅是人肉，还有很多脚本，外挂自动化的抢购系统，压力可想而知。           
秒杀的优化手段很多，就拿数据库来说，有用排队机制的，有用异步消息的，有用交易合并的。           
PostgreSQL提供了一种更极端的秒杀应对方法，裸秒。可以让用户尽情的释放激情，以一台32核64线程的机器为例，每秒可以获取、探测约130万次的ad lock。            
试想一下，对单条记录的秒杀操作，达到了单机100万/s的处理能力后，秒杀算什么？100台机器就能处理1亿/s的秒杀请求。        
[《HTAP数据库 PostgreSQL 场景与性能测试之 30 - (OLTP) 秒杀 - 高并发单点更新》](../201711/20171107_31.md)    
[《聊一聊双十一背后的技术 - 不一样的秒杀技术, 裸秒》](../201611/20161117_01.md)    
[《PostgreSQL 秒杀场景优化》](../201509/20150914_01.md)    
### 17. PostgreSQL 使用阿里云 varbitx支持实时用户画像    
用户画像在市场营销的应用重建中非常常见，已经不是什么新鲜的东西，比较流行的解决方案是给用户贴标签，根据标签的组合，圈出需要的用户。          
通常画像系统会用到宽表，以及分布式的系统。          
宽表的作用是存储标签，例如每列代表一个标签，但是通常数据库到2000个列基本就是极限了，上万TAG的话，只能使用多表JOIN来实现，效率较差。        
另一方面，使用宽表(甚至列存储)，标签的筛选性能也比较差（无法达到实时级别）。        
以PostgreSQL数据库为基础，以BIT来存储用户，每行一个TAG的方式，单机支持十万亿user tags体量，毫秒级实时圈人。         
[《阿里云RDS PostgreSQL varbitx实践 - 流式标签 (阅后即焚流式批量计算) - 万亿级，任意标签圈人，毫秒响应》](../201712/20171212_01.md)    
[《阿里云RDS for PostgreSQL varbitx插件与实时画像应用场景介绍》](../201705/20170502_01.md)    
[《基于 阿里云 RDS PostgreSQL 打造实时用户画像推荐系统(varbitx)》](../201610/20161021_01.md)    
### 18. 路径动态规划，助力物流配送、打车软件、导航软件、出行软件、高速、高铁等业务场景        
物流行业是被电子商务催生的产业之一。          
快件的配送和揽件的调度算法是物流行业一个非常重要的课题，直接关系到配送或揽件的时效，以及物流公司的运作成本。            
好的算法，可以提高时效，降低成本，甚至可以更好的调动社会资源，就像滴滴打车一样，也许能全民参与哦。            
以后也许上班路途还能顺路提供快递服务呢。            
以物流行业为例，PostgreSQL为物流行业应用提供了包括机器学习(madlib)、路径规划(pgrouting)、地理位置信息存储和处理等基础服务。     
[《聊一聊双十一背后的技术 - 物流、动态路径规划》](../201611/20161114_01.md)    
### 19. 金融级可靠性，事务级可控多副本。       
传统的金融行业高度依赖共享存储来解决数据库的高可用，数据0丢失以及异地容灾的场景。          
共享存储的解决方案价格昂贵，对厂商的依赖较大。        
PostgreSQL基于同步流复制的任意副本解决方案，在解决0丢失，高可用以及容灾的问题的同时，还可以提供只读的功能。相比传统的存储解决方案，优势更加明显。     
允许用户根据事务的可靠性要求，设置事务所需的副本数。    
[《PostgreSQL - 鱼与熊掌可兼得 - 多副本0丢失与高性能兼得 - 事务级异步、同步开关》](../201712/20171207_01.md)    
PostgreSQL 事务提交模式synchronous_commit 介绍：  
```    
synchronous_commit    
local, remote_write, remote_apply, on, off.    
```    
解释    
```    
local, 本地fsync    
remote_write, 本地fsync + 超阈值个数的 sync standby write   (quorum based sync standby)    
on, 本地fsync + 超阈值个数的 sync standby fsync  (quorum based sync standby)    
remote_write, 本地fsync + 超阈值个数的 sync standby apply   (quorum based sync standby)    