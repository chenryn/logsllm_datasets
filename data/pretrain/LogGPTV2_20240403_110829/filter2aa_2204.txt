DefCon (China) 1, Beijing 2019 
Breaking the back end! 
Gregory Pickett, CISSP, GCIA, GPEN 
Chicago, Illinois 
PI:EMAIL 
Hellfire Security 
Overview 
  Transit Systems 
  Reverse Engineering 
  My Discoveries 
  The Exploit 
  The Lessons 
Brief History 
 The Anatomy of a Subway Hack 
(2008) 
 NFC Subway Hack (2012) 
 How to Hack All the Transport 
Networks of a Country (2012) 
 Breaking Korea Transit Card with 
Side-Channel Attack (2017) 
How This Is Different 
 This is not illegal 
 We aren’t sneaking into the station 
 We aren’t hacking their terminals 
 We aren’t social engineering anyone or 
attacking their wired/wireless network 
 This is not about the hardware 
 We aren’t cracking anyone’s encryption 
 We aren’t cloning the magstripe, RFID, 
or NFC 
How This Is Different 
 This Is About 
 Flaws in the Application Logic 
 OK.  Cloning is involved but it is not the 
vulnerability exploited 
 Using AppSec to attack Complex Multi-
Layered Real World Solutions 
Elevated Train 
 Bangkok Mass Transit System 
(BTS) 
 Elevated rapid transit system in 
Bangkok, Thailand 
 Serves Greater Bangkok Area 
 Operated by Bangkok Mass Transit 
System PCL (BTSC) 
 43 stations along two lines 
Tickets 
 Stored-Value Card (NFC) 
 All Day Pass (Magstripe) and Single 
Journey (Magstripe) 
 Two magstripes 
 Hole through one magstripe 
 Only 0.27mm thick 
Tickets 
Tickets 
Tickets 
Gates 
 Entering 
 Exiting 
Why Them? 
 Magstripe Really? 
 There had to be something there! 
 Threatening To For Years 
 Had to Before Moving On … 
The Equipment 
 Standard Reader/Writer 
 Manufactured in China 
 Standards or Raw Read 
 Errors Rare 
 Reliable Performance 
The Questions 
 Data Location 
 Encoding Schemes 
 Data Changes 
 Data Meaning 
 System Response 
 Data Tampering 
 Repeating states or out of order 
transitioning  
Lab Work 
 Reading the magstripes 
 Decoding the data 
Lab Work 
Lab Work 
 Attempted Decode Using Standards 
 International Organization for 
Standardization 
 6-bit Character sets and 4-bit 
Character sets 
 Some With Parity and Some Without 
 Attempted Decode both forwards 
and backwards 
 It wasn’t using the standards 
Lab Work 
* The section marked “Known” is always 100 + the price of the ticket 
Lab Work 
 There is no encryption. 
 There are no parity checks 
 There was no longitudinal 
redundancy check (LRC) 
 There are no timestamps 
Field Work 
 Run Tickets Through The System 
 Vary The Input Each Time 
 See how The Data Changes 
 Use Changes To Identify The 
Meaning 
Field Work 
Field Work 
GUID%
GUID%
GUID%
Station%
Dispenser%
Station%
Turn-style%
Field Work 
0x00E078401A327826E91E76ED00FF7400D20FE948AE0A41
“Issued”
“Used”
“Collected”
Buying
Entering
Exiting
0x00E078401A327826E91E76ED00FF74801C0FE948D8681B
0x00E078401A327826E91E76ED00FF74801C0FE948D8681B
Field Work 
 For all day passes, the known 
section or “100+price” is used to 
track trips taken. 
 There is a different "Never Changes" 
for All-Day passes. 
Handling Rules 
 To Enter, 
 Ticket must have previously been in 
“Collected” State 
 Ticket Must Be Now Be In “Issued” 
State 
 To Exit, Ticket Must Be In “Used” 
State 
Research Under A Junta 
 Situation There 
 Legal Rights 
Trying Not To Get Arrested 
 Avoiding Security Guards 
 Dip and Dash 
 Last Resort 
Local Attitudes 
 Punished for Disruptions 
 Wouldn’t Notice 
 Wouldn’t Care 
 What Procedure? 
 Avoiding Farang 
Exploiting This System 
 What We Have Learned So Far 
 System Safeguards 
 Their Assumptions 
 Attacks Against Their Assumptions 
 Epic Fail! 
What We Have Learned So 
Far 
 Object Based 
 Physical Object 
 Database Object 
 Properties 
 Identification 
 Value 
 Location 
What We Have Learned So 
Far 
 States 
 Issued 
 Used 
 Collected 
 History 
System Safeguards 
 Ticket Composition and Ticket 
Design 
 Mirror Physical Object and Database 
Object 
 Handling Rules Define Valid Use of 
The Objects 
 Lifecycle limited to Twenty-Four 
Hours 
 Collection of Ticket After Use 
Their Assumptions 
 No One Will Be Able to Reproduce 
Our Ticket 
 Our System Has The Only Valid 
Objects 
 Handling Rules Will Prevent 
Concurrent Use 
 Damage is limited by Lifecycle 
 After Use, Ticket Will Be In Our 
Possession 
Attacks Against Assumptions 
 Acquire Suitable Ticket 
 Capture Valid Object 
 Bypass Rules 
 Extend the Attack to Increase the 
Damage 
Epic Fail! 
 Found Someone to Make Blank 
Tickets 
 Copied Shit Ton of Objects in 
“Issued” State 
 Found Flaw In the Handling Rules 
 “Collected” State found in Current 
Lifecycle  
 Overrides all other states! 
 Object Always Seen Recently 
“Collected” 
R
Th
O i i
l Ti k t
Epic Fail! 
“Issued”
“Used”
“Collected”
Entering
Exiting
Original
Original
Original
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Collected”
X 
X 
X 
Epic Fail! 
“Issued”
“Used”
“Collected”
Entering
Exiting
Original
Original
Original
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Collected”
X 
X 
X 
Epic Fail! 
Epic Fail! (Demonstration) 
Turning The Exploit Into An 
Attack 
 Tickets 
 Plan 
The Tickets 
 Find Cards 
 Punch Holes 
Finding Cards 
 RFP on Alibaba 
 Running Trails 
 Winning Bid! 
RFP on Alibaba 
 Thousands of Companies (Probably 
Millions) 
 Just Tell Them What You Want 
 Anything That You Need! 
 They Will Make It For You 
Running Trials 
 Many Offers 
 All failed but one company 
 Couldn’t produce the desired 
thickness 
 Took many months to find them 
Winning Bid! 
Winning Bid! 
Punch Holes 
Punch Holes 
The Plan 
 Buy Ticket (Daily Pass) 
 Copy Ticket 
 Use Original 
 Hand Out Copies 
 Have Fun! 
 Repeat Tomorrow! 
Results of The Attack 
Extend the attack! 
Implications for The BTS 
 Millions of Dollars in Losses 
 Loss of Face! 
Response from the BTS 
 Who Are You Again? 
 Not Interested! 
  For Us 
  For The BTS 
The Lessons 
  There is no hardware-only solution 
  Solutions are often complex 
  There is software in there somewhere 
  Trusting assumptions can be 
dangerous 
  Don’t be afraid of where research 
might lead 
  Measure your risk wisely before 
proceeding 
  Have a plan that includes the people 
involved 
For Us 
  Don’t Let Social Conventions Blind 
You 
  Not Everyone Thinks Like You 
  Be Willing To Talk to Anyone 
  Rely on the Evidence 
  You Can Always Cover It Up Later 
For The BTS 
  Test All Layers of a Solution 
  Test for Application Issues 
  Check Your Assumptions 
  Use Compensating and Mitigating 
Controls 
Avoiding Their Fate 
  Deployed Second Generation 
  Still No Channels for Sharing 
  Still Ignoring “The Wrong People” 
  Still Ignoring me 
What Are They Doing Now 
Final Thoughts 
  Transit Systems Are Fun 
  They Can Also Get You In Trouble 
  You Don’t Know Until You Try 
  Reverse Engineering Is Key 
  You Got Have Some Balls! 
  Don’t Believe The Hype 
  AppSec for The Win! 
Links 
  https://wikileaks.org/wiki/
Anatomy_of_a_Subway_Hack_2008 
  https://file.wikileaks.org/file/anatomy-of-a-subway-hack.pdf 
  https://defcon.org/images/defcon-16/dc16-presentations/
anderson-ryan-chiesa/47-zack-reply-to-mbta-oppo.pdf 
  https://www.computerworld.com/article/2597509/def-con--
how-to-hack-all-the-transport-networks-of-a-country.html 
  https://www.cio.com/article/2391654/android-nfc-hack-
enables-travelers-to-ride-us-subways-for-free--
researchers-say.html 
  https://www.youtube.com/watch?v=-uvvVMHnC3c 
  https://www.blackhat.com/docs/asia-17/materials/asia-17-
Kim-Breaking-Korea-Transit-Card-With-Side-Channel-
Attack-Unauthorized-Recharging-wp.pdf 
Links 
  https://www.msrdevice.com 
  https://www.msrdevice.com/product/misiri-msr705x-hico-
magnetic-card-reader-writer-encoder-msr607-msr608-
msr705-msr706 
  https://www.alibaba.com/ 
  https://nexqo.en.alibaba.com 
  http://www.nexqo.com/ 
  https://www.bts.co.th/ 
  http://www.btsgroup.co.th