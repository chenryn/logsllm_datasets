Windows_Kernel_Shellcode
_Exploit
chrO.ot
Nanika
Summary
• What is Exploit
• Windows_Shellcode
• Windows_Kernel_shellcode
• CreateRemoteThread backdoor “byshell”
• Exploit Demo
• 0day_exploit
What is Exploit
• Buffer overflow
• Heap overflow
• Format string
• CGI or SQL inject
Buffer overflow
STACK 
----------------
Local Variables 
ESP
Buffer 
----------------
EBP-> Old Value of EBP
----------------
Return Address 
----------------
void func(void) 
{
char buffer[256]; // * 
for(i=0;i dt nt!_KTHREAD
•
+0x02d State            : UChar
•
lkd> dt nt!_KAPC_STATE
•
+0x000 ApcListHead
: [2] _LIST_ENTRY
•
+0x010 Process          : Ptr32 _KPROCESS
•
+0x014 KernelApcInProgress : UChar
•
+0x015 KernelApcPending : UChar
•
+0x016 UserApcPending
: UChar
void KeInitializeApc(struct _KAPC *Apc, PKTHREAD thread, unsigned char 
state_index, PKKERNEL_ROUTINE ker_routine, PKRUNDOWN_ROUTINE 
rd_routine, PKNORMAL_ROUTINE nor_routine, unsigned char mode, void *context);
void KeInsertQueueApc(struct _KAPC *APC, void *SysArg1, void *SysArg2, 
unsigned char arg4); 
CreateRemoteThread backdoor
• backdoor byshell
• monitor thread&process
backdoor byshell
•
HANDLE OpenProcess( DWORD dwDesiredAccess, 
BOOL bInheritHandle, DWORD dwProcessId );
•
LPVOID VirtualAllocEx( HANDLE hProcess, LPVOID
lpAddress, SIZE_T dwSize, DWORD flAllocationType, 
DWORD flProtect );
•
BOOL WriteProcessMemory( HANDLE hProcess, 
LPVOID lpBaseAddress, LPCVOID lpBuffer, SIZE_T
nSize, SIZE_T* lpNumberOfBytesWritten );
•
HANDLE CreateRemoteThread( HANDLE hProcess, 
LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T
dwStackSize, LPTHREAD_START_ROUTINE
lpStartAddress, LPVOID lpParameter, DWORD
dwCreationFlags, LPDWORD lpThreadId );
monitor thread&process
•
PsSetCreateProcessNotifyRoutine(ProcessCreateMon, FALSE)
•
PsLookupProcessByProcessId((ULONG)PId, &EProcess);
•
PsSetCreateThreadNotifyRoutine(ThreadCreateMon);
•
PsLookupThreadByThreadId((PVOID)4, &Thread); 
Windows Kernel shellcode
Exploit
• Ring3->Ring0
• Exploit Apc inject
Ring3->Ring0
• OpenPhysicalMemory() 
• MapPhysicalMemory( )
Exploit Apc inject Demo
Exploit Demo
• Microsoft Jet Database Engine DB 
File Buffer Overflow Exploit
• Microsoft Exchange Server Remote 
Code Execution Exploit (MS05-021)
• Microsoft Internet Explorer 
"javaprxy.dll" Command Execution 
Exploit
Q&A
Reference
•
Remote Windows Kernel Exploitation - Step Into the Ring 0 (pdf)
http://www.eeye.com/~data/publish/whitepapers/research/OT2005020
5.FILE.pdf
•
ring3->ring0 code by http://zzzevazzz.blogchina.com/427939.html
•
monitor thread&process
http://www.xfocus.net/articles/200503/788.html
•
Inside Microsoft Windows 2000
•
Byshell backdoor
http://www.xfocus.net/tools/200412/943.html
MSDN
谢谢各位