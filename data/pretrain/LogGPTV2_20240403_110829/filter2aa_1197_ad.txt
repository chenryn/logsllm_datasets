and
transfer
con
trol
to
a
"BIOS
pa
yload".
This
BIOS
pa
yload
is
in
turn
resonsible
for
setting
up
and
In
terrupt
V
ector
T
able
that
will
allo
w
an
op
erating
system
to
in
terract
with
the
hardw
are
previously
detected.
In
our
setup,
Coreb
o
ot
and
Seabios
ha
v
e
b
een
trivially
patc
hed
not
to
displa
y
an
ything,
ev
en
though
Coreb
o
ot
is
in
theory
capable
of
displa
ying
a
custom
user
dened
b
o
otsplash
at
b
o
ot
time,
whic
h
w
ould
allo
w
faking
the
image
normally
displa
y
ed
b
y
the
original
BIOS
(t
ypically
con
taining
the
v
endor
logo
etc).
SeaBIOS
w
as
c
hosen
for
its
simplicit
y
,
but
alternativ
e
op
en
source
BIOS
pa
yloads
are
a
v
ailable
whic
h
can
also
displa
y
men
us
and
fo
ol
more
adv
anced
users
that
could
w
an
t
to
mo
dify
their
BIOS
settings.
Other
BIOS
pa
yload
can
also
con
tain
EFI/UEFI
exten
tions,
whic
h
mak
es
our
tec
hnique
applicable
en
tirely
to
UEFI
en
vironmen
ts
6
.
Coreb
o
ot
ha
ving
a
v
ery
mo
dular
design,
it
is
p
ossible
to
em
b
ed
ab
out
an
y
PCI
R
OM
along
with
it,
meaning
that
w
e
can
stu
arbitrary
co
de
inside
the
BIOS
c
hip
itself.
W
e
ha
v
e
c
hosen
to
stic
k
to
the
bare
minim
um,
adding
a
video
driv
er
and
a
rogue
iPXE
ethernet
rm
w
are
(equally
patc
hed
not
to
displa
y
an
ything
when
op
erating).
This
later
PCI
rm
w
are
implemen
ts
a
sup
er
set
of
the
original
PXE[22
â„„
standard
:
instead
of
relying
only
on
DHCP
to
aquire
an
IP
address
and
the
address
of
a
TFTP
serv
er
to
do
wnload
an
op
erating
system
from,
it
can
use
a
wide
range
of
proto
cols,
based
on
a
user
dened
conguration
le
em
b
eded
in
the
rm
w
are
itself.
iPXE
con
tains
w
orking
stac
ks
for
ethernet,
wi
and
ev
en
wimax
data
link
la
y
ers
proto
cols,
a
full
featured
IPv(4/6)/icmp
stac
k,
and
implemen
ts
all
a
mal-
w
are
writter
could
dream
of
in
terms
of
upp
er
la
y
er
net
w
ork
stac
ks
:
from
UDP
and
TCP
to
DHCP
,
DNS,
HTTP
,
HTTPS
and
(T)FTP
among
others.
T
ec
hnically
,
Coreb
o
ot
could
also
em
b
ed
a
full
featured
bac
kdo
or
in
the
BIOS
R
OM
itself.
But
since
w
e'd
lik
e
to
oer
upgrading
facilities
to
Rakshasa
and
a
v
oid
lea
ving
an
y
trace
of
hostile
co
de
on
the
mac
hine
(to
deceiv
e
forensics
analyst
in
case
of
detection
or
at
least
suspicion),
w
e'll
refrain
from
using
this
tec
hnique
:
w
e'll
b
o
ot
our
malicious
pa
yload
from
the
net
w
ork
at
eac
h
b
o
ot.
Instead
of
b
o
oting
a
normal
op
erating
system
from
the
wire,
w
e'll
use
iPXE
to
b
o
ot
a
b
o
otkit
remotely
,
whic
h
will
in
turn
transparen
tly
load
the
b
o
otloader
from
the
rst
b
o
otable
disk
b
y
em
ulating
in
terrupt
0x19,
patc
h
the
k
ernel
on
the
y
,
and
ev
en
tually
load
the
op
erating
system
k
ernel
as
the
user
exp
ects
it,
silen
tly
.
6
Inner
w
orking
of
Rakshasa
Rakshasa
can
t
ypically
b
e
installed
in
one
of
t
w
o
w
a
ys.
The
rst
one
is,
giv
en
ph
ysical
access
to
the
hardw
are,
to
ash
the
BIOS
rm
w
are.
This
can
b
e
ac
hiev
ed
either
b
y
using
a
dedicated
ph
ysical
asher
(usually
made
of
a
FPGA)
7
or
b
y
relying
on
a
generic
rm
w
are
asher
(from
usb
or
a
cdrom
for
instance.
PXE
could
also
b
e
used).
This
op
eration
tak
es
less
than
a
min
ute
in
an
y
case.
The
second
installation
tec
hnique
is
a
p
ost
in
trusion
one
and
do
esn't
require
ph
ysical
access
to
the
hardw
are
at
all
:
once
an
attac
k
er
has
ac
hiev
ed
remote
ro
ot
on
a
computer,
he
can
use
the
same
generic
asher
to
install
Rakshasa
in
place
of
the
original
BIOS.
In
case
the
op
erating
system
is
not
a
Lin
ux,
one
can
simply
piv
ot
o
v
er
the
MBR
upp
on
next
reb
o
ot.
T
o
ac
hiev
e
redundancy
and
a
v
oid
single
p
oin
ts
of
failure,
the
net
w
ork
card
rm
w
are
is
also
ashed
with
a
rogue
iPXE
rm
w
are.
Optionally
,
a
second
PCI
rm
w
are
can
b
e
replaced
b
y
a
mo
died
v
ersion
of
iPXE
(t
ypically
the
cdrom).
It
is
unfortunatly
not
p
ossible
to
main
tain
the
functionalit
y
of
this
second
device
when
doing
so
for
the
time
b
eing
(though
this
is
an
implemen
tation
issue
and
not
a
theorical
one).
If
the
BIOS
ev
er
attempted
to
b
o
ot
from
this
second
device,
the
net
eect
w
ould
b
e
the
same
:
the
computer
w
ould
really
b
o
ot
6
In
other
w
ords
,the
ro
ot
cause
of
the
problems,
namely
a
writable
BIOS
and
a
passiv
e
TPM
are
not
solv
ed
with
UEFI.
7
This
metho
d
has
the
main
adv
an
tage
of
b
ypassing
an
ti-ashing
coun
ter
measures
suc
h
as
rm
w
are
signing
on
certain
motherb
oards.
8
from
iPXE,
that
is,
from
the
net
w
ork.
iPXE
is
capable
of
attempting
actions,
and
p
erform
other
ones
upp
on
failure.
T
o
maximize
our
c
hances
of
w
orking
in
an
y
giv
en
en
vironmen
t,
w
e
ha
v
e
congured
iPXE
to
rst
attempt
to
connect
to
the
in
ternet
via
wi.
A
n
um
b
er
of
common
SSIDs
and
ev
en
wi
cyphers
can
b
e
sp
ecied
at
compile
time.
T
ypically
,
w
e'll
try
to
b
o
ot
from
an
attac
k
er
dened
SSID/WEP
access
p
oin
t.
In
case
of
failure,
w
e'll
try
to
connect
to
a
(short)
list
of
common
public
SSIDs
usually
asso
ciated
with
op
en
wireless
access
p
oin
ts.
The
main
adv
an
tage
of
relying
on
wi
is
to
b
ypass
an
y
net
w
ork
ltering
or
detection
mec
hanism
in
corp
orate
en
vironmen
ts.
As
a
matter
of
fact,
ev
en
if
Rakshasa
w
as
to
b
e
used
in
a
large
organisation
whose
access
to
the
in
ternet
is
normally
done
through
an
authen
ticating
pro
xy
,
ev
en
if
I(D|P)S
w
ere
to
b
e
found
in
this
net
w
ork,
ev
en
if
prop
er
DNS
segregation
w
as
in
place,
the
simple
fact
of
using
encrypted
wi
as
a
link
la
y
er
w
ould
totally
breac
h
the
net
w
ork
p
erimeter
and
render
all
those
costly
devices
en
tirely
useless.
If
Rakshasa
still
didn't
manage
to
get
access
to
the
in
ternet,
it
w
ould
attempt
to
aquire
an
IP
address
from
DHCP
o
v
er
ethernet,
and
default
to
a
c
hosen
reasonable
static
LAN
IP
in
case
ev
erything
else
failed.
Sp
eed
is
indeed
critical
to
remain
unoticed,
and
some
of
those
settings
can
b
e
skipp
ed
b
y
mo
di-
fying
a
simple
conguration
le
at
compile
time.
If
at
this
stage
Rakshasa
still
didn't
get
access
at
least
to
the
LAN,
it
w
ould
simply
b
o
ot
the
default
op
erating
system
to
a
v
oid
b
eing
detected.
A
t
this
stage,
Rakshasa
can
p
erform
a
n
um
b
er
of
things.
Assuming
it
didn't
managed
to
connect
to
the
in
ternet
o
v
er
wi
but
simply
ethernet
access,
it
could
attempt
to
attac
k
hosts
reac
hable
on
the
LAN
using
virtually
an
y
proto
col
based
on
top
of
IPv4/IPv6
or
icmp.
This
can
include,
based
on
a
simple
iPXE
conguration
le
:
icmp
host
en
umeration,
tcp/dns
p
ort
scanning,
router
pharming
(o
v
er
h
ttp/h
ttps),
exploiting
net
w
ork
deamons
or
net
w
ork
stac
ks
(ping
of
death,
ip
v6
attac
ks,
sending
broad-
cast
trac,
sm
urf/DDoS
attac
ks,
exploiting
remote
o
v
ero
ws
in
an
ything
routable,
etc.).
One
could
for
instance
attempt
to
mo
dify
the
settings
of
an
ADSL
router
to
op
en
p
orts.
This
is
not
b
eliev
ed
to
b
e
sp
ecially
smart
or
stealth,
so
this
feature
is
only
men
tioned
for
the
sak
e
of
completeness.
As
a
matter
of
fact,
acting
as
suc
h
w
ould
b
e
con
trary
to
our
agreed
princip
e
of
"plausible
deniabilit
y"
since
hostile
co
de
w
ould
b
e
em
b
edded
on
the
bac
kdo
ored
mac
hine...
Rakshasa
will
then
t
ypically
try
to
connect
to
a
giv
en
host
on
the
in
ternet
o
v
er
h
ttps
(sa
y
go
ogle.com
b
ecause
it
is
unlik
ely
to
trigger
alarms,
ev
en
if
the
connection
is
op
erated
o
v
er
an
ethernet
link).
In
case
it
succeeds,
Rakshasa
will
assume
it
has
full
access
to
the
in
ternet.
In
the
opp
osite
case
(whic
h
could
happ
en
if
the
infected
computer
had
no
wi
card
and
the
net
w
ork
w
as
segregated
b
y
an
authen
ticating
rew
all),
Rakshasa
could
attempt
to
reac
h
the
in
ternet
via
TCP
o
v
er
DNS
(whic
h
w
ould
suce
if
the
net
w
ork
didn't
had
prop
er
DNS
segregation
b
et
w
een
the
LAN
and
the
outside
w
orld)
or
TCP
o
v
er
icmp
(wh
y
not
!).
As
the
astute
reader
shall
ha
v
e
understo
o
d
b
y
no
w,
the
sky
is
the
limit