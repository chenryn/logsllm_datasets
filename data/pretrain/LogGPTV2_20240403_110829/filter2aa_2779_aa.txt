Veil%Pillage:**
Post%Exploitation*2.0*
Will$$
@harmj0y*
Veris$Group$–$Adaptive$Threat$Division$
$*whoami*
▪  Security$researcher$and$pentester/red$teamer$
for$Veris$Group’s$Adaptive$Threat$Division$$
▪  Co?founder$of$the$Veil?Framework$#avlol$
– www.veil?framework.com$
– Shmoocon'‘14:'AV$Evasion$with$the$Veil$
Framework$
– co?wrote$Veil?Evasion,$wrote$Veil?Catapult,$Veil?
PowerView,$and$PowerUp$
$
▪  Active$Cortana,$Powershell,$and$NovaHacker!$
tl;dr*
▪  The$Veil?Framework$
▪  Post$Exploitation;$redux$
▪  Veil?Pillage$
▪  Current$Module$Overview$
▪  Hashdumping$and$Plaintext$Creds$
▪  Demos$
▪  KB$2871997$(Microsoft$PTH$ﬁx?)$
▪  Module$Releases$and$Development$
▪  Recap$
The*Veil%Framework*
How$We$Got$Here$
Background*
▪  Started$with$the$May$2013$release$of$
‘Veil’,$later$renamed$to$‘Veil?Evasion’$
▪  Utilizes$various$languages$and$
techniques$to$generate$AV?evading$
payloads$
– shellcode$injection$and$’pure’$meterpreter$
stagers$
▪  Debuted$at$Shmoocon$‘14:$“AV$Evasion,
with,the,Veil$Framework”,
– https://www.veil?framework.com/$
How*We*Got*Here*
▪  After$dealing$with$AV?evasion,$focus$
moved$to$payload$delivery$
▪  Wanted$a$way$to$trigger$backdoors$on$
target$boxes$in$a$stealthy$way$
▪  Released$at$Shmoocon'‘14,$Veil?
Catapult$can$upload/host$and$execute$
binaries,$as$well$as$few$other$common$
tricks$
The*Attack*Cycle*
Recon$
Enumeration$
Exploitation$
Post?
exploitation$
Post%Exploitation;*Redux*
Identify$points$that$aﬀect$business$impact$
Datamine$for$Sensitive$Information$
Establish$Persistence$
Acquire$Domain/Network$Administrative$Privileges$
Identify$Further$Exploit$Points$
Escalate$Privileges$
Gain$Situational$Awareness$
Gain$Access$Through$Exploit$
Post%Exploitation;*English*
▪  If$you$have$access$and/or$credentials$for$
one$or$more$machines$on$a$network,$
what$can$you$do?$
▪  Example:'say$you$have$a$local$
administrator$hash$for$remote$hosts,$
and$want$to$grab$plaintexts$of$other$
logged$on$users$on$those$hosts?$
Post%Exploitation;*Today*
▪  Option'#1:'PSEXEC$to$a$box$with$
Metasploit,$then$getsystem/wdigest$
▪  Advantages:'
– Flexible,$can$utilize$the$entire$Metasploit$
framework$
▪  Drawbacks:'
– service$running$as$SYSTEM$created$
– LOTS$of$non?standard$traﬃc$$
– “known”$malicious$binary$dropped$to$disk$
Post%Exploitation;*Today*
▪  Option'#2:'use$smbexec$to$upload/
execute$a$wce.exe$binary$
▪  Advantages:'
– Don’t$need$to$establish$a$full$Meterpreter$
session$
– Doesn’t$rely$on$MSF$binary$templates$
▪  Drawbacks:'
– SYSTEM$service$still$created$
– And$another$“known”$malicious$binary$is$
uploaded/executed$
Post%Exploitation;*Today*
▪  Option'#3:'use$the$passing?the?hash$
toolkit$and$PowerSploit$
▪  Advantages:'
– No$service$created!!$
– No$binaries$dropped$to$disk!!$
▪  Drawbacks:'
– Usage$isn’t$the$simplest$
– What$if$you$want$to$do$this$on$a$lot$of$hosts?$
– What$if$powershell$is$disabled,$or$not$
installed?$
*
What*We*Want*
▪  Trigger'Options:'with$a$preference$for$
stealth$
▪  Modularity:'want$it$to$be$easy$to$
implement$new$post?exploitation$
techniques$
– And$want$to$be$able$to$easily$integrate$our$
code/techniques$into$other$tools$
▪  Completeness:'automation,$
comprehensive$logging,$cleanup,$etc.$
Veil%Pillage*
Catapult$2.0$
Veil%Pillage*Primitives*
▪  pthGwmis':'no$service$created$
▪  pthGwinexe':'runs$as$system,$binary$
dropped$
▪  ImpacketGsmbexec':'service$created,$but$
no$binaries$dropped$
▪  Impacket:'smbservers$and$clients$and$more$
▪  Everything$abstracted$out$to$common$
library$methods$
Veil%Catapult*Integration*
Veil%Catapult*Integration*
▪  All$of$Veil?Catapult’s$functionality$has$
been$modularly$integrated$into$Veil?
Pillage:$
– payload_delivery/exe_delivery$
– payload_delivery/powershell_injector$
– payload_delivery/python_injector$
– persistence/registry/sticky_keys$
▪  Veil?Catapult$will$now$be$obsoleted$:($
▪  Blog$post$on$transitioning$up$soon$
exe_delivery*
▪  Catapult$functionality$ported$to$Pillage$
▪  Executables$can$be$speciﬁed,$or$
generated$with$seemless$Veil?Evasion$
integration$
▪  .EXEs$are$then$uploaded/triggered,$or$
hosted/triggered$with$a$\\UNC$path$
– This$gets$some$otherwise$disk?
detectable$.EXEs$right$by$some$AVs$
python_injector*
▪  Uploads$a$minimal$python$.zip$
installation$and$7zip$binary$
▪  Python$environment$unzipped,$
shellcode$invoked$using$“?c$…”$$
▪  The$only$ﬁles$that$touch$disk$are$trusted$
python$libraries$and$a$python$interpreter$
Veil?$
Pillage$
Veil$Catapult$
• exe_delivery$
• python_injector$
• powershell_injector$
Primitives$
• pth?wmis$
• pth?winexe$
• Impacket?smbexec$
• Impacket$
Veil%Pillage*
New$Features$
powershell_stager*
▪  Last$month,$the$Veil$team$released$
custom?written,$‘pure’$powershell$
meterpreter$stagers$:$
– reverse_tcp/reverse_http/reverse_https$
▪  These$don’t$utilize$any$shellcode,$and$
work$great$with$the$passing?the?hash$
toolkit$
Output/Cleanup*
▪  Logs$logs$logs$
▪  Also,$we$want$to$leave$boxes$how$we$
found$them$
– Clients$are$so$picky$:)$
▪  Why$not$do$all$of$this$in$a$nice$and$
systematic$way$
Random*features*
▪  State$preservation$
– On$exit/rage$quit,$all$options$preserved$
▪  MSF$database$interaction$
– pull$in$existing$hosts$and$credential$sets$
▪  Tab?completion,$error?checking,$
complete$command$line$options,$etc.$
External*Integration*
▪  Veil?Pillage$contains$complete$
command$line$ﬂags$for$whatever$you$
can$think$of$
▪  Makes$it$easy$to$script?up$and$integrate$
Veil?Pillage$into$your$own$code$
$
▪  see$./VeilGPillage.py'Gh'
External*Integration*
▪  Similar$to$Veil?Evasion,$it’s$easy$to$
integrate$Veil?Pillage’s$functionality$as$a$
library$import:$
from$modules.management$import$check_uac$
module$=$check_uac.Module($
$targets=[“192.168.1.100”],$$
$creds=[[“Administrator”,$“password”]])$
module.run()$
print$module.output$
Veil?$
Pillage$
Primitives$
• pth?wmis$
• pth?winexe$
• Impacket?smbexec$
• Impacket$