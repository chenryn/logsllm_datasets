# Rotexy：兼具银行木马和勒索软件功能的移动恶意软件
## 0x00 概述
随着特洛伊木马活动的激增，我们决定深入分析并跟踪一些流行恶意软件家族的演变过程。除了[Asacub](https://securelist.com/the-rise-of-mobile-banker-asacub/87591/)之外，Rotexy家族的移动木马是迄今为止我们发现最为活跃且有趣的目标之一。在2018年8月至10月期间，该木马发起了超过70,000次攻击，主要针对俄罗斯境内的用户。

Rotexy的一个显著特征在于它同时使用三种命令源：
1. Google Cloud Messaging (GCM) 服务：通过[Google服务器](https://securelist.com/gcm-in-malicious-attachments/57471/)以JSON格式向移动设备发送小型邮件；
2. 恶意C&C服务器；
3. 短信消息。

这种“多功能性”自Rotexy的第一个版本就已存在，并一直延续到后续的所有变种中。根据我们的研究，这个木马起源于2014年10月首次被检测为`Trojan-Spy.AndroidOS.SmsThief`的短信间谍软件，而其后续版本则归类于另一个家族：`Trojan-Banker.AndroidOS.Rotexy`。

较新版本的Rotexy将银行木马与勒索软件的功能相结合，通常以`AvitoPay.apk`或类似名称传播，可以从诸如`youla9d6h.tk`、`prodam8n9.tk`、`prodamfkz.ml`以及`avitoe0ys.tk`等网站下载。这些域名由特定算法生成，前缀代表热门分类广告服务，后跟随机字符串及两字母顶级域名。在详细介绍最新版Rotexy及其特性之前，让我们先简要回顾一下从2014年以来该木马的发展历程。
## 0x01 Rotexy的进化历史
### 2014-2015
自2014年被发现以来，Rotexy的主要功能和传播方式基本保持不变：通过网络钓鱼短信中的链接进行传播，并提示用户安装应用。一旦启动，恶意软件会请求设备管理员权限，并开始与C&C服务器通信。

直到2015年中期，Rotexy都采用纯文本JSON格式与C&C通信，其中C&C地址直接硬编码在代码内，未经过任何加密处理。某些版本甚至利用动态生成的子域名作为C&C地址。

初次连接时，木马会向C&C发送受感染设备的IMEI信息，随后接收一套用于处理来自银行、支付系统及移动运营商短信的规则（包括电话号码、关键字和正则表达式）。例如，它可以自动回复短信并立即删除原始内容。

接着，Rotexy会继续发送有关智能手机的信息给C&C，如型号、电话号码、运营商名称、操作系统版本及IMEI。对于每个后续请求，恶意软件都会生成新的子域名。此外，木马还注册了Google Cloud Messaging服务，以便通过该渠道接收命令。

### 2015-2016
自2015年中起，Rotexy开始采用AES算法加密与C&C之间的通信数据，并通过POST请求向形式为`/[number]`的相对地址（数字范围0-9999）发送数据，其中数字由伪随机生成。从2016年初开始，在部分样本中实现了从`assets`文件夹提取加密DEX可执行文件的算法。这一阶段的Rotexy不再使用动态生成的子域名。

### 2016
到了2016年中期，网络犯罪分子重新启用了动态生成的子域名，但除此之外没有其他重大变化。年末时，部分变种开始在其`assets/www`文件夹中包含一个名为`card.html`的钓鱼页面，用以窃取用户的银行卡详情。

### 2017-2018
进入2017年后，`assets`文件夹中出现了更多HTML钓鱼页面，如`bank.html`、`update.html`和`extortionist.html`。同年，Rotexy变种开始使用一次性域名（由随机字符组成），并通过IP地址直接联系C&C服务器。此时，木马也积极采用了各种混淆技术，比如在`DEX`文件中添加无用代码或密钥来解密APK中的主执行文件。

## 0x02 最新版分析（2018）
现在让我们聚焦于Rotexy的最新版本（SHA256: `ba4beb97f5d4ba33162f769f43ec8e7d1ae501acdade792a4a577cd6449e1a84`），详细探讨其特点。

### 启动应用
初次运行时，木马会检查是否处于仿真环境或非俄罗斯地区。如果满足任一条件，应用程序将展示一个伪装页面，并在日志中记录含有语法错误和拼写错误的俄语文本。

若检查通过，Rotexy将注册GCM并启动`SuperService`以监控是否拥有设备管理员权限。每当服务停止时，`SuperService`会追踪状态并自动重启。木马每秒都会检查自身权限，如果没有获得所需权限，则会无限循环地请求用户授予。

一旦用户同意授权，木马会隐藏图标并显示另一界面。如果检测到用户试图撤销其权限，Rotexy会关闭手机屏幕阻止操作。若成功撤销权限，木马将继续不断请求恢复权限。此外，当尝试撤回权限时，如果`SuperService`未能及时响应关闭屏幕，木马还会尝试警告用户。

在程序运行过程中，Rotexy会持续监视以下事件：
- 手机开机/重启；
- 木马进程终止（此时木马将自动重启）；
- 发送短信（此时手机将切换至静音模式）。

### C&C通信
默认C&C地址已被硬编码进Rotexy代码中。木马将以伪随机算法生成相对地址，并在此基础上发送信息。不同版本可能还会使用动态生成的子域名。

木马会在本地SQLite数据库中存储与C&C相关的信息及从受感染设备收集的数据。首先，它会在管理面板注册，并从C&C获取操作所需的指令（如SMS拦截模板和HTML页面上的显示文本）。

Rotexy会拦截所有收到的短信，并根据从C&C接收到的模板处理这些消息。收到短信时，木马会将手机设为静音并关闭屏幕，使用户不易察觉新到达的消息。必要时，木马会将截获的短信转发至指定号码。若未收到处理短信的具体规则，所有短信将被保存在当地数据库中，并上传至C&C服务器。

除了常规设备信息外，木马还会向C&C报告当前运行的所有进程列表及已安装的应用程序列表。这有助于攻击者识别正在运行的安全软件或银行应用。

基于从C&C接收到的不同命令，Rotexy可以执行如下操作：
- **START, STOP, RESTART** - 控制`SuperService`的启动、停止与重启。
- **URL** - 更新C&C地址。
- **MESSAGE** - 向指定号码发送带有特定文本的短信。
- **UPDATE_PATTERNS** - 在管理面板上注册。
- **UNBLOCK** - 解锁电话（即取消木马的设备管理员权限）。
- **UPDATE** - 从C&C下载并安装APK文件，可用于更新应用程序或安装其他恶意软件。
- **CONTACTS** - 将从C&C收到的文本发送给所有联系人，可能是为了进一步传播。
- **CONTACTS_PRO** - 根据地址簿中某个联系人的信息请求特定消息文本。
- **PAGE** - 使用C&C或本地数据库中的`User-Agent`值访问指定URL。