# 山东省城市商业银行合作联盟有限公司
## 交易路径跟踪与全局统一流水号和日志规范
### 发布日期：2019年04月

#### 目录
1. 交易路径跟踪模型
    1.1 交易路径
    1.2 交易路径组成要素
    1.3 应用组件
    1.4 组件
    1.5 组件实例
    1.6 组件连接
    1.7 组件连接实例
    1.8 组合交易
    1.9 联机技术接口
        1.9.1 联机交互模式
        1.9.2 联机交互动作
    1.10 技术接口实例
2. 交易路径跟踪图形化展示
    2.1 交易路径跟踪拓扑图
        2.1.1 联盟内部系统发起
        2.1.2 联盟外部系统发起
        2.1.3 说明
    2.2 交易路径跟踪时序图
        2.2.1 联盟内部系统发起
        2.2.2 联盟外部系统发起
3. 全局统一流水规范
    3.1 全局统一流水号
        3.1.1 作用
        3.1.2 组成规范
        3.1.3 字段说明
        3.1.4 使用规则
        3.1.5 范例
    3.2 调用路径号
        3.2.1 作用
        3.2.2 组成规范
        3.2.3 字段说明
        3.2.4 使用规则
        3.2.5 范例
    3.3 联机交互动作职责分解
        3.3.1 联盟外部系统发起点
        3.3.2 联盟内部系统发起点
        3.3.3 中间节点
        3.3.4 联盟内部末端节点
        3.3.5 联盟外部末端节点
    3.4 联机交互动作职责图解
        3.4.1 联盟内部系统发起
        3.4.2 联盟外部系统发起
    3.5 应用场景分析
        3.5.1 场景一：联盟统建系统内部发起的交易
        3.5.2 场景二：联盟端第三方系统发起的交易
        3.5.3 场景三：行内外围系统发起的交易
        3.5.4 场景四：人民银行发起的来账交易
        3.5.5 场景五：银联发起的来账交易
        3.5.6 场景六：网联发起的来账交易
        3.5.7 场景七：联盟内部系统批量、定时任务
        3.5.8 场景八：消息推送类场景
    3.6 传递规则
        3.6.1 分布式域
        3.6.2 中间件组件
        3.6.3 数据库组件
        3.6.4 专用组件
        3.6.5 第三方系统
        3.6.6 历史负债直连系统
    3.7 持久化规则
        3.7.1 持久化到日志文件
        3.7.2 持久化到数据库
    3.8 报文规范支持
        3.8.1 ESB XML联机交易接口规范改造
        3.8.2 核心CICS报文改造
4. 交易路径跟踪日志规范
    4.1 适用范围
    4.2 日志记录方式
    4.3 存放目录及日志文件命名
    4.4 日志记录时机
    4.5 日志级别
    4.6 日志滚动方式
    4.7 编码格式
    4.8 分隔符
    4.9 内容格式
    4.10 数据行定义
5. 系统间数据流向及架构关系
    5.1 日志分析平台
    5.2 数据下档
    5.3 架构管理工具
    5.4 BPC系统
6. 附录
    6.1 附录一：应用系统编号表
    6.2 附录二：应用组件编号
    6.3 附录三：应用组件实例编号

### 1. 交易路径跟踪模型
#### 1.1 交易路径
**定义**：交易路径从一个业务功能执行的角度，以系统外部人员角色操作（UI）触发，或者从联盟内部、外部系统调用触发，按照交易顺序，跨组件之间的交互形成交易路径。

**说明**：
- 交易路径是一个完整的业务调用过程，可以有多个组件参与，可以包含多段组件连接。
- 对请求应答型的交易，交易路径分为请求和应答两条线路，从最初发起请求的组件实例开始，沿交易路径到达服务方，然后应答从服务方开始沿交易路径返回请求方。
- UI操作触发的动作可以分为两类，一类是向后台服务发起请求，一类不向后台服务发送请求。这里只关注向后台服务发起请求的动作。
- 一次UI操作触发的服务调用可能不止一次，每一次都视为一笔独立的交易，即一次操作可触发多次交易，每次交易都有自己独立的交易路径。
- 对于联盟内系统间调用触发的，例如电子银行定时任务发起的交易，一次向服务端系统的调用，视为一笔独立的交易，具有独立的交易路径。
- 对于联盟外部系统(人行、银联、第三方、行内外围等)发起对联盟系统的调用，每一次调用视为一笔独立的交易，具有独立的交易路径。

#### 1.2 交易路径组成要素
交易路径由以下要素组成：
- **组件实例**：在交易路径上用圆角矩形表示。
- **组件连接实例**：在交易路径上用一条线段（单向消息模式）或两条线段（请求应答模式）表示。
- **技术接口实例**：在交易路径上用组件实例边界上的小圆点表示。
- **联机交互动作**：在交易路径上用箭头表示。

#### 1.3 应用组件
应用组件是应用功能的封装，它封装了行为和数据，通过接口公开服务，供外部使用。应用组件是模块化、可重用、可替换的。

#### 1.4 组件
应用组件、数据库组件、中间件组件、专用组件，合称为组件。

#### 1.5 组件实例
组件实例是组件配置、部署、运行在一个节点，对外提供服务的物理实体。组件实例包括应用组件实例、中间件组件实例、数据库组件实例和专用组件实例。

**说明**：组件实例是运行态的。一个组件可以在多个节点部署，形成实例集群或者主备实例。

#### 1.6 组件连接
组件连接是组件交互双方消息（或文件）逻辑传递通道，组件连接的两端分别是供接口和需接口。

#### 1.7 组件连接实例
部署视图中组件连接的实例化，是组件交互双方消息（或文件）传递通道。

#### 1.8 组合交易
服务使用方发起一个调用，通过ESB、服务整合平台或者特定的组件调用后台多个服务提供方的技术接口，组合形成应答。

**说明**：组合交易是一类特殊的组件连接，区别于常见的供需接口一对一的组件连接，供需接口是一对多连接，作为独立的架构要素种类处理。

#### 1.9 联机技术接口
实现联机交易的技术接口。

##### 1.9.1 联机交互模式
联机交互模式有请求应答和单向消息两种模式。

##### 1.9.2 联机交互动作
联机交互动作是指在交易过程中，各组件之间进行的数据交换和处理动作。

#### 1.10 技术接口实例
技术接口的实例化，属于部署视图的元素，是组件实例的对外交互窗口，组件实例通过技术接口实例与其他组件实例进行通信。

### 2. 交易路径跟踪图形化展示
#### 2.1 交易路径跟踪拓扑图
##### 2.1.1 联盟内部系统发起
详细描述联盟内部系统发起的交易路径及其组件连接。

##### 2.1.2 联盟外部系统发起
详细描述联盟外部系统发起的交易路径及其组件连接。

##### 2.1.3 说明
对拓扑图中的各个元素进行详细说明。

#### 2.2 交易路径跟踪时序图
##### 2.2.1 联盟内部系统发起
详细描述联盟内部系统发起的交易路径及其时间序列。

##### 2.2.2 联盟外部系统发起
详细描述联盟外部系统发起的交易路径及其时间序列。

### 3. 全局统一流水规范
#### 3.1 全局统一流水号
##### 3.1.1 作用
全局统一流水号用于唯一标识每一笔交易，确保交易的唯一性和可追溯性。

##### 3.1.2 组成规范
流水号由多个字段组成，具体结构如下：
- **前缀**：表示交易类型
- **时间戳**：表示交易发生的时间
- **序列号**：表示同一时间段内的交易序号
- **校验位**：用于校验流水号的正确性

##### 3.1.3 字段说明
详细说明每个字段的含义和长度。

##### 3.1.4 使用规则
详细说明流水号的生成规则和使用方法。

##### 3.1.5 范例
提供具体的流水号范例。

#### 3.2 调用路径号
##### 3.2.1 作用
调用路径号用于标识交易路径中的每一段调用，确保调用路径的唯一性和可追溯性。

##### 3.2.2 组成规范
调用路径号由多个字段组成，具体结构如下：
- **前缀**：表示调用类型
- **时间戳**：表示调用发生的时间
- **序列号**：表示同一时间段内的调用序号
- **校验位**：用于校验调用路径号的正确性

##### 3.2.3 字段说明
详细说明每个字段的含义和长度。

##### 3.2.4 使用规则
详细说明调用路径号的生成规则和使用方法。

##### 3.2.5 范例
提供具体的调用路径号范例。

#### 3.3 联机交互动作职责分解
##### 3.3.1 联盟外部系统发起点
详细描述联盟外部系统发起的联机交互动作及其职责。

##### 3.3.2 联盟内部系统发起点
详细描述联盟内部系统发起的联机交互动作及其职责。

##### 3.3.3 中间节点
详细描述中间节点的联机交互动作及其职责。

##### 3.3.4 联盟内部末端节点
详细描述联盟内部末端节点的联机交互动作及其职责。

##### 3.3.5 联盟外部末端节点
详细描述联盟外部末端节点的联机交互动作及其职责。

#### 3.4 联机交互动作职责图解
##### 3.4.1 联盟内部系统发起
提供联盟内部系统发起的联机交互动作职责图解。

##### 3.4.2 联盟外部系统发起
提供联盟外部系统发起的联机交互动作职责图解。

#### 3.5 应用场景分析
##### 3.5.1 场景一：联盟统建系统内部发起的交易
详细描述联盟统建系统内部发起的交易场景。

##### 3.5.2 场景二：联盟端第三方系统发起的交易
详细描述联盟端第三方系统发起的交易场景。

##### 3.5.3 场景三：行内外围系统发起的交易
详细描述行内外围系统发起的交易场景。

##### 3.5.4 场景四：人民银行发起的来账交易
详细描述人民银行发起的来账交易场景。

##### 3.5.5 场景五：银联发起的来账交易
详细描述银联发起的来账交易场景。

##### 3.5.6 场景六：网联发起的来账交易
详细描述网联发起的来账交易场景。

##### 3.5.7 场景七：联盟内部系统批量、定时任务
详细描述联盟内部系统批量、定时任务场景。

##### 3.5.8 场景八：消息推送类场景
详细描述消息推送类场景。

#### 3.6 传递规则
##### 3.6.1 分布式域
详细描述分布式域的传递规则。

##### 3.6.2 中间件组件
详细描述中间件组件的传递规则。

##### 3.6.3 数据库组件
详细描述数据库组件的传递规则。

##### 3.6.4 专用组件
详细描述专用组件的传递规则。

##### 3.6.5 第三方系统
详细描述第三方系统的传递规则。

##### 3.6.6 历史负债直连系统
详细描述历史负债直连系统的传递规则。

#### 3.7 持久化规则
##### 3.7.1 持久化到日志文件
详细描述持久化到日志文件的规则。

##### 3.7.2 持久化到数据库
详细描述持久化到数据库的规则。

#### 3.8 报文规范支持
##### 3.8.1 ESB XML联机交易接口规范改造
详细描述ESB XML联机交易接口规范改造的内容。

##### 3.8.2 核心CICS报文改造
详细描述核心CICS报文改造的内容。

### 4. 交易路径跟踪日志规范
#### 4.1 适用范围
明确日志规范的适用范围。

#### 4.2 日志记录方式
详细描述日志的记录方式。

#### 4.3 存放目录及日志文件命名
详细描述日志文件的存放目录及命名规则。

#### 4.4 日志记录时机
详细描述日志的记录时机。

#### 4.5 日志级别
详细描述日志的级别划分。

#### 4.6 日志滚动方式
详细描述日志的滚动方式。

#### 4.7 编码格式
详细描述日志的编码格式。

#### 4.8 分隔符
详细描述日志中的分隔符使用规则。

#### 4.9 内容格式
详细描述日志内容的格式。

#### 4.10 数据行定义
详细描述日志数据行的定义。

### 5. 系统间数据流向及架构关系
#### 5.1 日志分析平台
详细描述日志分析平台的功能和架构。

#### 5.2 数据下档
详细描述数据下档的过程和要求。

#### 5.3 架构管理工具
详细描述架构管理工具的功能和使用方法。

#### 5.4 BPC系统
详细描述BPC系统的功能和架构。

### 6. 附录
#### 6.1 附录一：应用系统编号表
提供应用系统编号表。

#### 6.2 附录二：应用组件编号
提供应用组件编号表。

#### 6.3 附录三：应用组件实例编号
提供应用组件实例编号表。