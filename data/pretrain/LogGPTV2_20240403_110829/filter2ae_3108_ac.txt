诚实节点（左）、f 个恶意节点、f个诚实节点（右）。然后：
1、恶意 primary 给 f 个诚实节点（左）和 f 个恶意节点 发送 mi，加上 primary 自己刚好满足 2f + 1。
2、恶意 primary 给 f 个诚实节点（右）和 f 个恶意节点 发送 mj，加上 primary 自己也刚好满足 2f + 1。
3、这里在一个 view 的 prepare 阶段针对同一个 sequence number 产生了两个交易，也就是所谓的双花。
双花攻击会对资金产生重要的危害。
## 2.3 更多场景要分开讨论
由上两个小节可知，若容错边界被打破，对实际业务产生的危害随着业务场景的不同而不同，要根据场景去分析。
**具体案例分析：**
有一个基于 PBFT 改进的溯源链案例，案例主要做溯源服务。溯源服务的核心在于存证。案例认为 PBFT 存在如下问题：
1.目前 PBFT 算法应用于联盟链中最主要的问题是动态性。原始 PBFT 网络中的节点数量固定，节点的增减都需要对共识网络进行初始化。
2.对于 PBFT 的共识过程中可以看出，PBFT
算法对于作恶的主节点并没有惩罚机制，仅仅是切换视图更换主节点，而拜占庭节点仍然停留在共识网络中。因此在区块链的实际应用中需要进行改进。
3.PBFT 算法对于网络的带宽要求过高，带宽随着节点的数量的增加呈多项式级别的增长。因此可以与其他的共识算法进行融合改进，选举出代表节点进行 PBFT
算法，从而减小网络带宽的开销。
**案例进行了如下改进：**
1.在共识网络中部署一条智能合约，当网络中的某些节点达到合约要求的时候，例如节点所拥有的资产的大小，节点对于区块链的贡献等，那么他就可以进入候选节点的名单中。
2.对达成共识的主节点进行一定的奖励，并对恶意或不作为节点进行惩罚甚至取消废除恶意节点，从而提高网络中拜占庭节点作恶的代价，维护整个区块链网络的稳定性。
3.在共识网络中加入超时重传机制，从而提高消息传达的成功率，并且可以减小进行视图切换的次数，从而增加区块链网络的出块效率。
**针对以上改进，我们分析可能的威胁模型如下：**
1.引入智能合约动态调整共识节点数量增加了 PBFT
的扩展性，但是智能合约的合约本身是否安全是一个需要考量的因素。智能合约可能存在编码不当问题，如各类溢出漏洞；逻辑不当问题，如对共识节点条件判断出现漏洞；权限不当问题，如智能合约被越权访问。
2.引入奖惩制度有助于提高网络稳定性，但是额外的处理逻辑可能引入新的问题，如逻辑不当问题。
3.引入超时重传机制有利于提高出块效率，但是超时重传会影响其他节点计算超时时间，可能导致逻辑混乱。
4.不管如何更改和优化协议，编码安全问题都是共性问题。
**对区块链的安全影响分析如下：**
1.以上威胁模型可导致共识协议被攻破，共识可以被人为操控。
2.溯源信息可以被伪造，共识不验证上链信息的合法性，任意伪造信息都可上链。
3.溯源信息可以被删除。
4.溯源链被拒绝服务。
对溯源链来说，信息的可靠性是最为重要的，共识协议被攻破之后，可靠性不复存在。
# 03 小 结
拜占庭将军问题最初由 Leslie Lamport 和另外两人在1982年提出，距今已有近 40
年的历史，在互联网领域，可以称的上是一个“经典”的问题。近年来，随着区块链技术的发展，拜占庭将军问题也重新焕发了生机。BFT
协议在区块链中有了广泛的应用。在蓬勃发展之余，威胁模型也变得多样，本文做了简要的分析。BFT
被攻破之后，对区块链安全的影响不能一概而论，需要看区块链上所承载的业务。我们也做了案例分析。
拜占庭将军问题是个经典问题，针对拜占庭协议的研究工作非常多，本文也只是管中窥豹，无法完全展现 BFT
的精妙，感兴趣的读者还需要自己做研究。由于区块链方案更新迭代的速度极快，不排除一些信息滞后，欢迎读者斧正。
本文图片来源于：
刘秋杉. Practical Byzantine Fault Tolerance[EB/OL].2014-09-09.
区块链安全：基于区块链网络攻击的方式原理详解
参考资料
* * *