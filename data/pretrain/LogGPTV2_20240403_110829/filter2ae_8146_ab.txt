Stuxnet Dropper的资源在安装执行过程中会释放载荷，震网落地文件如表3-2所示。
**落地文件主要名称** | **文件功能 ** _*/_** *资源** **ID**  
---|---  
**~WTR4141.tmp** | usb loader  
**~DF540C.tmp** | 状态标记文件  
**~wtr4132.tmp** | USB感染中的dropper名  
**DEFRAG[RANDLNT].tmp** | 共享感染中的dropper名  
**Oem7a.pnf** | 加密的主dll  
**mdmeric3.PNF** | 90字节的数据文件  
**mdmcpq3.PNF** | Stuxnet配置文件  
**oem6C.PNF** | 日志  
**MrxCls.sys** | 资源242  
**MrxNet.sys** | 资源201  
**s7otbxdx.dll** | 被替换的Step7文件  
**s7hkimdb.dll** | 资源202（stuxnet loader）  
**cc_tlg7.sav** | CAB文件 包 含一个加载和执行Stuxnet的DLL  
**winmic.fts** | 资源209（数据文件）  
**winsta.exe** | 利用打印机漏洞传播时释放的可执行文件版Stuxnet  
**sysnullevnt.mof** | 托管对象格式文件  
**~WTR4141.tmp** | usb loader  
**~DF540C.tmp** | 状态标记文件  
按资源类型，对照其编译时间戳，获得PE类型资源版本迭代，如图3-1所示，由图能够看出资源202、210都存在3个可能的版本，资源208存在2个可能的版本，其余各资源都仅有1个版本。另外资源207、231仅存在少数样本，在后续版本的Stuxnet中已经删除。
**图 3-1 PE类型资源版本迭代**
安天CERT基于对震网样本集及已有数据的分析，绘制了震网整体运行框架，它包含传播和安装执行。
**图 3-2 震网整体运行框架图**
震网的传播主要包括两种方式，一种是移动设备感染，利用LNK漏洞或者通过autorun.inf文件进行传播；另一种是网络传播，涉及WinCC数据库感染、网络共享传播、打印机后台处理程序漏洞传播、Windows服务器漏洞传播等多种方式。这两种传播方式虽然不同，但最终都会释放主DLL文件，进行后续的安装和执行操作。震网感染目标系统后，会启动RPC服务器监听网络，将网络上其他感染计算机都连接到RPC服务器，并查询远程计算机安装的震网版本，以执行对等通信和更新，如果远程计算机上的震网版本较新，则本地计算机就会请求新版本并自我更新，如果远程机器上的震网版本较旧，则本地计算机上的震网就将自身副本发送给远程机器。这样，震网可以在任何感染机器上更新并最终传播到所有机器。
在安装执行中，传播释放的主DLL文件首次加载时调用导出函数15执行一系列检查工作，包括检查配置数据是否为最新、检查操作系统是否为64位、检查操作系统版本是否匹配，如果不符合其安装执行要求，则退出；此外，检查目标系统是否具备管理员权限，如果不具备，则利用资源250中两个当时的零日漏洞进行提权以获取最高权限；之后，检查目标系统安装了哪些反病毒软件以及哪个进程适合注入；导出函数15完成上述规定的检查后，震网就会调用导出函数16。
导出函数16是震网的主安装程序。首先，检查目标系统配置是否匹配、注册表键值是否为特定值、当前时间是否小于终止时间，如果不符合这些安装执行要求，则退出；继续执行，震网通过创建全局互斥量与不同的组件通信，并再次检查目标系统当前时间，确保只在小于终止时间的目标系统上执行；从磁盘中读取其加密版本，解密、加载到内存中，从新加载的文件中调用导出函数6，获取自身配置数据的版本信息，如果与磁盘文件的版本相同，则继续执行；震网提取、解密资源201和资源242，并将两个驱动文件写入磁盘，分别用于持久化和隐藏恶意文件，为了规避检测，震网会修改这两个文件的时间以匹配目标系统目录下的其他文件时间；创建rootkit服务和注册表，以实现震网的持久化，并再次创建全局互斥量；为了继续安装和传播，震网将控制权传递给其他导出函数，一种是将主DLL文件注入service.exe进程，并调用导出函数32，以感染新连接的移动设备，以及启动RPC服务器，另一种是将主DLL文件注入Step7进程，并调用导出函数2，以感染所有指定的Step7文件。
### **4、威胁框架视角下的震网解读**
能够研发类似震网的复杂高级的恶意代码，是源自高级网空威胁行为体具有充足资源和成本支撑能力。其作业过程具有庞大的工程体系和人员团队为支撑条件，是一系列复杂的动作组合。与此同时，复杂的过程并不必然全部由“高级”攻击手段和“高级”装备支撑。防御方的一些低级配置错误和未及时修补的漏洞会成为威胁行为体攻击的入口；高级网空威胁行为体也会劫持和利用低级网空威胁行为体所掌控的僵尸网络等资源，这些都使局面更为复杂。
解读复杂的攻击行动，并驱动防御的改善，需要有更理想的结构化方法。杀伤链等模型用于解构震网式的复杂攻击，依然显得不足，需要进一步改善。威胁框架作为一种对攻击过程更为结构化和数据化的描述方法，开始成为改善防御能力的威胁认知基础。当前较为流行的威胁框架主要有MITRE提出的ATT&CK，和NSA提出的《NSA/CSS技术网空威胁框架》（NSA/CSS
Technical Cyber Threat
Framework）。后者对前者做了一定的借鉴工作。鉴于NSA/CSS技术网空威胁框架，更具有情报机构的背景，因此更适合推演类似震网级别的A2PT攻击。
从威胁框架出发，针对威胁每个阶段、逐个行为推演，无论对评估当前防御体系及相关安全产品能力的有效性和合理性，还是对形成体系化的防御规划与建设目标，都是一种有益的工作。2019年6月，安天发布的“方程式组织”攻击SWIFT服务提供商EastNets事件复盘分析报告中[5]，将事件涉及的威胁行为映射到了“NSA/CSS威胁框架”V2版本中。
将震网事件涉及到的威胁行为映射到威胁框架的类别与动作，如图4-1所示。
**图 4-1 震网事件映射到威胁框架**
在震网行动中共涉及21个目标中的83种行为，其中包括推测的和确定执行的行为。
**表 4-1 震网事件中涉及的类别与动作**
**威胁框架类别** | **威胁框架动作** | **具体行为**  
---|---|---  
**Administration** **（行动管理与资源保障）** | 规划 |
可能存在对行动过程分析；在发起攻击前可能会先确定战略与目标、预先制定行动计划、选择目标受害者和获得执行行动的批准；  
资源开发 | 在行动前，搭建模拟靶场环境进行测试；在行动前可能会获取行动需要的基础设施、资金、联盟和伙伴，并对相关人员进行培训； |  
研究 | 可能会存在对目标进行收集信息，研究目标网络能力； |  
**Preparation ** _*（_ * **目标勘察与环境整备）** | 侦察 | 可能会选择潜在受害者调查网络环境与设备；  
环境预置 | 应用数据文件中添加可利用点；分配行动所需基础设施；可能会对目标进行预制载荷； |  
**Engagement** **（接触目标与进攻突防）** | 投递 |
通过可移动介质投递载荷；利用漏洞投递载荷；利用受感染主机投递载荷；通过硬编码数据库服务器密码感染WinCC机器；可能会通过对目标供应链/授信源入侵；  
利用 |
RPC远程执行漏洞（MS08-067）；快捷方式文件解析漏洞（MS10-046）；打印机后台程序服务漏洞（MS10-061）；内核模式驱动程序漏洞（MS10-073）；任务计划程序程序漏洞（MS10-092）；
|  
**Presence** **（持久化驻留潜伏）** | 执行 | 注入lsass.exe与csrss.exe等系统进程；以特殊方式注入自身；替换西门子
step7驱动文件；运行无文件载荷；使用KERNEL32.DLL.ASLR.XXXX这样的DLLName调用LoadLibraryA以加载主DLL文件；利用远程服务；写入多个PNF文件；  
内部侦察 | 枚举账户和权限；检测安全产品；通过注册表查找特定键；枚举进程；扫描连接的移动设备； |  
提权 | 快捷方式文件解析漏洞；RPC远程执行漏洞；打印机后台程序服务漏洞；Windows Win32K.sys本地提权（MS10-073）； |  
凭证访问 | 转储凭证、定位凭证； |  
横向移动 |
利用对等网络；利用密码哈希认证；通过利用一个漏洞，允许自动执行可移动驱动器；通过网络共享在远程计算机中复制和执行其本身；写入远程文件共享；通过硬编码数据库服务器密码感染WinCC机器；
|  
持久化 | MrxCIs.sys驱动文件会注册成为启动服务；创建新服务；修改服务配置；利用库搜索劫持； |  
**Effect** **（致效能力运用）** | 监控 | 将信息记录到oem6c.pnf文件中；监控插入的USB设备；  
渗出 | 泄露数据或信息；将数据存储到指定位置；通过HTTP向攻击者发送被感染机器的基本信息； |  
修改 | 在PLC上隐藏修订的代码，基本上是PLC的rootkit；修改进程结果；通过修改可编程逻辑控制器代码重新编程工业控制系统；修改机器间通信； |  