formodeltraining,weobtainprelogandpostlogeventsequenceLSTMmodels. These
twoLSTMmodelsarecombinedtoformacompleteanomalydetectionmodel. Ofcourse,
howtocombinethesetwomodelsrequirestheuseofanotherfeature(length)ofthelog
eventsequence. Duringmodeltraining,wecountthedistributionofthelengthofthelog
eventsequenceforpreliminaryfilteringofthelogeventsequence. Finally,accordingto
the log verification dataset and many tuning experiments, we obtain the most suitable
modelparameters.
Inthedetectionphase,weusethelogtestdatasettoperformmodeldetection. First,
wegeneratealogeventsequencefromtheoriginallogthroughtheparsedlogtemplateand
thendeterminetheusemethodofthepreorderandpostorderdetectionmodelsaccording
tothesequencelengthcharacteristics. Accordingtotheselectionofthemodel,acertainlog
eventintheincominglogeventsequenceisdetected,andwhetherthelogeventdeviates
fromthepredictionresultofthenormallogsequenceisdetermined. Ifthereistoomuch
deviation, it is judged as anomaly. If the result of the judgment is normal, the next log
event detection work is performed on the sequence until the entire log event sequence
detectioniscompletedorananomalylogeventthatdeviatesfromthenormallogsequence
isfound. Ifacertainlogeventinthelogsequenceispredictedtobeabnormal,theentire
logsequenceismarkedasabnormal. Thismethodprovidesafeedbackmechanism,and
logsmarkedasanomalieswillbeprovidedtotheuserforfurtheroperation. Iftheuser
findsthatthedetectedabnormalmarkingresultisfalselyreported,thefalselyreportedlog
eventsequencecanbeaddedtothetrainingset. Whentherearemanyfalsepositives,users
canretrainthemodelaccordingtothenewtrainingsettograduallyupdatethemodel.
Symmetry2022,14,454 5of21
3. Methodology
ThispaperproposesasystemloganomalydetectionmethodbasedondualLSTM.
Through the cooperation of two LSTM models, the gradient problem of a single LSTM
modelinlongsequenceprediction[27]issolved,andtheperformanceofanomalydetection
isimproved. Figure2showsthethreemainmodulesofthismethod: logparsing,logkey
anomaly detection model, and anomaly detection workflow model. In the rest of this
section,wewillcoverthevariouspartsofthismethodindetail.
3.1. LogParser(Spell)
Inthelogparsingmodule,weconverttheoriginallogintoastructuredlogthrough
thelogparser. Logparsingisconsideredacommonpreprocessingofunstructuredlogs
andisanimportantpartofmostloganalysistasks. Therearemanyparsingmethodsat
present,amongwhichSpelliscurrentlythebetterone. Itisalogparsingmethodbasedon
thelongestcommonsubsequence(LCS).Thetimecomplexityofthismethodforprocessing
eachlogentryeisclosetolinear(linearlyrelatedtothesizeofe)andunstructuredlog
messagesareparsedintostructuredlogtemplates. AlthoughSpellisabetterloganalysis
methodatpresent,thelogtemplateparsedbythismethodisnotcompletelycorrect. If
itisuseddirectlytogeneratelogeventsandcomposealogeventsequenceforanomaly
detection,itisdifficulttoachieveoptimalresults.
ThemaindatasetofthisarticleisHDFSlogs,whichcanwellreflecttheeffectiveness
oftheLogLSmethod. Table1showstheHDFSlogtemplateparsedbytheSpellmethod.
Thereare37typesofHDFSlogtemplatesobtained. Wecanseethatsomelogtemplates
areduplicated. Forexample,thethreelogeventtemplatesin{E7,E8,E9}aresimilar,and
E8cancontaintheothertwo. Ifwedirectlyusethesetemplatestogeneratelogsequences,
it will seriously affect the effect of log anomaly detection, so this method has room for
improvement. Thisarticleaddsmanualdeduplicationstepstofurtheroptimizetheeffect
oflogparsingandachieveahigherlevelofdetection.
Table1.TheeventtemplateobtainedfromparsingtheHDFSlogbythespellmethod.
EventId EventTemplate
E1 Addinganalreadyexistingblock(*)
E2 Verificationsucceededfor(*)
... ...
E7 writeBlock(*)receivedexceptionjava.io.IOExceptionConnectionresetbypeer
E8 writeBlock(*)receivedexception(*)
E9 writeBlock(*)receivedexceptionjava.io.IOExceptionCouldnotreadfromstream
... ...
E14 PacketResponder(*)(*)Exceptionjava.io.IOExceptionBrokenpipe
E15 PacketResponder(*)2Exception(*)
E16 PacketResponder(*)1Exception(*)
... ...
E36 Deletingblock(*)file(*)
E37 BLOCK*NameSystem.allocateBlock(*)(*)
Toimproveaccuracy,weneedtoeliminateduplicatedatainthelogeventtemplate
obtainedbySpell. Wedosobyselectingafewrepresentativelogentriesthatconformto
eacheventtemplateandcheckwhethertheyarerepeated. Iftheyarerepeated,according
tothefrequencyofthelogeventtemplate,theyareunifiedintotheeventtemplatewiththe
mostfrequentoccurrences. ThelogeventsinTable1arereprocessed,andtheresultsare
showninTable2.
Symmetry2022,14,454 6of21
Table2.HDFSlogeventtemplateafterprocessing.
EventId EventTemplate
E1 Addinganalreadyexistingblock(*)
E2 (*)Verificationsucceededfor(*)
... ...
E7 writeBlock(*)receivedexception(*)
E8 PacketResponder(*)forblock(*)Interrupted.
E9 Receivedblock(*)ofsize(*)from(*)
... ...
E14 ExceptioninreceiveBlockforblock(*)(*)
E15 Changingblockfileoffsetofblock(*)from(*)to(*)metafileoffsetto(*)
E16 (*):Transmittedblock(*)to(*)
... ...
BLOCK*NameSystem.addStoredBlock:addStoredBlockrequestreceivedfor(*)
E28
on(*)size(*)However,itdoesnotbelongtoanyfile.
E29 PendingReplicationMonitortimedoutblock(*)
In this article, we first use the system log template to divide the unstructured log
into several parts (e.g., date, time, content, etc.), and then further extract meaningful
information(e.g.,events)fromtheseparts. Usually,theeventconsistsofthreeparts(time
stamp,signatureandparameters). Figure3illustratestheHDFSlogparsingprocess. The
signatureattributeisthelogtemplate. Thespecificalgorithmisimplementedasfollows:
1. Theinitializationprogramfirstdefinesalogobject(LCSObject)suchasthelogkey
(LCSseq)andlinenumberlist(lineIds),anddefinesalogobjectlist(LCSMap),which
isusedtosaveeachlogobject.
2. Enterthelogfileandreaditlinebyline.
3. Readalineoflog,andthentraversetheLCSMaptoseeifthereisalreadyanLCSObject
inthelistthathasthesameLCSseq(logkey). IfsuchanLCSObjectexists,addthe
lineIdsofthislogtothelineIdsoftheLCSObject.Ifnot,thengenerateanewLCSObject
toLCSMap.
4. Keepreadingtheloguntiltheend.
Figure3.Exampleoflogparser.
Symmetry2022,14,454 7of21
ThetemplateextractedfromtheloginFigure3is“PacketResponder(*)forblock(*)
terminating”,where“(*)”representsthevariableparameter. Ifyouenteranewlogentry
“PacketRespo-nder2forblockblk_2529569087635823495termina-ting”,Spell’sideaisnotto
extractthelogkeydirectly,buttoextractitincomparison. Afterreceivingthenewlyinput
logentry,theLCSMapistraversedandanLCSObjectwhoseLCSseqis“PacketResponder
0forblockblk_6137960563260046065terminating”isfound. Then,theLCSiscalculated
as“PacketResponderforblockterminating”. Whenthelengthofthesequenceisbetween
1/2and1timesthelengthoftheinputentry,itisjudgedthatitbelongstothesamelog
key, soitismerged, andthelineIdsofthislogentryisaddedtothelineIdsattributeof
theLCSObject.
Then,theobtainedinitiallogtemplateismanuallyfilteredtoobtainthefinallogevent
template. The log entries of the entire dataset are then processed to obtain log events
of all log entries, which are used to form log event sequences and perform subsequent
modeltraining.
3.2. AnomalyDetection
HDFSlogsareparsedtoobtainthelogtemplate,andtheeventidofeachlogentry
isobtainedbasedonthelogtemplate. Thevalueofsomeparameterscanbeusedasan
identifierforaspecificexecutionsequence,suchasblock_idinHDFSlogs. Theseidentifiers
cancombinelogentriestogetherorunwraplogentriesgeneratedbyconcurrentprocesses
toseparateasinglethreadsequence. AsshowninTable3,theHDFSlogeventsequencein
thisarticleisgeneratedbasedonblock_id.
Table3.ThedemoofHDFSlogeventssequences.
SequenceID LogEventsSequences
0 E5E5E5E22E11E9E11E9E11E9E26E26E26E23E23E23E21E21E21
1 E22E5E5E5E11E9E11E9E11E9E26E26E26
2 E22E5E5E5E26E26E26E11E9E11E9E11E9E23E23E23E23E21E21E21
3 E22E5E5E5E11E9E11E9E11E9E26E26E26
E22E5E5E5E26E26E26E11E9E11E9E11E9E4E3E3E3E4E3E4E3E3E4
4
E3E3E23E23E23E21E21E21
5 E5E22E5E5E11E9E11E9E11E9E26E26E26
Systemlogdetectionwillbeperformedonthelogeventsequence(showninTable3)
obtainedbythelogparser. AssumingthatK={k ,k ,k ,...,k }isalogeventsequence
1 2 3 n
transformedbyalogblock,eachlogkeyrepresentsalogpathcommandatacertaintime,
andtheentirelogeventsequencereflectsthesequentialexecutionpathofthelog. Todetect
theentiresequence,itisnecessarytocheckwhethereachlogeventisnormal. Letk beone
i
ofthenKsequences,representingthelogeventtobedetected. ThemodelinDeepLog
takes the influence of the forward sequence on k to determine whether it is abnormal.
i
ForHDFSlogs,thisarticlenotonlyconsiderstheimpactoftheforwardsequenceonthe
nextlogeventbutalsoconsiderstheimpactofthebackwardsequenceonthepreviouslog
eventandcombinesthemtofurtherdeterminewhethertheeventisabnormal. Figure4
summarizestheclassificationsettings. Supposetisthesequenceidofthenextlogevent,
w1isthesetofhmostrecentlogeventsintheprevioussequence,andw2isthesetofh
mostrecentlogeventsinthesubsequentsequence. Inotherwords,w1={m t−h,...,m t−2,
m t−1}, w2={m t+h,..., m t+2, m t+1}, whereeachmtisinK,andisthelogeventfromthe
logentryet. Thesamelogeventinw1andw2mayappearmultipletimes. Theoutputof
thetrainingphaseistwoconditionalprobabilitydistributionmodelsPr1(m =k |w1)and
t i
Pr2=(m =k |w2)foreachk ∈ K(i =1,...,n).
t i i
Symmetry2022,14,454 8of21
Figure4.Anoverviewoflogeventsanomalydetectionmodel.
Toextractcontextfeaturesandpotentialsymmetryinformation[28]fromsequence
relationships,twolongshort-termmemorynetworks(LSTMs)[29–31]areusedinLogLSto
trainthepreorderandpostorderlogeventsequences. EachLSTMnodehasahiddenstate
h t−iandacellstateC t−i,bothofwhicharepassedtothenextnodetoinitializeitsstate. The
purposeistoobtaintheprobabilityofthecurrentlogeventk throughthepreorderandthe
i
subsequentlogeventk throughthemodelandthensetaprobabilitylimit(parametersg1,
i
g2)todeterminewhetherthecurrentlogeventisanomalous.
Theformulaforforwardpropagationis:
Inputgate:
I H C
at = ∑ w xt+ ∑ w bt−1+ ∑ w st−1 (1)
ι iι i hι h cι c
i=1 h=1 c=1
bt = f(at) (2)
ι ι
Forgetgate:
I H C
at = ∑ w xt+ ∑ w bt−1+ ∑ w st−1 (3)
φ iφ i hφ h cφ c
i=1 h=1 c=1
bt = f(at) (4)