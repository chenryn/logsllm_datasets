![](media/image23.jpeg){width="3.812512029746282in"
height="1.8645833333333333in"}
6.  卸载系统盘，挂回源实例（[[https://help.aliyun.com/document_detail/146752.html]{.underline}](https://help.aliyun.com/document_detail/146752.html)），启动机器，可以正常进入系统。
## [Windows 控制台登录不能切换用户](#_bookmark0)
> 简介：客户将原来的用户禁用了，新建了一个用户，但是控制台登录的时候无法切换到新的用户。
>
> 客户还把允许远程禁止了，因此无法通过远程登录。
### 背景
> 客户将原来的用户禁用了，新建了一个用户，但是控制台登录的时候无法切换到新的用户。
>
> 客户还把允许远程禁止了，因此无法通过远程登录。
![](media/image24.jpeg){width="4.918326771653543in"
height="1.7334372265966753in"}
### 解决方案
1.  把系统盘挂载到其他实例，挂载步骤请参考
    [[https://help.aliyun.com/document\_]{.underline}](https://help.aliyun.com/document_detail/146752.html)
    [[detail/146752.html]{.underline}](https://help.aliyun.com/document_detail/146752.html)。
2.  更改以下组策略对应的注册表。
> 组策略：计算机配置 \\Windows 设置 \\ 安全设置 \\ 本地策略 \\ 安全选项
> \\ 交互式登录 : 不显示最后的用户名。
>
> 注册表：HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVer-
> sion\\policies\\system\\dontdisplaylastusername
### 具体步骤如下
a.  cmd 命令行输入 regedit，找到 HKEY_LOCAL_MACHINE, 然后点击 file，选择
    Load Hive。
![](media/image25.png){width="4.716288276465442in"
height="1.9170822397200349in"}![](media/image14.png){width="3.565008748906387in"
height="2.51875in"}
b.  找到系统盘，并加载
    windows\\system32\\config\\software（注：一定要找到正确的系统盘！！！默认加载的是当前实例的
    C 盘，需要改到源实例的系统盘比如 D 盘））, 任意命名（例如 test）。
![](media/image22.jpeg){width="4.92625656167979in"
height="2.7256244531933507in"}
c.  找到
    HKEY_LOCAL_MACHINE\\test\\Microsoft\\Windows\\CurrentVersion\\pol-
    icies\\system\\dontdisplaylastusername，改为 1。
![](media/image26.jpeg){width="4.841681977252843in"
height="1.6916666666666667in"}
3.  卸载系统盘，挂回源实例（[https://help.aliyun.com/document_detail/146752.htm]{.underline}l），启动机器，看到登录界面用户名是空的，这样就可以手动输入用户名和密码进行登录。
![](media/image27.png){width="4.919687226596675in"
height="1.5965616797900262in"}
## [启动报错"An operating system wasn\'t found"](#_bookmark0)
> 简介：分享一个启动报错"An operating system wasn\'t found"的案例。
### 问题现象
> 启动报错"An operating system wasn\'t found"。
![](media/image28.png){width="4.9246052055993in"
height="1.816353893263342in"}
### 排查
1.  把系统盘挂载到其他实例进行排查，挂载步骤请参考
    > [[https://help.aliyun.com/]{.underline}](https://help.aliyun.com/document_detail/146752.html)
    > [[document_detail/146752.html]{.underline}](https://help.aliyun.com/document_detail/146752.html)。
2.  发现源实例缺失 bootmgr
    文件（注：一定要找到正确的系统盘！！！需要改到源实例的系统盘比如 D
    盘）。
> 启动报错"An operating system wasn\'t found" \ 简介：针对 windows 重置密码不生效问题的详细排查。
### 问题
> 控制台重置密码后重启服务器仍然不生效。
### 排查
1.  把系统盘挂载到其他实例进行排查，挂载步骤请参考
    > [[https://help.aliyun.com/]{.underline}](https://help.aliyun.com/document_detail/146752.html)
    > [[document_detail/146752.html]{.underline}](https://help.aliyun.com/document_detail/146752.html)。
2.  控制台更改密码的日志在
    ProgramData\\aliyun\\vminit\\log，查看日志没有关于更改密码的记录，怀疑是控制台更改的密码并没有被触发。
3.  查看源实例系统盘完全没有可用空间（注：一定要找到正确的系统盘！！！需要查看的是源实例的系统盘比如
    D 盘）），这个解释了第 2 步日志没有记录的原因。
![](media/image31.png){width="4.904086832895888in"
height="0.8114577865266842in"}
4.  清理磁盘空间后，更改密码，重启后发现仍然不生效。
5.  再次更改密码，重启后直接进入安全模式，发现更改密码是生效了的，说明密码更改过程没有问题。
> windows重置密码不生效 \
> 注：对于安全模式正常，直接启动异常的问题，多是跟三方有关，因为安全模式下只加载一些支撑系统能够成功启动的必要组件（有些系统组件也不会加载）。
>
> 安全模式正常重启后，再输入密码还是提示报错，基本可以确认是三方问题，一般如下排查方案：
>
> 在安全模式下：
a.  运行 msconfig，将所有非 microsoft
    的服务和启动项都禁用，具体请参考如下步骤
> [https://support.microsoft.com/zh-cn/help/929135/how-to-perform-a-]{.underline}
> [clean-boot-in-windows]{.underline}
>
> 禁用后重启发现仍然报错密码不正确，看起来还是有三方影响。
>
> 我们碰到过很多 msconfig
> 将三方服务和启动项禁用后仍然不行的问题，这个是因为一般三方应用除了服务外还会有三方驱动，这些驱动在系统启动过程中就会被加载，这时候就需要我们去查看对应注册表信息（驱动和服务的注册表都是HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services）。
b.  查看注册表 HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services，
    > 有一个可疑注册表项，从命名来看就是重置密码相关的，将 start
    > 类型改成 4（4表示禁用）。
![](media/image32.jpeg){width="4.8485454943132105in" height="1.5725in"}
> 之后重启服务器后使用密码可以正常登录了。
### 后续
> 从现有信息来看，服务器可能已经中毒或者被入侵，安全起见还是建议客户备份好数据重置系统。
>
> []{#_bookmark8 .anchor}启动报错"No bootable device" \ 简介：三个步骤排查启动报错"No bootable device"。
### 问题
> 启动时报错截图如下。
![](media/image33.png){width="4.946675415573053in"
height="0.933332239720035in"}
### 排查
1.  从报错基本可以判断是识别不到启动盘。
2.  把系统盘挂载到其他实例进行排查，挂载步骤请参考
    > [[https://help.aliyun.com/]{.underline}](https://help.aliyun.com/document_detail/146752.html)
    > [[document_detail/146752.html]{.underline}](https://help.aliyun.com/document_detail/146752.html)。
> 挂载后，发现原来实例系统盘的活动分区标志没有了（一定要找到正确的系统盘！！！需要改到源实例的系统盘比如
> D 盘）），右键选择"将分区标记为活动分区"。
>
> ![](media/image34.png){width="4.980007655293089in" height="1.8525in"}
![](media/image35.png){width="4.959998906386701in" height="1.0in"}
3.  卸载系统盘，挂回源实例（[https://help.aliyun.com/document_detail/146752.htm]{.underline}l），启动机器，之后系统正常启动。
# [第二章 windows 激活问题排查](#_bookmark0)
## [激活常用排查方案](#_bookmark0)
> 简介：分享激活常用排查方案。
1.  确认 software protection
    服务是否正常运行，如果是运行中状态，重启服务确保能正常重启。
![](media/image36.jpeg){width="3.934021216097988in"
height="0.5127077865266841in"}
2.  能够正常 ping kms 服务器和 telnet kms 1688 端口（确保 DNS
    > 配置的是内网DNS）经典网络下是内网 10 网段地址，对应
    > kms.aliyun-inc.com 域名，经典网络内网 DNS：10.143.22.116 和
    > 10.143.22.118。
> VPC 环境下是 100 网段内部服务地址，对应 kms.cloud.aliyuncs.com，vpc
> 内网 DNS：100.100.2.136 和 100.100.2.138。
3.  确保使用的是正常的激活码（各版本 Windows
    > 系统产品密钥参考：[[https://technet.]{.underline}](https://technet.microsoft.com/en-us/library/jj612867.aspx)
    > [[microsoft.com/en-us/library/jj612867.aspx]{.underline}](https://technet.microsoft.com/en-us/library/jj612867.aspx)）。
> 运行 slmgr /upk 卸载激活码。
>
> 运行 slmgr /ipk \ 安装激活码。
>
> ![](media/image37.png){width="4.870900043744532in" height="0.5775in"}
4.  重命名 tokens.dat 文件后再试下：
> 注：以下步骤可能会对环境有影响，建议先进行快照备份。对于 Windows Vista
> 或 Windows Server 2008。
>
> 以管理员身份运行下面 CMD 命令：
>
> 重启客户端两次使配置生效。
>
> 对于 Windows 7 或 Windows Server 2008 R2。以管理员身份运行下面 CMD
> 命令：
>
> 重启客户端两次使配置生效。
>
> 对于Windows 8, Windows Server 2012, Windows 8.1, or Windows Server
> 2012 R2。
>
> 以管理员身份运行下面 CMD 命令：
>
> 重启客户端两次使配置生效。
## [window 机器 ping 不通 KMS 服务器](#_bookmark0)
> 简介：分享 window 机器 ping 不通 KMS 服务器的案例。
1.  检查防火墙是否开启，临时关闭再测试一下。
![](media/image38.jpeg){width="4.967584208223972in"
height="1.8751038932633421in"}
2.  安全组内网出方向是否做了限制，如果有限制，临时放开所有地址测试一下[[https://help.aliyun.com/document_detail/25471.htm]{.underline}l](https://help.aliyun.com/document_detail/25471.html)。
3.  ![](media/image39.jpeg){width="4.8124956255468065in"
    height="2.1381244531933508in"}在网卡属性里将 DNS
    服务器设置成内网地址（VPC 是 100.100.2.136
    和100.100.2.138，经典网络是 10.143.22.116 和 10.143.22.118）。
## [windows 激活报错 0xC004F074](#_bookmark0)
> 简介：windows 激活报错 0xC004F074 的案例分享。
1.  运行 slmgr /ato 后无任何输出。
2.  查看应用程序日志，发现报错 0xC004F074。
![](media/image40.jpeg){width="4.901887576552931in"
height="2.831874453193351in"}
> 信息提示已经向 KMS 服务器发送了请求，所以问题就是 KMS 服务器没有响应
>
> 进一步核实发现指向了错误的 KMS 服务器，客户是 VPC
> 网络，截图中显示客户使用的是经典网络 KMS
> 服务器（kms.aliyun-inc.com）。
>
> ![](media/image41.jpeg){width="4.555415573053368in"
> height="2.897915573053368in"}
3.  运行命令行更改服务器，之后重启 software protection 服务后问题依旧。
![](media/image42.png){width="4.884782370953631in"
height="0.3987489063867017in"}
4.  通过注册表更改 KMS 服务器（kms.cloud.aliyuncs.com），之后重启
    software protection 服务后激活成功。
![](media/image43.jpeg){width="4.363330052493438in"
height="1.6912489063867016in"}
## [windows 激活报错 0x80070020 或 0x80041010](#_bookmark0)
> 简介：windows 激活报错 0x80070020 或 0x80041010。
### 问题现象
> 激活报错，slmgr /ato 后报错代码类似如下：
![](media/image44.png){width="4.910251531058618in"
height="1.0047911198600175in"}
### 排查步骤
1.  运行命令行 slmgr /dlv 同样报错，说明是 slmgr
    本身命令有问题，不像是网络层面的问题。
2.  查看 msinfo32，发现报错，提示 winmgmt 服务有问题。
> ![](media/image45.jpeg){width="4.885939413823272in"
> height="3.662916666666667in"}
3.  重启 winmgmt 服务，可以正常重启，说明 winmgmt 服务本身正常，需要
    > rebuild wmi 数据库。