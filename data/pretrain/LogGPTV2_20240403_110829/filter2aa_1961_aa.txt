Catching)Malware)En)Masse):)DNS)and)IP)style!
!
Dhia!Mahjoub!PI:EMAIL!@DhiaLite!!
Thibault!Reuille!PI:EMAIL!@ThibaultReuille!!
Andree!Toonk!PI:EMAIL!@atoonk!!!!
Part!1:!Catching!Malware!DNS!style!
!FasFlux!botnets!as!proxy!networks!
Part!2:!Catching!Malware!IP!style!
!ASN!graph!
!Suspicious!sibling!ASNs!
!DetecJng!sibling!ASNs!through!BGP!outages!
!DetecJng!Malicious!IP!ranges!
!DetecJng!Malicious!subdomains!under!compromised!
domains!
Part!3:!Visualizing!knowledge!with!our!3D!engine!
!OpenGraphiJ!
!SemanJc!Nets!
!ParJcle!Physics!
Conclusion!
Part!1:!
!
Catching!Malware!DNS!style!
!
!
Background!
AQackers!seek!to!keep!their!operaJons!online!at!all!Jmes!
The!Network!=!the!hosJng!infrastructure!is!
)
)
)
)CRUCIAL)
!
Spam!
Phishing!
Malware!distribuJon!
Botnets!
Fast!ﬂux!botnets!
Fast!ﬂux!botnets!serving!as!proxy!networks!
Extra!evasion/protecJon!layer!for!actual!CnCs!
Infected!hosts!!FF!proxy!network!!Backend!CnCs!
Usages!of!proxy!network:!
YServe!malware!pushed!from!CnCs!down!to!infected!clients!
(via!driveYby,!spam,!etc.)!
YForward!communicaJon!from!infected!clients!to!CnCs!
e.g.!Kelihos!TTL!0,!zbot!TTL!150!
Zeus!Crimeware!
YControl!panel!
YConﬁg!ﬁles!(contains!urls!for:!drop!zone,!extra!payload,!extra!
conﬁgs,!target!websites!for!web!injects)!
YBinary!ﬁles!
YBuilder!
CharacterisJcs:!
YSteals!ﬁnancial!data:!online!bank!account!info,!credit!card!
YSteals!sensiJve!credenJals!
YWeb!injects!
Zeus!CnCs!
YCompromised!sites!
YBulletproof!or!free!hosJng!
YFast!ﬂux!botnet!
!
CnC!domains!used!for!3!types!of!purposes:!
YServe!conﬁguraJon!ﬁles!
YServe!binary!ﬁles!
YDrop!zones!
Zbot!proxy!network!
Fast!ﬂux!domains!with!TTL!=!150!sec!sharing!same!infected!
hosts!infrastructure!
!
DetecJon!methods:!
1)  Periodic!batch!pig!job!
2)  IP!harvesJng!+!streaming!auth!DNS!+!ﬁltering!heurisJcs!
!
!
DetecJon!methods!(1)!
YPeriodic!Pig!job!to!retrieve!domains!with!TTL!=!150!from!
authoritaJve!logs!
YFilter!out!noise!domains!such!as!spam,!legiJmate!domains!
known!to!use!TTL!=!150!
YBuild!“domain!to!IP”!biparJte!graph!
YExtract!largest!connected!component!
YIdenJfy!new!zbot!CnC!domains!to!block!
YAdd!IPs!from!largest!connected!component!to!pool!of!zbot!IPs!
!
Streaming!AuthoritaJve!DNS!
•  Tap!into!processed!authoritaJve!DNS!stream!before!
it’s!consolidated!into!a!persistent!DB!
•  asn,!domain,!2LD,!IP,!NS_IP,!Jmestamp,!TTL,!type!
•  Faster!than!DNSDB!on!Hadoop!
•  100s!–!1000s!entries/sec!(from!subset!of!resolvers)!
•  Need!to!implement!your!own!ﬁlters,!detecJon!
heurisJcs!
DetecJon!methods!(2)!
YStart!with!a!seed!of!idenJﬁed!zbot!CnC!domains!
YConJnuously!harvest!IPs!and!add!them!to!pool!of!zbot!IPs!
YCheck!for!any!domain!in!authlogs!DNS!stream!whose!IP!or!
NS_IP!is!in!pool!of!zbot!IPs!
YIdenJfy!new!zbot!CnC!domains!to!block!
YAdd!new!domains!to!seed!
!
!
Zbot!proxy!network!
YFast!ﬂux!domains!riding!on!proxy!network!used!as!CnCs!postYinfecJon!
by!Kuluoz!
YVarious!Exploit!kits!lead!to!dropping!of!malware!and!infected!host!
joins!Asprox!botnet!
YMalware!used!to!gain!control!of!hosts!is!Kuluoz/Dofoil!
InfecJon!vectors:!
YDriveYby,!exploit!kit!
YSpam!emails:!embedded!links!leading!to!malware,!or!malware!in!
aQachment!(fake!Flash!update)!
Zbot!proxy!network!
HTTP!traﬃc!url!paQerns!
Monitoring!HTTP!traﬃc!to!CnCs!using:!
YSinkhole!
and!
YVirusTotal!
!
!!
!
HTTP!traﬃc!url!paQerns!
A!Zeus!CnC!domain!can!serve!3!types!of!urls:!
YConﬁg!
YBinary!
YDrop!zone!
Example!Zeus!CnC!observed!traﬃc!
seorubl.in,!GET!/forum/popap1.jpg,!ConﬁgURL!
reznormakro.su,!GET!/winconf/kernl.bin,!ICE!IX,!ConﬁgURL!
orbitmanes.ru,!GET!/01.exe,!KINS,!BinaryURL!
reportonh.com,!GET!/pack32/sysconf.exe,!BinaryURL!
sytemnr.com,!GET!/pack32/sysconf.exe,!BinaryURL!
!
!!
HTTP!traﬃc!url!paQerns!
ET!TROJAN!W32/Asprox.ClickFraudBot!CnC!Beacon!
GET!/b/eve/0008f258b0e99d069756f425!
GET!/b/letr/002D63501FC3E082B1E9F290!
GET!/b/shoe/1480!
!
ET!TROJAN!W32/Asprox.ClickFraudBot!POST!CnC!Beacon!
POST!/b/opt!
POST!/b/req!
MulJple!Asprox!type!callbacks!and!binary!downloads!followed!by!click!fraud!
HTTP!traﬃc!url!paQerns!
Beaconing!and!announcing!version,!make,!OS!
GET!/1/?
uid=01604555&ver=1.14&mk=bb3b62&os=S2000&rs=adm&c=14&rq=0!
!
os=S2000!
os=Win07!
os=Win_V!
os=WinXP!
os=Win08!
!
HTTP!traﬃc!url!paQerns!
Other!urls!to!get!binaries!and!conﬁgs!
azg.su,!GET!/coivze7aip/modules/bot.exe!
tundraYtennes.com,!GET!/infodata/sow32.dll!
tundraYtennes.com,!GET!/infoYdata/sow32.dll!
beeYpass.com,!GET!/info/sow32.dll!
!
quaranteYml.com,!GET!/nivoslider/jquery/!
GET!/nivoslider98.45/ajax/!
GET!/nivoslider98.45/jquery/!
GET!/nivoslider/ajax/!
Pony!panel!on!zbot!proxy!network!
Ymarmedladkos.com!
!
Pony!panel!on!zbot!proxy!network!
YPony!1.9!leaked!for!Trojan!Forge!in!late!2012!
YBotnet!controller!via!a!panel,!user!management,!logging,!database,!
staJsJcs!
YInfo!stealer!
YWin32/Fareit!
!
Payload!delivered!via:!
YDriveYby/Exploit!kit!
YAQachment!in!spam!emails!
!
Pony!panel!on!zbot!proxy!network!
Pony!panel!on!zbot!proxy!network!
Yp/Panel.zip!—!controlling!php!scripts!
Yincludes/design/images/modules/*!!—!images!for!each!zeus!plugin!
supported/tracked!
Yincludes/password_modules.php!—!contains!array!with!all!sowware!it!
tries!to!steal!credenJals!for!
Yincludes/database.php!—!contains!db!schema!and!accessors!
Ycharacter!set!cp1251!used!everywhere!
Ymysql!storage!engine!is!MyISAM!
Yconﬁg.php!date_default_Jmezone_set(‘Europe/Moscow’)!
Pony!panel!on!zbot!proxy!network!
Pony!panel!on!proxy!network!
Pony!panel!on!proxy!network!
Pony!panel!on!zbot!proxy!network!
YSearching!for!certain!strings!leads!to!several!more!sites!with!
open!panels!with!some!sites!hosJng!other!malware!payload!
YExample:!
Pony!panel!on!zbot!proxy!network!
Pony!panel!on!zbot!proxy!network!
epvpcash.net16.net/Panel/temp/!
hg{g{g{fg.net/pony/temp/!
hQp://pantamaJ.com/dream/Panel/temp/!
hQp://pantamaJ.com/wall/Panel/temp/!
mastermetr.ru/steal/Panel/temp/!
microsow.blg.lt/q/temp/!
santeol.su/p/temp/!
terraYaraucania.cl/pooo/temp/!
thinswares.com/panel/temp/!
www.broomeron.com/pn2/temp/!
www.kimclo.com/cli/temp/!
www.sumdfase2.net/adm/temp/!
www.tripplem2.com/images/money/temp/!
TLD!distribuJon!of!CnCs!!
Sample!of!925!zbot!CnC!domains!
!
!
!
Proxy!network!hosts!geoYdistribuJon!
Sample!of!170,208!IPs!of!the!zbot!proxy!network!Map!
!!
!
!
!
!
Proxy!network!hosts!geoYdistribuJon!
Clients!phoning!to!CnCs!
2,220,230!DNS!lookups!to!CnCs!over!24!hours!Map!
!
!
Clients!phoning!to!CnCs!
CnC!domains!and!related!samples!
YSample!of!337!zbot!CnC!domains!
Y208!diﬀerent!samples!(sha256!communicated!with!the!CnCs)!
!
Top!recorded!sample!names:!
Trojan[Spy]/Win32.Zbot!
TrojanDownloader:Win32/Upatre!
!
YUpatre!is!used!as!a!downloader!for!Zeus!GameOver!
YSent!as!aQachment!in!spam!emails!delivered!by!Cutwail!botnet!
!
Part!2:!
!
Catching!Malware!IP!style!
!
!
MoJvaJon!
• 
Examine!malicious!IP!ranges!in!certain!ASNs!from!a!new!
perspecJve!
• 
Look!beyond!the!simple!counJng!of!number!of!bad!domains,!
bad!IPs!hosted!on!preﬁxes!of!an!ASN!
How)?)
• 
Look!at!topology!of!AS!graph!
• 
Look!at!ﬁner!granularity!than!BGP!preﬁx:!subYallocated!
ranges!within!BGP!preﬁxes!
Internet!101!&!BGP!
Internet!101!&!BGP!
Meet!the!Internet!
Network!of!Networks,!it’s!a!Graph!!
!
Each!organizaJons!on!the!Internet!
is!called!an!Autonomous!system.!
!
Each!dot!represents!an!
Autonomous!system!(AS).!!
!
AS!is!idenJﬁed!by!a!number.!
OpenDNS!is!36692,!Google!is!
15169.!
!
Each!AS!has!one!or!more!Preﬁxes.!!
36692!has!56!(ipv4!and!IPv6)!
network!preﬁxes.!
!
BGP!is!the!glue!that!makes!this!
work!!!
AS!graph!
• 
BGP!rouJng!tables!
• 
Valuable!data!sources!
• 
Routeviews!!
• 
CidrYreport!!
• 
Hurricane!Electric!database!hQp://bgp.he.net/!
• 
500,000+)BGP)preﬁxes)
• 
46,000+)ASNs)
AS!graph!
•  Route!Views!hQp://archive.routeviews.org/bgpdata!
AS!graph!
•  Cidr!Report!hQp://www.cidrYreport.org/as2.0/!
AS!graph!
•  Hurricane!Electric!database!hQp://bgp.he.net/!
AS!graph!
• 
Build!AS!graph!
• 
Directed!graph:!node=ASN,!a!directed!edge!from!an!ASN!
to!an!upstream!ASN!
• 
TABLE_DUMP2|1392422403|B|96.4.0.55|11686|67.215.94.0/24|
11686!4436!2914!36692|IGP|96.4.0.55|0|0||NAG||!
AS!graph!
Focus)of)this)study:)