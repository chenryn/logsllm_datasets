Introduction
We have written this small book for those who only start
gettingacquaintedwiththeworldofPostgreSQL.Fromthis
book,youwilllearn:
I PostgreSQL—whatisitallabout? ....................3
II What’snewinPostgreSQL12 .........................15
III InstallationonLinuxandWindows ..................23
IV Connectingtoaserver,writingSQLqueries,
andusingtransactions ................................33
V LearningtheSQLlanguageonademodatabase....59
VI UsingPostgreSQLwithyourapplication..............87
VII Minimalserversetup.................................101
VIII AboutausefulpgAdminapplication................109
IX Advancedfeatures:
full-textsearch, ......................................115
JSONformat, ..........................................122
foreigndatawrappers ...............................134
X Educationandcertificationopportunities ..........147
XI Keepingupwithallupdates ........................165
XII AboutthePostgresProfessionalcompany..........169
Wehopethatourbookwillmakeyourfirstexperiencewith
PostgreSQLmorepleasantandhelpyoublendintothePost-
greSQLcommunity.Goodluck!
3
i
I About PostgreSQL
PostgreSQListhemostfeature-richfreeopen-sourcedata-
basesystem.Developedintheacademicenvironment,ithas
broughttogetherawidedevelopercommunitythroughits
longhistory.Nowadays,PostgreSQLoffersallthefunctional-
ityrequiredbymostcustomersandisactivelyusedallover
theworldtocreatehigh-loadbusiness-criticalsystems.
SomeHistory
ModernPostgreSQLoriginatesfromthePOSTGRESproject,
whichwasledbyMichaelStonebraker,professoroftheUni-
versity of California, Berkeley. Before this work, Michael
Stonebraker had been managing INGRES development. It
wasoneofthefirstrelationaldatabasesystems,andPOST-
GRESappearedasaresultofrethinkingallthepreviouswork
andthedesiretoovercomethelimitationsofitsrigidtype
system.
Theprojectwasstartedin1985,andby1988anumberof
scientificarticleshadbeenpublishedthatdescribedthedata
model,POSTQUELquerylanguage(SQLwasnotanaccepted
standardatthetime),anddatastoragestructure.
POSTGRESissometimesconsideredtobeaso-calledpost-
relational database system. Relational model restrictions
hadalwaysbeencriticized,beingtheflipsideofitsstrictness
4 andsimplicity.Ascomputertechnologieswerespreadingin
i allspheresoflife,newtypesofapplicationsstartedtoap-
pear,andthedatabaseshadtosupportcustomdatatypes
andsuchfeaturesasinheritanceorcreatingandmanaging
complexobjects.
Thefirstversionofthisdatabaseappearedin1989. Itwas
beingimprovedforseveralyears,butin1993,whenversion
4.2wasreleased, theprojectwasshutdown. However, in
spiteoftheofficialcancellation,opensourceandBSDlicense
allowedUCBerkeleyalumni,AndrewYuandJollyChen,to
resumeitsdevelopmentin1994. TheyreplacedPOSTQUEL
querylanguagewithSQL,whichhadbecomeagenerallyac-
ceptedstandardbythattime. Theprojectwasrenamedto
Postgres95.
In1996,itbecameobviousthatthePostgres95namewould
notstandthetestoftime, andanewnamewasselected:
PostgreSQL.Thisnamereflectstheconnectionbothwiththe
originalPOSTGRESprojectandtheSQLadoption.Onehasto
admitthatthisnameisquitehardtopronounce,butnever-
theless,weshouldpronounceitas“Post-Gres-Q-L,”orsimply
“postgres,”butnot“postgre.”
The first PostgreSQL release had version 6.0, keeping the
originalnumberingscheme. Theprojectgrew,anditsman-
agementwastakenoverbyatfirstasmallgroupofactive
usersanddevelopers,whichwasnamed“PostgreSQLGlobal
DevelopmentGroup.”
Development
Allthemaindecisionsaboutdevelopingandreleasingnew
PostgreSQLversionsaretakenbytheCoreteam,whichcon-
sistsoffivepeopleatthemoment. 5
i
Apart from the developers who contribute to the project
fromtimetotime,thereisagroupofmaindeveloperswho
have made a significant contribution to PostgreSQL. They
are called major contributors. There is also a group of
committerswhohavethewriteaccesstothesourcecode
repository.Groupmemberschangeovertime,newdevelop-
ers join the community, others leave the project. For the
currentlistofdevelopers, seePostgreSQLofficialwebsite:
www.postgresql.org.
ThecontributionofRussiandevelopersintoPostgreSQLis
quitesignificant. Thisisarguablythelargestglobalopen-
sourceprojectwithsuchavastRussianrepresentation.
Vadim Mikheev, a software programmer from Krasnoyarsk
whousedtobeamemberoftheCoreteam,playedanim-
portantroleinPostgreSQLevolutionanddevelopment. He
createdsuchkeycorefeaturesasmulti-versionconcurrency
control(MVCC),vacuum,write-aheadlog(WAL),subqueries,
triggers.Vadimisnotinvolvedwiththeprojectanymore.
OlegBartunov,aprofessionalastronomerandresearchsci-
entist at Sternberg Astronomical Institute of Lomonosov
Moscow State University, has been contributing to Post-
greSQLforalmost25years. In2015,togetherwithTeodor
SigaevandAlexanderKorotkov,whocurrentlyhavethefor-
malstatusofPostgreSQLmajorcontributors,hehasstarted
thePostgresProfessionalcompany.
ThemainareasoftheircontributionarePostgreSQLlocal-
ization(nationalencodingsandUnicodesupport),full-text
search,workingwitharraysandsemi-structureddata(hstore,
json,jsonb),newindexmethods(GiST,SP-GiST,GINandRUM,
Bloom).Theyhavecreatedalotofpopularextensions.
6 PostgreSQLreleasecycleusuallytakesaboutayear.Inthis
i timeframe,thecommunityreceivespatcheswithbugfixes,
updates, and new features from everyone willing to con-
tribute.Traditionally,allpatchesarediscussedinthepgsql-
hackersmailinglist.Ifthecommunityfindstheideauseful,
itsimplementationiscorrect,andthecodepassesamanda-
torycodereviewbyotherdevelopers,thepatchisincluded
intothenextrelease.
Atsomepoint(usuallyinspring,abouthalfayearbeforethe
release),codestabilizationisannounced: allnewfeatures
getpostponedtillthenextversion;onlybugfixesandim-
provementsforthealreadyincludedpatchesareaccepted.
Withinthereleasecycle,betaversionsappear.Closertothe
endofthereleasecycleareleasecandidateisbuilt,andsoon
anewmajorversionofPostgreSQLisreleased.
Themajorversionusedtobedefinedbytwonumbers,but
in2017itwasdecidedtostartusingasinglenumber.Thus,
version9.6wasfollowedbyPostgreSQL10,whilethelatest
availableversionisPostgreSQL12, whichwasreleasedin
October2019.
Asthenewversionisbeingprepared,developerscanfindand
fixbugsinit. Themostcriticalfixesarebackportedtothe
previousversions.Thecommunityusuallyreleasesupdates
quarterly;these“minor”versionsaccumulatesuchfixes.For
example,version10.6containsbugfixesforthe10.5release,
whileversion11.2providesfixesforPostgreSQL11.1.
Support
PostgreSQL Global Development Group supports major re-
leases for five years. Both support and development are
managedthroughmailinglists.Acorrectlyfiledbugreport 7
hasallthechancestobeaddressedveryfast:bugfixesare i
oftenreleasedwithin24hours.
Apart from the community support, a number of compa-
nies all over the world provide 24x7 commercial support
forPostgreSQL,includingRussia-basedPostgresProfessional
(www.postgrespro.com).
CurrentState
PostgreSQL is one of the most popular databases. Based
onthesolidfoundationofacademicdevelopment,overits
20-yearhistoryPostgreSQLhasevolvedintoanenterprise-
levelproductthatisnowarealalternativetocommercial
databases. Youcanseeitforyourselfbylookingatthekey
featuresofPostgreSQL12,whichisthelatestreleasedver-
sionrightnow.
ReliabilityandStability
Reliabilityisespeciallyimportantinenterprise-levelappli-
cationsthathandlebusiness-criticaldata.Forthispurpose,
PostgreSQLprovidessupportforhotstandbyservers,point-
in-timerecovery,differenttypesofreplication(synchronous,
asynchronous,cascade).
Security
PostgreSQLsupportssecureSSLconnectionsandprovides
variousauthenticationmethods,suchaspasswordauthen-
8 tication(includingSCRAM),clientcertificates,andexternal
i authenticationservices(LDAP,RADIUS,PAM,Kerberos).
Forusermanagementanddatabaseaccesscontrol,thefol-
lowingfeaturesareprovided:
• creatingandmanagingnewusersandgrouproles
• role-andgroup-basedaccesscontroltodatabaseobjects
• row-levelandcolumn-levelsecurity
• SELinuxsupportviaabuilt-inSE-PostgreSQLfunctionality
(MandatoryAccessControl)
Russian Federal Service for Technical and Export Control
(FSTEC)hascertifiedacustomPostgreSQLversionreleased
byPostgresProfessionalforuseindataprocessingsystems
forpersonaldataandclassifiedinformation.
ConformancetotheSQLStandard
AstheANSISQLstandardisevolving,itssupportisconstantly
beingaddedtoPostgreSQL.Thisistrueforallversionsofthe
standard,fromSQL-92tothemostrecentSQL:2016,which
hasstandardizedJSONsupport.Muchofthisfunctionalityis
alreadyimplementedinPostgreSQL12.
Ingeneral,PostgreSQLprovidesahighrateofstandardcon-
formance,supporting160outof179mandatoryfeaturesand
manyoptionalones.
TransactionSupport
PostgreSQLprovidesfullsupportforACIDpropertiesanden-
sureseffectivetransactionisolationusingthemulti-version
concurrencycontrolmethod(MVCC).Thismethodallowsto 9
avoidlockinginallcasesexceptforconcurrentupdatesof i
thesamerowbydifferentprocesses. Readingtransactions
neverblockwritingones,andwritingneverblocksreading.
Thisistrueevenforthestrictestserializableisolationlevel.
UsinganinnovativeSerializableSnapshotIsolationsystem,
thislevelensuresthattherearenoserializationanomalies
andguaranteesthatconcurrenttransactionexecutionpro-
ducesthesameresultassequentialone.
ForApplicationDevelopers
Applicationdevelopersgetarichtoolsetforcreatingappli-
cationsofanytype:
• Supportforvariousserverprogramminglanguages:built-
inPL/pgSQL(whichiscloselyintegratedwithSQL),Cfor
performance-critical tasks, Perl, Python, Tcl, as well as
JavaScript,Java,etc.
• APIstoaccessthedatabasefromapplicationswrittenin
virtuallyanylanguage,includingthestandardODBCand
JDBCAPIs.
• Aselectionofdatabaseobjectsthatallowtoeffectively
implement the logic of any complexity on the server
side:tablesandindexes,sequences,integrityconstraints,
views and materialized views, partitioning, subqueries
and with-queries (including recursive ones), aggregate
andwindowfunctions,storedfunctions,triggers,etc.
• Aflexiblefull-textsearchsystemwithsupportforallthe
Europeanlanguages(includingRussian),extendedwith
effectiveindexaccessmethods.
10 • Semi-structureddata,similartoNoSQL:hstorestoragefor
i key/valuepairs, xml, json(representedastextorinan
effectivejsonbbinaryformat).
• ForeignDataWrappers. Thisfeatureallowsaddingnew
data sources as external tables by the SQL/MED stan-
dard.Youcanuseanymajordatabaseasanexternaldata
source.PostgreSQLprovidesfullsupportforforeigndata,
includingwriteaccessanddistributedqueryexecution.
ScalabilityandPerformance
PostgreSQLtakesadvantageofthemodernmulti-corepro-
cessorarchitecture.Itsperformancegrowsalmostlinearlyas
thenumberofcoresincreases.
Startingfromversion9.6, PostgreSQLsupportsconcurrent
dataprocessing.Version10enabledparallelreads(including
indexscans),joins,anddataaggregation.Version11added
fullsupportforparallelhashjoin,inwhichseveralworkers
buildanduseasinglehashtable. Besides,parallelscanof
partitionedtablesandparallelindexcreationwereimple-
mented.
Version12offersqueryparallelizationattheserializableiso-
lation level, JIT-compilation of queries that can speed up
operationsbybetteruseofhardwareresources,andmany
otheroptimizations.
QueryPlanner
PostgreSQLusesacost-basedqueryplanner. Usingthecol-
lectedstatisticsandtakingintoaccountbothdiskoperations
andCPUtimeinitsmathematicalmodels,theplannercan 11
optimizemostcomplexqueries.Itcanuseallaccessmeth- i
odsandjointypesavailableinstate-of-the-artcommercial
databasesystems.
Indexing
PostgreSQLprovidesvarioustypesofindexes.Apartfromtra-
ditionalB-trees,youcanusemanyotheraccessmethods.
• Hash,
ahash-basedindex. UnlikeB-trees, suchindexeswork
onlyforequalitychecks,butcanprovetobemoreefficient
andcompactinsomecases.
• GiST,
ageneralizedbalancedsearchtree.Thisaccessmethodis
usedforthedatathatcannotbeordered.Forexample,R-
treesthatareusedtoindexpointsonasurfaceandallow
toimplementfastk-nearestneighbors(k-NN)search,or
indexingoverlappingintervals.
• SP-GiST,
ageneralizednon-balancedtreebasedondividingthe
searchrangeintonon-intersectingnestedpartitions.For
example,quad-treesforspatialdataandradixtreesfor
textstrings.
• GIN,
ageneralizedinvertedindex,whichisusedforcompound
multi-element values. It is mainly applied in full-text
searchtofinddocumentsthatcontainthewordusedin
thesearchquery.Anotherexampleissearchofelements
indataarrays.
12 • RUM,
i anenhancementoftheGINmethodforfull-textsearch.
Availableasanextension,thisindextypecanspeedup
phrasesearchandreturntheresultssortedbyrelevance.
• BRIN,
acompactstructurethatprovidesatrade-offbetweenthe
indexsizeandsearchefficiency.Suchindexisusefulfor
bigclusteredtables.
• Bloom,
anindexbasedonBloomfilter.Havingacompactrepre-
sentation,thisindexcanquicklyfilteroutnon-matching
tuples,butrequiresre-checkingoftheremainingones.
Manyindextypescanbebuiltuponbothasinglecolumnand
multiplecolumns. Regardlessofthetype,youcanbuildin-
dexesnotonlyoncolumns,butalsoonarbitraryexpressions,
aswellascreatepartialindexesforspecificrows.Covering
indexescanspeedupqueriesasalltherequireddataisre-
trievedfromtheindexitself,avoidingheapaccess.
Theplannercanusebitmapscan,whichallowstocombine
severalindexestogetherforfasteraccess.
Cross-PlatformSupport
PostgreSQLrunsbothonUnixoperatingsystems(including
serverandclientLinuxdistributions,FreeBSD,Solaris,and
macOS)andWindowssystems.
Itsportableopen-sourceCcodeallowstobuildPostgreSQL
onavarietyofplatforms,evenifthereisnopackagesup-
portedbythecommunity.
Extensibility 13
i
OneofthemainadvantagesofPostgreSQLarchitectureis
extensibility.Withoutchangingthecoresystemcode,users
canaddthefollowingfeatures:
• datatypes
• functionsandoperatorstosupportnewdatatypes
• indexandtableaccessmethods
• serverprogramminglanguages
• foreigndatawrappers
• loadableextensions
Full-fledgedsupportofextensionsenablesyoutodevelop
newfeaturesofanycomplexitythatcanbeinstalledonde-
mand,withoutchangingPostgreSQLcore.Forexample,the
followingcomplexsystemsarebuiltasextensions:
• CitusDB,
which implements data distribution between different
PostgreSQLinstances(sharding)andmassivelyparallel
queryexecution.
• PostGIS,
oneofthemostpopularandpowerfulgeo-information
dataprocessingsystems.
ThestandardPostgreSQL12packagealoneincludesabout
fiftyextensionsthathaveprovedtobeusefulandreliable.
14 Availability
i
AliberalPostgreSQLlicense,whichissimilartoBSDandMIT
licenses,allowstheunlimiteduseofPostgreSQL,aswellas
itscodemodificationandintegrationintootherproducts,in-
cludingcommercialandclosed-sourcesoftware.
Independence
PostgreSQLdoesnotbelongtoanycompany;itisdeveloped
bytheinternationalcommunity,whichincludesdevelopers
fromallovertheworld. ItmeansthatsystemsusingPost-
greSQLdonotdependonaparticularvendor,thuskeeping
theinvestmentsafeinanycircumstances.
II What’s New in
PostgreSQL 12
IfyouarefamiliarwiththepreviousversionsofPostgreSQL,
thischaptercangiveyouasenseofwhathaschangedthis
year.Itmentionsonlysomeoftheupdates;forthefulllistof
changes,seetheReleaseNotes,asusual:postgrespro.com/
docs/postgresql/12/release-12.
Partitioning
Previously,partitioningcouldonlybeachievedwiththehelp
ofinheritance,exclusionconstraints,andtriggersthathad
tobemanuallyappliedtotables. Inversion10, thelong-
awaiteddeclarativepartitioningappeared,whichallowedto
declareatablepartitionedrightatthetimeofitscreation.
Originallyquitelimited,thisfunctionalityisbeingactively
developedandimprovedineachnewversion.
Version11addedsupportforuniquenessconstraintsforpar-
titionedtables,butforeign-keyreferenceswerenotimple-
mented.Nowthisoversighthasbeencorrected.
Apartfromthismajorenhancement, version12alsointro-
ducedmultipleotherperformanceimprovementsthatspeed
16 upqueriesonpartitionedtables(includingthosewiththou-
ii sandsofpartitions),reducelockingrequirementsforutility
commands,andfacilitatemaintenancetasks.
Globalindexesonpartitionedtablesarenotimplemented
yet,buttheyarebeingactivelydiscussedinthemailinglist.
Indexes
B-tree indexes get smaller: this enhancement applies to
multi-columnindexesandindexesthatcontainduplicated
data. Besides,insertionoperationsforB-treeindexeshave
beenaccelerated.
Otherindexeshavealsobeenimproved:
• WALwriteoverheadofGiST,GIN,andSP-GiSTindexcre-
ationhasbeenreduced.
• GiSTindexescannowhaveadditionalcolumnsspecified
intheINCLUDEclause,whichcanbeusedtomakethem
covering(inthepreviousversion,thisfunctionalitywas
availableforB-treeindexesonly).
• SP-GiSTindexesnowsupportk-nearestneighbors(k-NN)
search,justlikeGiST.SupportforB-treeisontheway.
The REINDEX CONCURRENTLY command has been added,
whichcanrebuildanindexwithoutlockingwriteoperations.
Previously,thesameeffectcouldbeachievedbyusingCRE-
ATEandDROPINDEXCONCURRENTLYcommands, butreplac-
inganindexsupportingintegrityconstraintsstillrequireda
shortexclusivelock.
QueryExecutionandOptimization 17
ii
Multi-column(extended)statistics,whichfirstappearedin
version10,canimprovetheplanner’sestimatesasittakes
into account functional dependencies and the number of
distinctvalues.Nowextendedstatisticsalsosupportsmost-
common-value(MCV)lists.
Youcanadjusttheestimatesbyspecifyingtheexpectedse-
lectivity,cardinality,andcostforparticularfunctionsdepend-
ingontheirparametervalues.
Commontableexpressionscannowbeinlinedintoaquery,
sotheplannercanoptimizethemtogetherwiththemain
query.Thisfeaturechangesthedefaultbehavior,whichcan
berestoredbyexplicituseofMATERIALIZED.
Youcannowchoosebetweencustomandgenericplansfor
preparedstatements using a server parameter. Previously,
therewasnowaytoforbidtheuseofgenericplans,which
couldleadtonon-optimalqueryexecution.
Queriescannowbeparallelizedattheserializableisolation
level. Since the previous version implemented predicate
locksforGiST,GIN,andHashindexes,theserializablelevelis