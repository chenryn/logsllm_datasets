Spawned from #1532.
There is quite a bit of duplicated script junk here. We should have this stuff
in one place.