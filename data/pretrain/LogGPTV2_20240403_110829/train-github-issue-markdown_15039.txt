Derived from issue #1532:

There is a significant amount of duplicated script code in this section. We should consolidate this code into a single, centralized location to improve maintainability and reduce redundancy.