Friday'the'13th:'JSON'Attacks
Alvaro'Muñoz'(@pwntester)
Oleksandr Mirosh
HPE'Security
>"whoarewe
• Alvaro'Muñoz
• Security'Research'with'HPE
• @pwntester
• Oleksandr Mirosh
• Security'Research'with'HPE
Introduction
• 2016'was'the'year'of'Java'Deserialization'apocalypse
• Known'vector'since'2011
• Previous'lack'of'good'RCE'gadgets'in'common'libraries
• Apache'Commons-Collections'Gadget'caught'many'off-guard.
• Solution?
• Stop'using'Java'serialization
• Use'a'secure JSON/XML'serializer'instead
• Do'not'let'history'repeat'itself
• Is'JSON/XML/'any'better?
• Raise'awareness'for'.NET'deserialization'vulnerabilities
Agenda
1. Attacking'JSON'serializers
• Affected'Libraries
• Gadgets
• Demo
2. Attacking'.NET'serializers
• Affected'formatters
• Gadgets
• Demo
3. Generalizing'the'attack
• Demo
Is'JSON'any'better?
Introduction
• Probably'secure'when'used'to'transmit'data'and'simple'JS'objects
• Replacing'Java/.NET'serialization'with'JSON'requires'OOP'support.
• How'do'we'serialize'a'java.lang.Object field?
• How'do'we'deal'with'generics?
• How'do'we'serialize'interface'fields?
• How'do'we'deal'with'polymorphism?
Quick"recap"of"Java"deser attacks
• Attackers'can'force'the'execution'of'any'readObject() / 
readResolve() methods'of'any'class'sitting'in'the'classpath
• By'controlling'the'deserialized'field'values'attackers'may'abuse'the'
logic'of'these'methods'to'run'arbitrary'code
• JSON'libraries'do'not'(normally)'invoke'deserialization'callbacks'or'
magic'methods
Can'we'initiate'a'gadget'chain'in'some'other'way?
Object"Reconstruction
• JSON'libraries'need'to'reconstruct'objects'by'either:
• Calling'default'constructor'and'using'reflection to'set'field'values
• Calling'default'constructor and'calling'setters to'set'field'values
• Calling'“special”'constructors,'type'converters'or'callbacks
• Calling'common'methods'such'as:'
• hashcode(), toString(), equals(), finalize(), …
• Combinations'of'the'previous'ones'J
Gadgets:".NET"Edition
• System.Configuration.Install.AssemblyInstaller
• set_Path
• Execute'payload'on'local'assembly'load
• System.Activities.Presentation.WorkflowDesigner
• set_PropertyInspectorFontAndColorData
• Arbitrary'XAML'load
• Requires'Single'Threaded'Apartment'(STA)'thread
• System.Windows.ResourceDictionary
• set_Source
• Arbitrary'XAML'load
• Required'to'be'able'to'work'with'setters'of'types'derived'from'IDictionary
• System.Windows.Data.ObjectDataProvider
• set_(MethodName | ObjectInstance | ObjectType)
• Arbitrary'Method'Invocation
ObjectDataProvider
set_MethodName()
BeginQuery()
QueryWorker()
InvokeMethodOnInstance()'
Refresh()
set_ObjectType()
set_ObjectInstance()
ObjectDataProvider
{"$type": "System.Windows.Data.ObjectDataProvider, PresentationFramework",
"ObjectInstance":{
"$type":"System.Diagnostics.Process, System”},
"MethodParameters":{
"$type":"System.Collections.ArrayList, mscorlib",
"$values":["calc"]},
"MethodName":"Start"
}
•
Non-default'constructor'with'controlled'parameters'
•
ObjectType + ConstructorParameters
•
Any'public'instance'method'of unmarshaled object'without'parameters
•
ObjectInstance + MethodName
•
Any'public'static/instance'method'with'controlled'parameters
•
ObjectType + ConstructorParameters +'MethodName +'MethodParameters
Gadgets:"Java"Edition
• org.hibernate.jmx.StatisticsService
• setSessionFactoryJNDIName
• JNDI'lookup'
• Presented'during'our'JNDI'attacks'talk'at'BlackHat'2016
• com.atomikos.icatch.jta.RemoteClientUserTransaction
• toString
• JNDI'lookup'
• com.sun.rowset.JdbcRowSetImpl
• setAutoCommit
• JNDI'lookup
• Available'in'Java'JRE
JdbcRowSetImpl.setAutoCommit
http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/com/sun/rowset/JdbcRowSetImpl.java/
JdbcRowSetImpl.setAutoCommit
http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/com/sun/rowset/JdbcRowSetImpl.java/
Gadgets:"non"RCE
Arbitrary'Getter'call
• org.antlr.stringtemplate.StringTemplate (Java)
• toString
• Can'be'used'to'chain'to'other'gadgets'such'as'the'infamous'
TemplatesImpl.getOutputProperties()
• System.Windows.Forms.BindingSource (.NET)
• set_DataMember
XXE
• System.Xml.XmlDocument/XmlDataDocument (.NET 
Message : Message
Body : Object
Exc: Exception
User
Message
Data : IDictionary
Message : String
Source: String
StackTrace: String
InnerException: Exception
…
Exception
…
Value : Object
ValidationException
Name : String
Items : Dict
Message : Message
Props : Hashtable
IUser
Summary
Name
Language
Type Name
Type'Control
Vector
FastJSON
.NET
Default
Cast
Setter
Json.Net
.NET
Configuration Expected'Object'Graph'Inspection
Setter
Deser.'callbacks
FSPickler
.NET
Default
Expected'Object'Graph'Inspection
Setter
Deser.'callbacks
Sweet.Jayson
.NET
Default
Cast
Setter
JavascriptSerializer
.NET
Configuration Cast
Setter
DataContractJsonSeri
alizer
.NET
Default
Expected'Object'Graph'Inspection'+'
whitelist
Setter
Deser.'callbacks
Jackson
Java
Configuration Expected'Object'Graph'Inspection
Setter
Genson
Java
Configuration Expected'Object'Graph'Inspection
Setter
JSON-IO
Java
Default
Cast
toString
FlexSON
Java
Default
Cast
Setter
GSON
Java
Configuration Expected'Object'Graph'Inspection
-
FastJson
• Always'includes'Type'discriminators
• There'is'no'Type'check'controls'other'than'a'post-deserialization'cast
• Invokes
• Setter
• Should'never'be'used'with'untrusted'data
• Example:
• KalikoCMS
• CVE-2017-10712