Machine
Learning
Protect against
tomorrow’s
threats
基于机器学习的恶
意软体分类实作:"
Microsoft"Malware"
Classification"
Challenge"经验谈
Trend Micro
ch0upi
miaoski
Kyle Chung
2 Dec 2016
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
ch0upi
•
Staff"engineer"in"Trend"Micro
•
Machine"Learning"+"Data"Analysis
•
Threat"intelligence"services
•
KDDCup 2014"+"KDDCup 2016:"Top10
•
GoTrend:"6th in"UEC"Cup"2015
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
miaoski
•
Senior"threat"researcher"in"Trend"Micro
•
Threat"intelligence
•
Smart"City
•
SDR
•
Arduino"+"RPi makers
•
Loves"cats
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
4
Outline
•
Why"Malware"Classification?
•
Machine"Learning
•
Microsoft"Challenge
•
How"to"Solve"it?
•
Conclusion
Machine
Learning
Protect against
tomorrow’s
threats
MALWARE'
CLASSIFICATION
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
What’s"Malware"Classification?
•
Identify"malware"family
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
Why"Malware"Classification?
•
Know"how"to"clean
•
Possible"attribution
•
Set"proper"priority
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
Current"Malware"Classification
•
Manually"generated"by"researchers
•
Use"signature"to"fingerprint"malware"
•
YARA"rules
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
Challenge
•
Manual"process"è wrong"family
•
more"and"more"malware"families
•
Very"large"volume
•
daily"1M+"samples
•
Increasing"signatures
•
Slow"in"scanning"+"need"more"storage
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
BSidesLV 2016:"VirusShare
•
John"Seymour,"Labeling"the"VirusShare Corpus:"
Lessons"Learned,"BSidesLV 2016
•
VirusShare Corpus:"~20M"files
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
Machine"Learning"for
•
Automation"of"malware"family"identification
•
Save"researcher’s"effort
Machine
Learning
Protect against
tomorrow’s
threats
MACHINE LEARNING
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
13
Machine"Learning"Steps
•
Prepare"Data
•
Generate"Feature
•
Train"Model
•
Make"Prediction
•
Evaluate
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
14
Fruit"Classification
•
Apple
•
Banana
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
15
Fruit"Features
•
Color
•
Shape
•
Size
•
Weight
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
16
Learning
•
Apple
•
Banana
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
17
Learned"Model"of"Fruit
•
Apple
•
Color:"Red
•
Shape:"Round
•
Banana
•
Color:"Yellow
•
Shape:"Long
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
18
New"Fruit"Coming…
•
Apple?"Banana?
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
19
Prediction"of"Fruits
•
Fruit"1
•
Color:"Red"=>"Apple
•
Shape:"Round"=>"Apple
•
Fruit"2
•
Color:"Yellow"=>"Banana
•
Shape:"Long"=>"Banana
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
20
Evaluation"of"Fruit
•
Accuracy:"(9+9)/20"="90%
Apple
Banana
Apple
9
1
Banana
1
9
Total
10
10
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
21
Machine"Learning"Steps
•
Prepare"Data
•
Generate"Feature
•
Train"Model
•
Make"Prediction
•
Evaluate
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
22
Machine"Learning"is"...
•
Mathematical"methods"and"algorithms
•
From"historical"labelled"data
•
Find"a"separating"hyperplane
•
Apply"it"on"future"data
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
23
Feature"is"...
•
Measurable"property"of"a"phenomenon"being"
observed
•
Use"to"describe"entries
•
Feature"vector
•
input"of"machine"learning"algorithm
•
Source"of"features
•
data"exploring
•
domain"knowledge
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
24
Model"is"...
•
A"mathematical"description"of"how"to"classify"the"
data
•
Parameters"tuned"by"certain"algorithm
•
training
•
Used"to"make"prediction
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
25
Prediction
•
Identify"the"class"of"new"entities
•
With"trained"model"from"training"data
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
26
Evaluation
•
Review"model"result"by"some"measurements
•
Cross"validation
•
Evaluation"functions
•
Accuracy
•
logloss
•
AUC
•
precision,"recall,"F1
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
27
Glue"Language
•
Glue"the"steps"of"Machine"Learning"Learning
•
Batch"running"for"large"amount"of"data
•
Integration"with"Hadoop,"Spark
•
Rich"libraries/Algorithm"support
•
Easy"to"develop/learn
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
28
scikit learn
•
Open"source"machine"learning"library"for"python
•
Various"classification,"regression"and"clustering"
algorithms
•
Interoperate"with"NumPy,"SciPy,"and"underlying"
BLAS
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
29
scikit learn"cheat-sheet
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
30
Supported"Algorithm"in"scikit learn
•
Classification"Algorithm
•
Logistic"Regression:"linear_model.LogisticRegression()
•
SVM:"svm.SVC()
•
Random"Forest:"ensemble.RandomForestClassifier()
•
Interface
•
fit(X,"Y):"train"model
•
Yp=predict(X):"make"prediction
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
31
Evaluation"Functions"in"scikit learn
•
Evaluation"functions
•
metrics.accuracy_score()
•
metrics.log_loss()
•
metrics.auc()
•
metrics.f1_score()
•
metrics.confusion_matrix()
•
metrics.classification_report()
Machine
Learning
Protect against
tomorrow’s
threats
MICROSOFT'MALWARE'
CLASSIFICATION'CHALLENGE
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
33
Microsoft"Malware"Classification"
Challenge
•
Hosted"by"WWW"2015"/"BIG"2015"
•
Microsoft"Malware"Protection"Center
Microsoft"Azure"Machine"Learning
Microsoft"Talent"Management
•
PE"Hexdump &"Disassembled
•
Training:"10,868"(compressed:"17.5GB)
•
Testing:"10,873"(compressed:"17.7GB)
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
34
9 Classes
Category
Count
1
Ramnit
1541
2
Lollipop 
2478
3
Kelihos_ver3 
2942
4
Vundo
475
5
Simda
42
6
Tracur
751
7
Kelihos_ver1 
398
8
Obfuscator.ACY
1228
9
Gatak
1013
Total 
10868
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
35
Class:"Ramnit
•
Steal"sensitive"personal"information
•
Infected"through"removable"drivers
•
Copy"itself"using"a"hard-coded"name,"or"with"a"
random"file"name"to"a"random"folder
•
Inject"codes"into"svchost.exe
•
Infects"DLL,"EXE,"HTML
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
36
Class:"Lollipop
•
An"adware"shows"ads"when"browsing"web
•
Bundle"with"third-party"software
•
Auto"run"when"Windows"starting
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
37
Class:"Kelihos
•
A"Trojan"family"distributes"spam"email"with"
malware"download"link
•
Communicate"with"C&C"server
•
Some"variants"install"WinPcap to"spy"network"
activity
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
38
PE"Hexdump w/o"Header
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
39
IDA"Pro"Dump
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
40
IDA"Pro"Dump
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
41
IDA"Pro"Dump
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
42
Evaluation"Function
pij is the submitted probability of sample i is class j
yij=1 if sample i is class j,
yij=0 for others
𝑙𝑜𝑔𝑙𝑜𝑠𝑠 = − 1
𝑁 ) ) 𝑦𝑖𝑗-log-(𝑝𝑖𝑗)
4
567
8
967
Machine
Learning
Protect against
tomorrow’s
threats
Machine
Learning
Protect against
tomorrow’s
threats
43
Evaluation"Example
•
Submission
00000000,0.5,0.5,0,0,0,0,0,0,0,0
00000001,0,0,0.5,0.5,0,0,0,0,0,0
00000002,0,0,1,0,0,0,0,0,0,0
•
logloss ="- (log(0.5)+log(0)+log(1))/3
•
log(0)"=>"log(1e-15)
Machine
Learning