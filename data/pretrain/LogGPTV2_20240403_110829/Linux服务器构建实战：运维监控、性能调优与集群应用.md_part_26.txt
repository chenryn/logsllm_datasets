Fll nane
除利器exi3grep
151
PDG
---
## Page 170
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
此时就要利用ext3grep命令的“--restore-all”参数了。具体操作如下：
是如果要恢复很多个文件，如1000个以上，还采取逐个指定的方式，效率是非常低下的，
方式恢复出来的文件是完整的。
（其中inode值为12的是profile文件）：
定的形式。
5.恢复所有已删除数据
通过“--restore-inode”参数，
总计2512
[root@localhost RESTORED_FILES]# 1s -al
[root@localhost /opt]# cd RESTORED_FILES/
Restoring
The oldest inode block that is stil1 in the journal,appears to be from 1270629014
Minimum / maximum journal block:447/ 4561
[root@localhost/opt]# ext3grep
当需要恢复的文件较少时，通过前面介绍的指定文件的方式进行逐个恢复是可行的。但
根据校验结果可知，这个校验码与文件被删除之前的校验码完全一致，因此，通过这个
a6e82d979bb95919082d9aceddf56c39
[root@localhost RESTORED_FILES]# md5sum inode.12
5afe55495cdb666daad667e1cd797dcbext3grep.txt
[root@localhost RESTORED_FILES]# md5sum ext3grep.txt
ext3grep
[root@localhost RESTORED_FILES]# ls
[root@localhost/opt]# cd RESTORED_FILES
下面进人RESTORED_FILES目录，验证文件是否成功恢复。
Restoring inode.12
Writing outputto
The oldest inode block that is stil1 in the journal, appears to be from 1270629014
Minimum/
Running ext3grep version 0.10.1
[root@localhost RESTORED_FILES]# ext3grep
=Wed Apr
=Wed Apr
www.Linuxidc .com
initrd-2.6.18-164.11.1.e15xen.img
ext3grep.txt
ext3grep.txt
7 16:30:14 2010
7 16:30:14
directory RBSTORED_FILES/
journal:63;min/max Bequence numbers:2/10
2010
只需指定文件对应的inode值即可恢复文件。操作如下
done
/mydata/disk1
inode.12
第6章
done.
done
/mydata/disk1
ext3文件系统反
--restore-all
删际利器exisgrep153
--restore-inode 12
米
PDG
---
## Page 171
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
装目录为/data/mysql。下面进入实例介绍。
6.4.2
程，其实就是恢复这3个文件的过程。
的索引文件、以frm为后缀的结构文件、以MYD为后缀的数据文件。恢复MySQL表的过
除操作方面有很大的局限性。
它具有对事务的回滚和崩溃恢复能力，但是仅仅限于事务管理方面，在对恢复库或表的误删
除一个表后，如果没有备份，那么数据就永远丢失了。另一个常用的存储引擎是InnoDB，
擎，
6.4.1
6.4
放到了RESTORED_FILES目录中。“--restore-all”参数对恢复大量数据文件是非常有用的。
154第2篇
2.模拟误删除操作，删除表t_manager
首先登录MySQL数据库查看cicro库中相关的表信息，操作如图6-2所示。
1.查看MySQL数据库表信息
这里设定：MySQL所在的磁盘分区为/dev/sda6，挂载到/data目录下，而MySQL的安
下面介绍在采用的是MyISAM存储引擎的MySQL中模拟表被误删除后的恢复过程。
MySQL采用MyISAM存储引I擎时，
，它具有高速存储和检索及全文搜索能力，但不支持事务处理和故障恢复，因此，在误删
mysql>exit
Query OK, 0 rows affected (0.o0 sec)
mysql>drop table t_manager;
接着查看t_manager表的内容及数据结构，操作如图6-3所示。
MySQL数据库在存储管理方面，有多个存储引擎可以选择，MyISAM是默认的存储引
通过ext3grep恢复误删除的MySQL表
根据这个输出可知，“--restore-all”参数将指定存储设备中可以恢复的文件都恢复出来并
rw-r--r--
rw-.
rW-r--r--
drwxr-xr-x2 root root
drwxr-xr-x4 root root
模拟MySQL表被误删除的环境
MySQL存储引I擎介绍
www.Linuxidc .com
1
1 root
root
root
root
root
root
root
root
2535991
1029
096
4096 04-07 16:46 ext3grep
096
4096 04-07 16:46
904-07 16:30profile
04-07 16:30
04-07 16:31 ext3grep.txt
504-0716:45
：每张表分别对应3个文件，分别是以MYI为后缀
16:33
0initrd-2.6.18-164.11.1.el5xen.img
PDG
---
## Page 172
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
如图6-4所示。
6.4.3通过ext3grep分析数据、恢复数据
通过ext3grep分析MySQL数据所在的分区信息，进而判断是否有可恢复的信息，操作
1.对MySQL执行分区数据扫描
3.停止MySQL数据库，卸载MySQL所在分区
www.Linuxidc.com
Field
aysql> desc t_aanager;
1 rov in set （0.00 sec)
mysql> select *from t_manager;
Tables_in_ciczo
ype
nt
rous in set (0.00 sec)
ZLONON
MNG_ID
MNG_IDIHNG_NAME1MNG_PASSWORD
t_usertable
manacer
LCODe
table
图6-3查看t_manager表的内容和结构
_orga
ford
varchar(30)
decimal(9,0)
Type
图6-2查询cicro库中所有表
-f=aCX1K3glErs=
1 Mul1 1 Key | Default 1 Extra
Comnands end vith : or \g.
PRI|NULL
-+
1MNG_NOTE
adninistrator
HULL
NULL
HULL
---
## Page 173
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
MySQL目录的Inode号是34545。接着继续扫描MySQL目录的Inode信息，如图6-5所示。
156
通过图6-4可知，MySQL目录中有可恢复的数据信息。根据查询到的恢复信息，可知
Indx ext
08
0
inimm
6
de
Indx Mext 1
inir
hunber
www.Linuxidc.com
34545
Pr
journal
of
first block
oldest
P
P
groups:
end
口
to
图6-4通过ext3grep查询/data分区可恢复的数据信息
49215
35468
34545
journalb1ock:530/9271
63
r0m1270697
图6-5扫描MySQL目录下可恢复的数据信息
Deletion
1Deletion
Tbs&n,
--D:
/dev/sda5
7526
tim
/dev/sda5--1s --1node2
tine
Tu
530/ 9271
min/
--1s --inode 34545
done
-data-from-inode-
Erom
ain/ax sequence nuabers:2/22
xsequence nunbers:2/22
done
-ino
32
drx-xE-
EW-
droxz-x-x
drwxz-xr-x
Mode
x-1xxxaxp
drux
druxx-xx-x
druxr-xr-x
Hode
shar
INSTALL-BINARY
scripts
sql-bench
REAQId
PDG
---
## Page 174
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
manager对应的文件。
程如图6-7所示。
36577，即data目录下的文件信息，过程如图6-6所示。
看MySQL目录下的inode信息。
6-5输出可知，MySQL目录的Directoryblock为139777，因此，也可以通过下面的命令查
34545的MySQL目录进行扫描，查找到了此目录下所有文件和目录的inode信息。根据图
目录对应的inode为34545，接着查找inode为34545下面的文件信息。通过对inode为
到这里为止，根据D标识可以看到被删除的3个文件，这3个文件正是被删除的表t
Loading journal descriptors...sorting...done
[root@localhost /]# ext3grep /dev/sda6 --restore-inode 40650
接下来，通过ext3grep的“--restore-inode”参数恢复这3个文件。过程如下：
2.恢复mysql数据文件
mysql表文件存放在cicro目录下，因此，可以继续查看inode为40641的目录信息，过
由于MySQL数据文件存放在data目录下，因此可以通过ext3grep继续查看inode为
[root@localhost/]#ext3grep
在上面的操作中，首先通过“--ls--inode2”参数扫描了整个分区信息，查找到MySQL
Indx Mext
ding
www.Linuxidc.com
N
Inode
be
图6-6查看Inode为36577目录下的可恢复的数据信息
P
147969
60
1397  8
journalblock:530/ 9271
ap/tbsn
/dev/sda6
69.
--1s --1node 36577
第0章
locer
--1s--block 139777
ex13文件
irw
zru-r-....
Mode
ib_1ogfile0
logfilel
PDG
---
## Page 175
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
Restoring
Minimum
Running ext3grep
Restoring
The
Minimum
[root@localhost/]#ext3grep
Restoring inode.40650
The oldest inode block that is stil1 in the journal, appears to be from 1270697526
=Thu Apr
=Thu Apr
Load
inode.40655
de:
be
inode block
Inode
Bqrer
811:32:06 2010
8 11:32:06
8 11:32:06 2010
图6-7查看Inode为40641目录下的可恢复的数据信息
/1#ext3grep
556
53
9
block
journalb1ock: 530/ 9271
journal block:
63
journal block:
xdy r05690 
D 1270697750 Thu Apr 8 11:35:50 2010
63
D 1270697750 Thu Apr 8 11:35:50 2010
Deletion
D：
that is
7526
journal:3796;min/max8equence
2010
time
/dev/sda6
/dev/sda6
still in the journal，
sorting...
/dev/sda6
-data-from-inode-
530/9271
：3796; min / max sequence numbers:2 / 22
530/9271
the journal,