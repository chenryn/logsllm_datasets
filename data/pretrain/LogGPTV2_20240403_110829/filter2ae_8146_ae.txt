CVE-2010-2772—WinCC 默认口令 MS09-025 NtUserRegisterClassExWow /NtUserMessagerCall
EOP | 通过感染Step7项目文件 通过USB实现自启动 网络共享 Windows Server RPC Printer spooler
WinCC服务器 通过RPC更新对等网络 | 主要基于Tilded平台 | 针对S7-300（315）PLCs的代码 （控制了旋转离心机的速度） 针对417
PLCs的不完整的代码序列  
**1.100** **1.001** | 2010/3/1 2010/4/14 | 二进制编译时间戳更新 |
CVE-2010-3888—任务调度程序EOP CVE-2010-2743--LoadKeyboardLayout EOP
CVE-2010-2729—打印服务 RCE CVE-2008-4250—Windows Server Service RPC RCE
CVE-2012-3015—Step7 安全库加载 CVE-2010-2772—WinCC 默认口令 CVE-2010-2568—Shortcut .lnk
RCE | Step7项目文件 通过USB触发CVE-2010-2568 网络共享 Windows Server RPC Printer spooler
WinCC服务器 通过RPC更新对等网络 |  |  
毒曲的主要版本包括Duqu1.0、Duqu1.5和Duqu2.0。Duqu与Duqu2.0之间使用统一算法以及复用大量相同代码，Duqu1.0和Duqu2.0之间攻击目标有很多重合，Duqu1.5和Duqu2.0之间均使用了Pipe
Backdoor插件。
震网和毒曲之间在模块结构、编译器结构、关键功能、数据结构、病毒作者心理等方面具有同源性[14]，此外，震网和Duqu1.0、Duqu2.0均采用窃取自中国台湾IT厂商的数字证书。
##### **7.3 震网与Fanny、Flowershop的关联**
从图7-3中能够看出，震网除了与毒曲、火焰具有一定关联之外，其与Fanny、Flowershop也具有一定的关联。
Stuxshop是震网的早期组件，用于管理早期C2。Stuxshop与Flowershop（活跃于2002年至2013年的恶意软件平台）之间存在代码重叠或共享。
方程式早期组件Fanny，其使用了两个震网的0day漏洞，即LNK漏洞（CVE-2010-2568）以及嵌入在“Resource
207”中的提权漏洞。此外，震网和方程式开发者之间共享编码风格，或者使用同样的开发规范手册。
### **8、直面检测引擎与威胁情报的挑战**
在安天此前的分析报告中，针对 A2PT
带来的防御挑战，进行过一些论述和探讨，而针对震网的复盘，我们希望聚焦一个具体的问题，高级恶意代码对检测引擎和威胁情报的挑战。
作为攻击载荷的恶意代码是网空攻击的“战斗部”，几乎绝大多数的网空攻击事件中都会出现恶意代码的身影，在高能力网空威胁行为体的攻击活动中更是如此。从威胁框架的视角来看，高能力网空威胁行为体要针对目标完成接触目标与进攻突防、持久化驻留潜伏、全程持续支撑作业，并进一步达成各种致效能力运用，在整个过程中，既需要针对业务场景达成作业意图，又要绕开体系化的防护，达成深度持久化和隐蔽通讯等动作，其必然要完成高度复杂的逻辑功能执行。这导致了APT攻击对恶意代码的依赖程度在不断加深，高级恶意代码呈现出框架日趋庞大、模块众多和指令体系原子化等趋势。
在过去对网空威胁的分析和对网空威胁行为体的追踪中，安天对震网、火焰、毒曲、方程式等拥有完整、严密的作业框架与方法体系的攻击活动，以及其自研使用的的高级恶意代码进行了持续关注分析；同时也分析了一些组合使用“商业军火”、开源免费工具即较低水平的自研恶意代码的定向攻击活动。这些分析工作是长期的、高代价的，但这些工作是实现更有效地防御和猎杀的基础。赋能客户建设动态综合防御体系是我们的目标；而针对攻击装备（恶意代码、漏洞利用程序和其他的工具）的斗争一直是其中的焦点。
在这种对抗中，传统的反病毒引擎和威胁情报成为两个具有互补作用的机制，前者针对海量的恶意代码的检测、辨识能力，并且通过深度预处理、虚拟执行等机制来应对恶意代码的变种、变换，因此在载荷检测方面，有无以伦比的识别与解析深度，而且对海量载荷对象提供了精准的判定机制。但传统病毒引擎在威胁对抗中的短板也很明显，其是最容易被攻击方获得的安全资源，绝大多数反病毒软件都可以公开的下载或低成本的购买、同时Virustotal等公开的多引擎扫描机制也会成为攻击方的测试资源。因此反病毒引擎面对自动化构造的免杀测试等方法，有被绕过的必然性。同时其本地检测定期升级库的机制，或者是云引擎对远程的依赖，对内网用户也都带来了一定的部署成本。另一个问题是，传统反病毒引擎的工作视角是基于样本检出率为核心指标的，其信息输出缺少从威胁对抗方面更明确的指向性。这些短板都需要威胁情报进行弥补。在威胁情报金字塔中，HASH、IP、域名等“狭义情报”被列入底层，即获取难度低、应用成本低。较为容易的被分析防御方提取为攻击指示器（信标），同时可以与多种安全设备、管理设备、防护软件等现有扩展接口实现对接。
**图 8-1 威胁情报金字塔模型**
尽管与传统的反病毒检测引擎相比，HASH检测机制毫无鲁棒性可言，但由于HASH的唯一性，其在可靠的知识运营支撑的情况下，可以建立起对攻击组织的精准的指向性。例如两个不同的攻击组织，分别定制了同一个版本的商用木马，在文件尾部附着了各自的C2配置。对于反病毒引擎来说，这是同一种样本，而对于HASH情报在分析支撑下输出，反而能将其区别出来。但HASH情报其可用前提也很明显，那就是存在着二进制形态不变的样本复用。对IP和域名规则也是如此，当情报供给方能将恶意活动指向某个确定的通讯基础设施（C2），来完成心跳、控制、升级、回传等操作，并将这个恶意活动指向某个攻击组织时，那么相应的网络IoC就可以命中在其他攻击活动中的行为，从而建立起攻击行为和组织的关联。这种低层次的攻击指向器，尽管效用机理比反病毒引擎和流量检测引擎都要简单，但基于其可以快速发布，广泛扩展，精准定义，一定程度上带了一种快速的、更为普适的监测和普查能力。因此传统检测引擎+IoC情报可以形成一定的互补组合的效果。这种组合模式也是过去数年安天所推动的模式。
但通过复盘9年前的震网事件就可以看到，这个层面的情报对于 A2PT
攻击近乎无效。每一台主机上提取到Dropper文件的HASH都不可能命中另一台主机上的等效文件。我们不能认为震网Dropper的落地自写更新机制，主要目的是为了对抗HASH检测机制，但其客观上构成了这样的效果。而更需要看到的是，尽管在分析过程中，可以看到震网攻击的相关域名从2005年已经被注册。但在分析方将相关通讯特性作为规则时，震网的攻击效果已经达成，而在毒曲等的攻击中，我们亦广泛看到内网C2等机制的存在。如果反病毒引擎是一种会被攻击者重点绕过的重载机制，而攻击指示器（信标）又作为一种稳定性极低的情报机制的话，这对双保险的效果就会大打折扣。
安天基于传统检测引擎在威胁对抗中，是攻击方重点绕过环节的特点，自2016年起开始研发下一代威胁检测引擎。安天下一代引擎延续并深化了安天传统引擎格式识别、深度解析等特点，继承对海量恶意代码精准的分类到变种的识别能力。同时，以没有可信的格式和对象为前提，形成对检测对象全格式识别，对更多重点格式形成深度解析能力。不止为调用环节输出判定结果，同时也可以将检测对象的向量拆解结果结构化输出，形成支撑产品场景和态势感知场景研判分析、关联与追溯的数据资源。
探索检测引擎与威胁情报更好的结合，建立起更可靠的基础标识能力与响应机制，更有效的支撑TTP，乃至人员组织相关的情报，建立起更完善的知识工程运营体系，这对我们来说，将是一个需要长期努力的方向。
### **附录一：参考资料**
[1] 对Stuxnet蠕虫攻击工业控制系统事件的综合分析报告
[2] 对Stuxnet蠕虫的后续分析报告
[安天技术文章汇编（五）工控系统安全分册](https://www.antiy.com/response/20190930.html#)
[3] WinCC后发生了什么
[安天技术文章汇编（五）工控系统安全分册](https://www.antiy.com/response/20190930.html#)
[4] 《Offensive Cyber Capabilities at the Operation Level》
[5] “方程式组织”攻击SWIFT服务提供商EastNets事件复盘分析报告
[6] Why Stuxnet Isn't APT
[7] Revealed: How a secret Dutch mole aided the U.S.-Israeli Stuxnet
cyberattack on Iran
[8] W32.Stuxnet
[9] Stuxnet’s Secret Twin
[10] 探索Duqu木马的身世之谜——Duqu和Stuxnet同源性分析
[11] 从Duqu病毒与Stuxnet蠕虫的同源性看工业控制系统安全
[安天技术文章汇编（五）工控系统安全分册](https://www.antiy.com/response/20190930.html#)
[12] Resource 207: Kaspersky Lab Research Proves that Stuxnet and Flame
Developers are Connected
[13] Flame蠕虫样本集分析报告
[14] Duqu和Stuxnet同源性分析系列报告
[安天技术文章汇编（五）工控系统安全分册](https://www.antiy.com/response/20190930.html#)
* * *