具，它应该作为MySQL客户端的一部分被安装在你的系统当中
法各不相同。
允许你访问它们的度量值，但是你也会看到，获取这些度量值的方
用，但更有用的是数据库本身的度量值。MySQL 和PostgresSQL都
PostgresSQL，让它要么监听你想要的网络地址，要么监听所有网卡
PostgresSQL仅仅监听了127.0.0.1这个地址，那么你需要重新配置
PostgresSQL仅监听了本机IP（127.0.0.1:5432），所以只有在同一
命令，直接看看 netstat 的输出）。还要注意的是，在这个例子中，
果，它是一种安全模式。如果需要其他服务器也能访问数据库，而
台服务器上的进程才能访问这个数据库一如果这就是你想要的结
口来过滤，查看 postgres 是否正在监听其他端口（或者不使用 grep
的地址。
当你想要跟踪一个数据库相关的问题时，服务器度量值相当有
为了获取MySQL中的度量值，需要使用mysqladmin这个工
注意，监听这个端口的进程与ps 输出中的第一个进程的ID
tcp6
$sudo netstat-1np|grep:5432
tcp
MySQL
0::1:5432
0127.0.0.1:5432
0.0.0.0:*
LISTEN
LISTEN
1629/postgres
1629/postgres
---
## Page 174
涵义：
息，可以使用extended-status 命令：
和queries-per-second这几个度量值。
况并能分辨出什么值不在正常范围内，尤其是threads、slow queries
下面是从 mysqladmin的帮助页面中获得的每个值所代表的
时长大于 long_query_time 秒的查询的数量
MySQL服务器已经运行的秒数
Uptime
对于很多数据库故障排除过程来说，这些值足够你了解相关情
数据库收到的每秒查询数量的平均值
Queries per second avg
服务器执行fush-*、refresh 以及reload命令的次数
Flush tables
Opens
Slow queries
从服务器启动到现在，客户端发起的查询次数
当前打开的表的数量
Open tables
服务器打开的表的数量
Questions
活动线程（客户端）的数量
Threads
Enter password:
mysqladmin-uroot-p status
Enter password:
$mysqladmin-u root -p extended-status
Uptime:2680987 Threads:1 Questions: 17494181 Slow queries:0 Opens:2096 Flush
，当然，要想获得更详细的信
9.3获得数据库度量值·167
---
## Page 175
·第9章为什么数据库这么慢？追踪数据库问题
是 postgres 用户（或者拥有数据库超级用户权限的其他用户），这样
track_counts 选项开启。很有可能默认情况下它们就是开启的，但是
内专门的表中。与MySQL不同的是，你需要用 SQL 命令从这些表
在/etc/postgresql/8.4/main/文件夹中），然后确保 track_activities 和
首先，需要修改 postgresql.conf 文件（例如，在Ubuntu 系统中，
9.3.2
建立更完整的概念，这样你就会发现何时数据库服务器出现了异
档中，下面这几节会列举出几个特别有用的表。首先，请确保自己
中获取数据。完整的静态数据表的列表记录在PostgresSQL官方文
如果要更改这些变量，你可能需要重启PostgresSQL，之后这些更
常问题。
外还有大量其他度量值，借助这些额外的度量值，可以对数据库
改才能生效。
一旦开启了统计数据收集功能，相关的数据就会存储在数据库
PostgresSQL用一种完全不同的方式收集和列出性能统计数据。
extended-status 命令将会提供 status 命令返回的所有信息，
Variable_name
Threads_cached
Threads_running
Bytes_sent
Aborted_clients
Uptime
Threads_created
Threads_connected
Bytes_received
Binlog_cache_use
Binlog_cache_disk_use
Aborted_connects
------------T
PostgresSQL
|Value
149337359253
10
2683061
2683061
6575
3264109643
它
另
---
## Page 176
你才能发起查询：
很多事——唯一的进程是你用来获取静态数据的进程。不过，如果
什么查询的时候，这个表特别有价值。想要查看表中的数据，请使
现某个数据库进程占用了大量CPU时间，而你想知道当前正在执行
用标准的 select语句：
正在访问这个进程、
包括它正在访问哪个数据库、它正在使用哪个系统进程、哪个用户
你想要追踪一个特定的进程，仅需要修改SQL语句：
pg_stat_activity这个表展示了当前运行的服务器进程的信息，
pg_stat_database这个表存储了数据库静态统计数据，如连接
postgres=# select ± from pg_stat_activity where procpid-4689;
在这个例子中，
(1row)
2012-07-12 04:26:01.363883-071
postgres=# selectfrom pg_stat_activity;
ty:lf
(1row)
11564 | postgres |
datid |datname|procpid|usesysid |usename
Type "help" for help.
psq1 (8.4.12)
2012-07-12 04:26:01.363883-07
Spsq1
11564| postgres|
datid|datname|procpid|usesysid |usename|
su-postgres
|waiting|
backend_start
backend_start
12012-07-12 04:26:19.602872-07|2012-07-12 04:26:19.602872-071
46891
4689
、当前的查询以及查询运行的时长数据。当你发
|waiting
，可以看到默认的 PostgresSQL 数据库并没有做
xact_start
|client_addr|client_port
1client_addr|client_port
2012-07-12 04:26:19.602872-07| 2012-07-12 04:26:19.602872-071
10 |postgres| select +from pg_stat_activi
10|postgres | select from pg_stat_activi
xact_start
-1
query_start
current_query
9.3
current_query
获得数据库度量值·169
query_start
---
## Page 177
170
统计信息。和 pg_stat_activity表类似，使用基本的 select语句就能
他操作的数量的数据。因为这个表中存储了所有现存表的数据，
所以列出了默认数据库，但是你也会看到你创建的全部数据库。
获得当前所有的数据：
到数据库的服务器进程数量、事务提交和回滚的数量以及块和列的
?
以默认的 select语句将会返回大量数据：
包括顺序扫描静态数据、索引扫描静态数据以及在这个表上执行其
第9章为什么数据库这么慢？追踪数据库问题
pg_stat_all_tables 这个表为每个表存储了一些静态数据，其中
postgres=# select  from pg_stat_all_tables;
这个例子中的数据是从默认安装的PostgresSQL 中获得的数据，
s_hit|tup_returned|tup_fetched|tup_inserted|tup_updated|tup_deleted
datid |datname|numbackends|xact_comit| xact_rollback|blks_read|blk
utoanalyze
n_live_tup |n_dead_tup |last_vacuum|last_autovacum |last_analyze|last_a
1 idx_scan |idx_tup_fetch|n_tup_ins| n_tup_upd |n_tup_del| n_tup_hot_upd
(3rows)
relid|
615441
11564 I postgres
2328 I pg_catalog
11563|template0
2617 | pg_catalog
2753 1 pg_catalog
---------+----
01
01
1|templatel
01
01
01
schemaname
1075635
S
S
01
1 pg_foreign_data_wrapper
Ipg-operator
I pg_opfamily
6775
01
01
relname
38761
S
01
01
01
|seq_scan|seq_tup_read
0
116
S
所
---
## Page 178
9.4识别查询缓慢的问题
看 pg_stat_user_tables 表可以仅看到用户表信息，查看 pg_stat_sys_
slow_queries 和 long_query_time。log_slow_queries 变量应该设置成
和 PostgresSQL 都有各自的机制记录慢查询，这样后面就可以查看
数据库这么慢？”为了回答这个问题，你可能需要验证是不是慢查
tables可以仅看到系统表信息。
的例子。当然，你可能想要排除所有的系统表，仅留下用户表。查
修改并重启之后，会发现创建了慢查询日志，其中的内容看起来如
的时候就带了 my.cnf这个文件，这些设置已经出现在这个文件中，
用来标识多长时间的查询属于慢查询。默认情况下，MySQL安装
记录所有慢查询的文件（请确保运行MySQL的用户能在这个位置
9.4.1
这些日志。
候，那么做一些优化工作，让它们在数据库中运行得更快。MySQL
询——查询时间比特定值长的数据库查询。
只不过被注释起来：
想要启动MySQL的慢查询记录功能，需要设置两个变量：log
当调试数据库问题的时候，最常见的问题之一就是“为什么
这绝对是一个你想要用一些特定的SQL语句来截取想要的数据
#Here you can see queries with especially long duration
(65rows)
一旦你设置了这两个值，就需要重新启动MySQL进程。完成
1og_s1ow_queries=/var/log/mysq1/mysq1-s1ow.1og
long_query_time=2
MySQL
01
01
9.4识别查询缓慢的问题171
当你确定慢查询的时
---
## Page 179
172
例如，如果你想要终止 WordPress DB 中连接时间超过80秒的连接
慢了系统，想要终止这个进程，那请留意processlist命令输出所带
有一个客户端（一个本地 mysql客户端连接）通过mysqladmin命令
有些示例输出，它来自一个相对不活跃的WordPress安装过程，它
下所示：
应该输人：
的进程ID，然后根据这个进程ID使用kill命令终止对应的进程。