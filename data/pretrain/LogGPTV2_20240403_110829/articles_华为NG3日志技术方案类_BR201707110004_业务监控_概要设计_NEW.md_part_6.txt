+-----------+-----------+------+-------------------+-----------------+
| S         | varch     | 可选 | 子系统名，如ORDER | 前台服务        |
| ubSysName | ar(max32) |      | _WEB、ORDER_APP、 | 填写应用名称；  |
|           |           |      | ORDER_DDS、ORDER_ |                 |
|           |           |      | DB。优先获取PAAS_ | 后台CICS服务    |
|           |           |      | CLUSER_NAME环境变 | 填写条带名称；  |
|           |           |      | 量，然后是SubSysN |                 |
|           |           |      | ame系统属性，最后 | 工单发送        |
|           |           |      | 是DSF传递的参数。 | 填写进程名称；  |
|           |           |      |                   |                 |
|           |           |      |                   | 信控进          |
|           |           |      |                   | 程填写进程名称  |
+-----------+-----------+------+-------------------+-----------------+
| Protocol  | varch     | 必选 | 协议类型，TC      | 前              |
|           | ar(max12) |      | P/HTTP/SOAP/DSF等 | 台WEB服务调用填 |
|           |           |      |                   | 写HTTP或HTTPS； |
|           |           |      |                   |                 |
|           |           |      |                   | 后              |
|           |           |      |                   | 台CICS填写TCP； |
|           |           |      |                   |                 |
|           |           |      |                   | 工单            |
|           |           |      |                   | 发送填写SOAP；  |
|           |           |      |                   |                 |
|           |           |      |                   | 信控            |
|           |           |      |                   | 进程填写DATA；  |
+-----------+-----------+------+-------------------+-----------------+
| BeginTime | char(16)  | 必选 | 对服务调用是请    | 请求日志时填    |
|           |           |      | 求收发的时间，对  | 写服务请求时间  |
|           |           |      | 异步消息通信是消  |                 |
|           |           |      | 息收发的时间，采  | 响应日志时填空  |
|           |           |      | 用UTC时间记录，格 |                 |
|           |           |      | 式为YYMMDDHHMMSS. |                 |
|           |           |      | sss，粒度到毫秒。 |                 |
+-----------+-----------+------+-------------------+-----------------+
| EndTime   | char(16)  | 可选 | 对                | 请求日志时填空  |
|           |           |      | 服务调用是响应收  |                 |
|           |           |      | 发的时间，对异步  | 响应日志时填    |
|           |           |      | 消息通信为空，采  | 写系统当前时间  |
|           |           |      | 用UTC时间记录，格 |                 |
|           |           |      | 式为YYMMDDHHMMSS. |                 |
|           |           |      | sss，粒度到毫秒。 |                 |
+-----------+-----------+------+-------------------+-----------------+
| R         | int(10)   | 必选 | 对服务            | 请              |
| eqMsgSize |           |      | 调用是请求消息大  | 求日志时填写请  |
|           |           |      | 小，对异步消息通  | 求消息的总大小  |
|           |           |      | 信是收发的消息大  |                 |
|           |           |      | 小，单位为字节。  | 响应日志时填写0 |
+-----------+-----------+------+-------------------+-----------------+
| R         | int(10)   | 必选 | 对服务调用是      | 响应日志时填写  |
| spMsgSize |           |      | 响应消息大小（请  | 响应消息的大小  |
|           |           |      | 求消息中不用打印  |                 |
|           |           |      | ），对消息通信为  | 请求日志时填写0 |
|           |           |      | 空，单位为字节。  |                 |
+-----------+-----------+------+-------------------+-----------------+
| R         | int(12)   | 可选 | 对服务调          | 服务调用返回    |
| esultCode |           |      | 用是调用的返回码  | 码，成功时填写  |
|           |           |      | ，对消息通信为空  | 0，失败时填写-1 |
|           |           |      | 。0为正常返回码， |                 |
|           |           |      | 非0为异常返回码。 |                 |
+-----------+-----------+------+-------------------+-----------------+
| R         | varchar   | 可选 | 结果描述信        | 服务调用失败时  |
| esultInfo | (max 512) |      | 息，只在异常时输  | ，填写失败信息  |
|           |           |      | 出，最大长度512字 |                 |
|           |           |      | 节，正常时为空。  |                 |
+-----------+-----------+------+-------------------+-----------------+
| SeqNo     | varchar   | 必选 | 埋点序            | 填写服务调用    |
|           | (max 128) |      | 列号，标识调用链  | 序号，交易埋点  |
|           |           |      | 中埋点先后顺序，  | 开始填写1，步骤 |
|           |           |      | 最大长度128字节。 | 埋点、服务埋点  |
|           |           |      |                   | 根据业务调用服  |
|           |           |      |                   | 务顺序填写埋点  |
|           |           |      |                   | 层级，在1的基础 |
|           |           |      |                   | 上逐级增加，如  |
|           |           |      |                   | 1，1.1，1.1.1， |
|           |           |      |                   | 1.2，1.2.1，1.2 |
|           |           |      |                   | .1.1，1.2.1.1.1 |
+-----------+-----------+------+-------------------+-----------------+
| C         | int(10)   | 必选 | 服务调用          | 根据Se          |
| allNumber |           |      | 序号，服务在调用  | qNo判断，有几个 |
|           |           |      | 链中的调用顺序，  | 层级就写几，如  |
|           |           |      | 在serverRecv加1。 | 1.1，则填写2，  |
|           |           |      |                   | 如1.1.1则填写3  |
+-----------+-----------+------+-------------------+-----------------+
| E         | varchar   | 可选 | 预留              | 业务特殊信息:\  |
| xtendInfo | (max      |      | 的业务扩展字段，  | 业务类型        |
|           | 1024)     |      | 采用名值对（Name= | 编码（RECTYPE） |
|           |           |      | Value）的格式，"= | 、受理渠道（ACC |
|           |           |      | "前后不能有空格， | ESSTYPE）、受理 |
|           |           |      | 如包含多个名值对  | 地市（REGION）  |
|           |           |      | ，之间以英文逗号  | 、操作员ID(OPE  |
|           |           |      | ","加空格分隔，名 | RID)、服务号码( |
|           |           |      | 值对之间不可以包  | SERVNUMBER)、菜 |
|           |           |      | 含回车或换行符。\ | 单ID(MENUID)等  |
|           |           |      | 业务              | 业务关键信息。  |
|           |           |      | 扩展字段仅供业务  |                 |
|           |           |      | 层输出能辅助故障  | 注意            |
|           |           |      | 定界定位的业务层  | 红色格式要求。  |
|           |           |      | 关键信息（如业务  |                 |
|           |           |      | 返回码、用户号码  |                 |
|           |           |      | 、用户ID等），请  |                 |
|           |           |      | 求和响应的码流信  |                 |
|           |           |      | 息不能放在这里。\ |                 |
|           |           |      | 在移动阅读门      |                 |
|           |           |      | 户的埋点信息里，  |                 |
|           |           |      | 需要固定输出用户  |                 |
|           |           |      | 号码信息，格式为" |                 |
|           |           |      | UserNumber=\*\*\* |                 |
|           |           |      | \*"，该字段需要放 |                 |
|           |           |      | 在扩展信息首部。  |                 |
+-----------+-----------+------+-------------------+-----------------+
| PlatformE | varchar   | 可选 | 平台扩展字        | 暂时填空        |
| xtendInfo | (max 512) |      | 段，采用名值对（  |                 |
|           |           |      | Name=Value）的格  |                 |
|           |           |      | 式，如包含多个名  |                 |
|           |           |      | 值对，之间以英文  |                 |
|           |           |      | 逗号加空格分隔，  |                 |
|           |           |      | 名值对之间不可以  |                 |
|           |           |      | 包含回车或换行符  |                 |
|           |           |      | 。平台扩展信息需  |                 |
|           |           |      | 要包含如下信息：\ |                 |
|           |           |      | 1、               |                 |
|           |           |      | 跟踪              |                 |
|           |           |      | 任务ID，格式为：  |                 |
|           |           |      | TaskID=\*\*\*\*\  |                 |
|           |           |      | 如包含多个跟踪任  |                 |
|           |           |      | 务ID，每个跟踪任  |                 |
|           |           |      | 务ID都以单独的名  |                 |
|           |           |      | 值对输出，输出格  |                 |
|           |           |      | 式为：TaskID=ID1, |                 |
|           |           |      | TaskID=ID2,       |                 |
|           |           |      | TaskID=ID3\       |                 |
|           |           |      | 2、               |                 |
|           |           |      | Tra               |                 |
|           |           |      | ceFlag，格式为：T |                 |
|           |           |      | raceFlag=\*\*\*\* |                 |
|           |           |      | (取值为二进制数)\ |                 |
|           |           |      | 3、               |                 |
|           |           |      | 调用链            |                 |
|           |           |      | 组标识GroupID，BE |                 |
|           |           |      | S中对应为业务交易 |                 |
|           |           |      | 流水号，格式为：  |                 |
|           |           |      | GroupID=\*\*\*\*\ |                 |
|           |           |      | 4、               |                 |
|           |           |      | 调用链            |                 |
|           |           |      | 组名称GroupName， |                 |
|           |           |      | BES中对应为业务交 |                 |
|           |           |      | 易类型名，即Entr  |                 |
|           |           |      | yMenu，格式为：Gr |                 |
|           |           |      | oupName=\*\*\*\*\ |                 |
|           |           |      | 5、               |                 |
|           |           |      | 调用链子          |                 |
|           |           |      | 组标识SubGroupID  |                 |
|           |           |      | ，BES中对应为步骤 |                 |
|           |           |      | 标识，格式为：Su  |                 |
|           |           |      | bGroupID=\*\*\*\* |                 |
+-----------+-----------+------+-------------------+-----------------+
| C         | varchar   | 可选 | 可读文本格式的码  | 填空            |
| odeStream | (max      |      | 流（非二进制码流  |                 |
|           | 10240)    |      | ）输出，仅针对与  |                 |
|           |           |      | 门户中设置的特定  |                 |
|           |           |      | 用户号码匹配（跟  |                 |
|           |           |      | 踪匹配标志hasComp |                 |
|           |           |      | aredTrace为true） |                 |
|           |           |      | 的调用请求和响应  |                 |
|           |           |      | ，以及业务返回码  |                 |
|           |           |      | 异常的调用响应。  |                 |
|           |           |      | 不需要打印码流时  |                 |
|           |           |      | ，该字段可为空。  |                 |
+-----------+-----------+------+-------------------+-----------------+
### 业务监控日志文件平台
#### 业务调用链日志采集（方案一：filebeat+logstarsh）
#### 
Filebeat简介：
filebeat是一个日志文件托运工具，在你的服务器上安装客户端后，filebeat会监控日志目录或者指定的日志文件，追踪读取这些文件（追踪文件的变化，不停的读），并且转发这些信息到elasticsearch或者logstarsh中存放。
以下是filebeat的工作流程：当你开启filebeat程序的时候，它会启动一个或多个探测器（prospectors）去检测你指定的日志目录或文件，对于探测器找出的每一个日志文件，filebeat启动收割进程（harvester），每一个收割进程读取一个日志文件的新内容，并发送这些新的日志数据到处理程序（spooler），处理程序会集合这些事件，最后filebeat会发送集合的数据到你指定的地点。
业务监控日志采集方案：
![](media/image16.png){width="5.768055555555556in"
height="2.3631944444444444in"}
1.  NGCRM、NGBOSS前台WAS应用、后台CICS服务、后台进程应用运行过程中将业务调用链日志写入本地服务器日志文件，在各应用主机部署日志实时采集程序filebeat，并配置filebeat业务日志的输入路径、文件名称，以及日志信息输出方式及IP、端口等信息。
2.  filebeat实时读取日志文件变更信息，并将日志信息实时写入业务监控日志服务器的logstash目录。通过logstash程序将filebeat写入的日志实时写入业务监控日志服务器的本地文件。
3.  
4.  在业务监控日志服务器部署BOMC采集代理程序，实时将调用链日志信息采集到BOMC服务器做日志分析和查询展示。
#### 采集器filebeat部署
> 配置采集器filebeat扫描的目录文件。
>
> 实时日志采集器配置：
>
> paths:
>
> \- /hwapp/NGCRM/cicslog/ZJ-NGCRM-CICS-TRACELOG-20180108\*.log
> #指明读取文件的位置
>
> output.logstash: #使用logstash对filebeat收集起来的数据执行其他处理
>
> hosts: \[\"logstash.xxx.xxx.xxx.xxx:xxxx\"\]
> #hosts选项需要指明logstash服务所监听的地址和它的端口
注：logstash将所监听的端口传入的数据写到本地磁盘文件。
#### logstash部署配置
> 业务监控日志服务器部署logstash应用，并监听xxxx端口，对于此端口写入的数据写入到本地磁盘的日志文件中：
**文件名称：**AA-NGXXX-BBB-TRACELOG.log.YYYYMMDD.nnn
其中
AA：地市编码简写，如广州:GZ
NGXXX：应用系统，如NGCRM、NGBOSS
BBB：应用服务，如WAS、CICS
YYYYMMDD：年月日，如20171121
nnn：文件序列号，如001，002递增
**文件路径：**
/xxx/logs/%{basepath}/%{host}/%{foldername}/%{filename}.%{suffix}.
#### 业务调用链日志采集（方案二：FTP 工具RBI）
![](media/image17.emf){width="5.768055555555556in"
height="4.8016447944007in"}
> 程序特性：
>
> 1、FTP采集工具部署在业务监控日志文件服务器，采用pull的方式：定时（可配置时间间隔）到目标机器取文件（文件名称匹配规则可配置）。
>
> 2、可将当前接口机的文件分发到其他目标机器，分法策略可以配置。
### ~~业务配置平台~~
#### ~~业务配置新增日志服务模块功能~~
##### ~~日志数据采集~~
~~由于业务调用链日志散落在各节点CRM、节点BOSS应用服务器上，包括CRM
WEB、CRM WAS、CRM CICS、CRM APP、BOSS
CICS等，需要新增日志采集程序FTP上传到业务配置平台接口文件服务器主机进行汇总，然后由业务配置平台对日志文件数据入库。上传成功后各应用节点将原始日志文件删除，以减少到存储的占用。~~
![](media/image18.emf)
~~业务配置平台文件服务器信息:~~
~~IP地址：~~
~~账号：~~
~~密码：~~
~~文件目录：~~