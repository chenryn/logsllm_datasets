# 木马盗用“风行播放器签名”进行流氓推广

**译文声明**
本文为翻译文章，原文来源：qxnjawk@360安全播报。译文仅供参考，具体内容及含义以原文为准。

## 摘要
近期，360安全中心检测到大量推广程序在传播一款带有有效风行签名（"Beijing Funshion Online Technologies Ltd."）的静默安装程序。进一步分析发现，该程序无法卸载，并通过LSP注入系统中的联网进程。此外，该程序具备反虚拟机、反调试、抗分析、远程控制和远程执行等功能，实际上是一款植入用户计算机的后门程序。

## 0x1 FunMini文件分析
### 基本信息
- MD5: 64a34cc9a22fa93d0705920e4c3aed0c
- 文件名: FunMini.exe
- 文件类型: PE, 未加壳
- 签名: Beijing Funshion Online Technologies Ltd.
- 签名状态: 正常

### 行为概述
运行后，样本会对目标机器环境进行检测，包括虚拟机和开发工具等。如果未检测到开发工具和虚拟机，它会下载一个后门DLL并加载执行，同时进行手机应用推广。

### 行为详解
该木马会检查用户机器上是否存在IDA、VC6.0、windbg.exe等常用分析工具。这类检测在木马中较为常见，而面向大众的软件很少进行此类检测。以下是木马检测的所有字符串的内存截图：

检测通过后，后门从服务器下载名为Foamii.dll的文件，该文件是整个行为的核心。

## 0x2 Foamii.dll文件分析
### 基本信息
- 名称: Foamii.dll
- MD5: a8367b1199422f103da439678a1a3683
- 文件类型: win32 PE, DLL
- 签名: Beijing Funshion Online Technologies Ltd.
- 签名状态: 正常

### 行为详解
木马首先调用WinExec函数启动rundll32.exe作为宿主进程，并调用Foamii.dll的startup函数。运行后，DLL会从服务器读取在线shellcode代码到本地。shellcode的远端地址如下：
- URL: http://fld.funshion.com/instant/instant?bid=52

浏览器打开该URL返回的内容如下：
- 数据报文内容见下图

加载shellcode后，代码会向服务器发起访问，返回一个JSON字符串，其中包含新的下载地址。下载回来的是一个名为Foamii.zip的压缩文件。解压后，释放了一个名为FunNail.dll的程序。

## 0x3 FunNail.dll文件分析
### 基本信息
- 文件名称: FunNail.dll
- MD5: 042ace2a209f537bb9402a563894cf9e
- 签名: Beijing Funshion Online Technologies Ltd.

### 行为概述
该程序运行后，首先检测当前环境是否为虚拟机，并删除PcHunter、smiff等常见分析工具。然后下载推广程序进行推广。

### 行为详解
木马调用IsProcessorFeaturePresent函数检测自身是否处于调试环境中，从而判断是否正在被分析。若非调试环境，则申请内存执行shellcode。接着创建一个模态对话框，关键工作函数放在窗体回调函数中。

工作函数中，首先检测虚拟机情况，然后遍历磁盘文件。一旦发现分析工具则立即删除，如PCHunter32.exe和smsniff.exe。此外，程序还包含绕过UAC防护的代码，适用于Windows 7及更高版本。

准备工作完成后，程序下载一套安卓手机连接组件，并开启专门线程等待USB设备接入。一旦检测到安卓手机接入，便创建可读写的pipe管道，用于adb fork-server服务。利用adb命令在手机端创建adb fork-server server进程，通过adb连接电脑。成功后，读取手机端数据并启动守护进程，同时下载一个或多个APK文件到本地。最后，找到SD卡或内部存储的tmp路径，将准备好的APK文件推送到手机中，安装并启动守护进程，使用adb shell:install命令启动APK进行流氓推广。

整个过程对用户来说是完全不可见的，唯一感知到的是手机上的多次不期而遇的安装。

## 0x4 总结
360安全中心最早于2014年12月中旬接到关于带有风行签名的程序从PC端强推安卓应用的问题，并组织技术力量进行了拦截。然而，在沉寂了9个月后，今年9月中旬，该族系又卷土重来，采用了更加复杂的反安全软件代码。

目前，360已对该推广进行了拦截，并提醒用户及时清理。该后门已感染数百万台计算机，并且仍在不断变种对抗。我们希望厂商能够管理好自己的产品，避免走上这条不归路。