Are all BSDs created equally? 
A survey of BSD kernel vulnerabili9es.;
!
!
!
Ilja!van!Sprundel!!
Who Am I;
•  Ilja!van!Sprundel!!
•  PI:EMAIL!
•  Director!of!Penetra4on!Tes4ng!at!IOAc4ve!!
•  Pen!test!
•  Code!review!
•  Break!stuﬀ!for!fun!and!proﬁt!J!!
Outline/Agenda ;
•  Intro!
•  Data!!
•  vulnerabili4es!over!the!years!
•  Test!by!audit!
•  Common!aJack!surface!!
•  Somewhat!less!common!aJack!surface!!
•  Some!results!/!conclusions!!
What is this talk about? ;
•  BSD!kernel!vulnerabili4es!!
•  Comparison!!
•  Between!diﬀerent!BSD!ﬂavors!!
•  Audience!!
•  Low!level!security!enthusiasts!!
•  UNIX/BSD!geeks!!
•  I!suspect!Linux!folks!might!enjoy!this!too!!
•  Curious!people!that!like!to!poke!around!in!OS!internals!
•  Knowledge!!
•  Some!basic!knowledge!of!UNIX!/!BSD!internals!!!
Standing on 
the shoulders 
of giants;
•  Previous!interes4ng!BSD!kernel!security!
research!by:!!
•  Silvio!!
•  the!noir!
•  Esa!Etelavuori!
•  Patroklos!(argp)!Argyroudis!
•  Christer!Oberg!!
•  Joel!Erikkson!!
•  Clement!Lecigne!
intro;
Really? Got Data?;
•  Somehow!that!statement!has!always!
been!stuck!in!my!head!!
•  Is!it!true?!!
•  Can!we!look!at!some!data!?!!
Source: hFps://www.cvedetails.com/product/47/Linux-Linux-Kernel.html;
Data! ;
•  Goes!from!current!back!to!1999!for!Linux!kernel!vulnerabili4es!!
•  Cvedetails.com!doesn’t!seem!to!provide!data!for!OBSD/NBSD/FBSD!!
•  Manually!grab!it!from!!
•  hJps://www.freebsd.org/security/advisories.html!
•  hJp://netbsd.org/support/security/advisory.html!
•  hJps://www.openbsd.org/errata*.html!
BSD kernel vulnerabili9es over the years ;
•  Looking!at!these!numbers,!that!was!an!astute!
observa4on!by!Theo.!!
•  20!was!a!very!low!es4mate!!
•  But!are!these!numbers!on!equal!foo4ng?!!
•  Many!eyeballs?!!
•  Yea,!yea,!I!know!….!But!is!there!some!truth!to!it!in!this!
case?!!!
FreeBSD!
NetBSD!
OpenBSD!
1999!
3!
8!XXXTODO!
2000!
8!
4!XXXTODO!
2001!
6!
7!XXXTODO!
2002!
11!
6!XXXTODO!
2003!
7!
3!XXXTODO!
2004!
8!
5!XXXTODO!
2005!
11!
8!XXXTODO!
2006!
9!
15!XXXTODO!
2007!
1!
4!XXXTODO!
2008!
8!
6!XXXTODO!
2009!
5!
1!XXXTODO!
2010!
3!
6!XXXTODO!
2011!
1!
2!XXXTODO!
2012!
2!
1!XXXTODO!
2013!
8!
8!XXXTODO!
2014!
7!
6!XXXTODO!
2015!
7!
2!XXXTODO!
2016!
12!
1!XXXTODO!
2017!
1!
3!XXXTODO!
Total!
118!
96!XXXTODO!
Test by audit!;
•  Silvio!Cesare!did!some!interes4ng!work!in!~2002!that!gives!
some!answers!!!
•  hJps://www.blackhat.com/presenta4ons/bh-usa-03/bh-
us-03-cesare.pdf!!
•  His!results!seem!to!indicate!there!isn’t!really!that!much!of!a!
quality!diﬀerence.!However:!!
•  that!was!well!over!a!decade!ago.!!
• 
Have!things!changed?!!
•  Time!spend!on!the!BSDs!was!only!a!couple!of!days!compared!to!Linux!
• 
If!more!4me!would’ve!been!spend,!would!more!bugs!have!been!found?!!
•  bugs!are!mostly!int!overﬂows!and!info!leaks!!
• 
Other!kinds!of!issues!that!can!‘easily’!be!found!?!!
Test by Audit redux.;
•  Spend!April-May-June!audi4ng!BSD!source!code.!
•  Asked!myself,!“where!would!the!bugs!be?”!!
•  AJack!surface!
•  Very!common!
•  Syscalls!!
•  TCP/IP!stack!!
•  Somewhat!less!common!(in!ascending!order,!more!or!less)!
•  Drivers!(ioctl!interface)!
•  compat!code!!
•  Trap!handlers!!
•  Filesystems!!!
•  Other!networking!(BT,!wiﬁ,!IrDA)!
!
Syscalls;
AFack surface entrypoint;
•  The!obvious!aJack!surface!!
•  Syscalls!are!how!userland!gets!anything!done!from!kernel!!
•  Hundreds!of!them!!
•  FreeBSD:!~550!!
•  OpenBSD:!~330!!
•  NetBSD:!~480!
•  Assump4on:!given!that!they’re!obvious,!and!well!tested,!less!likely!to!contain!
security!bugs!!
int!
sys_sendsyslog(struct!proc!*p,!void!*v,!register_t!*retval)!
{!
!struct!sys_sendsyslog_args!/*!{!
!
!syscallarg(const!void!*)!buf;!
!
!syscallarg(size_t)!nbyte;!
!
!syscallarg(int)!ﬂags;!
!}!*/!*uap!=!v;!
!int!error;!
!sta4c!int!dropped_count,!orig_error;!
...!
!error!=!dosendsyslog(p,!SCARG(uap,!buf),!
SCARG(uap,!nbyte),!
!!!!!SCARG(uap,!ﬂags),!UIO_USERSPACE);!
...!
!return!(error);!
}!
int!
dosendsyslog(struct!proc!*p,!const!char!*buf,!size_t!nbyte,!int!ﬂags,!
!!!!enum!uio_seg!sﬂg)!
{!
...!
!struct!iovec!aiov;!
!struct!uio!auio;!
!size_t!i,!len;!
...!
!aiov.iov_base!=!(char!*)buf;!
!aiov.iov_len!=!nbyte;!ß!user!controlled!size_t.!never!capped!anywhere!!
...!
!auio.uio_resid!=!aiov.iov_len;!
...!
!len!=!auio.uio_resid;!ß!user!controlled!size_t!
!if!(fp)!{!
...!
!}!else!if!(consJy!||!cn_devvp)!{!
...!
!}!else!{!
...!
!
!
!kbuf!=!malloc(len,!M_TEMP,!M_WAITOK);!!!
...!
!}!
...!
}!
Sample bug ;
•  sendsyslog!system!call!!
•  OpenBSD!6.1!
•  Been!there!since!OpenBSD!6.0!
•  Unbound!length!passed!to!malloc()!from!userland!!
•  Will!trigger!a!kernel!panic!!
•  Previous!assump4on!is!not![en4rely]!true:!bugs!in!syscalls!do!occur!with!some!
frequency!!
•  Especially!newly!added!syscalls!!
TCP/IP stack ;
AFack surface entrypoint;
•  TCP/IP!stack!!
•  Ipv4/6!!
•  Udp/tcp/icmp!
•  Ipsec!!
•  …!
•  Obvious!and!well!known!aJack!surface!!
•  Has!been!around!forever!!
•  Assump4on:!well!tested!and!less!likely!to!ﬁnd!bugs!there!!
struct!secpolicy!*!
key_msg2sp(!
!
!!!!struct!sadb_x_policy!*xpl0,!
!
!!!!size_t!len,!
!
!!!!int!*error)!
{!
...!
!switch!(xpl0->sadb_x_policy_type)!{!
...!
!
!case!IPSEC_POLICY_IPSEC:!
!
!{!
...!
!
!
!tlen!=!PFKEY_EXTLEN(xpl0)!-!sizeof(*xpl0);!
!
!
!xisr!=!(struct!sadb_x_ipsecrequest!*)(xpl0!+!1);!
!
!
!!
!
!
!while!(tlen!>!0)!{!!
/*!length!check!*/!
if!(xisr->sadb_x_ipsecrequest_len!sadb_x_ipsecrequest_len!>!sizeof(*xisr))!{!
!struct!sockaddr!*paddr;!
!
!
!
!
!!
!paddr!=!(struct!sockaddr!*)(xisr!+!1);!
!
!
!
!
!!
!/*!validity!check!*/!
!if!(paddr->sa_len!
!
!>!sizeof((*p_isr)->saidx.src))!{!!
!
!ipseclog((LOG_DEBUG,!"key_msg2sp:!invalid!request!"!
!
!!!"address!length.\n"));!
!
!key_freesp(newsp,!KEY_SADB_UNLOCKED);!
!
!*error!=!EINVAL;!
!
!return!NULL;!
!
!}!!
length!check!is!incomplete.!
sadb_x_ipsecrequest_len!can!
be!!invalid!
length!check!is!incomplete.!!
paddr->sa_len!can!be!
invalid!
bcopy(paddr,!&(*p_isr)->saidx.src,!!paddr->sa_len);!
this!copy!can!out!of!bound!
read!on!paddr.!Assume!
malicious!user!that!controls!
heap!chunk!aÇer!paddr.!
could!make!it!so!paddr-
>sa_len!is!large!and!causes!
memory!corrup4on!
Sample bug;
•  IPSEC!setsockopt()!!
•  Out!of!bound!read!!
•  Can!end!up!corrup4ng!memory!!
•  Aﬀects:!!
•  FreeBSD!11!
•  NetBSD!7.1!
•  Previous!assump4on!is!not![en4rely]!true:!bugs!in!TCP/IP!stack!do!occur!with!
some!frequency!!
•  newer!code!!!
•  mbuf!handling!is!complicated!and!error!prone!!
Drivers ;
AFack surface entrypoint;
•  Lots!and!lots!of!drivers!!
•  For!all!sorts!of!things!!
•  UNIX:!everything!is!a!ﬁle!!
•  Most!expose!entrypoints!in!/dev!!
•  File!opera4ons!!
•  Open!!
•  Ioctl!!
•  Read!
•  Write!!
•  Close!