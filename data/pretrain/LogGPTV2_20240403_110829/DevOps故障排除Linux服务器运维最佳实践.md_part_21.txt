postfix的主进程）的进程正在所有的IP地址上监听端口 25。例如，
务器仍在运行，这说明有一些其他需要解决的配置问题。
不用root权限就能运行这个命令：
最后，如果的确看到邮件服务器正在运行并监听正确的端口，
不过，有很多问题可能导致telnet 测试失败。其中一个就是：
从上面的输出中可以看到，ID号为16923（进程名是master,
如果相关进程没有正常运行，解决方案也很简单：启动相应的
如果运行的是 sendmail或者exim 系统，可以用服务器初始脚
$ sudo netstat -1np| grep :25
$sudo/etc/init.d/postfix status
$ps-ef| grep postfix
postfix
*postfix is running
tcp
root
postfix
postfix
root
postfix
telnet测试无法连接
10784169230Jan13？
10820 16923
20426 12533
2030416923
18320 16923
16923
00.0.0.0:25
1
0 20:38 pts/2
0 Jan13 ?
020:36?
020:23
02011
0.0.0.0:*
00:00:00 grep postfix
00:02:44 qmgr -1-t fifo-u-c
00:00:00anvil-1-tunix-u
00:00:00pickup -1-tfifo-u-C
00:24:15/usr/lib/postfix/master
00:00:39 t1smgr-1-t unix-u-C
LISTEN
7.4
4接收邮件的问题·129
16923/master
---
## Page 137
130
·第7章为什么无法收发邮件？追踪邮件问题
该去检查日志，看看为什么原始信件没有成功发送。
到本地邮箱的时候应该有点问题）之间应该有一些问题。如果邮件
找问题的所在了。根据这些信息，首先你要做的就是使用类似less
件日志中过滤查找有用的信息。
的确在收件箱中，那么就有理由确定此时邮件服务器工作正常，应
POP/IMAP服务器（或者，如果它在同一台机器上，那么邮件传输
的邮箱中。如果这封邮件没有出现在邮箱内，那你的邮件服务器和
的邮箱已经装满，那么当你尝试发送测试邮件的时候，就会获得一
看到。例如，如果因为硬盘已满或者其他一些服务器问题导致用户
外界连人。
功，那么很有可能是防火墙或者路由的问题，它们阻止了服务器从
件本应该被发送的时间段和发件人的地址。这两样信息会帮助在邮
这封邮件。如果你正在回复一位用户的抱怨，看看你是否能找到邮
一些远程邮件服务器打算连接你的邮件接收服务器的痕迹并发送了
7.4.3
个告诉你去哪里寻求帮助的错误信息。
那你应该能看到一些投递问题，这些问题在远程邮件服务器上也能
次，这次连接到相同子网下的另一个服务器。如果两次尝试都能成
127.0.0.1，确定是否可以连接。如果能够正常连接，那么再尝试一
封邮件，但是她到现在也没有收到，这些信息就已经足够你开始查
7.4.2
另一方面，如果接收了这个邮件，请确认它已经出现在收件人
如果telnet能连接到邮件服务器，但是却无法发送测试邮件
例如，如果用户的邮件地址是PI:EMAIL，同时Jan告诉
如果邮件服务器能正常接收其他邮件，现在需要看下能否找到
telnet可以连接，但消息却被拒绝了
研究邮件日志
---
## Page 138
常发送。事实上，即使那个时候邮件服务器宕机，邮件也应该要么
需执行一个理智的检查，看看这个时间段内其他的消息是否已经正
到早上8:00左右这段时间，现在还不需要查找Jan的邮件信息，仅
件中，用 grep 命令查到完整的邮件传输信息：
用文本编辑器打开/tmp/jans_incoming_emails这个文件，检查 Jan
该将/var/log/mail.log替换为那天的日志。不管哪种情况，现在你要
样才方便仔细检查。
是过滤今天发送给 Jan 的邮件并将其导人到一个单独的文件中，这
就会把这封邮件发送出去。
在备用服务器的队列中，要么一旦这台服务器重新正常工作，很快
这样的工具打开/var/log/mail.log这个日志文件，跳过前面的信息直
要提取报文ID。例如，日志中你感兴趣的一项看起来可能是这样：
段内的信息。在检查文件的过程中，如果你找到任何在那个时间段
段的邮件，但是为了保险起见至少要查看早7点到早9点这个时间
类型的邮件。如果你想省事点，可以使用 grep 命令过滤出特定时间
是否收到了其他邮件。然后，检查她在早上8点左右都收到了哪种
内符合条件的邮件，你可能会想要查看完整的文件传输，所以你需
当你确信邮件服务器在这个时间段内工作正常之后，下一步就
如果Jan 告诉你这封邮件是几天前而不是今天发送的，那你应
拿到报文的 ID62337254A2，然后回到/var/log/mail.log 这个文
$ sudo egrep'to=,*PI:EMAIL'/var/log/mail.1og > /tmp/jans_incoming_emails
Apr 19 08:05:06 incoming postfix/local[13089]: 62337254A2:to=,
Apr19 08:05:06incoming postfix/ocal[13089]:6233254A2:to=,
Apr1908:05:02incoming postfix/mgr[10784]:62337254A2:from=
→info>,size=11382,nrcpt=1 （queue active)
command:/usr/bin/procmail-t)
re1ay=1ocal,delay=4.7,delays=0.4/0.03/0/4.3,dsn=2.0.0,status=sent(delivered to
7.4接收邮件的问题131
---
## Page 139
132
grep 命令查询所有与 gmail.com 相关的信息：
·第7章为什么无法收发邮件？追踪邮件问题
使问题你这边不再出现，你可能仍然想要追踪问题的根源，即便它
的管理员一起工作，对比日志文件。这要看这些邮件的重要性。即
的邮件信息，让Fred再发一次。最后你甚至可能要与管理远程站点
信息，那么就可以自信满满地找到Jan，告诉她没有看到任何相关
那个域中发来的任何邮件。如果此时在日志中还是看不到任何相关
文件中看看他是否尝试发送过邮件。最后，你甚至可能会简单地用
有与 fred 邮件地址相关的信息：
址，那么邮件就会被退回，但是Fred却没注意到。为此，提取出所
而是查找由 Fred 发出的邮件。毕竟，如果他拼错了 Jan 的邮件地
件人不是PI:EMAIL。
是另外一个管理员的过失。
查找整个邮件日志的另一个方法不是查找发送给Jan的邮件，
$ sudo grep‘gmail.com'/var/log/mail.log > /tmp/gmail_all_emails
然后，看看是否有任何来自 Fred 的报文ID，再回到原始日志
从这个日志中，你可以查看在Jan所说的这段时间内是否有从
$ sudo egrep 'from=PI:EMAIL' /var/log/mail.log > /tmp/freds_incoming_emails
在这个例子中，这个邮件不对(看上去像是垃圾邮件），因为发
Apr 19 08:05:06 incoming postfix/qmgr[10784]:62337254A2:removed
command:/usr/bin/procmail-t)
→relay=1ocal,delay=4.7,delays=0.4/0.03/0/4.3,dsn=2.0.0,status=sent (delivered to
---
## Page 140
务器为什么不响应。对于开发工程师来说，很可能你开发的程序即
建工具需要通过 Web 前端来操作，更不要说去测试基于Web 的应
故障显得愈发重要。
能将来某一天你也要负责一款这样的应用程序，能排除Web服务器
浏览器来访问。有这么多的应用依赖于 Web 服务器的健康程度，可
外，现在很多本地运行的应用程序被移植到了Web 服务器上并通过
你可能不会立刻得知某个人的电子邮件服务器或者DNS 服务器岩
它们打交道，但是Web 服务已经开始得到人们越来越直接的关注。
性能迟缓或者不可用的问题上担负更多的责任。当然如果你是系统
程师要比在传统的团队里承担起更多的职责，并且在诊断Web服务
务器上。另外在DevOps 团队里，就配置Web服务器方面，开发工
使不是全部运行在Web服务器上，至少也会有一部分服务运行在服
用程序了。当Web服务器无响应时，你需要用工具去追踪Web服
除Web 服务器的故障。对质量工程师来说，许多自动测试用例和构
机了，但是如果你最喜爱的站点岩机了，你可能立即就会知道。另
将来某个时候，可能DevOps团队中的每个人都需要及时地排
尽管DNS 和电子邮件是重要的互联网服务，我们每天都要和
网站岩机了？追踪Web服务器问题
第8章
---
## Page 141
134
8.1.1远程端口是否开放
●第8章网站宕机了？追踪Web服务器问题
下面这个测试用于查看80端口是否开放。做这个测试有很多不同
强烈推荐你先通读第5章；但是，本章假设问题不在于网络，所以
果 Web服务器不能访问，第一个需要回答的问题是，这个故障是本
列诊断步骤已经在第5章使用过，主要用来诊断网络故障。毕竟如
8.1
障，所以无论你使用哪种 Web 服务器软件，当出现故障时，这些工
程度。这里介绍的工具和技术可以用于处理大多数Web 服务器故
你可以用它们来衡量两个流行Web 服务器 Apache 和Nginx的健康
故障不见得会有帮助。相反，本章会提供通用和基本的诊断步骤
第一个回答那个糟糕问题的人：“网站是不是岩机了？”
管理员，很可能将负责维护团队中的一些Web 服务器。也许你将是
的方法，比如使用telnet命令：
器域名和IP与你自己的配置一致。
服务器域名是web1，IP地址是10.1.2.5，请确保命令中的Web服务
将会重复第5章里某些特定的Web服务器故障排除步骤。本例中，
地的故障还是远程服务器的问题。要查看完整的网络诊断步骤，我
具和技术都可以帮助你定位故障的原因。
的泥潭中，那些内容都可以单独写一本书，但对你排除Web 应用的
人排除某个特定Web 框架、内容管理系统、插件或者博客平台故障
在这样一个专门介绍排除 Web 服务器故障的章节里，很容易陷
虽然可以路由到服务器，却不能访问Web服务器的80端口。
首先要诊断的服务器故障是完全不可访问的问题，通用的一系
$telnet10.1.2.580
telnet:Unable to connect to remote host:Connection refused
Trying 10.1.2.5...
服务器是否正在运行
---
## Page 142
开放，因为这个命令可以探测到防火墙的存在。如果系统没有安
的 Web 服务没有按你的预期工作，那么你需要检查 Web 服务器上
问请求。如果 telnet 可以连接，说明根本不存在网络故障。若运行
Apache没有运行或者监听的端口不是80），要么是防火墙阻挡了访
查找有关监听 80端口的信息，或者使用 grep命令过滤输出内容，
器，测试服务器是否在监听 80端口。命令 netstat-lnp 能列出本机
8.1.2
webl主机是否开放了80端口。
丢弃了。这意味着你需要检查网关（10.1.1.1）的防火墙规则以及
将会显示端口关闭，例子中显示被过滤。这说明防火墙将数据包给
实被关闭了，还是被防火墙过滤了。若是端口确实被关闭了，nmap
webl，只需输人命令：
装 nmap 程序，请使用系统软件包管理工具安装 nmap。想要测试
Apache的配置。
所有的监听端口和打开这些端口的进程名称。分析该命令的输出，
是否可用。
因。如果认为故障源于本机，那么可以做一些测试来检查80端口
只输出有关监听 80端口的信息。
相比telnet命令，我更倾向使用 nmap命令去测试端口是否
测试监听端口如果确认网络没有故障，那么登录Web 服务
现在，我们可以把故障范围缩小到网络原因或者主机本身的原
哈哈，nmap 命令很聪明，它可以区分出一个被关闭的端口是确
若是看到Connection refused，那要么是端口没有启动（很可能
$ nmap -p 80 10.1.2.5
80/tcp filtered http
PORTSTATESERVICE
Interesting ports on web1 (10.1.2.5):
在本地测试远程主机
8.1服务器是否正在运行·135
---
## Page 143
136
·第8章网站宕机了？追踪Web服务器问题
可能是服务器上运行了防火墙程序。使用iptables 命令列出本机所
截规则。如果是这样，输出结果可能类似下面这样：
启动Apache 服务器。
有的防火墙规则。如果主机禁用了防火墙，iptables 的输出信息应该
监听这个端口，如果在 netstat 命令中看不到这个输出，那么你需要
址，这里可以看到特定的IP地址信息：10.1.2.5:80。
在监听所有通过 80 端口的流量。若Apache 只监听主机的以太网地
该列说明该主机正在监听哪个地址。本例中，0.0.0.0:80说明主机正
接收队列和发送队列数据（这里都设置为0）。你需要关注第四列，
火墙可能会被默认设置为丢弃所有的数据包，虽然没有列出任何拦
类似下面这样：
防火墙规则如果进程正在运行并且已经监听了80端口，那么
最后一列说明哪个进程打开了这个端口。本例中，
$sudo /sbin/iptables -L
注意在此输出信息中，防火墙默认的规则是ACCEPT。不过防
$sudo/sbin/iptables-L
输出的第一列说明端口所使用的网络协议。
Chain OUTPUT (policy DROP)
Chain INPUT (policy DROP)
Chain OUTPUT (policy ACCEPT)
Chain INPUT (policy ACCEPT)
Chain FORWARD（policy DROP
target
target
Chain FORWARD(policy ACCEPT)