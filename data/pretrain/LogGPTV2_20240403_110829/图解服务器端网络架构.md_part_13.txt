带点D
/LAN10
ALANZG
VLANTC
VLANGS
垂实际上L2文提机中也有对VLAN标签的处理，图中省略水西
使用打标VLAN时应统一本征VLAN
我们在设置打标VLAN时要注意本征VLAN的存在。设有IEEE802.1Q的端口并非对所有
的VLAN都会打标，有一个VLAN是除外的，那就是本征VLAN
这里的关键在于要保持相邻设备的本征VLAN一致。也许你会想，如果是不打标的VLAN
就可以不用在意嘛，然面实际情况却并非如此。假设一边的本征VLAN是VLAN1而另一边的
本征VLAN是VLAN3，那么它们会分别映射不同的广播域，二者之间就无法进行通信了。所
以我们不仅要保持两边的VLANID一致，还要保持两边的本征VLAN也一致才行。
Catalyst交换机的默认本征VLAN是VLAN1，当然我们也可以修改这一默认设置。另外，
只有在使用CDP（CiscoDiscoveryProtocol，思科发现协议）的前提下，才能自动检测出两边设
备的本征VLAN不一致并发出警告信息“%CDP-4-NATIVE_VLAN_MISMATCH”。关于CDP
的内容将在5.1.4.1节中说明。
本征VLAN在虚拟环境中的原理也一样。如果我们在端口组的VLANID中选择“无（0）
那么隶属于该端口组的虚拟机的顿就不会被打标。不被打标也就等同于本征VLAN。面如果在
这里设置VLANID，那么vSwitch就会给该VLANID打标。
---
## Page 89
2.1数据链路层的技术73
图2.1.27有一个VLAN不会被打标
图2.1.2
节AD
LAN
---
## Page 90
74|第2章建辑设计
图2.1.29在虚拟环境中世要注意本征VLAN
L2文换机
802.10
1号0
拍交机
无（0]
VLAN2
2.1.3ARP将逻辑和物理关联到一起
在网络的世界里只有两个概念是表示地址的，一个是前面一直在讲的MAC地址，另一个
则是IP地址。MAC地址是硬件被赋予的物理地址，在数据链路层（L2）中发挥作用。IP地址
则是由OS设置的逻辑地址，在网络层（L3）中发挥作用。这两个地址如果步调不一致就会乱
套，务必让它们被此协调配合才行。ARP（AddressResolutionProtocol，地址解析协议）就是能
让这两个地址保持协调的存在，它在物理和逻辑之间起着桥梁的作用。
图2.1.30ARP是物理和逻辑之间的桥梁
物理地址
报电址
MAC 地址
IP地址
在网卡中设置
在OS中设置
---
## Page 91
2.1数据链路层的技术75
2.1.3.1ARP通过IP地址查询MAC地址
ARP是物理和逻辑之间的桥梁，这听起来似乎非常高深，不过它实际上只是将IP地址和
MAC地址关联起来而已，并没有进行什么复杂的处理。
我们知道，收到来自网络层的IP数据包之后，节点必须将其封装成帧并传递给线缆。然
面，刚刚收到IP数据包时节点并不清楚该如何对它进行封装，因为节点虽然知道源MAC地址
就是本机的MAC地址，却不知道目的MAC地址是什么。这时候就要用到ARP了。ARP先去
查看IP数据包的目的IP地址，如果是同一网段的节点，ARP就去查询该IP地址的MAC地址；
如果是不同网段的节点，ARP就去查询默认网关的MAC地址。默认网关相当于一个通往非本
地网段的出口，如果数据包是发给非本地的其他网段面且并不清楚目的IP地址，那么它就会被
发给默认网关。这里说的“网段”指的是IP地址的所属范围，会在2.1.1.2节中另外详细说明。
在目前这个阶段，我们可以认为广播城和VLAN是同一个意思。
这里请记住一点：ARP是通过IP地址去查询MAC地址的。
图2.1.31ARP将两个地址美联到一起
请过ARP将两个的地址
XXEK
自的
MAC
MAC地址
MAC地址
类型
数据
FCS
89节
6字节
2*节
46  15009 节
49节
ARP的原理很简单
ARP的原理很简单，非常容易理解。请想象一下这个场景：你大声地（广播）问大家“某
某某是哪位啊？”，于是某某某回答“我就是某某某啊！”。
络层发来的数据包中目的地的IP地址。ARP请求通过广播散发出去，同一VLAN中的所有节
点都会收到该请求。
---
## Page 92
76|第2章逻辑设计
图2.1.32
ARP不知道应将信息发往何处，于是大声沟问所有节点
VLANI
L2 交换机
点A
点日
点
MAC地址
L2交换机
点8
TAC
节点0
MAC电址：C
MAC地址：D
IP地址：③
IP地址：4
-VLAN（广播域）的所有节点中，只有一个真正拥有对象IP地址的节点会做出回应。其他的
节点因为与己无关，会将收到的信息丢弃。ARP回复不需要使用广播，它通过单播将信息发给
发送ARP请求包的节点。
---
## Page 93
2.1数据链路层的技术|77
图2.1.34通过广播和单播查出对方节点的MAC地址
12交换
节点A
西过广
1点8
MAC地址: A
IP地址
ARP请求
2是位响？
ARP
收能是2响
通过单格发送信息
Q以太网的数据部分中包含着诸多的地址信息
ARP在以太网的数据部分写人了很多地址信息，并以此将MAC地址和IP地址关联起来。由
于操作（Operation）和地址之外的数据都是固定不变的，因此本书只介绍操作和地址这两项内容。
图2.1.35ARP在数据部分写入了很多信息
生号
ARP复
ARP清求
出ARP请求时，因不清
MACE
P地址
P
2半节2字节1学梦1字节2字
专字节
4字节
0字
MAECE
前导码
美型
数据（数据包）
6字
6字节
2字节
2字节
4字节
ARP请求的操作代号是1。请求时，节点将源MAC地址和源IP地址设置为本机地址，将
目的MAC地址设置为00-00-00-00-00-00（因为尚不清楚实际地址是什么）.将目的IP地址设为
欲查询其MAC地址的节点的IP地址。ARP请求采用广播的形式，收到广播的所有节点都会去
查看目的IP地址，但是只有真正拥有该IP地址的节点才会给出ARP回复，拥有其他IP地址的
节点则会将收到的信息丢弃。
ARP回复的操作代号是2。回复时，节点将源MAC地址和源IP地址设置为本机地址，将
---
## Page 94
781第2章速辑设计
目的MAC地址和目的IP地址分别设置为发送了ARP请求的节点的MAC地址和IP地址。
ARP回复采用单播的形式，向发来ARP请求的节点返回信息。收到ARP回复的节点查看源
MAC地址和源IP地址的部分后，就能知道对方的MAC地址是多少，面知道MAC地址之后就
可以开始通信了。将MAC地址和IP地址关联起来的表叫作ARP表。
图2.1.36数据部分将MAC地址和IP地址关联到一起
L2文换机
点A
节点B
MAC地址：8
P地址：②
课过查看日的所
星在项己
ARPA
Q通过高速缓存控制通信流量
读到这里，想必各位已经能够了解ARP在通信中的重要作用了。对于通信来说，ARP是基
础中的基础。正是因为通过ARP查询出发送目的地的MAC地址，通信才得以成立。
然而ARP有着致命的弱点，那就是“以广播发送为前提条件”。由于一开始发送方并不知
道对方节点的MAC地址，使用广播也算是一种必然的选择。然面广播会向同一网段中的所有
节点都发送数据，是一种效率很低的通信。假设VLAN中有1000台节点机，那么通信就会流
向这1000台机器，假如每台节点机通信时都发送ARP，那么仅ARP通信流量就会充斥于整个
VLAN。原本MAC地址和IP地址就不会频繁发生变化，于是人们为ARP开发出了可暂时存储
条目的高速缓存功能。
ARP查询到对方节点的MAC地址后，会在ARP表中添加新的条目并将其暂时保存。在暂
时保存期内ARP不会发送信息，超过一定时间（时限）之后则会删掉该条目并发送ARP请求。
时限因OS面异，Windows7是10分钟，思科公司的设备则为4个小时，当然，这些默认时限
部是可以修改的。
---
## Page 95
2.1数据链路层的技术
79
效率极作
图2.1.38通过高速缓存功能提高效率
ARP8
计时直至时限
---
## Page 96
80|第2章遂辑设计
更换设备时要注意ARP高速缓存
高速缓存功能在减少ARP的通信流量上发挥着巨大的作用，但它并非是完美无缺的。有了
这项功能，实时性就会差强人意，这是拥有高速缓存功能的所有协议相通的一个致命弱点。当
IP地址或MAC地址发生变化时，ARP表依然保留着旧的信息，因此只有等保留的条目超过时
限后，ARP再重新学习一遍新地址才能重新开始通信。
那么，节点的MAC地址或IP地址会频繁发生变化吗？不会。在大多数情况下MAC地址和
IP地址都是一直不变的，因此，一般情况下我们不必在意ARP的这个弱点，需要注意的是更换
设备的时候。例如，网络打印机突然出故障面不得不换掉了，这时候IP地址还是不变的，但
MAC地址会变，然面打印机周边的节点并不知道MAC地址的这个变化，还是会去查看ARP表，
试图和已经不存在的MAC地址通信，直到表中该条目的时限到来为止（超过时限之后才能重新
开始通信）。要想解决这个间题就得使用GARP，关于GARP的内容将在2.1.3.3节中详细说明。
图2.1.39MAC地址一变航无法通信了
L2 交提机
点A
节点8
IP地址：
IP地址：2
ARP
2是零位制？
ARP9R
ARP表
节点0
MAC地址：X
一要
P地址：2
ARPR
2是哪位明
AAPE
通信成
---
## Page 97
2.1数据链路层的技术81
2.1.3.2抓取ARP包、观察它的写法
下面两张图是我们抓取到的ARP请求包和ARP回复包的实例。
ARP请求为广播发送，所以目的地址为FF-FF-FF-FF-FF-FF，此外我们还能看到数据部分
写人了很多地址信息；ARP回复为单播发送，所以目的地址为发来ARP请求的节点的MAC地
址，我们能看到该数据部分也同样写人了很多地址信息。
图2.1.40ARP请求是通过广播发送的
re_43:5eibe Bn
Pemet , Src: Vmware_43:5e:be (00:
red (26 bits]
n: Broadcost (tHHAH
e:be (00:0c:29:42:5e:be)
ARP求力
型代码
广发送
(1) meg3 odA eemp
rotocol type: 3P (0x0600)
ARP求的择作
在AC地中
内号电1