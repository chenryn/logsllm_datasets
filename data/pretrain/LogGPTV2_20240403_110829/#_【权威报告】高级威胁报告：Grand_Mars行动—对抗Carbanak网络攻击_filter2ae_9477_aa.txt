# 【权威报告】高级威胁报告：Grand Mars行动—对抗Carbanak网络攻击
|
##### 译文声明
本文是翻译文章，文章来源：2.trustwave.com
原文地址：
译文仅供参考，具体内容表达以及含义原文为准。
****
**翻译：**[ **pwn_361**
****](http://bobao.360.cn/member/contribute?uid=2798962642)
**预估稿费：300RMB**
**投稿方式：
发送邮件至[linwei#360.cn](mailto:PI:EMAIL)，或登陆[网页版](http://bobao.360.cn/contribute/index)在线投稿**
**一、摘要**
2016年9月到10月期间，在欧洲和美国的酒店行业中，多个重要机构在他们的网络里发现了可疑和潜在的恶意活动，这些恶意活动分布在不同属性和地点的服务器、销售点终端机、和客户端工作站中。Trustwave公司的SpiderLabs安全团队接受了这些机构的安全咨询并进行调查。
这次攻击行动的主要动机是获取经济利益、完全控制目标的基础设施、在受害组织内收集僵尸主机。取证调查和分析表明，这次行动是由多个个体或多个群体实施的，包含多个恶意团体的互相合作，每个恶意团体有自己的角色和任务。很明显，我们正在对付有组织的犯罪份子，他们为了对多个受害人实施攻击活动，建立了这个复杂的网络主机系统，及大量的恶意文件。
在被攻击的机构里发现了多个攻击标志，不仅在企业AV服务中发现了一些潜在的恶意软件碎片，而且在Windows事件日志中也发现了可疑活动的标志信息。由于受害者是不同的机构，因此对不同机构的调查由Trustwave内部的不同小组进行，但是小组之间是共享信息的，调查表明攻击事件中存在几个相似之处。
在所有攻击行动中，共同的进入点是一封针对受害者公共服务的电子邮件，包含一个Word文档附件。一旦打开这个附件，多个恶意文件就会被创建或下载，这就使攻击者一定程度上进入了受害者的基础设施中。在一些情况下，攻击者实际上会给受害人打一个电话，用一个社会工程学策略，来引导受害人打开附件。
下一步，攻击者会运用多种HASH传递的方法，进行提权操作，并通过计划任务和多个自启动的位置使得控制持久化。最终这些行为允许攻击者获得域权限、甚至以企业管理级访问该网络，并使用了多个在欧洲和美国的资源作为C&C服务器。
攻击者通过使用云服务，如Google Docs,Google
Forms和Pastebin.com，来跟踪被感染的系统、传播恶意软件、实施附加的恶意活动。利用这些服务对攻击者很有利，因为大多数企业的网络都允许访问这些服务，并且几乎不可能屏蔽它们。
在这次攻击行动中使用的恶意代码，被分割成了内存驻留代码、脚本代码(PowerShell,JavaScript,VBS)、可执行代码(经常出现新变种)，并使用了定制版本的工具包，如Metasploit,PowerSploit,Veil
Framework。
另一个重要标识是一些可执行文件使用了来自Comodo的有效证书，一个权威的证书。根据对该证书的分析，我们相信攻击者购买或使用了假的身份，绕过了额外的安全控制。
在本文中，我们描述了一个针对欧洲和美国酒店行业的系统性犯罪攻击行动。然而，我们的发现显示出其它行业，如电子商务和零售行业也在危险中，这种犯罪活动可以轻易地传播到世界其他地方。
大部分C&C服务器使用的IP地址部署在欧洲(英国、法国、瑞典等)的未知系统上，表明攻击者通过使用看似无害的服务器作为恶意端点，试图绕过网络安全控制。在对这次攻击行动调查期间，我们监控了这些C&C服务器的访问，发现攻击者偶尔会改变他们的C&C服务器，并下线之前的C&C服务器。我们相信，这种交替使用C&C服务器的做法是有目的的行为，应该是为了尽可能的保持隐蔽。
我们将这次攻击行动称为“Grand
Mars”行动，在那以后，网络犯罪份子使用了从Comodo买到的其中一个数字证书。尽管在证书细节中使用的名称和俄罗斯位置细节(城市，地址等)可能是假的，但实际上有人买了这些证书，这是一个强有力的标志，说明我们对付的是有组织的犯罪活动。
我们的高级威胁报告旨在对该攻击行动的行为和文件进行分析：
我们的分析和调查采取的方法是描述恶意活动的性质、策略、及攻击者运用的技术、可能的动机，以及攻击背后的威胁角色的属性。
对于已经被这个行动攻击的机构、或愿意采取积极应对措施的机构，我们提出了修补措施和建议。
攻击指示器(IOCs)将不仅有利于机构探索评估遭受到的攻击(或在专业安全团队的帮助下)，而且在机构被当成目标时，提供一个具有前瞻性检测机制的早期预警系统。
尽管如此，还是要注意到，我们的这种高级威胁报告没有、也没有能力取代正式的事件响应行动和程序，事件响应行动和程序作为机构事件响应/灾难恢复的路线图，必须担负起减缓威胁和恢复业务的功能。
**二、分析和调查**
**1、进入点**
调查的第一个目标是识别出攻击者进入网络时准确的进入点，和最初的攻击方法。
钓鱼邮件和恶意Word文档
Trustwave
SpiderLabs安全团队在全球范围内进行了众多调查，在这次攻击行动的时间线中，最开始使用了一个常见的攻击方法—钓鱼邮件，至少有一个或更多的员工收到了这个邮件，它包含了一个恶意的Word文档，作为邮件的附件。
图 1 受害人收到的邮件中包含恶意Word文档附件
图 2 钓鱼邮件内容
邮件的内容是：美好的一天，我们想为员工预订房间，有12个人将会在11月24日到达巴黎，房间类型在我们的附件中，还有我们员工的名字。如果你们有空房间，我们就付押金。等待你的回复。
邮件内容看起来是合理的，并且和机构的服务(酒店行业)内容是有关系的，邮件包含一个Word文档(.docx)，名称为“1-list.docx”，如下图：
图 3 Word文档附件
有趣的是，恶意软件作者会直接给受害人打电话，并要求受害人打开附件，以确保感染，原因是Word的默认设置会阻止任何宏的执行。这就是攻击途径中说服用户执行宏的社会工程学元素，通过双击文档中内嵌的一个图片。
**恶意Word文档分析**
对Word附件进行详细检查后，发现了该攻击行动使用的攻击方法(策略、途径)，通过使用这种攻击途径，攻击者获得了目标机构网络的进入点，“1-list.docx”文件似乎是一个启用宏的恶意软件，可以在目标系统中下载、并执行恶意代码。
图 4 Word文档，宏激活恶意软件
最新的office(.docx,.xlsx等等)文件实际上是由微软设计的一个基于XML的压缩文件格式，作为一个正常的压缩文件，里面的文件可以被提取出来。解压以后，Word文档的内容中有一个内嵌的OLE对象(oleObject1.bin)被释放出来。
图 5 Word文件中释放出的oleObject1.bin文件
在oleObject1.bin的内容中，嵌入了一段宏代码(unprotected.vbe)，它似乎被编码了。
图 6 oleObject1.bin中疑似编码的内容
图 7 使用合法工具加密/编码VBE脚本
在oleObject1.bin的内容里，有一段字符串，请看上图截图部分，表明攻击者使用了一个市场上可以买到的脚本编码/加密工具，名为“Scripts
Encryptor”，攻击者使用了它的一个评估版本。
图 8 用于混淆VBE脚本的工具
**  
**
**内嵌的脚本**
手动对oleObject1.bin的内容进行了解码，结果果然是一个VBScript。这个脚本包含了多个功能，其中的一个子集用于转换数据，针对的是嵌入到脚本中的自定义变量数据，使用的技术例如“BinaryToStRinG，StringTOBinary”和“Base64DecodE，base64ENcode”。
图 9 二进制转换字符串函数
图 10 base64编码解码函数
嵌入式脚本的主要用途之一是使用先前列出的功能在受感染的系统上创建几个其他文件。新文件被存储在名为“f”的变量中。
图 11 创建starter.vbs文件
上面的代码将会在用户的临时文件夹中创建一个starter.vbs文件。
图 12 创建LanCradDriver.vbs、LanCradDriver.ini文件
上图中的代码将会在用户的临时文件夹中创建一个LanCradDriver.vbs文件和一个空的LanCradDriver.ini文件。LanCradDriver.ini的作用将会在后面章节中解释。
图 13 创建TransbaseOdbcDrive.js文件
最后创建的TransbaseOdbcDriver.js文件需要在隐藏的命令行下，利用wscript.exe来执行。
图 14 starter.vbs持久化
除了创建的文件，内嵌的脚本(oleObject1.bin)会添加一个注册表键值用于程序持久化，还包含了一个计划任务，会周期性(每30分钟)的调用并执行“starter.vbs”。
另一个有趣的函数使用了系统的硬盘序列号，并计算出一个唯一的用户识别号。利用这个函数，攻击者从每个受感染的系统中会得到一个唯一的识别号。函数的输出用base64编码过，并存储为“cuid”,在随后的操作中会使用到它。
图 15 计算CUID号
互联网活动还表明，有一个函数在检查机器上的代理设置情况，可疑互联网活动是这个操作行为的一部分，在后面的文章中我们会解释到。
图 16 检查代理配置
图 17 主函数
在操作行为的第一阶段，“主”函数负责处理最后一个比特。初始调用了cuid()，正如我们前面看到的，会处理磁盘的S/N号，然后运行了其它几个功能函数。这些函数收集了用户的信息，如用户名、计算机名/域名(GetUseRData)，检查系统架构(32位还是64位)，并获得系统版本(GetOS)。所有这些信息存储在了“txt”变量中，然后sendFormData函数接着对它进行了处理。
图 18 sendFormData函数
如上图，sendFormData函数使用并连接了Google
Forms，在这一阶段，前面收集的到信息(用户数据、磁盘S/N等)将会被恶意软件操作者发送到Google Form，显示如下：
图 19 最初提交给Google Form
从“formFirstPingBotList”名称上就可以明显看出来，正在从受害者上收集初始信息。使用这种服务，会有利于攻击者，因为这些服务在访问的大部分网络中都不受限制。
**  
**
**2、邮件附件的衍生品**
正如我们看到的，打开Word文档会执行内嵌的脚本，会释放出下面四个文件：
图 20 执行内嵌的VBE脚本，释放出的文件
注意上图中的内容，LanCradDriver.ini文件是一个空文件，它还没有被填充。在下面的分析中，你将会看到，在TransbaseOdbcDriver.js脚本执行后，它会被填充。
**starter.vbs**
这是一个VBScript文件，前面已经显示过了，包含注册表自启动，和利用计划任务实现持久化，并执行真正的载荷。
表格 1 starter.vbs的HASH
Starter.vbs负责在一个隐藏的命令行下，使用wscript.exe执行TransbaseOdbcDriver.js脚本。
图 21 starter.vbs脚本
下面的图片显示，starter.vbs脚本通过计划任务被启动了。Starter.vbs依次调用并执行了TransbaseOdbcDriver.js，这是这一攻击阶段的核心。
图 22 TransbaseOdbcDriver.js进程的信息
**TransbaseOdbcDriver.js**
该脚本包含了多个函数，但是在这里我们主要关注它的主要功能。
表格 2 TransbaseOdbcDriver.js的HASH
在执行该脚本后，它会调用LoadLinkSettings()函数，该函数会连接Google
Spreadsheet，并执行一个宏，这个宏基于唯一磁盘序列号(guid)，在文章前面我们可以看到。
图 23 LoadLinkSettings()函数
该宏代码的输出结果被分隔($$$)成三部分，并在后面的操作中会使用到，分别是：SpreadSheetKey、FormKey、Entry。
图 24 执行Google宏后的输出结果
然后，它使用这些参数，调用了LogInet()函数，并使用Google Forms提交了一个新感染者/僵尸主机，连接Google
Forms使用了一个“Android HTC Pyramid”模型(中国–台湾语言)的User-agent字符串。
图 25 LogInet()函数
图 26 使用Google Form注册新感染的系统
初始化成功后，脚本调用getsourcecode()函数，功能是按1或2分钟的间隔无限循环。