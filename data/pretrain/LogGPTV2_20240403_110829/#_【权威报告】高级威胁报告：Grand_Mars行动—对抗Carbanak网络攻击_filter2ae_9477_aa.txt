# 【权威报告】高级威胁报告：Grand Mars行动—对抗Carbanak网络攻击

#### 译文声明
本文为翻译文章，原文来源：2.trustwave.com。译文仅供参考，具体内容及含义以原文为准。

**翻译者：pwn_361**
**预估稿费：300 RMB**

**投稿方式：**
- 发送邮件至 [linwei#360.cn](mailto:PI:EMAIL)
- 或登录 [网页版](http://bobao.360.cn/contribute/index) 在线投稿

## 摘要
2016年9月至10月期间，欧洲和美国的酒店行业多个重要机构在其网络中发现了可疑且潜在的恶意活动。这些活动涉及不同地点的服务器、销售点终端机以及客户端工作站。Trustwave公司的SpiderLabs安全团队接受了这些机构的安全咨询并展开了调查。

此次攻击的主要动机是获取经济利益、完全控制目标基础设施，并在受害组织内部收集僵尸主机。取证调查和分析显示，该行动由多个个体或团体实施，各团体之间存在合作，每个团体承担特定的角色和任务。显然，我们面对的是有组织的犯罪分子，他们为了对多个受害者进行攻击，构建了复杂的网络主机系统和大量恶意文件。

在受攻击的机构中，发现了多个攻击标志，不仅包括企业AV服务中的潜在恶意软件碎片，还包括Windows事件日志中的可疑活动标记。由于受害者来自不同的机构，因此Trustwave内部的不同小组分别进行了调查，但小组间共享信息，发现攻击事件中有几个相似之处。

所有攻击行动的共同入口点是一封针对受害者公共服务的电子邮件，其中包含一个Word文档附件。一旦打开该附件，就会创建或下载多个恶意文件，使攻击者能够进入受害者的基础设施。在某些情况下，攻击者甚至会通过电话联系受害者，利用社会工程学策略引导其打开附件。

接下来，攻击者使用多种HASH传递方法进行提权，并通过计划任务和多个自启动位置实现持久化控制。最终，这些行为允许攻击者获得域权限，甚至以企业管理级访问网络，并利用位于欧洲和美国的资源作为C&C服务器。

攻击者还利用云服务（如Google Docs、Google Forms和Pastebin.com）来跟踪被感染的系统、传播恶意软件并执行其他恶意活动。利用这些服务对攻击者非常有利，因为大多数企业的网络都允许访问这些服务，并且几乎不可能屏蔽它们。

此次攻击中使用的恶意代码包括内存驻留代码、脚本代码（PowerShell、JavaScript、VBS）和可执行代码（经常出现新变种），并使用了定制版本的工具包，如Metasploit、PowerSploit和Veil Framework。

另一个重要标识是部分可执行文件使用了Comodo的有效证书。根据对该证书的分析，我们相信攻击者购买或使用了虚假身份，绕过了额外的安全控制。

本文描述了一次针对欧洲和美国酒店行业的系统性犯罪攻击行动。然而，我们的发现表明，其他行业（如电子商务和零售业）也处于危险之中，这种犯罪活动可以轻易扩散到世界其他地区。

大部分C&C服务器使用的IP地址部署在欧洲（英国、法国、瑞典等）的未知系统上，表明攻击者试图通过使用看似无害的服务器作为恶意端点来绕过网络安全控制。在调查期间，我们监控了这些C&C服务器的访问情况，发现攻击者偶尔会更换C&C服务器并下线之前的服务器。我们认为，这种交替使用C&C服务器的做法是有意为之，目的是尽可能保持隐蔽。

我们将此次攻击命名为“Grand Mars”行动。此后，网络犯罪分子使用了从Comodo购买的一个数字证书。尽管证书细节中使用的名称和俄罗斯位置细节（城市、地址等）可能是假的，但实际上有人购买了这些证书，这表明我们面对的是有组织的犯罪活动。

我们的高级威胁报告旨在对该攻击行动的行为和文件进行分析：
- 描述恶意活动的性质、策略和技术
- 分析攻击者的可能动机
- 确定攻击背后的威胁角色属性
- 提出修补措施和建议，帮助已受攻击的机构或希望采取积极应对措施的机构
- 提供攻击指示器（IOCs），有助于机构评估遭受的攻击，并在成为目标时提供早期预警系统

需要注意的是，此高级威胁报告无法替代正式的事件响应行动和程序。事件响应行动和程序必须作为机构事件响应/灾难恢复的路线图，负责减轻威胁和恢复业务。

## 分析和调查
### 1. 进入点
调查的第一个目标是识别攻击者进入网络的确切入口点和初始攻击方法。

#### 钓鱼邮件和恶意Word文档
Trustwave SpiderLabs安全团队在全球范围内进行了多次调查，在此次攻击的时间线中，最开始使用了一个常见的攻击方法——钓鱼邮件。至少有一个或多个员工收到了包含恶意Word文档附件的邮件。

![图 1 受害人收到的邮件中包含恶意Word文档附件](图 1)

![图 2 钓鱼邮件内容](图 2)

邮件内容如下：
```
美好的一天，我们想为员工预订房间，有12个人将会在11月24日到达巴黎，房间类型在我们的附件中，还有我们员工的名字。如果你们有空房间，我们就付押金。等待你的回复。
```

邮件内容看起来合理，并与酒店行业的服务相关。邮件包含一个名为“1-list.docx”的Word文档附件。

有趣的是，恶意软件作者有时会直接给受害者打电话，要求其打开附件，以确保感染成功。这是因为Word的默认设置会阻止任何宏的执行。这就是攻击途径中说服用户执行宏的社会工程学元素，通过双击文档中内嵌的图片来激活宏。

#### 恶意Word文档分析
对Word附件进行详细检查后，发现该攻击行动使用的攻击方法（策略、途径）。通过这种方法，攻击者获得了目标机构网络的入口点。“1-list.docx”文件似乎是一个启用宏的恶意软件，可以在目标系统中下载并执行恶意代码。

![图 4 Word文档，宏激活恶意软件](图 4)

最新的Office（.docx, .xlsx等）文件实际上是由微软设计的一种基于XML的压缩文件格式。解压后，Word文档内容中释放出一个内嵌的OLE对象（oleObject1.bin）。

![图 5 Word文件中释放出的oleObject1.bin文件](图 5)

在oleObject1.bin的内容中，嵌入了一段宏代码（unprotected.vbe），似乎是经过编码的。

![图 6 oleObject1.bin中疑似编码的内容](图 6)

![图 7 使用合法工具加密/编码VBE脚本](图 7)

在oleObject1.bin的内容中，有一段字符串表明攻击者使用了市场上可买到的脚本编码/加密工具“Scripts Encryptor”，并且使用了其评估版本。

![图 8 用于混淆VBE脚本的工具](图 8)

#### 内嵌的脚本
手动解码oleObject1.bin的内容，结果是一个VBScript。这个脚本包含了多个功能，其中一个子集用于转换数据，针对嵌入脚本中的自定义变量数据，使用的技术包括“BinaryToStRinG, StringTOBinary”和“Base64DecodE, base64ENcode”。

![图 9 二进制转换字符串函数](图 9)

![图 10 base64编码解码函数](图 10)

嵌入式脚本的主要用途之一是使用上述功能在受感染的系统上创建多个文件。新文件存储在名为“f”的变量中。

![图 11 创建starter.vbs文件](图 11)

上面的代码将在用户的临时文件夹中创建一个starter.vbs文件。

![图 12 创建LanCradDriver.vbs、LanCradDriver.ini文件](图 12)

上图中的代码将在用户的临时文件夹中创建一个LanCradDriver.vbs文件和一个空的LanCradDriver.ini文件。LanCradDriver.ini的作用将在后续章节中解释。

![图 13 创建TransbaseOdbcDrive.js文件](图 13)

最后创建的TransbaseOdbcDriver.js文件需要在隐藏的命令行下使用wscript.exe执行。

![图 14 starter.vbs持久化](图 14)

除了创建的文件，内嵌的脚本（oleObject1.bin）还会添加注册表键值以实现持久化，并包含一个计划任务，每30分钟调用并执行“starter.vbs”。

另一个有趣的函数使用系统的硬盘序列号计算唯一的用户识别号（CUID）。利用这个函数，攻击者可以从每个受感染的系统中获得一个唯一的识别号。函数的输出用base64编码，并存储为“cuid”，在后续操作中使用。

![图 15 计算CUID号](图 15)

互联网活动还表明，有一个函数检查机器上的代理设置情况。可疑的互联网活动是这一操作的一部分，将在后续文章中解释。

![图 16 检查代理配置](图 16)

![图 17 主函数](图 17)

在操作的第一阶段，“主”函数负责处理最后一个比特。初始调用了cuid()，正如前面看到的，处理磁盘S/N号，然后运行其他几个功能函数。这些函数收集用户信息（用户名、计算机名/域名）、检查系统架构（32位还是64位）并获取系统版本（GetOS）。所有这些信息存储在“txt”变量中，然后sendFormData函数对其进行处理。

![图 18 sendFormData函数](图 18)

如上图所示，sendFormData函数连接Google Forms，在这一阶段，前面收集的信息（用户数据、磁盘S/N等）将被发送到Google Form，显示如下：

![图 19 最初提交给Google Form](图 19)

从“formFirstPingBotList”名称可以看出，正在从受害者处收集初始信息。使用这种服务对攻击者有利，因为这些服务在大多数网络中不受限制。

### 2. 邮件附件的衍生品
正如所见，打开Word文档会执行内嵌的脚本，释放出以下四个文件：

![图 20 执行内嵌的VBE脚本，释放出的文件](图 20)

注意上图中的内容，LanCradDriver.ini文件是空的，尚未填充。在下面的分析中，你将看到，在TransbaseOdbcDriver.js脚本执行后，它会被填充。

#### starter.vbs
这是一个VBScript文件，包含注册表自启动和利用计划任务实现持久化，并执行真正的载荷。

| 文件 | SHA-256哈希 |
| --- | --- |
| Starter.vbs | 示例哈希 |

Starter.vbs负责在一个隐藏的命令行下使用wscript.exe执行TransbaseOdbcDriver.js脚本。

![图 21 starter.vbs脚本](图 21)

下图显示starter.vbs脚本通过计划任务被启动。Starter.vbs依次调用并执行TransbaseOdbcDriver.js，这是该攻击阶段的核心。

![图 22 TransbaseOdbcDriver.js进程的信息](图 22)

#### TransbaseOdbcDriver.js
该脚本包含多个函数，但在此我们主要关注其主要功能。

| 文件 | SHA-256哈希 |
| --- | --- |
| TransbaseOdbcDriver.js | 示例哈希 |

执行该脚本后，它会调用LoadLinkSettings()函数，该函数连接Google Spreadsheet并执行一个基于唯一磁盘序列号（guid）的宏。

![图 23 LoadLinkSettings()函数](图 23)

该宏代码的输出结果被分隔（$$$）成三部分，并在后续操作中使用：SpreadSheetKey、FormKey、Entry。

![图 24 执行Google宏后的输出结果](图 24)

然后，它使用这些参数调用LogInet()函数，并使用Google Forms提交一个新的感染者/僵尸主机，连接Google Forms使用了一个“Android HTC Pyramid”模型（中国–台湾语言）的User-agent字符串。

![图 25 LogInet()函数](图 25)

![图 26 使用Google Form注册新感染的系统](图 26)

初始化成功后，脚本调用getsourcecode()函数，按1或2分钟的间隔无限循环执行。