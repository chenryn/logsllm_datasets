### 1. 数据概览
- **13,585 (0.9%)**
- **13,046 (0.9%)**
- **Cat Telecom**
- **Rostelecom-AS**
- **TOT-NET**
- **UKRTELNET**
- **IR-THR-PTE**
- **Count (%)**
- **12,883 (0.9%)**
- **11,352 (0.8%)**
- **11,136 (0.8%)**
- **10,993 (0.8%)**
- **9,248 (0.6%)**

### 2. 漏洞生命周期各阶段的工具和方法
在第6节中，我们将结合各个阶段的研究结果，对参与者的情况进行综合概述。

### 3. 识别阶段
为了在目标机器上建立立足点，攻击者首先需要知道哪些设备是可利用的。根据市场调查，全球大约有200万台MikroTik路由器被安装使用 [33]。这些路由器通常以三种方式部署在互联网上：
1. **ISP提供**：由互联网服务提供商（ISP）向客户提供，并用于连接到ISP的网络。
2. **客户购买**：由客户自行购买、部署和运营，用于连接互联网。
3. **ISP基础设施**：作为ISP网络基础设施的一部分。

由于RouterOS在整个MikroTik产品线中广泛使用，我们在实践中看到了这三种类型的易受攻击设备。

#### 3.1 地理分布
图6展示了在研究期间至少被利用一次的MikroTik路由器的地理分布热图。这些设备在全球某些地区特别普遍，尤其是在巴西和印度尼西亚，分别有29%和35%的大型运营商公开IP地址响应了这些设备，表明这些设备是由ISP提供给客户的。表2列出了受影响最严重的10个自治系统中的被入侵MikroTik路由器数量及其占总感染人口的比例。我们可以看到，前五大被入侵的ISP中有136,659台MikroTik路由器被利用。热图还显示了全球范围内的稀疏部署，在人口密集地区出现了集群，这与该地区的IP地址数量成比例，表明这些路由器是由最终用户拥有和操作的。

#### 3.2 端口扫描发现
为了定位潜在受害者，攻击者可以使用端口扫描来测试远程IP是否开放TCP端口8291（WinBox漏洞相关端口）。这种侦察可以以不同的粒度和复杂程度进行：
- **低级策略**：盲目地遍历整个互联网，虽然会制造大量噪音并可能被识别、阻止和列入黑名单。
- **高级策略**：进行一些背景研究，确定哪些网络中存在大量的MikroTik设备，可能是由于这些设备在ISP网络中使用或被分发给客户。

我们可以通过网络望远镜提供的数据和一级运营商的一般流量统计数据来区分这些策略。图5显示了2018年每天针对端口8291的绝对包数以及运营商携带的流量。垂直线表示漏洞生命周期中的重要里程碑和新闻报道。3月24日，Hajime僵尸网络执行了一次短而集中的全网扫描，导致每日流量激增了六个数量级 [25]。4月23日，MikroTik发现了漏洞并进行了修补，随后的新闻报道仅导致扫描流量略有增加。7月中旬开始，首次出现加密劫持安装，随后发布了公开的漏洞利用代码。8月初，CVE报告发布在美国国家漏洞数据库 [26] 中。

从图表中可以看出，望远镜和NetFlow流量的总体特征相似。两者都记录了Hajime僵尸网络造成的同一时刻和相似幅度的网络流量激增，表明该僵尸网络发起了一次无针对性的全球扫描。在这次爆发之后，望远镜流量恢复到正常水平，除了部分全球扫描外，我们在NetFlow数据中看到地理定向扫描（不针对我们的网络望远镜）立即跟进，并持续到观察期结束。随着2019年12月感染数量的上升，我们观察到全球扫描活动增加，望远镜和NetFlow数据都报告了更多针对端口8291的连接。

在三月份的突发活动中，共有170万个IP地址探测了我们望远镜中的三个/16网络范围以及互联网的其余部分，但只有12.4万个IP继续探测特定部分的互联网以寻找路由器漏洞。这似乎表明扫描器使用了之前收集的数据（因为我们的被动监视器不会响应8291端口），或者他们利用了额外的知识（如MikroTik在特定地区的流行程度）来指导搜索。

### 4. 使用公共数据集进行定位
除了主动扫描和探测互联网上的IP以测试其是否运行RouterOS并可能被利用外，攻击者还可以尝试从Shodan等服务获取预编译的设备IP列表，直接连接到潜在目标。为了确定攻击者是否使用此类服务来定位易受攻击的路由器，我们考虑Censys在某个时刻从一个带有挖矿站点键的路由器检索代理页面的时间，这意味着此时设备已被攻陷。如果此时路由器尚未在Shodan中列出，则攻击者必须通过独立扫描找到该易受攻击的路由器。如果在Censys公布之前，Shodan中已经存在记录，则攻击者可能从该服务获得了信息。

当我们跟踪每个站点键首次出现在140万台路由器上的日期时，我们发现54%的新站点键安装在已经在Shodan中列出的路由器上，而29%的新安装来自独立扫描。其余情况下，由于被同一站点键攻陷的路由器数量太少，无法显著分类。图8显示了行为者在其活动的前14天内使用的未列出路由器的百分比。我们清楚地看到两种模式。创新者和早期采用者，如d68a7a和hsFAjj（用虚线表示，参见图13）都进行自己的发现，并以高比例的新未列出路由器开始。随着时间的推移，这个百分比下降，因为被攻陷的设备随后被纳入Shodan。长期活动tD2a2P在第一天开始时有42%的未列出路由器，并在接下来的几个月里不断添加未知设备。另一方面，我们发现许多活动主要依赖公共列表来填充其设置。其中一个最有利可图的活动6a9929在其高峰期同时感染了13,815台路由器，几乎全部来自公共列表。正如我们将在第6节中看到的，创新程度并不总是代表这些活动的收益——创新并不总是能带来回报。总结这一生命周期阶段，MikroTik路由器在全球范围内广泛传播，我们在2018年看到了对端口8291的扫描兴趣稳步增长，一半的新安装站点键是在已经在Shodan中列出的路由器上安装的，而只有29%的新安装是攻击者独立扫描的结果。

### 5. 漏洞利用
一旦识别出易受攻击的路由器，攻击者可以通过发送简单的有效载荷来触发漏洞，如第3.3节所述。尽管我们无法从数据集中推断出攻击者在设备上的具体活动，但我们可以通过分析攻击者如何感染设备以及如何接管已感染设备的模式来进行研究。

#### 5.1 感染和再感染
从前文讨论中，我们看到NetFlow数据和望远镜数据显示大量IP扫描了端口8291，并且攻击者还使用了Shodan等记录来查找可利用的目标。然而，一旦设备出现在Shodan中，它可能已经被感染，因为代理服务可能正在端口80或8080上运行。这自然引出了一个问题：再感染是如何发生的？换句话说，攻击者是否从其他人那里夺取了被攻陷的设备，还是更新了他们已经“拥有”的路由器上的站点键？

图10描绘了140万台路由器之间站点键的转换行为，过滤后只包括超过500台设备从原始“所有者”转移到特定新攻击者的边缘。圆圈的大小表示从该站点键转移出去的路由器数量，箭头的粗细和圆圈的颜色表示新感染特定站点键的路由器数量。由于我们无法获取站点键背后的人格，我们在本节中假设每个站点键都是不同的人格。然而，正如我们在第6.2节中揭示的那样，我们有强烈的怀疑情况并非如此。在图中，我们看到两种转换行为。首先，我们看到一些站点键从已感染路由器池中抽取安装基础。例如，4983e3依赖于已感染设备的列表，然后用新的站点键重新感染它们，这一点我们已经可以从图8中推断出来。其次，我们看到路由器上的站点键按照特定顺序被另一个账户替换。当更新前后不同站点键的路由器共享相同属性（例如，由同一个人访问或共享基础设施组件）时，我们可以得出结论，这是攻击者执行密钥轮换系统的例子。从iWDUFD到ByMzv3再到aff2ba再到ef18c8的序列展示了这种过渡，可以看到所有节点的路由器离开同一个目的地，如节点和箭头颜色相同所示。一种特殊的更新形式也出现在混淆技术的应用中。例如，被站点键4983e3感染的路由器在某个时刻被更新为图9所示的iframe代码。混淆的JavaScript表达式0xbdaf(’0x0’)解码后为4983e3，因此这里的转换是技术的演变而不是账户的进展。然而，账户轮换并不一定按链发生，例如右侧的集群，其中最初为hsFAjj挖矿的路由器转向SK_LCx和oDcuak，约有15,000台路由器在这两个接收站点键之间来回切换。尽管再感染图仅显示了最大的转换以提高可读性，但实际上发生了许多变化，特别是在分布的长尾部分。总体而言，55%的路由器被多个站点键感染，15%的MikroTik设备在2018年拥有五个或更多的站点键。

### 6. 感染巩固
在攻击者获得系统凭据并激活开发人员后门后，使用root权限在设备上建立立足点。如第3节所述，防火墙配置被更改，代理被激活，并下载了其他文件。我们将在下一节中讨论货币化（加密挖矿），并在本节中讨论用于执行扫描、登录和加载其他组件的基础设施。

#### 6.1 节点间侦察
基于Censys和Shodan的数据，我们获得了随时间变化的受感染设备列表，并可以在NetFlow中追踪哪些匿名IP地址连接到易受攻击和已感染路由器上的WinBox服务。虽然大部分连接来自各种匿名IP地址，但有6.5%的流向端口8291的流量是从已感染的MikroTik路由器发送到其他MikroTik路由器的。我们观察到948台已感染路由器系统地扫描本地子网以查找端口8291上的其他易受攻击路由器。虽然基于NetFlow不清楚这些已感染路由器只是枚举易受攻击主机还是实际执行了攻击，但我们认为这种额外的结构成分值得注意。有趣的是，这种行为仅在ISP结构性推出MikroTik路由器的地理区域实施，特别是在巴西。

#### 6.2 基础设施
2018年8月，首批路由器感染事件在巴西蔓延，并受到一个复杂的攻击者的控制。成功定位易受攻击的MikroTik设备后，它利用WinBox漏洞注入了一个挖矿脚本到HTTP代理页面，并安装了一个每30秒从端口2008的暂存服务器获取新更新和命令的脚本。这些更新可能涉及挖矿服务的变更或新的站点键。通过我们的NetFlow数据，我们已经确定了六个位于211.164.222.*子网中的暂存服务器，这证实了[37]的研究。我们确定这些暂存服务器在2018年7月26日至9月21日期间活跃。