不要一厢情愿
完美的。
的部分，哪怕API语义中说明了这些问题不存在。要记住，完美的理论不代表实现也是
API都一定会存在某些问题。应该通过使用带外数据检测器来检查数据最关键、最核心
我们依赖的任何API都不可能一直完美工作。不管测试有多么复杂，工程质量有多么高，
信任但要验证
上文说的那个数据删除流水线！）
此，我们需要创建和测试一套数据备份与恢复的流程。这套机制作为DiRT演习的
审视我们的复制策略——不光是为了延时和带宽，现在数据安全性也很重要了。因
也无法被迅速恢复了，而数据对用户来说也变得越来越重要。因此，我们需要重新
后来，团队新增了一个功能一
所以我们从来也没有备份过索引。
面的索引丢失，我们也可以很快地用一个MapReduce任务恢复。整个恢复时间很短，
正关注过数据完整性问题。因为虽然我们不想返回错误结果，但是就算Bigtable上
前文提到的莎士比亚服务反响很好，用户群在稳定增长。在服务构建之初，没有真
个例子：
停地变动，我们必须要验证之前的假设和流程在新的环境下仍然适用。例如下面这
数据今天是安全的，并不意味着明天还是安全的。你的服务，甚至基础设施都在不
第26章数据完整性：读写一致
定期重新检查和重新审核
—允许用户增加文字标记。突然之间，我们的数据再
一多个保障手段彼此
---
## Page 363
都不是问题了。
目标一定是保障全部数据随时可用一
测来降低N，最后的目标一定是将N趋近于0。接下来，我们可以将重点从恢复转为预防，
当能做到在N时间范围内恢复数据之后，我们可以通过更迅速的、更细致的数据丢失检
续运行，不断演习才能保障我们在其他的364天里也能睡上好觉。
够覆盖所有可能的所有组合一
的飞跃。通过对所有的可能性以矩阵式排列，可以帮助我们确保数据完整性保障过程能
对灾难预防来说，从“任何部分都可能出错”到“任何部分都一定会出错”是一个巨大
这样的陷阱。
关注于目标，而不是具体手段，我们可以避免落入“过程全部成功，系统却仍然存在故障”
持数据可用是一个更好的策略。这中间采取的方式和手段都是为这个目标服务的。通过
GoogleSRE采用了一种与软件测试类似的流程和思路：证明系统可以在某时间范围内维
数据可用性必须作为任何以数据为中心的系统的首要重点。与其关注于具体的实现细节，
小结
恢复。
一部分要持续测试，以保障我们可以在SLO规定的时间内将用户的信息从备份中
一这可以让我们睡一晚上的好觉。只有将整个恢复计划持
一当你做到了这一点之后，每天去海边沙滩上睡也
小结
321
---
## Page 364
>第27章
322
虽然这样的一个网站是半娱乐性质的，但它的发布具有一切难度高和危险性强的特点：
卫星图像来实时跟踪圣诞老人的飞行路线。
际上收集了很多数据以提高地图的精确性）。网站的一个重要功能是“飞行模式”，利用
（该网站是半娱乐性质的，允许用户自己在上面添加自己收到的礼物记录和地理位置，实
上面显示了圣诞老人在全球各地发送礼物的记录，并且允许任何人跟踪圣诞老人的行踪。
几年前，Google和NORAD（北美空防指挥中心）合作推出了一个圣诞节主题的网站，
圣诞老人要来了！
在2011年圣诞节前夜，突然之间流量暴涨到25倍日常峰值一
Google Earth提供卫星图像。在平常的一天里，Keyhole 需要每秒响应几千条图像请求。
让我们来讨论一个普通的Google服务一
编辑：BetsyBeyer
作者：Rhandeev Singh、Sebastian Kirsch、Vivek Rau
是什么导致了此次流量暴涨呢？
可靠地进行产品的大规模发布
以及避免常见问题的手段。这个列表在实践中被证实是保障发布可靠性的重要工具。
这个小组同时维护一个“发布检查列表”，
供技术顾问和支持。
为此SRE还建立了一个专门的团队一
功能。SRE在整个流程中起到的作用是确保快速迭代不会影响到网站的稳定性。
Google这样的互联网公司比起传统公司来可以更快地发布和选代新的产品和新的
Keyhole。该服务负责给GoogleMaps以及
一发布协调小组，负责为具体的开发团队提
包括针对每次发布需要检查的常见问题
—接近了每秒100万条
---
## Page 365
个团队中的人被称为发布协调工程师（LaunchCoordinationEngineering，LCE），LCE
开发者构建符合Google标准的可靠的、可扩展的、稳定的，而且性能一流的产品。这
程师和运维工程师组成，还包括一些曾经有过其他SRE团队经验的人。该团队负责指引
Google通过建立一个SRE内部的专职顾问团队来帮助解决这些问题。该团队由软件工
的可能性，以及最大化产品的性能指标。
是，他们对同时发布给几百万用户的挑战不是很了解一
Google的软件工程师在编码和设计上的经验很丰富，同时也对产品的细节非常了解。但
发布协调工程师
践来提升这个流程的速度和可靠性。
公司不需要详细的发布流程一—下次发布时，任何之前创建的发布用的组件可能都过时
这种发布速度要求我们创建和维护一个精简的发布流程。
义来说，Google有时可以做到每周发布70次。
Google将发布定义为用户可见的应用程序代码更新。取决于每次发布的特点一属性以
而不需要发布到每个使用者的电脑上。
是非常不同的。快速发布、快速迭代变得简单的原因是他们仅仅需要在服务器端发布，
努力都是为了向世界宣布这一刻。传统公司的发布周期很长，而互联网公司的发布周期
发布一个新产品或者一个新功能对每个公司来说都是一场考验—
工程师”（LCE）负责预测发布可能出现的问题，以及在不同的开发小组之间协调工作。
嵌的儿个保护性功能开关命名为“让小孩子哭吧”。SRE中的一个特殊团队“发布协调
程不受影响。由于没有一个人想目睹小朋友们无法使用网站而伤心，我们甚至将产品内
团队通过以下几个方面确保发布流程平稳：
了。这样的公司也不可能有足够的机会创建出一个好的发布流程，因为无法通过反复实
及时间，
GoogleSRE团队为了这次发布做了很多基础设施的改动，以确保圣诞老人发送礼物的过
可不要小看几百万个小孩同时刷新网站一
传活动，3.数百万的使用人群，4.流量增速非常快（所有人都会在平安夜浏览这个网站）。
1.不可改变的截止日期（Google可不能因为网站没有上线而不过圣诞节），2.大规模宣
·审核新产品和内部服务，确保它们和Google的可靠性标准以及最佳实践一致，
同时提供一些具体的建议来提升可靠性。
发布步骤的多少，以及发布复杂程度一
一这个项目有潜力能将Google的全部服务搞垮。
一发布的流程也很不一样。按照这个定
一在这个过程中还要最小化故障
一个每三年发布一次新产品的
发布协调工程师
一几个月，甚至几年的
323
371
370
---
## Page 366
372
324
客观性
跨职能的视角
广泛的经验
专职的发布协调小组提供了以下优势。
师提供建议和指导。
的团队聚合在一起达成一个共同目标，同时还需要偶尔处理冲突问题，并且为其他工程
术要求与其他的SRE团队一样，并且需要有很强的沟通和领导能力——LCE需要将分散
我们的发布协调工程师团队由直接招聘的工程师和其他有经验的SRE组成。LCE的技
发布协调工程师的角色
的时候提供帮助。
者）。LCE团队因为参与过几百次发布因而经验很丰富，他们可以在服务进行SRE审核
挑战经常和平时稳定运行一个可靠性很强的服务是完全不同的（SRE团队的强项在于后
SRE支持，LCE团队经常也会在关键功能发布时介入帮助。发布一个新产品所面临的
发布产品，LCE会介入提供咨询服务确保发布平稳进行。如果某项产品已经有了很强的
工作是在新产品或者新服务发布之时进行的。如果某个团队在没有SRE支持的情况下
LCE团队的成员会在整个服务生命周期的不同阶段进行审核（audit）工作。大部分审核
作为一个中立的建议方，LCE在SRE、产品研发组、产品经理和市场运营团队之间
起到了平衡与协调的作用。
布通常需要协调七八个不同时区的团队共同完成。
SRE、研发团队和产品团队等。这种全局视角对复杂发布流程来说更重要，这些发
LCE对发布过程具有整体视角，这使得该团队可以协调多个分散的小组，包括
合进行知识共享的媒介。
线活动中。丰富的跨产品知识和与很多团队的良好关系使得LCE团队是公司中最适
作为一个真正的跨产品小组，发布协调小组的全部成员都积极参与到公司全部产品
·针对Google的最佳实践和各项服务的集成来培训开发者，充分利用内部的文档
●作为整个发布过程中的一个守门人，决定某项发布是否是“安全的”。
·跟进发布所需任务的进度，负责发布过程中所有技术相关的问题。
·在发布过程中作为多个团队之间的联系人。
和培训资源来加速开发。
第27章可靠地进行产品的大规模发布
---
## Page 367
的压力之下一
经验证明，工程师会绕过那些过于烦琐，或者附加值不高的流程一
高度定制
级和完整性是很困难的，在这些参数中取舍平衡需要持续不断地投入。Google成功地采
可扩展性
完整性
鲁棒性
具有的一些特征。
Google已经用超过10年的时间打磨发布流程，在这段时间中我们发现了好的发布流程
建立发布流程
保证通用路径快速完成
适应性
轻量级
注可靠性，可能会采用另外一种组织架构。
用了以下几种手段来达到目的：
正如你想的那样，这些需求是互相有冲突的。例如，想要设计一个流程来同时满足轻量
由于LCE是SRE的一部分，LCE也非常注重可靠性。
简化
确保基本信息正确。不需要为所有的可能性做准备。
可以应用在很多简单的发布上，也可以用在复杂的发布过程中。
能够最大限度地避免简单的错误。
提供一个快速简化通道。
有经验的工程师会针对每次发布定制流程
应全新的发布类型（例如Chrome 浏览器和Google Fiber的第一次上线）。
可以适用于大多数常见的发布（例如在产品界面上增加新的UI组件），以及可以适
完整地、
占用很少的开发时间。
识别出几类发布流程所具有的共同模式（例如在新的国家发布产品），针对这类发布
一致地在各个环节内跟踪重要的细节问题。
一整个发布流程可能被视为另外一个拦路虎。正是由于这样，LCE必须持
。如果其他公司不像Google这么关
建立发布流程
一尤其是在产品上线
|325