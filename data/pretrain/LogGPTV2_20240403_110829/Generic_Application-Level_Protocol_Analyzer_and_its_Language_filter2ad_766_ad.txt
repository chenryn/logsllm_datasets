Chuanxiong Guo
AGenericApplication-LevelProtocolAnalyzeranditsLanguageNikitaBorisovUIUCnikita@uiuc.eduDavidJ.BrumleyCarnegieMellonUniversitydbrumley@cs.cmu.eduHelenJ.WangMicrosoftResearchhelenw@microsoft.comJohnDunaganMicrosoftResearchjdunagan@microsoft.comPallaviJoshiUCBerkeleypallavi@eecs.berkeley.eduChuanxiongGuoICENanjingxguo@ieee.orgAbstractTheShieldprojectreliedonapplicationprotocolan-alyzerstodetectpotentialexploitsofapplicationvulner-abilities.Wepresentthedesignofasecond-generationgenericapplication-levelprotocolanalyzer(GAPA)thaten-compassesadomain-speciﬁclanguageandtheassociatedrun-time.WedesignedGAPAtosatisfythreeimportantgoals:safety,real-timeanalysisandresponse,andrapiddevelopmentofanalyzers.Wehavefoundthatthesegoalsarerelevantformanynetworkmonitorsthatimplementpro-tocolanalysis.Therefore,webuiltGAPAtobereadilyinte-gratedintotoolssuchasEtherealaswellasShield.GAPApreservessafetythroughtheuseofamemory-safelanguageforbothmessageparsingandanalysis,andthroughvarioustechniquestoreducetheamountofstatemaintainedinordertoavoiddenial-of-serviceattacks.Tosupportonlineanalysis,theGAPAruntimeusesastream-processingmodelwithincrementalparsing.Inordertospeedprotocoldevelopment,GAPAusesasyntaxsimilartomanyprotocolRFCsandotherspeciﬁcations,andincor-poratesmanycommonprotocolanalysistasksasbuilt-inabstractions.Wehavespeciﬁed10commonlyusedproto-colsintheGAPAlanguageandfounditexpressiveandeasytouse.WemeasuredourGAPAprototypeandfoundthatitcanhandleanenterpriseclientHTTPworkloadatupto60Mbps,sufﬁcientperformanceformanyend-hostﬁrewal-l/IDSscenarios.Atthesametime,thetrustedcodebaseofGAPAisanorderofmagnitudesmallerthanEthereal.1IntroductionTheShieldproject[54]introducedtheconceptofvulnerability-speciﬁc,exploit-genericsignaturesforintru-sionprevention.Thesesignaturesdifferfromtraditionalexploit-speciﬁcsignaturesbydescribingallpathsthatleadtoanetwork-exploitablevulnerability.Indoingso,theyre-quireamuchmoredetailedunderstandingofbothnetworkprotocolsandapplicationcontext.Therefore,eachsigna-tureperformssomeformofprotocolanalysis,parsingnet-workmessageformatsandreconstructingcontext.TheoriginalShieldprototypeincludedadomain-speciﬁclanguageforperformingprotocolanalysisnecessaryforasignature.However,thelanguagewasincompleteanddifﬁ-culttouseforsomeprotocols,inparticular,text-basedonesandcomplexonesinvolvingmultiplelayers.Thispaperde-scribesthedesign,implementation,andevaluationofthesecond-generationlanguageforShield,supportingrapidde-velopmentofmemory-safeandDoS-resilientprotocolana-lyzers.Inbuildingthelanguageanditsruntime,wehadsev-eralgoals.Themostimportantonewassafety:asShieldisintendedtoensurethereliableoperationofapplicationsinapotentiallyadversarialenvironment,itisimperativethatShieldanalyzersdonotintroducenewsourcesoffailureorvulnerabilities.Wethereforewantedtoavoidmemorycorruptionerrorsandprovideresistancetodenial-of-serviceattacks.Alloftheanalysisisperformedwithinamemory-safelanguage,andweintroducedfurtherrestrictionsintothelanguagetolimittheamountofmemoryandCPUusedbyprotocolanalysis.Thesecondgoalwasoneofreal-timeanalysisandre-sponse.Shieldactsasa“bumpinthewire”;therefore,itmustnotbufferdatafortoolongtoavoidapplicationde-laysorevendeadlock,andatthesametimeitmustnotde-liverdatatotheapplicationuntilitcanbesurethatitissafeandwillnotresultinavulnerability.Thelanguageandruntimearethereforedesignedbasedonastreamingdatamodel,parsing,analyzing,andenactingdecisionsonpo-tentiallyincompleteapplicationmessages.Intermsofper-formance,ourprototypeimplementationcanprocessdataatspeedsmatchingthetrafﬁcdemandsofbusywebservers,allowingforonlineoperation.Ourthirdgoalwastosupportrapiddevelopmentofpro-tocolanalyzersandvulnerabilitysignatures.Thetimelyde-ploymentofvulnerabilitysignaturesisessentialtoShield’seffectiveness.Tofacilitatethedevelopmentofprotocolana-lyzersinShield,weincorporatedcommontasksinvolvedinprotocolanalysis,suchassessionmanagementandbuffer-ingofincompletedata,asfeaturesofthelanguageandtheassociatedruntime.Westructuredthedomain-speciﬁclan-guagetobesimilartotheBNFspeciﬁcationsfoundinmanyRFCsthatdescribeprotocols.Wealsointroducedavisi-torsyntaxtoseparatevulnerability-speciﬁcanalysislogicfrommessageparsingandprotocolcontextreconstruction,sothatthelattercanbereusedamongmanyvulnerabilitysignaturesforasingleprotocolorapplication.AlthoughourinitialmotivationcamefromtheShieldproject,werecognizedthattheabovegoalsareimportantforothertoolsthatperformapplication-levelprotocolanal-ysis.Inparticular,networkmonitoringtoolssuchasEthe-real[50]andtcpdump[31],intrusiondetectionsystemssuchasSnort[51]andBro[45],andapplication-levelﬁre-wallssuchasHogwash[28]allperformsomeformofpro-tocolanalysis,buteachtoolinvolveshand-codingtheana-lyzersinageneral-purpose,low-levellanguagesuchasC.Thisapproachisbothexpensiveanderror-prone,resultingindozensofsecurityvulnerabilitiesthathavebeenfoundinrecentyearsinthepopulartoolsEtherealandtcpdump.Wethereforedesignedourlanguageandruntimetobeagenericcomponentthatcanbeincorporatedintosuchtoolsandperformtheprotocolanalysisinasecurefashion.WecalledourtoolGAPA,theGenericApplication-levelProto-colAnalyzer,anditsassociatedlanguageGAPAL.TheuseofGAPAcouldreducethetrustedcodebaseoftoolslikeEtherealbyoveranorderofmagnitudeandgreatlyreducetheriskofwormsthatexploittheparsinglogicofsecuritytools,suchasWitty[49].Therestofthepaperisorganizedasfollows.Wede-scribetheGAPAlanguageinsectionSection2,andthelan-guageruntimeinSection3.WepresentourevaluationinSection4.InSection5,wecompareandcontrastGAPAwithrelatedwork.Finally,weconcludeinSection6.2GAPALanguageAprotocolanalyzerspeciﬁcationintheGAPAlanguage(GAPAL),calledaSpec,takescareofthreetasks.First,itspeciﬁeshowtoparsethemessageformatusedbyaproto-col.Second,itneedstocorrectlytracksessionandapplica-tioncontext.Finally,itneedstoperformanalysisbasedonthemessagecontentandtheapplicationcontext,andpoten-tiallycarryoutdecisions,suchasterminatingaconnection.Inthissection,wediscussthelanguagefeaturesforthesethreetasksandthenpresentsomeoftheimportantsafetyfeaturesbuiltintotheGAPAlanguage.WewillillustratemanyofthefeaturesusingthespeciﬁcationfortheHTTPprotocolinFigure1.2.1MessageParsingEachprotocoldeﬁnesaparticularmessageformatforex-changingdata.Theseformatscanroughlybeclassiﬁedintotextandbinary.TextformatsuseASCIItexttoencodeboththestructureandthecontentofmessages,followingsomesortofgrammarthatisoftenformalizedinBackus-Naurform(BNF).Binaryformatsusemachinestructurestoen-codedata,overlayingC-likeconstructedtypesontothedatastream.Agenericprotocolanalyzermust,ofcourse,beabletoparsebothtypesofprotocols.TheoriginalShieldprototypelanguagewasmostlyori-entedtowardsparsingbinaryprotocols,withthelanguagedescribingdatastructuresthatformmessages.Textpro-tocolsweresupportedbyswitchingfrombytetowordortokenpositions;adecisionthatweultimatelyfoundtoocumbersomeforeasyprotocolspeciﬁcation.Inthesecond-generationlanguage,wehaveadoptedaBNF-likegrammarforspecifyingmessageformats.Thisgrammarmakesiteasytorepresenttextprotocols,andthereisanaturalmap-pingofbinaryprotocolstothisgrammaraswell,makingthelanguageveryversatile.ThegrammarsectionofaGAPALspeciﬁcationcon-sistsofproductionrulesthatspecifyamostly(seebe-low)context-freelanguage.Eachproductionmapsanon-terminal(variable)toasequenceofterminals(tokens)andnon-terminals;additionally,analternationoperationcanbeusedtoselectamongmultiplesuchsequences.Thisstruc-turecloselymirrorsBNFnotation,andwefoundthatmuchofthetaskofspecifyingtextprotocolscanbeaccomplishedmerelybycopyingtheBNFspeciﬁcationoutofanRFC.Eachiteminthesequenceontheright-handsideofapro-ductioncanalsobeannotatedwithasymbolname,intheformof:.Thesymbolnamecanbeusedtorefertothatpartofthemessagelaterduringproto-colanalysis.Expressingbinaryprotocolsisalsostraightforward.Inthiscase,theterminalsrepresentbasetypes,suchasbytesork-bitintegers,non-terminalsrepresentstructures,andal-ternationisusedtoencodeunions.Wealsosupportarraynotation,withbothstaticallyanddynamically-sizedarrays.RFCsoftenuseBNFnotationtodescribeaprotocol,butthesespeciﬁcationsarenotingeneralcontext-freegram-mars;theycontainambiguitiesthatareresolvedbasedonotherﬁeldsinamessageorprotocolstate.RatherthanforceGAPALauthorstorewritespeciﬁcationstobecontext-free,weincorporatetheconceptofdirectedparsing,whereapro-grammercanuseaninterpretedC-likelanguageandembedcodetospecifyhowacertainﬁeldshouldbeparsedbasedonvariablescomputedfromparsingpreviousﬁelds.For2protocolHTTPProtocol{transport=(80/TCP);/*Sessionvariables*/int32content_length=0;boolchunked=false;boolkeep_alive=false;/*messageformatspecificationinBNF-likeformat*/grammar{WS="[\t]+";CRLF="\r\n";%%HTTP_message->Request|Response;Request->RequestLineHeadersBody;Response->ResponseLineHeadersBody;HeadersBody->{chunked=false;keep_alive=false;content_length=0;}HeadersCRLF{/*message_body’stypeisresolved(:=)atruntimebasedonTransfer-Encoding*/if(chunked)message_body:=ChunkedBody;elsemessage_body:=NormalBody;}message_body:?;Headers->GeneralHeaderHeaders|;GeneralHeader->name:"[A-Za-z0-9-]+"":"value:"[ˆ\r\n]*"CRLF{if(name=="Content-Length"){content_length=strtol(value,10);}elseif(name=="Transfer-Encoding"&&value=="chunked"){/*slightsimplification*/chunked=true;}elseif(name=="Connection"&&value=="keep-alive"){keep_alive=true;}};NormalBody->bodypart:byte[content_length]{/*‘‘send’’:sending"bodypart"totheupperlayer(e.g.,RPC)forfurtherparsing*/send(bodypart);};[...]};//Grammarstate-machinehttpMachine{(S_Request,IN)->H_Request;(S_Response,OUT)->H_Response;initial_state=S_Request;final_state=S_Final;};/*Alwaysexpectaresponseafterarequest*/handlerH_Request(HTTP_message){intheaderCount=0;/*visitorsyntax*/@GeneralHeader->{print("headername=%v\n",name);headerCount++;}print(‘‘Totalnumberofheaders:%v\n’’,headerCount);returnS_Response;};handlerH_Response(HTTP_message){if(keep_alive){returnS_Request;}else{returnS_Final;}};};//protocolFigure1.AbbreviatedHTTPspeciﬁcationinGAPAL.example,thelengthofthebodyofanHTTPmessageisspeciﬁedbytheheaderﬁeldContent-LengthaspartofGeneralHeader;inFigure1thecontentlengthvalueissavedinsideavariableandretrievedintheNormalBodyproduction.Codeblocksarealsohelpfulwhenthetypeofasymbolisbestdeterminedatruntime.Weintroduceare-solveoperator,denoted:=,whichallowsthestatementstospecifyhowtoparsesubsequentﬁelds.Aresolveassignsatype(oranon-terminal),speciﬁedontheright-handside,toasymbolnameontheleft-handside.Adynamicallyresolvedsymbolnameisdenotedwiththe‘?’type.Forexample,inourHTTPspeciﬁcation(Figure1),thetypeofmessagebody(aspartofHeadersBody)dependsonthevalueofTransfer-Encodingheader.Itispossibletorewritethesegrammarstoavoidtheresolveoperatorandbecontext-free,buttheresultingspeciﬁcationismuchmoreawkward.Directedparsingisalsousefulinbinaryprotocolstosupportsuchidiomsastaggedunions.32.2TrackingContextAtypicalprotocolinteractioninvolvestheexchangeofmultiplemessagesfrombothsides.Therefore,aGAPALspeciﬁcationmusttracktheprotocolcontext(andthecor-respondingapplicationcontext)acrossmultiplemessageswithinasingleinteraction,orsession.Wedeﬁneasessiontobeagroupofrelatedmessages;formanyprotocolsthiscorrespondsdirectlytoasingleTCPconnection,andthisisthedefaultsessiongroupingusedbyGAPA.Otherpro-tocols,suchasthoserunningoverUDP,mayencodeex-plicitsessionidentiﬁersinsidemessagesorhaveotherim-plicitsessionidentiﬁcationmechanisms.Tosupportsuchprotocols,weallowaprogrammertodeﬁneasessionidenti-ﬁcationhandler,whichparsesamessage(perhapspartially)andreturnsthesessionidentiﬁerthatthemessagebelongsto.SuchhandlerscanbeusedinbothTCPandUDPproto-cols.Onceasessionhasbeenselected,parsingoccursaccord-ingtoastatemachine.Themachinespeciﬁeswhatkindofmessagesmaybereceivedfromwhichendoftheconnec-tioninagivenstate.Onceamessageisreceivedandfullyparsed,GAPAcallsahandler,writtenintheinterpretedlan-guage,todeterminethenextstate.Thehandlersareneces-sarybecausethestatetransitionmaydependonthecontentofamessage.Handlersarealsousedforprotocolanalysis,asdescribedbelow.TheHTTPstatemachine,showninFigure1,isconcep-tuallysimple,alternatelyexpectingarequestmessagefromtheclientoraresponsefromtheserver.Theresponsehan-dlerinthiscasewilleithergotoaﬁnalstateorstartwait-ingforanotherrequestbasedonavariablesavingthevalueoftheHTTPConnectionheader.Otherprotocolsmayhavemorecomplicatedstatemachines,withmessagespo-tentiallyarrivingfrombothsides.2.3VisitorsToperformanalysis,handlerswillneedtorefertoﬁeldsofamessageaccordingtotherecursivegrammar.Insim-plecases,dotnotationsuchasa.b.ccouldbeuseful.How-ever,thedotnotationbecomescumbersomeincaseswithdeeprecursionoralternation,whichoccurinbothbinaryandtext-basedprotocols.Forexample,RPCmayhaveupto11differentalternationswitheachalternation4levelsdeep.Inthecaseofalternation,onemustexplicitlycheckwhichcasewaschoseninthecurrentmessageinordertoavoidreferringtoﬁeldsthatarenotpresent.Toaddressthedifﬁcultyofdotnotation,weallowtheprogrammertowritegrammarvisitors[25]insidehandlers.Avisitorisablockofcodethatisexecutedeachtimearuleisvisited.Thesyntaxforavisitoris:@−>{......}Thesyntaxassignsthenon-terminal(oritsalternation)acodeblocktoruneverytimeafterthenon-terminal(orthealternation)isparsed.Thesecodeblocksworksimilarlytotheblocksinsertedintothegrammar,however,wewanttoenableacleansep-arationbetweentheparsinglogicandthespeciﬁcprotocolanalysistaskssothatthesameparsinglogiccanbere-usedfordifferenttasks.Essentially,thevisitorsinahandlerrep-resentthehandler’scustomizationofmessageparsingforthepurposeofaprotocolanalysistask.Consequently,visi-torsarealwaysexecutedbeforetherestofthehandlercode.Asanexample,inourHTTPspeciﬁcationinFig-ure1,handlerHRequestcontainsavisitorstatementthat“visits”non-terminalGeneralHeader,countsthenumberofheaders,andprintsallheadernames.Ev-erytimeGeneralHeaderistraversedduringparsing,headerCountisincremented,andtheheadernameisprinted.Whentheentiremessageisparsed,thetotalnum-berofheadersisprinted.2.4LayeringProtocolscanbelayeredontopofotherprotocols,withaGAPALSpecateachlayerperformingprotocolanalysisandsendingdatauptothenextlayer.ASpeccanindi-catealowerlayerSpecwithausesstatement,ordirectlybindtothetransportlayerwithatransportstatement.ThelowerlayerSpecsusethesendcalltopassdatatoupperlayers,whereitappearsasanincomingdatapacket.Eachlayerhasitsownsessionidentiﬁers,grammar,statemachine,andhandlers.Wealsouseourlayeringmechanismasageneralwayofcomposingdataprocessinglogic,verymuchinthesamespiritastheUnixpipe.Inparticular,weuselayeringtoim-plementapplication-levelprotocolfragmentationanddata-gramreordering.ThelowerlayerparsesoutthefragmentdataandusesaspecialversionofthesendcalltoindicatetoGAPAthefragmentsequencemetadataforthecurrentdatagram.GAPAthenperformsfragmentreassemblybe-forepassingthedatatotheupperlayer,whichparsesthereassembleddataintomeaningfulmessagecomponents.TheHTTPSpecinFigure1showsanexampleus-ageofsendforprotocollayering:theHTTPmessagebody,parsedintothebodypartvariableunderthenon-terminalsNormalBodyandChunk,is“sent”tothenextprotocollayer,say,RPC,forfurtherprocessing.Asanotherexample,weusedlayeringtoimplementthevulnerabilityﬁlterforCodeRed:theHTTPprotocolidentiﬁestheURLsintheHTTPrequestsandpipesthemontoaCodeRedURLparserwhichdetectsandblocksCodeRed.42.5SafetySafetyisaprimarygoalfortheGAPAlanguage.Firstandforemost,wewanttoensurethatGAPAanalyzersdonotsufferfromcrashesorbufferoverrunsduetomemoryerrors.Toavoidthis,theGAPAinterpretedlanguageisstrictlytyped,withboundschecksonarrayaccessesandnodynamicmemoryallocation.Thelackofdynamicmemoryallocationisalsohelpfultopreventunboundedmemoryus-age.Thisplacesarestrictiononprogrammerstoimplementcertainkindsoflogic,butinourexperience,wehavenotfoundthistobeaninconvenience.Wealsomakesurethatstoringthepartially-parsedmes-sagedoesnotresultinunboundedmemoryusage.TheGAPAengineisdesignedtofreememoryforthosemes-sageﬁeldsthatwillnolongerbereferenced,andtoapplycomputationtomessageﬁeldsasearlyaspossiblethroughincrementalexecution(seeSection3.1).Thisallowsustoparsevariable-sizedmessagecomponentssuchasarraysinastreamingfashion:theprogrammerwritescodetoberunoneachelementusingthevisitorsyntaxoraforeachloop,andthiscodegetsexecutedaseacharrayelementisbeingparsed,afterwhichthememoryforthatelementisre-leased.Theprogrammercanretainsomeoftheinformationfromthevariable-sizedarraysbystoringitinastaticallyboundedbuffer.Forothertypesofmessagecomponents,suchastokensspeciﬁedbyregularexpressions,weenforceastaticboundontheirlength.ToavoidexcessiveCPUconsumption,weallowonlyasingleloopingconstructwithinGAPAL—theaforemen-tionedforeachstatement.Theforeachstatementiter-atesoverallitemsinsideasafearray.Itislimitedtofor-wardtraversal[36].Thepurposeofourforeachloopistoallowparsingofiterativestructuresinmessagesortoperformaconstantnumberofiterationsofcertaintasks.Itispossibletonestforeachstatementsforparsingnested,iterativestructuresinmessages,butnestingforeachonthesamearrayisdisallowedasthisisincompatiblewiththestreamingmodel.InourexperienceusingGAPAL,weﬁndthislimitediterationissufﬁcient.Theforeachdesignal-lowstheCPUcostperbyteofnetworktrafﬁctobestaticallybounded.3TheAnalysisEngineTheanalysisengineistheGAPALruntime.Itparsesmessagesusingarecursivedescentparser.Theanalysisen-gineﬁrstﬁndstheappropriateGAPALSpecforthecurrentpackettobeanalyzed.Theenginethenfollowsthegram-marthatspeciﬁesthemessageformattogenerateaparsetree.Sincetheenginemayreceivepacketscontainingin-completemessages,itperformsparsingincrementally,sav-ingparsingstatebetweenpackets.Duringparsing,theen-gineexecutescodefragments,boththoseembeddedinthemessagegrammarandthoseresultingfromthevisitorpat-terninthehandlers(Section2.3).Thehandlersuseboththeparsetreeandanyothersessionstateupdatedbythecodefragmentstocarryouttask-speciﬁclogicandtoupdatethecurrentprotocolstate.Whenevertheanalysisenginefailstoparseamessage,italertstheapplicationcontainingGAPA,whichcanthenreactappropriately.Forexample,aﬁrewallwouldlikelydropthemessage,whileanetworkmonitorsuchasEtherealcoulddisplayanuninterpretedbytestream.Intheremainderofthesection,wefocusonourtech-niquestolimitthestateinordertoresiststate-holdingat-tacksandtoachieveﬁdelityintheengine’sinterpretationofthecurrentcommunicationstateofanapplication.3.1LimitingStateTopreventstate-holding,westructureouranalysisen-ginetoperformﬁlteringdecisionsasquicklyaspossiblewiththeuseofincrementalexecution.Afterreceivingeachpacket,theappropriatehandlerisexecuted,eveniftheapplication-levelmessageisincomplete.Thehandlerisrununtilitreferencesamessageﬁeldthatisnotyetﬁlledwithavalue.Atthatpoint,itsexecutionissuspendedandacontin-uationissaved,toberesumedwhenthenextpacketarrives.Ifthenextpacketcontainsthereferencedﬁeld,thehandlerexecutioncontinues,otherwise,itissuspendedonceagain.Ifthehandlercompletes,therestofthemessageisparsedwithoutsavinganystate.Thisapproachallowsthehandlerstomakeﬁlteringde-cisionsonincompletemessages.If,forexample,ﬁlteringisbasedonthecontentofacertainﬁeld,ahandlerperform-ingsuchacheckwillbeexecutedassoonasthatﬁeldisfullyparsed.Wethereforepasspacketscontainingincom-pletemessagestotheapplicationassoonastheincrementalexecutionofallthehandlersiscomplete.OnesubtleissueraisedbyincrementalexecutionintheﬁrewallscenarioisthatapartialﬁeldthatispassedtotheapplicationduringincrementalexecutioncouldtriggeranapplicationvulnerabilitysuchasabufferoverruntobeexploitedbeforethefullﬁeldisparsedandexaminedbyGAPA.Toaddressthisissue,GAPAusesastream-basedratherthanbuffer-basedimplementationforbuilt-infunc-tions(e.g.,lengthfunctionsorregularexpressions)formes-sageﬁeldswhosesizesareunpredictable,suchasabytesequenceﬁeldthatendswithsometerminatorsymbol.Inthefollowingexample,if(strlen(field)>1024)...strlenisstream-based:thecomparisoncompletesassoonastheengineparsesapacketthatcausesfieldto5havemorethan1024characterseveniffieldhasmorebytestocome.Theprogrammingsemanticsexposedbyincrementalex-ecutiontoGAPALhandlersisthatamessageﬁeldispassedtotheapplicationafteritisparsedandthehandlerhasbeengivenanopportunitytoprocessit.Thisworkswellwhenaprogrammerprocessesmessageﬁeldsintheorderoftheirarrival,whichistypicallythecase.However,whenahan-dlerimplementationprocessesmultiplemessageﬁeldsinadifferentorderfromtheirparsingorder,thiscanleadtounintendedbehavior:ahandlermaybesuspendedasitiswaitingforalaterﬁeldwhiletheearlierpotentiallymali-ciousﬁeldispasseduptotheapplication.Wemakethedesigndecisiontoplaceresponsibilityofavoidingsuchun-intendedbehavioronGAPALprogrammersbecauseother-wise,theenginewouldneedtobufferpacketsuntilallthemessageﬁeldshavearrived,resultinginunboundedstateaccumulation.Tohelpprogrammersfollowourprogram-mingsemantics,weapplystaticanalysistoidentifysuchoccurrencesinGAPALprograms.Inthefuture,weplantoinvestigatethepossibilityofautomaticallyreorderingcodewhentherearenocontrol-ordata-ﬂowdependenciesbe-tweenstatements.Withthissemanticsoftheincrementalexecution,onlyonepartialﬁeld(ortoken)issavedacrosspackets;andtheothercompletedﬁeldsthatarecarriedbythecurrentpacketarereleasedimmediatelyafterthehandlerexecutionforthepacket.Toboundthesavedstateofthepartialﬁeld,wechosetomirrorthebehavioroftheapplications,whichusu-allyinvolvesimposinganartiﬁciallimitonthesizeofsuchtokens(e.g.,Apachehasaconﬁgurablemaximumheadertokensize[52]).Weallowtheprogrammertospecifythemaximumlengthofanytoken,aswellasaglobalmaxi-mumforalltokensinthemessage,andstopparsingtheincompletetokenoncethislengthisexceeded.Incrementalexecutionappliesnaturallytosessiondis-patchingaswell.Whenamessageisreceived,weincre-mentallyexecutethesessionidentiﬁerlogic,followedbytheappropriatehandlerofthedispatchedsession.Thetran-sitionbetweenthedispatcherandthehandlerhappensau-tomaticallyatthepointwhenenoughofthesessioninfor-mationhasbeenparsedtodecidewhichsession’shandlertorun.Whenmultiplelayeredspecsareused,weincrementallyexecutethehandlersateachlayerbeforepassingapacketontotheapplication,sinceeachlayermaydecidetoﬁlterthecurrentmessageorsession.Weavoiddatabeingbufferedatalowerlayerbothtoreducethememoryfootprintandtoensurethatﬁlteringdecisionsattheupperlayerscanhappenasearlyaspossible.Tosupportthis,weincrementallyex-ecutethesendoperationonincompleteﬁeldsbysendingthepartialﬁelduptotheupperlayeraftereachpacket.Anattackercanalsoperformastate-holdingattackbyABCTimeoutTimeout(T)Receive XSend YReceive XErrorSendErrorABCTimeoutTimeout(T-Δ)Receive XSend YReceive XErrorSendErrorMaybeTimeoutTimeoutOrBSend YSend ErrorReceive XTimeout(2Δ)Figure2.ApplicationstatemachineandGAPA-maintainedstatemachinecreatingmanyconcurrentsessionsandcausingouranalysisenginetomaintainsessionstateforeach.Themonitoredap-plicationcanitselfbeattackedthiswayevenwhenGAPAisabsent.Ourgoalistomaketheengineatleastasscal-ableastheapplication.Theper-sessionstatemaintainedbytheengineforparsingshouldbesubstantiallylessthantheper-sessionstateintheapplication.Todealwithanattackusingmanyconcurrentsessions,wemirrortheapplicationbehavior.Forexample,ifanapplicationexplicitlyclosesoutdatedsessions,GAPAobservesthesocketcloseeventsandfollowssuitbydiscardingallthecorrespondingsessionstate.Theapplicationmayalsouseatimertoexpireunusedsessionswithnoexternally-visibleaction;inthiscase,weusethetimersupportinGAPA,describedbelow,tocopytheapplicationbehavior.3.2AchievingFidelityGAPA’sinterpretationoftheapplicationcommunicationstatemuststaysynchronizedwiththatoftheapplicationprocess.Inthemajorityofcases,applicationstatechangesareeithercausedbyorfollowedbyanetworkmessage,andthereforeitiseasytomaintainﬁdelityintheGAPAstate.However,incasesoftimeoutstheremaybeastatetransi-tionwithoutanynetworkmessages,posingachallengeforGAPA.Inthissection,wediscusshowweachievebetterﬁdelityfortimeoutevents.Protocolstatemachinesoftenhavetimeouteventsforre-triesorforsessionstatecleanup,incaseofremotehostorconnectivityfailures.Ifthetimeoutintheapplicationtrig-gersanetworkevent,suchasaretrymessageoraclosed6socket,GAPAcanmonitorforsucheventsandavoidmain-tainingthetimingitself.However,fornetwork-silenttime-outs,GAPAhasnochoicebuttomaintainatimer.Main-tainingtiminginGAPAistrickybecausethetimersinGAPAmaynotbepreciselysynchronizedwiththoseusedbytheapplication.Suchinconsistenciescanleadtoincor-rectanalysis.Ourimplementationofnetwork-silenttime-outsisincomplete,butweincludeourdesignhere.AhandlerinGAPAcansetatimeoutusingthetimeout(time)built-infunction.Ifnostatetransitionoc-curswhenthespeciﬁedtimehaselapsed,atimeouthan-dleriscalled.TocopewithtiminginconsistenciesbetweenGAPAandtheapplication,weapplybifurcatinganalysisasusedinBro[45];inaddition,weassumethatonedirectionofthetrafﬁccomesfromatrustedsource.Insteadoftran-sitioningtoaTimeoutstate,GAPAcantakeatransitiontoaMaybeTimeoutstateearlyenoughtoaccountfortimingerrortolerances(speciﬁedbytheprogrammer).Fromthispoint,allmessagesfromonedirectionareprocessedalonganambiguouspath,untilamessagefromtheotherdirectionresolvestheambiguity.Suchbifurcatinganalysiscanbein-corporatedintotheprotocolstatemachineautomatically.Forexample,ifanincomingmessagewouldcauseatran-sitiontostateBfromanon-timedoutstate,weuseittotran-sitionfromMaybeTimeouttoTimeoutOrB.IfGAPAisusedtoﬁltermalicioustrafﬁc,thistransitionmustcheckformes-sagesthatarepotentiallydangerouseitheronthetimedoutorthenormalpathintheapplication.TheresponsefromtheapplicationwillletGAPAresolvetheambiguityandtransi-tiontothecorrectstate.IfnotrafﬁcisreceivedintheMaybeTimeoutstate,GAPAcantransitiontotheTimeoutstateafterwaitinglongenoughtomakesurethattheapplicationtimeouthascertainlyex-pired,accountingforsynchronizationerrors.SinceGAPAisrunonthesamehostastheapplication,weexpectthesetimingtolerancescanbequitesmall,butwehavenotyetperformedexperimentstostudythisinmoredetail.Fig-ure3.2showsthestatemachinesmaintainedintheapplica-tionandtheanalysisengineforthisexample.4Evaluation4.1GAPASafetyWeevaluatethesafetyofGAPAusingthemetricoftrustedcodebasesize.Thoughcrude,thismetrichasbeenappliedinthepasttoguideresearchinsecuringothercriti-calsystems,suchastheJavaVirtualMachine[3].Asmallertrustedcodebaseiseasiertoanalyzeandislesslikelytocontainsecurity-criticalbugs.TheGAPAtrustedcodebaseincludestheGAPAengine,writteninC++,butexcludesprotocolspeciﬁcationswritteninGAPAL.Thereasonforthisisthatwhilebugsintheen-ginecanpotentiallycauseapplicationcompromise,bugsinGAPALSpecswill,atworst,causeincorrectprotocolanal-ysis.Wecontrastthiswiththetraditionalprotocolanalysisap-proachusedintoolssuchasthewidely-usedEthereal[50]suiteofprotocolanalyzers.InEthereal,boththeengineandprotocolanalyzersarewritteninC,andbugsineithercancauseapplicationcompromise.Therefore,weneedtoclas-sifybothcomponentsaspartofthetrustedcodebase.AdirectcomparisonofEtherealandGAPAisinap-propriate,sinceEtherealincludesmanymorecomponents,suchasaUIandsupportfornumerousﬁlecomponents.Wethereforeeliminateallenginecomponentsandfocusonlyontheprotocolanalyzers.Luckily,theEtherealcodebaseusesnamingconventionstodistinguishbetweenbroadclassesoffunctionality:muchoftheprotocol-analysisspe-ciﬁccodeisinaspeciﬁcsub-directory,epan/dissectors.Lookingatonlythecodeinthatsub-directory,wecount779thousandlinesofcodethatareusedforprotocolanaly-sis.ThisnumberdwarfsthesizeoftheGAPAtrustedcodebasebyoveranorderofmagnitude:theGAPAengineisonly24thousandlinesofcode.Therefore,securingEthe-realwillbeamuchmoredifﬁculttaskthansecuringGAPA.Thisisnotjustatheoreticalconcern,either;asearchfor“etherealdissector”reveals69vulnerabilitiesrecordedintheCommonVulnerabilitiesandExposuresdatabase[16].Furthermore,thisproblemislikelytoonlygetworse,asnewprotocolsareaddedtotheEtherealdissectorcollection.Incontrast,addingnewSpecstoGAPAdoesnotaffectitssecurity,andalthoughourcurrentGAPAimplementationcouldhavesomesecuritydefects,thesigniﬁcantlysmallertrustedcodebasepresentsamuchmoreappealingtargetforstandardsecuritybestpractices,suchascodereviews,penetrationtesting,fuzztesting,andstaticanalysis.RewritingtheEtherealprotocolanalyzersinageneral-purposememory-safelanguage,suchasJava,wouldelimi-natemany,butnotall,oftheabovevulnerabilities.Inpar-ticular,aboutaquarterofthedissectorvulnerabilitiesresultindenialofservicethroughexcessivememoryorCPUcon-sumption;thesevulnerabilitieswouldstillexist.Thishigh-lightstheimportanceoftheresourcelimitationsimposedbyGAPALthatmakeitimpossibletointroducesuchvulnera-bilitiesinprotocolanalyzerSpecs.4.2GAPALanguageEase-of-UseThegoalofourGAPAlanguageevaluationistoshowthatthelanguageiscompleteenoughtoexpressmanyim-portantprotocolsandvulnerabilitiesintheseprotocols,thattheamountofeffortrequiredforthespeciﬁcationisrea-sonable,andthatthelanguagefeaturesarehelpfulinthistask.Tothisend,wehavespeciﬁedanumberofproto-7cols:HTTP[21],RPC[47](overbothTCPandUDP),DNS[37],SIP[26],BitTorrent[10],DHCP[18],SSH[55]andTLS[17].Thisrepresentsadiversecollection,includ-ingtextandbinaryprotocols,bothstream-anddatagram-oriented.Inallcases,wespeciﬁedtheprotocolinatleasttheamountofdetailasiscontainedinthedescriptionofthemessageformatintheRFC.Wealsoimplementedvulner-abilitysignaturesontopoftheHTTP,RPC-over-TCP,andDNSspeciﬁcations.ForHTTP,weimplementedsignaturesforboththeHostHeader[29]andtheCodeRed[15]vul-nerabilities.ForRPC,weimplementedasignaturefortheMSBlast[38]vulnerability.ForDNS,weimplementedasignatureforaDoSvulnerabilitycommontomultipleDNSimplementationsresultingfrompointersintheDNSrecordformingaloop[40],whichwerefertoasthepointer-cyclevulnerability.Filteringforthepointer-cyclevulnerabilityrequiredparsingthevaluesofthepointersandfollowingthemuntilacycleisfound.ThisisanexampleofaGAPALﬁlterthatcouldnothavebeenimplementedusingregularexpressions,evenwhenthepointervaluesareexposedbyaDNSprotocolanalyzer,asisthemodelinnumerousIDSs,e.g.,Snort[51].Inallcases,wefoundthespeciﬁcationprocesstobestraightforward,aswecanstartwithanRFCusingBNF,copy-and-paste,andthenannotateitwithadditionalpars-ingandprotocollogic.Wewereabletoconstructaninitialspeciﬁcationformostprotocolswithinafewhours.Noneofthe9protocolspeciﬁcationsrequiredmorethan300semi-colons(theGAPALend-of-statementmarker).OurexperiencewithGAPAListhatthelanguagefea-turesofembeddedcodeblocks,visitors,andlayeringwerequitehelpful.Embeddedcodeblockswereessentialinev-eryprotocolwherethelengthofalaterﬁeldisspeciﬁedbyanearlierﬁeld(e.g.,BitTorrent,HTTP,andRPC).Weusedthevisitorsyntaxinallourvulnerabilitysignaturestoavoidmodifyingtheprotocolspeciﬁcationitself.Fi-nally,thelayeringfeaturemadecompositionoflogiceasy.Forexample,theHTTPprotocolidentiﬁestheURLsintheHTTPrequests,parsesandprocessesescapesintheURLencoding,andpassesthemontoaURLparserusingthelayeringmechanism.TheURLparseronlyrequires25linesofGAPAcodetoﬁlterforCodeRed.WeveriﬁedthattheﬁlterdetectsarealCodeRedinfectionpacketandpro-ducesnofalsepositivesona500MBtracefromahighvol-umecommercialwebsite.Additionally,thesignaturenatu-rallyhandlesCodeRedIIandevenpolymorphicvariantsofCodeRed,becauseitoccursaftertheURLhasbeenparsedandescapesremoved.OurexperiencewithGAPAListhatitisasigniﬁcantim-provementovertheShieldlanguage.TheShieldlanguagewasmostlysuitableforbinaryprotocolssuchasRPC[47],nottext-basedprotocolssuchasHTTP[21].Shield’sap-proachwastotreattextmessageslikebinaryones,usingaC-likestruct,buttoallowunitsof“offset”and“size”tobedeﬁnedaswords(madeofcharacters),inadditiontobytes.Thisrequiresmanuallyconvertingtherecursionsandalter-nationsinBNFrulesoftext-basedprotocolstotheserigidstructs,whichisoftenverydifﬁcult.GAPAL’suseofBNFeliminatesthisdifﬁculty.TheShieldlanguagealsofailedtocleanlyseparatepro-tocolanalysisfromvulnerabilityﬁltering.TheGAPAde-signallowsmaintainingacompleteandwell-testedprotocolspeciﬁcation.Whenanewvulnerabilityisdiscovered,thevisitorsyntaxmakesaddingacorrespondingﬁlteraseasyasaddingafewvulnerability-speciﬁcchecks.Thevisitorsyntaxalsomakesmergingvulnerabilityﬁlterstrivial(justrunallthevisitors),anditavoidsShield’srequirementthatthespeciﬁcationindicateﬁeldsthatdonotrequireparsingusingthe“SKIP”keyword(theGAPALcompilerinsteadcanusethevisitorstoderivetheunneededﬁelds).4.3GAPAPerformanceWeevaluatedtheperformanceofGAPAusingtracescollectedintwodifferentproductionnetworks.TheWebServertracecontains500megabytesoftrafﬁcfromalinkconnectingtoahigh-volumecommercialwebsite.TheEdgeRoutertracecontains1gigabyteoftrafﬁcfromalinkconnectingasubnetcontaininghundredsofPCstotherestofalargecorporateintranet.Wechosethreeprotocolanalyzersforourevaluation,HTTP,RPC,andDNS.HTTPisprimarilyatext-basedpro-tocol,whileRPCisprimarilyabinaryprotocol.DNSisofparticularinterestbecauseitcontainsbothvariable-lengthﬁeldsandpointers.Wemanuallyveriﬁedeachanalyzer’scorrectnessonsmalltraces.Theprimarymetricweuseintheevaluationisthrough-putforthespeciﬁcprotocol’strafﬁcafterextractingitfromourtrace.Wechosethismetrictoavoidallowingtheexactfractionofthevariousprotocolsinourtracestoinﬂuenceourresults.WeconductedthemeasurementsonaPCwitha3GHzXeonmicroprocessorand2GBofRAM.Averagesandstandarddeviationsweretakenover10runs.TheCPUwassaturatedinallcases.Allmeasurementsweretakenonal-readyreconstructedTCPstreams,tofocusonthethrough-putofourGAPAprototype,whichintegratesintoanend-hostabovethetransportlayer.Alargersystemincorpo-ratingGAPA,suchasawebserverprotectedbyaGAPA-drivenﬁrewallontopofahostTCPstack,wouldnaturallyhavesomelowertotalthroughputreﬂectingtheadditionalworkperformedbythewebserver.InFigure3weshowthethroughputofeachprotocolanalyzerwithandwithoutvulnerabilitysignaturesontheEdgeRoutertrace.(Weuseaboxplot[14]toshowthevariabilitybetweenseveralmeasurements;theboxcontains8●HTTPHTTP +HostHdrHTTP +CodeRedRPCRPC +BlasterDNSDNS +PointerCycle020406080100Throughput on Edge Router TraceThroughput (Mbps)Figure3.EdgeRouterTrace●HTTPHTTP +HostHdrHTTP +CodeRed0510152025Throughput on Web Server TraceThroughput (Mbps)Figure4.WebServerTracethemiddle50%ofthedataandthelinerepresentstheme-dian.)Wefoundthattheperformanceofourimplementa-tionofourHTTPanalyzerwaswithinafactorof3ofpub-lishednumbersoncommercialHTTPprotocolanalyzersinﬁrewallproducts[24].TheadditionofeithertheCodeRedortheHostHeadervulnerabilityﬁlterscausedonlyminordropsintotalthroughput.ThethroughputforRPCwassig-niﬁcantlygreaterthanfortheHTTPanalyzer.Thethrough-putfortheDNSanalyzerwasquitelow,andtheadditionofthepointercyclevulnerabilityﬁltercausedittodecreaseevenfurther.Theorder-of-magnitudedifferenceinparsingratebetweenHTTPandDNSisconsistentwiththeﬁndingsofotherresearchonprotocolanalyzers[43];DNSismorecomplicatedtoparseforprotocolanalyzerswritteninCaswell.InFigure4weshowthethroughputoftheHTTPpro-tocolanalyzerwithandwithoutvulnerabilitysignaturesontheWebServertrace.Theadditionofvulnerabilitysig-naturescausedminordegradationsinthroughput,asbefore.ThroughputisapproximatelyhalfwhatitwasontheEdgeR-outertrace.ThedramaticvariationinbpsthroughputforthedifferentHTTPEdgeHTTPWebRPCDNS0500010000150002000025000Throughput in Tokens per SecondFigure5.Comparisonofthroughputusingto-kenspersecondprotocolanalyzers,andforthesameprotocolanalyzerondifferenttraces,canbeexplainedbythecomplexityoftheanalysisbeingperformed.InFigure5,weshowthenumberoftokensgeneratedeachsecondbythevariousprotocolan-alyzers.Thethroughputintokenspersecondismuchcloseracrossprotocolanalyzersthanitisinbps.Thissuggeststhatthecurrentdominantperformancecostsinourdesignareallper-tokencosts.WeﬁrstanalyzethedifferenceinthroughputoftheHTTPanalyzeronthetwodifferenttraces.AlthoughthethroughputinbpsishigherontheEdgeRoutertrace,theanalyzerisparsingmoretokenspersecondintheWebServertrace.Manualinspectionrevealedthattheav-eragepacketlengthintheWebServertraceisonly446bytes,approximatelyhalfthatoftheEdgeRoutertrace.BecausetheHTTPanalyzertreatsthebodyoftheHTTPre-questasanopaquearrayofbytes,thebodyismuchfastertoparsethantheheaders.IntheWebServertrace,thebod-iesweremuchshorter,leadingtolessthroughputunderthebpsmetric.AsimilareffectexplainsthehigherthroughputinbpsfortheRPCanalyzerwhencomparedtotheHTTPanalyzer:theRPCbodiesarelongerthantheHTTPbodies,leadingtoahigherthroughputinbps.TheDNSanalyzer’sparsingrateintokenspersecondiscomparabletotheparsingrateofHTTP.Thedifferenceintokenspersecondseemslargelyduetotheneedforaddi-tionalcodeblocksfordeterminingthemeaningofparsedﬁelds.Inparticular,distinguishingbetweenrecordnamesandrecordpointers,andswitchingappropriately,requiredexaminingindividualbytesusingtheinterpretedlanguagemuchmoreoftenthanwasthecaseforHTTPheaders.Thisexplainsthedifferencebetweenthetokenspersecondratesforthetwoanalyzers.ThemuchlargerdifferenceinbpsisexplainedsimplybythefactthatDNShasnolarge“body”againstwhichtheparsingcostscanbeamortized.InFigure6,weanalyzethecurrentcostsofthevarious9Overhead of GAPA Subsystems0%10%20%30%40%50%60%70%80%90%100%HTTP-WebHTTP-EdgeRPCDNSProtocolFraction Of TotalOther (e.g., memoryallocation)RegExSharedNamespaceInterpreterGrammarFigure6.GAPAperformancebreakdowncomponentsoftheGAPAengine.Thelabel“Grammar”referstoBNF-directedparsing.“Interpreter”referstotimeexecutinghandlersandembeddedcodeblocks.“Shared-Namespace”referstotimespentreadingandwritingthegrammarvariablesbythehandlersandembeddedcodeblocks.“RegEx”referstotimespentintheregularexpres-sionmatchinglibrary.“Other”referstomemoryallocation,copying,andinitializationcosts.Inthetwolowerthroughputcases(HTTP-WebandDNS),weﬁndthatasigniﬁcantfractionoftimeisgoingtotheBNF-directedparsingandtotheinterpreter.Inthetwohigherthroughputcases(HTTP-EdgeandRPC),weﬁndthatmostoftheCPUtimeisgoingtomemoryalloca-tion,copying,andinitializationcosts.TheCPUcostofin-terpreterinitializationalreadyincorporatestheoptimizationofsharinginterpretedcodeacrosssessions,sotheremain-ingcostissimplyallocatingandinitializingdata.Althoughpreviousworkoninterpreters[46]hasfoundthattheyof-tenimposeslowdownsrangingfromafactorof10tooverafactorof100,thecombinedcostofthegrammarinterpreterandtheC-subsetinterpreteristhedominantproblemonlyforthelowerthroughputcases(HTTP-WebandDNS).Forthehigherthroughputcases(HTTP-EdgeandRPC),thema-jorbottleneckistheclassicproblemofmemoryallocationsandcopies.Inallcases,regularexpressionmatchingwasasmallfractionofoverallCPUoverhead.Ourestimationisthatalloftheareasexceptregularexpressionmatchingareopentosigniﬁcantadditionaloptimization.Compila-tiontechniquesseemlikeaparticularlypromisingapproachtoperformanceimprovement.5RelatedWork5.1LanguagesandFrameworksforPro-tocolDesign,VeriﬁcationandImple-mentationManylanguagesandframeworkshavebeendevelopedforprotocoldesign,veriﬁcationandimplementation.Pro-tocolanalysisonlyaimstodecodecommunicationsessionsofalready-implementedanddeployedprotocols,andsocanforgofunctionalityrequiredintheseotherdomains,e.g.,dy-namicallyallocatingnewportsorgeneratingresponsepack-ets.Inthissubsection,weexplainhowGAPAisbettersuitedtothetaskofprotocolanalysis.Languagesbasedonformalmethods[4],suchasEs-telle[12],Promela++[6],LOTOS[53],andSDL[48]wereoriginallytargetedatprotocolspeciﬁcation,emphasizingvalidationandveriﬁcationofprotocollogicthroughtheuseofﬁnitestatemachines.StateCharts[27]andEsterel[8]areformalmethod-basedlanguagesthataremoresuitableforimplementation.RTAG[2](real-timeasynchronousgram-mars)isalsosuchalanguage,thoughitusesacontext-freegrammartodeﬁnetheprotocolbehavior.GAPAL’suseofﬁnitestatemachineswithcode-directedtransitionshascloseparallelsinsomeoftheselanguages,e.g.,Esterel’suseofcodetodecidethenextstate.However,theselan-guagesdonotprovidebuilt-inabstractionsforspecifyingprotocolmessageformats.Forexample,inboththeEsterel-based[13]andRTAG-based[2]TCPimplementations,theTCPprotocolstatemachineisspeciﬁedinEsterel/RTAG,butpacketaccessandmanipulationhavetobecodedinC.GAPALprovidesBNFwithembeddedcodeblocksformessageformatspeciﬁcation.ComparedtoC-baseddatamanipulation,GAPALprovidesmemorysafetyandDoSre-silience,e.g.,GAPALdoesnotallowgeneral-purposeloopsordynamicmemoryallocation.Kohleretal[34]proposedProlac,astatically-typed,object-orientedlanguagefornetworkprotocolimplementa-tion,withthegoalofimprovingreadability,implementabil-ity,andextensibility.Prolaccanbeusedtoimplementanynetworkprotocols,whileGAPALismorespecial-purposewithexplicit,built-insupportforabstractionsneededforprotocolanalysis(messageparsing,protocolstatemachine,visitors,layering,sessiondispatching).Likeotherprotocolimplementationlanguages,Prolacsupportsarbitraryrecur-sion,whileGAPALdoesnot.Thex-Kernelframeworkprovidesprotocol,session,andmessageobjectsalongwithasetofsupportroutinesforbuffermanagement,identiﬁermapping,andtimers.Throughthisuniforminterfaceamongprotocols,x-Kernelaimstoimprovethestructureandperformanceofproto-collayering.InaccordancewithGAPA’sfocusonproto-colanalysisratherthanimplementation,GAPAprovidesverydifferentoperationsonprotocols,sessionsandmes-sage.Forexample,GAPAsupportsmessageparsingusingBNFwithembeddedcode,whilex-Kernelsupportsmes-sageparsingbyprovidinglibraryfunctionsthatefﬁcientlyaddorremoveheadersasamessagemovesdownoruptheprotocolstack;GAPAusestheabstractionofaproto-colstatemachinetotrackprotocolstate,whilex-Kernelusestheprotocolobjecttoorganizefunctionality(e.g.,the10IPlayercodeisintheIPprotocolobject).Furthermore,GAPAL’stypesafetyandDoSresilienceareabsentintheC-basedx-Kernel.Protocolconformancetestingtoolsalsosharesomesim-ilaritieswithGAPA,astheyalsomustparseprotocolmes-sagesandverifycertainproperties.However,testingsce-nariosdifferfromthecontextofﬁrewallsorintrusionde-tectionsystems,asthereisnoneedtoworryaboutadver-sarialtrafﬁctryingtocompromiseorDoSthetestingtool.Indeed,testingtoolsdonotevenneedtooperateonline:Bishopetal[9]performdetailedconformancecheckingonTCPtracesat500bps.Thedifferentemphasisindomainalsomanifestsitselfinthelanguagedesign:Bishopetalchoosealanguageofferinglogicoperations,suchasquanti-ﬁers,whileGAPALincludesBNFwithembeddedcodeandotherfeaturestofacilitateprotocolanalysis.5.2IDS/FirewallLanguagesSnortandHogWash[51]useregularexpressionsasrulesformatchingmaliciousnetworkinput.Toobtainmorepro-tocolcontextforsuchmatching,theysupportprotocolana-lyzerswritteninCasplug-ins.AsdiscussedinSection1,usingCincursbothahighdevelopmentcostandahighse-curityrisk.TheBro[45]languageisdesignedtospecifynetworkmonitoringandintrusiondetectionpoliciesbasedonknownattackbehaviors,suchasportscanning.TheBrolanguagedoesnotsupportimplementingprotocolanalysis,buttheBrosystemallowsincorporatingprotocolanalyzerswritteninC.TheBinpac[43]languagehassimilargoalstoGAPALandnaturallysharesmanyofitsfeatures(theBinpacauthorsreferenceourearlydesigndocument[11]intheirwork).Binpacisintendedtoperformmessageparsingonly,pro-vidinganinterfaceforanalyzerswritteninalanguagesuchasC++,whereGAPALencompassesbothparsingandreac-tion.BinpacisalsocompiledtoC++andusesC++forpartsofitsparsinglogic.Forourpurposes,C++posesanunac-ceptablesafetyriskandweuseourinterpretedlanguageforthispurposeinstead.5.3DataDescriptionLanguagesGAPALismorethanadatadescriptionlanguage;italsoincludesprotocolanalysis-speciﬁcfeaturessuchasthepro-tocolstatemachine,layering,andvisitors.Inthissection,wecomparethemessageformatpartoftheGAPALdesigntopreviouswork.ASN.1[19],NDR[47],andUSC[42]targetdescrib-ingbinarydatastructures.Datascript[5]andPacket-Types[35]specifybinarydataandenhancethespeciﬁca-tionwithpredicate-directedparsing.Wefoundthattext-basedprotocolmessagescanbemoreeasilyexpressedus-ingBNFwithembeddedcodeblocks;amoredetaileddis-cussioncanbefoundinourease-of-useevaluationinSec-tion4.2.ParsergeneratorssuchasYacc[33],ANTLR[44]andJavaCUP[30]useBNFandembeddedcodeforpars-ing;GAPAadditionallyprovidessupportforprotocolanal-ysisspeciﬁcabstractionsandatype-safeDoS-resilientlan-guagefortheembeddedcodeblocks.Asomewhatorthog-onalpieceofworkisErlang’sbitsyntax[41],anErlanglanguageextensionthatsupportsbinarypatternmatching.Recently,PADS[22]wasproposedasadomain-speciﬁclanguageforspecifyingbothtextandbinarydata.Theirgoalisrapidparsergenerationformanykindsofadhocdatasuchasweblogs,ﬁnancerecords,ﬁrewallrules,etc..Despitesomedifferencesinlanguageappearance,PADSissimilartothemessageformatspeciﬁcationpartofGAPAL:GAPAL’suseofBNFwithembeddedcodeblockismir-roredbyPADS’suseof“switchedPUnion”andcode-directedparsing.BothGAPALandPADStargettextandbinarydata,andbotharrivedatasimilarparsingdesign.5.4PacketFiltersandOtherSystemsPacketﬁlters[36,20,7,32]areprogrammablecriteriaforclassifyingorselectingpacketsfromapacketstreambasedonheadersforprotocollayer4orbelow.Becauseofpacketﬁlters’emphasisonspeed,theyexposeonlysimplerulesforpacketclassiﬁcation,suchaspredicatesonbytevaluesatﬁxedoffsets.Thismakestheminappropriateforprotocolanalysisabovethetransportlayer,whichrequiresparsingmulti-packetmessagesandkeepingtrackofproto-colstate.SPINE[23]andFLAME[1]aresystemsdesignedtoal-lowuntrustedcodetoprocessnetworkmessagesintheker-nel.Theymaintainisolationfromarbitrarymemoryaccesswithinthekernelbyusingtype-safelanguages(Modula-3andCyclone,respectively),andtheyguardagainstun-boundedCPUconsumptionbyusingtimeouts.GAPAL’sprotocol-analysisspeciﬁcabstractionsandtheanalysisen-gine’sbuilt-insupportforastreamprocessingmodelareab-sentfromSPINEandFLAME.Also,SPINEandFLAME’stimeoutapproachtoDoS-resiliencewasinappropriateforourtargetscenarioofaﬁrewall;timeoutsmayleadtofalsepositives.Proof-CarryingCode[39]isatechniqueforconveyingprogrampropertiesliketypesafetyorboundedexecutiontime.IfGAPAwerecompiledtomachinecode,insteadofbeinginterpreted,ProofCarryingCodewouldbeapromis-ingtechniqueforavoidingatrustedcompiler.116ConcludingRemarksProtocolanalysisisimportantinnumerousapplications,suchasintrusiondetection,ﬁrewalling,andnetworkmoni-toring.Wehavepresentedthedesign,implementation,andevaluationofagenericapplication-levelprotocolanalyzer,GAPA,anditslanguage.GAPAistheﬁrstsystemthatal-lowsrapiddevelopmentofprotocolanalyzerswhileprovid-ingmemorysafetyandDoSresilience.Toachievetheseproperties,GAPALusestechniquessuchasBNFwithem-beddedcodeblocks,visitorsforseparatingparsing-speciﬁcandtask-speciﬁclogic,incrementalexecution,andlayering.OurevaluationindicatesthatGAPALissafe,expressiveandeasytouseandourGAPAsystemprototypecanhandleanenterpriseclientHTTPworkloadatupto60Mbps,sufﬁ-cientperformanceformanyend-hostﬁrewall/IDSscenar-ios.7AcknowledgmentsAndrewBegel,JohnDouceur,JonHowell,andDawnSonggaveusinvaluablecritiquesonthedraftsofourpa-per.OurworkalsobeneﬁtedfromdiscussionswithRonnieChaiken,JonPincus,DanSimon,ZhendongSu,andZheYang.GeoffNordlandkindlyprovidedussomeofthenet-worktracesusedinourevaluationuponourshort-noticedrequests.Theanonymousrefereesofferedmanyhelpfulsuggestions.Wearethankfultoeveryone’shelp.References[1]K.Anagnostakis,M.Greenwald,S.Ioannidis,andS.Miltchev.OpenpacketmonitoringonFLAME:Safety,performanceandapplications.In4thInternationalWorkingConferenceonActiveNetworks,2002.[2]D.Anderson.AutomatedprotocolimplementationwithRTAG.IEEETransactionsinsoftwareengineering,14(3),March1988.[3]A.AppelandD.C.Wang.JVMTCB:MeasurementsofthetrustedcomputingbaseofJavavirtualmachines.TechnicalReportCSTR-647-02,PrincetonUniversity,Apr.2002.[4]F.BabichandL.Deotto.Formalmethodsforspeciﬁcationandanalysisofcommunicationprotocols.IEEECommuni-cationsSurveysandTutorials,December2002.[5]G.Back.DataScript—Aspeciﬁcationandscriptinglanguageforbinarydata.InProceedingsofGenerativeProgrammingandComponentEngineering,volume2487.LNCS,2002.[6]A.Basu,M.Hayden,G.Morrisett,andT.vonEicken.Alanguage-basedapproachtoprotocolconstruction.InPro-ceedingsoftheACMSIGPLANworkshopondomainspe-ciﬁclanguages,1997.[7]A.Begel,S.McCanne,andS.Graham.Bpf+:Exploitingglobaldata-ﬂowoptimizationsinageneralizedpacketﬁl-terarchitecture.ComputerCommunicationReview,29(4),1999.[8]G.Berry.TheEsterelPrimer.[9]S.Bishop,M.Fairbairn,M.Norrish,P.Sewell,M.Smith,andK.Wansbrough.Rigorousspeciﬁcationandconfor-mancetestingtechniquesfornetworkprotocols,asappliedtoTCP,UDP,andsockets.InProceedingsofACMSIG-COMM,2006.[10]BitTorrentprotocolspeciﬁcation.http://www.bittorrent.org/protocol.html/.[11]N.Borisov,D.Brumley,H.Wang,J.Dunagan,P.Joshi,andC.Guo.Genericapplication-levelprotocolanalyzeranditslanguage.TechnicalReportMSR-TR-2005-133,MicrosoftResearch,Feb.2005.[12]S.BudkowskiandP.Dembinski.AnintroductiontoEstelle:Aspeciﬁcationlanguagefordistributedsystems.ComputerNetworksandISDNSystems,1991.[13]C.Castelluccia,W.Dabbous,andS.O’Malley.Generat-ingefﬁcientprotocolcodefromanabstractspeciﬁcation.InProceedingsoftheACMSIGCOMM,1996.[14]J.Chambers,W.Cleveland,B.Kleiner,andP.Tukey.GraphicalMethodsforDataAnalysis.Wadsworth&Brook-s/Cole,1983.[15]MicrosoftSecurityBulletinMS01-033,November2003.http://www.microsoft.com/technet/treeview/default.asp?url=/technet/security/bulletin/MS01-033.asp.[16]M.corporation.Commonvulnerabilitiesandexposuresdatabase(CVE).www.cve.mitre.org.[17]T.DierksandC.Allen.RFC2246:TheTLSprotocolver-sion1.0,January1999.http://www.ietf.org/rfc/rfc2246.txt.[18]R.Droms.Rfc2131-dynamichostconﬁgurationprotocol,March1997.http://www.faqs.org/rfcs/rfc2131.html.[19]O.Dubuisson.ASN.1-CommunicationBetweenHeteroge-neousSystems.MorganKaufmannPublishers,2000.[20]D.EnglerandM.Kaashoek.DPF:Fast,ﬂexiblemessagedemultiplexingusingdynamiccodegeneration.InProceed-ingsofACMSIGCOMM,1996.[21]R.Fielding,J.Gettys,J.Mogul,H.Frystyk,L.Masinter,P.Leach,andT.Berners-Lee.RFC2616:HypertextTrans-ferProtocol–HTTP/1.1,June1999.[22]K.FisherandR.Gruber.PADS:Adomain-speciﬁclanguageforprocessingadhocdata.InProceedingsofPLDI,June2005.[23]M.Fiuczynski,R.Martin,B.Bershad,andD.Culler.SPINE:Anoperatingsystemforintelligentnetworkadapters.TechnicalReportTR-98-08-01,UniversityofWashington,1998.[24]M.Fratto.Application-levelﬁrewalls:Smallernet,tighterﬁlter,March2003.http://www.nwc.com/1405/1405f32.html.[25]E.Gamma,R.Helm,R.Johnson,andJ.Vlissides.DesignPatterns.Addison-WesleyProfessional,1995.[26]M.Handley,H.Schulzrinne,E.Schooler,andJ.Rosenberg.RFC2543:SIP:Sessioninitiationprotocol,March1999.[27]D.Harel.Statecharts:Avisualformalismforcomplexsys-tems.ScienceofComputerProgramming,pages231–274,1987.[28]Hogwash.http://sourceforge.net/projects/hogwash/.[29]MalformedHOSTheadercausesIISDoS,October2002.http://www.securiteam.com/windowsntfocus/6C00C1F5QA.html.12[30]S.Hudson.CUP:LALRparsergeneratorforJava.http://www2.cs.tum.edu/projects/cup/.[31]V.Jacobson,C.Leres,andS.McCanne.Tcpdump.www.tcpdump.org.[32]M.JayaramandR.Cytron.Efﬁcientdemultiplexingofnet-workpacketsbyautomaticparsing.InProceedingsoftheWorkshoponCompilerSupportforSystemsSoftware,1996.[33]S.Johnson.Yacc—YetAnotherCompiler-Compiler,1979.UNIXProgrammer’sManual.[34]E.Kohler,M.Kaashoek,andD.Montgomery.AreadableTCPintheProlacprotocollanguage.InProceedingsofACMSIGCOMM,1999.[35]P.J.McCannandS.Chandra.PacketTypes:Abstractspec-iﬁcationofnetworkprotocolmessages.InProceedingsofACMSIGCOMM,2000.[36]S.McCanneandV.Jacobson.TheBSDpacketﬁlter:Anewarchitectureforuser-levelpacketcapture.InUSENIXSymposium,1992.[37]P.Mockapetris.RFC1035—Domainnames—implementationandspeciﬁcation,November1987.http://www.faqs.org/rfcs/rfc1035.html.[38]MicrosoftSecurityBulletinMS03-026,September2003.http://www.microsoft.com/technet/treeview/default.asp?url=/technet/security/bulletin/MS03-026.asp.[39]G.Necula.Proof-carryingcode.InProceedingsofthe24thACMSIGPLAN-SIGACTSymposiumonPrinciplesofPro-grammingLangauges(POPL’97),pages106–119,Paris,Jan.1997.[40]NISCCVulnerabilityAdvisoryDNS-589088,May2005.http://www.niscc.gov.uk/niscc/docs/al-20050524-00433.html.[41]P.Nyblom.Thebitsyntax—thereleasedversion.InSixthInternationalErlang/OTPUserConference,October2000.[42]S.W.O’Malley,T.A.Proebsting,andA.B.Montz.USC:Auniversalstubcompiler.InProceedingsofACMSIGCOMM,1994.[43]R.Pang,V.Paxson,R.Sommer,andL.Peterson.binpac:Ayaccforwritingapplicationprotocolparsers.InACMInternetMeasurementConference,Oct.2006.[44]T.ParrandR.Quong.ANTLR:Apredicated-LL(k)parsergenerator.Software:PracticeandExperience,25(7):789–810,1995.[45]V.Paxson.Bro:Asystemfordetectingnetworkintrudersinreal-time.ComputerNetworks,Dec1999.[46]T.H.Romer,D.Lee,G.Voelker,A.Wolman,W.Wong,J.-L.Baer,B.Bershad,andH.Levy.Thestructureandper-formanceofinterpreters.InProceedingsofthe7thInter-nationalConferenceonArchitecturalSupportforProgram-mingLanguagesandOperatingSystem(ASPLOS),volume31:9,pages150–159,NewYork,NY,1996.ACMPress.[47]DCE1.1:RemoteProcedureCall.http://www.opengroup.org/onlinepubs/9629399/.[48]http://www.sdl-forum.org/Publications/index.htm.[49]C.ShannonandD.Moore.ThespreadoftheWittyworm.http://www.caida.org/analysis/security/witty,2004.[50]R.Sharpe,E.Warnicke,andU.Lamping.Ethereal.www.ethereal.com.[51]TheOpenSourceNetworkIntrusionDetectionSystem.http://www.snort.org/.[52]Apachecorefeatures.http://httpd.apache.org/docs/1.3/mod/core.html.[53]P.H.J.vanEijk,C.A.Vissers,andM.D.(Editors).TheformaldescriptiontechniqueLOTOS.[54]H.Wang,C.Guo,D.Simon,andA.Zugenmaier.Shield:Vulnerability-drivennetworkﬁltersforpreventingknownvulnerabilityexploits.InProceedingsofACMSIGCOMM,2004.[55]T.YlonenandC.Lonvick.InternetDraft-SSHTransportLayerProtocol,March2005.13