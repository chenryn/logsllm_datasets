    09c908d4 49              dec     ecx
    09c908d5 49              dec     ecx
    09c908d6 49              dec     ecx
    09c908d7 49              dec     ecx
    09c908d8 eb1c            jmp     09c908f6
    09c908f6 e8e2ffffff         call    09c908dd
    09c908dd 58              pop     eax
    09c908de e9c8000000      jmp    
    09c909ab
    09c909ab e833ffffff         call    09c908e3
表2 ShellCode代码片段
前面很长的一段“dec
ecx”作为空指令，覆盖更多的地址来提高漏洞利用的适应能力。该shellcode的主要功能为释放~$Norm~1.dat和Normal.domx两个文件，~$Norm~1.dat是恶意文件的载体，Normal.domx是一个VBE文件，并通过修改注册表来设置多个版本Office的禁止项目，其目标版本为Office
10.0至Office 16.0。
Normal.domx执行后会释放诱饵文档，释放并运行MicroS~1.exe、jli.dll、msvcr71.dll，这三个文件正是攻击者远程控制程序的投放端植入程序。
### **5.2.2 水坑攻击使用的漏洞**
我们在对攻击者所使用的各种资源跟踪过程中，发现攻击者搭建了一套挂马漏洞集成攻击平台。该平台文件最后修改时间为2016年4月，但未配套挂载欲植入的后门程序，故判断该攻击平台处于预备状态。
平台集成的攻击漏洞有针对IE、FireFox浏览器的，也有针对SWF、PDF浏览器插件，已知CVE漏洞如表3所示。
表3 已知CVE漏洞
另外，攻击者还赫然将针对AOL 9.5的漏洞利用代码输出函数命名定义为“IE_0Day”，说明该组织对美国在线的用户群也非常感兴趣。
表4 IE_0Day漏洞
漏洞利用执行的Shellcode是通过进程的PEB结构来查找自己需要的Dll，继而能够在Dll中查找自己需要的函数。
    seg000:00000000                xor     eax, eax
    seg000:00000002                mov     eax, fs:[eax+30h] ; PEB
    seg000:00000006                js      short loc_14
    seg000:00000008                mov     eax, [eax+0Ch]  ; DllList
    seg000:0000000B                mov     esi, [eax+1Ch]  ; DllList[7]
    seg000:0000000E                lodsd
    seg000:0000000F                mov     ebx, [eax+8]    ; DllList[2] kernel32.dll
    seg000:00000012                jmp     short loc_1D
    seg000:00000014 ;
表5 ShellCode代码片段
通过一系列的函数调用完成对新脚本的加载，从而进行后续的恶意行为。
## 5.3 后门分析
### **5.3.1 功能分析**
“丰收行动”的攻击者使用了三套远程控制工具，这三套工具均以文件和数据窃取为主要目的，其中一款的具体功能主要包括：
    与远程C&C服务器通信接收控制命令，具备文件遍历、文件上传下载、命令无回显执行、屏幕截图等功能；
    设置自身为随系统启动，收集用户名、计算机名、样本版本信息，并加密上传；
    全盘搜索各类文档（主要包括：“pdf、doc、docx、ppt、pptx、txt”），并在形成索引文件后加密上传；
    能够对U盘的使用进行监控，对U盘上各类文档进行截获；
其中以“MicroS~1.exe、jli.dll、msvcr71.dll”三个文件为投放端植入程序的后门已经在友商的分析报告[[8]]有过相应的描述，我们不再赘述。
从HTTP通信协议请求的相似性分析，另外一款远程控制工具应是该套后门的高级版本，且对关联到的组件样本进行分析后发现其还具备非驱动型的文件隐藏功能。
#### **5.3.1.1 反沙箱检测技术**
样本分析时发现，样本调用了QueryPerformanceFrequency和QueryPerformanceCounter两个系统函数来计算系统运行时长，以此来区分真实系统和虚拟系统，从而实现绕过虚拟机的检测，可见其使用了典型的反沙箱检测技术。
图15 绕过虚拟检测
#### **5.3.1.2 非驱动型的高级隐藏技术**
在对投放端样本进行关联时，找到其疑似组件。该组件样本先通过SetWindowsHook挂载到所有进程中，然后inline
Hook应用层ntdll!ZWQueryDiectoryFile函数，该函数是系统用于查询遍历文件目录的函数。图16为jmp跳转到的Hook函数，先平衡堆栈，然后调用原ZWQueryDiectoryFile函数来获取系统真实返回数据，最后再对返回的结果数据进行相应的处理。
图16 Hook跳转后的执行代码
后续对数据的处理，Hook函数会对原函数的返回结果进行过滤，查询是否包含其指定的文件名称，如果存在则从返回结果里面移除该文件名相关信息。
这样当“我的电脑”对应的explorer.exe进程在查询某目录（例如开始菜单启动项）时，就无法查看到指定的文件，达到不加载驱动也能对文件进行隐藏的目的，避免防御软件对驱动加载这一高危行为的拦截和防御。
### **5.3.2 基于PowerShell的恶意代码**
攻击者使用PowerShell脚本配合程序实现Agent代理端，利用Web服务器统一接受各Agent在杀毒软件测试虚拟机搜集的数据。免杀辅助系统Agent代理端具备系统信息搜集、截屏录屏、键盘记录、数据回传等功能，涉及的组件包括：
表6 组件说明
**5.4 C &C分析**
从我们直接获取到的样本来看，“丰收行动”的三个C&C服务器一共可对应出8个域名地址，均为免费的二级动态域名，没有办法直接从注册域名信息进行详细分析。
从一些关联到的数据来看，攻击者有攻击其他正常服务器来放置临时数据，以期在漏洞利用植入阶段提供远程下载恶意模块的行为习惯。
**6.TTPs分析**
TTPs（Tactics,
Techniques and Procedures），是指攻击者用到的战术、技术和步骤[[9]]。我们把“丰收行动”涉及到的一些相关信息汇总如下：
表7 “丰收行动”总览
本次行动涉及到TTPs，我们希望能通过图17来进行简要说明：
图17 一张图展示丰收行动
1．确定目标，并搜集个人信息。“丰收行动”针对的目标主要是巴基斯坦、中国等国家的科研院所、军事院校、外交官员为主，攻击者通过搜索引擎、Facebook等社交网络，获取受害者的电子邮箱地址和个人信息，在后续攻陷受害人，还会从受害人的文档里搜集电子邮箱和个人信息。
2．搭建C&C服务器。攻击者分阶段搭建了三个C&C服务器，该过程可能与步骤1同步进行。跟踪发现，该组织的C&C服务器之间有相互的关联，比如德国的C&C服务器的远程控制工具是从摩洛哥C&C服务器下载部署。同时，这些C&C服务器的建设都采用了标准化流程操作，进行了系统加固、支持库安装、控制模块、监控模块部署等，说明对此已经非常熟练。
3．木马免杀。针对目标使用的系统和杀毒软件，搭建环境进行木马免杀工作。在本次跟踪过程中我们发现，攻击者利用了Powershell+VMware搭建半自动化免杀平台来提高效率，足见其成员非新手。跟踪到的数据显示，其中一次免杀工作是在2016年5月2日和3日进行的。此外，攻击者还制作了多个浏览器挂马漏洞库（参考漏洞利用），最后修改时间为2016年4月18日，搭配三套远程控制工具使用。
4．投放诱饵。攻击者将已免杀的木马捆入带有利用程序的RTF文档中，伪装成Word文档，通过电子邮件附件方式发送给受害人，诱使其点击。用户点击后会弹出一个真实的Word文档，迷惑受害者。此外，推测攻击者也会采取发送浏览器挂马网页，发动水坑攻击。
5．加密回传数据。受害者计算机感染木马后，木马会搜索敏感的电子文档、记录键盘操作等，并加密打包为.enc后缀发回到C&C服务器。加解密工具非通用zip等压缩工具，而是攻击者自己编写的私有工具。
6．长期控制。本次行动中攻击者会长期控制受害者计算机，监控其浏览的网页、读取的邮件、新生成的文档，同时根据需要装载新的模块。通过对远程控制工具分析，其包含文件管理、关键词搜索、摄像头监控、键盘记录、U盘监控等功能模块，以窃取文档为主。此外，攻击者会根据从受害者获取到的个人信息和其他联系人电子邮件，做进一步的扩大攻击。
**7.结语**
与友商用大量样本统计来分析APT方式不同，2046Lab针对“丰收行动”的分析虽也利用了样本分析手法，但更多是利用跟踪溯源的方式。这种跟踪溯源和分析过程，给了我们一种逐渐拨开迷雾见彩虹的感觉。从一个样本到一个C&C服务器，再到另一个样本，到另一个C&C服务器，每跟踪溯源一次，我们对攻击者的了解就加深一些，包括攻击者的目标对象、使用工具、C&C服务器据点、惯用手法，最后云开雾散，发现攻击者的具体IP，定位到其在南亚某国的幕后大本营。这一过程不免让我们感叹，东巽科技倡导的“人与人”的对抗确实是APT防护对抗的本质所在。
本次“丰收行动”，再一次证明了APT攻击的存在和长期活跃，而导致攻击成功的主要因素是：防守在明、攻击在暗，受害者的防御措施与攻击者攻击手段存在能力差距，尤其是未知威胁的检测和预警能力。
本次的揭露只是全球APT攻击事件的冰山一角,中国也是APT攻击的受害者之一。我们预测和以往同行的报告一样，攻击者并不会因为本次的揭露而销声匿迹，至多是偃旗息鼓一段时间，然后以更隐蔽的方式卷土重来，并用上新的免杀技术、新的漏洞或者新的攻击方式。所以，本报告希望能给用户，尤其是可能遭受APT攻击的重要机构一些提醒和建议，落实习总书记4.19讲话精神，树立正确的网络安全观，充分认识自己的防御措施和攻击技术之间的差距，加快构建安全保障体系，提前部署防御措施，尤其是未知威胁的检测和识别方面的能力建设，增强网络安全防御能力和威慑能力，防患于未然。
**8.本文参考资料：**
[[1]] https://en.wikipedia.org/wiki/DarkComet
[[2]] The Dropping Elephant，https://securelist.com/blog/research/75328/the-dropping-elephant-actor/
[[3]] DarkHotel，https://securelist.com/files/2014/11/darkhotel_kl_07.11.pdf
[[4]] sitar，https://en.wikipedia.org/wiki/Sitar
[[5]] avatar，https://en.wikipedia.org/wiki/Avatar
[[6]]
利用邮件实施APT攻击，http://mp.weixin.qq.com/s?src=3&timestamp=1470618506&ver=1&signature=iL9QskvxpmXKHy7hy*xFENSwn-2xRDA1-DruyOtDkd4Fe3kCfU5olgBs3RgSaH2mn6KoxyKY78LXeZeJWu3mXXBe2H8PiEE2SbugOtv4jzW4F*Z7W56qwPoPJzCdfUHhtswfNhc96UcyBK9rKJdlvxt13iXpPbGKV6KWeYv0szU=
[[7]] 水坑攻击，http://baike.baidu.com/link?url=b_-FXNCFcKDWuph7v-ViUhyQSt0WmqT_EtVNqQkiWRn8NMEtd2Zh6TIsLTQkWrhILjeKeKgRa95isIb-6DVnhF7DeKcQ6bA2-7itMpwkjwM1wzjxCMOU2AWQXbtrCVEx
[[8]]
360追日团队APT报告：摩诃草组织（APT-C-09），http://bobao.360.cn/learning/detail/2935.html
[[9]] TTPs,
https://en.wikipedia.org/wiki/Terrorist_Tactics,_Techniques,_and_Procedures