Controlling the Source: 
Abusing Source Code 
Management Systems
Brett Hawkins (@h4wkst3r)
Adversary Simulation, IBM X-Force Red
Agenda
2
IBM Security / © 2022 IBM Corporation
•
Introduction
•
Source Code Management Systems
•
GitHub Enterprise
•
GitLab Enterprise
•
Bitbucket
•
SCMKit
•
Demos
•
Defensive Considerations
•
Conclusion
Introduction
IBM Security / © 2022 IBM Corporation
3
Who am I?
4
IBM Security / © 2022 IBM Corporation
•
Current Role – Adversary Simulation, IBM X-Force Red
•
Previous Roles - Mandiant, J.P. Morgan Chase, J.M. Smucker Company
•
Conference Speaker – DerbyCon, Wild West Hackin’ Fest, BSides, Hackers Teaching 
Hackers
•
Open-Source Tool Author – SharPersist, DueDLLigence, InvisibilityCloak, SCMKit
How did this research come about?
5
IBM Security / © 2022 IBM Corporation
•
Real-world experience attacking source code management systems
•
Recent Security Breaches
•
Software Supply Chain Attacks - SolarWinds, Kaseya, Codecov
•
Source Code Theft - LAPSUS$
–
Microsoft - Azure DevOps
–
T-Mobile - Bitbucket
–
Samsung - GitHub Enterprise
–
Globant - GitHub Enterprise
Research Goals
6
IBM Security / © 2022 IBM Corporation
•
Bring more attention to securing Source Code Management systems
•
Inspire future research on defending Source Code Management systems
Attendee Takeaways
7
IBM Security / © 2022 IBM Corporation
•
Learn about different attack scenarios against Source Code Management systems
•
Learn how to defend Source Code Management systems
•
Learn how to abuse Source Code Management systems via privileged and non-privileged 
context
My Perspective
8
IBM Security / © 2022 IBM Corporation
I AM:
•
Current - Red Team Operator
•
Previous - Blue Teamer
I AM NOT:
•
DevOps Engineer
•
Software Developer
•
System Administrator
Source Code Management Systems
IBM Security / © 2022 IBM Corporation
9
10
IBM Security / © 2022 IBM Corporation
• Manages source code repositories
• Allows multiple developers to work on code at same time
• Supports integrations into other systems within DevOps pipeline
What is a Source Code Management System?
11
IBM Security / © 2022 IBM Corporation
• GitHub Enterprise
• GitLab Enterprise
• Bitbucket
Popular Systems
12
IBM Security / © 2022 IBM Corporation
• SCM systems used
during “Build” phase
DevOps Pipeline
Image: https://medium.com/aws-cyber-range/secdevops-101-strengthen-the-basics-20f57197aa1c
13
IBM Security / © 2022 IBM Corporation
• Attacker injects itself into development process to deploy malicious code
• Research focuses on scenarios “B” and “C” below
Software Supply Chain Attacks
Image: https://opensource.googleblog.com/2021/10/protect-your-open-source-project-from-supply-chain-attacks.html
14
IBM Security / © 2022 IBM Corporation
SCM Systems
• Initial access point
• Pivot to CI/CD Platform
• Pivot to Distribution Platform
Lateral Movement to other DevOps Systems
Image: https://opensource.googleblog.com/2021/10/protect-your-open-source-project-from-supply-chain-attacks.html
GitHub Enterprise
IBM Security / © 2022 IBM Corporation
15
Access Model
16
IBM Security / © 2022 IBM Corporation
Enterprise Roles
•
Owners, Members
Organization Roles
• Organization Owners, Organization Members, Security Managers, GitHub App Managers, Outside Collaborators
Repository Roles
• Read, Triage, Write, Maintain, Admin
Access Token Scopes
• Repository, Organization, SSH Keys, Gists, Users, GPG Keys, Site Admin
17
IBM Security / © 2022 IBM Corporation
• REST API
• Interact with:
• Repositories
• SSH Keys
• Users
• Admin functionality
• And much more…
API Capabilities
18
IBM Security / © 2022 IBM Corporation
Attack Scenarios
Attack Scenario
Sub-Scenario
Admin Required?
Reconnaissance
-Repository
-File
-Code
No
Repository Takeover
N/A
Yes
User Impersonation
-Impersonate User Login
-Impersonation Token
Yes
Promoting User to Site Admin N/A
Yes
Maintain Persistent Access
-Personal Access Token
-Impersonation Token
-SSH Key
No
Yes
No
Management Console Access
N/A
Yes
19
IBM Security / © 2022 IBM Corporation
•
Interact with web interface or REST API
• Repository, File, Code
Reconnaissance
20
IBM Security / © 2022 IBM Corporation
HAProxy Log
• /var/log/haproxy.log
Search Criteria
• ('/search' OR '/api/v3/search') AND 'http'
Reconnaissance Logging
21
IBM Security / © 2022 IBM Corporation
• Site admin can unlock any repository for modify access
Repository Takeover
22
IBM Security / © 2022 IBM Corporation
Audit Log
• /var/log/github-audit.log
Search Criteria
• action:repo.staff_unlock
Repository Takeover Logging
23
IBM Security / © 2022 IBM Corporation
• Impersonate User Login
• Impersonation Token
User Impersonation
24
IBM Security / © 2022 IBM Corporation
Audit Log
• /var/log/github-audit.log
Search Criteria
• action:staff.fake_login
• action:oauth_access.create
• action:oauth_authorization.create
User Impersonation Logging
25
IBM Security / © 2022 IBM Corporation
• Using site admin privileges, add any user to site admin
Promoting User to Site Admin
26
IBM Security / © 2022 IBM Corporation
Audit Log
• /var/log/github-audit.log
Search Criteria
• action:user.promote
• action:business.add_admin
Promoting User to Site Admin Logging
27
IBM Security / © 2022 IBM Corporation
• Personal Access Token
• Impersonation Token
• SSH Key
Maintain Persistent Access
28
IBM Security / © 2022 IBM Corporation
Audit Log
• /var/log/github-audit.log
Search Criteria
• action:oauth_access.create
• action:oauth_authorization.create
• action:public_key.create
• action:public_key.verify
Maintain Persistent Access Logging
29
IBM Security / © 2022 IBM Corporation
• Single shared password
• Configure enterprise instance
• Example: Adding SSH key
Management Console Access
30
IBM Security / © 2022 IBM Corporation
• Multiple commands available in management console SSH access
• Example: ghe-config -l
Management Console Access
31
IBM Security / © 2022 IBM Corporation
Management Log
• /var/log/enterprise-manage/unicorn.log
Management Console Access Logging
GitLab Enterprise
IBM Security / © 2022 IBM Corporation
32
33
IBM Security / © 2022 IBM Corporation
User Project Permissions
• Guest, Reporter, Developer, Maintainer, Owner
Access Token Scopes
• api, read_user, read_api, read_repository, write_repository, read_registry, 
write_registry, sudo
Access Model
34
IBM Security / © 2022 IBM Corporation
• REST API
• Interact with:
• Repositories
• SSH Keys
• Users
• Admin functionality
• And much more…
API Capabilities
Attack Scenarios
35
IBM Security / © 2022 IBM Corporation
Attack Scenario
Sub-Scenario
Admin Required?
Reconnaissance
-Repository
-File
-Code
No
User Impersonation
-Impersonate User Login
-Impersonation Token
Yes
Promoting User to Admin Role N/A
Yes
Maintain Persistent Access
-Personal Access Token
-Impersonation Token
-SSH Key
No
Yes
No
Modifying CI/CD Pipeline
N/A
Yes – Project Level
SSH Access
N/A
Yes
36
IBM Security / © 2022 IBM Corporation
• Interact with web interface or REST API
• Repository, File, Code
Reconnaissance
Reconnaissance Logging
37
IBM Security / © 2022 IBM Corporation
Production Log
• /var/log/gitlab/gitlab-rails/production.log 
• /var/log/gitlab/gitlab-rails/production_json.log 
API Log
• /var/log/gitlab/gitlab-rails/api_json.log 
Access Log
• /var/log/gitlab/nginx/gitlab_access.log
Search Criteria
• 'get' AND '/search?search'
• 'get' AND '/search'
• 'get' AND ('/search'| OR 'repository/tree')
• 'search'
38
IBM Security / © 2022 IBM Corporation
• Impersonate User Login
• Impersonation Token
User Impersonation
39
IBM Security / © 2022 IBM Corporation
Production Log
• /var/log/gitlab/gitlab-rails/production_json.log 
• /var/log/gitlab/gitlab-rails/production.log 
API Log
• /var/gitlab/gitlab-rails/api_json.log
Search Criteria
• 'has started impersonating'
• 'impersonate'
• 'post' AND 'impersonation_tokens'
• 'impersonation_tokens'
User Impersonation Logging
40
IBM Security / © 2022 IBM Corporation
• Using admin privileges, add any user to admin
Promoting User to Admin Role
41
IBM Security / © 2022 IBM Corporation
Production Log
• /var/log/gitlab/gitlab-rails/production_json.log
• /var/log/gitlab/gitlab-rails/production.log
API Log
• /var/log/gitlab/gitlab-rails/api_json.log
Search Criteria
• 'patch' AND 'admin/users'
• 'put' AND '"key":"admin","value":"true"'
Promoting User to Admin Role Logging
42
IBM Security / © 2022 IBM Corporation
• Personal Access Token
• Impersonation Token
• SSH Key
Maintain Persistent Access
43
IBM Security / © 2022 IBM Corporation
Production Log
• /var/log/gitlab/gitlab-rails/production_json.log
• /var/log/gitlab/gitlab-rails/production.log
API Log
• /var/log/gitlab/gitlab-rails/api_json.log
Search Criteria
• 'post' AND 'personal_access_tokens'
• 'post' AND 'profile/keys'
• 'post' AND 'personal_access_tokens'
• 'post' AND 'user/keys'
Maintain Persistent Access Logging
44
IBM Security / © 2022 IBM Corporation
• Modify .gitlab-ci.yml file in repo
• This will trigger pipeline to run for that project
Modifying CI/CD Pipeline
45
IBM Security / © 2022 IBM Corporation
Production Log
• /var/log/gitlab/gitlab-rails/production_json.log
Search Criteria
• 'post' AND '/api/graphql' AND '.gitlab-ci.yml' AND 'update'
Modifying CI/CD Pipeline Logging
46
IBM Security / © 2022 IBM Corporation
GitLab Config file
• /etc/gitlab/gitlab.rb
GitLab Secrets file
• /etc/gitlab/gitlab-secrets.json
Postgresql Database -
SSH Access
Bitbucket
IBM Security / © 2022 IBM Corporation
47
Access Model
48
IBM Security / © 2022 IBM Corporation
4 permission levels
• Global, Project, Repository, Branch
Global Permissions
• Bitbucket User, Project Creator, Admin, System Admin
Project Permissions
• Project Admin, Write, Read
Repo Permissions
• Admin, Write, Read
Branch Permissions
• Prevent all changes, Prevent deletion, Prevent rewriting history, Prevent changes without a pull request
Access Token Scopes
• Repository read, Repository write, Repository admin, Project read, Project write, Project admin
49
IBM Security / © 2022 IBM Corporation
• REST API
• Interact with:
• Repositories
• SSH Keys
• Users
• Admin functionality
• And much more…
API Capabilities
Attack Scenarios
50
IBM Security / © 2022 IBM Corporation
Attack Scenario
Sub-Scenario
Admin Required?
Reconnaissance
-Repository
-File
-Code
No
Promoting User to Admin Role N/A
Yes
Maintain Persistent Access
-Personal Access Token
-SSH Key
No
Modifying CI/CD Pipeline
N/A
No
51
IBM Security / © 2022 IBM Corporation
• Interact with web interface or REST API
• Repository, File, Code
Reconnaissance
52