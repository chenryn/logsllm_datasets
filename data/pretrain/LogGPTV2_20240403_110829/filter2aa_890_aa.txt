"FIRST-TRY" DNS CACHE 
POISONING WITH IPV4 AND IPV6 
FRAGMENTATION
Or how to become the one in 
“one in 34 million”
WHERE WE’RE GOING
1. Intro
2. Background on DNS
3. Fragmentation Attacks
4. IPID Inference
5. The Attack (agnostic to IPv4 and IPv6)
6. Mitigations
© 2018  Cisco and/or its affiliates. All rights reserved.   Cisco Public
$ whoami
Travis (Travco) Palmer
§ Security Research Engineer for 
Cisco Systems
§ Offensive Security Certified 
Professional & Expert (OSCP & 
OSCE)
§ Not a DNS/DNSSEC expert
Brian Somers
§ Principal Engineer for Cisco Systems
§ FreeBSD & OpenBSD developer 
alumnus
YOU DID WHAT?
Found a way to poison the cache of DNS resolvers 
without man-in-the-middle more consistently
Modified an IPv4 attack on DNS over UDP, reduced it 
from hundreds of iterations to plausibly one
Extended the attack so that it bypasses all current 
recommendations
YES, WE DID DISCLOSE RESPONSIBLY
Our team discovered this attack during a focused 
“pentest” engagement
Our team disclosed to Cisco Umbrella
Umbrella has been disclosing this to other DNS operators 
(ongoing) before DEF CON.
1. Intro
2. Background on DNS
3. Fragmentation Attacks
4. IPID Inference
5. The Attack (agnostic to IPv4 and IPv6)
6. Mitigations
WHERE WE’RE GOING
If the timing on a particular 
DNS request can be predicted,
the reply only needs to be well 
structured and have a valid ID
In 2008 Dan Kaminsky demonstrated 16bits of entropy is not 
sufficient to prevent cache poisoning
And can be performed off-path (source ports are predictable)
QUICK AND DIRTY DNS PRIMER
D. Kaminsky. It’s The End Of The Cache As We Know It. In Black Hat 
conference, 2008. http://www.doxpara.com/DMK_BO2K8.ppt
IDEAL POISONING SCENARIO
TARGET
PUPPET
INTERNET
CACHE
ATTACKER
IDEAL POISONING SCENARIO
TARGET
INTERNET
Resolver is 
v.x.y.z !
CACHE
PUPPET
ATTACKER
IDEAL POISONING SCENARIO
TARGET
INTERNET
CACHE
PUPPET
ATTACKER
DNS ID = 
2003, 2004, 
2005, 2006, 
2007, 2008, 
2009, 2010, 
2011, etc…
IDEAL POISONING SCENARIO
TARGET
INTERNET
CACHE
Not Poisoned?
Try, try again 
(just make sure it 
isn’t cached)
PUPPET
ATTACKER
DNS ID = 
2003, 2004, 
2005, 2006, 
2007, 2008, 
2009, 2010, 
2011, etc…
IDEAL POISONING SCENARIO
TARGET
INTERNET
CACHE
PUPPET
ATTACKER
DNS ID = 
2003, 2004, 
2005, 2006, 
2007, 2008, 
2009, 2010, 
2011, etc…
IDEAL POISONING SCENARIO
TARGET
INTERNET
CACHE
PUPPET
ATTACKER
IDEAL POISONING SCENARIO
INTERNET
CACHE
TARGET
PUPPET
ATTACKER
IDEAL POISONING SCENARIO
INTERNET
CACHE
TARGET
PUPPET
ATTACKER
DNS source ports aren’t
predictable anymore.
To fake a DNS response 
off-path, a 16bit DNS identifier, 
and a UDP port number (16bit*) 
need to be guessed.
QUICK AND DIRTY DNS PRIMER
“.org” TLD
.defcon.org
A www.defcon.org 162.222.171.206
ICANN  “.”
Enter DNS Security Extensions (DNSSEC)
Cryptographic key-based signing of DNS zones by 
parent zones, and signing of records by zones.
QUICK AND DIRTY DNS PRIMER
Enter DNS Security Extensions (DNSSEC)
QUICK AND DIRTY DNS PRIMER
https://www.cloudflare.com/dns/dnssec/how-dnssec-works/
Data origin authentication - verify that the data it 
received actually came from the zone it should 
have come from.
Data integrity - data cannot be modified in transit 
since records are signed by the zone owner with the 
zone's private key.
DNSSEC adds (most importantly) :
QUICK AND DIRTY DNS PRIMER
QUICK AND DIRTY DNS PRIMER
https://www.icann.org/news/announcement-2019-02-22-en
QUICK AND DIRTY DNS PRIMER
https://www.internetsociety.org/resources/doc/2016/state-of-
dnssec-deployment-2016/
Sign Delegation NS and A
resource records (RRs) 
Sign Glue Records
DNSSEC doesn’t:
Origin of work:
“Fragmentation Considered Poisonous”, Amir Herzberg and Haya Shulman, Published 2012
.com
example.com
QUICK AND DIRTY DNS PRIMER
QUICK AND DIRTY DNS PRIMER
Sign Delegation NS and A
resource records (RRs) 
Sign Glue Records
DNSSEC doesn’t:
Origin of work:
“Fragmentation Considered Poisonous”, Amir Herzberg and Haya Shulman, Published 2012
.com
example.com
Signing comes at a cost, 
especially with NSEC3
Origin of work:
“Fragmentation Considered Poisonous”, Amir Herzberg and Haya Shulman, Published 2012
$ dig +dnssec @dns-
2.datamerica.com. 
gggg.defcon.org
QUICK AND DIRTY DNS PRIMER
Origin of work:
“Fragmentation Considered Poisonous”, Amir Herzberg and Haya Shulman, Published 2012
dig +dnssec @dns-2.datamerica.com. gggg.defcon.org; > DiG 9.11.2-P1-1-Debian > +dnssec @dns-2.datamerica.com. 
gggg.defcon.org; (2 servers found);; global options: +cmd;; Got answer:;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 49427;; flags: 
qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 6, ADDITIONAL: 1;; WARNING: recursion requested but not available;; OPT PSEUDOSECTION:; EDNS: 
version: 0, flags: do; udp: 4096; COOKIE: 7f011ea810942e94c127df285cfd54a55323c46351aa65c0 (good);; QUESTION 
SECTION:;gggg.defcon.org.
IN
A;; AUTHORITY SECTION:defcon.org.
86400
IN
SOA
dns-
1.datamerica.com. hostmaster.defcon.org. 2019042612 43200 600 2419200 86400defcon.org.
86400
IN
RRSIG
SOA 10 2 2419200 20190910161941 20190609151941 14006 defcon.org. 
HeG6b/gBOIsP4lMsC7/N7neFp/OQQV5VcKWycbnLe88wwT2wPTxx0Rsm mx9By1mGJv0TJhh/F4gFz7Vgh7lB1gPmGgkjfaHP42U3EyvdtyIYDIn6 
xfa2l9Ev4vNB3NrFwR9vzsnRbi0OZjBKEsK6gpB4caiEAyVpXkgp61NU QpW0NKojLAo7PECRmjpdKiu1VthY9wMUjz4b9phXQUBQtCxq7EhheuZf 
JXQixGyGTlxeel3DO0hWo465YyBhyM8cd4qh2xNRiGbLdkzrNx+QI7uG 41eyJqDlRZK8hUmacyCI7J4+2F6MTEUDsTfYzVJnq5IAJZG1n4ByUjPe 
fq/M4nZ3dmRMSV2HlSARYqaMcYuVsRRQUSG8mEP1sV2ByPIwXMRnxDnc 
QuxmS6p+ML7yQnc2azpWtQHoYer+F0bwylkrW+5Qtivn4otIngtsoM94 
az+Dqxrue6YeK6BgMgGkXz1S3Wa8ld1v/z7o7DQGAXt36a6xM4CEbyWX ER+20zmXE40DKXwR0mByixzrLp9o6c/NhdsG7fIy9bKGzOYcpkbv8mf4 
qvcd9gKXA7BlIvk4Cf+RlpGTB4arjhASXP0RuZVu8yAD+8MZGE4Ri6/o U6v96xW5Ave2ck3C5W/gkxhn6+J9mB2gMCEKyLsOV5OUIhVhaQbZqymD 
Krg5dZTnlok=defcon.org.
86400
IN
NSEC
_dmarc.defcon.org. A NS SOA MX TXT AAAA RRSIG NSEC DNSKEY CAA 
TYPE65534defcon.org.
86400
IN
RRSIG
NSEC 10 2 86400 20190909090129 20190608080148 14006 
defcon.org. Sk/QKHMfW9u/oVEBoqL9T+KUVs00UMkmij71zS0KNZ6QOFFbwvdnpStc 
KD0JfQ6u4mczLXC3PfgOPlH11/YGLf9IRJ0x2CHYMg6UpYMw06Ox3MNm 
h1Mm2IT3TqCMrMCAUjAwO5jhBB6aOmYRlwIr3yv8x8YW/gFS/C61BKp0 uKXYUdR8sYlEZ9b8BDvyxAWbRN8N5jr72KSR5xpBwzt2TygAD3y6F4fr 
qyj2bZuZ4KFh+toTPwbXlFb3OvF8qcOhz+IpgO3zVkFbtCIc3tbHCknI uRf53X6dQ5vhy6eYstai4IhSx7TTGD/Lq1NoEpxKx8VS0gQyw0OSb8tj 
tAt4/x9qt98MYr++OsbYCt1lehv2sq7HL93s5RTnDs0ENDd19do/LqU4 S6toMxnCoKksmh2g5z5zHuzhiPWsH+OzD4SC4v4ji7R7tdvMXRQ9L9hs 
kkBsQERCD+AbYQ7usXYecnmkobWapJJkd1+5w3wsNQyqi1uMAhJmz2mm 
Wz0dVTv844lB1CG3htcmYViWKWmRRL/mRPKb2cmEgTmKXG5ZONvjkOUa 9Z0pYJTzIPhRENq3Nel9gEhz3auuf697TFJr5x/Jux1hNtoHvko4gKaH 
0t1UYkANH25n6W/m6tHcWtMliuqu7YC97E6FBB6dzXRFB/TsAU5qFnz2 5R0gePsKvOw=forums.defcon.org.
86400
IN
NSEC
info.defcon.org. CNAME RRSIG NSECforums.defcon.org.
86400
IN
RRSIG
NSEC 10 3 86400 20190909232755 
20190608224446 14006 defcon.org. JfXq564r6ge6qiZDvlUPQJBL+ks0UbQ/QuwbDj4+sbYOGO2HAePYNIxX 
g1EjC80FRAXKrYBb735iNdKS3OLcaepEnSQyps3TcVZrJ92k6ZrFGr2p lxOoX93CpYHgipkmR2vBVhuYqjXjXG/P1sNYymIhU+nZfMv13t5KjsPy 
NmC1tNIGnFa9tSwiIzD26GtHnqFfV0i4tPDvIz3lLfMt4i8tUalKL3i/ LiPhKoQvVNC/vTMg8CWiJIcBRe/3H25lT1lQDnvGXb2otrdrTX8KVK19 
T5diMVES1KjOUosxXc9lcYRZ0esAOxCDqygtIkd0mRLot8ipln1FPIo3 GUWtMUFZd4Ht3mIK9OfZljRBsFfS6rLxAU+vBk0Li68c+CX1qyDKYCRU 
Qf0m6Zerj2zcg2pwhb/H7OeucUnJXHEdtrsBbZIJzlHQ/WyOadVqT0ry RWjALawT0CXIIPVURnDpEVhv89LtSexnu+ysBUZFsVy0aMcj7WSONNWE 
6bW7mcKWyAJ3M8/Nfao7WIJaJM76RmgBJ8mzJKnkQFs/WIkj4umQrlY1 HgZbunn0EyoBa0MozA9U/D/q4WvFnOAEZ3jTlYpOi1/cJaM+0RWB/YNZ 
Dkbnqp54wdfy4TFG21z0lSfpHzNzf8g/xOxeB1RQJ8cqaCb1HrDuY0VH Q4C7XGn+4dU=;; Query time: 85 msec;; SERVER: 
64.87.1.238#53(64.87.1.238);; WHEN: Sun Jun 09 14:49:09 EDT 2019;; MSG SIZE  rcvd: 1922
$ dig +dnssec @dns-
2.datamerica.com. 
gggg.defcon.org
…
MSG SIZE  rcvd: 1922
Signing comes at a cost, 
especially with NSEC3
QUICK AND DIRTY DNS PRIMER
WHERE WE’RE GOING
1. Intro
2. Background on DNS
3. Fragmentation Attacks
4. IPID Inference
5. The Attack (agnostic to IPv4 and IPv6)
6. Mitigations
WHY DNS FRAGMENTATION OVER 
THE O.G. KAMINSKY?
If a response becomes too big, it
needs to be fragmented at the IP layer.
The DNS identifier and UDP port
number are early in the IP payload.
For the second fragment, the only entropy is the IP 
identifier (IPID) in the header.
Origin of work:
“Fragmentation Considered Poisonous”, Amir Herzberg and Haya Shulman, Published 2012
The IP identifier (IPID) for IPv4 is 16bits
A significant portion of nameservers
were found to have a single global 
counter for IPID 
Origin of work:
“Fragmentation Considered Poisonous”, Amir Herzberg and Haya Shulman, Published 2012
WHY DNS FRAGMENTATION OVER 
THE O.G. KAMINSKY?
IDEAL POISONING SCENARIO
TARGET
INTERNET
IPID=5002
CACHE
0
PUPPET
ATTACKER
IDEAL POISONING SCENARIO
TARGET
PUPPET
INTERNET
CACHE
0
ATTACKER
IDEAL POISONING SCENARIO
TARGET
INTERNET
IPID = 5003, 
5004, 5005, 
5006, 5007, 
5008, 5009, 
5010, 5011,
etc…
64
CACHE
We might need to repeat this
(Patience/Avoiding Cache)
PUPPET
ATTACKER
IDEAL POISONING SCENARIO
TARGET
INTERNET
63
CACHE
IPID = 5003, 
5004, 5005, 
5006, 5007, 
5008, 5009, 
5010, 5011,
etc…
PUPPET
ATTACKER
IDEAL POISONING SCENARIO
TARGET
INTERNET
63
CACHE
IPID = 5003, 
5004, 5005, 
5006, 5007, 
5008, 5009, 