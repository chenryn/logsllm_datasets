DEF CON USA 2019
65
 WinDbg is always an excellent tool to understand a .NET malware in a better way 
or even getting a basic understanding, at least. 
 Install SOSEX extension:
 Download it from http://www.stevestechspot.com/downloads/sosex_64.zip
or http://www.stevestechspot.com/downloads/sosex_32.zip
 Unpack it and copy to your WinDbg installation directory.  For example: 
C:\Program Files (x86)\Windows Kits\10\Debuggers\x64|x86
 Attach the WinDbg to either a running application (the .NET malware) or a saved 
dump. 
 Remember that the CLR process is composed by: 
 System Domain
 Shared Domain
 Default Domain
 code running at this domains can’t access resources in another 
application domain.
v
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
66
0x25B05A: Entry Point from dumpbin /headers malware1.exe
 Remember: 
 Malware execution
 Win loaders find the PE’s entry point
 Jump to mscoree.dll
 Call to CorExeMain
 Return to assembly’s entry point.
Disassembling CorExeMain( ) from the start.
We could have used before this point: sxe ld mscorwks.dll ; g
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
67
Listing domains of the CLR process.
As it’s commented previously.
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
68
Used assemblies tell us a 
bit about the application. 
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
69
Checks managed 
exception in each 
thread.
switch to the thread 5
managed threads:
0, 2 , 5, 10 and 14
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
70
Check the managed stack trace for this thread.
switch to the thread 0
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
71
Get a list of managed threads. Of 
course, we could used the -special 
option to get additional information.
Checks the 
unmanaged stack 
trace for this thread.
COM Threading Model:
STA: Single Thread Apartment 
MTA: Multi Thread Apartment
Threat state:
(0x0) Newly 
initialized thread.
(0x020) It can enter 
a Join. 
(0x200) background 
thread.
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
72
Check if the instruction pointer address belongs to 
the JIT code and find the Method Descriptor 
Disassembling the code
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
73
Checks the managed stack
Display information about the MethodDesc structure
Dump the MethodDesc structure at this address.
Method definition. 
Remember: Metadata token is 
composed by a Table Reference (1 byte) 
and a Table Index (3 byte).
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
74
Displays information about the EEClass structure associated with a type
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
75
dumps the object content, but in this case it is a value type. 
Class
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
76
Dump information about the Method Table
Dump information about the Method 
Table and display a list of all methods.
Code is PreJIT compiled
Type definition
EEClass data structure is similar to 
the method table, but it stores 
fields that are used less frequently.  
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
77
Dump information about a specific module
Dump information about the assembly (as shown previously)
Data accessed and/or updated less frequently
Data accessed and/or updated very frequently
Data used to help COM operations
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
78
Displays the 
MethodTable structure 
and EEClass structure 
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
79
Bad intentions?  
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
80
PreJIT: pre-compiled code
JIT: compiled Code
NONE: the code hasn’t been compiled by the  JIT.
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
81
Shows information about the EEClass structure
Set up a breakpoint on a code that is not JIT yet. 
Displays the MethodTable 
structure and EEClass structure 
of test.Client.Verbinden method.
Displays the MethodDesc 
structure information
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
82
Dumps out arrays
Performs stack walking and display 
managed objects from current thread
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
83
Value Type: 1
Reference:   0
Method Table 
of the field
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
84
As a general overview, during allocation requests: 
If the maximum expected memory for the Gen0 is 
exceeded, collect non-rooted objects and promote 
rooted objects to Gen 1.
The same approach is valid when collecting objects 
from Gen 1 and Gen 2. 
If Gen 2 is exceeded, so GC adds a new segment to 
Gen 2. 
Objects in Gen 0 and 1 are short-lived. 
Reference chain 
to the object 
from stack...
from handle tables...
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
85
The Finalization Queue contains 
objects with finalizers (Finalize( )). 
When  an object in Finalization 
Queue becomes rootless, so the 
GC put it into the f-reachable 
queue, which are considered 
garbage (but alive).
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
86
Excessive or long-time pinned handles 
can cause CLR heap fragmentation. 
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
87
Dumps the process 
to later analysis
Look for the string in 
the managed heap.
It shows information about locks
Make easier to find deadlocked threads 
Displays information 
about a type or variable
It could seems unbelievable, 
but some malware samples 
don’t work because deadlocks  
If there is some deadlock, so 
use the DumpObj command to 
find additional information 
about the thread. 
CCW: COM Callable Wrapper
RCW: Runtime Callable Wrapper, 
which intercepts, manage the 
object’s lifetime and the 
transition between managed 
code and native code.
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
88
Remember that an event works as 
synchronization object. 
When an event happens (going from 
non-signaled state to signaled state), the 
waiting thread (WaitForSingleObject( )) 
starts its execution. 
Auto reset: If the event is signaled, so 
allows the thread being release and it is 
automatically reset to non-signaled state. 
Manual reset: the event remains in 
signaled state until being intentionally 
reset. 
Other synchonization techniques could 
be Semaphores, ReaderWriterLock, 
Mutex and so on... 
It shows specific-object handle information
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
89
Additionally, it is always recommended 
to investigate the current stack, looking 
for some interesting string 
Few hints about our malware...
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
90
Get objects (and their respective metadata) stored 
in the heap. To a short output, use !DumpHeap -stat 
Dumps the heap, but 
limit the output to the 
specified type name. 
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
91
Displays information 
about the method table
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
92
Boxing turns a value type 
into an object reference 
(reference type)
Unboxing turns a object 
reference into a value type
!DumpIL displays the IL 
instructions of a method
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
93
!DumpHeap -strings is 
always excellent to find 
valuable strings. 
If you can’t recognise 
these strings, they are 
related to banks. 
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
DEF CON USA 2019
94
Surprise... is it malicious? 
 https://github.com/alexandreborges/malwoverview
DEF CON USA 2019
95
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
 Acknowledgments to:
DEF CON staff, who have been always very kind with 
me. 
You, who have reserved some time attend my talk.
Security is like a drunk: while walking back-and-forth, he 
always proceeds halfway through the remaining distance, 
but he never gets there. 
Remember: the best of this life are people. 
DEF CON USA 2019
96
Malware and Security Researcher. 
Speaker at DEF CON USA 2018
Speaker at DEF CON China 2019
Speaker at CONFidence Conference 
2019 (Poland)
Speaker at HITB 2019 Amsterdam
Speaker at BSIDES 
2019/2018/2017/2016
Speaker at H2HC 2016/2015
Speaker at BHACK 2018
Consultant, Instructor and Speaker on 
Malware Analysis, Memory Analysis, 
Digital Forensics and Rootkits. 
Reviewer member of the The Journal 
of Digital Forensics, Security and Law.
Referee on Digital Investigation: The 
International Journal of Digital 
Forensics & Incident Response
THANK YOU FOR 
ATTENDING MY TALK. 
 Twitter: 
@ale_sp_brazil
@blackstormsecbr
 Website: http://www.blackstormsecurity.com
 LinkedIn: http://www.linkedin.com/in/aleborges
 E-mail: PI:EMAIL
ALEXANDRE BORGES – MALWARE AND SECURITY RESEARCHER
Blackstorm Security: we offer one of best 
training courses around the world.