开发者PG TOP 18问
Digoal
我是: 德哥
江湖人称: 德哥
帮会: PostgreSQL社区
帮会职务: 校长
正经职务: 阿里云数据库产品经理
擅长武器: PostgreSQL
必杀技: 删库跑路
愿景:
没有PG解决不了的问题,如果有,就多买几台
格言: 公益是一辈子的事
业余爱好: 写博、写专利赚钱、毁人不倦
github: https://github.com/digoal
继续庆祝PG 13 于2020-09-24正式发布
• PG 13 它牛逼在哪? 打死也不说:
• PG 13 它贴心在哪?
https://github.com/digoal/blog/blob/master/202009/20200926_01.md
• PG 13 它烧脑在哪?
• PG 13 它奔放在哪?
全球社区 协作 奉献
• "PostgreSQL 13展示了 的 和 精神。", "
创新, 可靠 稳定
每个发行版带来的 以及PG在 性和 性方面的声
誉，是越来越多的企业选择使用PostgreSQL的原因"。
目录
•开发者 PG TOP 18问
TOP 18问有没有代表性?
•问题来源?
• 全球最大的共享出行服务商HelloBike
•回答够不够权威?
• 校长
pg 可以使用hint指定走某个索引吗？
• 为什么要问这个问题?
• 优化器没有选择合适索引
• 为什么优化器没有选择合适索引
• 统计信息维度不够、统计信息不准确、算子参数不准确
• 为什么统计信息维度不够
• 为什么不增加统计信息维度
• 为什么统计信息不准确
• 为什么没有触发统计
• 为什么算子参数不准确
• 还想要用HINT吗?
• 有哪些优化器? 分别解决什么问题?
• 自动: cbo, geqo, aqo
• 人为: srplan, hint
• 自动化趋势不可逆转, 未来一定是自动化的天下.
• 答案
• 废话真多, 用 pg_hint_plan 插件
pg 针对分表要新增一个字段，需要对每个
分表编辑吗？
• 为什么要问这个问题?
• 废话, 躺着赚钱不香吗
• 答案
• 不需要, 直接操作主表, PS: 所有DDL都有排他锁, 注意防止雪崩(后面会讲).
pg 在保持性能的前提下，最多能存多少条
数据呀？
• 为什么要问这个问题?
• 一定是没有遇到过性能瓶颈, 否则不就知道了么, 还有毛线疑问
• 答案
• 摩尔定律+安迪比尔定律
• 52C 384GB 16TB SSD
• PG 12 TPCB 100亿
• RO: 100万量级qps
• RW: 50万量级qps
pg 建议在多少条记录时分库/分表？
• 为什么要问这个问题?
• 寻址上限, ctid(pageid, offset)->pageid 32位->pagesize(2k-32k) ->最大128TB每分区
• 存储上限, 表空间->目录->文件系统->卷->块设备
• 性能上限,
• 垃圾回收, table/process, index/multiprocess, (更新模型, 瓶颈与 IO|CPU 匹配)
• 建索引, 支持并行, 10亿记录, 创建索引252秒
• freeze, 32bit xid, 只写(一次性freeze)、 更改(版本变化后需要freeze)
• 逻辑备份, 快照, 垃圾回收oldest位点, DDL互斥
• rewrite table, 某些情况需要重写表(vacuum full, 更改字段类型导致内部存储值发生变化, 老版本加字段默认值)
• 答案
• SSD或者10万级+IOPS
• 以下都是废话:
• 更新多的表
• 16GB or 1亿 / 分区
• 更新少的表
• 64GB / 分区
• 分库/建只读实例
• 热数据>内存/2 , 写入瓶颈, 查询瓶颈
pg delete记录后水位线会下降吗？
• 为什么要问这个问题?
• 水位不下降会怎么样?
• 水位下降有什么好处?
• 答案
• 索引, 复用空间, 不回收, 不降水位.
• HEAP, 复用空间, 无有效记录的空页为什么不能从文件系统回收空间?
• 试想索引如何检索记录? 当记录在HEAP末尾页, 不在末尾页时有什么区别?
• 末尾连续空页可以直接回收, 其他空页无法直接回收
• 水位没降下来怎么办?
• 表未来还要不要继续写入?
• vacuum full, pg_repack , (rewrite, 前提保留足够存储空间)
pg 一般tps/qps能达到多少？
• 为什么要问这个问题?
• 任何没有说明环境、场景、测试方法的性能指标都没有参考价值
• 答案
• 52C 384GB 16TB SSD
• PG 12 TPCB 100亿
• RO: 100万量级qps
• RW: 50万量级qps
pg 的统计信息收集是按照什么规则？
• 为什么要问这个问题?
• 一定是遇到过统计信息不准、未开启, 引起的SQL执行计划不准的问题
• 答案
• autovacuum_analyze_scale_factor
• autovacuum_analyze_threshold
• table | global level set.
• 开启自动收集->计数器->监工发现需要统计的表->分配工人干
活->更新统计信息
pg 支持json/jsonb吗？
• 为什么要问这个问题?
• 敏捷开发是把双刃剑
• 答案
• PG: 无敌的sqljson功能
• sql 2016的sql/json标准有15条， PG 支持14道标准
• PG (12 14/15)，
• oracle(18c 11/15),
• mysql(8.0.4 5/15),
• sqlserver(2017 2/15) 。
• 索引支持
• jsonpath搜索语法
https://github.com/digoal/blog/blob/master/202010/20201013_01.md
pg 索引类型，除了btree还有哪些，可以
建立btree-gist联合索引吗？
• 为什么要问这个问题?
• 一定是遇到事了!!!
• 《[直播]为什么饿了么网上订餐不会凉凉 & 牛顿发现万有引力有关?》
• https://github.com/digoal/blog/blob/master/202010/20201018_01.md
• 《[直播]为什么打车和宇宙大爆炸有关?》
• https://github.com/digoal/blog/blob/master/202009/20200926_02.md
• 答案
• 后面会讲到PG支持哪些索引
• 可以, create extension btree_gist;
• 性能提升的感觉
• 就像男人看到美女后, 荷尔蒙爆表.
canceling statement due to conflict with
recovery什么情况，怎么处理？
• 为什么要问这个问题?
• 一定是用了只读实例, 一定是SQL被莫名其妙的KILL过.
• https://github.com/digoal/blog/blob/master/202005/20200518_01.md
• 答案
• rw instance -> redo -> readonly instance -> startup process replay redo
-> conflict with query -> recovery等query -> 等待是有限度的 -> cancel
query
• replay的redo里面包含什么信息时, 会和query冲突?
• 最常见的情况: vacuum某些tuple version, 与query快照的xid相冲突
• 从节点调大replay等待时长, 主节点设置延迟回收, 从节点设置query feedback
• 可能导致主节点vacuum出现无用功, 或者膨胀
• 其他: 删除表空间, 锁冲突, pinned buffer, 死锁等.