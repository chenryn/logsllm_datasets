# GandCrab传播新动向——五毒俱全的蠕虫病毒技术分析V1.1
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 概述
近日，360终端安全实验室监控到GandCrab勒索病毒有了新动向，和以往相比本次GandCrab传播量有了明显的波动，我们分析了背后原因，发现此次波动是由一种近年较常见的蠕虫病毒引起的，该蠕虫病毒主要通过U盘和压缩文件传播，一直活跃在包括局域网在内的众多终端上。该蠕虫病毒构成的僵尸网络，过去主要传播远控、窃密、挖矿等木马病毒，而现在开始投递GandCrab勒索病毒。由于该病毒感染主机众多，影响较广，因而造成了这次GandCrab的传播波动。在此特提醒大家注意保护好您的数据，当心被勒索病毒袭击从而遭受不可挽回的损失。
我们对该蠕虫病毒的最新变种进行了深入分析。病毒的母体和以往相比没有太大变化，其主要特别之处在于其投递的病毒种类有了新变化，除了新增投递GandCrab勒索病毒外，还发现该病毒的初次投放方式，也即病毒制作者是怎么投放病毒的。一般病毒的初次投放方式包括挂马、捆绑下载、邮件附件、租用僵尸网络、漏洞利用等，而这次该病毒使用了邮件附件作为其初次投放传播的手段之一。
下面首先就其主要技术特点概括如下：
  * 病毒代码具有风格统一的混淆方式，通过内存解密PE并加载执行来绕过杀软的静态扫描查杀，病毒的母体具有一定反沙箱反分析能力；
  * 具备多种传播方式，包括投递恶意邮件、感染Web/FTP服务器目录、U盘/网络磁盘传播、感染压缩文件等；
  * 窃取多种虚拟货币钱包，包括：Exodus、JAXX、MultiBit HD、Monero、Electrum、Electrum-LTC、BitcoinCore等多种货币钱包；
  * 通过劫持Windows剪贴板，替换多种主流虚拟货币钱包地址，包括：BTC、ETH、LTC、XMR、XRP、ZEC、DASH、DOGE等币种；
  * 窃取邮箱账号、Web网站登录账号、WinSCP凭据、Steam游戏平台账号、以及多种即时通讯软件聊天记录；
  * 下载传播多种病毒，包括勒索、窃密、挖矿、母体传播模块等，其母体内嵌的下载链接主要固定为5种，正好印证了“五毒俱全”的特点；
## 病毒攻击流程
## 病毒详细分析
### 母体DownLoader分析
探测虚拟机/沙箱运行环境
病毒母体是一个DownLoader，运行时通过遍历进程以及检查加载的模块来探测运行环境是否是虚拟机或沙箱环境，其中特别针对python进程进行了检查（沙箱常用），还通过检查加载的DLL模块来检测sandboxie或sysanalyzer：
### 持久化设置
病毒会将自身拷贝至windows\自建目录\winsvcs32.exe，并创建注册表开机启动项实现持久化运行：
拷贝并重命名为winsvc32.exe
创建注册表开机启动项
删除自身的Zone.Identifier NTFS Stream避免运行时出现风险提示
### 添加防火墙例外以及关闭Windows Defender实时防护等功能
防火墙以及Windows Defender相关设置
### 通过可移动磁盘/网络磁盘进行AUTORUN传播
针对网络磁盘以及可移动磁盘
在U盘根目录创建”_”目录以及将自身拷贝并重命名为DeviceManager.exe
创建指向病毒母体的lnk文件
Lnk文件内容
被感染后的U盘以及AutoRun.inf截图
### 通过感染压缩包进行传播
判断%appdata%\winsvcs.txt是否存在，不存在则创建该文件，该文件起到一个开关作用，用来判断是否对压缩文件进行感染：
将自身拷贝至%TEMP%目录，并重命名为“Windows Archive Manager.exe”：
遍历本地磁盘中的压缩文件，将病毒本体添加到压缩文件，受感染的压缩类型包括zip、rar、7z、tar：
这部分代码功能还不太完善，经过测试，压缩格式只支持zip、rar，7z和tar格式的支持有Bug，感染后会破坏原有格式：
### 替换FTP/WEB服务器目录下的EXE文件进行传播
遍历磁盘文件，判断EXE文件所在路径是否包含如下FTP/WEB服务器目录：
如果满足条件，则把目录下的EXE文件替换成病毒自身文件：
### 监控系统剪贴板，劫持替换虚拟货币钱包地址
监控剪贴板，如果发现有预期的虚拟货币钱包地址，则进行替换，影响的币种包括：
Btc、eth、ltc、xmr、xrp、zec、dash、doge等。
判断各类货币钱包地址特征
劫持监控剪贴板
### 通过内置C2下载多个恶意模块
母体内嵌了3个C2服务器以及多个混淆的DNS备用地址用于下载传播其他病毒程序（这些DNS暂时无效，但如果前面3个IP被封或失效，可通过启用这些备用DNS来达到切换C2的目的）:  
将下列5个文件名与上述ULR链接拼接成完整下载链接：
此处5个恶意链接用来下载传播其他病毒，可谓“五毒俱全”。
下载的多个恶意模块保存在%TEMP%目录下并随机命名，然后删除对应的Zone.Identifier避免运行时出现风险提示：
下载成功后创建进程执行该文件：
此次分析时下载的恶意模块包括：传播模块、2个勒索病毒Downloader、窃密模块、挖矿模块（具体推送某类恶意程序随时间以及C2服务器而定）
## 挖矿模块分析
### 内存解密PE加载执行
挖矿模块与病毒母体采用了类似代码混淆方式，通过内存解密PE并加载执行：
解密配置文件URL地址、以及矿池地址等数据
内存映射NTDLL模块，获取所需API，绕过R3 Hook
通过获取挖矿配置相关数据
分析调试时，上述链接已失效：
解析配置数据，包含钱包地址、挖矿端口等配置信息
构造xmrig Config配置文件
根据前面获取到的钱包地址等信息，构造config文件，并进行base64编码保存。
配置文件格式化
Base64解码后的配置文件（由于url失效，无法获取有效钱包地址）
### 持久化设置
拷贝自身至“ProgramData\GCxcrhlcfj”目录，并创建r.vbs脚本：
通过VBS脚本，在start menu下生成url快捷方式，指向样本自身：
调用wscript执行：
Url快捷方式负责启动挖矿病毒：
### 解密内嵌的xmrig程序，借壳系统程序作为傀儡进程挖矿
挂起方式启动wuapp.exe，其命令行参数为挖矿配置文件：
解密xmrig：
解密xmrig
内存解密出的PE为XMRig 2.8.1版本：
在傀儡进程注入代码:
傀儡进程注入
### 监控TaskMgr.exe
为了隐蔽自身，样本会实时遍历系统进程检查是否有任务管理器进程存在，如果发现则杀掉挖矿进程：
杀进程代码
## 窃密模块分析
该窃密木马为Delphi编写，窃密内容主要包括即时通讯软件聊天记录、浏览器历史记录、WinSCP凭据、Steam账号、虚拟货币钱包、邮箱、屏幕截图等。
样本尝试与C2服务器通讯拉取配置信息（服务器已失效）
相关窃密功能代码结构：
涉及的虚拟货币钱包：
Exodus 、JAXX、MultiBit HD
Monero
Electrum、Electrum-LTC、BitcoinCore
即时通讯软件：