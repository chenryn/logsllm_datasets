ntp.api.bz.
;QUESTION SECTION:
6.2.2
;;ANSWER SECTION:
ntp.api.bz.
zu>-6>
[root@localhost~]#digntp.api.bz
flags:qr rd ra;QUERY:1,
Got answer:
global options:printcmd
添加完成后，我们用Linux下的dig命令查看ntp.api.bz域名的域名解析情况，如代码6-1
图6-2为全球第二大域名注册商——enom的域名Web管理界面，这里我们为 api.bz域名添
DNS轮询的成本非常低，在一些不重要的服务上，被经常使用。
DNS轮询方式
EdMXRecord
newrowdeleta checkedadd SRVorSPFrocordporkdomaln
口
口
口
口
口
口
口
哥
哥
哥
哥
哥
哥
1792
1792
1792
图6-2DNS服务器的Web管理界面
[A(Address）
[A(Address)
A(Address)
[A(Addres)
A(Adress)[114808169
A(Address)
(Address)
6.2常见的Web负载均衡方法
县
IN
www.TopSage.cohNginx：取代Apache的高性能Web服务器
ANSWER:6,AUTHORITY:5,ADDITIONAL:4
61.153.197.226
114.808172
11480.811
61.12966.79
218.754130
A
61.129.66.79
218.75.4.130
114.80.81.72
resetsave
NoOptons
toOptions
NoGptien
NeOptin
NO CUon
NoOptons
oOptions
NoOption
弘网
77
---
## Page 73
实战 Nginx：取代 Apache 的高性能 Web 服务餐w.TopSage.com
Web 服务器间的负载不均衡。
的映射，这会导致使用该 DNS 服务器的用户在一段时间内访问的是同一台 Web 服务器，导致
器上的情况。
前运行状态，不能做到为性能较好的服务器多分配请求，甚至会出现客户请求集中在某一台服务
衡问题，但是却存在可靠性不高的缺点。
DNS 记录全部生效需要几个小时，甚至更久。所以，尽管 DNS 轮流在一定程度上解决了负载均
但在 Intermet上，各地区电信、网通等宽带接入商将众多的 DNS 存放在缓存中，以节省访问时间,
服务器的请求将不会有所回应，这是任何人都不愿意看到的。即使从 DNS 中去掉该服务器的 IP,
其中一个IP上，从而实现负载均衡的目的。
dns5.name-services.com
dns3.name-services.com
dns2.name-services.com
dnsl.name-services.com
;;ADDITIONAL SECTION:
api.bz.
api.bz.
api.bz.
api.bz.
;; AUTHORITY SECTION:
ntp.api.bz
ntp.api.bz
ntp.api.bz
78
DNS 服务器是按照一定的层次结构组织的，本地 DNS 服务器会缓冲已解析的域名到IP地址
2．负载分配不均衡
我们可以发现，域名解析正常，A 记录有七个 IP。每次访问 ntp.api.nz 域名会被随机解析到
MSG SIZE
WHEN: Sun Aug 16 17:34:43 2009
SERVER: 219.141.136.10#53(219.141.136.10)
此外，用户本地计算机也会缓存已解析的域名到 IP 地址的映射。当多个用户计算机都缓存
DNS 负载均衡采用的是简单的轮询负载算法，不能区分服务器的差异，不能反映服务器的当
Query time: 1 msec 
假设一个域名 DNS 轮询多台服务器，如果其中的一台服务器发生故障，那么所有的访问该
1．可靠性低
虽然 DNS 轮询成本低廉，但是，DNS 负载均衡存在两个明显的缺点。
rcvd: 300
第 6 章Nginx HTTP 负载均衡和反向代理的配置与优化
3592'
3592
3592
3592
3592
1792
1792
1792
45929
38315
4665
45929
2
2
V
A
dns5.name-services.com
dns3.name-services.com
dns2.name-services.com
dnsl.name-services.com
dns4.name-services.com
114.80.81.69
114.80.81.1
61.153.197.226
98.124.196.1
98.124.193.1
98.124.197.1
98.124.192.1
---
## Page 74
它是独立于网络层和物理层的，工作时无须关心计算机是否正在运行软件还是其他操作。
输的可靠性。它的主要作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等。
路上进行可靠的传递。它把从网络层接收到的数据分割成特定的可被物理层传输的帧，保证了传
过程特性。虽然物理层不提供纠错服务，但它能够设定数据传输速率并监测数据出错率。
接在一起的设施。它规定了激活、维持、关闭通信端点之间的机械特性、电气特性、功能特性及
表示层和应用层。
后把数据传送到下一层。由低到高具体分为：物理层、数据链路层、网络层、传输层、会话层、
数据移动密切相关。五至七层是高层，包含应用程序级的数据。每一层负责一项具体的工作，然
open system interconnection)。
促进计算机网络的发展，国际标准化组织ISO于1977年成立了一个委员会，在现有网络的基础
并存，其结果是若采用 IBM的结构，只能选用IBM的产品，只能与同种结构的网络互联。为了
提出自己的网络体系结构如：Digital 公司的 DNA，美国国防部的 TCP/IP 等，多种网络体系结构
设备来实现服务器的负载均衡。
6.2.3四/七层负载均衡设备
上，提出了不基于具体机型、操作系统或公司的网络体系结构，称为开放系统互联模型（OSI,
纯静态网页服务器集群等。
慢；配置高的服务器分配到的请求少，而配置低的服务器分配到的请求多。
服务器间的负载分配不均衡。
了某域名到IP 地址的映射时，而这些用户又继续访问该域名下的网页，这时也会导致不同 Web
这个模型把网络通信的工作分为七层（可参见图6-3）。
世界上第一个网络体系结构由 IBM 公司提出（1974 年，名为 SNA)，以后其他公司也相继
数据链路层协议的主要内容包括：SDLC、HDLC、PPP、STP、帧中继等。
数据链路层的主要作用是控制网络层与物理层之间的通信。它保证了数据在不可靠的物理线
OSI模型的第二层：数据链路层
物理层包括物理连网媒介，实际上就是布线、光纤、网卡和其他用来把两台网络通信设备连
OSI模型的最低层或第一层：物理层
因此，DNS 轮询方式仅适用于一些可靠性要求不高的服务器集群，例如：图片服务器集群、
负载不均衡可能导致的后果有：某几台服务器负荷很低，而另几台服务器负荷很高、处理缓
6.2常见的 Web 负载均衡方法
Www.TopSage.c实Nginx：取代 Apache 的高性能 Web 服务器
一至四层被认为是低层，这些层与
6
---
## Page 75
实战 Nginx：取代 Apache 的高性能 Web 服条器.TopSage.com
文件管理及电子邮件等的信息处理。
信息进行解码和编码。
被加密，在网络的另一端，表示层将对接收到的数据解密。另外，表示层还要对图片和文件格式
断，以及通信中断时决定从何处重新发送。
区分包中的数据，这是第四层交换的基础。
等）。TCP/UDP端口号提供的附加信息可以为网络交换机所利用，四层交换机利用这种信息来
TCP和UDP包含端口号，它可以唯一区分每个数据包包含哪些应用协议（例如HTTP、FTP、telnet
制和流量控制等问题，最终为会话提供可靠的、无误的数据传输。
要求；而当网络层服务质量较好时，它只须进行很少的工作。另外，它还要处理端到端的差错控
端的层次，起到缓冲作用。当网络层的服务质量不能满足要求时，它将提高服务，以满足高层的
制、网际互联等功能。
服务质量及可选路由的花费来决定一个网络中两个节点的最佳路径。另外，它还可以实现拥塞控
协议或地址解析协议（ARP）相关的问题，那么这就是第三层的问题。
网络层负责对子网间的数据包进行路由选择，它通过综合考虑发送优先权、网络拥塞程度、
表示层的作用是管理数据的解密与加密，如常见的系统口令处理，当你的账户数据在发送前
很多用户经常混淆第二层和第三层的界限，简单来说，如果你在谈论一个与IP 地址、路由
应用层协议的代表包括：Telnet、FTP、HTTP、SNMP等。
简单来说，应用层就是为操作系统或网络应用程序提供访问网络服务的接口，包括文件传输、
OSI模型的第七层：应用层
OSI模型的第六层：表示层
会话层负责在网络中的两节点之间建立和维持通信，并保持会话同步，它还决定通信是否中
OSI模型的第五层：会话层
在IP协议栈中第四层是TCP（传输控制协议）和UDP（用户数据报协议）所在的协议层。
传输层协议的主要内容包括：TCP、UDP、SPX等。
传输层是OSI模型中最重要的一层，它是两台计算机经过网络进行数据通信时，第一个端到
OSI模型的第四层：传输层
网络层协议的主要内容包括：IP、IPX、RIP、OSPF等。
OSI模型的第三层：网络层
第6章Nginx HTTP负载均衡和反向代理的配置与优化
---
## Page 76
该虚拟 IP 下有一个服务器池（pool_squid），该服务器池下包含两台真实的 Squid 服务器
是如何实现四/七层负载均衡的。
度、搜狐、凤凰网、央视国际、中华英才网、猫扑、慧聪网等。
的 BIG-IP 负载均衡交换机的网站（有些网站为部分频道采用）最多，包括：新浪网、雅虎、百
Foundry 等产品，这些产品价格不菲，高达几十万元人民币。在中国大陆，采用F5 Network 公司
执行负载均衡任务。
HTTP 服务器群的应用。第七层负载均衡技术通过检查流经的 HTTP 报头，根据报头内的信息来
间进行映射，选取服务器群中最好的服务器来处理连接请求。
交换机根据源端和目的 IP 地址、TCP 或UDP 端口号和一定的负载均衡策略，在服务器IP 和 VIP
用，一个目标地址是服务器群VIP（虚拟IP，Virtual IP address）连接请求的数据包流经交换机，
(192.168.1.11 和 192.168.1.12）。
其中一个内部 IP 地址，达到负载均衡的目的。在第四层交换机中，此种均衡技术得到广泛的应
Intemet 上合法注册的 IP 地址映射为多个内部服务器的 IP 地址，对每次 TCP 连接请求动态使用
（1）如图，假设域名 blog.s135.com 被解析到 F5 的外网/公网虚拟 IP：61.1.1.3（vs_squid）
图6-4 是一张 F5 BIG-IP 实现动、静态网页分离的负载均衡架构图，很好地描述了 F5 BIG-IP
硬件四/七层负载均衡交换机的代表有：F5 BIG-IP、Citrix NetScaler、Radware、Cisco CSS、
常见的四/七层负载均衡设备：
第七层负载均衡控制应用层服务的内容，提供了一种对访问流量的高层控制方式，适合对
现代负载均衡技术通常操作于OSI网络模型的第四层或第七层。第四层负载均衡将一个
1．硬件四/七层负载均衡交换机
OSI网络模型如图6-3所示。
面
6.2常见的 Web 负载均衡方法
图6-3OSI网络模型
比特流的传输
解封
物理屏
表示
应用
链路
路
---
## Page 77
实战 Nginx：取代 Apache 的高性能 Web 服氨器w.TopSage.com
透明性、可伸缩性、高可用性和易管理性。
结构对客户是透明的，而且无须修改客户端和服务器端的程序。为此，在设计时要考虑系统的
务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器。整个服务器集群的
调度器具有很好的吞吐率，将请求均衡地转移到不同的服务器上执行，且调度器自动屏蔽掉服
分布式处理重点实验室工作，现在已加盟淘宝网的章文嵩博士。LVS 是一个开源的软件，可以
192.168.1.24)
池（pool_apache_irules），该服务器池下同样包含两台真实的Apache 服务器（192.168.1.23 和
器（192.168.1.21和192.168.1.22），当该虚拟IP匹配 iRules 规则时，则会访问另外一个服务器
拟 IP下有一个默认服务器池（pool_apache_default），该服务器池下包含两台真实的 Apache 服务
LVS 负载均衡的结构如图 6-5 所示。
软件四层负载均衡的代表作品为LVS（Linux Virtual Server），作者为曾经在国家并行与
2.软件四层负载均衡
（4）所有的真实服务器通过 SNATIP地址61.1.1.4访问互联网。
（3）另外，所有真实服务器的默认网关指向F5的自身内网IP，即192.168.1.2。
（2）如果 Squid 缓存未命中，则会请求 F5 的内网虚拟 IP：192.168.1.3（vs_apache），该虚
3.1管理网口.出厂IP为htp:/192.168.1.24或htp://192.168.245.245
1.1 网口外界交换机
默认网关指向F5/访问互联网、对外发部件
192. 168.1.21
192.168.1.23
1.2网口内接交换机，SquidApache服务器也接在交换机上
图6-4F5BIG-IP实现动、静态网页分离的负载均衡架构图
七层负载均衡
符合irutes规则
第6章Nginx HTTP 负载均衡和反向代理的配置与优化
默认
外网SNAT IP: 61.1.1:4.
对你发联
用户访间 blog.sl35.com
pool_squid 
四层负载均衡
192.168.1.12
---
## Page 78
www.sina.com.cn时，会被解析到武汉电信机房的IP上，等等。
www.sina.com.cn时，会被解析到广州电信机房的IP上；当湖南、湖北的电信用户访问
育网的用户访问www.sina.com.cn时，会被解析到教育网机房的IP上；当广东电信的用户访问
务器线路和地区，将对同一个域名请求解析到不同的IP上。
DNS轮询、四/七层负载均衡交换机”等技术。智能DNS解析能够根据用户本地设置的DNS服
6.2.4
服务器的健康检查。
可以按轮询、IP哈希、URL哈希、权重等多种方式对后端服务器做负载均衡，同时还支持后端
switching）、HAProxy等。Nginx的反向代理负载均衡能够很好地支持虚拟主机，可配置性很强，
例如：当北京电信用户访问www.sina.com.cn时，会被新浪的DNS服务器解析到北京电信机
将DNS地址设为北京电信的DNS服务器219.141.136.10，通过Linux下的dig命令可以发现，
以新浪首页（www.sina.com.cn）为例，负载均衡同时用到了“多线多地区智能DNS解析、
软件的七层负载均衡大多基于HTTP反向代理方式，代表产品有Nginx、L7SW（Layer7
3.软件七层负载均衡
多线多地区智能DNS解析与混合负载均衡方式
6.2常见的Web负载均衡方法
图6-5LVS负载均衡架构图
LoadBalancer
www.TopSage.cNginx：取代Apache的高性能Web服务器
ServerCluste
Storage
TopSage.com
厂弘网
83
---
## Page 79
实战 Nginx：取代 Apache 的高性能 Web 服器w.TopSage.com
ns2.sina.com.cn
hydra.sina.com.cn
hydra.sina.com.cn.
hycra.sina.com.cn.
hydra.sina.com.cn.
hydra.sina.com.c
hydra.sina.com.cn.
代码6-2
轮询解决负载均衡，如代码6-2 所示。
访问www.sina.com.cn 被解析到了北京电信的多台服务器的 IP上，这属于智能 DNS 解析+DNS
ns3.sina.com.cn.
nsl.sina.com.cn.
;; ADDITIONAL SECTION:
61
：
2
hydra.sina.com.cn.
hydra.sina.com.cn.
www. sina.com.cn.
;; ANSWER SECTION:
[root@localhost ~]# dig www.sina.com.cn
ina.com.cn.
ina.com.cn.
ina.com.cn
upiter.sina.com.cn.
www.sina.com.cn.
dra.sina.com.cn
ydra.sina.com.cn
ydra.sina.com.c
ydra.sina.com.cn.
：
> DiG 9.3.4-P1 > www.sina.com.cn
MSG SIZE rcvd: 433
WHEN: Sun Aug 16 23:54:43 2009
SERVER: 219.141.136.10#53(219.141.136.10)