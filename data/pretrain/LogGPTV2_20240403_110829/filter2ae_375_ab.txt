总而言之，代理脚本利用嵌入式密钥来解密URL并检索内容。
外观相似的编码字符串`index.php`作为参数传递给文件(包含广告系列特定数据的编码消息)。如果我们继续研究此PHP文件的功能，可以推测出它可用于跟踪统计信息以及广告系列文件的交付过程。
从后端提供广告系列文件：
## 统计面板
经过进一步分析，发现统计小组证实了我们的假设，对每个广告系列都进行仔细跟踪。在下图中，将显示每个文件的匹配项以及运算符和文件名。这对于典型的负载服程序，其需要统计信息才能准确地向客户收费。
该面板还显示其活动中每个链接的跟踪，这样可以更加深入了解每个活动的成功执行次数。
## Valak
其他研究人员已经对Valak进行了广泛的研究，我们将从Gozi
ConfCrew和Valak之间联系的方面来进行入手，这些研究主要围绕新插件的使用。当Valak在2019年进行测试时，看到了许多不同的插件。但存在两个涉及电子邮件凭据数据的收集的问题，其中一个是交换抓取器。
收集电子邮件凭据与Gozi之前的策略一致，他们会从帐户中收集电子邮件，然后在垃圾邮件中使用电子邮件链进行“回复链攻击”。该攻击围绕劫持现有的合法电子邮件，并将回复信息发送到垃圾邮件中。这种技术可以让用户措手不及，由于用户之前接受过识别假邮件的训练，当看到这封邮件是一个回复（尤其是使用用户信任的接收方式时），用户会放松警惕。回复链攻击还意味着参与者无需投资于创建看起来合法的电子邮件模板，因为他们能够利用真正的电子邮件通信链。
### Exchange数据插件——EXCHGRABBER
如果用户打算利用垃圾邮件中的回复链攻击，那就需要一些电子邮件数据。有趣的是，当攻击活动转移到Valak而不是Gozi时，却出现了围绕盗窃交换数据的插件。
该插件在config部分中将其自身命名为“exchgrabber”或交换抓取器。该名称适合.NET编译插件，因为该插件可以从凭据管理器中找到凭据，可以更方便对Office相关联的凭据进行查找。然后，使用来自autodiscover.xml的数据，并将它构建成为报告。
检索数据后，它将数据渗入C2：
### 电子邮件凭证插件——CLIENTGRABBER
最近关注点已转移到电子邮件盗窃和企业目标定位上，这很有趣。在进行这项研究时，我们还发现了一个名为“clientgrabber”的新插件，该插件主要用于从注册表中窃取电子邮件凭据。
在注册表位置中搜索“键”。
一旦找到，它将检查该值是否使用较新的加密方法（包含可以解密的实际加密数据）。
## IoCs
**Endpoint**
`%temp%\\[a-f0-9]{12}.bin`  
`Scheduled task 'PerfWatson_[a-f0-9]+'`
**ADS executable and script files:**
`HKCU\\Software\\ApplicationContainer\\Appsw64\\ShimV4`
`HKCU\\Software\\ApplicationContainer\\Appsw64\\SetupServiceKey`
**Network**
Base64 encoded PE files transferred over the wire
**Samples**
435ec42fefc05eba0a8005256c815979877d430a  
693e681e7be554e50e4ff9bf7cbfe5aeab3fe91f  
e22b404e1fec743f0795cdea8a95337660878860  
dba1337a0a8293b721642b8b45a86352bcdfd04f  
4d33425d7031284cf5ee323dc616d9f84987dc0d  
17b74a4c3f43c21504b355b1ffc333280ef4cd74  
7f58d22d9e95f65170acadd05e324ec2d8ef13f6  
9be234bf2268f4e055ea59cf7bef76781a36c35c  
19f481063ca956688824e3cc022b8eedb6dd0bea  
4ae3ed6c1ab2fe41daf6f650a54dae63684d2064  
30fd553dedfadc81522adf37e11dfc4039d4ea31
## 参考链接
  1. 
  2. 
  3. 
  4. 
  5. 
  6. 
  7. 
  8. 
* * *