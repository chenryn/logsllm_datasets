Figure 13-17 shows an example of adding an IPv4 packet filter. 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 392 
Figure 13-17  The Add IP Filter dialog box 
You can configure the following settings on an IPv4 packet filter: 
You can specify the IP Protocol, which is the identifier for an upper layer protocol. For example, TCP 
uses a Protocol of 6, UDP uses a Protocol of 17, and ICMP uses a Protocol of 1. 
You can specify the Source IP Address, which is the IP address of the source host. You can configure 
this address with a subnet mask to specify an entire range of IP addresses (corresponding to an IP 
subnet or address prefix) with a single filter entry. 
You can specify the Destination IP Address, which is the IP address of the destination host. You can 
configure this address with a subnet mask to specify an entire range of IP addresses (corresponding to 
an IP subnet or address prefix) with a single filter entry. 
For TCP traffic, you can specify the values for two fields: the TCP Source Port field, which identifies the 
source process that is sending the TCP segment, and the TCP Destination Port, which identifies the 
destination process for the TCP segment. 
For UDP traffic, you can specify the values for two fields: the UDP Source Port field, which identifies the 
source process that is sending the UDP message and the UDP Destination Port, which identifies the 
destination process for the UDP message. 
For ICMP traffic, you can specify the values for two fields: the ICMP Type field, which identifies the type 
of ICMP packet (such as Echo or Echo Reply) and the ICMP Code field, which identifies one of the 
possible multiple functions within a specified type. If only one function exists within a type, the Code 
field is set to 0. 
IPv6 Packet Filtering 
You can perform packet filtering for IPv6 traffic with the following: 
Windows Firewall 
IPv6 packet filtering with Routing and Remote Access 
Basic IPv6 firewall 
IPv6 ICF 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 393 
Windows Firewall 
Windows Firewall in Windows Vista, Windows XP with SP2 and later, Windows Server 2008, and 
Windows Server 2003 with SP1 and later supports IPv6 traffic. You can configure exceptions for IPv6 
traffic with the Windows Firewall with Advanced Security snap-in and the Windows Firewall item in 
Control Panel. 
For exceptions in the Windows Firewall Control Panel item, IPv4 and IPv6 traffic can share settings for 
excepted traffic. For example, if you allow file and print sharing traffic, then both IPv4-based and IPv6-
based unsolicited incoming file and print sharing traffic is allowed. 
IPv6 Packet Filtering with Routing and Remote Access 
Just like IPv4 packet filtering, Routing and Remote Access in Windows Server 2008 allows you to 
specify what types of IPv6 traffic to allow or discard on each interface. You can set filters for incoming 
and outgoing traffic. 
To configure IPv6 packet filters on an interface, do the following: 
1. In the console tree of the Routing and Remote Access snap-in, open the name of your Windows 
Server 2008 server, open IPv6, and then click General. 
2. In the details pane, right-click the interface on which you want to add a filter, and then click 
Properties.  
3. On the General tab, click Inbound Filters to configure filters for incoming IPv6 traffic to the interface 
or Outbound Filters to configure filters for outgoing IPv6 traffic from the interface. 
When specifying a source or destination IPv6 address, you must configure an address prefix and a 
prefix length. 
Basic IPv6 Firewall 
IPv6 for Windows Server 2003 with no service packs installed includes support for a basic firewall on 
IPv6 interfaces. When enabled, IPv6 drops incoming TCP Synchronize (SYN) segments and drops all 
incoming unsolicited UDP messages. This firewall is disabled by default on all interfaces and can be 
enabled with the netsh interface ipv6 set interface interface=NameOrIndex firewall=enabled 
command. The basic IPv6 firewall is not related to the Basic Firewall feature of Routing and Remote 
Access. The basic IPv6 firewall was replaced with Windows Firewall. 
IPv6 ICF 
The Advanced Networking Pack for Windows XP is a free download available from Microsoft for 
computers running Windows XP with SP1. This download includes IPv6 ICF, which is a stateful IPv6 
firewall. You can use IPv6 ICF to dynamically restrict traffic allowed from the Internet. IPv6 ICF is 
different from the existing ICF in Windows XP, which filters IPv4 traffic. IPv6 ICF does the following: 
Runs automatically and filters traffic through all network connections on which IPv6 is enabled. 
Monitors all outbound traffic and dynamically filters for incoming response traffic. This behavior is 
known as stateful filtering. IPv6 ICF silently discards all unsolicited incoming traffic. 
Logs IPv6 traffic events to a separate log file (from IPv4 ICF). By default, this log file is located at: 
Systemroot\Pfirewall-v6.log). 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 394 
You can configure IPv6 ICF by using commands in the netsh firewall context. You can use Netsh 
commands to configure IPv6 ICF to allow specific types of ICMPv6 traffic or traffic to specific TCP or 
UDP ports. IPv6 ICF was replaced with Windows Firewall. 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 395 
Chapter Summary 
The chapter includes the following pieces of key information: 
Internet Protocol security (IPsec) is a framework of open standards for helping ensure private, protected 
communications over IP networks. You can use IPsec in Windows to block, permit, or cryptographically 
protect IP traffic. 
IPsec provides data integrity, confidentiality (encryption), data origin authentication, and anti-replay 
security properties for IP-based communications. 
IPsec can help protect traffic through the use of AH (which provides data origin authentication, data 
integrity, and replay protection for an IP packet), ESP (which provides data origin authentication, data 
integrity, replay protection, and data confidentiality for the ESP-encapsulated portion of the packet), or 
AH with ESP. 
IPsec can use transport mode, in which the original IP header is used, or tunnel mode, in which the 
entire IP packet is encapsulated with a new IP header. 
IPsec uses main mode negotiation to determine encryption key material and to authenticate IPsec 
peers. IPsec uses quick mode negotiation to determine how to protect the traffic sent between peers. 
You can configure IPsec settings in Windows with the Windows Firewall with Advanced Security or 
IPsec Policy Management snap-ins. In the Windows Firewall with Advanced Security, you must 
configure connection security rules. 
An IPsec policy in the IPsec Policy Management snap-in consists of general IPsec policy settings and 
rules. For each rule of an IPsec policy, you must configure a single filter list, a single filter action, one or 
more authentication methods, a tunnel endpoint (if you are using IPsec tunnel mode), and the 
connection type. 
IPsec support for IPv6 traffic in Windows Vista and Windows Server 2008 is the same as that for IPv4. 
IPsec support for IPv6 traffic in Windows XP and Windows Server 2003 does not support ESP data 
encryption and must be manually configured using the Ipsec6.exe tool. 
Windows Firewall is a stateful IPv4 and IPv6 firewall in Windows Vista, Windows XP with SP2 and later, 
Windows Server 2008, and Windows Server 2003 with SP1 and later. Windows Firewall drops 
unsolicited incoming or outgoing traffic that has not been explicitly allowed. 
ICF is a stateful IPv4 firewall provided with Windows XP with no service packs installed, Windows XP 
with SP1, and Windows Server 2003 with no service packs installed. 
Basic Firewall is a feature of Routing and Remote Access for Windows Server 2003 with no service 
packs installed that functions as a stateful IPv4 firewall for public interfaces. 
By using IP packet filtering in Routing and Remote Access, you can specify the exact set of IPv4 traffic 
that is either allowed or discarded for both incoming and outgoing packets on a per-interface basis. 
By using TCP/IP filtering, you can specify exactly which types of incoming IPv4 traffic destined for a 
computer are processed for each interface 
You can perform IPv6 packet filtering with Windows Firewall, IPv6 packet filtering with Routing and 
Remote Access, the basic IPv6 firewall, and IPv6 ICF. 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 396 
Chapter Glossary 
AH – See Authentication Header. 
Authentication Header – A header that is placed between the IP header and the payload and that 
provides data integrity, data origin authentication, and anti-replay security services. 
Basic Firewall – A feature of Routing and Remote Access in Windows Server 2003 with no service 
packs installed that functions as a stateful IPv4 firewall for public interfaces. 
Encapsulating Security Payload – A header and trailer that is placed around an IP packet payload and 
that provides confidentiality (encryption), data integrity, data origin authentication, and anti-replay 
security services.  
ESP – See Encapsulating Security Payload. 
ICF – See Internet Connection Firewall. 
IKE – See Internet Key Exchange. 
Internet Connection Firewall – A stateful firewall built into Windows XP with no service packs, 
Windows XP with SP1, and Windows Server 2003 with no service packs. 
Internet Key Exchange – A protocol for authentication and key exchange between IPsec peers. 
IP filter – A description of network traffic can include source address, source mask, destination address, 
destination mask, protocol, source port, and destination port. 
IP packet filtering – A capability of Routing and Remote Access that you can use to specify the exact 
set of IPv4 traffic that is either allowed or discarded for both incoming and outgoing packets on a per-
interface basis. 
IPsec policy – A collection of rules and settings that you create to specify IPsec services. 
Rule – A list of IP filters and a collection of security actions that occur when a packet matches a filter. 
SA – See security association. 
security association (SA) – A combination of a mutually agreeable policy and keys that defines the 
security services, mechanisms, and keys used to help protect communication between peers. A main 
mode SA helps protect one or more quick mode negotiations. A quick mode SA helps protect the traffic 
that it carries in one direction between IPsec peers. 
Security Parameters Index (SPI) – A unique, identifying value in an SA that distinguishes among 
multiple security associations that exist at the receiving computer. For example, IPsec communication 
between two computers uses two SAs on each computer. One SA is for inbound traffic, and the other is 
for outbound traffic. Because the source and destination addresses for the two SAs are the same, the 
SPI distinguishes between the inbound and outbound SA. 
SPI – See Security Parameters Index. 
TCP/IP filtering – A capability of the Internet Protocol Version 4 (TCP/IPv4) or Internet Protocol 
(TCP/IP) component of Windows Server 2003 and Windows XP that you can use to specify exactly 
which types of incoming locally destined IPv4 traffic is processed for each interface. 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 397 
Windows Firewall – A stateful IPv4 and IPv6 firewall built into Windows Vista, Windows XP with SP2 
and later, Windows Server 2008, and Windows Server 2003 with SP1 and later. 
Chapter 13 – Internet Protocol Security and Packet Filtering 
TCP/IP Fundamentals for Microsoft Windows  
Page: 398 
Chapter 14 – Virtual Private Networking 
TCP/IP Fundamentals for Microsoft Windows  
Page: 399 
Chapter 14 – Virtual Private Networking 
Abstract 
This chapter describes the virtual private network (VPN) technologies included with Microsoft Windows operating 
systems to connect remote users to an intranet or to connect remote offices to each other. As a network administrator, 
you must understand how to configure and use VPN connections so that you can leverage the global connectivity of the 
Internet to provide ubiquitous, yet relatively secure, connectivity. 
Chapter 14 – Virtual Private Networking 
TCP/IP Fundamentals for Microsoft Windows  
Page: 400 
Chapter Objectives 
After completing this chapter, you will be able to: 
Define a virtual private network (VPN) in terms of its benefits, components, and attributes. 
Describe the two types of VPN connections and how routing works for each. 
Explain the roles of the different VPN protocols, including Point-to-Point Protocol (PPP), Point-to-Point 
Tunneling Protocol (PPTP), Layer Two Tunneling Protocol with Internet Protocol security (L2TP/IPsec), 
and the Secure Socket Tunneling Protocol (SSTP). 
Describe the process for creating a PPP connection, a PPTP connection, an L2TP/IPsec connection, 
and an SSTP connection. 
Configure remote access and site-to-site VPN connections. 
Describe the use of Remote Authentication Dial-in User Service (RADIUS) for VPN connections and 
use either Network Policy Server (NSP) or Internet Authentication Service (IAS) as a RADIUS server 
and proxy. 
Chapter 14 – Virtual Private Networking 
TCP/IP Fundamentals for Microsoft Windows  
Page: 401 
Virtual Private Networking Overview 
A VPN extends a private network to encompass links across shared or public networks like the Internet. 
By using a VPN, you can send data between two computers across a shared or public internetwork in a 
manner that emulates the properties of a point-to-point private link. The act of configuring, creating, and 
using a VPN is known as virtual private networking. 
To emulate a point-to-point link, data is encapsulated, or wrapped, with a header that provides routing 
information that allows packets to traverse a shared or public internetwork. To emulate a private link, 
the data being sent is encrypted for confidentiality. Anyone who intercepts packets on the shared or 
public network cannot decipher them without the encryption keys. The logical link over which private 
data is encrypted is known as a VPN connection. 
By using VPN connections, users working at home or on the road can connect to an organization server 
from a remote location using the infrastructure that a public internetwork, such as the Internet. From the 
user's perspective, the VPN is a logical point-to-point connection between a computer (the VPN client) 
and an organization server (the VPN server). 
Organizations that use VPN connections can create routed site-to-site connections with geographically 
separate offices or with other organizations over a public internetwork while maintaining relatively 
secure communication. A routed VPN connection across the Internet logically operates as a dedicated 
wide area network (WAN) link. 
For both remote access and routed connections, organizations that configure, create, and use VPN 
connections can replace long distance dial-up or leased lines with local dial-up or leased lines to an 
Internet service provider (ISP). 
Components of a VPN 
A Windows-based VPN includes the following components: 
VPN server 
A computer that accepts remote access or site-to-site connections from VPN clients. 
VPN client 
A computer that initiates a connection to a VPN server. A VPN client can be an individual computer 
that initiates a VPN connection from a remote location (called a remote access VPN connection) or 
a router that initiates a site-to-site VPN connection. Computers running Windows can create remote 
access VPN connections to a server running Windows. A computer running Windows Server 2008 
or Windows Server 2003 can create site-to-site connections to a server running Windows Server 
2008 or Windows Server 2003. Clients from companies other than Microsoft can also create remote 
access or site-to-site connections to VPN servers running Windows Server 2008 or Windows 
Server 2003 as long as the clients support PPTP or L2TP/IPsec. 
Tunnel 
The portion of the connection in which data is encapsulated. 
VPN connection 
Chapter 14 – Virtual Private Networking 
TCP/IP Fundamentals for Microsoft Windows  
Page: 402 
The portion of the connection in which data is encrypted. You can send data through a tunnel 
without encryption, but this configuration is not a VPN connection because you would send private 
data across a shared or public network in an unencrypted and easily readable form. 
In most cases, the tunnel and the VPN connection are defined between the same two endpoints: 
the VPN client and the VPN server. However, there are configurations known as compulsory 
tunnels in which the tunnel is defined between a dial-up service provider's tunnel server and the 
VPN server and the VPN connection is defined between the client and the server. 
Tunneling protocols 
Communication standards for managing tunnels and encapsulating private data. Windows 
Server 2003 and Windows XP include the PPTP and L2TP tunneling protocols. Windows Vista with 
Service Pack 1 and Windows Server 2008 also include the SSTP tunneling protocol. For detailed 
information about these protocols, see "Point-to-Point Tunneling Protocol (PPTP)," "Layer Two 
Tunneling Protocol with Internet Protocol Security (L2TP/IPsec)," and “Secure Socket Tunneling 
Protocol (SSTP)” later in this chapter. 
Tunneled data 
Data that is sent through a VPN tunnel. 
Transit internetwork 
A shared or public internetwork crossed by encapsulated data. For Windows, the transit 