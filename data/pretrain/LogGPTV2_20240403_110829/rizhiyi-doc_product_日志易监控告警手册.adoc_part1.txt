= 日志易监控告警手册
北京优特捷信息技术有限公司
v4.1, 2021-11-09
== 监控告警概述
监控告警是日志管理系统的重要功能，您可以让日志易轻松替您监控数据，我们可以把搜索语句按预设计划周期性执行，当监控数据结果满足触发条件时，日志易将生成对应的告警事件，并通过指定的告警推送方式及时通知您。
通常的告警方式是电子邮件，不过日志易也支持syslog和HTTP转发等的其他灵活方式。
监控同样归属在日志易权限管理系统下，不同角色的用户分别具有不同监控资源的增删改查权限。您可以在“角色权限”设置页编辑具体监控资源的授权。有关权限管理系统的更多内容，请参阅《日志易使用手册》相关章节。
监控和定时任务等后台任务在执行时, 日志易后台会定时刷新获取任务状态，刷新状态操作的间隔时间是5s。
配置监控时的主要内容：
* 常规信息：所选择的搜索，监控名称及描述；
* 告警类型：根据所选择的告警类型配置数据统计方式及触发条件；
* 告警阈值：按预设的时间周期性检测，如果预设时间范围内搜索结果计数达到预设的告警条件，就触发告警；
* 告警方式：配置多种通知方式发送给用户。
监控配置示例：
如果apache 访问日志中出现状态码为500的情况，已存搜索配置如下：
 apache.status:500
如果每分钟响应时间大于3s的次数大于5次，已存搜索配置如下：
 json.response_time:[3 TO *] 
如果30分钟内error次数超过10次，已存搜索配置如下
 apache.status:500 OR json.exception:error
== 配置监控
日志易当中有两种方式开始配置监控：
1. 单击搜索界面右边的“新建监控”。
2. 也可以在监控管理页面新建监控，或者快捷复制一个现有的监控。支持在列表页快速点击打开对应的搜索内容。
配置监控都需要填写以下信息，其中分为常规信息、监控执行、高级配置、告警方式四部分。
=== 常规信息
1.	名称
您可以自由命名监控的名称，监控被触发时将推送此名称的告警。
2.	资源标签
为监控选择标签，可以完成过滤功能。
3.  所属应用
为监控选择应用，以便在应用中查看监控。
4. 资源授权
讲监控授权给用户、用户分组、角色。
5. 运行用户
为监控选择运行用户，默认是当前登录用户。
6. 是否启用监控
默认启用监控。
7. 是否仅在交易日执行
默认禁用。在系统设置上传交易日文件后，可以选择是否在交易日执行并按需选择交易日历。如果未在系统设置启用交易日功能，则此功能不可见。
8. 高基模式
设置是否启用高基模式，默认不启用。如果您输入的spl是海量分组统计或去重数精准统计问题，建议您启用高基模式。
+
如果监控页面没有此选项，请查看manager上是否正确启动了flink相关模块实例。只有flink在运行时，用户才可以在此页面看到并选择是否启用高基模式。
=== 监控执行
监控执行区域主要根据监控类型的不同，配置具体的监控内容和执行计划。配置包括：
1. 监控类型
支持事件数监控、字段统计监控、连续统计监控、基线对比监控、SPL统计监控等 5 种定时执行类监控，和流式匹配监控、流式聚合监控等 2 种流式执行类监控。注意，流式执行类监控，只有在 flink 模块正确启动的前提下才能使用。
2. 描述
为监控做简短的描述，以便您能记起设置监控的原因。描述文案支持引用最后的告警变量。变量列表和模板语法与告警插件相同。了解细节可阅读后续章节。此外，日志易为不同告警类型内置了不同的默认描述模板。如图：
+
image::images/alert-desc-default.png[]
3. 定时执行类的搜索内容
您可以从已存搜索中选择一个作为监控范围使用，日志易将提供已存搜索列表供您选择；如果您正在进行搜索，并决定使用当前搜索建立监控，请直接点击创建监控按钮，进一步创建监控范围。
您也可以直接在搜索内容输入框内，手写SPL搜索语句，或点击"添加数据集"选择所需的数据集。
4. 定时执行类的执行计划：您可以选择简单的时间单位，填写数字。如10秒，5分钟等。日志易同时支持crontab时间格式配置格式。格式: `[秒] [分] [小时] [日] [月] [周] [年]`。填写完成后，可以点击"解析"查看未来 10 次的计划执行时间。
点击展开更多计划配置后，可以配置运行计划的优先级和启动窗口：
* 优先级：可以设置监控任务的优先级为默认、更高和最高。
* 启动窗口：不同任务可以在启动窗口的许可范围内，随机打散任务启动点，平摊系统负载。有权限的用户可以设置监控任务的启动窗口为无、5/15/30分钟、1/2/4/8小时、自动或自定义时间窗口。当选择自动时，日志易系统将根据任务的历史运行耗时来自动确定监控的最佳窗口配置。
+
[options="header"]
|========
|序号|说明|是否必填|允许填写的值|允许的通配符
|1
|秒
|是
|0—59
|, - * /
|2
|分
|是
|0—59
|, - * /
|3
|小时
|是
|0—23
|, - * /
|4
|日
|是
|1—31
|, - * ? / L W
|5
|月
|是
|1—12or JAN-DEC
|, - * /
|6
|周
|是
|1—7or SUN-SAT
|, - * ? / L #
|7
|年
|否
|empty 或 1970-2099
|, - * /
|========
+
.通配符说明
****
* * ：表示所有值. 例如:在分的字段上设置 "*",表示每一分钟都会触发。
* ? ：表示不指定值。使用的场景为不需要关心当前设置这个字段的值。例如:要在每月的10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为"?" 具体设置为 0 0 0 10 * ?
* - ：表示区间。例如 在小时上设置 "10-12",表示 10,11,12点都会触发。
* , ：表示指定多个值，例如在周字段上设置 "MON,WED,FRI" 表示周一，周三和周五触发
* / ：用于递增触发。如在秒上面设置"5/15" 表示从5秒开始，每增15秒触发(5,20,35,50)。 在日字段上设置'1/3'所示每月1号开始，每隔三天触发一次。
* L ：表示最后的意思。在日字段设置上，表示当月的最后一天(依据当前月份，如果是二月还会依据是否是润年[leap]), 在周字段上表示星期六，相当于"7"或"SAT"。如果在"L"前加上数字，则表示该数据的最后一个。 例如在周字段上设置"6L"这样的格式,则表示“本月最后一个星期五"
* W ：表示离指定日期的最近那个工作日(周一至周五). 例如在日字段上设置"15W"，表示离每月15号最近的那个工作日触发。如果15号正好是周六，则找最近的周五(14号)触发, 如果15号是周未，则找最近的下周一(16号)触发.如果15号正好在工作日(周一至周五)，则就在该天触发。如果指定格式为 "1W",它则表示每月1号往后最近的工作日触发。如果1号正是周六，则将在3号下周一触发。(注，"W"前只能设置具体的数字,不允许区间"-").'L'和 'W'可以一组合使用。如果在日字段上设置"LW",则表示在本月的最后一个工作日触发
* # ：序号(表示每月的第几周星期几)，例如在周字段上设置"6#3"表示在每月的第三个周星期六.注意如果指定"6#5",正好第五周没有星期六，则不会触发该配置(用在母亲节和父亲节再合适不过了) 周字段的设置，若使用英文字母是不区分大小写的 MON 与mon相同.
****
+
示例：
+
----
格式: [秒] [分] [小时] [日] [月] [周] [年]
0 0 12 * * ?       每天12点触发  0 15 10 ? * *      每天10点15分触发  0 15 10 * * ?      每天10点15分触发   0 15 10 * * ? *     每天10点15分触发   0 15 10 * * ? 2016     20165年每天10点15分触发  0 * 14 * * ?       每天下午的 2点到2点59分每分触发  0 0/5 14 * * ?       每天下午的 2点到2点59分(整点开始，每隔5分触发)   0 0/5 14,18 * * ?     每天下午的 18点到18点59分(整点开始，每隔5分触发)
----
+
5. 告警等级
用户可以选择添加告警等级，对定时执行类监控，可以定义不同的阈值，不同的告警等级对应不同的阈值范围。如下图所示，当cnt取值在0-1000之间，不触发告警；在1000到10000之间，触发低等级告警；在10000到100000之间，触发中等级告警；在100000以上，触发高等级告警。
在监控列表页上，对多等级的监控运行状态，系统将采用不同颜色的趋势图展现最近24次的运行结果。如下图所示：
image::images/monitor-list.png[]
颜色方案如下：
* 灰色：未触发
* 绿色：低级
* 黄色：一般
* 橙色：中级
* 红色：重要
* 紫色：严重
* 无：未运行
如果当次运行结果达到触发条件但被抑制，展示颜色稍加透明。
而流式执行类监控，只能定义统一等级，且无法在监控列表页上记录展现最近的运行结果。
不同监控类型的触发条件差别较大，以下将分章节讲述。
==== 事件数
您可以创建基于搜索结果的告警触发条件，在一个给定的时间范围内触发告警的阈值数。例如，您可以设置告警触发条件为：5分钟内搜索结果计数超过10次时触发低级别告警：
image::images/alert-events-config.png[]
如果配置时还不太了解实际数据情况，可以点击触发条件下方的"数据预览"，展开预览当前搜索内容和执行计划下的实际数据折线图，并对照图形合理调整阈值配置。您也可以点击预览图右上角的时钟图标，调整数据的时间范围。注意：预览数据受系统设置限制，可能展示不完整。
image::images/alert-events-config-trend.png[]
事件数监控类型支持设备切分，您可以输入需要切分的字段，可以填写多个字段，逗号分隔。对应的spl是:
  `* | stats count() by 切分字段`
一次执行可能分别发送多条告警邮件，告警恢复邮件也是分开发送。告警记录页面，趋势图显示多条折线图，监控列表页的sparkline上，只记录第一行(也就是最大的那个)的count数。
==== 字段统计
字段统计为您提供针对字段内容的告警设置，在触发条件中您需要填写字段名，统计方式可以在下拉框中选择，分组事件数、总和、平均数、去重数、最大值、最小值。其中，分组事件数是采用 `|stats count() by NAME` 方式，对每个字段值分组的计数进行逐一阈值比对。
例如，触发条件为：apache.req_time在5分钟之内的平均值大于0.5时触发低等级告警，则设定如下：
image::images/alert-stats-config.png[]
字段统计监控类型支持设备切分，您可以输入需要切分的字段，例如上图对应的spl是`* | stats dc(统计字段) by 切分字段`；一次执行可能分别发送多条告警邮件，告警恢复邮件也是分开发送。告警记录页面，趋势图显示多条折线图，监控列表页的sparkline上，只记录第一行(也就是最大的那个)的count数。
==== 连续统计
连续统计为您提供连续统计触发告警功能，即当某个告警条件在某个时间内连续触发次数达到阀值，才触发告警。
例如，触发条件为：apache.status在1小时之内超过404的次数超过100，则触发中等级告警，则设定如下：
image::images/alert-continue-config.png[]