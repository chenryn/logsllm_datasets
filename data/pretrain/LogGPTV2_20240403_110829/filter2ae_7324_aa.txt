**作者：PIanet  
招高级安全分析 反APT研究 威胁情报 PI:EMAIL  
原文链接：[https://projectsharp.org/2020/02/23/APT%20%E5%88%86%E6%9E%90%E5%8F%8A%20TTPs%20%E6%8F%90%E5%8F%96/?from=groupmessage&isappinstalled=0](https://projectsharp.org/2020/02/23/APT%20%E5%88%86%E6%9E%90%E5%8F%8A%20TTPs%20%E6%8F%90%E5%8F%96/?from=groupmessage&isappinstalled=0)**
## Abstract
本文对 APT 分析及 TTPs 提取进行讨论，总结出一套适用于安全分析、安全研究及企业应急响应人员的分析方法。
文章由六部分组成，引用了杀伤链模型，钻石分析模型，ATT&CK 等内容，介绍了攻击事件、APT 攻击的一些概念，简单概括了 “通过攻击者能力切入” 和
“通过基础设施切入” 的两种 APT 事件分析的方法。着重探讨了 TTP 的提取、使用、应用、落地及归因判断。提出了 “特征矩阵” 和
“事件链图”，设计了描述模型，同时进行了简单的可行性论证。
内容适用于具有一定经验的安全分析师，病毒分析师，威胁情报分析师等安全人员。
## 0x00 攻击事件
什么是攻击事件？
个人理解，攻击事件是在未授权情况下，对计算机系统或计算机资源进行访问、使用、更改、破坏的活动。根据事件烈度和影响范围，可以分为以下几类：
  * 常规攻击
  * Botnet
  * 恶意软件
  * APT
### 0x00-01 攻击事件甄别
对攻击事件，可以从烈度、影响、指向以及特点等维度进行甄别。
  * 常规攻击
常规攻击一般事件复杂度低，杂音少，线性且可直接推测出攻击目的。其中包括非定向钓鱼，端口，服务扫描，SQL
注入，拒绝服务攻击，会话劫持和中间人攻击，凭证重放等。此类型事件，影响少，危害可控且可在短时间内进行排查修复。
  * Botnet
僵尸网络的特点就是大规模攻击，数据说话，涉及到RAT。比如 Necurs、Gafgyt、Mirai 僵尸网络上的垃圾邮件、DDoS 等。
  * 恶意软件
恶意软件指一些勒索、挖矿以及病毒木马。涉及钱包、矿池；目的不同，会包含 RAT；不同的入口，也会出现标志性的工具和利用。比如 WannaCry、Bad
Rabbit、大量 MikroTik 路由器被感染进行恶意挖矿等。
  * APT
APT 攻击时间复杂度高，多个行为，多个指纹身份；有 loader、有Downloader、有 RAT、有
Malware。在所有攻击事件中是最难分析的一类。知名的 APT 组织：海莲花、摩诃草、APT28、Lazarus Group 等。APT
的目标通常是监视网络活动并窃取数据，而不是破坏网络或系统。
### 0x00-02 攻击事件的核心元素
借用钻石模型中的概念，每一起攻击事件（Event）都包含四个核心元素：攻击者（Adversary）、受害者（Victim）、能力（Capability）和基础设施（Infrastructure）。
  * 攻击者：攻击事件的直接执行者 在一些大型的攻击事件中，攻击组织有完善的人员体系结构，这里所说的攻击者，是事件的直接操作者。
  * 受害者：攻击者的目标 不同类型的的攻击事件中受害者表现也不同，可能是一台主机、一个企业或者一个机构。
  * 能力：使用的工具或者技术
能力是事件中攻击者所使用技术或者工具。从探查到最终目的达到，“技术”存在攻击过程的每一个阶段。
  * 基础设施：攻击者维持权限控制的通道或者载体。 基础设施可以理解为攻击的 C2 通道，可以分为三类：① 攻击者购买拥有 ② 攻击者攻陷的 ③ 使用的第三方平台或者服务。
每一起攻击事件，都有一个攻击者通过基础设施上的能力对受害者产生影响，进而达成某种目的。所有攻击事件都是围绕这四者进行展开的。
在这四核心元素之上，又可以衍生出 “技术”，“社会” 维度，指导安全分析。在此不再展开，之后会单独做一个专题，使用钻石模型进行事件分析。
## 0x01 APT
APT (Advanced Persistent Threat)，翻译为高级持续威胁。这类攻击报告，最早可以追溯到 2005 年 6
月，英国国家基础设施安全协调中心 (UK-NISCC) 和美国计算机应急响应小组 (US-CERT)
发布了技术警报公告，其中描述了有针对性的社交工程电子邮件，这些电子邮件包含特洛伊木马进行窃密。(LM White Paper Intel
DrivenDefense）
这个概念炒了好几年，不同身份角色，站在不同角度都有自己的理解，就不过多解读。文章以下内容，限定在国家及组织对抗的 APT 攻击场景。
### 0x01-00 APT 攻击的特点
国家及组织对抗的 APT 有以下几个特点：
  * 攻击目的性强，为了达到目的不择手段。
  * 雄厚的支持
分析中发现有大量漏洞利用和定制化工具使用，这反应出 APT 攻击需要耗费巨大的人力、物力。攻击者往往有政府或财团支持。
  * 目标价值高
与投入相匹配，APT 攻击的目标价值往往也十分高，其攻击领域有：政府部门、军事部门、基础设施、金融机构、教育科研机构和大型企业等。
  * 时间复杂度高
APT 攻击的另一个特点就是，时间复杂度高，持续时间长。即使有报告对 APT 组织进行披露，导致之前的攻击手段失效，但只要目标的价值还在，那么攻击还会发生。
### 0x01-01 APT 入侵的方式
APT 攻击入侵的方式主要有：鱼叉式钓鱼、IM、水坑攻击、钓鱼网站、1/N day 漏洞、0 day
漏洞和物理接触。入侵包括载荷投递和突破防御两个阶段，各种入侵方式的成本如下图：
入侵方式金字塔，从下到上，入侵成本和危害程度逐层递增。
处于金字塔最底层的是鱼叉式钓鱼邮件和即时通讯软件，它是最常见、入侵成本最低的攻击方式。攻击者常常以鱼叉邮件做为攻击入口，精心构造邮件标题、正文和附件。用来投递恶意网址、伪装文件或者含有漏洞利用的文档。IM
与鱼叉邮件钓鱼类似。水坑攻击和钓鱼网站也是常见 APT 攻击入侵方法。侵入网站，加入恶意 JS
伪装更新；或者通过推特、fb、论坛上面通过发布、评论、转发等方式进行社交平台的水坑攻击。还可以制作钓鱼网站，通过邮件、IM、水坑等方式投递给受害者，窃取账号密码、收集主机信息或者诱惑下载恶意软件。这两种入侵方式的成本也不高。
防御边界的渗透攻击，针对的是受害系统、业务的防御边界，进行常规的渗透攻击，例如常见的 SQL
注入，文件上传，跨站脚本攻击、跨站请求伪造等。此类入侵方式较常规网络攻击并无不同，入侵的目的是突破防御边界，找到稳定且隐蔽的入口，渗透攻击在 APT
攻击中也是比较常见的。
再往上，就是漏洞利用。漏洞利用的目的有两点：未授权安装、运行代码和规避杀软检测。其中 0 day 漏洞危害和成本要远大于 1/N day 漏洞。各种 APT
攻击中，出现过许多操作系统漏洞、路由器或交换机网络设备漏洞，以及 office，Flash，PDF
等应用漏洞。此种攻击往往搭配其他手法，组合进行入侵。例如容器漏洞在渗透攻击中的利用，以及 Office 漏洞在钓鱼中的利用。
漏洞入侵之上是供应链攻击，典型的例子如 XSHELL
、CCleaner、华硕软件更新劫持等攻击事件。在突破上游供应商后，在极短的时间内进行资产摸排、更改、下发、劫持。又同时可以顺利筛选、控制下游目标。整套流程下来，及其考验攻击组织的技术能力，协调能力，后勤能力及储备和信息收集能力。
最顶层是物理接触，典型的攻击事件：“震网”。这种比较少见，不多说。
APT 攻击是否成功，取决于攻击者的目的和所具有的入侵能力，与目标防御强弱无关。防御强弱和目标的价值决定了入侵的方式。漏洞利用，特别是 0 day
漏洞都是针对高价值，特定目标，考虑到入侵成本，APT 攻击更倾向于其他的入侵方式。
## 0x02 APT 事件分析
在事件分析的初期，我们拿到的线索是破碎零散的，这些线索只是攻击者为了达成目的采取的手段，我们做安全分析，其实是对攻击手段上下文的描述。
事件有四个核心元素，攻击者、受害者、基础设施和能力。我们分析 APT，可以从受害者、基础设施和能力三个角度进行切入。具体方法分为两种。
### 0x02-00 APT 两种分析方法
### 通过攻击者“能力”切入分析：