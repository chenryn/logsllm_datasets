# 技术分享：逆向分析Aura睡眠闹钟

### 译文声明
本文是翻译文章，原文来自courk.fr。译文仅供参考，具体内容及含义请以原文为准。
**  
**
**译者信息**
- 译者：[WisFree](http://bobao.360.cn/member/contribute?uid=2606963099)
- 预估稿费：200RMB
- 投稿方式：发送邮件至linwei#360.cn 或 登录网页版在线投稿

### 前言
最近，我收到了一款名为 **Aura** 的设备，该产品由Withings设计、生产和销售，定位为联网睡眠闹钟。Aura不仅仅是一个简单的闹钟，它还集成了Spotify音乐流媒体服务，允许用户根据个人喜好选择助眠和唤醒音乐。此外，Aura内置了多种传感器，能够监测并分析用户的睡眠环境和参数。其上部设有一个LED灯，支持触控操作，通过模拟日出的光线变化和播放悦耳音乐来减轻起床时的不适感。

出于以下原因，我对这款设备进行了逆向工程：
1. 这将是一次充满乐趣且学习机会丰富的体验。
2. 我希望能够完全“掌控”这台设备，让自己的代码在其上运行。

本文详细记录了对Aura进行逆向分析的过程，包括固件镜像获取与远程缓冲区溢出漏洞利用方法。
**注**：已与厂商取得联系，通报了本文中涉及的安全问题。事实上，部分安全漏洞厂商之前已经知晓，并正在修复剩余的问题。本文不会提供Aura的固件镜像、完整代码文件或脚本，所有内容仅用于教育目的。

### 初步分析
首先，为了更好地了解Aura硬件配置，在不拆解设备（价格约1200元人民币）的前提下，我查阅了FCC验证报告。报告显示Aura使用了一款Freescale处理器，并运行嵌入式Linux系统。由于Aura需要持续连接WiFi，因此我用nmap扫描了设备开放的端口，发现SSH服务器处于可响应状态，但没有有效的密码或密钥则无法访问。从蓝牙方面来看，Aura可通过蓝牙发现，运行着SDP服务器，表明某些服务正在进行中。

### 固件获取
为进一步深入分析，我需要获得设备的固件文件。在固件更新过程中设置了一个中间人代理来捕获网络通信数据，发现Aura似乎使用HTTP协议下载固件镜像文件。

### 固件镜像分析
#### 文件系统提取
下载得到的镜像文件开头部分显示为一个头部信息，后续转换为FPKG格式。利用binwalk工具快速识别出有价值的数据段，揭示了包含UBIFS文件系统的镜像。借助jrspruitt提供的脚本，可以轻松地从UBIFS镜像中提取文件，使我们能够访问整个嵌入式Linux系统的文件结构。尝试破解/etc/shadow中的密码未果后，转向研究FPKG文件格式。

#### FPKG文件格式
与固件更新及FPKG文件相关的函数存在于libfpkg.so和libufw.so两个共享库中。经过反编译，得到了文件结构描述。然而，此文件经过签名处理，无法直接用于更新固件。

### 获取Root SSH访问权限
通过对代码执行过程的观察，寻找潜在的安全漏洞。注意到seqmand守护进程负责自动从远程服务器下载音频文件。利用目录遍历攻击，成功重写了/var/service/sshd/run脚本，从而获得了root级别的SSH访问权限。

### 蓝牙与远程代码执行
进一步分析揭示了Aura蓝牙功能中存在的缓冲区溢出漏洞，允许攻击者通过蓝牙协议执行恶意代码。相关演示视频链接已在原文中给出。

### 总结
得益于Aura HTTP流量未经加密的特点，使得获取系统固件变得相对容易，进而发现了两个安全漏洞：一是通过MITM攻击获得SSH root权限；二是更为严重的蓝牙缓冲区溢出漏洞。所幸这些问题均已得到妥善解决。更多详情，请参阅原始文献。

**附京东购买链接**：只需2999元即可拥有Aura睡眠闹钟！