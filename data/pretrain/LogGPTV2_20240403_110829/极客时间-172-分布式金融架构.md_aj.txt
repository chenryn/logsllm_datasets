# 06 计算输入的正确性：如何选择正确时间的数据？

你好，我是任杰。从今天开始，我们将进入第二个模块：系统正确性保障。在第一个模块“金融业务及系统”中，我们探讨了常见的金融业务、盈利模式以及对系统工具的要求，并介绍了**领域驱动设计**这一在金融行业中行之有效的方法论。

然而，领域驱动设计仅提供了顶层设计层面的指导，而未涉及具体实践中的实施细节。因此，在本模块中，我们将重点解决如何确保金融系统的最重要要求——正确性。正如“巧妇难为无米之炊”，如果处理金融业务时使用了错误的数据，那么计算结果将毫无意义。因此，正确的数据是所有正确性的基础。接下来，让我们一起探讨如何解决正确性的首要问题：如何选择正确时间的数据。

### 业务案例

为了更好地理解技术解决方案，先来看一个金融业务的例子。在国外，有一种金融机构被称为养老基金，负责管理人们的养老保险。由于养老基金的收益通常在退休后才能获得，其最重要的衡量指标之一便是能否在未来提供足够的生活费用。考虑到生活成本逐年上涨，一个可能的衡量标准是养老基金每年的收益率是否能超过通货膨胀率（CPI, Consumer Price Index）。

通货膨胀率每月公布一次，但其特点是数据公布的时间延迟较长。当前只能发布预期值，实际数值可能要几个月后才公布，并且可能会被修正。例如，在下面的例子中，2018年3月和6月的通货膨胀率分别在一个月后公布，并在之后进行了多次修正。

![](https://static001.geekbang.org/resource/image/bf/2b/bf56d6f1beyy37a8986527de876e132b.png)

面对这种情况，如何确保每次数据更新不会影响之前已完成的金融业务？这个问题看似简单，但在复杂的背景下却变得非常棘手。金融公司面临成千上万种金融数据，而且像保险这样的业务一旦签署就可能持续数十年，期间公司的信息系统会发生巨大变化。如果你是金融公司的CTO，当有人拿着30年前的养老保险投诉说通货膨胀率用错了，你如何证明合同数据的正确性？或者作为CFO，如果你想分析2018年3月的通货膨胀率对保险合同价格的影响，又如何保证只使用了更新后的该月份数据而不是其他月份的数据？

这些问题凸显了金融公司数据正确性的管理挑战。你需要确保业务、运营、财务、合规等各部门的信息系统都采用统一的数据访问方式，这种访问方式还必须具备可重现性。无论经过多少年或系统更新换代多少次，都能准确追溯过去发生的情况。这就是为什么这节课的主题叫作“正确时间”。

### 双时序数据库

对于大型金融机构而言，寻找一种能够满足所有部门长期需求的数据使用方案至关重要。在金融系统中，双时序数据库正是为此而生。需要注意的是，**双时序数据库和领域驱动设计一样，主要用于解决复杂问题**，特别适用于机构金融业务而非普惠金融业务。

#### 双时序坐标轴

从前面的例子可以看出，一个金融数据有两个时间维度：一个是数据对应的业务发生时间，另一个是数据的修改时间。在双时序数据库中，这两个时间分别称为**发生时间（Valid Time, VT）**和**记录时间（Transaction Time, TT）**。

与单时序数据库不同，双时序数据库不仅解决了数据增加的问题，还解决了数据修改的问题。下图展示了双时序数据库的时间逻辑，其中横轴表示记录时间，纵轴表示发生时间。

![](https://static001.geekbang.org/resource/image/54/7d/54da2ba123ayy1cb7338f0bb7ed44d7d.png)

#### 数据可见范围

根据之前的例子，我们在2018年4月收到了2018年3月的通货膨胀率数据。这个数据对应于坐标系中的一个点（2018年4月，2018年3月），并在系统内有一个可见范围。

![](https://static001.geekbang.org/resource/image/f1/d0/f1db234f264059yy5a95331923ef37d0.png)

可见范围指的是数据既存在且有意义的时间范围。查询双时序数据库时需要同时提供发生时间和记录时间。下图展示了四种查询范围，只有在粉红色方块内的查询可以查到数据。

![](https://static001.geekbang.org/resource/image/6c/63/6c897760cb58c167e04683ee4f6efc63.png)

随着数据的不断更新，新的可见范围会覆盖旧的可见范围。例如，2018年7月收到的2018年6月的通货膨胀率数据会在坐标系中形成一个新的点，并产生新的可见范围。

![](https://uploader.shimo.im/f/sLSlYm6i106s2qS7.png!thumbnail)

再比如，2018年9月更正了2018年3月的通货膨胀率数据，这会在坐标系中形成第三个点，并进一步调整可见范围。

![](https://static001.geekbang.org/resource/image/18/c5/189f8f62aa3071cb43c02e1048f48fc5.png)

可见范围的定义是基于查询的结果来确定的。当我们查询数据时，关心的是离当前查询时间点最近的合理数据。这里的“合理”指的是数据既存在且有意义，“最近”则指发生时间最晚的数据。

![](https://static001.geekbang.org/resource/image/e3/34/e350415782fde172e585b08ea24bd334.png)

### 优缺点分析

了解了双时序数据库的基本原理和使用方法后，我们还需要知道它的优缺点，以便在设计之初做出合理的判断。

#### 优点

- **数据不变性**：金融行业要求数据不可被覆盖和篡改，双时序数据库通过唯一标识符（记录时间和发生时间）确保数据的不变性。
- **数据唯一性**：每个数据都有唯一的标识符，确保数据的可见范围也是唯一的。这为数据的正确使用提供了保障。

#### 缺点

- **学习成本高**：开发人员需要理解二维情况下的数据可见范围，有时甚至需要向业务方和产品经理解释。
- **执行速度慢**：相比单时序数据库，双时序数据库多了一个时间维度，导致插入和查询操作的额外索引开销较大，不适合延时要求极高的场景。

尽管如此，双时序数据库作为整个公司层面的数据正确性框架，能够降低出错的可能性，具有长远的价值。

### 理论与实际的区别

理论上，数据的可见范围可以是有限的。例如，房贷合同的有效期为30年，因此其可见范围是一个高度为30年的矩形。

![](https://static001.geekbang.org/resource/image/de/8f/de6bf3c396fa7a91b2785c09265d868f.png)

但在实际操作中，如果房贷合同期限发生变化，会导致多个有限的可见范围互相覆盖，使得定义和实现变得复杂。因此，实际应用中一般不推荐对发生时间做可见范围的约束，而是通过保存无效版本来覆盖原有的可见范围。

![](https://static001.geekbang.org/resource/image/e0/y8/e04e37dc56a4b2610b9036549a185yy8.png)

### 小结

通过本节课的学习，我们了解了如何使用双时序数据库来正确存储和查询金融数据。虽然双时序数据库看起来有些复杂，但它提供了一种金融级的数据正确性解决方案，尤其适用于规模大、历史悠久的金融机构。下一节课我们将学习事件溯源架构，以确保计算过程的正确性。

![](https://static001.geekbang.org/resource/image/85/df/856a5ca8c7964eda5edd0beec47f82df.jpg)

### 思考题

双时序数据库的一种存储方式是将坐标空间切割成尽可能多的矩形，并存储这些矩形。数据库的索引建立在矩形的左下角和右上角坐标点上。具体做法是每当坐标系内新增一个数据节点时，以这个点为中心进行水平和垂直切分。下图展示了系统中有三个数据点时的一种切割方式：

![](https://static001.geekbang.org/resource/image/a1/a0/a1bc85864e72888e9025efbcd96cd1a0.jpg)

你能计算一下这种方案的**存储空间复杂度**和**查询时间复杂度**吗？欢迎在留言区分享你的想法和疑问。如果有所收获，也欢迎转发给朋友和同事，共同交流学习。