219
---
## Page 232
吐能力也更强大，同时TUN模式可以支持跨网段，并支持跨地域部署，使用非常灵活。
软件可以快速搭建高可伸缩的、高可用的网络服务，管理也非常方便。
CentOS7系统管理与运维实战
220
此种技术负载均衡器只处理请求报文。由于结果不需经过负载均衡器，采用此种技术的集群吞
负载均衡器把请求报文通过IP隧道转发至真实服务器，而真实服务器将响应直接返回给客户，
地址重写，当客户请求越来越多时，负载均衡器的处理能力可能成为瓶颈。为了解决这个问题，
均衡器可能成为瓶颈。NAT模式体系结构如图8.2所示。
接收和返回都要经过负载均衡器，对前端负载均衡器性能要求较高，如业务请求量较大，负载
文的源地址被重写，然后返回给客户端，从而完成整个负载调度过程。由于NAT的每次请求
负载均衡算法将请求分配给后端的真实服务器。真实服务器的响应报文通过负载均衡器时，报
TUN模式如图8.3所示。采用NAT技术时，由于请求和响应报文都必须经过负载均衡器
此种技术中前端负载均衡器通过重写请求报文的目的地址实现网络地址转换，根据设定的
IPVS软件实现了这3种IP负载均衡技术，每种技术原理介绍如下。
2. Virtual Server via IP Tunneling (VS/TUN )
1.Virtual ServerviaNetworkAddressTranslation(VS/NAT)
VirtualServer
图8.2LVSNAT模式体系结构
---
## Page 233
网段机器数量有限，从而限制了其应用范围。
隧道协议的要求，但是此种模式要求负载均衡器与真实服务器都在同一物理网段上，由于同一
极大地提高集群系统的伸缩性。这种方法没有IP隧道的开销，真实服务器也没有必须支持IP
务器，类似TUN模式，DR模式下真实服务器将响应直接返回给客户端，因此VS/DR技术可
VS/DR模式如图8.4所示，该模式通过改写请求报文的MAC地址，将请求发送到真实服
3.Virtual ServerviaDirectRouting(VS/DR)
图8.4LVSDR模式体系结构
图8.3LVSTUN模式体系结构
第8章集群
221
---
## Page 234
集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。
称LBLCR。带复制的基于局部性最少链接调度算法也是针对目标 IP 地址的负载均衡，与
的服务器将承受较大比例的活动连接负载。
差异较大的情况下，负载均衡器采用加权最少链接调度算法优化负载均衡性能，具有较高权值
性能，采用此种算法可以较好地均衡负载。
网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统
负载均衡器可以自动问询真实服务器的负载情况，并动态地调整其权值，相比轮询模式，有更
据真实服务器的不同处理能力来调度访问请求，从而让处理能力强的服务器处理更多的请求。
务器的负载情况，需结合其他监控手段一起使用。
分配到集群中的真实服务器上，每台后端的服务器都是平等无差别的，此种算法忽略了真实服
8.2.2
CentOS7系统管理与运维实战
222
务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按最小连接原则从这个
LBLC算法的不同之处是要维护从一个目标IP地址到一组服务器的映射。该算法根据请求的
务器。
标IP地址最近使用的服务器，如该服务器是可用的且没有超载，将请求发送到该服务器；若
的最少链接调度算法是针对目标IP地址的负载均衡，该算法根据请求的目标IP地址找出该目
大的灵活性。
带复制的基于局部性最少链接（Locality-BasedLeastConnectionswithReplication）算法简
加权最少链接（WeightedLeastConnections）算法简称WLC。在集群系统中的服务器性能
最小链接（LeastConnections）算法简称LC。负载均衡器通过最少连接调度算法动态地将
加权轮询（WeightedRound Robin）算法简称WRR。负载均衡器通过加权轮询调度算法根
轮询（Round Robin）算法简称RR，负载均衡器通过轮询调度算法将外部请求按顺序轮流
针对不同的网络服务需求和服务器配置，IPVS负载均衡器提供了如下几种负载调度算法：
（6）带复制的基于局部性最少链接算法
基于局部性的最少链接（Locality-BasedLeastConnections）算法简称LBLC。基于局部性
（5）基于局部性的最少链接算法
（4）加权最少链接算法
（3）最少链接算法
（2）加权轮询算法
（1）轮询算法
负载均衡调度算法
---
## Page 235
所示。
缩性、高可用性和易管理性。一般来说，LVS集群采用三层结构，其体系结构一般如图8.5
明的，而且无须修改客户端和服务器端的程序。为此，在设计时需要考虑系统的透明性、可伸
组服务器构成一个高性能的、高可用可伸缩的虚拟服务器。整个服务器集群的结构对客户是透
将请求均衡地转移到不同的服务器上执行，且负载均衡器自动屏蔽掉服务器的故障，从而将一
送到该服务器，否则返回空。
作为散列键从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发
请求发送到该服务器，否则返回空。
作为散列键，从静态分配的散列表找出对应的真实服务器，若该服务器是可用的且未超载，将
LVS集群采用IP负载均衡技术和基于内容请求分发技术。负载均衡器具有很好的吞吐率，
源地址散列（Source Hashing）算法简称SH。源地址散列调度算法根据请求的源IP 地址，
目标地址散列（Destination.Hashing）算法简称DH。此调度算法根据请求的目的IP地址，
（8）源地址散列算法
（7）目标地址散列算法
LVS集群的体系结构
网
用户
企
图8.5负载均衡通用体系结构
图形监控软件
心跳线连接
服务器
·f
服务器2
服务器1
第8章集群
223
---
## Page 236
CentOS7系统管理与运维实战
224
息介绍基于NAT的Web集群配置。
同 IP 地址的并行网络服务变成在一个IP地址上的一个虚拟服务。根据上文提供的服务器信
信需求。不同IP地址的服务器组也认为其是与客户直接相连的。由此可以用NAT 方法将不
从而实现一个局域网只需使用少量IP地址即可实现私有地址网络内所有计算机与互联网的通
通过重写请求报文的IP地址（目标地址、源地址和端口等）将私有地址转换成合法的IP地址
8.4.1
到后端的真实服务器192.168.32.1或192.168.32.2上面，从而达到负载均衡的目的。
负载均衡器
例，说明LVS 负载均衡的配置方法，搭建LVS 相关的服务器信息如表8.1所示。
得服务器池拥有相同的内容，提供相同的服务。
测试域名
请求并返回结果。
客户认为服务是来自一个IP 地址上的。
Vip服务，客户请求到达该VIP后LD负责将客户的请求发送到后端的真实服务器上执行，而
NAT（NetworkAddress Translation）技术的出现有效缓解了IPv4地址空间不足的问题。
后端RS
虚拟IP
参数
．（3）共享存储（shared storage）是可选组成部分，主要提供一个共享的存储区，从而使
用户访问www.test.com时，会解析到192.168.32.150，然后负载均衡器通过算法将请求转
如今Web应用已经非常广泛，本节主要以搭建一组Web服务器并实现LVS的负载均衡为
（2）真实服务器池（real server pool）是一组真正执行客户请求的服务器，负责处理用户
（1）负载均衡器（load balancer）简称LD，是整个集群最外面的前端机，
负载均衡集群的通用体系结构一般主要有3个组成部分，分别为：
基于NAT模式的LVS的安装与配置
火墙、SELinux等都做了妥善的设置，
在开始所有配置之前，需要确认所有计算机上的LVS模块已加载（模块名为ip_vs）、防
LVS负载均衡配置实例
www.test.com
192.168.32.1、192.168.32.2
192.168.32.150
192.168.32.100、
说明
表8.1LVS实例相关信息
192.168.32.200
，任何环节设置不合理都会导致整个LVS无法工作。
上面部署一人
---
## Page 237
-LI-1
#
参数
过程如【示例8-1】所示。
-h
--stop-daemon
--start-daemon
-set
#
—A
ipvsadm常用参数说明如表8.2所示。
[root@Centos ipvsadm-1.26]#/sbin/ipvsadm -v
#确认ipvsadm安装成功
[root@Centos ipvsadm-1.26]#make
#解压源码包，在下载源码包时注意内核版本，下载对应的配置工具。
【示例8-1】
首先应该安装LVS 管理工具ipvsadm，本示例中采用的版本为 ipvsadm-1.26.tar.gz，安装
安装完毕后主要的程序有3个：
pvsadm v1.262008/5/15(compiled with popt and IPvs v1.2.1)
[rooteCentos
安装
可直接编译
[root@centos soft]# tar xvf ipvsadm-1.26.tar.gz
1.ipvsadm软件安装
ipvsadm-restore：用于恢复LVS 配置
ipvsadm-save：用户备份LVS配置
/sbin/ipvsadm:
说明虚拟服务器提供的是UDP服务
说明虚拟服务器提供的是TCP服务
显示帮助信息
停止同步守护进程
启动同步守护进程
-tcptcpfinudp设置连接超时值
虚拟服务表计数器清零（清空当前的连接数量等）
显示内核虚拟服务器表
删除一条虚拟服务器记录中的某条真实服务器记录
编辑一条虚拟服务器记录中的某条真实服务器记录
在内核虚拟服务器表的一条记录里添加一条新的真实服务器记录
保存虚拟服务器规则，输出为-R选项可读的格式
恢复虚拟服务器规则
清除内核虚拟服务器表中的所有记录
删除内核虚拟服务器表中的一条虚拟服务器记录
编辑内核虚拟服务器表中的一条虚拟服务器记录
在内核的虚拟服务器表中添加一条新的虚拟服务器记录
说明
ipvsadm-1.261# make install
为LVS主管理程序，
表8.2ipvsadm常用参数说明
负责RS的添加、删除与修改
第8章集群
225
---
## Page 238
务器，各个真实服务器权重指定为1，其他参数说明可参考表8.2。
CentOs7系统管理与运维实战
226
所示。
器并添加真实服务器。操作步骤如【示例8-2】所示。
92.168.32.2:80-m-W1
92.168.32.1:80 -m -W 1
-n
--sort
--rate
--stats
--daemon
-timeout
-C
-W
-m
二.
4
-P
-S
参数
Apache服务需要在真实服务器上部署，部署完毕后需要做一些设置并启动，如【示例8-3】
3.Apache服务搭建
上述示例首先清除ipvsadm表，然后添加LVS 虚拟服务，并指定NAT模式添加真实的服
#增加第2台real
【示例8-2】
增加第1台
首先在前端负载均衡器192.168.32.100做相关设置，包含设置VIP、添加LVS的虚拟服务
启用路由转发功能
2.LVS配置
清除ipvsadm
tQLD192
realservel
6
输出IP地址和端口的数字形式
对虚拟服务器和真实服务器排序输出
显示速率信息
显示统计信息
显示同步守护进程状态
显示tep tcpfin udp的timeout 值
显示LVS目前的连接数
真实服务器的权值
指定LVS的工作模式为NAT模式
指定LVS的工作模式为隧道模式
指定LVS的工作模式为直接路由模式
真实的服务器
持久服务
使用的调度算法，
说明是经过iptables标记过的服务类型
说明
表
16832
168
68
100 ~1#/sbin/ipvsadm
100~]#/sbin/ipvsadm
服务
100
，常见选项r|wrll/wlc|lbe|lblcr|dhshlsednq
]#ipvsadm
-C
-a-t192.168.32.150:80-r
-t
（续表）
---
## Page 239
255.255.255.255up
步骤如【示例8-4】所示。
192.168.32.2”，其他情况相同。
[root@Centos~]#ifconfig tun10
#检查相关设置
#设置路由
【示例8-4】
如需LVS代理到后端的真实服务器，后端真实服务器需要启动服务，并确认服务端口监
另外一个节点192.168.32.2做类似设置，不同之处在于首页内容为“welcome to
welcome to192.168.32.1
#测试服务
[root@Rs_192_168_32_1 httpd-2.2.17]#/usr/1ocal/apache2/bin/apachect1
6
4.真实服务器设置
启动服务
Listen 0.0.0.0:80
#编辑配置文件修改对应行并保存
[root@RS 192 168 32
echo welcome to 192.168.32.1
[root@Rs 192_168_32 1 httpd-2.2.17]# vim /usr/1ocal/apache2/conf/httpd.conf
[root@Rs_192_168_32_1 httpd-2.2.17]# make insta1l
root@Centos
[root@Centos]#cat-ntun.sh
[root@RS 192 168_32
Iroot@Rs_192 168_321httpd-2.2.171#make
root@Rs 192 168
[root@Rs 192_168 32 1 soft]# tar xvf httpd-2.2.17.tar.
【示例8-3】
echo
echo
#避免arp广播问题
echo1
/sbin/ifconfig tunlo up
#设置VIP
设置IP转发
N
>/proc/sys/net/ipv4/conf/all/arp_announce
>/proc/sys/net/ipv4/conf/al1/arp_ignore
>/proc/sys/net/ipv4/conf/tunl0/arp ignore
]# /sbin/route add -host 192.168.32.150
32
httpd-2.2.171#cat/usr/local/apache2/htdocs/index.htm]
1 httpd-2.2.17]#./configure
curl
dev tunl
68.32
gz
第8章集群
227
---
## Page 240
务器并添加真实服务器。操作步骤如【示例8-6】所示。
CentOS7系统管理与运维实战
228
整个集群系统的吞吐量。
对称特点，负载均衡器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高
大量的数据，负载均衡器将成为整个集群系统的瓶颈。VS/DR利用大多数Intermet 服务的非
器的数目在10台和20台之间时，如请求量不高，则运行良好，如请求量突增或响应报文包含
8.4.2
负载均衡器已经添加了虚拟服务，然后进行LVS的测试，测试过程如【示例8-5】所示。
的arp广播请求。
机器响应自己是VIP，因此为了达到负载均衡的目的，需让真实服务器忽略来自客户端计算机
器RS都设置了VIP，此时集群内的真实服务器会尝试回答来自客户端的请求，从而导致多台
在VS/NAT的集群系统中，请求和响应的数据报文都需要通过负载均衡器，当真实服务
welcome to192.168.32.1
[root@LD_192_168_32_100~]# cur1 http://192.168.32.150
【示例8-5】
确认真实后端服务器已经启动并监听在0.0.0.0，并且真实服务器上设置了VIP，LVS前端
5.LVS测试
当客户端访问 VIP 时，会产生 arp 广播，由于前端负载均衡器 LD 和Apache 真实的服务
tunl0
首先在前端负载均衡器192.168.32.100做相关设置，包含设置VIP，并添加LVS的虚拟服
2.LVS配置
首先可以按上节提供的方法安装ipvsadm软件。
1.ipvsadm软件安装