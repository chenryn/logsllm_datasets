permissions. 
Permission Name 
Description 
Global 
Who can login to Bitbucket, who is system admin, admin, etc. 
Project 
Read, write, and admin permissions at the project (groups of 
repositories) level. 
Repository 
Read, write, and admin permissions on a per repository basis. 
Branch 
Write (push) access on a per branch basis. 
47 https://www.atlassian.com/software/bitbucket/enterprise 
48 https://bitbucket.org/product/guides/getting-started/overview#key-terms-to-know 
49 https://confluence.atlassian.com/bitbucketserverkb/4-levels-of-bitbucket-server-permissions-779171636.html 
X-Force Red | 3/2/2022 
75 
Table of Bitbucket permission types 
The below table explains the different roles that can be assigned via the global 
permissions.  
Bitbucket global access permissions50 
The below table explains the different roles that can be assigned via the project 
permissions. 
Bitbucket project permissions51 
50 https://confluence.atlassian.com/bitbucketserver/global-permissions-776640369.html 
51 https://confluence.atlassian.com/bitbucketserver/using-project-permissions-776639801.html 
X-Force Red | 3/2/2022 
76 
The below table explains the different roles that can be assigned via the repository 
permissions. 
Bitbucket repository permissions52 
The below table explains the branch permissions that can be assigned53. 
Name 
Description 
Prevent all 
changes 
Prevents pushes to the specified branch(es) and restricts creating 
new branches that match the branch(es) or pattern. 
Prevent deletion 
Prevents branch and tag deletion. 
Prevent 
rewriting history 
Prevents history rewrites on the specified branch(es) - for example 
by a force push or rebase. 
Prevent changes 
without a pull 
request 
Prevents pushing changes directly to the specified branch(es); 
changes are allowed only with a pull request. 
Bitbucket branch permissions 
Access Token Scopes 
Access tokens in Bitbucket are restricted to just use with projects and repositories. This 
is a different model than some other SCM systems like GitHub Enterprise and GitLab 
52 https://confluence.atlassian.com/bitbucketserver/using-repository-permissions-776639771.html 
53 https://confluence.atlassian.com/bitbucketserver/using-branch-permissions-776639807.html 
X-Force Red | 3/2/2022 
77 
Enterprise. The below table explains the different scopes that can be assigned to an 
access token. 
Bitbucket API scopes54 
API Capabilities 
The Bitbucket REST API enables a user to perform several actions such as interacting 
with projects, repositories, access tokens, SSH keys and more. Full documentation on 
the REST API is available at this resource55. 
54 https://confluence.atlassian.com/bitbucketserver/http-access-tokens-939515499.html 
55 https://developer.atlassian.com/server/bitbucket/reference/rest-api/ 
X-Force Red | 3/2/2022 
78 
ATTACK SCENARIOS 
The below scenarios are notable for an attacker to attempt against Bitbucket and have 
been useful as a part of X-Force Red’s Adversary Simulation engagements. This is not 
an exhaustive list of every single attack path available to execute on Bitbucket. The 
below table summarizes the attack scenarios that will be described. 
Attack Scenario 
Sub-Scenario 
Admin Required? 
Reconnaissance 
-Repository 
-File 
-Code 
No 
Promoting User to Admin Role 
N/A 
Yes 
Maintain Persistent Access 
-Personal Access Token 
-SSH Key 
No 
Modifying CI/CD Pipeline 
N/A 
No – Write Access to 
Repo 
Table of Bitbucket Attack Scenarios 
Reconnaissance 
The first step an attacker will take once access has been gained to a Bitbucket instance, 
is to start performing reconnaissance. Reconnaissance that could be of value to an 
attacker includes searching for repositories, files, and code of interest. 
Repository Reconnaissance 
An attacker may be looking for repositories that deal with a particular application or 
system. In this case, we are searching for “cred” to look for repositories with that 
search term in the name. 
Searching for repository via web interface 
X-Force Red | 3/2/2022 
79 
Project searches can be accomplished also via the Repos REST API56 as shown with the 
below example curl command. 
curl -i -s -k -X $'GET' -H $'Content-Type: application/json' -H 
$'Authorization: Bearer accessToken' 
$'https://bitbucketHost/rest/api/1.0/repos?name=searchTerm' 
File Reconnaissance 
There also may be certain files of interest to an attacker based on file name. For 
example, maybe a file with “decrypt” in it. In this example, we are searching for any 
files with “jenkinsfile” in the name. 
Searching for file via web interface 
Another option for an attacker to search for a file is via the Search REST API as shown 
with the below example curl command. 
curl -i -s -k -X $'POST' -H $'Content-Type: application/json' -H 
$'Authorization: Bearer accessToken' --data-binary 
$'{\"query\":\"searchTerm\",\"entities\":{\"code\":{}},\"limits\":{\"p
rimary\":100,\"secondary\":100}}' 
$'https://bitbucketHost/rest/search/latest/search' 
Code Reconnaissance 
Another area of interest for an attacker is searching for secrets within code, such as 
passwords or API keys. In this example, we are searching for “API_KEY”. 
56 https://docs.atlassian.com/bitbucket-server/rest/7.20.0/bitbucket-rest.html#idp450 
X-Force Red | 3/2/2022 
80 
Searching for code via web interface 
An attacker can also search for a project via the Search REST API as shown with the 
below example curl command. 
curl -i -s -k -X $'POST' -H $'Content-Type: application/json' -H 
$'Authorization: Bearer apiToken' --data-binary 
$'{\"query\":\"searchTerm\",\"entities\":{\"code\":{}},\"limits\":{\"p
rimary\":100,\"secondary\":100}}' 
$'https://bitbucketHost/rest/search/latest/search' 
Logging of Reconnaissance 
In order to log the search query that is being performed, the logging level needs to be 
increased as shown in the below screenshot by enabling debug logging. This will add 
significantly more logging and usage of disk space on the Bitbucket server, so this 
logging change will depend on the organization. This is in the system administration 
menu within “Logging and Profiling”. 
X-Force Red | 3/2/2022 
81 
Increasing logging level to cover search terms being used 
You will see that the detailed search request is now in the Bitbucket log 
(/var/log/atlassian/application-data/bitbucket/log/atlassian-
bitbucket.log) 
cat /var/atlassian/application-data/bitbucket/log/atlassian-
bitbucket.log | grep -i post | grep -i search | grep -i query 
Viewing logging of search criteria 
X-Force Red | 3/2/2022 
82 
Promoting User to Admin Role 
An attacker who has admin credentials (username/password) can promote another 
regular user to the admin role. One option to perform this is via the Bitbucket web 
interface by checking the “Admin” checkbox next to the respective user. 
Adding admin role to user via web interface 
This 
is 
logged 
via 
the 
access 
log 
(/var/atlassian/application-
data/bitbucket/log/atlassian-bitbucket-access.log) as shown below. 
cat /var/atlassian/application-data/bitbucket/log/atlassian-bitbucket-
access.log | grep -i put | grep -i "/admin/permissions/users" 
Viewing role change in access log 
An attacker can also add a user to the admin role via the Admin User Permissions REST 
API57 as shown with the below example curl command. In this instance we are using 
the adumbledore account to add the hpotter account to the admin role. 
curl -i -s -k -X $'PUT' -H $'Content-Type: application/json' -b 
$'BITBUCKETSESSIONID= SessionID' 
$'https://bitbucketHost/rest/api/1.0/admin/permissions/users?name=user
ToAdd&permission=ADMIN' 
57 https://docs.atlassian.com/bitbucket-server/rest/4.5.1/bitbucket-rest.html#idp3716336 
X-Force Red | 3/2/2022 
83 
Adding user to admin role via API 
This 
is 
logged 
in 
the 
audit 
log 
(/var/atlassian/application-
data/bitbucket/log/audit/*.log) as shown below. 
cat /var/atlassian/application-data/bitbucket/log/audit/*.log | grep -
i 'new.permission' | grep -i admin 
Finding user addition via API in audit log 
Additionally, the audit log can be viewed in the Bitbucket web interface to see these 
events by filtering on “Global permission changed” where the “ADMIN” permission was 
added as shown below. 
X-Force Red | 3/2/2022 
84 
Viewing audit log in web interface for global permission changes 
Maintain Persistent Access 
There are two primary options an attacker can use to maintain persistent access to a 
Bitbucket instance, which includes creating a personal access token or creating an SSH 
key. There is no concept of impersonation tokens within Bitbucket like there is in GitHub 
Enterprise and GitLab Enterprise. 
Personal Access Token 
Personal access tokens (HTTP access tokens) in Bitbucket are only scoped to interact 
with projects and repositories and are not scoped to perform other actions such as 
interacting with users or administrative functionality. To create a personal access token 
via the web interface, navigate to the user account and select “HTTP access tokens” as 
shown below. 
X-Force Red | 3/2/2022 
85 
Access token menu 
You can then specify the access token name, permissions, and expiration date. 
Creating access token via web interface 
This 
is 
logged 
via 
the 
access 
log 
(/var/atlassian/application-
data/bitbucket/log/atlassian-bitbucket-access.log) as shown below. 
cat /var/atlassian/application-data/bitbucket/log/atlassian-bitbucket-
access.log | grep -i put | grep -i '/rest/access-tokens' 
X-Force Red | 3/2/2022 
86 
Viewing access token creation in web interface via access log 
This can also be performed via the Access Tokens REST API58 as shown in the below 
curl command. 
curl -i -s -k -X $'PUT' -H $'Content-Type: application/json' -b 
$'BITBUCKETSESSIONID=sessionID' --data-binary $'{\"name\": 
\"tokenName\",\"permissions\": 
[\"REPO_ADMIN\",\"PROJECT_ADMIN\"],\"expiryDays\": \"\"}'  
$'https://bitbucketHost/rest/access-
tokens/1.0/users/userToCreateAccessTokenFor 
This 
is 
logged 
via 
the 
audit 
log 
(/var/atlassian/application-
data/bitbucket/log/audit/*.log) as shown below. 
cat /var/atlassian/application-data/bitbucket/log/audit/*.log | grep -
i "personal access token created" 
Filtering audit log for personal access token created 
Additionally, the audit log can be viewed in the Bitbucket web interface to see these 
events by filtering on “Personal access token created” as shown below. 
58 https://docs.atlassian.com/bitbucket-server/rest/7.20.0/bitbucket-access-tokens-rest.html 
X-Force Red | 3/2/2022 
87 
Viewing advanced audit log for access token creation 
SSH Key 
An attacker can also maintain access to Bitbucket by adding an SSH key.  You can’t add 
an SSH key that already exists for another user. This can be performed via the web 
interface by navigating to a user profile and selecting “SSH keys” → “Add key”. 
Adding SSH key via web interface 
Below you can see the SSH key that was added. 
X-Force Red | 3/2/2022 
88 
Viewing added SSH key 
You can then use that SSH key to clone repositories as that user. 
Cloning repository via added SSH key 
This 
is 
logged 
via 
the 
access 
log 
(/var/atlassian/application-
data/bitbucket/log/atlassian-bitbucket-access.log) as shown below. 
cat /var/atlassian/application-data/bitbucket/log/atlassian-bitbucket-
access.log | grep -i post | grep -i 'ssh/account/keys/add' 
Viewing access log for SSH key added 
X-Force Red | 3/2/2022 
89 
An alternative method to add an SSH key is via the SSH REST API 59 as shown with the 
below example curl command. 
curl -i -s -k -X $'POST' -H $'Content-Type: application/json' -b 
$'BITBUCKETSESSIONID=sessionID' --data-binary $'{"text":"yourSSHKey"}'  
$'https://bitbucketHost/rest/ssh/1.0/keys?user=UserToCreateSSHKeyFor' 
This 
is 
logged 
via 
the 
audit 
log 
(/var/atlassian/application-
data/bitbucket/log/audit/*.log) as shown below. 
cat /var/atlassian/application-data/bitbucket/log/audit/*.log | grep -
i "user added ssh access key" 
Viewing audit log for SSH key added 
Additionally, the audit log can be viewed in the Bitbucket web interface to see these 
events by filtering on “User added SSH access key to profile” as shown below. 
59 https://docs.atlassian.com/bitbucket-server/rest/7.20.0/bitbucket-ssh-rest.html 
X-Force Red | 3/2/2022 
90 
Viewing advanced audit log for adding SSH key 
Modifying CI/CD Pipeline 
In Bitbucket, there is a feature called Bamboo60 that can be installed and configured to 
facilitate a CI/CD pipeline. If a repository is using a CI/CD pipeline with Bamboo, it will 
contain a directory named “bamboo-specs” within the root of the repository, along with 
a Bamboo configuration file. This configuration file will either be a YAML 61 file 
(bamboo.yaml) or a Java62 spec file (pom.xml). If an attacker would like to discover any 
repositories that are configured with a CI/CD pipeline via Bamboo, they can search for 
“bamboo-specs” in either the web interface or REST API. 
60 https://www.atlassian.com/software/bamboo 
61 https://docs.atlassian.com/bamboo-specs-docs/8.1.2/specs.html?yaml# 
62 https://docs.atlassian.com/bamboo-specs-docs/8.1.2/specs.html?java# 
X-Force Red | 3/2/2022 
91 
Discovering repos with CI/CD integration via Bamboo 
As long as you have write access or admin access to a repository, the Bamboo 
configuration file can be modified. In this case, we are modifying the bamboo.yaml file 
to add our SSH key to the server where the Bamboo agent is running. This can be 
performed via the Git command line tool as well to commit the changes to the Bamboo 
configuration file. 
Modifying Bamboo yaml file 
X-Force Red | 3/2/2022 
92 
This will immediately trigger the CI/CD pipeline to run as shown below. 
Showing successful job status 
When viewing the output from the pipeline, we can see our SSH key was added, and it 
printed the hostname of the server where the SSH key was added. 
Viewing pipeline logs 
Below shows successfully accessing the server where the SSH key was added via the 
modified CI/CD pipeline configuration file via SSH. 
X-Force Red | 3/2/2022 
93 
Proving SSH access to Bitbucket server 
When there is a change to a CI/CD pipeline, this is logged on the Bamboo server as 
shown below. 
sudo cat $BAMBOO_HOME/logs/atlassian-bamboo.log | grep -i "change 
detection found" 
Results of searching for changes in Bamboo YAML file 
Any commits that update the Bamboo YAML file in a project should be heavily 
scrutinized and require approval before pushed. 
X-Force Red | 3/2/2022 
94 
SCMKit 
BACKGROUND 
At X-Force Red, we wanted to take advantage of the REST API functionality available in 
the most common SCM systems seen during engagements and add the most useful 
functionality in a proof-of-concept tool called SCMKit. The goal of this tool is to provide 
awareness of the abuse of SCM systems, and to encourage the detection of attack 
techniques against SCM systems.  
SCMKit allows the user to specify the SCM system and attack module to use, along with 
specifying valid credentials (username/password or API key) to the respective SCM 
system. Currently, the SCM systems that SCMKit supports are GitHub Enterprise, GitLab 
Enterprise 
and Bitbucket 
Server. The 
attack 
modules 
supported 
include 
reconnaissance, privilege escalation and persistence. Other functionality available in 
the non-public version of SCMKit were not included in consideration for defenders, such 
as user impersonation and built-in credential searching. SCMKit was built in a modular 
approach, so that new modules and SCM systems can be added in the future by the 
information security community. The tool and full documentation are available on the 
X-Force Red GitHub63. A few example use cases will be shown in the next sections. 
RECONNAISSANCE 