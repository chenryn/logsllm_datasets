# 分析勒索软件Cerber的攻击方法

##### 译文声明
本文是翻译文章，原文来源：360安全播报。具体内容及含义请以原文为准。

勒索软件是进行网络勒索的主要手段之一。通常情况下，用户将无法访问他们的文件、程序或系统，直到支付赎金。加密货币（如比特币）直接促进了这种形式的犯罪。根据FireEye的动态威胁感知（DTI）系统的数据，自2015年中以来，勒索活动的数量一直稳步增长。

### Cerber勒索软件的攻击过程

2016年6月10日，FireEye的HX检测到一次Cerber勒索软件的攻击活动。该攻击通过电子邮件传播一个恶意Word文档。一旦收件人打开文档，恶意宏会连接到攻击者控制的网站，并下载安装Cerber家族的勒索软件。

**漏洞卫士** 是FireEye终端安全（HX）的新特性，能够检测到威胁并警告用户受到感染，从而帮助企业阻止Cerber的部署。进一步调查后，FireEye的研究团队与荷兰CERT以及不知情提供Cerber安装的主机托管服务提供商合作，在几小时内关闭了Cerber命令与控制（C2）服务器。当这些服务器离线时，配置为下载的宏和其他恶意载荷将无法继续感染用户。

尽管攻击者可以随时配置额外的C2服务器来恢复勒索活动，但在关闭C2服务器后，FireEye没有观察到任何新的感染行为。这种现象在三个不同的FireEye终端安全客户的六个不同终端上得到了验证，证明HX能有效检测和阻止Cerber的成功部署。

### 攻击流程

Cerber的攻击周期可以分为以下八个步骤：

1. **目标收到并打开Word文档**。
2. **文档中的宏被调用**，在隐藏模式下运行PowerShell。
3. **控制命令传递给PowerShell**，使其连接到恶意站点并下载勒索软件。
4. **成功连接后**，勒索软件被写入受害者的磁盘。
5. **PowerShell运行勒索软件**。
6. **勒索软件配置多个持续机制**，包括创建命令行、屏幕保护程序、startup.run和runonce注册表项。
7. **使用本地Windows工具**（如WMIC和VSSAdmin）删除备份和卷影副本。
8. **加密文件并向用户发送付款要求**。

漏洞卫士从第二步开始提供全方位保护，而不是等到第四步或第五步才开始防护。

### PowerShell的滥用

当受害者打开附加的Word文档时，恶意宏会将一小段VBScript写入内存并执行。该VBScript运行PowerShell来连接到攻击者控制的服务器，并下载勒索软件（profilest.exe）。这种技术绕过了执行策略，使PowerShell在隐藏和加密模式下运行，从而使勒索软件在受害者不知情的情况下下载和运行。

### Cerber的具体行为

#### 有效载荷的初始行为

Cerber运行时会检查其启动目录。除非它从特定目录（%APPDATA%）启动，否则它会在受害者的%APPDATA%目录下以随机文件名创建自己的副本。如果从特定目录启动，它会清除内部黑名单文件名，并使用伪随机选择的名字创建一个重命名的副本到%APPDATA%目录，然后执行新位置的软件并在结束后清理。

#### 卷影删除

Cerber会绕过UAC检查，删除所有卷影副本，并禁用安全启动选项。具体操作包括：
- `vssadmin.exe "delete shadows /all /quiet"`
- `WMIC.exe "shadowcopy delete"`
- `bcdedit.exe "/set {default} recoveryenabled no"`
- `bcdedit.exe "/set {default} bootstatuspolicy ignoreallfailures"`

#### 胁迫

Cerber会向受害者展示信息，促使他们尽快支付赎金。例如，在一定时间内付款可以享受50%的折扣。

#### 多语言支持

Cerber支持12种语言的信息和说明，表明这是一次全球性的攻击。

#### 加密

Cerber针对294种不同的文件扩展名进行加密，包括常见的办公文件格式（如.doc和.ppt）和金融文件格式（如.ibank和.wallet）。

#### 选择性靶向

攻击者使用在线服务（如ipinfo.io）验证主机的公网IP国家代码，避免感染黑名单中的国家（如俄罗斯及其周边国家）。此外，Cerber还会检查系统键盘布局，进一步确保不感染特定地区的机器。

#### 反虚拟机检查

Cerber会搜索一系列连接模块、特定文件名和路径以及已知的沙箱序列号，以避免在沙箱环境中被检测到。

#### 持续性

Cerber通过以下技术确保系统的持续感染：
- 添加注册表项，使系统空闲时运行勒索软件而非屏幕保护程序。
- 修改“命令提示符”的自动运行键值，指向Cerber有效载荷。
- 在启动文件夹中添加快捷方式文件，以便在用户登录Windows后立即执行勒索软件。
- 使用常见的持续性方法，如run和runonce键。

### 稳固的防御

对于受影响的企业来说，减轻勒索软件的影响至关重要。传统的基于签名的控制已经不足以应对不断变化的恶意软件变体。禁用网上文档对宏的支持和提高用户的警惕性是减少感染可能性的有效方法。然而，这些措施可能不足以阻止所有感染。

FireEye终端安全和漏洞卫士有助于检测勒索软件利用的漏洞和技术，并提供更详细的分析，帮助安全团队迅速识别和应对威胁。

### 结论

勒索软件已成为一种越来越普遍且有效的攻击方式，影响企业的正常运作并阻止用户访问重要文件和数据。减轻勒索软件的威胁需要强大的终端控制和先进的检测技术。FireEye的HX和漏洞卫士通过行为感知技术加速这一进程，快速分析企业内的终端并发出警报，使安全团队能够进行全面调查并即时处理威胁。