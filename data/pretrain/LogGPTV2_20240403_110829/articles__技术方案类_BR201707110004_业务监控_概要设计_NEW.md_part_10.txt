  ---------------------------------------------------------------------------------------
  **~~存储汇总~~**   **~~有效容量（G）~~**   **~~RAID方式~~**   **~~说明~~**
  ------------------ ----------------------- ------------------ -------------------------
  ~~SATA~~           ~~2679~~                ~~RAID5~~          ~~文件系统~~
  ~~SATA~~           ~~500~~                 ~~RAID10~~         ~~数据库~~
  ---------------------------------------------------------------------------------------
##### ~~日志数据入库~~
~~业务配置平台新增独立进程实时处理各应用节点上传的原始日志数据，对各节点上传的日志进行汇聚，并按约定的日志格式解析后写入业务调用链日志信息表CFG_DATA_BUSITRACEINFO，入库后将原始日志文件移入备份目录，后续由运维定期清理，入表各字段填值说明:~~
  ----------------------------------------------------------------------------------------
  **~~字段名~~**       **~~字段中文名称~~**       **~~填值说明，对应日志格式中的字段~~**
  -------------------- -------------------------- ----------------------------------------
  ~~TRACEID~~          ~~调用序号~~               ~~TraceID~~
  ~~SEQNO~~            ~~调用序号~~               ~~SeqNo~~
  ~~CALLINGNODEID~~    ~~调用者服务实例标识~~     ~~CallingNodeID~~
  ~~CALLINGIP~~        ~~调用者服务IP~~           ~~CallingIP~~
  ~~CALLEDNODEID~~     ~~被调用服务实例标识~~     ~~CalledNodeID~~
  ~~CALLEDIP~~         ~~被调用服务IP~~           ~~CalledIP~~
  ~~FLAG~~             ~~请求响应标识~~           ~~Flag~~
  ~~METHOD~~           ~~调用方法名称~~           ~~AppName_Method~~
  ~~PROGRAMNAME~~      ~~应用名称~~               ~~SubSysName~~
  ~~BEGINTIME~~        ~~请求时间~~               ~~BeginTime~~
  ~~ENDTIME~~          ~~响应时间~~               ~~EndTime~~
  ~~MSGSIZE~~          ~~消息大小~~               ~~ReqMsgSize或RspMsgSize~~
  ~~RESULTCODE~~       ~~返回码~~                 ~~ResultCode~~
  ~~RESULTINFO~~       ~~返回信息~~               ~~ResultInfo~~
  ~~EXTENDINFO~~       ~~请求扩展信息~~           ~~ExtendInfo~~
  ~~INITME~~           ~~入库时间~~               ~~填写系统时间~~
  ~~STATE~~            ~~日志分析状态~~           ~~填写0~~
  ----------------------------------------------------------------------------------------
##### ~~日志分析~~
~~新增后台进程分析调用链日志信息，统计业务调用链日志信息表CFG_DATA_BUSITRACEINFO中状态为0、入库时间为3小时前（为防止分析时日志未完整入库，增加时间间隔控制，时间间隔通过参数控制）的记录，根据交易流水号统计一次交易中，整体交易的时长以及每个服务请求、应答的时长，服务调用结果，服务调用失败信息，经过分析计算后生成保存到业务调用链分析表和分析明细表，并更新日志分析状态为1。~~
~~新增业务调用链分析表CFG_DATA_BUSITRACEANALY，记录交易流水号、业务类型、开始时间、结束时间、总耗时、业务状态、备注信息。~~
~~新增业务调用链分析明细表CFG_DATA_BUSITRACEANALYDETAIL，记录交易流水号、调用顺序号、调用者服务实例、被调用服务实例、服务器IP、请求响应标识、调用方法名称、服务应用名称、请求时间、响应时间、消息大小、返回码、返回信息
、业务扩展信息。~~
~~CFG_DATA_BUSITRACEANALY各字段填值说明:~~
  ---------------------------------------------------------------------------------------------------------------------------------------------
  **~~字段名~~**      **~~字段中文名称取值说明~~**
  ------------------- -------------------------------------------------------------------------------------------------------------------------
  ~~TRACEID~~         ~~交易流水号，取CFG_DATA_BUSITRACEINFO.traceid~~
  ~~RECTYPE~~         ~~业务类型，取CFG_DATA_BUSITRACEINFO.extendinfo中的RECTYPE键值~~
  ~~BEGINTIME~~       ~~开始时间，根据traceid查询请求时间最小那条记录的时间~~
  ~~ENDTIME~~         ~~结束时间，根据traceid查询响应时间最大那条记录的结束时间~~
  ~~USETIME~~         ~~耗时，endtime减去begintime，单位毫秒~~
  ~~BUSISTATE~~       ~~业务状态，判断最后一条日志，判断extendinfo中的TRACEPOINT键值是否1，如果为1，则填1（成功），如果非1，则填写0（失败）~~
  ~~NOTE~~            ~~备注~~
  ---------------------------------------------------------------------------------------------------------------------------------------------
~~业务调用链分析明细表（CFG_DATA_BUSITRACEANALYDETAIL）填值说明：~~
  -------------------------------------------------------------------------------------------
  **~~字段名~~**      **~~字段中文名称~~**   **~~填值说明~~**
  ------------------- ---------------------- ------------------------------------------------
  ~~TRACEID~~         ~~交易流水号~~         ~~CFG_DATA_BUSITRACEINFO.traceid~~
  ~~SEQNO~~           ~~调用顺序号~~         ~~CFG_DATA_BUSITRACEINFO.seqno~~
  ~~CALLINGNODEID~~   ~~调用者服务实例~~     ~~CFG_DATA_BUSITRACEINFO. CALLINGNODEID~~
  ~~CALLEDNODEID~~    ~~被调用服务实例~~     ~~CFG_DATA_BUSITRACEINFO.CALLEDNODEID~~
  ~~IP~~              ~~服务器IP~~           ~~CFG_DATA_BUSITRACEINFO.CALLINGIP或CalledIP~~
  ~~FLAG~~            ~~请求响应标识~~       ~~CFG_DATA_BUSITRACEINFO.Flag~~
  ~~METHOD~~          ~~调用方法名称~~       ~~CFG_DATA_BUSITRACEINFO.Method~~
  ~~PROGRAMNAME~~     ~~服务应用名称~~       ~~CFG_DATA_BUSITRACEINFO.PROGRAMNAME~~
  ~~BEGINTIME~~       ~~请求时间~~           ~~CFG_DATA_BUSITRACEINFO.Begintime~~
  ~~ENDTIME~~         ~~响应时间~~           ~~CFG_DATA_BUSITRACEINFO.Endtime~~
  ~~USETIME~~         ~~耗时~~               ~~endtime-begintime~~
  ~~MSGSIZE~~         ~~消息大小~~           ~~CFG_DATA_BUSITRACEINFO.Msgsize~~
  ~~RESULTCODE~~      ~~返回码~~             ~~CFG_DATA_BUSITRACEINFO.Resultcode~~
  ~~RESULTINFO~~      ~~返回信息~~           ~~CFG_DATA_BUSITRACEINFO.Resultinfo~~
  ~~EXTENDINFO~~      ~~业务扩展信息~~       ~~CFG_DATA_BUSITRACEINFO.Extendinfo~~
  -------------------------------------------------------------------------------------------
~~特殊处理逻辑：~~
~~为了能标识出一笔业务的开始和结束，需要根据交易流水号查询业务调用链日志表中extendinfo字段中键值TRACEFLAG的值，如果能找到值为0的记录，表示业务交易开始，则分析明细表记录一条交易开始记录，如果能找到值为1的记录，表示交易结束，则分析明细表记录一条交易结束记录，有些业务可能操作中途失败退出，就不会有值为1的记录。~~
~~各字段填值说明如下：~~
  -------------------------------------------------------------------------------
  **~~字段名~~**      **~~字段中文名称~~**   **~~填值说明~~**
  ------------------- ---------------------- ------------------------------------
  ~~TRACEID~~         ~~交易流水号~~         ~~CFG_DATA_BUSITRACEINFO.traceid~~
  ~~SEQNO~~           ~~调用顺序号~~         ~~1~~
  ~~CALLINGNODEID~~   ~~调用者服务实例~~     ~~空~~
  ~~CALLEDNODEID~~    ~~被调用服务实例~~     ~~空~~
  ~~IP~~              ~~服务器IP~~           ~~空~~
  ~~FLAG~~            ~~请求响应标识~~       ~~ClientSend/ClientRecv~~
  ~~METHOD~~          ~~调用方法名称~~       ~~Start/End~~
  ~~PROGRAMNAME~~     ~~服务应用名称~~       ~~空~~
  ~~BEGINTIME~~       ~~请求时间~~           ~~空~~
  ~~ENDTIME~~         ~~响应时间~~           ~~空~~
  ~~USETIME~~         ~~耗时~~               ~~空~~
  ~~MSGSIZE~~         ~~消息大小~~           ~~空~~
  ~~RESULTCODE~~      ~~返回码~~             ~~空~~
  ~~RESULTINFO~~      ~~返回信息~~           ~~空~~
  ~~EXTENDINFO~~      ~~业务扩展信息~~       ~~TRACEFLAG=0 / TRACEFLAG=1~~
  -------------------------------------------------------------------------------
##### ~~日志查询展示~~
-   ~~调用链基本查询~~
> ~~新增业务调用链信息查询菜单，菜单支持查询调用链总体信息和详细信息，~~
~~选中一个具体的业务调用链，将展示该调用链的总体信息和详细信息。总体信息包括：交易流水、业务类型、开始时间、结束时间、总耗时、状态。详细信息包括：每笔服务调用链信息，如"交易流水、调用序号、调用者服务实例标识、被调用服务实例标识、实例服务IP、请求和响应标识、调用方法名称（方法名、OPCODE、接口标识、工单标识等）、服务应用名称(如ngcustcare.war、liborder.so等)、请求时间、响应时间、返回码、返回信息、扩展信息（业务关键属性，如业务类型、操作员、渠道等信息）",界面参考如下：~~
![G:\\doc\\NGCRM\\02设计\\00需求文档\\BOSS新需求(17年08月)\\业务监控专题\\调用链查询.png](media/image25.png){width="5.768055555555556in"
height="3.20744750656168in"}
-   ~~调用链高级查询~~
(1) ~~统计和输出一段时间内，某个业务单次交易中各个环节的时间消耗~~
(2) ~~统计和输出一段时间内，某个业务各次交易中各个环节的时间消耗~~
(3) ~~统计和输出一段时间内，各关键业务的调用频度~~
(4) ~~汇总和输出一个时间段内，某几个业务的日志~~
(5) ~~汇总和输出一个时间段内，某个号码的日志~~
~~可以根据服务号码、业务类型、开始时间、结束时间、服务调用时延条件查询业务调用链信息和详细信息。~~
~~业务限制：查询条件中开始和结束时间必选，当其它条件为空时，时间段不能超过1天。有选其它条件时，时间段不能超过3天（通过系统参数控制）。~~
~~查询逻辑：~~
~~按服务号码查询时：先根据号码和时间段条件，查询业务调用链分析明细表中extendinfo字段中包括SERVNUMBER=服务号码
的记录，再根据traceid查询业务调用链分析表中请求时间在查询时间段内的记录。~~
~~按业务类型查询时：根据业务类型和时间段条件查询业务调用链分析表中rectype为所选业务类型，请求时间在查询时间段内的记录。~~
~~按服务请求时延查询时：先查询业务调用链分析表中请求时间在查询时间段内的记录，然后根据traceid查询明细表中USETIME字段大于所设置的值的记录。~~
~~参考界面如下：~~
![](media/image26.png){width="5.768055555555556in"
height="2.7493055555555554in"}
##### ~~日志历史数据清理~~
~~由于业务调用链属于业务操作过程中产生的日志数据，不用长时间保存，目前计划保存30天以内的数据，对于超过30天的历史数据进行清理，保持数据库低水位，减少对数据库存储的消耗和浪费。由一线维护编写清理数据的shell脚本定时运行清理。~~
~~清理逻辑：~~
~~先查询业务调用链分析表CFG_DATA_BUSITRACEANALY中intime字段小于30天前的数据，然后根据traceid字段清理业务调用链日志信息表(CFG_DATA_BUSITRACEINFO)、业务调用链分析明细表(CFG_DATA_BUSITRACEANALYDETAIL)中的数据。~~
# 接口设计
## 文件接口
### 【新增】业务调用链日志文件接口
NGCRM、NGBOSS生成业务调用链日志，分布在各应用主机服务器上，NGCRM/NGBOSS先实时将日志采集到业务监控日志服务器，再由BOMC采集代理程序从业务监控日志服务器将对应的日志信息实时采集上传到BOMC日志平台。
![](media/image27.png){width="5.768055555555556in"
height="2.6104166666666666in"}
**文件名称：**AA-NGXXX-BBB-TRACELOG.log.YYYYMMDD.nnn
其中
AA：地市编码简写，如广州:GZ
NGXXX：应用系统，如NGCRM、NGBOSS
BBB：应用服务，如WAS、CICS
YYYYMMDD：年月日，如20171121
nnn：文件序列号，如001，002递增
**文件路径：**
**NGCRM CICS:** 待确认
**NGCRM WAS:** 待确认
**NGBOSS CICS:** 待确认
**NGBOSS WAS:** 待确认
**文件大小：**200M（可配置，目前配置为按200M进行拆分）
日志格式如下：
\\>\>
说明:其中开始标志"\\>\>"之间不能有空格。
埋点日志字段内容中不可出现竖线"\|"，如果字段原始内容包含竖线"\|"，需要先转义为
&#124; 后再放入埋点日志字段内。
以下为日志服务中心要求的日志字段、字段说明以及广东项目特殊填值说明：
+-----------+-----------+------+-------------------+-----------------+
| 字段名    | 类型      | 是否 | 说明              | 特殊填值说明    |
|           |           | 必选 |                   |                 |
+===========+===========+======+===================+=================+
| TraceID   | char(32)  | 必选 | 调用链唯一标识    | 32位数字字符串  |
+-----------+-----------+------+-------------------+-----------------+
| Cal       | varcha    | 必选 | 被调用服务        | 填写            |