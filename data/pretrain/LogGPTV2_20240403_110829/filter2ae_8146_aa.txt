**作者： 安天CERT  
公众号：[震网事件的九年再复盘与思考](https://mp.weixin.qq.com/s?__biz=MjM5MTA3Nzk4MQ==&mid=2650173867&idx=1&sn=6b12446b10650f6c00784a63d3c486fb&chksm=beb9d29989ce5b8facbbad4c31886e98184461da5ced81e802a4f1c5e7c90f36c45d8e594de6&mpshare=1&scene=1&srcid=&sharer_sharetime=1570502559868&sharer_shareid=bafb2678ed1f77a340809d0b35c3d277&key=d67a32a1db8c21399407307af21fe041636d80b18f42c3dd13b85c2220cecc49917cd63f0e77e2a65bccb138e9fb7a8990bd3d183b17b72572c5c494cca50511ac5b9177f229567d4328e22d57389777&ascene=1&uin=MzM5ODEzOTY3MQ%3D%3D&devicetype=Windows+10&version=62060833&lang=zh_CN&pass_ticket=PxUxM6YK9p7HcU3t552gknPFG3j0UjkzADorBWc90iLY4m6HZb7qkEoKXYb4UEwi
"震网事件的九年再复盘与思考")**
### **1、小序**
2010年7月，“震网”（Stuxnet）蠕虫攻击事件浮出水面，引发了国际主流安全厂商和安全研究者的全面关注，安天、卡巴斯基、赛门铁克等安全厂商，Ralph
Langne等著名安全研究者，以及多国的应急组织和研究机构，都投入到了全面的分析接力中。最终使这场攻击的大量细节被呈现出来：这是一起经过长期规划准备和入侵潜伏作业；借助高度复杂的恶意代码和多个零日漏洞作为攻击武器；以铀离心机为攻击目标；以造成超压导致离心机批量损坏和改变离心机转数导致铀无法满足武器要求为致效机理，以阻断伊朗核武器进程为目的的攻击。
9年的时间过去了，这一安全事件依然在安天的研究视野中。安天从2010年7月15日展开对震网的分析工作，搭建了模拟环境，在9月27日发布了《对Stuxnet蠕虫攻击工业控制系统事件的综合分析报告》[1]，在后续形成了对其传播机理进行分析的《对Stuxnet蠕虫的后续分析报告》[2]，以及分析其对工业生产过程作用机理的《WinCC后发生了什么》[3]系列分析报告。
安天提出了震网与毒曲（Duqu）同源的猜测，并先后发表了两篇验证性报告，并启动了对火焰（Flame）恶意代码的马拉松式的模块分析。在工作推进中，安天逐步认识到震网、毒曲、高斯（Gauss）、火焰，这些高度复杂的恶意代码间存在着同样的背景联系。这些研究工作对安天后续展开对方程式组织（Equation）的深度分析起到了非常重要的作用。
由于历史原因，其中部分研究文献并未公开，而一些分析进展是碎片化的，虽然在我们的对外技术演讲中有所提及，但并未作为文献发布。这是安天编写这篇文献的原因之一。震网的整体运行框架、USB摆渡机理和传播失控分析，以及图解Tilded框架与Flamer框架的关联，将震网、火焰、毒曲、高斯、Fanny、Flowershop之间的关系进行串接的相关章节，是对这些成果的整理。
今天看来，在前期分析震网系列事件的过程中，我们缺少一种真正意义上的框架化方法。依然更多的是从自身习惯的反恶意代码视角来看待整个攻击过程。尽管我们给震网这样的复杂攻击提出了一个A2PT（即高级的高级可持续性威胁）的命名，但分析中始终缺乏作业到作战视角的思考。在相关专家的指导下，我们对网空博弈、敌情想定有了新的体悟，逐渐从威胁框架视角进行方法论切换，实现自我能力完善。也希望通过威胁框架这一视角来解读“震网”这场看起来依然高度复杂的“昨天的战争”。>2PT（即高级的高级可持续性威胁）的命名，但分析中始终缺乏作业到作战视角的思考。在相关专家的指导下，我们对网空博弈、敌情想定有了新的体悟，逐渐从威胁框架视角进行方法论切换，实现自我能力完善。也希望通过威胁框架这一视角来解读“震网”这场看起来依然高度复杂的“昨天的战争”。
本文也详细解读了一个值得思考的问题，震网作为一种没有感染属性的蠕虫，为何会有大量的样本存在。这个原理我们在早期的分析工作中已经发现，即震网的载荷投放程序，在每落地一台机器时，会有一个内嵌配置数据的自我更新，从而导致震网的每次落地形成的主执行体的HASH均不同，同时其实际攻击载荷多数均被包裹在主DLL之中，并不落地。而震网的相关域名则是在其已经达成其主体作业效果的情况下才被曝光的。这从某种意义上也昭示了面对更高级、隐蔽的攻击行动，以HASH、域名等为主体的威胁情报实际上早就面对着无效的危机。
**图 1-1 震网事件时间轴**
### **2、为什么是震网**
在信息技术发展历史上，出现过大量典型的安全事件，但为什么“震网”被视为具有威胁里程碑意义？震网被认为是第一个以现实世界中的关键工业基础设施为目标的恶意代码，并达到了预设的攻击目标，或者说，这是第一个“网络空间”意义上的重大攻击事件，而非传统的网络攻击事件。尽管此前也存在着一些通过信息攻击手段影响工业设施的传闻，但基本都缺乏技术层面的实证支撑。
从安天此前提出的观点来看，震网的里程碑意义并不是在于其相对其他简单的网络攻击的复杂性和高级性，而在于其证实了通过网络空间手段进行攻击，可以达成与传统物理空间攻击（甚至是火力打击）的等效性。在2016年的报告中，安天研究人员将上世纪70、80年代的“凋谢利刃与巴比伦行动”（在1977年~1981年间发生的以、美联合，在两伊战争期间针对伊拉克核反应堆进行军事打击的事件）与震网事件进行对比分析看出，通过大量复杂的军事情报和成本投入才能达成的物理攻击效果仅通过网络空间作业就可以达成，而且成本也大大降低。正如美国陆军参谋长前高级顾问Maren
Leed所讲的——网络武器可以有许多适应环境的属性，从生命周期的成本角度看，它们比其他的武器系统更为优越[4]。
**表 2-1 两次针对中东国家核计划所采用的军事行动与准军事行动的对比分析**
| **凋谢利刃与巴比伦行动（传统物理攻击伊拉克）** | **震网行动（网络空间攻击伊朗）**  
---|---|---  
**被攻击目标** | 伊拉克核反应堆 | 伊朗纳坦兹铀离心设施  
**时间周期** | 1977-1981年 | 2006-2010年  
**人员投入** | 以色列空军、特工人员、伊朗空军、美国空军和情报机构 | 美、以情报和军情领域的软件和网络专家，工业控制和核武器的专家  
**作战准备** | 多轮前期侦查和空袭，核反应堆情报 | 战场预制、病毒的传播和相关核设施情报  
**各方装备投入** | 伊：2架F-4鬼怪式以12枚MK82减速炸弹-轰炸核反应堆假设工地；10架F-4袭击伊拉克H-3空军基地。以：2架F-4E(S)-侦查任务；8架F-16A(美方提供)、4架F-15A、2架F-15B、16枚MK84炸弹-空袭反应堆模拟搭建反应堆特工人员暗杀伊拉克关键人员美：战略卫星和情报、空中加油机 | 编制震网病毒模拟搭建离心机和控制体系  
**前期成本** | 18个月模拟空袭训练，训练2架F-4鬼怪攻击坠毁，3名飞行员阵亡 | 跨越两位总统任期，经历了5年的持续开发和改进  
**毁伤效果** | 反应堆被炸毁，吓阻了法国供应商继续提供服务，伊拉克核武器计划永久迟滞 |
导致大量离心机瘫痪，铀无法满足武器要求，几乎永久性迟滞了伊朗核武器计划  
**效费比** | 打击快速，准备期长，耗资巨大，消耗大，行动复杂，风险高 | 周期长，耗资相对军事打击低，但更加精准、隐蔽，不确定性后果更低  
震网系列攻击也全面昭示了工业基础设施可能被全面入侵渗透乃至完成战场预制的风险，震网的成功是建立在火焰、毒曲恶意代码的长期运行、信息采集的基础上。在攻击伊朗铀离心设施之前，攻击方已经入侵渗透了伊朗的多家主要国防工业和基础工业厂商，包括设备生产商、供应商、软件开发商等，表2-2是多个企业遭遇入侵的事件。
**表 2-2 伊朗基础工业体系遭遇渗透的情况**
**公司** | **地理位置** | **被攻击时间** | **主要业务**  
---|---|---|---  
**FOOLAD Technic Engineering Co(FIECO)** | 伊朗 伊斯法罕 | 2009/6/23 2010/4/26 |
该公司为伊朗工业设施（主要为生产钢铁和电力）生产自动化系统，拥有许多伊朗最大的工业企业的数据、图纸和计划。  
**Behpajooh Co. Elec & Comp. Engineering** | 伊朗 伊斯法罕 | 2009/6/28 2010/3/23
2010/5/13 2010/7 | 开发工业自动化系统，拥有SCADA/PLC的专家。  
**Neda Industrial Group** | 伊朗 | 2009/7/7 | 为水电站、水泥、以及石油、天然气及石化领域提供工业自动化服务。  
**Control-Gostar Jahed Company** | 伊朗 | 2009/7/7 |
伊朗的一家工业自动化公司，与伊朗最大的石油生产、冶金、能源等企业有着非常深入的合作。  
**Kala Electric** | 伊朗 | 2010/5/11 |
是铀浓缩离心机设备IR-1最主要的供应商，报道称在1997年至2002年间，伊朗在Kala组装和测试IR-1。  
**Mobarakeh Steel Company(MSC)** | 伊朗 | 2010/4/24 |
该公司是伊朗最大的钢铁制造商，伊朗经营规模最大的工业园区之一。  
### **3、震网整体结构和运行逻辑**
震网的结构非常复杂。其中又经历了从0.5到1.x的版本更迭，其破坏机理从以干扰离心机阀门、造成超压导致离心机批量损坏调整为修改离心机转数。同时其开发框架也发生了变化。我们以流行更为广泛的1.x版本为对象，进行整体结构和运行逻辑梳理。震网的核心是仅在内存中解密存在的DLL文件（以下简称主DLL文件）。DLL文件包含32种不同的导出函数以及15种不同的资源，每一个导出函数都有不同的控制功能，其中主要涉及导出函数15（初始入口点）、导出函数16（安装）、导出函数32（感染连接的移动设备，启动RPC服务）、导出函数2（钩挂API以感染Step7工程文件）等；每个资源也分别执行不同的功能，主要涉及资源250、资源201、资源242等；导出函数正是利用这些不同功能的资源来控制震网执行不同的分支操作。
**表 3-1 Stuxnet Dropper资源列表**
**资源** **ID** | **功能**  
---|---  
**201** | MRxNet.sys加载驱动，Realtek签名  
**202** | 感染Step 7的DLL  
**203** | 感染WinCC的CAB文件  
**205** | 资源201的数据文件  
**207** | 震网的自动运行版本  
**208** | Step 7 替换DLL  
**209** | 数据文件（%windows%\help\winmic.fts）  
**210** | 用来注入的PE模板文件  
**221** | 通过SMB传播的MS08-067利用  
**222** | MS10-061打印机后台处理程序漏洞利用  
**231** | 网络连接检查  
**240** | 用来创建LNK利用的LNK模板文件  
**241** | USB Loader DLL ~WTR4141.tmp  
**242** | Mrxcls.sys rootkit 驱动  
**250** | Windows Win32k.sys本地权限提升（MS10-073）的利用  