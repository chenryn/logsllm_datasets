Vulnerability Exchange: 
One Domain Account for More Than Exchange Server RCE
Tianze Ding (@D1iv3)
> whoami
â€¢
Tianze Ding (@D1iv3)
â€“
Senior security researcher at Tencent Security Xuanwu Lab
â€“
Focusing on Active Directory Security / Red Team / Web Security
â€“
Reported some vulnerabilities to Microsoft, Apple, Google, etc.
â€“
Black Hat Asia / Black Hat USA Arsenal speaker
â€¢
Exchange Server Attack Surface Overview
â€¢
From a Domain Account to Arbitrary Mailbox Takeover
â€¢
From a Domain Account to Exchange Server RCE
â€¢
Lateral Movement & Privilege Escalation
â€¢
Conclusion & Takeaways
Agenda
â€¢
One of the most famous mail servers in the world
â€¢
Stores large amounts of sensitive corporate information
â€“
Emails, attachments, contacts, calendars â€¦
Why Microsoft Exchange Server ?
â€¢
Highly integrated with Microsoft Active Directory
â€“
Authentication
â€“
Mailbox / User / Group management
â€“
Exchange Server configuration
â€“
â€¦
â€¢
High-privileged AD objects
â€“
Exchange Servers are installed by Enterprise Admins /
Schema Admins / â€¦
â€“
The Exchange Windows Permissions group has
WriteDACL right on the Domain object (fixed in 2019)
Why Microsoft Exchange Server ?
[1] https://docs.microsoft.com/en-us/exchange/plan-and-deploy/active-directory/ad-access?view=exchserver-2019
[2] https://docs.microsoft.com/en-us/exchange/plan-and-deploy/deploy-new-installations/install-mailbox-role?view=exchserver-2019
Exchange Server Attack Surface Overview
â€¢
Client Access Services
â€“
HTTPS endpoints
â€“
POP3 / IMAP / SMTP
â€“
Unified Messaging
â€¢
HTTPS endpoints
â€“
OWA, ECP
â€“
RPC, EWS, MAPI, API,
ActiveSync, PowerShell, Auto
Discover, OAB
Architecture and Attack Surface
â€¢
Most historical vulnerabilities exist in ASP.NET code running on IIS Server
Historical Vulnerabilities
IIS Server
POP3
Exchange Server
RPC
ECP
OWA
EWS
MAPI
API
Active
Sync
Power
Shell
Autodi
scover
OAB
Front End
HTTP
Proxy
IMAP
SMTP
UM
Architecture and Attack Surface
POP3
IMAP
SMTP
UM
IIS Server
Windows Server
Exchange Server
â€¦
Exchange Server
Exchange Server
Front End
HTTP Proxy
OWA/ECP/MAPI/EWS/â€¦
From a Domain Account to Arbitrary 
Exchange Mailbox Takeover
The UNC Feature
â€¢
Many ECP operations/PowerShell Cmdlets support UNC feature
â€“
Export-ActiveSyncLog
â€“
Import-ExchangeCertificate
â€“
New-ExchangeCertificate
â€“
Export-ExchangeCertificate
â€“
New-MailboxExportRequest
â€“
â€¦
â€¢
Trigger SMB connection
â€“
Exchange Server runs with NT AUTHORITY\SYSTEM
â€“
NTLM authentication with XLAB\Exchange1$ (Machine Account)
The UNC Feature
What can we do with the SMB connection / NTLM authentication ? ðŸ¤”
â€¢
Embedded challenge-response style authentication protocol
â€¢
Protocols using NTLMSSP
â€“
NTLM over SMB
â€“
NTLM over HTTP
â€“
NTLM over LDAP
â€“
NTLM over MSRPC
â€“
â€¦
â€¢
NTLM relay attack
What is NTLM
NTLM Relay Attack 101
Victim
Attacker
Attacked Target
DC
[NTLM Negotiation]
Let me log in to
\\attacker\share
[NTLM Negotiation]
Let me log in to
the vulnerable service
NTLM Relay Attack 101
Victim
Attacker
DC
[NTLM Challenge]
Here is a challenge, hash it
with your password
[NTLM Challenge]
Here is a challenge, hash it
with your password
Attacked Target
NTLM Relay Attack 101
Victim
Attacker
DC
[NTLM Auth]
I am DOMAIN\victim, here is
the challenge-response
NETLOGON
Success
[NTLM Auth]
I am DOMAIN\victim, here is
the challenge-response
Attacked Target
NTLM Relay Attack 101
Victim
Attacker
DC
Login successful with
DOMAIN\victim
Login failed
NETLOGON
Success
Attacked Target
Exploit 
â€¢
We can trigger NTLM authentication of XLAB\Exchange1$
â€¢
Preconditions for NTLM relay attack
â€“
Authentication
â€¢
Are there any vulnerable services as targets of NTLM relay attacks?
â€“
Authorization
â€¢
Does the machine account have any special privileges on these services?
NTLM Relay Attack
Attacker
NTLM relay -> Login with XLAB\Exchange1$
Service
A
XLAB\Exchange1$ can perform sensitive operations
Endpoints
Description
Authentication
/owa
Outlook Web App
Web Form
/ecp
Exchange Control Panel
Web Form
/mapi
MAPI over HTTP, used by modern Microsoft Outlook
Kerberos, NTLM
/EWS
Exchange Web Services, used by Outlook for macOS and Outlook add-ins
Kerberos, NTLM
/Rpc
Outlook Anywhere, used by Microsoft Outlook 2013, Outlook 2010, or 
Outlook 2007
Kerberos, NTLM, Basic
/Microsoft-Server-ActiveSync
ActiveSync let you synchronize a mobile device with your Exchange mailbox
Basic
/Powershell
Used by Exchange PowerShell Cmdlets
Kerberos
/Autodiscover
Used by client application to configure itself
Kerberos, NTLM, Basic
/API
REST API, available in Exchange 2016 CU3 or newer
Kerberos, NTLM
/OAB
Offline Address Book
Kerberos, NTLM
Exchange Server (on-premise) Endpoints
Can we relay NTLM authentication to these endpoints ? ðŸ¤”
NTLM Reflection
â€¢
Can we relay the NTLM authentication back to Exchange1ï¼Ÿ
â€¢
CVE-2018-8581 SSRF + NTLM reflection
â€“
The victim and the attacked target are the same machine
â€“
CVE-2018-8581 disabled NTLM reflection on Exchange Server
â€“
Remove HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa
DisableLoopbackCHECK
Attacker
NTLM auth of XLAB\Exchange1$
Relay back to the same machine
Exchange1
Two Exchange Servers
â€¢
What if there is more than one Exchange Server in the AD ?
â€“
A common situation of Exchange Server load balancing in enterprise environments
Attacker
Exchange1
Exchange2
NTLM auth of XLAB\Exchange1$
Relay the NTLM auth to
HTTPS endpoints on Exchange2
EPA
Extended Protection for Authentication
â€¢
EPA (Extended Protection for Authentication)
â€“
Channel Binding: NTLM authentication protection on TLS channel
â€“
Calculates a Channel Binding Token (CBT) based on the TLS certificate and the
user's NT hash, then adds it to the NTLM_AUTHENTICATE message
Attacked Target
Victim
Attacker
NTLM_AUTH + CBT
CalculateCBT(NT hash of
DOMAIN\victim,
, â€¦)
NTLM_AUTH + CBT
â€¢
Channel Binding Token in
NTLMSSP over SMB are all zero
by default
â€¢
But fortunately, EPA is disabled 
on these Exchange endpoints
by default
Extended Protection for Authentication
Does XLAB\Exchange1$ has any special privileges on these endpoints? ðŸ¤”
â€¢
ExtendedRights ms-Exch-EPI-Token-Serialization
â€¢
All members of the Exchange Servers group have token serialization
rights on all Exchange Servers in the AD
Exchange Server Machine Account
EWS Impersonation
â€¢
EWS creates security access tokens based on 
â€¢
Users with token serialization rights can impersonate other Exchange users
EWS Impersonation
â€¢
Set UserSid in SerializedSecurityContext to impersonate other users
â€“
You can use LDAP or impacket/exchanger.py to get UserSids
â€¢
EWS supports almost all operations supported by Outlook
â€“
FindFolder: Find all pre-defined and customed folders
â€“
FindItem: Find all items (mails for instance) in folders
â€“
GetItem: Read mails
â€“
CreateItem: Send mails
â€“
GetAttachment: Read mail attachments
â€“
UpdateInboxRules: Redirect inbox mails to other users
â€“
InstallApp: Install a mail app for Outlook
â€“
â€¦
EWS Operations
https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-operations-in-exchange
â€¢
Found by @tifkin_ from SpecterOps
â€¢
Print System Remote Protocol (MS-RPRN)
â€“
Printer Spooler Service
â€“
Enabled by default
â€¢
RpcRemoteFindFirstPrinterChangeNotificationEx API
â€“
pszLocalMachine can be set to a UNC path
â€“
Any domain users / computers can force REMOTESERVER$ to establish SMB 
connections with any machine
The Printer Bug
DWORD RpcRemoteFindFirstPrinterChangeNotificationEx(
[in] PRINTER_HANDLE hPrinter,
[in] DWORD fdwFlags,
[in] DWORD fdwOptions,
[in, string, unique] wchar_t* pszLocalMachine,
[in] DWORD dwPrinterLocal,
[in, unique] RPC_V2_NOTIFY_OPTIONS* pOptions
);
The Exploit Chain
Exchange1
XLAB\attacker
Exchange2
Printer Bug
XLAB\Exchange1$ NTLM authentication
Relay the NTLM authentication to EWS
Log in successfully as XLAB\Exchange1$
Impersonate PI:EMAIL
Read mails, download attachments, send mails etc.
as PI:EMAIL
Demo
â€¢
The April 2021 Patch breaks the exploit chain
â€“
no longer allows machine accounts to log in to Exchange endpoints
â€¢
Fixed on Patch Tuesday in July and assigned CVE-2021-33768
Patches
Conclusion
Arbitrary Mailbox 
Takeover
A normal