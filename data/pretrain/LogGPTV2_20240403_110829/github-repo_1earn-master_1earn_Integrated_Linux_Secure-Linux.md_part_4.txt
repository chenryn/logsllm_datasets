# echo "flush ruleset" > /tmp/nftables
å¯¼å‡ºå½“å‰è§„åˆ™é›†ï¼š
# nft list ruleset >> /tmp/nftables
å¯ä»¥ç›´æ¥ä¿®æ”¹/tmp/nftablesæ–‡ä»¶ï¼Œä½¿æ›´æ”¹ç”Ÿæ•ˆåˆ™è¿è¡Œï¼š
# nft -f /tmp/nftables
```
---
### ç¦ping
**ä¸´æ—¶æ€§,é‡å¯åå¤±æ•ˆ**
```bash
echo 0 >/proc/sys/net/ipv4/icmp_echo_ignore_all     # å…è®¸ ping
echo 1 >/proc/sys/net/ipv4/icmp_echo_ignore_all     # ç¦æ­¢ ping
```
**é•¿æœŸæ€§**
```bash
vim /etc/rc.d/rc.local
echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all
```
æˆ–
```bash
vim /etc/sysctl.conf
net.ipv4.icmp_echo_ignore_all=1
```
`sysctl -p` ä½¿æ–°é…ç½®ç”Ÿæ•ˆ
---
### SSH
**æ–‡ç« **
- [Multiple Ways to Secure SSH Port](http://www.hackingarticles.in/multiple-ways-to-secure-ssh-port/)
**æŸ¥**
- **æŸ¥è¯¢å¯ä»¥è¿œç¨‹ç™»å½•çš„å¸å·ä¿¡æ¯**
    ```bash
    awk '/\$1|\$6/{print $1}' /etc/shadow
    ```
- **æŸ¥çœ‹å°è¯•æš´åŠ›ç ´è§£æœºå™¨å¯†ç çš„äºº**
    ```bash
    # Debian ç³»çš„å‘è¡Œç‰ˆ
    grep "Failed password for root" /var/log/auth.log | awk '{print $11}' | sort | uniq -c | sort -nr | more
    # Red Hat ç³»çš„å‘è¡Œç‰ˆ
    grep "Failed password for root" /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more
    ```
- **æŸ¥çœ‹æš´åŠ›çŒœç”¨æˆ·åçš„äºº**
    ```bash
    # Debian ç³»çš„å‘è¡Œç‰ˆ
    grep "Failed password for invalid user" /var/log/auth.log | awk '{print $13}' | sort | uniq -c | sort -nr | more
    # Red Hat ç³»çš„å‘è¡Œç‰ˆ
    grep "Failed password for invalid user" /var/log/secure | awk '{print $13}' | sort | uniq -c | sort -nr | more
    grep "Failed password" /var/log/secure | awk {'print $9'} | sort | uniq -c | sort -nr
    grep -o "Failed password" /var/log/secure|uniq -c
    ```
- **IP ä¿¡æ¯**
    ```bash
    # Debian ç³»çš„å‘è¡Œç‰ˆ
    grep "Failed password for root" /var/log/auth.log | awk '{print $11}' | sort | uniq -c | sort -nr | more
    # Red Hat ç³»çš„å‘è¡Œç‰ˆ
    grep "Failed password for root" /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more
    ```
- **ç™»å½•æˆåŠŸ**
    ```bash
    # Debian ç³»çš„å‘è¡Œç‰ˆ
    grep "Accepted " /var/log/auth.log | awk '{print $11}' | sort | uniq -c | sort -nr | more
    # Red Hat ç³»çš„å‘è¡Œç‰ˆ
    grep 'Accepted' /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr
    grep "Accepted " /var/log/secure | awk '{print $1,$2,$3,$9,$11}'
    grep "Accepted " /var/log/secure* | awk '{print $1,$2,$3,$9,$11}'
    ```
- **ç§é’¥**
    ```bash
    ll -al /etc/ssh/
    ll -al /root/.ssh/
    ```
**é˜²**
- **ping é’¥åŒ™**
    - [ä½¿ç”¨ ping é’¥åŒ™ä¸´æ—¶å¼€å¯ SSH:22 ç«¯å£,å®ç°è¿œç¨‹å®‰å…¨ SSH ç™»å½•ç®¡ç†å°±è¿™ä¹ˆç®€å•](https://www.cnblogs.com/martinzhang/p/5348769.html)
    ```bash
    # è§„åˆ™1 åªæ¥å—Dataä¸º1078å­—èŠ‚çš„pingåŒ…,å¹¶å°†æºIPè®°å½•åˆ°è‡ªå®šä¹‰åä¸ºsshKeyListçš„åˆ—è¡¨ä¸­
    iptables -A INPUT -p icmp -m icmp --icmp-type 8 -m length --length 1078 -m recent --name sshKeyList --set -j ACCEPT
    # è§„åˆ™2 è‹¥30ç§’å†…å‘é€æ¬¡æ•°è¾¾åˆ°6æ¬¡(åŠæ›´é«˜),å½“å‘èµ·SSH:22æ–°è¿æ¥è¯·æ±‚æ—¶æ‹’ç»
    iptables -A INPUT -p tcp -m tcp --dport 22 --syn -m recent --name sshKeyList --rcheck --seconds 30 --hitcount 6 -j DROP
    # è§„åˆ™3 è‹¥30ç§’å†…å‘é€æ¬¡æ•°è¾¾åˆ°5æ¬¡,å½“å‘èµ·SSH:22æ–°è¿æ¥è¯·æ±‚æ—¶æ”¾è¡Œ
    iptables -A INPUT -p tcp -m tcp --dport 22 --syn -m recent --name sshKeyList --rcheck --seconds 30 --hitcount 5 -j ACCEPT
    # è§„åˆ™4 å¯¹äºå·²å»ºç«‹çš„è¿æ¥æ”¾è¡Œ
    iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
    # è§„åˆ™5 è€è§„çŸ©:æœ€åçš„æ‹’ç»
    iptables -A INPUT -j DROP
    ```
- **æ›´æ”¹é»˜è®¤ç«¯å£**
    ä¿®æ”¹ `/etc/ssh/sshd_config` æ–‡ä»¶,å°†å…¶ä¸­çš„ Port 22 æ”¹ä¸ºæŒ‡å®šçš„ç«¯å£
    `!!! è­¦å‘Š,è®°å¾—é˜²ç«å¢™è¦å…ˆæ”¾è¡Œç«¯å£,ä¸ç„¶ä½ çš„è¿œç¨‹ä¸»æœºå°±è¿ä¸ä¸Šäº†ğŸ¤£!!!`
    ```
    service ssh restart
    ```
- **é…ç½®ä½¿ç”¨ RSA ç§é’¥ç™»å½•**
    1. å…ˆç”Ÿæˆä½ çš„å®¢æˆ·ç«¯çš„å¯†é’¥,åŒ…æ‹¬ä¸€ä¸ªç§é’¥å’Œå…¬é’¥
        ```bash
        ssh-keygen -t rsa
        ```
    2. æŠŠå…¬é’¥æ‹·è´åˆ°æœåŠ¡å™¨ä¸Š,æ³¨æ„,ç”Ÿæˆç§é’¥çš„æ—¶å€™,æ–‡ä»¶åæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„,ä¸”å¯ä»¥å†åŠ ä¸€å±‚å¯†ç ,æ‰€ä»¥å»ºè®®æ–‡ä»¶åå–è‡ªå·±èƒ½è¯†åˆ«å‡ºå“ªå°æœºå™¨çš„åå­—.
        ```bash
        cd /root/.ssh
        scp id_rsa.pub PI:EMAIL:~/
        ```
    3. ç„¶ååœ¨æœåŠ¡å™¨ä¸Š,ä½ çš„ç”¨æˆ·ç›®å½•ä¸‹,æ–°å»º `.ssh` æ–‡ä»¶å¤¹,å¹¶å°†è¯¥æ–‡ä»¶å¤¹çš„æƒé™è®¾ä¸º 700
        ```bash
        cd
        mkdir .ssh
        chmod 700 .ssh
        ```
    4. æ–°å»ºä¸€ä¸ª authorized_keys,è¿™æ˜¯é»˜è®¤å…è®¸çš„ key å­˜å‚¨çš„æ–‡ä»¶.å¦‚æœå·²ç»å­˜åœ¨,åˆ™åªéœ€è¦å°†ä¸Šä¼ çš„ id_rsa.pub æ–‡ä»¶å†…å®¹è¿½åŠ è¿›å»å³å¯,å¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºå¹¶æ”¹æƒé™ä¸º 400 å³å¯. ç„¶åç¼–è¾‘ ssh çš„é…ç½®æ–‡ä»¶
        ```bash
        mv id_rsa.pub .ssh
        cd .ssh
        cat id_rsa.pub >> authorized_keys
        chmod 600 authorized_keys
        ```
        ```bash
        vim /etc/ssh/sshd_config
        RSAAuthentication yes                           # RSA è®¤è¯
        PubkeyAuthentication yes                        # å¼€å¯å…¬é’¥éªŒè¯
        AuthorizedKeysFile /root/.ssh/authorized_keys   # éªŒè¯æ–‡ä»¶è·¯å¾„
        PasswordAuthentication no                       # ç¦æ­¢å¯†ç ç™»å½•
        ```
        `service sshd restart` é‡å¯ sshd æœåŠ¡
    5. æµ‹è¯•ä½¿ç”¨ç§é’¥ç™»å½•
        ```bash
        ssh root@x.x.x.x -i id_rsa
        ```
- **ç¦æ­¢ root ç”¨æˆ·ç™»å½•**
    å¯ä»¥å»ºä¸€ä¸ªç”¨æˆ·æ¥ä¸“é—¨ç®¡ç†,è€Œéç›´æ¥ä½¿ç”¨ root ç”¨æˆ·,ä¿®æ”¹ /etc/ssh/sshd_config
    ```vim
    vim /etc/ssh/sshd_config
    PermitRootLogin no
    ```
- **ä½¿ç”¨ Fail2ban**
    - [fail2ban](https://github.com/fail2ban/fail2ban) ,è¯¦ç»†æ­å»ºæ­¥éª¤è¯·ç§»æ­¥ [Power-Linux](./Power-Linux.md##Fail2ban)
- **SSH é™·é˜±**
    - [skeeto/endlessh](https://github.com/skeeto/endlessh) - è“é˜Ÿ SSH é™·é˜±
---
### æ–‡ä»¶å…±äº«
**NFSæœåŠ¡**
é…ç½®æ–‡ä»¶
```
/etc/exports
```
**TFTPæœåŠ¡**
é…ç½®æ–‡ä»¶
```
/etc/default/tftpd-hpa
/etc/xinetd.d/tftp
```
**sambaæœåŠ¡**
é…ç½®æ–‡ä»¶
```
/etc/samba/smb.conf
```
---
## åŠ å›º
### æŸ¥åé—¨
**ç›¸å…³æ–‡ç« **
- [linuxå¸¸è§backdooråŠæ’æŸ¥æŠ€æœ¯](https://xz.aliyun.com/t/4090)
**æ·»åŠ  root æƒé™åé—¨ç”¨æˆ·**
æ£€æŸ¥ `/etc/passwd` æ–‡ä»¶æ˜¯å¦æœ‰å¼‚å¸¸
**vim åé—¨**
æ£€æµ‹å¯¹åº” vim è¿›ç¨‹å·è™šæ‹Ÿç›®å½•çš„ map æ–‡ä»¶æ˜¯å¦æœ‰ python å­—çœ¼.
æŸ¥çœ‹è¿æ¥æƒ…å†µ `netstat -antlp`
ä¾‹å¦‚å‘ç° vim pid ä¸º 12
```
file /proc/12/exe
more /proc/12/cmdline
more /proc/12/maps | grep python
```
**strace è®°å½•**
é€šè¿‡æ’æŸ¥ shell çš„é…ç½®æ–‡ä»¶æˆ–è€… `alias` å‘½ä»¤å³å¯å‘ç°,ä¾‹å¦‚ `~/.bashrc` å’Œ `~/.bash_profile` æ–‡ä»¶æŸ¥çœ‹æ˜¯å¦æœ‰æ¶æ„çš„ alias é—®é¢˜.
**å®šæ—¶ä»»åŠ¡å’Œå¼€æœºå¯åŠ¨é¡¹**
 ä¸€èˆ¬é€šè¿‡ `crontab -l` å‘½ä»¤å³å¯æ£€æµ‹åˆ°å®šæ—¶ä»»åŠ¡åé—¨.ä¸åŒçš„ linux å‘è¡Œç‰ˆå¯èƒ½æŸ¥çœ‹å¼€æœºå¯åŠ¨é¡¹çš„æ–‡ä»¶ä¸å¤§ç›¸åŒ,Debian ç³» linux ç³»ç»Ÿä¸€èˆ¬æ˜¯é€šè¿‡æŸ¥çœ‹ `/etc/init.d` ç›®å½•æœ‰æ— æœ€è¿‘ä¿®æ”¹å’Œå¼‚å¸¸çš„å¼€æœºå¯åŠ¨é¡¹.è€Œ Redhat ç³»çš„ linux ç³»ç»Ÿä¸€èˆ¬æ˜¯æŸ¥çœ‹ `/etc/rc.d/init.d` æˆ–è€… `/etc/systemd/system` ç­‰ç›®å½•.
**é¢„åŠ è½½å‹åŠ¨æ€é“¾æ¥åº“åé—¨ ld.so.preload**
é€šè¿‡ `strace` å‘½ä»¤å»è·Ÿè¸ªé¢„åŠ è½½çš„æ–‡ä»¶æ˜¯å¦ä¸º `/etc/ld.so.preload` ,ä»¥åŠæ–‡ä»¶ä¸­æ˜¯å¦æœ‰å¼‚å¸¸çš„åŠ¨æ€é“¾æ¥åº“.ä»¥åŠæ£€æŸ¥æ˜¯å¦è®¾ç½® LD_PRELOAD ç¯å¢ƒå˜é‡ç­‰.æ³¨æ„:åœ¨è¿›è¡Œåº”æ€¥å“åº”çš„æ—¶å€™æœ‰å¯èƒ½ç³»ç»Ÿå‘½ä»¤è¢«æ›¿æ¢æˆ–è€…å…³é”®ç³»ç»Ÿå‡½æ•°è¢«åŠ«æŒ(ä¾‹å¦‚é€šè¿‡é¢„åŠ è½½å‹åŠ¨æ€é“¾æ¥åº“åé—¨),å¯¼è‡´ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œä¸æ­£å¸¸,è¿™ä¸ªæ—¶å€™å¯ä»¥ä¸‹è½½ busybox.ä¸‹è½½ç¼–è¯‘å¥½çš„å¯¹åº”å¹³å°ç‰ˆæœ¬çš„ busybox,æˆ–è€…ä¸‹è½½æºç è¿›è¡Œç¼–è¯‘é€šè¿‡Uç›˜æ‹·è´åˆ°ç³»ç»Ÿä¸Š,å› ä¸º busybox æ˜¯é™æ€ç¼–è¯‘çš„,ä¸ä¾èµ–äºç³»ç»Ÿçš„åŠ¨æ€é“¾æ¥åº“,busybox çš„ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹ busybox ls,busybox ps -a.
**å†…æ ¸çº§ rootkit**
å¯ä»¥é€šè¿‡ unhide ç­‰å·¥å…·è¿›è¡Œæ’æŸ¥,æ›´å¤šå†…å®¹è§ [åº”æ€¥](../../Security/BlueTeam/åº”æ€¥.md#rootkit)
**æ·±ä¿¡æœ Web åé—¨æ‰«æ**
http://edr.sangfor.com.cn/backdoor_detection.html
---
### æ€æ¯’
**[ClamavNet](https://www.clamav.net/downloads)**
---
### é…ç½® pam.d ç­–ç•¥
- [pam](./å®éªŒ/pam.md)
- [è®¤è¯](./ç¬”è®°/è®¤è¯.md#pam)