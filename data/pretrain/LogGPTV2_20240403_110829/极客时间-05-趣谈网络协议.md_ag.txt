# 第6讲 \| 交换机与VLAN：办公室太复杂，我要回学校上一次，我们在宿舍里组建了一个本地的局域网LAN，可以愉快地玩游戏了。这是一个非常简单的场景，因为只有一台交换机，电脑数目很少。今天，让我们切换到一个稍微复杂一点的场景，办公室。
## 拓扑结构是怎么形成的？ {#07.html#-}我们常见到的办公室大多是一排排的桌子，每个桌子都有网口，一排十几个座位就有十几个网口，一个楼层就会有几十个甚至上百个网口。如果算上所有楼层，这个场景自然比你宿舍里的复杂多了。具体哪里复杂呢？我来给你具体讲解。首先，这个时候，一个交换机肯定不够用，需要多台交换机，交换机之间连接起来，就形成一个稍微复杂的**拓扑结构**。我们先来看**两台交换机**的情形。两台交换机连接着三个局域网，每个局域网上都有多台机器。如果机器1 只知道机器 4 的 IP 地址，当它想要访问机器4，把包发出去的时候，它必须要知道机器 4 的 MAC 地址。![](Images/7902eae66dcaf40bf265ccc4478b6eef.png){savepage-src="https://static001.geekbang.org/resource/image/7a/73/7a40046c5a2c7f7cd3c95b54488b9773.jpg"}于是机器 1 发起广播，机器 2收到这个广播，但是这不是找它的，所以没它什么事。交换机 A一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是，除了广播包来的方向外，它还要转发给其他所有的网口。于是机器3 也收到广播信息了，但是这和它也没什么关系。当然，交换机 B也是能够收到广播信息的，但是这时候它也是不知道任何拓扑信息的，因而也是进行广播的策略，将包转发到局域网三。这个时候，机器4 和机器 5 都收到了广播信息。机器 4 主动响应说，这是找我的，这是我的 MAC地址。于是一个 ARP 请求就成功完成了。在上面的过程中，交换机 A 和交换机 B 都是能够学习到这样的信息：机器 1是在左边这个网口的。当了解到这些拓扑信息之后，情况就好转起来。当机器 2要访问机器 1 的时候，机器 2 并不知道机器 1 的 MAC 地址，所以机器 2会发起一个 ARP 请求。这个广播消息会到达机器 1，也同时会到达交换机A。这个时候交换机 A 已经知道机器 1是不可能在右边的网口的，所以这个广播信息就不会广播到局域网二和局域网三。当机器 3 要访问机器 1 的时候，也需要发起一个广播的 ARP请求。这个时候交换机 A 和交换机 B 都能够收到这个广播请求。交换机 A当然知道主机 A是在左边这个网口的，所以会把广播消息转发到局域网一。同时，交换机 B收到这个广播消息之后，由于它知道机器 1是不在右边这个网口的，所以不会将消息广播到局域网三。
## 如何解决常见的环路问题？ {#07.html#-}这样看起来，两台交换机工作得非常好。随着办公室越来越大，交换机数目肯定越来越多。当整个拓扑结构复杂了，这么多网线，绕过来绕过去，不可避免地会出现一些意料不到的情况。其中常见的问题就是**环路问题**。例如这个图，当两个交换机将两个局域网同时连接起来的时候。你可能会觉得，这样反而有了高可用性。但是却不幸地出现了环路。出现了环路会有什么结果呢？``{=html}![](Images/e2f4d7e92cf28b279cd1fe3193514e42.png){savepage-src="https://static001.geekbang.org/resource/image/c8/d2/c829b28978c3d9686680e4b62fdf53d2.jpg"}我们来想象一下机器 1 访问机器 2 的过程。一开始，机器 1 并不知道机器 2 的MAC 地址，所以它需要发起一个 ARP 的广播。广播到达机器 2，机器 2 会把 MAC地址返回来，看起来没有这两个交换机什么事情。但是问题来了，这两个交换机还是都能够收到广播包的。交换机 A一开始是不知道机器 2在哪个局域网的，所以它会把广播消息放到局域网二，在局域网二广播的时候，交换机B 右边这个网口也是能够收到广播消息的。交换机 B会将这个广播息信息发送到局域网一。局域网一的这个广播消息，又会到达交换机A 左边的这个接口。交换机 A 这个时候还是不知道机器 2在哪个局域网，于是将广播包又转发到局域网二。左转左转左转，好像是个圈哦。可能有人会说，当两台交换机都能够逐渐学习到拓扑结构之后，是不是就可以了？别想了，压根儿学不会的。机器 1 的广播包到达交换机 A 和交换机 B的时候，本来两个交换机都学会了机器 1 是在局域网一的，但是当交换机 A将包广播到局域网二之后，交换机 B 右边的网口收到了来自交换机 A的广播包。根据学习机制，这彻底损坏了交换机 B 的三观，刚才机器 1还在左边的网口呢，怎么又出现在右边的网口呢？哦，那肯定是机器 1换位置了，于是就误会了，交换机 B 就学会了，机器 1是从右边这个网口来的，把刚才学习的那一条清理掉。同理，交换机 A右边的网口，也能收到交换机 B转发过来的广播包，同样也误会了，于是也学会了，机器 1从右边的网口来，不是从左边的网口来。然而当广播包从左边的局域网一广播的时候，两个交换机再次刷新三观，原来机器1是在左边的，过一会儿，又发现不对，是在右边的，过一会，又发现不对，是在左边的。这还是一个包转来转去，每台机器都会发广播包，交换机转发也会复制广播包，当广播包越来越多的时候，按照上一节讲过一个共享道路的算法，也就是路会越来越堵，最后谁也别想走。所以，必须有一个方法解决环路的问题，怎么破除环路呢？
## STP 协议中那些难以理解的概念 {#07.html#stp-}在数据结构中，有一个方法叫作**最小生成树**。有环的我们常称为**图**。将图中的环破了，就生成了**树**。在计算机网络中，生成树的算法叫作**STP**，全称**SpanningTree Protocol**。STP协议比较复杂，一开始很难看懂，但是其实这是一场血雨腥风的武林比武或者华山论剑，最终决出五岳盟主的方式。![](Images/193ee1acfefcddfbc89da4fb24a98336.png){savepage-src="https://static001.geekbang.org/resource/image/5d/ba/5d3ba40babdacc735f617cc2356fefba.jpg"}在 STP协议里面有很多概念，译名就非常拗口，但是我一作比喻，你很容易就明白了。-   **Root    Bridge**，也就是**根交换机**。这个比较容易理解，可以比喻为"掌门"交换机，是某棵树的老大，是掌门，最大的大哥。-   **Designated    Bridges**，有的翻译为**指定交换机**。这个比较难理解，可以想像成一个"小弟"，对于树来说，就是一棵树的树枝。所谓"指定"的意思是，我拜谁做大哥，其他交换机通过这个交换机到达根交换机，也就相当于拜他做了大哥。这里注意是树枝，不是叶子，因为叶子往往是主机。-   **Bridge Protocol Data Units （BPDU）**    ，**网桥协议数据单元**。可以比喻为"相互比较实力"的协议。行走江湖，比的就是武功，拼的就是实力。当两个交换机碰见的时候，也就是相连的时候，就需要互相比一比内力了。BPDU    只有掌门能发，已经隶属于某个掌门的交换机只能传达掌门的指示。-   **Priority Vector**，**优先级向量**。可以比喻为实力    （值越小越牛）。实力是啥？就是一组 ID 数目，\[Root Bridge ID, Root    Path Cost, Bridge ID, and Port    ID\]。为什么这样设计呢？这是因为要看怎么来比实力。先看 Root Bridge    ID。拿出老大的 ID 看看，发现掌门一样，那就是师兄弟；再比 Root Path    Cost，也即我距离我的老大的距离，也就是拿和掌门关系比，看同一个门派内谁和老大关系铁；最后比    Bridge ID，比我自己的 ID，拿自己的本事比。
## STP 的工作过程是怎样的？ {#07.html#stp-}接下来，我们来看 STP 的工作过程。一开始，江湖纷争，异常混乱。大家都觉得自己是掌门，谁也不服谁。于是，所有的交换机都认为自己是掌门，每个网桥都被分配了一个ID。这个 ID里有管理员分配的优先级，当然网络管理员知道哪些交换机贵，哪些交换机好，就会给它们分配高的优先级。这种交换机生下来武功就很高，起步就是乔峰。![](Images/269e04815e42e13cde69cb2628838bb3.png){savepage-src="https://static001.geekbang.org/resource/image/26/54/2666530a121ff1d1b079a330427efb54.jpg"}既然都是掌门，互相都连着网线，就互相发送 BPDU来比功夫呗。这一比就发现，有人是岳不群，有人是封不平，赢的接着当掌门，输的就只好做小弟了。当掌门的还会继续发BPDU，而输的人就没有机会了。它们只有在收到掌门发的 BPDU的时候，转发一下，表示服从命令。![](Images/fada2fbe4a5eeee0e002541483593440.png){savepage-src="https://static001.geekbang.org/resource/image/e7/11/e7c0deeff171c9eb7e95dde2c73fe011.jpg"}数字表示优先级。就像这个图，5 和 6 碰见了，6的优先级低，所以乖乖做小弟。于是一个小门派形成，5 是掌门，6是小弟。其他诸如 1-7、2-8、3-4这样的小门派，也诞生了。于是江湖出现了很多小的门派，小的门派，接着合并。合并的过程会出现以下四种情形，我分别来介绍。
### 情形一：掌门遇到掌门 {#07.html#-}当 5 碰到了 1，掌门碰见掌门，1 觉得自己是掌门，5 也刚刚跟别人 PK完成为掌门。这俩掌门比较功夫，最终 1 胜出。于是输掉的掌门 5就会率领所有的小弟归顺。结果就是 1 成为大掌门。![](Images/65e66f49a9b44e7a1d7a0d2cf0e25d4c.png){savepage-src="https://static001.geekbang.org/resource/image/24/11/24fdcb9a11c5998e80738f502b2eff11.jpg"}
### 情形二：同门相遇 {#07.html#-}同门相遇可以是掌门与自己的小弟相遇，这说明存在"环"了。这个小弟已经通过其他门路拜在你门下，结果你还不认识，就PK了一把。结果掌门发现这个小弟功夫不错，不应该级别这么低，就把它招到门下亲自带，那这个小弟就相当于升职了。我们再来看，假如 1 和 6 相遇。6 原来就拜在 1 的门下，只不过 6 的上司是5，5 的上司是 1。1 发现，6 距离我才只有 2，比从 5 这里过来的5（=4+1）近多了，那 6 就直接汇报给我吧。于是，5 和 6 分别汇报给 1。![](Images/26d33afbdcc6b8a5787b5d835e42aee1.png){savepage-src="https://static001.geekbang.org/resource/image/89/90/899077ce9678c84d8b1a265ced5efb90.jpg"}同门相遇还可以是小弟相遇。这个时候就要比较谁和掌门的关系近，当然近的当大哥。刚才5 和 6 同时汇报给 1 了，后来 5 和 6 再比较功夫的时候发现，5 你直接汇报给1 距离是 4，如果 5 汇报给 6 再汇报给 1，距离只有 2+1=3，所以 5 干脆拜 6为上司。