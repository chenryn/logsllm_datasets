IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
Request Message
ProcessHandle
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
Request Message
ProcessHandle
ProcessInformationClass
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
Request Message
ProcessHandle
ProcessInformationClass
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
Request Message
ProcessHandle
ProcessInformationClass
ProcessInformationLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
Request Message
ProcessHandle
ProcessInformationClass
ProcessInformationLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Request Message
ProcessHandle
ProcessInformationClass
ProcessInformationLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Request Message
ProcessHandle
ProcessInformationClass
ProcessInformationLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Response Message
ReturnLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Response Message
ReturnLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Response Message
ProcessInformation
ReturnLength
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Response Message
ProcessInformation
ReturnLength
Return value
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
Response Message
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
TARGET SIDE
ATTACKER SIDE
ProcessInformation
ReturnLength
Return value
Handling
ARGUMENTS
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
NTSTATUS NtQueryInformationProcess(
IN HANDLE
ProcessHandle,
IN PROCESSINFOCLASS
ProcessInformationClass,
OUT PVOID
ProcessInformation,
IN ULONG
ProcessInformationLength,
OUT PULONG
ReturnLength
);
ATTACKER SIDE
TARGET SIDE
Response Message
ProcessInformation
ReturnLength
Return value
Attacker OS
P
r
o
c
e
s
s
Malicious 
code
Target OS
P
r
o
c
e
s
s
Innocent 
code
RECAP
Target & attacker stubs
Load the PE file and hook 
system API functions
Execution flow – hook, 
serialize, send, execute, 
serialize, send, return. Repeat.
API
Running
MALPROXY
ATTACKER SIDE
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
IMPORT ADDRESS TABLE
NtQuerySystemInformation
Kernel32.dll
OpenProcess
Kernel32.dll
ReadProcessMemory
Ntdll.dll
BCryptGenerateSymetricKey
Bcrypt.dll
ConvertSidToStringSidW
Advapi32.dll
…
…
RtlAdjustPrivilege
Ntdll.dll
NtQueryInformationProcess
Ntdll.dll
RtlEqualUnicodeString
Ntdll.dll
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
IMPORT ADDRESS TABLE
NtQuerySystemInformation
Malproxy
OpenProcess
Malproxy
ReadProcessMemory
Malproxy
BCryptGenerateSymetricKey
Bcrypt.dll
ConvertSidToStringSidW
Advapi32.dll
…
…
RtlAdjustPrivilege
Malproxy
NtQueryInformationProcess
Malproxy
RtlEqualUnicodeString
Ntdll.dll
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
NtQuerySystemInformation
Chrome.exe, explorer.exe  
Calc.exe, lsass.exe
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
NtQuerySystemInformation
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
NtQuerySystemInformation
OpenProcess
Handle 0x00000080
PID 1234
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
NtQuerySystemInformation
OpenProcess
NtQueryInformationProcess
Handle 0x00000080
PEB at 0xdeadbeef
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
NtQuerySystemInformation
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
Read 0xdeadbeef
[0x12, 0x34, 0x56, 0x78]
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
RtlAdjustPrivilege
NtQuerySystemInformation
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
TARGET SIDE
Running
MALPROXY
ATTACKER SIDE
RtlAdjustPrivilege
NtQuerySystemInformation
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
PWNED!
RtlAdjustPrivilege
NtQuerySystemInformation
RtlEqualUnicodeString
OpenProcess
NtQueryInformationProcess
ReadProcessMemory
BCryptDecrypt
TopSecretPassword
TARGET SIDE
DEMO
Endpoint protections 
BYPASS
Behavioral 
Signatures
Bypassing 
Heuristic Rules
Bypassing 
Static Signatures
Security Solution
Mimikatz sekurlsa::logonpasswords
Microsoft Defender
Malproxied!
Symantec Norton Security
Malproxied!
Kaspersky Internet Security
Blocks ReadProcessMemory without a verdict
ESET Smart Security
Malproxied!
Avast Free Antivirus
Blocks OpenProcess on lsass.exe without a verdict
Bitdefender Total Security
Malproxied!
McAfee Total Protection
Malproxied!
MITIGATIONS
Any more ideas?
Hunt and sign 
the target-side 
proxy stub
Improve the 
behavioral 
signature engines 
to handle their 
known weaknesses
MITIGATIONS
Any more ideas?
/dev/null
Hunt and sign 
the target-side 
proxy stub
Improve the 
behavioral 
signature engines 
to handle their 
known weaknesses
CREDITS
The Crazy Ideas Section - Remote Syscalls by Yaron Shani:
http://breaking-the-system.blogspot.com/2016/06/the-crazy-ideas-section-
remote-syscalls.html
Syscall Proxying - Simulating remote execution by Maximiliano Caceres:
http://www.vodun.org/papers/exploits/SyscallProxying.pdf
Syscall Proxying || Pivoting Systems by Filipe Balestra and Rodrigo Rubira Branco:
https://www.kernelhacking.com/rodrigo/docs/H2HCIII.pdf
Questions?