DefCon (China) 1, Beijing 2019 
打破后端限制！ 
Gregory Pickett, 获得CISSP, GCIA, GPEN等
多项认证 
芝加哥, 伊利利诺斯州 
PI:EMAIL 
Hellfire Security 
概述 
  交通系统 
  逆向⼯工程 
  我的发现 
  漏漏洞洞利利⽤用 
  经验总结 
简史 
 地铁⿊黑客剖析(2008) 
 NFC地铁⿊黑客(2012) 
 如何侵⼊入全国交通⽹网络（2012） 
 利利⽤用边信道攻击破解韩国交通卡
（2017） 
有何不不同 
 绝不不违法 
 我们不不会偷偷溜溜进⻋车站 
 我们不不会攻击终端 
 我们不不利利⽤用社会⼯工程学，也不不攻击有线
/⽆无线⽹网络 
 ⽆无关硬件 
 我们不不会破解任何⼈人的密码 
 我们不不会克隆隆磁条、⽆无线射频卡、NF
C等 
有何不不同 
 ⽽而是关于 
 应⽤用程序的逻辑缺陷 
 好吧，实际上⽤用到了了克隆隆，但不不是将
其作为漏漏洞洞进⾏行行利利⽤用 
 利利⽤用应⽤用程序安全来攻击现实世界中
复杂的多层次解决⽅方案 
城铁 
 曼⾕谷捷运公司（BTS） 
 曼⾕谷城铁交通系统 
 服务于整个曼⾕谷地区 
 由曼⾕谷捷运公司（BTSC）运营 
 两条城铁线，沿途共43个⻋车站 
⻋车票 
 储值卡（NFC） 
 单⽇日票（磁条）和单程票（磁条） 
 设有两个磁条 
 打孔穿过其中⼀一个磁条 
 薄厚仅0.27毫⽶米 
⻋车票 
⻋车票 
⻋车票 
闸⻔门 
 进站 
 出站 
为什什么选择他们？ 
 真的只有磁条吗？ 
 ⼀一定还有其他东⻄西！ 
 ⻓长久以来饱受威胁 
 不不得不不继续前进… 
设备 
 标准读/写器器 
 中国制造 
 标准或原始读数 
 错误罕⻅见 
 可靠的性能 
问题 
 数据位置 
 编码⽅方案 
 数据变化 
 数据含义 
 系统响应 
 数据篡改 
 重复状态或⽆无序转换 
实验室⼯工作 
 读取磁条 
 解码数据 
实验室⼯工作 
实验室⼯工作 
 尝试标准解码 
 国际标准化组织 
 6位字符集和4位字符集 
 有些使⽤用奇偶校验，有些则不不使⽤用 
 尝试对其前后数据解码 
 未使⽤用相关标准 
实验室⼯工作 
* The section marked “Known” is always 100 + the price of the ticket 
实验室⼯工作 
 没有加密 
 没有奇偶校验 
 没有纵向冗余检查（LRC） 
 没有时间戳 
现场⼯工作 
 在城铁系统中使⽤用⻋车票 
 每次使⽤用不不同输⼊入值 
 观察数据变化 
 通过变化来确认其含义 
现场⼯工作 
现场⼯工作 
GUID%
GUID%
GUID%
Station%
Dispenser%
Station%
Turn-style%
现场⼯工作 
0x00E078401A327826E91E76ED00FF7400D20FE948AE0A41
“Issued”
“Used”
“Collected”
Buying
Entering
Exiting
0x00E078401A327826E91E76ED00FF74801C0FE948D8681B
0x00E078401A327826E91E76ED00FF74801C0FE948D8681B
现场⼯工作 
 对于单⽇日票，已知部分或者“100+
价格”部分，被⽤用来追踪⾏行行程 
 单⽇日票有⼀一项独特的“永不不变更更”项 
处理理规则 
 进站， 
 购票前，⻋车票必须处于“collected”状态 
 进站前，⻋车票必须处于“Issued”阶段 
 出站, 出站前，⻋车票必须处
于“Used”状态 
军政府的研究 
 局势 
 合法权益 
尽量量不不被逮捕 
 躲避安检 
 浸渍 
 终极⼿手段 
当地⽂文化 
 因扰乱秩序⽽而受罚 
 不不会留留意 
 不不会关⼼心 
 哪些规程？ 
 Avoiding Farang 
利利⽤用该系统 
 当前已知信息 
 系统安全措施 
 BTS的假设 
 对假设进⾏行行攻击 
 史诗般的失败！ 
当前已知信息 
 基于对象 
 物理理对象 
 数据库对象 
 属性 
 识别 
 值 
 位置 
当前已知信息 
 状态 
 Issued 
 Used 
 Collected 
 历史 
系统安全措施 
 交通卡的组成和设计 
 镜像物理理对象和数据库对象 
 处理理规则定义了了如何有效使⽤用对象 
 使⽤用周期限制为24⼩小时 
 交通卡⽤用完后将被回收 
BTS的假设 
 没⼈人能复制我们的交通卡 
 我们的系统只存在有效对象 
 处理理规则能够防⽌止⻋车票并发使⽤用 
 使⽤用周期的限制降低了了损害的发⽣生 
 使⽤用后，⻋车票将在我们⼿手中 
对假设进⾏行行攻击 
 获取合适的⻋车票 
 捕捉有效对象 
 绕过规则 
 扩展攻击以增加损害 
史诗般的失败！ 
 制作空⽩白⻋车票 
 复制⼤大量量处于“Issued”状态的对象 
 发现处理理规则中的缺陷 
 在当前使⽤用周期中寻找“Collected” 状态 
 覆盖其他所有状态！ 
 对象最近的状态都为“Collected” 
 运⾏行行原始⻋车票 
 所有复制票⽴立即⽣生效 
史诗般的失败！ 
“Issued”
“Used”
“Collected”
Entering
Exiting
Original
Original
Original
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Collected”
X 
X 
X 
史诗般的失败！ 
“Issued”
“Used”
“Collected”
Entering
Exiting
Original
Original
Original
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Issued”
“Used”
“Collected”
Copy
Copy
Copy
“Collected”
X 
X 
X 
史诗般的失败！ 
史诗般的失败！（示范） 
将漏漏洞洞转为攻击 
 ⻋车票 
 计划 
⻋车票 
 寻找卡⽚片 
 打孔 
寻找卡⽚片 
 阿⾥里里巴巴的建议邀请书 
 运⾏行行试验 
 中标！ 
阿⾥里里巴巴的建议邀请书 
 成千上万的公司（可能数百万） 
 告诉他们你想要什什么 
 任何你需要的！ 
 他们会为你做的 
运⾏行行试验 
 很多提供者 
 只有⼀一家公司合格 
 ⽆无法满⾜足卡⽚片所需的厚度 
 花了了好⼏几个⽉月才找到他们 
中标！ 
中标！ 
打孔 
打孔 
计划 
 购票（单⽇日票） 
 复制⻋车票 
 使⽤用原始⻋车票 
 分发复制品 
 玩的开⼼心！ 
 明天接着来！ 
攻击结果 
Extend the attack! 
对BTS的影响 
 数百万美元的损失 
 丢脸！ 
BTS的回应 
 你哪位？ 
 不不感兴趣！ 
  对于我们 
  对于BTS 
经验总结 
  没有只针对硬件的解决⽅方案 
  解决⽅方案通常很复杂 
  软件⽆无处不不在 
  相信假设是危险的 
  不不要害怕研究⽅方向 
  ⾏行行动前明确⻛风险 
  制定包含所有相关⽅方的计划 
对于我们 
  不不要让社会习惯蒙蔽双眼 
  不不是所有⼈人都按照你的想法和思维做事 
  乐于沟通，坦然交流 
  ⽤用证据说话 
  亡⽺羊补牢，为时不不晚 
对于BTS 
  测试解决⽅方案中的所有层级 
  测试应⽤用程序 
  检查你的假设是否合理理 
  使⽤用补偿和缓解机制 
避免重蹈覆辙 
  部署第⼆二代系统 
  仍然没有分享渠道 
  仍然忽视“错误的⼈人” 
  仍然⽆无视我 
他们如今在做什什么 
最终感想 
  交通系统很有趣 
  同时也会带来麻烦 
  不不去尝试就永远不不会知道 
  逆向⼯工程是关键 
  你有种！ 
  不不要相信那些天花乱坠的宣传 
  应⽤用安全的胜利利之路路！ 
链接 
  https://wikileaks.org/wiki/
Anatomy_of_a_Subway_Hack_2008 
  https://file.wikileaks.org/file/anatomy-of-a-subway-hack.pdf 
  https://defcon.org/images/defcon-16/dc16-presentations/
anderson-ryan-chiesa/47-zack-reply-to-mbta-oppo.pdf 
  https://www.computerworld.com/article/2597509/def-con--
how-to-hack-all-the-transport-networks-of-a-country.html 
  https://www.cio.com/article/2391654/android-nfc-hack-
enables-travelers-to-ride-us-subways-for-free--
researchers-say.html 
  https://www.youtube.com/watch?v=-uvvVMHnC3c 
  https://www.blackhat.com/docs/asia-17/materials/asia-17-
Kim-Breaking-Korea-Transit-Card-With-Side-Channel-
Attack-Unauthorized-Recharging-wp.pdf 
链接 
  https://www.msrdevice.com 
  https://www.msrdevice.com/product/misiri-msr705x-hico-
magnetic-card-reader-writer-encoder-msr607-msr608-
msr705-msr706 
  https://www.alibaba.com/ 
  https://nexqo.en.alibaba.com 
  http://www.nexqo.com/ 
  https://www.bts.co.th/ 
  http://www.btsgroup.co.th