xy = exy max{mxy/M in
0
e
y }
x , mxy/M out
(24)
y
x and mxy/M out
Here mxy/M in
are the fractions of the to-
tal trafﬁc that mxy constitutes on it input and output inter-
faces. Heuristically, e0
xy deemphasizes errors in estimating
relatively small MEs.
We plot the corresponding ordered values of the errors
e0
xy in the right hand column of Figure 4. Note:
(i) regular i,o,r and adhoc i,o,r are uniformly more ac-
curate than other methods, except for low sampling rates
and low estimation errors, in which case they perform about
the same as the best of the other methods;
(ii)
adhoc i,o,r is more pronounced at larger sampling rates;
(iii) regular i,o,r and adhoc i,o,r display neither the
third nor fourth features described above, i.e., no ﬂat por-
tion or errors greater than 1. This indicates that these meth-
ods are successful in avoiding larger estimation errors for
the relatively large MEs, while for the other methods some
noticeable fraction of the relatively large MEs are badly es-
timated.
the accuracy advantage of regular i,o,r
and
We can also get a picture of the relative performance of
the methods by looking at the larger estimation errors of the
whole trafﬁc matrix. As examples, we show in Figure 5 un-
scaled relative errors for k = 128 samples per interface di-
rection, for average i,o and regular i,o,r. Errors have
been truncated at 10 in order to retain detail for smaller er-
rors. Observe:
(i) average i,o is poor at estimating many MEs through
the largest interface (labeled 1) since smaller MEs are
poorly sampled at that interface. regular i,o,r performs
better because it uses primarily the estimates gathered at
the other interface traversed by these MEs.
(ii) regular i,o,r has a smaller number of large relative
errors than average i,o.
In order to get a broader statistical picture we repeated
the experiments reported in Figure 4 100 times, varying the
100
Internet Measurement Conference 2005
USENIX Association
Figure 3: Comparing Conﬁdence Intervals by method, for 4 matrix elements from Table 1
seed for the pseudorandom number generator that governs
random selection in each repetition. The ranked root mean
square (RMS) of the relative errors shows broadly the same
form as Figure 4, but with smoother curves due to averag-
ing over many experiments.
6 Experiments: Network Matrix
In this section we shift the focus to combining a large num-
ber of estimates of a given trafﬁc component. Each esti-
mate may individually be of low quality; the problem is to
combine them into a more reliable estimate. As mentioned
in Section 1.4, this problem is motivated by a scenario in
which routers or other network elements ubiquitously re-
port trafﬁc measurements. A trafﬁc component can gener-
ate multiple measurements as it transits the network.
A challenge in combining estimates is that they may be
formed from sample sets drawn with heterogeneous sam-
pling rates and hence the estimates themselves may have
differing and unpredictable accuracy, as described in Sec-
tion 2.10. For this reason, the approach of Section 3 is
appealing, since estimation requires no prior knowledge of
sampling rates; it only assumes reporting of the sampling
rate in force when the sample was taken.
6.1 Experimental Setup
We wished to evaluate the combined estimator from inde-
pendent samples of a trafﬁc stream from multiple points.
Since we do not have traces taken from multiple locations,
we used instead multiple independent samples sets of the
CAMPUS ﬂow trace, each set representing the measure-
ments that would be taken from a single OP. We took 30
sample sets in all, corresponding to the current maximum
typical hop counts in internet paths [16].
The experiments used threshold sampling, rather than
priority sampling, since this would have required the ad-
ditional complexity of simulating background trafﬁc for
each observation point. Apart from packet loss or the pos-
sible effects of routing changes, the multiple independent
samples correspond with those obtained sampling the same
trafﬁc stream at multiple points in the network.
Our evaluations used multiple experiments, each of
which represented sampling of a different set of ﬂows in
the network. The ﬂow sizes were taken from successive
portions of the CAMPUS trace (wrapping around if neces-
sary), changing the seed pseudorandom number generator
used for sampling in each experiment. The estimates based
on each set of independent samples were combined using
USENIX Association
Internet Measurement Conference 2005  
101
00.511.521101001000bytes(normalized)number of priority samplesInterface 8->1: Relative Volume = 10-6inputoutputrouteraverageiorregular00.511.521101001000bytes(normalized)number of priority samplesInterface 6->3: Relative Volume = 0.08inputoutputrouteraverageiorregular00.511.521101001000bytes(normalized)number of priority samplesInterface 6->5: Relative Volume = 0.02inputoutputrouteraverageiorregular00.511.521101001000bytes(normalized)number of priority samplesInterface 2->6: Relative Volume = 0.5inputoutputrouteraverageiorregularFigure 4: Relative Errors of Matrix Elements for Different Estimators, Ranked by Size. Left: raw relative errors. Right:
scaled relative errors. Top: 16 slots per interface. Bottom: 128 slots per interface.
the following methods: average, adhoc, bounded and
regular. As a performance metric for each method, we
computed the root mean square (RMS) relative estimation
error over 100 experiments.
6.2 Homogeneous Sampling Thresholds
As a baseline we used a uniform sampling threshold at all
OPs. In this case that bounded reduces to average. In
7 separate experiments we use a sampling threshold of 10i
Bytes for i = 3, . . . , 9. This covers roughly the range of
ﬂow sizes in the CAMPUS dataset, and hence includes the
range of z values that would likely be conﬁgured if ﬂow
sizes generally conformed to the statistics of CAMPUS. The
corresponding sampling rate (i.e. the average proportion of
ﬂows that would be selected) with threshold z is π(z) =
Pi min{1, xi/z}/N where {xi : i = 1, . . . , N} are the
sizes of the N ﬂows in the set. For this dataset π(z) ranged
from π(103) = 0.018 to π(109) = 1.9 × 10−5.
We show a typical single path of the byte estimate (nor-
malized by the actual value) for a single experiment in Fig-
ure 6. This was for 10,000 ﬂows sampled with threshold
10MB at 100 sites. There were typically a handful of ﬂows
sampled at each OP. The bounded estimate relaxes slowly
towards the true value. regular also follows at a similar
Figure 6: Combined estimators acting cumulatively over
100 independent estimates.
rate, but displays some bias. adhoc displays systematic
bias beyond 30 combinations. The bias strikingly shows
the need for robust estimation methods of the type proposed
in this paper.
Summary RMS error statistics over multiple experiment
are shown in Tables 2 and 3. Here we vary the number of
102
Internet Measurement Conference 2005
USENIX Association
1e-050.00010.0010.010.11101001000100001000000200400600800100012001400160018002000relativeerrorrankrouterinputoutputaverage_ioaverage_iorad hocregular1e-050.00010.0010.010.11101001000100001000000200400600800100012001400160018002000relativeerrorrankrouterinputoutputaverage_ioaverage_iorad hocregular1e-050.00010.0010.010.11101001000100001000000200400600800100012001400160018002000relativeerrorrankrouterinputoutputaverage_ioaverage_ioradhocregular1e-050.00010.0010.010.11101001000100001000000200400600800100012001400160018002000relativeerrorrankrouterinputoutputaverage_ioaverage_ioradhocregular00.20.40.60.811.20102030405060708090100combinedestimate(normalized)#estimatesboundedregularizedad hocFigure 5: Matrix of relative errors. k = 128 samples per interface direction. Left: average i,o. Right: regular i,o,r.
threshold adhoc
0.0017
0.0121
0.1297
0.4787
8.080
46.10
108.7
103
104
105
106
107
108
109
bounded
0.0016
0.0066
0.0353
0.1293
0.515
1.464
3.581
regular
0.0017
0.0117
0.0883
0.3267
0.527
0.923
1.926
threshold adhoc
0.00002
0.00012
0.00064
0.00340
0.01505
0.16664
0.78997
103
104
105
106
107
108
109
bounded
0.00002
0.00012
0.00063
0.00321
0.01110
0.05400
0.17387
regular
0.00002
0.00012
0.00064
0.00339
0.01469
0.11781
0.37870
Table 2: Homogeneous Sampling. RMS relative error;
1000 ﬂows, 30 sites
Table 3: Homogeneous Sampling. RMS relative error;
100,000 ﬂows, 30 sites
ﬂows in the underlying population (1000 or 100,000) for
30 measurement sites. (Results for 10 measurement sites
are not displayed due to space constraints). bounded has
somewhat better performance than regular and signif-
icantly better performance than adhoc. The differences
are generally more pronounced for 30 sites than for 10, i.e.,
bounded is able to take the greatest advantage (in accu-
racy) of the additional information. On the basis of exam-
ination of a number of individual experiments of the type
reported in Figure 6, this appears to be due to lower bias in
bounded.
6.3 Heterogeneous Sampling Thresholds
To model heterogeneous sampling rates we used 30 sam-
pling thresholds in a geometric progression from 100kB to
100MB, corresponding to average sampling rates of from
0.016 to 8.9 × 10−5. This range of z values was chosen to
encompass what we expect would be a range of likely op-
erational sampling rates, these being quite small in order to
achieve signiﬁcant reduction in the volume of ﬂow records
through sampling.
We arranged the thresholds in increasing order 105B =
z1 < . . . < zi < . . . < z30 = 108B, and for each m com-
puted the various combined estimators formed from the m
individual estimators obtained from samples drawn using
the m lowest thresholds {zi : i = 1, . . . , m}. The perfor-
mance on trafﬁc streams comprising 10,000 ﬂows is shown
in Figure 7. Qualitatively similar results were found with
1,000 and 100,000 ﬂows.
The RMS error of average initially decreases with
path length as it combines the estimators of lower vari-
ance (higher sampling rate). But it eventually increases as
it mixes in estimators or higher variance (lower sampling
rate). RMS errors for bounded and regular are es-
sentially decreasing with path length, with bounded hav-
ing slightly better accuracy. The minimum RMS errors
(over all path lengths) of the three methods a roughly the
same. Could average be adapted to select and include
only those estimates with low variance? This would re-
quire an additional decision of which estimates to include,
and the best trade-off between accuracy and path length
is not known a priori. On the other hand, bounded and
regular can be used with all available data, even with
constituent estimates of high variance, without apparent
degradation of accuracy.
USENIX Association
Internet Measurement Conference 2005  
103
050100150200output050100150200input110050100150200output050100150200input110uniform sampling of the same population.
Further work in progress examines the properties of
combined estimators at an analytical level, and yields a
deeper understanding of their statistical behavior beyond
the mean and variance.
References
[1] Random
Sampled
NetFlow.
Cisco
Systems.
http://www.cisco.com/univercd/cc/td/doc/
product/software/ios123/123newft/123t/
123t 2/nfstatsa.pdf
[2] Cisco
IOS NetFlow Version
9
Flow-Record
Format.
http://www.cisco.com/warp/public/cc/pd/
iosw/prodlit/tflow wp.htm#wp1002063
[3] N. G. Dufﬁeld and M. Grossglauser, “Trajectory Sampling for Direct
Trafﬁc Observation”, IEEE/ACM Transactions on Networking, vol.
9, pp. 280-292, 2001.
[4] N.G. Dufﬁeld, C. Lund, M. Thorup, “Charging from sampled net-
work usage,” ACM SIGCOMM Internet Measurement Workshop
2001, San Francisco, CA, November 1-2, 2001.
[5] N.G. Dufﬁeld, C. Lund, M. Thorup, “Learn more, sample less: con-
trol of volume and variance in network measurements”, IEEE Trans.
of Information Theory, vol. 51, pp. 1756-1775, 2005.
[6] N.G. Dufﬁeld, C. Lund, M. Thorup, “Flow Sampling Under Hard
Resource Constraints”, ACM SIGMETRICS 2004.
[7] C. Estan, K. Keys, D. Moore, G. Varghese, “Building a Better Net-
Flow”, in Proc ACM SIGCOMM 04, Portland, OR
[8] C. Estan and G. Varghese, “New Directions in Trafﬁc Measurement
and Accounting”, Proc SIGCOMM 2002, Pittsburgh, PA, August
19–23, 2002.
[9] A. Feldmann, A. Greenberg, C. Lund, N. Reingold, J. Rexford,
F. True, ”Deriving trafﬁc demands for operational IP networks:
methodology and experience”, IEEE/ACM Trans. Netw. vol. 9, no.
3, pp. 265–280, 2001.
[10] A. Feldmann, J. Rexford, and R. C´aceres, “Efﬁcient Policies for
Carrying Web Trafﬁc over Flow-Switched Networks,” IEEE/ACM
Transactions on Networking, vol. 6, no.6, pp. 673–685, December
1998.
[11] “Internet Protocol Flow Information Export” (IPFIX). IETF Work-
ing Group. http://net.doit.wisc.edu/ipfix/
[12] M. Kodialam, T. V. Lakshman, S. Mohanty, “Runs bAsed Trafﬁc
Estimator (RATE): A Simple, Memory Efﬁcient Scheme for Per-
Flow Rate Estimation”, in Proc. IEEE Infocom 2004, Hong Kong,
March 7–11, 2004.
[13] J. Kowalski and B. Warﬁeld, “Modeling trafﬁc demand between
[14] S. Muthukrishnan. “Data Stream Algorithms”. Available at
nodes in a telecommunications network,” in ATNAC’95, 1995.
http://www.cs.rutgers.edu/∼muthu, 2004
[15] “Packet Sampling” (PSAMP).
IETF Working Group Char-
http://www.ietf.org/html.charters/
ter.
psamp-charter.html
[16] “Packet
Wingspan
Distribution”,
NLANR.
See
http://www.nlanr.net/NA/Learn/wingspan.html
[17] P. Phaal, S. Panchen, N. McKee, “InMon Corporation’s sFlow: A
Method for Monitoring Trafﬁc in Switched and Routed Networks”,
RFC 3176, September 2001
[18] Y. Zhang, M.Roughan, N.G. Dufﬁeld, A.Greenberg, “Fast Accurate
Computation of Large-Scale IP Trafﬁc Matrices from Link Loads”,
Proceedings ACM Sigmetrics 2003.
Figure 7: Heterogeneous Sampling Rates. RMS relative
errors for adhoc, average, regular and bounded,
as a function of number of estimates combined.
7 Conclusions
This paper combines multiple estimators of trafﬁc volumes
formed from independent samples of network trafﬁc. If the
variance of each constituent is known, a minimum vari-
ance convex combination can be formed. But spatial and
temporal variability of sampling parameters mean that vari-
ance is best estimated from the measurements themselves.
The convex combination suffers from pathologies if used
naively with estimated variances. This paper was devoted
to ﬁnding remedies to these pathologies.
We propose two regularized estimators that avoid the
pathologies of variance estimation. The regularized vari-
ance estimator adds a contribution to estimated variance
representing the likely sampling error, and hence amelio-
rates the pathologies of estimating small variances while at
the same time allowing more reliable estimates to be bal-
anced in the convex combination estimator. The bounded
variance estimator employs an upper bound to the variance
which avoids estimation pathologies when sampling prob-
abilities are very small.
We applied our methods to two networking estimation
problems: estimating interface level trafﬁc matrices in
routers, and combining estimates from ubiquitous measure-
ments across a network. Experiments with real ﬂow data
showed that the methods exhibit: (i) reduction in estima-
tor variance, compared with individual measurements; (ii)
reduction in bias and estimator variance, compared with
averaging or ad hoc combination methods; and (iii) appli-
cation across a wide range of inhomogeneous sampling pa-
rameters, without preselecting data for accuracy. Although
our experiments focused on sampling ﬂow records, the ba-
sic method can be used to combine estimates derived from
a variety of sampling techniques, including, for example,
combining mixed estimates formed from uniform and non-
104
Internet Measurement Conference 2005
USENIX Association
0.0010.010.11051015202530RMSrelativeerror#estimates10,000 flowsad hoc 1averageregularizedbounded