用
应
务
---
## Page 415
系统。
体内容可能依赖于具体的机器。如果真是如此，则不能简单地把它们从一个系统复制到另一个
数据库复制到另一台机器上。你应该熟悉整个操作的流程，以及产生的要求。数据库文件的具
些更改。
知道如何利用备份文件来恢复数据，以及如何利用二进制日志恢复最近一次备份后所发生的那
否则，你的用户会极度不满！你必须熟练掌握用于检查和修复MySQL表的那些程序。一定要
(尤其是在你正忙得不可开交、电话响、门铃也响的时候）。尽管如此，你必须要知道如何处理，
用到崩溃恢复的情况应该会很少，可是一旦需要，那么这将是一件非常痛苦且高度紧张的事情
把数据库迁移到另一个地方。
可以让你在无需关闭服务器的情况下创建备份。此外，在硬盘空间用尽的时候，你可能会想要
进行系统备份时，表所对应的文件很可能因服务器的活动而处于变化状态，因此恢复那些文件
请注意，数据库备份与常规的系统备份（如在Unix系统上使用dump 进行备份）并不相同。
在数据库崩溃之后，你肯定会希望把数据库恢复到崩溃前的状态，同时尽可能减少数据损失。
破坏的可能。当然，备份数据库是必不可少的，但是预防性维护可以减少你求助于备份的机率，
阻止问题的发生。你应该采取措施降低这种风险，并且应该学会在意外发生时要如何应对。
10.4
权限授予用户的问题！
他们应该只做期望他们做的事情。
户时，能为其授予合适的MySQL服务器访问权限。对于那些通过网络连接至服务器的用户，
户的权限来启动运行服务器。
运行MySQL服务器的用户账户，如何设置数据目录使得它隶属于该用户，以及如何使用该
坏，如复制或删除数据库的表、读取可能包含有敏感信息的日志。你应该了解：如何设置用于
重要的是需要保证这些账户不能访问数据目录。这样可以防止他们在文件系统级对数据造成矿
重要。MySQL管理员有责任控制好对数据目录及服务器的访问，并且应该对以下问题有所了解。
10.3
在发行的稳定版本和开发版本之间进行选择。
本来获得服务器的错误修复和新功能。你要知道在什么情况下应推迟更新，并且也要知道如何
供商密切相关。）对于这些情况，你应该知道如何设置多个实例服务器。
过让每组都拥有其自己的服务器的方式来更好地保护不同用户组的隐私。（后者与因特网服务提
能需要测试某个新发行的MySQL版本，而同时希望保持现有的生产服务器不动；或者希望通
（4）数据库迁移。如果你打算把现有的MySQL迁移到一台速度更快的主机上，那么需要把
（3）崩溃恢复。如果尽了最大努力但仍然出现了意外，那么你应该知道如何修复或恢复表。
（1）预防性维护。你应该有一套定期的预防性维护计划，用于降低数据库出现故障或遭到
（1)文件系统安全性。在一台计算机里可能会有多个与MySQL的管理任务无关的用户账户。
（2）数据库备份。当发生严重的服务器系统崩溃事件时，数据库备份能起到关键的作用。
（2）MySQL服务器安全性。你必须了解MySQL安全系统的工作原理，以便在创建用户账
（6）更新MySQL软件。MySQL的版本在不断更新。你应该知道，如何通过更新到最新版
每一个MySQL数据库管理员都希望能避免处理损坏或者遭破坏的表。但是，希望并不能
当你负责MySQL的安装时，需要确保用户托付给数据库的信息绝对安全一
（5）管理多个服务器。在某些情况下，可能需要在同一台机器上运行多个服务器实例。你可
访问控制与安全性
数据库维护、
备份和复制
，你肯定不想出现因错误理解安全系统而不小心把过高的访问
10.4数据库维护、备份和复制
这一点非常
395
它
要
在
用
千
破
---
## Page 416
们将依次讨论常规管理任务、MySQL的安全系统以及数据库的维护和备份。
论MySQL的数据目录一
细讨论，并且会描述应该遵循的操作流程，以便于大家能有效地履行这些职责。我们首先会讨
问题，并让复制工作重新开始。
务器的从服务器。
数据库。
让一个服务器所管理的数据库产生的更改，持续传播到另一个服务器所管理的与之相应的那个
状态拍一个快照。另一种可选的办法是使用复制（replication），即建立两个相互合作的服务器
396
以上几节简要描述了一名MySQL管理员应该承担的职责。接下来的几章将对它们进行详
要使用复制，应该知道：如何把服务器设置为主复制服务器，如何设置用来同步复制主服
（5）数据库复制。对数据库进行备份或制作副本，实际上相当于在某个特定的时间点对其
第10章MySQL管理简介
。如果出现了问题，导致复制工作停止，那么你必须要知道到什么地方去查找
一它是你要维护的主要资源，你应该熟悉它的结构和内容。然后，我
---
## Page 417
则默认目录为/var/lib/mysql。在Windows系统里，默认数据目录通常为c：\ProgramData\
11.1数据目录位置
原因。
在本书中，该账户的用户和组名都是mysq1。12.2.1.1节会讨论为MySQL 管理指定登录账户的
因为更好地理解服务器的运作机理绝无坏处。
好好履行职责的“必修课”。即使你没有负责MySQL的管理工作，你也可以从本章获得好处，
的状态文件和日志。如果你负责管理MySQL的安装设置，那么熟悉数据目录的结构和使用是
MySQL自然也不例外。默认情况下，MySQL服务器mysqld会把它管理的所有信息存储在一
MySQL数据目录
个被称为MySQL数据目录的地方。数据目录存储着所有的数据库，以及提供服务器运作信息
第11章
默认的数据目录位置被编译在服务器中。在Unix系统里，如果通过二进制或源代码发行版
对于Unix系统，本章会假定用于执行MySQL管理任务和运行服务器的登录账户已存在。
口如何改变数据库目录的默认位置或组织结构。这一点对于系统里的磁盘资源分配管理尤为
口服务器会生成哪些状态文件和日志，以及它们包括的内容。它们的内容提供了与服务器运
口服务器如何组织和提供对其管理的那些数据库及表的访问。这一点对于设置预防性维护计
口数据目录位置。因为数据目录是MySQL服务器运作的中心，所以你应该知道如何确定它
本章的主要内容如下。
的位置，这样才能高效地对其内容进行管理。
文件系统上。你也可以使用这些知识来规划新数据库的存放位置。
重要。例如，可以跨驱动器平衡磁盘活动，可以把数据重新放置到具有更多空余空间的
行状态有关的有用信息，在你遇到问题时，这些内容会很有用。
划以及在表出现损坏时进行崩溃恢复都非常重要。
---
## Page 418
11.2
务器来获得数据目录信息。
套接字文件、Windows命名管道或共享内存）。可以使用相应的连接参数选项依次连接每一个服
在 Unix系统里使用 SHOWVARIABLES 语句来查看变量值，则会得到类似下面这样的结果：
变量里，你可以使用 SHOW VARIABLES 语句或者 mysqladmin variables 命令来获得它。如果
与其运作有关的系统变量，
看帮助消息，在其中的开头部分便列出了选项文件的各个存放位置：
这个路径名指示的便是数据目录的位置。
能会在这个文件的[mysqld]选项组里看到一个datadir行：
下面会先介绍一种在服务器没有运行时使用的办法，然后会介绍另一种在它运行时使用的办法，
定数据目录的方法是将其列在服务器启动时读取的选项文件里。那样，你就不用在每次启动服
果想要指定一个与编译时内置的那个默认位置不同的位置，那么这种做法比较有用。另一种指
dir_name，以此来指定默认的数据目录。
一个取决于Windows的具体版本。
MySQL 或者 C:\Documents and Settings\All Users\Application Data\MySQL, 到底是哪
务
398
如果你还不清楚服务器在什么地方寻找这些选项文件，那么可以调用下面这条命令，并查
查看服务器启动时读取的选项文件。例如，在Unix系统上查看/etc/my.cnf 文件时，你可
器时都在命令行上指定它了。
MySQL的数据目录存放着服务器管理的所有数据库。一般情况下，它是一个树形结构，是
如果数据目录在某个位置创建好了，而你想把它转移到其他地方，那么可以参考11.3节。
如果同时运行着多个服务器实例，则它们将在不同的网络接口上监听（如 TCP/IP端口、Unix
如果服务器正在运行，
%mysqld --verbose --help
作为一名MySQL管理员，
如果想在启动服务器时指定数据目录的位置，则可以使用--datadir=dir_name选项。
如果通过源代码编译MySQL，则可以在运行CMake时使用命令行选项-DMYSQL_DATADIR=
在Windows上，这个位置则可能类似于C：\ProgramData\MySQL。
%mysqladmin variables
从命令行使用mysqladmin得到的结果如下所示：
mySql> SHOW VARIABLES LIKE'datadir';
datadir=/path/to/data/directory
[mysqld]
datadir
Variable_name
datadir
Variable_name I Value
数据目录结构
第11章MySQL数据目录
IValue
1/usr/local/mysql/data/
/usr/local/mysql/data/
，并且可以报告其中的任何一个值。数据目录的位置保存在datadir
，那么可以连接到它，向它询问数据目录的位置。服务器维护着许多
，你应该知道服务器的数据目录在什么地方。要是你不知道的话
如
---
## Page 419
为访问数据，客户端程序需要建立一个与服务器的连接，然后用SQL语句传递请求，执行所想
对外提供一个通向数据目录的网络接口。（更多关于网络接口选择的详细信息请参考12.2.4节。）
11-1展示了这个结构。
访问数据库的唯一联络点，它就像是处于客户端程序和它们想要使用的数据之间的中间人。
11.2.1MySQL服务器提供的数据访问方式
的数据结构，其中还表示了表和索引。默认情况下，InnoDB会把表空间文件存储在数据目录里。
在一个公共表空间里。该表空间可以包含一个或多个大文件，这些文件会被当成一个单独统一
录和文件实现的数据库层次结构。例如，InnoDB存储引擎可以把所有数据库的 InnoDB 表存储
直接利用Unix或Windows的文件系统层次结构实现的。
当服务器启动时，它会打开你请求它维护的日志文件，然后通过监听各种类型的网络连接，
当以常见的“客户端/服务器”结构使用MySQL时，数据目录下的所有数据库都会由一个
数据目录也可以包含其他文件。
口
口
口
某种给定的存储引擎完全可以使用另一种不同的存储结构一
口数据库里的表、视图和触发器都对应于数据库目录中的文件。
口每个数据库在数据目录下都对应有一个数据库目录。
都会把数据目录作为这些文件的存放位置。
服务器相关的文件，如DES密钥文件、服务器的SSL证书和密钥文件。大部分的管理员
那么这些日志表将位于 mysql 数据库里。）
乱”的查询。（如果服务器的配置是把日志信息记录到数据库表，而不是记录到文件，
例如，当某条特殊的语句使得服务器崩溃时，你便可以通过检查日志文件来找到这条“捣
这些信息对管理员来讲很有价值，特别是在出现了问题，而你想要弄清问题原因的时候。
服务器生成的状态文件和日志文件。这些文件提供了与服务器运作有关的重要信息，而
他程序在需要向服务器发送信号时可以找到这个值。
服务器进程ID（PID）文件。当服务器启动时，
表1
Unix域套接字
数据库1
表2
(Unix)
客户1
图11-1MySQL服务器控制数据目录访问的方式
表3
表1
MySQL服务器
(Unix,windows)
数据库2
数据目录
客户2
表2
表3
，它会将自己的进程ID写入文件，以便其
表1
数据库n
表2
(Windows)
命名管道
客户3
一它可以不同于常见的基于目
11.2数据目录结构
表3
网络接口
网
399
---
## Page 420
在磁盘上至少会使用一个文件来表示，即.frm格式文件，其中包含表结构的描述。服务器会负
11.2.3
据库目录的效果几乎一样。DROP DATABASE语句与文件系统命令的区别在于以下几点。
使用文件系统级的命令（如Unix系统里的rm命令或Windows系统里的del命令）手动删除数
db_name 目录，以及该目录里的所有表文件和其他数据库对象（如视图或触发器）文件。这
且只能被它访问。
默认字符集和排序规则。在Unix系统里，数据库目录只隶属于运行服务器的那个登录账户，并
它还会在这个数据库目录里创建一个名为db.opt的文件，其中列出了数据库的各种属性，
应的数据库目录都为 DATADIR/mydb。
上，DATADIR表示服务器的数据目录位置，那么名为 mydb 的数据库在Unix或Windows上所对
目录形式存在的，而且每一个目录的名称与它所表示的数据库名相同。例如，如果在你的主机
11.2.2数据库在文件系统里的表示
务器本身来完成表维护操作的方式，避开与服务器进行交互所带来的问题。
样的语句（或者使用mysqlcheck 程序，它可以替你执行这些语句)。这些语句可以通过指导服
14.2节。另一种不使用myisamchk 程序的办法是，使用像 CHECK TABLE 和 REPAIR TABLE 这
千万不要去访问该表。与“在使用这些程序时如何与服务器进行协作”相关的指导信息请参考
无法做到这一点，则必须知道如何告诉服务器：当你在使用这类工具直接操作某个表的文件时，
会导致表损坏。
的文件。因为这些工具程序会更改表的内容，因此在服务器修改表时使用它们来操作表，可能
作，可以使用像myisamchk那样的直接访问维护工具。这些程序可以直接操作与这些表相对应
务器并不能完全对数据目录做到互斥控制。对于MyISAM表的维护、故障诊断、修复和压缩操
可能造成的各种数据损坏情况提供保障。尽管如此，管理员还是应该有所注意，在许多时候服
个给定的行。
操作，因此服务器实际上会把各个请求排列起来，以便两个客户端决不会在同一时间改变同一
服务器支持多线程，能够同时为多个客户端提供连接服务。不过，因为每次只能执行一个更新
要的操作，如创建表、查询行或更新行。服务器会执行每一个操作，并把结果返回给该客户端。
400
MySQL支持多种存储引擎，如InnoDB、MyISAM和MEMORY。对于每一个表，MySQL
DROP DATABASE 语句实现得很简单。DROP DATABASE db_name 语句会删除数据目录里的
MySQL服务器管理的每个数据库都有其自己的数据库目录。数据库目录是以数据目录的子
避免出现这类问题的最好办法是，在运行这些表处理工具程序之前，先停止服务器。如果
在一般情况下，把服务器当作数据库访问的唯一仲裁者，可以为因多个进程同时访问表而
口册