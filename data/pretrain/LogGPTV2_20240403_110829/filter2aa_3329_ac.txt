to themselves, or somewhere like fbi.gov 
•  mod_evasive (equivalent of IIS Dynamic IP Restrictions) 
–  Creates an internal dynamic hash table of IP Addresses and URIs 
•  Limit number of requests per file per time interval (seconds) 
•  Limit number of overall site requests per time interval (seconds) 
•  Default returns 403 for the blocking period, can also run a system command 
•  Provides ability to notify via email when attacks occur 
•  Great for driving up attacker costs 
•  Do these methods really work? 
20 
Web Defense – Know Your Enemy 
•  Yes, these methods have worked well for SX (and others) 
•  Why? 
21 
Web Defense – Apache2 Examples 
• 
.htaccess 
Block him: 
SetEnvIf User-Agent ”.*Fuck.*" Skid=1 
Deny from env=Skid 
• 
.htaccess + mod_rewrite 
Redirect him to himself: 
RewriteCond %{HTTP_USER_AGENT} ^.*Fuck.*$ 
RewriteRule .* http://%{REMOTE_ADDR}/ [R,L] 
Redirect him somewhere more interesting: 
RewriteCond %{HTTP_USER_AGENT} ^.*Fuck.*$ 
RewriteRule .* http://www.fbi.gov/ [R,L] 
• 
Mod_evasive sample config 
DOSHashTableSize 3097 
DOSPageCount 3 
DOSSiteCount 50 
DOSPageInterval 3 
DOSSiteInterval 5 
DOSBlockingPeriod 1800 
DOSEmailNotify PI:EMAIL 
DOSLogDir /var/log/mod_evasive 
DOSWhitelist 192.168.42.* 
22 
•  Fail2Ban 
–  Designed to protect against brute-force attacks by analyzing error 
logs 
–  Can be pointed at access logs and used for DDoS defense 
•  Provides both blocking and notification 
Remember this “random” pattern from earlier? 
89.253.109.119 - - [02/Nov/2013:07:46:01 -0400] "GET /
CXZBIWYCXLBEKOELCZOTDTSBPWVIRBIGTCMGDJZKWEAHIBRFSQFDDEOQOLNUYRPLBWFNNKGUFBSXITRDGFW
QNBSOANJVMVLVEIZ=DZYRGTBVAVSJBVCDRLQBHPOXMOEVMVQDRYXPHZZHUMMSTISKMUXOEORVFQOYESHSV
NNDFRPVDITJAYNZSBVYKODFLULLQQNUQOM HTTP/1.1" 404 15650 "-" "*" 
89.253.109.119 - - [02/Nov/2013:07:46:00 -0400] "GET /
PATPDDSYOSWBPDYMHXLTFUUUYFDACLKBNHHCTVSPFKOLFKQGMRTFBDLDRVINIXXAEVIOKHOCLPGIGHRNDQL
QPCIXIKOLGXPHQMB=GFFGXISPOEGSIUOFQWQIBYVWMCNXIEZZSRPQGKWJDQLTUANRUUTUEQEYXMKNXXXCCQ
EXSLVNIKBJHABQCEATNSOTGSKYGSFKSQX HTTP/1.1" 404 15650 "-" "*” 
199.255.209.208 - - [02/Nov/2013:07:45:56 -0400] "GET /
UZMVEXPCUGYSFDXJUGIPKHBCNEPYNFZMUTEIRILNWACYKGKLLJWWIEAUHVENVHGKCTCJRAPFKGGWPMZRSES
XHSOEMRAUVELTNOI=RYPTYZNXFBPKCIUUKIULSBJISCKMVMFLNYAJOIPQODOPWXNMEBLVRLDMHSSHOBQTPQB
DOWUWEDOWGDAFFETPKWBMXHSGYLVWLTA HTTP/1.1" 302 834 "-" "*" 
199.255.209.208 - - [02/Nov/2013:07:45:56 -0400] "GET /
VQQFETHNZLTJSHTKQULAMBELWBRTPAZVKXUECZTZRVCNKZFNMYXBXGDHPJJKWAFXNRCEMPFILVSNYSKGLZFT
WGVLPUQYVGCZNOV=TZVOFJYTDSHBJBZYZRGIRCOHSSLARSUBEBLJJZMOFAEUYJCHTAQHWPYDOTHXSRLEBML
JDHSZZLDWXMEKASYJPTQDQIXZUKVKHUZ HTTP/1.1" 302 834 "-" "*" 
199.255.209.208 - - [02/Nov/2013:07:45:56 -0400] "GET /
PYFFDUKUCRSYUCXQCKCAUOQMFZVNOBVLOVHEMOKRCJZUOECQVVTJTVAWLEJNORYKLPGAXIMTCOKDPVYER
WUBDWJLVSKHAUAEHMV=MBTLZQPNGNRCYVFFUKOYALFDOUWHLRNSECAANEFQNOOLCTWYAFWFXOXSRWPJJ
OBVXKGJSTGKQWLUZZKQJJMUTVNNIVALPZOOSTW HTTP/1.1" 302 834 "-" "*" 
199.255.209.208 - - [02/Nov/2013:07:45:56 -0400] "GET /
PATPDDSYOSWBPDYMHXLTFUUUYFDACLKBNHHCTVSPFKOLFKQGMRTFBDLDRVINIXXAEVIOKHOCLPGIGHRNDQL
QPCIXIKOLGXPHQMB=GFFGXISPOEGSIUOFQWQIBYVWMCNXIEZZSRPQGKWJDQLTUANRUUTUEQEYXMKNXXXCCQ
EXSLVNIKBJHABQCEATNSOTGSKYGSFKSQX HTTP/1.1" 302 834 "-" "*” 
Web Defense – Fail2Ban 
23 
Web Defense – Fail2Ban Example 
24 
Turn “randomized” DDoS attack into a worthless attempt 
jail.conf  
#DDoS blocks for SX 
[apache-dos] 
enabled = true 
port = http,https 
filter = apache-dos 
banaction = iptables-allports 
action = %(action_mwl)s 
logpath = /var/log/apache*/*access.log 
maxretry = 1 
destemail = PI:EMAIL 
ignoreip = 127.0.0.1 192.168.0.0/16 
bantime  = 86400 
apache-dos.conf 
[Definition] 
# Option: failregex 
# Notes: Designed to stop lame DDoS.  No DDoS For You! 
failregex =  ^.*GET \/[A-Z]{99}\=[A-Z]{99}.*$ 
# ignoreregex is here as fail2ban needs it, but we do not. 
ignoreregex = 
Web Defense – Additional Ideas 
•  Caching 
–  Caching systems can cache generated data and greatly reduce 
load on the server 
–  A number of caching systems exist 
•  SX is based on Drupal and uses boost for caching 
•  Associates have reported success using Squid Proxy for caching 
•  Other Apache Defenses 
–  mod_bwshare 
•  Throttle bandwidth per client (IP) 
–  mod_limitipconn 
•  Limit # of simultaneous connections per IP 
•  Attempt to Detect Bots 
–  Captcha 
–  Custom Javascript 
•  Detect keystrokes, mouse events, etc 
25 
Web Defense – Improved Code 
•  Strict validation and filtering on user input 
•  Properly release resources 
•  Set limits 
–  Session related objects and memory allocated 
–  Token expiration 
–  Loop counters 
–  Concurrent session tokens per IP address 
–  Expensive queries (often searches) per IP address 
•  Cache results of expensive queries when possible 
•  Optimize DB structure for application 
•  Test code against DoS/DDoS 
–  Should be part of quality assurance in your organization 
26 
•  Don’t Panic! 
•  Verify Attack 
–  Attack or just youtube? 
•  Read logs 
–  Web logs are often ideal initially 
–  Get top talkers and block on malicious ones 
•  # cat access.log | awk '{print $1}' | sort | uniq -c | sort –n 
•  Use some sort of reputation system, especially if sharing the 
data to other organizations 
•  We use a small home grown tool called “reputator” 
27 
Reacting to an Attack 
•  Using Desu attack for this example 
•  Get top talkers from web server logs 
–  Decide on a cutoff count 
# cat access.log | awk '{print $1}' | sort | uniq -c | sort –n 
(x’s used to mask full IP addresses) 
 620 70.75.x.x 
 626 89.110.x.x 
 644 64.128.x.x 
 689 71.195.x.x 
 695 66.249.x.x 
 730 89.0.x.x 
 740 50.130.x.x 
 776 81.211.x.x 
 858 99.12.x.x 
 859 190.154.x.x 
 889 74.110.x.x 
 922 101.119.x.x 
1009 50.154.x.x 
1091 188.51.x.x 
1123 62.234.x.x 
1129 66.74.x.x 
1354 192.168.x.x 
1456 66.249.x.x 
1709 132.206.x.x 
1864 41.70.x.x 
2390 192.168.x.x 
28 
Top Talkers Example 
# ./reputator.py ips.txt torlist desu.csv 
-=====================================================- 
 reputator .005 
 by: Blake Self 
-=====================================================- 
IP: 50.154.x.x
 Rating: 85
 Tor:False
 ISP:Comcast Cable Communications Holdings Inc
 Location:Kendall, FL, USA
 Result: EVIL 
IP: 188.51.x.x
 Rating: 85
 Tor:False
 ISP:Saudinet Saudi Telecom Company  
 Location:Riyadh, Ar Riyad, Saudi Arabia Result: EVIL 
IP: 62.234.x.x
 Rating: 95
 Tor:False
 ISP:Online Adsl Customers With Static Addresses