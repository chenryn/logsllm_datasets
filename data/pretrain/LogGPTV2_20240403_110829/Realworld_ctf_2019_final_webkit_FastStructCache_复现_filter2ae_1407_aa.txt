# Realworld ctf 2019 final webkit FastStructCache å¤çŽ°
|
##### è¯‘æ–‡å£°æ˜Ž
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŽŸæ–‡ä¸ºå‡†ã€‚
å­¦ä¹  Webkit çš„æ¼æ´žåˆ©ç”¨ï¼Œ19å¹´realworld ctf final å‡ºäº†ä¸€é“ webkit çš„é¢˜ç›® `FastStructCache`,
è¿™é‡Œè®°å½•ä¸€ä¸‹å¤çŽ°çš„è¿‡ç¨‹ã€‚
å®Œæ•´çš„æ¼æ´žåˆ©ç”¨é“¾éœ€è¦é€ƒé€¸webkitçš„æ²™ç®±ï¼Œæˆ‘æ‰‹ä¸Šæœ¨æœ‰macï¼Œè™šæ‹Ÿæœºè£…macæµ‹è¯•åˆæ˜¯å„ç§çš„é—®é¢˜ï¼Œå„ç§å€’è…¾ä¹‹åŽæ”¾å¼ƒäº†åŽåŠéƒ¨çš„æ²™ç®±é€ƒé€¸çš„åˆ©ç”¨ï¼Œæš‚æ—¶åªåšäº†å‰é¢
jsc éƒ¨åˆ†çš„åˆ©ç”¨åˆ†æžï¼Œç­‰ä»€ä¹ˆæ—¶å€™æžå°macä¹‹åŽå›žè¿‡å¤´æ¥çœ‹ ðŸ™
## çŽ¯å¢ƒé…ç½®
é¢˜ç›®çš„åŽŸå§‹æ–‡ä»¶å¯ä»¥ä»Ž[è¿™é‡Œ](https://github.com/5lipper/ctf/tree/master/rwctf19-final/FastStructureCache)
ä¸‹è½½ï¼Œå¤çŽ°çš„çŽ¯å¢ƒæ˜¯åœ¨ ubuntu 1804 ä¸‹ï¼Œ
webkit ç‰ˆæœ¬æ˜¯ `commit 5ed80f740ac7b67ca9ddc43aae401bacc685c5e4`,
ä¸‹è½½æºç ä¹‹åŽæ‰“ä¸Šå¯¹åº”çš„patchç„¶åŽç¼–è¯‘å‡º jsc å°±è¡Œäº†ã€‚ä½†æ˜¯æˆ‘ç¼–è¯‘ debug ç‰ˆæœ¬çš„æ—¶å€™è·‘ä¸èµ·æ¥ï¼Œä¼šæç¤ºstructureID
é”™è¯¯ä¹‹ç±»çš„ï¼Œç¼–è¯‘æˆReleaseç‰ˆæœ¬å°±æ²¡æœ‰é—®é¢˜ã€‚è°ƒè¯•ç”¨çš„ gdb
æˆ‘è‡ªå·±å¤çŽ°ç”¨åˆ°çš„æ–‡ä»¶éƒ½æ”¾åœ¨äº†[è¿™é‡Œ](https://github.com/rtfingc/cve-repo/tree/master/0x06-realworldctf2019-final-faststructcache-side-effect),
åŒ…æ‹¬å­˜åœ¨æ¼æ´žå’Œæ²¡æœ‰æ¼æ´žçš„ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿è‡ªå·±è¿è¡Œæ¯”è¾ƒã€‚
## æ¼æ´žåˆ†æž
###  patch åˆ†æž
å¥½çš„ï¼Œæˆ‘ä»¬çœ‹çœ‹ç»™å‡ºçš„patch, é¢˜ç›®åœ¨`Source/JavaScriptCore/runtime`
ä¸‹æ–°åˆ›å»ºäº†ä¸¤ä¸ªæ–‡ä»¶`FastStructureCache.cpp`å’Œ`FastStructureCache`,
æ·»åŠ äº†ä¸€ä¸ªåä¸º`FastStructureCache` çš„ç±»
    --- /dev/null
    +++ b/Source/JavaScriptCore/runtime/FastStructureCache.cpp
    @@ -0,0 +1,10 @@
    +#include "FastStructureCache.h"
    +
    +namespace JSC {
    +
    +FastStructureCache::FastStructureCache(VM& vm, Structure* structure)
    +    : JSNonFinalObject(vm, structure)
    +{
    +}
    +
    +}
è¿™ä¸ªç±»åªæœ‰ä¸€ä¸ª`createStructureFastPath` æ–¹æ³•, åˆå§‹åŒ–çš„æ—¶å€™ä¼šåˆ›å»º`fastCacheSizeMax == 16` ä¸ª
`Structure` å¯¹è±¡ï¼Œä¿å­˜åœ¨`fastCacheStructure` é‡Œé¢ï¼ŒåŽé¢æ¯æ¬¡è°ƒç”¨`createStructureFastPath`
ç›´æŽ¥å°±ä»Žè¿™ä¸ªcache é‡Œé¢æ‹¿ä¸€ä¸ªï¼Œå¦‚æžœæ‹¿å®Œäº†çš„è¯å°±ç”¨`Structure::create` æ–°åˆ›å»ºä¸€ä¸ªã€‚
    --- /dev/null
    +++ b/Source/JavaScriptCore/runtime/FastStructureCache.h
    //...
    +class FastStructureCache final : public JSNonFinalObject {
    +public:
    +    using Base = JSNonFinalObject;
    +    static Structure** fastCacheStructure;
    +    static uint64_t fastCacheSizeMax;
    +    static uint64_t fastCacheSizeUsed;
    +
    +    static Structure* createStructureFastPath(VM& vm, JSGlobalObject* globalObject, JSValue prototype, const TypeInfo& typeInfo, const ClassInfo* classInfo)
    +    {    // åˆå§‹åŒ– --> fastCacheSizeMax == 16
    +        if (fastCacheStructure == NULL) {
    +            fastCacheStructure = new Structure*[fastCacheSizeMax];
    +            uint64_t idx = 0;
    +            while (idx setPrototypeWithoutTransition(vm, prototype);
    +            return_value->setGlobalObject(vm, globalObject);
    +            fastCacheSizeUsed += 1;
    +            return return_value;
    +        }
    +        return Structure::create(vm, globalObject, prototype, typeInfo, classInfo);
    +    }
    +
    +protected:
    +    FastStructureCache(VM&, Structure* structure);
    +};
`RegExpObject` å’Œ`RegExpPrototype` ä¸¤ä¸ªå¯¹è±¡`createStructure`
éƒ½æ¢æˆäº†ç”¨`FastStructureCache::createStructureFastPath` æ¥
    --- a/Source/JavaScriptCore/runtime/RegExpObject.h
    +++ b/Source/JavaScriptCore/runtime/RegExpObject.h
    //...
     class RegExpObject final : public JSNonFinalObject {
     //...
    static Structure* createStructure(VM& vm, JSGlobalObject* globalObject, JSValue prototype)
         {
    -        return Structure::create(vm, globalObject, prototype, TypeInfo(RegExpObjectType, StructureFlags), info());
    +        return FastStructureCache::createStructureFastPath(vm, globalObject, prototype, TypeInfo(RegExpObjectType, StructureFlags), info());
         }
    //........................................................................................
    --- a/Source/JavaScriptCore/runtime/RegExpPrototype.cpp
    +++ b/Source/JavaScriptCore/runtime/RegExpPrototype.cpp
    +Structure** FastStructureCache::fastCacheStructure = NULL;
    +uint64_t FastStructureCache::fastCacheSizeMax = 16;
    +uint64_t FastStructureCache::fastCacheSizeUsed = 0;
    //........................................................................................
    --- a/Source/JavaScriptCore/runtime/RegExpPrototype.h
    +++ b/Source/JavaScriptCore/runtime/RegExpPrototype.h
         static Structure* createStructure(VM& vm, JSGlobalObject* globalObject, JSValue prototype)
         {
    -        return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
    +        return FastStructureCache::createStructureFastPath(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
         }
æ€»çš„æ¥è¯´å°±æ˜¯é¢„å…ˆåˆ†é…äº†16ä¸ª `Structure` å¯¹è±¡ï¼Œ`RegExpPrototype` å’Œ `RegExpObject` è¦åˆ›å»ºçš„æ—¶å€™å¯ä»¥ä»Žé‡Œé¢æ‹¿ã€‚
###  æ¼æ´žåˆ†æž
æ¼æ´žå°±å‘ç”Ÿåœ¨`FastStructureCache::createStructureFastPath` çš„å®žçŽ°ä¸Šå•¦ï¼Œåœ¨èŽ·å–`Structure`
å¯¹è±¡çš„æ—¶å€™, ç›´æŽ¥ç”¨`setPrototypeWithoutTransition` è®¾ç½®`prototype`
    return_value->setPrototypeWithoutTransition(vm, prototype);
     return_value->setGlobalObject(vm, globalObject);
åŽŸç‰ˆæœ¬çš„`Structure::create`
å®žçŽ°åœ¨[`Source/JavaScriptCore/runtime/StructureInlines.h#L39`](https://github.com/WebKit/webkit/blob/5ed80f740ac7b67ca9ddc43aae401bacc685c5e4/Source/JavaScriptCore/runtime/StructureInlines.h#L39)
ä¸Š
    inline Structure* Structure::create(VM& vm, JSGlobalObject* globalObject, JSValue prototype, const TypeInfo& typeInfo, const ClassInfo* classInfo, IndexingType indexingModeIncludingHistory, unsigned inlineCapacity)
    {
        ASSERT(vm.structureStructure);
        ASSERT(classInfo);
        if (auto* object = prototype.getObject()) {
            ASSERT(!object->anyObjectInChainMayInterceptIndexedAccesses(vm) || hasSlowPutArrayStorage(indexingModeIncludingHistory) || !hasIndexedProperties(indexingModeIncludingHistory));
            object->didBecomePrototype();
        }
        Structure* structure = new (NotNull, allocateCell(vm.heap)) Structure(vm, globalObject, prototype, typeInfo, classInfo, indexingModeIncludingHistory, inlineCapacity);
        structure->finishCreation(vm);
        return structure;
    }
åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šæ£€æŸ¥ä¼ è¿›æ¥çš„ `prototype` æ˜¯ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æžœæ˜¯çš„è¯ï¼Œéœ€è¦è°ƒç”¨`didBecomePrototype`
ç»™è¿™ä¸ªå¯¹è±¡è®¾ç½®ä¸€ä¸ªflagsï¼Œè¡¨ç¤ºå®ƒå·²ç»æ˜¯æŸä¸ªå¯¹è±¡çš„`prototype` äº†ï¼Œå¦‚`a=[1.1] ; b = [1.1];` ï¼Œ`a.__proto__
= b` çš„æ—¶å€™ï¼Œ b å°±ä¼šè°ƒç”¨`didBecomePrototype` ï¼Œ å®ƒçš„å®žçŽ°å¦‚ä¸‹:
    //..  Source/JavaScriptCore/runtime/JSObjectInlines.h
    inline void JSObject::didBecomePrototype()      
    {                                               
        setPerCellBit(true);                        
    }                                               
    // Source/JavaScriptCore/runtime/JSCellInlines.h
    inline void JSCell::setPerCellBit(bool value)                                       
    {                                                                                   
        if (value == perCellBit())                                                      
            return;                                                                                                                                                 
        if (value)                                                                      
            m_flags |= static_cast(TypeInfoPerCellBit);      
        else                                                                            
            m_flags &= ~static_cast(TypeInfoPerCellBit);     
    }
    // Source/JavaScriptCore/runtime/JSTypeInfo.h
    static constexpr unsigned TypeInfoPerCellBit = 1 didBecomePrototype();
    //.....
    m_regExpPrototype.set(vm, this, RegExpPrototype::create(vm, this, RegExpPrototype::createStructure(vm, this, m_objectPrototype.get()))); 
    m_regExpStructure.set(vm, this, RegExpObject::createStructure(vm, this, m_regExpPrototype.get()));                                       
    m_regExpMatchesArrayStructure.set(vm, this, createRegExpMatchesArrayStructure(vm, this));    
    }
æˆ‘ä»¬å…·ä½“è°ƒè¯•çœ‹çœ‹, åœ¨`FastStructureCache::createStructureFastPath` ä¸‹ä¸ªæ–­ç‚¹ï¼Œè·Ÿä¸€ä¸‹å†…å­˜
    b FastStructureCache::createStructureFastPath
æ‰¾åˆ° `FastCacheStructure` ä¿å­˜çš„åœ°æ–¹ï¼Œå®ƒæ˜¯åœ¨ heap å†…å­˜ä¸Š, åˆ›å»ºäº† 16 ä¸ª `Structure` å¯¹è±¡
    pwndbg> vmmap 0x5555555a6960
    LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
        0x555555594000     0x5555555b5000 rw-p    21000 0      [heap]
    pwndbg> x/20gx 0x5555555a6960
    0x5555555a6960: 0x00007fffb26f2060      0x00007fffb26f20d0
    0x5555555a6970: 0x00007fffb26f2140      0x00007fffb26f21b0
    0x5555555a6980: 0x00007fffb26f2220      0x00007fffb26f2290
    0x5555555a6990: 0x00007fffb26f2300      0x00007fffb26f2370
    0x5555555a69a0: 0x00007fffb26f23e0      0x00007fffb26f2450
    0x5555555a69b0: 0x00007fffb26f24c0      0x00007fffb26f2530
    0x5555555a69c0: 0x00007fffb26f25a0      0x00007fffb26f2610
    0x5555555a69d0: 0x00007fffb26f2680      0x00007fffb26f26f0
    0x5555555a69e0: 0x0000000000000000      0x000000000000e621
    0x5555555a69f0: 0x0000000000000000      0x0000000000000000
ç¬¬ä¸€æ¬¡è°ƒç”¨`RegExpPrototype::createStructure` , ä¼šæ‹¿åˆ°ç¬¬ä¸€ä¸ª`Structure`,
ä¹Ÿå°±æ˜¯`0x00007fffb26f2060` è¿™ä¸ªåœ°å€,
æ¯ä¸ªå˜é‡å¯¹åº”çš„ä½ç½®å¯ä»¥çœ‹çœ‹`Source/JavaScriptCore/runtime/Structure.h`
    pwndbg> x/20gx 0x00007fffb26f2060
    0x7fffb26f2060: 0x0100000000002e74      0x0100170000007a64
                                         //m_globalObject
    0x7fffb26f2070: 0x0000001c00000000      0x00007fffb26e0000
                   //m_prototype
    0x7fffb26f2080: 0x00007fffb26d8000      0x0000000000000000
    0x7fffb26f2090: 0x0000000000000000      0x0000000000000000
                   // m_classInfo
    0x7fffb26f20a0: 0x00007ffff7d95b80      0x0000000000000001
    0x7fffb26f20b0: 0x00007fffb26cc060      0x0000000000000003
    0x7fffb26f20c0: 0x243e606800000074      0x0000000000000000
    0x7fffb26f20d0: 0x0100000000002e74      0x0100170000007baa
åˆ›å»ºçš„æ—¶å€™ä¼ é€’ç»™`RegExpPrototype` çš„`prototype` æ˜¯`m_objectPrototype`,
å®ƒé»˜è®¤æ˜¯è®¾ç½®äº†`TypeInfoPerCellBit` çš„
    pwndbg> x/20gx 0x00007fffb26d8000                                                                     
    0x7fffb26d8000: 0x01801700000068d5      0x00007fe00dcf4088                                           
    0x7fffb26d8010: 0x0188240100007056      0x00007fe00dcec208
ç„¶åŽæ˜¯`RegExpObject::createStructure` ï¼Œ å®ƒä¼šæ‹¿åˆ°ç¬¬äºŒä¸ª`Structure`
    pwndbg> x/20gx 0x00007fffb26f20d0
    0x7fffb26f20d0: 0x0100000000002e74      0x0100170000007baa
                                        //m_globalObject
    0x7fffb26f20e0: 0x0000002000000000      0x00007fffb26e0000
                   //m_prototype
    0x7fffb26f20f0: 0x00007fffb26d8020      0x0000000000000000
    0x7fffb26f2100: 0x0000000000000000      0x0000000000000000
                    //m_classInfo