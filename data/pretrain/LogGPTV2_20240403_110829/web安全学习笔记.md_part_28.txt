240 Chapter 6. 内网渗透
Web-Sec Documentation, 发布 1.0
对象与属性
ADDS 内的资源都是以对象（Object）的形式存在的，对象通过属性（Attrbute）来描述其特征。
域
域指将网络中多台计算机逻辑上组织到一起，进行集中管理的逻辑环境。域是组织与存储资源的核心管理单
元，在域中，至少有一台域控制器，域控制器中保存着整个域的用户帐号和安全数据库。
域树
域树（Trees）由多个域组成，这些域共享同一表结构和配置，形成一个连续的命名空间（namespace）。
林
林（Forests）是一个复杂的 AD 实例，由一个或数个域组成，每个域树都有自己唯一的名称空间。
信任
两个域之间需要创建信任关系，才可以访问对应域内的资源。
域控制器
ADDS 的目录存储在域控制器内，一个域内可以有多台域控制器，每一个域控制器的地位几乎是平等的，有
几乎相同的数据库。
在一台域控制器添加一个用户账户后，这个账户会被自动复制到其他域控制器的数据库中。
AD数据库有多主机复制模式（Multi-masterReplicationModel）和单主机复制模式（Sing-masterReplication
Model）。
多主机模式可以直接更新任何一台域控制器内的 AD 对象，并将更新之后的对象复制到其他域控制器，大部
分数据都是用多主机模式进行复制。
单主机复制模式是指由一台被称作操作主机（Operations Master）的域控制器负责接收更改数据的请求，并
将数据复制到其他的域控制器。
域信任类型
Active Directory 的信任方式可以分为以下几种：
• Tree-Root Trust
– 双向具有转移性
6.1. Windows 内网渗透 241
Web-Sec Documentation, 发布 1.0
• Parent-Child Trust
– 具有转移性，双向行人
• Forest Trust
– 如果两个林创建了信任关系，则林中所有的域都相互信任
– 两个林之间的信任关系无法自动扩展到其他林上
• Realm Trust
– ADDS 域可以和非 Windows 系统的 Kerberos 域之间创建信任
• External Trust
– 位于两个林内的域之间可以通过外部信任来创建信任关系
• Shortcut Trust
– 可以缩短验证用户身份的时间
攻击类型
黄金票据利用
在认证过程中，经过 client 与 AS 的通信会得到 TGT，黄金票据（Golden Ticket）就是伪造票据授予票据
（TGT），也被称为认证票据。
黄金票据利用需要与 DC 通信，且需要获取 krbtgt 的 hash，但是可以获取任何 Kerbose 服务权限。
白银票据利用
白银票据（Silver Tickets）伪造利用的是 Kerberos 认证中的第三个步骤，在第三步的时候，client 会带着
ticket 向 server 的某个服务进行请求，如果验证通过就可以访问 server 上的指定服务了，这里的 ticket 是基
于 client info、server session key、end time、server hash。这里 client info 已知，end time 可以构造，server
session key 是 TGS 生成的，所以只要 server 的 NTLM hash 即可。银票伪造的是 TGS，只能访问指定的服
务。
DCSync 攻击
DCSync 是域渗透中经常会用到的技术。DCSync 是 mimikatz 在 2015 年添加的一个功能，由 Benjamin
DELPY gentilkiwi 和 Vincent LE TOUX 共同编写，基于 DRS 来导出域内所有用户的 hash。
这种方式需要满足以下任一一种权限：
• Administrators 组内的用户
• Domain Admins 组内的用户
242 Chapter 6. 内网渗透
Web-Sec Documentation, 发布 1.0
• Enterprise Admins 组内的用户
• 域控制器的计算机帐户
DCShadow 攻击
DCShadow是由来自法国的安全研究人员BenjaminDelpy和VincentLeToux在2018年的微软蓝帽（Blue
Hat）大会上提出。
DCShadow 攻击指在 Active Directory 环境下创建一个恶意的域控制器，并用它来推送恶意对象。
票据传递攻击
票据传递攻击（Pass-the-Ticket Attacks，PtT）是一种使用 Kerberos 票据代替明文密码或 NTLM 哈希的方
法。PtT 最常见的用途可能是使用黄金票据和白银票据，通过 PtT 访问主机相当简单。
Kerberoasting Attacks
域内的任何一台主机，都可以通过查询 SPN，Kerberoasting 即是向域内的所有服务请求 TGS，然后进行暴
力破解。
Kerberos Delegation Attacks
在一个域中，A 使用 Kerberos 身份验证访问服务 B，B 再使用 A 的身份去访问 C，这个过程就可以理解
为委派。委派主要分为非约束委派（Unconstrained delegation）和约束委派（Constrained delegation）两种，
非约束委派可以访问域内任意其它服务，约束委派对认证做了限制不可以访问其他的服务。
Kerberos Delegation（Kerberos 委派）攻击分为非约束委派攻击和约束委派攻击。原理都是基于域内已经配
置了委派的账户来获取其它账户的权限。
6.2 Linux 内网渗透
6.2.1 信息收集
获取内核，操作系统和设备信息
• 版本信息
– uname -a 所有版本
– uname -r 内核版本信息
– uname -n 系统主机名字
6.2. Linux 内网渗透 243
Web-Sec Documentation, 发布 1.0
– uname -m Linux 内核架构
• 内核信息 cat /proc/version
• CPU 信息 cat /proc/cpuinfo
• 发布信息
– cat /etc/*-release
– cat /etc/issue
• 主机名 hostname
• 文件系统 df -a
• 内核日志 dmesg / /var/log/dmesg
用户和组
• 列出系统所有用户 cat /etc/passwd
• 列出系统所有组 cat /etc/group
• 列出所有用户 hash（root）‘‘cat /etc/shadow‘‘
• 用户
– 查询用户的基本信息 finger
– 当前登录的用户 users who -a /var/log/utmp
– 查询无密码用户 grep 'x:0:' /etc/passwd
• 目前登录的用户 w
• 登入过的用户信息 last / /var/log/wtmp
• 显示系统中所有用户最近一次登录信息 lastlog / /var/log/lastlog
• 登录成功日志 /var/log/secure
• 登录失败日志 /var/log/faillog
• 查看特权用户 grep :0 /etc/passwd
• 查看 passwd 最后修改时间 ls -l /etc/passwd
• 查看是否存在空口令用户 awk -F: 'length($2)==0 {print $1}' /etc/shadow
• 查看远程登录的账号 awk '/\$1|\$6/{print $1}' /etc/shadow
• 查看具有 sudo 权限的用户
– cat /etc/sudoers | grep -v "^#\|^$" | grep "ALL=(ALL)"
244 Chapter 6. 内网渗透
Web-Sec Documentation, 发布 1.0
用户和权限信息
• 当前用户 whoami
• 当前用户信息 id
• 可以使用 sudo 提升到 root 的用户（root）cat /etc/sudoers
• 列出目前用户可执行与无法执行的指令 sudo -l
环境信息
• 打印系统环境信息 env
• 打印系统环境信息 set
• 环境变量中的路径信息 echo $PATH
• 打印历史命令 history / ~/.bash_history
• 显示当前路径 pwd
• 显示默认系统遍历 cat /etc/profile
• 显示可用的 shell cat /etc/shells
进程信息
• 查看进程信息 ps aux
• 资源占有情况 top -c
• 查看进程关联文件 lsof -c $PID
• 完整命令行信息 /proc/$PID/cmdline
• 进程的命令名 /proc/$PID/comm
• 进程当前工作目录的符号链接 /proc/$PID/cwd
• 运行程序的符号链接 /proc/$PID/exe
• 进程的环境变量 /proc/$PID/environ
• 进程打开文件的情况 /proc/$PID/fd
服务信息
• 由 inetd 管理的服务列表 cat /etc/inetd.conf
• 由 xinetd 管理的服务列表 cat /etc/xinetd.conf
• nfs 服务器的配置 cat /etc/exports
6.2. Linux 内网渗透 245
Web-Sec Documentation, 发布 1.0
• 邮件信息 /var/log/mailog
• ssh 配置 sshd_config
计划任务
• 显示指定用户的计划作业（root）crontab -l -u %user%
• 计划任务
– /var/spool/cron/*
– /var/spool/anacron/*
– /etc/crontab
– /etc/anacrontab
– /etc/cron.*
– /etc/anacrontab
• 开机启动项
– /etc/rc.d/init.d/
网络、路由和通信
• 列出网络接口信息 /sbin/ifconfig -a / ip addr show
• 列出网络接口信息 cat /etc/network/interfaces
• 查看系统 arp 表 arp -a
• 打印路由信息 route / ip ro show
• 查看 dns 配置信息 cat /etc/resolv.conf
• 打印本地端口开放信息 netstat -an
• 列出 iptable 的配置规则 iptables -L
• 查看端口服务映射 cat /etc/services
• Hostname hostname -f
• 查看进程端口情况 netstat -anltp | grep $PID
已安装程序
• rpm -qa --last Redhat
• yum list | grep installed CentOS
246 Chapter 6. 内网渗透
Web-Sec Documentation, 发布 1.0
• ls -l /etc/yum.repos.d/
• dpkg -l Debian
• cat /etc/apt/sources.list Debian APT
• pkg_info xBSD
• pkginfo Solaris
• pacman -Q Arch Linux
• emerge Gentoo
文件
• 最近五天的文件 find / -ctime +1 -ctime -5
• 文件系统细节 debugfs
公私钥信息
• ~/.ssh
• /etc/ssh
日志
• /var/log/boot.log
• /var/log/cron
• /var/log/faillog
• /var/log/lastlog
• /var/log/messages
• /var/log/secure
• /var/log/syslog
• /var/log/syslog
• /var/log/wtmp
• /var/log/wtmp
• /var/run/utmp
6.2. Linux 内网渗透 247
Web-Sec Documentation, 发布 1.0
虚拟环境检测
• lsmod | grep -i "vboxsf\|vboxguest"
• lsmod | grep -i "vmw_baloon\|vmxnet"
• lsmod | grep -i "xen-vbd\|xen-vnif"
• lsmod | grep -i "virtio_pci\|virtio_net"
• lsmod | grep -i "hv_vmbus\|hv_blkvsc\|hv_netvsc\|hv_utils\|hv_storvsc"
容器内信息收集
• capsh --print
• cat /proc/1/cgroup
• env | grep KUBE
• ls -l .dockerenv
• ls -l /run/secrets/Kubernetes.io/
• mount
• ps aux
6.2.2 持久化
权限提升
• 内核漏洞利用
• 攻击有 root 权限的服务
• 利用第三方服务提权
• 通过有 SUID 属性的可执行文件
– 查找可能提权的可执行文件
– find / -perm +4000 -ls
– find / -perm -u=s -type f 2>/dev/null
– find / -user root -perm -4000 -print 2>/dev/null
– find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
• 利用可用的 root 权限
– sudo -l
248 Chapter 6. 内网渗透
Web-Sec Documentation, 发布 1.0
• 利用误配置的 crontab 任务
自启动
• /etc/init.d
• /etc/rc.d/rc.local
• ~/.bashrc
• ~/.zshrc
后门
• ssh 后门
– alias ssh='strace -o /tmp/.ssh.log -e read,write,connect -s 2048 ssh'
– 后门账户
• 常见应用
– ICMP
– DNS
• icmp 后门
• 后门端口复用
• . 开头隐藏文件
• rootkit
6.2.3 痕迹清理
历史命令
• unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; export HISTFILE=/dev/null;
• kill -9 $$ kill history
• history -c
• 在 HISTSIZE=0 中设置 HISTSIZE=0
清除/修改日志文件
• /var/log/btmp
• /var/log/lastlog
6.2. Linux 内网渗透 249