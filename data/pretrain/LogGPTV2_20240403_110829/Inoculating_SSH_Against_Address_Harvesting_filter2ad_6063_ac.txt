Cynthia D. McLain
InoculatingSSHAgainstAddressHarvestingStuartE.Schechter∗JaeyeonJungWillStockwell∗CynthiaMcLain∗MITLincolnLaboratoryMITCSAILMITLincolnLaboratoryMITLincolnLaboratoryses@ll.mit.edujyjung@mit.edubigwill@mit.educdmclain@ll.mit.eduAbstractAddressharvestingistheactofsearchingacompro-misedhostforthenamesandaddressesofothertargetstoattack,suchasoccurswhenanemailviruslocatestargetaddressesfromusers’addresslistsormailarchives.WeexaminehowhostaddressesharvestedfromSecureShell(SSH)clients’knownhostsﬁlescanaidthoseattack-ingSSHservers.Eachuser’sknownhostsﬁlecontainsthenamesofeveryhostpreviouslyaccessedbyitsowner.Thus,whenanattackercompromisesauser’spasswordoridentitykey,theknownhostsﬁlecanbeusedtoiden-tifythosehostsonanetworkthataremostlikelytoacceptthiscompromisedcredential.Suchattacksarenottheoret-ical–asingleattackerwhotargetedhostauthenticationviaSSHandemployedknownhostsaddressharvestingwasabletogainaccesstoamultitudeofacademic,com-mercial,andgovernmentsystems.Toshowthevalueofknownhostsﬁlestosuchattackers,wepresentresultsofastudyofknownhostsﬁlesandotherdatacollectedfrom173hostsdistributedover25topleveldomains.Wealsocollecteddataonusers’credentialmanagementprac-tices,anddiscoveredthat61.7%oftheidentitykeysweencounteredwerestoredunencrypted.ToshowhowhostauthenticationattacksviaSSHcouldevolveifautomated,wesurveymechanismsusedtoattackandtheirsuitabilityforuseinself-propagatingcode.Finally,wepresentcoun-termeasuresdevisedtodefendagainstaddressharvesting,whichhavebeenadoptedbytheOpenSSHteamandoneofthetwomaincommercialSSHsoftwarevendors.1IntroductionTheSSHprotocolhasdonemuchtopopularizetheuseofcryptographyforremotecommandexecution,ﬁletrans-fer,andotherservices.However,cryptographicchannelsalonearenotenoughtoensuretheseserviceswillonlybeaccessedbytheirintendedusersandforthepurposestheyauthorize.In2004,weaknessesinthehostauthenticationprac-ticesemployedbySSHwereexploitedbyasingleat-tackertocompromisesystemsatamultitudeofmajoruni-versities,corporations,nationallaboratories,supercomput-ingcenters,andevenmilitaryinstallations[8,17,33,22],withsigniﬁcantconsequences.OperatingsystemsourcecodeusedtocontrolrouterswasstolenfromCiscoSys-tems[13].Othersiteshadtobetakenofﬂineformulti-pledays[17,8,33].LogsatoneofthecompromisedsitesshowedSSHconnectionstohostsintheknownhostsﬁlebeinginitiatedimmediatelyafterthatﬁlewasreadbytheat-tacker[8].Attackersaredrawntoknownhostsﬁles,maintainedbytheSSHclientforeachuser,becauseitprovidesanabun-dantharvestofnamesandaddressesofnewtargethoststoattack.EachﬁlecontainsalistofeveryhostpreviouslycontactedviaSSHbytheuser,forthepurposeofmappingthesehoststotheirpublickeys.Hostsarelistedintheor-derinwhichtheywereﬁrstcontacted,suchthatthebottomofthelistcontainsthehostsatwhichtheuser’saccesscre-dentialsaremostlikelytoremainvalid.SuchreliabletargetlistsreduceboththetimerequiredtoﬁndvulnerablehostsandthelikelihoodthatattackswillraisealarmsduetofailedTCPconnectionattemptsorSSHauthenticationattempts.TobetterunderstandtheconsequencesofattacksthatharvestaddressesfromSSH,wehaveinitiatedtheﬁrstmulti-institutionstudyonSSHknownhostsrelation-shipsandkeymanagement,collectingdatafrom2,477useraccountson173hosts.Weusethedatafromthisstudy,pre-sentedinSection2,toexplainhowtheseknownhostsﬁleshaveenabledattackerstorepeatedlycompromisehostafterhost,andnetworkafternetwork.Weshowthatasmallnumberofpromiscuoususersareresponsibleforthemajor-ityofknownhostsentries,andthatthereexistsasetofgatewayhoststhatcontributesigniﬁcantlytothevulnerabil-ityofthenetwork.InSection3wediscussthecountermeasuresthatcanbeusedtosafeguardagainstaddressharvestingandthetrade-offstheyrequire.InSection4wedescribeanadditionalenhancementtoOpenSSHthatweimplementedtomakeiteasierforusersofgatewayhoststoavoidriskypracticesthat*ThisworkissponsoredbytheUnitedStatesAirForceunderAirForceContractFA8721-05-C-0002.Opinions,interpretations,conclusionsandrecommendationsarethoseoftheauthorandarenotnecessarilyendorsedbytheUnitedStatesGovernment.hostinformationOSnameandversionSSHclientvendorandversionIPaddress*NetmaskuseridentiﬁcationUsername**IPaddress*ofhostexportinguser’shomedirknownhostsﬁleforeachuserIPaddress*ofeachdestinationhostauthorizedkeysﬁleforeachuserPublicidentitykeys**identitykeyﬁlesforeachuserPublicidentitykeys**Flag:setifmatchingprivatekeyisencryptedSSHkeyversionTable1.Thecontentsofthereportgener-atedbycollect-ssh.pl,organizedbydatasourceexposeauthenticationcredentialstoabuse.Inanticipationofmoresophisticatedattacks,weexam-inemechanismsusedtoattackhostauthenticationviaSSHfortheirapplicabilitytoselfpropagatingmalwareinSec-tion5.AswecouldﬁndnopastsurveyofmechanismsforimpersonatinguserstoauthenticatetohostsviaSSH,weprovidesuchasurveyinAppendixA.RelatedworkandrelatedthreatsarediscussedinSec-tion6.WeconcludeinSection7anddiscussindustryadop-tionofourproposedcountermeasuresintheepilogthatfol-lows.2QuantifyingHarvestableDataTobetterunderstandhowattackscanspreadviaSSH,wehaveundertakenamulti-institutionefforttocollectdatafromusers’knownhostsdatabaseentriesandtheirover-allSSHconﬁguration.Wemadeavailableadatacollectionandreportingscript,writteninPerl,thatcouldberunoneachhosteitherbyindividualuserstocollectdatafromtheirownaccountorbysystemadministratorstocollectdatafromalluseraccounts.Thedatacollectionandreportingscriptispubliclyavailableathttp://nms.csail.mit.edu/projects/ssh/.HostsHostsTLDrootallTLDrootall.edu1273.net822.com1017.org27.de45.it24.uk33.kr13.pl23.ca03.ﬁ23.dk12.nl22.be12.pt11.cl11.ph11.biz11.nu11.cx11.au11.ee11.gov01.se01.sk11Table2.Rootsubmittinghostsandallsub-mittinghostsgroupedbytopleveldomain(excludeshostswithundeﬁnedPTRrecords)2.1CollectionmethodologyThecategoriesofinformationexaminedbyourdatacol-lectionandreportingscriptaresummarizedinTable1.AllIPaddressescollected,markedwithastar(*)inTa-ble1,havebeenanonymizedusingthepreﬁxpreservingpermutationalgorithmofXuetal.[31].Thepreﬁxpreserv-ingpropertyofthepermutationensuresthattwoaddresseswithinthesamenetworkbeforeanonymizationwillfallintothenetworkafteranonymization.Thepublickeysanduser-namesreportedbyourscript,markedwithtwostars(**)inTable1,arereplacedbytheirSHA1[15]hashes.Whenourdatacollectionscriptrunsonasubmittinghostitqueriesthehost’sIPaddressandincludestheanonymizedaddressinitsreport.Wecallthisthesubmitter-viewIPad-dress.WhenwereceivethesubmittedreportoveraTCPconnection,wecollectthesourceIPaddressoftheconnec-tionasourdatacollectionserverobserveditandrefertotheanonymizedformofthisaddresstherecipient-viewIPaddress.Submitter-viewIPaddressesallowustodifferen-tiatetwohostsbehindanetworkaddresstranslation(NAT)boxthatmayappeartoourdatacollectionserver,whichre-ceivesthesubmissions,tooriginatefromthesameaddress.Therecipient-viewIPaddressesareneededtodifferentiatehostsbehindtwodifferentNATsthatmayhavethesamesubmitter-viewIPaddress,butareactuallyondifferentnet-works. 0 0.2 0.4 0.6 0.8 1 0 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32cumulative fraction of src/dst pairsbit-wise network distance from source hostempirical datareference lineFigure1.Thedistributionofbit-wisenetworkdistancesbetweeneachuniqueknownhostssource/destinationaddresspair,wherethesourceisthehostfromwhichtheknownhostsﬁlecontainingthedestina-tionaddresswasread.2.2DemographicsAtthetimeofwritingwehavereceiveddatafrom173distincthosts,whichwerefertoassubmittinghosts.Thesehostscontain2,477useraccountswithknownhostsﬁles,whichinturncontainatotalof37,765knownhostsentriesto12,035uniquedestinationaddresses.Ofthose2,477users,2,359weresubmittedbythe63rootsubmit-tinghosts,thosesubmittinghostsonwhichthecollectionscriptwasrunasrootandonwhichdataweresubmittedfromallusers.Fortheremaining110submittinghosts,wereceivedatotalof118individualusersubmissionswithatmosttwousersubmissionsperhost.Ourstudydrewitsparticipantsfromvariouslocations.Table2showsthedistributionofsubmittinghostsacross25topleveldomains.Weinferthetopleveldomainofasub-mittinghostusingareverseDNSlookupoftherecipient-viewIPaddressbeforetheaddressisanonymized.2.3TheReachofknownhostsEntriesIfanadversarygainsaccesstooneormoreknownhostsﬁles,wherearetheentrieslikelytolead?Toanswerthisquestionwemeasuredthebit-wisenetworkdistancebetweeneachsourcehostandeveryuniquedestinationaddressinitsknownhostsﬁles.1Thebit-wisenetworkdistancebetweentwoaddressesa1anda2isthenumberofbitsthatfollowstheirlongestcommonpreﬁx.Figure1showsthecumulativefraction1Whenthesubmitter-viewofthesourceaddressdifferedfromtherecipient-view(seedeﬁnitionsinSection2.1),wemeasuredthedistancefromthesourceaddressthatwasclosertothedestinationaddress. 0 10 20 30 40 50 60 70 80 90 100 0 2 4 6 8 10 12 14 16 18 20CCDF of user accounts (%)# of known_hosts destinationsintermediatedistantclose(a) 0 10 20 30 40 50 60 70 80 90 100 0 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40CCDF of root submitting hosts (%)# of unique known_hosts destinationsdistantcloseintermediate(b)Figure2.Thecomplementarycumulativedis-tributionfunctionofuniqueknownhostsdestinationsofeachdistancecategoryperuser(a)andperrootsubmittinghost(b).ofalluniqueknownhostssource/destinationpairsthatfallwithinagivenbit-wisenetworkdistanceofeachother.Toillustratethatknownhostsdestinationsarelocallybiased,weplacedareferencelinerepresentingthedistributionofdistancesforaddresspairschosenrandomlyfromtheuniformdistribution(halfofdestinationswouldhaveadifferenthighorderbitandadistanceof32,onequarteradistanceof31,andsoon.)Wesegregatedknownhostsdestinationaddressesintothreecategoriesbasedonthebit-wisenetworkdistancefromtheirsourcehost.Theroughly60%ofdestinationsfoundtobewithinthesame/16(ClassB)astheirsourcewerecategorizedasclosetothatsource.About30%wereinadifferent/8thantheirsourceandwerecategorizedas 0 20 40 60 80 100 0 5 10 15 20 25 30 35 40 45 50CDF of # of unique destinations (%)% of user known_hosts filesFigure3.Thisﬁgureshowsthesmallestpossiblepercentageofuserknownhostsﬁles(Xaxis)neededtoidentifyagivenpercentageoftheuniquedestinationsob-servedinourstudy(Yaxis). 1 10 100 1000 10000 1 10 100 1000# of unique known_hosts destinations# of user accountsFigure4.Therelationshipbetweenthenumberofuserswithknownhostsﬁlesandthenumberofuniquedestinationsoverthesetofrootsubmittinghosts.distant.Theroughly10%thatremained,whichfellwithinthesame/8astheirsourcebutnotwithinthesame/16,werecategorizedasintermediate.Wethenasked,howmanyknownhostsdestinationsofeachcategorycouldanadversaryexpecttodiscoveronahostifhecompromisedoneaccountorallofitsaccounts?Figure2(a)showsthedistributionofuniquedes-tinationaddressesofeachdistancecategoryovertheknownhostsﬁlescollected.Nearlyhalfofallusers’knownhostsﬁlescontainedentriestooneormoredis-tantdestinations(49%)andfourormoreclosedestinations(47%).Over10%ofallusershadmorethantendistantknownhostsdestinationsandeighteenormoreclosedestinations.WeshowinFigure2(b)thedistributionofuniqueknownhostsdestinationsoverthesetofrootsubmit-tinghost.Unlikethedistributionofuniquedestinationsperuser,therearemoreuniquedistantdestinationsperrootsubmittinghostthanuniqueclosedestinations,asdifferentusersonthesamehosttendtoconnecttothesamenearbyhostsbutdifferentdistanthosts.Halfofallhostscontainknownhostsentriestofourteenormoredistantdestina-tions,andmorethanonequartercontainentriestooverfortydistantdestinations.Returningtoouroriginalquestionofwhereknownhostsentrieslead,thedatashowthatanadversarycannotonlyidentifynearbyhostsbutalsothoseondistantnetworks.Infact,theknownhostsentriesfromthe173submittinghostscollectivelycontaindestinationsto107different/8(classA)preﬁxes,or67%ofallvalid/8networks.22The160validclassAnetworksarethosethatexcludetwoprivate/82.4EvidenceofPromiscuousUsersandGatewayHostsThemedian-basedanalysisabovede-emphaizedtheheavy-tailofthedistributionthatcontainsthe‘promis-cuous’usersandhoststhatcontributedthemostknownhostsentries.FromFigure3weobservethe5%ofusersthatweremostpromiscuouscollectivelyhadknownhostsentriestoover75%oftheuniquedestina-tionaddressescollectedinourstudy.Figure4showstheexpectedcorrelationbetweenthenumberofuserswithknownhostsﬁlesperrootsub-mittinghostandthenumberofknownhostsentriesperrootsubmittinghost.Intheupperright-handcornertherearefourhostswithmorethan100usersand1,000uniqueknownhostsdestinations.Weinferfromtheplethoraofusersaccountsthatthesehostsactasgateways–hoststowhichusersconnectviaanincomingconnectiontotheSSHserverandtheninitiateoutgoingconnectionsviatheSSHclient.Whenusersinitiateoutgoingconnectionsviathegatewayhost’sclient,eithertheuser’scredentialsmustbesenttotheclientoraconnectionmustbeforwardedtotheuser’ssigningagentontheclient.Shouldanadversarycon-trolagatewayhostwhenauserinitiatesanoutgoingcon-nection,theadversarywilleitherbeabletostealtheuser’scredentialsorrequestthatagenttosignonhisbehalf.networksand94unallocated/8networks,asdocumentedbytheInternetAssignedNumbersAuthority[9,10]838781(a)7280838771738177847678797475616570(b)1672808387607173817784767879747582616570(c)Figure5.Submittinghostswithinonenetworkthatarereachablein1(a),2(b),and3(c)stepsfromasourcehostbytraversingknownhostsedges.2.5TheImpactofknownhostsHarvestingonRemoteExploitAttacksHowmuchmorequicklycananattackeridentifyanewtargetbyusingaddressharvestingthanbyusingalternativessuchasscanning?Theanswerdependsonwhethertheat-tackerislookingforanyhostrunninganSSHserveroronlythosehoststhatacceptoneofthecredentialsthathehasac-quired.Inthissection,wefocusontheformercase,andassumethatanattackercanbreakintomostSSHserversbyusingasoftwareorprotocolexploit.Weaddressthelattercaseinthefollowingsection.Figure5illustrateshow,givenaremoteexploitinanSSHserver,anattackerstartingfromasinglehostcoulduseknownhostsentriestorapidlywalkthroughanin-stitutionalnetworkfromourstudy.Figure5(a)showstheoriginhostandthesubmittinghoststhataredestinationsofitsknownhostsentries.ThesubmittinghoststhataredestinationsofthesehostsareaddedinFigure5(b).AthirdstepyieldsthecollectionofsubmittinghostsinFigure5(c).Tosimplifythesegraphs,thelargesetofdestinationsthatarenotsubmittinghostsornotwithinthesamenetworkarenotshown.Tobetterquantifytherateofpropagation,wecomputed,foreachofthe173submittinghosts,thenumberofaddi-tionaltargethoststhatarereachableinagivennumberofsteps.Figure6showsthemediannumberofreachablehostsateachstep.Overahundrednodesarereachableinthesec-ondstepandthousandsinthethird.Thepropagationthendiminishesaswereachthelimitsofthedatacollectedinourstudy.Toputaddressharvestingincontext,welookedatthealternativeofscanningforSSHservers.Weuseddatafromthe2001studyofProvosandHoneyman[18],whofoundthat/8networkswiththedensestpopulationofrespondingSSHserverswouldrespondtobetween1%andjustover1.5%ofscans.Withinadenselypopulatedacademicnet-work,theyfoundthatmorethan10%respondedtoSSHscans.RandomlyscanningthefullIPv4addressspace,theyfoundthesuccessratewascloserto0.05%. 0 500 1000 1500 2000 2500 1 2 3 4 5median number of reachable hostsstepFigure6.Themediannumberofhoststhatcanbereachedfromanoriginhostbytravers-ingallknownhostsedges.Insummary,avalidknownhostsentrycanreplace10to2,000scans,dependingonwhethertheattackerhasalreadyidentiﬁedadenselypopulatednetworkorifheisscanningrandomly.Whereasknownhostsentriescanbeusedtoreach2000hostsinjustthreepropagationcy-cles,hundredsofthousandstomillionsofscanswouldberequiredtoreachthismanyhostsoncenearbytargetshadbeenexhausted.Asevena20%connectionsuccessrateislowenoughtoindicatemaliciousbehavior[19],forcingat-tackerstoscancanbeaneffectivemeansofmakingattacksdetectablewhilesimultaneouslyslowingthemdown.2.6TheEffectofknownhostsonSpeedofCre-dentialManagementAttacksAttackershaveusedpasswordcrackingattacksandpass-wordscollectedviatrojanedSSHclientstoattackSSHserverswithoutexploitinganyﬂawsinthesoftwareitself.Theycouldalsoeasilymodifythesetoolstocrackthepassphrasesofencryptedidentitykeys.Forattacksthatem-ploycompromisedcredentials,theattackermustidentifyspeciﬁcSSHserversthatacceptthesecredentials.AstheattackermaydiscoverandconnecttoSSHserversatwhichthecredentialshehasappropriatedarenotaccepted,theconnectionsuccessratewillbelowerwhenmeasuredasafractionconnectionsthatresultinsuccessfullyauthenti-catedconnectionsthanthosethatsimplycompletetheTCPhandshake.Wethusrecommendthatsystemsbuilttodetectscansbeinstrumentedtoobservetheresultoftheauthenti-cationprocessforSSHconnections.Findingdistanthoststhatacceptagivensetofcreden-tialsrequiresvarylargenumbersofscans.Evenifstolencredentialsarevalidat1000distantaccounts,anaverageofovertwomillionrandomscanswouldberequiredtoﬁndtheﬁrstviabletargetwithinthevalidIPv4space.Withoutare-motelyexploitablevulnerability,attackingfromnetworktonetworkrequiresanapproachmoreeffectivethanscanning.Anattackerwillneedadditionalinformation,whetheritbeobtainedbyharvestingaddressesorwaitingfortheuserofacompromisedaccounttotypeinthenextdestination.SolongasknownhostsﬁlesmapuserstotheIPad-dressesofhoststhatarelikelytoaccepttheircredentials,attackersneedlooknofurtherwhenidentifyingnewtargets.2.7EvidenceofPoorCredentialManagementInadditiontocollectingknownhostsdata,ourcollec-tionscriptcheckedtoseeifidentitykeyﬁleswerepresentandwhetherusershadencryptedthemwithpassphrases.Of447identitykeyﬁlescollected,276(61.7%)wereun-encryptedandopentoabusebyanyonewithaccesstoreadthem.Ofthe12,035uniqueknownhostsdestinationad-dressesdiscoveredinoursurvey,4,314(or36%oftheto-tal)originatedfromuseraccountsinwhichanunencryptedidentitykeywaspresent.3CounteringAddressHarvestingAttacksHostnamesandaddressesmaybestoredinaprogram’sconﬁgurationbeforeexecution,initsstateduringorbe-tweenexecutions(knownhosts),andinlogsforac-countingorforensicpurposes.3Eachtypeofﬁlehasdif-ferentrestrictionsregardingwhichpartiesneedtobeable3Addressesenteredascommandlineparametersmayalsobestoredinshellhistoryﬁles.ThesecuritycommunityhasknownaboutthedangersSSHUser/AdminReadsWritesReadsWritesknownhostsXXXXconﬁgﬁlesXXXlogﬁlesXXTable3.OftheﬁlesreadorwrittenbySSHthatcontainhostnames/addressesofotherhosts,onlyknownhostsmustbereadableandwritablebybothSSHanditsusers.toreadorwritetoit,asillustratedinTable3,andsodif-ferentcountermeasures(orvariantsoncountermeasures)toaddressharvestingmayapplytoeach.Themostchalleng-ingﬁletomanageisknownhosts,asitmustbereadandmodiﬁedbothbySSHandbythosethatuseandadministerit.WewilltakeadvantageofthefactthatthecommoncaseisfortheﬁletobereadandappendedtobytheSSHclient,andthatusersonlyneedtoaccesstheﬁlemanuallywhenlocatingorremovinganentry.3.1ProtectingknownhostsTounderstandhowSSHimplementationscouldhidead-dressesinknownhostsdatabases,itisinstructivetolookathowpassworddatabasesevolvedtodefendagainstsim-ilarthreats.Earlymulti-usercomputersstoredpasswordsinplaintextﬁlesand,likeknownhostsﬁles,reliedupontheﬁlesystemtopreventtheirmisusebykeepingthemse-cret.In1974,Evans,KantrowitzandWeiss[5]proposedthatpasswordsbehashedwithaone-wayfunctionbeforebeingstoredinthepasswordﬁle.4Theirkeyobservationwasthatthehostdidnotneedtostorethepasswordsthem-selves,butonlyenoughinformationtolaterverifythatapasswordprovidedtothehostwasthesameonetheuserhadpreviouslyprovided.Thesameholdstrueforanysen-sitivedatum,suchasahostnameoraddress,thatmustbetestedforequalityagainstavalueprovidedinthefuture.Wepresentthreesimilarapproaches,summarizedinTable4,thatalsouseone-waycollision-resistanthashfunctionstoobscurethenamesandaddressesofhostsinknownhostsﬁles.Eachsolutionismoreharvest-resistantthanthelast,buteachcomeswithanadditionalusabilitycost.ofhistoryﬁlesforsometime.Fortunately,theseﬁlesareunlikethosediscussedinthissectioninthattheyarenotneededbytheprogram,notneededforsecuritypurposes,andtrivialtocleanse.4Fordetailsontheadoptionofthisapproach,seetheearlyworkofRobertMorrisandKenThompson[14]ormorerecentlyGarﬁnkeletal.[7].ContentsofknownhostsentryHarvestresistanceAdditionalusabilitycost(0)name,ipaddr,keyNoneNone(1)(s1,h(s1◦name)),(s2,h(s2◦ipaddr)),keyResistsplaintextharvestingNewcommandsrequiredtoﬁnd/deleteentries(2)(s1,h(s1◦name)),(s2,h(s2◦name,ipaddr)),keyResistsofﬂinedictionaryattacksonIPv4addresssaceUsercan’tlocateknownhostsentriesusingonlytheirIPaddress(3)(s1,h(s1◦name◦key)),(s2,h(s2◦name◦ipaddr◦key)),dateandtimeentryaddedResistsofﬂinedictionaryattacksontheIPv4addressspaceandonhostnamesUsercan’tdistinguishnewkeysentbyhostinknownhostsfromkeysentbyunknownhost.Addsneedforkeyrevocationlists.Table4.AsummaryofpossibleorganizationsforSSHknownhostsentries,wherehisaone-waycollision-resistanthashfunctionandsaltss1ands2arerandomlygeneratedforeachentry.Eachapproachisincrementallymoreresistanttoharvestingthantheoneaboveit,butincursanincrementalcostinusability.Approach(1)–Simplename/addresshashingThesimplestapproachtopreventharvestingofplaintexthostnamesandaddressesistohashtheirvaluesasonewouldhashapasswordinthepasswordﬁle.Randomlygeneratedsalts,s1ands2,areusedtoensurethattheworkrequiredtostageadictionaryattackagainstoneen-trycannotbere-usedonotherentries.Thecontentsoftheknownhostsﬁleforthissimplehashingstrategyissum-marizedinrow(1)ofTable4.WeﬁrstimplementedthisapproachintoOpenSSH3.9usingSHA1[15]asourhashfunctionhandbase64encod-ingsofrandom64bitnumbersassalts.Inresponsetoear-lierdraftsofthispaper,theOpenSSHdevelopmentteamcodedtheirownimplementationofthisapproach,whichﬁrstappearedinOpenSSH4.0.WhentheSSHclientiscalledupontoinitiateanewconnection,itchecksthedestinationhostnameandad-dressagainsttheknownhostsdatabaseentrybyentry.Aspecialstring(‘<’inourimplementationand‘|1|’intheOpenSSH4.0implementation)indicatesthatthehostnameoraddresshasbeenreplacedwithahashedtoken.Inthiscase,thedestinationhostnameoraddressishashedus-ingthesaltextractedfromthetoken,base64encoded,andthencomparedtothehashencodedinthetoken.Matchingencodingsimplywithhighprobabilitythattheaddressesmatch.TomaintainbackwardscompatibilitywithearlierSSHimplementations,aplaintextcomparisonbetweenad-dressestakesplacewhentheaddressinaknownhostsentryisnothashed.Sinceentriesintheknownhostsdatabasearecre-atedandveriﬁedautomaticallybytheSSHclient,itsbe-haviorwillremainunchangedfromtheuser’sperspec-tive.Weimplementedtwonewcommandsformanip-ulatingtheknownhostsﬁleshouldtheuserneedtodoso.remove-knownhostdeletesahostentryfromknownhostsbynameandssh-showkeyreturnsthekeyofahostspeciﬁedbynameoraddress.IntheOpenSSH4.0implementation,thesecommandsareintegratedasop-tionsinssh-keygen.Tospeedthetransitiontohashedhostaddresseswepro-videaprogram,ssh-hostname-encoder,thathashesalloftheaddressesinanexistingknownhostsﬁle.InOpenSSH4.0,thisfunctionalityisaccessibleviaacom-mandoptioninssh-keygen.WehavealsoprovidedaPerlscript,convertknownhosts.pl,thatcanberuntoconvertallknownhostsﬁlesonagivenﬁlesys-temintohashedhostaddressformat.AsnosuchscriptwasprovidedbytheOpenSSH4.0teamfortheirimple-mentation,wehaveprovidedoneatourprojectwebsite(http://nms.csail.mit.edu/projects/ssh).Approach(2)–ResistingIPv4dictionaryattacksAswithpasswordﬁles,theabovehashingapproachispo-tentiallyvulnerabletoanofﬂinedictionaryattack.OnIPv4networks,theattackercanexpecttoidentifyanIPaddresswithaworst-caseaverageof231SHA1calculations.Whilethismightbetimeconsumingenoughtoslowspreadandraisealarms,anattackercandecreasetheexpectedworkbystartingwithaddressesnearthatofthecompromisedhost(recallFigure1).Allofthenodesonthevictimhost’sclassCcanbeidentiﬁedbyperforminglessthan256SHA1cal-culationsperknownhostsentry.ThepossibilityofdictionaryattacksleadsustosuggestthatSSHclientimplementationsmaynotwanttostoreIPaddressesatall.Itshouldonlybenecessarytoassociatethekeywiththeaddressusedbytheuseronthecommandline,whichismostoftenthedomainname.IfhashedIPaddressesmustbestored,thanweproposethatitshouldbesaltedbothwitharandomsaltandwiththehostname,asillustratedbytheknownhostsformatinrow(2)ofTa-ble4.ThiswillsigniﬁcantlyincreasethecomputationcosttoattacknetworkswherereverseDNSlookupsandzonewalkingaredisabled,andincreasethelikelihoodofdetec-tionwherereverseDNSlookupsareenabledbutmonitored.Approach(3)–ResistingallofﬂinedictionaryattacksHostnamesarealsosubjecttodictionaryattack,espe-ciallyifcommonnamessuchas“gateway”,“mail”,and“database”areusedorifDNSserversareconﬁguredtoal-lowsubdomainenumeration(“zonewalking”).AdesignapproachtoeliminateofﬂinedictionaryattacksrequiresmorefundamentalchangestothewaythatSSHclientscon-ﬁrmthatthehostbeingcontactedisindeedonethatwaslastcontactedatthesameaddress.Weproposethatratherthanstoringentriesthatconsistofhashednamesmappedtothehost’skey,theSSHclientshouldinsteadconcatenatethehostkeyontothevaluetobehashedforthenameandaddressentriesasillustratedinrow(3)ofTable4.Whenahostiscontactedinthefuture,itskeywillbere-trievedbeforetheknownhostsﬁleissearchedandsoitisstillpossibletocheckwhetherthekeyisassociatedwithanyknownhostname/addresspairs.Obtainingthekeysre-quiresthattheattackerstageanonlinedictionaryattack,contactinghoststhatitmaynotbeabletoauthenticatetoandincreasingthelikelihoodofdetection.Theadditionalbeneﬁtincursasigniﬁcantlyhigherus-abilitycostthanthepreviousapproaches.First,boththehostnameandthekeyarerequiredinordertoidentifyorremoveanentryfromtheknownhostsdatabase.Ifakeywaslostandneededtoberevoked,arevocationlistwouldneedtobeemployedtorevokeallkeysassignedtothathostbeforethedateonwhichthekeywasreplaced.What’smore,userswouldnotbeabletodifferentiatebe-tweentheresponsereceivedwhentheyﬁrstcontactedahostandtheresponsereceivedwhenahost’skeychanged.For-tunately,thecorrectsecuritybehaviorinbothcasesshouldbethesame–theusershouldcheckthehashoftheserver’skeyagainstahashobtainedthroughasecurealternatechan-nel.3.2ProtectingconﬁgurationﬁlesHostaddresshashingcanalsobeusedtoprotectad-dressesinuser-conﬁguredﬁlessuchasthetrustedhostﬁle(.shosts)andtheuser’smainconﬁgurationﬁle,solongasthehostnameneednotbereaduntilthehosttobecon-tactedhasbeenidentiﬁed.However,usingincomprehensi-bletokensinplaceofplaintextaddressesintheseﬁlesmayraiseconcernsforanysophisticateduserorsystemadmin-istratorwhomaywanttoaudittheseﬁlestoensuretheydonotplacetrustinthewrongremotehosts.Fortunately,thereismoreﬂexibilityindesigningso-lutionstothisproblemthanthatoftheknownhostsdatabase,asconﬁgurationﬁlesarenotwrittenbySSH.Thus,solutionsdonotneedtosupportmechanismsthroughwhichtheSSHclientorservercanchangetheﬁle.Toensurethatconﬁgurationﬁlescouldbeaudited,ade-terministicpublickeyencryptionfunctioncouldbeusedin-steadofahashfunctioninordertoobfuscatehostnames.Anauditorwiththeprivatekeywouldbeabletoreversethefunctiontoverifyitscontents.3.3ProtectinglogﬁlesThelogﬁlesgeneratedbytheSSHservernotonlycon-tainthenamesofotherhostsrunningtheSSHprotocolsuite,butalsothenamesofusers’withaccountsonthosehosts.Whilethisinformationisdangerousinthehandsofanattacker,itisessentialtothosetaskedwithdetect-ingandtrackingintrusions.Fortunately,inexploringthesolutionspacetothisproblemwecantakeadvantageofthefactthatlogsneednotbewrittenbyusersoradministratorsand,moreimportantly,thattheyneednotbeprocessedbyanyoneotherthanthesystem’sadministrators.Wecanpreventlogentriesfrombeingharvestedifwecanencrypttheseentriestoensurethat,oncewritten,thedatacannotbereadbytherecordinghost.Onlyanauditorwithasecretkeyshouldbeabletotranslatethelogbacktoitsoriginalplaintextform.Ana¨ıvealgorithmtoaccomplishthiswouldencodeeachentryinthelogusingapublickeycryptosystem.LesscomputationallyintensiveapproachestosecuringauditlogshavebeenintroducedbyYeeandBel-lare[32],SchneierandKelsey[20],andWatersetal.[28].Asimpliﬁedalgorithmthatmeetsourrequirementscanbeconstructedusingapublickeypair.WhentheSSHserverbeginsexecuting,itcreatesarandomsessionkeyk0forusewithafastersymmetriccryptosystem.Itthenencryptsthisk0withthepublickeyandwritesittothelog.Eachlogentrythenbeginswithitssequencenumber,i,followedbytheentrycontentsencryptedwithsymmetrickeyki,whereki=h(ki−1).Oncetheloggingfunctionhasencodedtheentry,itimmediatelycalculateski+1anddiscardskifrommemory.Toreadapreviousentrywouldrequireonetode-rivekifromki+1,whichinturnwouldrequirebreakingtheone-wayhashfunction.4EncouragingSaferUseofGatewayHostsInSection2.4wesawevidenceoftheexistenceoflargegatewayhosts,idealtargetsforcredentialtheftattackssuchaspasswordcracking(seeSectionA.2)andforharvestingaddressesofhoststhatmayacceptstolencredentials.Whilehinderingattemptstoharvestaddressescanhelptothwartthespreadofattacksthroughgatewayhosts,itisbettertoavoidrunningSSHclientsonthesehostsalto-gether.AnidealSSHgatewayisoneonwhichtheSSHserver,butnottheSSHclient,isinstalled,andthroughwhichuserscanforwardTCPconnectionsbutexecutenootheroperations.Tomakeiteasiertousesuchgateways,wehaveimplementedanewSSHclientcommandoption,-H,whichindicatesthestartofanewconnectionwithinachainofcascadingconnections.ssh-Hgateway-HserverIntheaboveexample,theclientestablishesonecon-nectiontogatewayandthenestablishesasecurechannelfromtheclienttoserverthroughgateway.Thesyntaxsupportsthecascadingofconnectionsthroughanynumberofgatewayhosts,allwithencryptedconnectionsbacktotheuser’simmediateclient.Optionsspeciﬁedbeforetheﬁrst-Hareappliedtoallhostsinthechain,whereasoptionsspeciﬁedbetweena-Handahostnameareappliedonlytotheconnectiontothathost.TheimplementationusesUNIXdomainsocketsforcommunicationinordertoavoidopen-ingTCP/IPportsaccessibletootherusers.ExistingmethodsdoexistforchainingthroughlocalhostsandaredocumentedinthetextSSH,theSecureShell:TheDeﬁnitiveGuide[1],buteachhasseriousdrawbacksthathavekeptthemfrombeingwidelyused.Onesuchap-proachuseslocalTCP/IPportforwardingtoestablishtheconnectionfromtheclienttotheserverthroughthegate-way.OneofthedisadvantagesofthisapproachisthatotherusersontheclienthostcouldconnecttotheporttobypassthegatewayasTCP/IPcannotdistinguishbetweentheseusers.Anotherdisadvantageisthatthemethodre-quiredproperuseoftheHostKeyAliasconﬁgurationoptionsothattheconnectionforwardedthroughthelocalportisn’ttreatedasaconnectiontolocalhostintheknownhostsdatabase.Finally,theusermustusetwodifferentshellsontheclienthosttoinitiateclientsandtheirconnectionstothegatewayandserver.SSHconnectionscouldbeforwardedthroughgatewayhostsbysettingupaproxyintheuser’sSSHconﬁgurationﬁle,butproxyentriesmustbecreatedforeachgateway.Thepresenceofgatewayproxycommandsintheuser’sconﬁgu-rationwouldalsobecomeanattractivetargetforharvestingandcannotbetriviallyobfuscatedusingthetechniquespre-sentedinthispaper.Proxyforwardingalsopresentsprob-lemsifthegatewayusesanyformofinteractiveauthenti-cation,suchastheuseofpasswords.Giventhecomplex-ityandlimitationsoftheavailableoptions,it’slittlewonderthatmostusershavetakentheroutethat’ssimplestforthem:issuingacommandtotheSSHclientonthegatewayhostifoneisavailable.5AnticipatingFutureAttacksthatTargetHostAuthenticationviaSSHThewidespreadSSHattacksof2004arebelievedtobetheworkofasingleindividual[8,13]andwerenotfullyautomated.Oncehehadobtainedauseraccountonahost,theattackerwouldattempttogainrootaccessorﬁndotherwaystocompromiseotheraccountsonthehost,suchasbyexploitingavulnerabilityinNFS[22].Aself-propagatingwormarmedwithacommonvulnerabilityforescalatinguserprivilegestorootprivileges(oratleastgainingaccesstopassword/keyﬁles)couldusethesamesetofimperson-ationattacks.Suchafullyautomatedattackwouldnotbelimitedbythetimeavailabletotheattackerandcouldcausesigniﬁcantlymoredamage.Manyofthecomponentsforsuchaworm,suchastrojanSSHclientcode,passwordcrackingalgorithms,andtoolstoperformonlinedictionaryoverSSH,arereadilyavailable.Alistofthepotentialmech-anismsofattackaresummarizedinTable5,andsurveyedindetailinAppendixA.Tospreadquickly,anSSHwormwouldneedtoinfectasmanynewhostsaspossibleimmediatelyaftereachhostiscompromised.Uponcompromisingagatewayhost,awormcouldimpersonatethathost’susersbytakingoveroutgoingSSHclientsessions(rowI1inTable5)orbyusingforwardedagentstoauthenticateonitsbehalf(T2)andthenaddingkeystotheremoteauthorizedkeysﬁle(I2).Uponcompromisingahostofanytype,awormcouldimmediatelysearchforunencryptedidentitykeysintheﬁlesystem(T1)andextractidentitykeysfromrunningagents(C2).Obtainingrootaccesstothecompromisedhostswouldenabletheseattackstobecarriedoutusingdatafromallofthehost’susers,andwouldthenenablethewormtobeginanofﬂinedictionaryattacktoobtainanypasswordandkeycredentialsthatitdoesnotalreadyhave.Theknownhostsﬁleenablesthewormtoimmediatelyidentifyhostsondistantnetworksthatmayacceptstolencredentials.Awormcanalsostealcredentialsbyinteractingwithusers,recordingpasswordsasuserslogintoSSHserversithascompromised(C1)andobservingpasswordssenttoSSHclientsandagentsthatithascompromised(C5).Bystartingthisprocessimmediately,thewormmaybeabletostealcredentialsfromadministratorsshouldtheydetectthewormandlogininanattempttoremoveit.rootnotrequirednon-interactivestealthyAttackEventtriggeringattackopportunityT1ExtractunencryptedidentitykeystoredonhosttrustedbycredentialholderUser’saccountorhostcompromised*XXT2ForwardedagentusedtoauthenticateattackerCompromiseofaccountorhostalreadyrunningforwardedagents*XXC1PasswordstolenbycompromisedSSHserverNewpassword-authenticatedsessiontocompromisedserverXXC2IdentitykeyextractedfromSSHagentpro-cessesCompromiseofhostrunningagentpro-cesses*XXC3OnlinedictionaryattackonpasswordﬁleAuthenticationinitiatedwithcorrectusername/passwordguessXXC4OfﬂinedictionaryattackonpasswordsandidentitykeysPasswordhashcomputationcompletedwithcorrectpasswordguessXXC5Passwordorkeyenteredintopreviouslycom-promisedSSHclientoragentSSHclient/agentexecutedoncompro-misedhostXXI1/2Session/CredentialinsertionattackUser’saccountorhostcompromised*XXTable5.AttacksonSSHandthepropertiesthatmakethemamenableforuseinaworm.AnXindicateseitherthatanattackcanberunfromauseraccount(rootnotrequired),neednotwaitforinteractiveusereventsinordertospread(non-interactive)orwouldnotrequireexcessivenetworktrafﬁc(labeledstealthy).Astar(*)indicatesthattheattackcanrunwithoutrootprivileges,butonlyagainstaccountsavailabletothecompromiseduser.6RelatedThreats&RelatedWorkTheMorriswormof1988harvestedtargetaddressesfromﬁlessuchas.rhostsand.forward,andusedofﬂinedictionaryattackstocrackpasswords[23].Be-causetheMorriswormpredatedtheadventofSSH,knownhostsﬁleswerenotavailableforharvest.TrojanedSSHclientsthatcollectpasswordshavealsobecomewidespread,andanumberofthesehavebeenliftedfromcompromisedhosts[4].SuchatoolwasusedbytheperpetratorofthemajorSSHattacksof2004,whocompro-misedhostsintheU.S.military,NASA,supercomputingcentersincludingthosesupportingtheTeraGrid,andaslewofuniversities[8,17,33,22].However,todatetherehasbeennoevidenceofatrueSSHwormwhichcouldspreadwithouttheneedforuserinteraction.WormstargetingprotocolsotherthanSSH,suchasLov-gate[27],Deloader[25,6],andGaobot[26]alreadyuseon-linedictionaryattackstobypasshostauthenticationwithoutuserinteraction.Whilesuchbruteforceattacksareamongtheleasteffective,theyarefrequentlyfoundinthewildbe-causetheyareamongtheeasiesttowrite.ThetoolsrequiredtocarryoutonlinedictionaryattacksagainstSSHhavebeenautomatedandmadepubliclyavailable[21].Evidenceoftheiruseappearsinourlogs,anecdotalreportsofothernet-workresearchers,andpubliclyavailablereportsfromtheSANSInternetStormCenter[3].7ConclusionWeshowedinourstudythatknownhostsﬁlespro-videampleremotetargets,withamedianoffourteenad-dressestodistantnetworksidentiﬁedperhost.EachdistantknownhostsentryanattackerdiscoverssaveshundredstothousandsofscanstoﬁndadistantSSHservertoat-tack,andmanymorescansiftheattackerseeksaserverthatwillacceptaspeciﬁcuser’scredentials.Wealsoiden-tiﬁedimportantoutliersinthedata,suchasgatewayhoststhatcontainhundredsofknownhostsﬁleswithentriestothousandsofuniquedestinations.Thedistributionofuniquedestinationsperuserisheavy-tailed,asjust5%ofusers’knownhostsﬁlescollectedcontained75%oftheuniquedestinationhostsdiscoveredinourstudy.Inanticipationoffutureattacks,weexploredhowthemechanismsofattackusedinthepastandtheirsuitabilityforuseinself-propagatingmalwarethatcouldresultinsig-niﬁcantlygreaterdamagethanpriorattacks.Inresponsetolastyear’sattacksandinanticipationoffutureattacks,wepresentedaseriesapproachesforhidingknownhostsdestinationaddresses.Theseapproachesincludecountermeasuresnotonlyagainstplaintextaddressharvesting,butalsothosethatprotectagainstdictionaryat-tacksonlocalIPaddressesandhostnames.Intheepilog,wediscusstheadoptionofthesecountermeasures.EpilogThispaperwasﬁrstconceivedinearly2004anddraftshavebeeninprivatecirculationsinceJuneofthatyear.OnlylateintheyeardidweﬁrstlearnofthemajorattacksagainstSSHthatwereunderway.OnFebruary15,2005anupdateddraftwassubmittedtoofﬁcialsatF-Secure,SSHCommunicationsSecurityCorp.,andtheOpenSSHdevelopmentteam.OpenSSHrespondedbycreatingtheirownimplemen-tationofhostaddresshashingaspartofOpenSSH4.0onMarch9,2005.Unfortunately,thisimplementationdoesnotcomewithascriptwithwhichasystemadministratorcanupdateallofknownhostsﬁlesonasystem.Wehaveprovidedsuchascriptandinstructionsforturninghashingonathttp://nms.csail.mit.edu/projects/ssh/.WRQ,whichtookovertheF-SecureSSHproductlineinOctoberof2004andre-brandedtheproductunderthe“reﬂection”name,hasalsosincecommittedtoprovideanoptiontostorehostnamesinahashedformat[29].PetriSakkinenofSSHCommunicationsSecurityCorp.wroteinanemail[16]onMay17,2005that“SSHwillconsideraddingkeyhashingsupportinfutureversionsofSSHTectia,ifourenterprisecustomerswanttodeploythatapproach.”Thecompanyalsopostedastatementtoitswebsite[24].AcknowledgmentsTheauthorsareindebtedtoanumberofunnamedindi-vidualswhohavecontributedtheirtimeandefforttoeitheranonymouslycontributedatatooureffortsortocajoleoth-erstodoso.TheauthorswouldliketothankLouAnschuetz,HariBalakrishnan,RobertCunningham,DavidDagon,VictorHazlewood,GlennHolloway,RogerKhazan,DavidMol-nar,ScottPinkerton,MichaelD.Smith,BillYurcik,andouranonymousreviewersfortheiradviceandcomments.StuartSchechterwouldliketothanktheNationalScienceFoundationforsupportingthisworkwhilehewasatHar-vardundergrantnumberCCR-0310877,aswellastheMITLincolnLaboratoryAdvancedConceptsCommitteeandtheAirForcefortheirsupportsincehisarrivalatthelabora-tory.JaeyeonJungandWillStockwellwouldliketothanktheNSFforsupportunderCooperativeAgreementnumberANI-0225660.References[1]D.J.BarrettandR.E.Silverman.SSH,theSecureShell:TheDeﬁnitiveGuide.O’ReillyMedia,Inc.,Sebastopol,CA,Feb.2001.[2]M.BishopandD.V.Klein.ImprovingSystemSecurityviaProactivePasswordChecking.ComputersandSecurity,14(3):233–249,1995.[3]S.I.S.Center.PortGraph(forport22).http://isc.sans.org/port_details.php?port=22&days=70.[4]D.Dagon.GeorgiaInstituteofTechnology,Emailcorre-spondence,Dec.10,2004.[5]A.EvansJr.,W.Kantrowitz,andE.Weiss.AUserAuthen-ticationSchemeNotRequiringSecrecyintheComputer.CommunicationsoftheACM,17(8):437–442,1974.[6]F-Secure.F-SecureVirusDescriptions:Deloder.http://www.f-secure.com/v-descs/deloader.shtml.[7]S.Garﬁnkel,G.Spafford,andA.Schwartz.PracticalUNIX&InternetSecurity.O’ReillyMedia,Inc.,Sebastopol,CA,3rdedition,Feb.2003.[8]V.Hazlewood.SecurityTechnologiesManager,SanDiegoSupercomputerCenter(SDSC),Telephonecorrespondence,Jan.18,2005.[9]InternetAssignedNumbersAuthority.InternetProto-colv4AddressSpace.http://www.iana.org/assignments/ipv4-address-space.[10]InternetAssignedNumbersAuthority.RFC3330:SpecialUseIPv4Addresses.IETF,Sept.2002.[11]M.Kaminsky.UserAuthenticationandRemoteExecutionAcrossAdministrativeDomains.PhDthesis,MassachusettsInstituteofTechnology,Sept.2004.[12]M.Kaminsky,E.Peterson,D.B.Gifﬁn,K.Fu,D.Mazi´eres,andM.F.Kaashoek.REX:Secure,ExtensibleRemoteExe-cution.InProceedingsofthe2004USENIXAnnualTechni-calConference,pages199–212,June2004.[13]J.MarkoffandL.Bergman.InternetAttackCalledBroadandLongLastingbyInvestigators.TheNewYorkTimes,May10,2005.[14]R.MorrisandK.Thompson.PasswordSecurity:ACaseHistory.CommunicationsoftheACM,22(11):594–597,1979.[15]N.I.ofStandardsandTechnology.SecureHashStandard.FIPSPUB180-1,Apr.17,1995.[16]PetriSakkinen,Director,SolutionMarketing,SSHCom-municationsSecurity.“SSHWorm”andSSHCom-municationsSecurity.Emailcorrespondence,archivedathttp://nms.csail.mit.edu/projects/ssh/SSHIncEmail.html,May17,2005.[17]S.C.Pinkerton.NetworkSolutionsManager,ArgonneNa-tionalLaboratory,Emailcorrespondence,Feb.4,2005.[18]N.ProvosandP.Honeyman.ScanSSH-ScanningtheInter-netforSSHServers.InProceedingsofThe15thUSENIXSystemsAdministrationConference(LISA),2001.[19]S.E.Schechter,J.Jung,andA.W.Berger.FastDetectionofScanningWormInfections.InProceedingsoftheSeventhInternationalSymposiumonRecentAdvancesinIntrusionDetection(RAID2004),Sept.15–17,2004.[20]B.SchneierandJ.Kelsey.SecureAuditLogstoSupportComputerForensics.ACMTransactionsonInformationandSystemSecurity(TISSEC),2(2):159–176,1999.[21]K.-O.Security.SSHRemoteRootPasswordBruteForceCrackerUtility.http://www.k-otik.com/exploits/08202004.brutessh2.c.php,Aug.20,2004.[22]A.Singer.TemptingFate.;login:TheUSENIXMagazine,30(1),Feb.2005.[23]E.H.Spafford.TheInternetWormProgram:AnAnalysis.TechnicalReportCSD-TR-823,PurdueUniversityDepart-mentofComputerSciences,1998.[24]SSHCommunicationsSecurity.Statement:SecureShellandAddressHarvesting.http://www.ssh.com/company/newsroom/20050518_mit.html,May18,2005.[25]Symantec.Securityresponse–W32.HLLW.Deloder.http://securityresponse.symantec.com/avcenter/venc/data/w32.hllw.deloder.html.[26]Symantec.SecurityResponse–W32.HLLW.Gaobot.AA.http://securityresponse.symantec.com/avcenter/venc/data/w32.hllw.gaobot.aa.html.[27]Symantec.SecurityResponse–W32.Lovgate.mm.http://securityresponse.symantec.com/avcenter/venc/data/w32.hllw.lovgate@mm.html.[28]B.R.Waters,D.Balfanz,G.Durfee,andD.K.Smetters.BuildinganEncryptedandSearchableAuditLog.InPro-ceedingsofthe11thAnnualNetworkandDistributedSecu-ritySymposium(NDSS’04),Feb.1–6,2004.[29]WRQ.AHypotheticalThreattoSSH:WhatCustomersNeedtoKnow.http://www.wrq.com/products/whitepapers/0976.html,June2005.[30]T.Wu.TheSecureRemotePasswordProtocol.InProceed-ingsofthe1998InternetSocietyNetworkandDistributedSystemSecuritySymposium,pages97–111,Mar.1998.[31]J.Xu,J.Fan,M.H.Ammar,andS.B.Moon.Preﬁx-PreservingIPAddressAnonymization:Measurement-basedSecurityEvaluationandaNewCryptography-basedScheme.InProceedingsofthe10thIEEEInternationalConferenceonNetworkProtocols(ICNP’02),Nov.12–15,2002.[32]B.S.YeeandM.Bellare.ForwardIntegrityforSecureAu-ditLogs.Technicalreport,UniversityofCaliforniaatSanDiegoDepartmentofComputerScienceandEngineering,Nov.1997.[33]W.Yurcik.SeniorSystemsSecurityEngineer,TheNa-tionalCenterforSupercomputingApplications(NCSA),Telephonecorrespondence,Jan.28,2005.AHostAuthenticationAttacksviaSSHThemechanismsdescribedbelowexploitaccesstooneormorecompromisedaccountsononehostinordertoim-personatethoseuserswhoalsohaveaccountsonotherhostsinordertogainaccesstothoseotherhosts.A.1ExploitingmisplacedtrustSSHserversanduseraccountsareoftenconﬁguredtotrustotherhoststoactontheirbehalf,toauthenticateusers,ortosafelystoreusercredentials.Allofthesepracticesarepotentialtargetsofattack.T1—Exploitationoftrustinotherhoststoauthenti-cateuserorsecurestorecredentialsIfanattackcomesfromacompromisedhostthatislistedintheshosts.equivorhosts.equivﬁleinthetar-getserver’s/etcdirectory,orthe.shostsor.rhostsﬁleofthetargeteduser,theattackerwillbepermittedtoconnecttoatargetuser’saccountwithoutpresentingusercredentials.Evenifnohostsareexplicitlytrustedtoauthenti-cateonbehalfofthetargethost,suchtrustisoftenim-plicit.ManyusersplacetheirpublicidentitykeysintheirauthorizedkeysﬁlesonSSHserversandleavetheirsecretidentitykeyunencryptedonhoststheyuseasSSHclients,trustingthattheseaccountswillnotbecompro-mised.Ifonesuchclientaccountorhostiscompromised,thentheattackercanreadtheunencryptedidentitykeyanduseittoauthenticatetothetargethost.T2—AbuseofforwardedauthenticationagentAuthenticationagentsareprogramsemployedbyuserstoauthenticateontheirbehalf.Theyfreeusersfromtheneedtoretypethepassphrasesthatprotecttheiridentity-keycre-dentialseachtimethattheyauthenticate.Ausercanconﬁgurehisagenttoauthenticateonhisbe-halfwhenaccessingservicesfromanapplicationrunonaremotehost.However,mostSSHagentsdonotverifythattheactionsaremotehostperformsaretheactionstheuserintendedtoauthorize.Thus,whentheuserbelievesheisau-thorizingaCVStransactionhemayinsteadbeauthorizinganSSHconnectiontoahosttargetedbytheattacker.5A.2CredentialtheftAnattackerwhocanobtainauser’scredentialscanim-personatethatuseronanyhostthatacceptsthesecreden-tials.Anattackermaychoosefromanyofanumberofap-proachestostealcredentials.5TheagentinMichaelKaminsky’sremoteshellclient,REX[11,12],providesapartialsolutiontothisproblembyverifyingthattheservicebeingauthorized(butnotthecommandorparameterspassedtotheservice)isindeedtheonethattheuserintended.C1—PasswordtheftbycompromisedSSHserverWhenauthenticatingviapasswords,theSSHclientwillsendtheuser’spasswordcredentialstotheserveroveranencryptedchannel.Whentheuser’spasswordarrives,itisthendecryptedintoplaintextbeforeitischeckedagainstthepasswordﬁle.Iftheserverbelongsto,orhasbeencompro-misedbytheattacker,thentheattackercanmodifytheSSHservertocollectthesepasswords.Theattackercanthenpro-ceedtogainaccesstootherhostsonwhichthispasswordisusedforauthentication.Thisattackcanbethwartediftheclientisconﬁguredtoauthenticateviaachallenge-responseprotocol,suchasSSHidentity-keyauthenticationortheSecureRemotePassword(SRP)extension[30].C2—ExtractionofkeysfromauthenticationagentsTofreeusersfromtheneedtoretypethepassphrasesthatprotecttheiridentitykeycredentials,anauthenticationagentmustkeepthesecredentialsinitsmemory.Onceanaccountiscompromised,anattackercansearchtheprocesstableforactiveauthenticationagentprocesses.WhiletheSSHagenttakescaretoinstructoperatingsys-temsnottoallowitsmemorytobedumped,anattackerwithsufﬁcientprivilegeswillbeabletoinspectitsmemoryspaceinordertolocateidentitykeycredentials.C3—OnlinedictionaryattacksAnonlinedictionaryattackisstagedbyrepeatedlyattempt-ingtoauthenticatetoaremotehostusingcommonpass-words.Intrusiondetectionsystemscanbetrainedtodetecttheseattacksandterminatecommunicationswithattackinghosts.However,ifanattackinghostispermittedtocontinuetheseattacksandchoosesalargesetoftargets,itwilleven-tuallyﬁndserversthatallowcontinuedconnectionattemptsandemploycommonpasswords.C4—OfﬂinedictionaryattacksAfterobtainingthepasswordﬁleonacompromisedhost,anattackercantestcandidatepasswordsagainstthepasswordﬁleortrytodecryptidentitykeyﬁlesinuserhomedirec-tories.Whileitislikelythatanattackerwhocouldaccessthepasswordﬁlecouldcompromisethisaccountwithoutthepassword,chancesarethattheuseremploysthispass-wordtoauthenticatetootherhostsaswell.Suchofﬂinedictionaryattacksalsodifferfromtheironlinecounterpartsinthattheattackerneednotruntheauthenticationprotocol.Thisisadvantageousbecauseexecutinganetworkprotocolincreasestheriskthatalarmswillbeactivatedandintro-ducesanetworkdelayforeachpasswordtested.Onceauser’scredentialshavebeencompromised,theattackercanusethemtogainaccesstootherhostsonwhichtheyareaccepted.66A1995studybyBishopandKlein[2]showedthat40%ofpasswordswerecrackable.Morerecentreliablestatisticsonthepercentofcrackablepasswordsarehardertoﬁnd.Sufﬁceittosaythatwhileuserawarenessofweakpasswordsmayhaveimprovedsincethen,thesophisticationofC5—EavesdroppingbyclientsoftwareorhostApatientattackerwhohascompromisedauser’saccountcanmodifyorobservetheSSHclientandagenttocollectpasswordsandidentitykeypassphrasesastheusertypesthem.Thehostaddress,username,andpasswordtripletsdiscoveredcaneitherbestoredorsentdirectlytotheat-tacker.ManyusersﬁnditconvenientornecessarytoopenSSHclientsonhoststowhichtheyarealreadyconnectedviaSSH.WeusethetermgatewayhoststodescribethosehoststowhichauserconnectsviaSSHfromaclientandfromwhichtheusertheninitiatesanewSSHconnectiontoan-otherhostrunningtheSSHserver.Itisoftennecessarytousegatewayhostswhenﬁrewallspreventdirectaccessfromtheuser’simmediateclienttohisorherdesireddestinationhost.SSHmayalsobeemployedtoprotectﬁletransfers,CVScommands,orotherservicesrequiredbysoftwarethatisrunatagatewayhost.AttackerscanstrikeusersonthesegatewayhostsevenifanSSHserverisnotrunontheuser’simmediateclient.A.3InsertionattacksAnattackermaybeabletoinserthisowncommandsintoausersessionorinserthisowncredentialsinplaceofale-gitimateuser’scredentials.Theﬁrstattackdescribedbelow,inwhichtheattackerimpersonatestheuserforpartoftheSSHsession,canbeusedtoperformthelatterattack,whichallowstheattackertoimpersonatetheuserinfutureses-sions.I1—SessioncaptureandcommandinsertionWhileproperuseofidentitykeys,authenticationagents,andagentforwardingcanprotectagainstcredentialtheftatgatewayhosts,thesepracticescannotprotecttheuserifthehostherunstheSSHclientoniscompromised.Allcommu-nicationsaredecryptedandthenre-encryptedattheclient,andsoftwareatthishostcaninsert,modify,ordeleteinfor-mationatwill.I2—CredentialinsertionorreplacementAnattackercaninsertanidentitykeyintotheuser’sauthorizedkeysﬁle.TheSSHserverdependsonthisﬁletodeterminewhichkeystheuserhasauthorizedtoserveashiscredentials.Ifthecompromiseduser’shomedirectoryislocatedonasharedﬁlesystem,theattackerthenusestheinsertedidentitykeystoauthenticateasthatusertootherhoststhatmounttheuser’ssharedhomedirectory.Iftheattackercanwritetothesystempasswordﬁle,hecanreplaceanyoralluserpasswordswiththoseofhischoosing.crackingalgorithmshasalsoimprovedandthespeedofcomputersusedtocrackpasswordshasfollowedtheexpontentialgrowthofMoore’slaw.