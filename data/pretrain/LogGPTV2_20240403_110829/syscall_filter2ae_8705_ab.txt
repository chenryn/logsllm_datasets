è¯¥ç»“æž„ä½“ä¸­ä¼šåŒ…å«æ‰€æœ‰çš„åŽŸç”Ÿå‡½æ•°ï¼Œä¹Ÿå³å§”æ‰˜çš„ç­¾åï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¹‹åŽçš„syscallä¸­ä½¿ç”¨å®ƒä»¬äº†ã€‚
åœ¨å®šä¹‰å§”æ‰˜ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹NtCreateFileåœ¨Cä¸­çš„è¯­æ³•ã€‚
    __kernel_entry NTSTATUS NtCreateFile(
      OUT PHANDLE           FileHandle,
      IN ACCESS_MASK        DesiredAccess,
      IN POBJECT_ATTRIBUTES ObjectAttributes,
      OUT PIO_STATUS_BLOCK  IoStatusBlock,
      IN PLARGE_INTEGER     AllocationSize,
      IN ULONG              FileAttributes,
      IN ULONG              ShareAccess,
      IN ULONG              CreateDisposition,
      IN ULONG              CreateOptions,
      IN PVOID              EaBuffer,
      IN ULONG              EaLength
    );
åœ¨ä¸Šé¢çš„è¯­æ³•ç»“æž„ä¸­ï¼Œæœ‰ä¸€äº›å†…å®¹æ˜¯æˆ‘ä»¬ä¹‹å‰æ²¡çœ‹åˆ°è¿‡çš„ã€‚
é¦–å…ˆï¼ŒNtCreateFileå‡½æ•°çš„è¿”å›žç±»åž‹ä¸º[NTSTATUS](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55)ï¼Œè¯¥ç»“æž„ä½“ä¸­åŒ…å«äº†ä»£è¡¨æ¯ä¸ªæ¶ˆæ¯æ ‡è¯†ç¬¦çš„æ— ç¬¦å·32ä½æ•´æ•°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥å‡½æ•°ä¸­çš„éƒ¨åˆ†å‚æ•°æŽ¥å—çš„æ˜¯ä¸€ç»„ä¸åŒçš„æ ‡å¿—æˆ–è€…ç»“æž„ï¼Œæ¯”å¦‚è¯´[ACCESS_MASK](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/7a53f60e-e730-4dfe-bbe9-b21b62eb790b)æ ‡å¿—ï¼Œ[OBJECT__ATTRIBUTES](https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes)ç»“æž„ä»¥åŠ[IO_STATUS_BLOCK](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_io_status_block)ç»“æž„ã€‚
å¦‚æžœå†æŸ¥çœ‹ä¸€ä¸‹å…¶ä»–å‚æ•°çš„å®šä¹‰ï¼Œæ¯”å¦‚è¯´`FileAttributes`è¿˜æœ‰`CreateOptions`ï¼Œæˆ‘ä»¬ä¼šå‘çŽ°è¿™äº›å‚æ•°æŽ¥å—çš„ä¹Ÿæ˜¯ç‰¹å®šçš„æ ‡å¿—ã€‚
æ‰€ä»¥å¦‚æžœæƒ³è¦åœ¨C#ä¸­ä½¿ç”¨éžæ‰˜ç®¡ä»£ç ï¼Œå°±å­˜åœ¨ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ **æ‰‹åŠ¨**
åˆ›å»ºè¿™äº›æ ‡å¿—çš„æžšä¸¾ç±»åž‹ä»¥åŠç»“æž„ï¼Œè®©å…¶ä¸Žä¸Šè¿°Windowså®šä¹‰çš„å€¼ç›¸åŒã€‚å¦åˆ™ï¼Œå¦‚æžœæˆ‘ä»¬ä¼ é€’åˆ°syscallçš„å‚æ•°ä¸Žå®šä¹‰ä¸ç¬¦ï¼Œå°±ä¼šå¯¼è‡´syscallä¸­æ–­æˆ–è€…è¿”å›žé”™è¯¯ä¿¡æ¯ã€‚
å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œ[P/Invoke
wiki](https://www.pinvoke.net/)ä¸­åŒ…å«ç›¸å…³ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡ŒæŸ¥æ‰¾å¦‚ä½•å®žçŽ°åŽŸç”Ÿçš„å‡½æ•°ï¼Œç»“æž„ä½“ä»¥åŠæ ‡å¿—ã€‚
ä½ ä¹Ÿå¯ä»¥åœ¨Microsoftçš„[Reference
Source](https://referencesource.microsoft.com/)ä¸Šæœç´¢éœ€è¦çš„ç‰¹å®šç»“æž„ä»¥åŠæ ‡å¿—ä¿¡æ¯ã€‚è¿™é‡Œçš„å†…å®¹åº”è¯¥æ¯”P/Invokeä¸­çš„å†…å®¹æ›´æŽ¥è¿‘åŽŸå§‹çš„Windowså‚è€ƒæ‰‹å†Œã€‚
ä¸‹åˆ—é“¾æŽ¥æœ‰åŠ©äºŽæˆ‘ä»¬å®žçŽ°NtCreateFileå‡½æ•°ä¸­æ‰€éœ€çš„å¿…è¦ç»“æž„ä»¥åŠæ ‡å¿—ï¼š
  * [NTSTATUS](https://www.pinvoke.net/default.aspx/Enums/NtStatus.html)
  * [ACCESS_MASK](https://www.pinvoke.net/default.aspx/Enums.ACCESS_MASK)
  * [OBJECT_ATTRIBUTES & IO_STATUS_BLOCK](https://www.pinvoke.net/default.aspx/ntdll.ntcreatefile)
  * [FileAttributes, ShareAccess & CreateDisposition](https://www.pinvoke.net/default.aspx/kernel32.CreateFile)
ç”±äºŽè¿™äº›å€¼ï¼Œç»“æž„å’Œæ ‡å¿—å¯¹äºŽWindowsæ¥è¯´éƒ½æ˜¯â€œåŽŸç”Ÿâ€çš„ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬æ·»åŠ åˆ°`Native.cs`æ–‡ä»¶ä¸‹çš„`Native`ç±»ä¸­ã€‚
æ‰€æœ‰å†…å®¹æ·»åŠ å®Œæ¯•åŽï¼Œä¸‹å›¾æ˜¾ç¤ºäº†`Native.cs`æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹ï¼š
æ³¨æ„ï¼Œä¸Šå›¾åªæ˜¾ç¤ºäº†ä¸€éƒ¨åˆ†å·²ç»å®žçŽ°çš„åŽŸç”Ÿç»“æž„ä¸Žæ ‡å¿—ã€‚å¦‚æžœè¦é˜…è¯»å®Œæ•´å†…å®¹ï¼Œè¯·æŸ¥çœ‹æˆ‘çš„GitHubä¸ŠSharpCallé¡¹ç›®ä¸­çš„[Native.cs](https://github.com/jhalon/SharpCall/blob/master/Native.cs)æ–‡ä»¶ã€‚
æ­¤å¤–ï¼Œæ³¨æ„åˆ°åœ¨æ¯ä¸ªç»“æž„ä»¥åŠæ ‡å¿—æžšä¸¾å™¨ä¹‹å‰æˆ‘ä»¬éƒ½æ·»åŠ äº†[public](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/public)å…³é”®å­—ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½ä»Žç¨‹åºçš„å…¶ä»–æ–‡ä»¶ä¸­è®¿é—®è¿™äº›å†…å®¹äº†ã€‚
å®žçŽ°ä»¥ä¸Šå†…å®¹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠNtCreateFileä¸­C++å½¢å¼çš„æ•°æ®ç±»åž‹è½¬æ¢ä¸ºC#å½¢å¼çš„æ•°æ®ç±»åž‹ã€‚è½¬æ¢åŽï¼Œè¯¥å‡½æ•°åœ¨C#ä¸­çš„è¯­æ³•åº”è¯¥ä¸ºï¼š
    NTSTATUS NtCreateFile(
      out Microsoft.Win32.SafeHandles.SafeFileHandle FileHadle,
      FileAccess DesiredAcces,
      ref OBJECT_ATTRIBUTES ObjectAttributes,
      ref IO_STATUS_BLOCK IoStatusBlock,
      ref long AllocationSize,
      FileAttributes FileAttributes,
      FileShare ShareAccess,
      CreationDisposition CreateDisposition,
      CreateOption CreateOptions,
      IntPtr EaBuffer,
      uint EaLength
    );
åœ¨æŒ‰ç…§è¯¥ç»“æž„å®šä¹‰ä¸€ä¸ªå§”æ‰˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€è¦ä»‹ç»ä¸€ä¸‹ä¸Šé¢çš„éƒ¨åˆ†æ•°æ®ç±»åž‹ã€‚
ä¹‹å‰è¯´è¿‡ï¼ŒC++ä¸­çš„æŒ‡é’ˆæˆ–å¥æŸ„åœ¨C#ä¸­ä¸€èˆ¬éƒ½å¯ä»¥è½¬æ¢ä¸º[IntPtr](https://docs.microsoft.com/en-us/dotnet/api/system.intptr?view=netframework-4.8)ï¼Œä½†åœ¨æ­¤ä¾‹ä¸­ï¼Œæˆ‘æŠŠPHANDLEï¼ˆæŒ‡å‘[å¥æŸ„](https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types#handle)çš„æŒ‡é’ˆï¼‰è½¬æ¢æˆäº†[SafeFileHandle](https://docs.microsoft.com/en-us/dotnet/api/microsoft.win32.safehandles.safefilehandle?view=netframework-4.8)ç±»åž‹ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšæ˜¯å› ä¸ºåœ¨C#ä¸­
**SafeFileHandle** ä»£è¡¨äº†ä¸€ä¸ªæ–‡ä»¶å¥æŸ„çš„åŒ…è£…ç±»ã€‚
å› ä¸ºæˆ‘ä»¬éœ€è¦åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶ä¸”ä¼šé€šè¿‡å§”æ‰˜æŠŠæ•°æ®ä»Žæ‰˜ç®¡ä»£ç ä¼ é€’åˆ°éžæ‰˜ç®¡ä»£ç ï¼ˆæˆ–è€…åå‘ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç¡®ä¿C#å¯ä»¥å¤„ç†å¹¶ç†è§£å®ƒè¦marshalingçš„æ•°æ®ç±»åž‹ï¼Œå¦åˆ™å¯èƒ½ä¼šæŠ¥é”™ã€‚
å…¶ä½™çš„æ•°æ®ç±»åž‹åº”è¯¥å¾ˆç®€å•ï¼Œå› ä¸º`FileAttributes`ï¼Œ`FileShare`è¿™äº›ç±»åž‹ä»£è¡¨çš„å°±æ˜¯æˆ‘ä»¬æ·»åŠ åˆ°`Native`ç±»ä¸­çš„ç»“æž„ä»¥åŠæ ‡å¿—æžšä¸¾å™¨ä¸­çš„å˜é‡å’Œå€¼ã€‚æ¯æ¬¡æŠŠæ•°æ®ä¼ é€’ç»™è¿™äº›å‚æ•°ï¼ˆæ— è®ºæ˜¯å€¼è¿˜æ˜¯æè¿°ç¬¦ï¼‰æ—¶ï¼Œéƒ½éœ€è¦ä¸Žç‰¹å®šçš„ç»“æž„æˆ–æ˜¯æ ‡å¿—æžšä¸¾å™¨ç›¸å¯¹åº”ã€‚
ä½ å¯èƒ½ä¹Ÿæ³¨æ„åˆ°ï¼Œæˆ‘åœ¨ä¸€äº›å‚æ•°ä¸­æ·»åŠ äº†[ref](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/ref)å’Œ[out](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/out-parameter-modifier)å…³é”®å­—ã€‚è¿™ä¸¤ä¸ªå…³é”®å­—è¡¨æ˜Žå‚æ•°æ˜¯é€šè¿‡å¼•ç”¨è€Œä¸æ˜¯å€¼ä¼ é€’ã€‚
**ref** å’Œ **out** ä¹‹é—´çš„åŒºåˆ«åœ¨äºŽï¼Œ **ref** å…³é”®å­—è¡¨ç¤ºå‚æ•°åœ¨ä¼ é€’ä¹‹å‰å¿…é¡»å…ˆå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œ **out**
åˆ™ä¸éœ€è¦ã€‚å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œ **ref** å…³é”®å­—è¡¨ç¤ºæ•°æ®å¯ä»¥åŒå‘ä¼ é€’ï¼Œå¹¶ä¸”å½“æŽ§åˆ¶æƒè¿”å›žåˆ°è°ƒç”¨æ–¹æ³•æ—¶ï¼Œåœ¨è¢«è°ƒç”¨æ–¹æ³•ä¸­å¯¹å‚æ•°çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šåæ˜ åˆ°å¯¹åº”çš„å˜é‡ä¸­ã€‚è€Œ
**out** å…³é”®å­—è¡¨ç¤ºæ•°æ®ä»…åœ¨å•å‘ä¼ é€’ï¼Œå¹¶ä¸”æ— è®ºè°ƒç”¨æ–¹æ³•è¿”å›žçš„å€¼æ˜¯ä»€ä¹ˆï¼Œæœ€åŽéƒ½ä¼šè¢«è®¾ç½®æˆè¯¥å¼•ç”¨å˜é‡ã€‚
æ‰€ä»¥åœ¨NtCreateFileå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¸º`FileHandle`æ·»åŠ äº† **out** å…³é”®å­—ï¼Œå› ä¸ºå¦‚æžœå‡½æ•°æ‰§è¡Œ **æˆåŠŸ** ï¼Œè¯¥å‚æ•°ä¼šæ˜¯ä¸€ä¸ªæŒ‡å‘ç”¨äºŽ
**æŽ¥æ”¶** æ–‡ä»¶å¥æŸ„çš„å˜é‡çš„æŒ‡é’ˆã€‚è¿™å°±è¡¨ç¤ºæ•°æ®åªä¼šè¢«â€œä¼ å›žâ€ç»™æˆ‘ä»¬ã€‚
æŽ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŠŠç¬¦åˆC#è¯­æ³•çš„NtCreateFileå‡½æ•°æ·»åŠ åˆ°`Syscalls`ç±»ä¸­çš„`Delegates`ç»“æž„ä¸­äº†ã€‚
å®ŒæˆåŽï¼ŒSyscallsç±»åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚
**æ³¨æ„** ï¼šæˆ‘åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ äº†`using static
SharpCall.Native`ã€‚å®ƒå‘Šè¯‰äº†C#ä½¿ç”¨å«åš`Native`çš„é™æ€ç±»ã€‚ä¹‹å‰å·²ç»è§£é‡Šè¿‡äº†ï¼Œè¿™ä¹ˆåšå°±å¯ä»¥ç›´æŽ¥ä½¿ç”¨åŽŸç”Ÿçš„å‡½æ•°ï¼Œç»“æž„ä»¥åŠæ ‡å¿—ï¼Œè€Œä¸éœ€è¦æ·»åŠ ç±»åçš„é™å®šäº†ã€‚
åœ¨ç»§ç»­ä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œè¿˜è¦æ³¨æ„åˆ°åœ¨Delegatesç»“æž„ä¸­ï¼Œåœ¨è®¾ç½®NtCreateFileçš„å§”æ‰˜ç±»åž‹ä¹‹å‰ï¼Œæˆ‘è¿˜è°ƒç”¨äº†[UnmanagedFunctionPointer](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.unmanagedfunctionpointerattribute?view=netframework-4.8)å±žæ€§ã€‚è¯¥å±žæ€§ä¼šæŽ§åˆ¶å§”æ‰˜çš„ç­¾åçš„marshalingè¡Œä¸ºï¼Œåœ¨ä¼ å…¥æˆ–ä¼ å‡ºéžæ‰˜ç®¡ä»£ç æ—¶ï¼Œä¸Žéžæ‰˜ç®¡å‡½æ•°æŒ‡é’ˆç±»åž‹è¿›è¡Œè½¬æ¢ã€‚
è¯¥å±žæ€§çš„æ·»åŠ ååˆ†å…³é”®ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šä½¿ç”¨ä¸å®‰å…¨ä»£ç æŠŠéžæ‰˜ç®¡æŒ‡é’ˆç±»åž‹ä»Žsyscallæ±‡ç¼–ä»£ç marshalåˆ°ä¸Šè¿°å‡½æ•°å§”æ‰˜ä¸­ï¼Œæ­£å¦‚ä¸Šä¸€ç¯‡æ–‡ç« æ‰€è¿°ã€‚
å¤ªå¥½äº†ï¼Œæˆ‘ä»¬å·²ç»å–å¾—äº†ä¸€äº›è¿›å±•ï¼Œå®šä¹‰äº†ç»“æž„ï¼Œæ ‡å¿—æžšä¸¾å™¨ä»¥åŠå‡½æ•°å§”æ‰˜ï¼ŒçŽ°åœ¨æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å®žçŽ°è¯¥å§”æ‰˜ï¼Œä»Žè€Œå¤„ç†ä¼ é€’ç»™è¯¥å§”æ‰˜çš„ä»»ä½•å‚æ•°ã€‚è¿™äº›å‚æ•°ä¼šå…ˆè¢«åˆå§‹åŒ–ï¼Œç„¶åŽç”±syscallæ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†ã€‚
å…ˆåˆ›å»ºï¼Œæˆ–è€…è¯´å®žä¾‹åŒ–æˆ‘ä»¬çš„NtCreateFileå‡½æ•°å§”æ‰˜ã€‚è¿™éƒ¨åˆ†å†…å®¹å¯ä»¥ç›´æŽ¥æ·»åŠ åœ¨åœ¨syscallæ±‡ç¼–ä»£ç ä¹‹åŽã€‚
åˆ›å»ºå®ŒæˆåŽï¼Œ`Syscalls.cs`æ–‡ä»¶åº”å¦‚ä¸‹æ‰€ç¤ºã€‚
å®žä¾‹åŒ–å§”æ‰˜åŽçš„`TODO`æ³¨é‡Šéƒ¨åˆ†ï¼Œä¼šç”¨æ¥æ·»åŠ å¯¹ä¼ é€’äºŽæ‰˜ç®¡ä¸Žéžæ‰˜ç®¡ä»£ç ä¹‹é—´çš„æ•°æ®è¿›è¡Œå¤„ç†çš„ä»£ç ã€‚
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è§£é‡Šäº†[Marshal.GetDelegateForFunctionPointer](https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.getdelegateforfunctionpointer?view=netframework-4.8#System_Runtime_InteropServices_Marshal_GetDelegateForFunctionPointer_System_IntPtr_System_Type_)å…è®¸æˆ‘ä»¬å°†éžæ‰˜ç®¡å‡½æ•°æŒ‡é’ˆè½¬æ¢ä¸ºæŒ‡å®šç±»åž‹çš„å§”æ‰˜ã€‚
å¦‚æžœåœ¨[unsafe](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/unsafe)çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œæˆ‘ä»¬å°±èƒ½åˆ›å»ºä¸€ä¸ªæŒ‡å‘shellcodeæ‰€åœ¨å†…å­˜ä½ç½®çš„æŒ‡é’ˆï¼ˆå³syscallæ±‡ç¼–ä»£ç ï¼‰ï¼Œå¹¶ä½¿ç”¨å§”æ‰˜åœ¨æ‰˜ç®¡ä»£ç ä¸­æ‰§è¡Œè¯¥æ±‡ç¼–ä»£ç ã€‚
æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œæ‰§è¡ŒåŒæ ·çš„æ“ä½œã€‚å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„åä¸º`syscall`çš„[å­—èŠ‚æ•°ç»„](https://docs.microsoft.com/en-us/dotnet/api/system.byte?view=netframework-4.8)ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º`bNtCreateFile`æ±‡ç¼–ä»£ç çš„å†…å®¹ã€‚
å®ŒæˆåŽï¼Œè®¾ç½® **unsafe** ä¸Šä¸‹æ–‡å¹¶åœ¨å¤§æ‹¬å·ä¸­æ·»åŠ ä¸å®‰å…¨çš„ä»£ç ã€‚
æ›´æ–°å®ŒæˆåŽçš„`Syscalls.cs`æ–‡ä»¶åº”å¦‚ä¸‹æ‰€ç¤ºã€‚
æˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿè§£é‡Šè¿‡ï¼Œåœ¨è¯¥ä¸å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„åä¸º`ptr`çš„å­—èŠ‚æŒ‡é’ˆï¼Œå°†å…¶è®¾ç½®ä¸º`syscall`çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æ±‡ç¼–ä»£ç çš„å­—èŠ‚æ•°ç»„ã€‚
ä¹‹åŽï¼Œå¦‚å‰æ–‡æ‰€è¿°ï¼Œæˆ‘ä»¬ä¸ºæŒ‡é’ˆæ·»åŠ äº†[fixed](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/fixed-statement)è¯­å¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é˜²æ­¢åžƒåœ¾å›žæ”¶å™¨åœ¨å†…å­˜ä¸­å¯¹syscallå­—èŠ‚æ•°ç»„è¿›è¡Œé‡æ–°å®šä½ã€‚
ä¹‹åŽï¼Œæˆ‘ä»¬ä¼šç›´æŽ¥æŠŠå­—èŠ‚æ•°ç»„æŒ‡é’ˆè½¬æ¢ï¼ˆ[cast](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/types/casting-and-type-conversions)ï¼‰æˆä¸€ä¸ªå«åš`memoryAddress`çš„IntPtrã€‚ è¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´èŽ·å–åˆ°syscallå­—èŠ‚æ•°ç»„æ‰€å¤„çš„å†…å­˜åœ°å€äº†ã€‚
æ›´æ–°å®ŒæˆåŽçš„`Syscall.cs`æ–‡ä»¶åº”å¦‚ä¸‹æ‰€ç¤ºã€‚
æŽ¥ä¸‹æ¥è¦æ ¼å¤–æ³¨æ„äº†ï¼Œä¸‹é¢å°±æ˜¯å¥‡è¿¹å‘ç”Ÿçš„åœ°æ–¹ï¼ ðŸ˜‰
ç”±äºŽæˆ‘ä»¬çŽ°åœ¨å·²ç»æ‹¥æœ‰äº†ï¼ˆæˆ–å°†è¦æ‹¥æœ‰ï¼‰ç¨‹åºæ‰§è¡ŒæœŸé—´syscallæ±‡ç¼–ä»£ç æ‰€åœ¨çš„å†…å­˜åœ°å€ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸€äº›æ“ä½œä»¥ç¡®ä¿è¿™éƒ¨åˆ†ä»£ç èƒ½å¤Ÿåœ¨å…¶åˆ†é…çš„å†…å­˜åŒºåŸŸå†…å¾—åˆ°æ­£ç¡®çš„æ‰§è¡Œã€‚
å¦‚æžœä½ ç†Ÿæ‚‰exploitå¼€å‘æœŸé—´shellcodeçš„å·¥ä½œåŽŸç†â€”â€”æ¯å½“æˆ‘ä»¬æƒ³è¦åœ¨ç›®æ ‡è¿›ç¨‹æˆ–ç›®æ ‡å†…å­˜é¡µä¸­å†™å…¥ï¼Œè¯»å–æˆ–è€…æ‰§è¡Œshellcodeçš„æ—¶å€™ï¼Œé¦–å…ˆè¦ç¡®ä¿è¿™éƒ¨åˆ†å†…å­˜åŒºåŸŸå…·æœ‰ç›¸åº”çš„è®¿é—®æƒé™ã€‚
å¦‚æžœä½ å¯¹æ­¤è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·é˜…è¯»æœ‰å…³Windowså®‰å…¨æ¨¡åž‹å¯¹[è¿›ç¨‹å®‰å…¨åŠè®¿é—®æƒé™](//docs.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights))è¿›è¡ŒæŽ§åˆ¶çš„å†…å®¹ã€‚
æ¯”å¦‚è¯´ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ **NtCreateFile** å‡½æ•°åœ¨è®°äº‹æœ¬ä¸­æ‰§è¡Œæ—¶å…·æœ‰æ€Žæ ·çš„å†…å­˜ä¿æŠ¤ã€‚
    0:000> x ntdll!NtCreateFile
    00007ffb`f6b9cb50 ntdll!NtCreateFile (NtCreateFile)
    0:000> !address 00007ffb`f6b9cb50
    Usage:                  Image
    Base Address:           00007ffb`f6b01000
    End Address:            00007ffb`f6c18000
    Region Size:            00000000`00117000 (   1.090 MB)