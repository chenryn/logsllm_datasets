原文：[《A Sheep in Wolf’s Clothing – Finding RCE in HP’s Printer
Fleet》](https://foxglovesecurity.com/2017/11/20/a-sheep-in-wolfs-clothing-finding-rce-in-hps-printer-fleet/ "《A Sheep in Wolf’s Clothing – Finding RCE
in HP’s Printer Fleet》")  
作者：breenmachine@foxglovesecurity  
译者：Serene@知道创宇404实验室
非技术人员热衷于销售产品或服务的技术特性，但有时候市场营销做得有些过头了，需要有所控制。如果这条规律被打乱了，那么就会导致市场的FUD（Fear
Uncertainty and Doubt）：
上面这段宣传视频《The
Wolf》中处处表明惠普打印机是安全的，而购买非惠普的打印机则是接近于疏忽犯罪。比如，在开场黑底白字上写着“世界上有数以亿计的商业打印机，只有不到2％是安全的”，从这里开始，视频中的“狼”执行了一系列不太可能的攻击，利用不安全的打印机以获取公司网络和敏感数据，显而易见是指惠普打印机不会受到这些攻击。
尽管有[“Printer Hacking Wiki”](http://hacking-printers.net/wiki/index.php/Main_Page)和相关的[PRET](https://github.com/RUB-NDS/PRET)工具包这样非常好的资源，但似乎没有人深入研究过现代惠普商业打印机的安全性以验证惠普的安全声明。
于是我们购买了几台打印机，[MFP-586](http://store.hp.com/us/en/pdp/hp-pagewide-enterprise-color-mfp-586dn) 和 [M553](http://store.hp.com/us/en/pdp/hp-color-laserjet-enterprise-m553n)，正如惠普视频中“狼”说的，“要开始捕猎了”。
本文中讲到的RCE漏洞在2017年8月21日报告给了惠普，惠普已经修复并发布了安全公告：，本文涉及的所有代码我们都放在Github上：
#### 一、打印机攻击向量
在上面的视频及其续集中，“狼”执行了一系列不太可能的攻击。这些攻击是毫无道理且极其不切实际的，让我们暂且忽略这些事实，来看看下面相关的打印机安全问题：
  * 打印作业安全：打印作业安全主要通过两种方式暴露出来，一个是打印机托盘中已完成的文件，会被路过的人取走；或者是在一些打印机上，攻击者可以通过网络提取或拦截打印作业。
  * 未签名的代码执行：打印机通常会免除多种类型的监测，如果攻击者能在打印机上运行恶意软件，那么它不仅能不受限制地访问打印作业，并且还不太可能被发现，成为攻击者安全的避风港。
接下来，以上面2点攻击向量为主，我们将重点介绍一系列在现代惠普打印机上测试过的安全问题。
#### 二、测试常见的打印机漏洞
我们首先回顾了打印机中现有的安全空间，过程中我们发现了“打印机开发工具包”——PRET。这个工具包包含了许多预定义的攻击方法，可以针对不同制造商的打印机。它更多的是为常见攻击提供了模板，而不是针对某个特定打印机的特定漏洞。因此我们需要做些调查，看惠普打印机可能会受到哪些漏洞的影响。
以下问题是在PRET工具包中发现的：
##### 目录穿越 - 远程存储的打印作业泄漏
PRET工具包有三种模式，每种模式都指定工具包将尝试与打印机通信的“语言”。模式分别是Printer Job Language
(PJL)、PostScript
(PS)和PCL。每种模式都有一组不同的常见漏洞，和一些常见的问题。PJL是计算机允许打印作业时与打印机通信的语言，这种语言也被扩展为具有执行一些管理任务的能力。PJL的一项功能是对打印机上文件进行非常有限的管理，例如可以存储和删除文件，但只能在特定的位置，这是使用PJL语言在文件系统上不能逃离的一个小“监狱”。
从上面截图看到我们列举在目录“/”中的文件时，根目录中，我们只能看到“PostScript”目录。
在这里一个常见的漏洞是“目录穿越”，它涉及请求特别操作的文件和目录名称试图逃离这个“监狱”。我们在两台惠普打印机上找到了一条目录穿越序列，如下所示：
不幸的是，无法从这一点检索文件内容或编写任何文件，任何尝试都会导致打印机崩溃并重新启动。
经过进一步调查，我们发现只能在一个特定路径下检索文件内容，并且目录穿越序列略有修改：
这里的“Jobs”目录是存储打印作业的地方，通过PRET有可能检索存储在打印机上任何作业的内容，如下所示：
针对“受PIN保护的”作业和不安全的作业进行测试，结果相同，这让打印作业受保护这项安全功能变得没有那么诱人了。
##### PostScript作业操作
某些类型的打印作业可以在打印之前自动处理。例如，网络上任何人都可以将任意图像和字体放置在所有打印作业的页面上，如下所示，水印“FOO”并不属于要打印的原始文档：
##### 不安全的出厂重置功能
PRET工具包似乎包含了两个没有记录或者至少说不明显的方法，可将惠普打印机重置为出厂默认设置，从而将“Administrator”密码重设为默认无密码。通过PJL接口和SNMP可以实现这一点，即使设备上已经设置了管理密码，在默认情况下它们都是不安全的。
除此之外，即使在PJL和SNMP接口已被管理员保护的情况下，也有可能将SNMP社区字符串重置为“public”的默认值！这可以利用一个鲜为人知但惠普默认启用的功能下实现，这个功能允许打印机在启动时通过DHCP或BOOTP服务器重新配置。
每次打印机启动，当从DHCP服务器获得IP地址时，它也会在DHCP响应中查找一些特殊的配置选项。其中一个选项指定了一个TFTP服务器，打印机可以检索应用各种配置设置的配置文件。在这些设备的详细说明手册中，惠普正确指出了，任何手动配置设置优先于DHCP配置的设置。然而，在DHCP配置中有些选项允许清除手动配置的设置，包括以下内容：
  * 安全复位：将打印服务器上的安全设置重置为出厂默认值。
  * 冷复位：冷复位后重置为TCP/IP出厂默认设置。
启用这些选项的DHCP服务器配置文件将与[项目代码](https://github.com/foxglovesec/HPwn)一起发布在GitHub上。
#### 三、不安全的默认设置
受到前面测试结果的启发，我们想看是否能找到可以应用到打印机上的安全设置组合，以阻止上述攻击。具体来说，是找到管理员应该做些什么才能让任何用户都无法重置“Administrator”密码。
我们发现这是有可能实现的，但是现实环境中的管理员不太可能成功锁定这些打印机的管理界面，至少他们需要从默认值中更改以下设置，并且注意，这里没有向用户表明，这些设置与安全性有关联。我们将展示管理菜单中的完整路径，以演示打印机中这些设置藏得有多深：
  * 必须在设备的管理Web界面上设置密码，这是IT中的常见做法，也是唯一可能应用于现实世界的设置。
  * 在`Networking > Security > Mgmt. Protocols > SNMP`的`Set Community Name`需要由默认改为`public`。
  * 在`Security > PJL Security > Password`下，必须设置新密码
  * 以下设置必须禁用`Networking > Other Settings > Misc Settings > Enabled Features > TFTP Configuration File`
如果上述任何一项被忽略了，网络上的攻击者就有可能重置设备并因此获得管理访问权限。
#### 四、深入挖掘：提取操作系统和固件
我们花费了几千美元购买打印机，在找到RCE漏洞前都不会停止研究。第一步是掌握在打印机上实际运行的代码，看起来惠普采取了一些措施来防止用户从打印机中提取操作系统和固件，不过我们可以绕过这些限制。
首先，惠普送来的设备同时包含了符合FIPS标准的加密硬盘驱动器，当插入这其中一个特殊的驱动器时，驱动器上的所有数据都将被加密，如果移除该驱动器，那么没有加密密钥的话任何人都将无法读取数据。另外，即使我们能够设置或恢复这个密钥，正在使用的加密细节也不清楚，并且需要在从驱动器读取数据之前发现。
相反，我们只是删除了HP提供的支持FIPS的驱动器，并插入了不支持加密的常规东芝笔记本电脑硬盘驱动器：
重新启动设备后，我们可以让打印机将操作系统和固件从USB密钥安装到新的未加密的驱动器上：
关闭打印机，取出驱动器，就可以将驱动器上的许多文件读取到一个标准PC上。不过，一些更有趣的文件仍然难以捕捉，特别是在“/Windows/”和“/Core/bin”目录下的HP
DLL文件，我们知道这些文件存在，因为可以利用我们的目录穿越漏洞在PRET中看到它们：
不幸的是，驱动器插入PC后，我们没有找到这些目录。经过大量调查后，我们应用了两种不同的方法从这两个来源检索文件。
##### 检索/Windows/
首先是Windows目录，Linux实用程序“grep”用于对Windows目录中存在的各种文件的引用进行搜索：
文件“NK.bin”似乎每次都会返回，经过一番调查后，发现打印机上运行的操作系统是Windows CE的一个版本，Windows
CE内核存储在/CEKERNEL/NK.bin。我们可以用公开的工具Nkbintools来提取这个Windows
CE内核的内容，并检索Windows目录的确切内容：
##### 检索/Core/bin
目录/Core/bin的内容更难以检索，当硬盘连接到PC时，/Core/bin目录实际上是可见的，然而与/Windows/目录不同，它是空的：