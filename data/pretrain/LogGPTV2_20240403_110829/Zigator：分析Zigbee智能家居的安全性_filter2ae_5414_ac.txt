捕获了从十个商用Zigbee设备生成的数据包，如上图所示。在一半的实验中，使用第三代SmartThings集线器（IM6001-V3P01）作为Zigbee协调器，而第二代SmartThings集线器（STH-ETH-200）用于另一半（分别见图j和i）。需要注意的是，只有前者可以使用其安装代码来调试Zigbee
3.0设备。后者使用默认的“信任中心”链接密钥来调试它们。使用的Zigbee
3.0设备是SmartThings插座（IM6001-OTP01），SmartThings运动传感器（IM6001-MTP01），SmartThings智能灯泡和Schlage
Connect Smart Deadbolt（分别见图h，c，d和a）。其余设备是旧Zigbee设备，它们在调试过程中使用默认的Trust
Center链接密钥。特别是，使用的传统Zigbee设备是Centralite 3系列智能插座，SmartThings运动传感器（F-IRM-US-2），SmartThings多功能传感器（F-MLT-US-2） ，以及Yale确保锁定触摸屏锁舌（分别见图g，b，e和f）。
为了研究NWK命令的代表性示例进行了八个实验，将其代号为H-T，其中H∈{sth2，sth3}和T∈{room，duos，house，trios}。使用H
= sth2指代使用STH-ETH-200集线器的实验，而使用H = sth3指代使用IM6001-V3P01集线器的实验。使用T =
room来指将设备放置在单个房间中的实验，而T = duos指的是Zigbee网络一次仅包含一个集线器和一个其他设备的实验。此外，T =
house是指将设备放置在三个不同房间中的实验。最后，T =
trios是指Zigbee网络一次仅由一个集线器，一个Zigbee路由器和一个其他设备组成的实验。例如，sth3室对应于使用IM6001-V3P01集线器并将所有设备都放置在单个室中的实验。
在每个实验开始之前，对设备进行了出厂重置。接下来使用SmartThings智能手机应用程序注册了中心，以初始化Zigbee网络。请注意，这两个集线器的默认配置是禁用Zigbee设备的自动固件更新，而只有STH-ETH-200集线器接受不安全的重新加入请求。USRP N210在所选通道上连续捕获IEEE
802.15.4数据包。为了收集各种各样的NWK命令，在每个实验中执行了多项操作，包括将设备添加到网络，触发传感器，向执行器发出命令，重新关联设备，关闭设备电源以及引起PAN
ID冲突。将这些动作组合起来，形成了八个实验中通用的程序。程序的详细说明包含在数据集中。下表显示了在整个实验中捕获的不同数据包类型的数量，这些数据包总共持续了约34.644小时。
## 0x07 Result
在本节中演示集中式Zigbee网络中禁用的MAC层安全性的后果。首先表明可以从可操作的Zigbee网络中推断出有价值的信息，然后将其用于开发决策树以识别加密的NWK命令。最后发起选择性的干扰和欺骗攻击，迫使最终用户将其设备之一恢复出厂设置，并最终暴露出网络密钥。
###  （1）侦察攻击
攻击者可以通过记录MAC报头中不同的源地址和目标地址对来推断附近Zigbee网络的拓扑。例如，在sth2房屋实验期间，通过观察PAN
ID为0xd9b1的MAC数据包的寻址字段来生成上图。识别Zigbee协调器是微不足道的，因为它始终使用0x0000作为其简短的广告位，仅拓扑结构不足以绝对确定地确定所有设备的逻辑设备类型。
**主动识别逻辑设备类型：**
可以利用只有Zigbee路由器和Zigbee协调器响应信标请求这一事实来识别Zigbee路由器。通过注入信标请求，然后观察哪些设备响应了信标，攻击者可以识别出通信范围内的所有Zigbee路由器。回想一下Zigbee设备在MAC层上没有利用任何安全服务，这意味着攻击者可以欺骗上表中所示的任何MAC命令。要验证无响应的设备确实是Zigbee终端设备，攻击者可以欺骗孤立通知潜在的Zigbee终端设备，以便如果确实是Zigbee终端设备，则其父设备将以协调器重新排列响应。使用测试平台验证了这两种攻击，而没有观察到对网络正常运行的任何副作用。请注意，在实验过程中，即使仅旧版Zigbee终端设备发送了孤立通知，所有Zigbee路由器和Zigbee协调器都响应了协调器重新调整，无论假定的孤立设备是旧版设备还是Zigbee
3.0设备。
**匹配短地址和扩展地址：**
虽然攻击者不必假冒其他设备来注入有效的信标请求，但攻击者需要该设备的扩展地址才能成功欺骗孤立通知。但是，攻击者可以通过被动检查Zigbee流量来获取此信息。
NWK标头的寻址字段与MAC报头的寻址字段（其中短地址，扩展地址或不使用地址用于数据包的源字段和目标字段）不同。总是包含两个短地址，并且它们还可能包含相应的扩展地址。实际上，每个NWK命令都必须包括其源的扩展地址。当目标地址的扩展地址已知且未广播NWK命令时，也将包括该地址。另外，每个利用NWK层安全服务的数据包都要求在辅助报头中包含发送方的扩展地址，它将与MAC标头中源的短地址匹配。由于在Zigbee网络上禁用了MAC层安全性，因此所有这些标头字段都是未加密传输的。因此，被动攻击者只需检查MAC数据包即可将扩展地址与短地址进行匹配，反之亦然。
**被动识别逻辑设备类型：**
正如在本小节开头所描述的那样，无需注入任何数据包就可以识别Zigbee协调器。理想情况下，攻击者希望能够被动地识别Zigbee路由器和Zigbee终端设备。这将需要观察已知仅由Zig吧bee路由器或仅由Zigbee终端设备发送（或接收）的数据包。实际上，Zigbee终端设备将定期向其父设备发送数据请求，以便轮询未决的数据包。在检查数据请求时需要注意，因为Zigbee路由器在加入网络时也会使用它们;然而，在这种情况下，数据请求的源将使用其扩展地址。
关联成功后，数据请求的源将使用其短地址来轮询未决的数据包。只要数据请求的源地址是短地址，它就会在整个实验过程中由Zigbee终端设备进行传输。请注意，由于只有Zigbee路由器和Zigbee协调器是这些数据包的接收者，因此攻击者也可以使用数据请求来被动标识Zigbee路由器。但是，为了识别没有子代的Zigbee路由器，攻击者将不得不观察仅由Zigbee路由器传输的数据包。有一些MAC命令可用于此目的，但它们不会定期发送。因此，转向NWK命令（如下表所示）。实际上，Zigbee协调器和所有Zigbee路由器都在定期发送链路状态命令。即使NWK命令标识符字段是经过典型加密的，攻击者也可以通过检查其未加密的报头字段来区分链接状态命令和其他数据包。因此，被动攻击者有可能推断每个Zigbee设备的逻辑设备类型。
**识别硬件设备：**
设备的扩展地址对应于唯一的64位IEEE地址，其中包含组织标识符。由于Zigbee联盟维护着经过认证的Zigbee产品的公开注册表，因此攻击者可能会尝试使用其组织名称作为该注册表上的搜索关键字来识别从其生成观察到流量的硬件设备。另外，智能集线器供应商通常会发布受支持设备的类似列表（例如，“与SmartThings一起使用”网页），如果可以识别出智能集线器的供应商，也可以使用这些列表。通过考虑攻击者针对该设备推断出的逻辑设备类型，可以进一步缩小可能的硬件设备列表。
例如，在实验中使用的Smart Things
Outlet（IM6001-OTP01）的扩展地址为28：6d：97：00：01：09：4b：c8，其组织标识符为0x286d97，已为其分配SAMJIN
Co.，Ltd.
。在撰写本文时，在Zigbee联盟的注册表中搜索该组织会返回五种经过认证的Zigbee产品。但是，这些产品中只有一种用作Zigbee路由器，确实与设备匹配。重要的是要注意，其他组织标识符并没有得出结论性的结果，因为它们对应于片上系统（SoC）制造商，这些制造商的产品可在多种Zigbee设备中找到。
**识别旧的Zigbee设备：** 攻击者有兴趣将旧Zigbee设备与Zigbee 3.0设备区分开，尤其是在Zigbee
3.0网络中，因为前者使用默认的Trust
Center链接密钥来加入网络，这使它们成为攻击的潜在目标，如在下面的解释中所述。假设攻击者能够识别硬件设备，则经过认证的Zigbee产品注册表将提供此信息。例如，当前由SAMJIN
Co.，Ltd.认证的所有Zigbee产品都是Zig bee 3.0设备。此外，观察到在实验中，只有Zigbee
3.0设备发送了终端设备超时请求。当发送此NWK命令时，它的父级将发送一个终端设备超时响应。
但是，这对NWK命令是在Zigbee PRO 2015规范中引入的，因此一些旧式Zigbee设备不支持该命令。攻击者可以通过引起PAN
ID冲突，使Zigbee终端设备重新加入其网络，以观察哪些发送了“终端设备超时请求”，以及哪些父母以“终端设备超时响应”进行了响应。正如在以下小节中所示，即使以加密的方式传输了它们的NWK命令标识符字段，攻击者也可以100％准确地识别这些NWK命令。
###  （2）NWK命令的标识
应该清楚的是，攻击者将从能够识别加密的NWK命令的过程中受益匪浅。尽管NWK帧类型字段始终是未加密的，但由于它是NWK标头的一部分，并且MAC层安全性已禁用，因此NWK命令标识符字段通常是加密的，因为它是NWK有效负载的一部分。因此，被动观察者可以区分NWK命令与其他数据包类型，但不能区分实际上是哪个NWK命令。
构造了下表，其中包含可用于加密NWK命令分类的四个功能的可能值集。有效负载长度和半径列的值基于Zigbee PRO
2015规范的要求。但是，该规范未明确说明所有NWK命令的NWK目标和源地址字段的可能类型。结果，这两列中的某些值是基于对规范的理解，进行的实验以及所做的假设。请注意，不同NWK命令之间的有效负载长度差异很大，而其中一半仅限于单跳传输。此外，请注意，某些NWK命令仅限于某些NWK目标和源类型。
由于MAC协议数据单元（MPDU）的长度包含在PHY标头中和影响其预期长度的所有标头字段均未加密传输（例如，是否存在NWK目标的扩展地址），攻击者可以在传输NWK命令时计算其有效载荷长度。半径字段（表示一个数据包可以执行多少跳）也未加密传输。请注意，即使多跳命令的Radius字段可以达到1的值，仍然可以通过比较MAC和NWK标头中的寻址字段来确定数据包是否已遍历网络，还是将它们与单跳命令区分开来。不。