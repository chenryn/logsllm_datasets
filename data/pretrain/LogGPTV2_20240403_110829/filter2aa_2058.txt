Malicious Encrypted Traffic Detection
HITCON CMT 2018
Aragorn 
PI:EMAIL
About Me
•
Aragorn / 
•
Master of National Taiwan university
•
Security consultant in Somewhere
•
NTUCSA  () 
•
Malware AnalysisOperating Facebook fan page
Packet ForensicPenetration Test
•
Speaker 
•
2016 TANET Network Technology Promotion Seminar -
Hacker Attack Techniques: APT Attack & Ransomware 
Introduction
1
HTTPS Encrypted Traffic
• Since the end of 2016, Google and Mozilla have released statistics, 
and more than half of their browser users have used HTTPS protocol 
encryption
https://transparencyreport.google.com/https/overview?hl=en
https://letsencrypt.org/stats/
2
HTTPS Encrypted Traffic(cont)
• In March of this year, Cisco's latest survey found that HTTPS traffic 
reached 50% in October 2017, compared with only 38% of the overall 
in November 2016, the usage rate can be said to increase significantly.
• NSS Labs predict that there will be 3/4 of the network traffic in 2019, 
and encryption will be used.
3
Malicious Encrypted Traffic
• According to Cisco's sampling, the proportion of malware that 
communicated via TLS encrypted connections was 2.21% in 2015, and 
increased to 21.44% in May 2017.
• 10-12% of all Malware uses HTTPS
• https://blogs.cisco.com/security/malwares-use-of-tls-and-encryption (Jan 2016)
• 37% of all Malware uses HTTPS
• https://blog.cyren.com/articles/over-one-third-of-malware-uses-https (June
2017)
• From all HTTPS malware, 97% uses port 443, and 87% uses TLS
• In addition to TLS, SSL encryption, and technologies such as VPN, 
I2P, and Tor encryption, network security is facing great challenges.
4
Malicious Encrypted Traffic
• Exploit kits
• using SSL/TLS-enabled advertising 
networks injects malicious scripts 
into legitimate websites
• Malware
• Adware
• Malware callbacks
5
60%
25%
12% 3%
Banking Trojan
Ransomware
Infostealer Trojan
Other
Source : ZSCALER
Malware with Encrypted Traffic
Name 
Type
Gamarue/Andromeda
Modular botnet
Sality
File infecter, modular botnet
Necurs
Information stealer, backdoor, botnet
Rerdom
Click-fraud, botnet
["Dridex", "KINS", "Shylock", "URLzone", "TorrentLocker", "CryptoWall","Upatre", "Spambot", 
"Retefe", "TeslaCrypt", "CryptoLocker", "Bebloh","Gootkit", "Geodo", "Tinba", "Gozi", 
"VMZeus", "Redyms", "Qadars", "Vawtrack","Emotet“,”Trickbot”]
6
SSL Blacklist
• https://sslbl.abuse.ch/
7
APT attack
• CVE-2017-0199 with abuses Powerpoint slide
• Remcos RAT - REMCOS uses encrypted communication, including a hardcoded 
password for its authentication and network traffic encryption
• PLEADShrouded CrossbowWaterbear
• Keyboys - HP-Socket
•  - splwew32.exe
8
How to solve the problem?
• Change the signature based to machine learning based!
9
Our project: 
Deep Learning for Malicious Flow Detection
• To recognize the potential malicious behavior based on the net flow 
aspect especially for the encrypted net flow
10
Encrypted Net Flow example: TLS
11
Dataset
• Pcaps/flows with HTTPS/VPN/Tor traffic
• Malware/VPN/Tor/Benign
• Capture with CAPE sandbox
https://github.com/ctxis/CAPE
12
Dataset
• Malware traffic analysis
•
https://www.malware-traffic-analysis.net/
• CTU-13 dataset – public
•
Malware and Normal captures
•
13 Scenarios. 600GB pcap
•
https://www.stratosphereips.org/datasets-ctu13/
• MCFP dataset – public
•
Malware Capture Facility Project
•
340 malware pcap captures
•
https://stratosphereips.org/category/dataset.html
• Trend Micro Tbrain dataset
• UNB dataset – public
•
Tor-NonTor
•
VPN-NonVPN
•
http://www.unb.ca/cic/datasets/index.html
• Own malware/Tor dataset
13
Feature Engineering
• Cisco – joy
• https://github.com/cisco/joy
• UNB – Flowmeter
• https://github.com/ISCX/CICFlowMeter
• Bro logs
• Dpkt
IP
MAC
TCP
UDP
Level2
Level3
Level4
Level5-7
HTTP DNS DHCP ……
14
Joy feature Intro
15
Packet Metadata
Feature
Type
Input/output IP
xxx. xxx. xxx. xxx
Input/output port number
Integer
Inbound/outbound bytes
Integer
Inbound/outbound packets
Integer
Total duration of the flow (ms) Integer
16
HTTP:
• Request
• http_user_agent
• http_accept_language
• Response
• http_server
• http_content_type
• http_code
17
DNS
• dns_domain_name
• dns_ttl(time to live)
• dns_num_ip
• dns_domain_rank
18
Sequence of Packet Lengths and Times 
(SPLT)
Malware Behavior
Network Behavior
Communication with command 
control server
Sequence of packet lengths
Write to the disk
Time interval between packet 
• Size and Timing of the first few packets allow us to estimate 
the type of the data inside the encrypted channel
19
SPLT
Sequence of Length
Bin size = 150 bytes
1st packet size: 
170 bytes/150 => 1
2nd packet size: 
621 bytes/150 => 4
Sequence of Time
Bin size = 50 ms
1st packet cost time: 
280 ms/50 => 5
2nd packet cost time: 
187 ms/50 => 3
20
PACKET 
LENGTH
(BYTES)
Unix 
Time(s)
Visualize with SPLT
21
22
23
24
Byte Distribution
Source : cisco
25
Visualization with Byte Distribution
Email with TLSv1.2
26
Malspam
Facebook chat
27
Locky Ransomware
Locky Ransomware
28
TLS Information
• TLS handshake info:
TLS CiphersuiteTLS extensionPublickey length
29
Source : https://arxiv.org/abs/1607.01639
30
Source : https://arxiv.org/abs/1607.01639
31
Source : https://arxiv.org/abs/1607.01639
32
CICFlowmeter Feature Intro
33
CICFlowMeter
• An open source tool 
• Generate bidirectional flows from pcap files
• Extracts features from these flows
• Supports realtime generate bidirectional flows
34
Network basic Metadata
• Flow ID
• IP
• Port
• Protocol
• Timestamp
35
Time-based feature
• Flow Duration
• bytes/s
• packets/s
• packet length
• IAT(inter-arrival time)
• Flag
• Active time
• Idle time
36
• BWDFWD(direction)Total
• MaxMinMeanStd
Bro logs
Idea from Czech technical university in Prague
37
Bro 
• Conn.log
• ssl.log
• X509.log
• dns.log
• http.log
• Files.log
• ……
Bro logs
Bro lDS
38
ssl-connect-unit
1. SSL aggregation
conn.log
2.
SSL aggregation
N.
SSL aggregation
High level features
●
Mean
●
Standard deviation
●
Weighted mean
Raw data
ssl.log
x509.log
conn.log
ssl.log
x509.log
conn.log
ssl.log
x509.log
{SrcIP, DstIP, DstPort, protocol}
{SrcIP, DstIP, DstPort, protocol}
{SrcIP, DstIP, DstPort, protocol}
ssl-connect-unit ID:
{SrcIP, DstIP, DstPort, protocol}
Connection features
●
Numbers, lists, strings
Source : https://2018.bsidesbud.com/wp-content/uploads/2018/03/seba_garcia_frantisek_strasak.pdf
39
40 Features of ssl-connect-unit
• Number of SSL aggregations 
• Mean and standard deviation of duration 
• Mean and standard deviation of number of packets 
• Mean and standard deviation of number of bytes 
• Ratio of TLS and SSL version 
• Number of different certificates
Source : https://2018.bsidesbud.com/wp-content/uploads/2018/03/seba_garcia_frantisek_strasak.pdf
40
r
d
2015.7.27
2018.7.27
2020.7.27
Ratio of validity during the capture
!
"
41
Top 7 most discriminant features
• Certificate length of validity
• Inbound and outbound packets
• Validity of certificate during the capture
• Duration 
• Number of domains in certificate (SAN DNS) 
• SSL/TLS version 
• Periodicity
Source : https://2018.bsidesbud.com/wp-content/uploads/2018/03/seba_garcia_frantisek_strasak.pdf
42
Machine Learning methods
43
Quantity Dependent Backpropagation(QDBP)
• We introduce a vector F into backpropagation (eq (1)) and propose a 
QDBP algorithm which takes the disparity between classes into 
consideration and shows different sensitivities toward different 
classes.
• !"
#$ = !"
# − '×
)*+,,
)-.
/
− (1)
• !"
#$ = !"
# − ' 3 Ϝ 3 56788 −(2)
• Ϝ =
:;
<> , … ,
:@
)-. , … ,
)*+,,@
)-. ]C
44
Tree-Shaped Deep Neural Network (TSDNN)
• To mitigate the imbalanced data issue, we propose an end-to-end 
trainable TSDNN model which classifies the data layer by layer.
45
ACCURACY AND PRECISION OF DIFFERENT APPROACHES
46
Partial flow Detection
• Our model is able to distinguish the malicious flow by only 
considering the first 5 % of the entire flow which shows the possibility 
of a realtime detection since the model can perceive the potential 
threats in the very beginning of the process without analyzing the 
entire flow.
47
Zero-shot Learning
• We collect 14 different 
kinds of malware not in 
training data to evaluate 
the ability of our model to 
perceive potential threats.
48
Multiclass Classfication
• 12 classes
• Accuracy = 99.63%
• Precision = 85.4%
49
Multiclass Classfication
• 19 classes
• Accuracy = 92.84%
• Precision = 87.32%
50
Tor-NonTor Classification
• Xgboost
• Accuracy = 98.7%
• Precision = 91.9%
51
Application Classification among Tor
Algorithm
Accuracy
Precision
Recall
F-measure
XGBoost
79.3
68.9
53.7
60.4
audio
74.4
79.1
76.7
chat
88.9
86.5
87.6
file
66.8
56.0
61.0
email
79.2
81.2
80.2
video
84.2
86.5
85.3
voip
96.6
92.7
94.6
p2p
52
Implementation on SDN
53
Demo
54
Special Thanks
• 
• Project :
• 
• HICON^_^
55
Reference
• Deciphering Malware's use of TLS (without Decryption)
https://arxiv.org/pdf/1607.01639.pdf
• Characterization of Tor Traffic using Time based Features
https://www.researchgate.net/publication/314521450_Characterizati
on_of_Tor_Traffic_using_Time_based_Features
• Detecting malware even when it is encrypted
https://2018.bsidesbud.com/wp-
content/uploads/2018/03/seba_garcia_frantisek_strasak.pdf
• Deep Learning for Malicious Flow Detection
https://arxiv.org/pdf/1802.03358.pdf
56
Thanks!
Email : PI:EMAIL
Facebook : 
57