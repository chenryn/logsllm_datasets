#### (二)代理-计费分离
对于运营商而言，代理服务器与计费检测系统是两个业务量都很庞大的系统，为了系统管理升级与日常维护，这两个系统被做成了分离的模块，并运行着不同的网络请求处理机制。当用户访问互联网时会向运营商代理服务器发送一条请求信息，这条请求信息的头部包含了目的IP、源IP、UA、网络协议、文件类型等详细信息，代理服务器与计费检测系统从请求头获取目的IP，并分别以此代理用户网络请求或判断用户流量是否需要计费。免流软件正是不正当利用了代理服务器与计费检测系统检测机制分离这一特点，通过自定义网络请求头，使二者从请求头中获取到的目的IP不一致，从而达到欺骗计费检测系统、免流上网的目的。同时，由于各运营商、各地区的计费检测系统检测机制存在差异，不同模式的免流软件具有不同的应用场景与地区限制。
###  三、原理
免流软件的本质是用户端的流量欺骗，而实现欺骗的基本原理就是修改设备上发起的网络请求，用伪造的请求头欺骗运营商计费检测系统从而实现免流。
图7 全局免流软件原理
防跳程序会优先处理设备发起的网络请求，根据防跳策略或禁网或放行或强制网络请求走本地代理。当网络请求经过本地代理时，本地代理会根据免流模式对该网络请求的头部信息进行修改。修改过后的网络请求经过运营商代理服务器与计费检测系统得到不一样的效果，运营商代理服务器检测到的是真实访问的IP，而计费检测系统检测到的是免流IP。
早期出现了很多种“简单粗暴”的免流模式，传播较广的有前\后缀免流、端口免流、伪彩免流、双Host（或是Host—X-Online-Host）免流等，这些免流模式分别利用了运营商提供的免流前\后缀、免流端口与免流文件类型、以及运营商不检查多个重复字段的策略。随着运营商系统不断优化升级，不同地区运营商已根据自身策略情况在其代理服务器与计费检测系统中逐渐加入了针对此类攻击的校验机制，如校验获取的Host与Host字段内容的一致性、封掉原来的137/138免流端口、一旦检测到多Host或X-Online-Host字段就不免流等。
然而，免流模式也在随着运营商计费检测系统的升级不断演变。现今多数免流模式都采用了“字段伪装”的方式，即通过某些混淆信息将特定字段伪装起来，使代理服务器能够识别该字段而计费检测系统识别不了该字段，以此来达到蒙骗计费检测系统的目的。这种混淆信息可能是一个新的请求头字段，也可能是对原有字段的修改，甚至还有可能是一个空格或一个特殊字符等。
通常情况下，运营商代理服务器只能够解析三种固定格式的请求头，对于这三种固定格式的网络请求，代理服务器从中读取IP的方式是固定的（HTTPs与HTTP请求头有差异，这里以HTTP为例）：
  1. 请求方法中的Host与Host字段一致：此时运营商代理服务器直接解析请求方法[后跟的baidu.com](http://%E5%90%8E%E8%B7%9F%E7%9A%84www.baidu.com)：
2.请求方法后Host信息缺省：运营商代理服务器主动放弃从请求方法行寻找Host，转而解析Host字段内容baidu.com，并把Get后的内容作为Uri：
3.请求头中存在X-Online-Host（移动私有代理协议）字段：运营商代理服务器会优先解析X-Online-Host的内容为Host：
目前存活的免流模式绝大多数都是在以上3种固定请求头格式上做文章，通过免流模式对其进行增删改。由于运营商系统的不断升级完善，免流模式十分灵活多变，并且更新换代的速度很快，通常特定的模式只能留存很短的时间，一旦免流模式所针对的缺陷被修补，该模式将不再奏效。同时，由于运营商计费检测机制不透明，新的有效的免流模式往往要经过很多次试验才能被发现。
###  四、免流模式实例
以伪装双Host免流模式为例。伪装双Host免流模式即伪装起来的双Host字段请求头——去掉原请求头中请求方法后跟的Host，并且添加一个新的Host字段，使修改后的请求头实际上拥有两个Host字段。由于现在绝大多数运营商计费检测系统屏蔽了（不免流）双Host流量，所以必须把其中一个Host字段通过某种方式伪装起来，使计费检测系统识别不了它，具体实现方式是通过免流模式向请求头中加进混淆信息。
以一款名为“离调双Host”的Tiny免流模式为例，下图为该免流模式配置，其中http_ip表示代理服务器IP、http_port表示代理服务器监听端口、http_del表示删除原请求头中的指定字段、http_first表示按指定格式修改请求头首行。
图8 免流模式文件
设备中各应用程序发起的网络请求（除跳点外）在进入运营商代理服务器之前，会被核心模块按照以上文件配置进行修改，如下图左的请求头被修改后将会变成如下图右所示：
图9 修改前后的网络请求头对比
经该免流模式处理过之后，原HTTP请求头中出现了两个Host，其中一个Host前有两个中文字符，而请求方法行中已经没有了Host信息。根据上文提到的第（2）种固定请求头格式，对于新请求头，运营商代理服务器读取到的Host是[www.baidu.com](http://www.baidu.com)，而对于计费检测系统，因为有两个中文混淆字符，其不能从第二行开头获取Host字段标识，所以它选择从第三行的Host字段去获取Host——wap.10086.cn这个免流Host，因此最终达到了免流的目的。
以上只给出了一种经典的免流模式案例，现今存活的很多免流模式伪装方式千奇百怪，但万变不离其宗，最终的效果都是要欺骗计费检测系统去获取免流Host并以此实现免流。
###  五、定向流量卡
现在市场上有很多的“免流卡”，例如腾讯大王卡/天王卡、微博大V卡、蚂蚁宝卡等等，通常是互联网厂商与运营商合作推出的、促进本厂软件推广、增加用户粘性的手段。这类“免流卡”的主要特色是对特定来源的流量不收取流量费或一定限额内不收取流量费。以腾讯和联通合作推出的大\小王卡为例，运营商计费检测系统在检测到流量属于“腾讯系”（微信、腾讯视频、[王者荣耀](https://baike.baidu.com/item/%E7%8E%8B%E8%80%85%E8%8D%A3%E8%80%80/18752941)等）流量时，流量被自动计入包月的定向流量包，从而实现面向用户的免流。因此，与之前介绍的免流原理不同，这类“免流卡”实际上是一种定向流量包。
****
## 第三章 付费免流软件生态
###  一、完整的角色分工
免流软件发展至今已经有了成熟的生态链，这种生态链围绕着付费免流软件展开。目前付费免流软件的主要活跃场所是QQ群，我们一共找到了430个免流相关QQ群。免流QQ群在整个付费免流软件交易链中扮演着纽带角色，它为不同参与成员提供了一个咨询沟通与交易平台。在一个完整的免流QQ群中，主要包含以下几种角色：
#### (一)模式贡献者
模式贡献者是指提供免流模式的成员，这些成员负责向购买免流软件的用户提供可用的免流模式并不定时更新免流模式。因为免流模式决定了免流软件是否可用，因此这类成员是免流QQ群赖以运行的基础，一般是群主或者管理员。免流模式通常由模式贡献者自己学习编写或者从别处收购而来；
#### (二)推广代理
推广代理是指不涉及免流软件销售、仅负责对交易平台进行推广的成员，其主要职责是寻找有使用免流意向的用户，拉其加入所在QQ群，并向用户推荐咨询购买人。通常推广代理的收入来源与其成功拉进QQ群的用户数量成正比；
#### (三)分销代理
分销代理是指位于群主&管理员与用户之间的分销人，其通常出现在提供了云免流的QQ群中，成为分销代理需要先交纳一定金额的代理费。分销代理的主要任务是从群主&管理员处以低于直销价格的价钱批发云免流卡密，并以高价分销给用户。如下为一个QQ群提供的分销、加盟价格表，可以看到分销代理拿到的价格远低于用户直接从群主&管理员处购买的价格，分销代理正是利用这种价格差获利；
图10 免流QQ群拿货价格表
#### (四)加盟者
加盟者相当于高级代理，同样也要先缴纳一定金额加盟费，加盟费要高于代理费。成为加盟者后，不仅可以用比分销代理更低的价格购买免流模式与卡密，还可以像群主学习编写免流模式，并自主经营销售群主或自己编写的免流模式，其获利空间远大于推广代理与分销代理；
#### (五)用户
用户是免流软件的最终消费者，其可以从群主&管理员处直接购买免流软件，也可以通过分销代理购买。购买免流软件的用户在免流模式失效后通常可以免费获取新的免流模式；
#### (六)群主&管理员