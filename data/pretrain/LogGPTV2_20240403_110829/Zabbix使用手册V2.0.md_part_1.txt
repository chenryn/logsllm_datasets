ZABBIX 使用手册
-----运用zabbix构建企业大型监控系统
PI:EMAIL
ZABBIX 使用手册
运用zabbix构建企业大型监控系统
1. 文档信息........................................................................................................................................4
2. 声明：............................................................................................................................................4
3.Zabbix简介.....................................................................................................................................5
3.1Zabbix功能..........................................................................................................................6
3.2 优劣势..................................................................................................................................7
4. 安装部署........................................................................................................................................8
4.1 服务端安装lamp环境。...................................................................................................8
4.2 服务端配置lamp使用环境...............................................................................................8
4.3 服务端server的安装过程..................................................................................................9
4.3.1安装zabbix服务端...................................................................................................9
4.3.2添加zabbix到系统服务文件.................................................................................11
4.3.3导入zabbix数据库（此处采用mysql数据库）.................................................11
4.3.4拷贝service启动脚本............................................................................................12
4.3.5配置 zabbix_server.conf服务端文件....................................................................12
4.3.7拷贝网页文件到apache目录................................................................................15
4.3.8 设置zabbix开机启动............................................................................................15
4.4 通过web页面配置zabbix...............................................................................................15
4.5 客户端agentd的安装过程...............................................................................................19
4.5.1linux服务器客户端的安装....................................................................................19
4.5.1.1snmp监控方式......................................................................................................20
4.5.2windows客户端的安装..........................................................................................21
5.Zabbix的配置使用.......................................................................................................................24
5.1Zabbix支持的监控方式类型............................................................................................24
5.2 一个简单的例子--添加 Hosts，并应用模板.................................................................24
5.3 如何自定义监控................................................................................................................28
5.2.1，key的创建............................................................................................................28
5.2.2，web页面创建模板...............................................................................................30
5.4 如何自定义key.................................................................................................................34
5.5 添加 Items.........................................................................................................................35
5.6 添加 Triggers....................................................................................................................37
5.6.1如何配置Triggers...................................................................................................37
5.6.2触发器的表达式......................................................................................................38
5.7 添加 Actions.....................................................................................................................48
5.8 添加 Medias......................................................................................................................49
5.9 添加 Users.........................................................................................................................49
5.10 添加 WEBMonitorings..................................................................................................52
5.11 添加 Graphs....................................................................................................................56
5.12 添加 Screens...................................................................................................................57
5.13 添加 Maps.......................................................................................................................60
5.14 添加 MySQL监控.........................................................................................................62
5.15 添加 SNMP监控...........................................................................................................62
5.16 添加自定义监控.............................................................................................................62
5.17 添加 Templates...............................................................................................................66
5.18 添加Reports（定制报表）............................................................................................67
5.19 添加Macros....................................................................................................................69
5.20 添加自动发现设备.........................................................................................................69
5.21 添加Inventory.................................................................................................................70
5.22Export/ImportXML..........................................................................................................70
5.23Maintenance（维护时间）..............................................................................................71
5.24Proxy的使用....................................................................................................................73
5.25 创建zabbix的报警(以postfix为例子).........................................................................75
5.22.1创建meidatypes...................................................................................................76
5.22.2创建actions...........................................................................................................77
5.22.3zabbix用户配置....................................................................................................79
5.26 创建脚本报警(以mail.py为例)....................................................................................81
5.27 如何有效的设置监控报警.............................................................................................84
5.27.1基于业务类型........................................................................................................85
5.27.2基于故障级别........................................................................................................87
5.27.3基于时间发送........................................................................................................89
5.27.4故障依赖关系........................................................................................................89
5.27.5故障处理自动远程命令........................................................................................89
5.28 一些使用的技巧.............................................................................................................89
5.28.1监控项的使用技巧................................................................................................89
5.28.2触发器的使用技巧................................................................................................90
5.28.3定义全局变量的使用技巧....................................................................................91
5.28.4Snmp团组名的设置.............................................................................................91
5.28.5中文语言显示以及中文字体乱码解决方法.......................................................91
5.29Zabbix的4种监控方式概述..........................................................................................92
5.30zabbix_监控方式之一--agentd........................................................................................94
5.31zabbix_监控方式之二---SNMP.......................................................................................94
5.32zabbix_监控方式之四---IPMI.........................................................................................94
5.33zabbix_监控方式之四---JMX..........................................................................................97
6.Zabbix的高级使用-之自动化功能.............................................................................................99
6.1 自动发现添加主机............................................................................................................99
4.1.1创建自动发现规则..................................................................................................99
6.1创建自动添加到相应模板规则.......................................................................................100
6.2 通过low-leveldiscovery发现实现动态监控...............................................................102
6.2.1zabbix客户端配置................................................................................................103
6.2.2自动发现脚本编写................................................................................................103
6.2.3自定义key配置文件............................................................................................105
6.2.4web页面添加low-leveldiscovery.......................................................................106
7.zabbix性能优化.........................................................................................................................109
7.1Zabbix优化指标..............................................................................................................109
7.2zabbix_server.conf优化...................................................................................................109
7.3zabbix_agend.conf优化...................................................................................................109
7.4Zabbix数据库优化..........................................................................................................109
7.5zabix集群扩展的使用.....................................................................................................109
8. 批量更新参考文档....................................................................................................................120
9. 将zabbix打包成rpm包...........................................................................................................121
文档信息
1.
文档名：zabbix使用手册
------------运用zabbix构建大型监控系统
当前版本：v2.0
作 者：itnihao
版 权：GPL
个人站点：www.itnihao.com
Mail： PI:EMAIL
国内zabbixQQ交流群92242469（已满员），216490997(可加入)
文档修订信息
时间 更新内容
2012-12-07 初创时间V1.0
2013-01-23 增加自动发现V1.1
2013-02-08 增加部分文档说明V1.2
2013-02-11 修正部分错误V1.2
2013-05-22 增加自定义监控项的例子，邮件报警，触发器等内容
性能优化等内容V1.3
2013-06-06 增加监控报警分组，一些使用技巧 rpm打包v1.4
后续将继续更新proxy，优化，api等内容
2013-10-26 更新部分内容，版本为v2.0，更改文档名副标题
本文档涉及内容，zabbix的安装配置，zabbix的邮件报警，zabbix自定义脚本，自动化
配置
由于zabbix功能很丰富，许多功能需要逐步研究整理，后续本文档将继续完善。
声明：
2.
如果你觉得本文档对你学习zabbix有所帮助，请和我一同继续完善本文档，如果你觉
得本文档不适合你，或者说写的太差，请参看官方文档，那里是最权威的信息。同时，参考
本文档的读者，还是需要去参看官方文档。
如果你有兴趣完善本文档，请与我联系，在下一个版本中，会增加你的更新内容，本文
档继承开源精神，欢迎各位完善本文档。
值得高兴的事情，很多朋友在阅读本文档的时候，给我提过不少意见，也指出了个别的
错误之处。在此，感谢各位的支持。
同时，本文档也对网络内容进行了引用，引用的有pengyao，lihuipeng的相关内容，
文档中给出了链接。
如果本文档引用的内容侵犯你的权力，请与我联系，将在下一个版本中删除相关内容。
总之，感谢各位的支持，才有本文档的出现
3. Zabbix 简介
Zabbix是一个高度集成的网络监控解决方案，可以提供企业级的开源分布式监控解决
方案，由一个国外的团队持续维护更新，软件可以自由下载使用，运作团队靠提供收费的技
术支持赢利。
官方网站：http://www.zabbix.com
目前最新版本为2.0.X,后续版本2.1，2.2目前正在开发之中
Zabbix2.0官方文档：http://www.zabbix.com/documentation/2.0/manual
Zabbix通过C/S模式采集数据，通过B/S模式在web端展示和配置。
被监控端：主机通过安装agent方式采集数据，网络设备通过SNMP方式采集数据
Server端：通过收集SNMP和agent发送的数据，写入数据库（MySQL，ORACLE等），
再通过php+apache在web前端展示。
Zabbix运行条件：
Server：Zabbix Server 需运行在 LAMP（Linux+Apache+Mysql+PHP）环境下（或者
LNMP），对硬件要求低
Agent：目前已有的agent基本支持市面常见的OS，包含Linux、HPUX、Solaris、Sun、
windows
SNMP：支持各类常见的网络设备
监控过程逻辑如图示：
3.1 Zabbix 功能
具备常见的商业监控软件所具备的功能（主机的性能监控、网络设备性能监控、数据库
性能监控、FTP等通用协议监控、多种告警方式、详细的报表图表绘制）
支持自动发现网络设备和服务器（可以通过配置自动发现服务器规则来实现）
支持自动发现（lowdiscovery）key实现动态监控项的批量监控（需写脚本）
支持分布式，能集中展示、管理分布式的监控点
扩展性强，server提供通用接口（api功能），可以自己开发完善各类监控（根据相关接
口编写程序实现）
编写插件容易，可以自定义监控项，报警级别的设置。
数据收集
可用和性能检测
支持snmp(包括trappingandpolling)，IPMI，JMX，SSH，TELNET
自定义的检测
自定义收集数据的频率
服务器/代理和客户端模式
灵活的触发器
您可以定义非常灵活的问题阈值，称为触发器，从后端数据库的参考值
高可定制的报警
发送通知，可定制的报警升级，收件人，媒体类型
通知可以使用宏变量有用的变量
自动操作包括远程命令
实时的绘图功能
监控项实时的将数据绘制在图形上面
WEB监控能力
ZABBIX可以模拟鼠标点击了一个网站，并检查返回值和响应时间
Api功能
应用api功能，可以方便的和其他系统结合，包括手机客户端的使用。
更多功能请查看
https://www.zabbix.com/documentation/2.0/manual/introduction/features
3.2 优劣势
优点：
开源，无软件成本投入
Server对设备性能要求低
支持设备多，自带多种监控模板
支持分布式集中管理，有自动发现功能，可以实现自动化监控
开放式接口，扩展性强，插件编写容易
当监控的 item 比较多服务器队列比较大时可以采用被动状态，被监控客户端主动从
server端去下载需要监控的item然后取数据上传到server端。这种方式对服务器的负载比较
小。
Api的支持，方便与其他系统结合
缺点：
需在被监控主机上安装agent，所有数据都存在数据库里，产生的数据据很大,瓶颈主要
在数据库。
安装部署
4.
Zabbix Server 可以运行在 CentOS、RedHat Linux、Debain 等 Linux 系统上，这里以
centos6.3_X64作为部署环境。
预先配置好可用的yum源。
本文推荐的系统 rhel6.3，rhel6.464位系统（其他版本也是可以的，suse，ubuntu等）
磁盘空间，最好能在300G以上（注意，zabbix本身对磁盘要求并不高，但是考虑到数
据存放）
推荐的系统分区
/boot 100M-2G
Swap 10G
/ 剩余空间
配置yum源，epel的yum源
shell#rpm -vih rpm -ivh
http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
（当然此处的epel源版本可能后面会有变化，读者如果发现此源不能使用，改为当前
版本即可）
4.1 服务端安装 lamp 环境。
yum -y install gcc gcc-c++ autoconf httpd php mysql mysql-server php-mysql
httpd-manual mod_ssl mod_perl mod_auth_mysql php-gd php-xml php-mbstring php-ldap
php-pear php-xmlrpc php-bcmath mysql-connector-odbc mysql-devel libdbi-dbd-mysql
net-snmp-develcurl-devel unixODBC-devel OpenIPMI-devel java-devel
4.2 服务端配置 lamp 使用环境
配置php环境
修改php.ini
shell#vim /etc/php.ini (修改这些参数的目的是zabbix的web代码要求要这么配置才能正
常运行，所以，不修改饿后果就是安装无法获得正常的环境，关于php.ini这些参数的具体
意思，请读者自行参考php相关资料)
date.timezone = Asia/Shanghai
max_execution_time = 300
post_max_size = 32M
max_input_time=300
memory_limit = 128M
mbstring.func_overload = 2
如果不想手工修改，可以使用以下sed命令操作
sed -i "s/;date.timezone=/date.timezone=Asia\/Shanghai/g" /etc/php.ini
sed -i "s#max_execution_time=30#max_execution_time=300#g" /etc/php.ini
sed -i "s#post_max_size=8M#post_max_size=32M#g" /etc/php.ini
sed -i "s#max_input_time=60#max_input_time=300#g" /etc/php.ini
sed -i "s#memory_limit=128M#memory_limit=128M#g" /etc/php.ini
sed -i "/;mbstring.func_overload=0/ambstring.func_overload=2\n" /etc/php.ini
开启httpd，mysqld服务，
shell#chkconfigmysqld on
sehll#chkconfighttpd on
sehll#service mysqld start
sehll#service httpd start
4.3 服务端 server 的安装过程
在下面的安装过程中，展示的是通过源码安装，当然在实际的生产环境中，使用源码
安装的方式显得繁琐。我还是推荐rpm安装，对于初次学习的朋友呢，依然推荐rpm安装，
说实话，第一次源码安装lamp，lnmp的朋友，确实会遇到很多问题，所以推荐rpm安装。
下载zabbix安装包，这里以2.0.8为例（建议大家下载当前最新版本），
http://www.zabbix.com/download.php
http://sourceforge.net/projects/zabbix/files/ZABBIX%20Latest%20Stable/
4.3.1 安装 zabbix 服务端
shell#http://downloads.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/2.0.8/zabbix
-2.0.8.tar.gz
(当然读者可能想用最新版本，当前的最新版本为2.0.9,估计在2014年，最新版本2.2会即
将发行，但是编译安装的过程都是相同的，所以读者无需担心，同时本人还会维护zabbix
的rpm包，方便各位几分钟内搭建起自己的zabbix服务器)
增加zabbix用户
shell#groupaddzabbix-g201
shell#useradd-gzabbix-u201-m zabbix
shell#tarxfzabbix-2.0.8.tar.gz
下面截图看一下各目录的文件
shell#./configure--prefix=/usr --sysconfdir=/etc/zabbix --enable-server--enable-proxy
--enable-agent --enable-ipv6--with-mysql=/usr/bin/mysql_config--with-net-snmp
--with-libcurl --with-openipmi --with-unixodbc --with-ldap --with-ssh2 --enable-java
（如果你只是想安装一个服务端，只需开启--enable-server 即可，其他参数可以不用选，但
这里是为了后面的各项功能都可以使用，所以开启了非常多的参数）