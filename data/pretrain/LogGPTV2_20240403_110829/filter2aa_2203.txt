针对域证书服务的攻击（3）- ESC3
0x01 前言
在ESC1的利用的时候，好多小伙伴遇到一个错误，借用@Rcoil同学的图。解决方法也在星球，有@Rcoil
同学形成的文档。遇到这个错误的同学可以去看下。这个错误主要是因为2016以下的系统不支持这个
COM接口，因此需要改下代码。我开始以为是证书服务器16以下会出这个问题，但是我自己搭建12系统
的证书服务器环境发现并没有报错，因此我怀疑是域控在16以下。这算一个遗留问题，具体这个请求是
发送到域控还是证书服务器，需要后面分析，先mark下。
回归正题，今天时ESC3的分析，ESC3主要滥用的是错误配置了证书申请代理模板（Enrollment Agent 
Templates），听名字你也清楚，就是一个用户代替另一个用户去申请证书。这个一听，头脑里的利用
方案就出来了，一个普通域用户代替域管理员去申请证书。我们具体看下需要怎样的错误配置：
模板（Enrollment Agent Templates）允许一个低权限用户（这里我们使用普通域用户）去注册一
个代理证书。
这个条件和ESC1差不多，不需要设置使用者名称为在请求中提供，以及在扩展中修改应用程
序策略的EKU为证书申请代理OID（1.3.6.1.4.1.311.20.2.1）。
另外一个模板允许一个低权限用户使用代理证书（enrollment agent certificate）去代表另外一个
用户请求证书，并且这个模板的EKU里配置有允许域认证的EKU。
这里有点绕啊！不用担心，我们老规矩，配置环境。
0x02 危害环境配置
这里涉及到2个模板，我们先配置第一个模板，还是在ESC1的基础上配置，安全中的配置不变还是配置
了一个domain users组，来满足低权限访问，这里在实战中要举一反三，以我们当前权限为出发点，如
果我们当前有一个其他权限，而刚好有个一个危害模板在这个权限下能够访问，就满足了这个条件，而
不是非要domain users的权限。使用者名称改回默认的用Active Directory中的信息生成。重点修改的
还是扩展中的应用程序策略，改为证书申请代理。
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 1 / 7 - Welcome to www.red-team.cn
第二个模板我们还是在ESC1上设置，名称改为ESC3_1，在ESC1的基础上安全不用改，使用者名称恢复
默认的用Active Directory中的信息生成。扩展也不用改，保留里面的客户端认证EKU。下面的修改是
和以往不同的。
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 2 / 7 - Welcome to www.red-team.cn
这就是ESC3的2个模板了。这需要注意的是，你看我一项一项的配置，感觉修改的很多，大多不是默
认，其实不然，系统默认模板很多，不同配置在不同默认模板中都有默认配置，因此我们只需要搞清楚
每个ESC(权限提升)的各个关键配置点，理解里面的各个配置的作用，在实战中才能灵活运用。
0x03 工具利用
Certify.exe find /vulnerable
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 3 / 7 - Welcome to www.red-team.cn
这是第一个模板，还有第二个模板，你会发现这个命令并没有识别出ESC3_1的模板。因此使用这个工具
的时候也要注意了，不要只用上面的命令查看是否有危害，工具不是万能的。我们使用：
这个命令查看证书服务器上可用的所有模板，其中ESC3_1满足我们利用的第二个条件:
首先我们，利用ESC3模板获取一个代理证书：
Certify.exe find /ca:"win2019.redteamlab.com\redteamlab-WIN2019-CA"
Certify.exe request /ca:"win2019.redteamlab.com\redteamlab-WIN2019-CA-1" 
/template:ESC3
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 4 / 7 - Welcome to www.red-team.cn
老规矩，pem转pfx，这一步我就略去了，还不会的同学，看前2面文章。然后再利用ESC3_1模板去获取
特权证书，其中onbehalfof参数一定要使用NETBIOS名，xiaoaiti、redteamlab\xiaoaiti、
redteamlab.com\xiaoaiti都不行，一定要是REDTEAMLAB\xiaoaiti。具体原因可能是工具限制，这儿搞
了我半天。具体原因先mark下，后面分析。
最后一步，再使用pem转pfx，然后使用Rubeus，搞TGT：
Certify.exe request /ca:"win2019.redteamlab.com\redteamlab-WIN2019-CA-1" 
/template:ESC3_1 /onbehalfof:REDTEAMLAB\xiaoaiti /enrollcert:3.pfx
Rubeus.exe asktgt /user:REDTEAMLAB\xiaoaiti /certificate:4.pfx 
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 5 / 7 - Welcome to www.red-team.cn
0x04 总结
ESC3重点是代理模板的利用，这个过程我搞了好久，因为，为了验证前言中的win2012的问题，导致我
把域证书链弄错了，搞了很久一直报错，申请到证书一直报KDC_ERR_CLIENT_NOT_TRUSTED错误，卡
在了最后一部，后面发现是我根证书没有部署到域控的问题，导致整个证书链不能被信任。最后手动修
复：
ps:文中证书服务器开始时win2019.redteamlab.com\redteamlab-WIN2019-CA，后面就成了
win2019.redteamlab.com\redteamlab-WIN2019-CA-1，就是因为我重装了证书服务器。
cd C:\Windows\System32\certsrv\CertEnroll
C:\Windows\System32\certsrv\CertEnroll> certutil -dspublish .crl
C:\Windows\System32\certsrv\CertEnroll> certutil -dspublish +.crl
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 6 / 7 - Welcome to www.red-team.cn
Produced by AttackTeamFamily - Author: L.N. - Date: 2021-08-17 
No. 7 / 7 - Welcome to www.red-team.cn