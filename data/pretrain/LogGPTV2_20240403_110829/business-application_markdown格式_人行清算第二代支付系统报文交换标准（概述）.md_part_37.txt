|   | O            | 发送系统号  | 19   | 4  | x | M | BEPS           |
|   | rigSenderSID |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
| 接 | OrigReceiver | 报文接收人 | 23   | 14 | x | M | 103100022226   |
|   |              |             |      |    |   |   | （             |
| 收 |             |             |      |    |   |   | 注意后补空格） |
|   |              |             |      |    |   |   |                |
| 方 |             |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | Ori          | 接收系统号  | 37   | 4  | x | M | BEPS           |
|   | gReceiverSID |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
| 报 | OrigSendDate | 报         | 41   | 8  | d | M | 20100501       |
| 文 |             | 文发起日期  |      |    |   |   |                |
| 描 |             |             |      |    |   |   |                |
| 述 |             |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | OrigSendTime | 报          | 49   | 6  | t | M | 094508         |
|   |              | 文发起时间  |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | StructType   | 格式类型    | 55   | 3  | x | M | XML            |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgType     | 报          | 58   | 20 | x | M | b              |
|   |              | 文类型代码  |      |    |   |   | eps.101.001.01 |
|   |              |             |      |    |   |   | （             |
|   |              |             |      |    |   |   | 注意后补空格） |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgID       | 通          | 78   | 20 | x | M | A1234B         |
|   |              | 信级标识号  |      |    |   |   | 1234C1234D1234 |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgRefID    | 通          | 98   | 20 | x | O | 000000         |
|   |              | 信级参考号  |      |    |   |   | 00000000000000 |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgPriority | 报文优先级  | 118  | 1  | n | M | 3              |
+---+--------------+-------------+------+----+---+---+----------------+
|   | M            | 报          | 119  | 1  | X | M | U              |
|   | esgDirection | 文传输方向  |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | Reserve      | （保留域）  | 120  | 9  | x | O | （空格填充）   |
+---+--------------+-------------+------+----+---+---+----------------+
|   | EndFlag      | 结束标识    | 129  | 3  | x | M | }\\r\\n        |
+---+--------------+-------------+------+----+---+---+----------------+
#### MBFE发送给行内系统 {#mbfe发送给行内系统 .样式-标题-4标题-4-Char-+-宋体-五号}
+---+--------------+-------------+------+----+---+---+----------------+
| * | **域名**     | **含义**    | **位 | ** | * | * | **说明**       |
| * |              |             | 置** | 长 | * | * |                |
| 域 |             |             |      | 度 | 类 | 属 |              |
| * |              |             |      | ** | 型 | 性 |              |
| * |              |             |      |    | * | * |                |
|   |              |             |      |    | * | * |                |
| * |              |             |      |    |   |   |                |
| * |              |             |      |    |   |   |                |
| 类 |             |             |      |    |   |   |                |
| * |              |             |      |    |   |   |                |
| * |              |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | BeginFlag    | 起始标识    | 0    | 3  | x | M | {H:            |
+---+--------------+-------------+------+----+---+---+----------------+
| 版 | VersionID   | 版本号      | 3    | 2  | n | M | 02             |
| 本 |             |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
| 发 | OrigSender  | 报文发起人  | 5    | 14 | x | M | 102100099998   |
|   |              |             |      |    |   |   | （             |
| 起 |             |             |      |    |   |   | 注意后补空格） |
|   |              |             |      |    |   |   |                |
| 方 |             |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | O            | 发送系统号  | 19   | 4  | x | M | BEPS           |
|   | rigSenderSID |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
| 接 | OrigReceiver | 报文接收人 | 23   | 14 | x | M | 103100022226   |
|   |              |             |      |    |   |   | （             |
| 收 |             |             |      |    |   |   | 注意后补空格） |
|   |              |             |      |    |   |   |                |
| 方 |             |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | Ori          | 接收系统号  | 37   | 4  | x | M | BEPS           |
|   | gReceiverSID |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
| 报 | OrigSendDate | 报         | 41   | 8  | d | M | 20100501       |
| 文 |             | 文发起日期  |      |    |   |   |                |
| 描 |             |             |      |    |   |   |                |
| 述 |             |             |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | OrigSendTime | 报          | 49   | 6  | t | M | 094508         |
|   |              | 文发起时间  |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | StructType   | 格式类型    | 55   | 3  | x | M | XML            |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgType     | 报          | 58   | 20 | x | M | b              |
|   |              | 文类型代码  |      |    |   |   | eps.101.001.01 |
|   |              |             |      |    |   |   | （             |
|   |              |             |      |    |   |   | 注意后补空格） |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgID       | 通          | 78   | 20 | x | M | A1234B         |
|   |              | 信级标识号  |      |    |   |   | 1234C1234D1234 |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgRefID    | 通          | 98   | 20 | x | O | 000000         |
|   |              | 信级参考号  |      |    |   |   | 00000000000000 |
+---+--------------+-------------+------+----+---+---+----------------+
|   | MesgPriority | 报文优先级  | 118  | 1  | n | M | 3              |
+---+--------------+-------------+------+----+---+---+----------------+
|   | M            | 报          | 119  | 1  | X | M | D              |
|   | esgDirection | 文传输方向  |      |    |   |   |                |
+---+--------------+-------------+------+----+---+---+----------------+
|   | Reserve      | （保留域）  | 120  | 9  | x | O | （空格填充）   |
+---+--------------+-------------+------+----+---+---+----------------+
|   | EndFlag      | 结束标识    | 129  | 3  | x | M | }\\r\\n        |
+---+--------------+-------------+------+----+---+---+----------------+
## **数字签名域**
### **数字签名域格式**
数字签名域采用变长数据格式，格式如下：
+---+--------------+-------------+------+----+----+---+--------------+
| * | **域名**     | **含义**    | **位 | ** | ** | * | **说明**     |
| * |              |             | 置** | 长 | 类 | * |              |
| 域 |             |             |      | 度 | 型 | 属 |             |
| * |              |             |      | ** | ** | 性 |             |
| * |              |             |      |    |    | * |              |
|   |              |             |      |    |    | * |              |
| * |              |             |      |    |    |   |              |
| * |              |             |      |    |    |   |              |
| 类 |             |             |      |    |    |   |              |
| * |              |             |      |    |    |   |              |
| * |              |             |      |    |    |   |              |
+---+--------------+-------------+------+----+----+---+--------------+
|   | BeginFlag    | 起始标识    | 0    | 3  | x  | M | {S:          |
+---+--------------+-------------+------+----+----+---+--------------+
|   | Digi         | 数          | 4    | 签 | 签 | M |              |
|   | talSignature | 字签名内容  |      | 名 | 名 |   |              |
|   |              |             |      | 长 | 数 |   |              |
|   |              |             |      | 度 | 据 |   |              |
+---+--------------+-------------+------+----+----+---+--------------+
|   | EndFlag      | 结束标识    | 签   | 3  | x  | M | }\\r\\n      |
|   |              |             | 名后 |    |    |   |              |
|   |              |             | 紧接 |    |    |   |              |
+---+--------------+-------------+------+----+----+---+--------------+
### **加签要素和数字签名编制**
CNAPS2使用数字签名保证业务数据的可靠性和防抵赖性。数字签名由业务发起方编制，CNAPS2-NPC和业务接收方核验。
CNAPS2编制业务数字签名的做法如下：
（1）按报文中业务要素出现的顺序，将各加签业务要素值后附"\|（竖线）"后顺序拼接成签名要素串；例如"102100033452\|CNY1234.56\|beps.101.001.01\|"。最后一个业务要素值后面也有"\|（竖线）"；取金额字段作为加签要素时，应包括该金额对应的货币符号，例如格式CNY1234.56；取含有TAG标识符字段（格式为"/tag/value"）时，只使用value部分的内容，不包括/tag/字符。
（2）使用本行的数字证书（私钥）对签名要素串签名，签名的校验算法使用SM2算法；
（3）将签名值使用BASE64转码后填写到报文的数字签名域。
**各加签业务要素值，指业务要素对应的XML报文域数据，包括该域除XML标签外的所有字符，无须补齐位数，并截断两端空白字符。空白字符，指空格（0x20）、制表(0x09)、回车(0x0d)、换行(0x0a)四个字符。**
**如加签业务要素没有在报文中出现，或其值为全空白（即截断两端空白字符后长度为0），则拼接签名要素串时忽略该加签业务要素。**
### **数字证书绑定通知报文的数字签名核验标准**
CNAPS2数字证书绑定通知报文使用带签名者证书（公钥）的数字签名（PKCS#7）。核验该数字签名的要求如下：
（1）数字签名核验成功，并获取签名者证书（公钥）；
（2）检查签名者证书，应是CFCA签署且证书合法、有效，应使用证书注销列表文件（CRL）进行证书是否已被注销的检查；
（3）检查签名者证书的DN域，应包含ou=CNAPS（忽略大小写），且CN域应包含签名者的行号；
核验通过后，CNAPS2-NPC和各接收参与机构应存储签名者的证书公钥数据，并作为后续验证该参与机构发送的非数字证书绑定通知报文的数字签名的证书。
### **非数字证书绑定通知报文的数字签名核验标准**
CNAPS2非数字证书绑定通知报文使用无签名者证书（公钥）的数字签名（PKCS#1，裸签）。核验该数字签名的要求如下：
（1）按报文格式标准中的加签要素组织签名要素串；
（2）获取发起参与机构绑定的证书公钥；
（3）使用该公钥、签名要素串、数字签名，核验数字签名的合法性，应使用证书注销列表文件（CRL）进行证书是否已被注销的检查。
核验通过后，CNAPS2-NPC和各接收参与机构应存储业务及其签名备查。
### **特殊字符的说明**
在 XML 中，一些字符拥有特殊的意义。 如\ &
这3个字符，直接使用时会导致XML解析失败。因此，**报文正文中仅允许字符"\"，"&"使用其实体引用，其余字符不得使用实体引用进行转义**，在拼装报文时需要使用其实体引用
&lt; &lg;
&amp;代替。**解析与拼装加签要素时，使用该符号本身"\"，"&"。**
## **报文体格式**
报文体为XML格式，使用\标签标识XML报文的根。
+-----------------------------------------------------------------------+
| \                          |
|                                                                       |
| \                                |
|                                                                       |
| \... \...                                                             |
|                                                                       |
| \                                                         |
+-----------------------------------------------------------------------+
**注：**namespace_string的值为该报文所对应的schema文件中定义的名字空间值。
### **格式检查**
每个报文都有对应的schema文件用来进行报文格式检查，schema文件名称与报文编号相同，使用ISO20022标准的报文则采用ISO20022发布的schema文件。
参与机构发送报文给CNAPS2时，应将待发送往帐报文的报文体使用XML
Schema进行格式检查，检查通过后，才能提交给MBFE。
参与机构从MBFE接收报文后，应使用XML
Schema对收到的来帐报文的报文体进行格式检查，检查通过后，才能提交给行内系统进行业务处理。对检查失败的来帐报文，如报文可以解析并能获取返回业务级回应报文需要的报文数据时，返回"已拒绝"回执报文，否则丢弃该报文，留待日终对账解决。
## **报文编号**
**报文编号规则为"xxxx.nnn.nnn.nn"**
表示系统编号，四位小写字母
表示报文编号，三位数字
预留， 固定填写001
版本号， 两位数字
### **系统编号**
+----+---------------------------+------------------------------------+
| ** | **业务类型名称**          | **系统编号**                       |
| 序 |                           |                                    |
| 号 |                           |                                    |
| ** |                           |                                    |
+----+---------------------------+------------------------------------+
| 1. | 清算账户管理系统          | saps                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 2. | 大额实时支付系统          | hvps                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 3. | 小额批量支付系统          | beps                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 4. | 公共控制与管理系统        | ccms                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 5. | 支付管理信息系统          | pmis                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 6. | 网上支付跨行清算系统      | ibps                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 7. | 全国支票影像交换系统      | ncis                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 8. | 电子商业汇票系统          | ecds                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 9. | 境内外币支付系统          | fxps                               |
|    |                           |                                    |
+----+---------------------------+------------------------------------+
| 10 | 轧差服务器系统            | nets                               |
| .  |                           |                                    |
+----+---------------------------+------------------------------------+
| 11 | 支付报文传输平台          | PMTS                               |
| .  |                           |                                    |
+----+---------------------------+------------------------------------+
### **报文编号**
+------+-----------+------------------------------------+--------------+
| **序 | **名称**  | **小分类**                         | **编号范围** |
| 号** |           |                                    |              |
+------+-----------+------------------------------------+--------------+
| 1.   | 支        | 贷记、借记类业务                   | 100-139      |
|      | 付类业务  |                                    |              |
+------+-----------+------------------------------------+--------------+
|      |           | 即时转账类业务                     | 140-149      |
+------+-----------+------------------------------------+--------------+
|      |           | 城市商业银行汇票类业务             | 150-169      |
+------+-----------+------------------------------------+--------------+
|      |           | 质押融资类业务                     | 170-199      |
+------+-----------+------------------------------------+--------------+
| 2.   | 信        | 信息业务                           | 300-499      |
|      | 息类业务  |                                    |              |
+------+-----------+------------------------------------+--------------+
| 3.   | 轧        | 清算轧差类                         | 600-699      |
|      | 差清算类  |                                    |              |
+------+-----------+------------------------------------+--------------+
| 4.   | 日        | 业务核对与明细下载报文             | 700-799      |
|      | 终处理类  |                                    |              |
+------+-----------+------------------------------------+--------------+
| 5.   | 运        | 运行控制类                         | 800-899      |
|      | 行控制类  |                                    |              |
+------+-----------+------------------------------------+--------------+
| 6.   | 系        | 基础数据管理类                     | 900-939      |
|      | 统管理类  |                                    |              |
+------+-----------+------------------------------------+--------------+
|      |           | 系统管理与确认                     | 940-969      |
+------+-----------+------------------------------------+--------------+
|      |           | 回执归并类                         | 970-979      |
+------+-----------+------------------------------------+--------------+
|      |           | PMIS支付管理类                     | 980-989      |
+------+-----------+------------------------------------+--------------+
|      |           | 其他类                             | 990-999      |
+------+-----------+------------------------------------+--------------+
## **其他约束**