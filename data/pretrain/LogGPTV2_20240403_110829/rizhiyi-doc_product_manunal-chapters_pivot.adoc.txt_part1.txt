== 透视表视图[[pivot]]
上一章统计视图，都来自搜索页的查询结果配置。日志易还提供了单独的基于数据透视表的统计视图创建和管理方式。
点击"趋势图"菜单栏，进入趋势图列表页，页面右上角点击"创建"菜单，根据需要选择不同方式进入透视表视图引导流程。
透视表视图的创建有不同的方式，点击"新建"，则基于 SPL 语句返回的数据开始，又分为查询和统计两类数据；点击"选择数据集"，则基于数据集的配置开始。
=== 基于查询语句的透视表
1. 填写趋势图名称，描述，资源标签和所属应用等基础配置，点击下一步；
+
image::images/qushitu-new-step1.png[]
2. 填写查询类搜索语句，左侧可选数据集，页面类似搜索页效果，将展示命中范围内的字段列表和日志原文。
+
image::images/qushitu-new-step2.png[]
3. 勾选在命中范围内值得统计分析的字段。这将构成一个数据集合。为了让用户能更了解选中各字段的数据分布情况，日志易将采用概要卡片的形式展示数据集的频数分布状态：
+
image::images/pivot-step2.png[]
+
默认的，系统会采用每个分片仅取样 5000 条的配置完成快速统计。这个配置对于大致了解数据分布来说已经足够。如果您有更精确的需要，可以在搜索框下方手动调整参数。
+
[cols="2",options="header"]
|===
|取样数据结果
|不取样数据结果
a|image::images/pivot-terminal-after.png[]
a|image::images/pivot-terminal-without.png[]
|===
+
如上图对比，取样和不取样仅在罕见数据上略有区别，并不影响用户了解主要取值并进行后续配置。
+
4. 数据集勾选确定后，点击下一步，进入图表配置。
+
页面左侧展示上一步选定的数据集字段列表，中间是图表配置区域，右侧是效果预览区域。用户可以鼠标拖拽左侧的字段名称，释放到图表配置区域的相应位置。日志易将自动按照字段类型和配置类型，生成合适的 SPL 统计语句，并推荐最合适该统计结果的可视化图表类型供选择。
+
image::images/pivot-step3.png[]
+
当维度字段被设置为 timestamp 时，用户可以点击 timestamp 标签弹出细节浮层。具体配置对时间轴的分桶粒度/最小粒度/分桶数量等。不输入的情况下，日志易将使用 timechart 指令的自适应分桶功能。
+
当对比字段被设置为数值类型字段时，用户可以点击该对比字段标签弹出细节浮层。具体配置对数值区间的分桶粒度/分桶数量等。日志易将使用 timechart 指令中 by 字段的 SPAN/BINS 参数进行切分。
+
用户可以拖拽多个不同字段到数值配置区域，日志易将自动采用多 Y 轴效果。对于数值，默认采用 `count` 函数度量，用户可以点击字段名称，在细节浮层中修改统计函数为 `dc`, `avg` 等。
+
image::images/pivot-step3-multi-y-axis.png[]
+
5. 完成图表配置后，点击"保存"，完成趋势图的创建流程。
=== 基于统计语句的透视表
已经保存的趋势图，再次进入编辑流程；或在新建流程的第二步，输入非查询类的 SPL 统计语句，将进入统计类透视表视图引导流程。
1. 统计语句点击查询后，页面类似搜索页统计标签效果，将展示统计结果表格。如下图，即为上一小节创建的趋势图重新编辑时的效果：
+
image::images/pivot-step2-2.png[]
2. 点击下一步，进入图表配置。由于上一步已经是统计表格，此处无需再进行语句的生成操作，所以页面只有图表配置部分：
+
image::images/pivot-step3-2.png[]
=== 基于数据集的透视表
数据集各节点配置有独立的约束语句和字段列表。基于这些配置，足以完成数据透视表视图的数据查询和过滤，维度、数值和切分对比字段的配置流程。为了方便进行跨数据集的数据透视，日志易还提供多个数据集之间可视化的关联查询和追加合并功能。
在列表页点击"选择数据集"后，弹层展示三个路口，根据需要进行不同的透视流程：
image::images/pivot-menu.png[]
==== 单个数据集
选择"单个数据集"，进入数据透视流程第一步。在页面左侧选择具体的某个数据集节点：
image::images/pivot-single-dataset-step1.png[]
如图所示，页面右侧主体内容会自动预览该数据集的数据内容，表格各列就是所选数据集节点上配置的字段列表。在预览表格的右上角，可以查看预览数据对应的 SPL，并调整预览的时间范围。
在页面右侧下部，是数据集过滤条件配置区。
过滤方式支持条件判断和表达式两种。
条件过滤可以配置多个条件，并设置为必须满足全部条件或仅需满足任一条件即可。条件中的第一个选择为字段名称，必须从该数据集的字段列表中选择；第二个选择为判断方式，根据字段类型的不同，可以为：等于、不等于匹配，或者等于、大于、小于。
完成配置后，点击"应用"，上方预览表格会自动查询刷新。此时，再次点击上方的"查看SPL"，您可以看到 SPL 语句已经自动生成补充了 where 语句：
image::images/pivot-single-dataset-where-and.png[]
表达式过滤只有一个输入框，可以输入完整的 SPL 语法 where 表达式，比如上图通过条件过滤配置得到的效果，您也可以通过表达式过滤的方式，直接在表达式输入框中手写 `csv.name=="zookeeper.state.znode_count" && csv.host!="10.150.32.80"` 完成。
预览数据满意后，即可点击进入下一步"图表配置"。
图表配置的主要功能和操作和基于查询的数据透视表创建流程类似。并在此基础上丰富了快捷同环比统计的操作。
当维度字段为 timestamp 时，您可以点击 timestamp 并在配置弹层中添加"分桶粒度"参数。添加完成以后，可以看到数值配置右侧出现一个"对比"小图标，点击图标，"对比"配置栏被强制收起。重新点击数值配置栏的字段，在配置浮层中，可以看到同环比配置项。同环比配置栏可以勾选以下设置项：
* 同比
** 上周同比值
** 上月同比值
** 去年同比值
* 环比
您可以同时勾选多个选项，为主查询数据做同粒度下的同环比展示效果：
image::images/pivot-comparison.png[]
当维度字段为普通文本类型字段时，可以看到数值配置右侧也有"对比"小图标，同样可以点击切换进行同环比设置：
image::images/pivot-comparison-notime.png[]
在页面右上角点击"查看SPL"，可以在浮层上看到系统自动生成的同环比 SPL 语句。比如上图效果的实际 SPL 为：
 starttime=1555171200000 endtime=1555257600000 index=metric appname:tsv | where(tsv.name=="frontend.mysql.conn_count")|stats avg(tsv.value) by tsv.host | eval _compare="当前" | append [[ starttime=1554566400000 endtime=1554652800000 index=migu_b appname:migu_b | where(tsv.name=="frontend.mysql.conn_count")|stats avg(tsv.value) by tsv.host | eval _compare="同比一周" ]]
完成图表设置以后，点击下一步，配置趋势图名称、描述、标签等基础配置，最后点击保存即可。