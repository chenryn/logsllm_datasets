|          |          |       |        | ures-in- |         |        |
|          |          |       |        | rhel_con |         |        |
|          |          |       |        | figuring |         |        |
|          |          |       |        | -and-man |         |        |
|          |          |       |        | aging-ne |         |        |
|          |          |       |        | tworking |         |        |
|          |          |       |        | .html#xd |         |        |
|          |          |       |        | p-on-pee |         |        |
|          |          |       |        | r-device |         |        |
|          |          |       |        | .f       |         |        |
|          |          |       |        | ootnote} |         |        |
+----------+----------+-------+--------+----------+---------+--------+
| QEMU     | `virti   | 是    | 是     | 是       | 否      | 否     |
| Virtio   | o_net`{. |       |        | [^\[a\]^ |         |        |
| 网络     | literal} |       |        | ](#assem |         |        |
|          |          |       |        | bly_unde |         |        |
|          |          |       |        | rstandin |         |        |
|          |          |       |        | g-the-eb |         |        |
|          |          |       |        | pf-featu |         |        |
|          |          |       |        | res-in-r |         |        |
|          |          |       |        | hel_conf |         |        |
|          |          |       |        | iguring- |         |        |
|          |          |       |        | and-mana |         |        |
|          |          |       |        | ging-net |         |        |
|          |          |       |        | working. |         |        |
|          |          |       |        | html#ftn |         |        |
|          |          |       |        | .xdp-on- |         |        |
|          |          |       |        | interfac |         |        |
|          |          |       |        | e){.foot |         |        |
|          |          |       |        | noteref} |         |        |
|          |          |       |        | [^\[     |         |        |
|          |          |       |        | b\]^](#a |         |        |
|          |          |       |        | ssembly_ |         |        |
|          |          |       |        | understa |         |        |
|          |          |       |        | nding-th |         |        |
|          |          |       |        | e-ebpf-f |         |        |
|          |          |       |        | eatures- |         |        |
|          |          |       |        | in-rhel_ |         |        |
|          |          |       |        | configur |         |        |
|          |          |       |        | ing-and- |         |        |
|          |          |       |        | managing |         |        |
|          |          |       |        | -network |         |        |
|          |          |       |        | ing.html |         |        |
|          |          |       |        | #ftn.req |         |        |
|          |          |       |        | uires-qu |         |        |
|          |          |       |        | eues-ge- |         |        |
|          |          |       |        | cpu-inde |         |        |
|          |          |       |        | x){.foot |         |        |
|          |          |       |        | noteref} |         |        |
+----------+----------+-------+--------+----------+---------+--------+
| ::: {#a  |          |       |        |          |         |        |
| ssembly_ |          |       |        |          |         |        |
| understa |          |       |        |          |         |        |
| nding-th |          |       |        |          |         |        |
| e-ebpf-f |          |       |        |          |         |        |
| eatures- |          |       |        |          |         |        |
| in-rhel_ |          |       |        |          |         |        |
| configur |          |       |        |          |         |        |
| ing-and- |          |       |        |          |         |        |
| managing |          |       |        |          |         |        |
| -network |          |       |        |          |         |        |
| ing.html |          |       |        |          |         |        |
| #ftn.xdp |          |       |        |          |         |        |
| -on-inte |          |       |        |          |         |        |
| rface .f |          |       |        |          |         |        |
| ootnote} |          |       |        |          |         |        |
| [^\[a\]^ |          |       |        |          |         |        |
| ](#assem |          |       |        |          |         |        |
| bly_unde |          |       |        |          |         |        |
| rstandin |          |       |        |          |         |        |
| g-the-eb |          |       |        |          |         |        |
| pf-featu |          |       |        |          |         |        |
| res-in-r |          |       |        |          |         |        |
| hel_conf |          |       |        |          |         |        |
| iguring- |          |       |        |          |         |        |
| and-mana |          |       |        |          |         |        |
| ging-net |          |       |        |          |         |        |
| working. |          |       |        |          |         |        |
| html#xdp |          |       |        |          |         |        |
| -on-inte |          |       |        |          |         |        |
| rface){. |          |       |        |          |         |        |
| simpara} |          |       |        |          |         |        |
| 只有在接 |          |       |        |          |         |        |
| 口中载入 |          |       |        |          |         |        |
| XDP      |          |       |        |          |         |        |
| 程序。   |          |       |        |          |         |        |
| :::      |          |       |        |          |         |        |
|          |          |       |        |          |         |        |
| :::      |          |       |        |          |         |        |
|  {#assem |          |       |        |          |         |        |
| bly_unde |          |       |        |          |         |        |
| rstandin |          |       |        |          |         |        |
| g-the-eb |          |       |        |          |         |        |
| pf-featu |          |       |        |          |         |        |
| res-in-r |          |       |        |          |         |        |
| hel_conf |          |       |        |          |         |        |
| iguring- |          |       |        |          |         |        |
| and-mana |          |       |        |          |         |        |
| ging-net |          |       |        |          |         |        |
| working. |          |       |        |          |         |        |
| html#ftn |          |       |        |          |         |        |
| .require |          |       |        |          |         |        |
| s-queues |          |       |        |          |         |        |
| -ge-cpu- |          |       |        |          |         |        |
| index .f |          |       |        |          |         |        |
| ootnote} |          |       |        |          |         |        |
| [^\[     |          |       |        |          |         |        |
| b\]^](#a |          |       |        |          |         |        |
| ssembly_ |          |       |        |          |         |        |
| understa |          |       |        |          |         |        |
| nding-th |          |       |        |          |         |        |
| e-ebpf-f |          |       |        |          |         |        |
| eatures- |          |       |        |          |         |        |
| in-rhel_ |          |       |        |          |         |        |
| configur |          |       |        |          |         |        |
| ing-and- |          |       |        |          |         |        |
| managing |          |       |        |          |         |        |
| -network |          |       |        |          |         |        |
| ing.html |          |       |        |          |         |        |
| #require |          |       |        |          |         |        |
| s-queues |          |       |        |          |         |        |
| -ge-cpu- |          |       |        |          |         |        |
| index){. |          |       |        |          |         |        |
| simpara} |          |       |        |          |         |        |
| 需要分   |          |       |        |          |         |        |
| 配的多个 |          |       |        |          |         |        |
| XDP TX   |          |       |        |          |         |        |
| 队       |          |       |        |          |         |        |
| 列大于或 |          |       |        |          |         |        |
| 等于最大 |          |       |        |          |         |        |
| CPU      |          |       |        |          |         |        |
| 索引。   |          |       |        |          |         |        |
| :::      |          |       |        |          |         |        |
|          |          |       |        |          |         |        |
| :        |          |       |        |          |         |        |
| :: {#ass |          |       |        |          |         |        |
| embly_un |          |       |        |          |         |        |
| derstand |          |       |        |          |         |        |
| ing-the- |          |       |        |          |         |        |
| ebpf-fea |          |       |        |          |         |        |
| tures-in |          |       |        |          |         |        |
| -rhel_co |          |       |        |          |         |        |
| nfigurin |          |       |        |          |         |        |
| g-and-ma |          |       |        |          |         |        |
| naging-n |          |       |        |          |         |        |
| etworkin |          |       |        |          |         |        |
| g.html#f |          |       |        |          |         |        |
| tn.xdp-o |          |       |        |          |         |        |
| n-peer-d |          |       |        |          |         |        |
| evice .f |          |       |        |          |         |        |
| ootnote} |          |       |        |          |         |        |
| [^       |          |       |        |          |         |        |
| \[c\]^]( |          |       |        |          |         |        |
| #assembl |          |       |        |          |         |        |
| y_unders |          |       |        |          |         |        |
| tanding- |          |       |        |          |         |        |
| the-ebpf |          |       |        |          |         |        |
| -feature |          |       |        |          |         |        |
| s-in-rhe |          |       |        |          |         |        |
| l_config |          |       |        |          |         |        |
| uring-an |          |       |        |          |         |        |
| d-managi |          |       |        |          |         |        |
| ng-netwo |          |       |        |          |         |        |
| rking.ht |          |       |        |          |         |        |
| ml#xdp-o |          |       |        |          |         |        |
| n-peer-d |          |       |        |          |         |        |
| evice){. |          |       |        |          |         |        |
| simpara} |          |       |        |          |         |        |
| 只有     |          |       |        |          |         |        |
| 在对等设 |          |       |        |          |         |        |
| 备中载入 |          |       |        |          |         |        |
| XDP      |          |       |        |          |         |        |
| 程序。   |          |       |        |          |         |        |
| :::      |          |       |        |          |         |        |
+----------+----------+-------+--------+----------+---------+--------+
:::
Legend：
::: itemizedlist
-   基本：支持基本返回代码：
    `DROP`{.literal}、`PASS`{.literal}、`ABORTED`{.literal} 和
    `TX`{.literal}。
-   重定向：支持 `REDIRECT`{.literal} 返回代码。
-   目标：可以是 `REDIRECT`{.literal} 返回代码的目标。
-   HW 卸载：支持 XDP 硬件卸载.
-   零复制：支持 `AF_XDP`{.literal} 协议系列的零复制模式。
:::
:::
:::
[]{#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking.html}
::: chapter
::: titlepage
# []{#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking.html#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking}第 51 章 使用 BPF 编译器集合进行网络追踪 {.title}
:::
本节介绍 BPF Compiler Collection（BCC）是什么，如何安装
BCC，以及如何使用 `bcc-tools`{.literal}
软件包提供的预创建脚本执行不同的网络追踪操作。所有这些脚本均支持
`--ebpf`{.literal} 参数显示实用程序上传到内核的 eBPF
代码。您可以使用这些代码了解更多有关编写 eBPF 脚本的信息。
::: section
::: titlepage
# []{#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking.html#bcc_network-tracing-using-the-bpf-compiler-collection}BCC 介绍 {.title}
:::
BPF Compiler Collection（BCC）是一个库，可帮助创建扩展的 Berkeley Packet
Filter（eBPF）程序。eBPF
程序的主要工具是在不需要额外的开销或存在安全问题的情况下，分析操作系统性能和网络性能。
BCC 不再需要用户了解 eBPF
的技术详情，并提供了许多开箱即用的起点，如预先创建的 eBPF 程序的
`bcc-tools`{.literal} 软件包。
::: {.note style="margin-left: 0.5in; margin-right: 0.5in;"}
### 注意 {.title}
eBPF 程序在事件中触发，如磁盘 I/O、TCP
连接以及进程创建。程序不太可能导致内核崩溃、循环或者变得无响应，因为它们在内核的安全性虚拟机中运行。
:::
:::
::: section
::: titlepage
# []{#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking.html#installing-the-bcc-tools-package_network-tracing-using-the-bpf-compiler-collection}安装 bcc-tools 软件包 {.title}
:::
本节论述了如何安装 `bcc-tools`{.literal} 软件包，该软件包还会将 BPF
Compiler Collection（BCC）库作为依赖性安装。
::: itemizedlist
**先决条件**
-   有效的 [*[[Red Hat Enterprise Linux
    订阅](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/configuring_basic_system_settings/index#basics-registering-managing-subscriptions){.link}]{.citetitle}*]{.emphasis}
-   包含 `bcc-tools`{.literal} 软件包的
    [*[[已用软件仓库](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/configuring_basic_system_settings/index#basics-installing-software){.link}]{.citetitle}*]{.emphasis}
-   [更新的内核](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_monitoring_and_updating_the_kernel/updating-kernel-with-yum_managing-monitoring-and-updating-the-kernel#updating-the-kernel_updating-kernel-with-yum){.link}
-   根权限
:::
::: orderedlist
**流程**
1.  安装 `bcc-tools`{.literal}:
    ``` literallayout
    # yum install bcc-tools
    ```
    BCC 工具安装在 `/usr/share/bcc/tools/`{.literal} 目录中。
2.  （可选）检查工具：
    ``` literallayout
    # ll /usr/share/bcc/tools/
    ...
    -rwxr-xr-x. 1 root root  4198 Dec 14 17:53 dcsnoop
    -rwxr-xr-x. 1 root root  3931 Dec 14 17:53 dcstat
    -rwxr-xr-x. 1 root root 20040 Dec 14 17:53 deadlock_detector
    -rw-r--r--. 1 root root  7105 Dec 14 17:53 deadlock_detector.c
    drwxr-xr-x. 3 root root  8192 Mar 11 10:28 doc
    -rwxr-xr-x. 1 root root  7588 Dec 14 17:53 execsnoop
    -rwxr-xr-x. 1 root root  6373 Dec 14 17:53 ext4dist
    -rwxr-xr-x. 1 root root 10401 Dec 14 17:53 ext4slower
    ...
    ```
    上表中的 `doc`{.literal} 目录包括了每个工具的文档。
:::
:::
::: section
::: titlepage
# []{#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking.html#displaying-tcp-connections-added-to-the-kernels-accept-queue_network-tracing-using-the-bpf-compiler-collection}显示添加到内核的接受队列中的 TCP 连接 {.title}
:::
内核在 TCP 3 通道握手中接收 `ACK`{.literal}
数据包后，内核会在连接的状态变为 `ESTABLISHED`{.literal}后，将连接从
`SYN`{.literal} 队列移到 `accept`{.literal} 队列。因此，只有成功的 TCP
连接才能在此队列中看到。
`tcpaccept`{.literal} 实用程序使用 eBPF 功能显示所有内核添加到
`accept`{.literal} 队列的连接。这个程序是轻量级的，因为它跟踪了内核的
`accept()`{.literal}
功能，而不是捕获数据包并过滤它们。例如：一般故障排除请使用
`tcpaccept`{.literal} 来显示服务器接受的新连接。
::: orderedlist
**流程**
1.  输入以下命令启动追踪内核 `accept`{.literal} 队列：
    ``` literallayout
    # /usr/share/bcc/tools/tcpaccept
    PID   COMM      IP RADDR         RPORT  LADDR    LPORT
    843   sshd      4  192.0.2.17    50598  192.0.2.1  22
    1107  ns-slapd  4  198.51.100.6  38772  192.0.2.1  389
    1107  ns-slapd  4  203.0.113.85  38774  192.0.2.1  389
    ...
    ```
    每次内核接受连接时，`tcpaccept`{.literal} 显示连接详情。
2.  按 [**Ctrl**]{.keycap}+[**C**]{.keycap} 停止追踪过程。
:::
::: itemizedlist
**其它资源**
-   详情请查看 `tcpaccept(8)`{.literal} man page。
-   有关 `tcpaccept`{.literal} 和示例的详情，请查看
    `/usr/share/bcc/tools/doc/tcpaccept_example.txt`{.literal} 文件。
-   要显示 eBPF 脚本 `tcpaccept8)`{.literal} 上传到内核，请使用
    `/usr/share/bcc/tools/tcpaccept --ebpf`{.literal} 命令。
:::
:::
::: section
::: titlepage
# []{#network-tracing-using-the-bpf-compiler-collection_configuring-and-managing-networking.html#tracing-outgoing-tcp-connection-attempts_network-tracing-using-the-bpf-compiler-collection}追踪 TCP 连接尝试 {.title}
:::
`tcpconnect`{.literal} 实用程序使用 eBPF 功能跟踪 TCP
连接尝试。该工具的输出还包括失败的连接。
`tcpconnect`{.literal} 工具是轻量级的，因为它跟踪了内核的
`connect()`{.literal} 功能，而不是捕获数据包并过滤它们。
::: orderedlist
**流程**
1.  输入以下命令启动显示所有传出连接的追踪过程：
    ``` literallayout
    # /usr/share/bcc/tools/tcpconnect
    PID    COMM         IP SADDR      DADDR          DPORT
    31346  curl         4  192.0.2.1  198.51.100.16  80
    31348  telnet       4  192.0.2.1  203.0.113.231  23
    31361  isc-worker00 4  192.0.2.1  192.0.2.254    53
    ...
    ```
    每次内核处理传出连接时，`tcpconnect`{.literal} 会显示连接详情。
2.  按 [**Ctrl**]{.keycap}+[**C**]{.keycap} 停止追踪过程。
:::
::: itemizedlist
**其它资源**
-   详情请查看 `tcpconnect(8)`{.literal} man page。
-   有关 `tcpconnect`{.literal} 和示例的详情，请查看
    `/usr/share/bcc/tools/doc/tcpconnect_example.txt`{.literal} 文件。
-   要显示 eBPF 脚本 `tcpconnect(8)`{.literal} 上传到内核，请使用
    `/usr/share/bcc/tools/tcpconnect --ebpf`{.literal} 命令。
:::
:::