从 反序列化到内
Java RMI
⽹沦陷 安
- SecPulse.COM |
全脉搏
“ 映⼊眼帘的是两个⼤屏，分别显示着
Nmap、Nessus、Xray 的扫描报告，汇
总分⻔别类的展示了各个⼦域名对应端
⼝、服务、第三⽅组件、组织架构等信
息。
前⾔
在⼀个秋⾼⽓爽的上午，特别适合划⽔ (mo yu)。九点半
接到来⾃ CBD 的外卖早餐单，穿着⻩⾊的⼯作服，⾛街
串巷，四处奔⾛，⼀⼝⽓不带喘爬上 38 楼（毕竟坐的是
电梯），登上城市的⾼峰，⼀望⽆际的⼤海，是我渴望不
可及的梦想，深深感受来⾃资本主义的鞭策，早安，打⼯
⼈。把热腾腾的⾖汁递给了满眼⿊眼圈的安服仔，安服仔
满怀感激的⽬光注视着我，吐槽道：“害，熬了个通宵打
演练，结果 webshell 都没有，太难了，这次七天的演练
项⽬怕是要凉了，唯有这碗⾖汁能激发我的⽃志了。” 作
为 个前安服仔 现任鹅了没的骑⼿ 不能就这样让后浪
为⼀个前安服仔，现任鹅了没的骑⼿，不能就这样让后浪
（jiu cai）就这样倒在浪潮⾥。拍着隔壁安服仔的肱⼆头
肌，说道“Welcome to the real world，Welcome to
the jungle。” 安服仔顿时眼神憨住“说⼈话。” “来把我
带上你⼯位，我来帮你看看。”
正式开始
映⼊眼帘的是两个⼤屏，分别显示着 Nmap、Nessus、
Xray 的扫描报告，汇总分⻔别类的展示了各个⼦域名对
应端⼝、服务、第三⽅组件、组织架构等信息。
快速对信息收集报告扫了⼀眼，发现⼀处 x1099 端⼝对
应 java rmi 服务，这说明好的渗透测试皆是基于信息收
集做的好，作为⼀个三年渗透经验的安服仔，⽴即联想到
之前 Java RMI 存在反序列化漏洞 CVE-2017-3241，掏
出⼤佬写的⼯具。
果然，很快啊，啪的⼀下出来了，果断 Cobalt strike 执
⾏下 powershell 上线，年轻⼈不讲武德. jpg。
德 x 巧克⼒纵享丝滑般的顺畅（麻烦德 x 给我⼀下⼴告
费），啊不，渗透享受丝滑般快感。上来就是 system，
连提权都省了。不到五分钟，外⽹第⼀个点打下来了，安
服仔看向我的眼神多了⼏分仰慕。
内⽹渗透
进来先直接在 CobaltStrike 上运⾏ mimikatz 的
logonpassword，进⾏明⽂密码 dump。
获得第⼀个 A 密码 btscxxx$789，规律就是主站域名 +
数字 789。
使⽤ systeminfo 查看，发现该机器并没有加域。╮(╯-
╰)╭好叭⼜是⼯作组渗透，因为该⽬标是教育⾏业某⼤
学，感觉如果维护⼈员是学校计算机教师兼职维护的话，
安全性应该不是特别⾼，内⽹流量监控应该不严，常规套
路通过 lcx 代理进⼊内⽹（通过 tasklist /svc 还发现该
机器上存在数字杀软，通过本地搭建杀软环境，myccl
定位了⼀下特征码，发现杀的基本都是提示的字符串，通
过 CS32ASM 把全部字符串⼤⼩写反转⼀下，bypass
so easy 这⾥假装有图，感觉没啥技术难度，就不展开细
说。）。
⽬标机器（⾁鸡）上传 lcx，接着执⾏ lcx -slave 攻击者
IP VPS 监听端⼝ ⽬标机器 IP 转发的⽬标机器端⼝
攻击者本地 VPS 监听 lcx -listen 监听端⼝ (随便设置)
转发到本地的端⼝ (随便设置，远程端⼝链接)
中间⼀度转发成功，但死活连接不上，然后看了⼀下进程
发现存在⼀个安全狗的服务器版本，想了想应该多半这玩
意拦截，啪的⼀下 Kill 掉，接着⽤⽹上的⽅法禁⽌掉服
务，发现没啥卵⽤，他的进程会⾃动复活，后⾯凭借单身
⼆⼗年载的⼿速，跟他拼了，K 掉⽴即连进去，⼿动退
出安全狗，禁⽌服务，⼀⼝⽓不带喘操作，后⾯连接远程
桌⾯才没断断续续。
进来打开 IIS 看看我们的靶标系统在不在这⾥，发现还是
在这台机 上 发 在 外 台机 前机
不在这台机器上，ping ⼀下发现在另外⼀台机，当前机
器在是 35，靶标是 36 ⽬标主站，尝试直接利⽤刚才抓
的密码 btscxxx$789 登录靶标，报了个密码错误，⽓的
直跺脚，啊这，主站不是这密码，但内⽹其他机器是这个
密码。
接着超级弱⼝令先跑⼀波该密码。
接着漫⻓的跑⽹段，这⾥是个 B 段，但为了探测⽅便
（不影响业务）就⼀个个段⼿动跑，晚上的时候可以考虑
⼤⼀点的流量进⾏跑。接着⼿⼯进⼊后⼀个个
powershell 弹回来（由于没编写脚本，只能搬砖的节
奏）。
⽬前把⼀部分该拿的分拿了，该回到第⼀台机器上翻翻垃
圾堆，说不定有⼀些其他的⾯包屑信息可以帮助你再进⼀
步渗透。在 A 机器上发现有⼀个 8uftp，直接连进去发
现了靶标系统主站 A，
使⽤星号密码查看器读取密码，获得 B 密码
btscxxx$8888888（主站域名 + 某办公室电话）
尝试写⼊⽂件看看是不是真的⽬标，请求⻚⾯确认⽆误，
传⼊⼀句话⽊⻢。
冰蝎连⼊，找到 conn.asp ⽂件翻到上⾯的 mssql 数据
库账号 sa、密码 btscxxx!123，果断尝试连接数据库
exec 执⾏命令反弹 powershell。![img]
此时得到 MSSQL 数据库 C 密码 btscxxx!123，也获得
了靶标系统的权限。继续通过 mimikatz 密码
hashdump，得到主机其实就是 B 密码
btscxxx$8888888
接着继续拿着 B、C 密码接着跑⼀波。