  * 新加密体系（SMB 3.0+），防止嗅探，中间人攻击。1.1的加密体系性能要优于原体系的签名体系。
  * 恶意SMB访客拒绝机制（Win10+），对抗中间人攻击。
  * 更好的消息签名机制（SMB 2.02+），在SMB2和SMB3中分别使用SHA-256和AES-CMAC替换原有的MD5哈希算法，签名性能有很大提升。
糟糕的是，不管如何提高SMB协议的安全性，只要服务端和客户端支持使用SMB1，中间人攻击就无法避免。黑客只要踢掉SMB2+协议并告诉此路不通，客户端就会主动屁颠的降级到SMB1，和黑客共享通信过程中的一系列消息，除非通信内容本身加密。这并不是小说中的情节，实际攻击是存在的。
## SMB1不是必需的
很长一段时间里工业界都是需要SMB1协议的。NedPyle在微软博客《SMB1 Product
Clearinghouse》一文中，整理了使用SMB1的提供商依然有数十个，而且*nix平台下也有不少SMB协议实现和兼容，比如知名开源软件Samba等。
如果只谈论微软SMB1是不完整的。
很多人都以为Samba是微软Windows NT平台下SMB协议的一个克隆，但回顾历史会发现这并不准确。1992年1月Samba发布了第一个版本，
1993年Windows NT才发布它的第一个版本。除非让Samba研发人员时光穿梭，不然克隆Windows NT的说法不成立。
Samba最初目标是为了兼容DEC公司研发的Pathworks产品，这在当时很流行，主要运行于Ultrix 和VMS操作系统上。Samba作者Andrew
Tridgell试图在一台Sun工作站上完成DEC
Pathworks功能，这可以让他的桌面系统直接访问部门的Unix服务器，作者觉得这很酷。考虑微软桌面系统的垄断地位，Samba在实现时很注意兼容Windows客户端，这也是后来总是被拿出来和Windows
SMB作比较的原因。但这不代表Samba不注重其它客户端的兼容，只能说花在分析微软SMB协议上的时间要比其它客户端要多的多。
Samba的研发团队在过去很长时间里，都在对外声明Samba项目并不是基于黑客式的软件逆向工程得出来的代码。他们并不推崇软件逆向工程，觉得这样的方式得出来的代码不具有可维护性。Samba项目的成功，一方面是得益于SMB/CIFS那些可能不准确，不完整的公开文档（如“draft-leach-cifs-v1-spec-02.txt”），还有被称之为“法国咖啡技术”的方法。
法国咖啡技术，简而言之：一个人想学习法语，没有相关书籍，课程，老师等条件，于是他选择直接前往巴黎现场学习。他走进一个本地咖啡厅，开始观察顾客和服务员间对话，顾客说什么服务员带来什么，一段时间后他学会了“水”，“咖啡”，“面包”等单词，这和学习SMB里的“文件大小”，“时间戳”字段类似。有天他想学习法语骂人，这在咖啡厅很难遇见，于是他故意往服务员身上泼咖啡，服务员随即骂了他一嘴，这和如何确定SMB里的错误码是一个道理。一段时间后他学会了部分单词和基本用法，为掌握更多法语，他开始揣摩组合单词并做成剧本，晚上练习剧本，白天找耐心的服务员对话，通过比较服务员和剧本获得正确法语，同理可以应用在Samba的协议分析上。
Samba研发过程越是艰辛，暗示着SMB1协议的碎片化越严重，那是否也暗示着SMB1的信徒众多，业界离不开它？
2007年SMB2项目启动至今，留给SMB1协议的专用场景已经很少了。除非，还有这些看起来“合理”的理由：
  * 因种种原因需要运行Windows XP或Windows 2003系统。
  * 依然使用古老的管理软件，需要 “网上邻居”功能。
  * 古老的打印机，它需要通过扫描共享的方式来工作。
不过看上去，这些使用SMB1的场景只会影响到很小范围的业务和用户。目前相关服务提供商如果不支持SMB2+，那可能他们的业务也到尽头。微软在意识到SMB1问题的严重性后，一直在和存储，打印机，软件应用等领域的合作伙伴推广SMB2+协议的支持与应用。目前Samba，EMC，NetApp，苹果公司的OSX和MacOS都已经支持SMB2，3。
实际上，微软和Samba都已经在新版本中默认禁用了SMB1协议。
2017年5月WannaCRY勒索病毒事件爆发之时，很多企业选择直接在客户端和交换机上默认禁用139,445/TCP端口通信，并没有听说造成了业务影响（当然这个做法，长期看不见得合理）。专家NedPyle作过一次测试，“禁用SMB1
700天：什么都没发生，就像过去699天一样。任何在我的网络中请求使用SMB1都是违法的。”。
## 尾声
回过头，SMB1漏洞引爆的WannaCRY勒索蠕虫事件并不是意外，而是一直以来互联网对于最佳安全实践贯彻不坚决的总体反映，是网络安全中的一次“灰犀牛”事件。
一方面，安全专家需要反思。更多时候，专业安全人员的工作是否应该专注于提高系统的安全性，而非让个人，企业了解得像专业安全人员一样多。做防御的，不应该总想着能阻止攻击，而应该考虑怎么减少攻击面，提高攻击门槛。
另一方面，现代网络中禁用SMB1协议并没有那么难，需要的是关闭它的信心和勇气。
万物互联的大安全时代，是时候行动起来挥手告别SMB1了。
## 引用
  1. 
  2. 
  3. 
  4. 
  5. 
  6. 
  7. 
  8. 
  9. 
  10. 
  11. 
  12. 
  13. 
  14. 
  15. 
  16. 
  17. 