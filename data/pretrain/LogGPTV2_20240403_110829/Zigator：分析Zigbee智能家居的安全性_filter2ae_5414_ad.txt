NWK目标和源类型可以使用第7.1节中介绍的方法进行推断。仅使用这些功能，就可以构建一个决策树，以100％的精度识别12条可能的NWK命令中的6条。其余的NWK命令可能到达不纯的叶节点，该叶节点代表两种或三种可能的标识。
现在，描述获得100％准确度的派生决策规则。从上表中可以看出，只有“终端设备超时请求和响应”命令的有效载荷长度可以为2个字节。此外，“终端设备超时请求”命令的源始终是Zigbee终端设备，目的地是Zigbee协调器或Zigbee路由器，而“终端设备超时响应”命令的模式相反。因此，可以通过考虑NWK目标类型来将这两个NWK命令彼此区分开。在下图中提供的部分决策树中对此进行了描述。接下来，如上表所示，链路状态和路由请求命令是唯一广播到所有Zigbee路由器和Zigbee的NWK命令。协调器（由0xfffc广播地址表示）。可以根据它们是否是单跳NWK命令来区分它们。此外，请注意，“链接状态”命令仅由Zigbee路由器和Zigbee协调器发送，但是不必依靠这一事实就可以将它们标识为“链接状态”命令。
因此，被动攻击者可以通过检测链接状态命令来识别Zigbee路由器。还可以100％准确地识别“网络更新”和“重新加入响应”命令，将在以下小节中针对所发起的攻击进行讨论。
###  （3）密钥传输攻击
安全研究人员已经意识到，自Zigbee协议的早期版本以来，网络密钥到新设备的传输可能得不到充分的保护，从而导致“短暂的脆弱性”。关于传统的Zigbee网络，Zillner和Strobl建议攻击者诱使最终用户使用干扰技术将其Zigbee设备之一恢复出厂设置，从根本上延长了漏洞的发生时间。但是，Zigbee
3.0设备可以使用安装代码加入Zigbee 3.0网络，该安装代码用于派生特定于设备的预先配置的Trust
Center链接密钥，并按顺序通过带外通信通道传输到Trust
Center。加密将网络密钥传输到新设备的Zigbee数据包。现在研究了该策略在克服网络密钥泄漏漏洞方面的有效性。
**评估Zigbee 3.0设备的调试：** 在设备上及其包装盒内找到购买的Zigbee 3.0设备的失速代码，同时为灯泡提供了其他贴纸。为了将Zigbee
3.0设备添加到Zigbee 3.0网络，使用智能手机扫描了它的QR码，如上图a所示。提供了在不扫描其QR码的情况下添加Zigbee
3.0设备的选项，选中该选项后将显示上图b中所示的消息。在那种情况下，Zigbee协调器使用默认的“信任中心”链接密钥来加密“传输密钥”命令。假设不安全的重新加入请求不被接受，攻击者获取网络密钥的主要策略是发起拒绝服务攻击，这将迫使最终用户将使用已知信任中心的设备恢复出厂设置。链接密钥以加入网络。
攻击者可以通过识别和定位旧Zigbee设备来完成此任务。或者，如果攻击者可以访问Zigbee 3.0设备，则可以将其瞄准Zigbee
3.0设备；如果攻击者可以看到其QR码，最终用户未安全处置设备的包装箱或设备，则Zigbee 3.0设备可能会泄漏。以前由其他用户拥有。Zigbee
3.0设备的QR码还包含其相应设备的扩展地址，如果攻击者能够访问安装代码，则他们可能更有可能通过仅针对相应的Zigbee
3.0设备来获取网络密钥，因为最终用户可能不会考虑其安装代码被泄漏并在出厂时进行重置的可能性。不加思索。
**强制设备恢复出厂设置：** 理想情况下，攻击者希望将必须阻塞的数据包数量降到最少，以强制设备恢复出厂设置，意识到这可以通过引起PAN
ID冲突来实现。注入使用与最终用户的Zigbee网络相同的PAN ID，但具有不同的扩展PAN ID（EPID）的伪造信标，足以启动PAN
ID冲突解决过程。每个收到伪造信标的Zigbee路由器都会通知网络管理器，该管理器通常是Zigbee协调器，并使用“网络报告”命令。然后，网络管理器选择一个新的PAN
ID，并使用“网络更新”命令将其广播到网络中的所有设备。
传输网络更新命令后不久，网络管理器和接收该命令的所有设备将切换到新的PAN ID。 Zigbee终端设备在PAN
ID更改之前可能未收到“网络更新”命令，在这种情况下，它们将尝试重新加入网络。因此，如果攻击者有选择地阻塞了网络管理器发出的网络更新命令，则某些设备将不会自动切换到新的PAN
ID。
攻击者可以识别网络更新命令，因为它们是唯一可以具有12个字节有效负载长度的NWK命令。也可以识别重新加入响应，因为它们是唯一的NWK命令，其有效载荷长度可以为3个字节，并且仅限于单跳传输。但是，在实验过程中，观察到即使阻塞了所有“重新加入响应”，某些设备仍能够使用新的PAN
ID重新加入网络。为了使设备保持断开连接，必须有选择地阻塞更新的信标，以防止设备更新其PAN ID。还观察到，如果在PAN
ID冲突后为其数据请求欺骗了MAC确认，则Zigbee终端设备未按预期启动重新加入过程。发起这些拒绝服务攻击会导致以下结果：
（a）最终用户将无法更改其受影响的执行器的状态，
（b）如果受影响的传感器检测到事件，它将无法通知最终用户用户；
（c）依赖于受影响设备的自动化规则将无法正常运行。
如果攻击者成功锁定了使用已知信任中心链接密钥的Zigbee设备，并且最终用户决定将其重置为出厂设置，则攻击者可以在调试过程中通过嗅探和解密Transport
Key命令来访问网络密钥。然后，攻击者可以解密大多数加密的有效载荷，并注入命令来更改最终用户设备（包括使用安装代码的Zigbee 3.0设备）的状态。
**意外行为：**
通过修改ATUSB的固件启动了上述解决方案。当Zigbee路由器无法接收网络更新命令时，观察到了一些意外行为。在确定无法再到达Zigbee协调器之后不久，Smart
Things Outlet（IM6001-OTP01）很快启动了重新加入过程，但Centralite 3系列Smart
Outlet在大约25分钟后启动了该过程。这种现象也可以在数据集中观察到。更有趣的是，SmartThings智能灯泡在监控它的38个小时内没有像智能插座那样启动重新加入过程。这似乎是固件问题，因为Centralite插座是旧的Zigbee设备，而SmartThings灯泡是Zigbee
3.0设备。注意到，这种行为使攻击者受益，因为它们将不得不阻塞少于预期数量的数据包。鉴于经过认证的Zigbee设备数量众多，因此未知有多少没有启动或严重延迟重新加入过程的设备，如果它们没有收到网络更新命令。
**责任披露：** 向Zigbee联盟报告了本文的发现，其代表之一证实了其有效性。他们说，他们知道PAN
ID冲突攻击，并且已经实施了规范更改，可以防止恶意PAN ID更改。关于对网络更新命令的选择性干扰，他们评论说，即使在非恶意情况下，PAN
ID更改也可能会丢失，因此，未来的规范将需要更具攻击性的算法。他们还认为，很难从Zigbee
3.0设备泄漏网络密钥。但是，由于传统的Zigbee设备仍可在市场上购买，并且消费者可能还没有将其全部替换为Zigbee
3.0设备，因此认为密钥传输攻击仍然可以在野发起。
**安全性增强：**
认为如果可在带外通信通道上重新配置信任中心链接密钥，则将显着改善通信过程的安全性。特别是，当设备尝试加入新网络并通过NFC进行传输时，此加密密钥可能会有所不同。鉴于诸如SmartThings之类的智能家居生态系统已经依靠智能手机应用程序让用户向其Zigbee网络添加设备，因此使用NFC不会对可用性产生任何重大影响。但是，由于需要额外的硬件，设备的制造成本可能会增加。最后，应该使最终用户意识到使用旧Zigbee设备会给他们的网络带来的安全风险。
## 0x08 Conclusion
在这项工作中介绍Zigator和一个测试平台设计，该设计可以对Zigbee网络进行深入的安全性分析。描述了针对集中式Zigbee网络的多次侦察攻击，并表明，尽管进行了NWK层加密，攻击者仍可以100％准确地识别某些NWK命令。使用此信息来开发选择性的干扰和欺骗攻击，这些攻击可通过将目标锁定为使用已知信任中心链接密钥的设备来导致网络密钥暴露。当公开发布软件工具和数据集时，提供了防止网络密钥泄漏的建议。本文工作揭示了在集中式Zigbee网络中禁用MAC层安全性的后果。正如所展示的，NWK层安全性不足以抵御多种被动和主动攻击。