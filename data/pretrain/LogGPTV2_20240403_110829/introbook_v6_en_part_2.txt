gettingmoreandmoreattractive.Butitcannotbeusedon
standbyyet.
Therearealsootherchangesthatimprovequeryplanning.
Besides,theEXPLAINcommandcannowdisplaycustomized
parameters of the optimizer, which can help with trou-
bleshooting.
18 ServerPerformance
ii
JITcompilationisnowenabledbydefault,whichmeansitis
nolongerexperimental.
TOASTnowallowstoextractonlytheinitialpartofthevalue
thatisactuallyrequiredinsteadoffullydecompressingthe
toastedvalueandremovingtheredundantpart,asbefore.
Besides, there are many other minor improvements that
speedupvariousoperations.
Monitoring
Loggingqueriescangeneratehugelogfiles.Nowyoucanlog
onlyaspecificpercentofalltransactions,whichisespecially
usefulforOLTPsystemswithmultiplesimilartransactions.
(Theabilitytologonlysomeofthe“short”operationsistar-
getedforthenextversion.)
By analogy with pg_stat_progress_vacuum, this version
addsseveralotherviewsthatreporttheprogressofCREATE
INDEX,REINDEX,andVACUUMFULLcommandsduringtheirex-
ecution.
Onemorewaiteventhasbeenadded:fsyncforWALfiles.It
allowstoreceivemoredetailsaboutI/Operformance.
Besides,theinformationshowninmanysystemviewsisnow
morecomplete,andyoucanusenewfunctionstobrowse
throughthearchiveandtemporarydirectoriesdirectlyfrom
SQL.
Vacuum 19
ii
Inthenewversion,thedefaultsettingsimproveautovacuum
performance. Itdoesnotmeanitsfine-tuningisnolonger
required,especiallynowthatmanymorecontrol“knobs”are
provided.
VACUUMandANALYZEcommandscannowskiptablesthatcan-
notbelocked,anddonotrequestalockontablesforwhich
theuserlackspermissions.
YoucannowpreventVACUUMfromtruncatingtrailingempty
pages;althoughsuchcleanupcanoftenbeuseful,itrequires
ashortexclusivelockonthetable.Youcanalsoforbidindex
cleanup,forexample,ifyouneedtofreezeoldtuplesassoon
aspossibletoavoidtransactionIDwraparound.
Youcanalsospecifythewraparoundhorizonforthevacu-
umdbutilitytofocusoncleaningupthosetablesthatneed
itthemost.
EmptyleafpagesofGiSTindexesarenowdeletedduringvac-
uumoperation.
ReplicationandRecovery
All recovery parameters have been moved into the post-
gresql.conffile. Recovery.confdoesnotexistanymore;you
shouldnowusetwosignalfilestoswitchintorecoveryor
standbymode.Thischangeintroducesaunifiedapproachto
dealingwithconfigurationparametersandwillallowmodi-
fyingsomesettingswithoutaserverrestartinthefuture.
20 Youcannowcopyreplicationslots(bothphysicalandlogical).
ii Itcanbeusefulwhenyouhavetosetupseveralstandbys
fromasinglebackupcopy.
AnewSQLfunctionpromotesastandbytoprimary. Previ-
ously,itcouldonlybedonewithanOSsignal.
The wal_sender processes required for streaming replica-
tionarenolongertakenintoaccountwhendeterminingthe
maximumnumberofconnections.Thus,multipleclientcon-
nectionswillnothamperreplicationanymore.
Youcanalsofindmanymoreinconspicuous,butveryuseful
improvements.
SQLCommands
Itisnowpossibletoaddgeneratedcolumnstotablesusing
theGENERATEDALWAYSASclause. Thecurrentimplementa-
tionallowsonlystoredcolumns;virtualcolumns(calculated
onthefly)areexpectedlater.Generatedcolumnsworkfaster
andareoftenmoreconvenienttousethancolumnsauto-
filledbytriggers.
Youcanfilterrowswhencopyingdatafromafileintoatable
usingCOPYFROM.
COMMIT and ROLLBACK commands can now take the AND
CHAINclausetoendatransactionandimmediatelystarta
newone.SuchbehaviorisdescribedintheSQLstandard,but
wasnotimplementedinpreviousversions.
TheabilitytocreatetableaccessmethodsusingCREATEAC-
CESSMETHODandspecifytheaccessmethodatthetimeof
tablecreationopensendlessopportunities.Theonlymethod
available right now is the good old heap, so nothing has 21
changedforusersyet. Butit’sthefirststeptowardsimple- ii
mentingpluggablestorage,whichhasrequiredsignificant
refactoringofPostgreSQLcore. Someexperimentalaccess
methodsarealreadybeingdeveloped:
• Zheap.Usingtheredolog,itpreventstablebloatingand
eliminatestheneedforvacuum.Thismethodislikelyto
workbestforworkloadswithfrequentlychangingdata.
github.com/EnterpriseDB/zheap
• Zedstore.Thismethodimplementscolumn-orienteddata
storagewithbuilt-incompression.Itisusefulforanalyt-
icalqueriesthathavetoprocessmultiplerows,butonly
someofthecolumns.
github.com/greenplum-db/postgres/tree/zedstore
Utilities
Underestimated by many, the psql console client has be-
comemoreconvenient. NowitsupportstheCSVformatfor
tabledisplay,providesalinktothecorrespondingsection
indocumentationinSQLcommand-linehelp,improvesthe
auto-completefeatureformanycommands,andaddsthe\dP
commandthatdisplayspartitionedtables.
The pg_upgrade utility used for server upgrades can now
clonefiles(ifthefilesystemallowsit).Theeffectisthesame
aswhenusinghardlinks,butallthechangesthatfollowdo
notaffecttheoldcluster, soyoucangetbacktoitifany
issuesoccur.
The pg_verify_checksums utility has been renamed to
pg_checksumsandnowallowstoenableordisablecheck-
22 sumsinaclusterwithoutitsre-creation. Youhavetostop
ii theserverthough: changingchecksumsettingsonthefly
willbeimplementedlater.
SQL/JSONSupport
SQL:2016standarddefinedhowtoworkwithJSONdatausing
SQL,whichshouldputanendtoincompatibleimplemen-
tations. ThecurrentPostgreSQLversionsupportsthemain
partofthestandard: SQL/JSONpathlanguage,whichplays
roughlythesameroleforJSONasXPathdoesforworking
withXMLdata.Togetanideaofwhatthislanguageislike,
youcantakealookatseveralexamplesprovidedonp.131.
Support for SQL/JSON datetime data types, as well as the
otherpartofthestandardthatdefinestherequiredfunctions
(includingtheonethatpresentsJSONdataasarelationalta-
ble)isexpectedlater.
Miscellaneous
Theoidcolumninsystemcatalogtablesisnolongerhidden.
Thecolumnitselfisstillthere,andnowitwillbedisplayed
bySELECT*queries.Inanycase,usingtheoidtypeinyour
owntablesisnotrecommended.
Documentationreceiveditsfirstillustrations.Atthemoment,
therearejusttwoofthem:takealookatsections66.4“GIN
IndexesImplementation”and68.6“DatabasePageLayout.”
III Installation
and Quick Start
WhatisrequiredtogetstartedwithPostgreSQL?Inthischap-
ter,we’llexplainhowtoinstallandmanagePostgreSQLser-
vice,andthenshowhowtosetupasimpledatabaseand
createtablesinit. WewillalsocoverthebasicsoftheSQL
language,whichisusedtoqueryandmanipulatedata.It’sa
goodideatostarttryingSQLcommandswhileyouareread-
ingthischapter.
Wearegoingtousearegular(oftencalled“vanilla”)Post-
greSQL12distribution.Dependingonyouroperatingsystem,
PostgreSQLinstallationandsetupwilldiffer.Ifyouareusing
Windows,readon;forLinux-basedDebianorUbuntusystems,
gotop.29.
For other operating systems, you can view installation in-
structionsonline:www.postgresql.org/download.
YoucanjustaswellusePostgresProStandard12distribu-
tion:itisfullycompatiblewithvanillaPostgreSQL,includes
someadditionalfeaturesdevelopedbythePostgresProfes-
sionalcompany,andisfreewhenusedfortrialoreducational
purposes.Inthiscase,checkoutinstallationinstructionsat
postgrespro.com/products/download.
24 Windows
iii
Installation
DownloadthePostgreSQLinstallerfromourwebsite,launch
it, and select the installation language: postgrespro.com/
windows.
Theinstallerprovidesaconventionalwizardinterface: you
cansimplykeepclickingthe“Next”buttonifyouarefinewith
thedefaultoptions.Let’sexaminethemainsteps.
Choosecomponents:
Keepalloptionsselectedifyouareuncertainwhichonesto 25
choose. iii
ThenyouhavetospecifyPostgreSQLinstallationdirectory.
Bydefault,PostgreSQLserverisinstalledintoC:\Program
Files\PostgreSQL\12.
Youcanalsospecifythelocationofthedatadirectory.
This directory will hold all the information stored in your
databasesystem,somakesureyouhaveenoughdiskspace
ifyouareplanningtokeepalotofdata.
26 Serveroptions:
iii
Ifyouareplanningtostoreyourdatainalanguageother
thanEnglish,makesuretochoosethecorrespondinglocale
(orleavethe“Default”option,ifyourWindowslocalesettings
areconfiguredappropriately).
Enterandconfirmthepasswordforthepostgresdatabase
user(i.e., thedatabasesuperuser). Youshouldalsoselect
the“Setupenvironmentvariables”checkboxtoconnectto
PostgreSQLserveronbehalfofthecurrentOSuser.
Youcanleavethedefaultsettingsinalltheotherfields.
27
iii
If you are planning to install PostgreSQL for educational
purposesonly,youcanselectthe“Usethedefaultsettings”
optionforthedatabasesystemtotakeuplessRAM.
ManagingtheServiceandtheMainFiles
WhenPostgreSQLisinstalled,the“postgresql-12”serviceis
registered in your system. This service is launched auto-
maticallyatthesystemstartupundertheNetworkService
account.Ifrequired,youcanchangetheservicesettingsus-
ingthestandardWindowsoptions.
28 To temporarily stop the
iii service, run the “Stop
Server”programfromthe
Startmenusubfolderthat
you have selected at in-
stallationtime.
To start the service, run
the“StartServer”program
fromthesamefolder.
If an error occurs at the service startup, you can view
the server log to find out its cause. The log file is lo-
cated in the log subdirectory of the database directory
chosen at installation time (typically, it is C:\Program
Files\PostgreSQL\12\data\log). Logging is regularly
switchedtoanewfile. Youcanfindtherequiredfileeither
bythelastmodifieddate,orbythefilenamethatincludes
thedateandtimeoftheswitchovertothisfile.
Thereareseveralimportantconfigurationfilesthatdefine
serversettings. Theyarelocatedinthedatabasedirectory.
ThereisnoneedtomodifythemtogetstartedwithPost-
greSQL,butyou’lldefinitelyneedtheminrealwork:
• postgresql.confisthemainconfigurationfilethatcon-
tainsserverparameters.
• pg_hba.confdefinesaccessrules. Forsecurityreasons,
thedefaultconfigurationonlyallowsaccessfromthelo-
calsystem,anditmustbeconfirmedbyapassword.
Takealookatthesefiles,theyarefullydocumented.
Nowwearereadytoconnecttothedatabaseandtryout 29
some commands and SQL queries. Go to the “Trying SQL” iii
chapteronp.33.
DebianandUbuntu
Installation
IfyouareusingLinux,youneedtoaddPGDG(PostgreSQL
GlobalDevelopmentGroup)packagerepository. Atthemo-
ment,thesupportedDebianversionsare8“Jessie”,9“Stretch”,
and10“Buster”.ForUbuntu,16.04“Xenial”and18.04“Bionic”
versionsaresupported.
Runthefollowingcommandsintheconsolewindow:
$ sudo apt-get install lsb-release
$ sudo sh -c 'echo "deb \
http://apt.postgresql.org/pub/repos/apt/ \
$(lsb_release -cs)-pgdg main" \
> /etc/apt/sources.list.d/pgdg.list'
$ wget --quiet -O - \
https://www.postgresql.org/media/keys/ACCC4CF8.asc \
| sudo apt-key add -
Oncetherepositoryisadded, let’supdatethelistofpack-
ages:
$ sudo apt-get update
Beforestartingtheinstallation,checklocalizationsettings:
$ locale
30 IfyouplantostoredatainalanguageotherthanEnglish,
iii theLC_CTYPEandLC_COLLATEvariablesmustbesetappro-
priately.Forexample,fortheFrenchlanguage,makesureto
setthesevariablesto“fr_FR.UTF8”:
$ export LC_CTYPE=fr_FR.UTF8
$ export LC_COLLATE=fr_FR.UTF8
Youshouldalsomakesurethattheoperatingsystemhasthe
requiredlocaleinstalled:
$ locale -a | grep fr_FR
fr_FR.utf8
Ifit’snotthecase,generatethelocale,asfollows:
$ sudo locale-gen fr_FR.utf8
Nowwecanstarttheinstallation:
$ sudo apt-get install postgresql-12
Oncetheinstallationcommandcompletes,PostgreSQLwill
beinstalledandlaunched.Tocheckthattheserverisready
touse,run:
$ sudo -u postgres psql -c 'select now()'
Ifallwentwell,thecurrenttimeisreturned.
ManagingtheServiceandtheMainFiles 31
iii
WhenPostgreSQLisinstalled,aspecialpostgresuseriscre-
atedautomaticallyonyoursystem.Alltheserverprocesses
workonbehalfofthisuser.Alldatabasefilesbelongtothis
useraswell.PostgreSQLwillbestartedautomaticallyatthe
operatingsystemboot. It’snotaproblemwiththedefault
settings:ifyouarenotworkingwiththedatabaseserver,it
consumesverylittleofsystemresources.Ifyoustilldecide
toturnofftheautostart,run:
$ sudo systemctl disable postgresql
Totemporarilystopthedatabaseserverservice,enter:
$ sudo systemctl stop postgresql
Youcanlaunchtheserverserviceasfollows:
$ sudo systemctl start postgresql
Youcanalsocheckthecurrentstateoftheservice:
$ sudo systemctl status postgresql
Iftheservicecannotstart,usetheserverlogtotroubleshoot
this issue. Take a closer look at the latest log entries in
/var/log/postgresql/postgresql-12-main.log.
All information stored in the database is located in the
/var/lib/postgresql/12/main/directory.Ifyouaregoing
tostorealotofdata,makesurethatyouhaveenoughdisk
space.
32 Thereareseveralconfigurationfilesthatdefineserverset-
iii tings.There’snoneedtoconfigurethemtogetstarted,but
it’sworthcheckingthemoutsinceyou’lldefinitelyneedthem
inthefuture:
• /etc/postgresql/12/main/postgresql.conf is the
mainconfigurationfilethatcontainsserverparameters.
• /etc/postgresql/12/main/pg_hba.conf file defines
access settings. For security reasons, the default con-
figurationonlyallowsaccessfromthelocalsystemon
behalfofthedatabaseuserthathasthesamenameas
thecurrentOSuser.
Nowit’stimetoconnecttothedatabaseandtryoutSQL.
IV Trying SQL
Connectingviapsql
Toconnecttothedatabaseserverandstartexecutingcom-
mands,youneedtohaveaclientapplication. Inthe“Post-
greSQLforApplications”chapter,wewilltalkaboutsending
queriesfromapplicationswrittenindifferentprogramming
languages.Andherewe’llexplainhowtoworkwiththepsql
clientfromthecommandlineintheinteractivemode.
Unfortunately, manypeoplearenotveryfondofthecom-
mandlinenowadays.Whydoesitmakesensetolearnhow
toworkinit?
Firstofall,psqlisastandardclientapplicationincludedinto
allPostgreSQLpackages,soit’salwaysavailable. Nodoubt,
it’sgoodtohaveacustomizedenvironment,butthereisno
needtogetlostonanunknownsystem.
Secondly,psqlisreallyconvenientforeverydayDBAtasks,
writingsmallqueries,andautomatingprocesses.Forexam-
ple,youcanuseittoperiodicallydeployapplicationcode
updatesonyourdatabaseserver. Thepsqlclientprovides
itsowncommandsthatcanhelpyoufindyourwayaround
thedatabaseobjectsanddisplaythedatastoredintablesin
aconvenientformat.
34 However,ifyouareusedtoworkingingraphicaluserinter-
iv faces,trypgAdmin(we’llgetbacktoitlater)orothersimi-
larproducts:wiki.postgresql.org/wiki/Community_Guide_to_
PostgreSQL_GUI_Tools.
TostartpsqlonaLinuxsystem,runthiscommand:
$ sudo -u postgres psql
On Windows, open the
Start menu and launch
the“SQLShell(psql)”pro-
gram.
When prompted, enter
the password for the
postgresuserthatyou
setwheninstallingPost-
greSQL.
Windowsusersmayrun
into encoding issues
whenviewingnon-Latin
characters in the termi-
nal. Ifthatisthecase, makesurethataTrueTypefontis
selectedinthepropertiesoftheterminalwindow(typically,
“LucidaConsole”or“Consolas”).
Asaresult,youshouldseethesamepromptonbothoper-
atingsystems:postgres=#.Inthisprompt,“postgres”isthe
nameofthedatabasetowhichyouareconnectedrightnow.
AsinglePostgreSQLservercanserveseveraldatabases,but
youcanworkonlywithoneofthematatime.
Inthesectionsbelow,we’llprovidesomecommand-lineex-
amples. Enter only the part printed in bold; the prompt
andthesystemresponseareprovidedsolelyforyourcon- 35
venience. iv
Databases
Let’screateanewdatabasecalledtest:
postgres=# CREATE DATABASE test;
CREATE DATABASE
Don’tforgettouseasemicolonattheendofthecommand:
PostgreSQLexpectsyoutocontinuetypinguntilyouenter
this symbol, so you can split the command over multiple
lines.
Nowlet’sconnecttothecreateddatabase:
postgres=# \c test
You are now connected to database "test" as user
"postgres".
test=#
As you can see, the command prompt has changed to
test=#.
Thecommandthatwe’vejustentereddoesnotlooklikeSQL,
asitstartswithabackslash.Thisisaconventionforspecial
commandsthatcanonlybeusedinpsql(soifyouareus-
ingpgAdminoranotherGUItool,skipallcommandsstarting
withabackslash,ortrytofindanequivalent).
Therearequiteafewpsqlcommands,andwe’llusesomeof
themabitlater.
36 To get the full list of psql commands right now, you can
iv run:
test=# \?
Sincethereferenceinformationisquitebulky,itwillbedis-
playedinapagerprogramofyouroperatingsystem,which
isusuallymoreorless.
Tables
Relationaldatabasemanagementsystemspresentdataas
tables. The heading of the table defines its columns; the
dataitselfisstoredintablerows.Thedataisnotordered(so
therowsarenotnecessarilystoredinthesameorderthey
wereaddedtothetable).
Foreachcolumn, adatatypeisdefined. Allthevaluesin
thecorrespondingrowfieldsmustconformtothistype.You
canusemultiplebuilt-indatatypesprovidedbyPostgreSQL
(postgrespro.com/doc/datatype.html),oraddyourowncus-
tomtypes,butherewe’llcoverjustafewmainones:
• integer
• text