    0x040d1400   LTE_RRC_STOPPED_INDI
    0x040d140b   LTE_RRC_NOT_CAMPED_INDI
    0x040d1402   LTE_RRC_SIB_UPDATED_INDI
下图为MDM9607 4G LTE_RRC的状态机图谱
#### 状态机操作实例
为了更直观的理解消息状态机的操作过程，我这里提供了一个例子来展示消息传递过程以及状态机的处理过程，这个过程是在基带处于IDLE状态下，没有接入任何移动通信网络，到基带一次接入4G
LTE网络到SIM认证的过程，这里只提供RRC的状态机的处理过程。
发送端 | 接受端 | 接受UMID号 | 处理状态机 | 描述信息 |  
---|---|---|---|---|---  
0xF19 emm | LTE_RRC | 0x40d0204 | LTE_RRC_CSP_SM | LTE_RRC_SERVICE_REQ |  
0xF19 emm | LTE_RRC | 0x40d0204 | LTE_RRC_IRAT_FROM_W_MGR_SM |
LTE_RRC_SERVICE_REQ |  
0xF19 emm | LTE_RRC | 0x40d0204 | LTE_RRC_IRAT_FROM_G_MGR_SM |
LTE_RRC_SERVICE_REQ |  
0xF19 emm | LTE_RRC | 0x40d0204 | LTE_RRC_IRAT_FROM_TDS_MGR_SM |
LTE_RRC_SERVICE_REQ |  
0x40d LTE_RRC | LTE_RRC | 0x40d1442 | LTE_RRC_MEAS_SM |
LTE_RRC_CLEAR_DEPRI_FREQ_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d120d | LTE_RRC_CONTROLLER_SM |
LTE_RRC_MODE_CHANGE_REQI |  
0x40f LTE_MAC | LTE_RRC | 0x40f0803 | LTE_RRC_CONTROLLER_SM |
LTE_MAC_START_CNF |  
0x412 LTE_RLCUL | LTE_RRC | 0x4120801 | LTE_RRC_CONTROLLER_SM |
LTE_RLCUL_START_CNF |  
0x411 LTE_RLCDL | LTE_RRC | 0x4110801 | LTE_RRC_CONTROLLER_SM |
LTE_RLCDL_START_CNF |  
0x413 LTE_PDCPDL | LTE_RRC | 0x4130806 | LTE_RRC_CONTROLLER_SM |
LTE_PDCPDL_START_CNF |  
0x414 LTE_PDCPUL | LTE_RRC | 0x4140807 | LTE_RRC_CONTROLLER_SM |
LTE_PDCPUL_START_CNF |  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0801 | LTE_RRC_CONTROLLER_SM |
LTE_CPHY_START_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1513 | LTE_RRC_CSP_SM |
LTE_RRC_MODE_CHANGE_CNFI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1206 | LTE_RRC_LLC_SM | LTE_RRC_CFG_REQI |  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0809 | LTE_RRC_CSP_SM |
LTE_CPHY_SYSTEM_SCAN_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1206 | LTE_RRC_LLC_SM | LTE_RRC_CFG_REQI |  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0800 | LTE_RRC_CSP_SM | LTE_CPHY_ACQ_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1202 | LTE_RRC_SIB_SM | LTE_RRC_GET_SIBS_REQI |  
0x403 LTE_ML1_DLM | LTE_RRC | 0x40c0402 | LTE_RRC_SIB_SM | LTE_CPHY_MIB_IND |  
0x40F LTE_MAC | LTE_RRC | 0x40f0406 | LTE_RRC_SIB_SM |
LTE_MAC_RRC_BCCH_DL_DATA_IND | BCCH DL SCH SIB1  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0823 | LTE_RRC_SIB_SM |
LTE_CPHY_TDD_CFG_CNF |  
0x40F LTE_MAC | LTE_RRC | 0x40f0406 | LTE_RRC_SIB_SM |
LTE_MAC_RRC_BCCH_DL_DATA_IND | BCCH DL SCH SI  
0x40d LTE_RRC | LTE_RRC | 0x40d1514 | LTE_RRC_CSP_SM | LTE_RRC_GET_SIBS_CNFI |  
0x40F LTE_MAC | LTE_RRC | 0x40f0406 | LTE_RRC_SIB_SM |
LTE_MAC_RRC_BCCH_DL_DATA_IND | BCCH DL SCH SIB1  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c080a | LTE_RRC_CSP_SM |
LTE_CPHY_CELL_SELECT_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1206 | LTE_RRC_LLC_SM | LTE_RRC_CFG_REQI |  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0804 | LTE_RRC_LLC_SM |
LTE_CPHY_COMMON_CFG_CNF |  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0805 | LTE_RRC_LLC_SM |
LTE_CPHY_DEDICATED_CFG_CNF |  
0x40f LTE_MAC | LTE_RRC | 0x40f0801 | LTE_RRC_LLC_SM | LTE_MAC_CFG_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1516 | LTE_RRC_CSP_SM | LTE_RRC_CFG_CNFI |  
0x40d LTE_RRC | LTE_RRC | 0x40d140c | LTE_RRC_SIB_SM | LTE_RRC_CAMPED_INDI |
inactive  
0x40d LTE_RRC | LTE_RRC | 0x40d140c | LTE_RRC_SIB_SM | LTE_RRC_CAMPED_INDI |
active  
0x40d LTE_RRC | LTE_RRC | 0x40d140c | LTE_RRC_MEAS_SM | LTE_RRC_CAMPED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d140c | LTE_RRC_CAPABILITIES_SM |
LTE_RRC_CAMPED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d140c | LTE_RRC_CEP_SM | LTE_RRC_CAMPED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d140c | LTE_RRC_MISC_SM | LTE_RRC_CAMPED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1516 | LTE_RRC_CONTROLLER_SM | LTE_RRC_CFG_CNFI
|  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_CSP_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_CEP_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_PAGING_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_MEAS_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_CSG_ASF_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_IRAT_TO_G_MGR_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1402 | LTE_RRC_IRAT_TO_TDS_MGR_SM |
LTE_RRC_SIB_UPDATED_INDI |  
0x40d LTE_RRC | LTE_RRC | 0x40D0401 | LTE_RRC_CSG_ASF_SM | LTE_RRC_SERVICE_IND
|  
0x40d LTE_RRC | LTE_RRC | 0x40D0401 | LTE_RRC_PAGING_SM | LTE_RRC_SERVICE_IND
|  
0x40c LTE_ML1_MGR | LTE_RRC | 0x40c0815 | LTE_RRC_MEAS_SM |
LTE_CPHY_IDLE_MEAS_CFG_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d0225 | LTE_RRC_CSP_SM | LTE_RRC_AVOIDANCE_REQ |  
0x40F LTE_MAC | LTE_RRC | 0x40f0406 | LTE_RRC_SIB_SM |
LTE_MAC_RRC_BCCH_DL_DATA_IND | SI  
0x40d LTE_RRC | LTE_RRC | 0x40d1437 | LTE_RRC_CSP_SM |
LTE_RRC_INTERFREQ_LIST_UPDATE_INDI |  
0xf19 EMM | LTE_RRC | 0x40d0200 | LTE_RRC_CEP_SM | LTE_RRC_CONN_EST_REQ |
Attach Request NAS msg  
0x40d LTE_RRC | LTE_RRC | 0x40D1404 | LTE_RRC_CONTROLLER_SM |
LTE_RRC_CONN_ESTABLISHMENT_STARTED_INDI | RRC Connection Request  
0x40d LTE_RRC | LTE_RRC | 0x40D143d | LTE_RRC_CONTROLLER_SM |
LTE_RRC_TRM_PRIORITY_CHANGE_INDI |  
0xF19 EMM | LTE_RRC | 0x40d0206 | LTE_RRC_CONTROLLER_SM |
LTE_RRC_SIM_UPDATE_REQ |  
0xF19 EMM | LTE_RRC | 0x40d0206 | LTE_RRC_PAGING_SM | LTE_RRC_SIM_UPDATE_REQ |  
0xF19 EMM | LTE_RRC | 0x40d0206 | LTE_RRC_SEC_SM | LTE_RRC_SIM_UPDATE_REQ |
SIM Update Req received from NAS  
0xF19 EMM | LTE_RRC | 0x40d0206 | LTE_RRC_CAPABILITIES_SM |
LTE_RRC_SIM_UPDATE_REQ |  
0x404 LTE_ML1_ULM | LTE_RRC | 0x40c0421 | LTE_RRC_CEP_SM |
LTE_CPHY_RACH_MSG1_SCHED_IND | LTE MAC RACH Attempt  
0x40f LTE_MAC | LTE_RRC | 0x40f0800 | LTE_RRC_CEP_SM | LTE_MAC_ACCESS_CNF |  
0x40f LTE_MAC | LTE_RRC | 0x40f0405 | LTE_RRC_MH_SM |
LTE_MAC_RRC_CCCH_DL_DATA_IND | CCCH RRC Connection Setup  
0x40d LTE_RRC | LTE_RRC | 0x40d0703 | LTE_RRC_CEP_SM |
LTE_RRC_RRC_CONNECTION_SETUP_DLM | CCCH RRC Connection Setup  
0x40d LTE_RRC | LTE_RRC | 0x40d1206 | LTE_RRC_LLC_SM | LTE_RRC_CFG_REQI |  
0x40d LTE_RRC | LTE_RRC | 0x40D1408 | LTE_RRC_CSP_SM |
LTE_RRC_PROCEED_WITH_RESEL_INDI |  
0x411 LTE_RLCDL | LTE_RRC | 0x4110800 | LTE_RRC_LLC_SM | LTE_RLCDL_CFG_CNF |  
0x412 LTE_RLCUL | LTE_RRC | 0x4120800 | LTE_RRC_LLC_SM | LTE_RLCUL_CFG_CNF |  
0x413 LTE_PDCPDL | LTE_RRC | 0x4130800 | LTE_RRC_LLC_SM | LTE_PDCPDL_CFG_CNF |  
0x414 LTE_PDCPUL | LTE_RRC | 0x4140800 | LTE_RRC_LLC_SM | LTE_PDCPUL_CFG_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1516 | LTE_RRC_CEP_SM | LTE_RRC_CFG_CNFI |  
0x40d LTE_RRC | LTE_RRC | 0x40d1200 | LTE_RRC_MH_SM | LTE_RRC_SEND_UL_MSG_REQI
|  
0x40d LTE_RRC | LTE_RRC | 0x40d1405 | LTE_RRC_SIB_SM | LTE_RRC_CONNECTED_INDI
|  
|  |  |  |  |  
0x414 LTE_PDCPUL | LTE_RRC | 0x4140802 | LTE_RRC_MH_SM | LTE_PDCPUL_SDU_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1504 | LTE_RRC_CEP_SM |
LTE_RRC_RRC_CONNECTION_SETUP_COMPLETE_CNFI | UL_DCCH RRC connection Setup
Complete  
0x413 LTE_PDCPDL | LTE_RRC | 0x4130400 | LTE_RRC_MH_SM | LTE_PDCPDL_SDU_IND |
DL_DCCH info Transfer  
0x40d LTE_RRC | LTE_RRC | 0x40d0705 | LTE_RRC_DT_SM |
LTE_RRC_DL_INFORMATION_TRANSFER_DLM | DL_DCCH Auth Request Msg recvd  
0x40d LTE_RRC | LTE_RRC | 0x40d141f | LTE_RRC_MH_SM |
LTE_RRC_DLM_PROCESSED_INDI |  
0xF19 EMM | LTE_RRC | 0x40d0201 | LTE_RRC_DT_SM | LTE_RRC_UL_DATA_REQ | send
Auth Resp data  
0x40d LTE_RRC | LTE_RRC | 0x40d1200 | LTE_RRC_MH_SM | LTE_RRC_SEND_UL_MSG_REQI
| UL_DCCH ULinfo Transfer send NAS Auth resp  
0x414 LTE_PDCPUL | LTE_RRC | 0x4140802 | LTE_RRC_MH_SM | LTE_PDCPUL_SDU_CNF |  
0x40d LTE_RRC | LTE_RRC | 0x40d1509 | LTE_RRC_DT_SM |
LTE_RRC_UL_INFORMATION_TRANSFER_CNFI |  
DL_DCCH的Information Transfer字段里面包含了来自MME发送过来的认证请求数据(LTE NAS EMM信令消息id
0x52)，包含有nas key set id, 16个字节的认证随机数据auth_param rand，以及16个字节的auth param
AUTN数据，SIM卡通过收到的这两个关键信息进行认证， 并计算生成Auth_resp发送给MME进行比较完成本地端和服务器端的认证，本地端计算如下。
本地端收到的rand(16bytes)+AUTN(16bytes)  
K为sim卡和MME都持有的sim卡的唯一隐私数据，sim卡端只有sim卡芯片可以读取。
SIM卡端密钥派生认证过程，f1/2/3/4/5为sim卡的计算功能函数
AK=f5(K,rand)  
IK=f4(K,rand)  
CK=f3(K,rand)  
RES=f2(K,rand) //计算给MME进行认证SIM卡的数据
SQN=AUTN^AK (6bytes)  
AMF=AUTN[6:8]
MAC=f1(K,SQN,rand,AMF)
SIM卡端认证MME端过程  
sim_autn=SQN^AK(6bytes)+AMF(2bytes)+MAC(8bytes)  
比较MME发过来的AUTN和sim_autn ，相等则认为MME合法。
基带把sim卡计算得到的RES通过LTE NAS EMM
信令消息号0x53包裹到UL_DCCH的InformationTransfer字段里面发给基站进而到MME进行认证。
MME认证SIM卡的过程就比较简单了， MME端计算XRES=f2(K,rand)，然后比较收到的RES，相等表示MME认证SIM卡成功，至此认证完成。
由于上述操作涉及EMM和RRC之间的交互过程比较复杂，这里只是简单提一下，EMM的状态机会在下一篇文章里面单独详细介绍。
## 结语
由于从全球公开的信息渠道中并不能获取高通基带系统的深入信息，所以花费1年多的时间通过对底层操作系统和上层3GPP实现的业务系统进行深度逆向工程，这篇文章只是系统性的介绍了高通4/5G基带系统的消息机制和消息状态机，我认为这是一个关键的架构设计，梳理清楚其消息架构对于理解3GPP实现的消息原语操作以及对移动通信技术的多模分层设计有非常大的帮助，该消息系统架构设计具有非常好的扩展性，可以很灵活的增加新的功能到该消息框架中去，可以很好的减少系统测试成本，有很多设计理念值得学习和借鉴，由于现今高通5G基带所支持的UMID操作数高达2万多个，所以这里的展示的例子只是揭示了状态机功能操作的冰山一角，后续会持续研究对于状态机安全漏洞的挖掘研究，实现高效的5G安全测试体系，通过对基带系统的深刻认知，可以更好的对基站系统和核心网系统进行安全评估。
最后行文仓促，如有错误，欢迎反馈指正，预告下一章节将会介绍高通基带系统的A2/IPA硬件IP加速功能模块。
* * *