PDG
---
## Page 337
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
web1上进行。首先对共享磁盘进行分区，操作如下：
个节点，接下来将进行磁盘分区、格式化、创建文件系统等操作。
12.5.5配置存储集群GFS
RHCS集群系统，Web界面可只作为配置cluster.conf文件所用。
供的Web界面虽然比较直观，但目前还不是很稳定，这里建议通过命令方式来查看和管理
节点的运行状态。
点优先级完全吻合。
节点上，而mysqlserver服务运行在Mysqll节点上，这和配置FailoverDomain时指定的节
在前面的内容中，已经通过storgae-server主机将一个磁盘分区共享给了集群系统的4
了解RHCS系统中每个节点的运行状态，对集群的维护和问题的排查至关重要。Luci提
还可以通过cluster-s、cluster-m等方式单独查看一个服务或一个
Command action
Command （m for
[root@web1~]#fdisk/dev/sdb
可以在集群系统任意节点上对共享磁盘分区进行磁盘的分区和格式化，：
1.对磁盘进行分区
由这个输出可知，集群4个节点均处于Online状态，同时webserver服务运行在webl
Service Name
Current State
.......
Service
Last Transition
Last
Owner
Flags
Current State
Last Transition
Last Owner
Owner
web1
Mysq12
Mysql1
web2
Member Name ID
extended
Owner
help）:n
Status
Thu Aug 19 02:59:07 2010
none
web1
none（o）
started (112)
service:webserver
Thu Aug 19 04:12:132010
none
Mysql1
started (112)
service:mysqlserver
Online,
Online,rgmanager
Online,rgmanager
Online, rgmanager
Information
-----
Linuxidc.com
Local,rgmanager
这里选择在节点
---
## Page 338
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
The partition table has been altered!
/dev/sdb7
dev/sdb6
dev/sdb5
/dev/sdb1
Disk /dev/sdb:10.7 GB,10737418240 bytes
Command (m for help):p
Using default
Jsing default
First cylinder
Command
Last cylinder or
Jsing
irst
Command
Last cylinder
Using default
First
Command （m for help):
Using default
Last cylinder
Using default value 1
First cylinder (1-10240,default 1):
Partition number (1-4):1
Device
heads,
pprimary partition (1-4)
primary
default value 4770
logical
cylinder
primary
logica1
action
cylinder (1-10240, default 1):
action
(m for
(m
primary
Boot
acti
32 sectors/track,10240 cy1inders
www.Linuxidc.com
for
value10240
or +size or
value 8586
or
value 1
help):n
partition (1-4)
help）:n
partition (1-4)
value 10240
(8586-10240,default 8586):
partition (1-4)
(5
(4770-10240.default 4770):
（5or over)
(5 or over)
or
or over)
+8ize or +8izeM or +8izeK (4770-10240, default 10240):+4G
+size or +sizeM or +sizeK （1-10240,default 10240):+5G
+size or +sizeM or +sizeK（1-10240,default 10240);
8586
477
Start
n
r+sizeM or +sizeK(8586-10240,default 10240):
10240
8585
4769
10240
End
1694704
3907568
4883424
10485744
Blocks
83
W
PI
Linux
Linux
Linux
Extended
System
323
PDG
---
## Page 339
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
作，半
用于ext3文件系统，而将/dev/sdb7用于表决磁盘。表决磁盘将在后面进行讲述。
/sbin/mount.gfs2: parse_opts:e
/sbin/mount.gfs2: parse_opts: opts ="rw
/sbin/mount.gfs2:mount /dev/sdb5/gfs2
-5/sqp/p/zg6-uo#[~qmoox]
将共享文件系统挂载到/gfs2目录下。
所有节点重新启动后，
3.挂载磁盘
所有操作完成后，重启集群所有节点，保证划分的磁盘分区能够被所有节点识别。
口/dev/sdb5，指定要格式化的分区设备标识。
令在使用中动态调整。
口-j4，设定GFS2文件系统最多支持多少个节点同时挂载，这个值可以通gfs2_jadd命
必须与cluster.conf文件中Cluster标签的name值相同。
口-tmycluster:my-gfs2，指定DLM锁所在的表名称，mycluster就是RHCS集群的名称，
区时就会像ext3格式一样，两个系统的信息不能同步。
口-plock_dlm，定义为DLM锁方式，如果没有此参数，
其中参数含义如下：
UUID:
Lock Table:
Journals:
Filesystem Size:
Device Size
Blocksize:
Are you sure you want to proceed? [y/n]y
[root@web1~]#mkfs.ext3/dev/sdb6
接下来，在web1节点上将磁盘分区分别格式化为ext3和gfs2文件系统。操作如下：
2.格式化磁盘
这里将共享磁盘分为3个有效分区，分别将/dev/sdb5用于GFS文件系统，将/dev/sdb6
Syncing disks.
Device:
It appears to contain a gfs2 filesysten
www.Linuxidc.com
集群高级应用篇
clear flag 1 for "rw",
就可以挂载文件系统了，依次在集群的每个节点上执行如下操
F5207D5D-88AE-6E6D-DB44-438BCF204353
"mycluster:my-gfs2"
"lock_dlm"
9
4.66 GB （1220854 b1ocks)
4096
extra="
/dev/sdbs
，flags=0
当在两个系统中同时挂载此分
唐
PDG
---
## Page 340
inux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
点，整个集群系统也能正常运行。表决磁盘就是为完成此功能而存在的。
进行投票，通过这种方式可以始终保证集群投票数过半，即使集群系统中只存在一个健康节
剔除，由于节点脱离了集群系统，因此也就失去了投票的权利，然后继续由剩余的健康节点
就无法激活。针对这种情况，可采取一种方法：当某个节点失败后，将此节点从集群系统中
点的集群中，如果失败节点超过两个，集群投票数将无法大于集群节点数的一半，那么集群
一个完全民主的集群环境中，只有超过半数的投票才能决定集群的行为。例如，在一个6节
要通过表决磁盘来实现。
将无法使用。这种情况的出现，对高可用的集群系统来说是绝对不允许的。解决这种问题就
系统，那么只要有一个节点发生故障，所有节点挂载的GFS文件系统将挂起，此时共享存储
发生故障，整个集群系统将会挂起，集群服务也随之停止。而如果配置了存储集群GFS文件
到其他节点上。但是这种转移是有条件的，例如，在一个4节点的集群中，一且有两个节点
12.5.6
文件中。
为了能让共享文件系统开机自动挂载磁盘，
排查。
集群系统是基于成员的，
2.表决磁盘的运行机制
在一个多节点的RHCS集群系统中，
1.使用表决磁盘的必要性
/dev/sdb5
#GFS
/sbin/mount.gfs2:read_proc_mounts:opts="rw,hostdata=jid=3:id=65540:first=0"
sbin/mount.gfs2:
sbin/mount.gfs2:
sbin/mount.gfs2:
sbin/mount.gfa2:
sbin/mount.gfs2:
sbin/mount.gfs2:
sbin/mount.gfs2:
sbin/mount.gfs2:
sbin/mount.gfs2:
/sbin/mount.gfs2:parse_opts:hostdata = "
配置表决磁盘
MOUNT POINTS
Www.Linuxidc.com
/gfs2
lock_dlm_mount_result:write "mount_result /gfs2 gfs2 0"
mount（2)
lock_dlm_join:extra_plus:"hostdata=jid=3:id=65540:first=0
1ock_dlm_join:
message from gfs_controld:mount options:
lock_dlm_join:
message from gfs_controld: response to join request:
，它具有民主特征并可以通过投票来决定集群的行为。因此，
ok
locktable=
gfs2
lockproto =
：hostdata:*hostdata=jid=3:id=65540:first=0*
一个节点失败后，集群的服务和资源可以自动转移
read "hostdata-jid-3:id=65540:first=0"
device
defaults
，将下面内容添加到每个集群节点的/etc/fstab
"/dev/sdb5"
1
群325
在
---
## Page 341
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
qdisk分区。下面创建一个qdisk分区：
认为此节点失败，进而试图重启此节点，以使节点进人正常状态。
定位节点状态，常用的有ping网关或路由，或者通过脚本程序等。如果试探失败，qdiskd会
节点状态检测的精度，Heuristics就是这么一个扩充选项，它允许通过第三方应用程序来辅助
支持16个节点的RHCS高可用集群。
享磁盘的状态信息。mkqdisk操作只能创建16个节点的投票空间，因此目前qdisk最多可以
才允许其再次加人集群中。
在另一个节点B的qdiskd进程会请求节点A从集群系统中隔离，只有当节点A重新启动后
某个节点A上，如果qdiskd进程经过多次尝试都不能访问自己的共享磁盘分区，那么运行
盘分区中。同时qdiskd还可以查看其他节点的状态信息，并传递信息给其他节点。例如，在
qdiskd进程，集群节点定期评估自身的健康情况，并且把自身的状态信息写到指定的共享磁
态下，Quorum的值是每个节点投票值加上qdisk分区的投票值之和。
点数。和Quorum对应的是Quorate，Quorate是一种状态，表示达到法定节点数。在正常状
为了解决小规模集群中的投票问题，RHCS引入了Quorum机制，Quorum表示集群法定的节
有时候仅靠检测qdisk分区来判断节点状态还是不够的，还可以通过应用程序来扩展对
qdisk是一个小于10MB的共享磁盘分区。qdiskd进程运行在集群的所有节点上，通过
在前面内容中，已经划分了多个共享磁盘分区，这里将共享磁盘分区/dev/sdb7作为
4.创建一个表决磁盘
mkdisk是一个集群仲裁磁盘工具集，可以用来创建一个qdisk共享磁盘，也可以查看共
和qdisk相关的几个工具有mkdisk、
3.RHCS中表决磁盘的概念
表决磁盘，即QuorumDisk，在RHCS里简称qdisk，是基于磁盘的集群仲裁服务程序。
/dev/sdb7:
mkqdisk v0.6.0
Initializing status block for node 16...
：：
Initializing status block for node 2...
Initializing status block
mkqdisk v0.6.0
[root@web1 -]# mkqdisk-C/dev/sdb7-1myqdisk
Recorded Sector Size: 512
Kernel Sector Size:
Host:
Label:
Magic:
mkqdisk-L
for
a22
512
web1
Thu Aug 19 23:27:04 2010
myqdisk
eb7a62c2
node
data
'myqdisk'to/dev/sdb7.
on/dev/sdb7;proceed[N/y]?y
Heuristics,
PDG
---
## Page 342
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
网关的方式来扩展对节点状态的检测，单击“Apply”按钮，完成对qdisk的设置。
这里将qdisk的投票值设定为2，qdisk分区设置为共享磁盘/dev/sdb7，并且通过ping
口Interval：设定多长时间执行ping命令一次。
口Score：设定ping命令的投票值。
口PathtoProgram：配置第三方应用程序来扩展对节点状态检测的精度。这里配置的是
口Device：指定共享存储在节点中的设备名是什么。
口Label：qdisk分区对应的卷标名，也就是在创建qdisk时指定的“myqdisk”。这里建
口MinimumScore：指定最小投票值是多少。
口TKO：表示允许检查失败的次数。一个节点在TKO×Interval时间内如果还连接不上
口Votes：指定qdisk分区投票值是多少。
口Interval：表示间隔多长时间执行一次检查评估，单位是秒。
图12-29中每个选项的含义如下：
这里通过Conga的Web界面来配置qdisk。首先登录Luci，然后单击“Cluster”，在
ping命令。