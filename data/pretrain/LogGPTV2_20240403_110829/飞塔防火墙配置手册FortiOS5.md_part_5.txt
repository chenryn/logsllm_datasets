config firewall service custom
edit "TCP_6671" 服务对象名称
协议类型：
ICMP icmp类型和代码
set protocol TCP/UDP/SCTP ICMP6 icmp6类型和代码
IP IP协议号
TCP/UDP/SCTP tcp/udp/sctp
set check-reset-range default ICMP错误信息校验使用global参数
set comment '' 描述
set color 0 颜色，用于WEB页显示
set tcp-portrange 6671 TCP端口范围
unset udp-portrange UDP端口范围
unset sctp-portrange SCTP端口范围
set tcp-halfclose-timer 0 半关闭状态超时时间
Fortinet公司 46 / 118 www.fortinet.com.cn
set tcp-halfopen-timer 0 半连接状态超时时间
set tcp-timewait-timer 0 Time-waiter时间
set udp-idle-timer 0 UDP超时时间
set session-ttl 0 会话超时时间。
next
5.1.3. 时间表
5.1.3.1. 循环时间表
config firewall schedule recurring
edit "always" //默认
set day sunday monday tuesday wednesday thursday friday saturday
next
edit "worktime"
set day sunday monday tuesday wednesday thursday friday saturday
set end 18:00
set start 09:00
next
end
5.1.3.2. 单次时间表
config firewall schedule onetime
Fortinet公司 47 / 118 www.fortinet.com.cn
edit "testoneyear"
set end 00:00 2015/01/01
set start 00:00 2014/01/01
next
end
5.1.4. 虚拟 IP
5.1.4.1. 一对一 IP 地址映射
config firewall vip
edit "webserver"
set extip 202.0.0.167 // 映射给外部的ip地址，可以是范围
set extintf "port1"
set mappedip 192.168.0.168 //内部服务器实际的ip地址
next
end
5.1.4.2. 一对多端口转发映射
可以将以公网ip的地址，分别映射到不同的内网ip上:
公网ip 公网端口 内网ip 内网端口
11.1.1.1 80-------------------10.0.0.1 80
11.1.1.1 81-------------------10.0.0.2 81
11.1.1.1 1443-----------------10.0.0.3 443
Fortinet公司 48 / 118 www.fortinet.com.cn
例1：
config firewall vip
edit "web"
set extip 11.1.1.1 //映射给外部的ip地址
set extintf "port1"
set portforward enable //启用端口转发
set mappedip 10.0.0.1 //内部服务器实际的ip地址
set extport 80 //映射给外部的访问端口，可以是范围
set mappedport 80 //内部服务器实际的服务端口
next
end
config firewall vip
edit "web"
set extip 11.1.1.1
set extintf "port1"
set portforward enable
set mappedip 10.0.0.2
set extport 1080-1100 //端口范围
set mappedport 80-100 //端口范围
next
end
Fortinet公司 49 / 118 www.fortinet.com.cn
5.1.4.3. 虚拟 ip 地址组
config firewall vipgrp
edit "allweb"
set interface "port1"
set member "web" "webserver" //vip地址组成员
next
end
5.1.4.4. 命令参数
config firewall vip
edit "test" 对象名字
set id 0 ID序号
set comment '' 描述
set type static-nat 类型静态映射，或负责均衡
set extip 1.1.1.1 外部IP
set extintf "port2" 外部接口
set arp-reply enable 是否允许ARP应答
set nat-source-vip disable 只允许某些IP地址访问该VIP
set portforward enable 端口转发，进行端口映射
set gratuitous-arp-interval 0 为这个VIP发送免费arp，0为不发送
set color 0 颜色，用于WEB页显示
set mappedip 192.168.1.11 内部被映射的IP地址
set protocol tcp 协议类型TCP
set extport 80 外部端口
Fortinet公司 50 / 118 www.fortinet.com.cn
set mappedport 1080 内部端口
next
end
5.2. 防火墙策略
防火墙的策略按照从上网下的顺序执行，直到数据包匹配到策略为止。
（1）源ip，目的ip覆盖范围较小的放在范围较大的策略之前。
（2）匹配业务量较大的策略放在其他策略之前，减少策略匹配次数。
（3）策略尽可能的做到精确匹配，减少any,all等地址对象的使用。
5.2.1. 访问策略
1) WEB页面操作：
源接口：数据包进入的接口。
源地址：源IP地址。
目的接口：数据包流出的接口
目的IP：需要访问的目的ip.
时间表：可以通过时间对策略进行控制，默认选择always.
服务：允许访问目的地址的那些服务端口。
Fortinet公司 51 / 118 www.fortinet.com.cn
动作：accept, deny，ssl, ipsec等。
Enable NAT : 是否开启NAT.
2) CLI操作：
config firewall policy
edit 1193 //注意ID号不要重复，否则会覆盖原有配置。
set srcintf "port2" //源接口
set dstintf "port1" //目的接口
set srcaddr "11.133.16.*" //源IP
set dstaddr "11.156.77.7-8" //目的IP
set action accept //动作
set schedule "always" //时间表
set service "10080-10082" //服务
next
3) 克隆策略
如果要增加的新的策略与原有策略在一些参数上相同，则可直接克隆一个新的策略,然
后对其进行编辑。
Fortinet公司 52 / 118 www.fortinet.com.cn
5.2.2. SNAT 策略
Enable NAT有2个选项：
 Use Destination Interface Address: 当192.168.1.0/24网段需要通过port1口
进行访问的时候，会被NAT成接口port1 的ip地址。
 Use Dynamic IP Pool：将源地址翻译成地址池内的ip地址。
（1）定义策略对象，ippool：
（2）配置策略：
Fortinet公司 53 / 118 www.fortinet.com.cn
配置命令如下：
config firewall ippool
edit "natpool"
set endip 202.1.1.10
set startip 202.1.1.1
next
end
config firewall policy
edit 1
set srcintf "port2"
set dstintf "port1"
set srcaddr "office"
set dstaddr "all"
set action accept
set schedule "always"
set service "ANY"
set nat enable //开启NAT
set ippool enable //使用地址池
set poolname "natpool" //指定地址池名称
next
end
5.2.3. 虚拟 IP 策略(DNAT)
主要用于将内部的服务器映射到公网：
（1）定义VIP
参照5.1.4.
config firewall vip
edit "webserver"
Fortinet公司 54 / 118 www.fortinet.com.cn
set extip 202.0.0.167 // 映射给外部的ip地址，可以是范围
set extintf "port1"
set mappedip 192.168.0.168 //内部服务器实际的ip地址
next
end
（2）配置策略
目的地址：配置为定义好的VIP映射对象。
该策略允许从por1口进入的所有地址，访问202.0.0.167，防火墙接收到访问该地址
的数据包后，会根据vip映射的配置内容，将数据包的目的地址转换为192.168.0.168，
并发送给该服务器。
5.2.4. NAT 配置注意事项
防火墙策略做NAT的时候有2个选项，如下图所示，
1) use destintaion interface address:转换成策略中目的接口上所配置的ＩＰ地址.
如策略为 internal 到 wan 口的策略，internal 口地址为 192.168.1.1/24；wan 口地址为
202.0.0.1/24则所有从匹配该策略的数据包原地址被转换为 202.0.0.1。
如果internal口内有一台服务器192.168.1.100/24，被通过vip映射为202.0.0.100，并配
置了从 wan 到 internal 口的相关策略，则 192.168.1.100 主动访问外部网络的时候会被 NAT
Fortinet公司 55 / 118 www.fortinet.com.cn
成 202.0.0.100，而并不是 202.0.0.1. 因为 VIP 定义的时候与 wan 口关联，被优先选作
192.168.1.100外出访问的转换地址。
2) use Dynamic ip Pool.使用动态地址池作为NAT之用
可以在vip页面中定义地址池，该选项使策略会优先使用地址池内定义的地址．
在转换时按如下优先顺序工作：动态地址池＞vip映射＞外网口地址
5.2.5. CLI 批量添加策略
直接双击策略条目，进行编辑，与新建操作方法相同。
如下主要介绍如何进行批量的策略编辑。
1) 通过命令行对策略进行编辑保存为文本文件，如policy.txt的
2) 选择如下菜单： 从….执行脚本
3) 点击“选择文件“按钮，选择配置脚本文件，并应用。
5.2.6. VOIP 策略
对于所有VOIP业务，需要使用UTM功能内的VOIP profile 来实现ALG功能。
（1） 单独为voip业务建立一条新策略。
config firewall policy
edit 100 //新的策略ID，不要与现有策略重复
Fortinet公司 56 / 118 www.fortinet.com.cn
set srcintf "port1" //源接口
set dstintf "port2" //目的接口
set srcaddr "all" // 源地址
set dstaddr "voipserver" //voip服务器ip地址
set action accept
set schedule "always"
set service "ANY" // 根据需要配置
set utm-status enable //开启utm功能
set voip-profile "default" // 开启voip脚本
set profile-protocol-options "default" // 协议选项
next
end
其他参数根据实际网络情况配置。
（2） 将该策略移动到合适的位置，确保其可以被执行。 如下是将策略 100 移动到策略
11前面。
config firewall policy
move 100 before 11
end
5.3. 流量控制
飞塔的流量控制功能是基于策略实现的，即对匹配该策略的所有流量进行流控，通过策
略来对用户分组，不同的策略中配置不同的流控脚本。
5.3.1. 基本配置
打开防火墙策略配置页面，可以看到配置页面下部的流量控制选项：
Fortinet公司 57 / 118 www.fortinet.com.cn
流量控制： 是否对该策略使用流量控制功能。
共享流量控制：
匹配该策略的所有的 IP 共享的流量，该流量是指匹配该策略的所有会话内的上行和下
行流量总和。
反向流量控制：
如果希望上行和下行单独控制，则可以使用该功能。
上图中策略的方向为internal-wan口。 如果开启反向流量控制，那么：
共享流量控制针对从internal-wan方向的流量控制： 5M，
反向流量控制针对从wan-internal方向的流量控制： 10M。
针对每个ip的流量控制
匹配该策略的每个ip的流量控制。该参数为每个ip地址的上行与下行流量之和。
5.3.2. 共享流量控制
为了在策略中进行流量控制配置，需要定义好流量控制的对象脚本，然后在策略中引
Fortinet公司 58 / 118 www.fortinet.com.cn
用。配置页面如下
命令行：
config firewall shaper traffic-shaper
edit  ...
set priority {high | medium | low}
set maximum-bandwidth 
set guaranteed-bandwidth 
next
end