### 解析为 E 地址的第一个步骤

解析为 E 地址的第一个步骤是检查本地 ARP 缓存。如果所需信息已经存在于本地 ARP 缓存中，那么系统将直接使用这些信息。然而，有时攻击者会利用一种称为 ARP 缓存污染的技术，在 ARP 缓存中插入伪造的信息，从而导致网络通信被劫持。若 ARP 缓存中不存在所需信息，系统将发送一个广播形式的 ARP 请求。如果目标地址位于本地子网内，该设备将响应请求并提供所需信息。反之，若目标地址不在本地子网内，系统将通过默认网关转发通信数据。随后，路由器（即默认网关）需要执行自己的 ARP 或 RARP 进程。

### 常见的应用层协议

在 TCP/IP 模型的应用层（包括 OSI 模型中的会话层、表示层和应用层）上，有许多特定于应用或服务的协议。对于 CISSP 考试来说，了解这些协议的基本知识及其相关的服务端口非常重要：

- **远程登录 (Telnet)**: 使用 TCP 端口 23，这是一种终端仿真网络应用，支持命令执行和应用程序运行，但不支持文件传输。
- **文件传输协议 (FTP)**: 使用 TCP 端口 20 和 21，支持文件交换，可能要求匿名或特定身份认证。
- **简单文件传输协议 (TFTP)**: 使用 UDP 端口 69，支持无需身份验证的文件交换。
- **简单邮件传输协议 (SMTP)**: 使用 TCP 端口 25，用于从客户端向邮件服务器以及从一个邮件服务器向另一个邮件服务器传送邮件。
- **邮局协议 (POP3)**: 使用 TCP 端口 110，用于将邮件从邮件服务器传送到邮件客户端。
- **互联网消息访问协议 (IMAP)**: 使用 TCP 端口 143，允许用户从邮件服务器收件箱中检索邮件，并且比 POP3 更安全，支持直接删除邮件而不必先下载至本地客户端。
- **动态主机配置协议 (DHCP)**: 使用 UDP 端口 67 和 68，分别用于服务器响应和客户端请求广播。DHCP 在系统启动时为系统分配 TCP/IP 配置设置，提供了对网络寻址的集中化控制。
- **超文本传输协议 (HTTP)**: 使用 TCP 端口 80，用于从 Web 服务器向 Web 浏览器传送网页内容。
- **安全套接字层 (SSL)**: 使用 TCP 端口 443，是一个在会话层运作的安全协议，最初设计用于支持安全的 Web 通信，但可以保护任何应用层协议通信。
- **行式打印后台程序 (LPD)**: 使用 TCP 端口 515，是一种用于管理打印作业并向打印机发送任务的网络服务。
- **X Window 系统**: 使用 TCP 端口 6000-6063，这是一个用于图形界面操作系统的 API。
- **引导协议 (BootP) / 动态主机配置协议 (DHCP)**: 使用 UDP 端口 67 和 68，用于自动分配 IP 配置及下载基本操作系统元素，连接无盘工作站到网络。BootP 是 DHCP 的前身。
- **网络文件系统 (NFS)**: 使用 TCP 端口 2049，支持不同系统之间的文件共享。
- **简单网络管理协议 (SNMP)**: 使用 UDP 端口 161（162 用于跟踪信息），用于通过中央监控站轮询收集网络健康状况信息。

### 分层协议的应用

TCPIIP 协议套件包含多个跨越不同层级的独立协议，使其成为一个多层协议。这种分层设计带来了许多优势，特别是封装机制。例如，在 Web 服务器与浏览器之间的通信过程中，HTTP 封装在 TCP 中，TCP 再封装在 IP 中，而 IP 又封装在以太网帧中。这种结构可以通过以下方式展示：

```
[ Ethernet [ IP [ TCP [ HTTP ] ] ]
```

此外，还可以添加额外的封装层，如 SSL/TLS 加密通信，使得 HTTP 和 TCP 之间插入新的封装层：

```
[ Ethernet [ IP [ TCP [ SSL [ HTTP ] ] ] ]
```

进一步地，使用诸如 IPSec 的网络层加密技术进行更深层次的封装：

```
[ Ethernet [ IPSec [ IP [ TCP [ SSL [ HTTP ] ] ] ] ]
```

然而，封装并不总是出于善意。隐蔽信道通信机制可能会在一个授权协议中隐藏另一个未授权协议。例如，当网络阻止 FTP 但允许 HTTP 时，工具如 HTTP 隧道可用于绕过限制，形成如下封装结构：

```
[ Ethernet [ IP [ TCP [ HTTP [ FTP ] ] ] ]
```

通常情况下，HTTP 用于传输 Web 相关负载，但通过 HTTP 隧道工具，标准负载可被其他协议替换。这种错误封装甚至可以在较低层次出现。例如，ICMP 通常用于网络健康测试而非一般通信，但像 Loki 这样的工具可将其转换为支持 TCP 通信的隧道协议：

```
[ Ethernet [ IP [ ICMP [ TCP [ HTTP ] ] ] ]
```

另一个值得关注的领域是对无界封装的支持可能导致 VLAN 间跳跃。VLAN 通过逻辑标签实现网络分段，但跳跃攻击可通过创建二次封装的 IEEE 802.1Q VLAN 标签来突破这一限制：

```
[ Ethernet [ VLAN1 [ VLAN2 [ IP [ TCP [ HTTP ] ] ] ] ]
```

通过这样的双重封装，首次遇到的交换机将剥离第一个 VLAN 标签，后续交换机会被内部 VLAN 标签欺骗，将流量转移到其他 VLAN 中。

### 多层协议的优点与缺点

**优点**：
- 支持更广泛的高层协议
- 封装机制可与不同层次协同工作
- 在复杂网络中提供灵活性和弹性

**缺点**：
- 允许隐蔽信道的存在
- 绕过过滤机制
- 逻辑实现的网络段边界可被逾越

### DNP3

DNP3（分布式网络协议）主要用于电力和水利行业，支持数据采集系统与控制系统设备间的通信，涉及子站计算机、RTU（远程终端单元）、IED（智能电子设备）和 SCADA 主站（即控制中心）。DNP3 是一个多层协议，类似于 TCP/IP，具有链路、传输和应用层功能。更多关于 DNP3 的细节，请参阅：[DNP3 Primer](http://www.dnp.org/AboutUs/DNP3%20Primer%20Rev)

### TCPIIP 的脆弱性

TCPIIP 存在多种脆弱性。不正确的实现容易遭受缓冲区溢出攻击、SYN 泛洪攻击、各种 DoS 攻击、碎片攻击、过长数据包攻击、欺骗攻击、中间人攻击、劫持攻击以及编码错误攻击。除了这些侵入式攻击外，TCPIIP（及其他大多数协议）还易受到通过监控或嗅探进行的被动攻击。网络监控是指对信息流量模式进行监视以获取网络相关信息的行为。数据包嗅探则是从网络中捕获数据包并从中提取有用信息的过程。有效的数据包嗅探器可以提取用户名、密码、电子邮件地址、加密密钥、信用卡号、IP 地址和系统名称等敏感信息。

### 寻址和命名解析

寻址和命名操作是使网络通信成为可能的关键组成部分。没有寻址方案，互联的计算机无法区分或指定通信目的地；同样，没有命名方案，人们将不得不依赖编号系统识别计算机。因此，绝大多数命名方案是为了人类方便记忆而设计的，而不是为了计算机制定。理解基于 TCP/IP 网络中的寻址和命名概念非常重要。我们应意识到三个不同的层次：

- **第三层或底层**：MAC 地址层。MAC 地址是“永久”的物理地址。
- **第二层或中间层**：IP 地址层。IP 地址是在 MAC 地址上“临时”赋予的逻辑地址。
- **最顶层**：域名。域名或计算机名是在 IP 地址上“临时”赋予的友好转换约定。

**“永久”与“临时”地址**

这两个术语并不完全准确。虽然 MAC 地址设计为永久的物理地址，但某些 NIC 支持 MAC 地址更改，现代操作系统（如 Windows 和 Linux）也具备此功能。当 NIC 支持 MAC 地址更改时，变化发生在硬件层面；而操作系统支持的更改仅在内存中发生，但对其他网络实体而言，就像硬件发生了变化一样。由于 IP 地址是逻辑的，可以通过 DHCP 或管理员随时修改，因此被认为是临时的。然而，在现实中，也存在静态分配 IP 地址的情况。同样，计算机名或 DNS 名也是逻辑的，可以由管理员更改。

命名和寻址系统为每个网络连接组件提供所需信息，并尽可能简化其使用。人们获得人性化的域名，网络连接协议得到与路由器友好的 IP 地址，网络接口则获得物理地址。为了实现互操作性，这三种模式必须相互关联。因此，开发了域名系统 (DNS) 和 ARP/RARP 系统。DNS 将人性化的域名解析为相应的 IP 地址，ARP 则将 IP 地址解析为相应的 MAC 地址。这两种解析操作都有逆过程，分别是 DNS 反向查找和 RARP（请参阅本章前面的“ARP 和反向 ARP”部分）。

### 汇聚协议

汇聚协议是专业或专有协议与标准协议（如 TCP/IP）的融合。主要优势在于能够利用现有的 TCP/IP 网络基础设施支持特殊或专有主机，而无需部署修改后的网络硬件，从而节省成本。然而，并非所有汇聚协议都能提供相同的吞吐量或可靠性。以下是几个常见的汇聚协议示例：

- **以太网光纤通道 (FCoE)**: 光纤通道是网络存储解决方案（SAN 或 NAS）的一种，通过 FCoE 可以在以太网上运行光纤通道协议，从而简化数据中心网络架构。