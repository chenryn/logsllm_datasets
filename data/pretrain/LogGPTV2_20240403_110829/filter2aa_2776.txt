红蓝对抗中的溯源反制实战
The practise of trace and retaliation in red team/blue team exercises
深圳证券交易所  网络安全主管  郭威
目录
战前准备
1
战中对抗
2
战后反思
3
总结
4
战前准备
组织工作
技术工作
4
引子 > 案例1：社工
找到技术支持
QQ群
伪造成基金公
司人员
通过之后修改
姓名+头像
2天
关于XX网络安
全整改事项说明
T 出群聊
重新添加好友
分析链接
确定身份
IP定位
提交报告
5
引子 > 案例2：钓鱼邮件
钓鱼邮件
控制邮箱
《东莞深圳通技术有限公司》
标题
发送
 董事长A
接收
员工B
收到邮件马上建立一个公司QQ群，方便工作安排，建好群号发到此
邮箱给我
备注：设置允许任何人加入，先别拉人，由我进群自行拉人
找到真实 IP
提交报告
6
问题
1. 高分报告长什么样？
2. 溯源反制该如何组织？
3. 蜜罐应该如何部署?
从现在的经验来看：
n 这些攻击案例，真的只值200+分吗？
7
备战 > 组织架构
消息组（4）
分析组
（9）
处置组
（4）
线索
特征
处置
报告
各
部
门
异
地
中
心
下
属
公
司
关
联
机
构
监控组
（11）
可用性监控
指挥部
决
策
汇
报
工作小组
公安部
证监会
市网监
其他...
报
告
溯源反制组(3)
线索
8
备战 > 对蜜罐的理解
定位：互联网用重型蜜罐，内网
全量部署轻型蜜罐
n 获取攻击者信息（IP、社交ID）
n 反制攻击者
n 诱饵：域名、目录、端口、github、文库等
n 手段：jsonp、mysql local infile、rdp 
漏洞、执行文件（activex、pe文件）
9
备战 > 蜜罐部署
已知漏洞
众测、红蓝对抗
Shiro/Fastjson
热门漏洞
某VPN、某EDR
F5 WEB、常见WEB漏洞
产品特性
RDP反制
Mysql 反制
路径跳转
a.b.cn/shiro 
伪造接口
a.b.cn/actuator/env
域名复用
old.b.cn
欺骗域名
vpn.b.cn
常见目录
a.b.cn/admin
端口暴露
oa.b.cn:3389/21/22
github泄露
db.b.cn:3306
战中对抗
蜜罐
反制
11
迎战 > 拟定溯源反制组工作流程
n 高价值告警：一部分来自于蜜罐，一部分来自于分析组识别的真人攻击。
n 低价值告警：来自于NTA、WAF等边界检测设备。
人员能力栈构成：
1、能获取社工库信息：电报群组。
2、具备攻击能力：初级能熟练利用常见漏洞；中级能代码审计、组合利用漏洞；高级有0day。
3、二级制逆向：在沙箱基础上，对PE、ELF文件具备分析能力。
12
迎战 > 案例3：发现黑产
5天过去了……蜜罐依然没有收获，只能主动出击
n IP注册地为香港特别行政区
n 存在 phpmyadmin 弱口令
n 数据库写文件拿到 webshell
n 获取系统权限
13
迎战 > 案例3：发现黑产
14
迎战 > 案例3：发现黑产
1. 扫描器发现 800+ 台服务器存在 mysql 弱口令
2. C2服务器还控制了 600+ 台个人电脑 
15
迎战 > 案例3：发现黑产
ref.attacker.com
在一份19年的在线病毒分析报告中发现了 ref.attacker.com 曾经解析到了 119.xxx.xxx.xxx
1.
两个IP原先有正常业务：victim.cn和 victim2.cn
2.
最晚在2020年3月，黑客入侵了119.xxx.xxx.xxx
（victim2.cn），将域名3、4、5、6指向了该服务器，直到
2020-06-18日。
3.
预计在2020年9月，黑客入侵了211.xxx.xxx.xxx（victim.cn），
将域名3、4、5、6指向了该服务器，目前仍然有效。
4.
域名qq177xxxxx.attakcer.org泄露了QQ号码 177xxxxxx。
5.
利用QQ号码溯源到了身份证、手机号信息。
16
迎战 > 案例4：谜之得分
IP
邮箱
whois
当当网账号
支付宝账号
红蓝对抗无关。对于红蓝对抗无关的追踪溯源完整还原攻击链条，溯源到黑客的虚拟身份、真
实身份，溯源到攻击队员，反控攻击方主机，根据程度阶梯给分。本次溯源到疑似攻击者的虚
拟身份，给XXX分。
发现的攻击IP是非有效IP。入侵是得分的前提，对扫描探测（进行信息探测踩点，并未攻击成
功）的追踪溯源不得分。请明确是否入侵成功，并提供入侵成功证据。
17
迎战 > 案例5：利用设备指纹捕获真实攻击者
aab21d24ebb6ca60f1405d5dc84a2453
bingzi5xxxx0
百度ID
百度贴吧
CSDN
脉脉
手机号
教育经历
工作经历
18
迎战 > 案例5：利用设备指纹捕获真实攻击者（2）
………
蜜罐厂家指纹库
深交所
提交指纹
参演单位1
设备指纹
+
百度ID
参演单位2
设备指纹
+
新浪ID
参演单位N
设备指纹
+
优酷ID
返回：社交ID
19
迎战 > 案例6：钓鱼邮件案例
《关于申报XX杰出员工的通知》
C2地址：
111.222.333.XX
邮件头找到发件人：
PI:EMAIL
域名持有人：CC
邮箱：PI:EMAIL
dddd 找到CSDN博客
佐证具备攻击能力
找到公司注册信息
获得手机号码185XX
工作经历
脉
脉
毕业院校
工作经历
领
英
微博/知乎
/Github
社
交
微信/支付
宝
其
他
nmap查看到指纹 
XXXX_VM_XX
20
迎战 > 案例7：钓鱼邮件案例（延申）
我方攻击者
他山攻击者
21
迎战 > 案例8：水坑案例
该服务器在内网
开始横向扩散
利用后台计划任务
写入免杀webshell
管理后台
弱口令
22
迎战 > 案例8：水坑案例
该服务器在内网
开始横向扩散
利用后台计划任务
写入免杀webshell
管理后台
弱口令
溯源
反制
厂家情报
中心
样本泄露了
物理路径
捕获到用
户名
用户信息
在webshell中植入 
probe.js
浏览器
(Chrome)
操作系统
在webshell中增加
canvas探针
CPU
主板
Chrome UAF 0day
CS 免杀
客户端
获得微信
ID
IP代理
池
browser, ua, lang, referer, 
location, toplocation, 
cookie, domain, title, 
screen, flash
x 2
战后反思
蜜罐
反制
24
战后 > 反思2019年溯源中存在的问题
case1：QQ群社工
case2：邮箱钓鱼
1、将计就计，组建QQ群，诱导对方提
供链接、执行文件
2、针对回连信息（如IP、域名）进行
溯源
1、逆向分析，给出原理解析
2、利用社工库，从QQ号找到攻击者身
份信息
25
战后 > 反思 2020 年溯源中的局限性
战术上，也是柿子捡软的捏：
1、对于隐藏手段较为复杂
的场景，无能为力。
2、对于做了加固的“肉鸡”
服务器，定向攻击较难。
网络+应用隐藏：
n Domain Fronting
n cs2modrewrite
n Malleable-C2-Profiles
n Cloudflare Worker
R e f :  h t t p s : / / x z . a l i y u n . c o m / t / 4 5 0 9
26
战后 > 协作机制改进
蜜罐
钓鱼
扫描
作为属性，而非类别
IP
来源
记录
1.1.1.1
蜜罐
开放3306端口，存在弱口令，无法提权，请 xxx 
继续跟进。
2.2.2.2
钓鱼
开放80、443，存在xx漏洞，已获得webshell。
3.3.3.3
扫描
NTA，无对外开放端口。
27
战后 > 报告标题优化
一部手机失窃引发的惊心动魄的战争
看蓝队如何干翻你
手机一丢，倾家荡产
初探第三代蜜罐，xxx精准溯源攻击者身份
警民联动、共建美好网络空间 
  -- xxx联合xx网监在国庆前夕铲除一伙网络博彩组织
 一部手机失窃而揭露的窃取个人信息实现资金盗取的黑色产业链 
 攻防演练中的溯源反制实战
总结
29
溯源反制工作
01
02
03
04
责任主体
组织架构
协作机制
技术手段
这应该是公安的
事情？
三人小组
内外并举
攻击视角
n
社工信息的合法性、
准确性、完整性
n
常态化防护中，是
否有资源开展溯源
反制工作？
n
“比赛”规则。考
察CII单位与安全服
务厂商、公安的配
合能力。
n
公安的资源保障
n
明确目标：把握好
溯源的度。需要高
级别研究员？
0Day？普通蓝队？
n
人员构成：web+
二进制+信息库
n
对外：1）和公安
部门保持顺畅的沟
通渠道；2）依托
厂家的情报信息。
n
对内：和分析组、
夜班做好衔接。利
用共享文档进行信
息记录。
n
exploit：弱口令
/DB写
webshell/phpstu
dy /tomcat RCE 
n
payload：CS/冰蝎
/蚁剑/哥斯拉/菜刀
n
平台：bayonet
30
其他
n 钓鱼邮件：别遗漏反垃圾邮件网关中拦截的邮件。
n 获取身份：注意邮件头中的 host 字段。
n 平常心：加分的不确定性因素太多，是否有人攻击你？攻击者水平？裁判尺度？
n 辩证看待加分与排名。
n 反制工作本身的法律风险，算不算灰色地带？
汇报完毕， 请批评指正
安全建设
哪有什么圣杯
无非是日拱一卒的心态
和对解决问题的执拗