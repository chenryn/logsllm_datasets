这种攻击可以采用窃听的形式，也可以删除提供的所有选项，用最薄弱的认证策略
（比如基本认证）来取代现有的认证机制，对其进行修改。
入侵受信代理的方式之一就是使用其扩展接口。有时代理会提供复杂的编程接口，
可以为这类代理编写一个扩展（比如，plug-in）来拦截流量并对其进行修改。不过，
数据中心和代理自身提供的安全性使得通过恶意plug-in进行中间人攻击的可能性变
得很渺茫。
没有什么好办法可以解决这个问题。可行的解决方案包括由客户端提供与认证功能
有关的可见线索，对客户端进行配置使其总是使用可用认证策略中功能最强的那一
种，等等。但即使使用的是最强大的认证策略，客户端仍然很容易被窃听。防止这
些攻击唯一简便的方式就是使用SSL。 304
13.5.6 选择明文攻击
使用摘要认证的客户端会用服务器提供的随机数来生成响应。但如果中间有一个被
入侵的或恶意的代理在拦截流量（或者有个恶意的原始服务器），就可以很容易地为
客户端的响应计算提供随机数。使用已知密钥来计算响应可以简化响应的密码分析
过程。这种方式被称为选择明文攻击（chosen plaintext attack）。选择明文攻击有以
下几种变体形式。
摘要认证 ｜ 321
• 预先计算的词典攻击
这是词典攻击和选择明文攻击的组合。首先，发起攻击的服务器会用预先确定的
随机数和常见密码的变化形式产生一组响应，创建一个词典。一旦有了规模可观
的词典，攻击服务器或代理就可以完成对流量的封锁，向客户端发送预先确定的
随机数。攻击者从客户端得到一个响应时，会搜索生成的词典，寻找匹配项。如
果有匹配项，攻击者就捕获了这个用户的密码。
• 批量暴力型攻击
批量暴力型攻击的不同之处在于计算密码的方式。它没有试图去匹配预先计算出
来的摘要，而是用一组机器枚举了指定空间内所有可能的密码。随着机器运行速
度变得越来越快，暴力型攻击的可行性也变得越来越强了。
总之，这些攻击所造成的威胁是很容易应对的。防止这些攻击的一种方法就是配置
客户端使用可选的cnonce指令，这样响应就是基于客户端的判断产生的，而不是
用服务器提供的随机数（这个随机数可能会被攻击者入侵）产生的。通过这种方法，
再结合一些强制使用合理强密码的策略，以及一个好的密码过期策略，就可以完全
消除选择明文攻击的威胁。
13.5.7 存储密码
摘要认证机制将对比用户的响应与服务器内部存储的内容——通常就是用户名和
H(A1)元组对，其中H(A1)是从用户名、域和密码的摘要中导出的。
与Unix机器中传统的密码文件不同，如果摘要认证密码文件被入侵了，攻击者马上
就能够使用域中所有文件，不需要再进行解码了。
消除这个问题的方法包括：
• 就像密码文件中包含的是明文密码一样来保护它；
• 确保域名在所有域中是唯一的。这样，如果密码文件被入侵，所造成的破坏也只
局限于一个特定的域中。包含主机和domain的全路径域名就可以满足这个要求。
305
尽管摘要认证提供的解决方案比基本认证要强壮且安全得多，但它并没有为内容的安
全提供任何保证——真正安全的事务只有通过SSL才能实现，我们将在下一章介绍。
13.6 更多信息
更多有关认证的信息，参见以下资源。
• http://www.ietf.org/rfc/rfc2617.txt
RFC 2617，“HTTP Authentication：Basic and Digest Access Authentication.”
306 （“HTTP认证：基本和摘要访问认证”）。
322 ｜ 第13章
第14章
安全
HTTP
323
前面三章讨论了一些有助于识别和认证用户的HTTP特性。在友好环境中，这些技
术都能够很好地工作，但在充满各种利益驱动和恶意对手的环境中，它们并不足以
保护那些重要的事务处理。
本章提供了一种更复杂，更安全的技术，通过数字密码来保护HTTP事务免受窃听
和篡改的侵害。
14.1 保护HTTP的安全
人们会用Web事务来处理一些很重要的事情。如果没有强有力的安全保证，人们就
无法安心地进行网络购物或使用银行业务。如果无法严格限制访问权限，公司就不
能将重要的文档放在Web服务器上。Web需要一种安全的HTTP形式。
前面的章节讨论了一些提供认证（基本认证和摘要认证）和报文完整性检查（摘要
qop="auth-int"）的轻量级方法。对很多网络事务来说，这些方法都是很好用的，
但对大规模的购物、银行事务，或者对访问机密数据来说，并不足够强大。这些更
为重要的事务需要将HTTP和数字加密技术结合起来使用，才能确保安全。
HTTP的安全版本要高效、可移植且易于管理，不但能够适应不断变化的情况而且还应
该能满足社会和政府的各项要求。我们需要一种能够提供下列功能的HTTP安全技术。
• 服务器认证（客户端知道它们是在与真正的而不是伪造的服务器通话）。
• 客户端认证（服务器知道它们是在与真正的而不是伪造的客户端通话）。
• 完整性（客户端和服务器的数据不会被修改）。
• 加密（客户端和服务器的对话是私密的，无需担心被窃听）。
• 效率（一个运行的足够快的算法，以便低端的客户端和服务器使用）。
307 • 普适性（基本上所有的客户端和服务器都支持这些协议）。
• 管理的可扩展性（在任何地方的任何人都可以立即进行安全通信）。
• 适应性（能够支持当前最知名的安全方法）。
• 在社会上的可行性（满足社会的政治文化需要）。
HTTPS
HTTPS是最流行的HTTP安全形式。它是由网景公司首创的，所有主要的浏览器和
服务器都支持此协议。
HTTPS方案的URL以https://，而不是http://开头，据此就可以分辨某个Web页面
是通过HTTPS而不是HTTP访问的（有些浏览器还会显示一些标志性的安全提示，
如图14-1所示）。
324 ｜ 第14章
https方案 e
安全图标
图14-1 浏览安全Web站点
使用HTTPS时，所有的HTTP请求和响应数据在发送到网络之前，都要进行加密。
HTTPS在HTTP下面提供了一个传输级的密码安全层（参见图14-2）——可以使用
SSL，也可以使用其后继者——传输层安全（Transport Layer Security，TLS）。由于
SSL和TLS非常类似，所以在本书中我们不太严格地用术语SSL来表示SSL和TLS。
HTTP 应用层
HTTP 应用层 SSL or TLS 安全层
TCP 传输层 TCP 传输层
IP 网络层 IP 网络层
网络接口 数据链路层 网络接口 数据链路层
(a) HTTP (b) HTTPS
图14-2 HTTPS是位于安全层之上的HTTP，这个安全层位于TCP之上
大部分困难的编码及解码工作都是在SSL库中完成的，所以Web客户端和服务器
在使用安全HTTP时无需过多地修改其协议处理逻辑。在大多数情况下，只需要用 308
安全HTTP ｜ 325
SSL的输入/输出调用取代TCP的调用，再增加其他几个调用来配置和管理安全信
息就行了。
14.2 数字加密
在详细探讨HTTPS之前，我们先介绍一些SSL和HTTPS用到的加密编码技术的背
景知识。在接下来的几节里，我们会对数字加密的本质进行一个快速的入门性介绍。
如果你已经掌握了数字加密的技术和术语，可以直接阅读14.7节。
在这个数字加密技术的入门介绍中，我们会讨论以下内容。
• 密码
对文本进行编码，使偷窥者无法识别的算法。
• 密钥
改变密码行为的数字化参数。
• 对称密钥加密系统
编/解码使用相同密钥的算法。
• 不对称密钥加密系统
编/解码使用不同密钥的算法。
• 公开密钥加密系统
一种能够使数百万计算机便捷地发送机密报文的系统。
• 数字签名
用来验证报文未被伪造或篡改的校验和。
• 数字证书
309 由一个可信的组织验证和签发的识别信息。
14.2.1 密码编制的机制与技巧
密码学是对报文进行编/解码的机制与技巧。人们用加密的方式来发送秘密信息已
经有数千年了。但密码学所能做的还不仅仅是加密报文以防止好事者的读取，我们
还可以用它来防止对报文的篡改，甚至还可以用密码学来证明某条报文或某个事务
确实出自你手，就像支票上的手写签名或信封上的压纹封蜡一样。
326 ｜ 第14章
14.2.2 密码
密码学基于一种名为密码（cipher）的秘密代码。密码是一套编码方案——一种特
殊的报文编码方式和一种稍后使用的相应解码方式的结合体。加密之前的原始报
文通常被称为明文（plaintext或cleartext）。使用了密码之后的编码报文通常被称作
密文（ciphertext）。图14-3显示了一个简单的例子。
明文 密文 明文
Meet me at the Phhw ph dw wkh Meet me at the
pier at midnight slhu dw plgqljkw pier at midnight
编码器 解码器
图14-3 明文和密文
用密码来生成保密信息已经有数千年了。传说尤利乌斯 ·凯撒（Julius Caesar）曾
使用过一种三字符循环移位密码，报文中的每个字符都由字母表中三个位置之后的
字符来取代。在现代的字母表中，“A”就应该由“D”来取代，“B”就应该由“E”
来取代，以此类推。
比如，在图14-4中，用rot3（循环移位3字符）密码就可以将报文“meet me at the
pier at midnight”编码为密文“phhw ph dw wkh slhu dw plgqljkw”。1通过解码，在
字母表中循环移位3个字符，就可以将密文解密回原来的明文报文。
密码 ABCDEFGHIJKLMNOPQRSTUVWXYZ
ABCDEFGHIJKLMNOPQRSTUVWXYZABC
明文 MEETMEAT THE ATPIER AT MIDNIGHT
密文 PHHWPHDW WKH DWSLHU DW PLGQLJKW
图14-4 循环移位3字符密码实例 310
注1：为了简化这个例子，我们没有对标点和空格进行循环移位，但你可以自己试一试。
安全HTTP ｜ 327
14.2.3 密码机
最初，人们需要自己进行编码和解码，所以起初密码是相当简单的算法。因为密码
很简单，所以人们通过纸笔和密码书就可以进行编解码了，但聪明人也可以相当容
易地“破解”这些密码。
随着技术的进步，人们开始制造一些机器，这些机器可以用复杂得多的密码来快速、
精确地对报文进行编解码。这些密码机不仅能做一些简单的旋转，它们还可以替换
字符、改变字符顺序，将报文切片切块，使代码的破解更加困难。2
14.2.4 使用了密钥的密码
编码算法和编码机都可能会落入敌人的手中，所以大部分机器上都有一些号盘，可
以将其设置为大量不同的值以改变密码的工作方式。即使机器被盗，没有正确的号
盘设置（密钥值），解码器也无法工作。3
这些密码参数被称为密钥（key）。要在密码机中输入正确的密钥，解密过程才能正
确进行。密码密钥会让一个密码机看起来好像是多个虚拟密码机一样，每个密码机
都有不同的密钥值，因此其行为都会有所不同。
图14-5显示了使用密钥的密码实例。加密算法就是普通的“循环移位N字符”密
码。N的值由密钥控制。将同一条输入报文“meet me at the pier at midnight”通过
同一台编码机进行传输，会随密钥值的不同产生不同的输出。现在，基本上所有的
加密算法都会使用密钥。
14.2.5 数字密码
随着数字计算的出现，出现了以下两个主要的进展。
311 • 从机械设备的速度和功能限制中解放出来，使复杂的编/解码算法成为可能。
• 支持超大密钥成为可能，这样就可以从一个加密算法中产生出数万亿的虚拟加密
算法，由不同的密钥值来区分不同的算法。密钥越长，编码组合就越多，通过随
机猜测密钥来破解代码就越困难。
注2： 最著名的机械编码机可能就是第二次世界大战期间德国的Enigma编码机了。尽管Enigma密码非常
复杂，但阿兰·图灵（Alan Turing）和他的同事们在20世纪40年代初期就可以用最早的数字计算机
破解Enigma代码了。
注3： 在现实中，机器逻辑可能会指向一些可利用的模式，所以拥有机器逻辑有时会有助于密码的破解。现
代的加密算法通常都设计为，即使大家都知道这些算法，恶意的攻击者也很难发现任何有助于破解代
码的模式。实际上，很多功能最强大的密码都会将其源代码放在公共域中，供大家浏览和学习！
328 ｜ 第14章
(a) 明文
Meet me at the
pier at midnight
密文
密钥=1 nffu nf bu uif
qjfs bu njeojhiu
循环移位(n)编码器
(b) 明文
Meet me at the
pier at midnight
密文
密钥=2 oggv og cv vjg
rkgt cv okfpkijv
循环移位(n)编码器
(c) 明文
Meet me at the
pier at midnight
密文
密钥=3 phhw ph dw wkh