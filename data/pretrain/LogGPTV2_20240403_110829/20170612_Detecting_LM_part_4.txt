Event Log
Destination host - Required
- Confirmable Information
Security
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Application Information -> Application Name: "System"
- Network Information -> Direction: "Inbound"
- Network Information -> Source Port: "5985" (HTTP) or "5986" (HTTPS)
- Network Information -> Protocol: "6" (TCP)
- Confirmable Information
- Source Host: Network Information -> Destination Address
21
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C:\Windows\System32\winrshost.exe"
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine
- User Name: User
- Process ID: ProcessId
Event Log
- Required
Sysmon
Event ID: 1 (Process Create)
OS: Windows
5 (Process Terminated)
standard user
- Image: "[Command Specified by Source Host]"
↓
Destination host
OS: Windows - Confirmable Information
(Continued from the
administrator - Process Start/End Time and Date (UTC): UtcTime
previous entry)
(Continued from - Process Command Line: CommandLine
- User Name: User
the previous
- Process ID: ProcessId
entry)
Event Log
- The fact that the WinRS process corresponding to the log at the source host was executed is recorded.
Application and -
Service
Event ID: 81 (Sending the request for operation Get to destination host and port)
\Microsoft\Windows
\Windows Remote
File name:
Execution History C:\Windows\Prefetch\WINRSHOST.EXE-ECE7169D.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output Logs by a command execution via WinRS may be recorded.
22
3.2.8. AT Command
Basic Information
Tool Name AT
Legend
Category Command Execution
- Acquirable
Tool Overview Executes a task at the specified time
Information
Tool - Event ID/Item Name
Example of The tool may be used to secretly place an application or script without being recognized by the user in advance and then execute it at the desired time.
- Field Name
Presumed Tool Use - Source host: at command execution source
- "Field Value"
During an Attack - Destination host: The machine for which a task was registered by the AT command
Administrator
Authority
*Setting a task on the remote host can be performed by a standard user.
Windows 7 / Server 2008
Targeted OS
Operating The AT command was abolished in Windows 8 and later and Server 2012 and later.
Condition Domain Not required
Communication
445/tcp
Protocol
Service Task Scheduler
Information - Source host: Execution history (Prefetch)
Standard Settings
Acquired from - Destination host: Task creation / execution history in the task scheduler event log
Log Additional Settings - Execution history (Sysmon / audit policy)
- Source host: If the following log is in the event log, it is considered that a task was registered.
- The Event ID 4689 (A process has exited) of at.exe was recorded in the event log "Security" with the execution result (return value) of "0x0".
Evidence That Can Be Confirmed - Destination host: If the following log is in the event log, it is considered that a task was executed.
When Execution is Successful - The Event ID 106 (A task has been registered) was recorded in the event log "\Microsoft\Windows\TaskScheduler\Operational".
- The Event IDs 200 (The operation that has been started) and 201 (The operation has been completed) are registered in the event log
, and the return value of the Event ID 201 is set to success.
"\Microsoft\Windows\TaskScheduler\Operational"
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\at.exe"
Event Log
- Confirmable Information
- Required
- Process Start/End Time and Date: Log Date
Security
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 1 (Process Create)
Source host 5 (Process Terminated)
(Windows 7) - Image: "C:\Windows\System32\at.exe"
Event Log
- Confirmable Information
- Required
- Process Start/End Time and Date (UTC): UtcTime
Sysmon
- Process Command Line: CommandLine
- Specified Time, Execution Process, Target Host: CommandLine *This information is recorded when the process is executed for
- User Name: User the remote host.
- Process ID: ProcessId
File name:
Execution History C:\Windows\Prefetch\AT.EXE-BB02E639.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
When a task has been registered, the following logs are output.
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Object -> Object Name: "C:\Windows\Tasks\[Task Name].job"
"C:\Windows\System32\Tasks\[Task Name]
- Confirmable Information
OS: Windows 7
- Handle ID (Used for Association with Other Logs): Object -> Handle ID
user
- Process ID of the Process that Requested the Handle: Process Information -> Process ID (matches the ID of the
↓
process created in event 4688)
OS: Windows - Process Details: Access Request Information -> Access / Reason for Access ("WriteData (or AddFile)"
Server 2008 R2 "AppendData (or AddSubdirectory or CreatePipeInstance)")
administrator - Success or Failure: Keywords ("Audit Success")
Event ID: 4698 (A scheduled task was created)
- Task Information -> Task Name
- Confirmable Information
- Task Details: Task Information -> Task Content Described in the XML format.
- Execution Trigger: Triggers
- Priority and Other Settings: Principals
- Execution Details: Actions
Destination host Event log
When a task has been executed, the following logs are output.
(Windows Server - Required
2008 R2) Security
Event ID: 4688 (A new process has been created)
- Process Information -> Process Name: "C:\Windows\System32\taskeng.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Process ID: Process Information -> New Process ID
*This will be the parent process of the process to be executed later.
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: Process Executed by the Task
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Process ID : Process Information -> New Process ID
*If another child process is executed in the task, this process becomes the parent process.
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Parent Process ID: Process Information -> Creator Process ID *taskeng.exe, which was
executed first, is the parent process.
- Process Return Value: Process Information -> Exit Status
23
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4656 (A handle to an object was requested)
Event log
4663 (An attempt was made to access an object)
- - Object -> Object Name: "C:\Windows\Tasks\[Task Name].job"
Security - Access Request Information -> Access / Reason for Access: "WriteData (or AddFile)" / "AppendData Required
(Continued from the (or AddSubdirectory or CreatePipeInstance)"
previous entry) - Confirmable Information
- Handle ID: Object -> Handle ID *Used for association with other logs.
With respect to task registration, no beneficial information is output. When a task has been executed, the following logs are registered.
Event ID: 1 (Process Create)
Event Log 5 (Process Terminated)
- - ParentImage Name: "C:\Windows\System32\taskeng.exe" Required
Sysmon
- Confirmable Information
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *The execution process and argument are recorded.
- Process ID: ProcessId *This can be used for investigating the execution and access history of a
executed by
When a task has been registered, the following logs are output.
OS: Windows 7 Event ID: 106 (A task has been registered)
user
↓ Destination host - Confirmable Information
- User Who Registered the Task: Details Tab -> EventData\UserContext
OS: Windows (Windows Server
- Task Name: Details Tab -> EventData\TaskName
Server 2008 R2 2008 R2)
administrator (Continued from the
(Continued from previous entry)
When a task has been executed, the following logs are output.
the previous
entry)
Event ID: 200 (The operation that has been started)
- Confirmable Information
Event Log
- Task Name: Details Tab -> EventData\TaskName
-
- Command that was Executed: Details Tab -> EventData\ActionName
Application and Service
- Task Instance ID: Details Tab -> EventData\TaskInstanceId
Log -
\Microsoft\Windows
\TaskScheduler Event ID: 129 (A task process has been created)
\Operational - Details Tab -> EventData\TaskName matches TaskName output to the start event (Event ID 200).
- Confirmable Information
- Process that was Executed: Details Tab -> EventData\Path
- Process ID: Details Tab -> EventData\ProcessID
*This can be used for investigating the execution history and access history of a process executed
Event ID: 201 (The operation has been completed)
- Details Tab -> EventData\InstanceId matches TaskInstanceId output to the start event (Event ID 200).
- Confirmable Information
- Task Name: Details Tab -> EventData\TaskName
- Command that was Executed: Details Tab -> EventData\TaskActionName
- Execution Results (Return Value): Details Tab -> EventData\ResultCode
*The meaning of a return value varies depending on the process that is executed.
Remarks
Additional Event Logs That Can Be Output Logs related to the command called from the task may be recorded.
24
3.2.9. BITS
Basic Information
Tool Name BITS Legend
Category Command Execution - Acquirable
Tool Overview Sends and receives files in background (the priority, etc. for sending and receiving files can be set) Information
Tool - Event ID/Item Name
Example of This tool is used to send or receive files at a bandwidth that is less noticeable than other communications.
- Field Name
Presumed Tool Use - Source host: The machine that sends and receives files by BITS
- "Field Value"
During an Attack - Destination host: File transmission destination
Authority Standard user
Targeted OS Windows
Operating Domain Not required
Condition Communication
445/tcp
Protocol
Service Background Intelligent Transfer Service
- Source host: It is possible that the use of BITS can be determined based on a change in the execution status of the Background Intelligent Transfer Service. *However, it is not possible when BITS is already running.
Information Standard Settings
- Destination host: No beneficial information is recorded.
Acquired from
- Source host: Writing to the temporary file created by BITS "BITF[Random Number].tmp" is recorded.
Log Additional Settings
- Destination host: No beneficial information is recorded.
Evidence That Can Be Confirmed If the following log is in the event log, it is considered that a file was transferred.
When Execution is Successful - The event ID: 60 is recorded in the event log "Application and Service Log\Microsoft\Windows\Bits-Client", and the status code is set to "0x0".
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4656 (A handle to an object was requested)
4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Object -> Object Name: "[Path to Created File]\BITF[Random Number].tmp"
*Since a temporary file with a name starting with "BITF" is created, it is confirmed that a file transfer by BITS
Event Log
- Confirmable Information
- Required
- Handle ID (Used for Association with Other Logs): Object -> Handle ID
Security
- Process ID of the Process that Requested the Handle: Process Information -> Process ID (matches the ID of the
process created in event 4688)
- Process Details: Access Request Information -> Access / Reason for Access ("WriteData (or AddFile)" /
"AppendData (or AddSubdirectory or CreatePipeInstance)" / "DELETE")
- Success or Failure: Keywords ("Audit Success")
Event ID: 2 (File creation time changed)
Event Log - Image Name: "C:\Windows\system32\svchost.exe"
- Required
Sysmon - Confirmable Information
- Temporary File for which Time Stamp was Changed: "[Path to Created File]\BITF[Random Number].tmp"
Event ID: 7036 (The [Service Name] service entered the [Status] state)
- Details Tab -> System\Provider\Name is set to "Service Control Manager".
- Details Tab -> EventData\param1 is set to "Background Intelligent Transfer Service".
Source host
Event Log - Confirmable Information
- - Executing the Service: Details Tab -> EventData\param2 ("Executing") -
System
OS: Windows
user
- Remarks
↓
- If a process that uses BITS has been executed after the last startup of the machine, logs may not be output
OS: Windows
(For example, when BITS is used by Windows Update, logs may not be output after a file is downloaded by Windows Update).
user
Event Log
Event ID: 60
-
Application and Service
- Confirmable Information -
Log
- Targeted File: Details Tab -> ventData\url
\Microsoft\Windows - Success or Failure: General Tab -> Status Code
\Bits-Client
Registry Entry:
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\BITS
- Confirmable Information
Execution History - Service State: StateIndex
- -
Registry
- Remarks
- The value changes as a result of the BITS status changing to "Executing".
- If BITS is already in the executing status when the command is executed, the value does not change.
Event ID: 5145 (A network share object was checked to see whether client can be granted desired access)
- Network Information -> Source Address: "[Source Host]"
- Network Information -> Source Address: "[Source Port]"
Event Log
Destination host - Required
- Confirmable Information
Security
- Share Name: Shared Information -> Share Name
- Share Path: Shared Information -> Share Path
- Placed File Name: Shared Information -> Relative Target Name
Remarks
Additional Event Logs That Can Be Output - If an audit of object reading is conducted, reading of transferred files may be recorded.
25
3.3.1. PwDump7
Basic Information
Tool Name PwDump7 Legend
Category Password and Hash Dump - Acquirable
Tool Overview Displays a list of password hashes in the system Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used to perform logon authentication on other hosts using the acquired hash information.
- "Field Value"
During an Attack
Authority Administrator
Targeted OS Windows
Operating Domain Not required
Condition Communication
-
Protocol
Service -
Information Standard Settings - Execution history (Prefetch)
Acquired from Additional Settings - Execution history (Sysmon / audit policy)
Evidence That Can Be Confirmed
The successful execution of the tool cannot be determined from event logs or execution history.