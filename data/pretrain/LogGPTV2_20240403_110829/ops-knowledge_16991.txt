User: You are maintaining a CentOS server. After a system update, you find that the SSH service cannot be started. Please use the error message and system log to try to find out the cause and solve the problem.
Assistant: 1. Check the SSH service status and error information First, we need to check the SSH service status and error information to determine the specific problem. Execute the following command in a terminal: sudo systemctl status sshd.service If the SSH service is not started, you will see the following output: sshd.service - OpenSSH server daemon Loaded: loaded (/usr/lib/systemd/system/sshd.service ; disabled; vendor preset: enabled) Active: inactive (dead) If the SSH service starts with errors, you will see the following output: sshd.service - OpenSSH server daemon Loaded: loaded (/usr/lib/systemd/system/ sshd.service; enabled; vendor preset: enabled) Active: failed (Result: exit-code) since Wed 2021-12-01 18:34:11 CST; 6min ago Process: 2244 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=255) Dec 01 18:34:11 srv01 systemd[1]: Starting OpenSSH server daemon... Dec 01 18:34:11 srv01 sshd[2244]: /etc/ssh/sshd_config line 19: unsupported option "permitrootlogin" Dec 01 18:34:11 srv01 sshd[2244]: /etc/ssh/sshd_config line 22: directive 'usepam' is not allowed within a Match block Dec 01 18:34:11 srv01 sshd[2244]: /etc/ssh/sshd_config line 27: directive 'passwordauthentication' is not allowed within a Match block Dec 01 18:34:11 srv01 sshd[2244]: /etc/ssh/sshd_config line 47: missing '}' or '{' in block Dec 01 18:34:11 srv01 sshd[2244]: /etc/ssh/sshd_config line 54: unsupported option "subsystem" Dec 01 18:34:11 srv01 sshd[2244] : /etc/ssh/sshd_config line 54: unsupported option "sftp" Dec 01 18:34:11 srv01 sshd[2244]: /etc/ssh/sshd_config line 56: directive 'chrootdirectory' is not allowed within a Match block 12 01 Dec 18:34:11 srv01 systemd[1]: sshd.service: control process exited, code=exited status=255 01 Dec 18:34:11 srv01 systemd[1]: Failed to start OpenSSH server daemon. According to the above From the output, we can see that the SSH service failed to start due to unsupported options and syntax errors. The syntax of the SSH service configuration file may have changed, causing your SSH configuration file to contain unsupported options and syntax errors. 2. Check the SSH configuration file On CentOS, the SSH configuration file is usually located at /etc/ssh/sshd_config. Check the validity of the SSH configuration file with the following command: sudo sshd -t If there is a problem with the SSH configuration file, this will result in an error output such as: /etc/ssh/sshd_config line 15: Bad protocol spec 'SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.8' /etc/ssh/sshd_config line 16: Bad protocol spec 'SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.8' /etc/ssh/sshd_config line 77: Unsupported option GSSAPIAuthentication which means your SSH The configuration file contains syntax errors or unsupported options. If you make changes to your SSH configuration file, make sure it contains the correct syntax and options. You can restore the default SSH configuration file with the following command: sudo cp /etc/ssh/sshd_config.rpmnew /etc/ssh/sshd_config If you have backed up your SSH configuration file, you can replace it with the backup version. After making changes, run the following command again to check the validity of the SSH configuration file: sudo sshd -t 3. Restart the SSH service If you fixed the error in the configuration file and the SSH service has started successfully, you can try to restart the SSH service. Execute the following command: sudo systemctl restart sshd.service If the SSH service is up and running normally, you should be able to connect to the CentOS server via SSH. If the SSH service is still inaccessible, check the syslog for more details about the error. 4. Check the system log Checking the system log can help us find problems related to the SSH service. You can view the latest system logs with the following command: sudo tail -f /var/log/messages If there is a problem with the SSH service, you will see service-related error messages. For example, if your SSH service tries to listen on an invalid port or IP address, you might see the following error message: sshd[11032]: error: Bind to port 12345 on 0.0.0.0 failed: Address already in use. This means Another service is already using the same port. You can try changing the port number in your SSH configuration file. In summary, to troubleshoot the failure to start the SSH service, follow the steps above to check the SSH service status, SSH configuration files, and system logs. After determining the cause of the problem, you can repair the configuration file and restart the SSH service to make it work properly.