# 前言
区块链的根本属性是去中心化，而去中心化的依托是共识机制。  
在了解共识机制之前，我们可以先来了解两个有趣的古老问题：类两军问题、拜占庭将军问题。
## 类两军问题
如上图所示，一支白色部队在山谷里驻扎，在周围的两边上坡上驻扎着蓝色部队。白色部队比蓝色部队中的任意一支都要强大，但两支蓝色部队加在一起的战斗力要比白色部队强大。如果一支蓝色部队单独作战，那么它就会被白色部队击败；如果两支蓝色部队同时向白色部队进攻，那么蓝色部队可以获胜。两支蓝军不能够远程沟通，只能够派遣通信兵穿过由白军驻扎的沟渠去通知对面蓝军进攻的时间，而且在这个协商过程中发起通信的蓝军需要知道对面蓝军同意了攻击的时间，接收通信的蓝军也需要知道发起通信的蓝军知道自己同意了攻击时间。那么是否存在蓝军必胜的通信协议呢？这就是两军问题。  
两军问题的根本问题在于通信信道的不可靠，反过来说，如果传递消息的信道是可靠的，两军问题可解。然而，并不存在这样一种信道，所以两军问题在经典情境下是不可解的，为什么呢？  
倘若蓝军Army1向蓝军Army2派出了通信兵，那么Army1要想知道Army2是否收到了自己的信息，Army1必须要求Army2给自己传输一个回执，说“你的信息我已经收到了，我同意在明天12:00点准时进攻”。  
然而，就算Army2已经送出了这条信息，Army2也不能确定Army1就一定会在这个时间进攻，因为Army2发出的回执Army1并不一定能够收到。所以，Army1必须再给Army2发出一个回执说“我收到了”，但是Army1也不会知道Army2是否收到了这样一个回执，所以Army1还会等待一个Army2的回执。  
就这边不断的陷入了一个永无止境的“回执”循环当中，这对于两方来说都并不一定能够达成十足的确信。同时，这里我们还没有考虑到通信兵的信息有可能被篡改的情况呢。由此可见，经典情形下两军问题是不可解的，并不存在一个能使蓝军一定胜利的通信协议。
## 拜占庭将军问题
拜占庭帝国周围有10个小国，他们饱受拜占庭欺压，却只有同一时间有6个以上国家进攻才有可能击败拜占庭帝国，非则一定战败。然而拜占庭罗马帝国在军事行动中采取将军投票策略来决定是进攻还是撤退，即如果有多数人决定进攻，就整体确定进攻策略。但是军队中如果有奸细（将军有可能反水、传令官有可能篡改信息或误传），那么如何保证最后投票真实反映忠诚将军的的决策呢？这就是拜占庭将军问题。  
该问题的难点在于古时候军队之间的通信完全信赖于人，如果军队中有奸细，无论是将军反水还是传令官误传或篡改，都会令另外9个国家收到假消息，从而造成作战失败。如果你是国王，那么你该如何判断一定会有另外5个以上的国家与你并肩作战呢？毕竟一不小心，就亡国了~~~
**由于类似于以上这样的问题的存在，共识的必要性就浮现了出来！**
# 常见的几种共识机制比较
区块链上的共识机制有多种，但任何一种都不是完美无缺的，或者说适用于所有的应用场景的。
## 工作量证明（POW）
### 什么是POW
POW，工作量证明机制，通过一个竞争机制（计算猜测一个nonce随机值，得以解决规定的哈希问题），让计算工作完成最出色的节点获得记账的权利。POW通过这种算力消耗的经济惩罚限制了恶意节点的参与，因为它需要付出大量的经济成本。而这个计算过程就是挖矿。
### POW工作量证明三要素
1.工作量证明函数：在比特币中使用的是SHA-256算法函数，是密码哈希函数家族中输出为256位的哈希算法。  
2.区块：区块是构成区块链的基本单位，每个区块由区块头和区块主体组成。  
3.难度值：关于难度值可以直接看公式：
    新难度值=旧难度值*（过去2016个区块花费时长/20160分钟）
    目标值=最大目标值/难度值
**新难度值解析：** 撇开旧难度值，按比特币理想情况下每10分钟出块的速度，过去2016个区块的总花费时间接近20160分钟，这样，这个值永远趋于1.  
**目标值解析：**
最大目标值为一个固定数，若过去2016个区块花费时长少于20160分，那么这个系数会小，目标值将会被调大些，反之，目标值会被调小，因此，比特币的难度和出块速度将成反比列适当调整出块速度。
### POW工作量证明流程
从流程图可以看出，POW工作量证明的流程主要经历以下三步：  
1.生成Merkle根Hash  
2.组装区块头：区块头将被作为计算出工作量证明输出的一个输入参数，因此第一步算出来的Merkle根HASH和区块头的其他部分组装成区块头。  
3.计算出工作量证明的输出  
i.工作量证明的输出=SHA-256(SHA-256区块头)  
ii.if(工作量证明的输出=目标值），变更随机数，递归i的逻辑，继续与目标值进行比对。
**PoW的优点：** 完全去中心化、节点自由进出、容易实现、破坏系统花费的成本巨大等等。  
**PoW的缺点：** 对节点性能网络环境要求高、无法达成最终一致性、浪费能源。  
**使用PoW的项目有：** 比特币、莱特币等货币型区块链，以太坊的前三个阶段（Frontier前沿、Homestead家园、Metropolis大都会）。
## 权益证明（POS）
### 什么是POS
POS机制是署名为“Quantum Mechanic”的数字货币爱好者提出的（如下图），它的全称是proof of
stake,中文名即权益证明。顾名思义，这是一种依据各人持币权益来达成共识的机制。它要求用户证明自身拥有货币的数量和时间，也就是证明你对货币的权益。与POW相比，POS的魅力之处在于它可以“屯币得利息”。  
### 币龄概念
POS机制当中引入了币龄的概念，用户拥有的币龄是其持有币数和时间的乘积。以点点币为例，用户每持一币一天拥有一币龄，持一币十天拥有十币龄，持十币十天拥有一百币龄。  
而在POS机制中，用户每获得一定量的币龄，就可以开辟新区块，持有者的币龄越大，发现新区块的几率就越大。新区块开通后，币龄也会被使用消耗，但同时系统会给与一定量货币的奖励，也就是“”屯币有利息”。
### POS的实现原理及公式
要理解POS的实现原理，从POS的实现算法公式来理解更为直接：
    hash(block_header)=target*coinage
币龄的计算：
    coinage=币的个数*币的剩余使用时间
其中，coinage表示币龄，这意味着，币龄越大，越容易得到答案。而其中币龄的计算是通过挖矿者拥有的币乘以每个币的剩下使用时间得到，这也将意味着拥有的币越多，也越容易得到答案。这样，pos解决了pow中浪费资源的问题，同时挖矿者不可能拥有全网51%的币，所以也解决了51%攻击的问题。
### POS权益证明机制的过程
1.验证者把自己的一些货币作为押金投入到POS机制中。  
2.接下来，验证者就会开始验证区块（相对于POW的挖矿过程）。当他们发现一个区块可以添加到区块链时，他们会把自己持有的货币作为投注来验证它。  
3.如果区块被添加到区块链中，那么验证者就会获得跟他们投注的押金成比例的奖励。
**PoS的优点：** 资源消耗少，不需要消耗大量的电力和计算力；同时也缩短了共识达成的时间。  
**PoS的缺点：**
实现较为复杂；中间步骤较多，容易产生安全漏洞；需要时间验证；单纯采用POS机制的区块链产品需要通过IPO的方式来发行，这会导致少数人获得大量成本极低的货币。因此，一般采用POW+POS的双重混合机制，前期通过POW机制挖矿来发行货币，后期发行完货币后通过POS机制来维护网络稳定。
## 股份授权证明（DPOS）
### 什么是DPOS
DPOS是基于POW及POS的基础上，出现的一种新型的保障数字货币网络安全的共识算法。它既能解决POW在挖矿过程中产生的大量能源过耗的问题，也能避免POS权益分配下可能产生的“信任天平”偏颇的问题。