  Logon_Type, values(WorkstaOon_Name) 
  AS 
  WS_Name, 
  values(Source_Network_Address) 
  AS 
  Source_IP, values(Process_Name) 
  AS 
  Process_Name 
  by 
  Account_NameProcess_Name 
  by 
  Account_Name 
  | 
  where 
  Host_Count 
  > 
  2 
45 
4624 
  (Login 
  Success) 
  Results 
  in 
  Splunk 
46 
Query 
  3 
  – 
  5140 
  (Share 
  Accessed) 
Catches 
  crawling 
  shares 
  on 
  different 
  systems 
 index=windows 
  source="WinEventLog:Security" 
  EventCode=5140 
  (Share_Name="*\ \C$" 
  OR 
  Share_Name="*D$" 
  OR 
  Share_Name="*E$" 
  OROR 
  Share_Name="*E$" 
  OR 
  Share_Name="*F$" 
  OR 
Share_Name="*U$") 
  NOT 
  Source_Address="::1" 
  | 
  eval 
DesOnaOon_Sys1=trim(host,"1") 
  | 
  eval 
  DesOnaOon_Sys2=trim(host,"2") 
  | 
  eval Dest_Sys1=lower(DesOnaOon_Sys1) 
  | 
  eval 
  Dest_Sys2=lower(DesOnaOon_Sys2) 
  | rename 
  host 
  AS 
  DesOnaOon 
  | 
  rename 
  Account_Domain 
  AS 
  Domain 
  |Account_Domain 
  AS 
  Domain 
  | 
  where Account_Name!=Dest_Sys1 
  | 
  where 
  Account_Name!=Dest_Sys2 
  | 
  stats 
  count values(Domain) 
  AS 
  Domain, 
  values(Source_Address) 
  AS 
  Source_IP, 
values(DesOnaOon) 
  AS 
  DesOnaOon, 
  dc(DesOnaOon) 
  AS 
  Dest_Count, 
values(Share_Name) 
  AS 
  Share_Name, 
  values(Share_Path) 
  AS 
  Share_Path 
  by Account_Name 
47Share_Path 
  by Account_Name 
47 
5140 
  (Share 
  Accessed) 
  – 
  In 
  Splunk 
48 
Query 
  4 
  – 
  5156 
  (Win 
  FW 
  ConnecOon) 
Shows 
  what 
  process 
  connecOng 
  to 
  an 
  IP 
 index=windows 
  LogName=Security 
  EventCode=5156 
  NOT 
(Source_Address="239.255.255.250" 
  OR 
  Source_Address="224.0.0.*" 
  OR 
Source_Address="::1" 
  OR 
  Source_Address="ff02::*"OR 
  Source_Address="ff02::*" 
  OR 
  Source_Address="fe80::*" OR 
  Source_Address="255.255.255.255" 
  OR 
  Source_Address=192.168.1.255) 
  NOT (DesOnaOon_Address="127.0.0.1" 
  OR 
  DesOnaOon_Address="239.255.255.250" 
  OR DesOnaOon_Address="*.*.*.255" 
  OR 
  DesOnaOon_Address="224.0.0.25*") 
  NOT (DesOnaOon_Port="0") 
  NOT 
  (ApplicaOon_Name="\\icamsource\\" 
  OROR 
ApplicaOon_Name="*\\bin\\splunkd.exe") 
  | 
  dedup 
  DesOnaOon_Address 
DesOnaOon_Port 
  | 
  table 
  _Ome, 
  host, 
  ApplicaOon_Name, 
  DirecOon, 
  Source_Address, Source_Port, 
  DesOnaOon_Address, 
  DesOnaOon_Port 
  | 
  sort 
  DirecOon 
DesOnaOon_Port 
49 
5156 
  -­‐ 
  CSV 
  Output 
  for 
  AddiOonal 
  Processing Used 
  to 
  track 
  BAD 
  IP’s 
50 
Windows 
  FirewallIP’s 
50 
Windows 
  Firewall 
  Logging 
 Set 
  to 
  ANY/ANY 
  mode 
  if 
  Windows 
  Firewall 
  not 
  used. 
  Filter 
  out 
  5158 events 
  as 
  these 
  are 
  not 
  needed 
Do 
  NOT 
  set 
  in 
  Root 
  OU, 
  put 
  lower 
  so 
  you 
  can 
  add 
  and 
  remove systems 
  to 
  the 
  OU 
  to 
  apply 
  this 
  rule 
Export 
  to 
  CSV 
  for 
  manualExport 
  to 
  CSV 
  for 
  manual 
  processing 
Do 
  WhoIS 
  lookup 
  to 
  resolve 
  the 
  Company, 
  Country, 
  etc. 
Create 
  a 
  large 
  Whitelist 
  of 
  good 
  IP’s 
  (lookup 
  list) 
Exclude 
  browsers 
  from 
  one 
  search. 
  The 
  list 
  of 
  IP’s 
  will 
  be 
  much smaller 
  for 
  non 
  browser 
  executables 
  talking 
  to 
  external 
  IP’s 
51to 
  external 
  IP’s 
51 
Query 
  5 
  – 
  7045 
  (New 
  Service 
  Added) New 
  service 
  has 
  been 
  added 
 index=windows 
  LogName=System 
  EventCode=7045 
  NOT (Service_Name=tenable_mw_scan) 
  | 
  eval 
Message=split(Message,".") 
  | 
  eval 
Short_Message=mvindex(Message,0) 
 | 
  table 
  _Ome 
  host 
  Service_Name, 
  Service_Type, 
  Service_Start_Type, Service_Account,Service_Start_Type, Service_Account, 
  Short_Message 
52 
7045 
  (New 
  Service 
  Added) 
  – 
  In 
  Splunk 
53 
Query 
  6 
  – 
  4663 
  (File/Reg 
  AudiOng) 
Filter 
  out/exclude 
  known 
  good 
  noise 
 index=windows 
  sourcetype=WinEventLog:Security 
  EventCode=4663 
  NOT 
  (Process_Name="*\ \Windows\\servicing\\TrustedInstaller.exe" 
  OR 
  "*\\Windows\\System32\\poqexec.exe")"*\\Windows\\System32\\poqexec.exe") 
  NOT (Object_Name="*\\Users\\svc_acct\\pnp“ 
  OR 
  Object_Name="C:\\Users\\Surf\\AppData\ \Local\\Google\\Chrome\\User 
  Data*" 
  NOT 
  Object_Name="C:\\Users\\Surf\\AppData\ \Roaming\\MicrosoW\\Windows\\Recent\\CustomDesOnaOons") 
  NOT 
  (Object_Name="C:\
\Windows\\System32\\LogFiles\\*" 
  OR 
  Object_Name="*ProgramData\\MicrosoW\\RAC\\*" ORObject_Name="*\\MicrosoW\\Windows\\Explorer\\thumbcache*" 
  OR 
Object_Name="*.MAP" 
  OR 
  Object_Name="*counters.dat" 
  OR 
  Object_Name="*\\Windows\ \Gatherlogs\\SystemIndex\\*") 
  | 
  rename 
  Process_Name 
  as 
  Created_By 
  | 
  table 
  _Ome, 
  host, Security_ID, 
  Handle_ID, 
  Object_Type, 
  Object_Name, 
  Process_ID, 
  Created_By, 
  Accesses 
54 
4663 
  (File/RegAccesses 
54 
4663 
  (File/Reg 
  AudiOng) 
  – 
  In 
  Splunk 
55 
You 
  Could 
  Catch 
  CryptoLocker 
File 
  and 
  Registry 
  AudiOng* 
  Tips 
Add 
  this 
  slowly 
  and 
  keep 
  it 
  simple 
  or 
  you 
  will 
  create 
  a 
  lot 
  of 
  noise 
| 
 | Must 
  be 
  set 
  via 
  the 
  GUI 
  (Booo) 
Or 
  use 
  a 
  PowerShell 
  script 
Or 
  by 
  Securityscript 
Or 
  by 
  Security 
  Policy 
  file 
  (File_Audit.inf)  | Must 
  be 
  set 
  via 
  the 
  GUI 
  (Booo) 
Or 
  use 
  a 
  PowerShell 
  script 
Or 
  by 
  Security 
  Policy 
  file 
  (File_Audit.inf)  | Must 
  be 
  set 
  via 
  the 
  GUI 
  (Booo) 
Or 
  use 
  a 
  PowerShell 
  script 
Or 
  by 
  Security 
  Policy 
  file 
  (File_Audit.inf)  |
|---|---|---|---|(File_Audit.inf)  |
|---|---|---|---|
|       |– |Make    one    for    each    File    and    Registry,    apply    via    GPO    or    locally    with    “secedit”  |Make    one    for    each    File    and    Registry,    apply    via    GPO    or    locally    with    “secedit”  |
|       |Audit    only    for:  |Audit    only    for:  |Audit    only    for:  ||       |– |– |Files    -­‐    WriteData    (or    AddFile) |
|       |êCreate    folders    /    append    data,    Change    permissions,    Take    ownership    are    opOonal  |êCreate    folders    /    append    data,    Change    permissions,    Take    ownership    are    opOonal  |êCreate    folders    /    append    data,    Change    permissions,    Take    ownership    are    opOonal  ||       |– |– |Reg    –    Set    Value  ||       |êDelete,    Write    DAC,    Write    Owner    are    opOonal  New    is    what    we    want…    Malware    needs    to    be    added  Start    with    simple    items    like    run    keys,    firewall    policy,    keys    that    are    HIGH    value  |êDelete,    Write    DAC,    Write    Owner    are    opOonal  New    is    what    we    want…    Malware    needs    to    be    added  Start    with    simple    items    like    run    keys,    firewall    policy,    keys    that    are    HIGH    value  |êDelete,    Write    DAC,    Write    Owner    are    opOonal  New    is    what    we    want…    Malware    needs    to    be    added  Start    with    simple    items    like    run    keys,    firewall    policy,    keys    that    are    HIGH    value  |* 
  File 
  & 
  Registry 
  audiOng 
  can 
  also 
  be 
  accomplished 
  with 
  the 
  Splunk 
  App 
  for 
  Windows 
  Infrastructure hFp://docs.splunk.com/DocumentaOon/Splunk/latest/Data/MonitorfilesystemchangesonWindows hFp://docs.splunk.com/DocumentaOon/Splunk/latest/Data/MonitorWindowsregistrydata 
57 
Other 
  Valuable 
  Queries Add 
  these 
  to 
  the 
  list 
 EventIDto 
  the 
  list 
 EventID 
  4657 
  – 
  More 
  details 
  of 
  registry 
  key 
EventID 
  7040 
  – 
  Service 
  changes 
  state 
EventID 
  106 
  – 
  New 
  scheduled 
  job 
EventID 
  501 
  – 
  PowerShell 
  log 
EventID 
  2004, 
  2005, 
  2006 
  – 
  Windows 
  firewall 
  rule 
  added, 
  modified 
or 
  deleted 
Exchange 
  by 
  subject 
–Use 
  to 
  find 
  whosubject 
–Use 
  to 
  find 
  who 
  received 
  a 
  reported 
  phishing 
  email 
Network 
  logs 
  by 
  known 
  Bad 
  IP 
–Who 
  visited 
  a 
  known 
  Bad 
  IP 
  (you 
  populate) 
  that 
  you 
  discover 
  in 
  malware 
  analysis 	or 
  triggered 
  logs 
  menOoned 
  in 
  previous 
  slides 
58 
FREE 
  -­‐ 
  The 
  Windows 
  Splunk 
  Cheat 
  Sheet 
|  | Just 
  forCheat 
  Sheet 
|  | Just 
  for 
  you  |  |
|---|---|---|
|  |All    the    queries    in    this    preso  | |
|  |and    a    few    more  | |
|  |Some    Ops    about    filtering  | |
|  |Found    at:  | |
|  |–MalwareArchaeology.com  | |
59 
Recap 
Takeaways 
1. 
2. 
3. 
4. 
5. Start 
  with 
  the 
  Sexy 
  Six 
  Event 
  ID’s, 
  expand 
  from 
  there 
Enable 
  Command 
  Linethere 
Enable 
  Command 
  Line 
  Logging 
Start 
  Now 
  – 
  Use 
  queries 
  provided 
Use 
  the 
  “Windows 
  Logging 
  Cheat 
  Sheet” 
  – 
  easy 
  to 
  get 
  started Watch 
  my 
  blog 
  for 
  more 
  informaOon 
  -­‐ 
  HackerHurricane.com 
BONUS 
  !!! 
The 
  “Windows 
  Splunk 
  Logging 
  Cheat 
  Sheet” 
  NEW 
  Just 
  for 
  you •MalwareArchaeology.com 
61 
THANK61 
THANK 
  YOU