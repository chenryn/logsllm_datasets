LOCK 前缀。 
试图在实模式或虚拟 8086 模式执行 LLDT、SLDT、LTR、STR、LSL、LAR、VERR、
VERW 或 ARPL 指令。 
不在 SMM 模式（系统管理模式）下执行 RSM（从 SMM 模式返回）指令。 
《软件调试》补编 
- 115 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
还要说明的一定是，对于奔腾 4 和 P6 系列这些支持乱序执行的处理器，只有在可能
导致本异常的指令被回收（retire）时才会真正产生异常，因此投机执行了错误的分支
并不会导致不该发生的异常。类似的，对于奔腾以及更早的 IA-32 处理器，预取
（prefetching）和初步解码也不会产生异常。 
错误代码：无 
保存的程序指针：栈中保存的 CS 和 EIP 值指向的是导致本异常的那条指令。 
程序状态变化：该异常不会伴有程序状态变化，因为无效的指令并没有被执行。 
C.8  设备不可用异常（#NM） 
向量号：7 
异常类型：错误（Fault） 
引入该异常的处理器：80286 最早引入该异常，当时的名字叫无可用数学单元（No Math 
Unit Available），其后的所有 IA-32 处理器都实现了该异常。 
描述：以下情况会导致设备不可用异常（device-not-available）： 
当 CR0 寄存器的 EM 标志为 1 时执行 x87 FPU 浮点指令。处理器使用 EM（Emulation）
位表示其内部没有 x87 FPU 浮点单元。系统软件检测到此标志后，应当设置相应的处
理例程，这样当有 x87 FPU 浮点指令执行时，CPU 便会产生本异常，并交由异常处理
例程处理（可以进一步调用浮点指令仿真程序）。 
当 CR0 寄存器的 MP（Monitor Coprocessor）和 TS（Task Switch）标志为 1 时（不管
EM 位是 0 或 1）执行 WAIT/FWAIT1指令。 
当 CR0 寄存器的 TS 标志为 1 且 EM 标志为 0 时执行 x87 FPU、MMX 或 SSE/SSE2/SSE3
指令，但 MOVNTI、PAUSE、PREFETCHh、SFENCE、LFENCE、MFENCE 和 CLFLUSH
除外。 
CPU在每次任务切换时都会设置TS标志，并在执行 x87 FPU、MMX 和SSE/SSE2/SSE3
指令检查此标志，如果以上条件满足便在执行这些指令前产生此异常，目的是让异常
处理例程保存 x87 FPU、MMX 和 SSE/SSE2/SSE3 的环境信息（context）。 
MP 标志和 TS 标志共同作用决定 WAIT/FWAIT 指令会不会导致#NM 异常。如果 MP
标志为 1，那么当 TS 为 1 时执行 WAIT/FWAIT 指令时便会导致本异常，让异常处理
例程有机会在执行 WAIT 会 FWAIT 指令前保存 x87 FPU 的环境信息（context）。 
错误代码：无 
保存的程序指针：栈中保存的 CS 和 EIP 值指向的是导致本异常的那条指令。 
程序状态变化：该异常不会伴有程序状态变化，因为导致异常的指令没有被执行。 
C.9  双重错误异常（#DF） 
向量号：8 
异常类型：中止（Abort） 
引入该异常的处理器：80286 最早引入该异常，其后所有 IA-32 处理器都实现了该异常。 
1 FWAIT 只是 WAIT 指令的另一个助记符，二者的机器码都是 9B，因此是完全等价的。 
《软件调试》补编 
- 116 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
描述：表明当 CPU 在调用前一个异常处理例程时检测到第二个异常。正常情况下，
当 CPU 在调用一个异常处理例程过程中又检测另一个异常时，它可以顺次的（serially）
进行处理，但是如果处理器无法顺次处理它们，那么便会产生双重错误异常（Double Fault 
Exception）。为了判定对于那些错误组合应该产生双重错误，处理器将异常分为三个类型：
良性（benign）异常、有益（contributory）异常和页错误（page fault）。 
表 C-1  异常的另一种分类 
类型 
向量号码 
描述 
良性异常和中断 
1 
2 
3 
4 
5 
6 
7 
9 
16 
17 
18 
18 
所有 
所有 
调试 
NMI 中断 
断点 
溢出 
数组越界 
无效操作码 
设备不可用 
协处理器段溢出（overrun） 
浮点错误 
对齐检查 
机器检查 
SIMD 浮点 
INT n 
INTR（来自 INTR 管脚的外部中断请求） 
有益异常 
0 
10 
11 
12 
13 
除零 
无效 TSS 
段不存在 
栈错误 
一般保护（GP）异常 
页错误 
14 
页错误异常 
表 C-2 列出了哪些组合会导致双错异常。 
表 C-2  导致双错异常的组合 
第二次异常 
第一次异常 
良性类异常 
有益类异常 
页错误 
良性类异常 
有益类异常 
页错误 
顺次处理 
顺次处理 
顺次处理 
顺次处理 
产生双重异常 
产生双重异常 
顺次处理 
顺次处理 
产生双重异常 
需要注意的是，表 2-12 列出的并非是所有会产生双重错误异常的情况，当 CPU 在试
图将控制权移交给错误处理例程时，任何再发生的错误都会导致双重错误异常。 
如果 CPU 在将控制权移交给双重错误异常的处理例程时又有异常发生，那么 CPU 机
会进入关机模式（shutdown mode）。关机模式类似于执行 HLT（HALT，停止）指令后处
理器所处于的状态。在此状态下，CPU 停止执行任何指令直到： 
有不可屏蔽中断请求发生； 
有 SMI（系统管理中断）请求发生； 
硬复位（hardware reset）； 
对 CPU 的 INIT#管脚置低电平（assertion）。 
当进入关机模式时，CPU 会通过一个特别的总线周期/事务（bus cycle/transaction）输
出关机消息（Shutdown message）以通知前端总线上的系统部件（芯片组）。作为响应，系
《软件调试》补编 
- 117 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
统部件可以采取如下措施： 
打开指示灯通知给用户； 
产生一个 NMI 中断，让 CPU 苏醒并执行 NMI 处理例程，NMI 处理例程可以从芯片
组那里获得状态信息，判断出 CPU 处在关机模式，记录下诊断信息，然后命令芯片
组向设置以下信号之一： 
 RESET#，让 CPU 硬复位； 
 INIT#，让 CPU 软复位； 
 SMI#，让 CPU 转入系统管理模式。 
当 CPU 在执行 NMI 中断处理例程或在系统管理模式下发生关机，那么就只能通过硬
复位使 CPU 重启。 
错误代码：0。对于双重错误异常，CPU 总是向栈中压入错误码 0。 
保存的程序指针：栈中保存的 CS 和 EIP 值的指向未定义。 
程序状态变化：双重错误异常属于中止类异常，该异常发生后的处理器状态没有明确
定义，所以被中断的程序不可以恢复执行。 
双重错误异常处理例程的可以做的事情就是收集可能的环境信息供将来诊断使用。如
果当异常处理机制的机器状态被破坏时有双重错误异常发生，那么处理器将无法调用相应
的处理例程，这是 CPU 只能重启。 
C.10  协处理器段溢出异常 
向量号：9 
异常类型：中止（Abort） 
引入该异常的处理器：286 处理器最早引入该异常， 386 以及 486 的早期版本（在将
数学协处理器集成进 CPU 以前，如 486SX）实现了该异常。从 486DX 开始后的 IA-32 处
理器不再使用此异常。 
描述：该异常表示 CPU（如 386）在向 FPU（数学协处理器，如 387）操作数的中间
部分时检测到了页错误或段不存在异常。从 486DX 开始，这种情况会被当作一般保护异
常（#GP）报告。 
错误代码：无 
保存的程序指针：栈中保存的 CS 和 EIP 值指向的是导致该异常的那条指令。 
程序状态变化：该异常发生后的处理器状态没有明确定义，所以被中断的程序不可以
恢复执行。 
C.11  无效 TSS 异常（#TS） 
向量号：10 
异常类型：错误（Fault） 
引入该异常的处理器：286 最早引入该异常，其后的所有 IA-32 处理器都实现了该异常。 
描述：该异常表示 CPU 在进行任务切换或者执行使用 TSS（任务状态段）信息的指令
《软件调试》补编 
- 118 – 
Copyright © 2009 ADVDBG.ORG All Rights Reserved 
时检测到了一个与 TSS 有关的错误。表 C-3 列出了各种错误情况和该情况导致异常时错
误代码中的索引域内容。总体说来，错误情况是由于以下内容违反了保护模式规则： 
TSS 描述符； 
TSS 指向的 LDT（局部描述符表）； 
TSS 中引用的任何其它段。 
表 C-3  导致无效 TSS 的错误情况 
无效情况 
错误码索引域 
TSS 段的限制小于 67H（32 位的 TSS）或 2CH（16 位 TSS） 
TSS 段选择子索引 
通过 IRET 切换任务时，TSS 段选择子的 TI（table index）标志值代
表的是 LDT（应该为 GDT）。 
TSS 段选择子索引 
通过 IRET 切换任务时，TSS 段选择子的索引值超出描述符表的限
制。 
TSS 段选择子索引 
通过 IRET 切换任务时，TSS 描述符的 busy 标志值代表的是非活动
任务。 
TSS 段选择子索引 
通过 IRET 切换任务时，试图加载 backlink2 limit 时出错。 
TSS 段选择子索引 
通过 IRET 切换任务时，backlink 指向的是空选择子。 
TSS 段选择子索引 
通过 IRET 切换任务时，backlink 选择的 TSS 描述符的 busy 标志不
“繁忙”（not busy）。3 
TSS 段选择子索引 
新的 TSS 描述符超出了 GDT 的限制。 
TSS 段选择子索引 
新的 TSS 描述符是不可写的。 
TSS 段选择子索引 
向旧的 TSS 存储时遇到错误 
TSS 段选择子索引 
通过跳转或 IRET 进行任务切换时旧的 TSS 描述符不可以写 
TSS 段选择子索引 
通过调用（call）或异常进行任务切换时新 TSS 的 backlink 不可以写 
TSS 段选择子索引 
试图锁定新的 TSS 时，新 TSS 的选择子为空 
TSS 段选择子索引 
试图锁定新的 TSS 时发现新 TSS 选择子的 TI 位为 1（1 代表 LDT，
应该为 0 代表 GDT） 
TSS 段选择子索引 
试图锁定新的 TSS 时发现新 TSS 描述符不是可用的 TSS 描述符 
TSS 段选择子索引 
LDT 或 GDT 不存在 
LDT 段选择子索引 
栈段选择子（stack segment selector）超出描述符表限制 
栈段选择子索引 
栈段选择子为空 
栈段选择子索引 
栈段描述符的类型不是数据段 
栈段选择子索引 
栈段不可以写 
栈段选择子索引 
栈段 DPL!=CPL 
栈段选择子索引 
栈段选择子 RPL!=CPL 
栈段选择子索引 
代码段选择子（code segment selector）超出描述符表限制 
代码段选择子索引 
代码段选择子为空 
代码段选择子索引 
代码段描述符的类型不是代码段 
代码段选择子索引 
对于非相容（nonconforming）代码段4，DPL!=CPL 
代码段选择子索引 