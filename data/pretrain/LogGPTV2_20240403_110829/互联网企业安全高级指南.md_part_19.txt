口自动化触发机制建立在阔值之上，就意味着不是完全的自动化，因为阔值是一个经
验和业务场景相关的值
口全局策略是通用性策略，不能对每一个子业务起到很好的防御效果，有可能子业务
已经被D了，全局策略还没触发。
口常见的DDoS类型ADS可以自动处理，但变换形式的DDoS类型可能还需要人工识
别。
口默认的模板策略可能不适用于某些业务，需要自定义。
DDoS防御除了整体架构设计外，比较需要专业技能的地方就是在上述例子的场景
中。目前在ADS设备里覆盖了3～4、7这三层的解决方案。表7-2是常见ADS设备的
功能简介。
表7-2常见ADS设备功能
IPv4威胁防御类型
异常过滤
黑名单/基于HTTP协议字段的过滤/TCP/UDP/other协议负载特征过滤
协议漏润威助防护
IP Spoofing、LAND 攻击、Fraggle 攻击、Smurf 攻击、Winnuke 攻击、Ping of
Death 攻击、Tear Drop 攻击、IP Option 控制攻击、IP分片控制报文攻击、TCP标记
合法性检查攻击、超大ICMP控制报文攻击、ICMP重定向控制报文攻击、ICMP不
可达控制报文攻击等
传输层威势防护
SYN flood 攻击、ACK flood 攻击、SYN-ACK flood 攻击、FIN/RST flood 攻击
TCP fragment flood 攻 击 , UDP flood 攻 击, UDP fragment flood 攻击 、 ICMP flood
扫描窥探型威胁防护
端口扫描攻击、地址扫描攻击、TRACERT控制报文攻击、IP源站选路选项攻击、
IP时间截选项攻击、IP路由记录选项攻击等
DNS 威胁防护
虚假源 DNS query flood 攻击、真实源 DNS query flood 攻击、DNS reply flood 攻
击、DNS缓存投毒攻击、DNS 协议漏洞攻击等
Web成胁防护
HTTP get /post flood 攻击、CC 攻击、HTTP slow header/post 攻击、HTTPS flood
攻击、SSL DoS/DDoS 攻击、TCP连接耗尽攻击、Sockstress 攻击、TCP重传攻击、
TCP空连接攻击等
VOIP 威助防护
SIP flood
---
## Page 118
106技术篇
（续）
僵本螺威胁防护
200+流行僵户木马蜗虫防护。如：LOIC、HOIC、Slowloris、Pyloris、Htp
DosTool、Slowhttptest、Thc-ssl-dos、槐疆篮尸、猎鹰 DDOS、风云白金、小鱼重装
等主流倡尸网络工具
IPv6威胁防御类型
IPv6威助防御类型
ICMP Fragment 报文攻击、黑名单过滤、基于HTTP 协议字段的过滤、支持
TCP/UDP/other 协议负 载特征过部、SYN flood 攻击、ACK flood 双击、SYN-ACK
flood 攻击、FIN/RST flood 攻击、TCP fragment flood 攻击、UDP flood 攻击、UDP
fragment flood攻击、ICMP flood 攻击、虚假源 DNS query flood 攻击、真实源 DNS
query flood攻击、DNS reply flood 攻击、DNS 缓存投毒攻击、DNS 协议漏洞攻击
Fast flux 假户网络、 HTTP get /post flood 攻击 、CC 攻击 HTTP slow header/post 攻击
HTTPS flood 攻击、SSL DoS/DDoS 攻击、TCP 连接耗尽攻击、Sckstress 攻击、TCP
重传攻击、TCP空连接攻击、SIPflood等
IPv4/IPv6 双栈防得
一般情况下ADS设备可以缓解大部分常见的DDoS攻击类型，相对而言3-4层的攻击
手法比较固定，面7层的攻击，由于涉及的协议较多，手法变化层出不穷，所以ADS有时
候对7层的防护做不到面面俱到，比如对CC，ADS提供了HTTP302、验证码等，但还是
不能很好地解决这个问题。应用层的防护需要结合业务来做，ADS则在能利用的场景下承
担辅助角色，比如对于游戏封包的私有协议，通过给packet添加指纹的方式，ADS在客户
端和服务端中间鉴别流人的数据包是否包含指纹。
4. OS/APP层
这是DDoS的最后一道防线。这一层的意义主要在于漏过ADS设备的流量做最后
一次过滤和缓解，对ADS防护不了的应用层协议做补充防护。比如NTP反射，可以通
过服务器配置禁用monlist，如果不提供基于UDP的服务，可以在边界上直接阻断UDP
协议。
互联网在线服务中最大的比重就是Web服务，因此有些互联网公司喜欢自已在系统层
面去做应用层的DDoS防护，例如对抗CC，有时这些功能也能顺带关联到业务安全上，比
如针对黄牛抢单等。
实现方式可以是Web服务器模块，也可以是独立部署的旁路系统，反向代理将完整的
HTTP请求转发给检测服务器，检测服务器根据儿方面的信息，如图7-16所示：
口来自相同IP的并发请求。
---
## Page 119
第7章网络安全107
相同ip+cookie 的并发请求。
口相同HTTP头部可设置字段。
相同的 request URL
相同IP
相网cook
头部字段
&URL
反向代理
CC检测模块
APP服务器
图 7-16七层HTTP抗DDoS示意图
然后保存客户端的连接信息计数表，例如单位时间内相同IP+cookie再次发起连接请求
则此客户端IP的计数器+1，直到触发阅值，然后服务器会进行阻断。为了避免误杀，也可
以选择性地弹出验证码。
以上是拿CC防御举了个例子，ADS设备本身提供了HTTP302跳转、验证码、Java-
Script解析等防御方式，尽管OS和应用层可以做更多的事情，但毕竞有自己去开发和长期
维护的代价，这个收益要看具体情况。
5.链路带宽
大部分介绍DDoS防御策略的文章里似平很少提及这一点：增加带宽，但这个方法却
是以上所有防御的基础，例如第二层次的CDN实际上就是拼带宽，很多大型企业选择自建
CDN，本质上就是自己增加带宽的行为。除了CDN之外，要保障DC出口的多ISP链路、
备份链路，到下层机柜交换机的带宽都不存在明显的单点瓶颈，否则抗DDoS的处理性能
够了，但是流量流经某个节点时突然把一个杂牌交换机压垮了，最后的结果还是表现为有
问题。
对运维经验成熟的互联网公司而言，一般都有能容管理，对于促销活动，高峰时段的
---
## Page 120
108技术篇
带宽，IDC资源的波峰波谷都有预先的准备，DDoS防御主要是消除这些网络方案中内在的
单点瓶颈。
7.2.3不同类型的企业
DDoS的防御本质上属于资源的对抗，完整的4层防御效果虽好，但有一个明显问题
就是TCO，这种成本开销互联网行业排名TOP10以外的公司基本都吃不消。就算付得起这
钱，在IT整体投资的占比会显得过高，付得起不代表这种投资是正确的。所以针对不同的
企业分别描述DDoS缓解方案的倾向和选择性。
1.大型平台公司
这里的“天”有以下几层意思：
口公司很有钱，可以在补贴具体的业务上不“太”计较投人，对土豪来说只选效果最优
方案。
口公司不一定处在很赚钱的阶段，但IDC投资规模足够大，这样为了保障既有的投入，
安全的总投资维持一个固定百分比也是非常有必要的，在IDC盘子很大的时候没必
要省“小钱”。
口与潜在的由于服务中断造成的损失比，DDoS防御的投资可以忽略不计。
映射到现实中与这几条相关的公司：
口市值100亿美元以上互联网公司。
口大型公有云广商，IaaS、PaaS平台。
口利润比较高的业务，比如游戏、在线支付假如被DDoS的赖率较高。
对于IDC规模比较大又有钱的公司来说，防DDoS的口诀就是“背靠运营商，大力建
机房”，在拥有全部的DDoS防御机制的前提下，不断提高IDC基础设施的壁垒给攻击者制
造更高的门槛。对于网络流量比较高的公司而言，抗DDoS是有先天优势的，因为业务急
速增长而带来的基础设施的扩容无意识间就成了一种防御能力。但对于没有那么大业务流
量的公司，空买一堆带宽烧钱恐怕也没人愿意。
对于比较有钱，但没那么多线上服务器的公司面言，自已投入太多IDC建设可能是没
必要的，此时应该转向通过购买的手段尽可能获得全部的DDoS防御机制。
---
## Page 121
第7章网络安全109
2.中小企业
资源的对抗肯定不是中小企业的强项，所以追求ROI是主要的抗DDoS策略。第一种
情况极度省钱模式，平时裸奔，直到受攻击才找抗DDoS厂商临时引流，这种方案效果差
一点，但绝大多数企业都是这种心理，得过且过，能省则省，这也无可厚非，不过遇到关
键事件要知道上哪儿去找谁，知道做哪些事。
第二种情况追求效果，希望有性价比高的方案。如果本身业务运行于公有云平台，可以直
接使用云平台提供的抗DDoS能力，对于Web类企业可以考虑提前购买云清洗厂商的服务。
7.2.4不同类型的业务
不同的类型的服务所需要的DDoS防御机制不完全相同，所以不能直接拿前述4层生
搬硬套。
1. Web
对于Web类服务，攻击发生时终端用户可以有一定的延迟容忍，在防御机制上4
层全部适用，大型平台的一般都是4层全部拥有，规模小一点的企业一般购买云清洗，
cloudflare 类的服务即可。
2.游戏类
WebAPI形式的轻游戏跟Web服务类似，而对于TCPsocket类型的大型网游，稍有延
迟很影响用户体验，甚至很容易掉线。云WAF、CDN等措施因为是针对Web的，所以在
该场景下无效，只有通过DNS引流和ADS来清洗。ADS不能完美防御的部分可以通过修
改客户端、服务端的通信协议做一些辅助性的小动作，例如封包加tag标签，检测到没有
tag的包一律丢弃，防御机制基本都依赖于信息不对称的小技巧。DNS引流的部分对于有
HTTPDNS的厂商可以借助其缓解DNS递归生效的时间。
7.2.5服务策略
口分级策略一对于平台而言，如果有些服务被DDoS会导致全站服务不可用，例如
DNS不可用则相当于全线服务不可用，对于强账号体系应用，例如电商、游戏等，
---
## Page 122
110技术篇
如果SSO登录不可用则全线服务不可用，攻击者只要击垮这些服务就能做到“擒
贼擒王”。所以安全上也需要考虑针对不同的资产使用不同等级的保护策略，根据
BCM的要求，先将资产分类分级，划分出不同的可用性SLA要求，然后根据不同
的SLA实施不同级别的防护，在具体防护策略上，能造成平台级SPOF（单点故障）
的服务或功能应投入更高成本的防御措施，所谓更高成本不仅指购买更多的ADS设
备，同时可以建立多灾备节点，并且在监控和响应优先级上应该更高。
Failover机制—DDoS防御不只是依赖于DDoS防御的那4层手段，同时依赖于基
础设施的强大，例如做分流，就需要多点异地灾备，mirror site &hot site & standby
system，云上的系统需要跨AZ部署，这些是可以随时切换的基础。把鸡蛋放在一个
篮子里会导致没什么选择。
基础设施和应用层面建立余是技术形式上的基础，光有这些还远远不够，需要有与
之配套的DRP&BCP策略集，并且需要真实的周期性的演练，意在遇到超大流量攻击时能
够从容应对。
口有损服务一在应用服务设计的时候，应该尽量避免“单点瓶颈”，避免一个点被
DDoS了整个产品就不好用了，而是希望做到某些服务即使关闭或下线了，仍然不影
响其他在线的服务（或功能），能在遇到需要弃卒保师的场景时有可以“割肉”的选
择，不要除了“0”就是“1”，还是要存在灰度，比如原来10个服务在线，遇到攻
击时我只要保底重要的3个服务在线即可。
补充手段
DDoS攻击的目的不一定完全是出于想打垮服务，比如以前在做游戏时遇到玩家DDoS
服务器的目的竞然是因为没抢到排在第一的房间，这种因素通过产品设计就可以根治。面
有很多应用层DDoS只是为了达成另外一种目的，都跟上述4层纵深防御机制无关，面跟
产品设计有关。所以防御DDoS这事得看一下动因，不能首目应对。
7.2.6NIPS场景
ADS本质上是一个包过滤设备，虽功用不同却跟IPS有点相似，之前也提到有时候需
要提供全站IPS的虚拟补丁功能，ADS设备就可以充当这一角色，只是条目不宜多，只上
有限的条目，下面的是NSFOCUS 的 ADS设备的规则编辑界面，payload可自定义，如图
7-17所示。
---
## Page 123
第7章网络安全111
当安全团队能力尚可的话，可以通过运行POCexploit，然后抓包找出攻击payload的
特征，编辑16进制的匹配规则，即可简单实现人工定制。
255.255.255.4
口
255.295.2654
TOP
RCER
DPGS
OPRN
二
TO88
HVRE
[(+)0-1480]
p-)
大小
长度小于298个字用
00-22 21:14:31