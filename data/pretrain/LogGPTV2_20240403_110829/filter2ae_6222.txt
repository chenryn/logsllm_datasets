# WanaCrypt0r勒索病毒分析

## 译文声明
本文为翻译文章，原文来源于安全客。译文仅供参考，具体内容及含义请以原文为准。

## 作者与投稿信息
- **作者**：MerJerson
- **预估稿费**：700 RMB
- **投稿方式**：发送邮件至 linwei#360.cn 或通过网页版在线投稿

## 相关链接
- [【权威报告】WanaCrypt0r勒索蠕虫完全分析报告](http://bobao.360.cn/learning/detail/3853.html)
- [【安全资讯】遭遇WannaCry（想哭）蠕虫怎么办？防御百科帮你忙！](http://bobao.360.cn/news/detail/4166.html)

## 前言
近日，一种被外媒和多家安全公司命名为“WanaCrypt0r”的勒索病毒席卷全国，尤其在企事业单位和教育网中造成严重影响。该病毒利用NSA泄露的“永恒之蓝”黑客工具攻击Windows系统的445端口。如果用户未安装MS17-010补丁，只需开机上网，病毒即可感染本地系统，加密文件并进行勒索。此次爆发的病毒属于典型的蠕虫类勒索病毒，通过网络传播。接下来我们将针对流量对病毒行为进行详细分析。

## 实验环境
- 操作系统：Windows 7 旗舰版 Service Pack 1
- 工具：
  - Wireshark 1.12.5
  - VMware Workstation 12
  - Process Monitor

## 病毒触发时流量分析
本次分析所用的病毒样本为早期版本。英国研究员@malwaretechblog在Twitter上发现了一个隐藏的“触发开关”。蠕虫启动时会尝试连接一个固定的URL，若连接成功则退出程序，否则将继续攻击。我们首先验证了这一行为。

### 联网状态下的验证
- 在联网状态下触发病毒，等待几分钟后未发现异常。
- 使用Wireshark查看期间的流量信息。
- 过滤DNS流量，发现一条DNS请求被捕获，解析出IP地址为54.153.0.145（此IP不固定，先前回执的还有144.217.254.3和144.217.74.156）。
- 进一步过滤该IP的数据交换，发现三次握手建立连接后进行GET请求，随后RST断开连接。

### 断网状态下的验证
- 断网状态下再次运行病毒，成功触发。
- 查看流量信息，发现大量异常数据包，包括基于ARP的主机发现和针对445端口的TCP SYN扫描。
- 统计显示，病毒不仅扫描当前网段，还随机扫描公网主机以扩大传播范围。

## 病毒传播时流量分析
- 受感染主机A（IP: 192.168.43.101）对未受感染主机B（IP: 192.168.43.32）进行了445端口探测。
- 主机B回复SYN + ACK数据包，随后主机A建立连接并发送SMB数据包进行攻击。
- 对比Eternalblue工具使用的MS17-010 SMB数据包，可以确定此次蠕虫使用的是相同的攻击代码。

## 病毒行为分析
- 在被攻击机中创建一个名为“qweasd”的文件夹，并放置一些jpg格式的图片以便分析。
- 使用Process Monitor监视进程行为，发现病毒执行时的文件为mssecsvc.exe。
- mssecsvc.exe创建了tasksche.exe并在稍后启动它。
- tasksche.exe对“qweasd”文件夹进行了大量查询操作，并创建了加密文件QQWWEE1 (1).jpg.WNCRY。
- 病毒遍历文件夹，获取文件名并创建加密文件，之后频繁读写原始文件和加密文件。

## 病毒逆向分析
- 病毒每次运行时都会请求一个固定的域名，该域名硬编码在程序中。
- 通过反汇编代码发现，域名由InternetOpenUrlA函数调用，根据返回值决定是否继续执行。
- 分析发现病毒会注册一个名为mssecsvc2.0的服务，并开启两个线程进行外网IP 445端口的随机扫描。
- 通过IDA Pro进一步分析，发现病毒使用AES和RSA算法进行文件加密和解密。

## 总结
初次分析病毒时，直接逆向较为困难。由于该病毒是典型的蠕虫病毒，我们先从流量和进程操作等行为入手，逐步深入逆向分析。希望本文能为大家提供一些思路和参考。如有不足之处，请各位指正。

## 相关链接
- [【权威报告】WanaCrypt0r勒索蠕虫完全分析报告](http://bobao.360.cn/learning/detail/3853.html)
- [【安全资讯】遭遇WannaCry（想哭）蠕虫怎么办？防御百科帮你忙！](http://bobao.360.cn/news/detail/4166.html)