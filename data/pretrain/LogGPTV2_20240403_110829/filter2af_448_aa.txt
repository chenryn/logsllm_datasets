作者：启明星辰ADLab
#### 一、威胁概述
近期，思科Talos团队因情况紧急提前公开了一项未完成的研究，该研究提及了一个可能对全球网络产生重大危害的高级威胁攻击(大约有50万台设备受到感染)，由于其核心模块文件为VPNFilter，故该恶意代码也被命名为”VPNFilter”。该攻击是一起以入侵物联网为载体从事可能由国家发起的全球性的高级恶意软件攻击，恶意软件通过三个阶段来部署其攻击武器，目前已经有至少50万台设备受到感染。攻击者利用该恶意软件来控制并监视处于工控网络、办公环境中的网络设备(包含路由器、网关、防火墙以及其他的物联网设备)，其支持工控网络情报收集、重要敏感的流量(登录凭证)截取、流量篡改、定向JS注入、设备破坏性攻击等功能。
恶意软件在5月8日出现大规模的以乌克兰为主要目标的攻击活动，并且在5月17日乌克兰的受感染设备出现大幅度增加，这些受感染设备均受控于C&C
46.151.209.33,
看起来此次攻击目标似乎瞄准乌克兰。乌克兰电力系统曾经受到过两次黑客攻击，并且导致了停电事故，两次攻击均以持久而隐秘的渗透手段入侵到目标。而这次的攻击活动以物联网入口，利用大量存在漏洞的物联网设备作为载体进行撒网式攻击，并且以惊人的速度感染了至少50万台设备，其中包含有华为、中兴、华硕、Dlink、Ubiquiti、UPVEL、Linksys、MikroTik、NETGEAR
和 TP-Link等设备。同样，此次恶意代码与2015年攻击乌克兰电网的BlackEnergy使用相同的变形RC4算法对关键信息进行加密；并且与之类似的是同样也有对主机设备进行重要数据擦除与重启的连环动作以达到让设备无法启动的目的(同时也提高了取证的难度)。
启明星辰ADLab发现该预警后对该恶意软件进行了深入的分析，以剖析其实现机制。我们发现该恶意软件中除了采用图片文件的EXIF数据传输用于下载恶意代码核心组件的C&C外，还采用HTTP头中的location和direct字段传输该C&C，甚至采用了一种我们称之为”SYN隧道技术”的高级隐藏技术来实现恶意软件C&C的被动更新，即使如之前所报道那样，FBI阻断了该恶意软件的C&C，该技术也可以让该恶意软件快速复活。其中第三阶段恶意组件专门针对TCP协议进行嗅探处理，不仅对工控modbus
SCADA协议进行情报收集，同时还会嗅探基于http协议的登录凭证信息和Authorization信息。该嗅探模块需要黑客远程指定modbus服务器进行精确的监控，以发现所有连接的从机设备。此外，在最近公开的攻击插件模块中还可以看出，该次攻击可用于广泛的情报收集以及对特定目标进行渗透攻击，其中包含对80端口的流量重定向、强制转换HTTPS为HTTP以方便流量监控、窃取HTTP请求包中的登录凭证信息、向指定网站的响应数据中注入恶意javascript脚本等等。
#### 二、恶意软件工作原理
该恶意软件通过利用路由器、网关、防火墙等物联网设备漏洞进行广泛的感染和传播。在感染设备中，其首先启动一个Loader模块执行，该模块主要实现了VPNFilter组件的下载与执行。Loader模块并不是直接通过指定的下载地址来下载VPNFilter组件，而是通过多种技术手段来获取VPNFilter的下载地址(存储点)。其首先会向服务器photobucket.com发送请求并尝试解析响应数据中的Locaion、direct、图片EXIF信息来获取；如果失败则向服务器taknowall.com发送请求并解析图片的EXIF来获取；如果仍然无法获取到C&C，则会采用”SYN隧道技术”来获取C&C实现下一个阶段组件的下载地址。此外，VPN存储点获取成功后，Loader通过内置SSL证书文件来验证下载VPNFilter组件。
VPNFilter组件最后会被下载到”/var/run/”目录下，是该类恶意攻击的核心组件，通过该组件，恶意软件得以驻留在被感染系统中。VPNFilter组件为攻击者提供了一个用于维护僵尸网络的框架，攻击者可以基于不同的攻击目的加载不同的插件和执行不同远控控制命令。目前所发现的插件模块有：一个用于支持连接到Tor网络的Tor
客户端（Tor Client,文件tor）；一个为嗅探登录凭证和Modbus工控协议信息的TCP流量嗅探模块（TCP Traffic
Sniffer，文件ps）;一个专门为HTTP 80端口进行流量监控、截取、篡改、注入的HTTP 流量监控模块（HTTP Traffic
Controllor，文件ssler）；以及可用于破坏设备使其无法重启、无法取证的设备破坏模块（Destroy
Module，文件dstr），此外其还存在其他的模块如：mikrotik.o、torrc、ip_tables.ko、iptable_filter.ko、iptable_nat.ko。
#### 三、恶意软件剖析
根据该恶意软件执行攻击的步骤，可以将其划分为三个阶段，其中Loader文件为第一个阶段的恶意模块，VPNFilter文件为第二阶段的恶意模块，Tor客户端和流量嗅探器为第三阶段的恶意模块。以下分别对这三个阶段的恶意代码进行深入的剖析。
##### 第一阶段：感染设备并下载恶意代码主体执行
第一个阶段的样本可以看作是一个Loader（文件名为msvf），攻击者利用设备漏洞将其落地到设备内存中运行。该Loader主要目的是从C&C服务器上下载第二阶段的恶意组件执行。该Loader不同于以往的物联网恶意代码那样将C&C内置于代码内，而是通过在合法图片网站上下载一张隐藏有C&C地址的图片进行解析，从而得到真实的C&C。而恶意代码为了防止流量追踪，采用socks5代理、Tor、以及ssl的方式进行该图片的下载。如果图片下载失败，也会采用极其隐蔽的原始流量数据嗅探的方式来获取C&C。
同时该模块还试图修改NVRAM并将自身加入定时任务文件”crontab”中，以达到常驻的目的。一般物联网恶意代码如mirai等没有涉及常驻机制，使得其在设备重启后会消失。
1.两次创建子进程并且启用恶意代码对当前用户组的读写执行权限
第一阶段样本执行后，会fork两次，第一次用于清理进程资源启用读写执行权限。
第二次fork会在子进程中确认进程文件是否存在，如果不存在会进行文件的回写，防止进行文件丢失。
此外在第二次fork的子进程中，恶意代码为了防止自身文件在设备重启后消失，还会将自身文件加入到crontab文件末尾，以实现开启启动、常驻设备的目的。
2.解密证书文件名、图片链接数据等内容
接下来恶意代码会通过变形的RC4算法来解密后续要用到的字符串和数据，变形RC4秘钥为`“%^:d”`，最新版本已经更新为`“g&*kdj$dg0_@@7’x”`。
变形RC4的stable数据如下：
最后解密得到如下信息，其中包含证书文件名、版本号、build信息、图片url等。
解密url：
3.创建ssl证书文件以及恶意代码版本文件
解密完成后，恶意代码会将代码中内嵌的公钥、私钥数据存储在证书文件中。该恶意代码中存放有三个证书数据，其中两个公钥和一个私钥，公钥存储在文件`“/var/run/client_ca.crt”`和`“/var/run/client.crt”`中，私钥存储在文件`“/var/run/client.key”`中。
此外，版本信息0.3.9qa会被写入到文件/var/run/msvf.pid中。
4.下载第二阶段组件
第二阶段的恶意代码下载地址采用三种方式获取。首先尝试从photobucket网站请求C&C，具体按照如下链接顺序去下载并提取第二阶段恶意代码的服务器地址。
虽然当前这些链接已经失效，但是通过逆向可以看出，如果请求响应码为302，恶意代码则会从响应数据中的”Location”/”location”参数中提取出第二阶段恶意代码的下载地址。
如果恶意代码请求的响应码为200，则会从请求的响应数据包的HTTP头部中提取”direct”参数的值，作为第二阶段恶意代码下载地址。
如果不存在该值，则会从图片文件中的EXIF域提取经纬度数据并将其转换为第二阶段恶意代码下载的IP地址。下载的图片文件EXIF部分数据类似下图。
处理代码如下：
如果以上情况均失败，恶意代码还会尝试请求如下链接，该链接也是一张图片，和上面方法一样从EXIF中提取经纬度并处理得到下载地址。
如果上面的所有方式都尝试后依然无法成功获取C&C地址，恶意代码会通过链接获取到当前设备的外网IP地址，然后嗅探当前设备的原始网络流量数据，并试图从这些流量数据中过滤出符合特定格式的网络数据包，如果满足格式要求，便会从该数据中提取出第二阶段恶意代码的下载地址。其中过滤包时需满足如下条件：
  1. 原始数据流长度必须大于0x3D
  2. 数据包必须为TCP包
  3. 数据包的SYN必须被设置
  4. 目的IP必须为当前设备的公网IP
  5. Tcp Option的MSS(Maximum Segment Size) 必须为0c 15 22 2B（实际上为非法MSS）
如果满足以上条件，则从MSS之后的4个字节提取出C&C的IP地址。我们将这种以SYN
TCP数据流作为数据传输的技术成为”SYN隧道技术”。利用该种技术来传输C&C地址不仅能够很好隐秘黑客的踪迹(无需在恶意代码逆向或者网络存储点上暴露黑客C&C地址)，而且能够灵活的变换C&C，非常难以被发觉。因此，可以说样本中任何内置C&C或者存储C&C的存储点被处置后，该恶意代码仍然可以受控于黑客。这给执法部门处置该恶意代码带来了巨大挑战。原始流的部分判定代码如下：
如果以上任何一种方式能够成功获取到下载地址并且下载组件成功，恶意代码便会直接执行所下载恶意代码，然后退出。下载的第二阶段的恶意代码被保存为文件”/var/vpnfilter”。
##### 第二阶段：控制命令接收、分发、执行
该样本以实现后门控制为目的，其主要用于连接控制端服务器，接收控制命令执行相应的功能控制。样本首先为了确保运行实体的唯一性，会绑定1386端口。如果该端口被占用便会终止运行。此外在新版本中不再通过这种容易自我暴露的方式来做唯一性判定，并且添加了自我删除的功能。
如果绑定成功，便会进入核心工作代码中执行。首先为了防止因CPU资源不足、平台兼容性等问题导致无法工作或者退出，其还注册了大量异常信号用于自我复活。
然后采用同样的变形RC4算法和秘钥来解密关键字符串以供后续使用。接下来会完成后续安装配置流程。
首先检测ssl证书文件是否存在，如果不存在，其会处于等候状态，直到证书文件安装完成。否则开始配置工作目录、设置代理地址、设置Tor网络地址、获取外网IP地址、MAC地址、网络名称等信息。下图为部分安装信息。
接下来创建工作目录/var/run/xxm/及/var/run/xxw并开启主循环，向控制端请求控制命令并且执行相应的控制功能。
控制命令的请求有两种方式，一种是通过socks5代理方式，一种是通过Tor网络请求。通过socks5代理请求的C&C地址如下(在新版本中91.121.109.209被移除)：
91.121.109.209  
217.12.202.40  
94.242.222.68
通过Tor网络请求的地址如下（在新版本中”zuh3vcyskd4gipkm.onion/bin32/update.php”被移除）：
6b57dcnonk2edf5a.onion/bin32/update.php  