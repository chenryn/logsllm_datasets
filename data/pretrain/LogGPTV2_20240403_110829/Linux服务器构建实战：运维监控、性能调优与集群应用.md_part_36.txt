冲文件，这个设定可以加快CGI的配置缓冲，并且在编辑对象配置文件时，可以让正在运行
定一个目录，所有在这个目录下的以.cfg为扩展名的文件都将作为对象配置文件来处理。另
力，而且还不利于日后的维护，此时，就需要另一个变量了，那就是cfg_dir。该变量用于指
加即可。但在有些时候，监控的对象多达几千个，如果都在这里进行引用，那将会非常费
interval_1ength=60
command_check_interval变量用于设置Nagios对外部命令检测的时间间隔，如果指定
command_check_interval=2
check_external_commands变量用于设置是否允许Nagios在Web监控界面上运行CGI
check_external_commands=1
nagios_group变量用于指定Nagios由哪个用户组运行。
nagios_group=nagios
nagios_user变量指定了Nagios进程由哪个用户运行。
nagios_user=nagios
最小更新间隔是1秒。
status_update_interval变量用于定义状态文件（即status.dat）的更新时间间隔，单位是
status_update_interval=10
status_file变量用于定义一个状态文件，此文件用于保存Nagios 的当前状态、注释和岩
status_file=/usr/local/nagios/var/status.dat
resource_file变量用于指定Nagios资源文件的路径，可以在Nagios.cfg中定义多个资源文件。
resource_file=/usr/local/nagios/etc/resource.cfg
object_cache_file变量用于指定一个“所有对象配置文件”的副本文件，又称为对象缓
object_cache_file=/usr/local/nagios/var/objects.cache
Nagios将会递归该目录下的子目录并处理其子目录下的全部配置文件。
cfg_file变量用来引用对象配置文件，如果有更多的对象配置文件，那么在这里依次添
cfg_file=/usr/local/nagios/etc/templates,cfg
cfg_file=/usr/local/nagios/etc/timeperiods.cfg
cfg_file=/usr/local/nagios/etc/contacts.cfg
cfg file=/usr/local/nagios/etc/co
cfg_file=/usr/local/nagios/etc/services.cfg
Linuxidc.com
---
## Page 247
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
9.3.2
略的，因为一般只是建议性的。
件中的哪一行，这使修改Nagios的配置变得非常容易。检测结果中的报警信息通常是可以忽
web，所以修改主机组中的web1为web即可解决问题。
无法找到在hosts.cfg文件的第14行中定义的web1主机，因为在hosts.cfg中定义的主机是
nagios/etc/monitor/hosts.cfg',
确性呢？Nagios在这个方面做得非常到位，只需通过如下一个命令即可完成：
9.3.1
9.3
Nagios配置中所有的时间单位都是分钟。
Nagios提供的这个验证功能非常有用，在错误信息中通常会显示出错的配置文件及在文
有多种启动、停止和重启Nagios的方法，读者可以根据自己的需要，任选其一。
通过Nagios给出的错误提示，可以非常迅速地定位错误根源，由此可以知道，Nagios
Error:
Error:Could not
/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
在上节中，已经配置完成了一个基本的Nagios监控系统。那么如何知道配置文件的正
Processing object
Processing
Processing
Processing 0
Processing object
Reading
Last Modified:
Copyright
Nagios Core 3.2.0
得到的检测结果如下：
interval_length变量指定了Nagios的时间单位，默认值是60秒，也就是1分钟，即在
Error processing object config files!
Nagios的运行和维护
启动与停止Nagios
验证Nagios配置文件的正确性
http://www.nagios.org
GPL
www.Linuxidc.com
object
object
object
(c）
08-12-2009
1999-2009 Ethan Galstad
2009 Nagios Core Development Team and Community Contributors
config
config
config
config
data
file
file
/usr/local/nagios/etc/hosts.cfg'...
'/usr/local/nagios/etc/services.cfg'...
/usr/local/nagios/etc/templates.cfg'..
/usr/local/nagios/etc/contacts.cfg'.
specified in hostgroup
line 14)
(config file /usr/local/nagios/etc/
(config file '/usr/local/
---
## Page 248
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
己的环境和需要选择合适的报警方式即可。
警方式实时性介于邮件和短信之间，但需要编写自定义脚本，因此复杂性稍高。读者根据自
到指定的手机上，但是短信报警方式需要硬件或第三方插件支持，成本略高；MSN和QQ报
加报警的邮件地址即可，但是实时性不好：短信报警实时性最好，可以直接将监控结果发送
报警方式都有自己的优缺点：邮件报警是最普通、最简单的方式，无需任何插件，只需要添
9.3.3Nagios故障报警
来了。图9-2是Nagios的一个Web监控界面截图。
232
Nagios的故障报警功能非常强大，可以支持邮件、短信、MSN、QQ等多种方式，每种
到此为止，Nagios监控系统已经成功搭建并且运行起
ki11 -HUP 
（3）手工方式平滑重启
通过Web监控页重启Nagios，如图9-1所示。
(2）重启Nagios
/etc/rc.d/init.d/nagios reload
（1）通过初始化脚本来重启Nagios
3.重启Nagios
kill 
（2）通过kill方式关闭Nagios
Service nagios stop
或者
/etc/init.d/nagios stop
（1）通过初始化脚本关闭Nagios服务
2.关闭nagios
/usr/1ocal/nagios/bin/nagios -d /usr/local/nagios/etc/nagios.cfg
通过nagios命令的“-d”参数来启动nagios守护进程。
(2）手工方式启动Nagios
Service nagios start
或者
/etc/init.d/nagios start
（1）通过初始化脚本启动Nagios
etc/rc.d/init.d/nagios restart
1.启动Nagios
第4篇
www.Linuxidc.com
运维
图9-1通过Web监控页重启Nagios
停止主机检查
X停止服务检查
通知被禁用
-Naqios进程重自
关闭Nagios进程
进程命令
---
## Page 249
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
警，而图9-4是服务恢复正常后Nagios再次发送的服务正常邮件报警。
下面是两个邮件报警通知的截图，图9-3是服务异常时Nagios发送的服务故障邮件报
Nagios
食
www.Linuxidc .
Connectionrefused
AdditionalInto:
Date/Time: Wed Jan 26 16:48:30 CST 2011
State:CRITICAL
Agoress:192.168.12.237
Service:tp
Notification Type:PROBLEM
** Nagios **
收件人：b126.com
时间：2011年1月26日16:48（期三）
*pROBLEMServlceAlert:Ixdba-mysql/ftpIsCRITICAL**
Nogios
图9-3服务故障时Nagios发送的报警邮件
湖名
图9-2Nagios监控系统截图
SSH
o
服务
06-02-201022:11:24
02202217
安
共个四的服劳已全部提示
所有主机的正常状态
X图
Inteet|模用
日时1分32
##
第9章
运维监控利器Nagios233
.com
10-4019
志信息
PC
6-
实
我
PDG
---
## Page 250
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
的版本是rrdtool-1.4.5.tar.gz。安装过程如下：
9.4.3安装PNP
Nagios采集的数据绘制成相关的图表，然后显示主机或者服务在一段时间内的运行状况。
9.4.2PNP的概念与安装环境
种方式不但烦琐，而且抽象。不过幸运的是，PNP可以帮助我们来完成这个工作。
间内的性能及服务的响应状态，并且形成图表，这就需要通过查看日志数据来分析。但是这
9.4.1Nagios 性能分析图表的作用
9.4
234
RRDtool是一个图表生成工具，可以从http://www.mrtg.org/rdtool/获得信息。这里下载
口安装Perl。
口安装RDDtool工具。
口整合后的Apache和PHP环境，需支持GDizlibljpeg。
如果要安装PNP，首先需要安装如下环境：
PNP是一个小巧的开源软件包，它是基于PHP和Perl的。PNP可以利用rrdtool工具将
Nagios对服务或主机监控的是一个瞬时状态，有时候系统管理员需要了解主机在一段时
Nagios性能分析图表的实现
www.Linuxidc.com
Addbonalinro
Date/Time: Tue Jan 25 21:34:42 CST 2011
State.OK
Address: 192.168.12.251
Host: bcba-web
Service:http
Notificaton Type: RECOVERY
* Nagios *
收件人：dba126.com；
**RECOVERYServiceAlertIxdba-web/htplsOK**
图9-4
服务恢复时Nagios发送的服务正常邮件
我
PDG
---
## Page 251
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
制一份作为PNP配置文件即可。操作如下：
9.4.4
打开Nagios下的 process_perfdata.cfg文件，修改相关内容。操作如下：
2.修改process_perfdata.cfg文件
[root@nagios pnp] #chown -R nagios:nagios /usr/local/nagios/etc/pnp
[rootsnagiosp
[root@nagios etc]#cd /usr/local/nagios/etc/pnp/
在PNP安装完成后，默认安装目录下自带了模板配置文件，因此，只需将模板文件复
root@nagios
1.创建默认配置文件
root@nagios
General Options:
安装完成。PNP默认文件的放置情况如下：
[root@nagios
root@nagios
root@nagios pnp-0.4.13]#make a11
--with-perfdata-dir=/usr/local/nagios/share/perfdata
--with-rrdtool=/usr/local/rrdtool/bin/rrdtool\
root@nagiosp
root@nagios
接着安装PNP，这里下载的版本是pnp-0.4.13.tar.gz。安装过程如下：
RRD Files stored in:
Nagios user/group:
[root@nagios rrdtool-1.4.5]# make install
root@naglos
root@nagios rrdtool-1.4.5]#./configure
[root@nagios rrdtool]# cd rrdtool-1.4.5
[root@nagios rrdtool]# tar zxvf rrdtool-1.4.5.tar.gz
配置PNP
Perfdata files (NPcD)
process_perfdata.pl Logfile:
RRDs Perl Modules:
Path torrdtool:
Config Dir:
HTML Dir:
Install directory
www.Linuxidc.com
pnp]#cp rra.cfg-sample
pnpl#cp
pnp]#cp
pnp-0.4.13l#make instal1-init
pnp-0.4.13]#make
pnp]#cd pnp-0.4.13
pnp]#tar -xvzf pnp-0.4.13.tar.gz
npcd.cfg-sample
process_perfdata.cfg-sample
stored
in:
install-config
rra.cfg
/usr/local/nagios/var/spool/perfdata/
/usr/local/nagios/var/perfdata.log
npcd.cfg
/usr/local/nagios/share/perfdata
+**NOT FOUND ***
/usr/local/bin/rrdtool (Version 1.4.5)
/usr/local/nagios/etc/pnp
/usr/1ocal/nagios/share/pnp
/usr/local/nagios
nagios nagios
--prefix=/usr/local/rrdtool
process_perfdata.cfg
ios235
PDG
---
## Page 252
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
命令的内容替换成此脚本。修改后内容如下：
自动生成。因此，可以将process-host-perfdata和process-service-perfdata 指令中对应的执行
数据的方法，process_perfdata.pl就是PNP自带的一个脚本，这个脚本在PNP安装完成后会
件中。不过这些定义相对简单，而PNP提供了一个Perl脚本，非常详细地定义了一个输出
指令默认已经在commands.cfg文件中进行定义了。
Nagios的主配置文件nagios.cfg，找到如下几项，去掉注释。修改后的信息如下：
为1表示开启Nagios的数据输出功能。因此，如果想让Nagios将数据输出，首先要修改
选项就是用来定义是否开启Nagios的数据输出功能的，这个选项的值可以是0或1，设置
数据来生成图表的。在前面介绍templates.cfg文件时提到“process_perf_data”选项，这个
9.4.5修改Nagios配置文件
236
process-host-perfdata和process-service-perfdata指令声明了Nagios输出哪些值到输出文
3.修改commands.cfg
service_perfdata_command=process-service-perfdata
process_performance_data=1
Nagios监控系统提供的数据接口可供第三方插件使用，而PNP刚好就是调用Nagios的
2.修改nagios.cfg
define service
define host {
修改templates.cfg，增加一个定义PNP的host 和service。修改后的内容如下：
1.增加小太阳图标
这里将日志级别改为2，即debug模式。
LOG_LEVEL =2
LOG_FILE = /usr/local/nagios/var/perfdata.1og
process_perf_data
action_url
name
process_perf_data
name
www.Linuxidc .com
/nagios/pnp/index.php?host=$HOSTNAME$&srv=$SERVICEDESC$
services-pnp
/nagios/pnp/index.php?host=$HosTNAME$
hosts-pnp
---
## Page 253
9.4.6
如下：
完成所有配置之后，重新检查Nagios配置文件是否正确，然后重启Nagios。执行的命
define service{
define service{
修改后的services.cfg内容如下：
define host
define host
将hosts-pnp 和services-pnp 引用到hosts.cfg和 services.cfg中，修改后的hosts.cfg 内容
4.修改hosts.cfg文件和services.cfg文件
define command{