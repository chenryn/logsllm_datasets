# 互联网测量方法与性能分析

## 1. 测量方法概述

### 1.1 主动测量

主动测量包括以下几种协议和工具：

- **ICMP**：用于测量网络延迟。
- **UDP** 和 **TCP**：用于测量带宽和吞吐量。
- **D-ITG**：用于测量端到端延迟、丢包率和抖动。
- **ShaperProbe**：每12小时运行一次，用于测量UDP容量。
- **HTTP传输**：使用`curlget`和`curlput`命令分别进行下载和上传测试，并通过`/proc/net/dev`文件记录传输前后的字节数。

这些测量的频率如下表所示（表3）：

| 协议 | 频率 |
| --- | --- |
| ICMP | 5分钟 |
| UDP | 5分钟 |
| TCP | 30分钟 |
| D-ITG | 15分钟 |
| ShaperProbe | 12小时 |

### 1.2 被动测量

被动测量主要用于记录背景流量对吞吐量的影响。通过比较在传输前后`/proc/net/dev`文件中的字节数变化来计算实际吞吐量。

### 1.3 测量同步

所有测量均同步进行，以避免同一测量服务器上的重叠测量。

## 2. BISMark部署情况

截至2011年1月，BISMark部署了14个网关，涵盖AT&T (DSL) 和Comcast (Cable) 用户，另外还有两个Clear (WiMax) 用户。用户主要来自研究实验室和其他计算机科学系的研究生。本文仅讨论AT&T和Comcast的数据。

## 3. 吞吐量理解

### 3.1 解读吞吐量测量

用户通常关心的是其上行或下行吞吐量，但“吞吐量”的定义因测量方法、时间和测量者而异。例如，Speedtest.net 和Netalyzr 的测量结果可能反映瞬时网络状况，无法作为投诉ISP的依据。不同测量方法可能导致不同的结论。

### 3.2 不同测量方法的比较

我们比较了几种测量上行和下行吞吐量的方法，并将结果归一化为ISP广告宣传的速度。结果显示，多线程TCP会话和UDP容量测量更接近于广告宣传的速度。单线程TCP会话可能受丢包率影响较大，结合被动测量可以提高准确性。

### 3.3 性能一致性

我们分析了SamKnows部署中用户的性能一致性，使用Avg/P95指标（平均吞吐量与第95百分位吞吐量的比值）。大多数用户获得的吞吐量接近其峰值吞吐量。某些ISP（如Cox, Cablevision）的用户在高峰时段下载吞吐量显著下降。

### 3.4 性能不一致的原因

性能不一致的一个原因是时间因素。图8a显示，Cablevision用户在早晚高峰期吞吐量下降约40%，Cox用户则下降约20%。此外，某些ISP在高峰时段性能波动更大，这可能是由于拥塞或限速策略。

## 4. ISP流量整形对吞吐量的影响

ISP通过各种方式整形流量，使得跨ISP和同一ISP内的用户之间难以直接比较。我们研究了PowerBoost在不同ISP、时间和用户中的应用。结果显示，多数有线ISP提供持续时间少于30秒的PowerBoost，速率约为正常速率的1.5倍。Comcast和Cox似乎也提供了上传PowerBoost。

## 结论

不同测量方法捕捉到的吞吐量方面各不相同。单线程TCP会话对丢包敏感，结合被动测量可提高准确性。多线程TCP和UDP容量测量更能准确反映接入链路的容量。许多有线ISP实施PowerBoost，这可能扭曲短期测速结果。任何吞吐量基准测试都应考虑长期性能。