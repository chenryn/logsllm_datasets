52
3.5.3根分区损坏或失效
已经更改了的设备名称、新标签或者不同的UUID。
这些情况下，仅需要重复与处理根文件系统问题相同的步骤，寻找
止启动流程并进入 shell 界面，在这里你可以更深人地了解问题。在
home都已经损坏，无法自动修复或者无法找到，那么系统将会终
挂载了/dev/sda3中的/var和/dev/sdb1中的/home。如果/var或者
这些文件系统都定义在/etc/fstab文件中，看起来可能像下面这样：
3.6
论如何处理硬件问题。
错误。如果你担心磁盘已经完全损坏，请查阅第10章，那里会讨
系统。如果启动流程进人了这个状态，可以查阅4.4节并修正这些
严重，所以启动进程会进人基本的shell界面，需要你手动修复文件
到错误，它会自动开启修复流程。不过，因为很多情况下损坏非常
者磁盘本身失效。当挂载了一个文件系统，如果在文件系统中检测
第3章为什么系统无法启动？解决启动问题
很多服务器都有多个文件系统，在系统启动的时候会自动挂载
另一个内核无法挂载根文件系统的原因可能是文件系统损坏或
在这个例子中，能看到除了/dev/sdal下面的／分区外，系统还
#
#/etc/fstab: static file system information.
/dev/sdb1
/dev/sda2
/dev/sdal
/dev/sda3
proc
无法挂载二级文件系统
/home
/proc
ext3
proc
ext3
swap
defaults
defaults
defaults
defaults
defaults
---
## Page 60
4.1
误。本章将会介绍如何诊断并修复无法写人磁盘的常见问题。
耗尽了全部空间，当进程无法写人硬盘，可能会出现不同寻常的错
什么原因引起的这个问题。如果任由这些日志累积，最终它们将会
特别有价值。当一个自动测试失败的时候，你可能想准确地知道是
很重要的是，如果你负责维护服务器，那么你也不得不处理磁盘满
填满整个磁盘。
序无法在磁盘中写人数据。
或者文件系统损坏的问题。所有问题都有相同的征兆：用户或者程
题）上的硬件不但很容易损坏，而且还有可能是程序的主要瓶颈
的主要来源，很多人都会说是硬件。服务器（第10章会讨论这个问
在DevOps 组织中，当你解决代码问题的时候，记录调试数据
为什么磁盘无法写入？解决磁盘满或
如果你让DevOps团队介绍下Linux服务器中哪一部分是问题
当磁盘空间耗尽的时候，Linux的表现通常非常明显：
磁盘满
一旦发生这种情况，你可能不知道到底是哪个目录
者磁盘损坏的问题
第4章
---
## Page 61
具查看保留区域的大小。例如，下面的命令显示了如何检查已满的
共有 5%的保留区域，不过如果你有 root 权限，可以通过tune2fs 工
·第4章为什么磁盘无法写入？解决磁盘满或者磁盘损坏的问题
来登录，从而移除一些文件。在大多数基于ext的文件系统中，总
件系统满了的时候，root用户在文件系统中仍然有一些空间可以用
磁盘碎片化)。仅有root用户能在这些保留块中写人数据。所以文
称其为保留区域，留作紧急情况出现的时候使用（同时也为了避免
数学能力真的这么糟糕吗？7.4GB除以7.8GB更接近95%才对。
4.1.1
磁盘没有空闲空间，怎么能奢望做到这点呢？
会看到，压缩日志文件是文件系统释放空间的一个方法，但是如果
的文件系统来说，怎么可能登录系统并解决问题？在本章的后面你
已经满了，仅有60KB 的可用空间。当然，对于一个磁盘已经装满
的格式显示，
和可用空间。
区的大小为7.8GB，
一
一步，使用 df工具列出挂载的所有分区信息：分区大小、已用空间
这是因为Linux在文件系统中保留了一定数量的数据块，通常
如果仔细观察 df输出中的数字，你可能会说，等等，Linux 的
在这里你可以看到，系统仅挂载了一个分区/dev/sdal，这个分
当然，由于系统分区的原因，你可能不知道哪个磁盘满了。第
/dev/sdal
Filesystem
$df-h
cp:writing'syslogbackup': No space left on device
$ cp /var/log/sys1og syslogbackup
none
保留区块
，而不是按1KB为单位。
。如果在df后面添加-h 选项，这些信息将会以更易读
，其中已用空间为7.4GB，使用率100%说明它
249M
249M
249M
245M
7.8G
Used Avail Use% Mounted on
7.4G
36K
249M
249M
60K100%
249M
249M
0%/lib/init/rw
1%
0%/var/lock
1%/var/run
/dev/shm
/dev
---
## Page 62
4.1.2找到占用空间最大的目录
我亲切地将它称为“填鸭式命令”：
信息之后，你还需要弄清楚是什么消耗了这些空间。与df类似的
/dev/sdal分区中保留区块的总量：
存到/tmp/duck-root这个文件当中。如果在这个文件上使用tail命
录中，这样我就可以多次查看输出结果，而不用重新运行du命令。
最大。我喜欢将这个结果存到/tmp（如果还有足够的空间的话）目
可以扫描整个文件系统并报告每个文件夹占用了多少空间。如果使
命令 du对于解决这个问题非常有价值。这个命令带上正确的参数
下，它意味着root用户在修复问题的时候大概有400MB的可用空间。
令，你会看到空间使用量最大的前十个目录。
的列表，这个列表记录了占用空间最多的目录，同时将这个列表保
用 sort 命令对结果排序，就能很清楚地看到哪个文件夹消耗的空间
df命令能让你知道每个文件系统有多少空间，但是知道这些
这条命令不会在屏幕上输出任何信息，而是创建一个经过排序
$sudo du-ckx|sort-n>/tmp/duck-root
Scd/
如果用103667除以2073344，就会看到结果约为5%，在这种情况
$sudo tail/tmp/duck-root
Reserved block count:
Block count:
404168 total
404168/
124164 /usr
82832/1ib
76924/usr/share
69092/var/cache/apt
67876/1ib/modules
67872/lib/modules/2.6.24-19-server
69448/var/cache
103667
2073344
4.1磁盘满55
---
## Page 63
56
·第4章为什么磁盘无法写入？解决磁盘满或者磁盘损坏的问题
录下的其他文件夹中。在任何一种情况下，都会发生系统上的特定
的大文件导致。特别地，有很多很大的.swp类型的文件。当用Vim
的情况，通常会导致系统“冻结”），结果发现这个问题是由/tmp 中
注意
在 /etc/logrotate.conf和/etc/logrotate.d/中稍微修改下 logrotate的
打开一个文件的时候，它会将整个文件内容复制到一个.tmp文件
设置，保证它可以自动帮你压缩日志文件。
时，你应该截断（一般就是删除部分内容）一个特定的文件：
/var/log文件夹占用了大部分磁盘空间，那么你就可以进人这个目
的时候，这主要是因为日志文件的增长失去了控制。如果你看到
间的目录（如/usr 目录）不能乱动，不过一般当剩余空间迅速减少
一些版本会放入/var/tmp目录中或者还有一些版本会放到~/tmp目
中。根据Vim的版本，某些版本会将.swp文件放在/tmp目录中，
掉。如果你发现磁盘空间问题是由未压缩的日志引起，那么你可以
录，输人 sudo Is -ls 这个命令，根据文件大小列出所有的文件。此
看到所有的目录。
以用诸如 less 或者其他文本编辑工具打开 duck-root 文件，这样就能
目录占用的空间占/var/cache这个目录的绝大部分。当然，你也可
cache这两个文件夹分开了，所以你可以发现/var/cache/apt这个子
/usr/share和/var/cache目录。注意，输出将/var/cache/apt 和/var/
尾），那么若它未压缩就压缩一下，若不需要这个日志文件就将它删
我已经遇到不知道多少次/文件系统满的警告（这是非常危险
你可以用这些输出做些什么呢？部分情况下，占用了大多数空
logrotate是Linux系统中的一款日志管理工具。——译者注
在这个例子中，/usr 目录占用了绝大多数空间，紧接着是/lib
还有一种方法，如果大文件之一已经被分割（以.1或者.2结
$ sudo sh -c "> /var/log/messages"
---
## Page 64
不过，某些服务器在特定的文件系统中存储了上百万个文件，在这
统说它已经满了，但是当你运行df命令时，却发现还有足够空间
4.2
造成这种情形的Vim进程。
占据根文件系统的整个空间。为了解决这个问题，需要定位并终止
文件的时候，就会在/tmp目录下创建一个数吉字节的.swp文件，
用户将查看几吉字节的Apache日志文件的情况。当用户打开这个
种情况下就可能达到节点的上限。df-i命令会给出节点使用信息：
点用完，就无法再创建新文件。一般来说，无法用掉这么多节点，
分区大小。
个文件系统的时候，mkfs工具根据可使用的节点的最大数量决定
了节点资源（节点就是保存文件信息的数据结构）。当你格式化一
的情况。如果遇到了这种情况，首先你需要检查的是：是否耗尽
前那个硬盘从而获得更多的节点，然后再将文件复制回去。
压缩成一个文件；或者将这些文件备份到当前文件系统，格式化之
的文件或者将这些文件移动到另一个文件系统当中；将大量的文件
当用掉了全部节点的时候，仅有以下几种选择：找出大量可以删除
中的17539个，也就是说你还能在系统中再创建502653个文件。
另一种不常见但是非常棘手的情况是：你可能处于一种文件系
在文件系统中创建一个新文件会得到一个唯一节点，
在这个例子中，根分区总共有520192个节点，但仅使用了其
$df-i
/dev/sda520192175395026534%/
FilesystemInodes IUsed IFreeIUse% Mounted on
节点不足
4.2节点不足57
一旦把节
---
## Page 65
58
当 fsck 检查失败之后，通常会看到启动过程终止。最好能进入恢复
文件系统，但是系统偶尔可能损坏比较严重，需要一些手动操作
（名为fsck）来尝试修复文件系统。一般fsck的默认设置就足以修复
其他什么错误。通常Linux 会在启动的时候自动运行一个检查命令
件系统还是无法正常挂载，请参阅下一节的内容。
得不重启系统，这样它才能自检并重载文件系统。如果重启后，文
4.4
filesystem read-only的日志人口点。
些行。你应该看下输出中ext3 找到的错误以及声明为 Remounting
此，可以检查 dmesg 命令的输出，尤其是以 EXT3-fs error 开头的那
统会检测到严重的问题并采取措施自我保护。为了确定是否真的如
件之间抽象的部分。当在这两者之间出现一些意外的时候，文件系
我猜在虚拟机中这类问题更为常见，它会出现在虚拟磁盘和物理硬
/home分区只读，你需要输人：
误。如果可以，第一步要做的就是重新挂载文件系统。例如，如果
个分区。如果它是根分区，或者重载不起作用，那么很遗憾，你不
是根分区，并且能卸载整个分区，那么可以尝试完全卸载并移除这
误，所以它将磁盘挂载为只读属性，防止磁盘受到进一步的破坏
复制或者保存一个文件的时候，就会得到一个文件系统只读的错
4.3
第4章为什么磁盘无法写入？解决磁盘满或者磁盘损坏的问题
文件系统损坏可能出现在很多场景中，比如说由于冷启动或者
所以当你遇到这个问题的时候，应该怎么做？如果文件系统不
你可能会遇到文件系统未满却无法写人的情况。
如果你遇到了这个错误，很可能是因为文件系统遇到了一些错
$sudo mount-o remount,rw /home
修复损坏的文件系统
文件系统只读
，每当你想要
---
## Page 66