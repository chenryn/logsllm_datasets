Winnti%Polymorphism%
Takahiro%Haruyama%
Symantec%
Who%am%I?%
•  Takahiro%Haruyama%(@cci_forensics)%
•  Reverse%Engineer%at%Symantec%
–  Managed%Adversary%and%Threat%Intelligence%(MATI)%
•  https://www.symantec.com/services/cyber-security-services/
deepsight-intelligence/adversary%
•  Speaker%
–  BlackHat%Brieﬁngs%USA/EU/Asia,%SANS%DFIR%Summit,%
CEIC,%DFRWS%EU,%SECURE,%FIRST,%RSA%Conference%JP,%
etc…%
2%
Motivation%
•  Winnti%is%malware%used%by%Chinese%threat%actor%for%
cybercrime%and%cyber%espionage%since%2009%
•  Kaspersky%and%Novetta%published%good%white%papers%
about%Winnti%[1]%[2]%
•  Winnti%is%still%active%and%changing%
–  Variants%whose%behavior%is%diﬀerent%from%past%reports%
–  Targets%except%game%and%pharmaceutical%industries%
•  I’d%like%to%ﬁll%the%gaps%
3%
Agenda%
•  Winnti%Components%and%Binaries%
•  Getting%Target%Information%from%Winnti%
Samples%
•  Wrap-up%
4%
Winnti%Components%and%Binaries%
5%
Winnti%Execution%Flow%
%
6%
Dropper
Engine
2. run
3. load
& run
Service-
with-conﬁg
Worker-
with-conﬁg
(encrypted)
1. drop
5. load
memory-resident 
or omitted
4. decrypt
& run
rootkit
drivers
C2-server
6. connect 
to C2
New%Findings%
%
7%
Dropper
Engine
other,
malware,family
2. run
3. load
& run
Service,
with,conﬁg
Worker,
with,conﬁg
(encrypted)
1. drop
5. load
decrypt & run
(rare samples only)
memory-resident 
or omitted
or ﬁle
client,malware?,on,
other,machines
4. decrypt
& run
rootkit
drivers
C2,server
6. connect 
to C2
connected
through
covert 
channel
SMTP
supported
Dropper%Component%
•  extract%other%components%from%inline%DES-protected%blob%
–  the%dropped%components%are%%
•  service%and%worker%
•  additionally%engine%with%other%malware%family%(but%that%is%rare)%
–  the%password%is%passed%from%command%line%argument%
–  Some%samples%add%dropper’s%conﬁguration%into%the%overlays%of%the%
components%
•  run%service%component%
–  /rundll32.exe%"%s",%\w+%%s/%
–  the%export%function%name%often%changes%
•  Install,%DlgProc,%gzopen_r,%Init,%sql_init,%sqlite3_backup_deinit,%etc...%
8%
Service%Component%
•  load%engine%component%from%inline%blob%
–  the%values%in%PE%header%are%eliminated%
•  e.g.,%MZ/PE%signatures,%machine%architecture,%
NumberOfRvaAndSizes,%etc...%
•  call%engine’s%export%functions%%
–  some%variants%use%the%API%hashes%
•  e.g.,%0x0C148B03%=%"Install”,%0x3013465F%=%"DeleteF"%
9%
Engine%Component 
•  memory-resident%
–  some%samples%are%saved%as%ﬁles%with%the%same%
encryption%of%worker%component%
•  export%function%names%
–  Install,%DeleteF,%and%Workmain%
•  try%to%bypass%UAC%dialog%then%create%service%
•  decrypt/run%worker%component%
–  PE%header%values%eliminated,%1%byte%xor%&%nibble%swap%
10%
Worker%Component%
•  export%function%names%
–  work_start,%work_end%
•  plugin%management%
–  the%plugins%are%cached%on%disk%or%memory-resident%
•  supported%C2%protocols%
–  TCP%=%header%+%LZMA-compressed%payload%
–  HTTP,%HTTPS%=%zlib-compressed%payload%as%POST%data%
–  SMTP%
11%
SMTP%Worker%Component%
•  Some%worker%components%support%SMTP%
–  the%conﬁg%contains%email%addresses%and%more%obfuscated%
(incremental%xor%+%dword%xor)%
•  Public%code%is%reused%
–  The%old%code%looks%copied%from%PRC-based%Mandarin-language%
programming%and%code%sharing%forum%[3]%
•  The%hard-coded%sender%email%and%password%are%"PI:EMAIL"%and%
"test123456”%
–  The%new%code%looks%similar%to%the%one%distributed%in%Code%Project%[4]%
•  STARTTLS%is%newly%supported%to%encrypt%the%SMTP%traﬃc%
12%
SMTP%Worker%Component%(Cont.)%
for%decrypting%each%member%%
QQMail%[5]%account%is%used%%
for%sending%
recipient%email%addresses%
13%
VSEC%Variant%[6] 
•  Two%main%diﬀerences%compared%with%Novetta%variant%
[2]%
–  no%engine%component%
•  service%component%directly%calls%worker%component%%
–  worker’s%export%function%name%is%“DllUnregisterServer”%
•  takes%immediate%values%according%to%the%functions%
–  e.g.,%0x201401%=%delete%ﬁle,%0x201402%=%dll/code%injection,%0x201404%=%
run%inline%main%DLL%
•  recently%more%active%than%Novetta%variant?%
14%
VSEC%Variant%(Cont.)%
•  unique%persistence%
–  Some%samples%modify%IAT%
of%legitimate%windows%dlls%
to%load%service%component%
–  the%target%dll%name%is%
included%in%the%
conﬁguration%
•  e.g.,%wbemcomn.dll,%
loadperf.dll%
worker%
infected%
Windows%dll%
service%
15%
Winnti%as%a%Loader%
•  Some%engine%components%
embeds%other%malware%
family%like%Gh0st%and%
PlugX%
–  the%conﬁguration%is%
encrypted%by%Winnti%and%
the%malware%algorithm%
–  the%conﬁg%members%are%
the%malware%speciﬁc%+%
Winnti%strings%
Winnti-related%members%
16%
Related%Kernel%Drivers%
•  Kernel%rootkit%drivers%are%included%in%worker%
components%
–  hiding%TCP%connections%
•  The%same%driver%is%also%used%by%Derusbi%[7]%%
–  making%covert%channels%with%other%client%machines%
•  The%behavior%is%similar%to%WFP%callout%driver%of%Derusbi%
server%variant%[8]%but%the%implementation%is%diﬀerent%
17%
Related%Kernel%Drivers%(Cont.)%
•  The%rootkit%hooks%TCPIP%Network%Device%Interface%Speciﬁcation%
(NDIS)%protocol%handlers%