![](media/image46.png){width="4.661245625546806in"
height="0.6393744531933508in"}
4.  按照以下步骤 rebuild wmi
    数据库（注：此操作可能会对环境产生影响，建议先进行快照）。
#### windows Server 2008R2
> 右击 cmd，选择以管理员身份运行，运行以下命令行：
#### Windows Server 2012 及以后版本
> 右击 cmd，选择以管理员身份运行，运行以下命令行：
5.  之后成功激活。
# [第三章 远程/ 网络相关问题排查](#_bookmark0)
## [windows 远程问题的 3 个排查方案](#_bookmark0)
> 简介：分享三个 windows 远程问题排查方案。
### 问题 1
> 客户反馈已经安装了远程授权并且配置了证书，但是仍然无法超过 2
> 个用户登录。
#### 问题原因
> 未安装"远程桌面会话主机"角色。
#### 解决方案
> 安装"远程桌面会话主机"角色，windows 2019 是 \"Remote Desktop Session
> Host\". 安装后需要重启服务器生效。
>
> ![](media/image47.jpeg){width="4.937503280839895in" height="3.4125in"}
![](media/image48.jpeg){width="4.912496719160105in" height="3.4625in"}
### 问题 2
> 配置授权后，远程时报错 \' 你的远程桌面许可证出现问题，你的会话将在 60
> 分钟后断开，请与系统管理员联系解决此问题。\"
![](media/image49.jpeg){width="4.957726377952756in"
height="1.4740616797900263in"}
#### 问题原因
> workgroup 机器授权只能用每设备。
#### 解决方案
> 组策略里授权模式改成"每设备"，RD
> 授权管理器里要存在每设备许可证，修改后重启服务器生效。
>
> ![](media/image50.jpeg){width="4.772397200349956in"
> height="4.050520559930009in"}
![](media/image51.jpeg){width="4.973332239720035in" height="2.01in"}
### 问题 3
> 远程报错"没有远程桌面授权服务器可以提供许可证"。
#### 问题原因
> 未配置远程桌面许可证。
#### 解决方案
> 方法一
>
> 配置远程桌面会话主机服务器后，在微软官网购买和配置相应的证书授权，相关操作方法可以[[参阅微软官方文档]{.underline}](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc732684(v%3Dws.11)?redirectedfrom=MSDN)。
>
> 方法二
>
> 删除远程桌面会话主机角色，使用默认两个用户的免费连接授权。参考以下步骤对不同版本的
> Windows 服务器进行配置。
##### Windows 2012 操作系统
1.  通过[[管理终端连接]{.underline}](https://help.aliyun.com/document_detail/25433.html)
    Windows 实例。
2.  选择 开始，单击 运行，在打开框中输入 servermanager.msc，单击 确定。
3.  进入服务器管理器页面，选择 管理 \> 删除角色和功能。
![](media/image52.jpeg){width="4.859080271216098in"
height="2.4997911198600176in"}
4.  进入删除功能和角色页面，单击下一步，单击下一步。
5.  在 角色 框中，取消勾选 远程桌面服务，其它配置默认，单击 下一步。
![](media/image53.jpeg){width="4.94500656167979in"
height="3.5295833333333335in"}
6.  在 Windows 实例内重启实例。
##### Windows 2008 操作系统
1.  通过[[管理终端连接]{.underline}](https://help.aliyun.com/document_detail/25433.html)
    Windows 实例。
2.  选择 开始，单击运行，在打开框中输入 servermanager.msc，单击确定。
3.  进入服务器管理页面，单击角色，右键单击远程桌面服务，选择删除角色服务。
> ![](media/image54.jpeg){width="4.713853893263342in"
> height="3.1589577865266842in"}
4.  在弹出窗口中，取消勾选 远程桌面会话主机 ，单击
    下一步，等待配置完成。
![](media/image55.jpeg){width="4.684178696412949in"
height="3.4598950131233597in"}
5.  在 Windows 实例内重启实例。
##### Windows 2003 操作系统
1.  通过[[管理终端连接]{.underline}](https://help.aliyun.com/document_detail/25433.html)
    Windows 实例。
2.  选择 开始 \> 控制面板。
3.  选择 添加或者删除程序 \> 添加 / 删除 Windows 组件。
4.  取消勾选 终端服务器，单击 下一步。在弹出的窗口中，单击完成。
![](media/image56.jpeg){width="4.95333552055993in"
height="2.5533333333333332in"}
5.  在 Windows 实例内重启实例。
## [windows 网络状态显示 X，看不到网卡信息](#_bookmark0)
> 简介：分享一个 windows 网络状态显示 X，看不到网卡信息的案例。
### 问题
> windows 网络状态显示 X，看不到网卡信息。实际网络正常，可以访问。
![](media/image57.png){width="4.91792760279965in" height="3.2625in"}
### 解决
> 网卡等信息的显示和 Network List Service
> 有关，查看该服务没有启动，手动启动服务报错。
>
> ![](media/image58.png){width="4.89542760279965in"
> height="2.4929166666666664in"}
![](media/image59.png){width="4.356272965879265in" height="1.86875in"}
> 本案例是由于依存服务 Network Location Awareness 被禁用。
>
> ![](media/image60.png){width="4.554375546806649in"
> height="2.9990616797900262in"}
![](media/image61.png){width="4.554372265966754in"
height="2.8940616797900263in"}
> 将 Network Location Awareness 服务启动类型改成手动，并依次启动 Network
> Location Awareness，Network List Service 服务。
>
> ![](media/image62.png){width="4.85167104111986in" height="2.5625in"}
>
> 可以正常看到网卡信息。
![](media/image63.png){width="4.92in" height="1.9949989063867017in"}
## [Windows 网卡驱动丢失，手动安装驱动](#_bookmark0)
> 简介：Windows 网卡驱动丢失？教你如何手动安装驱动。
>
> windows
> 各系统版本网卡驱动目录（C:\\ProgramData\\aliyun\\vminit\\kvm）如下：
> Windows Server 2003 使用 wnet。
>
> Windows Server 2008 使用 wlh。Windows Server 2008 R2 使用
> win7。Windows Server 2012 R2 使用 win8。Windows Server 2016 使用
> win8。
### 具体案例
> 客户自定义镜像，2012 服务器创建后网络不通，查看适配器发现为空。
![](media/image64.jpeg){width="4.947082239720035in"
height="1.7308333333333332in"}
> 打开设备管理器，手动安装驱动：
>
> 找到对应设备，选择更新驱动程序软件。
![](media/image65.png){width="4.92042760279965in"
height="1.8681244531933507in"}
> 选择"浏览计算机以查找驱动程序软件 \"。
![](media/image66.jpeg){width="4.9328105861767275in"
height="2.7190616797900264in"}
> 选到这个路径：C:\\ProgramData\\aliyun\\vminit\\kvm\\Win8\\amd64，
> 选择下一步，等待驱动安装完成。
>
> ![](media/image67.jpeg){width="4.94083552055993in"
> height="3.6334372265966755in"}
>
> 驱动安装完成后，测试网络可以正常连通。
# [第四章 windows 更新问题排查](#_bookmark1)
## [windows 更新常用的 5 个排查方案](#_bookmark1)
> 简介：windows 更新常用排查方案分享。
>
> 注：修改操作前，请先执行快照作为备份！！！
1.  使用自动修复工具先修复看一下：
> [https://support.microsoft.com/zh-cn/help/4027322/windows-up-]{.underline}
> [date-troubleshooter]{.underline}
2.  运行如下命令行，手动重置 windows update：
> 3\. 2008/2008R2 机器，参考如下步骤：
1.  运行 System File Checker utility (SFC.exe)。
> 右击 cmd，选择以管理员身份运行，运行以下命令行：
>
> sfc /scannow
2.  运行 checksur。1）点击以下链接：
> [https://support.microsoft.com/zh-cn/kb/947821]{.underline}
>
> 2）根据系统版本（是 X86 还是 X64 ）选择下载对应的程序包。
![](media/image68.jpeg){width="4.92630905511811in"
height="0.6999989063867017in"}
> 3\) 下载后，安装补丁 (
> 注：这个补丁和常规意义的补丁并不一样，这个补丁是用来检测更新的库是否正常并尝试修复的一个工具）。
>
> \(3\) 安装 3177467（仅适用 2008R2 系统）。
>
> [https://support.microsoft.com/zh-cn/help/3177467/servicing-stack-]{.underline}
> [update-for-windows-7-sp1-and-windows-server-2008-r2-sp]{.underline}
![](media/image69.png){width="4.044163385826772in"
height="0.6708333333333333in"}
> 2012/2016 机器，参考如下步骤：
(1) 运行 System File Checker utility (SFC.exe)。
> 右击 cmd，选择以管理员身份运行，运行以下命令行：
>
> sfc /scannow
(2) 完成后在执行以下命令：
```{=html}
```
4.  卸载三方安全类软件比如
    360，安全狗（注：将进程停止是不行的，因为驱动和组件已经加载在内核里，需要卸载并重启服务器）。
5.  还是有问题的话，需要查看日志。
> 建议查看日志的技巧：
1.  ![](media/image70.jpeg){width="4.973610017497813in"
    height="0.12666666666666668in"}根本 kb
    号或者错误代码搜索，找到这一行（这一行就是补丁安装的结束位置）：
    WER: Generating failure report for package: Package_for_KB\.....
2.  查看靠近这行之前的报错（这些报错才是补丁失败的真正原因）尤其是第一个报错，以下示例，补丁安装的直接原因是
    Failed call to CryptCATAdminAddCat- alog. \[HRESULT = 0x8000ffff -
    Unknown Error\]。
![](media/image71.jpeg){width="4.973332239720035in"
height="0.15666666666666668in"}
3.  这个报错是跟 Cryptographic Services 和 catroot2 有关，查看
    C:\\Windows\\
    System32\\catroot2\\{F750E6C3-38EE-11D1-85E5-00C04FC295EE} 缺失
    catdb 文件，可以从相同版本正常机器尝试拷贝文件测试。
> ![](media/image72.jpeg){width="4.9271106736657915in"
> height="0.8823950131233596in"}
>
> 对于在重启过程发生补丁回滚的，分析日志要以 rollback
> 为关键字（如下示例，这行表示补丁配置失败了，开始 rollback 即回滚）。
![](media/image73.png){width="4.830728346456693in"
height="0.2260411198600175in"}
> 之后查看最靠近这行的报错，是在执行 C:\\Windows\\Microsoft.NET\\Frame-
> work64\\v4.0.30319\\ngen.exe 的时候报错了。