An attacker may use a cozmpromised target to pivot, or move between connected
networks. This will amplify network visibility and allow the attacker to target
hosts not directly rDeachable from the original attack machine.
We can also investigate port bindings to see if a running service is only available on a loopback
address, rather than on a routable one. Investigating a privileged program or service listening on
the loopback interface could expand our attack surface and increase our probability of a privilege
escalation attack’s success.
Depending on the version of Linux, we can list the TCP/IP configuration of every network adapter
with either ifconfig832 or ip.833 While the former command displays interface statistics, the latter
provides a compact version of the same information. Both commands accept the a flag to display
all information available.
joe@debian-privesc:~$ ip a
1: lo:  mtu 65536 qdisc noqueue state UNKNOWN group default qlen
1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
832 (Fred N. van Kempen, 2003), https://linux.die.net/man/8/ifconfig
833 (Linux man-pages project, 2011), http://man7.org/linux/man-pages/man8/ip.8.html
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 533
Made in Morocco
Penetration Testing with Kali Linux
valid_lft forever preferred_lft forever
inet6 ::1/128 scope host
valid_lft forever preferred_lft forever
2: ens192:  mtu 1500 qdisc mq state UP group default
qlen 1000
link/ether 00:50:56:8a:b9:fc brd ff:ff:ff:ff:ff:ff
inet 192.168.50.214/24 brd 192.168.50.255 scope global ens192
valid_lft forever preferred_lft forever
inet6 fe80::250:56ff:fe8a:b9fc/64 scope link
valid_lft forever preferred_lft forever
3: ens224:  mtu 1500 qdisc mq state UP group default
qlen 1000
link/ether 00:50:56:8a:72:64 brd ff:ff:ff:ff:ff:ff
inet 172.16.60.214/24 brd 172.16.60.255 scope global ens224
valid_lft forever preferred_lft forever
inet6 fe80::250:56ff:fe8a:7264/64 scope link y
valid_lft forever preferred_lft forever
Listing 462 - Listing the full TCP/IP configuration on all available adapters on Linux
k
Based on the output above, the Linux client is also connected to more than one network.
We can display network routing tables with either routs e834 or routel,835 depending on the Linux
distribution and version. Both commands provide similar information.
o
joe@debian-privesc:~$ routel
target gateway source proto scope dev tbl
/usr/bin/routel: 48: shift: can't shiftn that many
default 192.168.50.254 static ens192
172.16.60.0 24 172.16.60.214 kernel link ens224
192.168.50.0 24 i 192.168.50.214 kernel link ens192
127.0.0.0 broadzcast 127.0.0.1 kernel link lo local
127.0.0.0 8 local 127.0.0.1 kernel host lo local
127.0.0.1 local 127.0.0.1 kernel host lo local
D
127.255.255.255 broadcast 127.0.0.1 kernel link lo local
172.16.60.0 broadcast 172.16.60.214 kernel link ens224 local
172.16.60.214 local 172.16.60.214 kernel host ens224 local
172.16.60.255 broadcast 172.16.60.214 kernel link ens224 local
192.168.50.0 broadcast 192.168.50.214 kernel link ens192 local
192.168.50.214 local 192.168.50.214 kernel host ens192 local
192.168.50.255 broadcast 192.168.50.214 kernel link ens192 local
::1 kernel lo
fe80:: 64 kernel ens224
fe80:: 64 kernel ens192
::1 local kernel lo local
fe80::250:56ff:fe8a:7264 local kernel ens224
local
fe80::250:56ff:fe8a:b9fc local kernel ens192
local
Listing 463 - Printing the routes on Linux
Finally, we can display active network connections and listening ports using either netstat836 or
ss,837 both of which accept the same arguments.
834 (Phil Blundell, 2003), https://linux.die.net/man/8/route
835 (Linux man-pages project, 2008), http://man7.org/linux/man-pages/man8/routel.8.html
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 534
Made in Morocco
Penetration Testing with Kali Linux
For example, we can list all connections with -a, avoid hostname resolution (which may stall the
command execution) with -n, and list the process name the connection belongs to with -p. We
can combine the arguments and simply run ss -anp:
joe@debian-privesc:~$ ss -anp
Netid State Recv-Q Send-Q Local
Address:Port Peer Address:Port
nl UNCONN 0 0
0:461 *
nl UNCONN 0 0
0:323 *
nl UNCONN 0 0
0:457 *
...
udp UNCONN 0 0
[::]:47620 [::]:* y
tcp LISTEN 0 128
0.0.0.0:22 0.0.0.0:*
k
tcp LISTEN 0 5
127.0.0.1:631 0.0.0.0:*
tcp ESTAB 0 36 s
192.168.50.214:22 192.168.118.2:32890
tcp LISTEN 0 128
*:80 *:* o
tcp LISTEN 0 128
[::]:22 [::]:*
n
tcp LISTEN 0 5
[::1]:631 [::]:*
Listing 464 - Listing all active network connections on Linux
i
The output lists the various listezning ports and active sessions, including our own active SSH
connection and its listening socket.
D
Continuing with our baseline enumeration, let’s focus next on firewall rules.
In general, we’re primarily interested in a firewall’s state, profile, and rules during the remote
exploitation phase of an assessment. However, this information can also be useful during
privilege escalation. For example, if a network service is not remotely accessible because it is
blocked by the firewall, it is generally accessible locally via the loopback interface. If we can
interact with these services locally, we may be able to exploit them to escalate our privileges on
the local system.
During this phase, we can also gather information about inbound and outbound port filtering to
facilitate port forwarding and tunneling when it’s time to pivot to an internal network.
On Linux-based systems, we must have root privileges to list firewall rules with iptables.838
However, depending on how the firewall is configured, we may be able to glean information about
the rules as a standard user.
836 (Bernd Eckenfels, 2003), https://linux.die.net/man/8/netstat
837 (Linux man-pages project, 2019), http://man7.org/linux/man-pages/man8/ss.8.html
838 (Herve Eychenne, 2003), https://linux.die.net/man/8/iptables
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 535
Made in Morocco
Penetration Testing with Kali Linux
For example, the iptables-persistent839 package on Debian Linux saves firewall rules in specific
files under /etc/iptables by default. These files are used by the system to restore netfilter840 rules
at boot time. These files are often left with weak permissions, allowing them to be read by any
local user on the target system.
We can also search for files created by the iptables-save command, which is used to dump the
firewall configuration to a file specified by the user. This file is then usually used as input for the
iptables-restore command and used to restore the firewall rules at boot time. If a system
administrator had ever run this command, we could search the configuration directory (/etc) or
grep the file system for iptables commands to locate the file. If the file has insecure permissions,
we could use the contents to infer the firewall configuration rules running on the system.
joe@debian-privesc:~$ cat /etc/iptables/rules.v4
# Generated by xtables-save v1.8.2 on Thu Aug 18 12:53:22 2022
*filter y
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0] k
-A INPUT -p tcp -m tcp --dport 1999 -j ACCEPT
COMMIT
s
# Completed on Thu Aug 18 12:53:22 2022
Listing 465 - Inspecting custom IP tables
o
Since this file is read-only by any users other than root, we can inspect its contents. We’ll notice a
non-default rule that explicitly allows the destination port 1999. This configuration detail stands
out and should be noted for later investigatnion.
Next, let’s examine scheduled tasks that attackers commonly leverage during privilege escalation
i
attacks. Systems acting as servers often periodically execute various automated, scheduled
z
tasks. When these systems are misconfigured, or the user-created files are left with insecure
permissions, we can modify these files that will be executed by the scheduling system at a high
privilege level. D
The Linux-based job scheduler is known as cron.841 Scheduled tasks are listed under the
/etc/cron.* directories, where * represents the frequency at which the task will run. For example,
tasks that will be run daily can be found under /etc/cron.daily. Each script is listed in its own
subdirectory.
joe@debian-privesc:~$ ls -lah /etc/cron*
-rw-r--r-- 1 root root 1.1K Oct 11 2019 /etc/crontab
/etc/cron.d:
total 24K
drwxr-xr-x 2 root root 4.0K Aug 16 04:25 .
drwxr-xr-x 120 root root 12K Aug 18 12:37 ..
-rw-r--r-- 1 root root 102 Oct 11 2019 .placeholder
-rw-r--r-- 1 root root 285 May 19 2019 anacron
/etc/cron.daily:
839 (Debian, SPI Inc., 2023), https://packages.debian.org/sid/iptables-persistent
840 (Netfilter Core Team, 2023), https://www.netfilter.org/
841 (Wikipedia, 2019), https://en.wikipedia.org/wiki/Cron
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 536
Made in Morocco
Penetration Testing with Kali Linux
total 60K
drwxr-xr-x 2 root root 4.0K Aug 18 09:05 .
drwxr-xr-x 120 root root 12K Aug 18 12:37 ..
-rw-r--r-- 1 root root 102 Oct 11 2019 .placeholder
-rwxr-xr-x 1 root root 311 May 19 2019 0anacron
-rwxr-xr-x 1 root root 539 Aug 8 2020 apache2
-rwxr-xr-x 1 root root 1.5K Dec 7 2020 apt-compat
-rwxr-xr-x 1 root root 355 Dec 29 2017 bsdmainutils
-rwxr-xr-x 1 root root 384 Dec 31 2018 cracklib-runtime
-rwxr-xr-x 1 root root 1.2K Apr 18 2019 dpkg
-rwxr-xr-x 1 root root 2.2K Feb 10 2018 locate
-rwxr-xr-x 1 root root 377 Aug 28 2018 logrotate
-rwxr-xr-x 1 root root 1.1K Feb 10 2019 man-db
-rwxr-xr-x 1 root root 249 Sep 27 2017 passwd
/etc/cron.hourly: y
total 20K
drwxr-xr-x 2 root root 4.0K Aug 16 04:17 .
drwxr-xr-x 120 root root 12K Aug 18 12:37 .. k
-rw-r--r-- 1 root root 102 Oct 11 2019 .placeholder
s
/etc/cron.monthly:
total 24K
drwxr-xr-x 2 root root 4.0K Aug 16 04:25 . o
drwxr-xr-x 120 root root 12K Aug 18 12:37 ..
-rw-r--r-- 1 root root 102 Oct 11 2019 .placeholder
-rwxr-xr-x 1 root root 313 May 19 2n019 0anacron
/etc/cron.weekly:
total 28K i
drwxr-xr-x 2 root root 4.0K zAug 16 04:26 .
drwxr-xr-x 120 root root 12K Aug 18 12:37 ..
-rw-r--r-- 1 root root 102 Oct 11 2019 .placeholder
D
-rwxr-xr-x 1 root root 312 May 19 2019 0anacron
-rwxr-xr-x 1 root root 813 Feb 10 2019 man-db
joe@debian-privesc:~$
Listing 466 - Listing all cron jobs
Listing the directory contents, we notice several tasks scheduled to run daily.
It is worth noting that system administrators often add their own scheduled tasks in the
/etc/crontab file. These tasks should be inspected carefully for insecure file permissions, since
most jobs in this particular file will run as root. To view the current user’s scheduled jobs, we can
run crontab followed by the -l parameter.
joe@debian-privesc:~$ crontab -l
# Edit this file to introduce tasks to be run by cron.
#
# Each task to run has to be defined through a single line
# indicating with different fields when the task will be run
# and what command to run for the task
#
# To define the time you can provide concrete values for
# minute (m), hour (h), day of month (dom), month (mon),
# and day of week (dow) or use '*' in these fields (for 'any').
#
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 537
Made in Morocco
Penetration Testing with Kali Linux
# Notice that tasks will be started based on the cron's system
# daemon's notion of time and timezones.
#
# Output of the crontab jobs (including errors) is sent through
# email to the user the crontab file belongs to (unless redirected).
#
# For example, you can run a backup of all your user accounts
# at 5 a.m every week with:
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
#
# For more information see the manual pages of crontab(5) and cron(8)
#
# m h dom mon dow command
Listing 467 - Listing cron jobs for the current user
y
In the above output, only the commented instructions are present, meaning no cron job has been
configured for the user joe. However, if we try to run the same command with the sudo prefix, we
discover that a backup script is scheduled to run every minute.k
joe@debian-privesc:~$ sudo crontab -l
s
[sudo] password for joe:
# Edit this file to introduce tasks to be run by cron.
... o
# m h dom mon dow command
* * * * * /bin/bash /home/joe/.scripts/nuser_backups.sh
Listing 468 - Listing cron jobs for the root user
Listing cron jobs using sudo revealsi jobs run by the root user. In this example, it shows a backup
script running as root. If this file hzas weak permissions, we may be able to leverage it to escalate
our privileges.
D
As we’ll learn later in this Module, the joe user has been granted specific sudo
permission only to list cron jobs running as the root user. This permission alone
cannot be abused to obtain a root shell.
At some point, we may need to leverage an exploit to escalate our local privileges. If so, our
search for a working exploit begins with the enumeration of all installed applications, noting the
version of each. We can use this information to search for a matching exploit.
Manually searching for this information could be very time consuming and ineffective, so we’ll
learn how to automate this process in the next section. However, we should know how to
manually query installed packages as this is needed to corroborate information obtained during
previous enumeration steps.
Linux-based systems use a variety of package managers. For example, Debian-based Linux
distributions, like the one in our lab, use dpkg,842 while Red Hat-based systems use rpm.843
842 (Linux.die.net, 2003), https://linux.die.net/man/1/dpkg
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 538
Made in Morocco
Penetration Testing with Kali Linux
To list applications installed by dpkg on our Debian system, we can use dpkg -l.
joe@debian-privesc:~$ dpkg -l
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name Version
Architecture Description
+++-=====================================-
============================================-============-
===============================================================================
ii accountsservice 0.6.45-2
amd64 query and manipulate user account information
ii acl 2.2.53-4
amd64 access control list - utilities
ii adduser 3.118 y
all add and remove users and groups
ii adwaita-icon-theme 3.30.1-1
all default icon theme of GNOME k
ii aisleriot 1:3.22.7-2