echo"strace $i"
{SIGDFL},
{0x43ab80,
=0
=12
=12
=0
T209
第2章UNIX/Linux系统取证79
[SEGV],
协工主武中文团
SA_RESTORERSA_RESTART,
日工街
客同
---
## Page 103
上来。
Fault（段错误），此时如果系统CoreDump功能是打开的，那么将会有内存映像转储到硬盘
叫 dump），以便我们调试。Linux 下的C 程序常常会因为内存访问错误等原因造成 Segment
这时操作系统就会把程序崩溃时的内存内容写入一个叫做core的文件里（这个写入的动作就
fault”故障。
假设这些事件发生在同一时间段，那么是POST方法导致web服务器进程产生了“Segmentaion
还有来自error日志文件中的一行：TA23
存在于Windows系统中，所以这些命令跟我们的系统毫不相干，我们所关心的日志大部分
是会被那些企图利用该系统的漏洞所产生的报告所塞满，例如：
互动问答
障的发生。
80UNIX/Linux网络日志分析与流量监控
1！其实网上大部分服务器都在受到持续攻击，无论是人为还是蠕虫，所以你的日志还
疑难解析
2.CoreDump又是什么？我们在开发（或使用）一个程序时，程序可能会突然崩溃。
正如这个例子描述的，westshop.com运行的是Linux下的apache服务器，而 cmd.exe 仅
看了日志，小王觉得很可能与POST 命令有关，但他依然不知道是何原因导致了这种故
下面以 RHEL5为例讲解如何配置实现Apache 能在出现段错误时输出Core文件。
各位读者，看完了案例描述和小王对事件的分析，你能回答下面几个问题吗？
他心想：“访问日志中是不是有什么线索能告诉我这台计算机到底发生了什么问题呢？”
1.日志文件中发生了什么？
小王应该对他的网站进行哪些安全加固处理？
[Mon Oct 21 11:59:58 2010] [notice] child pid 6678 exit signal Segmentation fault (11)
192.168.1.215 -- [21/Oct/2010:11:59:57 -0400] “POST"/home.php HTTP/1.1" 200 84424
如何实现在系统Apache出现段错误时输出到Core文件？
process3204604detached
/var/www/htdocs/scripts..A./windows/system32/cmd.exe
[Sun may517:29:332010][error]
.....
192.168.1.215-[21/Oct/2010:11:57:59-0400]“POST/home.php HTTP/1.1“200 84404
192.168.1.215-[21/Oct/2010:11:57:58-0400]“POST/home.phpHTTP/1.1“2003870
192.168.1.215- [21/Oct/2010:11:57:56-0400] "POST/home.php HTTP/1.1“200 65401
#tail-50 access log|more
[client 80.11.134.231] File does not exist:
---
## Page 104
8）重启Apache：
手工运行下面命令使设置立刻生效：
7）实现重新启动后将PID 写入到core文件，修改/etc/sysctl.conf，添加：本
6）编辑/etc/init.d/httpd，在startO部分添加如下几行：
这一行。
5）编辑/etc/init.d/functions，注释掉
将ulimit -S -c 0>/dev/null 2>1
4）编辑/etc/profile，修改：
3）修改/etc/security/limits.conf，在最后添加：oliq
注意：
2）创建/var/apache-dump，并设置正确的权限和属主：
1）在/etc/httpd/conf/httpd.conf的最后添加如下内容：
改为：
#echo1>/proc/sys/kernel/core_setuid_ok
ulimit -S-cunlimited>/dev/null 2>1
echo -n $"Starting Sprog:"
startO
*-core unlimited
#servicehttpdrestart
#
kernel.core_setuid_ok=1H
#FollowingneededforEnterpriseLinux3servers
drwxrwx--- 2 apache apache 4096Aug 1610:59/var/apache-dump
#Is -ld /var/apache-dump
#chmod 0770/var/apache-dump
#chown apache.apache /var/apache-dump
#ps aux|grep http| tail-n2
CoreDumpDirectory/var/apache-dump
echo 1>/proc/sys/kernel/core_uses_pid
ulimit-cunlimited
#mkdir/var/apache-dump
2010
dsw当
（291
第2章UNIX/Linux系统取证81
cu
为碳工武（
文M
toudw
dov新
目
面
---
## Page 105
章讲解）。
自动报警，并迅速恢复被破坏的网页文件，有效保证Web数据的完整性（该方法将在14
测Web站点网页是否被修改。当发现Web站点上的文件被破坏或非法修改后，系统能够
定期扫描并计算网页的MD5摘要编码作为正常网页的“指纹”，实时监控Web站点，监
后面案例中将介绍一种方法，主要思路是：通过在Web服务器上安装网页防篡改系统，
HTML文件的用户，就可以防止ApacheWeb服务器的进程编辑文档。
web author 的权限组，这样可以进一步增强系统的安全。这个组里包含了能够或需要编辑
和www，在本案例中小王赋予www目录在/var/www/htdocs中写的权限。建议创建一个新的
大大提高Web系统的安全：在westshop.com计算机上运行Apache的UID和GID都是www
预防措施
/tmp、/etc、/home、/usr 并为 /etc、/home、/var、/tmp 设置nosuid 和 noexec 属性。
目录，查找新的core文件：
82
除此之外，小王还应该在www.php.net 下载最新的 PHP 版本，并替换现有版本。在
小王花费大量时间来查找westshop.com计算机上跨越驱动器的文件权限。另一项改动将
9）为了测试，使用“ps aux”查找 apache 进程，然后“kill-9"，检查/var/apache-dump/
UNIX/Linux网络日志分析与流量监控
为需要编译软件的用户创建独立分区，将它挂在/home/compile下，并改变属性。
除此之外，还要注意下面8个细节问题：
对于网站被篡改的情况小王选择重装系统的方式。首先对系统创建独立的分区/var、
3.小王的加固工作记录：
经过以上设置，我们得到core文件，接下来可以用GDB工具查看core文件，并进行调试。
作好网站异地备份。
对计算机用Nmap扫描，确信没有运行其他服务。
升级 Mysq1（5.66）、PHP（5.5.4）版本。
重建Apache。
升级Openssh，Openssl。
禁用 sendmail、Nfs 及所有可能运行着的 RPC 服务。
最好将二进制文件s位删除：chmod u-s。
#chmod-Rroot:compile/home/compile;chmod 770/home/compile
-rW--- 1 apache apache 7118480 Aug 16 13:48 /var/apache-dump/core.1333
#ls-ld/var/apache-dump/core.1333
apache13330.02.6801526776? S 13:590:00/usr/sbin/httpd-
apache 13310.02.6 801526776?S 13:59 0:00/usr/sbin/httpd
#psaux|grephttp|tail-n2
#chownroot:www/var/www/htdocs/*;chmod644/var/www/htdocs/
#1
kill-91333
车应瓜委食
0o-2-
---
## Page 106
列上并离线保存，目前《飞虎神拳》视频内容还没有写到阵列上。
储足够多的文件，王磊才将硬盘上的文件送给电影制作公司。然后这些文件会被写入磁盘阵
拳》的视频。团队完成后期制作，视频文件就被放在了服务器上的一个目录下。待硬盘中存
复制到RAID 阵列上，然后给后期制作小组发电子邮件，告诉他们可以取胶片。
后期制作的电影胶片（需采用非线性编辑的视频特效）存放在硬盘上，王磊将硬盘上的内容
作公司。周亮一一叙述了整个过程，因为这些都是在他的监督之下完成的。制片公司将需要
影胶片制作的所有过程，从收到电影制作公司的电影胶片，直到这些电影胶片运回到电影制
了解业务流程
的机会。
明白过来，他们不仅失去了这部电影的特效渲染工作，如果消息传开的话，他们将失去更多
特效交给他们制作，除非他们将这件事情查个水落石出，并且能防止其再次发生。张坤这才
让公司直接经济损失达数十万元！”曹工接着补充说，电影制作公司将不会再把自己的电影
“泄露出去的片段是观众最期望看到的内容，但现在已经公诸于众了！单单是一个镜头就能
成了后期制作。”
了1分钟的片段。周亮对此非常重视，他让我们检出谁干的，因为这些片段在昨天早晨才完
会议室。王磊对张坤说：“老大，有人将《飞虎神拳》的机密信息散布了出去，在网上发布
共同为之努力工作。
对于他来说是一件无比兴奋的事情。目前他们公司正在制作《飞虎神拳》的特技效果，大家
farm，学名叫分布式并行计算系统）电影特效公司上班，前不久刚刚被提升为IT 经理，这
的专辑，播放起了《God Is a Girl》，加大了油门往前方驶去。张坤在一家渲染农场（Render
事件背景
（新员工）
日志中找到了什么线索？是否知道如何通过攻击者发出的邮件信头找到他的IP地址呢？
来，勾勒出了这次攻击事件的全过程。读者在看完事件的描述后，是否知道在FTP和SSH
志和邮件信头进行分析，利用多方面日志内容验证了他的推测，最后他将这些信息汇总起
2.6
张坤是IT人员，并不熟悉动画渲染业务，他为了搞清楚公司业务流程，立刻询问了电
张坤有点紧张，此刻他意识到已经发生的事情对于他们来说意味着什么。周亮大声说：
他每天早上必须喝上一杯咖啡。今天，他拿着咖啡向办公室走去，被周亮和王磊叫进
在一个美丽的清晨，张坤驾驶着他的 SUV 行驶在三环路上。他拿了张Groove Coverage
后期制作小组的工作采取轮班工作方式，所以周亮打算查出昨天是谁处理过《飞虎神
故事人物：周亮（项目负责人）、王磊（网管）、张坤（IT 经理）、曹工（顾问）、小蒋
本案描述了IT经理张坤在一起广告公司文件泄露的案件中，通过对交换机、服务器日
关键日志：Apache访问日志、Squid访问日志、邮件头信息
难度系数：★★★★★
案例二：谁动了我的胶片
第2章UNIX/Linux系统取证83
---
## Page 107
修改过的文件提交给服务器。张坤询问上传下载的方法时，小蒋说是使用FTP下载的。张坤
作的整个过程：首先他将视频文件从服务器上下载下来，然后对它进行编辑加工，接着就将
拿着记事本去找小蒋，打算一探究竟。
局。这时，王磊来到张坤的办公室说，小蒋是昨天最后一个调取胶片文件的员工。张坤立刻
特网之间也有着防火墙、DMZ区和代理服务器，一切看上去都很正常，调查工作陷入僵
上网
这是他的前任临走前留给他的，也许能够从中找到一些启示。
此迎来自己的辉煌。张坤决定仔细研究一下网络拓扑图。公司的网络拓扑图如图 2-9 所示，
内有着良好的企业文化，假设《飞虎神拳》这部惊人之作能够家喻户晓的话，公司必定会因
民大员早天
自己的前程；其次，张坤非常欣赏他的业务能力。
电影胶片。这些Web上的代码都是两年前由公司内部开发的，非常可靠。
们想要操作的文件，并且挑出他们正在处理的文件，也就是说不可能两个人同时操作同一个
连的所有客户端也清一色使用Linux系统。所有的后期制作成员都使用Web浏览器来获取
意提供更多的技术细节，他们的磁盘阵列和Linux服务器之间采用直连方式，与该服务器
和张坤之间联系不多，因为后期制作相对独立。王磊再一次向张坤解释了所有的过程，
那种人吗？”张坤必须弄个水落石出。
一次交谈，以便进一步了解技术细节。张坤心想：“难道是王磊把视频卖给影迷网站？他是
公司内鬼所为？
84UNIX/Linux网络日志分析与流量监控
小蒋是公司的新员工，张坤曾经见过他几次，但并没有和他谈过话。小蒋告诉张坤他工
张坤回到了自己的办公室，思考着下一步该怎么办。这似乎并不像内部职员所为。公司
，张坤从与王磊的谈话中确信他不会是作案者。首先，他不会为了贪图眼前的利益而毁掉
王磊在公司创建之初就来工作，现已工作多年。他是后期制作团队的系统管理员。
调查工作进行到第二天清晨，丝毫没有得到有价值的线索。张坤认为有必要和王磊进行
这张网络拓扑图似乎并没有给张坤太多帮助，局域网中只有几个VLAN。公司内网和因
15
图2-9案例网络拓扑
www服务器
10.1.2.5
DMZ
?
Intemt
奥达出册
美业物
他
王磊
河
---
## Page 108
看看是否能够找到一些其他的信息，也许会有些头绪。张坤让王磊再次检查一下FTP日志。
信息：
看看是谁发布了这个视频。当和网管取得了联系后，网管说这些信息来自一个自称是 Tom
“视频是昨天晚上制作完成的，怎么这么快就泄露了呢？”。这时张坤想到联系对方的网管，
的片头视频被发布在网上了！”看到经理这样的情形，王磊和张坤的心里怦怦直跳。周亮说：
天都像是热锅上的蚂蚁。就在这时候，周亮来到了王磊的办公室，告诉他：“又有一部做好
现。然而张坤只能对他解释说发现了一些可疑之处，但还没有得到证实，张坤感到自己一整
FTP访问过。张坤一头雾水地回到了自己的办公室。王磊看到张坤，连忙询问是否有新的发
帮助张坤查询FTP日志文件，并登录了后期制作服务器。
取证分析
5:15~5:30"。
间。小蒋回忆了一下，说：“昨天是我太太生日，所以晚上下班比较准时，大约时间是在
听到这条线索，他觉得这也许就是问题所在。于是，他接着问小蒋修改完文件后上传的时
张坤决定先找王磊查看后期服务器上的FTP日志。
同样，在工作人员上传完文件之后没有人再访问过这些文件。张坤问王磊是否还有其他
经过认真分析、反复核对，张坤基本确定了他的 IP 地址。张坤来到王磊的办公桌前，想
48CST
com with Microsoft SMTPSVC(6.0.3790.4675);Sat,24Sep 201008:17:50-0700
下面张坤开始利用这封邮件的邮件头信息，希望找到Tom的IP。他找到了下列邮件头
“好，这说明小蒋是正常上传文件的。但是之后会不会又有人调取过呢？”
张坤有点糊涂了。小蒋是正常上传文件的，在这之后再没人访问过，至少没人再通过
Mon Sept 1004:48:18 2010 1 postprod 147456/completed/apple1.avi b_oalex ftp 0*
Received:from[122.246.51.2x] by web15604.mail.cnb.yaho0.comviaHTTP;Sat,24 Sep201023:17:
Received:from web15604.mail.cnb.yahoo.com([202.165.102.x])by SNT0-MC3-F14.Snt0.hotmail
MonSept1004:48:18201011.example.com147456/completed/hawk.avib_oaJer ftp0*i
#grep jer xferlog
Mon Sept 10 04:48:18 20101 1.example.com 147456/var/ftp/pubinfo/bdsq/file2.jpgb_oa xiaojiang ftp 0*i
#grep applel.avi xfelog
To:=?utf-8?B?6LS56ZyH5a6H?=PI:EMAIL
Date:Sat,24 Sep201023:17:48+0800(CST)
Message-ID:
#grep xiaojiang xferlog
Subject:testbywebmail