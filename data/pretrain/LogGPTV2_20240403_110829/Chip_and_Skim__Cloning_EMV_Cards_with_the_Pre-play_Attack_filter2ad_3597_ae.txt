### Optimized Text

#### Protocol Specialist Recommendations
A protocol specialist may recommend that randomness should be generated by the party relying on it. Therefore, the terminal should request a nonce from the issuing bank before initiating the transaction. A less secure but more cost-effective alternative could be for the terminal to authenticate the message conveying the nonce to the card-issuing bank. However, this approach would introduce significant latency and processing overhead, as even authentication is often omitted in payment messages to minimize such costs.

#### Short-Term Alternative
In the short term, a practical solution might be for arbitrators to shift the burden of proof in transaction disputes to the acquiring bank. The acquiring bank would then need to demonstrate that the unpredictable number was properly generated. Terminal equipment could support audits in various ways, such as using a generator that encrypts an underlying sequence, which can be revealed post-transaction and linked to the transaction log to establish time limits for potential pre-play tampering. However, this would not be straightforward; secure storage of audit data in the terminal presents new challenges and creates new attack vectors.

#### Discussion
The vulnerability of EMV to poor random number generators was first discussed by Murdoch [22]. Markettos and Moore [23] further explored how otherwise secure true random number generators could be manipulated to produce more deterministic output. This paper, however, is the first to demonstrate that poor random number generators exist in the wild, have been implicated in fraud, and can be exploited. It also highlights that the EMV specification does not adequately test for this problem.

#### Random-Number Exploit
The random-number exploit described in this paper can be viewed as a variant of the relay attack, which was explored in the context of EMV by Drimer and Murdoch [21]. In their scenario, the relay attack required real-time bidirectional communication with the genuine card, making it difficult to deploy. A more feasible attack might involve a false terminal, such as a parking meter, attracting cardholders and communicating with a crook who waits with a connected false card near an ATM. While we are not aware of this specific attack being deployed, there are rumors of its existence.

Another variant of the relay attack is the no-PIN attack, where a man-in-the-middle device tricks the terminal into accepting a transaction after the wrong PIN is entered. This has been deployed, and perpetrators have been prosecuted, but the losses have been relatively small, estimated at around one million Euros from one or two incidents.

#### Pre-Play Attack
The random-number pre-play attack can also be seen as a form of card cloning. We have already observed fake magnetic strip cards based on either the magnetic strip of the genuine card or the copy of the magnetic strip data stored on the chip of some EMV cards. Another method is the "YES-card," where static data from a chip is copied to a cloned chip card. If the transaction remains offline (e.g., by keeping it below the "floor limit"), the fact that such a card cannot produce a valid ARQC or TC will not prevent the transaction. Since the YES-card is responsible for verifying the PIN, it can be programmed to accept any PIN. The pre-play attack is more powerful in some respects, as it works for online transactions, but it requires advance knowledge of the transaction parameters. Crucially, the pre-play attack will work in ATMs, whereas a YES-card will not (a typical YES-card attack involves buying cigarettes for resale, which is less convenient than stealing cash directly).

#### Cloning vs. Pre-Play
One might assume that a fully cloned card containing a copy of the ARQC-generation keys could commit more fraud than a card with pre-play data. However, even a full clone will have its own ATC, which will eventually diverge from the real card's ATC and become detectable. Thus, a full cloning attack may not be significantly more powerful in practice than a pre-play attack.

#### Variants of the Pre-Play Attack
The pre-play attack can take several forms. In the version described here, and (we believe) observed in the wild, a single terminal is compromised and used to duplicate transactions. There are also variants where the terminals harvesting data are remote from those used for cash-out. If a gang compromises multiple terminals (as was done in the UK by three separate gangs in the mid-2000s) or communications to high-value stores (as was done to jewelry stores in Hatton Garden in the 1980s), ARQCs can be harvested in one location and presented in another.

#### Main Takeaway
The main takeaway is that an attacker who can subvert a merchant's premises, access terminal equipment, or control network connections can perform transactions indistinguishable from card cloning, even if full card cloning is impossible. The EMV attack surface is larger than commonly thought, especially once criminals learn to manipulate the protocol.

#### Evidential Issues in Disputes
The viability of the pre-play attack has significant legal implications. It can no longer be assumed that data in a logged transaction was harvested at the claimed time and place, undermining the reliability of evidence in both civil and criminal cases. To prove that a given transaction was made by a particular card, it is now necessary to show that the random number generator on the ATM or POS was sound.

From the perspective of an issuing bank in dispute with a customer, this attack complicates matters. The bank cannot rely solely on its own log data; it must collect data from third parties (such as the ATM operator) to prove that the ATM was not infected with malware, that the random number generator was not vulnerable due to design failure or a supply chain attack, and that the logs at the acquirer match those kept at the terminal itself. A one-off certification for a class of EMV kernel is insufficient to discharge this burden. Incentivizing the acquiring bank to cooperate with the issuer, especially in international cases, may present practical challenges.

Under existing Visa guidelines, logs should be retained in case of dispute. However, in recent cases, logs were routinely destroyed after 90 or 180 days, regardless of whether a dispute was ongoing. The industry is already struggling with dispute resolution based on issuer logs, and given that some disputes require scrutiny of acquirer and ATM operator systems, resolution can only become more difficult. The only feasible way forward is to get the liability right. Banks that destroy evidence should be automatically liable for the full sums in dispute, including costs. Above all, the burden of proof must lie with the banks, not the customer. The Payment Services Directive already requires this, yet dispute resolution bodies like the UK Financial Ombudsman Service often ignore the law and find in favor of banks that destroy evidence. We discuss these issues further in [22], [19].

#### Industry Response
We disclosed these flaws to major card schemes and selected banks and payment switches in early 2012, initially focusing on the random-number variant. All parties acknowledged receipt, and several contacted us for further questions. The card schemes initially chose not to circulate the work, but after several weeks, a different contact decided to circulate our report, which received several thousand downloads. Most contacts refused to speak on the record, but in April 2012, EMVCo published a specification update [24] partially addressing the random number generator problem. The bulletin required that the unpredictable number field be "truly unpredictable even given access to all previous numbers, and it should be infeasible for an attacker to control the next Unpredictable Number that the terminal generates." EMVCo also announced that testing and approval procedures for terminal random number generators would be strengthened. However, almost two years after our disclosure of the protocol flaw, little appears to have been done. The world's fleet of EMV terminals remains vulnerable to attacks involving terminal malware or man-in-the-middle manipulation of communications. This is particularly concerning given that industry insiders told us that Mr. Gambin's case likely involved ATM malware.

Beyond the direct impact of influencing a specification change, we received informal responses. Some were surprised by the extent and size of the problem, while others reported already being suspicious of the strength of unpredictable numbers or said they had been explicitly aware of the problem for years. If these assertions are true, it is further evidence that banks systematically suppress information about known vulnerabilities, resulting in fraud victims being denied refunds.

#### Conclusions
EMV is the primary protocol used worldwide for card payments, nearly universal in Europe, in the process of adoption in Asia, and in its early stages in North America. Despite being deployed for ten years and over a billion cards in issue, it is only now starting to come under proper scrutiny from academics, media, and industry. Customers have repeatedly complained of fraud and been told by banks that EMV is secure, implying that they must be mistaken or lying when disputing card transactions. However, one vulnerability after another has been discovered and exploited by criminals, and it has mostly been left to independent security researchers to uncover and publicize these issues.

In this paper, we report the shocking fact that many ATMs and point-of-sale terminals have seriously defective random number generators, often just counters. The EMV specification encourages this by requiring only that four successive values of a terminal’s "unpredictable number" be different for it to pass testing. As a result, a crook with transient access to a payment card (such as the programmer of a terminal in a Mafia-owned shop) can harvest authentication codes, enabling a "clone" of the card to be used in ATMs and elsewhere.

We also disclose that the pre-play attack is not limited to terminals with defective random number generators. Due to the lack of end-to-end transaction authentication, it is possible to modify a transaction made with a precomputed authentication code en route from the terminal to the acquiring bank, editing the "unpredictable number" to the value used in the pre-computation. This means that, in addition to inserting a man-in-the-middle device between the payment card and the terminal, an attacker could insert one between the terminal and the acquirer. It also means that malware in the terminal can attack the EMV protocol even if the protocol itself is implemented in a tamper-resistant module that the malware cannot penetrate. The banks appear to have ignored this, perhaps reasoning that it is difficult to scale up an attack that involves access to specific physical cards and the installation of malware or wiretaps on specific terminals. We disagree. The Target compromise shows that criminals can deploy malware on merchant terminals widely and exploit it to earn serious money. The move to terminals based on mobile phones may expose this flaw to industrial-scale exploitation by malware that can be spread through the mobile phone population much more easily than through the terminal fleet. The recent announcement that card payments via phones need no longer rely on cryptography in the SIM card, or in a secure element or TEE, opens the door wide to malware there too.

This flaw challenges current thinking about authentication. Existing models of verification do not easily apply to a complex multi-stakeholder environment. Indeed, EMV has already been verified to be secure, but we explain why such verifications do not work and discuss the type of analysis required instead. Ultimately, we feel that the tools needed to build robust systems for millions of mutually distrustful and occasionally hostile parties will involve game-theoretic analysis as well as protocol-theoretic modeling. Additionally, mechanisms for rolling out fixes across networks with huge installed bases of cards and terminals, and strong externalities, will have to be much better than those we have at present, with incentives that put the pain where it's deserved and technical mechanisms that offer the prospect of remedial action to the sufferers.

In the meantime, there is a structural governance failure that gives rise to systemic risk. Just as the world's bank regulators were gullible in the years up to 2008 in accepting the banking industry's assurances about its credit risk management, so too have regulators been credulous in accepting industry assurances about operational risk management. In a multi-party world where not even the largest card-issuing bank, acquirer, or scheme operator has the power to fix a problem unilaterally, we cannot continue to rely on a slow and complex negotiation process between merchants, banks, and vendors. It is time for bank regulators to take an interest. It is welcome that the US Federal Reserve is now paying attention, and it is time for European regulators to follow suit.

#### Acknowledgments
The authors thank Dan Bernstein for the photo in Figure 5(b). Steven J. Murdoch is funded by the Royal Society. Omar Choudary is a recipient of the Google Europe Fellowship in mobile security, and this research is supported in part by that fellowship. The opinions expressed in this paper do not represent the views of Google.

#### References
[1] Financial Fraud Action UK, “Scams and computer attacks contribute to increase in fraud, as total card spending rises,” Press Release, March 2014.
[2] S. Drimer, S. J. Murdoch, and R. Anderson, “Thinking inside the box: system-level failures of tamper-proofing,” in IEEE Symposium on Security and Privacy (Oakland), May 2008, pp. 281–295.
[3] S. J. Murdoch, S. Drimer, R. Anderson, and M. Bond, “Chip and PIN is broken,” in IEEE Symposium on Security and Privacy (Oakland), May 2010.
[4] S. Sellami, “L’imparable escroquerie à la carte bancaire,” Le Parisien, 24 January 2012, http://www.leparisien.fr/faits-divers/l-imparable-escroquerie-a-la-carte-bancaire-24-01-2012-1826971.php.
[5] A. Kelman, “Job v Halifax PLC (not reported) case number 7BQ00307,” in Digital Evidence and Electronic Signature Law Review, S. Mason, Ed., vol. 6, 2009.
[6] D. Moon, J. Flatley, R. Murphy, J. Hoare, B. Green, “Acquisitive and plastic crime: survey,” Home Office, Statistical Bulletin, April 2010, http://webarchive.nationalarchives.gov.uk/20110218135832/http://rds.homeoffice.gov.uk/rds/pdfs10/hosb0810.pdf.
[7] R. Anderson and R. Needham, “Programming Satan’s computer,” in Springer Lecture Notes in Computer Science vol 1000, 1995, pp. 426–441.
[8] Visa Integrated Circuit Card – Card Specification, Visa International, October 2001, version 1.4.0.
[9] EMVCo, LLC, “Terminal level 2, test cases,” Type Approval, November 2011, version 4.3a.
[10] EMV 4.2, EMVCo, LLC, June 2004, http://www.emvco.com/.
[11] O. Choudary, “The smart card detective: a hand-held EMV interceptor,” University of Cambridge, Computer Laboratory, Tech. Rep. UCAM-CL-TR-827, December 2012.
[12] B. Jack, “Jackpotting automated teller machines redux,” Presentation at Black Hat USA, July 2010, http://blackhat.com/html/bh-us-10/bh-us-10-archives.html#Jack.
[13] EMV.LIB Integration Guide, CreditCall, 2009, http://www.level2kernel.com/emvlib documentation.html.
[14] ATM Malware, SC Magazine, October 2013, http://www.pcworld.com/article/2058360/atm-malware-may-spread-from-mexico-to-englishspeaking-world.html.
[15] J. de Ruiter and E. Poll, “Formal analysis of the EMV protocol suite,” in Theory of Security and Applications (TOSCA 2011), ser. LNCS, S. Moedersheim and C. Palamidessi, Eds., vol. 6693. Springer, March 2011, pp. 113–129.
[16] M. Burrows, M. Abadi, and R. Needham, “A logic of authentication,” ACM Transactions on Computer Systems, vol. 8, pp. 18–36, 1990.
[17] R. Anderson, Security Engineering – A Guide to Building Dependable Distributed Systems. Wiley, 2003.
[18] R. M. Needham and M. D. Schroeder, “Using encryption for authentication in large networks of computers,” Commun. ACM, vol. 21, pp. 993–999, Dec. 1978.
[19] S. J. Murdoch and R. Anderson, “Security protocols and evidence: where many payment systems fail,” in Financial Cryptography and Data Security, 2014.
[20] Visa International, “Transaction acceptance device guide (TADG) v 2.1,” 2013.
[21] S. Drimer and S. J. Murdoch, “Keep your enemies close: Distance bounding against smartcard relay attacks,” in USENIX Security Symposium, August 2007.
[22] S. J. Murdoch, “Reliability of chip & PIN evidence in banking disputes,” in Digital Evidence and Electronic Signature Law Review, vol. 6. Pario Communications, November 2009, pp. 98–115, ISBN 0-9543245-9-5.
[23] A. T. Markettos and S. W. Moore, “Frequency injection attack on ring-oscillator-based true random number generators,” in Workshop on Cryptographic Hardware and Embedded Systems, 2009, pp. 317–331.
[24] EMVCo, LLC, “Specification bulletin no. 103, unpredictable number generation,” Bulletin, April 2012.