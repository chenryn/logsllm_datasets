WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
ANSSI
WSUSpendu
USE WSUS TO HANG ITS CLIENTS
SATURDAY, 29TH JULY 2017
YVES LE PROVOST & ROMAIN COLTEL
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Who we are, what we do…
-
Yves Le Provost
-
Security auditor for more than 10 years
-
Currently works for French cyber defense Agency (ANSSI)
-
Specializes in SCADA and database assessments, but masters any other field ;-)
-
Romain Coltel
-
Former security auditor
-
Currently works for a disruptive startup
-
Developing next-gen Active Directory security product
2
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
The problem
Sometimes, compromising a network 
is not that easy.
3
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise scenario
4
You
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise scenario
5
Internet-connected network
Servers
Workstations
Domain
controllers
You
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise scenario
6
Internet-connected network
Servers
Workstations
Domain
controllers
You
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise scenario
7
Internet-connected network
Servers
Workstations
Domain
controllers
You
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise scenario
8
Internet-connected network
Disconnected network
Physical boundary
Servers
Workstations
Domain
controllers
You
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
The solution?
Sometimes, compromising a network 
might not be as far as we think.
9
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Potential compromise scenario
10
Internet-connected network
Disconnected network
Physical boundary
WSUS 
Server
WSUS 
Server
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Potential compromise scenario
11
Internet-connected network
Disconnected network
Physical boundary
WSUS 
Server
WSUS 
Server
?
?
?
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Windows Server Update Services (WSUS)
12
Enterprise network
HTTPS
HTTP
Microsoft Update
www
WSUS
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Windows Server Update Services (WSUS)
13
Enterprise network
HTTPS
HTTP
Microsoft Update
www
WSUS clients
WSUS
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Windows Server Update Services (WSUS)
14
Enterprise network
HTTPS
HTTP
Microsoft Update
www
WSUS clients
WSUS
upstream
WSUS
downstream
WSUS clients
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Windows Server Update Services (WSUS)
15
Enterprise network
HTTPS
HTTP
Microsoft Update
www
External device
WSUS clients
WSUS
upstream
WSUS
downstream
WSUS clients
Disconnected
WSUS
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
16
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
17
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
1. Windows service downloads update metadata (binaries size, download URL, command-line arguments, …)
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
18
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
2. Windows service transmits the metadata to the database
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
19
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
3. The database uses functions to parse metadata inputs, incorporates them into its tables
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
20
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
4. Updates are approved, either by an admin or by automatic approval rules
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
21
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
5. Approved updates binaries (psf, cab, exe, …) are downloaded
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
22
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
6. Each binary signature is checked
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
23
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
7. Each binary is stored for the Web service to be able to get them
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
24
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
8. Clients are looking for new updates ; Web service gets approved updates metadata from the database
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
25
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
9. Web service transmits the metadata to the WSUS clients 
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
26
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
10. Each client evaluates if the updates is installable
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
27
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
11. If an update is installable on a client, the associated binary is downloaded
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
28
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
12. Each downloaded binary’s signature is checked
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Updates journey within a WSUS server
29
Windows service
Database
Web service
WSUS server
WSUS clients
Microsoft Update
13. Each binary is executed, with SYSTEM privileges, with possible command line parameters from the metadata
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
30
WSUS attacks: Black Hat USA 2015, WSUSpect
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
31
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
1. Get a mitm position
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
32
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
2. Intercepts new update queries
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
33
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
3. Infects the on-network metadata with a new, malicious update
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
34
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
4. The client sees a new available and installable update
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
35
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
5. Fetches the related binary
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
36
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
6. Checks if binary signature is okay: it is.
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
37
Microsoft Update
Enterprise network
WSUS 
clients
WSUS 
server
WSUSpect
7. Installs the binary, with SYSTEM privileges, with metadata command-line arguments
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
State-of-the-art
38
WSUS attacks: Black Hat USA 2015, WSUSpect
Awesome attack!
But some limitations:
-
Gain a mitm position
-
Meaning no network limitation is in place
-
Get a useful one
-
Meaning TLS has to be disabled
Doesn’t give us access to the disconnected network
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Introducing WSUSpendu
@
39
Microsoft Update
WSUS
www
Enterprise network
Open-source: https://github.com/AlsidOfficial/WSUSpendu
@Thx Maman
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Introducing WSUSpendu
40
Microsoft Update
WSUS
www
Enterprise network
1. Injects update metadata in the database, signed binary in the Web service
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Introducing WSUSpendu
41
Microsoft Update
WSUS
www
Enterprise network
2. The client sees a new available and installable update
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Introducing WSUSpendu
42
Microsoft Update
WSUS
www
Enterprise network
3. Fetches the related binary
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Introducing WSUSpendu
43
Microsoft Update
WSUS
www
Enterprise network
4. Checks if binary signature is okay: it is.
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Introducing WSUSpendu
Microsoft Update
WSUS
www
Enterprise network
5. Installs the binary, with SYSTEM privileges, with metadata command-line arguments
44
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Demonstration…
45
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise a connected network
Internet-connected network
Disconnected network
Physical boundary
46
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
47
We need to go deeper…
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Demonstration…
48
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise a disconnected network
Internet-connected network
Disconnected network
Physical boundary
49
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Compromise a disconnected network
Internet-connected network
Disconnected network
Physical boundary
50
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Conclusion
51
Stop updating
Control relationship WSUS server → clients
WSUSPENDU
/ 52
Yves Le Provost & Romain Coltel
Thank you all.
ROMAIN COLTEL
ANSSI
YVES LE PROVOST