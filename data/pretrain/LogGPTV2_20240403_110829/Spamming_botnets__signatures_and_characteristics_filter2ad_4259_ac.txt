Total
7,721
5,916
340,050
580,466
340,050
Table 1: Some statistics pertaining to the botnets identiﬁed by AutoRE.
1
0.8
0.6
0.4
0.2
s
t
e
n
t
o
b
f
o
n
o
i
t
c
a
r
F
0
100
s
n
o
i
s
s
e
r
p
x
e
r
a
l
u
g
e
r
f
o
#
800
700
600
500
400
300
200
100
0
104
Before grouping
After grouping
Nov 2006
June 2007
(b)
July 2007
l
l
a
o
t
m
a
p
s
m
a
p
s
d
e
s
a
b
t
e
n
t
o
b
f
o
%
Regular expression
Simple URL
0.2
0.15
0.1
0.05
0
Nov 2006
June 2007
(c)
July 2007
101
102
Number of distinct IP addresses
103
(a)
Figure 7: (a) Cumulative distribution of botnet size in terms of number of distinct IPs involved. (b) Number of regular expression
patterns before and after generalization. (c) Percentage of spam captured by AutoRE signatures.
Finally, we are interested in ﬁnding whether each set of emails
identiﬁed from the same spam campaign were correctly grouped
together. To answer this question, for every set, we examine the
similarity between the corresponding destination Web pages.
In
previous work [2], destination web pages were shown to be strongly
correlated to the corresponding spam campaign.
6.1 Evaluation of Botnet URL Signatures
Recall that every email in our dataset has been pre-classiﬁed as
either spam or non-spam by a human user; we now use these labels
to evaluate the effectiveness of the generated botnet URL signa-
tures.
6.1.1 False Positive Rate
We begin by presenting the spam detection false positive rate:
for every signature, we compute its spam detection false positive
rate as the fraction of non-spam emails matching the signature to
the total number of non-spam emails (see Figure 9(a)). For CU
signatures, the false positive rates lie between 0.0001 to 0.0006.
For RE signatures, the rates are between 0.0011 and 0.0014. The
aggregated false positive rates vary between 0.0015 and 0.0020.
6.1.2 Ability to Detect Future Spam
In Section 5, we showed that URL signatures generated by Au-
toRE can be used to detect between 16% to 18% of spam on a
monthly basis (Figure 7(c)). We now proceed to evaluate the effec-
tiveness of using AutoRE signatures for future spam detection – in
other words, we are interested in determining if AutoRE signatures
are effective over time. For this experiment, we applied the signa-
tures derived in Nov 2006 and June 2007 to the (sampled) emails
collected in July 2007.
From Table 2, we ﬁnd signatures generated in Nov 2006 are not
useful in detecting botnet spam sent in July 2007. In contrast, sig-
natures from June 2007 are highly effective, matching 50,529 spam
emails sent in July 2007 with a low false positive rate. The big dif-
ference between the detection rates of Nov 2006 and June 2007
Month
# of spam emails
# of non-spam emails
Nov 2006
CU RE
3
2
10
0
Total
5
10
June 2007
RE
43,778
561
Total
50529
715
CU
6,751
154
Table 2: Number of spam and non-spam emails from July that
match signatures derived from previous months.
signatures indicate that spam URL patterns evolve over time. Fur-
thermore, we observe that RE signatures are much more robust over
time than CU signatures. Speciﬁcally, the RE signatures generated
in June 2007 have comparable detection capabilities to the RE sig-
natures generated in July 2007. In the next subsection, we further
demonstrate the effectiveness of regular expression signatures by
comparing them against frequent keywords.
6.1.3 Regular Expressions vs Keyword Conjunctions
To understand the beneﬁts of using regular expressions vs. key-
word conjunctions (e.g., token1.*token2.*token3), we compare them
in terms of their spam detection rate and false positive rate. The fre-
quent keyword based signatures were generated using paths from
the root of the keyword-based signature tree (Section 4.1) to its
leaves. If a URL string contains all frequent keywords in a signa-
ture (regardless of order), then we consider it a match.
Both types of signatures produce almost identical spam detec-
tion rate. However, their false positive rates differ dramatically.
Figure 9(b) shows that regular expressions reduce the false positive
rates by a factor of 10 to 30. As we discussed in Section 2, URL
strings are often human readable strings with English words and
substring segments. Thus merely using frequent keywords results
in a high positive rate. Using regular expressions can greatly reduce
the chance of legitimate URLs matching a signature.
6.1.4 Domain-Speciﬁc vs Domain-Agnostic Signatures
An important step of regular expression generation is to merge
domain-speciﬁc signatures into domain-agnostic ones through gen-
CU
RE
0.0020
0.0018
0.0016
0.0014
0.0012
0.0010
0.0008
0.0006
0.0004
0.0002
0.0000
Nov 2006
June 2007
July 2007
(a)
0.045
0.04
0.035
0.03
0.025
0.02
0.015
0.01
0.005
0
e
t
a
r
e
v
i
t
i
s
o
p
e
s
l
a
F
Conjunction of frequent keywords
Regular expression
d
e
r
u
t
p
a
c
s
l
i
a
m
e
m
a
p
s
f
o
#
Before generalization
After generalization
50,000
45,000
40,000
35,000
30,000
25,000
20,000
15,000
10,000
5,000
0
Nov 2006
June 2007
July 2007
(b)
Nov 2006 June 2007
July 2007
June to
July
(c)
Figure 9: (a) False positive rate of AutoRE signatures. (b) False positive rate: RE signatures vs keyword-based signatures. (c)
Number of spam emails captured by RE signatures: before and after generalization.
IP−based
Session−based
0.015
0.01
0.005
e
t
a
r
e
v
i
t
i
s
o
p
l
e
s
a
F
0
Nov  2006
July 2007
June 2007
Month
(a)
)
%
(
s
l
i
a
m
e
m
a
p
s
/
s
P
I
l
l
a
f
o
e
g
a
t
n
e
c
r
e
P
6
5
4
3
2
1
0
IP addresses
Spam volume
Nov  2006
July 2007
June 2007
Month
(b)
Figure 10: Spam detection performance using botnet IPs iden-
tiﬁed by AutoRE. (a) False positive rate. (b) Total botnet-based
spam volume.
eralization. Figure 9(c) shows that after generalization, AutoRE
can detect 9.9-20.6% more spam without affecting the false posi-
tive rates. More importantly, generalization is critical to detecting
future botnet spam sent from new domains. When we apply June
2006’s domain-speciﬁc RE signatures to data in July 2007, we iden-
tiﬁed only 2749 spam emails. However, with domain-agnostic RE
signatures, the number of spam emails captured increased sharply
to 43,778. Thus, generalization effectively preserves the stable
structures of polymorphic URLs, yet removing the volatile domain
substrings.
In summary, our signature evaluation demonstrates the applica-
bility of using AutoRE signatures for botnet spam detection. Using
only a small number of automatically generated signatures, we de-
tect 16-18% of total spam with a low false positive rate (the remain-
der could be attributed to non-botnet based spam, or sent by small
botnets that AutoRE failed to detect due to our aggressive sampling
rate). We emphasize that this 16-18% belongs to the “stealthy"
category – emails that slip through the sophisticated spam ﬁlter-
ing system employed by Hotmail. Compared with exact URLs or
frequent keyword based signatures, regular expressions are much
more robust for future spam detection and also achieve a low false
positive rate. Finally, domain-agnostic signatures are more effec-
tive in detecting future botnet spam than domain-speciﬁc ones.
6.2 Evaluation of Botnet IP Addresses
In this section, we are interested in evaluating the identiﬁed bot-
net IP addresses to determine if these hosts are indeed spammers;
if so, we are also interested in quantifying the total amount of spam
that is received by Hotmail from them. Our evaluation leverages
the email server log on all emails and the human classiﬁed labels
on the sampled emails. As described earlier, every record in the
email server log contains aggregated statistics about the email vol-
ume and the spam ratio of each IP address on a daily basis. For
clarity, we refer to each record in the log as a session.
For those email servers setup using botnet IP addresses, we hy-
pothesize that the spam ratio should be 100% for all its sessions.
However, since existing spam ﬁlters do have false positives, it is
possible that a spamming server does not always have a 100% spam
ratio in our log. In such cases, we examine whether users unani-
mously classify those emails (in our sampled email data) as spam.
If not, we consider this IP address as a possible legitimate IP in the
false positive category. Figure 10 (a) shows that the false positive
rate over the total identiﬁed IPs (sessions) is very small.
Although the identiﬁed botnet IPs constitute only a very tiny per-
centage (less than 0.5%) of all the IP addresses that were used as
email servers in our log, their total spam volume is non-trivial —
up to 6% of all spam received (Figure 10 (b)). By using a larger set
of incoming emails, we expect the number of the identiﬁed botnet
hosts and the fraction of detected spam to increase.
6.3
Is Each Campaign a Group?
In the previous sections, we evaluated the signatures and the cor-
responding botnet IP addresses individually.