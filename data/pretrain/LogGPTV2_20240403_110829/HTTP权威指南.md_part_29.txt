### 注释18
并非所有资源都支持每种HTTP方法。例如，CGI脚本查询可能不支持文件PUT操作，而静态HTML文件则不接受POST请求。

### 代理 | 167
- **Web Caching（《Web缓存》19）**
  - 作者：Duane Wessels
  - 出版社：O’Reilly & Associates
  - 注19： 清华大学出版社出版了该书的影印版。（编者注）

### 第6章 | 168
### 第7章 | 缓存 | 169

Web缓存是一种HTTP设备，能够自动保存常见文档的副本。当Web请求到达缓存时，如果本地已存在“已缓存”的副本，则可以从本地存储设备中提取文档，而无需从原始服务器获取。使用缓存具有以下优势：
- 减少冗余数据传输，从而降低网络费用。
- 缓解网络瓶颈问题，提高页面加载速度，而无需增加带宽。
- 降低对原始服务器的要求，使服务器响应更快，避免过载。
- 减少距离延迟，因为从较近的位置加载页面会更快。

本章将探讨缓存如何提升性能并降低成本、衡量其有效性的方法以及最佳部署位置。此外，还将介绍HTTP如何保持缓存副本的新鲜度及缓存与其他缓存和服务器之间的通信机制。

#### 7.1 冗余的数据传输
当多个客户端访问一个流行的原始服务器页面时，相同的文档会被多次传输给每个客户端。这导致大量相同字节在网络中重复传输，浪费宝贵的带宽，降低传输速度，并加重Web服务器的负载。通过缓存，可以保留第一个服务器响应的副本，后续请求可由缓存副本处理，从而减少流入/流出原始服务器的重复流量。

#### 7.2 带宽瓶颈
缓存有助于缓解网络瓶颈问题。通常，本地网络为客户提供的带宽比远程服务器更大（参见图7-1）。客户端以路径中最慢的网速访问服务器。若客户端能从快速局域网中的缓存获取副本，尤其是对于大文件传输，缓存可以显著提高性能。

**示例：**
- 乔的五金店旧金山分店用户通过1.4Mbit/s的T1因特网连接从亚特兰大总部下载一个5MB库存文件需耗时30秒。若在旧金山分店设置缓存，本地用户通过以太网连接仅需不到1秒即可获取同一文件。

**表7-1** 显示了不同网络速率下传输不同类型文件所需的时间。带宽限制对大型文件的影响尤为明显，不同类型网络的速度差异也十分显著。

**注1：** 此表假设网络效率为100%，且无网络或应用程序处理延迟。实际延迟会更高，小型对象的延迟主要由非带宽因素造成。

#### 7.3 瞬间拥塞
缓存在应对瞬间拥塞（Flash Crowds）时尤为重要。突发事件如爆炸性新闻、大规模电子邮件公告或名人事件会导致大量用户几乎同时访问同一Web文档，引发流量峰值，可能导致网络和Web服务器崩溃。

**示例：**
- 1998年9月11日，“Starr报告”发布后，美国众议院Web服务器每小时收到超过三百万次请求，是平时平均负载的50倍。CNN.com服务器每秒平均收到超过50,000次请求。

#### 7.4 距离时延
即使带宽充足，距离也可能成为问题。每个网络路由器都会增加互联网流量的延迟。即使客户端和服务器之间没有太多路由器，光速本身也会产生显著延迟。

**示例：**
- 波士顿到旧金山的直线距离约为2700英里。信号以光速（约186,000英里/秒）传输，单程大约需要15毫秒，往返时间约为30毫秒。若某个Web页面包含20个小图片，波士顿的客户端通过四条并行连接下载这些图片，仅光速延迟就达240毫秒。若服务器位于东京（距离旧金山6700英里），延迟将增至600毫秒。

将缓存放置在附近的数据中心可以将文件传输距离从数千英里缩短至数十米。

**注2：** 实际应用中，信号传输速度低于光速，因此距离延迟会更加严重。

#### 7.5 命中与未命中
缓存无法保存世界上所有文档的副本。某些请求可以通过现有副本得到满足，称为缓存命中（参见图7-4a）。其他请求可能由于没有可用副本而被转发给原始服务器，称为缓存未命中（参见图7-4b）。

##### 7.5.1 再验证
原始服务器内容可能会发生变化，缓存需要定期检测其副本是否仍是最新的。这种“新鲜度检测”称为HTTP再验证（参见图7-4c）。为了高效地进行再验证，HTTP定义了一些特殊请求，可以在不从服务器获取整个对象的情况下快速检测内容是否最新。

缓存可在任意时刻以任意频率进行再验证。但考虑到缓存通常包含数百万文档且网络带宽宝贵，大多数缓存只在客户端发起请求且副本足够陈旧时才进行再验证。本章稍后将解释HTTP的新鲜度检测规则。

缓存对副本进行再验证时，会向原始服务器发送一个小的再验证请求。如果内容未变化，服务器将以304 Not Modified响应。只要缓存确认副本仍然有效，就会再次将其标记为暂时新鲜，并提供给客户端（参见图7-5a）。这被称为再验证命中或缓慢命中。虽然这种方式确实需要与原始服务器核对，但比缓存未命中要快，因为它不会从服务器获取对象数据。

**示例：**
- 使用If-Modified-Since首部进行再验证：
  - **再验证命中：** 如果服务器对象未修改，服务器会发送304 Not Modified响应（参见图7-6）。
  - **再验证未命中：** 如果服务器对象已修改，服务器会发送带有完整内容的200 OK响应。
  - **对象被删除：** 如果服务器对象已被删除，服务器会返回404 Not Found响应，缓存也会删除其副本。

##### 7.5.2 命中率
由缓存提供服务的请求所占比例称为缓存命中率，有时也称文档命中率。命中率介于0到1之间，通常用百分比表示。命中率为0%表示每次请求都未命中（需要通过网络获取文档），而100%表示每次请求都命中（缓存中有副本）。

缓存管理员希望命中率接近100%。实际命中率受缓存大小、用户兴趣相似性、缓存数据的变化频率以及缓存配置等因素影响。