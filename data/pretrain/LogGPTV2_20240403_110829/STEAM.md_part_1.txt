STEAM: Observability-Preserving Trace Sampling
ShilinHe LiqunLi YuKang Saravan DongmeiZhang
BotaoFeng∗ XuZhang QingweiLin Rajmohan Microsoft
Microsoft Microsoft Microsoft Microsoft Beijing,China
Beijing,China Beijing,China Beijing,China Redmond,USA
ABSTRACT
Indistributedsystemsandmicroserviceapplications,tracingisa
crucialobservabilitysignalemployedforcomprehendingtheirin-
ternalstates.Tomitigatetheoverheadassociatedwithdistributed
tracing,mosttracingframeworksutilizeauniformsamplingstrat-
egy,whichretainsonlyasubsetoftraces.However,thisapproach
isinsufficientforpreservingsystemobservability.Thisisprimarily
attributedtothelong-taildistributionoftracesinpractice,which
resultsintheomissionorrarityofminorityyetcriticaltracesafter
sampling.Inthisstudy,weintroduceanobservability-preserving
tracesamplingmethod,denotedasSTEAM,whichaimstoretain
asmuchinformationaspossibleinthesampledtraces.Weemploy
GraphNeuralNetworks(GNN)fortracerepresentation,whilein-
corporatingdomainknowledgeoftracecomparisonthroughlogical
clauses.Subsequently,weemployascalableapproachtosample Figure1:Distributionoftracesfromaproductionsystem.
traces,emphasizingmutuallydissimilartraces.STEAMhasbeen
implementedontopofOpenTelemetry,comprisingapproximately 1 INTRODUCTION
1.6KlinesofGolangcodeand2KlinesofPythoncode.Evaluation Overthepastfewdecades,moderndistributedsystemsandmi-
on fourbenchmark microservice applicationsand a production croserviceapplicationshaveevolvedtoincludenumerousloosely-
systemdemonstratesthesuperiorperformanceofourapproach coupledcomponentsanddynamicinfrastructures.Forinstance,
comparedtobaselinemethods.Furthermore,STEAMiscapableof Uber’sarchitecturecomprisesseveralthousandsofmicroservices[9],
processing15,000tracesinapproximately4seconds. whileNetflix’sapplicationutilizesover500microservicesandAPI
gatewaystomanagemorethan2billiondailyrequests[36].The
CCSCONCEPTS tremendouscomplexitymakesitexceedinglychallengingtocom-
•Softwareanditsengineering→Maintainingsoftware;Soft- prehend system internals, optimize performance, and diagnose
waremaintenancetools. failures[7,35,48,49].Theconceptofobservability,originating
fromcontroltheoryasametricforhowwellacomponent’sin-
KEYWORDS ternalstatescanbeinferredfromexternalinteractions[17],has
beenwidelyadoptedincomplexsoftwaresystems[13,29,39].Asa
distributedtracing,tracesampling,graphneuralnetwork
crucialproperty,observabilityoffersvisibilityintosystems’inter-
nalstatesthroughtelemetrydatasuchaslogs,traces,andmetrics,
ACMReferenceFormat:
ShilinHe,BotaoFeng,LiqunLi,XuZhang,YuKang,QingweiLin,Saravan therebyfacilitatingtheunderstandingofcomplexsystemsandtrou-
Rajmohan,andDongmeiZhang.2023.STEAM:Observability-Preserving bleshootingcriticalissues.Inthisstudy,wefocusontracedata.
TraceSampling.InProceedingsofthe31stACMJointEuropeanSoftware Atracetypicallyrecordstheflowofarequestamongvarioussys-
EngineeringConferenceandSymposiumontheFoundationsofSoftwareEngi- temcomponents,essentiallymodelingthesystemcallgraphwith
neering(ESEC/FSE’23),December3–9,2023,SanFrancisco,CA,USA.ACM, propertieslikeservicename,statuscode,andlatency.Tomaintain
NewYork,NY,USA,12pages.https://doi.org/10.1145/3611643.3613881 observability,substantialtracedatamaybegeneratedinproduction
systems,resultinginsignificantoverheadandcostsrelatedtotrace
∗TheworkwasdonewhenBotaoFengwasaninternatMicrosoft. ingestion,collection,andanalysis.Forexample,Googleisestimated
togenerateapproximately1,000TBofrawtracesdaily[37].Acom-
monpracticeforaddressingthedataexplosionissueishead-based
Permissiontomakedigitalorhardcopiesofallorpartofthisworkforpersonalor
tracesampling(i.e.,uniformsampling),inwhichasubsetoftracesis
classroomuseisgrantedwithoutfeeprovidedthatcopiesarenotmadeordistributed
forprofitorcommercialadvantageandthatcopiesbearthisnoticeandthefullcitation randomlychosentopersisttobackendstorage.However,uniform
onthefirstpage.Copyrightsforcomponentsofthisworkownedbyothersthanthe samplingmayfailtopreservesystemobservability,assometrace
author(s)mustbehonored.Abstractingwithcreditispermitted.Tocopyotherwise,or
arediscardedduringsamplingduetotheirlowerprobabilities(oc-
republish,topostonserversortoredistributetolists,requirespriorspecificpermission
and/orafee.Requestpermissionsfrompermissions@acm.org. currences)ofbeingselected,therebycompromisingobservability.
ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA Inthefollowing,weuseanexampletoelaborateit.
©2023Copyrightheldbytheowner/author(s).PublicationrightslicensedtoACM.
Fig.1showsthedistributionoftraces(inlogscale)collected
ACMISBN979-8-4007-0327-0/23/12...$15.00
https://doi.org/10.1145/3611643.3613881 fromalarge-scaleproductionsysteminMicrosoft.Specifically,the
1750
ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA ShilinHe,BotaoFeng,LiqunLi,XuZhang,YuKang,QingweiLin,SaravanRajmohan,andDongmeiZhang
subfigure(a)and(b)showthetracedistribution1beforeandafter GNNisgraphcontrastivelearning[46]basedonmanipulatedinput
theuniformsampling(samplerateis0.1%asin[37])withrespect graphs[50],e.g.,byrandomlyremovingsomenodesormasking
totherequestedoperations(i.e.,APIs).Beforesampling,thetraces features.However,themanipulationwouldcreatetracesthatdo
followalong-taildistribution,e.g.,tracesofthetop-1operation notexistintherealworld.Besides,itdoesnotconsiderdomain
occupyaround75%ofalltraces.Aftersampling,thereisnotrace knowledgeincomparingtraces.Forexample,whencomparingtwo
fromoperations“ListPools”,“Refresh”and“GetStatus”retained. traces,thestatuscodemaybemoreimportantthanthelatency.
Consequently,whenattemptingtodiagnoseanonlineissue,engi- Hence,weproposetofusethedomainknowledgeofcomparing
neerswouldnotfindanytracefromthesethreeoperations.One tracesintotherepresentationlearningoftracesvialogicclauses.
possiblesolutionistomanuallyspecifyoperationsthatrequire Forsampling,thekeyistofindastrategythatmaximizesthe
moretracestobesampledbysettingupad-hocrules.However, dissimilarityinthesampledsubset.Tothisend,weadoptastatistical
itisneverthelessad-hocandnotscalablesincetherearealarge technique,DeterminantalPointProcesses(DPP),tofavortraces
numberofoperationsandoperationscouldalsochangealongwith thataremutuallydissimilarfromeachother.However,thevanilla
thesystemdevelopmentandevolvement[27]. DPPdoesnotfulfilltheoperationalrequirementsfortracesofa
Moreover,thelong-taildistributionorthe“imbalance”behavior largescale.Therefore,weintroduceanovelsamplingalgorithm
isubiquitousinthetracedata.Fig.1(c)demonstratesthedistribu- fastDPPthatoperatesinaparallelfashionandmakessampling
tionoftracesfromthe“SendReq”operationintermsofend-to-end decisionsinstantly.
latency(e.g.,thefirstbarrepresentsalatencyvaluebetween0and Withalltheaboveconsidered,weproposedSTEAM,anobserv-
0.25second).Similarly,Fig.1(d)isthetracedistributionfromthe abilitypreservingtracesamplingapproach.Itisimplementedwith
“GetCluster”operationconcerningdifferenttracestructuretypes over1.6KlinesofGolangcodewithintheOpenTelemetryCollec-
(A-F).Inbothcases,theminoritiesarelikelytobemorecritical torcomponentand2KlinesofPythoncodefordatapreparation
thanthemajorityoftracessincetheformer(highlatencyandab- andmodeltraining.Weevaluatedthemethodonfourbenchmark
normalstructure,respectively)couldreflectsomepotentialissues microserviceapplicationsandaproductionsystem.Comparedto
andshouldneverbemissedafterthesampling. severalbaselinemethods,ourapproachcansampletraceswith
The intrinsic long-tail characteristics of trace data impose a highercoverageandentropytobestpreserveobservability;mean-
great challenge for preserving observability. While quantifying while,itisscalableandincursalowoverheadof∼15milliseconds
theobservabilityofacomplexsystemistricky,thesampledtraces pertrace.OurexperimentsconfirmthatSTEAMcanbenefitdown-
fromawell-observedsystemshouldcoverdifferenttracesfrom streamtaskssuchasfailuredetectionanddiagnosis.Tosummarize,
variousperspectives.Towardsthisgoal,weproposetwometrics themaincontributionsofthisworkare:
asameasurementofsamplingwithobservability,namelycoverage • Toourbestknowledge,wearethefirsttointroduceobservability
andentropy.Coveragemeasuresthepercentageofdifferenttrace preservingsamplingtohelpunderstandsysteminternalstates,
types(e.g.,thetypecanbeanoperationin(a),alatencybucket whichisquantitativelymeasuredbytwometrics(coverageand
in(c),orastructurein(d)ofFig.1)beingcoveredaftersampling. entropy).
Entropy[10]measurestheamountofinformationpreservedinthe • WepresentedSTEAM,agraphlearningmethodthatfusesdomain
sampledtrace.Intuitively,ifmostofthesampledtracesaresimilar knowledgeoftracecomparisonexpressedinlogicclausesand
(i.e.,mostlyfrommajoritytypesandthuslessinformative),both makesfastsamplingdecisions.
coverageandentropyshouldbesmall. • We implemented STEAM in OpenTelemetry and evaluated it
Overthepastfewyears,thereareafewearlyattempts[20,21] extensivelyonfourmicroservicebenchmarksandalarge-scale
onbiasedtracesampling.However,thereisalackofquantitative productionsystem.
measurementforthesamplingeffectivenessastheguide.These
studiescannotcapturethetracedistributionintermsofabundant 2 BACKGROUND
tracestructure[20]ortheresponselatency[21].Inthiswork,we
Observability. :Initiallyintroducedincontroltheory [17],ob-
proposetheobservability-preservingtracesampling,whichaimsto
servabilityquantifiestheextenttowhichasystem’sinternalstates
sampleasubsetoftracessothatthecoverageandentropycanbe
canbededucedfromitsexternaloutputs.Thisconcepthasbeen
maximized.Optimizingthesetwometricsnotablyimpliesmaxi-
adoptedinmodernsoftwaresystemstofacilitateinteractionand
mizingthedissimilarityamongthesampledtraces(moredetailsin
comprehensionofcomplexsystems.Observabilityoffersseveral
Sec.3).Therefore,thecorequestionsare1)howtoquantitatively
benefits:itenablesengineerstounderstandintricatesoftwaresys-
measurethesimilaritybetweentwotraces?and2)howtomaximize
tems,allowspromptresponsetoincidentsandtroubleshootingof
thedissimilarityinthesampledsubset.
distributedsystemspronetounpredictablefailures,andhelpsiden-
Fortracesimilaritymeasurement,anaturalwayistoencode
tifynewfeatureadoptionandsuccessfulproductusagetrendsfor
eachtraceasarepresentationvectorsothatthesimilaritybetween
newcustomers[29].Althoughobservabilitysignalsarenotstrictly
twotracescanbequantitativelyandcheaplycomputed.However,
defined,logs,metrics,andtracesarecommonlyrecognizedasthe
itisnon-trivialbecauseeachtracecarriesrichinformationabout
“threepillars”ofobservability[39].Inthisstudy,weprimarilyfocus
itsstructureandspanattributes.Toaddresstheissue,weadoptthe
ontrace-basedobservability.
GraphNeuralNetwork(GNN)toembedthetracestructureand
attributeinformationsimultaneously.Atypicalwayoftraining Trace. :Atraceencompassesasequenceofcausally-relatedand
concurrentdistributedeventsincomplexsystems.Eachtracepos-
1Forsimplicity,weonlyplottop10operationswithmosttraceamounts sesses aunique traceID,generated atthe root span(the initial
1751
STEAM:Observability-PreservingTraceSampling ESEC/FSE’23,December3–9,2023,SanFrancisco,CA,USA
span)andpropagatedtosubsequentspans.Comprisingsingleor
multiplespans,atracerepresentstheexecutionofspecificfunction-
alities,suchasinvokingaparticularmicroserviceinterface.Spans
recordvariousattributes,includingspanID,parentspanID,service
name,spanname,latency,andadditionalmetadata(e.g.,IPaddress
orserviceversion).Widely-useddistributedtracingtools,suchas
OpenTelemetry[33],Jaeger[15],Lightstep[23],andZipkin[52],
adheretoW3Cstandards[41]fortracegeneration.
TraceSampling. :Therearetwogenericstrategies[20,21,29]re-
garding“wheretomakesamplingdecision”:headsamplingandtail
sampling.Asthenameimplies,headsamplingmakesthedecision Figure2:AnoverviewoftheproposedSTEAMsystem.
wheninitiatingtherootspan.Sinceheadsamplingknowsalmost
nothingaboutthetrace,thedecision-makingiscompletelyrandom
(namely,uniformsamplingwithafixedprobability,e.g.,0.1%).As shouldbemaximizedaftersamplingforeachperspective.There-
presentedinSec.1,headsamplingtendstomissthoseimportant fore,theultimategoalforobservability-preservingtracesampling
butminortracessuchasthelong-latencytraces.Incontrast,tail istomaximizethecoveragejointlyfromalltheseperspectives.
samplinghappensafterallspansinthetracearegenerated.,incur- Entropy:Extendedfromthecoverage,itisalsocrucialtoknow
ringadditionalcomputationoverheadcausedbycachingtracesand whetherenoughinformationisretainedinthesampledtraces.For
makingthesamplingdecisions.However,tailsamplingallowsmore example,ifthereare10differentoperationsbeforeandafterthe
flexiblesamplingstrategiessinceinformationsuchasthestatus sampling,thecoverageis100%.However,ifthemajorityofsampled
codeandlatencyareavailabletouse.Ourproposedobservability- tracesbelongtoonespecificoperationwhiletracesofotheropera-
preservingtracessamplingisaspecifictypeoftailsampling. tionstogetheroccupyonlyaverysmallportion,thenthesampled
tracesarelessinformative.Therefore,weusetheentropy[10]to
GraphContrastiveLearning. :Inthedeeplearningera,graphs denotetheinformationdensityinthesampledtraces,andahigher
couldbeembeddedasrepresentationvectorsbygraphneuralnet- entropyvalueindicatesmoreinformationinthesampledtraces.
works(GNN),basedonwhichdifferentgraphscanbediscriminated. Similartothemeasurementofcoverage,theentropymetricshould
Toobtaintherepresentation,graphcontrastivelearning(GCL)is beconsideredjointlyfromallperspectives.
widelyadoptedtocapturewhichdatainstancesaresimilarordif-