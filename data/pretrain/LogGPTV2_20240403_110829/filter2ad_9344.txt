# 【技术分享】Spora勒索软件：无需与控制服务器通信的离线感染方式

#### 译文声明
本文为翻译文章，原文来源于[securingtomorrow.mcafee.com](http://securingtomorrow.mcafee.com)。具体内容及含义请以原文为准。
翻译：[华为未然实验室](http://bobao.360.cn/member/contribute?uid=2794169747)
预估稿费：110RMB
投稿方式：发送邮件至[linwei#360.cn](mailto:PI:EMAIL)，或登录[网页版](http://bobao.360.cn/contribute/index)在线投稿。

## 传播方式
Spora是一款勒索软件，通过加密受害者的文件并要求支付赎金来解锁文件。该恶意软件能够在短时间内通过大量垃圾邮件迅速传播，并且具有一个显著特点——它可以在不与任何控制服务器通信的情况下进行感染。

这些垃圾邮件通常包含一个`.zip`附件，内含一个HTML应用程序（HTA）文件，用于规避某些电子邮件扫描器的检测并扩大其传播范围。邮件内容经过精心设计，利用社会工程学手段诱使受害者打开附件。此外，该HTA文件还采用双重扩展名如`rtf.hta`和`doc.hta`来误导用户，如果在用户的系统中隐藏了文件扩展名，则他们只会看到第一个扩展名，从而可能误以为是安全文档而打开。

示例垃圾邮件如下所示：
```
[垃圾邮件正文]
```

当运行时，HTA文件会在%Temp%目录下释放一个JavaScript文件，然后该脚本会解压并执行一个随机命名的可执行文件（例如：`goodtdeaasdbg54.exe`）。同时，为了进一步迷惑受害者，HTA还会提取并尝试打开一个损坏的`.docx`文件，引发错误信息以转移注意力。

## 分析
`Goodtdeaasdbg54.exe`经UPX工具压缩处理后携带有效载荷（即Spora）。首先，程序会检查是否已有自身实例正在内存中运行；如果没有，则创建互斥锁防止重复感染同一系统。

接下来，Spora将遍历系统中所有可用逻辑驱动器，但会避开“Windows”、“Program Files”以及“Games”等关键目录下的文件夹。此外，它还会删除卷影副本服务中的备份数据点，确保用户无法轻易恢复被加密的数据。具体而言，Spora使用`vssadmin.exe Delete Shadows /All /Quiet`命令静默移除所有现有快照。

除此之外，在每个根分区上，Spora还将生成指向自身的快捷方式链接以及两个重要文件：`.key`和`.lst`。前者存储了解密所需的关键信息，后者则记录了受攻击影响的所有文件列表。同时，该病毒还会修改注册表设置，以清除桌面图标缓存。

### 加密过程
1. 对于每个待加密文件，生成独立的AES对称密钥。
2. 为当前会话创建一对新的RSA公私钥。
3. 利用上述步骤2中的公钥对步骤1里产生的各个AES密钥进行加密，并将其附加到对应的目标文件末尾。
4. 完成全部文件加密操作后，再生成一个新的全局AES密钥。
5. 将步骤2中得到的私钥复制进`.key`文件，并用新生成的全局AES密钥对其进行保护。
6. 最终，通过预置在恶意代码内的硬编码AES密钥解密出作者持有的公钥，并以此加密整个`.key`文件。

这种方法使得即使没有网络连接，Spora也能独立完成整个加密流程。只有当受害者支付赎金后，黑客才会提供相应的私有RSA密钥，进而解密`.key`文件里的其他部分，最终实现文件复原。

### 密钥文件结构
Spora主要针对六种类型的文件扩展名进行加密，其`.key`文件命名遵循特定格式，包含了地区代码、哈希值起始位以及各类别加密文件数量等信息。例如，“US736-C9XZT-RTZTZ-TRHTX-HYYYY.KEY”可以解读为：

- 地区：美国
- MD5哈希开头：736C9
- 办公文档类加密数：10
- PDF文档类加密数：2
- CorelDraw/AutoCAD/Photoshop文件类加密数：0
- 数据库文件类加密数：0
- 图片文件类加密数：25
- 压缩包类加密数：15

### 赎金通知
Spora向受害者提供了多种付费选项，根据不同的时间期限设定相应的价格。以下是俄语和英语版本的赎金说明截图：

![Ransom Note in Russian and English]

## 技术细节
分析过程中所使用的样本哈希值如下：
- `a159ef758075c9fb64d3f06ff4b40a72e1be3061`
- `0c1007ba3ef9255c004ea1ef983e02efe918ee59`

---

以上是对Spora勒索软件工作原理及其独特特性的概述。希望这些信息能够帮助大家更好地理解此类威胁，并采取适当措施加强防护。