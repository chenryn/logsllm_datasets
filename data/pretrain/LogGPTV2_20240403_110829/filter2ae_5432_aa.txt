**作者：腾讯御见威胁情报中心**  
**原文链接：**
## 背景介绍
MMCore是一款有趣的恶意文件，为下载器下载后在内存中解密执行的一个恶意文件。该恶意文件也被称为BaneChant，最早由fireeye在2013年曝光。此外Forcepoint也在2017年初曝光过而恶意文件的一些攻击活动。
该恶意文件的活动，主要活跃在亚洲地区，包括中国、巴基斯坦、阿富汗、尼泊尔等。不过Forcepoint也提到该攻击活动也包含非洲和美国。攻击的目标主要为军事目标、媒体、大学等。
该攻击活动可以追溯到2013年，直到2020年，依然存在。虽然技术上并未发生太大的改变，但也存在一些有趣的变化。此外在归属上，我们认为该恶意文件跟印度的一些APT攻击组织有关联，包括白象、蔓灵花、孔夫子等，此外我们还意外的发现了一个未被曝光过的攻击武器，一个.net的RAT。
## 攻击技术分析
分析的缘起为一个twitter某个安全研究员的帖子：
虽然我们曾经无数次抓获过该种类样本，也曾经多次在攻击活动中发现过该恶意文件的存在，但是一直并未系统的分析和追溯过该恶意文件。因此这次我们决定深入的来跟踪一下这款有趣的恶意文件。
### 1.MMCore loader分析
我们以下面文件为例进行分析：
整体功能：
对抗沙箱：首先获取最前端窗口，随后每隔1秒钟检测最前端端口是否发生变化，如果不变则无限循环检测：
杀软检测：检测snxhk.dll模块（安全厂商Avast的相关文件），如果有则延时2分钟：
解密下载URL，然后下载并内存执行：
存储方式：
解密后：
下载执行：
shellcode位于偏移+0x14位置：
### 2.MMCore分析 2.MMCore分析
首先检测"avp"、"bdagent"两个杀软进程，如果找到则退出：
然后使用两轮xor，解密得到一个dll：
解密得到的dll具有自加载能力：
dllmain中首先判断加载的进程是否为rundll32.exe，不是则执行木马安装操作：
然后进行install，首先定位自身`._code`区段，该区段存放了一个PE文件：
将PE文件释放到`C:\ProgramData\DailyUpdate\opendrive64.dll`：
在启动目录下释放`OneDrive(2).lnk`文件实现持久化，该lnk快捷方式指向`rundll32.exe`加载`C:\ProgramData\DailyUpdate\opendrive64.dll`并调用其IntRun函数：
启动`rundll32.exe`加载`C:\ProgramData\DailyUpdate\opendrive64.dll`并调用其IntRun函数：
该文件功能与loader相似，主要功能为从`dailysync.zapto.org/fancycumti/combidation/scale.jpg`上拉取payload并加载，确保payload本身无文件落地，每次木马加载均需从网络上拉取paylaod。其功能与loader相同，代码相似，因此不再详细分析。
下面开始执行真正的恶意payload。
首先创建`Mutex 44cbdd8d470e88800e6c32bd9d63d341` 防止重复运行：
执行命令收集获取信息，并将获取的信息上传到C&C服务器：
cmd.exe /q /c tasklist
cmd.exe /q /c ipconfig /all
cmd.exe /q /c dir C:\
cmd.exe /q /c dir D:\
cmd.exe /q /c dir E:\
cmd.exe /q /c dir F:\
cmd.exe /q /c dir G:\
cmd.exe /q /c dir H:\
收集的信息会保存在临时木马下，nnp[4位随机].tmp：
随后会读取到内存中，再删除该文件，再获取一些其他的信息后进行拼接，拼接后的信息如下：
之后开始跟C&C服务器通信：
获取指令，根据不同指令执行以下操作：
命令和功能对应关系如下表：
## 变化历程和总结
从我们的样本库里检索出大量MMcore的样本，针对这些样本我们进行了归纳分析，发现了一些有趣的规律，总结如下：
### 1.得名的由来
该恶意文件第一次被称为MMcore为国外安全公司Forcepoint的一篇分析报告，但是该文章并未解释得名的由来。经过我们的跟踪发现，最初版本的MMcore中，其互斥量的取名为"
MM-Core-Running "，因此我们猜测，Forcepoint因此而给该恶意文件取名为MMCore：
此后，作者对该互斥名进行了一些混淆和变化，如M1M-C1o1r1e-R1u1n1n1i1n1g1：
直至现在，已经完全没有MMCore的影子了：
### 2.标记的变更
此外，从上面的MMCore的详细分析中，可以发现该恶意文件存在明显的版本和版本标签：
我们罗列一下发现的样本标签和版本信息，具体信息如下：
可以发现，标签随着时间的变化而变化，目前最新的版本号为2.5，标签名为FreshPass。
### 3.解密算法的和编码
MMCore的一大特色就是把shellcode存放在下载回来的jpg文件中，虽然有些jpg已经完全没有了jpg的标识：
Shellcode的编码主要有两种，Shikata ga nai和普通的编码。Shikata ga
nai编码为常用的一种躲避杀软检测的编码，海莲花中的shellcode也多采用该编码。
单次xor解密：
两次xor解密：
多次xor解密：
C&C服务器的偏爱
MMCore的攻击团伙比较偏爱动态域名，使用的动态域名包括有ddns.net、zapto.org、no-ip.org、redirectme.net等，部分信息总结如下表：
## 攻击归属
腾讯安全御见威胁情报中心曾经在2019年发布过一篇文章《疑似白象组织针对巴基斯坦、孟加拉国等南亚国家的最新攻击活动报告》，文中就提到了MMCore部分的分析：
该活动的ip跟该文重点分析的白象存在重叠。
此外，也于奇安信的发布的文章《蔓灵花（BITTER）APT组织使用InPage软件漏洞针对巴基斯坦的攻击及团伙关联分析》中的RAT的分析一致：
因此我们把该恶意软件归属到印度的相关组织中。虽然暂时还未清楚MMCore为一个独立小组还是归属于白象、蔓灵花、donot、孔夫子等组织中。但是可以确定的是，该些组织在某些重要的活动中，会采用MMcore恶意软件来进行攻击，至少说明MMCore跟这些组织共享技术。
此外还有个发现，依然是基于腾讯安全御见威胁情报中心去年的文章《疑似白象组织针对巴基斯坦、孟加拉国等南亚国家的最新攻击活动报告》，文章中提到的白象的攻击活动，该文件诱饵使用带有宏的doc进行攻击。我们同样在库里发现了类似的宏文件：
`PakCERT-Snapchat hacked by Pakistani Hacker
Group.doc（92ee6729747e1f37dcae7b36d584760d）`
而文档释放的恶意文件为一个.net编写的RAT：
该.net RAT为之前未公开过的RAT，也为该组织的常规攻击武器之一。
其中文件的pdb为：`d:\KL\rav\rav\obj\Release\rav.pdb`
类似的，也有其他的pdb信息为：`d:\startnew\JackSparow\WinStore\WinStore\obj\Release\WinStore.pdb`
该RAT的主要功能包括：
解密C2：
解密结果为，拼接参数得到完整URL，执行systeminfo命令获取系统信息拼接到url尾部，url如下：
[http://188.241.68.127/pmpk/blue.php?MNVal=JNENIEYOU-PC&FNVal=ConnInfo&DVal=17_](http://188.241.68.127/pmpk/blue.php?MNVal=JNENIEYOU-PC&FNVal=ConnInfo&DVal=17_)
## 结论
APT组织的攻击武器库始终在进行不断进化，包括从攻击手段、开发工具和语言等等，也不断会有新的攻击武器库被补充进来。目前曝光的一些攻击武器库可能仅仅只是实际攻击中的冰山一角，但随着跟踪的深入以及被发现的攻击活动越来越多，会有更多的细节被曝光出来。
此外，攻击活动的归属，向来是一个比较头疼的问题。在MMCore的归属上，我们尚无十足的证据来证明必然归属于某个组织，但是至少可以说明，它跟印度的一些组织至少存在基础设施的重叠和攻击武器库的复用。这也跟印度的众多APT组织的关系错综复杂相关。
我们曾不止一次分析过，蔓灵花、白象、孔夫子、donot等等组织存在一定关联，也不排除为同属一个大组织。我们会继续跟踪该恶意文件的攻击活动，力图使得归属上更加清晰。
## 安全建议
  1. 腾讯安全威胁情报中心建议我国重要企业、政府机关对APT攻击保持高度警惕，可参考以下建议提升信息系统的安全性：
  2. 建议重要机构网管培训工作人员不要随意打开不明来源的邮件附件，在邮件目的及发件人均未知的情况下，建议不要访问附件。
  3. 建议企业用户使用腾讯安全T-Sec终端安全管理系统修补漏洞，及时安装系统补丁，可减少被漏洞攻击的风险。同时注意打开Office文档时，避免启用宏代码。
  4. 推荐企业用户部署腾讯T-Sec高级威胁检测系统（腾讯御界）对黑客攻击行为进行检测。