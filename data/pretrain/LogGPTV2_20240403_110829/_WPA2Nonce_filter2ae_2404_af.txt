**6.4 安全证明的限制**
有趣的是，我们的攻击并没有违反对四次握手和组密钥握手的安全属性。
（1）他人证明了四次握手提供了密钥保密和会话认证。密钥保密表明只有authenticator和supplicant将会拥有PTK。因为我们没有恢复PTK，所以这个仍然正确。会话身份验证使用了匹配会话的标准概念。直观地说，协议时安全的除非攻击者能依赖消息参与到完成这个协议中。我们的攻击，包括我们使用的基于信道的中间人攻击，并不违反此属性:我们只能通过转发(转发)消息使端点完成握手。
（2）他人证实了组密钥握手中key的有序性和key保密性。密钥有序性确保supplicant不安装旧的GTK。这在我们的攻击中仍然是正确的，因为我们重新安装了新的的组密钥。另外，我们不知道组密钥，因此我们的攻击也不违反密钥保密。
然而，这些证明并没有对密钥安装进行建模。不同的是，它们不会声明密钥重载使用了数据机密性协议。在实践中，这意味着相同的密钥可以多次安装，重置为了保证数据机密性中使用的nonce和重放计数器。
**6.5 对策**
密钥重载攻击可以在两层上减轻。
（1）实现数据保密协议的实体应该检查是否已经安装了已经使用的密钥。如果是这样，它不应该重置相关的nonces和重放计数器。这可以防止我们的攻击，至少攻击者不能临时欺骗去实现在重新安装当前的key之前安装一个不同的(旧的)密钥。特别是，当使用这个对策时，接收组密钥的握手重放计数器只会增加。否则，攻击者可以使用旧的Group
message1来临时安装一个旧的(不同的)密钥，然后使用现有的group message1重新安装新的组密钥。
（2）第二种解决方案是确保在握手过程中，在实现数据保密协议的实体中只安装一个特定的密钥。例如，在四次握手过程中生成的会话密钥应该只安装一次。当客户端接收到一个重新传输的message3时，它应该回复，但不能重新安装会话密钥。这可以通过在图3的状态机中添加一个布尔变量来实现。它被初始化为false，当在PKT-START时生成一个新的PTK时，它将被设置为true。如果在输入PTK-DONE且布尔值为true，则会安装PTK并将布尔值设置为false。如果在输入PTK-DONE时布尔值为false，则跳过PTK的安装。注：这正是2.6版本的wpa_supplicant实施的。
证明上述对策的正确性:我们NuSMV中对改进状态机进行了建模，并使用该模型证明了两个安装key总是被新的PTK分离。这意味着相同的密钥从未安装过两次。注：key保密性和会话身份验证已经在其他工作中得到了验证。
我们目前正在通知供应商关于我们发现的漏洞，这样他们就可以实施这些措施。我们所熟知的各种攻击的变种将会被提供给一个供应商名单。
**6.6 讨论**
从我们的结果中可以学到一些重要的教训。首先，协议的规范应该是足够精确和明确的。例如，当我们在第3.3节中攻击四次握手时，我们注意到802.11标准对于应该被接收的重放计数器的值是不明确的。更精确或更正式的规范将避免这种潜在的不正确的解释。
其次，这并不是因为协议已经被正式证明是安全的，它的实现也是安全的。在我们的例子中，在正式证明中使用的四次握手模式并没有完全反映现实。这是因为它没有定义何时应该安装协商的会话密钥。因此，不能保证只安装一次会话密钥。只有当我们读代码才发现正式模型并没有和显示情况相匹配，这些key可以重新安装。在这方面，正式的证明实际上可能会适得其反:一旦一个协议被正式验证，社区可能会对审核实际的实现变得不那么感兴趣。
有趣的是，一个模型可能是错误的，因此并不能准确地反映现实，也同样适用于我们自己的对策的证明。换句话说，不是因为我们在NuSMV中建模了对策，所有的实现现在都突然变得安全了。在现实中，我们的正式状态机可能无法准确地反映某些实现，供应商实现可能有缺陷，或者供应商可能受到未知的攻击的影响。因此，保持审计和测试实际实现是非常重要的。
另一个教训是，数据保密协议应该为nonce重用提供一些保护。例如，对于GCMP，可以在nonce重新使用时恢复身份验证密钥，而对于CCMP来说则不是这样。更广泛地说，应该使用一种nonce抵制重用加密模式，比如aes-siv、gcm-siv或hs1-siv 。这些减少了nonce重用的影响，也降低了key重新安装攻击的影响
**0x07 相关工作**
本章节我们将探索密钥重载攻击的历史，并对其它Wi-Fi和协议安全工作进行一个概述。
**7.1 密钥重载攻击**
我们并不清楚密钥重载攻击之前的一些研究，这很可能因为之前Wi-Fi握手包密码仍然易受到攻击。我们也是现在才发现长达14年的四次握手会受到密钥重载攻击的影响。此外，该缺陷不仅存在实现中，而是在协议规范（标准）本身。
电源故障也会导致nonce被重用。电源故障后，key从boot的非易失性存储器里被恢复，但是nonce会被重置为初始值。对于这个问题，Zenner
在参考文献[76]提出了解决方案。然而，和密钥重载攻击不同的是，触发电源故障不能通过网络进行远程实施。这需要对被攻击的设备进行物理访问。另外，电源故障不影响我们所研究的协议的安全性，因为这些握手协议是用来避免维护新旧连接的状态。
在参考文献[16]，Bock等人发现一些TLS服务器正在使用静态的nonces，这是由TLSrecord
layer协议的错误实现引起的。就是说，它不是由重装一个已经使用过的key引起的。此外，有些服务器使用随机产生的nonces，这意味着在实践中很可能因为生日悖论攻击导致nonce重用。相反，密钥重载攻击允许攻击者通过重放握手信息强制重用nonce，这是由于握手协议的规范（或实现）而导致的缺陷。
McGrew写了一篇关于产生IVs和nonces的最好实现的调查报告，并总结了它们是如何在协议中被生成和使用的[51]。然而在讨论安全风险时，没有提到密钥重载攻击。
另一个相关的工作是Beurdouche等人[14]和de Ruiter，
Poll[27]所进行的。他们发现了几个TLS实现存在缺陷的机器。错误的实现导致握手信息可以被重放。然而他们不能提供针对重放信息的攻击样例。我们猜想攻击者可以重放特定的信息欺骗站点重装一个TLS会话密钥，即密钥重载攻击存在可能性。我们认为能否实施实际的攻击在未来的工作里是很有趣的一点。
重用IVs在千疮百孔的WEP协议[17,18]里也存在问题。特别值得一提的是，Borisov等人发现某个无线网卡每次初始化时都将WEP
IV初始为零。因此，较小的IVs值产生的密钥流可能被重用[18]。然而，和密钥重载攻击不同的是，重置IV值不能被远程触发。
**7.2 Wi-Fi 和网络协议安全**
在对四次握手的一次正式分析中，何和Mitchell发现了一个拒绝服务漏洞[38,55]。这促使四次握手规范的改善[1]。2005年，何等人提出了一个关于四次握手和组密钥握手的正确性证明[39]。但是他们没有对密码选择和降级进行准确地建模。这使得Vanhoef和Piessens提出了针对四次握手的降级攻击[72]。在他们的攻击里，在传输Message
3时，AP被欺骗使用RC4来加密组密钥。这种攻击只有在支持WPA-TKIP的网络里有效，因为WPA-TKIP显然是一个不安全的加密协议[66,69]。此外，在参考文献[39]中使用的模型没有定义何时安装协商的会话密钥或者传输的组密钥。然而我们认为这一时机十分重要，有可能会导致密钥重载攻击。
FT握手是基于四次握手的[5]，但是业界没有对它进行正式的安全性分析。现有的工作重点都是放在握手的性能上。例如参考文献[11,46]。
部分工作是研究协商主密钥（PMKs）的认证机制[19,21,59,75]。其中一些机制依赖于初始时创建一个安全的TLS会话[9]。因此，近期对TLS的攻击也会影响这些机制。例如[10,14,15,27,62]。本文中我们对协商主密钥进行研究，而把主要精力放在如何从协商主密钥或预共享主密钥中获取新的会话密钥。
Beck和Tews在WPA-TKIP上实现了第一次关于数据保密协议的实际攻击[66]。他们展示了如何解密一个小TKIP数据包，恢复MIC
key，之后对数据包进行了伪造。他们的攻击进一步改善当前的一些工作[36,67,69,70]。研究人员还利用RC4的缺陷对由弱key构建的TKIP包进行攻击[6,57,71]。如今TKIP因为其安全问题已经被Wi-Fi协会所摒弃。
尽管CCMP收到一些批评[60]，但它已经被证明可以提供类似OCB模式的安全保障。在参考文献[31]中，Fouque等人讨论了在CCMP中nonces被重用时消息伪造攻击的原理。
众所周知，GCM密码在使用短验证标签和重用nonces时是脆弱的。Böck等人实际研究了当GCM在TLS被使用时nonce重用问题，发现一些服务器确实存在nonces重用问题。我们的攻击在802.11上的GCMP和之前不同是因为当一个端点重用nonce时我们可以对其进行控制。并且GCMP在连接双方使用相同的认证key。所以涉及到GCM的加密协议就会显得脆弱[35,56]。
最后，在Wi-Fi实现或者相关技术上的安全问题的一些工作值得被注意。例如在Wi-Fi保护设置（WPS）上发现了设计缺陷[73]，在驱动程序[13,20]发现了漏洞，路由器被发现可以使用预共享key，等等。
**0x08 总结**
尽管四次握手和组密钥交换握手都被证明为安全的，但我们展示出它们都存在被密钥重载攻击的可能。这些攻击方式和已经被证实的安全标准并不冲突，但是强调了它们所使用的模型的限制。特别的，模型没有指定何时应该装载一个用于数据保密协议的密钥。更多的，我们展示了PeerKey和fast
BSS Transition握手同样会被密钥重载攻击所影响。
所有我们测试的Wi-Fi设备都会被针对组密钥握手的攻击所影响。这就允许攻击者重放广播和组播的数据帧。当四次握手或者fast BSS
Transition握手被攻击的时候，这种影响范围取决于它们使用的哪一种数据保密协议。在所有情况下，都有可能解密数据帧，因此可以劫持TCP链接。这就允许攻击者向未加密的HTTP连接中注入数据。更多的，针对Android
6.0，我们的攻击使其装载了一个全为零的密钥，这让所有的安全保障都失效了。
更令人担心的是，如果我们的握手信息由于背景噪音而丢失，密钥重载攻击可能会自动地进行。这意味着，在一定的条件下，即使没有攻击者，nonces也可能被重用。
将来一个有趣的研究方向是其他协议的实现是否也会受到密钥重载攻击的影响。考虑到消息可能丢失的协议可能会显得特别脆弱，毕竟这些协议用设计用来重传帧时，就有可能密钥重载。
**0x09 致谢**
该研究由KU Leuven基金和the imec High Impact Initiative DistributedTrust赞助
**0x0A 参考链接**