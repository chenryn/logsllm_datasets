宝宝树安全总监：王利
宝宝树
中国规模最大孕婴社区，公司员工约1000人
每天产生文字图片音视频百万级
用户覆盖全国大部分年轻一代准妈妈和孕婴妈妈
分享人：王利
多年甲乙双方打杂经验
曾任职于宝宝树、爱奇艺等互联网公司
兴趣爱好：产品经理、白帽子、羊毛党
公司介绍
Topics
• 0x01 安全体系
（社区+电商）
• 0x02 风控边控联动
（反爬虫+反扫描+防火墙自动化）
• 0x03 风控系统
（引擎+指纹+数据）
• 0x04 开源应用
（扫描平台+ HIDS）
• 0x05 数据安全
（加密+脱敏+DLP）
宝宝树社区&电商常见攻击
中等规模社区电商互联网安全体系（绿色优先完成）
半
年
零
预
算
异
地
多
IDC
全
私
有
云
日志平台与防火墙联动：自动化拦截
2017.12.8 扫描引发
的事件：
• 在大型众测平台上
线SRC前，需做好
防扫描、爬虫、自
动化渗透工具
前提条件
l 日志平台（ELK、Splunk）
l WAF(防火墙)有API：支持向API写
拦截规则（国产WAF较多没有API）
业务价值：
l 反扫描、反爬虫、绊IP
l 防火墙自动化运维（参考宜信）
l ACL管控服务（参考爱奇艺）
日志平台与防火墙联动：自动化拦截
Nginx访问日志
WAF防火墙日志
1.收集日志
2.配置拦截规则
3.向API写拦截策略
WAF/防火墙
4.1 拦截IP
4.2 拦截用户session
4.3 拦截UA、
token等特征值
宝宝树多个APP
5.给APP返回拦截
时的http code
6.APP根据code定制
回显，减少误伤投诉
日志分析平台
踩过的坑：日志平台与防火墙联动
1. 拦截高频爬虫导致某个IDC多花几万元网费：
waf拦截触发返回 403页面默认是一张30K的
图片，当高频爬虫每分钟10万次请求时，
IDC出口流量暴增，网费增加。优化WAF返
回403页面的大小，只写文字，不用图片。
2. 拦截IP误伤用户投诉：每月XX人。因用户宽
带NAT导致。需精准拦截session或设备。
3. WAF硬盘日志打满，查询打不开。需及时收
到日志平台。Nginx日志量太大，只存几天。
4. 拦截IP只是解决爬虫的辅助方法：爬虫和撞
库来自全国各地IP代理池。需主要接口接入
风控拦截设备指纹和JS浏览器指纹。
5. 不能防撞库：每个IP登录3次后换IP，防撞库
需增加APP设备指纹和H5 js指纹验证。
日志平台+Redis+API 准实时简易风控
Nginx访问日志
业务功能接口
打印结果日志
1.收集日志
2.配置风控规则
3.分析结果入库
宝
宝
树
业
务
服
务
端
日志分析平台
4.实时同步数据
到缓存
6.查询风控库
5.http请求风
控API，用uid
查询用户风险
并返回结果
8.离线用户画像
业务价值：
l 人机账号识别：抓机器注
册登录、刷接口、单设备
登录多账号
l 社区抽奖/产品试用反黄牛
7.异步写入
举个栗子：机器注册识别规则
(APP和H5未上线设备指纹时使用）
机器注册特征：
软件注册机IP：一次请求注册接口，并注册成功。
打码平台IP：请求图片验证码、短信验证码，猫池提
供手机号，可批量重置猫池手机号密码。
Saas风控 VS 本地风控引擎
• Saas风控：黑数据查询API+简单风控规则
• 本地风控：复杂风控规则+自产黑数据+外采黑数据
• 多家手机号黑卡测试效果：黄牛黑名单命中率50%，非黑用户误伤率30%-50%
• Why只有50%? 在互联网金融骗贷，不一定在社区发广告，也不一定在电商撸羊毛
本地风控：推荐关注：爱奇艺技术产品团队、唯品会微信公众号
风控系统：引擎+规则+数据+设备指纹
风控对外接入：http API(有代码侵入)、日志、消息队列(无代码侵入)
风控处理中心：实时、近实时、离线计算
风控管理平台：规则、模型
风控处罚中心：API接口、边控设备
APP和H5js设备指纹：人机识别、标识设备、模拟器/root/越狱检测
某大厂风控引擎：接入、处理、规则、处罚
踩过的坑：
1.开源浏览器指纹Fingerprint2：不适用APP和手机H5页面指纹，同型号
、操作系统版本、浏览器相同，则指纹相同
2.APP未集成设备指纹SDK前：
服务端收集MAC、IMEI、uuid、IDFA、分辨率等等+盐 计算APP设备指纹
网页可采用Fingerprint2开源浏览器指纹
3.不要过度依赖图片验证码，一些可被打码平台秒过，不过不扣费
设备指纹：人机识别、设备标识、模拟器/root/按键精灵/改机工具
1.APP集成设备指纹SDK
H5网页集成js设备指纹
2.发送采集数据
4.返回Token
工号同步
(标准LDAP)
3.计算设备指纹和Token
APP和H5网页
风控服务集群
风控计算：传递字段 / 指标计算 / 匹配规则 / 返回结果
用好基本风控规则+设备指纹，解决70%以上的问题
1. 用户字段：uid、手机号（注册、收货）、收货地址、身份证号等
2. 设备字段：APP设备指纹、H5 jS指纹、模拟器、root/越狱等
3. 支付字段：银行卡号、微信账号、支付宝账号等
4. 交易字段：交易金额（购买/提现）、数量、活动、sku等
5. 网络：IP、User-Agent、Refer、Cookie、URL、接口顺序等
6. 时间间隔：注册时间、登录时间、交易时间、请求时间间隔等
基本计算规则：计数、求和、去重、平均值等
基本风控规则举例：某促销活动，每个支付卡号、微信支付号、支付宝号都只能下单1次；每个设
备只能下单1次；每个用户uid只能下单1次；收货地址距离相似性检测（调用地图API）
风控规则：分布式真人QQ薅羊毛群
经验和坑：
1.
熟悉套路
2.
分析工具
3.
黑地址规则：按收货地
址/地区做购买配额，控
制羊毛区域地址
4.
支付账号和设备去重
5. 坑：某些免费Android
加固阉割的越来越容易
逆向
QQ薅羊毛群
逆向老版本APP
绕过风控逻辑
发布多种薅羊毛工具
安全扫描平台+漏洞管理+任务管理
扫描引擎
• 主动扫描
• 被动扫描
漏洞管理
• OWASP&DefectDojo
• 宜信洞察
任务管理
• Redmine
• Jira
通知机制
• Email
• 微信
安管平台
• SOC、SRC
• 多系统打通
安全扫描平台（基于开源搭建）
主动扫描系统（集成多个扫描引擎）
• 最简单实用：外网端口扫描、眼镜蛇php审计
• 外网端口变化扫描（Nmap/masscan）
• 域名暴破（李姐姐等）
• Web扫描（AWVS接口）
• 主机扫描（Nessus/OpenVAS）
• Docker镜像扫描
• 特定漏洞快速扫描（巡风等）
• 信息泄露扫描（Git）
• 弱口令扫描（只暴外网）
• 终端漏洞扫描（MSF）
• PHP代码审计（Cobra）
• 详见grayddq的Github开源
被动扫描系统
• 数据源（日志、流量镜像、代理）
• 数据处理、检测规则、漏洞验证
开源主机入侵检测HIDS
业务价值：
• 主机被入侵、后门、反弹shell等报警
开源HIDS：
• 方案一：OSSec
• 方案二：OSQuery
• 方案三：YSRC开源驭龙
• 报警收集：SOC、ELK、Splunk
• 详见grayddq的Github开源
商业HIDS：
• 资产清点+HIDS+漏扫+报警+监控
• SAAS部署 or IDC私有部署
用户/订单数据安全：加密、脱敏、DLP
1. 数据库字段加密：自研加密service（PHP）、加密服务层（Java）、业务系统接入
2. 前端展示脱敏：敏感内容******展示
3. 电子文件透明加密：运营、审核、客服、海淘、第三方、仓储、物流等office文件加密
4. 外发电子文件加密：离线发送加密数据和订单文件、在线系统对接发送数据和订单
5. 网络和终端DLP：数据指纹、敏感数据外发拦截审批（弱管控方案）
社区电商渗透：易被忽视的简单高危漏洞
移动互联网时代，APP用户量是网站的多少倍？
1K/10K/100K？ 关注Web+逻辑+安卓逆向
易被忽视的简单高危漏洞：
l 竞争条件：并发抽奖、提现
l 水平越权：遍历大量用户信息
l 前端跨域：Jsonp劫持
l 业务逻辑漏洞：刷积分、薅羊毛、发广告
l Android逆向：老版本仿冒APP，绕过风控薅羊毛
支付漏洞、注入、XSS纳入软件自动化测试团队工作
THANKS
致谢：Frank Lu、李姐姐、咚咚呛、呆子不开口
业务驱动安全
兴趣作为职业
安全源于喜欢