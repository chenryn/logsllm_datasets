细说渗透江湖之⻓路漫漫
-
安全脉搏
SecPulse.COM |
“ 前⾔
前⾔
⽂章记录了⼀次护⽹前夕跟随同事们做的⼀次为期⼀周的
演练，本次项⽬被要求集中在客户现场，由客户提供公⽹
ip 作为出⼝，⽅便管理，时间较紧，也不太好求助场外
⼤佬，只好⾃⼰慢慢啃。
打点探测
根据客户提供的⽬标信息，我们先通过 fofa，xray，
securitytrails 等⼯具对其进⾏了⼀波信息搜集，因为最
后⽬标资产数量并不多，最后筛选出有⽤的资产数量七⼋
个，与⼤佬们各⾃分⼯开始测试。
其中⼀个可疑⽬标开放了 6080 端⼝，下⾯挂着 winmail
邮件服务器。
打开就出现了下图所示的登陆界⾯，登录界⾯可挖漏洞有
登录验证绕过，⽤户枚举，暴⼒破解等等。
这⾥的登陆框是没有验证码的，但是登录的返回信息都⼀
致，只能先尝试爆破⼀下弱密码。
对可能存在的⼀些个⽤户名爆破弱密码⽆果后，继续探测
密码忘记界⾯。
⼀般忘记密码界⾯都能探测⽤户是否存在，但是此处存在
验证码，⽆奈太菜，测试后没能成功绕过，先放⼀放，看
看此 ip 其他端⼝还有啥服务。
⽤户枚举
既然是邮件服务系统，那么 25 端⼝⼀般是打开的。若
smtp 服务对某些命令未正确设置的话，也是可能会存在
⽤户名枚举的，先 telnet ⼀下⽬标 25 端⼝，看是否能
连上。
咱们先通过⼯具构造好常⽤名字拼⾳加域后缀的字典。
使⽤ smtp-user-enum -M RCPT 对邮件系统⽤户进⾏
枚举，当然，如果⼯具不⻬全的话你也能通过⾃⼰ telnet
⼿动测试。运⽓不错，爆出⼀些⽤户名。
此处其实还能通过邮件伪造，向域内⽤户发送钓⻥邮件也
是⼀条路⼦，但是测试时间只有⼀周，效果可能很有限，
此种⽅法暂时就被舍弃留作备⽤了。
进⼊后台
通过枚举出的⽤户名开始对各个系统进⾏爆破。
在漫⻓的等待后，⼀个叫 XX 物业系统的管理后台被爆破
成功，看这画⻛应该是⼀个点餐系统。
对着功能点到处点点点，轻⻋熟路的找到⼏个上传点，开
始上传 shell。
然⽽好像事情也没像预期那样，前后端都有⽩名单验证，
经过多次尝试后并没有成功拿下 shell，正在⼀筹莫展之
际，队友那传来了有⽤的信息，他在某个⽬录下发现了⼀
个疑似备份⽂件的存在。
下载后发现应该是运维⼈员打包后忘记删除的备份⽂件，
真是美滋滋，有了源码咱们直接开始审计代码。
审计代码
实战中有利⽤价值的审计⽆⾮就是 getshell，那么就重点
关注代码执⾏，⽂件操作，sql 注⼊的相关关键字。
我们通过对代码的审计，在 Update() 函数发现了⼀点蛛
丝⻢迹，此函数在 658 ⾏会先从⽤户处获取⼀个
filepath，然后在 665 ⾏拼接成完整的⽂件下载路径，可
以看到数据都是通过 frparam() 这个功能接收的，我们跟
进 frparam()。
frparam() 函数就是通过 GPC 接收数据，然后返回给
format_param() 函数，这⾥没有对数据进⾏任何处理。
跟进 format_param()，这⾥⽂件路径为字符串，直接看
57 ⾏，数据⾸先被 htmlspecialchars() 与 addslashes()
函数过滤，然后返回。
回到 PluginsController.php 的 Update() 函数。当获取
到远程地址和拼接好本地⽂件地址后，函数就开始判断我
们的 action，这⾥的 action 值传⼊⽅式与上⾯同理。
我们继续向下审计，这⾥有个下载功能，获取远程⽂件的
内容通过 699 ⾏代码保存在本地 tmp_path 的路径下，
这⾥的 $remote_url 变量可控，且并未发现有对下载⽂
件的限制，可以尝试使 web 应⽤下载⾃⼰指定的恶意⽂
件。
但是问题来了，在代码第 665 ⾏，保存的本地路径后缀
是被写死的，咱们下载⼀个压缩⽂件也没办法 getshell。
我们继续向下审计，看看还有什么内置功能可以让我们绕
过这个限制，发现在第 720 ⾏存在⼀个 file-unzip 的功
能，顾名思义，应该就是⼀个⽂件解压的功能。
跟进第 722 ⾏，⾸先判断⽂件是否存在，存在就调⽤
zip_open() 函数，成功就执⾏解压操作否则就返回失
败。解压的路径为’/A/exts’。
理⼀下利⽤思路，先获取远程⽂件的内容，在本地存成压
缩⽂件，然后解压到他的升级⽬录下。那么现在基本可以
确定，只要我们把远程地址修改为我们⾃⼰带有恶意⽂件
的地址，并且下载后通过 unzip 将其解压那么就能
getshell。
说⾛就⾛，将包含 shell 的 php ⽂件压缩起来，放到远
程服务器上。并构造数据包使 download_url 指向我们的
恶意⽂件。
返回成功后，继续构造数据包解压我们的恶意⽂件。
第⼀个 shell
⼤功告成，成功将 shell 放到服务器上，⼼情有⼀点点⼩
激动。
通过冰蝎连接 shell 却发现⽆法执⾏命令，⼈⽣就是这
样，有许多的绊脚⽯，磕磕碰碰。
俗话说得好，不能执⾏命令的 shell 不是好 shell。
别慌我们先看看 phpinfo，看看哪些函数被禁⽤了
莫得办法，找不到替代函数，那就得绕⼀下函数禁⽤，判
断是 linux 系统后，祭出我们绕过 payload。
disable_function. ⼯具下载地址：
https://github.com/yangyangwithgnu/bypass_disablefunc_
将 payload ⽂件上传。
构造执⾏命令。
Payload:http://xxx/dp1.php?cmd=whoami&outpath=/tmp/xx&
这成功执⾏命令了。
进⼊内⽹
因为时间紧迫，前期在外探测已花费太多时间，接下来兵
分两路，⼀路对此系统进⾏深⼊探测，另⼀路直接通过
frp 代理进内⽹扩⼤战果。
敲下 ifconfig 后系统提示我 command not found，难道
是没装 net-tools？？
这种情况⼀般可以试试使⽤ ip addr 命令代替，或者是通
过 whereis 命令搜索⼀下，然后使⽤全路径去执⾏命
令，这⾥选择后者。
既然知道了 ip 段，按⽼规矩，先对本⽹段扫⼀波
ms17010，主机挺多，就是没办法利⽤，只好另寻出路。
在内⽹兜兜转转的信息搜集时 发现了⼀台内⽹服务器
redis 未设置密码，咱们先拿⼀台服务器看看。
先使⽤ ssh-keygen -t rsa 命令⽣成⼀个公钥。
这⾥直接⽤ proxychains 去连接 redis，然后在. ssh ⽂
件⾥写⼊密钥。
成功获取 root 权限。
横向扩展
在拿到服务器权限后，通过查看 history 历史命令，我们
获取到⼀个使⽤⽬标企业相关单词 +@2020 的密码，果
然使⽤这种规则密码的公司挺多，记得以前公司也是这样
设置的。
感觉离成功⼜近了⼀步。
在使⽤爆破⼯具横向时发现只有三台服务器上使⽤的相同
密码，应该是同时期部署的服务器，没办法，有三台是三
台，不然还能怎么办。
服务器上⾯的东⻄杂⽽乱，看了⼏个⽐较常⻅的配置⽂件
后实在不知道从哪下⼿，挨着排查可能时间吃紧，因为演
习时间只剩下最后⼀天。就当我准备换⽅向的时候队伍⾥
的⼀个常年接触 linux 的⼤佬默默敲了⼀条命令。
egrep expect /* -rl |grep “.sh”：递归查询包含expect字段的
⼤佬解释到，运维⼈员会定期做巡检，采集配置⽂件、
CPU 利⽤率等重要信息备份⼯作，⼀般借助 expect 处
理交互的命令，可以将交互过程如：ssh 登录，ftp 登录
等写在⼀个脚本上，使之⾃动化完成，⼤⼤提⾼系统管理
⼈员的⼯作效率，所以就有了 expect，通过递归查找存
在 expect 字段的⽂件，就有概率能获取密码信息。
听君⼀席话，胜读⼗年书，果然还是吃了⽂化太少的亏。
通过⼤佬提供的命令在上千个⽂件⾥发现了数⼗个具有相
关内容的 bash ⽂件。
Ps: 当搜索出的⽆⽤⽂件较多，影响判断时，也可以通过
指定⽬录来进⾏操作。
egrep expect /{root,home,opt,tmp}/* -rl|grep ".sh"
运⽓也是实⼒的⼀部分，果真在⼀个叫做 liu.sh 的⽂件
中发现了蛛丝⻢迹。这应该就是⼤佬⼝中的运维管理脚本
了。
看到密码的时候那个激动啊，⻢上寄出超级弱⼝令⼯具再
爆破⼀次，GG 思密达。
⾄此整个 c 段基本沦陷，其中还包含了 254/253 两台主
备部署的交换机，但是因为通过修改交换机配置进⾏跨⽹
段渗透可能存在⻛险。
Ps: 作为⼀个守法公⺠，不想提前⾐⻝⽆忧，所以做对客
户核⼼系统可能产⽣影响的操作之前，⼀定要取得客户的
同意。
在与客户交流后, 客户担⼼整体⽹络稳定性，遂放弃了这
个想法。还好没冲动。
尾声
梳理⼀下进攻路线，演习前期⾸先在外⽹通过 Smtp 枚
举出⽤户，借助⽤户信息爆破进⼊后台，在后台没办法上
传 shell，好在找到了备份⽂件并通过审计源码拿到 shell
进⼊了内⽹，在内⽹当中发现了⼀台未授权的 redis，⼜
通过其 history 获取密码扩展了⼏台主机，最终配合⼏台
主机上的 bash 脚本获取到本段⼤部分主机权限。
在渗透的江湖⾥，道阻且⻓。渗透的漫漫⻓路中并不是每
次都会利⽤多么⽜逼的技巧，但每次⾏动都有值得我们总
结的地⽅。
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明
|---|--|--|
| 0 |  |  |
| 1 |  |  |
| 2 |  |  |
| 3 |  |  |
| 4 |  |  |
| 5 |  |  |