5、攻击内⽹应⽤服务
在请求参数去请求dnslog，成功收获⼀枚SSRF漏洞：
同时发现⼀处知识库系统可泄露内⽹应⽤系统，仿佛打开了通往春天的⼤⻔：
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 11/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
准备中英关键字如下⼏类，尝试批量提取问答暴露的敏感信息：
• 内⽹重要应⽤系统：cas、oa、mail、login等；
• 常⻅服务框架账号密码：mysql、user、system等；
• 开发⼈员⼀些关键字：error、waring、debug、api等。
通过正则⼤法提取有效信息进⾏FUZZ， 成功发现⼀处内⽹系统存在⽬录遍历漏洞，修
改url参数为收集到的内⽹IP访问：
其中存在config⽂件，dump回来。
这个时候我⼜去看了⼀下写webshell部分的问题，其实之前是存在两个问题的：
1、webshell写⼊格式有问题（这个相对好解决，我的武林秘籍⾥边应该有提到解决⽅
法）。
2、⽹站根⽬录写⼊猜测可能是传shell有问题的。
有了这两点猜测，我们去⼀⼀解决这两个问题，第⼀个问题通过变换ps语句内容将输出
⽂件中的内容转义成正常格式就可以了。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 12/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
1 powershell "write-output ([System.Text.Encoding]::Unicode.GetString([Sy
这时webshell已经正常写进去了，通过type去读也发现内容没什么问题，当去访问
webshell的时候发现果然出问题了，连接不上（图未截取）。
这印证了我之前的第⼆点猜测-服务器所在环境不通外⽹
这个服务器上有两个站，只能再翻⽬录去找第⼆个站的绝对路径，但愿不会再出问题
了，我早已遍体鳞伤。尝试第⼆个站去写shell访问的时候发现可以连接了。
⽽且我们的注⼊点权限是“nt system”，执⾏⾼权限的操作直接通过注⼊点就可以了。
读⼀下密码，由于注⼊点执⾏命令不能有特殊符号，特殊符号会导致命令执⾏失败，此
处读密码我们通过上传⼀个powershell版的mimikatz加上⼀个执⾏命令的bat脚本就
可以了。
成功读取到密码！
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 13/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
内⽹漫游
此刻，我回顾了⼀下之前的渗透过程，可以开始搞内⽹了，此刻距项⽬结束时间还有17
个⼩时（加上睡觉的时间），此刻已然午夜12点，第⼆天17：00项⽬就要结束了。我决
定还是先休息⼀下，等第⼆天再搞，内⽹⼀般没什么太⼤难度。
第⼆天9点起床继续看这个⽬标，今天的我信⼼满满，想到就要完美完成这个项⽬⼼中还
是有⼀丝的欢愉。
我⾸先想到的是之前dump下来的那个config⽂件，因为⾥边应该写了数据库的⽤户、
密码等信息，我只需要去连接提权就可以了。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 14/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
我们的⽬标是敏感数据，⽽这个配置⽂件中数据库所在的⽹段我看了⼀下应该是在核⼼
内⽹的，因为根据线报核⼼内⽹是⼀个A类的⽹段。
当我打开那个config⽂件的时候发现密码是加密的，⼀段密码的加密字段还有⼀个公
钥，这样如果拿不到私钥的话是⽆法解除数据库的密码明⽂的，于是我⼜返回去看了⼀
下当时通过ssrf拖配置⽂件的⽹站，发现有⼀个⽹站源码的备份⽂件，于是下了下来。
开始想去找私钥解密数据库中的密码，因为从配置⽂件中可以看到这个站是站库分离
的，想搞定那个数据库的服务器需要将密码解出来看⼀下。
⼀开始去翻源码中的⽂件时，着重去翻关于“privateKey”相关的字段内容，找到了源
码中私钥的值。但是拿去解密的时候发现不对，这个时候猜测可能是思路偏了，⼜去看
源码发现在加解密处引⽤了⼀个包，这个包看了⼀下是提供数据库密码加解密的。
猜测应该是对加解密算法进⾏了重新定义或者修改所以正常的RSA解密是不⾏的，于是
写⼀段通过这个库去解密密码的代码，成功对密码进⾏解密。
获得了密码之后成功对⽬标服务器进⾏了提权，这⾥就不详细说明提权流程了，因为很
顺利。。。
提权之后看了⼀下这个数据库服务器是在域内的，想了⼀下，其实我们今天的主要⽬的
不是域控，⽽是想获得⼀些有价值的数据（例如：⼯资数据）作为证明。但是我看了⼀
下他们内⽹的⼯资系统之后没发现什么好的头绪，同⼝令、服务器的端⼝漏洞这些都试
过了暂时没什么思路。
这时冒出来⼀个想法，直接去搞域控，拿到域控⼤⼏率就可拿下⼯资系统了。
这⾥我⽤到了CVE-2019-1040这个漏洞，此乃内⽹渗透⼤杀器。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 15/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
NTLM中继
触发print spooler服务漏洞
模拟administrator⽤户请求票据
这⾥我只dump出了管理员的hash想先去域控看⼀下，拿去解密解出来了，这⾥dump
其它⽤户的时候失败了，只能先去域控看看。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 16/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
进域控在域管机上建⽴快照，复制ntds.dit与system⽂件。
⾸先需要建⽴快照，这⾥需要ntdsutil命令，然后以下列⽅式执⾏。
这⾥需要特别注意：
1、在⽣成快照成功后，mount装载成功以后，我们就得到了⽂件位置需要另开⼀个
cmd，对快照中的ntds.dit与system进⾏copy。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 17/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
2、将ntds.dit与system打包复制回来就好。
下⾯就是使⽤WPR破解hash就好了。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 18/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
迂回夺旗
到这⾥我们拿到了域内主机的部分密码，我看了⼀下⼯资系统的系统账号密码也在内，
于是登进去看了⼀下。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 19/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
找了⼀下⼯资系统管理员的密码，发现加密存储⽽且解不出来，我暂时把管理员的加密
密码复制下来，暂时覆盖了⼀个加密密码登录系统查看了⼀下，截了⼏张图。
⾄ 此 ， 这 次 渗 透 的 ⽬ 的 达 到 了 ， 此 时 已 经 下 午 3 点 半 ， 距 离 结 束 时 间 还 有 ⼀ 个 半 ⼩
时。。。
结尾总结
关于本次渗透的攻击利⽤链的思路图：
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 20/21
2020/7/27 细说渗透江湖之出荆棘⼊深林
这个案例对我来说是⼀次⽐较有意思的经历，起码让我浪费了很多⾛弯路的时间。以后
我会总结⼀下关于编码绕过的场景和常⻅的⼀些利⽤⽅式，关于SSRF的利⽤上，它确实
在我攻击链暂时中断的情况下有了初步搜集内⽹信息的时间，在思路中断的情况下如何
去缩⼩时间成本也是我们需要去考虑的问题。
我依然是⼀名正义的使者，依然会在⿊夜前⾏。最近我上⽹看了很多原创⽂章，发现⼤
家的攻击过程太过顺利了，作为⼀名正义的使者我还是遇到过很多“坑”，渗透的过程绝
不仅仅是技术的堆叠，思路永远是渗透的根本，接下来再跟⼤家分享我的故事的时候，
我会跟⼤家逐步分享我的思路我的故事，毕竟我还是⼀个充满故事的正义使者。
https://mp.weixin.qq.com/s/SOMUf89PkC88_ylSn_iQzQ 21/21