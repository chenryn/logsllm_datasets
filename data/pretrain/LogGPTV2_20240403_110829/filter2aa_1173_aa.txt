Reverse&Engineering&&
Mac&Malware&&
Sarah&Edwards&&
@iamevltwin&
mac4n6.com&
&
whoami&
Senior&Digital&Forensics&Analyst&with&Harris&CorporaAon&
•  Computer&Intrusions,&Criminal,&Counter&Terrorism,&Counter&Intelligence&
•  Mac,&Windows,&*nix,&Mobile,&Malware,&anything&&&everything…&
Government&Contractor&N&Embedded&FullAme&with&Federal&Law&
Enforcement&
General&Forensics&Nerd&&&Mac&Fan&Girl&
Author&&&Instructor&for&SANS&FOR518&–&Mac&Forensic&Analysis&
•  www.sans.org/course/macNforensicNanalysis&
Scope&&&Agenda&
Malware&Triage&
~20%&StaAc,&~80%&Dynamic&
No&Assembly&
Agenda:&
•  StaAc&Analysis&
•  File&Types&
•  Analysis&Tools&
•  Dynamic&Analysis&
•  VirtualizaAon&
•  ApplicaAon&Tracing&
•  Analysis&Tools&
•  Analysis&Examples&
StaAc&Analysis&
Locate&&&Extract&the&Executable&Files&
File&Types:&
• ApplicaAon&Bundles&
• MachNO&
• PKG&Files&
Tools:&
• MachOView&
• lipo&
• Strings&||&srch_strings&
• nm&
• codesign&
• Hopper&
Locate&the&Malware&
ApplicaAon&Bundle&(*.app)&
PKG&File&
MachNO&Executable&
…&
Oﬃce&Document&
ZIP&Archive&
JAR&File&
…others…&
ApplicaAon&Bundle&
Directory&
Contents:&
•  Info.plist&(required)&
•  ConﬁguraAon&InformaAon&
•  Executable&(required)&
•  Located&anywhere&in&bundle&
•  MacOS&Directory&
•  Executable&may&be&in&here&too!&
•  Resources&Directory&
•  SupporAng&Files&
ApplicaAon&Bundle&
Crisis&Sample&
•  Executables:&
–  IZsROY7X.-MP!
–  lUnsA3Ci.Bz7!
–  mWgpX-al.8Vq!
•  Kernel&Extension&=&
6EaqyFfo.zIK.kext!
PKG&File&
eXtensible&ARchiver&
(XAR)&Archive&
Flashback&used&a&fake&
“FlashPlayerN11N
macos.pkg”&Installer&
PKG&Files&
List&&&Extract&the&Malware&
PKG&Files&
List&&&Extract&the&Malware&
PKG&Files&
List&&&Extract&the&Malware&
•  *N1&(First&unar&N&gzip)&
•  *N1N1&(Second&unar&N&cpio)&
MachNO&Binaries&
•  Executable&Format&used&on&OS&X&
•  Universal&(Fat)&Binaries&
•  File&Signatures:&
•  0xCAFEBABE&–&Fat&binary&
•  0xFEEDFACE&–&32Nbit&
•  0xFEEDFACF&–&64Nbit&
•  0xCEFAEDFE&–&32Nbit,&Lirle&Endian&
•  0xCFFAEDFE&–&64Nbit,&Lirle&Endian&
32NBit/Lirle&Endian&
MachNO&Binaries&
Universal/Fat&Binaries&
Intel&32&&&64Nbit&
Universal&–&PowerPC&&&Intel&32Nbit&
Universal/Fat&Binary&File&Info&
lipo&
Review&Architecture&Details:&
• -info !
• -detailed_info !
Universal/Fat&Binary&File&Info&
lipo&
Extract&Binaries:&
• -extract !
• -output !
MachOView&N&Mach&Header&
sourceforge.net/projects/machoview/&
Executables&Strings&&
&strings&||&srch_strings&
Extract&all&strings:&&
• ASCII&Strings&
• strings –a !
• Unicode&Strings&(The&Sleuth&
Kit)&
• srch_strings –a -t!
MachOView&N&Strings&
sourceforge.net/projects/machoview/&
Display&Symbols&&
nm&
•  Variable&and&FuncAon&Names&
•  Crisis&Example:&
– “nm IZsROY7X.-MP”!
MachOView&N&Symbols&
sourceforge.net/projects/machoview/&
Hopper&N&hopperapp.com&
Code&Signed&Binaries&
codesign –dvvv !
KitM&Sample&=&“Kumar&In&the&Mac”&
Dynamic&Analysis&
VirtualizaAon&
• XProtect&
• Gatekeeper&
ApplicaAon&Tracing&
Analysis&Tools&(File,&Process&&&Network)&
• Dtrace&
• Xcode&Instruments&
• fs_usage&
• fseventer&
• AcAvity&Monitor&
• procxp&
• CocoaPacketAnalyzer&
• Wireshark&
• tcpdump&
• lsock&
VirtualizaAon
&&
VirtualizaAon&Tools&
• VMware&Fusion&
• Parallels&
VirtualizaAon&Issues&
• Capable&Versions&N&10.7+&(10.6&Server)&
• Xprotect&&&Gatekeeper&
XProtect&
Files&
•  /System/Library/CoreServices/
CoreTypes.bundle/Contents/Resources&
•  XProtect.meta.plist&
•  Last&Update&Date&&&Version&(10.7&&&
10.8)&
•  Java&Minimum&Version&&&Blacklisted&
Plugins&
•  XProtect.plist&
•  AV&Signatures&
Weaknesses&
•  Apple&updates&it…when&they&want&to.&
•  Very&few&signatures&on&blacklist.&&
•  No&HeurisAcs&
•  Only&checks&“quaranAned”&ﬁles&
•  com.apple.quaranAne&Extended&
Arribute&
•  Mac&Threats&Only&&
XProtect&
Signature&by&Hash
&&
“IdenAty”&Key&=&SHA1&Hash&
XProtect&
Signature&by&Launch&Service&&&Parern&
Disable&XProtect&
Delete/Edit&XProtect&Files&…or…&
Remove&com.apple.quaranAne&Extended&Arribute&
• xattr –d com.apple.quarantine !
Gatekeeper&
•  Introduced&in&10.7.5&
•  AnANmalware&Feature&
•  ApplicaAon&ExecuAon&
RestricAons&
•  Security&Sewngs&
–  Mac&App&Store&
•  Users&can&only&run&apps&from&
the&store.&
–  Mac&App&Store&&&IdenAﬁed&
Developers&
•  Default&Sewng&(10.8+)&
•  Users&can&only&run&soxware&
signed&using&Apple&Developer&ID&
–  Anywhere&
•  Default&Sewng&(10.7.5)&
•  Users&can&run&anything&from&
anywhere&
Disable&Gatekeeper&
•  Permanent:&Change&to&“Allow&ApplicaAons&
Downloaded&From:”&to&“Anywhere”&…or…&
•  CaseNbyNcase&basis:&Control+Click&ApplicaAon&
ApplicaAon&Tracing&&
“Trace”&program&execuAon,&ﬁle&system&events,&network&communicaAons&
for&use&in&troubleshooAng.&
LowNlevel&logging&
Verbose&
Very&useful&for&reverse&engineering!&
Tools:&Dtrace,&fs_usage,&Xcode&Instruments&
Dtrace&
•  TroubleshooAng&UAlity&
•  Designed&by&Sun&
Microsystems&(Originally&for&
Solaris)&
•  Added&to&OS&X&in&10.5&
•  Captures&data&from:&
–  CPU&
–  Memory&
–  Network&
–  File&System&
–  Processes&
•  Uses&D&Language&(awkNish)&
•  dtracebook.com&
•  man&–k&dtrace&
Dtrace&Example&
•  Files&Opened&by&Process&
•  Example&from&dtracebook.com&(ﬁlebyproc.d)&
dtrace -n 'syscall::open*:entry { printf("%s 
%s",execname,copyinstr(arg0)); }!
Xcode&Instruments&
•  Installed&with&Xcode&(Xcode&Tools)&
•  Apple&Developer:&Instruments&User&Guide&
•  GUI&Tracing&ApplicaAon&
Xcode&Instruments&
&
File&Analysis&
Dtrace&
• ﬁlebyproc.d&
• opensnoop&
• Iosnoop&
• creatbyproc.d&
fs_usage&
fseventer&
File&Analysis&–&Files&Opened&By&Process&
Dtrace&N&ﬁlebyproc.d&
•  CPU&–&CPU&that&received&event&
•  ID&–&Dtrace&Probe&ID&
•  FUNCTION:NAME&–&Dtrace&Probe&Name&
•  Remaining&–&Process/Pathname&
File&Analysis&–&Files&Opened&
Dtrace&N&opensnoop&
•  UID&–&User&ID&
•  PID&–&Process&ID&
•  COMM&–&Process&Command&Name&
•  FD&–&File&Descriptor&
•  PATH&–&File&Path&
File&Analysis&–&Files&Opened&
Dtrace&–&opensnoop&Na&
•  Na&=&All&Data&
–  TIME&–&Timestamp&(RelaAve&Microsecond&Counter)&
–  STRTIME&–&String&Timestamp&(Local&System&Time)&
–  UID&–&User&ID&
–  PID&–&Process&ID&
–  FD&–&File&Descriptor&
–  ERR&–&Errno&Value&(See&errno.h)&&
–  PATH&–&File&Path&
–  ARGS&–&Argument&List&
File&Analysis&N&Files&Read/Wriren&by&Process&
Dtrace&N&iosnoop&
•  UID&–&User&ID&
•  PID&–&Process&ID&
•  D&–&DirecAon&(Read/Write)&
•  BLOCK&–&File&System&Block&for&OperaAon&
•  SIZE&–&OperaAon&Size&
•  COMM&–&Process&Command&Name&
•  PATHNAME&–&File&Path&
File&Analysis&–&Files&Created&by&Process&
Dtrace&–&creatbyproc.d&
•  CPU&–&CPU&ID&
•  ID&–&Process&ID&
•  FUNCTION:NAME&–&Dtrace&Probe&Name&