http:///what?  
在发出命令之后，木马将会解析C&C的响应中是否存在Oops，如果存在，木马会认为C&C服务器已经出现了错误并会退出。否则，服务器将以一个命令来响应，后面紧接着一组参数，以分隔符<>来分隔：  
[command]<>[parameters for command in hexadecimal format]  
可用的命令如下：  
1 — 运行命令；  
2 — 上传文件；  
3 — 下载指定的文件。  
每个命令的参数都以十六进制的格式表示，例如字符A将以41表示。在木马中，大部分都会使用十六进制。  
运行命令（1）会使用附加的命令参数创建进程cmd.exe
/c，并且将该命令的执行结果以十六进制格式写入到%APPDATA%tmpCa.vbs文件中。然后，木马会以1500字节块的形式读取该文件的十六进制格式内容，并通过HTTP
GET请求将该文件逐块（以1500字节为单位）发送到C&C服务器，结果如下：  
http:///resp?AAZ  
上传命令（2）会将C&C提供的数据写入制定的文件中。此命令所包含的参数包括二进制数据的十六进制值和文件名，二者以(!)的分隔符进行分隔。该木马会通过发送一个如下结构的URL来向C&C服务器发送响应，以通知其成功上传：  
http:///resp?AAZ  
下载命令（3）会读取指定文件的内容，并将数据发送到C&C服务器。如果该文件不存在，木马回向C&C服务器发送消息，其URL如下：  
http:///resp?AAZ”)>  
如果文件存在，木马会读取文件的内容，并使用GZipStream类来压缩文件内容。随后，木马将获取压缩数据的十六进制值，并用ASCII字符替换以下十六进制值，以此来进一步压缩数据：  
随后，木马会以1500字节为单位，以十六进制的格式将数据写入到SpecialFolder.CommonApplicationData文件夹中的临时文件中，文件命名规则为：.tmp。  
随后，木马将从这个临时文件中逐个读取，并通过构建URL的方式向C&C服务器发送请求，其结构如下：  
http:///resp?ABZ  
一旦临时文件中所有数据都发送完毕后，木马会向C&C服务器发送一个请求，通知其数据已经成功通过URL传输，结构如下：  
http:///resp?ABZFinish
## 如何确认该木马是由OilRig组织发布的
自2016年5月以来，我们就一直在监控并不断发现OilRig黑客组织相关的各种攻击行为和所使用的工具。我们发现，该组织的新工具会重复使用此前已经有的基础工具和组件。这是一种非常常见的行为，攻击者往往会重复使用某些策略或技术，这样就可以提高效率，同时减少工作量。  
在上述攻击过程中，我们观察到该组织使用了此前未曾使用过的C&C域名来下发新的有效载荷。但随着我们的继续调查，就发现了该木马与OilRig组织存在的联系。最明显的一个证据就是使用了ThreeDollars承载恶意文件。此前，我们还发现了该组织会使用不同的有效载荷。除此之外，我们还发现C&C域名msoffice365cdn[.]com与OilRig组织有关。  
首先，通过WHOIS记录，我们看到注册该域名的电子邮件地址[PI:EMAIL](mailto:PI:EMAIL)
。经过继续搜索，我们发现该电子邮件地址还注册过office365-management[.]com这个域名，该域名在2017年10月已被确定作为OilRig的C&C服务器使用。另外，WHOIS记录中还出现了一个不寻常的电话号码，该电话号码还被用于注册另一个office365-technical[.]info，该域名注册者邮箱为[PI:EMAIL](mailto:PI:EMAIL)。根据域名、邮箱和电话号码的关联关系，我们有充分的理由相信该C&C域名和注册者都属于OilRig组织。  
此外，msoffice365cdn[.]com的IP解析为80[.]82.79.221，位于与office365-technical[.]info相同的C类网络范围内。另外，我们还发现80[.]82.79.221与少量其他IP地址共同使用同一个SSL证书，其中的一个IP是185[.]162.235.29。该IP对应的域名是由[PI:EMAIL](mailto:PI:EMAIL)注册的office365-management[.]com。另外，通过对185[.]162.235.0/24的调查表明，该网段中的另一个IP对应着2017年已确认OilRig所有的域名msoffice-cdn[.]com。  
最后，我们检查了文档本身。尽管已经确认该文档是ThreeDollars工具的变体，并分析了其中的伪装提示图片，但还存在其他的证据证明该文档与OilRig组织相关。该文档的作者名称为J-Win-7-32-Vm，与在 2017年8月收集的一个ThreeDollars早期样本的作者完全相同。
## 总结
OilRig黑客组织仍然持续活跃，并且主要针对中东地区发起攻击。该组织所使用的工具和策略不断在更新中，同时也会重复使用此前的一些攻击方式或组件。目前，我们已经捕获到该组织所使用的大量工具，可以说每个工具都是基于过去所使用工具的变体。然而，随着时间的推移，这些工具所产生的效果会越来越差，我们也已经将这一系列工具结合在一起进行分析，以推断出OilRig组织所掌握的技术和能力。
## IoC
    ThreeDollars SHA256：
    ec3f55cac3e8257d6d48e5d543db758fed7d267f14f63a6a5d98ba7a0fab6870
    81eb43ad46ed39bd4b869c709e5e468a6fc714485da288aaa77c80291ce6db8c
    OopsIE SHA256：
    9a040cdd7c9fcde337b2c3daa2a7208e225735747dd1366e6c0fcbc56815a07f
    231115a614c99e8ddade4cf4c88472bd3801c5c289595fc068e51b77c2c8563f
    OopsIE C&C域名：
    www.msoffice365cdn[.]com
    相关恶意域名及IP：
    office365-management[.]com
    office365-technical[.]info
    msoffice-cdn[.]com
    80[.]82.79.221
    80[.]82.79.240
    185[.]162.235.29