### 木马行为分析

在接收到命令后，木马会检查C&C服务器的响应中是否包含“Oops”。如果存在该字符串，则认为C&C服务器出现错误，并退出执行。否则，C&C服务器将以以下格式发送命令及其参数：

```
[command]<>[parameters for command in hexadecimal format]
```

可用的命令包括：
1. 运行命令
2. 上传文件
3. 下载指定文件

所有命令参数均以十六进制格式表示（例如，字符“A”表示为“41”）。

#### 命令详解

- **运行命令 (1)**
  - 参数：附加的命令参数
  - 行为：创建进程`cmd.exe /c [command]`，并将执行结果以十六进制格式写入`%APPDATA%\tmpCa.vbs`文件。
  - 传输：将文件内容按1500字节块读取，并通过HTTP GET请求逐块发送到C&C服务器，请求结构如下：
    ```
    http:///resp?AAZ
    ```

- **上传命令 (2)**
  - 参数：二进制数据的十六进制值和文件名，两者之间用`(!)`分隔。
  - 行为：将C&C提供的数据写入指定文件，并通过以下URL向C&C服务器发送成功通知：
    ```
    http:///resp?AAZ
    ```

- **下载命令 (3)**
  - 参数：文件路径
  - 行为：读取指定文件的内容，如果文件不存在，向C&C服务器发送消息，请求结构如下：
    ```
    http:///resp?AAZ
    ```
  - 如果文件存在，使用`GZipStream`类压缩文件内容，并将压缩后的数据转换为十六进制格式，存储在临时文件中（命名规则：`.tmp`）。然后，按1500字节块读取并发送给C&C服务器，请求结构如下：
    ```
    http:///resp?ABZ
    ```
  - 数据传输完成后，发送完成通知，请求结构如下：
    ```
    http:///resp?ABZFinish
    ```

### 如何确认该木马是由OilRig组织发布的

自2016年5月以来，我们一直在监控OilRig黑客组织的各种攻击行为和所使用的工具。观察到该组织经常重复使用已有的基础工具和组件，以提高效率并减少工作量。

在此次攻击中，我们注意到该组织使用了新的C&C域名来下发有效载荷。经过进一步调查，我们发现了与OilRig组织相关的多个证据：

1. **C&C域名关联**
   - 新的C&C域名`msoffice365cdn[.]com`与之前已知的OilRig C&C域名`office365-management[.]com`共享相同的注册邮箱和电话号码。
   - WHOIS记录显示，注册`msoffice365cdn[.]com`的电子邮件地址还注册了`office365-technical[.]info`，该域名在2017年10月被确认为OilRig的C&C服务器。

2. **IP地址关联**
   - `msoffice365cdn[.]com`解析到的IP地址`80[.]82.79.221`位于与`office365-technical[.]info`相同的C类网络范围内。
   - 该IP地址与其他一些IP地址共享同一个SSL证书，其中一个IP地址`185[.]162.235.29`对应的域名`office365-management[.]com`也是由同一注册邮箱注册的。
   - 对`185[.]162.235.0/24`网段的调查发现，另一个IP地址对应于2017年已确认属于OilRig的域名`msoffice-cdn[.]com`。

3. **文档分析**
   - 确认该文档是ThreeDollars工具的变体，并且作者名称`J-Win-7-32-Vm`与2017年8月收集的一个ThreeDollars早期样本的作者相同。

### 总结

OilRig黑客组织持续活跃，主要针对中东地区发起攻击。他们不断更新工具和策略，但也会重复使用过去的攻击方式或组件。我们已经捕获到该组织使用的大量工具，每个工具都是基于过去工具的变体。随着时间的推移，这些工具的效果逐渐减弱，但我们通过对一系列工具的综合分析，可以推断出OilRig组织的技术能力和战术。

### IoC (Indicators of Compromise)

- **ThreeDollars SHA256:**
  - `ec3f55cac3e8257d6d48e5d543db758fed7d267f14f63a6a5d98ba7a0fab6870`
  - `81eb43ad46ed39bd4b869c709e5e468a6fc714485da288aaa77c80291ce6db8c`
- **OopsIE SHA256:**
  - `9a040cdd7c9fcde337b2c3daa2a7208e225735747dd1366e6c0fcbc56815a07f`
  - `231115a614c99e8ddade4cf4c88472bd3801c5c289595fc068e51b77c2c8563f`
- **OopsIE C&C域名:**
  - `www.msoffice365cdn[.]com`
- **相关恶意域名及IP:**
  - `office365-management[.]com`
  - `office365-technical[.]info`
  - `msoffice-cdn[.]com`
  - `80[.]82.79.221`
  - `80[.]82.79.240`
  - `185[.]162.235.29`