### 9.3.5 统计地图
统计地图专门用于展示区域统计结果。首先，根据经纬度在地图上精确定位，然后绘制饼状图来表示指定区域内数据的统计结果。

#### 配置参数
- **饼状图半径**：设置饼状图的大小。
- **透明度**：调整饼状图的透明度以适应不同的背景。

#### 数据获取
使用以下SPL查询语句可获取统计地图所需的数据：
```spl
logtype:vors AND vors.VendorCountry:United\ States | geostats latfield=vors.VendorLatitude longfield=vors.VendorLongitude maxzoomlevel=3 sum(vors.Weight) by vors.product_name
```

#### 功能特点
- **缩放功能**：用户可以放大和缩小地图以查看不同层级的细节。
- **层级支持**：统计地图最多支持9个数据层级，方便进行多层次的数据分析。

### 9.3.6 其他图表

#### 1. 单值图
单值图示例如图9-23所示。

![](media/image32.png){width="3.1496062992125986in" height="1.2992125984251968in"}

**图9-23 单值图示例**

##### 配置参数
- **数值字段**：取第一个统计数值。
- **展示效果**：
  - **默认**：仅支持颜色填充、字体或背景设置。
  - **按区间**：手动添加数值分段区间并选择对应颜色，分段区间不能重叠。支持颜色填充、字体或背景设置。
  - **按趋势**：设置对比时间，涨跌启用红/绿色背景，可选择绝对值或百分比形式展示对比效果。
- **图标**：
  - **按名称**：输入任意一个Font Awesome免费图标的英文名称，在单值前部展示对应的图标。日志易提供了输入提示功能。
  - **按字段**：通过SPL语句返回某个字段，指定该字段名称，日志易将自动使用该字段值作为Font Awesome图标名称。

单值图图标如图9-24所示。

![](media/image33.png){width="3.1496062992125986in" height="0.6356178915135609in"}

**图9-24 单值图图标**

#### 2. 水球图
水球图只需要配置展示字段，默认用第一个统计数值自动配置。

例如，SPL语句如下：
```spl
logtype:apache | stats pct_ranks(apache.resp_len, 25) | eval ret = _pct_ranks.apache.resp_len.25 / 100
```

执行结果用水球图展示的效果如图9-25所示。

![](media/image34.png){width="3.1496062992125986in" height="2.7401574803149606in"}

**图9-25 水球图示例**

#### 3. 字符云图
字符云图常用于展示单词文本的占比情况，其视觉冲击力比饼状图更强。字符云图自动配置以下参数：

- **展示字段**：取第一个统计数值。
- **分组**：取第一个分组字段。

例如，执行以下SPL语句：
```spl
logtype:apache | stats count() by apache.geo.city
```

相应的字符云图如图9-26所示。

![](media/image35.png){width="4.724409448818897in" height="3.3622047244094486in"}

**图9-26 字符云图示例**

#### 4. 循序图
循序图（又称时序图、顺序图）常用于软件开发的UML领域。在日志易软件中，可以定义循序图的时序、来源、目标、分组、标记字段。系统会自动合并来源和目标字段，得到对象列表。

循序图示例如图9-27所示。

![](media/image36.png){width="3.1496062992125986in" height="3.5354330708661417in"}

**图9-27 循序图示例**

#### 5. 雷达图
雷达图（又称戴布拉图、蜘蛛网图）是一种展示多维（4维以上）数据的图表。将多个维度的数据映射到不同坐标轴上，这些坐标轴起始于同一个原点，将同一组数据对应的点连接起来就得到了雷达图。与饼状图不同，雷达图中点的相对位置和坐标轴之间的夹角没有意义。

为了便于理解和统一比较，通常将多个坐标轴统一成相同的度量形式（如分数、百分比），使雷达图退化为二维图。此外，雷达图还可以展示数据集中各个变量的权重，适用于展示性能数据。

雷达图示例如图9-28所示。

![](media/image25.tiff){width="3.098333333333333in" height="2.95in"}

**图9-28 雷达图示例**

如果采用统一度量，可以获得二维图效果，如图9-29所示。

![](media/image26.tiff){width="3.255in" height="3.135in"}

**图9-29 采用统一度量的雷达图**

**注意**：雷达图上的指示器过多或切分过多会导致可读性下降，使用时应控制数量，使雷达图简洁、清晰。

#### 6. 漏斗图
漏斗图适用于业务流程规范、周期长、环节多的单流程单向分析，通过比较各环节的业务数据，能够直观地发现存在问题的环节，进而做出决策。漏斗图示例如图9-30所示。

![](media/image37.png){width="5.756944444444445in" height="2.4208333333333334in"}

**图9-30 漏斗图示例**

漏斗图从上到下反映了逻辑上的顺序关系，显示了随着业务流程的推进业务目标完成的情况。在日志易软件中，可以定义漏斗图的数值和切分字段。

#### 7. 矩阵热力图
矩阵热力图结合矩阵布局进行时序数据分析。在日志易软件中，可以定义矩阵热力图的X轴、Y轴字段以及Y轴的分段数量。矩阵热度使用的并不是原始数据，而是计算落入对应分段区间的分组个数，分组个数越多，说明该区间数据越集中，热度越高。

例如，执行如下SPL语句：
```spl
* | bucket timestamp span=1d as ts | stats count() by ts, appname
```

得到的矩阵热力图如图9-31所示。

![](media/image27.tiff){width="5.56in" height="2.578333333333333in"}

**图9-31 矩阵热力图示例**

#### 8. 调用链图
调用链图用来展示Zipkin、Pinpoint、SkyWalking 和 Jaeger 等开源Tracing方案的数据。首先用SPL统计语句搜索出结果，再配置调用链参数（见图9-32）。

- **函数**：调用链表格展示的第一列。
- **父ID**：用来确定调用关系。
- **子ID**：用来确定调用关系。
- **开始时间**：函数开始时间，用来画时间轴。
- **持续时间**：函数运行时间，用来画时间轴。
- **信息字段**：可选，用来展示更多信息。
- **展示颜色**：用于选择颜色。

![](media/image38.png){width="3.1960728346456695in" height="1.5660750218722659in"}

**图9-32 调用链参数**

调用链图示例如图9-33所示。

![](media/image39.png){width="5.680621172353455in" height="0.6066940069991251in"}

**图9-33 调用链图示例**

## 9.4 日志可视化案例
日志的数据来源包括网络设备、操作系统、中间件系统、应用系统等。本节以MySQL性能日志与金融业务日志为例，介绍可视化分析的具体应用。

### 9.4.1 MySQL性能日志可视化
主要监控MySQL单节点的一些资源使用与性能数据，通过查询`information_schema`和`performance_schema`下的相关数据表及视图，实现数据展示。本节中的操作适用于MySQL 5.5及以上版本，采集数据需要`process`权限。

#### MySQL性能监控标签页
如图9-34所示。

![](media/image40.png){width="4.369725503062117in" height="1.7893274278215223in"}
![](media/image41.png){width="4.386843832020998in" height="2.5009109798775153in"}

**图9-34 MySQL性能监控标签页**

MySQL性能监控标签页主要展示线程连接情况，从SQL维度统计哪类语句执行最多、哪类语句的平均响应时间最长。

#### MySQL资源监控标签页
如图9-35所示。

![](media/image42.png){width="5.202224409448819in" height="2.2125120297462817in"}
![](media/image43.png){width="5.301639326334208in" height="0.7613910761154855in"}

**图9-35 MySQL资源监控标签页**

MySQL资源监控标签页主要展示MySQL各Schema大小，从Host（客户端）、User（用户）维度统计连接池使用情况，以及各类锁和事务。

由于篇幅有限，下面仅对MySQL性能监控标签页进行详细说明。

#### MySQL性能监控标签页内容
MySQL性能监控标签页包含以下几个部分：
- **线程连接情况**：展示当前活跃的线程连接数。
- **SQL语句统计**：统计各类SQL语句的执行次数和平均响应时间。
- **资源使用情况**：展示CPU、内存、磁盘I/O等资源的使用情况。

通过这些图表和数据，可以全面了解MySQL服务器的性能状况，及时发现并解决问题。