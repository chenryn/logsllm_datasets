459
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:58:33 UTC from IEEE Xplore.  Restrictions apply. 
(cid:1)(cid:2)(cid:3)(cid:4)(cid:5)(cid:4)(cid:5)(cid:4)(cid:5)(cid:6)(cid:7)(cid:8)(cid:6)(cid:7)(cid:8)(cid:6)(cid:7)(cid:8)(cid:1)(cid:9)(cid:10)(cid:11)(cid:12)(cid:13)(cid:10)(cid:6)(cid:14)(cid:14)(cid:12)(cid:10)(cid:3)(cid:10)(cid:15)(cid:16)(cid:17)(cid:10)DCIF(cid:1)(cid:9)(cid:10)(cid:11)(cid:12)(cid:13)(cid:10)(cid:6)(cid:14)(cid:14)(cid:12)(cid:10)(cid:3)(cid:10)(cid:15)(cid:16)(cid:17)(cid:10)WB(cid:1)(cid:17)(cid:12)(cid:11)(cid:18)(cid:19)(cid:10)(cid:20)(cid:18)(cid:15)(cid:13)(cid:21)(cid:18)(cid:22)(cid:23)(cid:24)(cid:15)(cid:25)(cid:13)(cid:26)(cid:1)(cid:20)(cid:24)(cid:27)(cid:1)(cid:17)(cid:12)(cid:20)(cid:18)(cid:19)(cid:10)(cid:8)(cid:21)(cid:16)(cid:11)(cid:10)(cid:23)(cid:20)(cid:16)(cid:11)(cid:28)(cid:10)(cid:26)(cid:1)(cid:8)(cid:20)(cid:27)Figure1.ArchitectureblockdiagramshowingEmμcode.Componentsinclude:EmμcodeControlUnit(ECU),EmμcodeTraceCache(ETC),andEmμcodeDestinationRegister(EDR).pipelineisnecessary.InordertofacilitateEmμcode,low-costmicroarchitec-turemodiﬁciationsarenecessary.Emμcodetracesmustex-ecuteinanon-intrusivemanner.Theycannotchangetheoriginalarchitectedstateasthismighthaveanadverseef-fectontheoriginalprogram.AnotherimportantaspectofEmμcodeisthecreationofthetracesthatwillsupplantanoriginalinstruction.Anaiveimplementationistosim-plycompileasoftwareﬂoatingpointlibraryandusethecodegeneratedasatrace.Butthereispotentialformuchoptimization.Theseoptimizationsexploitedknowledgeoftheactualtrace,aswellastheﬂexibilitytomakeminimalbutimportantmodiﬁcationstothemicroarchitecture.Pred-ication,extraarchitectedregistersonlyvisibletothemi-crocode,themicrocode’sﬂexibilitywithsourceanddesti-nationregisters,andtheimplementationofnewmicro-opswereusedtooptimizethetracestobeatbest6xfasterthanthenaiveimplementationand3.79xfasterintheaveragecaseforthetracesthemselves.OverviewThispaperisorganizedasfollows.Section2motivatesanddescribestheEmμcodeimplementationandlinkage.Section3describestraceoptimizations.Section4evaluatesEmμcodeinthecontextofacontemporaryar-chitecture.Section5givesanoverviewofrelatedwork.Section6concludes.2.EmμcodeAsprocesssizesshrinkandtheentireprocessingpipelinebecomesincreasinglysusceptibletohardfaults,protectionsforallinstructiontypesmustbeaddressed.Asadditionalsysteminstructions,suchasnewhardwarevir-tualizationsupportandspecial-purposehardwarelikeSSEvariants[21],becomeprevalent,therearisesaneedforacatch-alltechniquethatmaskshardfaultsinpartsofthechipnotprotectedbyduplicationmechanisms.Emμcodeisatechniquethatextendspreviousworktoincreasethereliabilityofcomplexcontemporarymicroprocessors.EmμcodeprovidesGPDforacceleratedinstructionswithouttheneedtoduplicatethestructurebyusingsoft-wareemulationratherthanhardwareduplication.AsFig-ure1shows,EmμcodeconsistsoftheEmμcodecontrollerthatisusedfororchestratingtheuseofEmμcodetraces,whicharemicrocodedversionsoftheinstructionsEmμcodeprotects.EmμcodetracesarestoredintheEmμcodeTraceCache,andrelevantinformationaboutthecurrentinstruc-tionbeingEmμcodedisstoredintheEmμcodeDestina-tionRegister(EDR).Onceafaultisdetected,Emμcodeisinvokedandreplacesthehardware-acceleratedinstructionwithasoftware-onlymicrocodetrace.Thus,theEmμcodetraceisrequiredtousepartsofthepipelinewhicharepro-tectedbyothertechniquessuchasGPDorSD.Usingthistechnique,Emμcodeisabletocoverasetofinstructionsthatwouldotherwiseincurhighmarginalcostperinstruc-tionifprotectedusingSDalone.Emμcodetracesaredesignedtousestructuresnotusedbytheoriginalinstruction,speciﬁcally,forthisstudyprotectingﬂoatingpointinstructions,theintegerpipelinewhichcanbeprotectedmorecheaplybySD.ThetracesshouldbeoptimizedtofacilitateEmμcodesinceperfor-manceisstillaprimaryconcern.Thispaperpresentstech-niquesthatcanproduceoptimizedtracestobeusedinamicrocodetechniquesuchasEmμcode.978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
460
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:58:33 UTC from IEEE Xplore.  Restrictions apply. 
2.1.CaseStudy:SSEFloatingPointFloatingpointarithmeticisinherentlydifferentfromreg-ularintegerarithmetic.Sincethereisaﬂoatingpointunitinmostmodernmicroprocessors,ﬂoatingpointarithmeticwillprovideagoodevaluationforEmμcodetracesbecauseaﬂoatingpointunitisanexpensivepieceofhardwaretodu-plicate.Speciﬁcally,theSSEinstructionsthatutilizebothoftheﬂoatingpointunitsinthepipelinesimultaneously,pro-videgoodexamplesofinstructionsthatwouldbehardtoduplicatewithSD,becauseitwouldessentiallyrequireim-plementinganentirealternateﬂoatingpointpipeline.Evenifonlyconsideringasingleﬂoatingpointarithmeticopera-tion,reproducinganentirealternateﬂoatingpointunitforthepurposeofreliabilityisarea-expensive.Emμcodecanbeusedtosupplantthesekindsofinstructionsincaseoferrorbyutilizingonlytheintegerpipeline.2.2.EmμcodeDesignTheEmμcodeControlUnit(ECU)isthecontrollogicfortheEmμcodedesign.TheEmμcodeECUtakesoveronceahardfaulthasbeendetectedforacertaininstruction.Abitissetinabit-maskofalloperationcodes(opcodes)thatcanbeEmμcodedsignifyingthatafaulthasbeende-tected.Ifthebitissetfortheopcodeofthecurrentlydecodinginstruction,EmμcodetakesoverandimplementstheoriginalinstructionwithanEmμcodetrace.Emμcodeneedstooperateinanenvironmentwheretheoriginalarchi-tectedstatedoesnotchangetoensuretheproperexecutionoftheprogram.Implementingandtrappingintothisspacepresentsachallenge.TosupportmultiplecodepathsandbranchingwithinEmμcodetraces,itisnecessarytotakecontrolofanaddressspacetodifferentiatebetweenbasicblocksoftheEmμcodetrace.ThereforeasmalladdressspacewassectionedoffforEmμcodeuseonly.EmμcodetracesrequiresendingthecurrentinstructiondecodewithabranchtotheEmμcodetrace,andbranchingbackattheendofthetrace.Theover-allprocessoftrappingfromtheoriginalinstructionstreamtotheEmμcodetraceandbackispresentedinFigure2.EmμcodelinkageincludesasetofregisterscalledtheEmuregistersthataremeanttobeintermediaryregisterstostoresourceoperandsandnecessaryinformationtoreturnbacktotheoriginalinstructionstream.TheyarenecessarybecauseEmμcodecannotchangetheoriginalstateoftheprogram,andthereforecannotchangethearchitectedregis-terﬁle.Alongthesesamelinesanewsetofregisters,calledEmutraceregisters,areusedwhenexecutinganEmμcodetrace.TheEmuregistersandEmutraceregistersaretreatedthesameasthearchitectedregisterswithrespecttothemi-croarchitecture.TheSSEinstructionsdonotchangeﬂags,sotheﬂagsmustbesavedandrestoredtoreturnthepro-(cid:37)(cid:72)(cid:74)(cid:76)(cid:81)(cid:81)(cid:76)(cid:81)(cid:74)(cid:3)(cid:82)(cid:73)(cid:3)(cid:40)(cid:80)(cid:88)(cid:70)(cid:82)(cid:71)(cid:72)(cid:3)(cid:87)(cid:85)(cid:68)(cid:70)(cid:72)(cid:48)(cid:82)(cid:89)(cid:72)(cid:3)(cid:86)(cid:82)(cid:88)(cid:85)(cid:70)(cid:72)(cid:86)(cid:3)(cid:87)(cid:82)(cid:3)(cid:40)(cid:80)(cid:88)(cid:3)(cid:85)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:86)(cid:54)(cid:68)(cid:89)(cid:72)(cid:3)(cid:73)(cid:79)(cid:68)(cid:74)(cid:86)(cid:3)(cid:87)(cid:82)(cid:3)(cid:40)(cid:80)(cid:88)(cid:3)(cid:85)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:51)(cid:79)(cid:68)(cid:70)(cid:72)(cid:3)(cid:68)(cid:71)(cid:71)(cid:85)(cid:72)(cid:86)(cid:86)(cid:3)(cid:82)(cid:73)(cid:3)(cid:81)(cid:72)(cid:91)(cid:87)(cid:3)(cid:76)(cid:81)(cid:86)(cid:87)(cid:85)(cid:88)(cid:70)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:76)(cid:81)(cid:87)(cid:82)(cid:3)(cid:40)(cid:80)(cid:88)(cid:3)(cid:85)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:36)(cid:71)(cid:71)(cid:3)(cid:71)(cid:72)(cid:86)(cid:87)(cid:76)(cid:81)(cid:68)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:85)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:3)(cid:87)(cid:82)(cid:3)(cid:40)(cid:80)(cid:88)(cid:70)(cid:82)(cid:71)(cid:72)(cid:3)(cid:39)(cid:72)(cid:86)(cid:87)(cid:76)(cid:81)(cid:68)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:53)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:37)(cid:85)(cid:68)(cid:81)(cid:70)(cid:75)(cid:3)(cid:87)(cid:82)(cid:3)(cid:40)(cid:80)(cid:88)(cid:70)(cid:82)(cid:71)(cid:72)(cid:3)(cid:87)(cid:85)(cid:68)(cid:70)(cid:72)(cid:40)(cid:81)(cid:71)(cid:3)(cid:82)(cid:73)(cid:3)(cid:40)(cid:80)(cid:88)(cid:70)(cid:82)(cid:71)(cid:72)(cid:3)(cid:87)(cid:85)(cid:68)(cid:70)(cid:72)(cid:42)(cid:72)(cid:87)(cid:3)(cid:71)(cid:72)(cid:86)(cid:87)(cid:76)(cid:81)(cid:68)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:85)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:3)(cid:73)(cid:85)(cid:82)(cid:80)(cid:3)(cid:40)(cid:80)(cid:88)(cid:70)(cid:82)(cid:71)(cid:72)(cid:3)(cid:39)(cid:72)(cid:86)(cid:87)(cid:76)(cid:81)(cid:68)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:53)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:48)(cid:82)(cid:89)(cid:72)(cid:3)(cid:85)(cid:72)(cid:86)(cid:88)(cid:79)(cid:87)(cid:3)(cid:76)(cid:81)(cid:87)(cid:82)(cid:3)(cid:71)(cid:72)(cid:86)(cid:87)(cid:76)(cid:81)(cid:68)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:85)(cid:72)(cid:74)(cid:76)(cid:86)(cid:87)(cid:72)(cid:85)(cid:53)(cid:72)(cid:86)(cid:87)(cid:82)(cid:85)(cid:72)(cid:3)(cid:73)(cid:79)(cid:68)(cid:74)(cid:86)(cid:37)(cid:85)(cid:68)(cid:81)(cid:70)(cid:75)(cid:3)(cid:87)(cid:82)(cid:3)(cid:81)(cid:72)(cid:91)(cid:87)(cid:3)(cid:76)(cid:81)(cid:86)(cid:87)(cid:85)(cid:88)(cid:70)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:73)(cid:85)(cid:82)(cid:80)(cid:3)(cid:83)(cid:85)(cid:82)(cid:74)(cid:85)(cid:68)(cid:80)(cid:36)(cid:71)(cid:71)(cid:85)(cid:72)(cid:86)(cid:86)(cid:3)(cid:82)(cid:73)(cid:3)(cid:82)(cid:85)(cid:76)(cid:74)(cid:76)(cid:81)(cid:68)(cid:79)(cid:3)(cid:40)(cid:80)(cid:88)(cid:70)(cid:82)(cid:71)(cid:72)(cid:71)(cid:3)(cid:76)(cid:81)(cid:86)(cid:87)(cid:85)(cid:88)(cid:70)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:36)(cid:71)(cid:71)(cid:85)(cid:72)(cid:86)(cid:86)(cid:3)(cid:82)(cid:73)(cid:3)(cid:81)(cid:72)(cid:91)(cid:87)(cid:3)(cid:76)(cid:81)(cid:86)(cid:87)(cid:85)(cid:88)(cid:70)(cid:87)(cid:76)(cid:82)(cid:81)(cid:3)(cid:73)(cid:85)(cid:82)(cid:80)(cid:3)(cid:83)(cid:85)(cid:82)(cid:74)(cid:85)(cid:68)(cid:80)Figure2.Overviewoflinkingfromoriginalin-structionstreamtotheEmμcodetrace.gramtotheexactstatethatwasexpectedaftertheexecutionoftheSSEinstruction.Twonewmicro-opswereimplementedinordertofacil-itatesavingandrestoringtheﬂags.Thesemicro-opshaveadelayofonecycle.Addingthesetwomicro-opsissufﬁcienttoallowmicrocodecontrolﬂowforEmμcodetraces.AsFigure2shows,theoriginalinstructionisdecodedwithabranchtotheEmμcodetrace,thereforetheaddressofthenextinstructionissavedinanEmuregister,andthedestinationoftheinstructionissavedintheEmμcodeDesti-nationRegister.NexttheEmμcodetracewilltakeoverandexecuteinascratchspacethatdoesnotmodifytheoriginalarchitectedstate.OncetheEmμcodetracehascompleteditwillreadinthedestinationregisteroftheoriginalinstruc-tionfromtheEmμcodeDestinationRegister,movethere-sultintoit,andindirectlyjumptothenextinstructionintheoriginalinstructionstream.3.TraceOptimizationAbaselineimplementationofEmμcodetracesisgen-eratedbycompilingSoftFloat2b[8]withgcc-O3-finlinefunctionsandconvertingtheassemblyintomicro-ops.Thesetracesprovedtobetoodetrimentalto978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
461
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:58:33 UTC from IEEE Xplore.  Restrictions apply. 
overallperformance.Sincethesetraceshavepredictabledynamicbehaviorinactualpractice,suchasthesourcesordestinationnumbersnotbeingNaNordenormal,wewereabletotargetapredictablepaththatgccisnotabletodo.Wewerealsomakeminormodiﬁcationstothemi-croarchitecturetoimproveperformance.Wealsohavemoreknowledgeabouttheactualimplementationoftracesandknowthatforourcase,predicationtoavoidhard-to-predictbranchesisagoodideawhereasthevalueofpredicationishardtodeterminestatically.3.1.RegisterSpillReductionInstandardcompilation,compilerswillspilltomemoryundertheassumptionofaverylargestack.ThereasongccrequirestheuseoflocalvariablesisthatthetargetISA,x86,onlyhassevenregistersthatgcccanuse,inadditiontothestackregister.Withsofewregisters,gcccannotstoreallthedataneededforthecomputation,includingintermediatedatainregisters.Wecangetaroundthislimitationbycre-atingnewarchitectedregistersthatarenotvisibleattheex-ternalISA.Therefore,increasingthenumberofarchitectedandavailableregisterscanimprovetheoptimizationsthatwecandoonthetrace.Inmicrocodethereislimitedactualmemorythatcanbeusedfortemporaryinformationwithoutcompromisingthearchitectedstate.Therefore,inordertoimplementthetracethecreationofanEmμcodescratchspaceisnecessary,whichis1kBinsizeandassumedtoexistatthesamelevelasthelevel1datacache.Althoughitneveractuallyusesclosetoafull1kB,itisnotknownwhatfuturetracesmayuse.Theoptimizedtracesdonotusethescratchspace,astheyusesevenadditionalarchitectedregistersinstead.Thetracesconvertedfromgcccompilationdousethescratchspace.3.2.PreservingISASemanticsManyCISCarchitecturesimplementaseparateinternalISAbyutilizingmanyRISCmicro-operations[9].SincegcctargetstheexternalISAitcannotexploitfeaturesoftheinternalRISCISA.However,theinternalRISCISAdoesnotnecessaryhavethesamelimitationsastheexternallyvisibleISA.ThereforeoptimizationispossiblebyusingtheRISCmicro-opswhichcanallowformoreregistersthanallowedbythetargetISA.SincegcctargetstheexternalISA,andinthiscasethex86ISA,requiredmanyinstructionstohaveonesourceoperand,andonesourceanddestinationoperand.How-ever,themicrocodeisnotlimitedtoonesourceoperandandonesourceanddestinationoperand.Themicrocode,weassume,allowsuptothreesourceregistersandadiffer-entdestinationregisterformanyoperations.AnexampleofanISAlevelinstructionthatcanhavetwosourceoperandsandadifferentdestinationoperandistheleainstructiononx86,whichdoesallowthislevelofﬂexibilitywithanaddoperation.However,therearenotnecessarilycomple-mentaryinstructionslikeleaforotherstandardoperationslikeor,and,andxorattheISAlevelthatcanexistatthemicrocodelevel.Sincegccdoesnotknowthis,itgener-atescodethatwillmovedatathatneedstobesavedtothestacksothatitcanperformanoperationthatwillclobbertheregister.3.3.PredicationinTraceOptimizationTherearemanyhard-to-predictbranchesintheEmμcodetraces.Thisleadstoproblemsdealingwithbranchmisprediction.1if(0<=(int32_t)(zSig0<<1)){2zSig0<<=1;3--zExp;4}Figure3.Thecheckforthemantissaof32bitﬂoatingpointproductresultbeingtoolarge.Considerthepieceofcodeinthe32bitﬂoatingpointmultiplyofSoftFloat2binFigure3.Mispredictingthisbranchchangestheexecutiontimeofthetracefrom25cy-clesto48cycles,a23cyclepenalty.Onahard-to-predictbranchthiscausesconcernfortheaveragecase.Predicationcanbeusedtoimproveperformanceinthesecases.PredicationistheideaofhavingaBooleanguardaroundtheissueofaninstruction.HsuandDavidsonpresenttheideaofhavingaguardexpressionoverastoreorbranchinstruction[10].Byimplementingpredication,itispossibletofetchanddecodeinstructionsunrelatedtotheconditionbeforetheconditioniscalculated.Withpred-ication,instructionscanbemovedaroundandimplementedundertheassumptionthatinstructionswillonlybeallowedtoexecuteoncetheresultofaBooleanguardiscalculated.Bydoingthistheycreateanewscheduleofinstructionsthatimprovesperformancedramatically.IntheexampleinFig-ure3theguardwouldbethebooleanintheifstatementonline1andtheconditionalinstructionswouldbestatements2and3.Manycontemporaryarchitecturessupportpartialpred-icationinstructions.PartialpredicationasexplainedbyMahlkeetal.[13]istheabilityforinstructionstotakeasetofconditioncodes.Iftheconditioncodeturnsouttobetrue,theresultofexecutioniswrittenback.Iftheconditioncodeisnottrue,theresultoftheexecutionisthrownawayandnotused.Thisdiffersfromfullpredicationbecausefull978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE