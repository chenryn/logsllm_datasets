场景三：行内外围系统发起的交易
成员行内外围系统发起的交易，直连成员行ESB，再调用联盟ESB，统一流水号、调用路径号应从成员行ESB处生成，与场景二相同。
场景四：人民银行发起的来帐交易场景四：人民银行发起的来帐交易
人民银行发起的来帐交易，调用联盟二代支付系统（大小额），统一流水号、调用路径号应从联盟二代支付系统处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
人民银行发起的来帐交易，调用联盟网银互联系统，统一流水号、调用路径号应从网银互联系统处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
场景五：银联发起的来帐交易
银联发起的来帐交易，调用联盟银联前置，进入联盟系统，统一流水号、调用路径号应从银联前置系统处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
ATM发起的交易，因ATM属于行内外围系统，与场景三相同。
场景五：网联发起的来帐交易
网联发起的来帐交易，调用XBUS，进入联盟系统，统一流水号、调用路径号应从XBUS处生成，与场景二相同。
往帐交易是由联盟内部发起，与场景一相同。
场景六：联盟内部系统批量、定时任务往帐交易是由联盟内部发起，与场景一相同。
场景六：联盟内部系统批量、定时任务
联盟统建系统内部通过批量、定时任务或其他方式自动发起的任务，统一流水号、调用路径号应从发起任务的系统处生成，与场景一相同。
场景七：消息推送类场景
消息推送类业务，例如由于用户帐户变动而触发的，由联盟统建系统内部CBUS核心发起的通知推送，通过ESB调用微信前置、XBUS相关服务，发送到微信公众号、短信平台等第三方系统，最终推送到用户手机上。统一流水号、调用路径号应从发起任务的CBUS核心处生成，与场景一相同。
传递规则
分布式域
分布式域在交易路径跟踪里，作为一个黑盒来处理，内部的跟踪串联由自身完成。
中间件组件
容器类：如果此类组件可以按照要求输出跟踪日志，则可作为交易路径上的节点体现，否则不需要在交易路径中体现。
消息传输类：如果此类组件可以按照要求输出跟踪日志，则可作为交易路径上的节点体现，否则不需要在交易路径中体现。负载均衡类：如果此类组件可以按照要求输出跟踪日志，则可作为交易路径上的节点体现，否则不需要在交易路径中体现。
数据库组件
数据库组件不需要在交易路径中体现。
专用组件
例如安全加密设备、第三方前置，此类组件不需要在交易路径中体现。
第三方系统
交易调用路径中，联盟统建系统调用第三方系统时，如果是单向消息模式的调用，调用完成后携带统一流水号继续后续操作即可；如果是请求应答模式的调用，则等待第三方系统返回后，根据上下文找到原来的统一流水号继续后续操作。
无论是从第三方系统向联盟统建系统发起的服务调用，还是联盟统建系统向第三方系统发起的服务调用，调用路径号均应做深度、广度递增处理，由联盟统建系统供接口、需接口的相关接收或发送动作来处理。
历史负债直连系统
关于历史负债的系统直连的问题，也就是没有经过ESB，也没有按照ESB的报文规范来的，不在交易路径跟踪方案考虑范围之内。
持久化规则
持久化到日志文件持久化规则
持久化到日志文件
全局统一流水号、调用路径号，都应该在交易路径上各应用系统的日志文件中输出（详见后文的跟踪日志规范），用来支撑基于日志分析的交易路径跟踪和监控。
持久化到数据库
全局统一流水号应该在交易路径上各业务类系统的数据库中保存，用来支撑大数据平台开展数据整合、数据质量核检等功能。
报文规范支持
ESB XML联机交易接口规范改造
新增三个报文头字段：
| XPATH | /Service/Service_Header | /Service/Service_Header | /Service/Service_Header | /Service/Service_Header | /Service/Service_Header |
|---|---|---|---|---|---|
| 字段名称 |字段中文名称 |长度 |必填 |属性 |内容说明 || 字段名称 |字段中文名称 |长度 |必填 |属性 |内容说明 |
| global_trace_num |全局统一流水号 |45 |M |C |参考上文全局统一流水号规范 |
| global_path_num |调用路径号 |45 |M |C |参考上文调用路径号规范 |
| client_sysid |服务请求方系统编号 |11 |M |C |服务请求方填写。编号规则由ESB进行制定与管理。 |
核心CICS报文改造
（1）普通联机报文
新增两个报文头字段：
| 字段名称 | 字段中文名称 | 类型 | 长度 | 内容说明 |
|---|---|---|---|---|
| INM-GLOBAL-SEARCH-NO |全局统一流水号 |C |45 |联盟交易路径跟踪日志统一规划需要  |
| INM-CLIENT-SYS-NO |服务请求方系统编号 |C |11 |联盟交易路径跟踪日志统一规划需要  |（2）大事务报文
新增两个报文头字段：
| 字段名称 | 字段中文名称 | 类型 | 长度 | 说明 |
|---|---|---|---|---|
| INM-GLOBAL-SEARCH-NO |全局统一流水号  |C  |45  |联盟交易路径跟踪日志统一规划需要 	 |
| INM-CLIENT-SYS-NO |服务请求方系统编号 |C |11 |联盟交易路径跟踪日志统一规划需要 |
说明：因为核心都是作为交易路径调用的末端节点，不会再去调用其他组件，出于对核心改造工作量、处理性能等方面的考虑，ESB没有必要将调用路径号字段传递给核心，只要将全局统一流水号、服务请求方系统编号传递给核心即可。日志分析平台进行日志分析串联的时候，对于核心侧的跟踪日志特殊处理一下，不使用调用路径号，而是根据业务流水号跟ESB侧的日志串联起来。
交易路径跟踪日志规范
适用范围交易路径跟踪日志规范
适用范围
本文档描述的交易路径跟踪日志规范，适用于各应用系统的研发部门。部署位置无论在联盟还是成员行，均适用于此日志文件规范。交易路径跟踪日志规范对各个应用系统内联机交易处理部分进行约束，对于文件传输或者批处理类型的处理过程，不适用。
以联机交易形式存在的交易连通性测试、批处理监控报文等，视同普通联机交易处理，适用于本规范。
日志记录方式
具备条件的应用系统应单独为交易路径追踪生成跟踪日志文件，以便于减少日志分析量，提升日志分析效率，减少跟踪监控延时。如果无法单独生成跟踪日志文件，可在原有系统日志中按照规范夹带输出跟踪日志，由日志分析平台的采集代理过滤提取。
存放目录及日志文件命名
..\日期\进程名称\[自定义]_gl.log.yyyyMMddHH
样例：
..\20170118\CBOD-1\sccbaesb1_CBOD1_ESB_gl.log.2018011213日志记录时机
对于供接口请求报文接收、需接口响应报文接收动作，应在接收到报文完成，解析出报文头相关信息但未进行业务逻辑处理时记录日志。对于供接口响应报文发送、需接口请求报文发送动作，应在报文发送完成后记录日志。
日志级别
输出日志级别不做统一要求，只要生产环境能够正常输出跟踪日志信息即可。
日志滚动方式
按照日期小时滚动。
编码格式
日志文件建议采用UTF-8字符集编码，如果使用GBK等其他字符集编码，由日志采集代理适配。
分隔符
单条日志中，使用“#”分隔各日志字段，日志字段为空时，分隔符仍要输出。
内容格式
单独生成跟踪日志的情况下，每行直接输出日志内容即可，不需要日志头；对于在系统日志中夹带输出跟踪日志的情况，如果日志头部分必须要输出，可由日志采集代理过滤掉。
日志字段名或日志内容中不要出现字段分隔符：“#”，可替换为其他符号。
每条日志单行打印，不能产生换行。
数据行定义每条日志单行打印，不能产生换行。
数据行定义
| 序号 | 字段名 | 参考长度 | 描述 | 需要输出日志字段的联机交互动作 |
|---|---|---|---|---|
| 1 |日志版本号 |3 |日志规范的版本号，此文档中日志规范的版本号为1.0 |全部 |
| 2 |时间 |23 |日志实际输出时间格式： yyyy-MM-dd HH:mm:ss.SSS |全部 |
| 3 |全局统一流水号 |45 |发起端系统填充，整个交易流转过程中该流水号不变 |全部 |
| 4 |调用路径号 |45 |调用路径编号 |全部 |
| 5 |日志类型 |1 |G：全局跟踪日志 |全部 |
| 6 |节点类型 |3 |条线自定义，可为空 |全部 |
| 7 |主机名 |20 |当前服务器主机名称 |全部 |
| 8 |成员行号 |3 |获取不到可为空 |全部 || 8 |成员行号 |3 |获取不到可为空 |全部 |
| 9 |服务调用类型 |2 |0：非组合交易 1：组合交易，本服务依赖其他服务调用结果 2：组合交易，本服务不依赖其他服务调用结果 3：通过消息中间件发布消息 4：通过消息中间件订阅消息 |全部 |
| 10 |联机交互模式 |3 |单向消息模式： RS（请求报文发送） RC（请求报文接收） 请求应答模式（同步）： SRS（请求报文发送） SRC（请求报文接收） SPS（响应报文发送） SPC（响应报文接收） 请求应答模式（异步）： ARS（请求报文发送） ARC（请求报文接收） APS（响应报文发送） APC（响应报文接收） |全部 |
| 11 |服务请求方系统编号 |11 |联盟统一规划的11位系统编号 举例：80100180000 |全部 |
| 12 |服务提供方系统编号 |11 |联盟统一规划的11位系统编号 举例：80100180000，对于服务请求方来说，如果不能确定可为空 |全部 || 13 |组件实例编号 |17 |联盟统一规划的组件实例编号 |全部 |
| 14 |组件实例服务端口号 |5 |组件实例服务端口号，获取不到可为空 |全部 |
| 15 |服务请求方交易码 |14 | |全部 |
| 16 |服务提供方交易码 |14 | |全部 |
| 17 |业务流水号 |19 |esbxml报文service_sn，获取不到可为空 |全部 |
| 18 |交易状态 |1 |成功：0 失败：1 超时(没有收到信息)：2 |需接口响应报文接收 |
| 19 |响应码 |12 | |供接口响应报文发送 |
| 20 |自定义字段1 | |各系统自己定义，不做统一要求，但不能产生换行 | |
| 21 |自定义字段2 | |各系统自己定义，不做统一要求，但不能产生换行 | |
| 22 |自定义字段... | |各系统自己定义，不做统一要求，但不能产生换行 | |系统间数据流向及架构关系
日志分析平台
日志文件：每个应用系统按照交易路径跟踪统一日志规范，将日志文件记录在本地。
采集代理：在每台记录日志文件的主机上部署日志采集代理，用来实时采集日志文件并上传到日志分析平台进行统一处理。
日志分析平台：负责接入各种日志数据，通过系统自带或用户配置的规则引擎解析日志，抽取关键字段，将非结构化的日志转化为结构化数据。对关键字段及日志全文做分布式索引，方便用户对关键字段或全文进行检索。
数据下档
数据库：各应用系统按照交易路径跟踪规范，将全局统一流水号持久化到数据库。
数据下档：各应用系统将业务数据下档给数整平台，再通过全局统一流水号对下档数据进行数据整合和数据质量核检。
架构管理工具
日志分析平台：通过实时接口，以一次完整交易为单位，将全局统一流水号相同的同一次交易的日志数据，推送给架构管理工具。架构管理工具：从实时接口接收日志分析平台推送的一次完整交易的日志数据，按照调用路径号构建交易路径，用来核对应用架构基线的正确性和完整性，梳理出典型的交易路径，并可以对某个交易路径做可视化的展示。
BPC系统
BPC系统：对网络抓包获取的数据进行分析，用统一流水号将交易数据串联起来，展示交易路径信息和交易总体状况。
附录
附录一：应用系统编号表
详见《渠道分类表_按照系统隶属》
附录二：应用组件编号
附录三：应用组件实例编号