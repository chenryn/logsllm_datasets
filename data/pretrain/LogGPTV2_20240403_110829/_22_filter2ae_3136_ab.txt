攻击过程如图11所示。恶意的动态主机配置协议PDU可使用以下几种方式发送：
允许更改主机名参数的自定义脚本
数据包处理工具（如Scapy等）
dhclient -H 命令
/etc/hostname文件修改
图11
**3.4特权升级**
没有管理员权限的本地或远程用户可以通过特权升级从而成为管理员。攻击者利用隐藏的非管理用户的存在，使用默认密码。通过将这些没有特权的用户连接到路由器FTP服务器，攻击者可以下载/etc/passwd和config.xml文件，如图12所示。最后一个是以明文形式存储所有路由器的配置参数，包括所有用户的密码。文件的一部分如图13所示。这样做，任何用户都可以获得管理员权限。
图12
图13
**3.5 信息泄露**
无需任何登录过程，外部攻击者就能获取目标路由器的重要信息，如Wi-Fi密码和WLAN参数、Internet配置以及连接用户列表等。这些安全隐患一般由不当的文件权限和意外的调试信息造成。在某些情况下，受支持API（例如JSON）的配置不当，会导致路由器定期发布包含关键信息的无保护文件，如图14所示，而获取这些重要信息就如同访问公开文件（图15）或网页一样简单（图16）。
图15
图16
**3.6后门**
隐藏管理员帐户对于终端用户来说完全不可见，这使得任何攻击者都能够通过Web界面或拨号网络随意更改路由器配置设置。图17显示了一个名为“admin”的后门管理员帐户，其密码为“7449airocon”。该账户仅出现在备份XML配置文件中，无法被删除。
图17
**3.7旁路认证**
未经身份验证的攻击者可以通过不当文件权限或是错误服务配置，实现路由器配置更改。
在几个路由器型号中，攻击者可以通过不断访问/rebootinfo.cgi
URL来实现永久拒绝服务，如图18所示。攻击者还可以访问/restoreinfo.cgi
URL强制重置路由器至默认配置（图19）。之后，任何用户都可以使用默认凭据登录该路由器。
图18
图19
在两次未经身份验证的攻击中，路由器都会回复HTTP
400状态码，但其实际正在执行重新启动或是重置设置的操作。集成在一些设备中的SMB文件共享服务，可能会因为共享外连接特性的一处错误配置，导致严重的安全风险。未经身份验证的攻击者可以利用这一漏洞，通过本地或远程连接Samba服务器，从而下载整个路由器文件系统。如图20和21所示，在这种共享服务（称为存储）中，能够允许路由器文件系统创建符号链接（symbolic
links），并下载其中内容。
图20
图21
攻击者因此可以自由查看和下载路由器的整个文件系统，包括密码和配置文件等。使用put和mput内置命令上传修改文件或新文件到路由器同样可行。许多型号路由器均支持Twonky
Media
Server服务，若存在配置错误，将允许外部攻击者操纵连接到路由器的USB存储设备，从而在不需要任何登录过程的情况下，执行包括下载，修改，删除和上传文件在内的操作。为了做到这一点，攻击者只需要根据9000端口来访问路由器IP就能完成，如图22所示。
图22
**3.8 UPnP协议（通用即插即用协议）**
多数路由器型号均默认采用UPnP协议。这一协议旨在为不同家用设备之间的连接提供便利。举个例子，UPnP协议可以允许计算机应用程序更改网络配置，比如打开端口，以便在用户不进行干预的情况下增强性能。
由于在进行配置更改时缺乏认证环节，UPnP协议其实极其不安全。不仅如此，路由器厂商的实现手段通常也十分糟糕，这无形中为攻击者提供了许多可用攻击手段，包括为远程WAN主机打开重要端口，终止任何WAN连接，以及执行命令盲注攻击（Blind
Command
Injection）等等。为了在本地利用UPnP协议漏洞，我们强烈建议使用一款名为Miranda的客户端工具。首先，我们将组播传输SSDP协议的PDU，目的是确定网络中支持的设备，如图23所示。
图23
家用路由器通常会支持多项UPnP协议操作，但从攻击者的角度来看，“添加端口映射”（AddPortMapping）和“强制终止”（ForceTermination）是最为实用的。图24中显示了这些可用选项。
图24
由于该协议的实现并不理想，且NewInternalClient参数未得到准确检查，使未经身份验证的攻击者能够打开连接远程WAN主机的端口，如图25所示。
图25
一旦受攻击者访问包含恶意SWF文件的特定网站，就能实现UPnP协议漏洞远程利用。这个Flash文件正悄然执行着“添加端口映射”操作（或任何UPnP协议支持的选项），并在后台更改防火墙设置。由此，在重要端口对WAN主机开放的情况下，远程攻击者将能对本地相关安全漏洞进行利用。图26是该攻击的图解说明。
图26
**4、工具**
****
通过研究，我们制作了多种漏洞利用工具。
（1） **SendDHCPRequest** 。可以向网络中的任一DHCP服务器发送带有自定义参数的恶意DHCP 协议请求
PDU。该工具可用于未授权XSS攻击。
图27
（2） **ChangeHostname** 。改变计算机主机名的简单脚本。该工具可用于未授权XSS攻击。
图28
（3） **SMBExploit** 。该工具将在目标的共享服务中创建一个符号链接。如果路由器存在漏洞，将可以被下载整个文件系统。其主要可用于SMB
Symlink攻击。
图29
此外，这些被发现的漏洞将添加到 **RouterPwn** 项目，用户和研究人员可以因此更为方便地检查设备存在的漏洞。
**5、审计报告**
****
我们目前已经发现超过60个此前未经公开的安全漏洞，影响了22种不同型号的SOHO路由器。大多数路由器在西班牙都非常受欢迎，而互联网服务提供商愿意将这些产品推销给客户。
**Amper，Astoria，Belkin，Comtrend，D-Link，华为，Linksys，Netgear，Observa
Telecom，Sagemcom和Zyxe** l等厂商的路由器设备都存在多重安全漏洞，如图30所示。
图30
图31按类型展示了漏洞分布情况。
图31
表1和表2展示了一份包含所有漏洞，以及受影响路由器型号的综合列表。
表1
表2
所有被发现的漏洞都已上报设备厂商和网络服务供应商，方便他们能够尽快解决问题；以及建立多个漏洞数据库，如MITR（CVE-ID）或OSVDB。在向厂商提供足够的时间后，我们披露了这些漏洞。
**6、结论**
****
迄今取得的成果表明，绝大多数SOHO路由器都受到了严重的安全漏洞影响，其中一些非常严重，很容易遭到网络犯罪分子利用，使终端用户和小型企业陷入安全威胁当中。我们能够得出结论，路由器的安全性在过去几年内其实并未得到改善。事实上，这些不断涌现的新型安全漏洞和攻击性载体，反而丰富了攻击者的“武器库”。
设备厂商和互联网服务供应商应该共同努力，以解决目前影响SOHO路由器的庞大的安全问题。在漏洞分析过程的基础上，我们开发了多种漏洞利用工具以及一种审计方法，目的是为研究人员未来的工作提供便利。