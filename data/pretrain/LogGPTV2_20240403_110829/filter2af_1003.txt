# 第四部分：USB设备研究——首次插入时的测试环境及注册表变化

## 译文声明
本文为翻译文章，原文来源：360安全播报。
原文地址：[链接]
译文仅供参考，具体内容以原文为准。

在前几篇文章中，我概述了研究目标，并介绍了三个主要的USB传输协议：MSC（大容量存储类）、PTP（图片传输协议）和MTP（媒体传输协议），以及每个协议的基本信息。接着，我探讨了Windows系统如何根据新插入的USB设备选择相应的驱动程序。在本篇及后续的文章中，我将分享我的研究发现，包括测试环境、所用工具以及注册表项在USB设备首次插入时的变化情况。特别是，我将重点讨论不同传输协议对注册表的影响。

### 1. 测试环境
表1.1.1列出了用于辅助测试的详细环境设置。所有测试均在虚拟化软件VMware Workstation上进行。在每次测试开始前，会先捕获基准报告，随后执行测试操作，最后记录操作系统的变化并生成最终报告。相关文件会被复制和归档。数据收集完成后，虚拟机将恢复到一个干净的状态快照，以确保未来测试的一致性。

#### 1.1 额外考虑因素
由于虚拟机软件的限制，我们无法直接测试USB 3.0设备；即使在测试过程中使用了USB 3.0设备，它们也会被自动降级为USB 2.0标准。此外，针对MTP和PTP设备的测试仅涵盖了有限数量和类型的样本，因此对于未测试的其他类型设备的支持情况可能存在不确定性。

**表1.1.1 测试环境概览：USB传输协议识别与研究**

### 2. 测试一：首次插入设备对注册表的影响
该实验旨在探索Windows系统是如何识别并安装USB设备的。具体方法是观察当设备首次连接至系统时，注册表发生的变动。基于先前假设，即Windows主要依据设备采用的传输协议来决定其驱动程序的选择与安装过程。我们的目标是验证这种选择是否具有一致性，或者是否存在因MSC、PTP、MTP这三种协议而异的行为模式，并据此判断Windows是否还会参考其他信息来进行设备安装。

#### 2.1 方案一：Windows XP SP3下的比较
表2.1.1展示了在Windows XP Service Pack 3环境下，不同协议间首次插入设备时注册表条目及其值的变化对比。从测试结果来看，Windows XP确实按照传输协议的不同来处理设备安装流程。通过分析这些数据可以明显看出三者之间存在显著差异。

您可以下载以下注册表文件以供进一步研究：
- [XP_1-toshiba_canvio_1tb_usb30.zip](http://nicoleibrahim.com/wp-content/uploads/2013/12/XP_1-toshiba_canvio_1tb_usb30.zip)
- [XP_2-seagate_bkplus_3tb_usb20.zip](http://nicoleibrahim.com/wp-content/uploads/2013/12/XP_2-seagate_bkplus_3tb_usb20.zip)
- ... (更多链接)

**值得注意之处：**
- 除了三个通用注册表项外，其余项均特定于某一协议。
- 由于各协议间的共通点较少，取证软件可能难以全面覆盖所有已绑定至系统的USB设备信息，在正式调查中需由分析师手动解析注册表内容。
- 对于PTP和MTP设备而言，首次插入不会导致NTUSER.DAT文件发生变化，从而增加了确定用户身份的难度。然而，一旦用户开始使用这些设备，系统就会创建与其相关的特定数据记录。

**表2.1.1 Windows XP: 不同协议下USB设备首次插入时注册表变更对比**

#### 2.2 方案二：Windows 7 SP1下的比较
表2.2.1则提供了Windows 7 Service Pack 1条件下，各种协议首次接入设备后注册表条目与值变化情况的对比分析。同样地，您也可以下载相应注册表文件以便深入研究。

**特别注意：**
- Windows 7似乎基于两种主要因素来决定是否通过WPD支持安装某设备。
- PTP和MTP设备在首次插入时也不会在NTUSER.DAT中留下痕迹，除非该设备支持Device Stage功能。
- 自Windows 7起引入了一种名为“Device Stage”的特性，某些USB设备实现了这一功能，使得安装过程中会产生对取证至关重要的痕迹信息。

**表2.2.1 Windows 7: 各协议支持设备首次插入时注册表变更对比**

完整表格可从[这里](http://nicoleibrahim.com/wp-content/uploads/2013/12/USB_Research-USBFirstInsertChanges.xls)下载获取。

接下来的文章将探讨Windows 7中关于遍历MSC设备的测试内容，以及两种不同协议设备bagMRU shell注册表键的比较。

### 资源链接
- [第一部分：USB设备研究——简介](http://bobao.360.cn/news/detail/2508.html)
- [第二部分：USB设备研究——MSC与PTP/MTP](http://bobao.360.cn/learning/detail/2511.html)
- [第三部分：USB设备研究——Windows中的USB设备枚举](http://bobao.360.cn/learning/detail/2526.html)