**Author: LoRexxar'@Knownsec 404 Team**  
**Date: December 7, 2018**  
**Chinese Version:**
On December 3, 2018, @L3mOn disclosed a front-end SSRF in Discuz x3.4. By
using a secondary jump and two parsing problems, the SSRF attack chain can be
cleverly completed.
In the process of recurrence with my partner @dawu, it is found that the
vulnerability itself relies on multiple features, resulting in a variety of
reductions in the exploitative environment and strong dependencies on some of
the conditions, which greatly reduces the harm of the vulnerability. Let's
analyze this vulnerability in detail.
# The Conditions of Vulnerability
  * The version ＜ 41eb5bb0a3a716f84b0ce4e4feb41e6f25a980a3 ([The patch link](https://gitee.com/ComsenzDiscuz/DiscuzX/commit/41eb5bb0a3a716f84b0ce4e4feb41e6f25a980a3 "The patch link"))
  * PHP version ＞ PHP 5.3
  * php-curl 
    http://127.0.0.1/{可控}
But this is actually useless, so we still need an arbitrary url to jump,
otherwise it makes little sense if it can only attack the local.
# URL Redirector Abuse
In order to be able to interact with the previous requirements, we need an
arbitrary url jump which is the "get" type and does not require login.
Dz will get the value from the referer parameter (not the header parameter)
when in the logout, and then enter the 301 to jump, and the only requirement
here is to have some verification on the host, let’s look at the code.
`/source/function/function_core.php:1498`
![
](https://images.seebug.org/content/images/2018/12/c7ea9b3f-6482-4ec4-b9f8-c8b611203b6a.png-w331s)
The screenshot above explains the main problem with this code, and the core
code is framed in red.
In order for the referer not to change, we must make the host only have one
character, but obviously, if the host can only have one character, we can't
control arbitrary url jump.
So we need to find a way to get `parse_url` and `curl` to parse at odds with
the target of the same url in order to possibly achieve our goal.
    http://localhost#@www.baidu.com/
`parse_url` parses the above link as `localhost`, and the curl is explained as
`www.baidu.com`.
Let’s capture a packet to take a view:
![
](https://images.seebug.org/content/images/2018/12/4d8c35de-112d-4a9b-9782-6f336339ed70.png-w331s)
We successfully bypassed various limitations.
# Exploits
Now that we have mastered SSRF and arbitrary url jump, we just need to link up
the attack chain. The attack process is as follows:
    cutimg ssrf link
    =====>
    The server accesses url redirector abuse at the logout
    ====301====>
    Jump to the malicious server
    =====302=====>
    Arbitrary target, such as gophar, http, etc.
Of course, when you first access the cutimg page, you need to get the forghash
first, and the referer should be modified accordingly, otherwise it will be
intercepted directly.
Exp demo
![
](https://images.seebug.org/content/images/2018/12/756f8a53-db10-4bc3-a94f-508d1b90d636.png-w331s)
# About Knownsec & 404 Team
Beijing Knownsec Information Technology Co., Ltd. was established by a group
of high-profile international security experts. It has over a hundred frontier
security talents nationwide as the core security research team to provide
long-term internationally advanced network security solutions for the
government and enterprises.
Knownsec's specialties include network attack and defense integrated
technologies and product R&D under new situations. It provides visualization
solutions that meet the world-class security technology standards and enhances
the security monitoring, alarm and defense abilities of customer networks with
its industry-leading capabilities in cloud computing and big data processing.
The company's technical strength is strongly recognized by the State Ministry
of Public Security, the Central Government Procurement Center, the Ministry of
Industry and Information Technology (MIIT), China National Vulnerability
Database of Information Security (CNNVD), the Central Bank, the Hong Kong
Jockey Club, Microsoft, Zhejiang Satellite TV and other well-known clients.
404 Team, the core security team of Knownsec, is dedicated to the research of
security vulnerability and offensive and defensive technology in the fields of
Web, IoT, industrial control, blockchain, etc. 404 team has submitted
vulnerability research to many well-known vendors such as Microsoft, Apple,
Adobe, Tencent, Alibaba, Baidu, etc. And has received a high reputation in the
industry.
The most well-known sharing of Knownsec 404 Team includes: [KCon Hacking
Conference](http://kcon.knownsec.com/#/ "KCon Hacking Conference"), [Seebug
Vulnerability Database](https://www.seebug.org/ "Seebug Vulnerability
Database") and [ZoomEye Cyberspace Search Engine](https://www.zoomeye.org/
"ZoomEye Cyberspace Search Engine").
* * *