运行分析平台建设
有了基线，就有了系统运行好坏的参考值，接下来要制定策略以定位什么是好，什么是
层进行分析。
收集耗时很长。
无法快速找到上个月的分析情况
易量少而导致的波动性问题就不在运行分析范围之内。
的趋势，需重点评估是否需要扩容。
看两者正负比率，
进行对比。
的运行情况。
多少判断是否存在某些时点出现了性能上升的问题，需要应用运维人员分析对应时点
CPU
按工作日、节假日区分，以每小时的数据计算一个平均值作为基线
，如出现当前运行点大部分均偏离基线上方，则整体运行性能有下降
O
且数据
图8-4运行基线技术方案
换页空间
数据采样
集中监控工具
容量分析
批量API接口
据基线
DB事务
婷
图8-5
性能分析
第8章应用系统运行分析199
数据模型
成功率
运行分析平台架构
可视化服务
数据采集
客户体验分析
批量任务
失败率
批量API接口
APM工具
业务量分析
数据库
---
## Page 216
8.2.3
将交易单笔平均耗时超过2秒的交易渠道发给开发团队，督促开发进行优化。
管理员进行分析，最终统一用分析数据反推开发中心进行优化，比如刚开始的按渠道分析，
行比较，通过偏离度与偏离数量判断运行的情况。在建设数据分析模块时，应采用如下几个
但是采用旁路抓包的方式实施落地更高效，而且在性能分析方面也能满足80%的需求。
交易处理情况、关联系统返回的情况等信息。也就是对这类系统进行改造所获得的数据，
系统的交易，并负责转发到关联系统，在总线类的应用中可以获得各渠道的交易处理时间、
开发部门没有很多推脱的理由。选择总线类的应用系统主要是因为这类系统接收了大量渠道
运行情况的数据，阻力会比较大，所以我们分成如下两个步骤进行：
虑由开发部门支持运维，将应用系统的运行数据主动输出成标准化的数据格式：
了更好地推广，
了为保障运维团队生产的决策提供数据支持外，还需要推广到IT管理团队及业务团队。为
或开发团队优化性能。
了第三个步骤就是抓运行毛刺，通过将毛刺出现的时间、性能表现集中展示出来，督促运维
式对数据做汇总分析，分析的模型可参考上面提到的基线比较的方式。
行数据比较的策略进行简化、原子化，并将原子化后的操作实现自动化，通过定期批量的方
步骤：
8.2.2
处理时间、成功率等数据，这些数据虽然不能像应用在开发阶段注入运行数据时那么精细，
以用来分析各渠道的整体运行情况，能起到事半功倍的作用。
200
，第一步是挑选节点总线类的应用系统进行改造，因为是挑选个别应用系统来进行改造，
（3）第三步是持续深化运行分析的深度与粒度，第二个步骤主要是整体的运行情况，
（2）第一步所述的手工分析的方法可行后，第二步就是将数据分析的数据采集范围、运
（1）手工分析数据，发现运行问题，并将分析到的运行问题反馈给应用管理员，由应用
第二步是我们发现基于网络旁路抓包的APM工具可以实现无须改造应用就能获得交易
上面已经提到如何在运维团队中推广运行分析工作的开展，这还不够，运行数据分析除
关于数据分析模块，就如上文提到的，建立运行基线，拿当前运行的数据与运行基线进
在实施过程中，我们发现由开发部门配合运维部门修改应用旁路，向运维输出有关应用
口着手重构LOG4J日志包，即将LOG4J的主函数进行重构，在应用按标准异步写人应
口与开发部门沟通，由开发部门提供标准化的数据运维流水表和运维流水日志，运维部
门在变更版本交付流程中进行标准化落地控制。：
推广
数据分析模块
码的修改，同时无须安装其他日志代理。
用日志文件时，格式化一份格式统一的运行日志文件，这个改造减少了开发对应用代
运维前线：一线运维专家的运维方法、技巧与实践
，需要强化数据分析结果的可视化效果，例如如下两个方面。
到
---
## Page 217
务较以往有所增长，希望知道问题的原因。这个过程就是根据业务的需求做减法与加法。
话务量、坐席菜单响应率是业务关注的几个重要指标，同时业务部门发现近期人工坐席的话
8.3.1确定分析方案
个应用系统涉及150个操作系统分区，如此多服务模块的运维管理必须进行前瞻性的运行分
音、多媒体等十几个子模块；坐席部分则主要包括坐席应用、运管、报表、网关等模块。整
中心系统的运行状态主要包括话务、坐席两部分，其中话务部分又包括网关、自助语音、
8.3呼叫中心系统运行分析示例
析才能提前发现问题，减少问题。
景的运行分析报告，在审核通过后，系统将通过邮件的方式将报告发送到用户邮箱中。
针对上述沟通情况，我们制定了如下分析方案。
，针对呼叫中心系统的运行分析情况，我们与业务部门进行了沟通，确认了客服满意度、
口根据分析的数据问题做进一步分析，并转化为后续优化计划的决策依据。
运行分析主要如下几点：
本节主要通过介绍呼叫中心系统的运行分析来回顾上面提到的运行分析技术方案。呼叫
（2）提供订阅式的报告推送方式：用户可以通过订阅的方式，查看不同的应用系统或场
口按交易码统计成功率：发现交易的成功率情况，以确认是否存在交易设计的问题或交
口IVR交易量情况分析：IVR交易量的分析主要是对交易量分布、交易最多的菜单进行
口IVR超时交易转人工分析：业务希望尽可能多的客户需求直接在IVR（自助语音系统）
（3）细化的交易级指标。创
口按交易码统计交易平均耗时：发现某几笔交易耗时异常的情况。
口按渠道统计交易平均耗时：发现是否涉及关联系统耗时过长的情况。
口交易平均耗时分析：交易平均耗时分析可以整体感知平台的处理能力概况。
（2）应用性能指标。变望
口WebSphere中间件分析：分析中间件连接数、GC回收等维度的数据建议。
口数据库性能分析：分析高峰期数据库索引、锁、大数据表等维度的数据建议。
口系统资源分析：分析系统CPU、内存、IO的资源使用情况。
（1）资源类指标。
口根据业务需求增加个性化的业务分析方向。
口根据运维及业务的需求，对运行分析的服务器范围及交易分析指标做加法与减法。
（1）权限：控制不同的机构、不同的用户查看不同的运行情况分析报告。
分析，通过对交易最多的菜单进行优化将会最快地提高效率。
中完成交易，如IVR 交易超时过多，将导致客服人力不足、系统等一系列影响。
第8章应用系统运行分析201
---
## Page 218
建议。
关联查询数据，效率低下，因此影响了整体的性能。
表，业务人员往往会在次日上班9时后进行查询。由于该功能需要在多张上亿条数据的表中
而带来一些业务功能，这些业务功能主要在上午9时至11时发生交易。
时至11时是否有一些特别的交易导致整体超时的问题，重点评估24日晚是否有因生产变更
结论是：业务部门需要先应急扩大9时至11时的坐席人员数量，技术方面需要进一步分析9
出现了IVR交易超时情况，这些超时交易全部转到人工坐席，人工坐席出现爆线情况。初步
的情况如下。
8.3.2
202运维前线：一线运维专家的运维方法、技巧与实践
。所以运维人员针对IVR人工话务量增多方面的分析结论附上问题原因之后，提出了如下
。在分析过程中，以业务部门需要分析的关于近期人工话务量增长较多的情况为例，分析
口建议运维人员对IVR 超时交易进行交易级监控配置，
口因该查询功能是T-1日数据，建议开发团队将该功能设置在凌晨批次生产报表，减少
（1）近期工作建议：
经过分析最终发现了问题的原因，24日晚投产了一个查询前一日客服处理情况的实时报
从以上三个分析点可以看出：在话务量未明显增长的情况下，IVR在上午9时至11时
口客服满意度分析中排队返回主菜单数、坐席待机率指标均有变差，问题同样集中在9
口交易整体耗时方面，从本月25日开始，每笔交易的平均耗时由原来的150毫秒上升
口本月下旬25日开始每天均出现IVR超时的情况，IVR 超时情况集中出现在上午9时
口近一个月话务量的分布有如下特点：星期五的话务量相比其他几天增长了20%，本月
口话务平台录音丢失专项分析：分析录音丢失的情况。
口重复来电情况分析：发现是否有恶意来电攻击的情况。
口话务量情况分析：分析话务量在一个月内的分布情况，发现话务量高峰期的特点，
口呼叫中心客服满意度分析：从业务最关心的客服满意度指标进行分析，包括总进线量
（4）业务指标：业务指标个性化较强，主要以人工分析为主。
在业务高峰期进行统计类的查询业务。
时到11时，存在坐席不足爆线的情况。
到250毫秒（500毫秒将对客户体验产生明显影响）。
到11时。
的话务量相比上月话务量有明显增长的趋势。！
问题分析案例介绍
协助业务人员安排座席人员班次的人数。
均通话时长、话后处理时长、平均整体时长、坐席待机率几个指标。
总接通数、接通率、人工转接数、排队返回主菜单、20秒水平、平均应急速度、平
易异常的情况。
当IVR出现交易超时时提供监
以
---
## Page 219
行数据关联分析，挖掘影响业务开展的功能设计或应用性能因素，促进业务开展。
的方向发展，为监控自动化工具提供预测性的事件预警等，完善运维自动化体系的建设。
运行。
提供容量决策支持，反推开发团队优化应用性能，推动应用架构改造，进一步保障系统稳定
变，由局部到整体进行把控，由被动应急向主动出击进行转变。
8.4小结
建时（3）通过大数据技术的引人，提高运行分析效率，将运行分析由T+N向T日实时分析
（4）提高应用运行分析的深度，将运行数据与业务运营活动的开展、客户体验等方面进
（2）为应用系统的资源、性能运行情况建立一个运行基线（优、正常、差），为系统管理
（1）通过应用运行分析的开展，全面转变运维人员的工作思维，由操作向分析进行转
上述应用运行方案仍在实施中不断进行完善，后续主要的优化方向是：
口建议对报表类交易设计降级开关，当实时交易发生异常时，要能够快速暂停报表类
口建议对数据库中的数据实现读写分离，优先考虑增加一个复制库，在业务空闲期间定
口建议将查询报表类的数据库进行配套的拆分。
口建议将查询报表类的模块单独拆分为独立的应用服务。
（2）中期工作建议：
口建议业务人员对爆线情况进行现场监督，及时调配好班次人员。
口建议对生产实时表数据过亿的表格进行历史数据迁移，以保持实时表的高效。
交易。
离中间件。
时生成批量报表，对于需要实时查询的数据采用读取复制库的方式；同时研究读写分
控报警。
第8章应用系统运行分析203
---
## Page 220
数直接相关，所以改善启动风暴大多是从这些相关方面直接入手。
（扫描风暴）等。
影响，甚至假死。类似于启动风暴对存储IO会造成压力的场景还有登录风暴、杀毒风暴
果启动时服务器的CPU能力或存储能力未能满足其需要，那么就会对全部桌面的启动造成
为“启动风暴”。在私有桌面云中，尤其是教学环境中，会定时定量集中启动一批桌面，如
本章的介绍，读者在解决此类问题时能够尝试从不同的角度进行思考。
桌面云启动风暴进行调优，然后在本章末尾处会介绍类似于杀毒风暴的解决办法，希望通过
都会遇到此类问题。本章将以oVirt为基础平台介绍其平台存储配置，并针对这种配置下的
计与实施。
统与设备（ARM架构），分布式存储（GlusterFS)。多次参与银行与教育领域的私有云架构设
化产品应用（云桌面、云服务器），云平台架构与相关开发（自主产品与开源软件），嵌入式系
主要包括OpenStack、oVirt的虚拟化、网络、存储组件及其在桌面云领域的应用。涉及虚拟
长
启动风暴的发生条件并不确定，因为它与服务器的CPU、存储、系统配置及虚拟机的参
，当同时启动的虚拟机达到一定数量时，就会对服务器造成极大的压力，这种情况一般称
-在启动虚拟桌面时，虚拟机系统内部会产生远高于正常运行状态时的CPU负载与I/O请
以我个人的经验和客户反馈的情况来说，其中存储的改变对启动风暴的影响是最大的，
启动风暴是私有云桌面中经常会遇到的问题，不管是开源平台还是闭源平台，或多或少
蒋迪，上海沃帆信息科技有限公司资深虚拟化基础架构工程师，从事云平台研发工作，
作者简介
第9章
虚拟化中存储配置典型场景：启动风暴
---
## Page 221
的某个主机上，而且根据集群状态可以动态迁移至其他主机，限于篇幅，本章在此将不展开
式的硬盘上。
分在模板硬盘上进行，所以在传统机械硬盘上多个实例的并发启动风暴更容易发生在此种格
backing file方法创建的，基于backing file创建的硬盘不能是raw 格式，命令如下：
建时需要消耗一定的时间，不能满足秒级创建的需求。
的扇区位置，所以在读写操作时受机械硬盘磁头引起的小区域并发问题影响较小，缺点是创
convert。通过上述方式创建的实例，其硬盘与模板硬盘相对独立，在服务器存储上拥有各自
例即依赖模板创建的虚拟机，是具有运行生命周期的虚拟机的通称。
分虚拟机中的模板与实例，本章默认模板即原始虚拟机，所有新实例的创建都依赖于它；实
比较清晰的模板和实例概念，同时也有模板与实例镜像存储位置相关的存储域配置。为了区
9.1.1.
硬盘的创建方式与所在的存储位置，以便基于此进行优化。
9.1
者有所帮助。
迁移的情况。
分层存储的方法处理之，然后在现有方法的基础上提出一些较为常用的改进措施，希望对读
而针对存储的优化则可以从最基本的存储性能及其存储结构方面进行调整。
（2）增量，即新建的虚拟机只复制模板配置信息，但其硬盘文件是通过qemu-img 的
本章将尝试模拟桌面云的一般场景，启动相当数量的虚拟机来重现启动风暴，尝试使用
如此创建的硬盘对模板硬盘的依赖较大，非增量文件的读操作（比如启动系统）绝大部
（1）克隆，即完整克隆模板配置与硬盘，硬盘的创建方式一般为cp或qemu-img
比较成熟的开源虚拟化或云计算平台包括OpenStack、CloudStack 和oVirt 等，它们都有
1.硬盘分配方式
在开始存储结构优化的实验之前，我们先来了解一下云平台的一般存储配置，包括实例
口集群的CPU类型（Family）集群负载状态。
我们在实现调度策略的时候应主要考量如下几点：
从图9-1中我们可以看到，一个实例在真正启动之前会根据一定的策略被安排到某集群
实例的启动在虚拟化平台中的一般调度如图9-1所示。
2.集群调度策略
[root@localhost ~]# qemu-img create -b hda.qcow2 -f qcow2 hda-new.qcow2
在这些平台中，一般有两种新建实例的方式：克隆与增量。·
oVirt虚拟化平台配置介绍
存储配置背景知识
第9章虚拟化中存储配置典型场景：启动风暴205
---
## Page 222
表了一个对象，lease 文件、metadata分别为文件锁和元数据：
板硬盘的 hardink 作为实例硬盘的 backing file 来创建增量硬盘，或者直接复制模板硬盘。
9.1.2
206
在oVirt 的数据存储域中我们可以看到如下代码段中的目录结构，其中每个UUID 都代
当模板与实例存储在同一文件系统中时，我们创建虚拟机的常用方法有两种一
4440c3f9-ba1f-4803-86ac-d59c694c61c1/
[root@localhost~]#tree data/
口主机CPU用度、网络用度、内存用度、存储I/O用度，以及它们超过一定阈值的
口主机中运行的虚拟机数量、主机历史健康度。
模板与实例同一存储
时间。
运维前线：一线运维专家的运维方法、技巧与实践
dom_md
images
d25c4d22-15c1-4f3c-8aef-2ed74deb4723
outbox
d6a7e74d-76fc-48c6-b3c6-3c506b98e73e
metadata
leases
inbox
ids
-2bf1ba4c-3fb5-4e25-9368-cc96724b1a63.meta
81031024-5942-4086-901b-f991777ff32a
2bf1ba4c-3fb5-4e25-9368-cc96724b1a63.1ease
2bf1ba4c-3fb5-4e25-9368-cc96724b1a63
2bf1ba4c-3fb5-4e25-9368-cc96724b1a63.1ease
2bf1ba4c-3fb5-4e25-9368-cc96724b1a63
2bf1ba4c-3fb5-4e25-9368-cc96724b1a63.meta
Schedule