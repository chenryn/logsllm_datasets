As cards are swiped on monitored processes, it creates process memory 
dump file in “memdump” folder and then calls a process called 
“dnsmgr.exe” which parses track data from dump files to an ASCII file 
“dirmon.chm” 
Sample B – Data Exfiltration 
• 
The attacker’s created RAR archives created with WinRar and password 
protected them. 
− 
We obtained the passwords for these RAR files by searching RAM 
dumps from the compromised systems and parsing for interesting 
strings 
− 
Found “!SYSTEMNAME#623!” and it worked!  
• 
Data exported via over SSL to a host in South Korea (211.232.XXX.X). 
• 
Estimated that 350,000 (or more) credit cards were exported during the 
time the attackers were on the systems. This is based upon the 
contents of the RAR files.   
Sample B – Propagation 
• 
The attackers made connection using RDP to 35 other hotel 
locations via the corporate WAN.  
• 
We visited many of the other locations and found the exact 
same sets of tools and large quantities of RAR files containing 
credit card data.  
Sample B – Live Demo 
WINMGMT.EXE 
Sample B – Add’l Comments 
Why isn’t this malware caught? 
• 
Anti-Virus can’t catch this 
−  They only know what they know.  
• 
Lack of Log Review 
• 
No checks for storage of prohibited data; often a sign that 
someone is on the system doing something they shouldn’t be 
• 
Thanks to the IT Talent 
−  On few of these cases, IT simply searched Google for the 
malware name. Needless to say the results.  
Sample C: 
Video Poker in Lake Tahoe 
Note: This portion of the talk is based on actual cases we 
investigated where the use of “credentialed” malware was 
found.  This portion of the presentation does not discuss or 
infer that any specific Video Poker system is vulnerable to this 
attack method. 
Sample C – What is Credentialed Malware? 
B 
Credentialed Malware: 
•   A program that is specifically design to exploit functions of the target 
application that are not typically available to the normal end user. 
•   Access to the malware’s functions are control by the developer using 
various forms of  “authentication” tokens.  
•   Authentication Tokens could be sold or rented to criminals looking 
to illegally obtain what ever the target application is in the business of 
providing.  
Sample C - Architecture 
A – Video Poker Machine 
B – Voucher Reader / Printer 
C – Casino Network 
D – The Casino 
D 
C 
A 
B 
Sample C – Common Problems 
• 
Due to the number of machines and maintenance required, 
machines are constantly being worked on. 
• 
Does the “Eye in the Sky” monitor repair personnel?  
• 
Unique passwords are difficult to manage.  
• 
Do you need to run AV on Video Poker machines? 
• 
Under the hardened case they are low end PCs and may have 
USB ports, etc.  
• 
What OS are they running? How often are they patched? 
Sample C – Installation Vector 
Possible scenario: 
• 
Attacker, dressed like casino repair staff, with a key walks up to 
the Video Poker Machine. 
• 
They login using a default/common password (i.e. all Casino’s 
machines have the same password) 
• 
The Attacker inserts a USB key with the Malware on it 
• 
The Attacker copies the dropper over to the local file system 
• 
The Attacker executes the dropper file, removes the USB key, 
and locks up the machine 
Another scenario: 
• 
The malware is installed at the manufacture as a “backdoor” 
• 
It is active on every single Video Poker machine deployed… 
Sample C – Analysis 
VIDEOPOKER.EXE 
• 
While the malware is active it parsing for valid Vouchers, it 
is also looking for a User Voucher: 
−  Single Function – activates a single function 
execution 
−  Multi-Function – activates the malware interface 
window 
• 
A User Voucher is identified by passing the value of the 
Voucher through a hashing algorithm and comparing the 
results to set values stored in the malware.  
• 
If the malware does NOT see a User Voucher, it does 
nothing and passes the information over to the Video 
Poker software for adding credits to the game.  
Sample C – Analysis 
VIDEOPOKER.EXE 
Key 
Value 
Function 
Description 
Hold (1) Uninstall 
Deletes the malware service, puts the system logs back where 
they were before the malware was installed.  
Hold (2) Display Stats 
Presents information on the number of  User Vouchers uses 
(function 3 and 4) and malware version running on the 
machine.  
Hold (3) Odds Shift 
Modifies the odds on the machine by increasing the face cards 
in ‘deck’.  
Hold (4) Modify Credits Prompts ‘user’ to enter value of credits (using 1,2,3,4,5 Hold 
keys), adds the value to the current game, and then can be 
cashed out.  
Deal 
Test Printer 
Prints ‘hello world’ to the voucher printer. 
Max Bet Exit 
Exits the malware and returns to normal game play. Also, used 
to enter a value to get to a sub-function.  
Sample C – Propagation 
• 
If the Video Poker machine is connected to the Casino 
network (and likely will be) a services based vulnerability 
would be needed.  
• 
The attackers could check for successful propagation by 
walking up to random machines. Inserting a User Voucher that 
will either result in it being rejected or the activation of the 
Malware.   
Sample C – Live Demo 
VIDEOPOKER.EXE 
Sample D: 
Restaurant in Michigan 
Firewall /Linksys 
Router (Allowing 
VNC – Port 5900) 
Back of House 
Server 
(No Egress filtering) 
Sample  A - Architecture 
POS Terminals  
(Internet Access 
Permitted) 
Sample  D – Problems 
• 
VNC allowed from Internet to Restaurant POS Server 
• 
 Weak / Common passwords 
– 
 E.g. Admin: support 
• 
POS Terminals were not running Anti Virus software 
• 
Unrestricted Internet Access was allowed from all systems 
including POS Terminals 
• 
POS Integrator used same passwords for all restaurants in 
the region 
Sample  D – Tools Found 
Name 
Size 
MD5 Hash 
Description 
HOST32EDU.EXE 
68KB 
17c83eba9a436edbeb74a42a51b9087a  IRC Bot / Backdoor 
X.BAT 
2KB 
N/A 
Malware loader  
*contents of file found in Unallocated Clusters 
REPZ.EXE 
65KB 
6c9e01933aa88894f476d690666dc403  IRC Bot / Backdoor 
PACKETSNIFFER.EXE 
57KB 
10e5a2813d51c547346173290a0ae53b  Packet Sniffer 
Sample  D – Installation Vector 
• 
Entry via VNC on POS Server 
– 
VNC password was “support” 
• 
Downloaded malware files 
– 
IRC Bot  
– 
X.bat (Malware loader) 
– 
Custom Packet Sniffer 
• 
Malware kills all security software in Windows 
• 
Microsoft .Net framework version 2.0 was downloaded as Packet Sniffer was 
written in .Net and needs the framework to run properly. 
• 
IRC Bot downloads the configuration (tcp ports, output file location, etc.) for 
the system based on POS software installed 
• 
Sniffed files are placed in C:\Export folder and then uploaded to FTP server.  
Sample D – Dynamic Analysis 
PACKETSNIFFER.EXE 
• 
Installed in C:\Windows\Temp folder of the system 
• 
Uses Microsoft .Net Framework v2.0 to run properly 
• 
Uses a configuration file, which is created based on POS software 
• 
Sniffs TCP traffic on ports 5101,5010,5011,5100 
• 
Stores the sniffed output in C:\Export folder 
• 
Filenames are .SEND.cap and .READ.cap  
• 
Data is uploaded to an IP based in Munich, Germany 
Sample D – Live Demo 
PACKETSNIFFER.EXE 
Sample  D – Add’l Comments 
•  The destination FTP server for sniffed output files 
contained several other folders; all of which had 
sniffer output files.    
•  Upon analysis of FTP server, it was concluded that 9 
other restaurants were affected by the same sniffer 
and they were all sending the data regularly to the 
FTP server 
•  6 of the restaurants were all are based in Michigan; 
all restaurants are serviced by same POS Integrator. 
Conclusions 
•  Malware is dominating 
•  Computer Memory is the target to extract sensitive data 
•  Companies are still not getting segmentation, passwords, 
firewalls right!! Easy Entry.  
•  Attackers are taking the time to learn, even obscure business 
applications before creating targeted Malware.  
•  Once Malware use has proved successful, similar businesses and  
  environments are targeted quickly.   
Tools We Like 
Name 
URL 
Description 
Dependency Walker h"p://www.dependencywalker.com 
Lists the imported and exported func;ons of an 
executable ﬁle 
Encase 
h"p://www.guidanceso?ware.com 
Forensic Analysis and Case Management 
FastDumpPro 
h"p://www.hbgary.com/products‐services/
fastdump‐pro 
Memory Acquisi;on Tool 
FTK Imager Lite 
h"p://www.accessdata.com/ 
Acquires Windows Images Live 
GMER 
h"p://www.gmer.net 
Detect hidden processes and rootkits 
Hex Workshop 
h"p://www.hexworkshop.com 
Analyze, edit, cut, copy, paste, insert, ﬁll and delete 
binary data 
IDA Pro 
h"p://www.hex‐rays.com/idapro 
Disassembler and Debugger 
NMAP 
h"p://www.nmap.org 
Network Port Scanner 
Process Monitor 
h"p://technet.microso?.com/en‐us/sysinternals/
bb896645.aspx 
Tracks ﬁle, registry and network ac;vity of a given 
process 
RegRipper 
h"p://regripper.net 
Registry Analysis 
Regshot 
h"p://sourceforge.net/projects/regshot 
Acquires and Compares registry snapshot 
Sigcheck 
h"p://technet.microso?.com/en‐us/sysinternals/
bb897441.aspx 
Checks for Digital Signatures of ﬁles on system 
VolaFlity 
h"ps://www.vola;lesystems.com/default/vola;lity 
Memory Analysis 
Win32dd 
h"p://win32dd.msuiche.net  
Memory Acquisi;on Tool 
Wireshark 
h"p://www.wireshark.org 
Network Protocol Analyzer 
Contacts: 
Nicholas J. Percoco  / @c7five 
Jibran Ilyas  
www.trustwave.com/spiderlabs/   @SpiderLabs 
Special Thanks:   
Adam, Stephen, Colin, Chris, Ferns, Brandon, and Nathan. 
Contact Us