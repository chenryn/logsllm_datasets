T-Bittorrent-2
Fingerprints
1 1 145 319, UDP
1 1 109 100, UDP
1 1 146 340, UDP
5 3 346 170, TCP
1 1 145 310, UDP
1 1 145.01 317.66, UDP
1 1 109 100, UDP
1 1 146 342, UDP
5 3 346 170, TCP
2 2 466 461, UDP
Trace
Skype
Fingerprints
1 1 74.58 60, UDP
1 1 78 60, UDP
1 1 75 60, UDP
1 1 76 60, UDP
1 1 79 60, UDP
Table IV: Summaries of Fingerprint Clusters
Ë†ğ‘‡ğ‘ƒ 2ğ‘ƒ =
active time (ğ‘‡ğ‘ƒ 2ğ‘ƒ ) of a P2P application as
max(ğ‘‡ (ğ¹ ğ¶1), ..ğ‘‡ (ğ¹ ğ¶ğ‘—), ..ğ‘‡ (ğ¹ ğ¶ğ‘˜)).
ğ‘– , .., ğ¹ ğ¶ ğ‘—
If the ratio ğ‘Ÿ(â„) = Ë†ğ‘‡ğ‘ƒ 2ğ‘ƒ
ğ‘‡ğ‘ ğ‘¦ğ‘ 
As illustrated in Table III, the estimated active time
> Î˜ğ‘ƒ 2ğ‘ƒ , we say that â„ is
running a persistent ğ‘ƒ 2ğ‘ƒ application, and add it to a set
P of candidate P2P bots. Host â„ will then be input to our
botnet detection algorithm (see Section III-D), where â„ will
be represented by a set of persistent ï¬ngerprint clusters for
â„, denoted as ğ¹ ğ¶ğ‘(â„) ={ğ¹ ğ¶ 1
ğ‘˜} where ğ‘‡ (ğ¹ ğ¶ğ‘–) >
Î˜ğ‘ƒ 2ğ‘ƒ for any ğ¹ ğ¶ğ‘– âˆˆ ğ¹ ğ¶ğ‘(â„).
Ë†ğ‘‡ğ‘ƒ 2ğ‘ƒ
is the same as the actual active time (ğ‘‡ğ‘ƒ 2ğ‘ƒ ) of the P2P
Ë†ğ‘‡ğ‘ƒ 2ğ‘ƒ can accurately
application, which demonstrates that
approximate ğ‘‡ğ‘ƒ 2ğ‘ƒ . As we can see from Table III, when we
leave a P2P application running for as long as the machine
is on (24 hours for this particular experiment) we obtain
a ratio ğ‘Ÿ(â„) = 1. Therefore, we decided to conservatively
set Î˜ğ‘ƒ 2ğ‘ƒ = 0.5. ğ‘ğ‘ğ‘™ğ‘¢ğ‘ ğ‘¡ in Table III illustrates the size of
ğ¹ ğ¶ğ‘(â„), the number of ï¬ngerprint clusters (ğ¹ ğ¶s) whose
ğµğºğ‘ƒ (ğ¹ ğ¶) > Î˜ğ‘ğ‘”ğ‘ and ğ‘‡ (ğ¹ ğ¶) > Î˜ğ‘2ğ‘.
D. P2P Botnet Detection Algorithm
Once we have identiï¬ed the set P of candidate P2P bots,
we apply our botnet detection algorithm. At this stage, our
objective is to differentiate between legitimate persistent P2P
clients and P2P bots. As we mentioned at the beginning of
Section III, our detection approach is based on the following
observations: i) bots that belong to the same botnet use
the same P2P protocol and network, and ii) the set of
peers contacted by two different bots have a large overlap,
compared to peers contacted by two P2P clients connected to
the same legitimate P2P network. Accordingly, we look for
P2P clients that are running the same protocol and connect
to the same P2P network, and whose sets of contacted des-
tination IPs overlap signiï¬cantly. We do so by introducing
a measure of similarity between the ï¬ngerprint clusters, and
then grouping P2P clients according to similarities between
their respective ï¬ngerprint clusters.
We proceed as follows. For each host â„ âˆˆ P, we
consider the set of persistent ï¬ngerprint clusters ğ¹ ğ¶ğ‘(â„) =
{ğ¹ ğ¶1, .., ğ¹ ğ¶ğ‘˜} (see Section III-B). For each ğ¹ ğ¶ğ‘– âˆˆ
ğ¹ ğ¶ğ‘(â„), we compute the average number of bytes sent,
ğµğ‘¦ğ‘¡ğ‘’ğ‘ ,ğ‘–, and received, ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ,ğ‘–, in all ï¬‚ows in ğ¹ ğ¶ğ‘– (remem-
ber that each ï¬ngerprint cluster ğ¹ ğ¶ğ‘– is a cluster of ï¬‚ows).
Also, for each cluster ğ¹ ğ¶ğ‘– we extract the set of peers Î ğ‘–, i.e.,
the set of all destination IPs for the ï¬‚ows in ğ¹ ğ¶ğ‘–. Therefore,
Authorized licensed use limited to: Tsinghua University. Downloaded on March 18,2021 at 14:47:04 UTC from IEEE Xplore.  Restrictions apply. 
126Fingerprints
1 1 145 319, UDP
1 1 109 100, UDP
outgoing content
d1:ad2:id20:. . . ï¬nd node1:. . . :y1:qe
d1:ad2:id20:. . . ï¬nd node1:. . . :y1:qe
d1:ad2:id20:. . . ï¬nd node1:. . . :y1:qe
d1:ad2:id20:. . . :ping1:. . . :y1:qe
d1:ad2:id20:. . . :ping1:. . . :y1:qe
d1:ad2:id20:. . . :ping1:. . . :y1:qe
ï¬‚ows
1
2
. . .
1
2
. . .
Table V: Payload of ï¬‚ows in a ï¬ngerprint cluster of Bittorrent
incoming content
d1:rd2:id20:. . . nodes208:. . . :y1:re
d1:rd2:id20:. . . nodes208:. . . :y1:re
d1:rd2:id20:. . . nodes208:. . . :y1:re
d1:rd2:id20:. . . :y1:re
d1:rd2:id20:. . . :y1:re
d1:rd2:id20:. . . :y1:re
description
peer discovery
ping/pong
each ï¬ngerprint cluster ğ¹ ğ¶ğ‘– can be summarized by the tuple
(ğµğ‘¦ğ‘¡ğ‘’ğ‘ ,ğ‘–, ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ,ğ‘–, Î ğ‘–). This allows us to deï¬ne a notion of
distance between ï¬ngerprint clusters. In practice, we deï¬ne
two separate distance functions as follows
i) ğ‘‘ğ‘ğ‘¦ğ‘¡ğ‘’ğ‘ (ğ¹ ğ¶ğ‘–, ğ¹ ğ¶ğ‘—) =
âˆš
(ğµğ‘¦ğ‘¡ğ‘’ğ‘ ,ğ‘– âˆ’ ğµğ‘¦ğ‘¡ğ‘’ğ‘ ,ğ‘—)2 + (ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ,ğ‘– âˆ’ ğµğ‘¦ğ‘¡ğ‘’ğ‘Ÿ,ğ‘—)2
ii) ğ‘‘ğ¼ğ‘ƒ ğ‘ (ğ¹ ğ¶ğ‘–, ğ¹ ğ¶ğ‘—) = 1 âˆ’ âˆ£Î ğ‘–âˆ©Î ğ‘—âˆ£
âˆ£Î ğ‘–âˆªÎ ğ‘—âˆ£
and then we deï¬ne the distance between two hosts â„ğ‘ and
â„ğ‘ as
ğ‘‘ğ‘–ğ‘ ğ‘¡(â„ğ‘, â„ğ‘) = min
ğ‘–,ğ‘—
(
ğ‘–
, ğ¹ ğ¶ (ğ‘)
ğœ† âˆ— ğ‘‘ğ‘ğ‘¦ğ‘¡ğ‘’ğ‘ (ğ¹ ğ¶ (ğ‘)
+ (1âˆ’ ğœ†) âˆ— ğ‘‘ğ¼ğ‘ƒ ğ‘ (ğ¹ ğ¶ (ğ‘)
ğ‘šğ‘ğ‘¥ğµ âˆ’ ğ‘šğ‘–ğ‘›ğµ
ğ‘–
ğ‘— ) âˆ’ ğ‘šğ‘–ğ‘›ğµ
)
, ğ¹ ğ¶ (ğ‘)
ğ‘— )
where
ğ‘–
ğ‘–
ğ‘˜
, ğ¹ ğ¶ (ğ‘)
ğ‘— )
, ğ¹ ğ¶ (ğ‘)
ğ‘— )
is the ğ‘˜-th ï¬ngerprint cluster of host â„ğ‘¥
âˆ™ ğ¹ ğ¶ (ğ‘¥)
âˆ™ ğ‘šğ‘–ğ‘›ğµ = minğ‘–,ğ‘— ğ‘‘ğ‘ğ‘¦ğ‘¡ğ‘’ğ‘ (ğ¹ ğ¶ (ğ‘)
âˆ™ ğ‘šğ‘ğ‘¥ğµ = maxğ‘–,ğ‘— ğ‘‘ğ‘ğ‘¦ğ‘¡ğ‘’ğ‘ (ğ¹ ğ¶ (ğ‘)
âˆ™ ğœ† is a predeï¬ned constants, which we set to ğœ† = 0.5.
After computing the distance between each pair of hosts
(i.e., each pair of candidate P2P bots in set P), we apply
hierarchical clustering, and group together hosts according to
the distance deï¬ned above. In practice, the hierarchical clus-
tering algorithm will produce a dendrogram (a tree-like data
structure) as shown in Figure 5. The dendrogram expresses
the â€œrelationshipâ€ between hosts. The closer two hosts are,
the lower level they are connected at in the dendrogram. Two
P2P bots in the same botnet should have small distance and
thus are connected at lower level (forming a dense cluster).
Even if these P2P botsâ€™ trafï¬c is overlapped with trafï¬c of
legitimate P2P applications, the distance between two bot-
compromised hosts is decided by the minimum distance of
their respective ï¬ngerprint clusters. Since the distances of
ï¬ngerprint clusters from botnet P2P protocols have smaller
distance compared to those from legitimate P2P protocols
(due to botsâ€™ large overlap of peer IPs),
the minimum
distance will stem from ï¬ngerprint clusters of P2P bots
instead of legitimate P2P applications. Therefore, two bot-
compromised hosts running legitimate P2P applications will
still exhibit small distance. We then classify hosts in dense
clusters as P2P bots, and discard all other clusters and the
related hosts, which we classify as legitimate P2P clients.
In practice, we cut the dendrogram at Î˜ğ‘ğ‘œğ‘¡ (Î˜ğ‘ğ‘œğ‘¡ âˆˆ [0, 1])
of the maximum dendrogram height (Î˜ğ‘ğ‘œğ‘¡ âˆ— â„ğ‘’ğ‘–ğ‘”â„ğ‘¡ğ‘šğ‘ğ‘¥).
To set Î˜ğ‘ğ‘œğ‘¡, we consider the following two assumptions:
a) we assume we do not have a labeled data set of botnet
trafï¬c; b) we assume that the distance between two legit-
imate P2P applications is much larger than that between
two bots belonging to the same botnet (as motivated above).
Therefore, we conservatively set Î˜ğ‘ğ‘œğ‘¡ = 0.95.
IV. EVALUATION
In this section we present an evaluation of the effective-
ness of our stealthy P2P botnet detection system.
A. Experimental Setup
We evaluated the performance of our detection system
using real-world network trafï¬c, including trafï¬c collected
from our academic network, trafï¬c generated by popular P2P
applications, and live P2P botnet trafï¬c.
The trafï¬c we collected from our academic network came
from a span port mirroring all trafï¬c crossing the gateway
router (around 200-300Mbps) for the college networks. We
used Argus [1] to efï¬ciently collect network ï¬‚ow infor-
mation of the trafï¬c between internal and external networks
for one entire day. Along with various ï¬‚ow statistics we also
recorded the ï¬rst 200 bytes of each ï¬‚ow payload, which we
used to identify known legitimate P2P clients within our
network. To reduce the volume and noise in our network
traces, we excluded all trafï¬c related to email servers, DNS
servers, and planetlab nodes from our botnet detection
analysis. The DNS trafï¬c was collected simultaneously with
the network ï¬‚ow information, using dnscap, to keep track
of all the domain-to-IP mappings needed to perform trafï¬c
volume reduction. Overall, we observed 953 active hosts, as
reported in Table VI. We refer to the trafï¬c collected from
our academic network as ğ‘ ğ¸ğ‘‡ğ¶ğ‘œğ¶.
In order to establish some ground truth in terms of what
hosts are running P2P applications, we used a signature-
based approach by matching the signatures from [11] onto
the ï¬rst 200 bytes of each network ï¬‚ow. We further manually
investigated each of these hosts to eliminate false positives
(we found some spurious signature matches deriving from
trafï¬c towards SMTP servers that we were not able to pre-
ï¬lter, and a few web requests towards our departmental
website). After manual validation, we identiï¬ed a total
of 3 hosts that were running Bittorrent , which in
the following we denoted as â€œBT1@Câ€, â€œBT2@Câ€ and
â€œBT3@Câ€. Furthermore, there exists no signature that can
match P2P trafï¬c generated by Skype, since Skype com-
munications are encrypted. However, using the statistical
trafï¬c ï¬ngerprints, we were able to identify 5 likely Skype
clients within our network (we discuss this in more detail in
Section IV-C1), denoted as â€œSkype1@Câ€, â€œSkype2@Câ€, ..,
Authorized licensed use limited to: Tsinghua University. Downloaded on March 18,2021 at 14:47:04 UTC from IEEE Xplore.  Restrictions apply. 
127Trace
t-c
Trace
t-dns
duration
24h
duration
24h
# of TCP / UDP ï¬‚ows
61,745,989 / 20,226,837
# of domains
328,965
# of clients
953
# of IPs
268,753
Table VI: Trafï¬c statistics for our academic network.
Trace
Bittorrent-1/2
Limewire-1/2
Emule-1/2
Skype-1/2
Ares-1/2
Dur
24 hr
24 hr
24 hr
24 hr
5 hr
# of ï¬‚ows
250960/297785
229215/638103
58941/110821
88927/49541
17566/21756
# of Dst IPs
17337/17657
11602/64994
6649/14554
10699/6264
1918/3118
Avg Flow Size
68310/350205
1003/2038
124267/22681
514/1988
69373/24755
Table VII: Traces of Popular P2P Applications
â€œSkype5@Câ€. We refer to the network traces corresponding
to these 8 P2P clients as ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ @ğ¶ğ‘œğ¶. One possible
reason why we found only a few (fewer than expected) P2P
hosts is that our college network is well-managed and the
usage of ï¬le sharing applications is highly discouraged. In
addition, the vast majority of the hosts we have monitored
are desktops managed by the college, where regular users
have no permission to install software including Skype.
In order to increase the number and diversity of P2P nodes
in our network, we ran 5 popular P2P applications, whose
name and version are listed in Table I. We ran each of
the 5 P2P applications in two different (virtual) hosts for
several hours (e.g., 24 or 5 hours) simultaneously. Each host
was represented by a WindowsXP (virtual) machine with a
public IP address selected within a /24 network. Given a
P2P application among the 5 we considered, we manually
interacted with one instance (on one host) to simulate
typical human-driven application usage behavior, and we
fed the second instance of the application (on the second
host) with automatically generated user-interface input. This
artiï¬cial user input was simulated using a AutoIt [2]
script that randomly selects contents to be downloaded or
uploaded using the P2P application at random time intervals.
Therefore, overall we obtained 10 additional network traces
related to trafï¬c generated by P2P applications (Table VII
shows some statistics related to these network traces). We
refer to these network traces as ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ .
In addition, we were able to obtain network traces for two
popular P2P botnets, Storm and Waledac. Both traces
were collected by purposely running Storm and Waledac
malware samples in a controlled environment, and record-
ing their network behavior. The Storm traces included
13 different bot-compromised hosts, while the Waledac
included 3 different bot-compromised hosts, as shown in
Table VIII. It is worth noting that both traces were collected
at a time when the two botnets were fully active, before
any successful takedown attempt was carried out by law
enforcement or network operators. We refer to these network
traces as ğ‘ ğ¸ğ‘‡ğ‘ğ‘œğ‘¡ğ‘ .
B. Experimental Design
We structured our experiments in ï¬ve parts:
1) Evaluate the effectiveness of identifying and proï¬ling
P2P applications using statistical ï¬ngerprint clusters.
Trace
Waledac
Storm
duration
24hr
24hr
size
1.1G
4.8G
# of bots
3
13
Table VIII: Traces of Botnets
(see Section IV-C1)
2) Evaluate the detection performance by pretending that
a number of machines in our network have been
compromised with either Storm or Waledac (Sec-
tion IV-C2).
3) Determine whether our system is able to detect P2P
bots running on compromised machines that are also
running legitimate P2P clients at the same time (Sec-
tion IV-C3).
4) Estimate the detection performance in special cases,
where only two bots or no bot (e.g., a â€œcleanâ€ network)
appear in the monitored networks (Section IV-C4).
5) Analyze the effect of system parameters ğ¶ğ‘›ğ‘¡ğ‘ğ‘–ğ‘Ÿğ‘â„ and
Î˜ğ‘ğ‘œğ‘¡ (Section IV-C5).
We prepared four data sets for evaluation, ğ·1, ğ·2, ğ·â€²
1
and ğ·â€²
2. We obtained ğ·1 as follows: For each host (denoted
as â„ğ‘2ğ‘) of both16 P2P bots (in ğ‘ ğ¸ğ‘‡ğ‘ğ‘œğ‘¡ğ‘ ) and 10 P2P
applications (in ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ ), we randomly selected one host
(denoted as â„ğ¶ğ‘œğ¶) from trace ğ‘ ğ¸ğ‘‡ğ¶ğ‘œğ¶, and we overlaid
â„ğ‘2ğ‘â€™s trafï¬c to the â„ğ¶ğ‘œğ¶â€™s trafï¬c. We aligned the start
time of the â„ğ¶ğ‘œğ¶â€™s trafï¬c according to the start time of
its corresponding â„ğ‘2ğ‘â€™s trafï¬c. If the duration of â„ğ¶ğ‘œğ¶â€™s
trafï¬c was ğ‘¡â„ and that of â„ğ‘2ğ‘ was ğ‘¡ğ‘, where ğ‘¡â„ > ğ‘¡ğ‘,
we only kept the ï¬rst ğ‘¡ğ‘ of â„ğ¶ğ‘œğ¶â€™s trafï¬c. In effect, we
simulated the scenario where the P2P bots/applications are
running persistently in the underlying hosts. ğ·1 represents
the scenario that a host is compromised by a P2P bot and
some legitimate P2P applications are active in the same
monitored network.
For ğ·2, we randomly selected half (8) of the P2P bots
from ğ‘ ğ¸ğ‘‡ğ‘ğ‘œğ‘¡ğ‘ . Then for each of the 5 P2P applications
we ran, we randomly selected one out of its two traces
from ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ and overlaid its trafï¬c to the trafï¬c of a
randomly selected host from ğ‘ ğ¸ğ‘‡ğ¶ğ‘œğ¶. We further randomly
chose 3 P2P hosts from ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ @ğ¶ğ‘œğ¶ identiï¬ed in the ï¬rst
experiment (Section IV-C1). We ï¬nally overlaid each of 8
P2P bot traces to each of the selected 8 P2P traces (5 from
ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ and 3 from ğ‘ ğ¸ğ‘‡ğ‘ƒ 2ğ‘ƒ @ğ¶ğ‘œğ¶), as illustrated in the
ï¬rst two columns in Table IX. ğ·2 represents the scenario
that a host, which is compromised by a P2P bot, has an
active legitimate P2P application running at the same time.
1 to represent a â€œcleanâ€ network, where no host
is compromised by P2P bots. We get ğ·â€²
1 by simply removing
all the hosts overlaid with botsâ€™ traces from ğ‘ ğ¸ğ‘‡ğ‘ğ‘œğ‘¡ğ‘ . In
order to get ğ·â€²
2, we randomly select hosts compromised by
two bots for each botnet from ğ·2 and discard the rest of the
hosts overlaid by the traces from ğ‘ ğ¸ğ‘‡ğ‘ğ‘œğ‘¡ğ‘ . Soğ· â€²
2 represents
the scenario in which only two bots from each botnet exist
in the monitored network.
We use ğ·â€²
Authorized licensed use limited to: Tsinghua University. Downloaded on March 18,2021 at 14:47:04 UTC from IEEE Xplore.  Restrictions apply. 