**作者：启明星辰ADLab**  
**公众号：**
## 0x01 引言
近期，启明星辰ADLab监测到一批疑似针对西班牙语地区的政府机构及能源企业等部门的定向攻击活动，黑客组织通过构造恶意Office
Word文档并配合鱼叉邮件发起定向攻击，以“简历更新”作为诱饵文档向攻击目标植入间谍木马，从事情报收集、远控监视及系统破坏等恶意行动。我们将土耳其黑客的此次攻击行动称为“黑狮行动”。
通过对攻击者的行为和所用服务器相关信息的分析和追踪，确定该次攻击来源于一批隐秘多年的土耳其黑客组织-KingSqlZ黑客组织。该组织是一个民族主义色彩非常浓厚的黑客组织，曾攻下其他国家的3千多个网站服务器，并高调的在被攻击网站上留下其组织的名称，随后消失了多年。
如今通过我们对”黑狮行动”的追踪再次挖出该黑客组织的活动迹象。本次攻击过程中，该黑客组织采用渗透手段攻下多台服务器并将其作为存放攻击代码的跳板。
2019年2月，我们发现了第一个攻击样本并将其加入到追踪清单中，直到近期已经发现了多起攻击，每次攻击都使用了不同的攻击形态和免杀方式。从目前已有的攻击代码中我们发现了两款商用远程管理工具（RAT）：“WARZONE”和“Remcos”，其中“WARZONE”被杀毒厂商广泛的识别为“AVE_MARIA”（因为RAT代码中存在该字符串因而被命名为
“AVE_MARIA”），
但是通过我们深入的分析确定“AVE_MARIA”为远程管理工具“WARZONE”。本文中，我们将对黑客组织、攻击目标以及其所使用的攻击武器进行深入分析。
## 0x02 威胁分析
### 2.1 攻击目标分析
从目前所获取的攻击样本和威胁情报，可以看出本次攻击活动并没有大规模的进行，目前还处于攻击试探阶段，但是从其投放的诱饵文档可以简单的确定其攻击目标锁定在西班牙语系的国家。这些诱饵文档形如：“Curriculum
Vitae Actualizado Jaime Arias.doc”（简历更新 海梅阿里亚斯）、“Curriculum Vitae Actualizado
Daniel Ortiz.doc”(简历更新 丹尼尔奥蒂兹)、“Michelle Flores - Curriculum
Actualizado.doc”(米歇尔弗洛雷斯-简历更新)、“Jose
Trujillo.doc”(何塞特鲁希略)等等，它们均采用西班牙语来构造一个带恶意宏代码的简历文件。以此来对目标人力部门进行攻击，以诱使相关人员执行恶意代码进而从事间谍活动。
在我们分析这批诱饵文档时，还发现一个有趣的现象，那就是许多诱饵文档中包含了文档作者信息和最后一次保存者信息，并且这些信息均为类似财政部、信访局、SCG（Southern
Connecticut
Gas）等等与政府部门相关的信息。通过我们实际测试发现，这些信息均会在文档修改后变成当前访问者office登陆账户名或者主机名，并且有心的人还可以对其进行任意定制。我们选取几个典型的样本并针对相关信息和逻辑关系做了如下梳理和推论：
我们通过创建内容时间、最后修改时间及攻击文档内部的逻辑关系推论出相关记录应为攻击者保存。基于最合理以及最有可能的推测，我们认为攻击者可能是基于黑客组织内部规范，将文档的相关名称设置为攻击目标或相关行业信息，从而伪造成内部人士，在一定程度上起到混淆视听、隐蔽自身的目的。
由此我们可以看出此次行动的攻击目标为西班牙语系地区的政府或者公共服务部门，当然并不排除其有更多的目标，至少可以肯定的是此次行动是一次带有政治目的的攻击活动。
### 2.2 黑客组织分析
在我们深入分析恶意代码时，发现该次攻击的控制命令服务器是由上游黑客也即是恶意软件提供商所提供的，从这些控制命令服务器上是无法追踪到该次行动的背后组织，因此我们把主要精力聚焦于攻击的前几个阶段相关的域名。虽然大部分域名均采用了隐私保护，无法找到有用的信息，但是我们却在其中一个强关联的样本中发现一个可突破的点。我们在其中一个RTF文档中内部发现了一个Excel文件，该Excel文件会通过执行宏来下载恶意代码。通过对该服务器的分析我们成功地找到了与黑客组织相关的线索。
在恶意代码存储路径的同目录，我们发现黑客组织所留下的一些信息，下图为其中一个文件记录的信息：
该文件中包含了一些声明信息、黑客组织及其相关成员，并且所采用的语言为土耳其语，因此我们判定该组织正是曾经活跃一时的KingSqlZ黑客组织。该服务器很有可能在被黑客组织控制后作为跳板机或资源服务器继续使用。此外通过恶意代码时区分析法，我们进一步确定该次攻击来自于土耳其黑客。我们对RAT样本之前的PE文件及其他前期攻击环节相关的样本的编译时间做了时区分析（因为RAT样本来自于上游黑客，因此我们忽略了该类样本的时区分析）。最后发现这些攻击样本的编译时间在UTC时间21:00至06:00区间内出现的频次极低。而假定以24:00至08:00作为睡眠时间，攻击者所处的时区可能会在东3区（UTC+3）正负
1 小时区间内，而土耳其时区为东三区正好符合。
在文件的记录信息里还可以得知到该组织成员如F0RTYSEVEN , BlackApple , Pyske , HeroTurk , SadrazaM ,
MrDemonLord等，他们早期进行过疯狂的网络攻击活动，攻陷的服务器高达3287个，而之后便神秘的销声匿迹，其twitter账号也停止了活动。  
本次攻击活动开始于2019年，采用大量公共DDNS服务子域名作为C2来实施攻击，这其中的一些域名为2019年新注册的，使用的部分域名如下：
  * asdfwrkhl.warzonedns.com 
  * casillas.hicam.net 
  * casillasmx.chickenkiller.com 
  * casillas.libfoobar.so 
  * du4alr0ute.sendsmtp.com 
  * settings.wifizone.org 
  * wifi.con-ip.com 
  * rsaupdatr.jumpingcrab.com 
  * activate.office-on-the.net 
到报告撰写时，部分中间攻击阶段的域名已经失效，但RAT回连的C2依然在活跃。依据我们目前对疑似攻击组织的掌握和溯源分析，绘制黑客组织画像如下：
## 0x03 攻击概述
此次事件的主要攻击活动时间线如下所示:
其中，我们对2019年2月7日发现的“Curriculum Vitae Actualizado Jaime
Arias.doc”文档进行了详细的分析，并相继捕获到关联文档“Curriculum Vitae Actualizado Daniel
Ortiz.doc”和“Michelle Flores - Curriculum Actualizado.doc/ Jose Trujillo.doc”。
攻击者使用了API哈希、无文件攻击、WinrarSFX、AutoIt、C#混淆和傀儡进程等技术来规避检测并干扰分析人员。其中，“Curriculum
Vitae Actualizado Jaime Arias.doc”文档植入的木马来源最初无法确认，我们在其中发现了特征字符串“AVE_MARIA”,其与
Cybaze-Yoroi ZLab
研究人员在2018年12月底披露的针对意大利某能源企业进行攻击的恶意软件相似度很高，部分安全研究员和厂商因为没有成功的进行溯源便以此字符串做为该木马家族的名称。而我们经过关联溯源和同源性分析后发现，“AVE_MARIA”类恶意样本同RAT工具“WARZONE”
RAT具有高度一致性，因此将此类恶意家族命名更新为“WARZONE”。
后文将重点就植入间谍木马的2个Office Word文档（”Curriculum Vitae Actualizado Jaime
Arias.doc”和“Michelle Flores - Curriculum Actualizado.doc”）及其释放的文件进行详细分析。
## 0x04 技术分析
### 4.1 早期攻击样本
此次攻击过程开始于一个携带恶意宏的DOC文档，黑客通过伪造成简历的投递邮件手段将此恶意文件发送给攻击目标，当目标用户不慎打开文档便成为了受害者。DOC文档运行后会启动恶意宏代码并从指定的服务器下载“Etr739.exe”，成功下载后立即执行。新进程通过
Base64 解码出另一个服务器地址，继续下载恶意代码“hqpi64.exe”至临时目录下。恶意程序“hqpi64.exe”便是 Warzone RAT
的释放器，其通过释放 Warzone RAT 来执行后续操作，如将“explorer.exe”作为傀儡进程守护、与控制端进行通信等。
样本中的恶意代码大部分采用 CRC32 来加密敏感字串，同时在 API 调用手法上采用了API Hash
值动态获取函数地址和模拟系统快速调用两种方式。使用此类手法不但能在一定程度上减少杀软静态扫描的检测，而且还不易被监测到API的调用踪迹。同时其使用纯加密
Shellcode
代码内存执行的方式加载其核心功能模块，通过“无文件技术”提高自身隐蔽性，以此来躲避安全厂商查杀。其与C2服务器间的通信数据也以CR4算法进行加密进而规避
IDS 系统的检测。  
样本整体执行流程如下：
#### 4.1.1 DOC文档
Doc 文档为 word
文件，也是针对攻击目标实施的第一步攻击，黑客通过钓鱼攻击、社工等手段欺骗攻击目标打开此文档让其中嵌入的恶意宏代码得以执行。我们使用提取工具获取到的宏代码如下图所示：
在AutoOpen函数中包含了一串混淆过的 cmd 命令，经过解密后的代码如图所示：
这段代码获得执行后，会直接从此链接地址(`http[:]//linksysdatakeys.se`)下载恶意程序到`%Temp%\SAfdASF.exe`并执行。
#### 4.1.2 Payload
下一个 Dropper 的下载地址是被加密后保存在恶意程序“SAfdASF.exe”的资源中，加密的资源数据如下图：
该Payload先将上图中加密的数据通过Base64解码出下载链接地址
`http[:]//www.gestomarket[.]co/hqpi64.exe`，然后把“hqpi64.exe”更名为
“2XC2DF0S.exe”并保存在临时目录下。
#### 4.1.3 Dropper
在后续的解密以及执行的过程中，此 Dropper 会把一段 Shellcode 注入到 explorer
进程并在内存中解密出RAT实体使其不落地，最终通过无文件技术将RAT加载到内存中来执行。
**逃避检测**  
此恶意程序在开始执行时，会通过大量的调用 printf 函数打印垃圾代码和 sleep
函数来达到延时效果，这在一定程度上能够躲避安全软件的监控。而其核心功能是将自身携带的 shellcode 解密并执行：
**解密shellcode**  
如上图所示，恶意程序会在加载执行 shellcode 前进行解密。解密算法非常简单，将每个字节的值增加`0x0c`即可。
自定义的解密函数 经过重重下载并解密之后，那么这段解密后的 Shellcode(PE Loader) 代码具体会做些什么，下面我们来一窥究竟。
**PE Loader**  
此 PE Loader 在执行 Shellcode 的时候使用了四个参数，经分析后我们将这4个参数内容所对应的具体功能整理如下表所示：
该PE
Loader首先在运行过程中进行了沙箱和指定进程的检测，以防止被自动化系统分析。并且根据自带的资源数据来判定是否实施驻留本机的操作和注入体的选择。最后此PE
Loader将最终选择的傀儡进程的空间架空，并把解密出的RAT模块映射到此进程中执行(原本PE文件代码被置换)。
**运行环境检测**  
该 PE Loader
在开始运行时，依然会进行沙箱和调试环境的检测，同时通过预先计算好的进程名哈希值来查找指定的进程。当这些检测条件中的任意一条满足时，该恶意程序就不再继续执行，直接返回退出。
运行环境检测