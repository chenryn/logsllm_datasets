58628_953c148f2d%26oauth_token%3De65d28ab0862cbd517c67c3cc6f2247e052ad9c22%26oauth_token_secret%3D2fde10390cd1a2477abaa3dcd44e4b99
其中，oauth_callback没有与应用的oauth_token进行绑定，没有对可用性进行校验，可
以修改为任意地址。这里我们把oauth_callback的值改为xxx.org，并没有提示uri  非法。登
录并授权，跳转到了指定的地址，用户的 oauth_token 泄露，如图 17-5所示。
图17-5 跳转到xxx.org
修复建议：请遵循OAuth协议规范，将应用的oauth_token与oauth_callback绑定，对
oauth_callback进行有效性校验。
17.3 防范OAuth2.0漏洞的相关手段
关于防范OAuth2.0漏洞的安全建议如下。
（1）绑定劫持安全建议
OAuth  2.0提供了state参数用于防御CSRF。认证服务器接收到的state参数按原样返回
给redirect_uri，客户端收到该参数并验证与之前生成的值是否一致。
（2）授权劫持安全建议
用户授权凭证会由服务器转发到 redirect_uri 对应的地址，如果攻击者伪造redirect_uri 为自己的地址，然后诱导用户发送该请求，之后获取的凭证就会发送给攻击者伪造的回调
地址。攻击者使用该凭证即可登录用户账号，造成授权劫持。正常情况下，为了防止该情
况出现，认证服务器会验证自己的 client_id 与回调地址是否对应。常见的方法是验证回调
地址的主域。
第18章 在线支付安全案例总结
目前网络在线消费和支付，已遍布人们生活的衣食住行等各个方面，比如网上商城在
线购物、水电燃气在线缴费、手机话费在线充值等。由于在线消费和支付过程中涉及真金
白银，一旦存在漏洞，将会带来重大的经济损失。
18.1 某快餐连锁店官网订单金额篡改
篡改订单金额的流程如图18-1所示。
图18-1 篡改订单金额流程
步骤一：登录某快餐连锁官网，选择快餐后，显示要支付的金额46元，在Chrome浏
览器中，按 F12 快捷键，在浏览器下方弹出开发者工具，选择最左侧的箭头，如图18-2所
示。
图18-2 调用开发者工具
步骤二：单击已输入金额46元的地方，可以看到该处HTML代码如图18-3所示。
图18-3 查看金额部分HTML代码
步骤三：把金额46元修改为0.01元，如图18-4所示。
图18-4 修改快餐实际金额
步骤四：调用支付宝接口，可以用0.01元购买价值46元的快餐，如图18-5所示。
图18-5 通过支付宝进行支付
18.2 某网上商城订单数量篡改
篡改订单数量的流程如图18-6所示。
图18-6 篡改订单数量流程图
步骤一：在某网上商城购买商品，在购物车中填入购买数量时，可以填入负数，如图
18-7所示。
图18-7 将物品一的数量修改为负数
步骤二：通过填入负数，服务器端会进行数量相加，运算过程及结果是-1*55+1*59=4
元，因此造成支付漏洞，如图18-8所示。
图18-8 最终支付金额
18.3 某服务器供应商平台订单请求重放测试
订单请求重放测试流程如图18-9所示。
步骤一：在某服务器供应商平台上购买服务器资源，购买时通过抓包并进行多次重放
测试，有90%的概率发生购买服务器价格为0元的情况，订单如图18-10所示。
图18-9 订单请求重放测试流程图
图18-10 购买订单
步骤二：服务器可以进行管理和运行，如图18-11所示。
图18-11 购买后的服务器运行状态
18.4 某培训机构官网订单其他参数干扰测试
订单其他参数干扰测试流程如图18-12所示。
图18-12 订单其他参数干扰测试流程
步骤一：在某培训机构官网上进行课程报名，同时利用抓包工具抓包，直接修改金额
发现无法修改成功，因为该参数是直接和schoolid绑定的。
通过观察和测试发现，订单中的配送方式参数可以利用，且运费金额可以修改，但该
参数的数值在服务器端会有验证，课程费用和配送运费不能低于0，否则订单无法成功提
交。
步骤二：接下来重新选择一门课程，课程的价格是1700元，同时将运费修改为-1699
元，两者相加最终费用为1元，如图18-13所示。
图18-13 抓包并修改运费
步骤三：订单成功提交，提示应付金额为1元，如图18-14所示。
图18-14 订单成功提交提示
步骤四：可以在历史订单里发现，该订单已提交成功，只需付款1元即可生效，如图
18-15所示。
图18-15 成功提交的订单历史截图
18.5 防范在线支付漏洞的相关手段
在线支付对广大消费者和商家来说日益重要，稍有不慎就会给商家带来经济损失，为
了减少或者避免在线支付环节中的业务安全问题，希望商家采取以下措施进行预防。
（1）针对订单金额篡改的预防措施
将订单中的商品价格封装为码表形式，即每个商品拥有一个ID，每个ID对应一条相
应的价格。用户访问前台选择商品并提交，服务器端验证商品  ID，然后计算商品总额并
生成订单。
（2）针对订单数量篡改的预防措施
·  在服务器端判断提交商品ID中数量参数值不低于0，如果数量参数值低于0，则直接
提示错误信息，让客户修正。
·  通过数据类型判断正确后，同时判断商城库存对应商品的剩余量，如果剩余量低于
商品的购买数量，则直接提示错误信息，让客户修正。
（3）针对订单请求重放测试的预防措施
无论支付成功还是失败时，使用的订单编号必须唯一，并且永久记录订单编号，不允
许二次使用。
（4）针对其他参数（如运费）干扰测试的预防措施
在服务器端判断订单中运费参数值不低于0，如运费参数值低于0，则直接提示错误信
息，让客户修正。
Document Outline
版权页
前言
致谢
目录
理论篇
第1章 网络安全法律法规
第2章 业务安全引发的思考
2.1 行业安全问题的思考
2.2 如何更好地学习业务安全
第3章 业务安全测试理论
3.1 业务安全测试概述
3.2 业务安全测试模型
3.3 业务安全测试流程
3.4 业务安全测试参考标准
3.5 业务安全测试要点
技术篇
第4章 登录认证模块测试
4.1 暴力破解测试
4.1.1 测试原理和方法
4.1.2 测试过程
4.1.3 修复建议
4.2 本地加密传输测试
4.2.1 测试原理和方法
4.2.2 测试过程
4.2.3 修复建议
4.3 Session测试
4.3.1 Session会话固定测试
4.3.2 Seesion会话注销测试
4.3.3 Seesion会话超时时间测试
4.4 Cookie仿冒测试
4.4.1 测试原理和方法
4.4.2 测试过程
4.4.3 修复建议
4.5 密文比对认证测试
4.5.1 测试原理和方法
4.5.2 测试过程
4.5.3 修复建议
4.6 登录失败信息测试
4.6.1 测试原理和方法
4.6.2 测试过程
4.6.3 修复建议
第5章 业务办理模块测试
5.1 订单ID篡改测试
5.1.1 测试原理和方法
5.1.2 测试过程
5.1.3 修复建议
5.2 手机号码篡改测试
5.2.1 测试原理和方法
5.2.2 测试过程
5.2.3 修复建议
5.3 用户ID篡改测试
5.3.1 测试原理和方法
5.3.2 测试过程
5.3.3 修复建议
5.4 邮箱和用户篡改测试
5.4.1 测试原理和方法
5.4.2 测试过程
5.4.3 修复建议
5.5 商品编号篡改测试
5.5.1 测试原理和方法
5.5.2 测试过程
5.5.3 修复建议
5.6 竞争条件测试
5.6.1 测试原理和方法
5.6.2 测试过程
5.6.3 修复建议
第6章 业务授权访问模块
6.1 非授权访问测试
6.1.1 测试原理和方法
6.1.2 测试过程
6.1.3 修复建议
6.2 越权测试
6.2.1 测试原理和方法
6.2.2 测试过程
6.2.3 修复建议
第7章 输入/输出模块测试
7.1 SQL注入测试
7.1.1 测试原理和方法
7.1.2 测试过程
7.1.3 修复建议
7.2 XSS测试
7.2.1 测试原理和方法
7.2.2 测试过程
7.2.3 修复建议
7.3 命令执行测试
7.3.1 测试原理和方法
7.3.2 测试过程
7.3.3 修复建议