Exploring Layer 2 Network Security 
in Virtualized Environments
Ronny L. Bull
&
Jeanna N. Matthews
Road Map
© 2015 Ronny L. Bull - Clarkson University
● Context for the Problem of Layer 2 Network Security in 
Virrtualized Environments
– Virtualization, Multi-tenant environments, Cloud 
services
– Physical networking basics → Virtual networking basics
● Test platforms
– Array of virtual networking implementations tested
● Specific attacks and results
– MAC Flooding, DHCP Attacks
– Mitigations
● Next steps and conclusions
Virtualization Overview
© 2015 Ronny L. Bull - Clarkson University
Virtual Networking
© 2015 Ronny L. Bull - Clarkson University
Multi-Tenancy
© 2015 Ronny L. Bull - Clarkson University
What If?
© 2014 Ronny L. Bull - Clarkson University
Multi-Tenant Cloud Services
© 2015 Ronny L. Bull - Clarkson University
● Amazon EC2
● Microsoft Azure
● Google Cloud Services
● Countless fly by night VPS hosting providers online
● Brick and mortar data centers serving local clients
● Similarities
– Most run some form of Xen (OS Xen, XenServer)
– Some use VMWare or Hyper-V
– All share network connectivity between tenants 
Key Question
© 2015 Ronny L. Bull - Clarkson University
● Since all client virtual machines are essentially connected 
to a virtual version of a physical networking device, do 
Layer 2 network attacks that typically work on physical 
devices apply to their virtualized counterparts?
● Important question to explore:
– All cloud services that rely on virtualized environments could 
be vulnerable
– This includes data centers hosting mission critical or 
sensitive data!
● Not the only class of attacks from co-located VMs
● Old lesson: vulnerable to those close to you
Bottom Line
© 2015 Ronny L. Bull - Clarkson University
● Initial research experiments show that virtualized network 
devices DO have the potential to be exploited in the same 
manner as physical devices
● In fact some of these environments allow the attack to spill 
out of the virtualized network and affect the physical 
networks they are connected to!
– MAC Flooding in Citrix XenServer
● Allows eavesdropping on physical network traffic as well 
as traffic on the virtual host
Possible Attacks
© 2015 Ronny L. Bull - Clarkson University
● What if another tenant can successfully launch a Layer 2 
network attack within a multi-tenant environment?
– Capture all network traffic
– Redirect traffic
– Perform Man-in-the-Middle attacks
– Denial of Service 
– Gain unauthorized access to restricted sub-networks
– Affect performance 
Quick Review of Network Basics 
© 2015 Ronny L. Bull - Clarkson University
Bridging
© 2015 Ronny L. Bull - Clarkson University
● Physical bridges connect two or more segments at Layer 2
– Separate collision domains
– Maintain MAC address forwarding table for each segment
– Forward requests based upon destination MAC addresses
● Do not cross bridge if destination is on same segment as 
source
● Cross if destination is on a different segment connected 
to the bridge
Ethernet Frame
© 2015 Ronny L. Bull - Clarkson University
Preamble
8
Dest.
Address
6
Source
Address
6
Type /
Length
2
Data
~
FCS
4
Preamble
8
Dest.
Address
6
Used for Layer 2 Forwarding
Bridging
© 2015 Ronny L. Bull - Clarkson University
Virtual Bridges
© 2015 Ronny L. Bull - Clarkson University
● Simplest form of virtual networking
● Uses 802.1d Ethernet Bridging
– Support built into Linux kernel and bridge-utils user-space 
package
– Uses virtual TAP interfaces to connect virtual machines to 
virtual bridge (ie. tap0)
● User-space “Network Tap”
● Simulates a Layer 2 (link layer) network device
Switching
© 2015 Ronny L. Bull - Clarkson University
● Physical switches operate at Layer 2 or higher
● Multi-port bridges
– Separate collision domains
● CAM Table – Content Addressable Memory
– Similar to bridge forwarding table
– Dynamic table that maps MAC addresses to ports
– Allows switches to intelligently send traffic to connected 
devices
– Check frame header for destination MAC and forward
– Finite amount of memory! 
Switching
© 2015 Ronny L. Bull - Clarkson University
Example of switch's CAM table 
Mapping dest address to port
Virtual Switches
© 2015 Ronny L. Bull - Clarkson University
● Advanced form of virtual networking
● Can emulate Layer 2 and higher physical devices
● Virtual machines connect to vSwitch via virtual interfaces 
(ie. vif0)
– Similar to tap devices
● Able to provide services such as
– QoS
– VLAN traffic separation
– Performance & traffic monitoring
Virtual Switches
© 2015 Ronny L. Bull - Clarkson University
● Variety of virtual switches available
– Typically bound to certain environments
– Open vSwitch
● OS Xen, Citrix XenServer, KVM, Prox-Mox
– Cisco Nexus 1000V Series
● VMWare vSphere, MS Hyper-V (add-on)
– MS Hyper-V Virtual Switch
● Microsoft Hyper-V
● All are considered as enterprise level solutions
Overview of Results
● MAC Flooding Attack
● Attack Overview
● Summary of Results
● DHCP Attack Scenarios
● Scenario Descriptions
● Summary of Results
© 2015 Ronny L. Bull - Clarkson University
Test Environment
A.K.A.
Cloud Security 
Research Lab
© 2015 Ronny L. Bull - Clarkson University
Hardware Specs
© 2015 Ronny L. Bull - Clarkson University
(full system specs are provided in the white paper on the DEFCON 23 CD)
MAC Flooding Attack
© 2015 Ronny L. Bull - Clarkson University
MAC Flooding
© 2015 Ronny L. Bull - Clarkson University
● MAC Flooding
– Flood switch with numerous random MAC addresses to fill 
the CAM table buffer
– Forces switch into fail safe mode (a.k.a. Hub mode)
– All frames forwarded to all connected devices
● Breaks collision domain separation
– Works well on most physical switches
MAC Flooding
© 2015 Ronny L. Bull - Clarkson University
MAC Flooding Demo
Network Diagram
© 2015 Ronny L. Bull - Clarkson University
MAC Flooding Demos
© 2015 Ronny L. Bull - Clarkson University
● Demos
– Gentoo / OS Xen – 802.1d Linux Bridging
● https://www.youtube.com/watch?v=Zh-aOy9gu9I
– Gentoo / OS Xen – Open vSwitch 2.0.0
● https://www.youtube.com/watch?v=gzuQI_XUgKc
– Citrix XenServer 6.2 – Open vSwitch 1.4.6
● https://www.youtube.com/watch?v=Y1JQg5YXfY4
MAC Flooding Summary
© 2015 Ronny L. Bull - Clarkson University
MAC Flooding
(Performance Degradation)
© 2015 Ronny L. Bull - Clarkson University
MAC Flooding
● Reported Open vSwitch vulnerability to:
● cert.org
● Assigned VU#784996
● PI:EMAIL
● No response as of yet
● PI:EMAIL
● Responded with implementation of MAC learning fairness 
patch
● Applied to all versions of Open vSwitch >= 2.0.0
● https://github.com/openvswitch/ovs/commit/2577b9346b9b77feb94b34398b54b8f19fcff4bd
© 2015 Ronny L. Bull - Clarkson University
MAC Flooding Mitigation
© 2015 Ronny L. Bull - Clarkson University
● Can be mitigated by enforcing port security on physical 
switches
– Feature only currently available on Cisco Nexus 1000V 
'Non-Free' version (VMWare Essentials Plus & MS Hyper-V)
– Limit amount of MAC addresses that can be learned via a 
single port
● Only allow authorized MAC addresses to connect to a 
single port on the switch
– Trusted connections, no malicious intent
● Disable unused switch ports
DHCP Attacks
© 2015 Ronny L. Bull - Clarkson University
DHCP Protocol
© 2015 Ronny L. Bull - Clarkson University
● Networking protocol used on most computer networks to 
automate the management of IP address allocation
● Also provides other information about the network to 
clients such as:
– Subnet Mask 
– Default Gateway
– DNS Servers
– WINS Servers
– TFTP Servers
DHCP Protocol
Client – Server Model
© 2015 Ronny L. Bull - Clarkson University
DHCP Options
© 2015 Ronny L. Bull - Clarkson University
● DHCP allows an administrator to pass many options to a 
client besides the standard Subnet Mask, DNS, and 
Default Gateway information
● Options are specified by a DHCP Option Code number
– Option 4 – Time Server
– Option 15 – Domain Name
– Option 35 – ARP Cache Timeout
– Option 69 – SMTP Server
● Options are defined in RFC 2132 - DHCP Options
–
https://tools.ietf.org/html/rfc2132
DHCP Attacks