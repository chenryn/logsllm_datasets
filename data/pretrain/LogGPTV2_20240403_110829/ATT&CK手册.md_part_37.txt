> [O 山 中 以
> 及mi](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [OLI••-](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [Grunt:
> a18f381153](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [今 中一 。. f0 , －" tm沁 0m\`
> OT..m"](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> \_ [\>
> G叩\"](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [O T"
> "](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [O T·· 心 心
> ·](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [\ h](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [色 D.
> ，.](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [总 u"
> "](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
>
> [mi旧 可心 o 飞，mm," matcato 匕""口心 mt."" mt忙皋肝 R," "
> ToSe廿\',"](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
[shell
s,心](https://demonsec666.oss-cn-qingdao.aliyuncs.com/4A408314A86E0999EE6A7EE0034CFEB1.jpg)
![](media/image391.png){width="5.832182852143482in"
height="7.396874453193351in"}
参考资料： https://github.com/cobbr/Covenant/wiki/Installation-And-
Startup https://posts.specterops.io/covenant-the-usability-update-
9a7a596a4772 https://github.com/cobbr/Covenant
详细请看视频：https://[www.ggsec.cn/Covenant.html](http://www.ggsec.cn/Covenant.html)
# 十.Exfiltration
## 1、远程文件复制
> 系统：Windows，Linux，MacOS
可以将文件从一个系统复制到另一个系统，以在操作过程中分级对手工具或其他文件。可以通过命令和控制通道从外部对手控制的系统复制文件，以将工具带入受害者网络，或通过其他工具如FTP
使用备用协议。也可以使用scp，rsync 和sftp 等本机工具在Mac 和Linux
上复制文件。
攻击者还可以在内部受害者系统之间横向复制文件，以支持使用固有文件共享协议进行远程执行的横向移动，例如通过SMB
与连接的网络共享或使用Windows
管理员共享或远程桌面协议的经过身份验证的连接进行文件共享。
## 2、自动脚本窃取
> 系统：Windows，Linux，MacOS
描述：在收集目标信息之后或期间，可以使用自动化信息处理工具和脚本来执行包含机密信息数据的泄露。结合渗出自动化工具，通过使用控制通道（C2）或替代协议的渗透方法可用于通过网络传输数据。
1、通过FTP 自动将数据信息传送到远程C2 服务器
2、BadUSB 物理信息窃取
3、自动截图、盗取剪切板、收集用户凭证、包括密码、账户哈希各种密钥发送到中转服务器
保护提示：使用AppLocker
或软件限制策略等白名单工具识别并阻止潜在危险和恶意软件。
####### 凭据窃取恶意软件
让我们回到恶意软件本身。LokiBot 被定义为 "infostealer",
因为它有能力窃取来自各种流行电子邮件客户端和 web 浏览器的凭据。
此恶意软件还可以窃取来自许多 FTP 客户端 (如 FileZilla, FlashFXP, WS_FTP
等) 和 SSH 程序 (如PUTTY) 的登录细节,
尤其对于网站管理员和网站开发商而言更
加危险，谁都可以从他们的网站上窃取凭据。
6-10 年前, 这是黑客攻击最受欢迎的媒介。一旦网站管理员的计算机被感染,
恶意软件只需扫描保存 ftp 凭据的文件 (大多数 FTP
客户端都以纯文本保存它们), 然后将调查结果发送到控制服务器。
虽然这种攻击媒介现在不那么流行, 但你仍然不能低估它。例子：
-   使用鱼叉式网络钓鱼电子邮件窃取合法凭据的组织，从而获得了合并和获取信息。
-   通过使用在其入侵中被盗的合法凭据攻击了支付系统并获得了对信用卡记录的访问权限。
-   针对销售点系统的攻击中使用合法凭据，为信用卡记录刮取内存。https://[www.anquanke.com/post/id/170364](http://www.anquanke.com/post/id/170364)
密 码 窃 取 软 件 AcridRain
https://[www.4hou.com/web/16245.html](http://www.4hou.com/web/16245.html)
窃取恶意软件\'Ovidiy Stealer\'
https://[www.hackread.com/buy-password-stealing-malware-ovidiy-](http://www.hackread.com/buy-password-stealing-malware-ovidiy-)
stealer-for-7/
![](media/image392.jpeg){width="5.789349300087489in"
height="3.4140616797900263in"}
![](media/image393.jpeg){width="5.607042869641295in"
height="1.745624453193351in"}
如果窃取者能够从目标应用程序中找到密码，它将跟踪其初始签入，并报告目标应用程序密码的另一个请求：
-   id：DiskID 和ProcessorID
-   site：保存凭据的网站
-   程序：有针对性的应用程序
-   login：保存的应用程序用户名
-   pass：保存的应用程序密码
-   user：已注册的Ovidiy Stealer 用户名
![](media/image394.jpeg){width="5.786151574803149in"
height="0.8431244531933508in"}
## 3、数据压缩
> 系统：Windows，Linux，MacOS
攻击者可以压缩在渗出之前收集的数据（例如，敏感文档），以使其可移植并最小化通过网络发送的数据量。压缩与exfiltration
通道分开进行，并使用自定义程序或算法，或更常见的压缩库或实用程序（如
7zip，RAR，ZIP 或zlib）执行。
1、以在将数据发送回C2 服务器之前使用ZLIB 压缩数据。
2、将收集的数据隐藏在受密码保护的.rar 档案中。技术示例：
7zip:
7z.exe a -tzip -p111 archive.7z txt.txt 压缩 密码为 111 7z.exe x -tzip
-p111 archive.7z 解压 密码为 111
RAR:
> rar.exe a -pmyhoney secret1 \*.txt 添加 \*.txt
> 文件并用密码\"myhoney\"加密rar.exe x -pmyhoney secret1 解密secret1.rar
> 文件使用密码\"myhoney\"解密
rar.exe a -hpfGzq5yKw secret report.txt 将添加文件 report.txt
到加密的压缩文件secret.rar 中，使用密码\'fGzq5yKw\'
注：-hp\[p\] 加密文件数据和头，这个开关和 -p\[p\] 类似，但是开关 -p
只加密文件数据，而使文件名等其它信息可见。这个开关加密所有包括文件数据、文件名、大小、属性、注释和其它块等所有可感知压缩文件区域，所以它提供了更高的安全等级。在压缩文件中使用-hp
加密，没有密码甚至不可能查看文件列表。
ZIP:
> zip -q -r -P 123456 tools.zip tools 安静模式，使用密码 123456
> 加密文件夹zip -q -r tools01.zip tools
> 安静模式，压缩文件不显示指令的执行过程
zlib:
下载Zlib 库，地址:  用wget
下载，后自行安装。以下代码为压缩字符到test.gz 文件。
C:
> #include \ #include \
>
> int main(int argc,char \*\*args)
>
> {
>
> gzFile file;
>
> char str\[\]=\"testtest\"; file=gzopen(\"test.gz\",\"wb\");
> if(NULL==file) perror(\"Can\'t open file\"); gzsetparams(file,2,0);
> gzwrite(file,str,sizeof(str)); gzclose(file);
>
> return 0;
>
> }
保护建议：为了绕过IPS
或DLP，阻止某种类型的文件传输或在未加密的通信信道上包含某个标头，攻击者可以切换到使用Exfiltration
通道的加密。可以通过监视与调用已知数据压缩使用程序相关联的进程和命令行参数来提前检测压缩软件和压缩文件，但此方法涉及分析大量错误事件。
####### 数据传输大小限制 {#数据传输大小限制-1}
说明：为了防止超过网络上传输数据的允许阈值的保护和可能的警告，攻击者可以将exfiltered
文件拆分成许多相同大小的片段或限制网络数据包的大小低于阈值。将数据包大小限制在特定阈值以下。避免触发网络数据传输阈值警报。
安全提示：使用流量特征分析的IDS 和DLP
可用于检测和阻止已知的特定管理和控制工具（C2）和恶意软件，因此攻击者可能会随时更改使用的工具或设置数据传输协议避免通过已知的保护手段进行检测。
作为一种检测技术，我们建议分析异常数据流的网络流量（例如，客户端发送的数据远多于从服务器接收的数据）。恶意进程可以通过顺序发送固定大小的数据包或打开连接并以固定间隔执行数据传输来长时间保持连接。这种通常不使用网络的活动过程应该是可疑的。用于数据传输的端口号与在默认网络协议中设置的端口号的不匹配也可能表示恶意活动。
技术案例：
1、Helminth 将数据拆分为最多 23 个字节的块，并将DNS
查询中的数据发送到其C2 服务器。
2、OopsIE 以 1500 字节块的形式将命令输出和收集的文件泄露到其C2
服务器。使用WINRAR 分割压缩文
件:https://jingyan.baidu.com/article/bea41d43b255feb4c51be6d6.html
1、把一个文件压缩成几个固定大小的文件及解压缩，然后再将其转移到C2 服务器
![](media/image395.jpeg){width="5.850849737532808in"
height="5.0451038932633425in"}
点击确定按钮，就开始按设定大小压缩成几个固定大小的文件，最后一个不一定是固定大小
![](media/image396.jpeg){width="4.517012248468942in"
height="3.6990616797900264in"}
## 4、代替的协议窃取
> 系统：Windows，Linux，MacOS
描述：数据泄漏通常使用除对手用来建立控制信道（C2）之外的替代协议来执行。替代协议包括FTP，SMTP，HTTP
/ S，DNS 和其他网络协议，以及外部Web 服务，如云存储。
安全提示：请遵循有关配置防火墙的建议，将流量限制为仅允许从允许的端口进入和退出网络。例如，如果不使用FTP
服务在网络外部发送信息，则阻止与网络边界周围的FTP
协议关联的端口。为了减少组织控制信道和泄漏的可能性，使用代理服务器和专用服务器来进行DNS
等服务，只允许通过适当的端口和协议进行系统交互。
要检测和防止组织控制通道和数据泄漏的已知方法，请使用使用流量特征分析的IDS
/ IPS 系统。但是，攻击者可能会随着时间改变控制和渗透协议，以避免通过
保护进行检测。作为一种检测技术，我们还建议分析异常数据流的网络流量（例
如，客户端发送的数据远多于从服务器接收的数据）。不匹配使用的端口号和默认网络协议中设置的端口号也可能表示恶意活动。
使用不同网络协议执行转移数据，包括FTP，SMTP,HTTP/S,DNS
或者其他网络协议。还可能包括WEB 服务，云存储。
1、将收集的数据上传到云端硬盘 \--\> 远程登录云端硬盘下载数据
2、通过FTP 传输与清除文件
## 5、命令控制信道窃取
> 系统：Windows，Linux，MacOS
说明：可以使用攻击者用作控制通道的相同协议（C2）来泄露数据。
保护建议：使用IDS / IPS
系统组织基于流量特征的分析，以识别组织控制通道和渗透的已知方法。分析异常数据流的流量（例如，客户端发送的数据远多于从服务器接收的数据）。不匹配使用的端口号和默认网络协议中设置的端口号也可能表示恶意活动。
技术案例：
1、APT32 的后门使用已经打开的通道及其C＆C 服务器来泄露数据。
2、MobileOrder 通过与C2 通信相同的协议将数据泄露到其C2 服务器。3、Remexi
通过bitsadmin 执行泄漏，bitsadmin 也用于C2 通道。
## 6、网络媒介窃取
> 系统：Windows，Linux，MacOS
说明：数据泄露可以在与组织控制通道（C2）的环境不同的网络环境中进行。如果控制信道使用到因特网的有线连接，则可以通过无线连接（WiFi，蜂窝网络，
蓝牙连接或其他无线电信道）进行泄露。如果存在可用性和接近性，则攻击者将使用备用数据传输介质，因为其中的流量将不会通过受攻击的公司网络路由，并且网络连接可以是受保护的或打开的。
安全建议：确保主机上的安全传感器支持审核所有网络适配器的使用，并在可能的情况下阻止连接新的网络适配器。跟踪和分析与添加或复制网络接口相关的网络适配器设置的更改。
技术案例：
1、Flame 有一个名为BeetleJuice
的模块，其中包含可以以不同方式使用的蓝牙功能，包括通过蓝牙协议从受感染系统传输编码信息，充当蓝牙信标，以及识别附近的其他蓝牙设备。
## 7、数据加密
> 系统：Windows，Linux，MacOS
描述：在进行渗透之前，可以对目标数据进行加密，以隐藏被盗信息，逃逸检测或使过程不那么明显。使用实用程序，库或自定义算法执行加密，并在控制通道
（C2）和文件传输协议之外执行。具有数据加密支持的通用归档格式是RAR
和zip。
安全提示：可以通过监视进程和命令行参数来检测运行众所周知的文件加密软件，
但这种方法涉及分析大量错误事件。加载Windows crypt.32.dll DLL
的进程可以被攻击者用来加密，解密或验证文件签名。可以通过分析网络流量的熵来执行对加密数据的传输的检测。如果信道未加密，则可以通过分析文件头的IDS
或DLP 系统检测已知类型的文件的传输。
参考链接：
3DES 加 密 算 法 ：
https://blog.csdn.net/knight20160302/article/details/82952686
RC4 加密算法：https://blog.csdn.net/chence19871/article/details/17564877
Base64 加密算法：https://blog.csdn.net/zyhlwzy/article/details/77964763
## 8、物理介质窃取
> 系统：Windows，Linux，MacOS
说明：在某些情况下，例如物理隔离受损网络，可能会通过物理介质或用户连接的设备进行渗透。这种媒体可以是外部硬盘驱动器，USB
驱动器，手机，mp3
播放器或任何其他可移动存储或信息处理设备。对手可以使用物理介质或设备作为渗透的终点或隔离系统之间的过渡。
安全提示：禁用自动运行可移动存储设备。如果业务运营不需要，则禁止或限制在组织安全策略级别使用可移动设备。作为检测通过物理环境进行渗透的措施，建议组织对可移动介质上的文件的监视访问，以及在连接可移动介质时启动的审核进
程。
1、有线电话机控制器
2、暴露在外处的USB 接口
3、BadUSB 将数据从气隙网络传输到连接Internet 的系统。技术示例：
USB 攻 击 方 式 ：
https://blog.csdn.net/xCnhYKoHj3eK/article/details/79649822
> https://blog.csdn.net/weixin_34097242/article/details/86256003
> https://[www.youtube.com/watch?v=90MIjgh5ESU](http://www.youtube.com/watch?v=90MIjgh5ESU)
>
> https://[www.youtube.com/watch?v=w2yadyr-lDU](http://www.youtube.com/watch?v=w2yadyr-lDU)
## 9、已计划的转移
> 系统：Windows，Linux，MacOS
说明：数据只能在一天的特定时间或定期进行。这种调度用于将过滤后的数据与网络上的正常流量混合。当使用计划的渗出时，还使用其他信息泄漏方法，例如通过控制通道（C2）和替代方案的渗出。
保护建议：使用带有流量签名分析的IDS / IPS 系统。作为检测恶意活动的措施，
建议监视进程到文件的访问模式，以及扫描文件系统然后发送网络流量的进程和方案。在几天的同一时间发生的同一地址的网络连接应该是可疑的。