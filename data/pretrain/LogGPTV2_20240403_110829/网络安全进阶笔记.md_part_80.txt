间也同时被自动记录下来。其实，在计算机网络中，利用噢探器也可以达到同样的效果，它可
以窃听计算机程序在网络上发送和接收到的数据。
用过Windows平台上的sniffer工具的朋友都知道，在共享式的局域网中，采用sniffer工
具简直可以对网络中的所有流量一览无余！因此，对于网络管理人员来说，使用噢探器可以随
时掌握网络的实际情况，在网络性能急剧下降的时候，可以通过snifer工具来分析原因，找出
造成网络阻塞的来源：对于网络程序员来说，可以通过sniffer工具来调试程序，找出发生问题
的原因。站在另外一个角度，对于需要了解某个网络信息的攻击者来说，噢探器还可能成为他
的一个攻击法宝。
1.典型的TCPDump日志分析
那么，对于钟爱Linux的网络安全爱好者来说，能找到这样一款强大的Linux下的噢探器
吗？答案是肯定的。TCPDump就是一个免费的网络分析工具，它还提供了源代码，并公开了
3
---
## Page 399
网络安全进阶笔记
接口，具备很强的可扩展性。在Linux下TCPDump的安装十分简单，通过rpm命令可以直接
安装，rpm包是将软件编译后打包成二进制的格式，不需要修改任何东西。安装时，以超级用
户登录，参考命令如下：#rpm-ivhTCPDump.rpm，这样，TCPDump就可以顺利地安装到Linux
系统中。不过，现在较高版本的Limux操作系统都自带了这个工具。普通情况下，不带参数执
行TCPDump，即wTCPDump，截获的是通过第一个网络界面的数据包。直接启动TCPDump
将监视第一个网络界面上所有流过的数据包，如图8.11所示。
1%:47:09.78841561.183.14.
2955 > E32.168.19,25-135: s 319e/81803:399e7k148]c90 sis I5384
1.10.128.1028 2 esd.Ma11.a21-0.0 i6: 54 PTE 117,0.18.200
47341 e.4p11.a1.a.dmin 152.1.19.1289%: 85 Nais 0/9 (12)
图8.11使用TCPDump监视数据包
从上面的输出结果来看，TCPDump的基本输出格式具有一定的规律。值得一提的是，这
些数据流是无恶意的，它只是一个友好的Web数据包。上面只是列出了几行，不过，“麻雀
虽小，五脏俱全”，在此已经包含了许多的重要信息，了解这些信息，对于我们了解网络入侵
的“蛛丝马迹”具有十分重要的意义。
下面，我们取一个比较典型的日志实例进行详细面深入的分析，这是TCPDump所监视的
一个流过的数据包。以下所代表的意思是时间、接口、数据流方向、源地址、源端口、目标地
址、目标端口、标志集、序列号、数据包中的字节、窗口大小、选项、不支持数据包分解。日
志记录如下：
11:53:49.869667eth0>192.168.10.128.12242>192.168.10.255.w:
6373380:6373380 （0)win8192 （DF)
第1个是11:53:49.869667。其中，11:53:49是发现数据包的时间，.869667是ID号，它的
作用是为了更加准确地记录数据，这样可以将时间记录很精确地表示出来。如果将来需要查证，
只需提供查找关键字，就可以很容易地将某个时间段的事件确定下来，
“ethO>”表示从网络接口设备发送数据包，在Linux操作系统中，一般为eth开头。如果在其
他的操作系统，名称可能会产生一定变化，如Solaris中一般为hme开头。
第3个是192.168.10.128.12242，这是源地址和源端口12242.这里面还隐藏着不少玄机。
我们可以根据端口来判断哪个系统是客户，哪个系统是服务器。当客户向服务器请求某种服务
时，如HTTP或FTP，它往往会把其源端口设置为一个临时端口，此端口一般为1024或者更
大。面客户则通过一些常用的端口如80或者21，来向服务器发送相关的请求。
第4个是192.168.10.255.www.这是目标机器的IP地址和端口。在这个例子中，TCPDump
会把www转换为相应的端口号。如果服务是未知的，就会通过数字的形式显示出来，不过，
304
---
## Page 400
三
第8章掌握实用的Linux安全工具
用www表示的端口并不一定是www服务，比如也可以通过80端口开启一个Telnet服务，这
是可以灵活配置的。
第5个是s标志，这是一个标志字段。其值可能是F、S、R或P.分别是FIN、SYN、RST
或PSH。如果在标志字段中有一个句号或一个点号，则表示FIN、SYN、RST或PSH都没有
设置。攻击者往往可以通过设置异常的标志来选避IDS的检测。如果一个数据包中的标志不规
范，就要引起注意了。
第6个是6373380:6373380（0）。前面的部分是初始序列号，后面是一个完全相同的结束序
列号。（0）表示此数据包中的字节数。初始序列号可以用于跟踪记录数据包发送的顺序。设置完
毕，针对数据包中的各字节，每台主机都会将序列号增加1，这样就能够保证通信双方实现同
步。对于TCP来说，在全双工连接方式中，连接双方都有一个序列号，这样，就可以跟踪双
方的数据发送情况了，
第7个是win8192。这个功能主要是设置窗口大小，从而指出它所能够接收的最大数据包
长度。这是因为不同的操作系统可以处理不同大小的数据包，面且处理速度也不相同。如果客
户发给服务器的数据包超过了窗口大小，服务器通常会丢掉数据包。
第8个是。这里可以在建立连接时，设置各种TCP选项。Mss
表示满意当前连接中可以接受的最大长度，本记录中为1460字节。TCP选项必须达到32个字
节，如果不能达到，就要用nop（NOOperationCodes）米表示，其意思是无操作码。
第9个是（DF）。它表示不支持数据包的分解。在TCP模式下，一般不建议分解。
2.利用TCPDump检测SYNFlood攻击
在参加联合国安理会讨论的过程中，如果中国代表团把握其中可能出现的某些迹象，然后
使用一些小技巧，就可以有效地防范间谋的窃听了。同样，通过上面的典型日志分析，我们可
以发现，网络事件通常在时间上具有很强的相关性，这样可以很好地应对拒绝服务攻击（如
SYN-Flood、teardrop等）.所调拒绝服务，是指在特定攻击发生后，被攻击的对象不能及时提
供应有的服务，例如本来应提供网站服务（HTTPService）面不能提供网站服务，电子邮件服务
器（SMTP、POP3）不能提供收发信件等的功能，基本上，阻绝服务攻击通常利用大量的网络数
据包，来瘫痪对方的网络及主机，使得正常的使用者无法获得主机及时的服务。
在实际应用中，我们可以首先利用TCPDump工具收集大量的网络数据流量，然后对
TCPDUMP所收集的网络数据包进行分析，挖掘出拒绝服务序列规则，最后把该序列规则应用
于实时的网络数据流中。这样，就可以得到某种分析结果，如图8.12所示。
通过观察上述流程，可以分析如下。
（1）对TCPDUMP格式的数据经过预处理，将其转换为一条条的连接记录，然后减少需要
挖掘的数据量，以提高数据挖掘效率。经过简化后的数据可以只包括。
（2）经过整理后，将大量的连接记录装入SQLSever数据库，再次进行清理，去掉所有标
志不是SYN的记录，并按照目标主机、自标端口、时间升序排列，便于下一步进行序列挖掘。
（3）确定时间窗口。反复修改时间窗口大小、反复挖掘，以确定时间窗口大小和该时间窗
口内导致拒绝服务的标志为SYN的TCP连接数目。而且随着主机、端口、系统和带宽等具体
网络环境的不同而有所不同，具有适应性。
395
---
## Page 401
网络安全进阶笔记
入SOLS物要
抢期出D用
数期挖掘序用分析
应用DeS期
图8.12利用TCPDump 检测 SYN Flood 攻击
（4）DoS序列规则。经过反复挖掘，最后确定规则。例如在2秒钟时间内，1000条SYNFlood
会导致某一系统的WWW端口产生了拒绝服务攻击。
（5）把上述获得的DoS序列规则应用于实时网络数据流中进行序列分析，以判断是否检
测到了拒绝服务攻击。如果不是则认为正常，否则需采取如下的措施以挽救其联接队列。
相信很多人还记得2000年Yahoo网站遭受的攻击事例，当时黑客利用的就是简单而有效
的SYN攻击，有些网络蟠虫病毒配合SYN攻击造成更大的破坏。下面简单介绍一下对付SYN
Flood的几个基本方法。这些对策各有自己的优势和劣势，不过都对消减SYNFlood的入侵威
力有帮助。
①增加联接队列的大小。尽管每个程序员实现IP协议栈时都会有所不同，但调整联接
队列的大小肯定可以有助于减轻SYNFlood。但这样做会消耗额外的系统资源，从而影响性能。
②缩短SYNTimeout时间。由于SYNFlood入侵的效果取决于服务器上保持的 SYN半
联接数，这个值等于SYN入侵频率与SYNTimeout值的积，所以通过缩短从收到SYN报文到
确定这个报文无效而丢弃联接的时间，即SYNTimeout，可以成倍地降低服务器的负荷（例如设
置为20s以下，但是太低的SYNTimeout设置可能会影响客户的正常访间）。
③应用相关的软件补丁。随着SYNFlood淹没在Intemet上越来越流行，针对这种情况，
许多操作系统上已开发了专门应对这种DoS入侵的程序。例如，Linux内核2.0及以后的版本
采用了SYNCookie选项，内核可以利用它检测并记录可能的SYNFlood，能够允许合法用户
在强度很大的攻击下也能继续进行联接
另外，在Windows 2000中，可以通过设置动态Backlog（Dynamic Backlog）来增大系统所能
容纳的最大半连接数，配置动态 Backlog由AFD.SYS驱动完成，AFD.SYS是一种内核级的驱
动，用于支持基于WindowsSocket的应用程序，比如FTP、Telnet等。AFD.SYS的位置为
[HKEY_LOCAL_MACHINE\SYSTEMCurrentControlSetIServices'AFDParametersEnableDynami
cBacklog]-当它的值为1时，表示启用动志Backlog，可以修改最大半连接数。当SynAttackProtect
值为2时(Microsoft 推荐使用此值），系统不仅使用Backlog队列，还使用附加的半连接指示，
以此来处理更多的SYN连接。
396
---
## Page 402
第8章掌握实用的Linux安全工具
④应用网络IDS产品.有些基于网络的IDS产品能够检测并主动对SYN入侵做出响应。
通过观察没有对应的ACK数据分组或RST数据分组的SYN分组的数量，就可以确定SYN
Flood淹没。IDS会向发出SYN请求的系统主机发送RST分组，以帮助遭受入侵的系统挽教
其联接队列。
类似的应用还有很多，对于IP网络的系统管理员来说，在排查网络中的故障时，用好
TCPDump这样的包分析软件，配合其他的管理工具，就可以起到事半功倍的效果。
8.2.3巧用Webalizer分析网络服务器日志
网管的天职就是要对系统的一举一动了如指掌。无论在Windows系统还是Linux系统下，
管理员经常需要对网站流量和日志进行分析。要完成这些工作，一般需要使用日志及流量分析
工具。Webalizer就是这样一款高效、简单易用、免费的Web服务器日志及流量分析程序。它
采用C语言编写，具有很高的运行效率。在主频为200MHz的机器上，Webalizer每秒钟可以
分析10,000条记录，所以分析一个40M大小的日志文件只需区区15秒，效率十分惊人。
更值得一提的是，可以将Webalizer的分析结果以列表和图片形式显示并保存成HTML文
件格式。这样，就可以通过浏览器进行浏览，也可以将统计结果导出，并方便地导入到其他数
据库和应用系统中。这里将通过对Linux下的服务器流量日志进行分析，详细介绍如何使用该
软件进行流量分析。软件下载地址为http://www.mrunix.net/wcbalizer/download.html。
1.快速安装与配置Webalizer软件
与Linux下的其他软件安装过程一样，用户可以通过命令行配置Webalizer，也可以通过配
置文件进行配置。
具体步骤如下。
（1）解压代码包。安装该软件时，首先解开源代码包：
tar xvzfwebalizer-2.21-02-sre.tar
在生成的目录中有个lang目录，该目录中保存了各种语言文件，其中也包含了简体中文。
（2）配置并编译文件。进入生成的目录，输入以下命令：
./configure
配置过程如图8.13所示。
(3）使用中文编译。命令为：
nake install
如图8.14所示。
(4)配置Webalizer:
cp webalizer /usr/sbin/
编译成功后，会在/usr/local/bin/目录下生成一个Webalizer可执行文件，可将其拷贝到
/usr/sbin/目录下，然后就可以开始配置Webalizer了。
307
---
## Page 403
网络安全进阶笔记
图8.13Webalizer的配置过程
3.21:02
围8.14Webalizer的编译过程
Webalizer的配置文件的路径为/etc/webalizer.conf。一般情况下，该配置文件的默认选项都
能满足一定应用需要，可以直接使用，如图8.15所示。
5
图8.15Webalizer的配置文件webalizer.conf
在Webalizer配置文件中，包含了许多配置选项。下面是webalizer.conf配置文件中的常用
---
## Page 404
第8章掌握实用的Linux安全工具