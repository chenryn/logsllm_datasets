### Optimized Text

#### 2. Limitations in CEE and InfiniBand Switches
Priority Flow Control (PFC) and Congestion-Based Flow Control (CBFC) are both limited in CEE and InfiniBand switches. Essentially, PFC and CBFC function similarly to prevent buffer overflow by alternating switch ports between sending (ON) and pausing (OFF). When a port is in the pausing (OFF) state, subsequent packets are queued until buffer space becomes available at the downstream switch.

#### 3. Observations and Insights
In lossless networks, hop-by-hop flow controls inevitably take effect, and the alternation between ON and OFF states of switch ports can introduce unexpected issues in congestion detection. This section presents fine-grained simulations in both single and multiple congestion point scenarios to investigate the interaction between hop-by-hop flow controls and congestion detection.

##### 3.1 Experimental Observations
**Simulation Setup:**
We use a topology as shown in Figure 3.1.1, which is a common unit in today’s multi-rooted topologies (e.g., Fat-Tree [9], Leaf-Spine [11]). All links operate at 40Gbps with a 4μs propagation delay. S1 sends a long-lived flow F1 to R1, while A0-A14 send concurrent 64KB bursts to R1. Initially, F1 achieves 40Gbps. In both single and multiple congestion point scenarios, bursts start at time 0 and last for about 3ms. After the bursts start, long-lived flows F0 and F2 send at a constant rate to R0. The bursts cannot be controlled by end-to-end congestion controls due to their size being smaller than the Bandwidth Delay Product (BDP). ECN (DCQCN [56]) and FECN (IB CC [13]) are the congestion detection mechanisms in CEE and InfiniBand switches, respectively. The CC parameters are set to recommended values [22, 56], and details are provided in § 5.2. For CEE, the PFC threshold is 320KB, and for InfiniBand, the ingress buffer size is 280KB.

**Single Congestion Point Scenario:**
In this scenario, port P3 is the only congestion point. F1 initially achieves 40Gbps, and bursts start at time 0. After the bursts start, F0 and F2 send at a constant 5Gbps. The rate of F1 drops below 15Gbps when F0 and F2 start, so port P0 is never congested. During the burst, the ideal bandwidth allocation for F1 is about 2.5Gbps. Figures 3(a) and 3(b) illustrate the queue length and marked packets at port P2 for CEE and InfiniBand.

For ports P0, P1, and P2, each input rate does not exceed the line rate, so these ports should not detect congestion. However, due to congestion spreading from port P3, these ports are paused intermittently. With a constant input rate of 5Gbps for F0 and F2, port P2 has a maximum queue length of over 500KB. As shown in Figure 3, both ECN and FECN incorrectly detect congestion at port P2. F0 is mistakenly marked with ECN at port P2, even though it is not the congestion point. Meanwhile, the congested flow F1 should only be marked with ECN at port P3. Partial packets of F1 are marked with ECN at port P2, despite it not being the real bottleneck. Similar marking behavior is observed at ports P1 and P0, but the results are omitted for brevity.

In CEE, queue-based congestion detection alone is inadequate. In lossy networks, congestion is typically detected when switch ports have queue buildup. However, when PFC takes effect in CEE, a port will receive PAUSEs intermittently, leading to queue buildup. CEE switches check the queue size and mark ECN when each packet dequeues. If the current egress queue length exceeds a threshold \( K_{\text{max}} \) (i.e., 200KB), the packet is marked with ECN. Since ECN detects congestion based solely on the current queue length without considering whether the port received PAUSEs before, switches cannot distinguish between queue buildup caused by congestion and PAUSEs. Consequently, an uncongested port may be mistakenly regarded as congested.

In InfiniBand, periodic credit updates in CBFC also confuse congestion detection. InfiniBand switches detect congestion by combining credit information. They mark FECN when the queue length exceeds the queue threshold (i.e., 50KB) and the packet is not delayed due to lacking credit (i.e., not paused). However, as shown in Figure 3(b), partial packets of F0 and F2 are still marked with FECN at port P2, and partial packets of F2 are marked at port P1 (not shown in the figure). This is because IB CC overlooks the periodicity of credits in CBFC, leading to improper detection. Ports affected by hop-by-hop flow controls can also receive a few credits periodically, causing packets arriving after new credits to be perceived as having sufficient credits to send out, resulting in incorrect detection.

**Multiple Congestion Points Scenario:**
In this scenario, port P2 becomes the second congestion point besides port P3. F1 initially achieves 40Gbps, and bursts start at time 0. After the bursts start, F0 and F2 send at a constant 25Gbps. When F0 and F2 start, the rate of F1 drops below 15Gbps, so port P0 is never congested. The sending rate and queue length evolution for CEE and InfiniBand are depicted in Figures 4(c) and 4(d), and Figures 4(a) and 4(b), respectively.

Due to congestion spreading from port P3, the sending rate of port P2 alternates between ON and OFF until 1.6ms/4ms (CEE/InfiniBand), and the queue builds up. At the same time, port P2 is the other congestion point. After 1.6ms/4ms (CEE/InfiniBand), port P2 recovers to normal sending, indicating that congestion at port P3 is mitigated. However, port P2 still experiences persistent queue accumulation. Note that this differs from the single congestion point scenario, where the accumulated queue at port P2 is drained out. The sending rate drops to 10Gbps after congestion at port P3 disappears (see Figures 3(c) and 3(d)). Ideally, switches should detect congestion when the sending rate alternates between ON and OFF. However, we observe that whether congestion occurs at a port with an ON-OFF sending pattern may be indeterminate. As illustrated in Figures 3(a) and 4(a), the queue length evolutions are the same from 1.0ms to 1.5ms in CEE. Similarly, the queue length evolutions in InfiniBand are the same from 2.6ms to 4ms in Figures 3(b) and 4(b).

The ON-OFF regulation of hop-by-hop flow controls masks the real input rate. Hop-by-hop flow controls propagate upstream, and once PAUSEs/no credits reach the upstream switches, the sending rate of the upstream ports is regulated to an ON-OFF pattern. When upstream ports receive RESUME/credits, previously accumulated packets are sent out at line rate immediately. From the switch’s perspective, even if the real input rate differs, the incoming traffic rate appears as line rates in a specific time scale. Thus, the ON-OFF arriving pattern may induce the same queue length evolutions.

**Summary:**
Our detailed observations and analysis reveal that existing congestion detection mechanisms fail to recognize the impact of ON-OFF sending patterns, leading to inaccurate congestion detection results in lossless networks like CEE and InfiniBand. Closer inspection of ports with ON-OFF sending patterns shows that a port may have the same queue length evolution and sending pattern, but the actual congestion state varies.

#### 3.2 Understanding Port States in Lossless Networks
**3.2.1 Definition of Ternary States:**
Based on our observations in § 3.1, we define ternary states of switch ports in lossless networks as follows:

- **Non-congestion (0):** The port is persistently ON and without queue buildup.
- **Congestion (1):** The port is persistently ON, with the output rate at full rate and queue buildup not caused by OFF. For example, in the two scenarios in § 3.1, port P3 is the congestion port with a full output rate, and the accumulated queue is solely due to congestion.
- **Undetermined (/):** The output rate is in an ON-OFF style. In the two scenarios in § 3.1, ports P0, P1, and P2 are in the undetermined state. The port may have queue buildup, but the cause of the queue buildup is ambiguous. For instance, in the single congestion point scenario, the queue buildup in ports P0, P1, and P2 is due to receiving PAUSEs/no credits. In the multiple congestion points scenario, the queue buildup in port P2 is attributed to excessive input traffic.

The undetermined state is a new state in traditional lossy networks due to the ON-OFF regulation of hop-by-hop flow controls. Generally, assume a port outputs freely at the maximum rate initially. Once the port is paused due to receiving PAUSEs/no credits, it enters the undetermined state. The sending rate is regulated to an ON-OFF pattern. During each OFF period, the port is pausing, and all arriving packets are queued. During each ON period, the port sends at the full rate, dequeuing the accumulated packets. Packets may arrive at any moment during the undetermined state. Finally, the port recovers to a continuous ON pattern and leaves the undetermined state. After leaving the undetermined state, a port may transition to a non-congestion or congestion state.

**State Transitions from the Undetermined State:**
To further elaborate on the port states after a port leaves the undetermined state, we use the example of congestion trees and discuss port states under typical scenarios of multiple congestion trees, as shown in Figure 5.

1. **Isolated:** Two congestion trees coexist in the network without overlapping leaves or roots. The roots are in the congestion state. If one congestion tree disappears, the leaves transition from the undetermined state to the non-congestion state, and the root transitions from the congestion state to the non-congestion state. In the single congestion point scenario (§ 3.1.2), port P2 recovers to a non-congestion port after congestion spreading is eliminated.
2. **Overlapped:** Two congestion trees have overlapping leaves but different roots. The roots of congestion trees \(a\) and \(b\) are in the congestion state. If one congestion tree disappears first, the overlapping leaves remain undetermined, while non-overlapping leaves transition to the non-congestion state.
3. **Covered:** This is a more complex case adopted in the multiple congestion points scenario (§ 3.1.3). A deeper congestion tree \(a\) covers another congestion tree \(b\). The root of congestion tree \(b\) is also a leaf of congestion tree \(a\). In the multiple congestion points scenario, port P2 is the covered root, and port P3 is the root of a deeper congestion tree. The covered root of congestion tree \(b\) is in an undetermined state. After congestion tree \(a\) disappears, the covered root of congestion tree \(b\) emerges, transforming into a congestion port.

The goal of congestion detection in lossless networks is to identify congestion ports in switches. Congestion ports are the roots of congestion trees, where flows passing through them are the primary causes of congestion. The leaves of congestion trees are in an undetermined state.