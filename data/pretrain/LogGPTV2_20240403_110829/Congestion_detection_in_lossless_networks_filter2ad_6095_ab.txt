both limited in CEE switches and InfiniBand switches. In essence,
PFC and CBFC function in the same way to avoid buffer overflow:
the switch ports alternate between sending (ON) and pausing (OFF).
If the port is pausing (OFF), the subsequent packets are queued to
wait for available buffer space at the downstream switch.
3 OBSERVATIONS AND INSIGHTS
When hop-by-hop flow controls take effect (which is inevitable in
lossless networks), the alternation between ON and OFF of switch
ports may impose unexpected problems on congestion detection
behaviors in switches. In this section, we conduct fine-grained
simulations in a single congestion point scenario and multiple con-
gestion points scenario to investigate the interaction issue between
hop-by-hop flow controls and congestion detection.
3.1 Experimental Observations
Simulations setup. We adopt a topology as shown in Figure
3.1.1
2, which is a common unit in today‚Äôs multi-rooted topologies (Fat-
Tree [9], Leaf-Spine [11]). All links are 40Gbps with 4ùúás propagation
delay. S1 sends long-lived flow F1 to R1. A0-A14 send concurrent
64KB bursts to R1. Assume F1 achieves 40Gbps at the beginning
371
Congestion Detection in Lossless Networks
SIGCOMM ‚Äô21, August 23‚Äì27, 2021, Virtual Event, USA
(a) [CEE] P2
(b) [InfiniBand] P2
(a) [CEE] P2
(b) [Infiniband] P2
(c) [CEE] P2
(d) [InfiniBand] P2
(c) [CEE] P2
(d) [InfiniBand] P2
Figure 3: Single congestion point scenario. Queue length and
sending rate.
Figure 4: Multiple congestion points scenario. Queue length
and sending rate.
of the simulation. In both single congestion point and multiple
congestion points scenarios, bursts launch at time 0 and last for
about 3ms. After bursts start, long-lived flow F0 and F2 send at a
constant rate to R0 simultaneously. The bursts cannot be controlled
by end-to-end congestion controls since the size is smaller than
Bandwidth Delay Product (BDP). ECN (DCQCN [56]) and FECN
(IB CC [13]) is the congestion detection mechanism in CEE and
InfiniBand switches, respectively. The CC parameters are the rec-
ommended values in the literature [22, 56], and details are given
in ¬ß 5.2. For CEE, the PFC threshold is 320KB. For InfiniBand, the
ingress buffer size is 280KB.
Single congestion point scenario. In this scenario, port P3 is
3.1.2
the only congestion point. F1 achieves 40Gbps at the beginning of
the simulation and bursts launch at time 0. After bursts start, F0
and F2 send at constant 5Gbps. The rate of F1 has decreased below
15Gbps when F0 and F2 start, so port P0 is never congested. During
bursts launching, the ideal bandwidth allocation of F1 is about 2.5
Gbps. Figure 3(a) and Figure 3(b) illustrate the queue length and
marked packets at port P2 for CEE and InfiniBand.
For ports P0, P1 and P2, each input rate does not exceed the
line rate. Hence, the three ports should not detect the presence
of congestion. However, due to congestion spreading from port
P3, three ports are paused intermittently. With constant input rate
5Gbps of F0 and F2, port P2 has a maximum queue length of over
500KB. As shown in Figure 3, both ECN and FECN detect congestion
improperly at port P2. F0 is mistakenly marked with ECN at ports
P2, although ports P2 is not the congestion point. Meanwhile, the
congested flow F1 should only be marked with ECN at port P3.
While partial packets of F1 are marked with ECN at ports P2, even
it is not the real bottleneck. We omit the results at ports P1 and P0
as the marking behavior is similar.
In CEE, queue-based congestion detection alone is essen-
tially inadequate. In lossy networks, generally, congestion is de-
tected when switch ports have queue buildup. However, when PFC
takes effect in CEE, a port will receive PAUSEs intermittently, which
may also lead to queue buildup. With dequeue marking [49, 54],
CEE switches check the queue size and mark ECN when each packet
dequeues. If the current egress queue length exceeds a threshold
ùêæùëöùëéùë• (i.e., 200KB), the packet is marked with ECN. Because ECN
detects congestion solely based on current queue length without
considering whether the port receives PAUSEs before, switches
can not distinguish between queue buildup caused by congestion
and PAUSEs. As a result, an uncongested port may be mistakenly
regarded as a congested port.
In InfiniBand, periodical updated credits of CBFC also con-
fuse congestion detection. In InfiniBand, switches detect conges-
tion combining credit information. Switches mark FECN when the
queue length exceeds the queue threshold (i.e., 50KB) and the packet
is not delayed due to lacking credit (i.e., not paused). However, as
shown in Figure 3(b), partial packets of F0 and F2 are still marked
with FECN at ports P2. Partial packets of F2 are marked at ports
P1 (not shown in the figure). This is because IB CC overlooks the
periodicity of credits in CBFC, which may mislead congestion de-
tection. The ports affected by hop-by-hop flow controls can also
receive a few credits periodically. Packets arriving after the arrival
of new credits may be perceived to have sufficient credits to send
out, resulting in improper detection behaviors.
3.1.3 Multiple congestion points scenario. In this scenario, port P2
becomes the second congestion point besides port P3. F1 achieves
40Gbps at the beginning of the simulation and bursts launch at time
0. After bursts start, F0 and F2 send at constant 25Gbps. When F0
and F2 start, the rate of F1 has decreased below 15Gbps, so port
P0 is never congested. For CEE and InfiniBand, the sending rate of
port P2 is depicted in Figure 4(c) and Figure 4(d), respectively. The
queue length evolution is demonstrated in Figure 4(a) and Figure
4(b), respectively.
Due to congestion spreading from port P3, the sending rate of
port P2 alternates between ON and OFF till 1.6ms/4ms (CEE/InfiniBand),
372
SIGCOMM ‚Äô21, August 23‚Äì27, 2021, Virtual Event, USA
Yiran Zhang, Yifan Liu, Qingkai Meng, Fengyuan Ren
and the queue builds up. At the same time, port P2 is the other con-
gestion point. After 1.6ms/4ms (CEE/InfiniBand), port P2 recovers
to send normally, which indicates that congestion at port P3 is mit-
igated. Afterward, port P2 still has persistent queue accumulation.
Note that this is different from the single congestion point scenario,
where the accumulated queue at port P2 is drained out. The send-
ing rate drops to 10Gbps after congestion at port P3 disappears
(see Figure 3(c) and Figure 3(d)). Ideally, switches should be able to
detect congestion when the sending rate alternates between ON
and OFF. However, we observe that whether congestion happens
at a port with an ON-OFF sending pattern may be unknowable. As
illustrated in Figure 3(a) and Figure 4(a), the queue length evolu-
tions are the same from 1.0ms to 1.5ms in CEE. Similarly, the queue
length evolutions in InfiniBand are the same from 2.6ms to 4ms in
Figure 3(b) and Figure 4(b).
The ON-OFF regulation of hop-by-hop flow controls masks
the real input rate. Hop-by-hop flow controls are endowed with
the propagation property. Once PAUSEs/no credits propagate to
the upstream switches, the sending rate of the upstream ports is
regulated to an ON-OFF pattern. Concretely, when upstream ports
receive RESUME/credits, previously accumulated packets are sent
out at line rate immediately. From the switch‚Äôs view, even the real
input rate is different, the incoming traffic rate is both line rates in
a specific time scale. As a result, the ON-OFF arriving pattern may
induce the same queue length evolutions.
Summary: Our detailed observations and analysis reveal that
existing congestion detection mechanisms fail to cognize the im-
pact of ON-OFF sending patterns, leading to inaccurate congestion
detection results in lossless networks, such as CEE and InfiniBand.
A closer observation on the port with an ON-OFF sending pattern
tells that a port may have the same queue length evolution and
sending pattern, but the real congestion state is diverse.
3.2 Understanding Port States in Lossless
Networks
3.2.1 Definition of ternary states. Based on our observations in
¬ß 3.1, we define ternary states of switch ports in lossless networks
as follows:
‚Ä¢ Non-congestion (0): The port is persistently ON and without
queue buildup.
‚Ä¢ Congestion (1): The port is persistently ON. The output rate
is at full rate with queue buildup not caused by OFF. For instance,
in two scenarios in ¬ß 3.1, port P3 is the congestion port with full
output rate. The accumulated queue is solely caused by congestion.
‚Ä¢ Undetermined (/): The output rate is in an ON-OFF style. In
two scenarios in ¬ß 3.1, ports P0, P1 and P2 are in the undetermined
state. Note that the port may have queue buildup, but the cause of
queue buildup is ambiguous. For instance, in the single congestion
point scenario, the queue buildup in ports P0, P1 and P2 is owing
to receiving PAUSEs/no credits. In the multiple congestion points
scenario, the queue buildup in port P2 is also attributed to the
excessive input traffic.
The undetermined state is a brand-new state as to traditional
lossy networks due to the ON-OFF regulation of hop-by-hop flow
controls. Generally, assume a port outputs freely with a maximum
rate of the full rate in the beginning. Once the port is paused due
(cid:2)(cid:10)(cid:10)(cid:13) (cid:10)(cid:6) (cid:4)(cid:10)(cid:9)(cid:7)(cid:5)(cid:12)(cid:13)(cid:8)(cid:10)(cid:9) (cid:13)(cid:11)(cid:5)(cid:5)
(cid:1)(cid:5)(cid:3)(cid:6) (cid:10)(cid:6) (cid:4)(cid:10)(cid:9)(cid:7)(cid:5)(cid:12)(cid:13)(cid:8)(cid:10)(cid:9) (cid:13)(cid:11)(cid:5)(cid:5)
(cid:13)(cid:11)(cid:5)(cid:5) (cid:1)
(cid:13)(cid:11)(cid:5)(cid:5) (cid:2)
(cid:13)(cid:11)(cid:5)(cid:5) (cid:1) (cid:13)(cid:11)(cid:5)(cid:5) (cid:2)
(cid:13)(cid:11)(cid:5)(cid:5) (cid:1)
(cid:13)(cid:11)(cid:5)(cid:5) (cid:2)
(cid:2)(cid:7)(cid:3) (cid:5)(cid:16)(cid:13)(cid:12)(cid:7)(cid:17)(cid:11)(cid:10)
(cid:2)(cid:8)(cid:3) (cid:6)(cid:18)(cid:11)(cid:15)(cid:12)(cid:7)(cid:14)(cid:14)(cid:11)(cid:10)(cid:1)
(cid:2)(cid:9)(cid:3) (cid:4)(cid:13)(cid:18)(cid:11)(cid:15)(cid:11)(cid:10)(cid:1)
Figure 5: Congestion trees in lossless networks.
to receiving PAUSEs/no credits, it enters the undetermined state.
The sending rate is regulated to an ON-OFF pattern. During each
OFF period, the port is pausing, and all arriving packets are queued.
During each ON period, the port sends at the full rate, dequeuing the
accumulated packets. Note that packets may arrive at any moment
during the undetermined state. Finally, the port recovers to send
packets in a continuous ON pattern and leaves the undetermined
state. After releasing from the undetermined state, a port may
transform to a non-congestion or congestion state.
State transitions from the undetermined state. To further elab-
3.2.2
orate on the port states after a port leaves the undetermined state,
we use the example of congestion trees and discuss port states
under typical scenarios of multiple congestion trees, as shown in
Figure 5.
(1) Isolated. Two congestion trees coexist in the network with-
out overlapped leaves or roots. The roots are in the congestion
state. If any congestion tree disappears, the leaves transit from
the undetermined state to the non-congestion state, and the root
transits from the congestion state to the non-congestion state. In
the single congestion point scenario (¬ß 3.1.2), port P2 recovers to a
non-congestion port after congestion spreading is eliminated.
(2) Overlapped. Two congestion trees have overlapped leaves
but with different roots. Roots of congestion tree ùëé and congestion
tree ùëè are in the congestion state. If one congestion tree disappears
first, the overlapped leaves are still undetermined. Non-overlapped
leaves will transit to the non-congestion state.
(3) Covered. This is a sophisticated case that is adopted in the
multiple congestion points scenario (¬ß 3.1.3). A deeper congestion
tree ùëé covers another congestion tree ùëè. The root of congestion
tree ùëè is also a leaf of congestion tree ùëé. In the multiple congestion
points scenario, port P2 is the covered root. Port P3 is the root of
a deeper congestion tree. The covered root of congestion tree ùëè
is in an undetermined state. After congestion tree ùëé disappears,
the covered root of congestion tree ùëè emerges, transforming into a
congestion port.
The goal of congestion detection in lossless networks is to de-
tect congestion ports in switches. Congestion ports are roots of
congestion trees, where flows passing through them are the real
culprits of congestion. The leaves of congestion trees are in an