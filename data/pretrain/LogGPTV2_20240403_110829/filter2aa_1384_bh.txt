Next, create a new window by pressing Ctrl-b and then c. Go ahead and rename that
window as well.
246
APPENDIX B
Essential Linux commands
B.2.2
Saving a tmux session
Now suppose you need to walk away from a session. Instead of clicking the close but-
ton on the terminal, you can use the tmux detach command, which is Ctrl-b d. You
should get output similar to the following:
[detached (from session0)]
You’re also placed back at an ordinary bash prompt. You can now close the terminal.
After you return, you can open a new terminal and type tmux ls. This will display
something like the following, which shows you that the session has two active windows
and a single tmux session with an ID of 0 and also gives the date/time it was created:
0: 2 windows (created Thu Apr 18 10:03:27 2019) [105x12]
This output even tells you the character array or size of the session, which in my case is
105 × 22. As an example, I can attach to this tmux session by typing tmux a -t 0,
where a means attach, -t means target session, and 0 is the session ID. If the com-
mand tmux ls displays multiple sessions, you can replace the 0 in the previous com-
mand with the numeric ID of the specific tmux session you want to attach to.
 Finally, the simple yet awesome ability of tmux to attach multiple users to a session
at the same time may be less important to you right now, but will become handy in the
future if you find yourself working collaboratively on a pentest with multiple consul-
tants. This means you and a friend can share the same session and attack the same tar-
get from different terminals. If that isn’t cool, I don’t know what is!
247
appendix C
Creating the Capsulecorp
 Pentest lab network
This appendix serves as a brief, high-level guide to setting up your testing environ-
ment, which closely mirrors the Capsulecorp Pentest environment that I built for
the purposes of writing this book. It is not meant to be a lengthy step-by-step guide
showing you how to create a replica of the environment, because it is not necessary
for you to have a replica to practice the techniques used in this book.
 The only details you need to concern yourself with are the vulnerabilities and
attack vectors present on each system, rather than a play-by-play tutorial with
screenshots for every dialog box. Going that route would be an entire book all by
itself. Instead, I will provide a high-level explanation like “Create a Windows Server
2019 virtual machine, join it to the domain, and install Apache Tomcat with a weak
password for the admin user account.” Of course, I will provide links to external
resources, including software and OS downloads and setup guides. 
NOTE
To be honest, I think you would benefit more from creating a unique
environment, and I encourage you to come up with a mock enterprise. Every
company’s network is different. If you’re going to do network penetration
testing regularly, you need to get used to navigating new environments.
The Capsulecorp Pentest lab network was designed to have all the basic compo-
nents that you would find in 90% of enterprise networks today:
 An Active Directory domain controller
 Windows and Linux/UNIX servers joined to the domain
 Workstations joined to the domain
 Database services
248
APPENDIX C
Creating the Capsulecorp Pentest lab network
 Web application services
 An email server, most likely Microsoft Exchange
 Remotely accessible file shares
The details regarding which server has what OS and which services installed on it are
less important. Also, the size (the number of systems) of your virtual lab network is
arbitrary and up to the limitations of your hardware. I could have taught every tech-
nique used in this book with as few as three or four virtual systems. So, if you read this
appendix and find yourself worrying about how you’re going to afford a brand-new
lab server with 1 TB of disk space, a quad-core i7 CPU, and 32 GB of RAM, don’t. Just
use whatever you have. Even VMware Player on a laptop running three VMs can work
as long as you set up all the necessary components in the previous list. That said, if you
want to buy a brand-new box and set up a close-to-exact replica of the Capsulecorp
Pentest environment, this appendix shows you how to do it.
C.1
Hardware and software requirements
The Capsulecorp Pentest virtual lab network was built using a single physical server
running VMware ESXi. I made this choice completely because of my personal prefer-
ences. There are many different options for setting up a virtual lab environment, and
you shouldn’t feel compelled to alter your practices if you’re used to using a different
hypervisor. 
 The network consists of 11 hosts, 6 Windows servers, 3 Windows workstations, and
2 Linux servers. The hardware specifications are listed in table C.1. 
Table C.1
Hardware specifications for the Capsulecorp Pentest virtual lab network
Server hardware specifications
Server
Intel NUC6i7KYK
Processor
Quad-core i7-6770HQ
Memory
32 GB DDR4
What if I’ve never set up a virtual network?
Before moving on, I want to be clear about something. I’m making the assumption
that you have experience setting up virtual network environments. If you have never
done this before, then this appendix might be more confusing than it is helpful. If
that’s the case, I recommend that you pause here and do some research about build-
ing virtual networks. An excellent resource that I recommend is the book Building Vir-
tual Machine Labs: A Hands-On Guide by Tony Robinson (CreateSpace, 2017). 
You could also buy a premade environment. Or rather, you could pay a monthly sub-
scription to have access. Offensive Security and Pentester Academy are two great com-
panies that offer, among other services, preconfigured vulnerable virtual networks that
you can use to test your pentesting and ethical hacking skills for a reasonable price.
249
APPENDIX C
Creating the Capsulecorp Pentest lab network
I used evaluation versions for the Windows systems. Evaluation versions of Microsoft’s
OS ISOs can be obtained from Microsoft’s software download site at www.micro-
soft.com/en-us/software-download. They are free to use, and I recommend using the
ISO version to create new VMs. Table C.2 shows the hosts I created and the OSs I used
to create them.
As you can see from the server utilization graph in figure C.1, the Capsulecorp network
was not fully utilizing my physical server’s CPU and memory, so I probably could have
used a less expensive system. This is something to consider if you are on a tight budget.
Storage
1 TB SSD
Hypervisor
VMware ESXi 6.7.0
Table C.2
Host OSs for the Capsulecorp Pentest virtual lab network
Hostname
IP address
Operating system
Goku
10.0.10.200
Windows Server 2019 Standard Evaluation
Gohan
10.0.10.201
Windows Server 2016 Standard Evaluation
Vegeta
10.0.10.202
Windows Server 2012 R2 Datacenter Evaluation
Trunks
10.0.10.203
Windows Server 2012 R2 Datacenter Evaluation
Raditz
10.0.10.207
Windows Server 2016 Datacenter Evaluation
Nappa
10.0.10.227
Windows Server 2008 Enterprise
Krillin
10.0.10.205
Windows 10 Professional
Tien
10.0.10.208
Windows 7 Professional
Yamcha
10.0.10.206
Windows 10 Professional
Piccolo
10.0.10.204
Ubuntu 18.04.2 LTS
Nail
10.0.10.209
Ubuntu 18.04.2 LTS
Table C.1
Hardware specifications for the Capsulecorp Pentest virtual lab network (continued)
Server hardware specifications
Figure C.1
ESXi host server CPU, memory, and storage utilization
250
APPENDIX C
Creating the Capsulecorp Pentest lab network
It worked best for me to create all the base VMs first. That is, I allocated the virtual
hardware, CPU, RAM, disk, and so on for each system and then installed the base OS.
Once the base OS setup is complete, be sure to take a snapshot of each system so you
have something to revert to if you get into trouble while configuring the software and
services for a particular machine. Once all your systems are built, you can begin cus-
tomizing the individual components of your lab network, beginning with the Active
Directory domain controller. After you’ve created all of your VMs, you should have
something similar to the graphical depiction in figure C.2.
C.2
Creating the primary Windows servers
This section explains important details about each individual Windows server’s config-
uration, including which services I installed and how each service was configured inse-
curely. Once again, this appendix does not include detailed step-by-step installation
instructions for individual applications such as Apache Tomcat and Jenkins. Instead, I
provide a high-level summary of a specific host and include links to external resources
and installation guides. 
 For each VM, use the OS listed in table C.2 for that machine. Any important details
related to a specific host’s configuration are listed in the sections that follow. You
shouldn’t worry too much about the specifications of virtual systems; use what you have.
In my case, as a general practice, I gave each VM 50 GB of virtual disk space, two virtual
CPU cores, 4 GB of RAM for Windows systems, and 1 GB of RAM for Linux systems.
C.2.1
Goku.capsulecorp.local
Goku is the domain controller for the Capsulecorp network. Follow the standard Mic-
rosoft documentation for promoting this machine to a domain controller. Due to the
best practice recommendations when creating an Active Directory environment, you
should set up the domain controller first. When asked to choose a root domain name,
you can choose whatever you like. If you wish to mimic my setup, use capsule-
corp.local; and for the NetBIOS domain name, use CAPSULECORP. 
Windows servers
Goku
Tien
Krillin
Yamcha
Piccolo
Nail
Gohan
Vegeta
Trunks
Raditz
Nappa
Windows workstations
Linux servers
Figure C.2
Overview of the systems in the Capsulecorp Pentest environment
251
APPENDIX C
Creating the Capsulecorp Pentest lab network
 All other virtual hosts in the Capsulecorp network should be joined to the CAP-
SULECORP Active Directory domain. For Windows systems, follow the official Micro-
soft documentation for joining a computer to a domain. For Linux systems, I followed
the Ubuntu documentation using sssd. There are also dozens of video tutorials on
YouTube that can help you if you get stuck with this part. Here are some other
resources:
 Microsoft TechNet, promoting Windows Server 2019 to a domain controller:
https://gallery.technet.microsoft.com/Windows-Server-2019-Step-4c0a3678
 Microsoft Docs, joining Windows servers to a domain: https://docs.microsoft.com/
en-us/windows-server/identity/ad-fs/deployment/join-a-computer-to-a-domain
 Ubuntu Server Guide, joining Ubuntu servers to a domain: https://help.ubuntu
.com/lts/serverguide/sssd-ad.html
I created several Active Directory domain and local accounts for various reasons, just
as is the case with a modern enterprise network. Table C.3 lists the usernames and
passwords that I used. Feel free to come up with different user accounts with other
passwords. 
C.2.2
Gohan.capsulecorp.local
Gohan is running Microsoft SQL Server 2014. Download the setup files from the Mic-
rosoft download center. Set up MSSQL Server with a weak password on the sa user
account. In the example demonstrated in chapters 4 and 7, the password for the sa
account is Password1. Resources:
 MSSQL 2014 download page: https://www.microsoft.com/en-us/download/
details.aspx?id=57474
 MSSQL 2014 setup guide: https://social.technet.microsoft.com/wiki/contents/
articles/23878.sql-server-2014-step-by-step-installation.aspx
Table C.3
Domain user accounts and credentials
User account
Workgroup/Domain
Password
Administrator
Gokuadm
CAPSULECORP
Password265!
CAPSULECORP
Vegetaadm
CAPSULECORP
Password906^
VEGETA
Gohanadm
CAPSULECORP
Password715%
GOHAN
Trunksadm
CAPSULECORP
Password3210
TRUNKS
Raditzadm
CAPSULECORP
Password%3%2%1!!
RADITZ
piccoloadm
CAPSULECORP
Password363#
PICCOLO
Krillin
CAPSULECORP
Password97%
n/a
Yamcha
CAPSULECORP
Password48*
n/a
Tien
CAPSULECORP
Password82$
n/a
252
APPENDIX C
Creating the Capsulecorp Pentest lab network
C.2.3
Vegeta.capsulecorp.local
Vegeta is running a vulnerable instance of Jenkins. Download the Windows version of
the latest Jenkins setup package from the official Jenkins website, and follow the
installation instructions for setting up a basic vanilla Jenkins environment. Set up the
username as admin and the password as password. The Windows IIS service was
installed following the standard setup documentation from Microsoft. Nothing is run-
ning; this is just done to demonstrate what the service looks like to nmap during ser-
vice discovery. Resources:
 Jenkins download page: https://jenkins.io/download
 Jenkins setup page: https://jenkins.io/doc/book/installing
C.2.4
Trunks.capsulecorp.local
Trunks is running a vulnerable configuration of Apache Tomcat. Specifically, the
XAMPP project was used to set up Apache; however, it is just as possible to install
Apache Tomcat by itself. Use whichever you prefer. To mirror the Capsulecorp Pentest
environment, download the latest version of XAMPP for Windows and follow the
setup documentation. Configure the Apache Tomcat server with a weak set of creden-
tials such as admin/admin. Resources:
 XAMPP download page: www.apachefriends.org/index.html
 XAMPP Windows FAQ: www.apachefriends.org/faq_windows.html
 XAMPP Windows setup video: www.youtube.com/watch?v=KUe1iqPH4iM
C.2.5
Nappa.capsulecorp.local and tien.capsulecorp.local
Nappa does not require any setup or customization. Because the server is running
Windows Server 2008, by default it is missing the MS17-010 patch and is vulnerable to
the Eternal Blue exploit demonstrated in chapter 8. The same is true for Tien, which
is a workstation running Windows 7. By default, this host is also missing the MS17-010
patch from Microsoft. Often, during real-world pentests, exploiting a single worksta-
tion or server can lead to a domain admin-level compromise, which is discussed and
demonstrated in chapter 11. 
C.2.6
Yamcha.capsulecorp.local and Krillin.capsulecorp.local
These two systems are identical and are running Windows 10 professional. They do
not have any vulnerable configurations apart from being joined to the CAPSULE-
CORP domain, which is pretty insecure. These systems are optional but were included
to mirror real-world enterprise networks that contain user workstations with no viable
attack vectors.
C.3
Creating the Linux servers
There are two Linux servers, also joined to the CAPSULECORP domain. These serv-
ers are both running identical builds of Ubuntu 18.04. The purpose of these systems is
to demonstrate Linux post-exploitation. The particular means of compromise is not
253
APPENDIX C
Creating the Capsulecorp Pentest lab network
important, and neither is gaining initial access. Therefore, you can configure them in
any way you choose. My example configuration is as follows. 
 Server A (piccolo.capsulecorp.local) is running a vulnerable web application on
port 80. The web application is configured to run without root privileges, so once you
compromise piccolo, you have access but not root privileges. Somewhere in the web
directory is a configuration file with a set of MySQL credentials that have access to
Server B (nail.capsulecorp.local). On this server, MySQL is running with root privi-
leges. This type of configuration—where one system can be compromised but not
with root or admin-level privileges, which then leads to accessing another system with
root or admin—is quite common.
254