Lateral
 Movement
 Remote Desktop Protocol
 Description
 RDPis routinely used by your administrators, help desk, 
 or others it provides an attractive attack vector for 
 adversaries who are trying to blend in with standard 
 network activity. Once on a client system, the attacker 
 can simply leverage the built in Microsoft tools to allow 
 for remote access to other systems using RDP and 
 valid credentials
 An attacker can use the Microsoft Remote Desktop 
 Connection (mstsc.exe) tool to access a victim system. 
 While you hopefully are not exposing the default port 
 3389 to the Internet, port forwarding set
 up as a pivot on other, Internet accessible systems 
 does make this possible from either external or
 internal hosts
 Indicators
 Windows Event logs
 4624
 The logon event will show either a Type 10 or Type 3 
 when RDP is used, depending on the versions of 
 Windows used and their speciﬁc conﬁguration
 4778
 This event is logged when a session is reconnected to a 
 Windows station. This can occur locally when the user 
 context is switched via fast user switching. It can also 
 occur when a session is reconnected over RDP. To 
 diﬀerentiate between RDP versus local session 
 switching, look at the Session Name ﬁeld within the 
 event description. If local, the ﬁeld will contain Console, 
 and if remote, it will begin with RDP. For RDP sessions, 
 the remote host information will be in the Network 
 Information section of the event description
 4779
 This event is logged when a session is disconnected. 
 This can occur locally when the user context is 
 switched via fast user switching. It can also occur when 
 a session is reconnected over RDP. A full logoﬀ from 
 an RDP session is logged with Event ID 4637 or 4647 as 
 mentioned earlier. To diﬀerentiate between RDP versus 
 local session switching, look at the Session Name ﬁeld 
 within the event description. If local, the ﬁeld will 
 contain Console, and if remote, it will begin with RDP. 
 For RDP sessions, the remote host information will be 
 in the Network Information section of the event 
 description
 21, 22 or 25
 On the machine receiving the connection, additional 
 RDP speciﬁc logs may be found. The
 %SystemRoot%\System32\winevt\Logs\Microsoft-
 Windows-TerminalServicesLocalSessionManager%
 4Operational log may contain the IP address and logon 
 user name of the originating computer 
 Adversaries usually use tools such as plink.exe to 
 forward RDP traﬃc over SSH with a command line 
 containing 127.0.0.1:3389.  This helps adversaries 
 bypass ﬁrewalls restricting port 3389 and prevent 
 traﬃc inspection while being able to use RDP. This can 
 also work with numerous additional protocols
 SC (Service Controller)
 Description
 The Service Controller command, sc, is able to create, 
 stop, and start services. Services are processes that 
 run outside of the context of a logged-on user, allowing 
 them to start automatically at system boot time. By 
 running a process as a service, the malicious actor can 
 ensure persistence of the service on the system, 
 including allowing for automating restarting or other 
 actions should the process stop execution. Once again, 
 the sc command allows for these actions to be taken 
 on the local system or on remote
 systems with appropriate credentials
 Syntax
 To establish an initial, authenticated connection to a 
 remote system
 net use \\[targetIP] [password] /u:[Admin_User
 To create a service on the remote system
 sc \\[targetIP] create [svcname] binpath= [executable]
 Indicators
 Win Event Logs
 7045
 creation of a new service on the system, including the 
 path to the executable service ﬁle name. This event, 
 recorded in the System event log, can be useful in 
 identifying the creation of malicious services on victim 
 systems
 Registry
 HKLM\SYSTEM\CurrentControlSet\Services 
 When a service is created, the path to its associated 
 executable is stored in the registry. The ImagePath key 
 will specify the location of the associated executable 
 on disk for each service
 Any use of authenticated credentials to modify services 
 on remote systems will also leave the associated 
 account logon and logon events
 Windows services
 WinRM (Windows Remote Management)
 Description
 Allows for commands to be sent to remote Windows 
 computers over HTTP or HTTPS by leveraging the Web 
 Services for Management protocol. WinRM runs as a 
 service under the Network Service account, and as 
 native Microsoft components, use of these tools will 
 bypass many whitelisting solutions providing another 
 attractive option for attackers
 Attack vectors
 winrs
 Use of the Windows Remote Services command, winrs, 
 allows for execution of arbitrary commands on remote 
 systems
 Syntax
 winrs -r:http://target_host “cmd”
 Indicators
 Network
 Unusual activity on TCP port 5985 for HTTP traﬃc and 
 TCP port 5986 for HTTPS
 Windows Event Log
 6
 When a connection is initiated using WinRM. This event 
 will include the remote destination to which the 
 connection was attempted. Therefore, the appearance 
 of Event ID 6 onmlocal workstations or other 
 computers where administrative tasks are not 
 frequently done may be suspicious
 91
 will be logged on the system where the connection is 
 received. This log will include the user ﬁeld which 
 shows the account used to authenticate the 
 connection. Once again, the standard account logon 
 and logon events can also be leveraged to help ﬁll in 
 additional gaps regarding the systems, accounts, and 
 times involved in such activity
 WMI (Windows Management Instrumentation)
 Description
 Windows Management Instrumentation (WMI) is a 
 Microsoft-provided platform for simplifying
 administrative tasks. Use of WMI requires that 
 authenticated access be made to the target system, so 
 account logon and logon events may provide
 a useful indicator of suspicious activity. WMIC does not 
 encrypt its network traﬃc when run against a
 remote system, making network security monitoring a 
 viable approach to detect malicious use of WMIC
 Indicators
 %SystemRoot%\wbem\Repository
 An oﬄine image, WMI subscriptions are stored in the 
 WMI database, located here, which can be parsed using 
 the open-source python-cim tool
 Windows DCOM 
 Description
 DCOM may be used for lateral movement: using users 
 with high privileges, and attacker can remotely obtain 
 shellcode execution through Oﬃce applications as well 
 as other Windows objects that contain insecure 
 methods, or execute macros in existing documents
  DDE execution can be directly invoked through 
 a COM created instance of a Microsoft 
 Oﬃce application, bypassing the need for a malicious 
 document
 Indicators
 An executed command is run as a child process of 
 mmc.exe
 An executed command is run as a child process of 
 Excel
 Object creation is handled by the DCOMLaunch service. 
 This service is implemented in the rpcss.dll library and 
 can be identiﬁed with the "C:\WINDOWS\system32\
 svchost.exe -k DcomLaunch" command line. 
 Unlike most other methods, ShellWindows does not 
 create a process. Instead, it activates the class 
 instance inside of an existing explorer.exe process, 
 which executes child processes quite regularly. To 
 communicate, the host explorer.exe opens a listening 
 socket on a DCOM port, which should clearly ﬂag this 
 technique. An explorer.exe process with a listening 
 socket should raise your suspicion regardless of this 
 method.
 An  addon is run as a direct child process of Visio.
 VBE7.dll and ScrRun.dll are loaded into the Visio 
 process
 A command is run as a direct child process of Outlook
 An Excel process loads an unknown DLL
 A Word process loads an unknown library with the WLL 
 extension
 The ScriptControl object is implemented in msscript.
 ocx and is seldom used, and an instance of Outlook 
 which loads this legitimately is an extremely rare 
 phenomenon. Additionally, either jscript.dll or vbscript.
 dll are loaded to run the script itself
 Registry
 The VBA Engine model in Oﬃce is normally inaccesible 
 programmaticaly and needs to be enabled through the "
 Trust Access to Visual Basic Project" option in the 
 properties menu of every application
 This can also be done via the "HKCU\Software\
 Microsoft\Oﬃce\\\Security\accessVBOM" value in the registry for 
 every relevant Oﬃce application. Setting these values 
 to 1 remotely (via WMI, for example) allows for the 
 injection and execution of VBA macros into Excel, 
 Word, PowerPoint and Access without supplying a 
 payload carrying document ﬁle ﬁrst
 at/schtasks
 Description
 Malicious attackers can leverage the built-in Windows 
 at and schtasks commands to both expand their 
 inﬂuence and maintain persistence within a victim 
 environment
 Syntax
 at [\\targetIP] [HH:MM][A|P] [command]
 schtasks /create /tn [taskname] /s [targetIP] /u [user] /
 p [password] /sc [frequency] /st [starttime] /sd [
 startdate] /tr [command]
 Indicators
 On the system where the task is scheduled, additional 
 details can be found in the
 %SystemRoot%\System32\Tasks folder
 Each task created with schtasks creates an XML ﬁle 
 with the same name as the task in this location. Within 
 these XML ﬁles a number of ﬁelds are useful. Under the 
 “RegistrationInfo” section, the “Author” ﬁeld shows the 
 account used to schedule the task and the “Date” ﬁeld 
 shows the local system date and time when the task 
 was registered. In the “Principals”
 section, the “UserID” ﬁeld shows the user context under 
 which the task will execute. The Triggers
 section provides details on when the task will run and 
 the Exec ﬁeld under the Actions section details
 what will be run.
 PsExec
 Description
 Administration tool that leverages SMB to remotely 
 execute commands on other systems. While not a 
 native Windows binary, it is provided by Sysinternals, so 
 ﬁnding it running inside a network may not be unusual. 
 The command allows remote execution of programs 
 over an encrypted network connection when provided 
 with the necessary credentials. If the executable to be 
 run is not already on the target system, it can be copied 
 by psexec to the target and then executed
 Syntax
 psexec \\[targetIP] [-d] [-e] [-u user] [–p password] [
 command]
 WARNING !
 By default, the Sysinternals version of psexec will also 
 install itself as a service with a service name of
 PSEXESVC and an associated executable of psexesvc.
 exe written to disk
 Metasploit psexec module
 Requires a valid credential to access the remote 
 system, but can accept either a cleartext password or a 
 password hash representation to facilitate pass-the-
 hash attacks. In the absence of a valid credential, the 
 module will attempt to logon as Guest
 Similar services
 CSExec