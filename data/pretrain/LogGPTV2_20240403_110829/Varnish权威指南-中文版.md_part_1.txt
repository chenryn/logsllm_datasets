1
www.linuxidc.com
Varnish Documentation
Version：varnish-2.1.3 released
http://varnish-cache.org/docs/2.1/
文档版本varnish-cn.0.9-bate
译者：andy.feng
网名：fh.cn
Email：PI:EMAIL
目录
Varnish Documentation ......................................................................................................... 2
关于本手册 ............................................................................................................................... 3
一、Varnish 安装 ..................................................................................................................... 4
●安装varnish .......................................................................................................................... 4
●通过源码包编译安装 ........................................................................................................... 5
●获得支持 ............................................................................................................................... 6
●提交BUG .............................................................................................................................. 6
二、varnish指南 ...................................................................................................................... 7
●Backend servers(后端服务器) .............................................................................................. 7
●Starting Varnish（启动varnish） ........................................................................................ 8
●Logging in varnish（记录数据） .......................................................................................... 8
●PutVarnish on port 80(使varnish工作在80端口上) ......................................................... 9
●Varnish Configuration Language - VCL（varnish配置语言-VCL） ....................................... 9
●Statistics（统计varnish相关数据） ................................................................................. 12
●Achiveving a high hitrate（提高缓存命中率） ................................................................. 12
●advanced backend configuration（后端服务器高级配置） ............................................. 18
●Directors .............................................................................................................................. 19
●Health checks(健康检查) .................................................................................................... 19
●Misbehaving servers（服务器停止运转） ........................................................................ 20
●advanced topics（重要的话题） ....................................................................................... 21
●Troubleshooting varnish（varnish排错） ......................................................................... 22
三、Varnish参考手册 ............................................................................................................ 23
●VCL（varnish configuration language） ............................................................................. 23
●varnishadm .......................................................................................................................... 35
2
www.linuxidc.com
●varnishd ............................................................................................................................... 36
●varnishhist（varnish请求图） .......................................................................................... 43
●varnishlog（varnish日志） ............................................................................................... 44
●varnishncsa（以NCSA的格式显示日志） ....................................................................... 47
●varnishreplay ....................................................................................................................... 48
●varnishsizes（请求SIZE图） ............................................................................................. 49
●varnishstat ........................................................................................................................... 50
●varnishtest ........................................................................................................................... 51
●varnishtop ........................................................................................................................... 51
●shared memory logging and statistics ................................................................................. 52
四、Frequently ask questions（F@Q） ................................................................................. 53
●GENERAL QUESTIONS .......................................................................................................... 53
●How…… ................................................................................................................................ 53
●where…… ............................................................................................................................. 55
●Can I …… .............................................................................................................................. 55
●Why…… ................................................................................................................................ 56
●排错..................................................................................................................................... 57
●HTTP .................................................................................................................................... 57
●Configuration....................................................................................................................... 58
●Logging ................................................................................................................................ 59
●Varnish Glossary(varnish术语) ........................................................................................... 59
关于本手册
本手册由andy.feng于2010/6月初开始翻译，使用的是最新版本的官方文档和最新的软
件包为基准，由于2.0.6版本后，varnish做了很大改动，包括一些设计理念，VCL配置文件
语法等，和以前的版本出现了一些不可兼容性。而且 varnish 团队也保证以后不会出现这种
大规模的改动。
感谢：我要感谢我的女朋友 mandy.gu，对我工作的支持和谅解（因为花费了很多陪她
的时间）。还要感谢公司老大，boyod.yang的支持，以及朋友刘东林，彬帅。感谢松涛为PDF
做的封面，以及“varnish 中文项目”QQ 群和很多 IT 朋友的帮助与支持，最后还要感谢
51cto.com的管理员们的支持和推广。
申明：这是我第一次翻译英文技术文档，一个是官方手册本来有一些病句和错误的单词，
以及错误的代码。另外就是一些术语我也没法理解，所以翻译有误，或者不能看懂的情况下
情参照官方文档。当然也欢迎你对此文档提出修改意见。我会整理后发，发布修订版，相信
有您的参与，varnish会给更多中国IT人带来福音。
版本规定：
version-0.8 翻译首搞（已完成）
version-0.9 译者校对（已完成）
version-1.0-beta 此版本为当前文档版本，文档还不完善，请大家把发现的问题发送到
3
www.linuxidc.com
指定bug收集处，我会整理发布release版本。
本文章指定问题反馈和拍砖地址：http://linuxguest.blog.51cto.com/195664/354889
version-1.0-release 网友反馈，更新到文档中（进行中）
Andy.feng 2010/9/2
欢迎阅读 varnish’s 中文文档！
varnish是一款先进的网站加速器，他的任务是代理并缓存他后面 web 服务器的内容。
加速访问您的 web 站点。我们建议您先阅读 “varnish 安装”。如果您的 varnish 已经成功
启动，您可以去阅读“varnish 指南”。
正文：
一、Varnish 安装
●安装 varnish
它是一个开源软件，你可以选择安全二进制包，或者从源码定制编译安装。安装二进制
包还是源码包是个人习惯。如果您不知道选择哪种方式，请阅读整个文档，然后选择一种您
喜欢的方式。
通过源码包还是通过二进制包安装？
在相关系统上，可以使用系统自带的包管理器来安装，常见的用例：
FreeBSD
源码安装：
cd /usr/ports/varnish && make install clean
二进制安装：
pkg_add –r varnish
CentOS/RedHat
我们尽力维护最近的版本提供RPMS（EL4&EL5） on SourceForge。
Varnish 被包含在 EPEL 资源库，不幸的是 varnish2.0.6→varnish2.1.X 有语法改变。这样
我们就不能更新EPEL中的 varnish版本，EPEL中最后的版本是2.0.6.
DEBIAN/UBUNTU
varnish已经发布了DEBINA和UBUNTU的包，只需要使用一下命令就可以安装，注
意：这样安装可能不是最新的版本。
4
www.linuxidc.com
apt-get install varnish
OTHER SYSTEMS
您最好使用源码安装，参照“源码编译安装“
如果您已经完成了安装，您可以阅读“varnish 指南“，“varnish 指南”比安装更
加有趣。
●通过源码包编译安装
如果没有您系统适用的二进制包，或其他原因您想要通过源码编译，请参考以下步
骤：
首先需要使用svn命令下载源码。如果您没有这个命令，您需要先在您的系统上安
装 subversion软件，笔者使用的是二进制安装的subversion。
下载当前的2.1分支版本
svn co http://varnish-cache.org/svn/branches/2.1
下载当前的开发源码
svn co http://varnish-cache.org/svn/trunk
DEBIN/UBUNTU系统环境下的依耐关系
要在DEBIN/UBUNTU系统下成功编译安装varnish，需要先安装以下软件包：
○autotools-dev
○automake1.9
○libtool
○autoconf
○libncurses-dev
○xsltproc
○groff-base
○libpcre3-dev
使用以下命令安装上面所有的包
sudo apt-get install autotools-dev automake1.9 libtool autoconf libncurses-dev xsltproc
groff-base libpcre3-dev
RedHat/CentOS系统环境下的依耐关系
如果您是RedHat/CentOS系统想安装varnish，您需要安装以下软件包：
○automake
○autoconf
○libtool
○ncurses-devel
○libxslt
○groff
○pcre-devel
○pkgconfig
5
www.linuxidc.com
以下是在配置好yum包管理器的情况下运行
yum install automake autoconf libtool ncurses-devel libxslt groff pcre-devel pkgconfig
配置和编译
下一步，配置，配置时会检查软件的依耐关系是否满足。
cd varnish-cache
sh autogen.sh
sh configure
make
这里的 configure 命令可以使用一些参数，但是大多数情况下和上面一样不使用参
数。您可以忘记这一步，因为几乎所有的参数都可以在varnish运行的时候添加。
在您安装 varnish 前，您可以运行自动测试，然后去喝杯茶，因为它会花费您几分
钟。
cd bin/varnishtest && ./varnishtest tests/*.vtc
如果您发现有一两个失败的时候，请不用担心，某些测试项目对时间比较敏感（您
可以告诉我们，我们来解决这个问题）。如果出现很多错误，或者 b00000.vtc测试也失
败的话，应该是发生了某些可怕的错误，如果您不解决这个错误的话，接下来将一事无
成。
INSTALLING
最后的考验，您是否有一颗勇敢的心：
make install
varnish将被安装到/usr/local目录，varnishd可执行文件将被安装到/usr/local/sbin/，
默认配置文件被安装到/usr/local/etc/varnish/default.vcl。
●获得支持
关于直接获取varnish团队的支持，我们会在时间允许的情况下尽量多的帮助大家，
并试图尽可能的简化这一过程。
但是请在联系我们前花一点时间，整理您的想法和明白表达您的问题，如果您只告
诉我们“我的varnish不能工作了”，而没有进一步的信息，这将是毫无意义的。
IRC CHANNEL
最直接的获得我们帮助的方法就是加入我们的IRC 通道。
#varnish on server irc.linpro.no
含义:时区是欧洲+美国
如果您要发表您的VCL或者相关文档，可以使用http://gist.github.com/
MAILING LISTS
打开或关闭邮件列表请访问MailMan http://lists.varnish-cache.org/mailman/listinfo
COMMERCIAL SUPPORT
商业支持，请联系PI:EMAIL
●提交 BUG
Varnish 的 debug 工作就像一个棘手的禽兽，有可能一些数据的拥挤，导致成千上
6
www.linuxidc.com
万的线程核心转储。
如果您发现一个bug，花一点时间收集bug的相关信息是十分必要且必须的，我们
可以通过您收集的信息来修复这个bug。
二、varnish 指南
Varnish是一个web加速器，被安装在web应用程序前面，缓存web应用程序，并响应
用户请求，varnish让您的web应用程序运行的更快，并且varnish灵活好用。
这个指南没有覆盖所有的varnish函数和功能，它可以让您对varnish有个全面的认识并
且掌握如何运用它。
我们假设您有一个web服务器和web应用程序正在运行，而且您想使用varnish给您的
web运行程序加速。
此外我们还假设您已经阅读了“varnish安装”并且按照默认配置安装了varnish。
●Backend servers(后端服务器)
varnish有一个概念叫做“后端服务器”或者叫“原点服务器”，一个后端服务器将
提供varnish加速的内容。
我们的第一个任务就是告诉 varnish 在哪里可以找到他要的内容。使用您喜欢的文
本编辑器打开 varnish 默认的配置文件，如果您是源码安装的配置文件可能在
/usr/local/etc/varnish/default.vcl ， 如 果您 是 二 进 制 包 安 装 的 配 置 文 件 可 能 在
/etc/varnish/default.vcl.
配置文件的最顶端如下：
# backend default {
# .host = "127.0.0.1";
# .port = "8080";
# }
我们取消前面的注释，并且把8080端口改成80端口。如下
backend default {
.host = "127.0.0.1";
.port = "80";
}
现在，这块配置定义了一个varnish默认访问的后端服务器，当varnish需要从后端
服务器获取内容的时候，它就会访问自己（127.0.0.1）的80端口。
Varnish 可以定义多个后端服务器而且您可以通过定义多个后端服务器达到负载均
衡的目的。
现在我们完成了基本的 varnish 配置，我们可以在 8080 端口上启动 varnish，并做
一些基本的测试。
7
www.linuxidc.com
●Starting Varnish（启动 varnish）
假设varnishd在您的环境变量中，您可能需要运行pkill varnishd来确定varnish没
有运行。然后使用root执行下面的命令。
varnishd -f /usr/local/etc/varnish/default.vcl -s malloc,1G -T 127.0.0.1:2000 -a
0.0.0.0:8080
我添加了一些选项，现在来详细分析他们：
-f /usr/local/etc/varnish/default.vcl
这个 –f 选项指定varnishd使用哪个配置文件。
-s malloc，1G
这个 –s 选项用来确定varnish使用的存储类型和存储容量，我使用的是malloc类
型（malloc 是一个 C 函数，用于分配内存空间）， 1G 定义多少内存被 malloced，1G =
1gigabyte。
-T 127.0.0.1：2000
Varnish有一个基于文本的管理接口，启动它的话可以在不停止varnish的情况下来
管理 varnish。您可以指定管理软件监听哪个接口。当然您不能让全世界的人都能访问您的
varnish管理接口，因为他们可以很轻松的通过访问varnish管理接口来获得您的root访问权
限。我推荐只让它监听本机端口。如果您的系统里有您不完全信任的用户，您可以通过防火
墙规则来限制他访问varnish的管理端口。
-a 0.0.0.0：8080
这一句的意思是制定varnish监听所有IP发给8080端口的http请求，如果在生产
环境下，您应该让varnish监听80，这也是默认的。
现在您的 varnish 已经在运行了，现在我们来验证它是否工作正常，在留言其中输入
http://192.168.2.2:8080/ ，您应该可以看见您的web程序在这里运行。
使用varnish后，web应用程序是否加速，取决于一些原因。如果您的程序的每个会话
都使用cookies或者您每个程序都需要三次握手认证，这样varnish就不能缓存更多的数据，
我们暂时忽略这个问题，等到“提高缓存命中率”这节的时候我们再继续讨论这个问题。
想要知道varnish对您的网站做了什么，请查看logs。
● Logging in varnish（记录数据）
Varnish一个真正的特点就是它如何记录数据的。使用内存段代替普通的日志文件，
当内存段使用完以后，又从头开始，覆盖最旧的记录。这样就可以非常快的记录数据，，并
且不需要磁盘空间。
缺点就是您没有把数据写到磁盘上，可能会消失。（varnish也支持将数据写到硬盘
的文件上，看您如何选择）
Varnishlog这个程序可以查看 varnish记录了哪些数据。Varnishlog给您生成原始的
日志，包括所有的事件。我一会给您演示。
在运行了varnish的终端窗口上，运行varnishlog这个命令。
您可以看见如下显示
0 CLI - Rd ping
0 CLI - Wr 200 PONG 1277172542 1.0
这是检查varnish的主进程是否正常，如果看见这就说明一切OK
8
www.linuxidc.com
现在您去浏览器通过varnish重新访问您的web程序，您将看到如下信息：
11 SessionOpen c 127.0.0.1 58912 0.0.0.0:8080
11 ReqStart c 127.0.0.1 58912 595005213
11 RxRequest c GET
11 RxURL c /
11 RxProtocol c HTTP/1.1
11 RxHeader c Host: localhost:8080
11 RxHeader c Connection: keep-alive
第一列是任意的数，它用来定义请求，相同的号码代表相同的HTTP传输。
第二列是信息标记，所有的日志都带有一个标记（tag），标记对应相对的操作。Rx
表示varnish收到数据，Tx表示varnish发送数据。
第三列代表数据是从哪里传出或者传入的，是从c（client）还是b（backend）。
第四列是被记录的数据。
现在，您可以过滤掉相当多的varnishlog，这些基本的选项，您需要知道：
-b \\只显示varnish和backend server之间的日志，当您想要优化命中率的时
候可以使用这个参数。
-c \\和-b差不多，不过它代表的是varnish和client端的通信。
-i tag \\只显示某个tag，比如“varnishlog –i SessionOpen”将只显示新会话，注
意，这个地方的tag名字是不区分大小写的。
-I \\通过正则表达式过滤数据，比如“varnishlog -c -i RxHeader -I Cookie”将
显示所有接到到来自客户端的包含Cookie单词的头信息。
-o \\聚合日志请求ID
如果varnish一切运行OK，我们就可以把它调整到80端口上。
● PutVarnish on port 80(使 varnish 工作在 80 端口上)
如果您的程序正常运行，没有问题，我们就可以把varnish调整到80端口运行。先
关闭vernish
pkill varnishd
然后停止您的web服务器，修改web服务器配置，把web服务器修改成监听8080
端口，然后修改varnish的default.vcl和改变默认的后端服务器端口为8080.
先启动您的web服务器，然后在启动varnish：
varnishd -f /usr/local/etc/varnish/default.vcl -s malloc,1G -T 127.0.0.1:2000
我们取消了-a 选项，这样varnish将监控默认端口，启动后，检查您的web程序是
否正常。
●Varnish Configuration Language - VCL（varnish 配置
语言-VCL）
Varnish 有一个很棒的配置系统，大部分其他的系统使用配置指令，让您打开或者关闭
一些开关。Varnish使用区域配置语言，这种语言叫做“VCL”（varnish configuration language），
9
www.linuxidc.com
在执行vcl时，varnish就把VCL转换成二进制代码。
VCL文件被分为多个子程序，不同的子程序在不同的时间里执行，比如一个子程序在接
到请求时执行，另一个子程序在接收到后端服务器传送的文件时执行。