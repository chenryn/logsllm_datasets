**作者：深信服千里目安全实验室  
原文链接：**
## 一、组件介绍
### 1.1 基本信息
ZenTaoPMS（ZenTao Project Management
System），中文名为禅道项目管理软件。ZenTaoPMS是易软天创公司为了解决众多企业在管理过程中出现的混乱，无序的现象，开发出来的一套项目管理软件。
禅道项目管理软件的主要管理思想基于国际流行的敏捷项目管理方式——Scrum。scrum是一种注重实效的敏捷项目管理方式，但众所周知，它只规定了核心的管理框架，但具体的细节还需要团队自行扩充。禅道在遵循其管理方式基础上，又融入了国内研发现状的很多需求，比如bug管理，测试用例管理，发布管理，文档管理等。因此禅道不仅仅是一款scrum敏捷项目管理工具，更是一款完备的项目管理软件。基于scrum，又不局限于scrum。
禅道还首次创造性的将产品、项目、测试这三者的概念明确分开，产品人员、开发团队、测试人员，这三者分立，互相配合，又互相制约，通过需求、任务、bug来进行交相互动，最终通过项目拿到合格的产品。
### 1.2 版本介绍
禅道项目管理软件基于自主研发的PHP开发框架---禅道PHP框架开发而成，企业或者第三方的开发者可以通过这套框架，灵活的对禅道进行功能的修改或者扩展。经过逐年演化，禅道项目管理软件发展成为四大系列、功能完善的项目管理软件。禅道项目管理软件发展至今其核心开发系列共有以下三个，即禅道企业版、禅道专业版、禅道集团版、禅道开源版。其中禅道开源版是基础版本；而专业版、企业版是根据禅道开源版进行二次开发而成，其间仅存在功能性上的不同，所以专业版、企业版是兼容同级开源版的；而集团版仅为部署架构上的不同，核心还是企业版，具体如下：
（1）禅道开源版（2009-2020）是禅道项目管理软件的基础版本，属于禅道项目的开发框架，其中仅开发了项目管理的基本模块。
（2）禅道专业版（2012-2020）是在禅道开源版的基础上增加增强功能。专业版推出的初衷是为IT企业或部门提供更完善的服务，专业版增强功能更加适合企业的内部流程化管理。同时专业版的增强功能都以收费插件的方式发布在禅道官网里，为用户提供单独下载使用的服务。
（3）禅道企业版（2017-2020），在禅道专业版功能的基础上，增加了运维管理、OA办公管理、反馈管理，以及文档的版本管理及在线预览等功能，可以为企业项目管理流程提供更全面的支撑。
（4）禅道集团版（2019-2020）主要包含主站平台和子站点两部分。集团版用户可以通过主站平台给旗下的 部门、
子公司或者第三方开发团队分别开通一个独立的子站点进行项目管理。集团版的子站点由禅道项目管理软件企业版提供项目管理服务，
每个子站点的数据都是独立且互不影响的。
版本细分如下图所示：
### 1.3 使用量及使用分布
根据全网数据统计，使用ZenTaoPMS的网站多达4万余个，其中大部分集中在国内，约占使用量的75%以上。其中，广东、浙江、北京、上海四省市使用量最高，由此可见，ZenTaoPMS在国内被广泛应用。
## 二、高危漏洞介绍
通过对ZenTaoPMS漏洞的收集和整理，过滤出其中的高危漏洞，可以得出如下列表。
漏洞名称 | 漏洞ID | 影响版本 | 漏洞披露日期  
---|---|---|---  
禅道 8.2-9.2.1 SQL注入导致前台Getshell | 无 | 禅道开源版 8.2-9.2.1 | 2018  
禅道 后台代码注入漏洞 | 无 | 禅道开源版 parseRequest();
    $common->checkPriv();
    $app->loadModule();
即parseRequest()函数就是路由解析入口。进入到`\framework\base\router.class.php`文件中的`parseRequest()`函数：
`parseRequest()`函数首先用于解析判断url是否采用了'GET'或者是'PATH_INFO'模式，其中有一个点就是`isGetUrl()`函数，该函数用于判断url是否采用了GET模式，具体有以下三种模式：
我们回到parseRequest()函数中可以得出，如果系统的默认解析模式是PATH_INFO，而你的url采用的是GET模式，系统则会将此次访问的路由解析模式配置修改GET，故当你的url模式与系统默认解析模式不同，系统也会解析，不会报错。所以禅道系统的两种路由解析模式可同时使用。
（1）路由解析中，GET模式属于非默认模式，但是该种解析方式是PHP类CMS的常规解析模式，即m=block&f=main，m参数负责传递模块名（module），f参数负责传递方法名（method），由此就可以定位到对应module中的`control.php`文件，以及该文件中对应的method。
（2）路由解析中，PATH_INFO模式属于系统默认模式，我们在配置文件中可以看到系统默认模式以及对应的分隔符、参数含义:
我们可以看出PATH_INFO的默认分隔符是
-，然后我们进入到path_info模式下的`setRouteByPathInfo()`函数，通过分隔符将url分割后，第一个值为模块名称`module`，第二个值即为方法`method`:
总，两种解析模式解析后获取的最终module、method通过 `$this->setControlFile();`方法来寻找对应的文件：
自此路由解析结束，定位到对应的模块方法后，就进行了权限验证，即使用者身份是否可以调用该模块与方法，`$common->checkPriv();`，文件`module/common/model.php`:
从此方法看出，除了`isOpenMethod`之外，均需要登录后具有对应权限才可访问，不需登录的方法如下所示。
### 4.1 禅道 8.2-9.2.1 SQL注入漏洞导致Getshell
#### 4.1.1 漏洞简介
漏洞名称：禅道8.2-9.2.1SQL注入前台Getshell  
漏洞编号：无  
漏洞类型：SQL注入  
CVSS评分：无  
漏洞危害等级：高危
#### 4.1.2 漏洞概述
禅道项目管理软件集产品管理、项目管理、质量管理、文档管理、组织管理和事务管理于一体，是一款功能完备的项目管理软件。该漏洞影响版本为禅道8.2--9.2.1。漏洞出现在系统orm框架中，在拼接order
by的语句过程的时候，未对limit部分过滤并直接拼接，导致攻击者构造执行SQL语句。在mysql权限配置不当的情况下，攻击者可利用该漏洞获取webshell。
#### 4.1.3 漏洞影响
禅道8.2 - 9.2.1
#### 4.1.4 漏洞修复
1.建议受影响的用户升级至ZenTao
9.2.1以上版本或打上对应补丁包，下载地址：
#### 4.1.5 漏洞利用过程
0x0：随便访问一个不存在的路径，返回页面会出现报错，报错回显出文件的存放路径为。
0x1：根据报错回显的路径，构造SQL注入语句将木马写入系统的EXP。
0x2：将上述EXP进行ASCIIhex加密，得到加密后的字符串。
0x3：然后将加密后的字符串放入：
    {"orderBy":"order limit 1;SET @SQL=0x(加密后字符串);PREPARE pord FROM @SQL;EXECUTE pord;-- -","num":"1,1","type":"openedbyme"}
0x4：然后将上述语句进行base64加密。
0x5：最终通过访问以下语句执行漏洞
    http://siteserver/zentao/index.php?m=block&f=main&mode=getblockdata&blockid=case&param=base64加密字符串
#### 4.1.6 代码分析
我们根据漏洞PoC来跟踪漏洞执行流程，从技术背景中的路由解析我们可以定位到漏洞存在的模块是block模块中的main方法，在经过路由解析后，系统将通过loadModule()方法加载对应模块，如下图所示：
在处理完url路由后，就开始处理方法中的各种参数，通过setParamsByGET()函数将参数解析：
在参数解析后，就对各个参数进行过滤检测，若没有问题，最终将解析过滤后的参数进行保存：