User: How to do port forwarding via iptables?
Assistant: 1. Enable the IP forwarding function In the Linux system, you need to enable the IP forwarding function first. In most cases, it can be achieved by modifying kernel parameters/sysctl.conf. For example, modify the /sysctl.conf file by the following command: sudo vi /etc/sysctl.conf Find the following line (if it does not exist, please add it): net.ipv4.ip_forward=1 Change it to "1", save and close the file . Then run the following command to verify that the changes have taken effect: sudo /sbin/sysctl -p 2. Create an iptables NAT rule Next, we will use iptables to create a NAT rule to forward ports. The following command will forward TCP traffic on port 80 to port 8000 on 127.0.0.1: sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 127.0.0.1:8000 Explanation : -t nat: use NAT table -A PREROUTING: execute rules before packets reach the system -p tcp: apply only to TCP packets --dport 80: destination port is 80 -j DNAT: redirect destination IP and port To the specified address and port --to-destination 127.0.0.1:8000: Redirect to port 8000 of 127.0.0.1 3. Add iptables rules to allow traffic transmission Next, we need to create an allow incoming traffic, and allow Outgoing rules to ensure that the forwarding manager works properly. This can be done with the following commands: # Allow incoming traffic sudo iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT # Allow outgoing traffic sudo iptables -A OUTPUT -o eth0 - p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT Explanation: -A INPUT: Append to input rules -i eth0: Traffic incoming interface is eth0 -p tcp: Only apply to TCP packets --dport 80: Destination port is 80 (this is also the port of the original request) -m state --state NEW,ESTABLISHED: allow only newly established and echoed connections -j ACCEPT: allow communication -A OUTPUT: attach to output rules -o eth0: traffic output interface is eth0 -p tcp: apply only to TCP packets --sport 80: source port is 80 (this is also the port for responses) -m state --state ESTABLISHED: allow only echo connections -j ACCEPT: allow communication Note: In the above command, "eth0" is the default interface name. If you are using a different network interface, adjust the iptables rules accordingly. 4. Save the rules and restart iptables After completing all the rules, you need to save the rules and restart the iptables service. Save the rules: sudo iptables-save > /etc/iptables.conf We can now restart IPTABLES at any time with the following command: sudo systemctl restart netfilter-persistent After this, the port forwarding will operate according to the rules you defined. Specifically, accessing the server's IP address/port 80 will automatically point to port 8000 of localhost. This is useful in many situations, such as when deploying web applications to production. Do you have any other questions that need help?