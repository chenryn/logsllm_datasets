## 公有 IP 地址和私有 IP 地址在日常的工作中，几乎不用划分 A 类、B 类或者 C类，所以时间长了，很多人就忘记了这个分类，而只记得CIDR。但是有一点还是要注意的，就是公有 IP 地址和私有 IP 地址。![](Images/11c08f65c46e64e5b064d902f0b676f6.png){savepage-src="https://static001.geekbang.org/resource/image/90/93/901778433f2d6e27b916e9e53c232d93.jpg"}我们继续看上面的表格。表格最右列是私有 IP地址段。平时我们看到的数据中心里，办公室、家里或学校的 IP地址，一般都是私有 IP 地址段。因为这些地址允许组织内部的 IT人员自己管理、自己分配，而且可以重复。因此，你学校的某个私有 IP地址段和我学校的可以是一样的。这就像每个小区有自己的楼编号和门牌号，你们小区可以叫 6 栋，我们小区也叫6 栋，没有任何问题。但是一旦出了小区，就需要使用公有 IP 地址。就像人民路888 号，是国家统一分配的，不能两个小区都叫人民路 888 号。公有 IP地址有个组织统一分配，你需要去买。如果你搭建一个网站，给你学校的人使用，让你们学校的IT 人员给你一个 IP 地址就行。但是假如你要做一个类似网易 163这样的网站，就需要有公有 IP 地址，这样全世界的人才能访问。表格中的 192.168.0.x 是最常用的私有 IP 地址。你家里有Wi-Fi，对应就会有一个 IP 地址。一般你家里地上网设备不会超过 256 个，所以/24 基本就够了。有时候我们也能见到 /16 的CIDR，这两种是最常见的，也是最容易理解的。不需要将十进制转换为二进制 32 位，就能明显看出 192.168.0是网络号，后面是主机号。而整个网络里面的第一个地址192.168.0.1，往往就是你这个私有网络的出口地址。例如，你家里的电脑连接Wi-Fi，Wi-Fi 路由器的地址就是 192.168.0.1，而 192.168.0.255就是广播地址。一旦发送这个地址，整个 192.168.0网络里面的所有机器都能收到。但是也不总都是这样的情况。因此，其他情况往往就会很难理解，还容易出错。
## 举例：一个容易"犯错"的 CIDR我们来看 16.158.165.91/22 这个CIDR。求一下这个网络的第一个地址、子网掩码和广播地址。你要是上来就写 16.158.165.1，那就大错特错了。/22 不是 8 的整数倍，不好办，只能先变成二进制来看。16.158的部分不会动，它占了前 16 位。中间的165，变为二进制为‭10100101‬。除了前面的 16 位，还剩 6 位。所以，这 8位中前 6 位是网络号，16.158.\，而 \.91 是机器号。第一个地址是 16.158.\\.1，即 16.158.164.1。子网掩码是255.255.\\.0，即 255.255.252.0。广播地址为16.158.\\.255，即 16.158.167.255。这五类地址中，还有一类 D类是**组播地址**。使用这一类地址，属于某个组的机器都能收到。这有点类似在公司里面大家都加入了一个邮件组。发送邮件，加入这个组的都能收到。组播地址在后面讲述VXLAN 协议的时候会提到。讲了这么多，才讲了上面的输出结果中很小的一部分，是不是觉得原来并没有真的理解ip addr 呢？我们接着来分析。在 IP 地址的后面有个 scope，对于 eth0 这张网卡来讲，是global，说明这张网卡是可以对外的，可以接收来自各个地方的包。对于 lo来讲，是 host，说明这张网卡仅仅可以供本机相互通信。lo 全称是**loopback**，又称**环回接口**，往往会被分配到 127.0.0.1这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。
## MAC 地址在 IP 地址的上一行是 link/ether fa:16:3e:c7:79:75 brdff:ff:ff:ff:ff:ff，这个被称为**MAC地址**，是一个网卡的物理地址，用十六进制，6 个 byte 表示。MAC 地址是一个很容易让人"误解"的地址。因为 MAC地址号称全局唯一，不会有两个网卡有相同的 MAC地址，而且网卡自生产出来，就带着这个地址。很多人看到这里就会想，既然这样，整个互联网的通信，全部用MAC 地址好了，只要知道了对方的 MAC 地址，就可以把信息传过去。这样当然是不行的。**一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能。**而有门牌号码属性的 IP 地址，才是有远程定位功能的。例如，你去杭州市网商路 599 号 B 楼 6层找刘超，你在路上问路，可能被问的人不知道 B楼是哪个，但是可以给你指网商路怎么去。但是如果你问一个人，你知道这个身份证号的人在哪里吗？可想而知，没有人知道。MAC地址更像是身份证，是一个唯一的标识。]{.orange}它的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不用担心冲突。从硬件角度，保证不同的网卡有不同的标识。MAC 地址是有一定定位功能的，只不过范围非常有限。你可以根据 IP地址，找到杭州市网商路 599 号 B 楼 6层，但是依然找不到我，你就可以靠吼了，大声喊身份证 XXXX的是哪位？我听到了，我就会站起来说，是我啊。但是如果你在上海，到处喊身份证XXXX 的是哪位，我不在现场，当然不会回答，因为我在杭州不在上海。所以，MAC 地址的通信范围比较小，局限在一个子网里面。例如，从192.168.0.2/24 访问 192.168.0.3/24 是可以用 MAC 地址的。一旦跨子网，即从192.168.0.2/24 到 192.168.1.2/24，MAC 地址就不行了，需要 IP地址起作用了。
## 网络设备的状态标识解析完了 MAC 地址，我们再来看 \是干什么的？这个叫作**net_device flags**，**网络设备的状态标识**。UP 表示网卡处于启动的状态；BROADCAST表示这个网卡有广播地址，可以发送广播包；MULTICAST表示网卡可以发送多播包；LOWER_UP 表示 L1是启动的，也即网线插着呢。MTU1500是指什么意思呢？是哪一层的概念呢？最大传输单元 MTU 为1500，这是以太网的默认值。上一节，我们讲过网络包是层层封装的。MTU 是二层 MAC 层的概念。MAC 层有MAC 的头，以太网规定连 MAC 头带正文合起来，不允许超过 1500个字节。正文里面有 IP 的头、TCP 的头、HTTP的头。如果放不下，就需要分片来传输。qdisc pfifo_fast 是什么意思呢？qdisc 全称是**queueingdiscipline**，中文叫**排队规则**。内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc（排队规则）把数据包加入队列。最简单的 qdisc 是pfifo，它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。pfifo_fast稍微复杂一些，它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则。三个波段（band）的优先级也不相同。band 0 的优先级最高，band 2的最低。如果 band 0 里面有数据包，系统就不会处理 band 1里面的数据包，band 1 和 band 2 之间也是一样。数据包是按照服务类型（**Type ofService，TOS**）被分配到三个波段（band）里面的。TOS 是 IP头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。队列是个好东西，后面我们讲云计算中的网络的时候，会有很多用户共享一个网络出口的情况，这个时候如何排队，每个队列有多粗，队列处理速度应该怎么提升，我都会详细为你讲解。
## 小结怎么样，看起来很简单的一个命令，里面学问很大吧？通过这一节，希望你能记住以下的知识点，后面都能用得上：-   IP 是地址，有定位功能；MAC 是身份证，无定位功能；-   CIDR 可以用来判断是不是本地人；-   IP 分公有的 IP 和私有的    IP。后面的章节中我会谈到"出国门"，就与这个有关。最后，给你留两个思考题。1.  你知道 net-tools 和 iproute2 的"历史"故事吗？2.  这一节讲的是如何查看 IP 地址，那你知道 IP 地址是怎么来的吗？欢迎你留言和我讨论。趣谈网络协议，我们下期见！![](Images/55417b60e9c8040807daf07e6bd9cb4b.png){savepage-src="https://static001.geekbang.org/resource/image/b5/fb/b5bc14cb81d3630919fee94a512cc3fb.jpg"}
# 第4讲 \| DHCP与PXE：IP是怎么来的，又是怎么没的？上一节，我们讲了 IP的一些基本概念。如果需要和其他机器通讯，我们就需要一个通讯地址，我们需要给网卡配置这么一个地址。