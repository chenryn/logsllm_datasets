# 第10章 赛后——分析报告
> 译者：[@Snowming](https://github.com/Snowming04)
![](../images/chapter_10/10-1.png)

在之前的 THP 书籍中，我们介绍了如何编写渗透测试报告，并提供了多种报告模板。这些示例适用于常规的渗透测试活动，但并不适合红队行动。正如本书所述，红队的重点不仅在于识别漏洞（尽管这也是工作的一部分），更在于测试人员、工具、流程和员工技能的整体组合。如果您的公司被授权的渗透测试者或未经授权的攻击者成功入侵，您会如何评价自己的安全表现？我一向反对使用差距评估分数、ISO 分数、成熟度模型分数、标准风险分析、热度图等报告来展示公司的安全状况。

个人而言，我更倾向于看到公司在之前的红队活动中采取了哪些措施来改进安全控制。例如，在一次近似域名网络钓鱼活动中，公司可能启用了以下功能：
- 使用 dnstwist 对类似公司域名发出警报；
- 设置一个可信的外部电子邮件域列表。任何不匹配的外部邮件都将在最终用户的邮箱中标注为未经批准的外部来源，帮助用户更容易识别网络钓鱼；
- 对来自未分类域的电子邮件中的链接进行点击检测，并警告用户该链接尚未分类；
- 禁用 Office 宏附件，强制启用受保护视图，并对文档进行沙盒处理。

这只是公司可以实施的一些简单方法，以防止攻击的发生。

请记住，红队只需找到一个漏洞就可能破坏整个内网环境。而蓝队只需识别出攻击者的 TTP（战术、技术和过程）之一，就能阻止威胁。因此，问题在于，当这些 TTP 中的一个已经触发防御系统报警时，应急响应团队发现并处理威胁的速度有多快？

### 红队风格的报告应包含哪些内容？
由于红队的概念相对较新，目前尚无标准报告模板，可以根据客户需求进行定制。在我看来，红队报告应包括以下几个部分：

#### 活动期间的记录
许多工具如 Empire 和 Cobalt Strike 在红队活动期间都有良好的日志记录功能，但这可能还不够。我发现建立一个简单的 Web 服务器来记录红队成员的每个操作非常有用。记录过程中仅收集基本信息，包括特定事件、服务器、描述、影响、任何警报和屏幕截图。大多数红队/渗透测试人员不喜欢做笔记，但这类记录提供了一种简单的跟踪活动的方法。
![](../images/chapter_10/10-2.png)

#### 报告的主要组成部分
一旦活动结束，我们将收集所有笔记并将其整合成一份讲述故事的红队报告。主要组成部分可能包括：

- **简介/范围**：明确说明活动的目标。例如，有些客户要求我们访问特定数据、获得域管理权限、获取 PII（个人身份信息）、获取 IP 或在生产环境中找到标志（flag）。
- **指标**：在交战后提供详细的攻击报告，这对应急响应团队/取证团队非常有帮助。我们还希望确定他们的防护工具或安全传感器可能遗漏的地方，导致他们无法执行取证或检测恶意活动。因此，我们需要提供 C2 服务器的 IP 地址、使用的域名、二进制文件的 MD5/SHA1 哈希值、电子邮件地址和 IP 信息、被钓鱼的受害者列表以及任何其他有助于取证/应急响应的信息。
- **攻击时间轴**：这是红队行动中最重要的部分之一，详细记录所有主要活动、触发警报的 TTP 以及关键事件。这将允许蓝队比较他们的时间轴和笔记，找出遗漏之处。在真实的攻击中，你有机会询问攻击者每一步的操作吗？这对防守团队来说是非常有价值的。一个时间轴示例可能是这样的:
  ![](../images/chapter_10/10-3.png)
- **检测时间（TTD）/解决时间（TTM）**：通常我们可以使用蓝队报告构建 TTD/TTM 统计数据。我们需要确定蓝队发现多次入侵所需的时间；扫描事件触发调查前花费的时间（如果进行了调查的话）；以及蓝队识别网络钓鱼活动所需的时间。此外，还需要讨论在采取行动前花费的时间。如果有已警告的 C2 通信或已识别的网络钓鱼，那么在防火墙或 DNS 服务器上封锁这些域需要多长时间？我们经常看到公司可能擅长屏蔽域名，但在 C2 服务器通过 IP 进行通信时却迅速失败（反之亦然）。我们希望确保跟踪此活动并帮助客户识别问题。另一个有用的 TTM 衡量标准是他们在最快的情况下需要多长时间来隔离一个已确认受损的系统。随着恶意软件变得越来越自动化，我们需要开始利用智能化和自动化的流程将系统或网络的一部分与组织的其他部分隔离开来。
- **来自应急响应/应急人员的反馈**：我最喜欢记录的内容之一是来自蓝队的反馈：他们是如何从防守的角度看待整个活动的。我想知道的是，他们是否觉得自己遵守了安全政策，事件负责人是否推动了调查，管理层是否过度介入，安全部门如何与 IT 部门互动以促进任何与 IT 相关的改变（如防火墙屏蔽、DNS 修改等）。以及他们中间的哪些人过于慌张、哪些人过于冷静。

如前所述，红队的目的不是寻找漏洞或破坏环境（尽管这是非常有趣的部分），而是改善客户组织的整体安全程序和规划，并证明其环境中存在某些漏洞。如今，许多公司对自己的安全程序过于自信，只有在被攻破时才会做出改变。现在有了红队，我们可以模拟攻击行为并鼓励客户做出改变，而不是等到真实入侵发生时才采取行动，那时或许已为时太晚。