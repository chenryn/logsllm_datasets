# 【木马分析】新版“Locky Bart”勒索软件的二进制文件及后端服务器分析

##### 译文声明
本文为翻译文章，原文来源于malwarebytes.com。译文仅供参考，具体内容和含义以原文为准。

**翻译者**: [overXsky](http://bobao.360.cn/member/contribute?uid=858486419)  
**预估稿费**: 200 RMB  
**投稿方式**: 发送邮件至[linwei#360.cn](mailto:linwei#360.cn)，或登录[网页版](http://bobao.360.cn/contribute/index)在线投稿

## 背景分析
本文将探讨一种新的勒索软件——Locky Bart。该软件的开发者先前已经成功推出了两个版本的勒索软件：“Locky”与“Locky v2”。在收到多起关于Locky Bart感染事件的报告后，我们开始对其进行深入研究，旨在发现新旧版本之间的差异并获取更多相关信息。

Locky Bart具备一些不同于其前身的新特性，例如能够在无网络连接的情况下加密设备，并采用了更高效的加密算法。此外，研究表明，Locky Bart的后端基础设施可能由不同于原版本的威胁主体维护。尽管两者的二进制代码存在许多相似之处，但仍然有一些值得注意的区别，包括应用程序代码中的注释以及后端服务器使用的软件类型等。

这些发现并不令人惊讶，因为网络犯罪分子之间经常共享、租赁甚至窃取彼此的恶意代码已是众所周知的事实。

## 二进制分析
早期版本的Locky Bart采用了一种相对简单的加密过程：它会枚举需要加密的所有文件，然后将其放入受密码保护的ZIP存档中，重复此过程直至所有目标文件均被加密。不过，开发者并未使用AES加密算法来保护ZIP存档，而是选择了较为老旧的技术方案，这使得研究人员能够开发出相应的解密工具。

新版Locky Bart则执行了一系列更为直接的操作来加密受害者的文件，具体步骤如下：
- 使用VSSadmin删除系统还原点。
- 生成种子以创建用于加密用户文件的密钥。
- 枚举待加密文件，跳过某些特定目录以提高处理速度。
- 利用生成的密钥对选定文件进行加密。
- 采用主密钥对上述密钥进行加密，得到的密钥被称为“UID”，用于标识受害者身份。
- 在桌面上创建包含付款页面链接及其对应UID的赎金通知。

下图展示了部分关键函数及数据结构示例（此处略去图片说明）。

Bart Locky的一个重要变化在于如何获取密钥（即UID）。当受害者访问指定URL试图支付赎金时，实际上是在无意间向攻击者发送了解密所需的关键信息。接下来我们将详细解释这一过程：
1. Locky Bart收集有关受害者机器的信息以生成加密密钥。
2. 使用上一步骤中基于种子创建的密钥对用户的文件进行加密。
3. 应用公钥/私钥对机制中的公钥对原始加密密钥进行单向加密。私钥存储于恶意软件服务器上且无法被受害者访问。
4. 随后，在受害者的计算机上生成一个包含指向TOR隐藏服务（.onion地址）链接的URL。该链接内嵌有用户ID，即加密形式下的解密密钥。
5. 当受害者访问.onion站点时，恶意软件服务器将接收加密后的UID。
6. 对于受害者而言，UID毫无用处，因为他们没有私钥来解锁自己的文件；但对于勒索软件开发者来说，却可以通过UID识别受害者并在收到赎金后提供解密服务。

最终结果是，只有勒索软件开发者才能解密用户的文件，而且无需再次连接到恶意软件服务器即可完成整个加密过程。

## 软件保护技术
为了增加逆向工程难度，Locky Bart还引入了代码虚拟化技术。这种技术通过使用开源软件WPProtect实现。显然，这使二进制文件变得更加复杂难解，从而增加了分析难度。虽然此类技术通常应用于反盗版领域，但在本案例中，其目的显然是为了阻碍安全研究人员的工作进展。

## 服务器分析
Locky Bart的服务器主要用于提供支付赎金所需的机制，包括但不限于：
- 接收作为支付手段的比特币；
- 将比特币转移至其他钱包；
- 为受害者生成解密程序；
- 向受害者提供解密程序下载链接；
- 收集更多关于受害者的信息。

该后端系统基于Yii框架构建，这是一个高性能PHP框架，非常适合开发Web 2.0应用。通过Yii调试面板可以查看大量关于Locky Bart内部运作的信息，如服务器配置、请求日志、错误追踪等。

MySQL数据库用于存储受害者唯一标识符、加密密钥、比特币地址、支付状态及时戳等信息。此外，还有一个额外的数据库记录了有关勒索软件受害者的更多细节。

BTCwrapper.php文件定义了一个名为“BTC”的比特币钱包类，允许其他PHP脚本调用相关方法以管理比特币交易。这个类不仅支持创建新的比特币地址，还能定期清空各个子钱包并将资金转入主钱包中。同时，它也提供了检查每个受害者付款状态的功能。

值得注意的是，Locky Bart服务器模仿合法企业的客户服务模式，设置了自动化的“支持票务系统”，允许用户就支付过程中遇到的问题寻求帮助。整个流程从感染到支付再到解密都是全自动化的，极大地简化了操作流程。

## 结论
通过对Locky Bart勒索软件的研究，我们可以窥见此类恶意软件背后的复杂运营体系。这些犯罪分子展现出了极高的技术水平，因此用户必须采取额外措施保护自己免受此类攻击。随着勒索软件不断进化升级，确保重要文件备份以及安装具有反勒索功能的安全防护软件变得尤为重要。