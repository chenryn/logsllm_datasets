# OCR Output
## Page 1
ArchSummit
Kubernetes
在华为全球IT系统中的实践
InfoQ
---
## Page 2
华为IT系统业务现状
MWC（中间件云）应用增长分析（以虚机计）
规模庞大一部署面广，覆盖全球多个地区
01
45000
跨域多DC的部署维护无法拉通，运维投入巨大
生产环境
测试环境
频繁发布－业务繁多，迭代周期短
02
平台不支持快速迭代，业务上线效率低
21000
20000
冗余部署－同城双活、异地容灾、备份/滚
03
动升级
应用独占VM，资源利用率低，成本高
6000
3000 2000
300500
容器化、微服务化改造，应用急速增长
04
2013年
2014年
2015年
2016年
系统重载，无法大规模快速弹性部署
2015年统计数据
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 3
CCE在华为IT系统中的自标与定位
企业IT
SCM
ERP
CRM
MES
跨域应用集中部署与管理
开发
测试
运维
混合应用资源编排
安
打通应用和服务
App
中间件
服务
应用融合
开发测试生产一致性环境
快速供给
统一调度
和编排
打通I/P/C
VM
PaaS
容器
平台融合
docker
开发性快速集成传统中间件
(laaS PaaS CaaS)
支撑传统应用中间件容器化
DC
DC
DC
DC
跨地域DC
高可用
(数据中心)
以kuberentes、docker为核心技术构建，融合打通原有laaS、PaaS、
CaaS平台，一个技术栈支撑多种业务场景
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 4
CCE在华为IT系统的进展
2015年底上线生产环境
TIME
·实现自动化部署、提升资源利用率3-4倍；
端到端分钟级自助在线环境获取、自动弹性
伸缩，大幅加速应用上线；
·支持华为内部IT系统多项业务从传统SOA架
SCALE
当前规模
构向容器为中心的微服务架构平滑演进。
2k+VM，8k+容器
近期重点技术实践
CASES
·Kubernetes多集群联邦
·应用间的亲和/反亲和调度
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 5
Kubernetes基本概念
鸟语
人话
Kubernetes Cluster
Kubernetes Master
Container
容器
Replication
API Server
Controller
Pod
容器组
Replication
副本控制器
Controller
(副本集)
(ReplicaSet)
Service
服务
Container
Container
Container
Container
标签
Label
 Pod
Pod
8
Pod
 Pod
Node
节点
kubelet
[Kube-proxy
[docker
[kubelet
[Kube-proxy]
docker
Node
Node
Kubelet
节点Agent
Kubernetes
主节点
8
=Labels
=Service
Master
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 6
Kubernetes集群联邦
·多数据中心统一管理部署应用，提供跨域的
应用服务发现
宝
·跨域的网络限制与差异较大，难以通过k8s单
提供跨域应用集中部署
集群支持
与管理降低运维成本
·当前单集群的规模为1k到2k
（k8s社区1.3版
本规模为2k，年度目标为5k)
·根据目前的应用增长速度，容器化之后整体规
模需要支持3w虚机，10w容器
大规模部署的需求驱动
1）按虚机应用算年底VM数量将超过6万
2）应用/实例的部署比例平均在1:2到1:3之间
3）容器化1个应用平均拆分出4~5个微服务
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 7
多集群联邦架构
复用list-watch机制实现组件解耦
管理控制请求
KubeCtl / KubeUl / Rest API
88
业务流量
Ubernetes Api server
增加集群相关API，屏蔽集群
 Ubernetes API
ETCD
Server
3rd Auth
差异，统一请求入口
Ubernetes Controller Manager
Ubernetes
全球分布式路由
Service
Cluster
Scheduler
Controller
Ubernetes Scheduler
Controller
分拆联邦级别对象到集群
Kubernetes Master
负载均衡
Kubernetes Master
负载均衡
888
Cluster controller
管理个集群状态，集群级别
Node
Node
Node
Node
Node
Node
对象创建
Node
Node
Node
Node
Node
Node
Service controller
Flannel/OvS（叠加网络）
Flannel/OvS
跨集群服务发现
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 8
Kubernetes的list-watch机制
·watch各类set，处理
·list & watch集群中的
watch被调度到本节点
生命周期事件
node，供调度时使用
的Pod，执行生命周期
定期list做同步处理，
watch未调度的Pod,
动作
保证最终一致
进行多策略调度
kubectl
controller-manager
scheduler
kubelet
0.
.发起Watch
0.发起watch
0发起watch
ReplicaSet
Pod
(destNode="")
Pbd (destNode
9.更新Pod
="myNode")
1.创建
:5.创建Pod
按调度结果
ReplicaSet
4.上报事件
12．上报事件
8.上报事件
绑定node
ReplicaSet
Pod Bound
Pod Created
Created
(Updated)
API-server
3．上报事件
7.上报事件
11．上报事件
2.创建
6.创建 Pod
10.更新Pod
ReplicaSet
ReplicaSet
Created
Pod Created
Pod Bound
(Updated)
ETCD
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 9
多集群联邦下的应用创建
①
RS
Ins:5
创建应用
保存对象
KubeCtl
Ubernetes APl Server
ETCD
④监视应用的创建,
③监视子应用的创建
RS
subRS
subRS
选择目标集群，
Ins:2
+
Ins:3
Ins:5
Cluster:A
Cluster:B
拆分出多个子应用
Ubernetes Scheduler
Ubernetes Controllers
③周期性获取集群
调用k8s API在各个目
负载等数据
标集群中创建应用
RS
RS
Ins:2
Ins:3
Kubernetes Cluster A
Kubernetes Cluster B
RS:ReplicaSet多实例无状态应用
subRS:子应用
Ins:实例数
ArchSummit全球架构师峰会
Powered by
InfoQ
---
## Page 10
联邦调度器
分拆联邦级别对象到集群
①
RS
Ins:5
创建应用
保存对象
KubeCtl
Ubernetes APl Server
ETCD
Update RS, destClusters=[
④监视应用的创建
③监视子应用的创建
watch RS
{cluster: “foo", replica: 6},
选择目标集群，
watch cluster
拆分出多个子应用
Ubernetes Scheduler
Ubernetes Controllers