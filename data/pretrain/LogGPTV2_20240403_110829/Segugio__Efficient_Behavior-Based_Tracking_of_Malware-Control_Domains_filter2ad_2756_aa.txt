title:Segugio: Efficient Behavior-Based Tracking of Malware-Control Domains
in Large ISP Networks
author:Babak Rahbarinia and
Roberto Perdisci and
Manos Antonakakis
2015 45th Annual IEEE/IFIP International Conference on Dependable Systems and Networks
2015 45th Annual IEEE/IFIP International Conference on Dependable Systems and Networks
Segugio: Efﬁcient Behavior-Based Tracking of
Malware-Control Domains in Large ISP Networks
Babak Rahbarinia1, RobertoPerdisci1,2, and Manos Antonakakis2
2Georgia Institute of Technology
1University of Georgia
{babak,perdisci}@cs.uga.edu
Abstract—In this paper, we propose Segugio, a novel defense
system that allows for efﬁciently tracking the occurrence of
new malware-control domain names in very large ISP networks.
Segugio passively monitors the DNS trafﬁc to build a machine-
domain bipartite graph representing who is querying what. After
labeling nodes in this query behavior graph that are known to be
either benign or malware-related, we propose a novel approach to
accurately detect previously unknown malware-control domains.
We implemented a proof-of-concept version of Segugio and
deployed it in large ISP networks that serve millions of users. Our
experimental results show that Segugio can track the occurrence
of new malware-control domains with up to 94% true positives
(TPs) at less than 0.1% false positives (FPs). In addition, we
provide the following results: (1) we show that Segugio can
also detect control domains related to new, previously unseen
malware families, with 85% TPs at 0.1% FPs; (2) Segugio’s
detection models learned on trafﬁc from a given ISP network
can be deployed into a different ISP network and still achieve
very high detection accuracy; (3) new malware-control domains
can be detected days or even weeks before they appear in a large
commercial domain name blacklist; and (4) we show that Segugio
clearly outperforms Notos, a previously proposed domain name
reputation system.
I.
INTRODUCTION
Despite extensive research efforts, malicious software (or
malware) is still at large. In fact, numbers clearly show that
malware infections continue to be on the rise [1], [2]. Because
malware is at the root of most of today’s cyber-crime, it is
of utmost importance to persist in our battle to defeat it, or
at the very least to severely cripple its ability to cause harm
by tracking and blocking its command-and-control (C&C)
communications.
Our Research. In this paper, we propose Segugio1, a novel
defense system that allows for efﬁciently tracking the occur-
rence of new malware-control domain names in very large ISP
networks. Segugio automatically learns how to discover new
malware-control domain names by monitoring the DNS query
behavior of both known malware-infected machines as well as
benign (i.e., “non-infected”) machines. Our work is based on
the following simple but fundamental intuitions: (1) in time,
as the infections evolve, infected machines tend to query new
malware-control domains; (2) machines infected with the same
malware, or more precisely malware family, tend to query
the same (or a partially overlapping) set of malware-control
domains; and (3) benign machines have no reason to query
malware-control domains that exist for the sole purpose of
providing malware C&C capabilities or other “malware-only”
functionalities.
1The name Segugio refers to an Italian hound dog breed.
PI:EMAIL
?
?
d1
11
d2
222
d3
?
MA
MB
MC
?
Annotations
- IP addresses
- Domain activity
- other info...
?
?
MD
Fig. 1: Machine-domain annotated graph. By observing who is querying what,
we can infer that d3 is likely a malware-related domain, and consequently that
MD is likely infected.
Segugio’s main goal is to track current malware infections
to discover where (i.e. to what new names) malware-control
domains relocate. In addition, we will show that Segugio can
also discover malware-control domains related to new malware
families previously unseen in the monitored networks.
To put the above observations and goals into practice, we
propose an efﬁcient strategy. First, Segugio passively observes
the DNS trafﬁc between the users’ machines and the ISP’s
local DNS resolver to build an annotated bipartite graph
representing who is querying what, as shown in Figure 1. In
this graph, nodes represent either machines or domain names,
and an edge connects a machine to a domain if that machine
queried the domain during the considered trafﬁc observation
time window. The domain nodes are augmented with a number
of annotations, such as the set of IPs a domain resolved
to, its domain activity (e.g., how long ago a domain was
ﬁrst queried), etc. Then, we label as malware those nodes
that are already known to be related to malware control
functionalities. For example, we can ﬁrst label known malware
C&C domains, and as a consequence also propagate that label
to the machines, by marking any machine that queries a C&C
domain as malware-infected. Similarly, we can label as benign
those domains that belong to a whitelist of popular domains
(e.g., according to alexa.com), and consequently propagate
the benign label to machines that query exclusively known
benign domains. All remaining machine nodes are labeled
as unknown, because they do not query any known malware
domain and query at least one unknown domain, whose true
nature is not yet known. Segugio aims to efﬁciently classify
these unknown graph nodes.
Approach. Based on the machine-domain bipartite graph
(Figure 1), we can notice that unknown domains that are con-
sistently queried only (or mostly) by known malware-infected
machines are likely themselves malware-related, especially if
they have been active only for a very short time or point
to previously abused IP space. In essence, we combine the
machines’ query behavior (i.e., who is querying what) with
a number of other domain name features (annotated in the
graph) to compute the probability that a domain name is used
for malware control or that a machine is infected.
978-1-4799-8629-3 2015
978-1-4799-8629-3 2015
U.S. Government Work Not Protected by U.S. Copyright
U.S. Government Work Not Protected by U.S. Copyright
DOI 10.1109/DSN.2015.35
DOI 10.1109/DSN.2015.35
403
403
Authorized licensed use limited to: Tsinghua University. Downloaded on March 19,2021 at 08:49:35 UTC from IEEE Xplore.  Restrictions apply. 
Main Differences w.r.t. Previous Work. Recently, researchers
have proposed domain name reputation systems [3], [4] as a
way to detect malicious domains, by modeling historic domain-
IP mappings, using features of the domain name strings,
and leveraging past evidence of malicious content hosted at
those domains. These systems mainly aim to detect malicious
domains in general, including phishing, spam domains, etc.
Notice that while both Notos [3] and Exposure [4] leverage
information derived from domain-to-IP mappings, they do not
leverage the query behavior of the machines “below” a local
DNS server. Unlike [3], [4], our work focuses speciﬁcally
on accurately tracking new “malware-only” domains by mon-
itoring the DNS query behavior of ISP network users. In
Section V, we show that our approach yields both a lower
false positive rate and much higher true positives, compared
to Notos [3] (we perform a direct comparison to a version of
Notos provided by the original authors of that system).
Kopis [5] has a goal more similar to ours: detect malware-
related domains. However, Kopis’s features (e.g., requester
diversity and requester proﬁle) are engineered speciﬁcally for
modeling trafﬁc collected at authoritative name servers, or
at top-level-domain (TLD) servers, thus requiring access to
authority-level DNS trafﬁc [5]. This type of global access to
DNS trafﬁc is extremely difﬁcult to obtain, and can only be
achieved in close collaboration with large DNS zone operators.
Furthermore, due to the target deployment location, Kopis may
allow for detecting only malware domains that end with a
speciﬁc TLD (e.g., .ca). Unlike Kopis, Segugio allows for
efﬁciently detecting new malware-control domains regardless
of their TLD, by monitoring local ISP trafﬁc (namely, DNS
trafﬁc between ISP users and their local DNS resolver).
Therefore, Segugio can be independently deployed by ISP
network administrators, without the need of a collaboration
with external DNS operators.
Another work related to ours is [6], which uses graphical
models to detect malicious domains via loopy belief propa-
gation [7]. Unlike [6], which is limited to using machine-
domain relationships, Segugio can complement information
about the query behavior of the machines with properties of
the queried domain names (e.g., their lifetime and resolved IP
information). This allows us to achieve a signiﬁcantly higher
accuracy, compared to [6], especially at low false positive rates.
In addition, the approach in [6] does not scale well to the very
large ISP-level DNS trafﬁc that is the target of our work. On
the other hand, Segugio is speciﬁcally designed to be highly
efﬁcient and has been evaluated in multiple very large ISP
networks. To concretely compare our own Segugio system to
the approach proposed in [6], we implemented loopy belief
propagation using the GraphLab [8] distributed computing
framework, and performed a number of pilot experiments
over the same datasets we use for evaluating Segugio (see
Section III). Our results indicate that Segugio on average can
achieve 45% better accuracy, compared to [6]. In addition,
the efﬁcient classiﬁcation approach we propose in this paper
allows us to process an entire day of DNS trafﬁc in minutes,
rather the tens of hours required by loopy belief propagation.
We further discuss the differences between Segugio and
other related work in Section VII.
Summary of Our Contributions. In summary, with Segugio
we make the following contributions:
• We propose a novel behavior-based system that can
efﬁciently detect
the occurrence of new malware-
control domains by tracking the DNS query behavior
of malware infections in large ISP networks.
• We implemented a proof-of-concept version of Segu-
gio, and deployed it in two large ISP networks that
serve millions of users. Our experimental results show
that Segugio in average can classify an entire day
worth of ISP-level DNS trafﬁc in just a few minutes,
achieving a true positive (TP) rate above 94% at less
than 0.1% false positives (FPs).
• We provide the following additional results: (1) we
show that Segugio can also detect malware-control do-
mains related to previously unseen malware families,
with 85% TPs at 0.1% FPs; (2) Segugio’s detection
models learned on trafﬁc from an ISP network can be
deployed into another ISP network and still achieve
very high detection accuracy; (3) new malware-control
domains can be detected days or even weeks before
they appear in a large commercial domain name black-
list; and (4) we show that Segugio clearly outperforms
Notos [3].
II. SEGUGIO SYSTEM DESCRIPTION
Segugio’s main goal is to track the DNS query behavior
of current malware infected machines to discover their new
malware-control domains. In addition, in Section IV-C we
show that Segugio is also capable of discovering domains
related to malware families previously unseen in the monitored
networks. In this section, we ﬁrst motivate the intuitions
on which our system is based, and then describe Segugio’s
components.
Intuitions. As mentioned in Section I, Segugio is based on
the following main intuitions: (1) in time, infected machines
tend to query new malware-related domains; (2) machines
infected with the same malware family tend to query partially
overlapping sets of malware-control domains; and (3) benign
machines have no reason to query domains that exist for the
sole purpose of providing “malware-only” functionalities.
We motivate the above three intuitions as follows (in
reverse order), deferring a discussion of possible limitations
and corner cases to Section VI. Intuition (3) is motivated by the
fact that most malware-control domains host no benign content
whatsoever, because they are often registered exclusively for
supporting malware operations. This is particularly true for “re-
cently activated” domains. Therefore, non-infected machines
would have no reason to reach out to such domains. Intuition
(2) relates to the fact that different variants of a same original
malware are semantically similar, and will therefore exhibit
similar network behavior. Finally, intuition (1) is motivated
by the fact
that malware needs to employ some level of
network agility, to avoid being trivially blacklisted. To this
end, malware-control servers will periodically relocate to new
domain names and/or IP addresses. This intuition is further
supported by the measurements on real-world ISP-level DNS
trafﬁc reported in Figure 3. During one day of trafﬁc observa-
tion, roughly 70% of the malware-infected machines queried
404404
Authorized licensed use limited to: Tsinghua University. Downloaded on March 19,2021 at 08:49:35 UTC from IEEE Xplore.  Restrictions apply. 
Local DNS 
Resolver
- Blacklists
- Whitelists
Active Domains
Build Machine-Domain
Behavior Graph
Annotate
and Label Nodes
Graph Pruning
(de-noising)
Behavior-Based
Domain Classiﬁer
Large ISP
Network
Reports:
- New Malware Domains
- List of Infections
Passive
DNS DB
Fig. 2: Segugio system overview.
Fig. 3: Distribution of the number of malware-control domains queried by
infected machines. About 70% of known malware-infected machines query
more than one malware domain.
more than one malware-control domain name (Figure 3 also
shows that it is extremely unlikely that an infected machine
queries more than twenty malware-control domains in one
day). We also veriﬁed that these results are consistent across
different observation days and different large ISP networks.
A. System Components
We now describe the components of our Segugio system,
which are also shown in Figure 2.
1) Machine-Domain Behavior Graph: As a ﬁrst step, Segu-
gio monitors the DNS trafﬁc between the machines in a large
ISP network and their local DNS server, for a given observation
time window T (e.g., one day). Accordingly, it constructs a
machine-domain graph that describes who is querying what.
Notice that we are only interested in authoritative DNS re-
sponses that map a domain to a set of valid IP addresses.
Based on the monitored trafﬁc, Segugio builds an undi-
rected bipartite graph G = (M, D, E) that captures the DNS
query behavior of machines in the ISP network. Nodes in
the set M represent machines, whereas nodes in D represent
domain names. A machine mi ∈ M is connected to a domain
dj ∈ D by an edge eij ∈ E, if mi queried dj during the
observation window T .
Node Annotations and Labeling. We augment each domain
node dj ∈ D by recording the set of IP addresses that
the domain pointed to during the observation window T (as
collected from the live DNS trafﬁc). In addition, we estimate
how long ago (w.r.t. to T ) the domain was ﬁrst queried.
We then label machine and domain nodes as either
malware, benign, or unknown. Speciﬁcally, by leveraging a
small number of public and private malware C&C domain
blacklists, we can ﬁrst label known malware-control domains
as malware. To label benign domains, we leverage the top
one-million most popular second-level domains according to
alexa.com. Speciﬁcally, we label as benign those domains
whose effective second-level domain2 consistently appeared
in the top one-million alexa.com list for about one year (see
Section III for details). These domains are unlikely to be used
for malware control. Notice also that we take great care to
exclude certain “free registration” second-level domains from
our whitelist, such as dynamic DNS domains, blog domains,
etc., because subdomains of these second-level domains can
be freely registered and are very often abused. At the same
time, we acknowledge that perfectly ﬁltering the whitelist is
difﬁcult, and that some amount of noise (i.e., a few malicious
domains) may still be present. In Section IV-D we discuss the
potential impact of such whitelist noise, which may cause us
to somewhat overestimate our false positives.
All remaining domains are labeled as unknown, since we
don’t have enough information about their true nature. These
unknown domains are the ones we ultimately want to classify,
to discover previously unknown malware-control domains.
Finally, we label machines as malware, if they query malware-
control domains, in that they are highly likely infected. We can
also label as benign those machines that query only known
benign domains. All other machines are labeled as unknown.
2) Graph Pruning: Because we aim to monitor all DNS
trafﬁc in large ISP networks, our machine-domain graph G may
contain several million machine nodes, hundreds of millions
of distinct domain nodes, and potentially billions of edges. To
boost performance and reduce noise, we prune the graph using
the following conservative rules:
(R2)
(R1) We identify and discard machines that are essentially
“inactive”, because it is unlikely that they can help our
detection system. To be conservative, we only ﬁlter out
machines that query (cid:2) 5 domains.
In our ISP test networks, we observed a number of
machine nodes that likely represent large proxies or
DNS forwarders serving an entire enterprise network.
Such devices appear as nodes with very high degree,
and tend to introduce substantial levels of “noise”.
We therefore ﬁlter them by discarding all machines
that query (cid:3) θd domains. Empirically setting θd to
be the 99.99-percentile of the distribution of number