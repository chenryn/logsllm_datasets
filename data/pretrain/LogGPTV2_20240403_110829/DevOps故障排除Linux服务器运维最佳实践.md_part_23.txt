306 unused
服务器会在应答URI字段提供了一个代理，被请求的资源必须
客户端发送GET请求获取资源，
304 Not Modified
与 401响应不同的是，
403Forbidden
当前请求需要用户验证，因此客户端需要以合适的授权重新发
这个错误码用于告诉客户端它发送了一个错误的请求。
400 Bad Request
这个状态码当前没使用
305 Use Proxy
401 Unauthorized
4××客户端错误状态码
，身份验证并不能提供任何帮助，而且这
，如果被请求的资源被修改才返
8.3HTTP状态码·143
---
## Page 151
144
这个资源，现在这个资源已经不存在了。
·第8章网站宕机了？追踪Web服务器问题
正在维护。
器的无效响应就会提示该错误码。
中的漏洞导致文件执行出错，就会见到这个错误状态码。
过这些错误很可能是发生在服务器端。如果你是Web 服务器管理
8.3.5
更多信息，进而找到造成错误的原因。下面是一些示例错误码：
员，看到这类的错误码，你需要查看Web 服务器的错误日志来获取
障可能会遇到这个状态码。
应重定向的页面，或者该页面以前存在现在已经被删除了。
请求有误的情况，
504 Gateway Timeout
服务器目前无法为请求提供服务，经常是因为服务器过载或者
503 Service Unavailable
如果服务器被设置为网关或者代理设备，但是收到了上游服务
501 Not Implemented
服务器处理请求时遇到内部错误。若某个CGI或者PHP脚本
服务器尝试执行请求时，未能及时从上游服务器获取到请求
502 Bad Gateway
500 Internal Server Error
类似于4××状态码，5××状态码也是处理请求错误，只不
与3××重定向请求不同，这个错误码用以标记服务器曾经有
410 Gone
客户端完成请求时花费的时间太长，使用 telnet诊断服务器故
408Request Timeout
服务器未找到请求所希望得到的资源，该错误码常出现在用户
服务器不支持客户端的请求方法。
5××服务器错误状态码
，或者客户端请求了一个已经被移走却没有设置相
---
## Page 152
8.4分析Web服务器的日志
解，我们也可以作些猜测。首先，请求的IP地址是10.1.2.3。之
而www.example.org.log记录了大部分数据。
默认的日志格式类似并且都把请求日志记录在 access.log，把错误记
同样Nginx在/var/log/nginx目录下存储日志。这两个 Web服务器
log/apache2（apache或httpd，取决于使用的系统）目录下存储日志，
版本。
LDAP，甚至DNS 服务器超时所致。
的响应。上游服务器可能是HTTP，但这种情况也有可能是FTP、
数据或者不可用，用“-”替代。本例中，即使对日志格式不了
本章前面用到的curl命令发送请求并查看相应的请求记录。
（虚拟主机）配置了各自的日志文件，因此 access.log可能是空的，
录在errors.log 文件里。除此之外，大多数系统管理员为每个站点
古怪，但是每一行都包括了对故障诊断有用的信息。Apache在/var/
服务器的每个请求会以标准格式记录在日志里，这个格式乍看有些
为了展示从 Web 服务器日志中可以获取的信息种类，我们使用
诊断 Web 服务器故障的一个主要手段就是分析日志。访问 Web
505 HTTP Version Not Supported
不言自明，服务器收到的请求使用了它不支持的HTTP协议
每条日记记录被分成许多不同的字段，如果某个字段没有
$curl-w"%[http_code}\n"http://ww.example.net
The web server software is running but no content has been added, yet.
This is the default web page for this server.
Itworks!
200
8.4分析Web服务器的日志145
---
## Page 153
146
返回“”)。
说明：
项列表记录在 Apache 配置文件中，这里有一些格式化字符串的
得每个请求更多的相关信息。不过Apache 默认的日志格式配置如
less 这样的翻页工具去查看日志而不是用vi。
为不会再修改web日志文件，我们只是去查看它们，因此应该使用
有多少次，
件的副本（在/tmp目录或者用户的根目录)。这么做对小文件来说
件在内的任何文件。遗憾的是，vi习惯在临时空间保存一份打开文
注意
后，在日志的结尾是客户端传给服务器的User-Agent 信息，本例
HTTP/1.1），紧接着后面的 200是请求响应的HTTP 状态码。最
后是请求的时间戳。其次是服务器处理的HTTP请求（GET
?
下所示：
有人在/tmp 目录下打开了一个几千吉字节的Web服务器日志。
没有问题，
中，
第8章
如果你和我一样也使用vi的话，你可能会用它打开包括日志文
，客户端被识别为curl。
远程用户名（如果访问该页面需要权限返回远程用户名，否则
每个冠以%的符号表示要存在日志当中的数据。完整的选
每一种Web 服务器都允许定制日志的输出格式，所以你可以获
远程登录名（通常返回“-”，除非打开IdentCheck 选项）。
远程主机（主机名或者IP）。
口%1
%h
LogFormat "%h %] %u %t \"%r\" %>s % \"%[Referer}i\"\"%{User-Agent}i\"" combined
%u
网站宕机了？追踪Web服务器问题
当我去排查Web服务器硬盘空间用尽问题的时候，发现
但是Web服务器的日志大小能增长到数吉字节。记不清
团
---
## Page 154
供几个基本的例子供你使用。首先是一个简单的 grep 命令，提取
的数据。在这种情况下，类似 grep 或者 perl这类命令行工具是首选
某一天的日志：
管道输出给wc-1，就可以统计输出数据有多少行。
出来自某个指定源IP的所有日志。在这个例子中，查找来自主机
工具，原因很简单，几乎每台主机都安装了这些工具。
有帮助；但是诊断故障时，通常你只想获取某个特定IP或者URI
都能分析和展示日志中的数据。这类软件对获取统计数据和趋势很
10.1.2.3的所有日志记录。
网上有很多用一行命令从Web日志中提取数据的例子，下面提
因为大多Web 服务器的日志都使用了标准格式，所以很多工具
或者如果你想统计某个IP发送了多少请求，可以把查找结果用
请求的第一行数据。
状态码。
请求收到的时间。
当然，如果日志文件中包含了若干天的日志记录，而你只关心
HTTP请求头部指定字段的内容。
%{Header}i
已发送字节数，含HTTP头部数据。
% 
%s
1%
1%
1- 3160ss/zayde/60//, zTy,daa s
10.1.2.3 --[04/Ju1/2012:12:08:05-0700"GET/HTTP/1.1" 200 303"""cur1/7.19.7
$egrep'){if(ml(^\d+\.\d+\.\d+).\d+).?04/Jul/2012| ）{ sv{$1}++;}}
#!/usr/bin/perl
从结果里可以看到，内网IP地址（10.2.1.3）的请求数据大概
使用perl，可以从Apache日志文件中提取更多有趣的统计数
foreach(keys %v )
while(
ExtendedStatus On
#V
listen 127.0.0.1:80;
with the URL ofhttp://servername/server-status
access fromother hosts.
Uncomment and change the".example.com"to allow
location/nginx_status
Allow from localhost ip6-localhost
Order deny,allow
SetHandler server-status
Deny from all
网站宕机了？追踪Web服务器问题
stub_status on;
deny all;
allow 127.0.0.1;
access_log off;