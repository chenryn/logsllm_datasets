## 概要
通过利用内部版本（称为“狗粮”）的谷歌云部署管理器（Google Cloud Deployment Manager），我能够借助Google的全球服务负载平衡器（Global Service Load Balancer，GSLB）向某些Google内网站点发出请求，从而导致远程代码执行（RCE）漏洞。

### 相关定义
- **狗粮（Dogfood）**：Google在其内部广泛使用自己的产品进行测试。在正式对外发布前，这些产品的内部测试版本被称为“狗粮”，它们可能包含一些公众无法使用的功能，但稳定性可能较差。
- **谷歌云部署管理器（Google Cloud Deployment Manager）**：这是一种基础设施部署服务，允许用户通过编写灵活的模板和配置文件自动创建和管理Google Cloud资源。
- **全球服务负载平衡器（Global Service Load Balancer, GSLB）**：GSLB是Google的全球软件负载均衡器，用于在不同集群之间分配实时用户流量，确保用户需求与可用服务容量匹配，并能透明地处理服务故障。

### 漏洞细节
该漏洞可以通过向部署管理器发送特定请求来触发，此请求用于创建类型提供器（Type Provider），并添加一个未记录的字段`googleOptions`。在此异步操作过程中，部署管理器尝试从指定的描述符URL中检索描述符文件。如果操作失败，返回的错误消息可能会泄露某些信息；反之，则可能允许攻击者发起复杂的内部请求。需注意，此问题不仅限于API请求，尽管对于这类请求效果最为显著。

提交漏洞报告后，Google支付了$31,337作为奖励。

## 介绍
部署管理器是一种Google云服务，提供了以编程方式创建、删除和修改基础架构资源的方法。相关概念包括：
- **类型**：描述特定类型的基础架构资源属性，如虚拟机（VM）、发行凭证等。
- **类型提供器**：提供可用于管理特定服务类型的API站点及其描述符文档。
- **资源**：由类型提供的单个基础架构资源实例。
- **模板**：可重用的Python或Jinja2文件，用于配置资源。
- **部署**：资源集合，支持同时部署和管理。
- **操作**：所有在部署管理器中完成的操作都会返回一个操作对象，可以轮询以检查其状态。

与部署管理器交互的主要途径是通过其REST API，目前有两个公开版本：`v2`（稳定版）和`v2beta`（公测版）。值得注意的是，类型提供器仅在`v2beta`版本中可用。

## 说明
初学者可能觉得理解谷歌云部署管理器有些困难。建议感兴趣的读者先熟悉一下，尤其是通过`v2beta` REST API的方式。本文将提供一些有用的链接以帮助更好地理解相关内容。

## 安全研究
### 隐藏类型探索
首先，我尝试寻找隐藏或内部类型，因为某些Google服务（例如Google App Engine Flexible）在内部使用部署管理器。然而，这一尝试并未发现任何有用信息。

### 模板审查
接着，我查看了`Jinja2`和`Python`模板。经过反复试验，最终能够使用特制模板创建出在操作过程中返回数据为Python异常的部署。这种方法让我得以检查Python库、读取代码及列出/读取文件。不过，由于解释脚本运行于零权限隔离环境中，且无网络连接，因此实际影响有限。

### 类型提供器实验
随后，我试图创建指向Google内网服务API的类型提供器，但始终收到描述符文档获取失败的错误提示。即使尝试了绕过私有IP地址限制的方法也未能成功。

### 发现新版本
经过一段时间的停滞，我决定深入研究部署管理器API方法。通过访问指标页面并在过滤器中搜索，我发现除了已知的`v2`和`v2beta`外，还有两个未记录的API版本：`alpha`和`dogfood`。替换API调用中的版本号即可引用这些版本的方法。

虽然`alpha`版本未发现有价值的内容，但在`dogfood`版本中找到了有趣的东西。特别是注意到大多数基本类型在其定义中包含了额外字段`googleOptions`。进一步探索后，发现了多个未知用途但似乎与GSLB相关的参数。这些参数可能被用于实现内部服务器的服务器端请求伪造（SSRF）攻击。