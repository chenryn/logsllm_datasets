## 前言
本次靶场要求：
- 提示：获取四个 `root.txt` 文件，分别位于四台机器的用户目录下。拿到三个文件即为及格，全部四个文件则为满分。

## 代码审计 Getshell
首先访问网站 `cocat.cc`。
- 通过提示下载了该站点的备份文件，并在本地进行了代码审计。

### Bypass 突破执行命令
- 通过代码审计获得了 webshell。
- 当前环境无法直接执行命令，因为相关函数已被禁用。
- 在文件中找到了 MySQL 的配置文件。
- 尝试使用 MySQL UDF 提权但发现 MySQL 版本高于 5.1，此方法不可行。

#### 拿到宝塔后台权限
- 确认当前 web 服务器由宝塔面板搭建。
- 查找并下载宝塔面板的配置文件 `C:/BtSoft/panel/data/admin_path.pl` 和数据库文件 `default.db`。
- 从 `default.db` 中提取出宝塔的登录账号和密码（MD5 加密）。
- 由于 MD5 密码无法解密，选择替换或添加新用户。
- 更新后的文件上传回目标服务器，使用新账户 `saulGoodmang:123456` 登录宝塔面板。
- 关闭禁用的函数并重启服务以实现命令执行绕过。

#### 拿到第一个 root.txt
- 成功获取第一个 flag: `flag{moonsec-c20ad4d76fe97759aa27a0c99bff6710-1}`

## 内网渗透一
- 检测到系统上安装了火绒 AV，使用免杀技术将恶意软件上线至 Cobalt Strike (CS)。
- 使用 `nbtscan` 和 `fscan` 发现内网中有其他主机存活。
- 设置 FRP Socks 代理进入内网，并利用脚本绕过火绒 AV 添加了一个新用户 `hacker:P@ssw0rd`。
- 开启远程桌面服务 (RDP) 并将 shell 弹回 Metasploit Framework (MSF)。
- 抓取到了多个用户的哈希值，成功解密得到管理员密码 `QWEasd444`。

### 内网横向移动 - 192.168.59.4
- 使用 MSF 扫描内网发现另一台主机 `192.168.59.4`。
- 通过 nmap 扫描确认开放端口，包括 Redis 服务。
- 利用 Redis 未授权访问漏洞尝试连接，但需要破解密码。
- 使用 MSF 模块爆破 Redis 密码后重新登录。
- 尝试写入 ASPX shell 到 IIS 默认目录，最终通过设置读写权限成功上传。

## 内网渗透二
- 发现当前机器不联网且权限较低。
- 找到一个可读写的目录 `C:\ProgramData\VMware\logs\` 并进行提权操作。
- 获取第二个 flag: `flag{moonsec-b6d767d2f8ed5d21a44b0e5886680cb9-2}`

### 内网渗透 - 10.10.10.202
- 对内网进行存活探测，发现三台活跃主机。
- 关闭防火墙并生成正向 shell，使 MSF 上线。
- 解密哈希值获得密码 `QWEasd1122` 并开启 RDP。
- 识别域控制器存在 CVE-2020-1472 漏洞，利用 Mimikatz 实施攻击。
- 最终通过 SMB psexec 获得域控权限，完成最后一个 flag 的获取。

## 总结
对于红队成员来说，全面掌握各种渗透技术和漏洞复现至关重要。此次考核中因未熟悉 Exchange 相关漏洞导致时间浪费较多，实际环境中应更加谨慎以避免潜在风险。

## 结尾
若有任何建议或发现错误，请在评论区留言！