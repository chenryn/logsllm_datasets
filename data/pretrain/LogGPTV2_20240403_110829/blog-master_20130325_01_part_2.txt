 18585 |    12816 |      828 | relation | AccessShareLock | t       | pg_default_acl_oid_index    
 18585 |        0 |     1213 | relation | AccessShareLock | t       | pg_tablespace    
 18585 |    12816 |     1247 | relation | AccessShareLock | t       | pg_type    
 18585 |    12816 |     1249 | relation | AccessShareLock | t       | pg_attribute    
 18585 |    12816 |     1255 | relation | AccessShareLock | t       | pg_proc    
 18585 |    12816 |     1259 | relation | AccessShareLock | t       | pg_class    
 18585 |        0 |     1260 | relation | AccessShareLock | t       | pg_authid    
 18585 |        0 |     1262 | relation | AccessShareLock | t       | pg_database    
 18585 |    12816 |     1417 | relation | AccessShareLock | t       | pg_foreign_server    
 18585 |    12816 |     2187 | relation | AccessShareLock | t       | pg_inherits_parent_index    
 18585 |    12816 |     2328 | relation | AccessShareLock | t       | pg_foreign_data_wrapper    
 18585 |        0 |     2396 | relation | AccessShareLock | t       | pg_shdescription    
 18585 |        0 |     2397 | relation | AccessShareLock | t       | pg_shdescription_o_c_index    
 18585 |    12816 |     2605 | relation | AccessShareLock | t       | pg_cast    
 18585 |    12816 |     2607 | relation | AccessShareLock | t       | pg_conversion    
 18585 |    12816 |     2608 | relation | AccessShareLock | t       | pg_depend    
 18585 |    12816 |     2609 | relation | AccessShareLock | t       | pg_description    
 18585 |    12816 |     2611 | relation | AccessShareLock | t       | pg_inherits    
 18585 |    12816 |     2612 | relation | AccessShareLock | t       | pg_language    
 18585 |    12816 |     2615 | relation | AccessShareLock | t       | pg_namespace    
 18585 |    12816 |     2616 | relation | AccessShareLock | t       | pg_opclass    
 18585 |    12816 |     2617 | relation | AccessShareLock | t       | pg_operator    
 18585 |    12816 |     2618 | relation | AccessShareLock | t       | pg_rewrite    
 18585 |    12816 |     2658 | relation | AccessShareLock | t       | pg_attribute_relid_attnam_index    
 18585 |    12816 |     2659 | relation | AccessShareLock | t       | pg_attribute_relid_attnum_index    
 18585 |    12816 |     2660 | relation | AccessShareLock | t       | pg_cast_oid_index    
 18585 |    12816 |     2661 | relation | AccessShareLock | t       | pg_cast_source_target_index    
 18585 |    12816 |     2662 | relation | AccessShareLock | t       | pg_class_oid_index    
 18585 |    12816 |     2663 | relation | AccessShareLock | t       | pg_class_relname_nsp_index    
 18585 |    12816 |     2668 | relation | AccessShareLock | t       | pg_conversion_default_index    
 18585 |    12816 |     2669 | relation | AccessShareLock | t       | pg_conversion_name_nsp_index    
 18585 |    12816 |     2670 | relation | AccessShareLock | t       | pg_conversion_oid_index    
 18585 |        0 |     2671 | relation | AccessShareLock | t       | pg_database_datname_index    
 18585 |        0 |     2672 | relation | AccessShareLock | t       | pg_database_oid_index    
 18585 |    12816 |     2673 | relation | AccessShareLock | t       | pg_depend_depender_index    
 18585 |    12816 |     2674 | relation | AccessShareLock | t       | pg_depend_reference_index    
 18585 |    12816 |     2675 | relation | AccessShareLock | t       | pg_description_o_c_o_index    
 18585 |        0 |     2676 | relation | AccessShareLock | t       | pg_authid_rolname_index    
 18585 |        0 |     2677 | relation | AccessShareLock | t       | pg_authid_oid_index    
 18585 |    12816 |     2680 | relation | AccessShareLock | t       | pg_inherits_relid_seqno_index    
 18585 |    12816 |     2681 | relation | AccessShareLock | t       | pg_language_name_index    
 18585 |    12816 |     2682 | relation | AccessShareLock | t       | pg_language_oid_index    
 18585 |    12816 |     2684 | relation | AccessShareLock | t       | pg_namespace_nspname_index    
 18585 |    12816 |     2685 | relation | AccessShareLock | t       | pg_namespace_oid_index    
 18585 |    12816 |     2686 | relation | AccessShareLock | t       | pg_opclass_am_name_nsp_index    
 18585 |    12816 |     2687 | relation | AccessShareLock | t       | pg_opclass_oid_index    
 18585 |    12816 |     2688 | relation | AccessShareLock | t       | pg_operator_oid_index    
 18585 |    12816 |     2689 | relation | AccessShareLock | t       | pg_operator_oprname_l_r_n_index    
 18585 |    12816 |     2690 | relation | AccessShareLock | t       | pg_proc_oid_index    
 18585 |    12816 |     2691 | relation | AccessShareLock | t       | pg_proc_proname_args_nsp_index    
 18585 |    12816 |     2692 | relation | AccessShareLock | t       | pg_rewrite_oid_index    
 18585 |    12816 |     2693 | relation | AccessShareLock | t       | pg_rewrite_rel_rulename_index    
 18585 |        0 |     2697 | relation | AccessShareLock | t       | pg_tablespace_oid_index    
 18585 |        0 |     2698 | relation | AccessShareLock | t       | pg_tablespace_spcname_index    
 18585 |    12816 |     2703 | relation | AccessShareLock | t       | pg_type_oid_index    
 18585 |    12816 |     2704 | relation | AccessShareLock | t       | pg_type_typname_nsp_index    
 18585 |    12816 |     2753 | relation | AccessShareLock | t       | pg_opfamily    
 18585 |    12816 |     2754 | relation | AccessShareLock | t       | pg_opfamily_am_name_nsp_index    
 18585 |    12816 |     2755 | relation | AccessShareLock | t       | pg_opfamily_oid_index    
 18585 |        0 |     2964 | relation | AccessShareLock | t       | pg_db_role_setting    
 18585 |        0 |     2965 | relation | AccessShareLock | t       | pg_db_role_setting_databaseid_rol_index    
 18585 |    12816 |     2995 | relation | AccessShareLock | t       | pg_largeobject_metadata    
 18585 |    12816 |     2996 | relation | AccessShareLock | t       | pg_largeobject_metadata_oid_index    
 18585 |    12816 |     3079 | relation | AccessShareLock | t       | pg_extension    
 18585 |    12816 |     3080 | relation | AccessShareLock | t       | pg_extension_oid_index    
 18585 |    12816 |     3081 | relation | AccessShareLock | t       | pg_extension_name_index    
 18585 |    12816 |     3085 | relation | AccessShareLock | t       | pg_collation_oid_index    
 18585 |    12816 |     3164 | relation | AccessShareLock | t       | pg_collation_name_enc_nsp_index    
 18585 |    12816 |     3456 | relation | AccessShareLock | t       | pg_collation    
 18585 |    12816 |     3466 | relation | AccessShareLock | t       | pg_event_trigger    
 18585 |    12816 |     3467 | relation | AccessShareLock | t       | pg_event_trigger_evtname_index    
 18585 |    12816 |     3468 | relation | AccessShareLock | t       | pg_event_trigger_oid_index    
 18585 |        0 |     3592 | relation | AccessShareLock | t       | pg_shseclabel    
 18585 |        0 |     3593 | relation | AccessShareLock | t       | pg_shseclabel_object_index    
 18585 |    12816 |     3596 | relation | AccessShareLock | t       | pg_seclabel    
 18585 |    12816 |     3597 | relation | AccessShareLock | t       | pg_seclabel_object_index    
 18585 |    12816 |     3600 | relation | AccessShareLock | t       | pg_ts_dict    
 18585 |    12816 |     3601 | relation | AccessShareLock | t       | pg_ts_parser    
 18585 |    12816 |     3602 | relation | AccessShareLock | t       | pg_ts_config    
 18585 |    12816 |     3604 | relation | AccessShareLock | t       | pg_ts_dict_dictname_index    
 18585 |    12816 |     3605 | relation | AccessShareLock | t       | pg_ts_dict_oid_index    
 18585 |    12816 |     3606 | relation | AccessShareLock | t       | pg_ts_parser_prsname_index    
 18585 |    12816 |     3607 | relation | AccessShareLock | t       | pg_ts_parser_oid_index    
 18585 |    12816 |     3608 | relation | AccessShareLock | t       | pg_ts_config_cfgname_index    
 18585 |    12816 |     3712 | relation | AccessShareLock | t       | pg_ts_config_oid_index    
 18585 |    12816 |     3764 | relation | AccessShareLock | t       | pg_ts_template    
 18585 |    12816 |     3766 | relation | AccessShareLock | t       | pg_ts_template_tmplname_index    
 18585 |    12816 |     3767 | relation | AccessShareLock | t       | pg_ts_template_oid_index    
 18585 |    12816 |    11054 | relation | AccessShareLock | t       | pg_roles    
 18585 |    12816 |    16384 | relation | AccessShareLock | t       | t1    
 18585 |    12816 |    16390 | relation | AccessShareLock | t       | t2    
 18585 |    12816 |    16396 | relation | AccessShareLock | t       | t3    
 18585 |    12816 |    16402 | relation | AccessShareLock | t       | t4    
 18585 |    12816 |    16408 | relation | AccessShareLock | t       | t5    
 18585 |    12816 |    16414 | relation | AccessShareLock | t       | t6    
 18585 |    12816 |    16420 | relation | AccessShareLock | t       | t7    
 18585 |    12816 |    16426 | relation | AccessShareLock | t       | t8    
 18585 |    12816 |    16449 | relation | AccessShareLock | t       | t9    
 18588 |    12816 |     1259 | relation | AccessShareLock | t       | pg_class    
 18588 |    12816 |     2615 | relation | AccessShareLock | t       | pg_namespace    
 18588 |    12816 |     2662 | relation | AccessShareLock | t       | pg_class_oid_index    
 18588 |    12816 |     2663 | relation | AccessShareLock | t       | pg_class_relname_nsp_index    
 18588 |    12816 |     2684 | relation | AccessShareLock | t       | pg_namespace_nspname_index    
 18588 |    12816 |     2685 | relation | AccessShareLock | t       | pg_namespace_oid_index    
 18588 |    12816 |    16426 | relation | AccessShareLock | t       | t8    
 18589 |    12816 |     1259 | relation | AccessShareLock | t       | pg_class    
 18589 |    12816 |     2615 | relation | AccessShareLock | t       | pg_namespace    
 18589 |    12816 |     2662 | relation | AccessShareLock | t       | pg_class_oid_index    
 18589 |    12816 |     2663 | relation | AccessShareLock | t       | pg_class_relname_nsp_index    
 18589 |    12816 |     2684 | relation | AccessShareLock | t       | pg_namespace_nspname_index    
 18589 |    12816 |     2685 | relation | AccessShareLock | t       | pg_namespace_oid_index    
 18589 |    12816 |    16408 | relation | AccessShareLock | t       | t5    
(118 rows)    
```    
随着备份的进行, 继续查询.... pg_dump的子进程需要继续获取t1,t3,t2,t4的AccessShareLock锁.    
```    
 18588 |    12816 |     1259 | relation | AccessShareLock     | t       | pg_class    
 18588 |    12816 |     2615 | relation | AccessShareLock     | t       | pg_namespace    
 18588 |    12816 |     2662 | relation | AccessShareLock     | t       | pg_class_oid_index    
 18588 |    12816 |     2663 | relation | AccessShareLock     | t       | pg_class_relname_nsp_index    
 18588 |    12816 |     2684 | relation | AccessShareLock     | t       | pg_namespace_nspname_index    
 18588 |    12816 |     2685 | relation | AccessShareLock     | t       | pg_namespace_oid_index    
 18588 |    12816 |    16384 | relation | AccessShareLock     | t       | t1    
 18588 |    12816 |    16396 | relation | AccessShareLock     | t       | t3    
 18588 |    12816 |    16426 | relation | AccessShareLock     | t       | t8    
 18589 |    12816 |     1259 | relation | AccessShareLock     | t       | pg_class    
 18589 |    12816 |     2615 | relation | AccessShareLock     | t       | pg_namespace    
 18589 |    12816 |     2662 | relation | AccessShareLock     | t       | pg_class_oid_index    
 18589 |    12816 |     2663 | relation | AccessShareLock     | t       | pg_class_relname_nsp_index    
 18589 |    12816 |     2684 | relation | AccessShareLock     | t       | pg_namespace_nspname_index    
 18589 |    12816 |     2685 | relation | AccessShareLock     | t       | pg_namespace_oid_index    
 18589 |    12816 |    16390 | relation | AccessShareLock     | t       | t2    
 18589 |    12816 |    16402 | relation | AccessShareLock     | t       | t4    
 18589 |    12816 |    16408 | relation | AccessShareLock     | t       | t5    
```    
SESSION A :     
当pg_dump的子进程获取t7的AccessShareLock锁时会失败. 因为SESSION B在等待与之冲突的Exclusive Lock. 而pg_dump使用的是nowait进行锁请求, 当pg_dump获取锁失败后马上退出, pg_dump主进程虽然已经获取了t7的AccessShareLock, 但是为了保证整个备份的一致性, 也会退出.    
```    
pg_dump: [parallel archiver] could not obtain lock on relation "public.t7". This usually means that someone requested an ACCESS EXCLUSIVE lock on the table after the pg_dump parent process has gotten the initial ACCESS SHARE lock on the table.    
Mon Mar 25 11:29:43 CST 2013    
SESSION B :    
TRUNCATE TABLE    
complete    
```    
## 参考    
1\. https://github.com/postgres/postgres/commit/9e257a181cc1dc5e19eb5d770ce09cc98f470f5f    
2\. http://www.postgresql.org/message-id/CACw0+PI:EMAIL    
3\. http://www.postgresql.org/docs/devel/static/app-pgdump.html    
4\. http://blog.163.com/digoal@126/blog/static/163877040201222112937900/    
5\. http://blog.163.com/digoal@126/blog/static/163877040201326829943/    
6\. http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/    
7\. pg_dump --help    
```    
pg_dump dumps a database as a text file or to other formats.    
Usage:    
  pg_dump [OPTION]... [DBNAME]    
General options:    