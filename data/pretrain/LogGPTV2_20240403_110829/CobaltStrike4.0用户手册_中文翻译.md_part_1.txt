Cobalt Strike 4.0 手册——献给渗透测试人
员的先进威胁战术（2019年12月2日更新版
本）
翻译校对
翻译：Snowming
校对：L.N.
团队介绍
奇安信 A-TEAM 是奇安信集团旗下的纯技术研究团队，团队主要致力于Web渗透，APT攻防、对抗，前
瞻性攻防工具预研，从底层原理、协议层面进行严肃、有深度的技术研究，深入还原攻与防的技术本
质，曾多次率先披露 Windows域、Exchange、Weblogic、Exim等重大安全漏洞，第一时间发布相关
漏洞预警及可行的处置措施并获得官方致谢👏👏。
团队博客
https://blog.ateam.qianxin.com/
团队 GitHub
https://github.com/QAX-A-Team
团队公众号
英文名词翻译对照表
名词 翻译 注释
Artifact 工件
Artifact Kit
集
Data Channel 数据通道
Data Model 数据模型
External C2 外置 C2
Foreign
对外监听器
Listener(s)
Keystroke
键盘记录器
Logger
Malleable C2
C2 拓展文件
Profile
Named Pipe(s) 命名管道
Network
网络流量指标
Indicators
Payload Staging 分阶段投递 Payload
Peer-to-peer
对等通信
Communication
Peer-to-peer C2 对等 C2
Pipe 管道
Pivot Graph Pivot 图
Port Bending 端口弯曲重定 例如，接受来自 80 或 443 端口的连接但将连接路由到团
Redirector 向器 队服务器开在另一个端口上的连接，这样的重定向器。
Post-
后渗透
Exploitation
PowerShell PowerShell
one-liner 单行程序
Session 会话
Sessions Table 会话表
Strategic
Strategic Cyber
Cyber 责任有 Cobalt Strike 是 Strategic Cyber 责任有限公司的产品
LLC
限公司
英文名词翻译对照表（续）
名词 翻译 注释
System Profiler 是一个探针
Targets Table 目标表
Token 令牌
第一章 欢迎来到 Cobalt Strike 的世界！
1.1 什么是 Cobalt Strike？
Cobalt Strike 是一个为对手模拟和红队行动而设计的平台，主要用于执行有目标的攻击和模拟高级威胁
者的后渗透行动。本章中会概述 Cobalt Strike 的功能集和相关的攻击流程。在本手册的剩余部分中会
详细的讨论这些功能。
图1. 攻击问题集
译者注：图中的 Intrumentation & Telemetry 大概可以翻译为“终端行为采集 Agent & 云端
行为分析引擎”。Instrumentation 指的应该是安装在目标主机上的各类日志收集与监控类工
具，Telemetry 指的应该是将这些监控类工具所产出的各位监测日志进行归一化、汇聚到一个统
一分析引擎并等待引擎的研判结果这类的过程。
一场深思熟虑的对目标的攻击始于侦查。Cobalt Strike 的 System Profiler 是一个 web 应用，该应
用用于客户端的攻击面。从侦查流程中收集的信息会帮助你分析以及做出最好的选择。
武器化是将一个后渗透 payload 与一个文档或在目标上执行此 payload 的漏洞利用相结合。Cobalt
Strike 提供将普通的文档转为武器化 Artifacts 的选项。Cobalt Strike 还提供以多种形式导出后渗透
payload、Beacon 的选项，可以结合此工件集以外的 artifacts 使用。
使用 Cobalt Strike 的网络钓鱼工具投递武器化文档到目标网络中的一个或多个人。Cobalt Strike 的网
络钓鱼工具将保存的电子邮件重新用于像素级完美的钓鱼。
使用 Cobalt Strike 的 Beacon 来控制你的目标网络。这个后渗透 payload 使用一种异步的“低频次且
慢速”的通信模式，高级威胁中的恶意软件常使用这种模式。 Beacon 会通过 DNS、HTTP 或 HTTPS
等方式回连（团队服务器）。Beacon 还可以经过常见的代理配置回连至多个主机来避免阻塞。
想要检验目标的攻击溯源分析能力，可以使用 Beacon 的 C2 扩展语言功能。此功能中，通过对
Beacon 重新编程、让流量看上去像一些知名的恶意软件或者融入正常流量。
译者注：所谓的“让流量看上去像一些知名的恶意软件”，如下图中所示的 GitHub 开源 C2 拓展
文件项目中的 crimeware 文件夹，就是通过配置 C2 拓展文件、让 Beacon 的流量特征看上去像
Zeus、Asprox 等知名恶意软件。样可以达到掩盖、伪装 Beacon 行动的目的。
Beacon 优越的自动化以及基于命名管道和 TCP sockets 之上的对等通信模式可帮助攻击者进入受害者
网络，然后继续进行主机发现和横向移动。Cobalt Strike 被用来抓取信任关系和使用被抓取的证书、密
码哈希、访问令牌和 Kerberos 票据等凭据进行横向移动。
使用 Cobalt Strike 的 user-exploitation 工具来展示有实际意义的业务风险。Cobalt Strike 的工作流
程使得在受害系统内部署键盘记录器或截屏工具非常简单。使用 Browser Pivoting 去获取到受害目标
Internet Explorer 上记录的网站的访问权限。这个 Cobalt Strike 独有的技术在大多数站点都可以生
效，并且可以绕过双因素验证。
Cobalt Strike 的报告功能重建了 Cobalt Strike 客户端的参与度。可以提供给网络管理员一个活动时间
表，这样他们可以在他们的监控设备（比如一些流量监测系统）中发现攻击痕迹。可以将 Cobalt Strike
生成的高质量报告作为独立报告提交给客户或将其用作正式文档的附录。
贯穿上面的所有步骤，你需要去了解目标环境、目标防御情况，以及在资源有限的前提下选择最好的方
法来达成后渗透目标。这个过程就是规避。提供开箱即用的规避方案不是 Cobalt Strike 的目标。
Cobalt Strike 提供的是极大的灵活性，在配置和执行攻击行动的选项等方面都具有很大的灵活性，这使
得此软件适用于各种环境和目标。
1.2 安装和更新
Strategic Cyber 责任有限公司发行了适用于 Windows、Linux 和 MacOS X 的 Cobalt Strike 软件包。
要安装 Cobalt Strike，只需将其存档解压到你的操作系统上。
系统要求
Cobalt Strike 要求 Oracle Java 1.8，Oracle Java 11, 或 OpenJDK 11。
如果你的系统上装有防病毒产品，请确保在安装 Cobalt Strike 前将其禁用。
运行“更新”程序
Cobalt Strike 发行套件包含 Cobalt Strike 启动器、支持文件和更新程序。它不包含 Cobalt Strike 程序
本身。你必须运行更新程序才能下载 Cobalt Strike 产品。
图2. 更新流程（欢迎尝试，但是图中的 key 不再有效）
请使用你的 license key 更新你的团队服务器和客户端软件这两个组件。Cobalt Strike 按单个用户授
权。团队服务器不需要单独的 license。
1.3 团队服务器
Cobalt Strike 分为客户端组件和服务器组件。服务器组件，也就是团队服务器，是 Beacon payload 的
控制器，也是 Cobalt Strike 社会工程功能的托管主机。团队服务器还存储由 Cobalt Strike 收集的数
据，并管理日志记录。
Cobalt Strike 团队服务器必须在受支持的 Linux 系统上运行。要启动一个 Cobalt Strike 团队服务器，
使用 Cobalt Strike Linux 安装包中的 teamserver 脚本文件。
图3. 启动团队服务器
团队服务器的启动命令包含两个必填的参数和两个选填的参数。第一个必选参数是团队服务器的外部可
达 IP 地址。Cobalt Strike 使用这个值作为它的功能使用的默认主机地址。第二个必选参数是密码，你
的团队成员将使用此密码从自己 Cobalt Strike 客户端去连接至 Cobalt Strike 团队服务器。
第三个参数是选填的，这个参数指定一个“C2 拓展文件”。第11章和12章会讨论此功能。
第四个参数也是选填的。此参数以 YYYY-MM-DD 的日期格式指定结束日期。团队服务器会将这个结束日
期嵌入到它生成的每个 Beacon stage 中。Beacon payload 在此日期后将拒绝运行，并且在此日期后
如果这个 Beacon payload 醒来也会自动结束(对应 Beacon 会话中的 exit 选项)。
当团队服务器启动，它会发布团队服务器的 SSL 证书的 SHA256 hash。你需要给你的团队成员分发这
个 hash。当你的团队成员连接团队服务器时，在身份验证至团队服务器前、他们的 Cobalt Strike 客户
端会询问他们是否承认这个 hash 。这是抵御中间人攻击的重要保护措施。
1.4 Cobalt Strike 客户端
使用 Cobalt Strike 客户端连接至团队服务器。要启动 Cobalt Strike 客户端，使用适用于你的平台的软
件包内的启动器。
当 Cobalt Strike 客户端启动时，你会看到一个连接对话框。
图4. Cobalt Strike 连接对话框
在 Host （主机）字段指定你的团队服务器的地址。团队服务器的默认端口为 50050，没有必要修改这
个默认端口。User 字段填写你的昵称，当你进入团队服务器之后会显示此昵称。可以将此字段更改为
你的外号、称呼或幻想的黑客名号（如 Snowden 斯诺登）。Password 字段填写团队服务器的共享密
码。
按下 Connect 按钮来连接到 Cobalt Strike 的团队服务器。
如果这是你第一次连接至此团队服务器， Cobalt Strike 会询问你是否承认这个团队服务器的 SHA256
hash。如果你承认，那么按 OK，然后 Cobalt Strike 的客户端就会连接到这个团队服务器。Cobalt
Strike 也会在未来的连接中记住这个 SHA256 hash。你可以通过 Cobalt Strike
→Preferences→Fingerprints 来管理这些团队服务器的 hash。
图5. 验证服务器的 SSL 证书
Cobalt Strike 会跟踪你连接到的团队服务器并记住你的信息。从连接对话框左手边选择一个团队服务器