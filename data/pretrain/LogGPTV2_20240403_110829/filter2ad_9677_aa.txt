原文地址：  
翻译人：agostop
## 摘要
Reel是一个运行着FTP服务，允许匿名访问的Windows主机，它被用来访问系统上的文件以枚举用户的邮件并确定用户正等待着通过邮件接收一个.rtf文件。利用[CVE-2017-0199](https://cvedetails.com/cve/CVE-2017-0199/)生成一个恶意的.rtf文件然后通过Reel的SMTP服务器发送给用户，利用这个漏洞授予用户对Reel的访问权限，在.xml文档中发现了加密的用户凭证，解密之后可以通过ssh获取持久性连接。
利用在主机上的BloodHound活动目录审计结果逐步提升在主机上的权限，使用PowerView(现在是PowerSploit的一部分)可以利用Active
Directory的配置访问另一个用户帐户，该用户帐户具有对包含管理员帐户凭据的文件的读访问权。
## 探查
首先我在这个主机上使用nmap扫描检查服务版本，并且在前1000个最常用的端口上运行默认脚本：
    nmap -sV -sC 10.10.10.77
    Starting Nmap 7.60 ( https://nmap.org ) at 2018-07-19 11:38 EDT
    Nmap scan report for 10.10.10.77
    Host is up (0.11s latency).
    Not shown: 997 filtered ports
    PORT   STATE SERVICE VERSION
    21/tcp open  ftp     Microsoft ftpd
    | ftp-anon: Anonymous FTP login allowed (FTP code 230)
    |_05-29-18  12:19AM                 documents
    | ftp-syst:
    |_  SYST: Windows_NT
    22/tcp open  ssh     OpenSSH 7.6 (protocol 2.0)
    | ssh-hostkey:
    |   2048 82:20:c3:bd:16:cb:a2:9c:88:87:1d:6c:15:59:ed:ed (RSA)
    |   256 23:2b:b8:0a:8c:1c:f4:4d:8d:7e:5e:64:58:80:33:45 (ECDSA)
    |_  256 ac:8b:de:25:1d:b7:d8:38:38:9b:9c:16:bf:f6:3f:ed (EdDSA)
    25/tcp open  smtp?
    | fingerprint-strings:
    |   DNSStatusRequest, DNSVersionBindReq, Kerberos, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, X11Probe:
    |     220 Mail Service ready
    |   FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest:
    |     220 Mail Service ready
    |     sequence of commands
    |     sequence of commands
    |   Hello:
    |     220 Mail Service ready
    |     EHLO Invalid domain address.
    |   Help:
    |     220 Mail Service ready
    |     DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
    |   SIPOptions:
    |     220 Mail Service ready
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |     sequence of commands
    |_    sequence of commands
    | smtp-commands: REEL, SIZE 20480000, AUTH LOGIN PLAIN, HELP,
    |_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
    SF-Port25-TCP:V=7.60%I=7%D=7/19%Time=5B50B0A4%P=x86_64-pc-linux-gnu%r(NULL
    SF:,18,"220\x20Mail\x20Service\x20ready\r\n")%r(Hello,3A,"220\x20Mail\x20S
    --REDACTED FOR BREVITY--    
    SF:e\x20of\x20commands\r\n503\x20Bad\x20sequence\x20of\x20commands\r\n503\
    SF:x20Bad\x20sequence\x20of\x20commands\r\n");
    Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 171.99 seconds
它返回了3个服务:端口21上的FTP服务、端口22上的SSH服务和端口25上的SMTP服务。FTP允许匿名访问，这是下一步枚举工作的逻辑前提：
    ftp 10.10.10.77
    Connected to 10.10.10.77.
    220 Microsoft FTP Service
    Name (10.10.10.77:root): Anonymous
    331 Anonymous access allowed, send identity (e-mail name) as password.
    Password:
    230 User logged in.
    Remote system type is Windows_NT.
    ftp> dir
    200 PORT command successful.
    125 Data connection already open; Transfer starting.
    05-29-18  12:19AM                 documents
    226 Transfer complete.
    ftp> cd documents
    250 CWD command successful.
    ftp> dir
    200 PORT command successful.
    125 Data connection already open; Transfer starting.
    05-29-18  12:19AM                 2047 AppLocker.docx
    05-28-18  02:01PM                  124 readme.txt
    10-31-17  10:13PM                14581 Windows Event Forwarding.docx
    226 Transfer complete.
我们可以看到在documents文件夹中有3个文件可以访问，这些文件可以使用GET
命令单独复制，也可以在攻击主机上使用wget命令获取(因为这是匿名FTP):
    wget -r ftp://10.10.10.77
“Windows Event
Forwarding.docx”文档的Creator元数据字段中包含用户电子邮件地址“PI:EMAIL”，可以使用exiftool查看该字段：
    exiftool “Windows Event Forwarding.docx”
    ExifTool Version Number         : 10.97
    File Name                       : Windows Event Forwarding.docx
    Directory                       : ftp
    File Size                       : 14 kB
    File Modification Date/Time     : 2018:07:19 08:56:52-07:00
    File Access Date/Time           : 2018:07:19 08:59:07-07:00
    File Inode Change Date/Time     : 2018:07:19 08:57:11-07:00
    File Permissions                : rw-r--r--    File Type                       : DOCX
    File Type Extension             : docx
    MIME Type                       : application/vnd.openxmlformats-officedocument.wordprocessingml.document
    Zip Required Version            : 20
    Zip Bit Flag                    : 0x0006
    Zip Compression                 : Deflated
    Zip Modify Date                 : 1980:01:01 00:00:00
    Zip CRC                         : 0x82872409
    Zip Compressed Size             : 385
    Zip Uncompressed Size           : 1422
    Zip File Name                   : [Content_Types].xml
    Creator                         : PI:EMAIL
    Revision Number                 : 4
    Create Date                     : 2017:10:31 18:42:00Z
    Modify Date                     : 2017:10:31 18:51:00Z
    Template                        : Normal.dotm
    Total Edit Time                 : 5 minutes
    Pages                           : 2
    Words                           : 299
    Characters                      : 1709
    Application                     : Microsoft Office Word
    Doc Security                    : None
    Lines                           : 14
    Paragraphs                      : 4
    Scale Crop                      : No
    Heading Pairs                   : Title, 1
    Titles Of Parts                 : 
    Company                         : 
    Links Up To Date                : No
    Characters With Spaces          : 2004
    Shared Doc                      : No
    Hyperlinks Changed              : No
    App Version                     : 14.0000
“readme.txt”文件里只有：
    please email me any rtf format procedures — I’ll review and convert.
    new format / converted documents will be saved here.
在SMTP上使用VRFY命令验证“PI:EMAIL”邮件帐户时，返回结果声明该命令是不被允许的。但是可以使用RCPT命令枚举有效的电子邮件帐户：
    telnet 10.10.10.77 25