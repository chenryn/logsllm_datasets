为什么
饿了么网上订餐不会凉凉
&
牛顿发现万有引力有关?
Digoal
我就是: 德哥!!!
最近BB的作品:
《亿级用户量的实时推荐数据库到底要几毛钱?》
《在数据库中跑全文检索、模糊SQL会不会被开除?》
《刷脸支付会不会刷到别人的钱包? 》
《为什么打车和宇宙大爆炸有关?》
《大话数据库终局之战》
江湖名号: 德哥
帮会: PostgreSQL社区
帮会不正当职务: 校长
擅长武器: PostgreSQL
雕虫小技: 全文检索、模糊搜索、化学分析、
人脸识别、相似推荐、时空调度、向量搜索...
必杀技: 删库跑路
正经职务: 阿里云数据库产品经理
愿景: 没有MyBase解决不了的问题,如果有,就多买几台
格言: 公益是一辈子的事
业余爱好: 写博、写专利、分享、毁人不倦
github: https://github.com/digoal
联系方式:
目录
• 为什么要讨论这个问题?
• 牛顿告诉我们为什么真相离我们越来越远
• 懒人改变历史 - 网上订餐凉凉史
• 顿顿给了饿了么什么启发?
• 没有MyBase PG解决不了的问题, 如果有,就多买几台
!
!
!
论
讨
得
为什么要讨论这个问题? 值
都
题
问
术
技
的
关
有
吃
与
何
任
牛顿告诉我们为什么真相离我们越来越远
• 独立思考
凉凉
懒人改变历史 - 网上订餐 史
• 为什么会凉凉?
• 骑手没钱赚, 人不够?
• 骑手调度算法不够优, 导致人不够?
• 调度算法有问题, 鞭长莫及?
• 没有使用保温箱?
• 骑手薪资与配送时间限制、单数不挂钩, 无保障配送时长?
顿顿给了饿了么什么启发?
• 核心指标:
• 缩短配送时间
• 提高能效, 降低“单数/骑手”比例
土豪不差钱的
• 怎样让骑手的多单配送目的地就近?
请Gun出克.
• pgrouting – 图算法, 商旅问题.
• 怎样避免或减少骑手有未完成的单就安排下一单?
• 怎样避免保温箱超载?
• 怎样避免呼叫远离卖家的骑手?
各位观众:
学霸已经悄悄打开链接了!!!
• demo:
• https://github.com/digoal/blog/blob/master/201711/20171107_48.md
更新:
• 频繁更新的骑手位置
查询:
• 保温箱有足够空间(范围查询)
• 评价(范围查询)
• 其他条件(数组、其他in查询)
• 距离排序(GIS, 距离排序) 限制返回N条
• 其他优先级排序返回
痛点(此时此刻, 头大):
• 只能用1个条件进行索引过滤,
• 其他条件需要回表后再过滤,
• 需要额外对空间进行排序过滤.
性能好才见鬼了.
土豪(懒人)的有钱能使鬼推磨方案
select * from
(
select * from tbl_pos where
att1 in (?,?,?) and
att2  array[?, ?] and
st_contains(geometry(ST_Buffer(geography(st_setsrid(st_makepoint(x?, y?), 4326)), dis?)), pos)
order by pos  st_setsrid(st_makepoint(x?, y?), 4326) limit 100
6秒左右
) as t
order by att1;
回表,CPU过滤
CPU排序 限制输出 CPU排序
索引扫描
条件a
原始
条件x 条件b 排序1 limit 排序2
数据
2000万 1000 100 100
条件c
1ms 1ms 1ms
300万
1000
2s
4s
没有MyBase PG解决不了的问题,
如果有,就多买几台
根据用户输入的att1, att2, ... 条件，搜索满足条件的附近5公里内的对象，根据距离顺序返回100条
还有数组条件的包含查询过滤
返回顺序: 先返回空闲状态的骑手，其次返回最近7天活跃的骑手，其次 ... ...
MyBase PG 扩展模块:
create extension ganos; -- 阿里云空天数据库模块
create extension btree_gist; -- 空间、普通类型组合通用索引模块
create extension intarray; -- 数组组合通用索引模块
结构设计:
create table tbl_pos (id int primary key,
att1 int, att2 int, att3 int, att4 int[],
mod_time timestamp, pos geometry);
这恐怕是全宇宙唯一能支持空间、范围、数组这类条件组合索引过滤的数据库:
create index idx_tbl_pos_1 on tbl_pos using gist(att1, att2, att4, pos);
没有MyBase PG解决不了的问题,
如果有,就多买几台
with
a as (
select * from tbl_pos where att1=1 and
att2 array[i_att4_1, i_att4_2]
order by pos  st_setsrid(st_makepoint(x,y), 4326) limit 100
),
b as (
select * from tbl_pos where att1=2 and
att2 array[i_att4_1, i_att4_2]
order by pos  st_setsrid(st_makepoint(x,y), 4326) limit 100
),
c as (
select * from tbl_pos where att1=3 and
att2 array[i_att4_1, i_att4_2]
order by pos  st_setsrid(st_makepoint(x,y), 4326) limit 100
)
select * from a union all select * from b union all select * from c limit 100;
自信源自MyBase PG
10毫秒
左右
索引扫描 索引排序 索引扫描 索引排序
条件1 条件1
条件2 条件2
原始 条件1 ... ...
limit
排序2 排序2
数据 append输出
100
条件3 条件3
2000万
<1ms
条件4 条件4
< 100 < 100 < 100 < 100
<3ms <1ms <3ms <1ms
没有MyBase PG解决不了的问题,
如果有,就多买几台
机器: 26c
数据量: 2000万骑手
指标:
更新: 9.6万/s
500倍
骑手调度查询: 5000/s, RT 11毫秒.
性能提升
学霸怎么就那么快捏!!!
• 提前收藏: !
!
!
!
• https://github.com/digoal/blog !
!
这
在
都
方
配
的
哥
总结一下
• 顿顿的最大启发是什么? 用一首歌来形容!
• 没有MyBase PG解决不了的问题, 如果有,就多买几台
• 既要又要还要
• 普通类型范围、等值、IN组合
• 空间排序
• 数组包含
• MyBase PG有什么核武器?
• Ganos(PostGIS 增强)
• btree_gist
• intarray
MyBase
顿顿喊你用
咨询砖家
• 入钉钉群,
• 免费
进行中!!!
• 周周
红包雨!!!
• https://www.aliyun.com/product/apsaradb/cddc