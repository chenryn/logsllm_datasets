# 【木马分析】揭秘达芬奇密码 – 新型敲诈者木马分析

## 译文声明
本文是翻译文章，原文来源：360安全卫士。译文仅供参考，具体内容及含义以原文为准。

## 0x00 前言
“达芬奇密码”（.da_vinci_code）是一款近期出现的敲诈者木马，首次在国外报道时并未对国内用户造成影响。然而，自今年九月以来，360白名单分析组发现该木马在国内逐渐活跃，并出现了多个变种。这类敲诈者木马会加密用户的文档、压缩包和图片等重要数据，若在48小时内未通过暗网支付比特币赎金，这些数据将被永久加密保存。此外，由于其频繁更新，一旦在国内大规模爆发，可能会带来巨大的危害。

图1：2023年下半年至10月22日捕获的部分“达芬奇密码”敲诈者变种

感染“达芬奇密码”后，电脑上的文档、压缩包和图片等文件会被加密，并且文件后缀名将被修改为“da_vinci_code”。同时，在每个磁盘目录和桌面上会生成10个README.txt文件。如图2所示：

图2：“达芬奇密码”敲诈者感染后的桌面截图

README.txt 文件内容如下：
图3：“达芬奇密码”敲诈者的用户提示信息

## 0x01 基本流程
“达芬奇密码”敲诈者的功能主要分为安装包解密、ShellCode执行以及勒索软件主体三部分。具体流程如下图所示：
图4：“达芬奇密码”敲诈者恶意代码流程

## 0x02 安装包解密
### 2.1 利用NSIS脚本的IntOp和IntFmt函数拼接System.dll::Call的调用参数，然后执行Call。
图5：NSIS脚本内容

执行的主要函数包括：
- `kernel32::CreateFileW`
- `kernel32::VirtualAlloc`
- `kernel32::ReadFile`
- `kernel32::CloseHandle`

### 2.2 Call执行功能
- 打开特定文件
- 申请一段内存空间
- 读取文件内容到新申请的空间
- 关闭句柄并跳转到新申请的空间执行ShellCode
图6-图8展示了具体的步骤。

## 0x03 ShellCode执行
### 3.1 双层异或算法解密执行代码
图9-图10展示了ShellCode解密过程。

### 3.2 动态获取API并利用INT 2E调用相关API
- 通过API名字的哈希值获取函数地址
- 获取的具体函数列表
- 利用INT 2E调用相关API
图11-图13展示了详细的步骤。

### 3.3 解出勒索者本体
- 从特定偏移处读取数据进行AES256解密
- 生成解密密钥
- 对解密后的数据进行Zlib解压缩
图14-图17展示了整个过程。

### 3.4 执行勒索者
- 创建傀儡进程执行勒索者
图18展示了创建傀儡进程的过程。

## 0x04 勒索者本体
### 4.1 解密API名称并动态获取API地址
图19展示了API名称解密过程。

### 4.2 生成计算机特征码
- 计算当前计算机名、处理器核数、系统卷序列号和系统版本的MD5，并保存在注册表中
图20展示了特征码生成算法。

### 4.3 自我复制并添加注册表启动项
- 拷贝自身到指定位置
- 添加注册表自启项
图21-图22展示了详细步骤。

### 4.4 通过Tor网络匿名与服务器通信
图23展示了通信过程。

### 4.5 保存公钥及相关配置信息
- 将生成的公钥及其相关配置信息保存在注册表中
图24展示了注册表中的关键数据。

### 4.6 加密文件
- 加密特定后缀名的文件
- 不加密系统关键文件以保证系统正常启动
图25-图26展示了加密的文件类型和忽略的文件类型。

### 4.7 AES256加密密钥生成算法
- 初始化随机种子并生成两个256位的密钥
图27展示了密钥生成算法。

### 4.8 文件名加密算法
- 对原始文件名进行AES256加密再通过Base64加密
- 通过计算机特征码生成第二部分
- 最终的加密文件名为两部分加上“.da_vinci_code”
图28-图30展示了文件名加密过程。

### 4.9 文件加密算法
- 生成的密钥和其他关键数据以RSA加密的方式保存在文件头部
- 加密文件内容
图31-图33展示了文件数据加密过程。

### 4.10 删除卷影
- 删除文件卷影
图34展示了删除卷影的过程。

## 0x05 解密过程
- 收到赎金后提供RSA私钥
- 通过私钥解密文件头部的数据块
- 解密文件名和文件内容
- 覆盖文件开头的解密块数据完成解密

## 0x06 查杀情况及防范措施
提醒广大网友：应定期备份重要数据，及时安装软件漏洞补丁，避免点击可疑程序或脚本。360白名单分析组会通过样本收集系统第一时间查杀该木马变种。最新版360安全卫士可以全面拦截此类敲诈者病毒，并提供一站式的代缴赎金及文件解密服务，全面保障用户财产和数据的安全。

图35：2023年11月14日“达芬奇密码”敲诈者的查杀情况