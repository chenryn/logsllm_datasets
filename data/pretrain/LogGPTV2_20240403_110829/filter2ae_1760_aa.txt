**作者：Lightal @ PwnMonkey Security Lab**  
**原文链接：**
# 1．简介
海康威视作为国际大厂，旗下如摄像头等产品早就被无数人分析过了，通过google和github等可以找到很多分析记录和分析工具。萤石是海康威视的一个子品牌，相比于海康威视，萤石的绝大部分产品侧重于家用领域，本文将要分析的智能门锁和网关就是萤石的产品。
之前果加门锁的分析文章中，我们分析了门锁和相关的app，这篇文章我们打算对门锁配套的网关进行一些分析（真正原因是门锁让我们搞坏了，虽然海康又补发了一个，但型号没对上）。刚刚看了看萤石的网上商城，最新的联网门锁已经没有外置网关了，我们在2019年分析的智能门锁还是有外置网关的款式，图片如下：
图1-1 海康萤石智能门锁网关
门锁和网关在拿到手之后，就已经是配对状态，我们不需要进行额外的配对操作。海康萤石智能门锁有一个配套使用的app，该app对服务端有证书校验，所以直接抓包是行不通的，由于我们这里是网关分析，所以就不讨论app的工作了，在本专题的后续文章中，还会遇到类似的问题，到那时我们在解决app的事。
## 2． 通信分析
按照正常思路，肯定是先抓包看一下网关与服务器的通信内容。这里我们通过交换机端口监控的方法抓取海康萤石网关的通信内容（用电脑开启热点，然后网关连到电脑的热点上也可以实现抓包的目的），如下图：
图2-1 海康萤石网关通信内容
通过上图中的通信内容，我们大体上可以分析出一些内容：
A. 网关上电之后，与litedev.ys7.com进行通信。
B.
与litedev.ys7.com通信中，获取了另一个ip，即101.71.30.172。此后，终止了与litedev.ys7.com通信，并一直保持与101.71.30.172的tcp连接。
C. 通信内容看起来是加密的，通信内容中没有很多直接可见的明文。
既然抓包获取不了太多有用的信息，那么我们就要进一步研究网关固件是如何处理这些通信数据的。
# 3． 电路分析
这次并没有像之前的果加智能门锁那样顺利：萤石配套的app不能获取固件的下载地址，在海康和萤石的官网仔细翻找，同样没有查到固件的下载地址。那么接下来我们需要先对电路进行一些分析，以找到固件提取和调试的方法。
## 3.1 主要芯片分析
我们首先来看一看网关电路板上用哪些芯片，尤其注意主控MCU的型号，以及有没有外置的Flash芯片。电路板如下图所示：
图3-1 海康萤石门锁网关电路板
上图中，最明显的就是中间的MCU，仔细观察可以确认品牌和型号为MEDIATEK
MT7688AN，联发科的芯片，先下载一份芯片手册看一看，下载地址是：。
通过阅读芯片手册，可以找到关于Flash的部分内容：
图3-2 MT7688AN芯片关于Flash的内容
上图可以看到该芯片并没有内置Flash，而是使用SPI通信的外置Flash，那么我们继续在电路板上寻找Flash芯片。
在图2-2中，MCU的上方是Winbond W9751G6KB芯片，该芯片是DDR2
SDRAM存储器，简单说就是断电丢数据的内存，固件程序不可能在里面。在MCU的下方有两个芯片，分别是PCM5100A和GD25Q127CSIG芯片，
PCM5100A是个音频立体声DAC芯片，而GD25Q127CSIG芯片则是128M-bit的Flash芯片，我们要提取的固件文件应该就是在此Flash中。关于Flash中固件的提取方法，我们将在第4章中介绍。
## 3.2 电路接口分析
IoT设备在开发和测试过程中，都会使用JTAG、UART等接口用于辅助调试工作。在设备的发行版中，MCU的这些引脚是否与电路板上的接口接通就不一定了，这需要我们测试一下。
在MT7688AN的芯片手册中，我们可以看到该芯片UART0接口和UART1接口。其中UART0接口在30和31引脚，如下图：
图3-3 MT7688AN芯片UART0引脚位置
上图中，我们仅展示了UART0的位置，UART1可以自行查询芯片手册。如果海康萤石的网关没有屏蔽对UART的输入和输出，那么通过这些UART也许可以实现一些操作。通过万用表测量，可以确定芯片的UART是否被引出到了软排线接口上，如下图所示的。
图3-4 海康萤石网关软排线接口
为了接通软排线接口，我们需要购买一段20pin的软排线和转接板，淘宝可以买到，楼下手机店可能也有，软排线的尺寸间距我们在图3-4已经测量出来了。此外，我们还需要一个USB转TTL模块才能将UART口连接到电脑上，该模块用于调整USB电路和TTL电路的电平逻辑，软排线+转接板+USB转TTL模块的连接如下图所示。
图3-5 连接MCU的UART接口
我们在实际操作中，发现软排线的触点位置经常虚接，暂无法确定海康萤石的软排线接口是否需要特殊的软排线才能连接，但这样也勉强能用，后续我们会有更好的替代方法。
按照图3-5方式连接好之后，在电脑的“设备管理器”选项卡中就会出现一个COM口，可以使用xShell、SecureCRT或者sscom等串口调试工具来读取这个COM口上的通信数据，当使用xShell和SecureCRT的时候需要将连接方式选择为串行接口。
到此为止，如果操作无误，网关上电后，应该可以在串口调试工具中看到了类似下图的输出内容。
图3-6 串口输出内容
上图中的输出内容显然是网关上电之后的输出日志，待系统启动完成之后，我们可以试着输入一些内容，这时就会出现登陆嵌入式Linux系统的提示字符，但是登陆用户和登陆密码我们暂不知道。现在是时候去分析固件了。
# 4． 固件分析
## 4.1 固件提取
我们在3.1节提到固件应该存储在电路板的Flash芯片中，要读取Flash芯片，只需要将芯片连到编程器上即可。如果情况允许，烧录夹是最优选择，这样我们就不需要将芯片焊下来了。不巧的是，烧录夹有点粗，海康萤石的门锁网关设计的很紧凑，烧录夹夹不上去。所以我们只好用热风枪和镊子就可以把Flash吹下来了，如下图所示：
图4-1 热风枪吹取Flash芯片
如果没有热风枪，用电烙铁也是可以的，注意手别抖就好。然后将摘下来的芯片放在编程器上。支持读写GD25Q127CSIG芯片的编程器有很多种，我们这里选择一种较为实惠的MinPro100B，如下图：
图4-2 将Flash芯片放置于编程器上
将编程器连接到电脑上，使用编程器配套的软件，选择相应的Flash芯片型号后即可提取芯片内容，提取完成后可以将读出的内容保存成文件，并命名为OriginFirmware.bin。
## 4.2 固件结构分析
提取出固件之后，我们可以尝试用binwalk对它进行分析，这里，我们直接用-Me参数提取固件内容，其中M参数表示递归提取：
图4-3 binwalk提取固件内容
根据binwalk的分析结果，我们可以判断固件应该包含一个嵌入式Linux操作系统，智能网关的主要功能逻辑应该由文件系统中的可执行程序完成。待binwalk运行完毕之后，会生成几个文件夹，分别是2个squashfs文件系统，2个LZMA压缩的数据，以及1个jffs2文件系统，如下图所示：
图4-4 海康萤石网关提取内容
上图中，前2个文件夹即2个LZMA压缩的数据，解压之后会发现是cpio文件系统，binwalk会自动帮我们递归全部提取。
逐个浏览这些文件系统中的内容，可以得到以下信息：
A. jffs2文件系统保存着门锁和网关的相关信息，如id等；
B. 两个cpio文件系统中，其中一个应该是恢复出厂设置时的备份文件系统，另一个是当前正在使用的文件系统；
C. 两个squashfs文件系统中，一个保存的全部都是mp3文件，另一个保存着网关的主程序，该程序即为我们将要分析的主程序。
D. 在固件的cpio文件系统中，可以找到/etc/shadow文件，文件内容如下：
图4-5 文件系统中/etc/shadow文件
借助于彩虹表，就可以找到root用户的登陆密码为abc123。使用该用户名，就可以通过串口顺利登陆海康萤石的智能网关，并使用串口shell提供的各种功能了。
## 4.3 固件重打包
我们现在已经拿到了固件内容，但是在对主程序进行分析之前，我们还需要处理一个串口总是虚接的问题，调着程序唱着歌，突然就被麻匪劫了（划掉），串口断开连接了，也是一件很恼火的事情。
在海康萤石的网关固件中翻一翻，可以发现在/sbin目录中有telnetd程序，如果我们可以通过telnet连接智能网关，或许会稳定很多，如下图所示：