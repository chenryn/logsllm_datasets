面。商户应用程序后台服务在收到来自微信开放平台的支付成功回调通
知后，标志该笔订单支付流程结束。
2.技术选择与应用
微信支付使用的消息格式为自定义的XML格式，对于通信的安全
性除了使用基本的身份鉴别措施，如商户注册认证、商户密钥、API证
书的单双向认证、商户支付密钥，还使用了随机数算法、签名算法、
HTTPS来保证消息在通信过程中的安全性。
（1）消息格式
统一下单的消息格式的主要字段及消息格式，其官方有如下定义。
1）请求消息关键部分格式如下。在请求消息的格式定义中可以看
到，包含了随机字符串、签名、签名类型等与消息保护的关键字段。
而与之对应的响应消息，其格式类似。
2）应答消息关键部分格式如下。在应答消息的格式定义中除了与
业务相关的返回状态码、服务商商户APPID、服务商商户号字段外，也
可以包含随机字符串、签名等字段。
在这些字段中，与消息保护关系密切的三个字段是sign、
sign_type、nonce_str，下面来详细看看其使用过程。
（2）签名算法的选择和使用
使用签名算法之前，先生成随机数，微信支付随机数nonce_str生成
算法如下：
当对传输的消息采用签名算法时，其签名过程如下。
1）将多个参数以键值对的格式（即key1=value1&key2=value2…）
拼接成字符串stringA。
2）将参数键值对按照参数名ASCII字典序排序。
3）将stringA拼接上key得到stringSignTemp字符串，再对
stringSignTemp按照指定的签名算法（MD5或HMAC-SHA256）进行运
算，最后将得到的字符串中所有字符转换为大写，得到sign值。算法表
示为sign=Upper（签名算法（stringA+key））。
通过上述步骤后，将生成的sign值放入请求消息或应答消息中，供
通信的对方验签使用。当然，微信支付在签名过程中，还需要注意如果
参数的值为空不参与签名、参数名排序时区分大小写等问题（因此处主
要分析API的消息保护，故其相关注意事项不在此展开）。
而通信的对方在验签时，其过程为生成sign的逆操作，首先判断消
息格式中是否包含sign字段，如果包含sign字段，则对所有参数进行签
名，将获得的签名值与传输过来的sign进行比对，结果一致则验签通
过，其关键代码如下：
除了上述的消息签名外，对于微信支付接口的安全性还有一些其他
的安全策略，比如敏感数据加密处理、外部请求数据访问必须进行鉴权
操作、通过XML外部实体引用的限制来防止XXE，这些都是值得学习
的地方，如下代码所示：
感兴趣的读者，可以访问其开发者网站，下载源码进行分析与学
习，网址链接为https://pay.weixin.qq.com/wiki/doc/api/jsapi_sl.php?
chapter=11_1。
9.5 小结
本章重点围绕API的消息保护，从传输层消息保护和应用层消息保
护两个方面详细阐述了当前的主流技术，比如传输层TLS协议的使用、
JWT系列规范、Paseto令牌技术、WS-Security等。其中因WS-Security技
术相对比较陈旧，介绍篇幅较少，重点介绍了JSON相关的JWT、Paseto
技术。最后通过百度智能小程序OpenCard和微信支付统一下单接口两个
案例，结合消息保护的实践，详细分析了其使用过程。从这些内容读者
可以看出，TLS协议、消息加密、消息签名是当前API消息保护的主要
方式，同时，对于API消息中传输的敏感数据，使用字段级加密、脱
敏、鉴权等技术，也已逐渐被各厂商所重视，这是监管合规和数据安全
共同推动的结果。
第3篇 治理篇
第10章 API安全与SDL
前两篇分别为读者介绍了API安全的基础知识和API安全设计相关
技术，从这一章开始，将从API治理的角度，讨论在API生命周期中，
如何综合性地融合管理手段和技术手段进行API安全治理。本章将围绕
SDL，从API开发到API运维以及应急响应，介绍API安全在研发中的诸
多细节。
10.1 SDL简介
SDL最早是由微软提出、围绕软件生命周期的安全管理模型。为
了保证最终用户的安全，微软于2004年在软件开发各阶段中引入安全和
隐私问题的考量，将SDL引入其内部软件开发流程。接着，2008年发布
了一系列重要的指南（称为SDL优化模型），2010年又添加了敏捷
（Agile）开发模板，其目的是为了迎合互联网技术的发展和软件形态
的变化，综合落地过程中安全投入成本、应用安全性和易用性之间的考
量，做了更易于落地实施方面的改进。
10.1.1 SDL的基本含义
在微软提出的标准的软件安全管理模型SDL实施过程中，包含的关
键安全活动内容如图10-1所示。
●图10-1 微软SDL关键安全活动
■ 培训（Training）：所有的团队成员都需要参与软件安全培训。
■ 需求（Requirements）：明确安全需求和计划，开展隐私风险评
估。
■ 
设计（Design）：开展安全设计活动，比如设计规范、威胁建
模、攻击面分析等。
■ 实现（Implementation）：主要是安全编码，比如静态检测工具
的使用、弃用不安全函数、安全编译器等。
■ 验证（Verification）：验证安全机制的有效性，主要手段有动态
分析、黑/白盒测试、威胁模型和攻击面评析。
■ 发布（Release）：审核安全过程是否与需求一致，建立应急响应
机制。
■ 响应（Response）：执行应急响应，问题跟踪解决。
但对大多数企业来说，标准SDL模型的复杂度仍让应用研发人员在
业务与安全之间无法下手。比如威胁建模，其目的是帮助应用开发团队
在应用系统设计阶段，充分了解应用中存在的各种安全威胁，并指导应
用开发团队选择适当的应对措施。通常应对措施会涉及技术和业务两个
方面，比如如何改进业务流程的设计或如何在代码编写过程中避免某些
代码安全漏洞的出现等，甚至还有人员培训等方面。这些要求无论是对
安全人员还是对研发人员，都需要很高的专业素养。再比如安全开发制
定编码规范一项，如何制定覆盖多种编程语言、包含几百条安全编码规
则的编码规范，对安全人员来说也是一个挑战；即使安全人员制定出来
了，研发人员在编码过程中，如何学习掌握，又如何满足于编码规则，
对研发人员也是很大挑战。基于这些原因，国内的互联网企业安全建设
大多数是裁剪后的SDL片段，能完整实施成套SDL的企业寥寥无几。如
今，当业界在讨论SDL时，更多的是指对软件生命周期安全管理的大
范畴，代指安全管理模型上微软的SDL、OWASP的S-SDLC模型对安
全管理的理念，而不是实指微软的SDL。
10.1.2 SDL对API安全的意义
从单点的安全功能设计到全生命周期SDL安全模型的使用，是软件
开发在安全建设过程中发展的必然结果。和传统的应用安全类似，在
API研发过程中应用SDL对API安全有着特殊的意义。首先，与单一的安
全活动或单点安全设计相比，SDL模型从API全生命周期、安全管理、
安全运营、安全技术等多个角度关注API的安全性，看问题更为全面，
也为安全风险的早期识别、早期解决提供了切入点。其次，使用SDL模
型，实际是使用一套安全管理的方法论，通过模型的建立为API安全管
理工作提供标准的操作规范指引，解决了安全工作不知道从何处下手
的困境。在SDL实施过程的各个关键安全活动上，根据各个企业或业务
的特点，制定出来的标准化操作流程和操作规范，在安全水平参差不齐
的情况下，通过过程保证了整体输出产物的稳定水平。最后，SDL的
核心理念是将安全融入软件开发的每一个阶段，比如安全需求、安全设
计、安全测试等，让不同阶段不同角色的人员参与安全活动，有利于软
件研发团队的安全文化建设。对软件研发来说，每一个角色所需要的技
能，所看到的视野是不一样的。如果都让安全工程师全程去做，则对安
全工程师的水平要求比较高。从外部来看，难以从市场上招聘到合适的
人员；从内部人才培养来看，难以短期内看到成效。这些既不利于一个
企业的用人需求，也不利于企业的长期发展。采用安全工程师作为教练
员，指导各个不同的角色正确的开展安全活动，并对过程进行监督和审
核，在当前环境下，是比较理想的一种解决思路。
10.2 SDL之API安全培训
安全培训是SDL在正式开展前必须实施的一个重要环节，安全培训
做得成功与否直接关系到整个SDL过程的成败。下面，将从API安全的
角度谈谈如何开展API安全培训。
10.2.1 如何开展API安全培训
在开展API安全培训活动时，首先需要考虑以下几个方面的内容。
■ 培训对象：是指明确需要参与API安全培训的对象。在SDL过程
中会涉及多个角色的参与，不同的角色关注的重点不同。开展一个培训
课程时，首先需要明确培训对象。
■ 培训目标和内容：组织培训时，给培训对象讲述哪些内容，培训
完成之后达到什么样的培训目标，是编写一节培训课程还是编写一个系
列的培训课程等。只有这些明确了，才能有的放矢地编写相关培训课程
或采购外部课程。
■ 
培训形式：指如何开展培训，是线上远程培训还是线下教室培
训，是单纯性的教授知识还是讲解案例后竞赛抢答，是授课还是短视频
播放，是海报还是宣传卡片等。这些，也是安全培训的一部分，多数情
况下，需要和课程结合来考虑培训形式。
■ 培训计划：是指如何实施培训，要制定相关的培训计划，以跟踪
和推进培训工作。比如每两周一次，每次面向的对象不同，三个月一轮
询。还是普遍性的开展大规模线上培训，每半年一次。这是由制定的培
训计划和实际需求确定的。
■ 效果评价：是指通过什么指标来评价培训的效果，做完安全培训
之后，是否达到了之前预设的培训目标。如果没达到，还有多大差距，
下次培训需要重点补齐哪些内容。这是通过评价指标来反映的，培训工
作的主导者通过指标数据分析，不断改进安全培训工作。
以上内容是比较成熟的安全培训工作要求。在实际开展过程中，可
能每一个企业内部的情况各不相同，安全工程师的水平也不尽相同，不
一定要求这么全面。这里，对API安全培训过程中的重点注意事项作一
下说明。
（1）安全培训对象与培训内容的选择
整个SDL的安全培训，虽然培训的内容以服务技术人员为主，但在
不同的培训课程中仍需要将具有管理职能的角色纳入培训对象，典型的
角色如项目经理。纳入项目经理作为培训对象的目的是希望通过赋能培
训，让项目经理了解SDL的大体内容，明白项目经理在整个过程中需要
关注的重点事项以及安全管理的底线要求。一般来说，比较全面的安全
培训对象需要包含项目经理、技术负责人、架构师、开发工程师、测
试工程师、运维工程师、质量工程师。
虽然培训对象包含了上述人员，但并不是这些角色均需要全程参与
所有的培训，培训主导者需要根据不同角色实际工作的需要在不同的课
程中将对应的角色包含进来。如果企业内部已有安全培训的内容，通常
无须单独开展，仅需要将API安全培训融入整体的培训过程中即可。如
果没有相关安全培训，则培训内容一般包含如下内容。
■ API安全管理框架和关键指标。
■ 常见API安全问题。
■ 常见API安全技术与安全设计。