0x00 前⾔
作者J0o1ey，有技术交流或渗透测试/Redteam培训需求的朋友欢迎联系QQ/VX-547006660
本⽂简单记述了⼀下本⼈在某攻防演练过程中⼀次层层突破的有趣经历
技术性⼀般，但是层层突破属实艰难，并⽤到了⽐较多的思路，还望各位⼤佬多多指教
0x01 SSO账号获取
由于⽬标是某⼤学，对外开放的服务基本上都是⼀些静态Web⻚⾯，没什么太多利⽤点
因此获取⼀个该⼤学的SSO账号就显得尤为重要~
本⼈使⽤该⼤学的域名、以及常⻅的搜索密码关键词，调⽤Github的api在Github中定位到了就读该⼤学的关键⽤
户
该同学安全意识较为薄弱，经常将账号密码硬编码在程序内，这正是我们苦苦寻觅的⼈才
结合他在其他项⽬中硬编码的学号，我们成功利⽤他的学号+密码登陆该⼤学SSO系统和学⽣vpn系统
本来以为可以进驻内⽹了，结果发现学⽣VPN除了访问⼀些学术资源，啥也⼲不了
好在进去SSO了，那么后⾯接近靶标之路就会更加轻松，现在⾃然要把着⼒点放在SSO能访问到的系统漏洞挖掘上
0x02 某系统接⼝利⽤测试tips获取⼤量信息
⾛了⼀遍SSO能访问的系统
发现某项⽬申请处，可以搜索学校其他同学的信息
如图，接⼝在流量中是这样表现的
我们利⽤⼀个测试tips，将其中的关键键置空，或者使⽤通配符*，发现可以成功返回全校三万多名学⽣的信息
凭此成果，仅能得⼀点可怜的分数，还得继续来撸
我继续在系统重翻找接⼝，终于发现了⼀个可以搜索学校⽼师的接⼝
同样的使⽤刚刚的tips，在关键的键处置空键值或使⽤*，这次运⽓很好，返回的信息中，甚⾄出现了所有⽼师的
⼯号和md5加密的密码
甚⾄包括sso管理员的密码。。。
解了⼀下admin的密码，⾮常遗憾，解不开，不然游戏就直接结束了~
但我们现在掌握了⼤量⽼师的⼯号，密码(包括负责运维的⽼师)，那么我们后⾯进驻内⽹的⼯作就会顺利很多
0x03 进驻DMZ区并获取内⽹跳板
我们做了很⻓时间的信息搜集，找到了该学校开放在外⽹给运维⼈员使⽤的DMZ区VPN
我们直接⽤刚刚获取到负责运维的⽼师的账号密码登录，发现⼀直不好使...
结果试了⼀下，发现密码竟然和⼯号是⼀致的....真是⽆语...
随后就成功接⼊了该学校DMZ区VPN
进⼊DMZ区后，我们简单做了⼀下弱⼝令扫描探测，发现了⼀台SqlServer的弱⼝令
直接通过恢复执⾏xp_cmdshell，发现还是管理员权限
但是列进程的时候发现了万恶的某60
试了试⾃⼰之前的certutil下载⽂件绕过⽅法，因为之前交了360SRC，已经被修复了，TMD直接被拦
但是仔细⼀想，SqlServer中是存在LOL bin的，可以实现⽩利⽤执⾏powershell
通过此姿势，成功上线CS
如此⼀来，访问内⽹核⼼区的跳板就有了~
0x04 被踢出内⽹与收买学校内⻤
还没等开⼼⼀会，突然发现CS的进程已经被下掉了，并且DMZ区账号也被踢下线并改密码了
估计是⽬标机有主机安全设备，检测到了进程中的CS内存特征或流量特征。。。
线索全断，让⼈陷⼊了沉思，不过转念⼀想，内⽹代理套代理也是卡的要死，还不如想想办法如何直接获取内⽹核
⼼区的访问权限
我们于是在咸⻥上开始寻找猎物，发现了就读于该⼤学的某学⽣
该学⽣咸⻥上挂的具体内容忘记截图了，⼤体意思是”我是xxx⼤学的学⽣，可以为⼤家提供xxx⼤学的有关帮助，
考研，⽣活等等等，视难度收费10-50“
我们直接加他联系⽅式，给他转了50。
话术如下
LOL bin
C:\Program files (x86)\Microsoft SQL Server\xxx\Tools\Binn\SQLPS.exe
C:\Program files (x86)\Microsoft SQL Server\xxx\Tools\Binn\SQLPS.exe whoami
就这样，我们连上了这个⼆傻⼦的向⽇葵
然后直接⽤他的cmd，把权限给到CS，做好权限维持
我：你好你好，我是xx⼤学的学⽣，现在在外⾯，回不去学校，想⽤下你的电脑，访问学校内的教务系统，给您50元答
谢
对⽅：哦哦可以，你看看怎么整
我：你下个向⽇葵，然后把主机号和密码发给我就好
对⽅：okok
把隧道传出来，发现学⽣的PC竟然可以直接访问核⼼区。。。随后在内⽹⼜开始了扫描，撸了⼀些乱七⼋糟的系
统，⽐如海康某设备的RCE，web系统的注⼊，⽹关等等东⻄，但都没法反弹shell。。
当时⼜发现了⼀个SSH弱⼝令，可给我们⾼兴坏了，⼆话不说连过去
当看到这⼀幕的时候，⼀身冷汗，因为⾮常清楚，⾃⼰踩到内⽹蜜罐了，⼜要寄了。。。
果然不出20分钟，那位同学就发来了微信
⽓煞我也，后⾯想继续⽤⾦钱收买，道了歉，说⾃⼰⼀不⼩⼼传错软件了，⼜给他转了20块钱，想再⽤⼀阵
可谁知
⽓煞我也，竟然不讲武德
0x05 近源渗透直捣⻩⻰
眼看着所有能通向内⽹核⼼区的路径全寄了，我们只能想办法出奇制胜，摇⼈去近源渗透
叫甲⽅派了了个⼈，混进学校内的图书馆，⽤之前获取到的学⽣sso账号接⼊校园⽹
如此⼀来，我们就有了稳定且不易察觉的内⽹通道
接下来就是常规操作了，漏扫核⼼⽹段，发现了docker api未授权和vcenter的RCE
可控制数⼗个镜像
核⼼区VCenter存在CVE-2021-21972漏洞，可直接写⼊Webshell
随后可利⽤Vcenter的shell权限实现cookie伪造
使⽤脚本
https://github.com/horizon3ai/vcenter_saml_login/blob/main/vcenter_saml_login.py
使⽤⽣成的cookie进驻VCenter
分数刷满，润了~
0x06 末⾔
本⽂没有过多的技术性东⻄，主要是跟⼤家分享⼀下⾃⼰打攻防被”围追堵截“的经典案例，给奋⽃在攻防⼀线的兄
弟加油⿎劲
权限掉了，被踢出内⽹，莫要灰⼼⽓馁，⻅招拆招，才是攻防的乐趣所在
python3 vcenter_saml_login.py -t Vcenter内⽹ip -p data.mdb
data.mdb路径
windows：C:/ProgramData/VMware/vCenterServer/data/vmdird/data.mdb
linux：/storage/db/vmware-vmdir/data.mdb