Patroni
使用维护手册
神州飞象（北京）数据科技有限公司
Patroni使用维护手册 第 1 页，共 33 页
All rights reserved
2017 版权所有 侵权必究
目录
关于本手册....................................................................................................................................... 4
提供内容 ................................................................................................................................... 4
读者........................................................................................................................................... 4
如何使用本手册 ....................................................................................................................... 4
1 Patroni集群说明 ...................................................................................................................... 5
1.1 软件说明 ................................................................................................................... 5
1.2 组件说明 ................................................................................................................... 5
1.3 Patroni流程 .............................................................................................................. 6
1.4 使用优势 ................................................................................................................... 7
1.5 使用限制 ................................................................................................................... 8
2 集群的启停 ............................................................................................................................... 8
2.1 启动 ........................................................................................................................... 8
2.1.1 启动zookeeper（root） ................................................................................... 9
2.1.2 启动Patroni（普通用户） .............................................................................. 9
2.2 关闭 ........................................................................................................................... 9
2.2.1 关闭patroni（普通用户）............................................................................. 10
Patroni使用维护手册 第 2 页，共 33 页
2.2.2 关闭zookeeper（root） ................................................................................. 10
2.3 重启 ......................................................................................................................... 11
3 Patroni参数的更改 ................................................................................................................ 11
4 Patronictl集群维护命令 ........................................................................................................ 15
4.1 查看集群状态 ......................................................................................................... 16
4.2 发送一条SQL语句 ............................................................................................... 17
4.3 获取主节点dsn信息 ............................................................................................. 17
4.4 重启集群 ................................................................................................................. 17
4.5 手动执行主备切换 ................................................................................................. 19
4.6 手动failover一个节点 .......................................................................................... 20
4.7 在DCS中删除集群信息 ....................................................................................... 21
4.8 重新初始化节点 ..................................................................................................... 21
5 Postgresql数据库插件的加载 ............................................................................................... 22
6 Watchdog功能........................................................................................................................ 22
6.1 适用场景: ................................................................................................................ 22
6.2 Watchdog 配置步骤 ............................................................................................... 22
6.3 开机启动服务 ......................................................................................................... 24
7 添加节点 ................................................................................................................................. 24
7.1 添加patroni与数据库节点 ................................................................................... 24
8 日志级别调整 ......................................................................................................................... 25
9 故障......................................................................................................................................... 27
9.1 故障检查流程 ......................................................................................................... 27
9.2 检查项 ..................................................................................................................... 27
Patroni使用维护手册 第 3 页，共 33 页
关于本手册
提供内容
patroni使用维护手册将向读者介绍patroni高可用集群的使用方法。通过该手册，您
将学会如何使用patroni高可用集群。
读者
·本指南适用于数据库管理员、应用工程师、系统工程师等能独立完成部署的人员。
如何使用本手册
本手册包含以下几章：
启停，参数的分类以及修改，patroni集群的维护命令，添加patroni节点，故障检
测流程等。
在文档使用过程中，您可以顺序阅读每一章， 也可以根据目录，寻找您需要的部分进
行使用。具体的故障测试请查看测试文档。祝您阅读愉快。
Patroni使用维护手册 第 4 页，共 33 页
1 Patroni 集群说明
1.1 软件说明
patroni是一款运用dcs存储集群来存储信息、主备状态与配置,通过patroni来检测并且实
现主备库自动切换的软件。使用一套模板化的配置文件来自动搭建初始化数据库流复制集群
以及配置数据库。patroni高可用集群由postgresql,patroni,dcs存储组成。。
1.2 组件说明
组件分别的作用(不包括pg数据库):
⚫ patroni:通过参数文件来配置自动初始化数据库搭建流复制（配置 pg 参数
文件、创建用户、可以配置预加脚本），指定zookeeper节点等。负责通过
一个api接口连接到dcs(分布式存储系统集群)，向其插入键值记录patroni
参数、数据库参数、主备信息以及连接信息。平时通过对zookeeper中的信
息进行更新、读取来判断集群的健康状态。在主备切换或者做恢复时通过向
zookeeper读取主备信息来判断各节点的状态进行切换。
⚫ zookeeper:最少需要三个节点且为奇数来进行 leader 选举（脑裂发生时
zookeeper集群会僵死等待恢复，不会发生都认为自己是主的情况）。存储
并在各个节点上同步键值信息。
Patroni使用维护手册 第 5 页，共 33 页
1.3 Patroni 流程
dcs+patroni+postgres+pgbouncer+复制程序基本架构图
DCS节点C
DCS节点A DCS节点B
主备状态，健康状态，配置信息
patroniA
patroniB
primary
standby
通过DCS进行心跳检测
pgbouncer
Wal日志
复制程序
ip:4432
Patroni使用维护手册 第 6 页，共 33 页
Client
rabbitmq
基本流程：
⚫ patroni自动创建主备流复制集群并且向zookeeper读取以及更新键值
⚫ zookeeper存储,同步键值信息
⚫ patroni 进行循环检测，如果发现当前节点或者主节点发生异常，会执行相对的应对措施
（重启节点、主备切换等）
1.4 使用优势
➢ 自动检测主备状态进行切换
➢ 统一模板配置
➢ 不会发生因双主而照成的脑裂现象，主节点是哪个节点记录在了dcs中，恢复后pg_rewind
会同步主备的时间线
➢ 在线添加zookeeper、patroni节点以及数据节点
➢ 支持同步异步流复制，级联流复制
➢ 异步流复制可设置最小丢失数据量
Patroni使用维护手册 第 7 页，共 33 页
➢ 使用pg_rewind进行恢复，缩短恢复时间
➢ 拥有watchdog机制来解决节点数据库因内存资源超出而照成的崩溃或者是高负载系统下
patroni被卡死这样的单点故障
1.5 使用限制
➢ 需要至少三个以上且为奇数的zookeeper节点
➢ 底层基于的是流复制
➢ 部分patroni自带参数需要通过更改dcs中键值来修改
➢ 因故障发生而未提交的事物会回滚，会话需要客户端重新发起连接
➢ 在复制程序开启的情况下pg_ctl命令关闭主库，
2 集群的启停
2.1 启动
Patroni使用维护手册 第 8 页，共 33 页
zookeeper Patroni
2.1.1 启动 zookeeper（root）
开启命令
三个zookeeper节点均需执行:
/root/zookeeper-3.3.6/bin/start
查看zookeeper运行状态:
/root/zookeeper-3.3.6/bin/status
2.1.2 启动 Patroni（普通用户）
Patroni所在节点均需执行:
输出到屏幕运行
/home/postgres/patroni-1.4.3/patroni.py /home/postgres/patroni-
1.4.3/postgresmq.yml
后台运行
nohup /home/postgres/patroni-1.4.3/patroni.py
/home/postgres/patroni-1.4.3/postgresmq.yml >
/home/postgres/logfile/patroni_log 2>&1 &
2.2 关闭
建议：
Patroni使用维护手册 第 9 页，共 33 页
⚫ 正常来说，强烈不建议去关闭集群。高可用集群启动后是不需要关闭的。组件或节点故
障都会有相应的高可用机制。
如果遇到特殊情况需要关闭集群，最完美的关闭情况请依照以下顺序关闭:
确认数据库再没有业务连接进来，并且备机wal日志更新没有延迟
Patroni zookeeper
2.2.1 关闭 patroni（普通用户）
node1，node2均需执行
首先关闭每个节点的patroni进程
[yd@node1 ~]$ ps -ef|grep patroni
postgres 2853 2823 0 14:32 pts/1 00:00:39 python ./patroni.py
postgres000.yml
postgres 5873 5840 0 16:16 pts/0 00:00:00 grep patroni
[yd@node1 ~]$ kill -9 2853
关闭数据库，先关闭主库，再关闭从库
主库：
pg_ctl -D /home/postgres/flyingdb-v3-logical/data stop
从库:
pg_ctl -D /home/postgres/flyingdb-v3-logical/data stop
2.2.2 关闭 zookeeper（root）
三个节点均需执行
开启命令
Patroni使用维护手册 第 10 页，共 33 页
三个zookeeper节点均需执行:
/root/zookeeper-3.3.6/bin/stop
查看zookeeper运行状态:
/root/zookeeper-3.3.6/bin/status
2.3 重启
重启整个集群
/home/postgres/patroni-1.4.3/patronictl.py -c
/home/postgres/patroni-1.4.3/postgresmq.yml restart batman5
重启单个节点
/home/postgres/patroni-1.4.3/patronictl.py -c
/home/postgres/patroni-1.4.3/postgresmq.yml restart batman5
postgresql0
3 Patroni 参数的更改
Patroni参数和数据库参数配置有3种类型：
⚫ 必须在dcs中更改的数据库参数:
Patroni使用维护手册 第 11 页，共 33 页
这些参数在patroni参数文件中配置，包括了流复制参数和部分连接参数。
vi postgresql.conf
# Do not edit this file manually!
# It will be overwritten by Patroni!
include 'postgresql.base.conf'
cluster_name = 'batman5'
hot_standby = 'on'
listen_addresses = '0.0.0.0'
max_connections = '100'
max_locks_per_transaction = '64'
max_prepared_transactions = '0'
max_replication_slots = '10'
max_wal_senders = '10'
max_worker_processes = '8'
port = '5433'
track_commit_timestamp = 'off'
unix_socket_directories = '/tmp'
wal_keep_segments = '8'
wal_level = 'logical'
wal_log_hints = 'on'
hba_file = '/home/postgres/flyingdb-v3-logical/data/pg_hba.conf'
ident_file = '/home/postgres/flyingdb-v3-logical/data/pg_ident.conf'
更改方式:
依据字典格式在dcs中更改，更改完后在全局生效，依据该参数是动态或是静态参数来选
择是否需要重启数据库
zk的更改格式
进入zk
Patroni使用维护手册 第 12 页，共 33 页
[root@test2 bin]# cd /root/zookeeper-3.3.6/bin
[root@test2 bin]# ./zkCli.sh -server localhost:2181