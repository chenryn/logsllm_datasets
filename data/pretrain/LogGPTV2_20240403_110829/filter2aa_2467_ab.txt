IBM Security / © 2022 IBM Corporation
Bitbucket Log
• /var/log/atlassian/application-data/bitbucket/log/atlassian-bitbucket.log
Search Criteria
• 'post' AND 'search' AND 'query'
• Need to increase logging level
Reconnaissance Logging
53
IBM Security / © 2022 IBM Corporation
• Using admin privileges, add any user to admin
Promote User to Admin Role
54
IBM Security / © 2022 IBM Corporation
Access Log
• /var/atlassian/application-data/bitbucket/log/atlassian-bitbucket-access.log
Audit Log
• /var/atlassian/application-data/bitbucket/log/audit/*.log
Search Criteria
• 'put' AND '/admin/permissions/users'
• 'new.permission' AND 'admin'
Promote User to Admin Role Logging
55
IBM Security / © 2022 IBM Corporation
• Personal Access Token
• SSH Key
Maintain Persistent Access
56
IBM Security / © 2022 IBM Corporation
Access Log
• /var/atlassian/application-data/bitbucket/log/atlassian-bitbucket-access.log
Audit Log
• /var/atlassian/application-data/bitbucket/log/audit/*.log
Search Criteria
• 'put' AND '/rest/access-tokens'
• 'post' AND 'ssh/account/keys/add'
• 'personal access token created’
• 'user added ssh access key’
Maintain Persistent Access Logging
57
IBM Security / © 2022 IBM Corporation
• Discovery of CI/CD Configuration file
• Modify CI/CD Configuration file
• Triggers pipeline to run automatically
Modifying CI/CD Pipeline
58
IBM Security / © 2022 IBM Corporation
Bamboo Log
• $BAMBOO_HOME/atlassian-bamboo.log
Search Criteria
• 'change detection found'
Modifying CI/CD Pipeline Logging
SCMKit
IBM Security / © 2022 IBM Corporation
59
60
IBM Security / © 2022 IBM Corporation
• Source Code Management Attack Toolkit written in C#
• https://github.com/xforcered/SCMKit
• Full presentation at Black Hat USA Arsenal 2022
• Supported SCM systems:
• GitHub Enterprise, GitLab Enterprise, Bitbucket Server
• Modules include:
• Reconnaissance, Privilege Escalation, Persistence
Background
61
IBM Security / © 2022 IBM Corporation
Example - Reconnaissance
62
IBM Security / © 2022 IBM Corporation
Example - Privilege Escalation
63
IBM Security / © 2022 IBM Corporation
Example - Persistence
Demos
IBM Security / © 2022 IBM Corporation
64
65
IBM Security / © 2022 IBM Corporation
Demo 1: Software Supply Chain Attack - Repository Takeover on GitHub Enterprise
Demo 2: Lateral Movement from GitLab Enterprise to Artifactory
Demo 3: Lateral Movement from Bitbucket to Jenkins
Demos
Defensive Considerations
IBM Security / © 2022 IBM Corporation
66
67
IBM Security / © 2022 IBM Corporation
• Static signatures in YARA rule file in SCMKit repo
• Static user agent string
• SCMKIT-5dc493ada400c79dd318abbe770dac7c
• All access token and SSH key names created in SCM systems prepended with 
“SCMKIT-”
SCMKit
GitHub Enterprise – Important Logs
68
IBM Security / © 2022 IBM Corporation
Log Name
Location
Audit Log
/var/log/github-audit.log*
Management Log
/var/log/enterprise-manage/unicorn.log*
HAProxy Log
/var/log/haproxy.log
GitHub Enterprise – Log Filters
69
IBM Security / © 2022 IBM Corporation
Attack Scenario
Log Name
Search Filter
Reconnaissance
HAProxy Log
('/search' OR '/api/v3/search') AND 'http'
Repository Takeover
Audit Log
'action:repo.staff_unlock'
User Impersonation
Audit Log
'action:staff.fake_login'
OR
'action:oauth_access.create'
OR
'action:oauth_authorization.create'
Promoting User to Site Admin
Audit Log
'action:user.promote'
OR
'action:business.add_admin'
Maintaining Persistent Access Audit Log
'action:oauth_access.create'
OR
'action:oauth_authorization.create'
OR
'action:public_key.create'
OR
'action:public_key.verify'
Management Console Access
Management Log 'authorized-keys' AND 'post'
GitLab Enterprise – Important Logs
70
IBM Security / © 2022 IBM Corporation
Log Name
Location
Application Log
/var/log/gitlab/gitlab-rails/application.log
/var/log/gitlab/gitlab-rails/application_json.log
Production Log
/var/log/gitlab/gitlab-rails/production_json.log
/var/log/gitlab/gitlab-rails/production.log
API Log
/var/log/gitlab/gitlab-rails/api_json.log
Web Log
/var/log/gitlab/nginx/gitlab_access.log
GitLab Enterprise – Log Filters
71
IBM Security / © 2022 IBM Corporation
Attack Scenario
Log Name
Search Filter
Reconnaissance
Production Log
API Log
Web Log
'get' AND '/search?search'
'get' AND '/search'
'get' AND ('/search'| OR 'repository/tree')
'search'
User Impersonation
Application Log
Production Log
API Log
'has started impersonating'
'impersonate'
'post' AND 'impersonation_tokens'
'impersonation_tokens'
Promoting User to Admin Role
Production Log
API Log
'patch' AND 'admin/users'
'put' AND '"key":"admin","value":"true"'
Maintaining Persistent Access
Production Log
API Log
'post' AND 'personal_access_tokens'
'post' AND 'profile/keys'
'post' AND 'personal_access_tokens'
'post' AND 'user/keys'
Modifying CI/CD Pipeline
Production Log
'post' AND
'/api/graphql'
AND
'.gitlab-ci.yml'
AND 'update'
Bitbucket – Important Logs
72
IBM Security / © 2022 IBM Corporation
Log Name
Location
Access Log
/var/atlassian/application-data/bitbucket/log/atlassian-bitbucket-
access.log
Audit Log
/var/atlassian/application-data/bitbucket/log/audit/*.log
Bitbucket Log
/var/atlassian/application-data/bitbucket/log/atlassian-bitbucket.log
Bamboo Log
$BAMBOO_HOME/atlassian-bamboo.log
Bitbucket – Log Filters
73
IBM Security / © 2022 IBM Corporation
Attack Scenario
Log Name
Search Filter
Reconnaissance
Bitbucket Log
'post' AND 'search' AND 'query'
Promoting User to Site Admin
Access Log
Audit Log
'put' AND '/admin/permissions/users'
'new.permission' AND 'admin'
Maintaining Persistent Access
Access Log
Audit Log
'put' AND '/rest/access-tokens’
'post' AND 'ssh/account/keys/add'
'personal access token created'
'user added ssh access key'
Modifying CI/CD Pipeline
Bamboo Log
'change detection found'
74
IBM Security / © 2022 IBM Corporation
Personal Access Tokens and SSH Keys
•
Set automatic expiration date
•
Do not allow creation with no expiration date
Access and Authorization
•
Limit the number of administrative users
•
Enable multi-factor authentication
•
Disable user impersonation
SCM System Configuration Guidance
75
IBM Security / © 2022 IBM Corporation
Repository Access and Code Commits
•
Policy of least privilege
•
Code branches deleted in a timely manner
•
Require at least one approver for each code commit
•
Require signed commits via GPG keys or S/MIME certificates
Logging
•
Increase logging level to detect reconnaissance where applicable
•
Forward important logs to SIEM
SCM System Configuration Guidance
Conclusion
IBM Security / © 2022 IBM Corporation
76
77
IBM Security / © 2022 IBM Corporation
• SCM systems contain some of most sensitive information in organizations
• Compromise of SCM system can lead to compromise of multiple organizations
• SCM systems need more visibility and research from information security community
Conclusion
78
IBM Security / © 2022 IBM Corporation
Thank You to the below people for feedback and support on this research
•
Chris Thompson (@retBandit)
•
Daniel Crowley (@dan_crowley)
•
Dimitry Snezhkov(@Op_nomad)
•
Patrick Fussell (@capt_red_beardz)
•
Ruben Boonen (@FuzzySec)
Acknowledgements
79
IBM Security / © 2022 IBM Corporation
Twitter: @h4wkst3r
Discord: @h4wkst3r#9627
Blog Post: 
https://securityintelligence.com/posts/abusing-source-code-management-systems
Whitepaper: 
https://www.ibm.com/downloads/cas/OG6KNX1E
Questions?
Appendix - References
81
IBM Security / © 2022 IBM Corporation
•
https://www.cisa.gov/publication/software-supply-chain-attacks
•
https://github.com/enterprise
•
https://about.gitlab.com/enterprise/
•
https://bitbucket.org/product/
•
https://www.redhat.com/architect/devops-cicd
•
https://medium.com/aws-cyber-range/secdevops-101-strengthen-the-basics-20f57197aa1c
•
https://devops.com/the-basics-devsecops-adoption
•
https://www.crowdstrike.com/cybersecurity-101/cyberattacks/supply-chain-attacks/
•
https://www.mandiant.com/resources/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-
sunburst-backdoor
•
https://opensource.googleblog.com/2021/10/protect-your-open-source-project-from-supply-chain-attacks.html
•
https://www.jenkins.io/
•
https://www.jenkins.io/doc/book/pipeline/jenkinsfile/
Appendix - References
82
IBM Security / © 2022 IBM Corporation
•
https://www.jenkins.io/doc/book/pipeline/
•
https://www.jenkins.io/doc/book/using/remote-access-api/
•
https://docs.gitlab.com/runner/
•
https://docs.gitlab.com/ee/api/runners.html
•
https://docs.gitlab.com/ee/ci/yaml/
•
https://docs.github.com/en/enterprise-server@3.3/get-started/quickstart/github-glossary
•
https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-
enterprise/roles-in-an-enterprise
•
https://docs.github.com/en/enterprise-server@3.3/organizations/managing-peoples-access-to-your-organization-
with-roles/roles-in-an-organization
•
https://docs.github.com/en/enterprise-server@3.3/organizations/managing-access-to-your-organizations-
repositories/repository-roles-for-an-organization
•
https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps#available-scopes
•
https://docs.github.com/en/enterprise-server@3.0/rest/guides/getting-started-with-the-rest-api
Appendix - References
83
IBM Security / © 2022 IBM Corporation
•
https://docs.github.com/en/enterprise-server@3.3/rest/reference/search#search-repositories
•
https://docs.github.com/en/enterprise-server@3.3/rest/reference/search#search-commits
•
https://docs.github.com/en/enterprise-server@3.3/rest/reference/search#search-code
•
https://docs.github.com/en/enterprise-server@3.3/rest/reference/enterprise-admin#create-an-impersonation-
oauth-token
•
https://docs.github.com/en/enterprise-server@3.3/rest/reference/enterprise-admin#promote-a-user-to-be-a-site-
administrator
•
https://docs.github.com/en/enterprise-server@3.3/rest/reference/users#create-a-public-ssh-key-for-the-
authenticated-user
•
https://docs.github.com/en/enterprise-server@3.0/admin/configuration/configuring-your-enterprise/command-
line-utilities
•
https://docs.gitlab.com/ee/user/index.html
•
https://docs.gitlab.com/ee/user/permissions.html#project-members-permissions
•
https://docs.gitlab.com/ee/user/permissions.html#group-members-permissions
Appendix - References
84
IBM Security / © 2022 IBM Corporation
•
https://docs.gitlab.com/ee/user/permissions.html#gitlab-cicd-permissions
•
https://docs.gitlab.com/ee/user/permissions.html#job-permissions
•
https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#personal-access-token-scopes
•
https://docs.gitlab.com/ee/api/index.html
•
https://docs.gitlab.com/ee/api/search.html#scope-projects
•
https://docs.gitlab.com/ee/user/search/advanced_search.html
•
https://docs.gitlab.com/ee/api/repositories.html#list-repository-tree
•
https://docs.gitlab.com/ee/api/search.html#scope-blobs-premium-2
•
https://docs.gitlab.com/ee/administration/audit_events.html#impersonation-data
•
https://docs.gitlab.com/ee/api/users.html#create-an-impersonation-token
•
https://docs.gitlab.com/ee/api/users.html#user-modification
•
https://docs.gitlab.com/ee/api/users.html#create-a-personal-access-token
Appendix - References
85
IBM Security / © 2022 IBM Corporation
•
https://docs.gitlab.com/ee/api/users.html#add-ssh-key
•
https://www.atlassian.com/software/bitbucket/enterprise
•
https://bitbucket.org/product/guides/getting-started/overview#key-terms-to-know
•
https://confluence.atlassian.com/bitbucketserverkb/4-levels-of-bitbucket-server-permissions-779171636.html
•
https://confluence.atlassian.com/bitbucketserver/global-permissions-776640369.html
•
https://confluence.atlassian.com/bitbucketserver/using-project-permissions-776639801.html
•
https://confluence.atlassian.com/bitbucketserver/using-repository-permissions-776639771.html
•
https://confluence.atlassian.com/bitbucketserver/using-branch-permissions-776639807.html
•
https://confluence.atlassian.com/bitbucketserver/http-access-tokens-939515499.html
•
https://developer.atlassian.com/server/bitbucket/reference/rest-api/
•
https://docs.atlassian.com/bitbucket-server/rest/7.20.0/bitbucket-rest.html#idp450
•
https://docs.atlassian.com/bitbucket-server/rest/4.5.1/bitbucket-rest.html#idp3716336
Appendix - References
86
IBM Security / © 2022 IBM Corporation
•
https://docs.atlassian.com/bitbucket-server/rest/7.20.0/bitbucket-access-tokens-rest.html
•
https://docs.atlassian.com/bitbucket-server/rest/7.20.0/bitbucket-ssh-rest.html
•
https://www.atlassian.com/software/bamboo
•
https://docs.atlassian.com/bamboo-specs-docs/8.1.2/specs.html?yaml#
•
https://docs.atlassian.com/bamboo-specs-docs/8.1.2/specs.html?java#
•
https://github.com/xforcered/SCMKit
•
https://krebsonsecurity.com/2022/04/leaked-chats-show-lapsus-stole-t-mobile-source-code/
•
https://threatpost.com/microsoft-lapsus-compromised-one-employees-account/179048/
•
https://techcrunch.com/2022/03/30/lapsus-globant-breach/
•
https://www.bleepingcomputer.com/news/security/hackers-leak-190gb-of-alleged-samsung-data-source-code/
•
https://securityintelligence.com/posts/abusing-source-code-management-systems
•
https://www.ibm.com/downloads/cas/OG6KNX1E