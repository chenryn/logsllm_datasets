¡ Action/Component/Data仅仅是狭义的举例，
实际范畴是所有构成Intent的元素均可被注
⼊入
¡ 攻击者可以控制发送intent的目标或数据，
或者是全部
Action
Compo
Extras
Data
…
Intent
¡ curesec发现的安卓拨打电话权限绕过漏洞CVE-­‐2013-­‐6272  
（1k），但依然发现了⼀一个0dayJ
¡ WapPushManager中存在的SQL注⼊入，也是Intent注⼊入，攻
击者可以远程发送恶意wappush指令，让⼿手机启动组件
¡ 我们在2014-­‐10-­‐11报告安卓，2014-­‐11-­‐8确认
com.android.smspush.WapPushManager
¡ 通过模拟端⼝口发送wappush sms
¡ ⼿手机收到后，触发SQL注⼊入，查询出settings的component
并启动
¡ 4.4.4的POC如下
0891683108200105f04408a00156
08860104216092902512237B0605
040b8423f00A065603B081EAAF2
720756e696f6e2073656c65637420
302c27636f6d2e616e64726f6964
2e73657474696e6773272c27636f6
d2e616e64726f69642e736574746
96e67732e53657474696e6773272c
302c302c302d2d200002066A008
509036D6F62696C65746964696E
67732E636F6D2F0001
37
parseUri注入
PendingIntent误用
Action/Component/Data注入
Intent转换与复制
Intent注入的概念
¡ PendingIntent，经常用于通知
§ Pending：延时的
§ 包裹着真实的intent
§ 创建者的context
¡ A把将来要发送的intent打包，
然后交给B，让B在将来代表A
发出这个intent
¡ 即使A已经不存在，B也能以A
的context来发出这个intent
B篡改这个intent  =  intent注⼊入
¡ 安卓也意识到PendingIntent的风险，设置了限制，详见
android.content.Intent.fillin()
¡ 默认情况下（除非开发者设置特殊标记）
§ B⽆无法修改Component
§ 仅当A的原始Intent中action为空，B才可以修改action
¡ 但是，如果A的原始Intent中component与action都为空，B
就可以控制Intent的目标，B填⼊入Extras部分的数据直接合并
覆盖A的-­‐>目标与数据均被B控制-­‐>Intent注⼊入（注：这里描述的是⼤大部
分情况，忽视了pkg,  data,  type,  category这些数据在intent解析中的影响）
Action
Compo
Extras
Data
…
Intent
目标
数据
¡
http://developer.android.com/reference/android/app/PendingIntent.html
By  giving  a  PendingIntent to  another  application,  you  are  granting  it  the  right  to  
perform  the  operation  you  have  specified  as  if  the  other  application  was  
yourself  (with  the  same  permissions  and  identity).  As  such,  you  should  be  careful  
about  how  you  build  the  PendingIntent:  almost  always,  for  example,  the  base  
Intent  you  supply  should  have  the  component  name  explicitly  set  to  one  of  your  
own  components,  to  ensure  it  is  ultimately  sent  there  and  nowhere  else.
¡
扫描每个method，根据情况调整告警级别
§
发现有构造PendingIntent的⽅方法，例如getActivity，getBroadcast，getService，
createPendingResult，getActivities，若有报告并设定告警级别为低
§
在同⼀一个method中，扫描是否调用Intent的设置Component⽅方法，例如特定intent构
造函数，setClass，setClassName，setComponent等，若没有，调⾼高告警级别为中
§
在同⼀一个method中，扫描是否调用Intent的设置action⽅方法，例如特定intent构造函
数， setAction等，若没有，调⾼高告警级别为⾼高
§
其他⼀一些细节调整：例如开发⼈人员主动设置了相关的特殊标记，同⼀一个method中
用putExtra将PendingIntent打包到intent中
¡
对Android  4.4全系统扫描后发现152例告警，其中⾼高优先级35例，发
现⼀一个0day…
¡ 安卓Settings中存在PendingIntent权限泄漏漏洞，恶意⽆无
权限app可以system权限发送⼀一个含action与数据的⼴广播
¡ 我们在2014-­‐9-­‐2报告安卓，2014-­‐9-­‐10确认
com.android.settings.accounts.AddAccountSettings.addAccount(String)
¡ 安装时提示⽆无需任何
权限
¡ 启动后自动伪造来自
任意⼿手机号的⼀一条短
信
¡ 另外⼀一个严重的
Demo中，启动后自
动重启用户⼿手机并清
除包括短信，通信录
等数据
¡
https://android.googlesource.com/platform/frameworks/base/+/android-­‐
5.1.1_r8/keystore/java/android/security/KeyChain.java
¡
https://android.googlesource.com/platform/frameworks/opt/telephony/+/android-­‐
5.1.1_r8/src/java/com/android/internal/telephony/gsm/GsmServiceStateTracker.java
47
parseUri注⼊入
PendingIntent误用
Action/Component/Data注入
Intent转换与复制
Intent注入的概念
¡
https://developer.chrome.com/multidevice/android/intents
A  little  known  feature  in  Android  lets  you  launch  apps  directly  from  a  web  page  
via  an  Android  Intent.  Only  activities  that  have  the  category  filter,  
android.intent.category.BROWSABLE are  able  to  be  invoked  using  this  method  
as  it  indicates  that  the  application  is  safe  to  open  from  the  Browser.
基于intent的URI语法如下:  （可参考安卓源码android.content.Intent.parseUri()
intent:
HOST/URI-­‐path  //  Optional  host  
#Intent;  
package=[string];  
action=[string];  
category=[string];  
component=[string];  
scheme=[string];  
end;
参考：
[1]  http://www.mbsd.jp/Whitepaper/IntentScheme.pdf
[2]  http://drops.wooyun.org/papers/2893
¡
com.android.webview.chromium.WebViewContentsClientAdapter.java
¡
直接查找intent.parseUri⽅方法的调用即可
¡
对Android  4.4全系统扫描后发现9例告警，并未发现明显的安全问题
¡
于是我们去看Chrome，于是发现⼀一个0day…
¡
检查Intent的action是否等于某个常量字符串，符合条件的intent被启
动activity。
¡
但可以直接在uri中指定component，⽆无视action，启动任意activity，
即使未声明BROWSABLE
¡
我们在2014-­‐10-­‐9报告Chrome，2014-­‐10-­‐9确认
¡ 访问页面自动触发（Chrome  
Android <=37.0.2062.117）
¡ 访问⽹网页自动触发，详见
https://code.google.com/p/chromiu
m/issues/detail?id=421817
¡ 演示视频是基于小米语音助⼿手，与
上述链接中的POC略有修改
¡ Intent注⼊入漏洞，并非⼀一个新的概念，它早就存在。它比
较稀少，因此容易被忽视
¡ 归纳了Intent注⼊入的4种形式：Intent转换与复制、
Action/Component/Data注⼊入、PendingIntent误用与
parseUri注⼊入
¡ 归纳了利用自动化的⼯工具发现这4类形式的⽅方法，通过批
量的扫描，可以轻易发现这些漏洞
¡ 在每种都找到了⼀一个安卓OS或Chrome安卓版的0day，达
到本地提权或远程命令执⾏行的效果，分别得到了Android
与Chrome的官⽅方致谢
¡
Android官⽅方致谢：http://source.android.com/devices/tech/security/overview/acknowledgements.html
¡
Chrome官⽅方致谢：http://googlechromereleases.blogspot.com/2014/11/stable-­‐channel-­‐update_18.html
¡ 谢谢！