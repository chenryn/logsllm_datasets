Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:57:38 UTC from IEEE Xplore.  Restrictions apply. 
GET/homepage?userid=5&popups=noHTTP/1.1User-Agent:Mozilla/1.7Accept:text/html......theninadditiontoplacingtherequestinoneofthedy-namicrequestqueues,theheaderparsingthreadwillfur-therparsethequerystring“userid=5&popups=no”andthetwoheaders“User-Agent”and“Accept”.Theheadersandquerystringwilleachbeparsedintoadictionary(a.k.a.hashtable).Weperformthesefurtherparsingsmainlybe-causewedonotwantathreadwithanopendatabasecon-nectiontowastetimedoinganythingotherthangeneratingdata.Thisisnotanissueforstaticrequests,soweletthethreadswhichactuallyservethosestaticrequestsparsetheirheaders.Eachdynamicrequestthreadmapstherequeststringtoafunction,thenexaminesthefunction’sreturnvaluetoseewhetheritisastringoratemplatetoberendered.EveryfunctionshouldreturnanunrenderedtemplateasdescribedinSection3.1,andweperformthischecktoallowback-wardcompatibilitysothatunmodiﬁedtemplatecodecanstillproperlyrunonourmodiﬁedwebserver.Ifthefunc-tionreturnsastring,thenthedynamicrequestthreaddi-rectlysendsthestringtotheclient.Ifthefunctionreturnsatemplate,thenthedynamicrequestthreadpassestherequestontothepooloftemplaterenderingthreads.Afteroneofthetemplaterenderingthreadsﬁnishestherenderingofadynamicpage,itmeasuresthesizeoftheoutput.Thus,itisabletosettheContent-LengthHTTPresponseheaderappropriately,whichcannotbeachievedbymostexistingmethodsindynamiccontentgeneration.Thetemplaterenderingthreadthentransmitstheresponsetotheuseragentclient.3.3SchedulingPolicyOurrequestschedulingmethodusestwothreadpoolsforservingdynamicrequests:ageneraldynamicrequestthreadpool,andalengthydynamicrequestthreadpool.Wereferthesetwopoolsasthegeneralpoolandthelengthypool,respectively.Thelengthypoolonlyhandlestherequestswhichtakealongtimetoserve.Weusedacutoffpointoftwosecondstodistinguishbetweenquickandlengthyrequests,whichissuitableforourbenchmark.Thegeneralpoolhandlesbothquickandlengthydy-namicrequests,andtherequestswhichcanbeprocessedquicklyarealwaysservedbythispool.Becauseourmainpriorityistoensurethatquickrequestsdonotgetstuckinaqueuebehindanumberoflengthyrequests,thegeneralpoolhasfourtimesasmanythreadsasthelengthypool.Inordertodistinguishbetweenquickandlengthyre-quests,wetracktheaveragetimespentingeneratingdataforeachpage.Speciﬁcally,wemeasurethetimecostinconditiondispatchdecisionaquickrequestsendtogeneralpoolalengthyrequestandtspare>treservesendtogeneralpoolalengthyrequestandtspare≤treservesendtolengthypoolTable1.Dynamicrequestdispatchingrules.thedynamicrequestthread,fromwhentherequestisac-quiredthroughwhenitsunrenderedtemplateisplacedinthetemplaterenderingqueue.Thisgivesustheaccuratemea-surementofhowmuchtimeisspentinperformingdatabasequeries.Toensurethatquickrequestsarealmostalwaysservedimmediately,ourwebservertracksthenumberofsparethreadsinthegeneralpool,whichwecalltspare.Italsokeepsupdatingashiftingminimumnumberofthreadsre-servedforquickrequests,calledtreserve.Thetspareisameasuredvaluethatreﬂectstheloadofthewebserver,whilethetreserveisadynamicallyadjustedvaluethatre-ﬂectsthetargetednumberofthreadsthatshouldbereservedforquickrequests.Inthecaseoftsparebeinggreaterthantreserve,thesparethreadsinthegeneralpoolisabundantandtheycanservesomelengthyrequestsinadditiontopro-cessingallthequickrequests.Inthecaseoftsparebeingnogreaterthantreserve,thesparethreadsinthegeneralpoolfallshortandshouldbededicatedtoservingquickrequests.Therefore,whenaheaderparsingthreadreceivesalengthyrequest,itsendstherequesttothegeneralpooliftspareisgreaterthantreserve;otherwisetherequestissenttothelengthypool.Table1summarizesthethreerulesfordis-patchingadynamicrequestbyaheaderparsingthread.Ourwebserverchecksandmodiﬁestreserveoncepersecondinordertodealwithtrafﬁcspikes.Becausewewanttopreventquickrequestsfrombeingqueuedbehindlengthyrequests,weincreasetreserveanytimewesuspectthatatrafﬁcspikeisoccurring.Speciﬁcally,wheneverts-paredropsundertreserve,weincreasetreservebythedif-ference,plustheamountthattsparehasdroppedbeneathaconﬁguredminimumvalueoftreserve,ifapplicable.Welowertreservemoreslowlytoavoidprematurelyas-sumingthatatrafﬁcspikehasended.Whentsparerisesabovetreserve,welowertreservebyhalfthedifferencebutwithoutmakingitlessthantheconﬁguredminimumvalue.Table2liststhedynamicsoftreservevs.tspareovera10-secondperiodwiththeminimumvalueoftreserveconﬁg-uredas20.Intuitively,wheneveratrafﬁcspikeisoccurringandsparethreadsinthegeneralpoolbecomescarce,wein-creasethetreservesothatmorelengthydynamicrequestscanbedispatchedtothelengthypool,thusreservingthethreadsinthegeneralpoolonlyforquickrequests.Bycon-trast,whenatrafﬁcspiketendstodisappearandthesparethreadsinthegeneralpoolbecomeabundant,wedecrease978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
254
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:57:38 UTC from IEEE Xplore.  Restrictions apply. 
thetreservesothatthesesparethreadscanalsobeusedtoprocessincominglengthydynamicrequests.timetsparetreserve∆treserve1s3520+02s2420+03s1720+64s2126+55s3031+16s3632-27s3830-48s3726-59s3521-110s3920+0Table2.Changestotreserveoveranexample10-secondperiod.Notethatwhilewehavemultiplethreadpoolsforservingdynamicrequests,weonlyhaveonethreadpoolforstaticrequestsandonethreadpoolfortemplaterendering.Thisisbecausethetimedifferenceinservingdifferentstaticre-questsorrenderingdifferenttemplatesismuchlesssignif-icantthanthatcausedbydifferentrequestswhichrequiredatabasequeries.However,applyingthistechniquetostaticrequestsandtemplaterenderingmightbeworthwhileonadifferentbenchmarkorwebapplication.4SystemEvaluationInthissection,weﬁrstdescribetheexperimentalsetupincludingtheTPC-WbenchmarkimplementedwithDjangowebtemplates,andthetestbedconﬁguration.Thenwepresenttheexperimentalresults.4.1ExperimentalSetupWeemployTPC-W,atransactionalwebe-commercebenchmark[24]fortheperformanceevaluationofthepro-posedrequestschedulingmethod.TPC-Wexercisesanon-linebookstore,whichsupportsafullrangeofactivities,suchasmultipleon-linesessions,dynamicpagegeneration,andonlinetransactions.Italsospeciﬁesaworkloadgen-eratorthatsimulatesmanyclientsvisitingawebsite.Thisbenchmarkiswelldesignedtomimicatypicalrealworldwebapplication,particularlybyhavingdatabaseaccessesbethebottleneckwhenthesitecomesunderheavyload.Unfortunately,existingTPC-Wimplementationsareallwrittenusingthetraditionaltechniquesfordynamicwebcontentgeneration.Forexample,PHARMteamoftheUni-versityofWisconsin-Madison[17]developedJavaservletsimplementationofTPC-Wbenchmark,andateamofRiceW(cid:13)e(cid:13)b(cid:13)/(cid:13)A(cid:13)p(cid:13)p(cid:13)l(cid:13)i(cid:13)c(cid:13)a(cid:13)t(cid:13)i(cid:13)o(cid:13)n(cid:13) (cid:13)S(cid:13)e(cid:13)r(cid:13)v(cid:13)e(cid:13)r(cid:13)D(cid:13)a(cid:13)t(cid:13)a(cid:13)b(cid:13)a(cid:13)s(cid:13)e(cid:13) (cid:13)S(cid:13)e(cid:13)r(cid:13)v(cid:13)e(cid:13)r(cid:13)C(cid:13)l(cid:13)i(cid:13)e(cid:13)n(cid:13)t(cid:13) (cid:13)E(cid:13)m(cid:13)u(cid:13)l(cid:13)a(cid:13)t(cid:13)o(cid:13)r(cid:13)HTTPrequests/(cid:13)responses(cid:13)Databaserequests/(cid:13)responses(cid:13)Figure6.Experimentaltestbed.University[18]developedPHP,JavaServlets,andEJBim-plementationsofTPC-Wbenchmark.Therefore,wehavetoimplementTPC-Wbenchmarkfromscratchusingamod-ernwebtemplatetechnique.WechooseDjangotemplate,whichissupportedbyCherryPywebserverandisusedbytheWashingtonPostformuchofitsonlinecontent.OurimplementationoftheTPC-Wbenchmarkconsistsof455linesofPythoncodeand704linesoftemplatecode(mostofwhichispureHTML).It’sworthnotingthatthisimple-mentationhaslessthan1/4asmanylinesofcodeastheJavaServletsimplementationbyPHARMteam.InourexperimentaltestbedshowninFigure6,threecomputersareusedtoperformtheTPC-Wbenchmark.OnecomputerisusedtoruntheMySQL5.0databaseserver,oneisusedastheCherryPywebservertohostboththestaticanddynamiccontent,andoneisusedastheworkloadgenerator.Eachcomputerhas8different3.7GHzCPUs,eachwith16KBofL1cacheand2MBofL2cache.Theyeachhave8GBofRAMandrunLinuxwithkernelversion2.6.18,andareallconnectedtothesamelocalareanetworkwitha100Mbnetworkinterfacecard.Thedurationofeachexperimentisonehourandthemeasurementintervalis50minutes.Theﬁrstﬁve-minuterampuptimeandthelastﬁve-minutecooldowntimearenotincluded.TheTPC-Wdatabaseisconﬁguredtohaveonemillionbooks,2.88millioncustomers,and2.59millionbookor-ders.Allexperimentalrunsdescribedinthispaperarecon-ductedwithstandard“browsingmix”workload,andeachsimulatedclientwaitsthestandardtimeof0.7to7secondsbeforevisitinganewpage.Theworkloadgeneratorsimu-lates400clientsinordertoputthewebserverunderaheavyload.Theserversaresetupasinaproductionenvironment,wherethewebanddatabaseserverswouldcertainlybeonthesameLAN.Ofcourse,mostclientswouldnotbecon-nectedfromthesamenetwork,sothetransfertimesforthisbenchmarkarefarbelowwhattheywouldbeforarealwebsite.However,thisshouldnotbeaproblemherebecauseweareprimarilyinterestedinthedecreaseofdatabasequeryresponsetimesratherthantransferlatencies.978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
255
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:57:38 UTC from IEEE Xplore.  Restrictions apply. 
4.2ExperimentalResultsWeusetwoperformancemetricstocompareourproposedschemewiththetraditionalthread-per-requestscheme:webinteractionresponsetimeandwebserverthroughput.InTPC-W,awebinteractionreferstoacom-pletecycleofthecommunicationbetweenanemulatedclientandtheserversystemundertest.Thewebinterac-tionresponsetimeismeasuredattheclient-sidebycalcu-latingthetimelapsedfromtheﬁrstbyteofawebinterac-tionrequestsentoutbyaclienttothelastbyteofthewebinteractionresponsereceivedbytheclient.Thewebserverthroughputismeasuredattheserver-sideintermsofthenumberofcompletedwebinteractionsperminute.Intherestofthissection,weusetheterm“unmodiﬁedwebserver”torefertotheconventionalthread-per-requestCherryPywebserver,onwhichTPC-WbenchmarkwithunmodiﬁedDjangowebtemplatesisrun.Weusetheterm“modiﬁedwebserver”torefertoourproposedmultiple-thread-poolCherryPywebserver,onwhichTPC-Wbench-markwithmodiﬁedDjangowebtemplatesisrun.4.2.1WebInteractionResponseTimeTheaverageresponsetimesofrunningthebenchmarkwiththeunmodiﬁedandmodiﬁedwebserversarelistedinTa-ble3.For11outofthe14pagesofthebenchmarkwebsite,theproposedschemesigniﬁcantlyshortensthewebin-teractionresponsetimes.Theaverageresponsetimesofmanypageslikethehomepage(TPC-Whomeinteraction)aredecreasedbytwoordersofmagnitude.Oneslowpage(TPC-Wnewproducts)staysaboutthesame,one(TPC-Wexecutesearch)becomesslightlyslowertorespond,andone(TPC-Wadminresponse)isclearlytakenlongertimetorespond.Thesharpperformancedichotomybetweentheex-tremelyfastandveryslowpagesinthemodiﬁedwebserverispartiallyduetotheTPC-Wbenchmarkitself.Mostofthequeriesareeitherselectstatementsmakinguseofanindex,orinsertstatementsaddinganewrow.Neitheroftheseop-erationsareveryslowevenonextremelylargedatabases;creatingadatabasewith10timesthesizeofthecurrentonedoesnotcausethefastqueriestobecomenoticeablyslower.Ofthe14pagesintheTPC-Wbenchmark,10arein-herentlyveryfast(lessthan10seconds)forthereasonsdescribedabove,threeareveryslowbecausetheyperformlargeandverycomplexqueries,andthelastoneisveryslowbecauseitperformsanupdateonafrequentlyusedtable.ThislastpageistheTPC-Wadminresponsepage,whichistheonlypagetoexperienceasigniﬁcantslowdownwithourmodiﬁedwebserver.Inordertoperformitsupdate,itmustacquirealockonadatabasetable,forcingittowaitforotherthreadstoﬁnishtheuseofthetable.Ironically,thiswebpagenameunmodiﬁedmodiﬁedTPC-Wadminrequest4.890.62TPC-Wadminresponse12.3518.85TPC-Wbestsellers18.4912.88TPC-Wbuyconﬁrm3.860.18TPC-Wbuyrequest3.740.07TPC-Wcustomerregistration4.460.01TPC-Wexecutesearch11.0513.21TPC-Whomeinteraction2.540.03TPC-Wnewproducts20.3021.39TPC-Worderdisplay2.780.54TPC-Worderinquiry4.840.04TPC-Wproductdetail1.100.01TPC-Wsearchrequest5.440.01TPC-Wshoppingcartinteraction6.820.27Table3.TPC-Wpagesandtheiraveragere-sponsetimes(seconds)ontheunmodiﬁedandmodiﬁedwebservers. 0 50 100 150 200 250 300 0 500 1000 1500 2000 2500 3000# of queued requestsTime (seconds)Figure7.Lengthofthequeuefordynamicre-questsontheunmodiﬁedwebserver.pageisslowertorespondforourmodiﬁedserverbecausetheotherpagesaresomuchmoreefﬁcient,lengtheningthewaittimetoacquirethetablelock.Infact,intheabsenceofanyconsiderableloadontheserver,thispageisquitefast.Aslowadminpageisnotastroublesomeasaslowpagevisibletocustomersonane-commercesite.Whilepayingcustomersmightleaveasitewhichisslowinresponse,thisproblemdoesnotexistforthepagesonlyvisibletoadmins.Thus,themostlysufferedpageinthemodiﬁedserveristhepagethatmattersleasttotheproﬁtabilityofanonlinebook-store.Figure7illustratestheeffectthattheseslowquerieshaveontheresponsetimesofotherwebpagesbyshow-ingthelengthoftherequestqueuefortheunmodiﬁedwebserver.Itisclearthatthequeuelengthtendstobeverylargewhenshortrequestsgetstuckbehindlengthyrequestsinthequeue.Ascomparison,Figures8(a)and8(b)showthelengthofqueuesthatareassociatedwiththetwody-namicrequestthreadpoolsinthemodiﬁedwebserver.Ontheonehand,theshortqueriesareabletoexecutealmostimmediatelybecausetherearethreadsreservedfortheminthegeneraldynamicrequestthreadpool.Ontheother978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
256