### 5.4.2 磁盘格式化

硬盘由一叠铝、合金或玻璃盘片组成，直径通常为5.25英寸或3.5英寸（笔记本电脑上可能更小）。每个盘片表面覆盖着一层薄薄的可磁化金属氧化物。在制造过程中，这些磁盘上没有任何信息。

#### 低级格式化
在磁盘能够使用之前，必须对其进行低级格式化。低级格式化通过软件完成，创建一系列同心的磁道，每个磁道包含若干扇区，并在扇区间留有间隙。一个典型的扇区结构如图5-25所示：

1. **前导码**：以特定的位模式开始，使硬件能够识别扇区的起始位置。前导码还包含柱面和扇区编号等信息。
2. **数据部分**：大小由低级格式化程序决定，大多数磁盘使用512字节的扇区。
3. **ECC域**：包含冗余信息，用于恢复读取错误。ECC域的大小和内容因生产商而异，取决于设计者愿意牺牲多少磁盘空间来提高可靠性，以及控制器处理ECC编码的能力。常见的ECC域大小为16字节。
4. **备用扇区**：所有硬盘都分配有一定数量的备用扇区，用于替换有制造缺陷的扇区。

#### 柱面斜进
为了提高性能，每个磁道上的第0扇区与前一个磁道存在偏移，这种偏移称为柱面斜进。这样可以确保在连续读取多个磁道时不会丢失数据。例如，假设一个读请求需要从最内侧磁道的第0扇区开始读取18个扇区，磁盘旋转一周可以读取前16个扇区，但为了读取第17个扇区，磁头需要向外移动一个磁道。如果没有柱面斜进，磁头会错过第0扇区，导致需要再旋转一周才能再次读取。柱面斜进量取决于驱动器的几何规格。例如，一个10,000 RPM的驱动器每6毫秒旋转一周，如果一个磁道包含300个扇区，则每20微秒就有一个新扇区经过磁头。如果磁道到磁道的寻道时间是800微秒，则在寻道期间将有40个扇区经过，因此柱面斜进应为40个扇区。

#### 格式化的影响
低级格式化会导致磁盘容量减少，减少的量取决于前导码、扇区间隙、ECC域的大小以及保留的备用扇区数量。通常，格式化后的容量比未格式化的容量低约20%。备用扇区不计入格式化容量，因此同类型的磁盘出厂时具有相同的容量，无论它们有多少坏扇区（如果坏扇区数量超过备用扇区数量，则该驱动器不合格，不会出厂）。

#### 容量混淆
某些制造商在广告中宣传的是未格式化的容量，这使得他们的驱动器看起来比实际容量大。例如，一个未格式化容量为200 GB的驱动器，在格式化后可能只有170 GB可用于存储数据。操作系统可能将其报告为158 GB，因为软件将1 GB视为2^30字节（即1,073,741,824字节），而不是10^9字节（即1,000,000,000字节）。

#### 性能影响
低级格式化还会影响磁盘性能。例如，一个10,000 RPM的磁盘，每个磁道有300个扇区，每个扇区512字节，可以在6毫秒内读取一个磁道上的153,600字节，数据率为25,600,000字节/秒或24.4 MB/s。即使使用80 MB/s或160 MB/s的SCSI接口，也不可能超过这个速度。

实际上，要以这一速率连续读取磁盘，控制器需要一个大容量缓冲区。例如，如果控制器只有一个扇区的缓冲区，并接到读取两个连续扇区的命令，当第一个扇区被读出并进行ECC计算后，数据必须传送到主存。在此过程中，下一个扇区将从磁头下通过。当复制完成后，控制器需要等待几乎一整周的旋转时间才能再次读取第二个扇区。

通过在格式化磁盘时交错扇区编号可以解决这个问题。图5-27a显示了通常的编号模式（忽略柱面斜进），图5-27b显示了单交错，图5-27c显示了双交错。如果控制器拥有整个磁道的缓存能力，许多现代控制器都能做到这一点，就不需要交错。

#### 分区
低级格式化完成后，磁盘需要进行分区。每个分区在逻辑上就像一个独立的磁盘。分区对于多个操作系统的共存是必需的。此外，在某些情况下，分区可以用于交换。在Pentium和其他计算机上，0扇区包含主引导记录（MBR），其中包含引导代码和分区表。分区表列出了每个分区的起始扇区和大小。在Pentium上，分区表有四个分区的空间。如果这四个分区都用于Windows，它们将被称为C:、D:、E:和F:，并作为单独的驱动器对待。如果其中有三个用于Windows，一个用于UNIX，那么Windows会将它的分区称为C:、D:和E:，然后第一个CD-ROM是F:。为了能够从硬盘引导，在分区表中必须有一个分区被标记为活动的。