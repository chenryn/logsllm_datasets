Do Not Trust the ASA, Trojans!
Jacob Baines
Lead Security Researcher, Rapid7
August 11, 2022
2
Introduction
Adaptive Security Appliance (ASA)
Original ASA
ASA-X
ASA-X with FirePOWER Services
3
ASAv Product Landing Page
Introduction
ASA Virtual Appliance (ASAv)
4
Firepower 9300 Series
Firepower 1000 Series
Firepower 2100 Series
Firepower 4100 Series
Secure Firewall 3100 Series
Secure Firewall ISA3000
ASA Service Module
ASA Software Landing Page
Introduction
Sort of ASA
5
Introduction
Adaptive Security Appliance (ASA)
6
Introduction
Do Not Trust the ASA
7
ASDM Product Landing Page
Introduction
Adaptive Security Device Manager (ASDM)
8
Request pdm.sgz
pdm.sgz
Admin session
Load and 
execute SGZ 
contents
Understanding ASDM
Starting ASDM Client Overview
9
Exploiting ASDM
ASDM Client Does Not Verify the Server Cert 
10
Exploiting ASDM
ASDM/ASA Man in the Middle
11
Exploiting ASDM
Man in the Middle with mitmproxy
12
Contents of 7.18.1 SGZ
-
13472 class ﬁles
-
6 jars
-
1 prop ﬁle
-
4 properties ﬁles
-
3 txt ﬁles
-
1 SIGNATURE ﬁles
github.com/jbaines-r7/getchoo
Exploiting ASDM
What’s in the SGZ?
13
Cisco ASDM RCE Vulnerability (CVE-2021-1585)
Exploiting ASDM
SGZ Client Logic Isn’t Veriﬁed (CVE-2021-1585)
14
1. Administrator connects to 
attacker using the ASDM client
2. The attacker responds with a 
malicious SGZ ﬁle.
3. A reverse shell is established from 
the Administrator to the attacker
Exploiting ASDM
CVE-2021-1585 Exploited via Evil Endpoint
15
Exploitation
-
Missing SSL veriﬁcation (No CVE) plus 
SGZ code not veriﬁed (CVE-2021-1585)
-
Evil endpoint or Man in the Middle
CVE-2021-1585
-
Disclosed in July 2021 with no patch
-
Failed patch in June 2022
-
Remains unpatched as of July 2022
Public Exploits
-
staystaystay
-
Metasploit module
github.com/jbaines-r7/cisco_asa_research/
tree/main/modules/cve_2021_1585
github.com/jbaines-r7/staystaystay
Exploiting ASDM
CVE-2021-1585 Exploits
16
Crafting a Malicious ASDM Package
Hacker Cat Can’t Get Inside Corpnet
17
Crafting a Malicious ASDM Package
Unless… We Modify the SGZ on the ASA!
18
Crafting a Malicious ASDM Package
How Does the SGZ Get On the ASA?
19
Header
Manifest
Files
Magic
Description
File length
Hash
Filename
Data offset
Data length
Filename
Data offset
Data length
Filename
Data offset
Data length
Raw Data
Crafting a Malicious ASDM Package
ASDM Binary Package Format
20
Header
Manifest
Files
Magic
Description
File length
Hash
Filename
Data offset
Data length
Filename
Data offset
Data length
Filename
Data offset
Data length
Raw Data
Crafting a Malicious ASDM Package
Is this a Security Feature?
21
Header
Manifest
Files
Magic
Description
File length
Hash
Filename
Data offset
Data length
Filename
Data offset
Data length
Filename
Data offset
Data length
Raw Data
Crafting a Malicious ASDM Package
Nope, Just an MD5 Hash
22
Crafting a Malicious ASDM Package
Missing ASDM Package Veriﬁcation (CVE-2022-20829)
23
Crafting a Malicious ASDM Package
ASA Will Host Any ASDM Package
24
Filename
Data offset
Data length
Filename
Data offset
Data length
Header
Manifest
Files
Magic
Description
File length
Hash
Filename
Data offset
Data length
Raw Data
1.
asdm50-install.msi
2.
asdmversion.html
3.
dm-launcher.dmg
4.
dm-launcher.msi
5.
pdm.sgz
6.
pdmversion.html
7.
public/asa-pix.gif
8.
public/asdm.jnlp
9.
public/asdm32.gif
10.
public/cert.jnlp
11.
public/cisco.gif
12.
public/deployJava.js
13.
public/dm-launcher.jar
14.
public/index.html
15.
public/jploader.jar
16.
public/lzma.jar
17.
public/retroweaver-rt-2.0.jar
18.
public/startup.jnlp
19.
version.prop
Crafting a Malicious ASDM Package
ASDM Binary Package Contents
25
Filename
Data offset
Data length
Filename
Data offset
Data length
Header
Manifest
Files
Magic
Description
File length
Hash
Filename
Data offset
Data length
Raw Data
1.
asdm50-install.msi
2.
asdmversion.html
3.
dm-launcher.dmg
4.
dm-launcher.msi
5.
pdm.sgz
6.
pdmversion.html
7.
public/asa-pix.gif
8.
public/asdm.jnlp
9.
public/asdm32.gif
10.
public/cert.jnlp
11.
public/cisco.gif
12.
public/deployJava.js
13.
public/dm-launcher.jar
14.
public/index.html
15.
public/jploader.jar
16.
public/lzma.jar
17.
public/retroweaver-rt-2.0.jar
18.
public/startup.jnlp
19.
version.prop
Crafting a Malicious ASDM Package
ASDM Binary Package Contains pdm.sgz
26
The Way
-
Parses and extracts ASDM packages
-
Rebuilds ASDM packages
-
Generates ASDM packages
CVE-2022-20829
-
Disclosed to Cisco in February 2022
-
ASA Software ﬁx planned for August 2022
github.com/jbaines-r7/theway
Crafting a Malicious ASDM Package
Extracting Cisco ASDM Binary Packages
27
The Way
-
Parses and extracts ASDM packages
-
Rebuilds ASDM packages
-
Generates ASDM packages
CVE-2022-20829
-
Disclosed to Cisco in February 2022
-
ASA Software ﬁx planned for August 2022
github.com/jbaines-r7/theway
Crafting a Malicious ASDM Package
Building Cisco ASDM Binary Packages
28
The Way
-
Parses and extracts ASDM packages
-
Rebuilds ASDM packages
-
Generates ASDM packages
CVE-2022-20829
-
Disclosed to Cisco in February 2022
-
ASA Software ﬁx planned for August 2022
github.com/jbaines-r7/theway
Crafting a Malicious ASDM Package
Generating Malicious ASDM Binary Packages
29
Crafting a Malicious ASDM Package
Malicious Cisco ASA
30
???
Crafting a Malicious ASDM Package
How To Get Malicious ASDM Package Installed?! 
31
Crafting a Malicious ASDM Package
Supply Chain
32
Remotely Rooting the ASA-X FirePOWER Module
33
Remotely Rooting the ASA-X FirePOWER Module
ASA-X with FirePOWER Services
34
Recreation of Image Published by Cisco
Remotely Rooting the ASA-X FirePOWER Module
ASA-X with FirePOWER Services Explained
35
Remotely Rooting the ASA-X FirePOWER Module
ASA-X with FirePOWER Services Explained
36
The command to invoke 
FirePOWER shell from 
ASA CLI
The FirePOWER 
shell requires a new 
set of credentials 
(admin:Admin123)
FirePOWER module shell
Remotely Rooting the ASA-X FirePOWER Module
Accessing the FirePOWER Module via Cisco CLI
37
Remotely Rooting the ASA-X FirePOWER Module
expert Command Yields Root Shell
38
Remotely Rooting the ASA-X FirePOWER Module
SSH Root Shell as a Feature
39
Remotely Rooting the ASA-X FirePOWER Module
An Attacker’s Dream
40
Remotely Rooting the ASA-X FirePOWER Module
Disable Root Shell via lockdown-sensor
41
Remotely Rooting the ASA-X FirePOWER Module
ASDM Can Talk to the FirePOWER Module
42
Remotely Rooting the ASA-X FirePOWER Module
ASDM Cannot Access the Root Shell
43
Remotely Rooting the ASA-X FirePOWER Module
session sfr do `shell command`
44
Remotely Rooting the ASA-X FirePOWER Module
session sfr do `shell command`
45
Remotely Rooting the ASA-X FirePOWER Module
Tweetable Reverse Shell
46
Remotely Rooting the ASA-X FirePOWER Module
session sfr do `ghost in the shell`
47
Remotely Rooting the ASA-X FirePOWER Module
CVE-2022-20828: Authenticated RCE
48
Remotely Rooting the ASA-X FirePOWER Module
ASDM Uses HTTP Basic Auth by Default
49
"ASDM Book 1" by Cisco
Remotely Rooting the ASA-X FirePOWER Module
Default Creds are :
50
ASDM Client Credential Logging
-
Assigned CVE-2022-20651
-
We developed a Metasploit module that 
hunts out the leaked credentials
github.com/jbaines-r7/cisco_asa_research/
tree/main/modules/cve_2022_20651
Remotely Rooting the ASA-X FirePOWER Module
ASDM Logs Credentials to File
51
Remotely Rooting the ASA-X FirePOWER Module
HTTP Brute-Force Protection Disabled by Default
52
ASDM HTTP Brute-Force
-
Generic HTTP brute-force won’t work due to 
user agent requirements.
-
Previous ASA brute-force modules hit the 
clientless VPN interface.
-
ASDM credentials can give privileged access 
and aid in network pivoting!
-
No shame in brute-force attacks. If it’s good 
enough for GRU, it’s good enough for you.
github.com/jbaines-r7/cisco_asa_research/
tree/main/modules/asdm_bruteforce
Remotely Rooting the ASA-X FirePOWER Module
Metasploit ASDM Brute-Force Module
53
github.com/jbaines-r7/cisco_asa_research/
tree/main/modules/cve_2022_20828
Exploitation
-
Authenticated command injection over 
HTTP or SSH to establish a root shell 
within FirePOWER module VM.
CVE-2022-20828
-
Disclosed to vendor in March 2022
-
Some versions patched in June 2022
-
All patched by December 2022
Remotely Rooting the ASA-X FirePOWER Module
CVE-2022-20828 Metasploit Module
54
Getting Root With an ASA-X 
FirePOWER Boot Image
55
Getting Root With an ASA-X FirePOWER Boot Image 
FirePOWER Module Not Installed, What Do?
56
Getting Root With an ASA-X FirePOWER Boot Image 
Get a Root Shell Using a FirePOWER Boot Image
57
1
2
ASA 5506-X with FirePOWER Services 6.2.3  Software Download
Getting Root With an ASA-X FirePOWER Boot Image 
FirePOWER Module Installation
58
Install and Conﬁgure a FirePOWER Services Module on an ASA Platform
Getting Root With an ASA-X FirePOWER Boot Image 
Install the FirePOWER Boot Image via Cisco CLI
59
Install and Conﬁgure a FirePOWER Services Module on an ASA Platform
Getting Root With an ASA-X FirePOWER Boot Image 
Drop to the FirePOWER Boot Image Shell
60
Getting Root With an ASA-X FirePOWER Boot Image 
FirePOWER Boot Image Shell
61
cisco123
Getting Root With an ASA-X FirePOWER Boot Image 
Boot Image Root Shell via Hard-Coded Creds
62
Getting Root With an ASA-X FirePOWER Boot Image 
We’re Back!
63
Exploitation
-
Exploit hard-coded credential establish root 
shell on ASA-X with FirePOWER Services.
Not a vulnerability
-
Disclosed to vendor in March 2022
-
Vendor states this is not a vulnerability
-
Fixed in Boot Image 7.0+
-
Unpatchable? No mechanism to stop loading 
of old boot images.
Exploits
-
Python script
-
SSH Metasploit module
github.com/jbaines-r7/cisco_asa_research/
tree/main/modules/boot_image_shell
github.com/jbaines-r7/slowcheetah
Getting Root With an ASA-X FirePOWER Boot Image 
Metasploit FirePOWER Boot Image Root Shell Module
64
Distributable Malicious 
FirePOWER Boot Image for ASA-X
65
Distributable Malicious FirePOWER Boot Image for ASA-X
Hacker Cat Has No Access!
66
Distributable Malicious FirePOWER Boot Image for ASA-X
FirePOWER Boot Image Is… A Generic Bootable Linux ISO
67
Distributable Malicious FirePOWER Boot Image for ASA-X
Distribute a Malicious ISO / Boot Image?
68
Exploitation
-
Create a Tiny Core Linux Bootable ISO
-
Get Administrator to install it
-
Sends a reverse shell to conﬁgured IP:port
Not a vulnerability
-
No security expectations for the boot image.
-
Doesn’t persist through reboots.
Features
-
Reverse Shell
-
SSH
-
DOOM-ASCII
github.com/jbaines-r7/pinchme
Distributable Malicious FirePOWER Boot Image for ASA-X
Pinch Me: Malicious Boot Image Creator
69
Distributable Malicious FirePOWER Boot Image for ASA-X
Proﬁt
70
Distributable Malicious 
FirePOWER Install Package for 
ASA-X
71
1
2
Distributable Malicious FirePOWER Install Package for ASA-X
ASA-X FirePOWER Module Install Package
72
Distributable Malicious FirePOWER Install Package for ASA-X
FirePOWER Boot Image Supports Signed Install Packages
73
Distributable Malicious FirePOWER Install Package for ASA-X
FirePOWER Module Signed Install Package
74
Distributable Malicious FirePOWER Install Package for ASA-X
FirePOWER Boot Image Supports Unsigned Install Packages
75
Distributable Malicious FirePOWER Install Package for ASA-X
Distribute a Malicious Install Package?
76
Distributable Malicious FirePOWER Install Package for ASA-X
FirePOWER Module Unsigned Install Package
77
Distributable Malicious FirePOWER Install Package for ASA-X
Convert a Secure Package to an Insecure Package
78
Exploitation
-
Input valid and signed Cisco created 
package. Output valid unsigned package 
containing malicious code.
-
Persistent payload. Survive reboots and 
upgrades.
Not a vulnerability
-
No security expectations on installation.
github.com/jbaines-r7/whatsup
Distributable Malicious FirePOWER Install Package for ASA-X
Create Malicious Install Packages
79
Exploitation
-
Input valid and signed Cisco created 
package. Output valid unsigned package 
containing malicious code.
-
Persistent payload. Survive reboots and 
upgrades.
Not a vulnerability
-
No security expectations on installation.
github.com/jbaines-r7/whatsup
Distributable Malicious FirePOWER Install Package for ASA-X
Create Malicious Install Packages
80
Distributable Malicious FirePOWER Install Package for ASA-X
Back Again!
81
Distributable Malicious FirePOWER Install Package for ASA-X
…Not a Supply Chain Issue?
82
Exploitation Summary
Do Not Trust the ASA?
This Talk Discussed
-
Man in the middle problems
-
Credential leaks
-
Code signing issues
-
Package signing issues
-
Root shell as a feature
-
Hard-coded credentials for a root shell
-
Remote command injection for root access
-
Executing arbitrary bootable ISO
83
Indicators and Mitigations
84
Indicators and Mitigations
Not This. Never This.
85
github.com/jbaines-r7/cisco_asa_research/blob/main/yara/
Indicators and Mitigations
YARA Rules
New YARA Rules
-
Detect malicious ASDM packages
-
Detect execution of malicious SGZ
-
Detect credentials in ASDM log ﬁles
-
Detect unsigned FirePOWER install packages
86
●
Eventually?
○
No patches planned for ASA-X with FirePOWER 
Services boot images or installation packages
○
CVE-2021-1585 still unpatched
○
CVE-2022-20829 still unpatched (maybe?)
○
CVE-2022-20828 patches planned through 
December 2022
●
What to do when patches aren’t available?
○
Mitigating controls: limit access and isolate
○
If possible, remove from network critical path
○
Rotate passwords
●
What to do about the ASA-X with FirePOWER Services?
○
Multiple distributable root shell vectors
○
Virtual machine root shell is a default feature
○
If possible, accelerate retirement and replace
○
Audit the virtual machine root shell regularly
○
Audit Cisco CLI / ASDM logins regularly
Indicators and Mitigations
Apply ASA and ASDM Patches?
87
Thank you!
Slides & Code: 
https://github.com/jbaines-r7/cisco_asa_research
@jbaines-r7
@Junior_Baines
@jbaines-r7