和特殊字符（如下划线或短划线）。
2. 默认情况下，密码长度至少为 7 个字符，且小于 40 个字符。
3. 密码不得包含字典单词或部分字典单词。
注：密码开头的大写字母不算入使用的字符类别数。密码结尾的数字不算入使用的字符类别数。密码内使用
的字典词可降低整体密码强度。
加固方法
1. 登录 web 端 ESXI 管理平台。
2. 点击左边的 “管理”。
3. 点击 “高级”，在搜索框中搜索”pass”，找出密码配置相关项。
1. 点击 Security.PasswordQualityControl ，并点击编辑选项，编辑它的值来配置相关的密码策略。
5.vSphere 加固
121
5.4.2 细化密码策略
密码长度小，容易受到暴力破解的攻击，并且破解的成功率极高。为了账户的安全性，很多系统都要求密码
至少为一定长度的位数，用以延长暴力破解成功的时间。但是，为了满足客户的自定义需求，一些系统是支持自
定义密码长度的，这就有可能导致用户设置位数较小的密码，给账户的安全性带来了极大的安全隐患。
加固建议
设置密码的长度至少为 7 位。
加固方法
ESXi 中设置密码的长度：
1. 登录 ESXi 系统。
2. 点击 “管理 -> 系统 -> 高级设置”。
3. 在右边 搜索框中 搜索 “pass” ，找到 结果 “Security.PasswordQualityControl”，并选中。
编辑选项，修改对应的值即可。
vCenter中设置密码的长度：
1. 登录 vCenter 来到系统主页，点击左边的 “系统管理”。
2. 点击 Single Sign On 下的 “配置”。
ITDR 之 vSphere
122
点击 “策略 -> 密码策略 -> 编辑”，即可设置密码的最小长度。
将密码的最小长度设置为 7
5.4.3 定期修改vpxuser密码
将 ESXI 主机添加到 vCenter Server 清单中时，vCenter Server 会在该主机上创建称为 vpxuser 的特殊用户
帐户。vpxuser 是特权帐户，管理主机的活动时，vCenter Server 使用 vpxuser 特权。
默认情况下，vCenter Server 使用 OpenSSL 密码库作为随机来源，每 30 天生成一个新的 vpxuser 密码。
密码长度为 32 个字符，且必须至少包含一个属于以下四个字符类别的符号：符号 (-./:=@[\\]^_{}~)、数字 (1-9)、
大写字母和小写字母。
5.vSphere 加固
123
加固建议
确保 vpxuser 密码定期过期在一定程度上能够限制攻击者的攻击。
注意：
1. 为了防止出现 vCenter Server 被锁在 ESXi 主机外的可能性，密码时效策略限定的时间不得短于设置为自
动更改 vpxuser 密码的时间间隔。
2. 不能使用 Active Directory 管理 vpxuser。
3. 不要以任何方式更改 vpxuser。不要更改其密码。不要更改其权限。如果进行了更改，在通过 vCenter 
Server 处理主机时可能会出现问题。
加固方法
1. 使用 vSphere Client 登录到 vCenter Server 系统。
2. 在对象层次结构中选择 vCenter Server 系统。
点击主机和集群
单击配置。
单击高级设置，然后单击编辑设置。
单击筛选器图标，然后输入 VimPasswordExpirationInDays。
ITDR 之 vSphere
124
根据您的要求设置 VirtualCenter.VimPasswordExpirationInDays。
5.4.4 细化密码复杂度
为了防止账号被攻击者轻易破解或账号被恶意利用，一般，各大网络平台或者产品都会要求设置相对
复杂的密码。然而，这样的要求也不是不可改变的，随着用户对密码策略进行了自定义设置，那么密码的
复杂度也会随之而更改。对于 ESXi 和 vCenter 的默认复杂度不算低，至少都包含了 7 个字符 ( 包括数字、
字母区分大小写、特殊字符组成 )。但是，如果用户自己修改密码策略，将密码复杂度调低，这样就可以
设置弱密码，造成密码复杂度异常现象。为了账户的安全性，建议通过修改 ESXi 和 vCenter 的密码策略，
调高密码复杂度。
加固建议
ESXi 
密 码 限 制 由 Linux PAM 
模 块 pam_passwdqc 
确 定。 可 以 使 用 Security.
PasswordQualityControl 高级系统设置更改所需长度和字符类别要求或允许密码短语。还可以使用 
Security.PasswordHistory 高级系统设置来设置要为每个用户记住的密码数。ESXi 对从直接控制台用户
界面、ESXi Shell、SSH 或 VMware Host Client 进行的访问强制执行密码要求。
1. 默认情况下，在创建密码时，必须至少包括以下四类字符中三类字符的组合：小写字母、大写字母、
数字和特殊字符（如下划线或短划线）。
2. 默认情况下，密码长度至少为 7 个字符，且小于 40 个字符。
3. 密码不得包含字典单词或部分字典单词。
4. 密码不得包含用户名或部分用户名。
5.vSphere 加固
125
vCenter Single Sign-On 管理员（默认为 PI:EMAIL）的密码由 vCenter Single Sign-
On 密码策略指定。默认情况下，它的密码设置要求为：
1. 至少八个字符。
2. 至少一个小写字符。
3. 至少一个数字字符。
4. 至少一个特殊字符。
加固方法
设置ESXi密码复杂度
1. 登录 ESXi，点击 “管理 -> 高级设置”。
2. 在右边搜索框中搜索 “pass”，可匹配出和密码设置相关的控制字符。
3. 选中 Security.PasswordQualityControl ，再点击编辑选项，可修改密码复杂度。
设置vCenter密码复杂度
1. 登录 vCenter。
2. 点击左边的 “系统管理”。
3. 点击 左边 “配置”。
点击右边 “编辑” 即可设置密码复杂度。
ITDR 之 vSphere
126
5.4.5 优化无用或长时间非活跃的账户
由于临时的需要创建的账户，使用完之后没有及时地删除，那么这类账户自然就属于无用的账户。另一类账
户，就是为某个人专门创建的账户，由于他没有登录系统的需求或者是登录较少，那么就造成了他的账户长时间
不活跃。如果系统中存在无用或长时间不活跃的账户，这是会给系统带来安全风险的，比如攻击者拿到账号的权
限，他就可以把这种账号作为后门，继续对系统进行长期渗透与控制。因此，对于无用的或长时间不活跃的账户，
值得去关注及加固。
加固建议
1. 定期检查系统的账户，梳理出哪些是无用的账户，哪些是非活跃账户。
2. 对于无用的账户，应该及时删除。
3. 对于非活跃账户，及时禁用这类账户，如果有需要，再次启用。
5.4.6 优化无用或长时间非活跃的管理员账户
由于临时的需要创建的账户，使用完之后没有及时地删除，那么这类账户自然就属于无用的账户。另一类账户，
就是为某个人专门创建的账户，由于他没有登录系统的需求或者是登录较少，那么就造成了他的账户长时间不活
跃。如果系统中存在无用或长时间不活跃的账户并且它们都具有管理员权限，那么这些账号一旦被攻击者控制，
带来的风险将是巨大的，相当于直接拥有整个系统的控制权。
加固建议
1. 定期检查系统的账户，梳理出哪些是无用的管理员账户，哪些是非活跃的管理员账户。
2. 对于无用的管理员账户，应该及时删除。
3. 对于非活跃的管理员账户，及时禁用，如果有需要，再次启用。
5.4.7 优化密码过期时间异常用户
一般地，为了保证账户的安全性，很多系统都会有一个合适的密码过期机制，这样就有效地避免了因为长时
5.vSphere 加固
127
间使用同一个密码造成密码泄露，也就在一定程度上增强了密码的安全性。尽管如此，基于便捷，很多人还是趋
向于将密码设置为永不过期，这就导致存在永不过期的账户。
加固建议
1. 定期排查账户，看哪些账户密码过期时间异常。
2. 针对异常用户，设置合理的密码有效期。
3. 登录 ESXi 和 vCenter 将设置全局密码策略，将密码过期时间设置为 90 天。
操作演示
ESXi设置密码过期策略：
登录 ESXi -> 主界面 -> 管理 -> 高级设置 -> 搜索 “pass”，找到 Security.PasswordMaxDays -> 编辑选项
vCenter设置密码过期策略：
登录 vCenter -> 主界面 -> 系统管理 -> Single sign On -> 配置 -> 策略 -> 密码策略 -> 编辑
5.4.8 特权账号密码没有定期修改
特权账号一般具有特定的用途或者具有高的权限，如果特权账号泄露，被攻击者恶意利用，造成的影响也是
非常大的，比如删除，修改，新增虚拟机等。
ITDR 之 vSphere
128
ESXi主机特权账号
如果环境不包含 vCenter Server 系统，则会预定义账户 root、vpxuser、dcui，这些账户是具有不同用途的
特权账户。
✓ root 账户：默认情况下，每个 ESXi 主机都有一个具有管理员角色的 root 用户帐户。该 root 用户帐户可
用于本地管理，并可用于将主机连接到 vCenter Server。
✓ vpxuser 账户：管理主机的活动时，vCenter Server 使用 vpxuser 特权。
✓ dcui 账户：dcui 用户以管理员权限在主机上操作。此用户的主要目的是从直接控制台用户界面 (DCUI) 
配置锁定模式的主机。此用户将充当直接控制台的代理，无法由交互式用户来修改或使用。
vCenter特权账号
✓ 特权：特权是精细的访问控制。可以将这些特权分组到角色中，然后可以将其映射到用户或组。
✓ 角色：角色是指一组特权。
✓ 用户和组：在 vCenter Server 系统中，可以仅向经过身份验证的用户或经过身份验证的用户组分配特权。
✓ 权限：vCenter Server 对象层次结构中的每个对象都具有关联的权限。每个权限为一个组或用户指定该
组或用户具有对象的哪些特权。
加固建议
针对 ESXi 主机
定期修改 root、vpxuser 的密码，并且设置一定复杂度的密码
针对 vCenter
1. 定期梳理出账号具有哪些特权。
2. 根据权限最小化原则，取消账号不必要的特权。
3. 定期修改这些特权账号的密码。
5.vSphere 加固
129
结语
06
ITDR 之 vSphere
130
6. 结语
如今 IT 架构的变革，企业云上业务的大规模普及，完善、稳定、易用的
vSphere 方案成为企业自建云的一个首选方案，而攻击者针对 vSphere 的攻击层
出不穷，在可预见的未来，攻击将变得更加深入且复杂，而其唯一不变的核心目标
则是获取管理员的身份权限，对于此类威胁的防御，我们面临着与过去截然不同的
挑战，基于身份行为的隐匿攻击将成为我们发现未知威胁的一个重要目标。而在未
来，ITDR 将深入企业的安全防护体系，从身份视角深度保护 vSphere。
本书从身份攻防的视角分析了 vSphere 的各攻击面，并对于 vSphere 的加固
提出了针对性的参考建议，旨在通过深入了解攻击者行为的前提下，进一步加强
vSphere 的安全建设。
当您开始意识到 vSphere 正在面临网络攻击威胁并尝试对其进行监测、防御时，
您可能会注意到 ITDR 的存在，以及其在 vSphere 身份威胁检测方面发挥的作用。
那么本书将为您提供一个心智模型，说明您应该如何思考推动 vSphere 的风险管理
工作。这当然不仅仅是 CISO 或某个 领导的工作——您应该利用这些知识并在你的
团队中传播它。考虑组建一个 “Identity security team”，专注于规划您的 ITDR
建设章程在未来 30 天、6 个月和几年内将如何发展。
6. 结语
131
ITDR 之 vSphere
132