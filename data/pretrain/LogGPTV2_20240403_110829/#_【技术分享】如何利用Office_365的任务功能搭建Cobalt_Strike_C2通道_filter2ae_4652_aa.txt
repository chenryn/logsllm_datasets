# 【技术分享】如何利用Office 365的任务功能搭建Cobalt Strike C2通道

## 译文声明
本文为翻译文章，原文来源：安全客。具体内容及含义以原文为准。
- 译者：[兴趣使然的小胃](http://bobao.360.cn/member/contribute?uid=2819002922)
- 预估稿费：200RMB
- 投稿方式：发送邮件至linwei#360.cn，或登录网页版在线投稿

## 一、前言
在定制化和创新化的命令与控制（C2, Command and Control）通道方面，已经有许多研究成果。然而，这些成果通常仅停留在理论层面，并未集成到现有的攻击工具包中。最近，Cobalt Strike引入了一个新的扩展功能“External C2”，该功能可以在保持工具兼容性的同时创建隐蔽的C2通道。

为了最大化挖掘“External C2”的潜力，MWR团队开发了一个使用Office 365作为通信媒介的定制C2通道。本文将介绍以下内容：
1. 利用Office 365服务中的Outlook“任务”功能，演示如何搭建Cobalt Strike的C2通道。
2. 分析在定制Cobalt Strike C2通道时可能遇到的一些挑战，并提出解决方案。

## 二、External C2接口
Cobalt Strike是一个广泛应用于目标操作场景的渗透测试平台，用于模拟特定威胁源。它包括许多关键功能，如beacon植入体和“可扩展C2”通道。通过“可扩展C2”功能，用户可以自定义C2请求和响应消息的具体结构，从而设计出隐藏在正常流量中的弹性化C2通道。尽管“可扩展C2”提供了丰富的自定义选项，但仍存在一些限制：
1. 该功能仅支持某些协议，即HTTP/HTTPS和DNS。
2. 与外部服务进行通信具有一定的难度，且成功率较低。
3. 对于HTTP/HTTPS，该功能仅限于客户端-服务器应用场景，其中客户端（植入体）向服务器（Cobalt Strike团队服务器）发起请求并接收响应。

Cobalt Strike的创始人Raphael Mudge最近发布了一个概念验证功能扩展，称为“External C2”接口。此接口允许使用任意C2通道。通过与传统的Cobalt Strike使用方法对比，我们可以更好地理解其工作原理。在HTTP/HTTPS场景中，植入体会直接或通过重定向器与团队服务器通信。典型的使用场景如下图所示。

“External C2”支持在传统Cobalt Strike C2模型中使用中间人技术。在这种情况下，客户端代码包含一个第三方客户端和一个SMB植入体。第三方客户端负责生成SMB植入体并通过命名管道与其通信。通过命名管道接收到流量后，第三方客户端可以将其重新封装并通过任意C2通道传输。服务端则需要搭建一个第三方控制端，以接收并解封装C2流量，并通过简单的TCP套接字将其转发给团队服务器。Cobalt Strike通过“aggressor script”启动“External C2”接口，团队服务器通过该接口监听数据。“External C2”接口可以在任意端口上监听，类似于现有的“监听器”功能。通信数据的回连路径与发送路径相同。

Raphael Mudge实现的“External C2”接口包含aggressor script和一个简单的第三方客户端。第三方客户端与控制端之间使用基本的TCP套接字进行通信。尽管Raphael Mudge没有实现任何第三方控制端，但在测试环境中，可以通过TCP端口转发来模拟其功能。

## 三、与Office 365同步“任务”
“External C2”接口允许选择各种类型的C2通道。本文提供了一个使用C++语言编写的PoC代码，实现了“External C2”的第三方客户端和控制端组件，并利用Office 365服务中的Outlook“任务”功能构建C2通道。随着越来越多的组织采用Office 365服务，这种方式构建的C2通道更加隐蔽，难以与合法流量区分开来。

### 3.1 与Office 365交互
Office 365中的Outlook由Microsoft Exchange提供支持，这并不罕见。令人惊讶的是，我们还可以通过Office 365使用Exchange内部实例所支持的许多功能。

Exchange提供了一个重要但不太为人知的功能，即 **Exchange Web Services (EWS)**。EWS是一个SOAP Web服务，客户端可以通过该服务与Exchange进行交互。EWS默认处于启用状态，地址为：“**https://<your-domain>/EWS/**”。我们发现Office 365确实提供了EWS服务，具体地址为：“**https://outlook.office365.com/EWS/**”。

许多客户端应用程序使用EWS服务，例如桌面版Outlook中的“加载项”功能。虽然Outlook本身通过MAPI/RPC与Exchange进行交互，无需依赖EWS，但EWS支持MAPI/RPC提供的大部分功能，只有少数例外（例如，EWS无法创建某些“有风险”的Outlook规则，如“启动应用程序”规则）。

EWS支持各种功能，如创建、修改和删除邮件、日历、联系人、任务等。这些操作会同步到Exchange上，因此也可以用作C2媒介。出于演示目的，本文的PoC选择了“任务”功能。与电子邮件一样，每个任务项目都可以包含大量数据。选择任务功能的原因是现有安全控制机制主要针对电子邮件（如自动扫描邮件中的恶意软件），因此任务功能成为更为隐蔽和安全的媒介。