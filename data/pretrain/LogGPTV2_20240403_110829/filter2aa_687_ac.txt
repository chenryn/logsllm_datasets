!}!
!}!
...!
}!
Sample bug 2;
•  panic()!driven!by!ﬁlesystem!data!!
•  FreeBSD!11!!
•  Been!there!since!FreeBSD!8.1!Thu$Jan$14$14:30:54$2010!
•  Ext2!ﬁle!system!code!!
Networking (bt, wiﬁ, 
irda) ;
Wiﬁ AFack surface entrypoint;
•  Stack!itself!!
•  802.11!network!data!!
•  Parsing!!
•  Info!leaks!
•  Wiﬁ!drivers!
•  Data!send!by!device!to!host!!!
802.11  stack;
•  One!802.11!stack!for!all!wiﬁ!drivers!!
•  Much!easier!to!maintain!
•  Need!to!ﬁx!in!only!1!place!if!bugs!are!found!!
•  ieee80211_input()!is!main!parsing!input!!
•  Called!from!all!wiﬁ!drivers!!
ieee80211_eapol_key_input(struct!ieee80211com!*ic,!struct!mbuf!*m,!
!!!!struct!ieee80211_node!*ni)!
{!
!struct!ifnet!*ifp!=!&ic->ic_if;!
!struct!ether_header!*eh;!
!struct!ieee80211_eapol_key!*key;!
...!
!eh!=!mtod(m,!struct!ether_header!*);!
...!
!if!(m->m_len!m_pkthdr.len!len))!ß!assume!key->len!is!larger!than!key->payload!!
!
!goto!done;!
!
!/*!check!key!data!length!*/!
!totlen!=!sizeof(*key)!+!BE_READ_2(key->paylen);!!ß!assume!key->len!is!larger!than!key->payload!!
!if!(m->m_pkthdr.len!!MCLBYTES)!
!
!goto!done;!
...!
!/*!make!sure!the!key!data!ﬁeld!is!con4guous!*/!
!if!(m->m_len!len!is!larger!than!key->payload!!
…!
!}!
!key!=!mtod(m,!struct!ieee80211_eapol_key!*);!
...!
!
!
!
!ieee80211_recv_4way_msg3(ic,!key,!ni);!ß!can!crash!in!here!if!not!enough!data!is!pulled!up.!
...!
}!
802.11 Stack sample bug;
•  mbuf!mishandling,!leading!to!crash!!!!
•  Doesn’t!guarantee!it!pulls!up!enough!mbuf!data!!
•  OpenBSD!6.1!
•  Bug!has!been!there!for!almost!9!years!!
•  Parsing!EAPOL!frames!
802.11 Drivers;
•  Wiﬁ!drivers!are!either!PCI!or!USB!
•  Do!you!trust!the!radio?!!
•  What!if!it!does!get!compromised?!!
!
•  Assume!PCI!cards!cause!total!compromise!(they!can!do!DMA)!!
•  Well,!actually,!with!IOMMU!that’s!no!longer!the!case!…!!
!
•  USB!is!packet!based!protocol!!
•  Host!USB!parsers!should!be!able!to!parse!safely!!
•  Currently!BSD!wiﬁ!drivers!do!not!do!this!!
•  Leads!to!trivial!heap!smashes!!
void!
run_rx_frame(struct!run_soÑc!*sc,!uint8_t!*buf,!int!dmalen)!
{!
...!
!struct!rt2860_rxwi!*rxwi;!
...!
!uint16_t!len;!
...!
!rxwi!=!(struct!rt2860_rxwi!*)buf;!
...!
!len!=!letoh16(rxwi->len)!&!0xﬀf;!ß!can!be!at!most!4095!
...!
!/*!could!use!m_devget!but!net80211!wants!con4g!mgmt!frames!*/!
!MGETHDR(m,!M_DONTWAIT,!MT_DATA);!
!if!(__predict_false(m!==!NULL))!{!
!
!ifp->if_ierrors++;!
!
!return;!
!}!
!if!(len!>!MHLEN)!{!m_ﬂags!&!M_EXT)))!{!
!
!
!ifp->if_ierrors++;!
!
!
!m_freem(m);!
!
!
!return;!
!
!}!
!}!
...!
!/*!ﬁnalize!mbuf!*/!
!memcpy(mtod(m,!caddr_t),!wh,!len);!ß!memory!corrup4on!!
!m->m_pkthdr.len!=!m->m_len!=!len;!
...!
}!
/*!
!*!A!frame!has!been!uploaded:!pass!the!resul4ng!mbuf!chain!up!to!
!*!the!higher!level!protocols.!
!*/!
void!
atu_rxeof(struct!usbd_xfer!*xfer,!void!*priv,!usbd_status!status)!
{!
...!
!h!=!(struct!atu_rx_hdr!*)c->atu_buf;!
!len!=!UGETW(h->length)!-!4;!/*!XXX!magic!number!*/!!ß!integer!underﬂow!!
!
!m!=!c->atu_mbuf;!
!memcpy(mtod(m,!char!*),!c->atu_buf!+!ATU_RX_HDRLEN,!len);!ß!need!to!validate!len!before!copy.!can!cause!memory!corrup4on!!
...!
!usbd_setup_xfer(c->atu_xfer,!sc->atu_ep[ATU_ENDPT_RX],!c,!c->atu_buf,!
!!!!!ATU_RX_BUFSZ,!USBD_SHORT_XFER_OK!|!USBD_NO_COPY,!USBD_NO_TIMEOUT,!
!
!atu_rxeof);!
!usbd_transfer(c->atu_xfer);!
}!
void!
otus_sub_rxeof(struct!otus_soÑc!*sc,!uint8_t!*buf,!int!len)!ß!len!comes!from!usb.!can!be!~8k!!
{!
...!
!uint8_t!*plcp;!
...!
!plcp!=!buf;!
...!
!mlen!=!len!-!AR_PLCP_HDR_LEN!-!sizeof!(*tail);!
...!
!mlen!-=!IEEE80211_CRC_LEN;!/*!strip!802.11!FCS!*/!
!
!wh!=!(struct!ieee80211_frame!*)(plcp!+!AR_PLCP_HDR_LEN);!
...!
!MGETHDR(m,!M_DONTWAIT,!MT_DATA);!
!if!(__predict_false(m!==!NULL))!{!
!
!ifp->if_ierrors++;!
!
!return;!
!}!
!if!(align!+!mlen!>!MHLEN)!{!
!
!MCLGET(m,!M_DONTWAIT);!ß!allocates!a!cluster,!which!is!2048!bytes!long!
!
!if!(__predict_false(!(m->m_ﬂags!&!M_EXT)))!{!
!
!
!ifp->if_ierrors++;!
!
!
!m_freem(m);!
!
!
!return;!
!
!}!
!}!
!/*!Finalize!mbuf.!*/!
!m->m_data!+=!align;!
!memcpy(mtod(m,!caddr_t),!wh,!mlen);!ß!mlen!can!be!~8k.!can!cause!memory!corrup4on.!
...!
}!
void!
rsu_event_survey(struct!rsu_soÑc!*sc,!uint8_t!*buf,!int!len)!
{!
...!
!struct!ndis_wlan_bssid_ex!*bss;!
!struct!mbuf!*m;!
!int!pktlen;!
...!
!bss!=!(struct!ndis_wlan_bssid_ex!*)buf;!
...!
!if!(__predict_false(len!ieslen)))!!ß!could!int!overﬂow!!
!
!return;!
...!
!/*!Build!a!fake!beacon!frame!to!let!net80211!do!all!the!parsing.!*/!
!pktlen!=!sizeof(*wh)!+!letoh32(bss->ieslen);!ß!could!int!overﬂow!!
!if!(__predict_false(pktlen!>!MCLBYTES))!ß!signedness!issue!!
!
!return;!
!MGETHDR(m,!M_DONTWAIT,!MT_DATA);!
!if!(__predict_false(m!==!NULL))!
!
!return;!
!if!(pktlen!>!MHLEN)!{!
!
!MCLGET(m,!M_DONTWAIT);!
!
!if!(!(m->m_ﬂags!&!M_EXT))!{!
!
!
!m_free(m);!
!
!
!return;!
!
!}!
!}!
!wh!=!mtod(m,!struct!ieee80211_frame!*);!
...!
!memcpy(&wh[1],!(uint8_t!*)&bss[1],!letoh32(bss->ieslen));!ß!memory!corrup4on!!
...!
}!
802.11 drivers sample bug;
•  Wide!open!aJack!surface!
•  Atmel!AT76C50x!IEEE!802.11b!wireless!network!device![atu(4)]!
•  Atheros!USB!IEEE!802.11a/b/g/n!wireless!network!device![otus(4)]!
•  Realtek!RTL8188SU/RTL8192SU!USB!IEEE!802.11b/g/n!wireless!network!device![rsu(4)]!
•  Ralink!Technology/MediaTek!USB!IEEE!802.11a/b/g/n!wireless!network!device![run(4)]!
•  Atheros!USB!IEEE!802.11a/b/g!wireless!network!device![uath(4)]!
•  Across!all!BSDs!
•  They!didn’t!think!about!the!aJack!surface!on!this!one!!
!
miscellaneous;
•  NULL!derefs!!
•  malloc(len,!type,!M_NOWAIT/M_CANFAIL)!
•  Not!checking!return!value!!
•  Rela4vely!frequent!bug!!
•  M_WAITOK!(==!can!never!fail)!is!a!very!common!case!
•  Developers!trea4ng!M_NOWAIT/M_CANFAIL!code!as!if!it!was!M_WAITOK!
•  DRM/DRI!
•  DRM/DRI!code!base!is!part!of!linux!kernel!source!tree.!
•  BSD!folks!fork!it!
•  Code!quality!is!about!as!big!a!shit!sandwich!as!it!is!in!linux!DRM/DRI!code!base!
!!
!
“ All this linux code that we are importing ... is not going to be 
reviewed by any of the other OpenBSD kernel developers ... 
because they refuse to read any code that is not conformant to 
the BSD KNF standard” – Matthieu Herrb 
Results;
•  results:!!
•  About!~115!kernel!bugs!so!far!!
•  FBSD:!~30!
•  OBSD:!~25!
•  NBSD:!~60!
!!
•  types!of!bugs!seen:!!
•  Straight!heap/stack!smash!
•  race!condi4ons!!
•  expired!pointers!!
•  Double!frees!
•  recursion!issues!
•  integer!issues!!
•  Underﬂows,!overﬂows,!signedness!
•  Refcount!issues!!
•  Overﬂows!!
•  Reference!dropped!too!soon!à!use!aÑer!free!
•  info!leaks!!
•  out!of!bound!read!
•  NULL!deref!
•  Logic!bugs!
•  typo!
•  Division!by!zero!
•  kernel!panics!driven!by!userland!!
•  Memory!leaks!
Conclusions;
•  Bugs!were!found!in!all!3!of!the!examined!BSDs!!
•  Among!all!of!the!aJack!surfaces!men4oned!above!!
•  Winner!/!loser!!
•  OBSD!clear!winner!(they!have!massively!reduced!their!aJack!surface!over!the!years):!
•  AJack!surface!reduc4on!!
• 
no!loadable!modules!
• 
rela4vely!few!devices!
• 
Virtually!no!compat!code!(they!removed!Linux!!a!couple!of!years!ago)!
• 
removed!en4re!Bluetooth!stack!!
• 
Signiﬁcantly!less!syscalls!(e.g.!200+!syscalls!less!than!FBSD)!
• 
Cut!support!for!some!older!architectures!
•  Code!Quality!
• 
int!overﬂows!/!signedness!bugs,!as!good!as!gone!in!most!places!
• 
Few!info!leaks!!
•  NBSD!clear!loser!
•  Tons!of!legacy!and!compat!code!(who!the!hell!s4ll!needs!the!ISO!protocols!???!Really?)!!
•  seems!to!be!less!consistent!with!security!code!quality!
•  Too!many!signedness!bugs.!!
•  This!is!NOT$a!dis.!!
• 
if!you!think!building/maintaining/improving!and!OS!is!easy,!go!ahead,!try!it.!See!how!far!you!get.!!!
•  FBSD!is!somewhere!in!between!!
Conclusions;
•  Security!team!responses!!
!
•  OpenBSD!
• 
About!a!week!or!so!to!get!response!(Theo!said!it!took!so!long!because!he!was!on!vaca4on)!!
• 
Bugﬁxes!rolled!out!in!the!next!couple!of!days!!
!
•  FreeBSD!
• 
Response!in!about!a!week!or!so!!
• 
The!ﬁled!bugs!internally!!
• 
Don’t!know!what!the!status!of!those!bugs!is!
•  NetBSD!
• 
They!ﬁxed!virtually!all!bugs!submiJed.!PreJy!much!overnight$!!!$
• 
That!is!ridiculously!impressive.!!
• 
They!also!turned!oﬀ!the!SVR4!subsystem!for!i386!by!default!!
“We have also disabled COMPAT_SVR4 by default on i386, something that 
should have been done a long time ago.” – Response from NetBSD developers 
More conclusions ;
•  Bugs!are!s4ll!easy!to!ﬁnd!in!those!kernels.!Even!OpenBSD.!
•  Varying!level!of!quality!depending!on!age!and!who!wrote!it!!
•  Most!consistent!quality!was!observed!with!OpenBSD!!
•  The!maintainers!of!various!BSDs!should!talk!more!among!each!other!!
•  Several!bugs!in!one!were!ﬁxed!in!the!other!!
•  OpenBSD!expired!proc!pointer!in!midiioctl()!ﬁxed!in!NetBSD!!
•  NetBSD!signedness!bug!in!ac97_query_devinfo()!ﬁxed!in!OpenBSD!!
More conclusions ;
•  Code!base!size!
•  OpenBSD:!2863505!loc!
•  NetBSD:!!!!7330629!loc!
•  FreeBSD:!!!8997603!loc!!
!
•  Obviously!this!plays!a!part!!
•  Can’t!have!a!bug!in!code!you!don’t!have!!
•  Accidental!vs.!planned!!
•  Haven’t!goJen!to!implemen4ng!something!yet!or!…!
•  Choice!made!on!purpose!to!delete!code!!
•  AJack!surface!reduc4on!
More conclusions ;
•  Many!eyeballs!…!
•  Gut!feeling,!I!suspect!this!is!a!factor.!!!
•  Based!on!my!result,!code!quality!alone!can’t!account!for!the!discrepancy!
between!the!bug!numbers!(BSD!vs.!Linux).!!
•  Say!what!you!will!about!the!people!reviewing!the!Linux!kernel!code,!there!are!
simply!orders!of!magnitude!more!of!them.!And!it!shows!in!the!numbers.!!
Ques9ons / comments from the internet;
•  Defcon!releases!presenta4on!before!you!actually!perform!the!presenta4on!!
•  This!is!kindof!annoying….!
•  People!saw!it,!and!commented!on!it!before!I!had!a!chance!to!stand!up!here!…!!
•  Surprisingly!liJle!hate!/!trolls!(yet?)!!
•  Got!some!from!the!OS!zealots!
•  Why!didn’t!you!do!the!same!for!linux?!!
•  The!numbers!presented!earlier!speak!for!themselves!IMO.!Assumed!them!(and!what!they!imply)!to!be!accurate!!
•  You!conclude!that!linux!is!beJer!!And!its!not!even!the!subject!of!the!presenta4on!!
•  I!did!not.!!
•  You!should’ve!added!a!comparison!of!protec4on!mechanisms!between!linux!and!the!BSDs!
•  While!that!would!be!interes4ng,!its!far!outside!of!the!scope.!Doesn’t!relate!to!code!quality.!Also!4me!constraints.!
•  What!about!dragonﬂyBSD?!HardenedBSD?!
•  I!Considered!it.!Maybe!I!should!have!too.!I!had!limited!amount!of!4me!and!picked!the!3!most!commonly!used!BSDs!
Ques9ons / comments from the internet;
•  Interes4ng!related!links!I!got!from!the!internet!!
•  How$to$ﬁnd$56$potenOal$vulnerabiliOes$in$FreeBSD$code$in$one$evening,!PVS-Studio$
delved$into$the$FreeBSD$kernel$
•  hJps://www.viva64.com/en/b/0496/!!
•  hJps://www.viva64.com/en/b/0377/!!
•  hJps://www.viva64.com/en/b/0487/!
•  FreeBSD!–!A!lesson!in!poor!defaults!!
•  hJps://vez.mrsk.me/freebsd-defaults.txt!!
Ques9ons ?;