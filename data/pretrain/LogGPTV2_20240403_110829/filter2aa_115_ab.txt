void speak(Animal a) {
a.talk();
}
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œwoofâ€ ğŸ¶
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œwoofâ€ ğŸ¶
One single function call?? 
BPU
ğŸ§â‰
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œwoofâ€ ğŸ¶
One single function call?? 
Prediction depends on the context
BPU
ğŸ§â‰
19
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
context
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
context
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
context
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
context
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
BPU
â€œmeowâ€ ğŸ±
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
20
Indirect Branch Prediction
// Cat
Cat kitten = new Cat();
speak(kitten);
//Dog
Dog puppy = new Dog();
speak(puppy);
void speak(Animal a) {
a.talk();
}
â€œmeowâ€ ğŸ±
BPU
â€œmeowâ€ ğŸ±
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
20
Context-based prediction
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
21
0x1337: void speak(Animal a) {
0x1338:    a.talk();
}
Context-based prediction
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
21
Shift Register
0x1337: void speak(Animal a) {
0x1338:    a.talk();
}
F1
BHB
Context-based prediction
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
21
Shift Register
0x1337: void speak(Animal a) {
0x1338:    a.talk();
}
F1
BHB
F2
Context-based prediction
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
21
Shift Register
0x1337: void speak(Animal a) {
0x1338:    a.talk();
}
F1
BHB
F2
=?
TAGcat
â€œmeowâ€ ğŸ±
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
22
TAG
PRIV
TARGET
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
22
printf(â€˜Helloâ€™)
â””â–º syscall(write, stdout, â€˜Helloâ€™, 5)
User space
sys_call_table[NR_write](regs)
â””â–º sys_write
Kernel space
BTB
TAG
PRIV
TARGET
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
22
printf(â€˜Helloâ€™)
â””â–º syscall(write, stdout, â€˜Helloâ€™, 5)
User space
sys_call_table[NR_write](regs)
â””â–º sys_write
Kernel space
BTB
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
23
getc(stdin)
â””â–º syscall(read, stdin, &c, 1)
User space
sys_call_table[NR_read](regs)
â””â–º sys_read
Kernel space
BTB
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
TAGread
kernel
sys_read
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
23
getc(stdin)
â””â–º syscall(read, stdin, &c, 1)
User space
sys_call_table[NR_read](regs)
â””â–º sys_read
Kernel space
BTB
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
TAGread
kernel
sys_read
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
24
printf(â€˜VUSecâ€™)
â””â–º syscall(write, stdout, â€˜VUSecâ€™, 5)
User space
sys_call_table[???](regs)
â””â–º ???
Kernel space
BTB
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
TAG
PRIV
TARGET
TAGwrite
kernel
sys_write
TAGread
kernel
sys_read
Bypassing Spectre Hardware Defenses
Intuition: user history is necessary for accurate kernel prediction
24
printf(â€˜VUSecâ€™)
â””â–º syscall(write, stdout, â€˜VUSecâ€™, 5)
User space
sys_call_table[???](regs)
â””â–º ???
Kernel space
BTB
BPU
Iâ€™ve already seen this user history!
Speculate on sys_write
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
25
TAG
PRIV
TARGET
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
25
context_A_1()
â””â–º ...
â””â–º context_A_64()
â””â–º syscall(sys_a)
sys_call_table[NR_sys_a](regs)
â””â–º sys_a()
BTB
User space
Kernel space
TAG
PRIV
TARGET
TAG
PRIV
TARGET
TAGA
kernel
sys_a
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
25
context_A_1()
â””â–º ...
â””â–º context_A_64()
â””â–º syscall(sys_a)
sys_call_table[NR_sys_a](regs)
â””â–º sys_a()
BTB
User space
Kernel space
TAG
PRIV
TARGET
TAGA
kernel
sys_a
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
26
context_B_1()
â””â–º ...
â””â–º context_B_64()
â””â–º syscall(sys_b)
sys_call_table[NR_sys_b](regs)
â””â–º sys_b()
BTB
User space
Kernel space
TAG
PRIV
TARGET
TAGA
kernel
sys_a
TAG
PRIV
TARGET
TAGA
kernel
sys_a
TAGB
kernel
sys_b
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
26
context_B_1()
â””â–º ...
â””â–º context_B_64()
â””â–º syscall(sys_b)
sys_call_table[NR_sys_b](regs)
â””â–º sys_b()
BTB
User space
Kernel space
TAG
PRIV
TARGET
TAGA
kernel
sys_a
TAGB
kernel
sys_b
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
27
context_A_1()
â””â–º ...
â””â–º context_A_64()
â””â–º syscall(sys_b)
sys_call_table[???](regs)
â””â–º ???
BTB
User space
Kernel space
TAG
PRIV
TARGET
TAGA
kernel
sys_a
TAGB
kernel
sys_b
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
27
context_A_1()
â””â–º ...
â””â–º context_A_64()
â””â–º syscall(sys_b)
sys_call_table[???](regs)
â””â–º ???
BTB
User space
Kernel space
BPU
Iâ€™ve already seen this user history!
Speculate on sys_a
TAG
PRIV
TARGET
TAGA
kernel
sys_a
TAGB
kernel
sys_b
Bypassing Spectre Hardware Defenses
Can we control kernel branch prediction with user-space history?
27
context_A_1()
â””â–º ...
â””â–º context_A_64()
â””â–º syscall(sys_b)
sys_call_table[???](regs)
â””â–º ???
BTB
User space
Kernel space
BPU
Iâ€™ve already seen this user history!
Speculate on sys_a
Bypassing Spectre Hardware Defenses
Experiment results:
â€¢
Intel
â—‹
eIBRS: perfect mispredicQon! âœ”
â€¢
Arm
â—‹
CSV2: perfect mispredicQon! âœ”
â€¢
AMD
â—‹
retpoline: no mispredicQon! âŒ
28
User context can be used to 
mistrain kernel 
indirect branches
(Even with HW defenses)
Branch History Injection (BHI)
29
Branch History Injection
30
For exploitation we need to understand:
Branch History Injection
30
For exploitation we need to understand:
â€¢
Which targets we can speculatively execute 
br_a: jmp rax
target_a
target_b
Branch History Injection
30
For exploitaOon we need to understand:
â€¢
Which targets we can speculaOvely execute 
br_a: jmp rax
target_a
target_b
ğŸ§â‰
Branch History Injection
30
For exploitation we need to understand:
â€¢
Which targets we can speculatively execute 
â€¢
Which branches we can mispredict
br_a: jmp rax
br_b: jmp rax
target_a
target_b
ğŸ§â‰
Branch History Injection
30
For exploitation we need to understand:
â€¢
Which targets we can speculatively execute 
â€¢
Which branches we can mispredict
br_a: jmp rax
br_b: jmp rax
target_a
target_b
ğŸ§â‰
BPU Internals
31
Patents
BPU Internals
31
Patents
Rev. Eng.
BPU Internals
31
Patents
Rev. Eng.
BPU Internals
31
Patents
Rev. Eng.
Brute Force
BPU Internals
32
â€¢
Just by controlling the BHB, what BTB tags can we generate?
TAG
TARGET
TAGcat
â€œmeowâ€ ğŸ±
...
...
TAGdog
â€œwoofâ€ ğŸ¶
BTB
breed_cats()
â””â–º new_cat()
â””â–º new Cat()
kitten_first_words()
â””â–º speak()
Shift Register
0x1337: void speak(Animal a) {
0x1338:    a.talk();
}
F1
BHB
F2
=?
TAGxxx
â€œmeowâ€ ğŸ±
BPU Reverse Engineering â€“ Brute Force
33
BPU Reverse Engineering â€“ Brute Force
33
BPU Reverse Engineering â€“ Brute Force
33
âœ” Always correct predic5on! The BPU is able to dis5nguish HA from HB
BPU Reverse Engineering â€“ Brute Force
33
âœ” Always correct predic5on! The BPU is able to dis5nguish HA from HB
BPU Reverse Engineering â€“ Brute Force
33
âŒ Always misprediction! The BPU is unable to distinguish HA from HB
BPU Reverse Engineering â€“ Brute Force
How long is this brute-force?
â€¢
Intel 10th gen: 14 bits entropy
â€¢
Intel 11th gen: 17 bits entropy
â€¢
Cortex-X1: 9 bits entropy
34
Entropy is small enough to 
make brute force feasible
BHI Capabilities
35
ind. branch
User
space
Kernel
space
BHI Capabilities
35
PRIV
TAG
TARGET
kernel
TAG_A
kern_func_a
user
TAG_B
user_func
kernel
TAG_C
kern_func_b
PRIV
TAG
TARGET
kernel
TAG_A
valid_target_a
user
TAG_B
user_func
kernel
TAG_C
valid_target_b
kernel
TAG_D
other_target_1
kernel
TAG_E
other_target_2