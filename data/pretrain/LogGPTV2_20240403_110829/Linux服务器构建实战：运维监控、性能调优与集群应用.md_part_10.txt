if ["$1"=
在Varnish的两种日志输出形式中，第一种在大多数情况下不是必须的，这里重点介绍
>-w/data/varnish/log/varnish.log
[root@varnish-server -]#/usr/local/varnish/bin/varnishncsa -n/data/varnish/cache
也可以将日志输出到一个文件中，通过“-w”参数指定即可。
[root@varnish-server -]#/usr/local/varnish/bin/varnishncsa
例如：
口通过自带的varnishncsa指令得到类似Apache的combined输出格式的日志。
rotatelogs/data/varnish/log/varnish.tY.&m.td.tH.1og 3600 480 &
killall varnishncsa
"stop"];then
echo $0 "{start|stop}"
，可以知道Varnish的运行状态和情况。
-n/data/varnish/cache
/uq/xsn/|-
君
PDG
---
## Page 71
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
行方式，通过查看网页头来查看命中情况。
二次打开网页的速度会明显比第一次快，但是这种方式并不能够充分说明问题。下面用命令
2.5.2
可以查看。
Apache类似。
为29646的进程是varnishd的主进程，并且派生出一个PID为29647的子进程。这点跟
正常启动。
2.5.1
2.5
可以通过浏览器访问对应的网页来查看Varmish缓存的效果。如果Varmish缓存成功，第
如果Varnish正常启动，80端口和3500端口应该处于监听状态，这一点通过如下命令
Last-Modified: Sat, 10 Ju1 2010 11:25:15 GMT
Server: Apache/2.2.14 (Unix) PHP/5.3.1 mod_per1/2.0.4 Per1/v5.10.1
HTTP/1.1200 OK
[root@varnish-server ~]# curl -I http://www.ixdba.net/a/mz/2010/0421/11.html
其中，80端口为Varnish的代理端口，3500为Varnish的管理端口。
从命令执行结果可知，PID为29615和29616的进程是Varnish的日志输出进程，而PID
varnish 29647 29646 0 00:211
[rootavarnish-server ~]#ps -ef|grep varnish
通过上一节的设置，Varmish已经可以启动起来了。执行如下命令可以查看Varnish是否
tcp
cp
[root@varnish-server ~]# netstat-antl|grep 3500
root296461000:21？
root 29615 10 00:20 pts/1
查看Varnish缓存效果与状态
varnish/cache -f
查看Varnish进程
管理Varnish
etc/vcl.conf -u varnish -g varnish -w 2,51200,10 -n /data/varnish/cache -g
run/varnish.pid -a 192.168.12.246:80 -T 127.0.0.1:3500 -f /usr/1oca1/varnish/
vcl.conf
varnish.pid
varnish.$Y.&m.$d.$H.1og 3600 480
www.Linuxidc .com
D
-a 192.168.12.246:80 -T 127.0.0.1:3500 -f /usr/1ocal/varnish/etc/
0192.168.12.246:41782
0127.0.0.1:3500
00:00:00/usr/1ocal/varnish/sbin/varnishd-P/var/run
00:00:00 /usr/local/varnish/bin/varnishncsa -n/data/
00:00:00 /usr/sbin/rotatelogs /data/varnish/1og/
00:00:00 /usr/1ocal/varnish/sbin/varnishd -P/var
192.168.12.26:80
0.0.0.0:
第2章
高性能HiTP加速器varnish
LISTEN
LISTEN
CLOSE_WAIT
---
## Page 72
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
状态，对于优化和调整Varnish至关重要。
Vamish的配置可能存在问题，需要进行调整。因此，从整体上了解Varnish的命中率和缓存
Varnish运行状态良好，Web服务器的性能也会提高很多；反之，过低的缓存命中率说明
52
Hitrate avg:
Hitrate ratio:
[root@varnish-server ~]#/usr/local/varnish/bin/varnishstat
下面是一个Varnish系统的缓存状态：
Varnish提供了一个varmishstat命令，通过它可以获得很多重要的信息。
缓存命中率的高低直接说明了Varnish的运行状态和效果，较高的缓存命中率说明
X-Cache:HIT from www.ixdba.net
Age:79
X-Varnish:1364398612 1364285597
Date:Fri,
con
ETag:"5e850b-616d-48b06c6031cc0=
Last-Modified:Sat, 10 Jul 2010 11:25:15 GMT
Server: Apache/2.2.14 (Unix) PHP/5.3.1 mod_per1/2.0.4 Per1/v5.10.1
HTTP/1.1 200 OK
[root@varnish-server -]# curl -I http://www.ixdba.net/a/mz/2010/0421/11.html
再次打开这个页面，查看网页的头信息。
x-Cache：MISSfromwww.ixdba.net#这里的“MISs”表示此次访问没有从缓存读取
Connection:
Age:0
x-Varnish: 1364285597
Date:Fri,09 Ju1 2010 08:29:16 GMT
Content-Length:24941
ETag:"5e850b-616d-48b06c6031cc0"
就是缓存命中
ntent-Type:text/html
第1篇Web应用篇
www.Linuxidc.com
112801
121820
2630
8978
2688
9990
444
2
68
09Ju12010 08:30:35 GMT
keep-alive
0.9999
32.
29.96
33.96
33.96
0.00
919.88
953.84
68.92
00
10
.96
0.9964
100
44.67 Backend conn.
13.14 Backend conn.
561.20
606.07
13.08
31.
49.70 C1ient
#由“HIT”可知，第二次访问此页面时，从缓存中读取小容，也
0.34
52
0.9964
N struct sess_mem
Fetch with Length
Backend conn
Cache misses
Cache hits
113
connections accepted
recycles
was closed
reuses
success
-n/data/varnish/cache
PDG
---
## Page 73
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
Varmish子进程进行启动、关闭、查看状态和清除缓存等操作。具体的使用方式如下：
2.5.3
Type help' for command list
Varnish HTTP accelerator CLI
200154
Escape character is
Connected to 1ocalhost.1ocaldomain (192.168.12.246).
Trying 192.168.12.246..
[root@varnish-server ~]#telnet 192.168.12.246 3500
Varmish提供了基于端口的管理方式，用户可以通过telnet方式登录到管理端口，对
口"NLRUmovedobjects”表示被淘汰的缓存内容个数。
口“Nexpiredobjects”表示过期的缓存内容数量。
口“N struct object”表示当前被缓存的数量。
口"Cachemisses”表示直接访问后端主机的请求数量，也就是非命中数。
口“Cachehits”表示反向代理服务器在缓存区中查找并且命中缓存的次数。
口“Client requests received”表示到现在为止，浏览器向反向代理服务器发送HTTP请
口“Client connections accepted”表示客户端向反向代理服务器成功发送HTTP请求的总
这里需要注意以下几点：
accepted”的值。
求的累计次数。
数量。
通过端口管理Varnish
121820
9985
3701
1201
www.Linuxidc.com
，由于可能会使用长连接，因此这个值一般会大于“Clientconnections
942.85
00
1.00
.99
606.07 Total Requests
49
587.
61
86
00
0.
34
Objects sent with write
N
N struct objectcore
worker
N struct sess
LRU moved objects
expired objects
backends
overflowed work requests
worker
large
struct smf
struct objecthead
struct object
第之章
work requests
threads
threads
free
smf
created
hish
53
PDG
---
## Page 74
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
54
Child in state running
20022
Status
2000
Start
Type
Type
=*
Varnish HTTP accelerator CLI
200154
Escape character is ^]'.
Connected to 1ocalhost.1ocaldomain (192.168.12.246)
[root@varnish-server -]#telnet 192.168.12.246 3500
这里列举一个简单的操作示例，执行如下：
purge.list
purge [&&].
purge.url 
vc1,show 
vcl.1ist
vcl.discard 
vc1.inline  
vc1.1load  
stats
atop
start
status
banner
quit
ping
200377
nelp
Type 'quit' to close CLI session.
help'for command list.
[timestamp]
www.Linuxidc.com
我
PDG
---
## Page 76
Linux公社（www.LinuxIDC.com）是专业的Linux系统门户网站，实时发布最新Linux资讯。
的相关情况。
服务器才能查看。下面给出一个PHP程序，可以随时随地清晰地了解Varnish系统的命中率
Varnish给出了很详细的统计数据，但是这些统计数据不是很直观，并且必须登录到Varmish
56
function byteReduce（Sbytes）(