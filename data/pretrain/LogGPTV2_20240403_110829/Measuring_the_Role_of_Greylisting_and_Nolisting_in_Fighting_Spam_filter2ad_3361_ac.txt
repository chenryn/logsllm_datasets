classify a spam bot with respect to its MX behavior [2] in
four categories:
•
•
•
RFC Compliant: the malware sample targets all
email servers following their priority order from
the higher to the lowest, according to the RFC
5321 [21].
Primary Only: the malware sample targets only
the mail server with the highest priority (this is the
fundamental assumption of nolisting).
Secondary Only: the malware sample targets only
the mail server with the lowest priority, skipping
the primary server altogether. People who criticize
nolisting often say that this was the natural reaction
of malware writers to nolisting.
566
three consecutive times, the ﬁrst using a signiﬁcantly low
greylisting threshold (5 seconds), the second using the default
Postgrey threshold of 300 seconds, and ﬁnally using a very
high threshold set to 21,600 seconds.
The results of the experiments are summarized in Ta-
ble II. First of all, our tests show that greylisting is still
very effective in practice. In fact,
it was able to stop
Cutwail and Darkmailer (together responsible for over
43% of the world spam) from delivering any spam message.
Unfortunately, Kelihos was able to cope with greylisting,
making this countermeasure ineffective against this particular
malware family.
The cumulative distribution of the delivery attempts time
of Kelihos are presented in Figure 3. The similarity
between the two curves clearly shows that the malware is
not able to take advantage of a shorter greylisting threshold
(e.g., by trying to resend more often in a short window time),
but instead it is designed to retry again to delivered a message
after a minimum delay of 300 seconds – which is, in fact,
the default threshold used by popular greylisting software.
The picture is quite different when the greylisting thresh-
old is set at 21600 seconds (i.e., six hours). In this case, it
is possible to observe the complete behavior of Kelihos,
while it attempted to delivery the failed messages multiple
times. Figure 4 shows a plot of all the delivery attempts
made by the malware: we can clearly identify a number of
peaks, such as the one we already mentioned between 300-
600 seconds, a second around 5000 seconds, and a third
between 80,000 and 90,000 seconds. As shown by the red
dots on the right side of the graph, after several attempts
Kelihos was able to deliver its messages.
To conﬁrm these results, we needed to rule out a possible
subtle side-effect of how spam bots could interact with a
service implementing greylisting with a very high threshold.
Suppose for instance that Kelihos only tried to deliver each
message three times before abandoning the task. However,
one hour later the bot could have received from its bot master
a new job to deliver a second spam message, different from
the ﬁrst one but directed again to the same list of recipients.
Since greylisting does not keep track of the message itself,
the server would consider the incoming connection as an
attempt to delivery the same message that had been greylisted
before. In this case, the ﬁrst spam message would have been
dropped, but the second (and all the following ones after
that) would successfully pass through the spam ﬁlter. To rule
out this hypothesis, we left few email addresses unprotected
(e.g., postmaster), allowing those spam messages to
be delivered without greylisting. Since all email messages
directed to the unprotected email addresses were the same
of the ones ﬁltered by the greylisting ﬁlter, we can conclude
that the there was only one spam task during the entire
experiment.
It is now interesting to compare the retransmission be-
havior of Kelihos with the one of benign email transfer
agents.
(a) CDF of the spam delivery delay with greylisting at 5 seconds
(b) CDF of the spam delivery delay with greylisting at 300 seconds
Fig. 3: Effect of greylisting on Kelihos
•
All MX: the malware sample targets all the email
servers of the target domain, in a random or system-
atic order.
By inspecting the communication of the malware sample
with our DNS and our email server, we were able to establish
to which category each family belongs to. As we already
mentioned, Kelihos only targets the primary server –
thus failing to deliver the spam messages. Cutwail is
not affected by nolisting because it targets immediately the
lowest priority mail server, ignoring the ﬁrst one. On the
contrary, the two Darkmailer versions we tried were RFC-
compliant, and they contacted the email servers in order of
priority.
V. GREYLISTING
While greylisting is much more popular than nolisting,
measuring its precise adoption on the Internet is not possible
because it would require to know in advance a valid recipient
for each server. For this reason, we focus our analysis on the
impact of this technique on the delivery of spam and benign
messages.
A. Impact on Spam Delivery
Similarly to what we described to measure the impact
of nolisting, we run each malware sample in our contained
environment – forwarding all the SMTP trafﬁc to a local
email server protected by greylisting. Every sample was run
567
Fig. 4: Retransmission delays of Kelihos with a greylisting threshold of 21600 seconds. In blue the failed attempts (below
the threshold) and in red the delay of delivered emails (above the threshold).
Fig. 5: CDF of the email delivery delay of a real-world mailbox with greylisting at 300 seconds
B. Greylisting on a Real Deployment
The experiments described in the previous section shows
that greylisting is still able to block many popular malware
families,
thus preventing over 50% of the spam to be
delivered to the users inboxes. However, the picture would
not be completed without looking at a real installation.
Greylisting is currently deployed to protect
the mail
the
server of our University department. By looking at
(containing only the timestamps of
anonymized logs
greylisted attempts) we found two interesting things. First,
Figure 5 shows the distribution of the delays introduced in
the message delivery of greylisted messages. The cumulative
distribution of the delays increases much slower than the
curve we observed for malware in Figure 3. This is a
surprising, and quite negative, result. In fact, even with
greylisting conﬁgured on 300 seconds (5 minutes), only half
of the messages get delivered in less than 10 minutes. Even
worse, some messages are delivered with over 50 minutes
of delay, and some even beyond that. This seems to suggest
that, as often mentioned by the critics of this technique, the
impact of greylisting on benign messages is not negligible.
C. Impact on the Delivery of Benign Emails
Figure 5 showed that, in presence of greylisting conﬁg-
ured with a 5-minute threshold, some emails get delivered
with very long delays. However, it is hard to tell precisely
which fraction of those were legitimate and which were
spam or commercial advertisements. Therefore, we decided
to verify ourselves the re-transmission delays of popular
MTA clients and web-mail providers.
In order to perform our experiments we created an
account on the top ten web-mail providers, as reported in
Table III and we used them to send an email to a test account
on our mail server. For this experiment, we removed the
568
default white-list of Postgrey, since by default it contains
all the web-mail providers used in our tests. To measure
the reliability of web-mail servers and to collect a sufﬁcient
amount of data, we set the greylisting delay to the excessively
large value of 6 hours. Table III shows the results of this
experiment. More precisely, the table contains ﬁve columns
showing the web-mail providers chosen for our experiments,
the number of unique IP addresses used to deliver the same
email message, the number of delivery attempts in the six
hours time window, whether or not the web-mail provider
was able to deliver the email message, and the timestamps
of all performed attempts.
By analyzing the results, we can notice that the retry
policy of each service is quite different, often without a clear
pattern. In few cases the server clearly used a linear approach,
in others it seems that the delay is doubled between each
attempt. Moreover, also the total number of attempts changes
very substantially between services – ranging from 9 in case
of gmail to 94 for hotmail in the same time window of
six hours.
In most cases,
the servers tried to deliver the email
long enough to successfully go over the 6h greylisting
threshold. However, two of them abandoned the task earlier
and therefore were not able to deliver the message. Quite
surprisingly, aol.com stopped its delivery attempts after
only 30 minutes. This is strange since the RFC-822 [30]
clearly states that “retries continue until
the message is
transmitted or the sender gives up; the give-up time generally
needs to be at least 4-5 days”.
The second column of Table III reports another infor-
mation that is crucial for testing the efﬁciency of greylisting
technique: the number of distinct IP addresses that were used
to deliver the same message. Since greylisting authorizes
emails based on a triplet containing the sending IP address,
if the sender changes address between consecutive attempts
the message risks to be greylisted again. This situation occurs
for ﬁve out of ten web-mail providers. Even though all of
them were able to eventually deliver the message because the
same IP was reused in different connections, this behavior
increases the delivery time and potentially results in a failed
delivery.
To complement
this result, we looked at
the default
conﬁguration of the seven most popular MTA servers used
on the Internet [16]. Table IV shows the retransmission times
extracted from the software documentation, for the ﬁrst 10
hours. The second column of the table represents the interval
time for each delivery attempt performed by the MTA server.
The third column shows instead the maximum time-to-live
of an email before the server stops retrying and bounces the
message back.
While the exact
intervals are often controlled by a
combination of multiple parameters, as one can see from
the table, by default some MTA servers (e.g., Sendmail
and Qmail) are very regular regarding the time interval
between consecutive attempts. Exchange was the only MTA
not RFC-822 complaint with respect
to the time-to-live.
Sendmail, Exim and postﬁx follow the same time to live
569
suggested in RFC-822, while Qmail and Courier are even
more conservative and use a threshold of 7 days.
VI. DISCUSSION
In the previous sections we presented a number of
experiments we conducted to assess the effect of nolisting
and greylisting. Based on our results, we can ﬁnally answer
a number of important questions.
First of all, the good news is that nolisting and greylist-
ing are still effective in 2015. In fact, over 70% of the
world spam is prevented by using either one or the other
technique. Quite surprisingly, the most common families of
malware responsible for sending spam are now able to cope
with either nolisting (e.g., by skipping the primary mail
server and contacting directly the secondary) or greylisting
(by continuously re-trying to deliver the messages) but not
with both. Between the two, greylisting seems to be more
effective, but it also introduces negative side effects that
need to be properly evaluated before deployment. On the
other hand, nolisting is very simple to deploy and does not
have many disadvantages. While it is certainly less famous
and widespread than greylisting, according to our measures
some popular companies and over 130 thousand domains
already use it as an additional layer of defense against spam.
If possible, our experiments show that using both techniques
together is a very effective way to protect against the majority
of spam.
Our study also conﬁrms that the possible negative side-
effect of greylisting are not a myth. To begin with, it is
fundamental for greylisting services to white-list web-mail
providers. The fact
that many of them use multiple IP
addresses and that some stop retrying after only 30 minutes
could otherwise be problematic. Finally, our experiments also
help to answer the question of which threshold should be
used to maximize the protection and reduce disadvantages.
In fact, on the one hand malware that supports the retransmis-
sion of failed messages is able to do that multiple times and
to successfully deliver spam also with very high thresholds.
On the other hand, a low threshold help reducing the delay
of normal emails and to minimize the possibility of losing
messages. Therefore, the use of a very short threshold is
probably the best way to maximize both aspects (stopping
spam and reducing unwanted delays).
Results Validity
This study presents a snapshot of the advantages and
disadvantages of the use of greylisting and nolisting in 2015.
It is very difﬁcult to say when our results will be outdated:
both techniques have been known for more than ten years,
but our results shows that today they are still quite effective
in practice. On the other hand, greylisting and nolisting have
a cost for the system (for example in terms of disk space
and computation resources) and for the Internet community
at large (because of the increased trafﬁc and bandwidth). The
effectiveness of these two techniques can change in the future
and it is important to know when they will become obsolete
because at that moment it will not be worth paying the price
anymore.
PROVIDER
gmail.com
yahoo.co.uk
hotmail.com
qq.com
mail.ru
yandex.com
mail.com
gmx.com
aol.com