DEF CON 18 
Malware Freakshow 2 
Nicholas J. Percoco & Jibran Ilyas 
Copyright Trustwave 2010 
Agenda 
•  About Us 
•  Introduction 
•  What’s a Malware Freakshow? 
•  Anatomy of a Successful Malware Attack 
•  Sample Analysis + Victim + Demo 
•  Sample SL2009-127 – Memory Rootkit Malware 
•  Sample SL2010-018 – Windows Credential Stealer 
•  Sample SL2009-143 – Network Sniffer Rootkit 
•  Sample SL2010-007 – Client-side PDF Attack 
•  Conclusions 
Copyright Trustwave 2010 
About Us 
Nicholas	
  J.	
  Percoco	
  /	
  Senior	
  Vice	
  President	
  at	
  Trustwave	
• 
15	
  Years	
  in	
  InfoSec	
  /	
  BS	
  in	
  Computer	
  Science	
• 
Built	
  and	
  Leads	
  the	
  SpiderLabs	
  team	
  at	
  Trustwave	
• 
Interests:	
−  Targeted	
  Malware,	
  AFack	
  PrevenHon,	
  Mobile	
  Devices	
• 
Business	
  /	
  Social	
  Impact	
  Standpoint	
Jibran	
  Ilyas	
  /	
  Senior	
  Security	
  Consultant	
  at	
  Trustwave	
• 
8	
  Years	
  in	
  InfoSec	
  /	
  Masters	
  in	
  Infotech	
  Management	
from	
  Northwestern	
  University	
• 
Interests:	
−  AnHforensics,	
  ArHfact	
  Analysis,	
  Real	
  Hme	
  Defense	
Copyright Trustwave 2010 
Introduction 
We	
  had	
  a	
  busy	
  year!!	
• 
Over	
  200	
  incidents	
  in	
  24	
  diﬀerent	
  countries	
• 
Hundreds	
  of	
  Samples	
  to	
  pick	
  from	
• 
We	
  picked	
  the	
  most	
  interesHng	
  for	
  you	
New	
  Targets	
  This	
  Year	
• 
Sports	
  Bar	
  in	
  Miami	
• 
Online	
  Adult	
  Toy	
  Store	
• 
InternaHonal	
  VoIP	
  Provider	
• 
US	
  Defense	
  Contractor	
Malware	
  Developers	
  were	
  busy	
  upda@ng/improving	
  their	
  code	
• 
Many improvements to avoid detection 
• 
Maybe they saw our Freakshow last year   
Copyright Trustwave 2010 
What’s a Malware Freakshow? 
We	
  have	
  access	
  to	
  breached	
  environments	
• 
These	
  environments	
  contain	
  valuable	
  data	
• 
Smash	
  and	
  Grab	
  is	
  old	
  school	
• 
AFackers	
  spend	
  average	
  of	
  156	
  before	
  geXng	
  caught	
• 
With	
  Hme,	
  comes	
  exploraHon	
  and	
  development	
• 
Custom	
  and	
  Targeted	
  Malware	
  is	
  the	
  Norm,	
  not	
  the	
excepHon	
• 
Gather	
  and	
  perform	
  analysis	
  on	
  each	
  piece	
  of	
  Malware	
− 
A	
  Malware	
  Freakshow	
  demos	
  samples	
  to	
  the	
  security	
  community	
− 
Beneﬁt:	
  Learn	
  the	
  sophis@ca@on	
  of	
  the	
  current	
  threats	
− 
Goal:	
  Rethink	
  the	
  way	
  we	
  alert	
  and	
  defend!!!	
Copyright Trustwave 2010 
Anatomy of a Successful Malware Attack 
Malware	
  development	
  takes	
  a	
  methodical	
  approach	
• 
Step	
  1:	
  IdenHfying	
  the	
  Target	
• 
Step	
  2:	
  Developing	
  the	
  Malware	
• 
Step	
  3:	
  InﬁltraHng	
  the	
  VicHm	
• 
Step	
  4:	
  Finding	
  the	
  Data	
• 
Step	
  5:	
  GeXng	
  the	
  Loot	
  Out	
• 
Step	
  6:	
  Covering	
  Tracks	
  and	
  ObfuscaHon	
  (opHonal)	
Before	
  we	
  discuss	
  the	
  samples,	
  we’ll	
  cover	
  this	
  process.	
Copyright Trustwave 2010 
Anatomy – Step 1: Identifying the Target 
Target	
  the	
  Data	
  that	
  will	
  lead	
  to	
  the	
  Money	
• 
Credit	
  Card	
  Data	
−  Exists	
  in	
  plain	
  text	
  in	
  many	
  type	
  of	
  environments	
−  Cash	
  is	
  just	
  4	
  hops	
  away	
[Track	
  Data]-­‐>[Fake	
  Card]-­‐>[Fraud]-­‐>[Sale	
  of	
  Goods]-­‐>[Cash]	
• 
ATM/Debit	
  Card	
  Data	
−  Limited	
  to	
  only	
  ATM	
  Networks	
  and	
  places	
  accepHng	
  debit	
−  Need	
  PIN	
  as	
  well	
−  Cash	
  is	
  just	
  3	
  hops	
  away	
[Track	
  Data+PIN]-­‐>[Fake	
  Card]-­‐>[ATM	
  Machine]-­‐>[Cash]	
Copyright Trustwave 2010 
Anatomy – Step 2: Developing the Malware 
Depends	
  on	
  the	
  Target	
  System,	
  but	
  focus	
  on	
  the	
  Big	
  Three	
• 
Keystroke	
  Logger	
• 
Network	
  Sniﬀer	
• 
Memory	
  Dumper	
• 
Disk	
  Parser?	
Design	
  Considera@ons	
• 
Naming	
  ConvenHon	
• 
blabla.exe	
  –	
  not	
  the	
  best	
  name	
  choice	
• 
svchost.exe	
  –	
  much	
  beFer	
• 
FuncHonality	
• 
Slow	
  and	
  Steady	
  wins	
  the	
  race	
• 
Persistency	
  and	
  Data	
  Storage	
Copyright Trustwave 2010 
Anatomy – Step 3: Infiltrating the Victim 
Three	
  basic	
  methods	
  of	
  plan@ng	
  your	
  malware:	
• 
The	
  Physical	
  Way	
−  “Hi,	
  I’m	
  Ryan	
  Jones.	
  Look	
  over	
  there.	
  pwned”	
• 
The	
  Easy	
  Way	
−  “Nice	
  to	
  meet	
  you	
  RDP	
  &	
  your	
  friend	
  default	
  password”	
• 
The	
  Über	
  Way	
−  0days	
−  “Silent	
  But	
  Deadly”	
Copyright Trustwave 2010 
Anatomy – Step 4: Finding the Data 
The	
  SoXware	
  Holds	
  the	
  “Secrets”	
• 
Task	
  Manager	
−  Busy	
  Processes	
  ==	
  Data	
  Processing	
• 
Process’s	
  Folders	
−  Temp	
  Files	
  ==	
  SensiHve	
  Data	
• 
Conﬁgura@on	
  Files	
−  Debug	
  Set	
  to	
  ON	
  ==	
  Shields	
  Down	
• 
The	
  Wire	
−  Local	
  Network	
  Traﬃc	
  ==	
  Clear	
  Text	
Copyright Trustwave 2010 
Anatomy – Step 5: Getting the Loot Out 
Keep	
  It	
  Simple	
  Stupid	
• 
Li]le	
  to	
  no	
  egress	
  ﬁltering,	
  doesn’t	
  mean	
  use	
  TCP	
  31337	
• 
Don’t	
  Reinvent	
  to	
  Wheel	
−  FTP	
−  HTTP	
−  HTTPS	
−  SMTP	
• 
IT/Security	
  Professional	
  Look	
  for	
  Freaks	
−  Traﬃc	
  on	
  high	
  ports	
  ==	
  suspicious	
Copyright Trustwave 2010 
Anatomy – Step 6: Covering Tracks and Obfuscation 
Don’t	
  Be	
  Clumsy	
• 
Test	
  the	
  Malware	
  First!	
−  Crashing	
  Systems	
  =	
  Sorta	
  Bad	
−  Filling	
  Up	
  Disk	
  Space	
  =	
  Real	
  Bad	
−  CMD	
  Popping	
  Up	
  =	
  Just	
  Stupid	
Mess	
  with	
  the	
  Cops	
• 
MAC	
  Hmes	
  to	
  match	
  system	
  install	
  dates	
• 
Obfuscate	
  Output	
  ﬁle;	
  even	
  just	
  slightly	
• 
Pack	
  the	
  Bag	
  of	
  Tricks	
• 
Automate,	
  but	
  Randomize	
  Events	
• 
Rootkits	
Copyright Trustwave 2010 
Sample SL2009-127 – Memory Rootkit Malware 