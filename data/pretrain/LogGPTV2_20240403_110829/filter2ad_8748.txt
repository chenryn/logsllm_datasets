# 【技术分享】旧瓶装新酒——Memcache 作为 DRDoS 反射放大器

## 译文声明
本文为翻译文章，原文来源：安全客。译文仅供参考，具体内容和含义以原文为准。
**作者：** [张鲁@360 0kee team](http://bobao.360.cn/member/contribute?uid=2515404114)
**投稿方式：** 发送邮件至 linwei#360.cn 或登录网页版在线投稿。

## 0x00 关于 DRDoS 反射攻击
分布式拒绝服务 (DDoS) 攻击有多种类型，包括大规模远程控制集群、反射放大攻击以及复杂的物联网 (IoT) 僵尸网络。本文将重点讨论基于 UDP 的反射 DRDoS 攻击。

### DRDoS 原理
DRDoS（Distributed Reflection Denial of Service）通过向放大器主机发送大量带有伪造受害者 IP 地址的 UDP 数据包来实施。放大器主机收到这些请求后，会向伪造的 IP 地址发送大量响应数据包，从而形成分布式拒绝服务攻击。黑客通常会选择那些响应数据包远大于请求数据包的 UDP 服务，以此实现小量请求引发大量响应的效果。

### 攻击流程
一次完整的反射放大攻击可简化为三个环节：
- **攻击者**：需要伪造 IP 地址并发送大量伪造来源的请求。这些请求通常从未采取 BCP38（防止 IP 欺骗的最佳实践）措施的数据中心发出。
- **反射服务器**：需满足两个条件：一是运行容易被放大的 UDP 协议，即设计或使用不当的 UDP 服务；二是该协议或服务在互联网上有一定数量的部署。
- **受害者**：通常是金融、游戏、政治等高价值目标，但也有可能是出于破坏或炫耀目的的任意目标。

### 常见协议
下图展示了近三个月内用于反射 DDoS 攻击的流行协议，数据来源于[360 网络安全研究院](https://ddosmon.net/insight/)。NTP 和 DNS 等传统协议仍然占据主导地位，而 CLDAP 在 9 月 29 日出现了显著增长，这可能是地下黑客的一次实战测试或新型 LDAP 攻击工具的传播。

### 攻击强度
攻击强度通常用 PPS (Packets Per Second) 和 BPS (Bits Per Second) 来衡量。PPS 表示每秒发送的数据包数量，主要消耗服务器、网关及路由器的 CPU 性能；BPS 则表示每秒传输的比特数，主要用于评估带宽消耗情况。对于 DRDoS 攻击，其强度由放大器的数量及其平均放大倍率决定。

$$\text{BPS} = \text{Amplifiers} \times \text{Amplification Factor}$$

### 放大系数
常见的 UDP 协议如 NTP、CHARGEN、DNS 和 LDAP 都具有较高的放大倍数。例如，NTP 的 `monlist` 功能可以返回最近 600 个客户端的 IP 地址，导致响应数据包体积远超请求数据包，放大倍数可达 557 倍。类似地，LDAP 查询也能产生约 50 倍的放大效果。

### 放大器数量
全网不同类型的放大器数量统计显示，SIP、DNS、NTP、RPC 和 SSDP 等协议拥有大量的可用放大器，尤其是 NTP 和 DNS 因其广泛的分布成为最常用的攻击载体。

## 0x01 关于 Memcache
### 定义
Memcached 是一种基于内存的对象缓存系统，常用于减轻动态 Web 应用中的数据库负载。它同时监听 TCP 和 UDP 端口，并且支持无需认证即可进行交互，使其成为理想的 DRDoS 放大器。

### 常见攻击面
由于 Memcache 不需要认证即可与外部通信，加上许多用户错误地将其配置为监听所有 IP 地址 (`0.0.0.0`) 而未设置防火墙规则，使得此类服务极易被利用来进行 DDoS 放大攻击。

### 放大系数
经测试，Memcache 的放大倍数可以稳定在 50,000 倍以上，最高可达 500,000 倍。

### 攻击链
1. 扫描端口和服务。
2. 抓取指纹，识别未认证的 Memcache 实例。
3. 过滤出可用于 UDP 反射的 Memcache 服务器。

## 0x02 实战攻击
### 全网 Memcache 放大器预估
根据 Shodan 搜索结果，全球范围内开放的 Memcache 服务主要集中在中美两国，其次是香港、法国、日本等地，总数约为 116,534 个。

### 攻击强度和演示
选取一台 DigitalOcean 上的 Memcache 服务器进行 DDoS 测试，目标为 AWS EC2 实例。测试结果显示，最大反射流量达到 700 Mbps，稳定在 500 Mbps 左右。保守估计，利用全网 50,000 个 Memcache 主机可实现超过 5 Tbps 的攻击流量。

## 0x03 影响范围
### Top 20 ASN 信息
受影响最大的主要是云服务商（如 AWS、阿里云）、VPS 提供商（如 Digital Ocean、Linode）以及独立服务器托管商（如 OVH）。其中，阿里云虽然市场份额不如 AWS，但受此漏洞影响的主机数量却是 AWS 的 15 倍，主要原因在于 VPC 配置不当及用户安全意识薄弱。

### Top 20 地理分布
从地理分布来看，中国和美国是最主要的目标国家，尽管两者在开放主机数量上存在差异，但实际受影响程度却反映出双方在网络防御能力上的差距。

## 0x04 缓解措施和总结
### Memcache 使用者
建议将 Memcache 服务置于可信网络内部，避免对外监听所有 IP 地址。此外，还可以随机更改监听端口号、升级到最新版本并启用 SASL 认证机制来增强安全性。

### 网络层防御
网络管理员应监控来自 UDP 端口 11211 的入站流量，并采取相应措施阻止潜在威胁。ISP 应遵循 BCP38 标准防止 IP 欺骗行为的发生。同时，允许客户利用 BGP Flowspec 控制特定类型的入站流量，以缓解大规模 DDoS 攻击期间可能出现的拥塞问题。

### 开发者
开发人员在设计新的 UDP 协议时必须充分考虑可能存在的放大风险，确保不会无意中引入新的安全隐患。

## 0x05 关于我们
我们是 0kee Team，隶属于奇虎 360 信息安全团队，专注于 Web 安全研究及相关领域的攻防技术。欲了解更多信息，请访问我们的官方网站 [0kee.360.cn](http://0kee.360.cn)。