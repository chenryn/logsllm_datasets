2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
1/9
depy
It is a long and beautiful life.
首页 
关于 
友链
开发shiro蜜罐遇到的一些问题
2022年09月14日 / 网络安全
前情概要
我曾经写过一篇文章是帮助freebuf实现php网站拥有shiro的:https://rce.ink/i
ndex/view/366.go
之前的蜜罐一直写到可以根据指定key让工具实现逼真的爆破效果,如图所示：
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
2/9
这样攻击者会觉得网站是shiro框架，并且被我爆破出了一个key。再配合修改p
hpsessionid为jsessionid，脚本伪静态修改后缀为jsp达到更好的效果。
后续开发
上次写到那里我就去做更有意思的项目了。直到最近我才开始对指定利用链检
测、命令回显等功能进行完善。
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
3/9
我写了一堆php代码来配合脚本小子使用工具进行利用链测试的场景，大概可以
实现下面的效果：
脚本小子发现可以使用这个cc链进行攻击的时候，肯定会进行命令执行。那么我
也只需要写脚本来配合他的一些场景给响应的回显即可，在这里具体针对一下j1a
nfen师傅开发的shiro-attack工具。我们反编译工具中的AttackService.clas
s，代码如下
通过设置序列化的恶意attackRememberMe到cookie，对用户输入命令进行b
ase64编码放入请求头，取响应包body中的内容进行字符串$$$分割,然后取第二
组数据，也就是响应结果，在进行base64解码拿到命令回显。
写一个配合实现的脚本，但是执行命令的时候抛出下标越界的错误，也就是响应
包不是类似$$$data$$$的字符串
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
4/9
工具可以设置代理，我挂了一个burpsuite代理 结果响应是正常的
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
5/9
没办法 只能对jar包打断点
dt_socket,address=5005,server=y,suspend=y -jar /Users/depy/deskto
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
6/9
在  String responseText = this.bodyHttpRequest(header, "");  处打一个断
点
然后发送命令执行的指令
在代理请求下正常
在关闭代理的情况下 数据变成的乱码 让我非常疑惑 使用自己写的工具、浏览器
访问都正常 就工具不正常
一开始实在没想明白 一直觉得是工具有问题 但是转过头想那为啥其他有漏洞的
网站可以测试呢？所以显然是自己的网站有问题
我不断观察响应包 发现一个header
捏吗 这不是gzip压缩的标头么 看了下数据貌似是被压缩了 这我才想到 我特么网
站用的是nginx啊 
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
7/9
很好 果然是开了 把on改成off 标头就消失了
然后就可以正常执行命令了
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
8/9
这样我们可以愉快的构造一些虚假的命令执行结果 继续浪费他的时间 对着php一
顿shiro反序列化了
原因
1.burpsuite等支持自动对响应做gzip解压缩
^
2022/9/14 上午1:41
开发shiro蜜罐遇到的⼀些问题 - depy
https://rce.ink/index/view/406.go
9/9
2.工具使用的请求类URLConnection不支持自动做gzip解压或者版本太低？我
使用自己java工具测试的时候是正常的，看了下我用的是httpurlconnection
所以使用j1anfen师傅工具的时候 建议直接挂burpsuite代理 防止遇到gzip解
压的问题让你觉得是命令执行没有回显^^
^