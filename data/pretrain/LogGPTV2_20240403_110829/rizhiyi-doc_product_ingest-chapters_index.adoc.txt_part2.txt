==== 索引字段留存配置
image::images/index-field-conf.png[]
用户可以通过字段配置步骤，来决定索引中部分字段的数据留存，以便按需减少磁盘占用。字段设置表格中各列的用途说明如下：
1. 倒排：用于搜索和时间戳过滤。丢弃 raw_message 倒排，则无法使用全文搜索；丢弃 timestamp 倒排，则无法正常运行；丢弃具体某个字段的倒排，则无法使用 `key:"value"` 的语句。由于 SPL 语句必须由一段查询条件作为起始，所以用户至少需要保留一个以上字段的倒排数据。总体而言，即使是冷数据，建议依然保留内置字段的倒排部分。
2. 正排：用于搜索页/仪表盘的事件列表内容展示。对于以统计表格为主要需求的索引，可以按需去除正排部分。
3. 列存：用于排序和 SPL 计算，包括 stats/timechart 统计函数、parse/jpath 解析等。丢弃具体某个字段的列存，则无法使用 ` | stats count() by key` 的语句。对于审计类冷数据，可以按需丢弃部分列存。注意：`timestamp` 和 `context_id` 作为默认的搜索排序字段，切不可删除这两个字段的列存。
4. 分词：分词配置后，该字段的数据在查询时可以支持全文搜索语法，搜索结果展开的日志详情中，分词字段值也可以鼠标划选添加过滤。
默认情况下，仅 raw_message 字段默认开启分词，所有字段均保留倒排、正排和列存部分。
用户可以点击添加，具体定义特定字段的留存和分词行为。表格前三行的内置字段，可以修改配置，不可删除。
对字段的留存计划，分为：
* 不保留：数据入库时直接抛弃，即不创建。常用于结构化数据的索引，比如指标数据、调用链数据，可能不需要多少倒排数据，只需要列存数据。此时，通过设置倒排、正排的不保留，可以模拟列式数据库的行为。
* 保留：默认存储配置。
* 温删：索引开启温数据阶段后，我们可以按需定义在温数据阶段，删除局部数据。比如：部分提取字段在热数据阶段常用，到温数据后不再需要，即可删除。像一些提取用于即时统计的字段，apache.referer 等。
* 冷删：索引开启冷数据阶段后，我们可以按需定义在冷数据阶段，删除局部数据。比如：部分提取字段在热和温数据阶段常用，到冷数据后不再需要，即可删除。像部分内置字段 appname、ip、source 在冷数据阶段只需要留倒排供审计搜索，可以丢弃列存部分。
[NOTE]
====
字段留存配置仅在 beaver_datanode.gflags 中开启了 --reducing_count=1 和 --only_reduce_frozen_shards=1 时有效。
====
==== 索引压缩配置
针对不同数据场景和性能要求，索引可以开启不同的压缩配置，获取性价比合适的压缩比例。
* 正排压缩：开启该优化后，会改用 zstd 压缩算法替代默认的 lz4 压缩算法，提升正排数据的压缩比例，基本不影响查询性能。
* 正排优化：开启该优化后，在正排数据部分只保留日志原文字段，不影响任何功能使用。
* 丢弃部分内置字段：在部分场景中，以指标存储尤为典型，部分内置字段无实际意义，可以丢弃。
* 差值存储时间类字段：timestamp,agent_send_timestamp,collector_recv_timestamp,context_id 等字段均有时间含义，正常情况下，timestamp 和后续几个时间之间差值较小，开启差值存储会有效的缩减后续几个时间字段的列存空间。访问日志场景测试显示，开启该配置，会在损失一些排序性能的前提下缩减大概 10% 的列存空间。
* 二次压缩：默认情况下，倒排数据和列存数据依赖独特的数据结构设计本身带来的空间压缩，并不使用通用的压缩算法。如果对磁盘空间非常敏感，可以额外再做一次 zstd 分块压缩。访问日志场景测试显示，开启该配置，会在查询响应时间下降 6-8 倍 的前提下缩减大概 30%的倒排和列存空间。
* 国密加密：加密算法采用的SM4，仅当热数据入库就二次压缩的前提下，可开启国密数据加密。启用该设置后，会影响搜索和入库的速度。
* 字段删减的最早时间：早于该时间的历史索引不再执行删减操作。按需设置该时间可以避免IO崩溃的问题。
image::images/index-compression-conf.png[]
=== 远端索引
日志易支持对不同集群的搜索引擎数据进行跨集群搜索。在远端集群开放网络策略的前提下，可以在本地集群创建远端索引，指定远端索引搜索。
点击索引配置列表页右上角的"远端索引"，打开远端索引管理页。切换到"远端集群"标签，点击"新建"，在弹层中填写远端集群名称、远端租户域名、远端集群的搜索引擎 beaver_broker 模块 IP 地址和端口(模块多实例可多次填写)。注意以上配置保存以后不可更改：
image::images/beaver-index-remote-cluster.png[]
远端集群创建完以后，切换到"远端索引"标签，点击"新建"，在弹层中选择远端集群，然后再选择索引名称，填写描述。注意索引名称保存以后同样不可更改。
image::images/beaver-index-remote-index.png[]
假设远端集群名为 remote，远端索引名为 yotta，则该远端索引在搜索时，可指定为：`index=remote:yotta \*`。如需搜索远端集群上所有索引，可指定为 `index=remote:* \*`。搜索全部(本地和多个远端)集群的全部索引，可指定为 `index=*,\*:* *`。
远端索引和本地索引同样可以进行授权。
注意：如果远端集群被删除，相关索引会变成 N/A:xxx，无法正常使用。
=== 仓库管理
日志易支持处于冷阶段索引上传到S3仓库，基于S3的存储进行搜索，可通过master定义默认的仓库：default_bolb。当前还不能做到热数据直接构建到S3仓库，数据下沉时间必须大于冻结时间。
日志易提供了自定义S3仓库配置，点击索引配置列表，切换到“仓库管理”标签，点击“新建”，每个S3仓库配置都需要包含：
* 仓库自定义名称。
* 按时间切分,切分时间是必填项，开启后按天单位切分。
* 连接配置，需提供服务器地址（ip:port）,访问密钥，秘密访问密钥，是否验证SSL，默认不启用。
image::images/index-s3-storage.png[]
索引生命周期配置使用S3仓库：
只有选择“使用冷阶段”弹出数据处理策略弹窗，才可选择对象存储方式以及选择已有的S3仓库。保存索引后若切换仓库，只对下一个切分时间后的新数据生效。
image::images/index-s3-cold.png[]