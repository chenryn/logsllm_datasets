图灵社区会员 metorm 专享 尊重版权
图灵社区会员 metorm 专享 尊重版权
内 容 提 要
这是一本兼具趣味性、实用性与学习性的操作系统图书。作者从计算机的构造、汇编语言、C语言开
始解说，让读者在实践中掌握算法。在这本书的指导下，从零编写所有代码，30天后就可以制作出一个具
有窗口系统的32位多任务操作系统。
本书适合操作系统爱好者和程序设计人员阅读。
图灵程序设计丛书
30天自制操作系统
◆ 著 [日] 川合秀实
译 周自恒 李黎明 曾祥江 张文旭
责任编辑 傅志红
执行编辑 乐 馨
◆ 人民邮电出版社出版发行 北京市崇文区夕照寺街14号
邮编 100061 电子邮件 PI:EMAIL
网址 http://www.ptpress.com.cn
北京 印刷
◆ 开本：800×1000 1/16
印张：45
字数：1063千字 2012年 8 月第 1 版
印数：1 — 4 000 册 2012年 8 月北京第 1 次印刷
著作权合同登记号 图字：01-2011-6036号
ISBN 978-7-115-28796-0
定价：99.00元
读者服务热线：(010)51095186转604 印装质量热线：(010)67129223
反盗版热线：(010)67171154
图灵社区会员 metorm 专享 尊重版权
错误！文档中没有指定样式的文字。 47
1
版 权 声 明
2
30 Nichi De Dekiru OS Jisaku Nyuumon by 川合秀実
Copyright © 2006 Hidemi Kawai
All rights reserved.
Original Japanese edition Published by Mynavi Corporation.
3
This Simplified Chinese edition is published by arrangement with Mynavi Corporation.
本书中文简体字版由Mynavi Corporation授权人民邮电出版社独家出版。未经出版者书面许
可，不得以任何方式复制或抄袭本书内容。
版权所有，侵权必究。
4
5
6
14
图灵社区会员 metorm 专享 尊重版权
译 者 序 1
1
译 者 序
2
《30天自制操作系统》中文版终于和国内读者见面了。标题一出，有人说“XX天”这种标题真不靠谱，
不过，作者取这个标题，并非随随便便之举。打个比方，“30天学会核物理”看起来“假大空”，如果改
成“30天自制微型反应堆”呢？虽然可能还是太难了，但至少你知道30天之后一定能做出一个反应堆来（即
便简陋）。这本书正是属于后者：不管多简单，它都是一个真正意义上的操作系统，更何况它还真不简单，
40KB便实现了图形界面、多任务等高级功能。只要跟着作者的脚步，你也能做到。即便只是抄抄代码，也
必定有所收获。
3
这本书的定位是零基础的读者，作者甚至找了中学生来试读，语言通俗易懂，轻松幽默。作为译者，
我很喜欢这样的风格，因为可以把很多好玩的流行词汇代入进去，不会破坏原书的意境，还能让大家看起
来更有意思。从技术角度来看，这本书并没有过多地解释技术细节。作者认为，自制操作系统最终的目的
还是为了好玩。因此，想从这本书系统学习计算机原理、汇编语言、C语言等知识是不现实的，但你一定能
够获得另一种完全不同的体验。
这本书的一大特色是“从失败中学习”，每次我们为这个操作系统实现一些功能，一开始总会有一些
漏洞和缺陷，甚至根本不能工作。这些漏洞都是刻意安排的。作者花了很大篇幅来引导读者去寻找并发现 4
这些漏洞，并从中学习如何让系统变得更加完善。这种思路非常有趣，也符合实际开发过程，先苦后甜乃
是成就感和幸福感的源泉。市面上的技术类书籍，很少有这种“试错”的过程，因为这需要精心的安排，
而且占用大量的篇幅。这正是这本书的与众不同之处，也是我认为值得向大家推荐它的主要理由。
如果你是一位高手，可能会觉得这本书的内容并不是那么系统和有条理，甚至觉得做出来的操作系统
在很多方面的处理都很简陋，算不上一个实用的系统。连作者自己都说：“这本书无论在哪个方面都只有半
瓶醋。”不过，作者是在带领大家从零开始编写一个系统，而并不是以一个现成的内核（如Linux、FreeBSD）
5
为基础——后者才是目前自制系统的主流方式。然而，只有从零开始，才能真正了解系统底层是如何运作的，
对于在其他内核上构筑系统也大有裨益。另外，千万别忘了读一读最后那个叫做“这也能叫自制操作系统？
太坑爹了！”的专栏，作者早就预料到了读者的各种吐槽，看过之后，你可能就会理解作者的良苦用心了。
这本书讲到了“日文显示”，在翻译上相当纠结。由于操作系统都是底层代码，牵一发而动全身，为
了不改动原书的结构和代码，中文版在原汁原味保留原书文字的基础上，补充了一些中文显示的相关内容，
以体现两者在实现上的异同。好在基本上只要替换字库和编码方式，就可以实现中文显示，甚至比日文还
简单些。这部分补充内容是我自己写的，但我自知才疏学浅，不敢班门弄斧，如有错误或疏漏，欢迎各位 6
高手随时拍砖。此外，关于光盘中代码的注释，由于量大繁杂，恕无法翻译成中文（书中代码注释已翻译），
非常抱歉。如果发现注释为乱码，请用UltraEdit等编辑器以Shift-JIS编码打开，就可以看到正常的日文了。
最后，在这里衷心感谢其他三位译者，以及图灵公司各位编辑的共同努力，使得这本书能够最终问世，
希望所有对编写操作系统有兴趣的读者都能从中获益。
周自恒
14
2012年9月于上海
图灵社区会员 metorm 专享 尊重版权
4 关于作者
前 言
“好想编写一个操作系统呀！”笔者的朋友曾说这是所有程序员都曾经怀揣的一个梦想。说“所
有的程序员”可能有点夸张了，不过作为程序员的梦想，它至少也应该能排进前十名吧。
也许很多人觉得编写操作系统是个天方夜谭，这一定是操作系统业界的一个阴谋（笑）。他
们故意让大家相信编写操作系统是一件非常困难的事情，这样就可以高价兜售自己开发的操作系
统，而且操作系统的作者还会被顶礼膜拜。那么实际情况又怎么样呢？和别的程序相比，其实编
写操作系统并没有那么难，至少笔者的感觉是这样。
在各位读者之中，也许有人曾经挑战过操作系统的编写，但因为太难而放弃了。拥有这样经
历的人也许不会认同笔者的观点。其实你错了，你的失败并不是因为编写操作系统太难，而是因
为没有人告诉你那其实是一件很简单的事而已。
不仅是编写操作系统，任何事都是一样的。如果讲解的人认为它很难，那就不可能把它讲述
得通俗易懂，即便是同样的内容，也会讲得无比复杂。这样的讲解，肯定是很难懂的。
那么，你想不想和笔者一起再挑战一次呢？如果你曾经梦想过编写自己的操作系统，一定会
觉得乐在其中的。
可能有人会说，这本书足足有700多页，怎么会“有趣”和“简单”呢？唔，这么一说笔者
也觉得挺心虚的，不过其实也只是长了那么一点点啦。平均下来的话，每天只有大约23页的内容，
你看，也没有那么长吧？
这本书的文风非常轻松，也许你不知不觉中就会读得很快。但是这样的话可能印象不会很深，
最好还是能静下心来慢慢地读。书中所展示的程序代码和文字的说明同样重要，因此也希望大家
仔细阅读。只要注意这些，理解本书的内容就应该没有问题了。
在本书中，我们使用C语言和汇编语言来编写操作系统，不过不必担心，你可以在阅读本书
的同时来逐步学习关于这些编程语言的知识。本书在这方面写得非常仔细，如果能有人通过本书
终于把C语言中的指针给搞懂了，那笔者的目的也就达到了。即便是从这样的水平开始，30天后
你也能够编写出一个很棒的操作系统，请大家拭目以待吧！
图灵社区会员 metorm 专享 尊重版权
目 录 …… 1
目 录
第0天 着手开发之前.....................................1 4 读入10个柱面...........................................52
1 前言..............................................................1 5 着手开发操作系统.....................................54
2 何谓操作系统...............................................3 6 从启动区执行操作系统..............................55
3 开发操作系统的各种方法............................4 7 确认操作系统的执行情况..........................56
4 无知则无畏...................................................4 8 32位模式前期准备....................................57
5 如何开发操作系统.......................................6 9 开始导入C语言.........................................59
6 操作系统开发中的困难................................7 10 实现HLT（harib00j）.............................62
7 学习本书时的注意事项（重要！）...............9 第4天 C语言与画面显示的练习..............64
8 各章内容摘要.............................................11 1 用C语言实现内存写入（harib01a）........64
第1天 从计算机结构到汇编程序入门......13 2 条纹图案（harib01b）...............................67
1 先动手操作.................................................13 3 挑战指针（harib01c）...............................69
2 究竟做了些什么.........................................19 4 指针的应用（1）（harib01d）...................74
3 初次体验汇编程序.....................................22 5 指针的应用（2）（harib01e）....................74
4 加工润色.....................................................24 6 色号设定（harib01f）................................75
第2天 汇编语言学习与Makefile入门.....28 7 绘制矩形（harib01g）...............................84
1 介绍文本编辑器.........................................28 8 今天的成果（harib01h）...........................86
2 继续开发.....................................................29 第5天 结构体、文字显示与GDT/IDT
3 先制作启动区.............................................40 初始化................................................88
4 Makefile入门.............................................41 1 接收启动信息（harib02a）........................88
第3天 进入32位模式并导入C语言.......45 2 试用结构体（harib02b）...........................89
1 制作真正的IPL..........................................45 3 试用箭头记号（harib02c）........................91
2 试错............................................................50 4 显示字符（harib02d）...............................91
3 读到18扇区...............................................51 5 增加字体（harib02e）...............................94
图灵社区会员 metorm 专享 尊重版权
2 …… 目 录
6 显示字符串（harib02f）............................96 第10天 叠加处理.......................................181
7 显示变量值（harib02g）...........................97 1 内存管理（续）（harib07a）...................181
8 显示鼠标指针（harib02h）.......................99 2 叠加处理（harib07b）.............................184
9 GDT与IDT的初始化（harib02i）.........101 3 提高叠加处理速度（1）（harib07c）......194
第6天 分割编译与中断处理.....................108 4 提高叠加处理速度（2）（harib07d）......197
1 分割源文件（harib03a）.........................108 第11天 制作窗口.......................................201
2 整理Makefile（harib03b）......................109 1 鼠标显示问题（harib08a）.....................201
3 整理头文件（harib03c）.........................110 2 实现画面外的支持（harib08b）.............202
4 意犹未尽..................................................112 3 shtctl的指定省略（harib08c）................203
5 初始化PIC（harib03d）..........................115 4 显示窗口（harib08d）.............................206
6 中断处理程序的制作（harib03e）..........119 5 小实验（harib08e）.................................208
第7天 FIFO与鼠标控制...........................125 6 高速计数器（harib08f）..........................209
1 获取按键编码（hiarib04a）....................125 7 消除闪烁（1）（harib08g）.....................211
2 加快中断处理（hiarib04b）....................127 8 消除闪烁（2）（harib08h）.....................214
3 制作FIFO缓冲区（hiarib04c）..............130 第12天 定时器（1）................................220
4 改善FIFO缓冲区（hiarib04d）..............133 1 使用定时器（harib09a）.........................220
5 整理FIFO缓冲区（hiarib04e）..............135 2 计量时间（harib09b）.............................224
6 总算讲到鼠标了（harib04f）..................138 3 超时功能（harib09c）.............................225
7 从鼠标接受数据（harib04g）.................141 4 设定多个定时器（harib09d）.................228
第8天 鼠标控制与32位模式切换.........144 5 加快中断处理（1）（harib09e）..............232
1 鼠标解读（1）（harib05a）.....................144 6 加快中断处理（2）（harib09f）..............234
2 稍事整理（harib05b）.............................146 7 加快中断处理（3）（harib09g）.............236
3 鼠标解读（2）（harib05c）.....................148
第13天 定时器（2）................................240
4 移动鼠标指针（harib05d）.....................151 1 简化字符串显示（harib10a）.................240
5 通往32位模式之路.................................153
2 重新调整FIFO缓冲区（1）
第9天 内存管理..........................................162 （harib10b）..............................................241
1 整理源文件（harib06a）.........................162 3 测试性能（harib10c～harib10f）............243
2 内存容量检查（1）（harib06b）..............163 4 重新调整FIFO缓冲区（2）
（harib10g）..............................................246
3 内存容量检查（2）（harib06c）..............168
4 挑战内存管理（harib06d）.....................172 5 加快中断处理（4）（harib10h）.............253
图灵社区会员 metorm 专享 尊重版权
目 录 …… 3
6 使用“哨兵”简化程序（harib10i）.......257 7 对各种锁定键的支持（harib14g）..........346
第14天 高分辨率及键盘输入..................262 第18天 dir命令..........................................350
1 继续测试性能（harib11a～harib11c）.....262 1 控制光标闪烁（1）（harib15a）..............350
2 提高分辨率（1）（harib11d）..................266 2 控制光标闪烁（2）（harib15b）..............352
3 提高分辨率（2）（harib11e）..................269 3 对回车键的支持（harib15c）..................355
4 键盘输入（1）（harib11f）......................272 4 对窗口滚动的支持（harib15d）..............357
5 键盘输入（2）（harib11g）......................275 5 mem命令（harib15e）............................359
6 cls命令（harib15f）................................363
6 追记内容（1）（harib11h）......................277
7 dir命令（harib15g）...............................366
7 追记内容（2）（harib11i）......................279
第19天 应用程序.......................................371
第15天 多任务（1）.................................282
1 type命令（harib16a）.............................371
1 挑战任务切换（harib12a）......................282
2 type命令改良（harib16b）.....................378
2 任务切换进阶（harib12b）......................289
3 对FAT的支持（harib16c）.....................382
3 做个简单的多任务（1）（harib12c）......291
4 代码整理（harib16d）.............................387
4 做个简单的多任务（2）（harib12d）......293
5 第一个应用程序（harib16e）..................387
5 提高运行速度（harib12e）......................294
第20天 API.................................................392
6 测试运行速度（harib12f）......................297
1 程序整理（harib17a）.............................392
7 多任务进阶（harib12g）.........................299
2 显示单个字符的API（1）
第16天 多任务（2）.................................304 （harib17b）..............................................399
1 任务管理自动化（harib13a）..................304 3 显示单个字符的API（2）
（harib17c）..............................................402
2 让任务休眠（harib13b）.........................308
4 结束应用程序（harib17d）.....................403
3 增加窗口数量（harib13c）......................313
5 不随操作系统版本而改变的API
4 设定任务优先级（1）（harib13d）..........317
（harib17e）..............................................405
5 设定任务优先级（2）（harib13e）..........320 6 为应用程序自由命名（harib17f）..........408
第17天 命令行窗口...................................329 7 当心寄存器（harib17g）.........................410
1 闲置任务（harib14a）.............................329 8 用API显示字符串（harib17h）.............412
2 创建命令行窗口（harib14b）..................331
第21天 保护操作系统...............................418
3 切换输入窗口（harib14c）......................334
1 攻克难题——字符串显示API
4 实现字符输入（harib14d）......................337 （harib18a）..............................................418
5 符号的输入（harib14e）..........................341 2 用C语言编写应用程序（harib18b）......420
6 大写字母与小写字母（harib14f）...........343 3 保护操作系统（1）（harib18c）..............424
图灵社区会员 metorm 专享 尊重版权
4 …… 目 录
4 保护操作系统（2）（harib18d）..............426 7 定时器API（harib21g）.........................507
5 对异常的支持（harib18e）.....................431 8 取消定时器（harib21h）.........................511
6 保护操作系统（3）（harib18f）..............434 第25天 增加命令行窗口..........................515
7 保护操作系统（4）（harib18g）..............435 1 蜂鸣器发声（harib22a）.........................515
第22天 用C语言编写应用程序.............443 2 增加更多的颜色（1）（harib22b）..........518
1 保护操作系统（5）（harib19a）..............443 3 增加更多的颜色（2）（harib22c）..........520
2 帮助发现bug（harib19b）......................448 4 窗口初始位置（harib22d）.....................523
3 强制结束应用程序（harib19c）..............452 5 增加命令行窗口（1）（harib22e）..........524
4 用C语言显示字符串（1） 6 增加命令行窗口（2）（harib22f）..........528
（harib19d）..............................................455
7 增加命令行窗口（3）（harib22g）..........531
5 用C语言显示字符串（2） 8 增加命令行窗口（4）（harib22h）..........532
（harib19e）...............................................457
9 变得更像真正的操作系统（1）
6 显示窗口（harib19f）..............................462 （harib22i）...............................................534
7 在窗口中描绘字符和方块（harib19g）....465
10 变得更像真正的操作系统（2）
第23天 图形处理相关...............................468 （harib22j）.............................................538
1 编写malloc（harib20a）.........................468 第26天 为窗口移动提速..........................541
2 画点（harib20b）.....................................472 1 提高窗口移动速度（1）（harib23a）......541
3 刷新窗口（harib20c）.............................475 2 提高窗口移动速度（2）（harib23b）......543
4 画直线（harib20d）.................................478 3 提高窗口移动速度（3）（harib23c）......547
5 关闭窗口（harib20e）.............................483 4 提高窗口移动速度（4）（harib23d）......549
6 键盘输入API（harib20f）......................484 5 启动时只打开一个命令行窗口