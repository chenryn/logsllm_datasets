Printing is still the Stairway 
to Heaven 
A Decade After Stuxnet’s Printer Vulnerability  
LABS
Peleg Hadar Senior Security Researcher  &  Tomer Bar Research Team Lead   |
Peleg 
Hadar Senior Security Researcher
■
7+ years in InfoSec
■
Senior Security Researcher @ SafeBreach Labs
■
Main focus in Windows internals and 
vulnerability research
■
@peleghd
2
LABS
Tomer 
Bar Research Team Lead
■
15+ years in Cyber Security
■
Research Team Lead @ SafeBreach Labs
■
Main focus in APT and vulnerability research
■
Past publications:
●
Prince of Persia - Terminating 10 Years Campaign For 
Fun And Proﬁt
●
Infy Malware Active In Decade Of Targeted Attacks
●
KasperAgent and Micropsia - Targeted Attacks In The 
Middle East
●
Ride The Lightning With Foudre
●
Double Edge Sword Attack - Exploiting Quasar Rat 
Command and Control
●
BadPatch (APT-C-23)
3
LABS
4
Agenda Is Stuxnet 2.0 possible?
■
Analysis of Stuxnet’s propagation capabilities (vulnerabilities)
●
Root Cause
●
Patch
●
Re-Exploitation / Equivalent newer vulnerability in the same component
■
Our Research
●
How did we re-exploited a patched 10 years old MS Windows vulnerability
●
Demonstration of 2 unpatched 0-day vulnerabilities (Pre-coordinated with Microsoft)
■
Mitigations and Suggestions
●
Better Patch
●
Better real-time prevention for an entire bug class
Stuxnet 2.0
Patch eﬀectiveness
5
Agenda two main takeaways
Is it possible to abuse patched  
vulnerabilities?
Is it possible to re-occur?
6
Terminology
Narrow Patch
Patch
7
Stuxnet Recap & Timeline
8
Stuxnet As Seen in “0 Days”
9
Propagation Capabilities
5 Vulnerabilities
2 LPE
3 RCE
Rootkit
Stolen 
Certiﬁcate
Final 
Payload
Siemens 
Related 
Actions
Evasion Capabilities
ICS Target 
Detection
ICS Capabilities
Stuxnet Main Building Blocks
MS10-046 (LNK)
MS10-061 (Spooler)
Spooler Propagation Capabilities
10
MS06-040 (RPC)
MS10-092
(Task Scheduler)
MS10-073  (Win32k)
“Now, over 22 million pieces of malware use that blueprint to attack 
organizations and states…” -regdox.com
MS10-046 (LNK)
MS10-061 (Spooler)
Spooler Propagation Capabilities
11
      MS10-046 (LNK)
MS06-040 (RPC)
MS10-092
(Task Scheduler)
MS10-073  (Win32k)
12
LNK File
Pointer to an 
Icon Resource
CPL (DLL) File
Icon 
Resource
LoadLibrary
Malicious 
Code
LNK Stuxnet’s 0-day - Root Cause
LNK Stuxnet’s 0-day - Exploitation
Icon ID = 0
Icon Path (CPL)
wszIcon
14
LNK 0-Day Exploitation Paths Overview 
CVE-2010-2568
Payload Execution Function
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
15
LNK MS10-046 Patch 
CVE-2010-2568
Payload Execution Function
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
The patch did not modify 
this call!
IsRegisteredCPL && 
StrToIntW(wszIconId) == 0
NO
YES
Don’t Load CPL, Change 
IconID to -1
User-controlled 
input from LNK
Narrow Patch
16
LNK 0-Day Exploitation Paths Overview 
CVE-2010-2568
Payload Execution Function
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
The patch did not modify 
this call!
IsRegisteredCPL && 
StrToIntW(wszIconId) == 0
Don’t Load CPL, Change 
IconID to -1
User-controlled 
input from LNK
CVE-2015-0096
NO
YES
Narrow Patch
CVE-2015-0096 Patch Bypass
Truncated to 260 Wide Chars
554 Wide Chars
17
[ c : \ M a . d l l , -  
 1 ,AA...AAA \ 0 ]
int dwIconId = StrToIntW(L”-”)
dwIconId will be 0
[ c : \ M a . d l l , -  \ 0 ]
18
LNK 0-Day Exploitation Paths Overview 
CVE-2010-2568
Payload Execution Function
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
The patch did not modify 
this call!
IsRegisteredCPL
Don’t Load CPL
CVE-2015-0096
MS015-020
●
Buﬀer truncation issue was ﬁxed
●
StrToIntW removed
NO
YES
Narrow Patch
Narrow Patch
19
LNK 0-Day Exploitation Paths Overview 
CVE-2010-2568
CVE-2015-0096
CVE-2017-8464
Payload Execution Function
_GetPidlFromAppletId
_DecodeSpecialFolder
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
Narrow Patch
Narrow Patch
20
LNK 0-Day Exploitation Paths Overview 
CVE-2010-2568
CVE-2015-0096
CVE-2017-8464
Payload Execution Function
_GetPidlFromAppletId
_DecodeSpecialFolder
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
CVE-2017-8464 - Patch 
●
Added previous validation to 
validate if CPL is registered
Narrow Patch
Narrow Patch
21
LNK 0-Day Exploitation Paths Overview 
CVE-2010-2568
CVE-2015-0096
CVE-2017-8464
Not been 
exploited yet
_NextNonCachedCpl
Payload Execution Function
_GetPidlFromAppletId
_DecodeSpecialFolder
LoadAndFindApplet
CPL_LoadCPLModule
LoadLibraryW
The patch did not modify 
this call either!
Narrow Patch
Narrow Patch
MS10-046 (LNK)
MS06-040 (RPC)
Spooler Printing our Way to SYSTEM
22
MS10-073  (Win32k)
MS10-061 (Spooler)
MS10-092
(Task Scheduler)
      MS10-046 (LNK)
CVE-2015-0096  
(LNK)
CVE-2017-8464  
(LNK)
      MS06-040 (RPC)
RPC
http://mapscroll.blogspot.com/2009/04/mapping-conficker-worm.html
Conﬁcker HeatMap
23
2009
2006
Wide spread - The same vulnerable dll was 
exploited By Stuxnet & Conﬁcker Worm 
MSRC - 1st Vulnerability -  Limited Scope
“Very limited, targeted attacks”
As a reminder, Microsoft is aware of very limited, 
targeted attacks that exploited the vulnerability 
prior to the release of the update, but we’re not 
currently seeing broad attacks that use this 
newly posted exploit code
“
~Microsoft Security Response Center
RPC Path Canonical path
Path Canonization
absolute path:                    canonical path:
C:\xxx\..\abc\ﬁle.txt  ---->  C:\abc\ﬁle.txt
It allows textual comparison of two diﬀerent representation of the same canonical path
C:\xxx\..\abc\xxx\..\ﬁle.txt  ==  C:\xxx\..\abc\ﬁle.txt  == C:\abc\ﬁle.txt
RPC Root Cause - CVE-2006-3439
25
NetpwPathCanonicalize 
RPC request
The vulnerable function allocates 0x414 bytes of space, but  limits the length of the Path to 0x411 
Unicode chars (0x822 bytes).
netpwpathcanonicalize(
_in_ DWORD Unicode_path_ptr_second_half,  
_out_ DWORD lpwidecharstr, 
_in_ DWORD Size,,
_in_ DWORD Unicode_path_ptr_ﬁrst_half,
_in_out_ DWORD long_ptr_ptr,
_in_ DWORD ﬂag_bit  
）;
25
Client
Path 
Server Service
CVE-2006-3439 - Old school stack based buﬀer overﬂow
dce=Pex::DCERPC->new(...) 
$dce->request(handle, 0x1f, stub(including path )
RPC - Exploitation Paths Overview
CVE-2006-3439
Wcscat
NetpwPathCanonicalize
Stack OOB 
write Primitive
MS06-040 Patch 
1.
Check if path length is more than 0x207
2.
Omit the wcscat function call
27
RPC Exploitation Paths Overview
28
CVE-2006-3439
CVE-2008-4250
CVE-2006-3439
Wcscat
NetpwPathCanonicalize
NetprPathCanonicalize
Wcscpy
Stack OOB 
write Primitive
Stack OOB 
write Primitive
RPC Exploitation Paths Overview
29
https://dontstuﬀbeansupyournose.com/2008/10/23/looking-at-ms08-067/
RPC The Patch - MS08-067
CVE-2006-3439
CVE-2008-4250
CVE-2006-3439
Wcscat
NetpwPathCanonicalize
NetprPathCanonicalize
_StringCopyWorkerW
Wcscpy
Stack OOB 
write Primitive
Stack OOB 
write Primitive