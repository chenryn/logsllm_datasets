---
## Page 77
58Linux程序设计
2.5shell程序设计示例
至此、我们已经学习完shell作为程序设计语言的主要功能了。现在，我们把已经学过的知
识总结在一起，编写一个有实际用途的示范程序。
我们将利用在这本书里学到的知识逐步完成一个对CD唱盘进行管理的数据库软件。我们从
shell脚本程序开始，以后再用c语言重写遍，给它逐步加上数据库等新的功能。就说到这，我
们动手吧。
2.5.1工作求
我们来设计并编写一个管理CD唱盘的程序。假设我们收集了大量的CD唱盘。因为我们正在
学习UNIX程序设计，所以以边学边练的方式实现一个电子化的唱盘目录看起来是个很不错的好
主意
在刚开始入手的时候，我们至少应该做到能够把各张CD唱盘的基本资料保存起来，比如唱
盘的名字、音乐类型、歌唱家或作曲家的名字等。我们还想再增加一些简单的曲目资料。
我们希望能够以每张唱盘为单位对它们进行检索，对曲目方面的细节暂不考虑。
为了让这个小小的应用程序比较完整，我们还希望能够在这个应用程序里对唱盘资料进行
输人、修改和删除。
2.5.2设计
既然我们有对数据进行修改、检索和显示这三项操作要求，采用一个简单的菜单应该是很
合适的做法。我们准备保存的数据全部都是文字性的，所以如果我们收集的CD唱盘还不是太多，
就不必非使用复杂的数据库不可，有几个简单的文本文件就足可以了。把资料保存在文本文件
里将使我们的应用程序比较简单；如果我们的操作要求又有了变化，文本文件总要比其他类型
的文件更容易处理一些。至少我们可以用一个编辑器来人工输人或删除数据，不必非得编出-
个程序来。
在数据存储方面我们需要做出一个重要的设计决定：一个文件够用吗？如果够用，它应该
采用什么样的格式呢？除了曲目信息，我们想要保存的大部分资料在每张CD唱盘上只出现次
（我们暂不考虑某些CD唱盘上会有多名作曲家或歌唱家作品的情况）；面几乎所有CD唱盘都有
一个以上的曲目。
需要给CD唱盘上的曲目数量加一个上限吗？这好像是个不怎么讲理也没什么必要的限制，
所以我们还是抛开这个念头吧。
如果我们对曲目的个数不设置上限，就有以下几种做法可供选择：
·只有一个文件，里面用一行来保存“标题”信息，再用n行保存该CD唱盘上的曲目信息。
·每张CD唱盘的全部信息都保存在一行上，让这一行的长度一直延续到信息都保存完为止：
·把标题信息和曲目信息分开，分别保存在不同的文件里。
只有第三个做法能够让我们灵活修改文件的格式，面如果今后真的想把我们的数据库转换
为关系数据库形式（请参考第7章内容）的话，就肯定要对文件格式进行修改，因此我们选它作
加入iava编程群：524621833
---
## Page 78
第2章shell程序设计
59
为我们的决策。
下一个决策是要在文件里放人哪些信息。
我们决定，对每张CD唱盘，我们保存以下信息：
·CD明盘的月录编号。
·标题
·曲日风格（古典、播滚、流行、爵士等）
·作曲家或歌唱家。
对每个曲目，我们保存：
·曲目编号。
·歌名或曲名。
为了把这两个文件“结合”起来，我们需要把曲目信息与CD唱盘的其他信息挂上钩。我们
选CD唱盘的目录号来担当这一任务。因为它对每张CD唱盘来说是独一无二的，在“标题”文件
里只出现一次，在“曲目”文件里也只出现一次。
我们来看看下面这个“标题”文件（见表2-14）。
裹2-14
日录编号
标题
曲日风格
作由家
CD123
Cool sax
Iazz (士）
Bix
CD234
Classic violin
Ciassical (古典）
Bach
CD345
Hit99
Pop (流行)
Various
再看看相应的“曲目”文件（见表2-15）。
表2-15
目录编号
曲目编号
歌名或曲名
CD123
1
Soene jazz
CD123
2
More jazz
CD345
1
Dizzy
CD234
1
Sotata in D minor
文件里一般都对应着多行数据。
最后一个决策是如何分隔这些数据项。在关系数据库里，长度固定的数据域比较常见，但
有时并非最方便。另一种常见办法是用一个逗号，我们在这里就选这个办法（也就是-个变量
之间用逗号分隔的文件，按英文“comma-separatedvariable”缩写为CSV文件）。
在后面的“动手试试”部分，为了不让你找不着北，我们把将会用到的函数列在下面。
get_return()
get_confirm(1
set_mepu_choice[)
insert_title[)
add_record_tracks()
insert_track()
加入jaVva编程群：524621833
---
## Page 79
60
Linux程序设计
add_records ()
find_cd()
update_cd()
remove_records{)
count_cds (}
list_tracks(1
动手试试：CD唱盘管理程序
1）这个脚本程序示例的第一行，就像平时一样，是确保自己能够作为脚本程序执行的语句
“#！/bin/sh"，随后是一些版权信息。如下所示：
#: /bin/sh
Very sinple exaxple shell script for managing a CD collection.
#Copyright (C} 1996-99 Wrox Press.
This progran is free software; you can redistribute it and/or nodify it
Free Software Foundation: either veraion 2 of the License, or fat your
¥option) any later versicn,
This program is distributed in the hopes that it will be useful, but
WITHoUT ANY wARRANTY;without even the inplied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the GNU General
# Public License for aore details.
 You should have received a copy of the GMU General Public License alorg
with this program; if not, write Lo the Free Software Foundation. Inc.
675 Mass Ave, Cambridge, MA 02139, USA.
和“曲目”文件，还设置了一个临时文件。然后设置“Ctrl-C”键陷阱，做好脚本程序被用户中
断运行时删除临时文件的准备工作。
Benu_choice=",
current_cd=*"
tracks_filen*tracks.cdb*
title_file='title.cdb"
temp_file=/tap/cdb.$$
3）现在开始定义函数。因为脚本程序将从文件的第一行开始执行，所以这样做可以让它在
我们调用其中任何一个之前知道每个函数的定义情况。
为了避免在几个地方反复书写同样的代码，最开始的两个函数是简单的工具性函数。
get_return(}(
echo -e 'Press return \c
read x
get_confizm()(
while true
do
read x
case
Y lyes IY|Yes 1 YEs 1
'$x'in
{ON丨ONNou u
returnD;:
加入jaVa编程群：524621833
---
## Page 80
第2章shell程序设计
61
echo *Cancelled*
echo
done
esac
4）下面是主菜单函数set_menu_choice。菜单内容是动态变化的，如果用户已经选中某张CD
唱盘，主菜单里会多出几个选项。
请注意，“echo-e”命令可能不能被移植到某些shell去。
set_menu_choice{){
echo *Options :-*
clear
echo
echo
a) Add new CD*
if[*$cdcatnum*!=*]；then
echo
c) Count the CDs and tracks in the catalog*
echo *
1) List tracks on $cdtitle*
echo·
r)Remove $cdtitle*
echo.
u) Update track information for Scdtitle*
fi
echo*
QQuit*
echo
echo
=e*Please enter choice then press return 1c*
read menu_choice
5)两个很短的函数insert_title和inser_track用来往数据库文件里添加数据。虽然有的人不喜
欢这种长度只有一行的函数，可它们被用在其他函数里时会因为意义明确而便于他人理解。
这两个小函数之后是比较大的add_record_track函数，后者要用到它们。该函数用模版匹配
确保没有输人逗号（因为我们把退号用做数据域之间的分隔符），用算术操作在用户输入曲目时
递增当前曲目的编号。
insert_title(}{
echo s* >> $title_file
return
insert_track()(
echo $*>> Stracks_file
return
1
add_record_tracks(){
echo‘Enter track information for this CD*
echo *When no nore tracks enter q*
cdtrack=1
while[*$cdttitle*|=*q]
cdttitle=**
do
echo -e*Track $cdtrack,track title?\c*
read tmp
dttitle=s{tmp#,*)
1f[*Stmp*!*$cdttitle*];then
echo *Sorry. no conmas allowed*
continue
if[-n*$cdttitle*}：then
fi
if[Scdttitle！q′]:then
insert_track $cdcatnum,Scdtrack,Scdttitle
加入java编程群：524621833
---
## Page 81
62Linur程序设计
fi
else
cdtrack=s((edtrack-1))
cdtrack=S {(cdtrack+1)}
done
6)add_records函数用来输人新CD唱盘的标题信息。
add_records()(
# Prompt for the tnitial information
echo -e *&nter catalog name 1c*
read t#p
cdcatnum=S(tmpe,*}
echo e 'Enter title \c
cdtit.1e=S(tmpks, *)
read tnp
echo -e *Enter type 1c*
cdtype=s(tmpg,*)
read tmp
cdac=$(tnp, *)
read tnp
 Check that they want to enter the information
echo About to add new entry
echo *$cdcatnum Scdtitle $cdtype $cdac*
# If confirmed then append it to the titles file
if get_confirm ; then
insert_title Scdcatnum,$cdtitle.$cdtype,Scdac
else
add_record_tracks
remove_records
fi
return