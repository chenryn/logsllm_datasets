get 1 tokens: 0.188413s
get 1 tokens: 0.197811s
get 1 tokens: 0.198316s
get 1 tokens: 0.19864s
get 1 tokens: 0.199363s
get 1 tokens: 0.193997s
get 1 tokens: 0.199623s
get 1 tokens: 0.199357s
get 1 tokens: 0.195676s
```
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Guava å¹³æ»‘é¢„çƒ­é™æµçš„ Demoã€‚
```java
import com.google.common.util.concurrent.RateLimiter;
import java.util.concurrent.TimeUnit;
/**
 * å¾®ä¿¡æœ JavaGuide å›å¤"é¢è¯•çªå‡»"å³å¯å…è´¹é¢†å–ä¸ªäººåŸåˆ›çš„ Java é¢è¯•æ‰‹å†Œ
 *
 * @author Guideå“¥
 * @date 2021/10/08 19:12
 **/
public class RateLimiterDemo {
    public static void main(String[] args) {
        // 1s æ”¾ 5 ä¸ªä»¤ç‰Œåˆ°æ¡¶é‡Œä¹Ÿå°±æ˜¯ 0.2s æ”¾ 1ä¸ªä»¤ç‰Œåˆ°æ¡¶é‡Œ
        // é¢„çƒ­æ—¶é—´ä¸º3s,ä¹Ÿå°±è¯´åˆšå¼€å§‹çš„ 3s å†…å‘ç‰Œé€Ÿç‡ä¼šé€æ¸æå‡åˆ° 0.2s æ”¾ 1 ä¸ªä»¤ç‰Œåˆ°æ¡¶é‡Œ
        RateLimiter rateLimiter = RateLimiter.create(5, 3, TimeUnit.SECONDS);
        for (int i = 0; i  Bucket4j åœ°å€ï¼š
ç›¸å¯¹äºï¼ŒGuava çš„é™æµå·¥å…·ç±»æ¥è¯´ï¼ŒBucket4j æä¾›çš„é™æµåŠŸèƒ½æ›´åŠ å…¨é¢ã€‚ä¸ä»…æ”¯æŒå•æœºé™æµå’Œåˆ†å¸ƒå¼é™æµï¼Œè¿˜å¯ä»¥é›†æˆç›‘æ§ï¼Œæ­é… Prometheus å’Œ Grafana ä½¿ç”¨ã€‚
ä¸è¿‡ï¼Œæ¯•ç«Ÿ Guava ä¹Ÿåªæ˜¯ä¸€ä¸ªåŠŸèƒ½å…¨é¢çš„å·¥å…·ç±»åº“ï¼Œå…¶æä¾›çš„å¼€ç®±å³ç”¨çš„é™æµåŠŸèƒ½åœ¨å¾ˆå¤šå•æœºåœºæ™¯ä¸‹è¿˜æ˜¯æ¯”è¾ƒå®ç”¨çš„ã€‚
Spring Cloud Gateway ä¸­è‡ªå¸¦çš„å•æœºé™æµçš„æ—©æœŸç‰ˆæœ¬å°±æ˜¯åŸºäº Bucket4j å®ç°çš„ã€‚åæ¥ï¼Œæ›¿æ¢æˆäº† **Resilience4j**ã€‚
Resilience4j æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®¹é”™ç»„ä»¶ï¼Œå…¶çµæ„Ÿæ¥è‡ªäº Hystrixã€‚è‡ª[Netflix å®£å¸ƒä¸å†ç§¯æå¼€å‘ Hystrix](https://github.com/Netflix/Hystrix/commit/a7df971cbaddd8c5e976b3cc5f14013fe6ad00e6) ä¹‹åï¼ŒSpring å®˜æ–¹å’Œ Netflix éƒ½æ›´æ¨èä½¿ç”¨ Resilience4j æ¥åšé™æµç†”æ–­ã€‚
> Resilience4j åœ°å€: 
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Œé¡¹ç›®çš„é™æµå’Œç†”æ–­éƒ½æ˜¯è¦ä¸€èµ·åšçš„ã€‚
Resilience4j ä¸ä»…æä¾›é™æµï¼Œè¿˜æä¾›äº†ç†”æ–­ã€è´Ÿè½½ä¿æŠ¤ã€è‡ªåŠ¨é‡è¯•ç­‰ä¿éšœç³»ç»Ÿé«˜å¯ç”¨å¼€ç®±å³ç”¨çš„åŠŸèƒ½ã€‚å¹¶ä¸”ï¼ŒResilience4j çš„ç”Ÿæ€ä¹Ÿæ›´å¥½ï¼Œå¾ˆå¤šç½‘å…³éƒ½ä½¿ç”¨ Resilience4j æ¥åšé™æµç†”æ–­çš„ã€‚
å› æ­¤ï¼Œåœ¨ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ Resilience4j æˆ–è®¸ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¦‚æœæ˜¯ä¸€äº›æ¯”è¾ƒç®€å•çš„é™æµåœºæ™¯çš„è¯ï¼ŒGuava æˆ–è€… Bucket4j ä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚
## åˆ†å¸ƒå¼é™æµæ€ä¹ˆåšï¼Ÿ
åˆ†å¸ƒå¼é™æµé’ˆå¯¹çš„åˆ†å¸ƒå¼/å¾®æœåŠ¡åº”ç”¨æ¶æ„åº”ç”¨ï¼Œåœ¨è¿™ç§æ¶æ„ä¸‹ï¼Œå•æœºé™æµå°±ä¸é€‚ç”¨äº†ï¼Œå› ä¸ºä¼šå­˜åœ¨å¤šç§æœåŠ¡ï¼Œå¹¶ä¸”ä¸€ç§æœåŠ¡ä¹Ÿå¯èƒ½ä¼šè¢«éƒ¨ç½²å¤šä»½ã€‚
åˆ†å¸ƒå¼é™æµå¸¸è§çš„æ–¹æ¡ˆï¼š
- **å€ŸåŠ©ä¸­é—´ä»¶æ¶é™æµ**ï¼šå¯ä»¥å€ŸåŠ© Sentinel æˆ–è€…ä½¿ç”¨ Redis æ¥è‡ªå·±å®ç°å¯¹åº”çš„é™æµé€»è¾‘ã€‚
- **ç½‘å…³å±‚é™æµ**ï¼šæ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§æ–¹æ¡ˆï¼Œç›´æ¥åœ¨ç½‘å…³å±‚æŠŠé™æµç»™å®‰æ’ä¸Šäº†ã€‚ä¸è¿‡ï¼Œé€šå¸¸ç½‘å…³å±‚é™æµé€šå¸¸ä¹Ÿéœ€è¦å€ŸåŠ©åˆ°ä¸­é—´ä»¶/æ¡†æ¶ã€‚å°±æ¯”å¦‚ Spring Cloud Gateway çš„åˆ†å¸ƒå¼é™æµå®ç°`RedisRateLimiter`å°±æ˜¯åŸºäº Redis+Lua æ¥å®ç°çš„ï¼Œå†æ¯”å¦‚ Spring Cloud Gateway è¿˜å¯ä»¥æ•´åˆ Sentinel æ¥åšé™æµã€‚
å¦‚æœä½ è¦åŸºäº Redis æ¥æ‰‹åŠ¨å®ç°é™æµé€»è¾‘çš„è¯ï¼Œå»ºè®®é…åˆ Lua è„šæœ¬æ¥åšã€‚
**ä¸ºä»€ä¹ˆå»ºè®® Redis+Lua çš„æ–¹å¼ï¼Ÿ** ä¸»è¦æœ‰ä¸¤ç‚¹åŸå› ï¼š
- **å‡å°‘äº†ç½‘ç»œå¼€é”€**ï¼šæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Lua è„šæœ¬æ¥æ‰¹é‡æ‰§è¡Œå¤šæ¡ Redis å‘½ä»¤ï¼Œè¿™äº› Redis å‘½ä»¤ä¼šè¢«æäº¤åˆ° Redis æœåŠ¡å™¨ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæˆï¼Œå¤§å¹…å‡å°äº†ç½‘ç»œå¼€é”€ã€‚
- **åŸå­æ€§**ï¼šä¸€æ®µ Lua è„šæœ¬å¯ä»¥è§†ä½œä¸€æ¡å‘½ä»¤æ‰§è¡Œï¼Œä¸€æ®µ Lua è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å…¶ä»–è„šæœ¬æˆ– Redis å‘½ä»¤åŒæ—¶æ‰§è¡Œï¼Œä¿è¯äº†æ“ä½œä¸ä¼šè¢«å…¶ä»–æŒ‡ä»¤æ’å…¥æˆ–æ‰“æ‰°ã€‚
æˆ‘è¿™é‡Œå°±ä¸æ”¾å…·ä½“çš„é™æµè„šæœ¬ä»£ç äº†ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šç°æˆçš„ä¼˜ç§€çš„é™æµè„šæœ¬ä¾›ä½ å‚è€ƒï¼Œå°±æ¯”å¦‚ Apache ç½‘å…³é¡¹ç›® ShenYu çš„ RateLimiter é™æµæ’ä»¶å°±åŸºäº Redis + Lua å®ç°äº†ä»¤ç‰Œæ¡¶ç®—æ³•/å¹¶å‘ä»¤ç‰Œæ¡¶ç®—æ³•ã€æ¼æ¡¶ç®—æ³•ã€æ»‘åŠ¨çª—å£ç®—æ³•ã€‚
> ShenYu åœ°å€: 
![ShenYu é™æµè„šæœ¬](https://oss.javaguide.cn/github/javaguide/csdn/e1e2a75f489e4854990dabe3b6cec522.jpg)
å¦å¤–ï¼Œå¦‚æœä¸æƒ³è‡ªå·±å†™ Lua è„šæœ¬çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ©ç”¨ Redisson ä¸­çš„ `RRateLimiter` æ¥å®ç°åˆ†å¸ƒå¼é™æµï¼Œå…¶åº•å±‚å®ç°å°±æ˜¯åŸºäº Lua ä»£ç ã€‚
Redisson æ˜¯ä¸€ä¸ªå¼€æºçš„ Java è¯­è¨€ Redis å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ Java ä¸­å¸¸ç”¨çš„æ•°æ®ç»“æ„å®ç°ã€åˆ†å¸ƒå¼é”ã€å»¶è¿Ÿé˜Ÿåˆ—ç­‰ç­‰ã€‚å¹¶ä¸”ï¼ŒRedisson è¿˜æ”¯æŒ Redis å•æœºã€Redis Sentinelã€Redis Cluster ç­‰å¤šç§éƒ¨ç½²æ¶æ„ã€‚
`RRateLimiter` çš„ä½¿ç”¨æ–¹å¼éå¸¸ç®€å•ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦è·å–ä¸€ä¸ª`RRateLimiter`å¯¹è±¡ï¼Œç›´æ¥é€šè¿‡ Redisson å®¢æˆ·ç«¯è·å–å³å¯ã€‚ç„¶åï¼Œè®¾ç½®é™æµè§„åˆ™å°±å¥½ã€‚
```java
// åˆ›å»ºä¸€ä¸ª Redisson å®¢æˆ·ç«¯å®ä¾‹
RedissonClient redissonClient = Redisson.create();
// è·å–ä¸€ä¸ªåä¸º "javaguide.limiter" çš„é™æµå™¨å¯¹è±¡
RRateLimiter rateLimiter = redissonClient.getRateLimiter("javaguide.limiter");
// å°è¯•è®¾ç½®é™æµå™¨çš„é€Ÿç‡ä¸ºæ¯å°æ—¶ 100 æ¬¡
// RateType æœ‰ä¸¤ç§ï¼ŒOVERALLæ˜¯å…¨å±€é™æµ,ER_CLIENTæ˜¯å•Clienté™æµï¼ˆå¯ä»¥è®¤ä¸ºå°±æ˜¯å•æœºé™æµï¼‰
rateLimiter.trySetRate(RateType.OVERALL, 100, 1, RateIntervalUnit.HOURS);
```
æ¥ä¸‹æ¥æˆ‘ä»¬è°ƒç”¨`acquire()`æ–¹æ³•æˆ–`tryAcquire()`æ–¹æ³•å³å¯è·å–è®¸å¯ã€‚
```java
// è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœè¶…è¿‡é™æµå™¨çš„é€Ÿç‡åˆ™ä¼šç­‰å¾…
// acquire()æ˜¯åŒæ­¥æ–¹æ³•ï¼Œå¯¹åº”çš„å¼‚æ­¥æ–¹æ³•ï¼šacquireAsync()
rateLimiter.acquire(1);
// å°è¯•åœ¨ 5 ç§’å†…è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false
// tryAcquire()æ˜¯åŒæ­¥æ–¹æ³•ï¼Œå¯¹åº”çš„å¼‚æ­¥æ–¹æ³•ï¼štryAcquireAsync()
boolean res = rateLimiter.tryAcquire(1, 5, TimeUnit.SECONDS);
```
## æ€»ç»“
è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å¸¸è§çš„é™æµç®—æ³•ã€é™æµå¯¹è±¡çš„é€‰æ‹©ä»¥åŠå•æœºé™æµå’Œåˆ†å¸ƒå¼é™æµåˆ†åˆ«åº”è¯¥æ€ä¹ˆåšã€‚
## å‚è€ƒ
- æœåŠ¡æ²»ç†ä¹‹è½»é‡çº§ç†”æ–­æ¡†æ¶ Resilience4jï¼š
- è¶…è¯¦ç»†çš„ Guava RateLimiter é™æµåŸç†è§£æï¼š
- å®æˆ˜ Spring Cloud Gateway ä¹‹é™æµç¯‡ ğŸ‘ï¼š
- è¯¦è§£ Redisson åˆ†å¸ƒå¼é™æµçš„å®ç°åŸç†ï¼š
- ä¸€æ–‡è¯¦è§£ Java é™æµæ¥å£å®ç° - é˜¿é‡Œäº‘å¼€å‘è€…ï¼š