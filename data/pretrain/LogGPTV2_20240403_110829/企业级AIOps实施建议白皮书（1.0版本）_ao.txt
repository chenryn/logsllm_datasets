3)依赖层：内网上下游业务之间的流量转发使用百度名字服务（BNS）进行流量调度。 
	对于单机房止损场景来说，DNS 流量调度的生效时间较服务层、依赖层的流量调度生效时间要慢很多，所以我们期望在发生某个业务的局部单机房故障时，优先进行服务层、依赖层调度。提升止损时效性。 
第 70 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
图 1 百度流量接入架构
3、单机房故障自愈的常见问题和解决方案 
3.1 容量风险控制能力不足3、单机房故障自愈的常见问题和解决方案 
3.1 容量风险控制能力不足 
【问题描述】 
	传统流量调度的模式有两种：固定比例模式与容量保护模式，参考(图 11.3-2)。 
	固定比例模式：按照预先设定的固定预案，一个机房故障，该机房的流量按照预先设定的比例分配到其 他的机房。很可能某个机房的容量或剩余机房的总容量不足，切流量后导致多个机房发生故障。 
容量保护模式：流量调度执行前判断健康机房整体剩余容量是否充足，容量充足则进行流量调度，否则 不进行调度并通知人工介入处理。但此种方案面对的问题是：1. 容量 buffer 没有尽可能的利用去实施故障 止损。2.容量数据本身存在一定误差，流量成分的变化以及变更等导致的容量退化都可能导致原先容量无法 完全可信，依然有流量调度场景下容量过载风险。 
	【解决方案】 
	基于容量水位的动态均衡：在流量调度时，对于容量不准确存在的风险，我们划分两条容量警戒线。参 考（图 11.3-3）。安全水位线：流量处于在安全线以下则风险较小，可以一步进行切换。水位上限：该水位线表明服务的 最大承载能力，一旦流量超过故障水位线，很大概率会导致容量过载。如果安全水位线提供的容量不足以满 足止损，那我们期望使用上两条中间的容量 buffer，同时流量调度过程中进行分步试探，避免一次性调度压 垮服务。 
	基于快速熔断的过载保护：在流量调度时，建立快速的熔断机制作为防止服务过载的最后屏障。一旦出 现过载风险，则快速停止流量调度，降低次生故障发生的概率。 
	基于降级功能的过载保护：在流量调度前，如果已经出现对应机房的容量过载情况，则动态联动对应机 房的降级功能，实现故障的恢复。 
第 71 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
 图 2 容量过载案例                                    图 3 基于容量
水位的动态均衡水位的动态均衡 
3.2 业务线止损策略需求差异大 
	【问题描述】 
	我们实现了基础的单机房故障流量调度止损算法，但在部分业务线中仍存在较大的需求差异，比如： 	1.分步动态调度需求：业务存在充 Cache 过程中服务能力降低，需要控制切换速度。 
	2.优先级调度需求：产品对延迟敏感，止损时需要优先切到同地域机房；业务服务于多个上游，多个上游的重要程度不同，优先保证重要上游服务稳定。 
	3.容量负载计算需求：请求成分不同，不同成分请求带来的容量负载不同。这部分需求一部分与 业务强相关，不具备通用性，另一部分则存在不同产品线需求冲突的情况。 
	【解决方案】 
	针对以上问题，我们推出了故障止损流量调度策略开放框架。支持用户根据业务需求自定义策略实现。同时将较为通用的策略开放为插件，使业务线可以根据需求自由插拔策略。 
	图 4 策略分析图 4 策略分析 
	基于以上两点，结合智能运维开发框架，单机房故障自愈框架无缝支持不同业务线，使得不同业务的运 维人员可以更关注策略本身，而无需关注不同业务线运维模型、底层平台适配成本。
4、单机房故障自愈的架构 
	百度 AIOps 框架中，单机房故障自愈解决方案构建在运维知识库、运维开发框架、运维策略框架三个核 心能力之上（参考图 2）。具体过程为自愈程序搜集分散的运维对象状态数据，自动感知异常后进行决策，得出基于动态编排规划的止损操作，并通过标准化运维操作接口执行。该解决方案策略和架构解耦，并且托 管到高可用的自动化运维平台之上，实现了业务在任意单个机房故障情况下皆可自愈的效果。截至目前该方 案已覆盖百度大多数核心产品，止损效率较人工处理提升 60%以上。 
第 72 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
图 5 百度单机房故障自愈系统架构图 5 百度单机房故障自愈系统架构
	针对百度服务接入层、服务层、依赖层中监控感知、止损决策与故障止损方式的不同，将止损自动决策 拆分为外网止损自动决策与内网止损自动决策。 
	1.外网止损自动决策：覆盖接入层。基于外网、内网监控信号；触发外网止损决策器进行止损决策；执 行 DNS 流量调度止损。 
	2.内网止损自动决策：覆盖服务层、依赖层。基于内网监控、基础监控、业务监控提供的故障信号；触 发内网止损决策器进行止损决策；执行流量调度、主备切换、弹性降级等止损操作。 
基于 AIOps 的单机房故障自愈方案和传统的故障止损方案对比可参考下表。(表 11-1) 
|  | 发现  | 决策  | 执行  |
|---|---|---|---|
| 传统方案  |传统监控  1.固定阈值检测 2.误报漏报多  |人工决策  1.局部信息，依赖人工经 	验  2.决策速度慢，甚至错误 	决策，故障扩散  |分散脚本  1.代码质量差，可用性设计欠缺 2.关键时刻不可用  || 单机房故 障自愈方 案  |智能监控  1.智 能 异 常 检 测 算 	法，动态阈值生成 2.高召回率、准确率  |智能化主动决策  1.收集全局信息，基于算 	法自动决策  2.精准的快速决策，反馈 	控制  |标准执行框架  1.统一框架和运维托管  2.开发效率高，高可用执行架构  |
	表 1 传统方案和新方案对比 
5、总结 
	针对传统单机房故障止损方案中存在的问题，我们构建了基于 AIOps 的单机房故障自愈方案。该方案将 止损过程划分为统一的感知、决策、执行三个阶段，通过运维知识库解决基础数据、基础设施差异化问题，通过策略框架支持智能化异常检测、策略编排、流量调度问题，同时支持用户自定义策略需求，实现单机房 故障自愈的智能化。 
第 73 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
说明《企业级 AIOps 实施建议白皮书》V1.0 
说明 
	本文档遵循开源协议：CC BY-NC-ND 3.0，所有对本文图文的引用，请注明：来自《企业级 AIOps 实施建 议》白皮书 高效运维社区联合出品。 
如您对本白皮书有任何意见或建议，或者您也想为白皮书贡献一份力量，请联系@东辉，邮箱：PI:EMAIL，微信：bohebohe2017，微信二维码如下（加好友请注明 AIOps 白皮书）。 
第 74 页共 74 页