nmap去除指纹以及识别假端⼝开放问题 
0x00 前⾔ 
最近在研究⼯具链的组合使⽤，在⽹络端⼝扫描⽅⾯还是打算先集成⼀下nmap这种⽼牌的⼯具再
结合其他⼀些个性化⼯具来解决⼀些端⼝扫描上的需求。
这边先对nmap进⾏⼀些优化⽐如去除明显的指纹降低被识别的⻛险，其次解决⼀下因为防⽕墙策
略导致批量假端⼝开放的问题。
0x01 去除指纹的思路 
nmap等各类开源扫描器⼀般来说都会有意⽆意的引⼊⼀些请求特征。⽐如tcp请求的⼀些选项配置
与正常请求不同，⽐如包含特定关键词的payload等。针对nmap我们可以先参考⼀下先知的这篇⽂
章《如何修改nmap， 重新编译，bypass emergingthreats 的公开ids规则》，⾥⾯记录了⼀些
nmap的特征修改，作为⼀个开始是很不错的。那么我们该如何找到更多的指纹以便于去除呢？
根据先知这篇⽂章⼊⼿，我们可以把思路⼤概放在这⼏个地⽅：
1. 根据开源检测⼯具的规则集来找针对的特征并定位特征⽂件进⾏修改；
2. 在nmap等开源⼯具源码中直接全量搜索疑似的关键词⽐如Nmap；
3. 针对性的对某种请求进⾏wireshark抓包，并对这种请求与可能的正常请求进⾏⽐对看看有没
有明显的区别
⼀般来说通过从1和2点开始⼊⼿是最好的。
从开源规则集⼊⼿ 
我这边先从开源IDS的snort以及suricata的规则集开始找寻相关的特征规则。
下载规则集
打开后可以看到有⼀⼤堆规则，具体语法⾃⼰可以参考官⽅的⽂档，其实你不懂语法，⼤概看看也
能理解个⼤概。但是当我搜索nmap关键词时并没有发现规则集⾥有针对nmap的特定规则，可能是
因为这是开源社区的规则，他并没有收录nmap的识别规则。
不过，仔细查找了⼀下资料，我在emergingthreats.net的⽹站⾥找到了nmap的规则集，看起来是
专⻔收录应急规则的⽹站。
我们在⽹站⾥搜索nmap可以看到收录了32条专⻔社区规则⽤于识别nmap。通过⽐对这些规则，
我们可以像开头先知⾥的⽂章那样定位到已知的特征点并进⾏更改。
⽐如这样⼀条规则
alert http $EXTERNAL_NET any -> $HTTP_SERVERS any (msg:"ET SCAN NMAP SQL Spider 
Scan"; flow:established,to_server; content:"GET"; http_method; content:" OR 
sqlspider"; http_uri; reference:url,nmap.org/nsedoc/scripts/sql-injection.html; 
classtype:web-application-attack; sid:2013778; rev:2; metadata:created_at 
2011_10_19, updated_at 2020_04_20;)
由于规则⾥多个选项其实意味着“AND”的关系，因此我们只需要改变其中⼀个特征就⾏了。这⾥可
以看到会去匹配内容中包含“OR sqlspider”。
先搜⼀下这个是哪个⽂件⾥包含的sqlspider
进⼊ ./scripts/http-sql-injection.nse 替换sqlspider为任意字符串即可。
从明显字符串⼊⼿ 
通过⼀些规则我们可以看到，nmap等开源扫描器很喜欢⽤⾃⼰的名字做特征字符。⽐如我们搜⼀
搜Nmap，然后把⼀些没有⽤的注释什么的过滤掉看看
find . -name "*.nse" -type f | xargs grep -s "Nmap"
像这样，我们在nse脚本⾥搜带有nmap关键词的内容
在⼀堆看起来都是没有⽤的东⻄⾥，⼀眼看到了疑似特征的内容
编辑脚本定位查看
确实是特征，在请求的ua⾥写⼊了Nmap字样，因此我们把它修改成普通的UA。
替换即可。
类似的，我们可以再找找，⽐如
⼜看到个ssh探测的
⼀看就是发送tcp包，把nmap字样去掉就⾏了。
⼀般来说，只要在发送请求的函数或字段（⽐如send、useragent）⾥看到payload⾥包含特定关
键词的，这种通常就是特征，把它替换掉即可。
0x02 识别假端⼝开放问题 
我们经常会遇到⼀些⽬标存在⼀些安全策略导致端⼝扫描呈现全部开放的情况，⽐如：
Host is up (0.25s latency).
Not shown: 139 closed ports
PORT      STATE    SERVICE
21/tcp    open     ftp
22/tcp    filtered ssh
23/tcp    open     telnet
25/tcp    open     smtp
42/tcp    open     nameserver
80/tcp    open     http
81/tcp    open     hosts2-ns
110/tcp   open     pop3
135/tcp   filtered msrpc
139/tcp   filtered netbios-ssn
143/tcp   open     imap
443/tcp   open     https
445/tcp   filtered microsoft-ds
465/tcp   open     smtps
593/tcp   filtered http-rpc-epmap
631/tcp   open     ipp
993/tcp   open     imaps
995/tcp   open     pop3s
1024/tcp  open     kdm
1025/tcp  open     NFS-or-IIS
1026/tcp  open     LSA-or-nterm
1027/tcp  open     IIS
1028/tcp  open     unknown
1029/tcp  open     ms-lsa
1030/tcp  open     iad1
1031/tcp  open     iad2
1032/tcp  open     iad3
1033/tcp  open     netinfo
1034/tcp  open     zincite-a
1035/tcp  open     multidropper
1036/tcp  open     nsstp
1037/tcp  open     ams
1038/tcp  open     mtqp
1039/tcp  open     sbl
1040/tcp  open     netsaint
1041/tcp  open     danf-ak2
1042/tcp  open     afrog
1043/tcp  open     boinc
1044/tcp  open     dcutility
1045/tcp  open     fpitp
1046/tcp  open     wfremotertm
1047/tcp  open     neod1
1048/tcp  open     neod2
1049/tcp  open     td-postman
1050/tcp  open     java-or-OTGfileshare
1051/tcp  open     optima-vnet
1052/tcp  open     ddt
1053/tcp  open     remote-as
1054/tcp  open     brvread
1055/tcp  open     ansyslmd
1056/tcp  open     vfo
1057/tcp  open     startron
1058/tcp  open     nim
1059/tcp  open     nimreg
1060/tcp  open     polestar
1061/tcp  open     kiosk
1062/tcp  open     veracity
1063/tcp  open     kyoceranetdev
1064/tcp  open     jstel
1065/tcp  open     syscomlan
1066/tcp  open     fpo-fns
1067/tcp  open     instl_boots
1068/tcp  open     instl_bootc
1069/tcp  open     cognex-insight
1070/tcp  open     gmrupdateserv
1071/tcp  open     bsquare-voip
1072/tcp  open     cardax
1073/tcp  open     bridgecontrol
1074/tcp  open     warmspotMgmt
1075/tcp  open     rdrmshc
1076/tcp  open     sns_credit
1077/tcp  open     imgames
1078/tcp  open     avocent-proxy
1079/tcp  open     asprovatalk
1080/tcp  open     socks
1081/tcp  open     pvuniwien
1082/tcp  open     amt-esd-prot
1083/tcp  open     ansoft-lm-1
1084/tcp  open     ansoft-lm-2
1085/tcp  open     webobjects
1086/tcp  open     cplscrambler-lg
1087/tcp  open     cplscrambler-in
1088/tcp  open     cplscrambler-al
1089/tcp  open     ff-annunc
1090/tcp  open     ff-fms
1091/tcp  open     ff-sm
1092/tcp  open     obrpd
1093/tcp  open     proofd
1094/tcp  open     rootd
1095/tcp  open     nicelink
1096/tcp  open     cnrprotocol
1097/tcp  open     sunclustermgr
1098/tcp  open     rmiactivation
1099/tcp  open     rmiregistry
1100/tcp  open     mctp
1102/tcp  open     adobeserver-1