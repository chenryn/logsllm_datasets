11.2.1
当单个文件的体型十分巨大，客户端数量更多时，条带化GlusterFS 卷已无法满足需要，
分布式条带化GlusterFS卷（DistributedStriped GlusterfsVolume）被用来处理体型十分巨
在开始 GlusterFS 安装之前，建议将系统升级至最新，最新的软件可以减少软件 Bug、提
GlusterFS有扩展性强、高可靠性、高性能等诸多优点，同时又有红帽公司的大力支持，
5.分布式条带化GlusterFS卷
当GlusterFS 被用来存储一些较大的文件时，如果仅保存在某个服务器上，当客户端较多
条带化GlusterFS 卷和分布式条带化GlusterFS 卷，此处不再费述。
由于本书并没有涉及大文件方面的内容，读者可阅读其官方网站的相关说明了解更多关于
GlusterFS安装
GlusterFS部署和应用
图11.10分布式条带化GlusterFS卷
99
File1
口
Vstrlined
Distributed Volume
89
server2
Fite2
Votrined
第11章GlusterFS存储
315
---
## Page 328
用网络同步时钟的方法。网络同步时钟使用命令ntpdate，如【示例11-2】所示。
通信带来麻烦，进而导致集群失效。如果服务器能连接到互联网或内部的授时服务器，可以使
能会带来一些问题，因此推荐使用 hosts 文件解析。服务器名设置及hosts 文件解析如【示例
量选用性能相近的硬件配置，以避免个别服务器性能较差引发的短板效应。
器的信息如表11.1所示。
SELinux规则等，本示例将不涉及这些设置，但在生产环境中应该特别注意。
升软件的兼容性。由于GlusterFS 需要使用网络，因此还必须事先根据环境设置防火墙规则、
CentoS7系统管理与运维实战
316
localhost4.1ocaldomain4
11-1】所示。
serverl
服务器
一台服务器的设置作为示例，其他服务器仅作IP地址、域名方面的修改即可。
server3
server2
22 Jun 15:22:52 ntpdate[1989]: adjust time server 23.101.187.68 offset 0.069146
首先需要作域名方面的设置，使用DNS作为解析手段有一定的延时，这在集群环境中可
由于此处仅为演示，因此硬件等方面几乎没有特殊要求，但在生产环境中使用时，应该尽
在本例中将采用3台服务器作为示例，演示如何在CentOS7中安装GlusterFS，3台服务
[root@serverl -]# ntpdate time.windows,com
#参数time.windows.com是微软的授时服务器
【示例11-2】
另一个问题是集群内部的时间非常重要，如果服务器间的时间有误差，可能会给集群间的
2.时钟同步
172.16.45.45 server3 server3.example.com
172.16.45.44 server2
172.16.45.43server1
127.0.0.1
[root@serverl~]# cat/etc/hosts
serverl.example.com
[root@serverl~]#cat /etc/hostname
【示例11-1】
由于GlusterFS 并没有服务器与元数据等概念，因此所有服务器的设置都相同。此处仅以
1.环境设置
1ocalhost localhost.localdomain 1ocalhost6 1ocalhost6.localdomain6
server2.example.com
serverl.example.com
IP地址
172.16.45.45
172.16.45.44
172.16.45.43
表11.1
示例服务器信息
server3.example.com
server2.example.com
serverl.example.com
---
## Page 329
http://download.gluster.org/pub/gluster/glusterfs/LATEsT/CentoS/glusterfs-epel
http://download.gluster.org/pub/gluster/glusterfs/LATEsT/Centos/glusterfs-epel
的方式安装，本例将采用这种方法安装，安装过程如【示例11-4】所示。
的详尽过程，读者可以参考。由于GlusterFS 提供了yum 源，因此可以在CentOS7中使用yum
行命令“crontab-e”，会打开Vi编辑器，在其中输入【示例11-3】所示内容，保存退出即可。
connected.
sec
0608b895:NOKEY
http://dl.fedoraproject.org/pub/epe1/6/x86_64/epel-release-6-8.noarch.rpm
[1055/1055]
.repo
.repo
warning:/var/tmp/rpm-tmp.13qxVt: Header V3 RSA/SHA256 Signature, key ID
Connecting to download.gluster.org (download.gluster.org) 150.57.69.89/:80..
Resolving download.gluster.org (download.gluster.org) ... 50.57.69.89
08***/usr/sbin/ntpdate time.windows.com&>/dev/null;/usr/sbin/clock
Preparing...
2015-06-22 15:43:16(112 MB/s) -/etc/yum.repos.d/glusterfs-epel.repo′ saved
HTTP request
--2015-06-2215:43:08--
#下载源到目录/etc/yum.repos.d/
【示例11-4】
在GlusterFS的官方网站上（地址为：http://www.gluster.org/），介绍了如何安装GlusterFS
3.建立 yum仓库
#其含义为每天早上8点整执行后面的命令同步系统时间和硬件时钟
命令输出即为需要输入的内容
Retrieving
#安装支持软件包
100%[==
Length:1055 (1.0k) [text/plain]
>
[root@serverl~]# wget-P/etc/yum.repos.d/
【示例11-3】
手动使用命令同步比较麻烦，可以使用cron 自动任务调度的方法。自动任务调度时，执
sent,
200OK
===>}1,055
第11章GlusterFS存储
--.-K/s
in 0s
317
-W
---
## Page 330
318
ping 各服务器的主机名，以确保域名与IP 都已正确设置。配置集群过程如【示例11-7】所示。
如何配置GlusterFS。
11.2.2
行一次。
glusterfs-3
例11-5】所示。
glusterfs-3.7
在两台服务器上启动服务后，就可以开始配置集群了。在配置集群之前，最好使用命令
[root@serverl -]# systemctl start glusterd
首先需要在3台服务器上分别启动相应的服务，如【示例11-6】所示。
安装完成GlusterFS之后，还不能立即使用，还需要对服务进行配置。本小节将简单介绍
Loaded plugins: fastestmirror
【示例11-5】
完成之前的环境设置、设置源等步骤后，就可以开始安装GlusterFS了，其安装过程如【示
s
[root@serverl]# systemctl enable glusterd
【示例11-6】
到此，
Resolving Dependencies
*epel:mirrors.neusoft,edu.
*base: mirrors.btte.net
[root@serverl~)#
-> Processing Dependency: glusterfs-libs = 3.7.1-l.el7 for package:
#部分安装过程省略
4.安装GlusterFS
，GlusterFS的安装就已经完成了，需要说明的是安装过程需要在每台服务器上都进
配置服务和集群
7.1-1.e17.x8664
1-1.017.x8664
yum install
.cn
-y glusterfs glusterfs-fuse glusterfs-server
arget
---
## Page 331
添加磁盘到集群首先需要对磁盘分区、创建文件系统，如【示例11-8】所示。
11.2.3
#对sda分区
接下来就需要为集群添加磁盘了，需要注意的是各集群节点上的磁盘容量应该尽量相同。
State: Peer in Cluster (Connected)
Select (default p)! p
Partition type:
Command (m for help) :a
#分区方案为sda1容量为50GB
Be careful before using the write comz
#其他节点也应做相同操作
#此处仅以server2为例
【示例11-8】
从上面的示例输出中，可以看到服务和集群都已经配置完成。
Uuid:85c9bdcc-68a4-4a43-bd4c-a16a95d02c7
Hostname:
State: Peer in Cluster (Connected)
Uuid:26f40e95-935a-4445-b6e7-ea9e3fb34e2d
[root@server2 ]# fdisk /dev/sda
Hostname: server2
Number of Peers:
[root@serverl
#查看集群状态
peer probe: success.
[root@serverl ]# gluster pee)
#将节点serveri和server2加入集群
【示例11-7】
primary (0 primary,
添加磁盘到集群
extendec
2
Probe on localhost not needed
-linux 2.23.2)
exterded,
probe server3
until you decide to write them
nand
第11章GlusterFS存储
319
---
## Page 332
CentOs7系统管理与运维实战
320
data
First sector (104859648-209715199,
Select (default p):p
Partition type:
#建立第二个分区，剩余容量都分配给sda2
Partition 1 of type Linux and of size 5o GiB is set
Firstsector(2048-209715199,default2048):
#创建集群挂载点
[root@server2
#挂载sdal和sda2
#创建挂载点文件夹
meta-data=/dev/sda2
[root@server2]# mkfs.xfs
realtime =none
naming
[root@server2]# mkfs.xfs
#创建文件系统
Syncing disks.
Command (m for help):
#写入分区方案
[rootlserver2
Log
Last sector,+sectors or +size(K,M,G) (104859648-209715199,default 209715199)
rooteserver2
D
extenooc
=internal log
version 2
~1#mount
~J# mount
~1# mkdir
mkdir
re-readpartition table.
Linux and
W
default
/dev/sda2 /data/mainDc/
/dev/sdal /data/myDc/
/data/mainDC
/dev/sdal
H
sectsz=512
dev/sda2
sectsz=512
sunit=0
bsize=4096
crc=0
sectsz=512
extsz=4096
isi2e=256
C=0
1size=256
bsize=4096
bsize=4096
defau1t 104859648):
finobt=0
sunit=0 blks,lazy-count=1
swidth=0 blks.
finobt=0
blocks=13107200,
blocks=6400, version=2
agcount=4,
agcount-4,agsize=3276800 b1ks
rtextents=0
agsize=3276736 blks
imaxpct=25
---
## Page 333
茄
应该相同。
#此处创建了一个名为myDC_disk的GlusterFs卷
以上步骤需要在3台服务器上进行操作，磁盘可以不同，但建议分区方案挂载点名称等都
由于不能使用磁盘的挂载点，因此此处选择在磁盘挂载点下面新建挂载点
volume set: success
#允许172.16.45.0、24网络访间
#为磁盘访问设置权限
volume start:myDc_disk: success
[root@serverl~]# gluster volume start myDc_disk
#启动磁盘
Options Reconfigured:
Brick3:
Brick2:
Brickl:
Bricks:
Transport-type: tcp
Number of Bricks:
Status:Created
Volume ID:eb747bf6-f923-4b15-b6a7-2cbd79e33666
Type:Distribute
Volume Name:myDc disk
#查看新建卷的情况
volume create: myDc_disk: success: please start the volume to access data
>server3:/data/myDc/brick0
>server2:/data/myDc/brick0
>serverl:/data/myDc/brick0\
[root@serverl ~]# gluster volume create myDc_disk\
#在serveri上添加磁盘
[root@serverl ~]# gluster volume set myDc_disk auth.allow
[root@serverl ~]# gluster
【示例11-9】
创建完磁盘之后，就可以为集群添加磁盘了，添加过程如【示例11-9】所示。
[root@server2~]#mkdir-p/data/myDc/brickl
动后可用。
在本例中并没有将挂载信息写入/etc/fstab中，实际应用中应该写入配置文件，以便重新启
server3:/data/myDc/bricko
server2:/data/myDc/brick0
serverl:/data/myDc/brick0
volume info
第11章GlusterFS存储
172.16.45
---
## Page 334
replica 参数为 2时，需要的服务器数量至少为4台。当 replica 参数增加时，服务器数量也需
所示。
的各种模式及应用环境。在本小节中将简单介绍如何创建各种模式的GlusterFS 卷。
11.2.4添加不同模式的GlusterFS磁盘
CentOS7系统管理与运维实战
322
服务器，创建命令如【示例11-12】所示。
此处指定的是将文件分成几份存放，而不是每份大小。创建条带化GlusterFS 卷至少需要2台
要相应地增加。创建命令如【示例11-11】所示。
器数量。创建复制GlusterFS卷如【示例11-10】所示。
复制的份数。由于此数值将决定文件在不同服务器中存放的份数，因此不能大于组成卷的服务
【示例11-11】
为了应用于不同的环境，GlusterFS 定义了多种模式，在11.1.3小节中简要介绍了GlusterFS
创建条带化GlusterFS 卷时，需要指定条带化参数 stripe，与磁盘阵列中的条带化不同，
> server2:/data/myDc/brick01
>6erverl:/data/myDc/brick0
#指定文件在服务器中存放的份数为3
【示例11-10】
创建复制 GlusterFS 卷时，需要指定一个replica 参数，即指定每个文件在GlusterFS 卷中
创建GlusterFS卷时，如果不加任何参数，则默认创建分布式GlusterFS卷，如【示例11-9】
server1:/data/myDc/bricko
[root@serverl 1# gluster volume create myDc_disk stripe 2 transport
【示例11-12】
[rooteserverl ]# gluster volume
创建分布式复制GlusterFS卷同样也需要指定replica参数，由11.1.3小节中可以看出，当
由于指定的份数为3且服务器数量为3因此可以预见3台服务器中存放的文件是相同的。
server3:/data/myDc/brick0
rooteserverl
（2）复制GlusterFS 卷
（1）分布式GlusterFS卷