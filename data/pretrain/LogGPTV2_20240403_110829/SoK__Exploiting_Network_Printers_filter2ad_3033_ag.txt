# 使用专用打印服务器进行攻击缓解

此外，如果设备支持，应为PostScript的`startjob`和系统参数、PJL磁盘锁和控制面板锁以及嵌入式Web服务器设置强密码。此外，可以使用IDS/IPS来阻止恶意PJL命令。然而，需要注意的是，基于签名的方法对于提供多种代码混淆技术的PostScript来说注定会失败。

## 9. 未来研究方向与挑战

接下来我们将介绍超出打印机范畴的攻击，并提出未来的研究挑战。

### 9.1. Google Cloud Print (GCP)

2010年，Google推出了首个版本的Google Cloud Print (GCP)——一个基于Web的服务，允许不同设备通过Google注册和配置打印机。借助此服务，用户可以跳过打印机驱动程序的安装和配置步骤，直接从移动设备打印文档。在图10中，我们展示了使用GCP的协议流程。可以看到存在两种不同的情景：(1) 使用具有集成GCP支持的打印机；(2) 使用仅在内网可用且不支持GCP的USB或网络打印机。根据具体情景，存在不同的安全风险。

#### 具有GCP支持的打印机

- **注册**：具备GCP支持的打印机能够发起HTTP请求并调用GCP API以完成注册。打印机配置几乎是自动完成的。通过访问打印机设置，终端用户可以启动打印机在Google上的注册过程。结果是，打印机显示一个唯一的URL，该URL用于将新注册的打印机绑定到特定的Google账户。为此，终端用户必须在其PC或移动设备上通过浏览器访问该URL并登录Google。
- **打印任务**：注册后，终端用户可以使用GCP及其打印机。如图10a所示，协议流程如下：
  1. 首先，文件被发送到GCP服务。这可以通过移动或桌面应用程序选择云打印机来打印选定文件来触发。
  2. 在第二步中，GCP服务解释并转换接收到的文件，这些文件可能采用PostScript格式。根据API文档[29]，“GCP尝试将文档转换为打印机支持的类型”。但是，GCP无法保证转换成功。
  3. 在第三步中，文件被发送到云打印机进行打印。如果GCP生成的输出是PostScript格式，则会在此处执行可选的PostScript解释。

从安全角度来看，GCP服务和云打印机上的两个PostScript解释器都至关重要。

- **攻击GCP**：我们的目标是利用恶意文件强制GCP服务泄露内部非公开信息。在测试中，我们成功地让GCP服务解释并处理了一个PostScript文件，读取了当前解释器的版本。我们通过以下步骤实现这一目标：
  1. 向GCP发送一个包含在HTTP POST请求中的PostScript文件（内容类型设置为`application/postscript`）。
  2. 文件导致解释器读取并存储所访问的信息（在本例中是关于所使用解释器的版本和支持功能的信息），这些信息会被写入要打印的文件中。
  3. 然后，文件被传输到我们的打印机，在那里我们可以看到攻击向量的结果。

为了避免滥用或损坏，我们拒绝执行DoS攻击或尝试读取GCP上存储的文件。我们立即向Google报告了该问题，并等待安全团队的回复。

- **攻击云打印机**：类似于第5节描述并在第7节评估的攻击，攻击者可以迫使终端用户打印一个恶意构造的文件。如果文件未被GCP转换，它将在云打印机上的PostScript解释器中处理，从而允许攻击者执行攻击并直接针对云打印机。

#### 不支持GCP的打印机

当打印机不支持GCP时，Google提供了另一种方法来提供其打印服务。

- **注册**：与之前的方法相比，现在配置是在装有Google Chrome的设备上进行的，例如用户的PC。通过在浏览器中访问`chrome://devices` URL，可以选择本地安装和配置的打印机。随后，用户需要登录Google。所选设备与用户帐户的绑定是自动完成的。

在PC后台，启动了一个Chrome打印服务守护进程。该服务不断从GCP拉取打印作业并将它们转发到本地配置的打印机之一。

- **攻击终端用户的PostScript解释器**：通过分析协议流程，我们得出了以下有趣的观察：
  1. 如果PC不在线或Chrome打印服务关闭，则无法使用GCP。因此，在这种情况下，只有当PC和Chrome打印服务运行时，移动应用才能使用GCP。
  2. 存在多个PostScript解释器，分别位于GCP服务、PC和每个打印机上。
  3. 根据发送到GCP的文件和PC上安装的打印机驱动程序，可能会使用不同的PostScript解释器。

除了已经描述的攻击之外，还有一个进一步的风险组件可以评估——PC上的PostScript解释器（见图10b中的步骤4）。在我们的评估中，我们能够在步骤1中发送一个PostScript文件。由于未知原因，GCP没有转换这个文件，而是直接将其发送到了Chrome打印服务。因此，Chrome打印服务使用已安装的PostScript解释器并执行文件中的代码。在我们的概念验证攻击中，我们访问了终端用户主目录中的所有文件和文件夹，并将它们的名字包含在文件中。然后，修改后的文件被发送到打印机，我们验证了攻击的成功。结果表明，能够迫使终端用户打印恶意构造文件的攻击者可以获得存储在终端用户设备上的敏感信息。

我们评估了GCP及其对PostScript文件的处理。我们发现Google使用的是一个过时版本的PostScript处理器。我们负责任地向Google开发者披露了这个问题，他们确认了我们的发现并进行了更新。

### 9.2. 网站解释器攻击

与在GCP上发起的攻击类似，攻击者也可以对网站上可用的PostScript解释器发起攻击。典型的例子是将PostScript文件转换为其他格式的网站。因此，攻击者可以直接访问所使用的解释器。

- **PostScript到PDF转换器**：作为我们分析的一部分，我们评估了流行的将PostScript转换为PDF文件的网站，并在表7中展示了结果。在我们的评估中，我们只关注了一种概念验证攻击，该攻击列出了服务器上存储的文件并导致信息泄露。攻击的想法如下：攻击者向网站发送一个恶意构造的PostScript文件，其中包含列出文件夹中所有文件并将它们添加到生成的PDF文件中的指令。攻击者然后下载生成的PDF文件并查看攻击结果。所使用的攻击向量与打印机上的攻击向量相同，因为PostScript命令保持不变。

可以看到，十二个网站中有八个容易受到此次攻击的影响，并泄露了本地存储的文件。未来的研究应该全面评估更严重的攻击，如DoS、Server-Side-Request-Forgery以及任何能够操纵本地存储文件的攻击。一般来说，任何解释PostScript或PJL文件的系统都应该根据本文描述的攻击进行评估。

- **PDF到PostScript**：PDF是一种复杂的平台无关文档格式。它允许终端用户定义包括文本、字体、图形或交互元素的新文档。交互元素可以由HTML、XML甚至JavaScript构建块组成，从而为攻击者提供了新的能力。科学研究已经展示了可用于新攻击的PDF编程特性[14]或从PDF文件执行恶意HTTP请求的方法[57]，[14]。基于这些结果，防病毒公司试图分类和检测恶意PDF文件[11]。

另一个尚未在先前研究中深入分析的攻击向量是利用PDF到PostScript转换的攻击。这种转换通常在打印机驱动程序或类似的打印机处理实用程序中执行，然后再将PDF文件发送到打印机设备。因此，攻击者可以构造一个看似无害但实际上包含恶意PostScript命令的PDF文件。例如，Heiderich等人使用类似的方法通过恶意innerHTML突变[34]或SVG文件[33]攻击Web应用程序过滤器。

### 9.3. 3D打印机

近年来，3D打印机变得非常流行。这也使得3D打印机成为有吸引力的攻击目标和攻击工具。几位研究人员展示了如何修改设计文件（.STL文件）以包含空洞和腔体，这些可以在使用过程中破坏最终对象[12]，[64]。Song等人展示了如何使用内置智能手机传感器在设备打印时提取机密设计数据[54]。

3D打印机使用的打印机语言与第2节中描述的典型打印机语言完全不同。打印指令和设计描述通过刀具路径文件传输给3D打印机。有几种刀具路径文件格式。最普遍的格式是G-code，它在RepRap项目[6]中使用。G-code文件包含标准命令来设置特定偏移位置或移除偏移；然而，它们也可以包含用于设置加热器故障检测超时[4]或上传配置文件[5]的配置命令。这些命令可能会引起有动机的攻击者的兴趣。

由于3D打印机相对于普通打印机仍然相当昂贵，偶尔的终端用户和开发人员会使用3D打印云引擎。这些服务接受3D设计文件并将最终对象发送给终端用户。这使得3D打印机云服务成为一个有趣的攻击目标。

### 9.4. 打印机软件和固件

- **固件更新**：恶意固件更新的危险众所周知，并已在[7]，[56]中讨论。然而，与其他联网设备不同，打印机通常将固件更新作为普通的打印作业部署。这为攻击者打开了广泛的大门，因为访问打印功能通常是一个低门槛。

针对网络打印机的固件修改攻击已经在Lexmark e240n [40]、几乎所有HP打印机[21]，[22]和Canon PIXMA系列[38]中得到演示。他们所需要做的只是理解用于固件验证的专有校验和算法的工作原理。Heiland修改了Xerox设备的固件，使其能够在设备上执行任意命令——用于数字签名固件的工具和密钥本身就包含在固件中[35]。Weidenbach和Ernst改进了攻击，并表明即使是最近的Xerox打印机也容易受到攻击[63]。Costin等人讨论了大规模固件分析的方法[65]，[19]。

作为对策，供应商开始对其固件进行数字签名[49]。代码签名的安全性基于长期保守私钥的秘密。然而，仍然可能存在一些易受恶意固件攻击的打印机——要么是因为它们尚未更新，要么是因为专有校验和算法被出售为加密安全的数字签名方案。当然必须指出，如果供应商不记录其固件格式和更新例程，分析固件可能会很困难。这通常需要一些逆向工程。

为了大致了解固件部署过程，我们下载并系统地分类了前十大打印机制造商的1,400个固件文件。在分析的十个制造商中，九个使用PJL命令进行所有或至少部分固件更新过程，这是一个强烈的指标，表明更新是作为普通的打印作业部署的。剩下的制造商——京瓷——使用PRESCRIBE页面描述语言。因此，我们可以声称，在打印行业中，通过打印通道安装新固件是很常见的，并指出了一个主要的设计缺陷：数据和代码通过相同的通道传输。然而，本工作范围之外的内容是对个别制造商保护机制的合理陈述。对固件修改攻击的深入分析应该是未来工作的重点。

- **软件包**：近年来，打印机供应商...