# 一款“僵尸网络挖矿” 攻击分析
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
## 一、 背景
随着虚拟货币市场的疯狂炒作，挖矿已经成为一种额外的经济来源，越来越多的人参与其中。从2019年安全态势来看，攻击者将企业、政府和教育行业作为挖矿的主要目标，通过弱口令爆破、社会工程和钓鱼等方式对计算机进行攻击，利用他人计算机CPU和GPU的计算能力挖取虚拟货币获利，导致计算资源被耗尽严重影响本地服务正常使用。
## 二、 事件概述
最近在单位测试环境中捕获一款新型挖矿病毒样本。经溯源分析，该挖矿病毒具有蠕虫属性，攻击者利用后门去控制失陷的计算机作为“肉机”，从3个固定的Web服务器来获取攻击的目标IP和所使用的爆破字典，之后通过不断感染其他目标形成僵尸网络。挖矿攻击过程如下图2-1所示：
图2-1挖矿木马攻击流程
## 三、 载荷投递
通过分析发现，此次攻击是一次有组织的攻击，攻击手段复杂多样，利用循环嵌套的方法在第三方网站隐藏真正存放恶意软件IP地址，目前只针对Linux物理机进行攻击，如果检测为蜜罐或者路由器则自动退出。攻击者通过ssh弱口令爆破取得系统权限后，利用ftp从其C&C服务器下载Shell脚本，为后续投递攻击载荷做准备。但是失陷计算机目录未发现“.ssh3”文件，分析人员怀疑攻击者在执行完脚本之后做了自身删除操作。图3-1所示为攻击者通过ftp下载命令。
图3-1 攻击者通过ftp下载恶意Shell
图3-2是在失陷计算机发现的tddwrt7s.sh脚本，猜测该脚本是通过ftp下发，目前下发地址控制台已失效，无法进行验证。
图3-2 通过wget和curl下载恶意软件
攻击者利用wget和curl指令从七个不同的URL下载恶意软件，这些URL下载的数据包中包含了与dota.tar.gz压缩包中同样的文件，如图3-3所示。利用这些URL，脚本随机选择其中一个URL，就可以下载有效载荷解压缩并执行。登陆被感染服务器，安全分析人员发现在X13-unix.tar.gz压缩包中包含了完整的挖矿组件，解压后的dota/.rsync目录中含有大量的恶意代码。攻击者为了掩盖痕迹，将恶意代码文件伪装成了系统指令，下文对恶意代码文件用表示。
图3-3 攻击者下发的大量的相同的数据包
挖矿组件分为a、b、c三个子目录和、和脚本，主目录的脚本主要对本地系统进行清理、初始化挖矿环境并启动恶意程序；文件夹a是挖矿组件，用于查杀其他矿机、定时任务和启动挖矿程序；文件夹b中包含了用于植入攻击者的后门组件和一些Shell启动脚本；文件夹c中包含的爆破程序和脚本将失陷计算机作为肉机去感染其他弱口令机器。
## 四、 初步感染
既然已经通过ssh爆破获得本地权限，那么后续则通过一系列脚本初始化本地系统、执行挖矿、安装后门和执行爆破。结合之前目录分析，使用脚本初始化/var/tmp目录，并启动主脚本；脚本执行过程如下：
1) 清除自身挖矿进程；
2) 执行挖矿程序；
3) 本地植入后门；
4) 启动爆破工具感染其他主机形成僵尸网；
5) 设置定时任务自启；
目标主机启动之后命令会自动执行。
图4-1 init定时任务脚本
启动挖矿操作详细流程如下：
攻击者为了在挖矿计算期间独占CPU资源，通过kill杀死其他矿机并进行删除，部分代码内容如图4-2所示。
图4-2 init0清理其他矿机程序
启动脚本中包含了下一步需要执行的恶意命令，删除当前crontab文件，生成执行，代码内容如图4-3所示。
图4-3生成udp进而执行run
恶意脚本根据i686架构或x86_64架构判断当前系统环境，如图4-4所示，不同的系统环境启动不同的挖矿程序。cron和anacron功能相同，一个是32位版本，一个是64位版本，两者主要作用是执行挖矿操作，其他Shell脚本则负责清理和删除本地系统中存在的其他挖矿程序。
图4-4 判断系统环境
接下来是挖矿信息分析，挖矿病毒支持Cryptonight系列算法的币种挖矿，逆向分析发现，本次挖矿攻击使用的工具是基于XMRig
家族，编译时间戳为2019年05月03日，该样本今年才开始构建完成，如图4-5和图4-6所示。
图4-5 挖矿病毒使用注释
图4-6 编译时间及版本
根据b目录中的IRCBot遗留的主控服务器IP，在挖矿程序中，也发现了与主控服务器在同一个C段的矿池。除此之外，还存在其他两个矿池。挖矿病毒中发现三个矿池分别是5.255.86.129:80
（荷兰）、107.191.99.221:80（美国）和workforce.ignorelist.com，截止分析之前所有矿池均存活，幸运的是找到矿池的同时也发现了攻击者的钱包地址，如图4-7所示。
图4-7 矿池和钱包地址
目前，由于钱包地址被多次举报为僵尸网络，在矿池官网已经无法查看钱包详细信息，钱包也已失效，如图4-8所示。
图4-8 钱包失效
## 五、 命令与控制
攻击者一旦成功入侵计算机系统，就会想方设法通过各种方式连接到C&C服务器。命令和控制组件由一个基于perl脚本的IRCBot后门和可执行文件ps组成。IRCBot充当C&C连接到恶意IRC服务器，并且执行一些内置的命令进行反弹Shell。分析发现，可执行文件用于通过删除本地主机的.ssh文件夹并植入公钥来建立另一种持久性机制。总结而言，IRCBot作为辅助性的命令与控制，而则作为长期的后门工具。
后门初始化
命令与控制初始化由启动开始，该脚本首先解密出IRCBot（以下称rsync）工具，并随后启动ps后门。此次攻击者所使用的挖矿工具使用IRC指令进行命令和控制，通过将RSA公钥植入到本地失陷系统，以便保持长期登录。
后门植入基本过程
执行一段经过base64编码的代码，解码之后发现代码又采用了另外一种方式混淆。图5-1是run脚本执行编码的后门，下面是详细分析：
图5-1 run启动后门