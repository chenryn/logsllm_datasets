./c2lint [/path/to/my.profile]
c2lintreturnsandlogsthefollowingresultcodesforthespecifiedprofilefile:
l Aresultof0isreturnedifc2lintcompleteswithnoerrors
l Aresultof1isreturnedifc2lintcompleteswithonlywarnings
l Aresultof2isreturnedifc2lintcompleteswithonlyerrors
l Aresultof3isreturnedifc2lintcompleteswithbotherrorsandwarnings.
Thelastlinesofthec2lintoutputdisplayacountofdetectederrorsandwarnings.Nomessageis
displayedifnonearefound.Therecanbemoreerrormessagesdisplayedintheoutputthanthe
UserGuide www.helpsystems.com page:95
MalleableCommandandControl/ProfileLanguage
countrepresentsbecauseasingleerrormayproducemorethan1errormessage.Thisisthe
samepossibilityforwarningshoweverlesslikely.Forexample:
l [!]Detected1warning.
l [-]Detected3errors.
Profile Language
Thebestwaytocreateaprofileistomodifyanexistingone.Severalexampleprofilesare
availableonGithub:https://github.com/cobalt-strike/Malleable-C2-Profiles
Whenyouopenaprofile,hereiswhatyouwillsee:
# this is a comment
set global_option "value";
protocol-transaction {
set local_option "value";
client {
# customize client indicators
}
server {
# customize server indicators
}
}
Commentsbeginwitha#andgountiltheendoftheline.Thesetstatementisawaytoassigna
valuetoanoption.Profilesuse{ curlybraces}togroupstatementsandinformationtogether.
Statementsalwaysendwithasemi-colon.
Tohelpallofthismakesense,here’sapartialprofile:
http-get {
set uri "/foobar";
client {
metadata {
base64;
prepend "user=";
header "Cookie";
}
}
ThispartialprofiledefinesindicatorsforanHTTPGETtransaction.Thefirststatement,seturi,
assignstheURIthattheclientandserverwillreferenceduringthistransaction.Thisset
statementoccursoutsideoftheclientandservercodeblocksbecauseitappliestobothofthem.
TheclientblockdefinesindicatorsfortheclientthatperformsanHTTPGET.Theclient,inthis
case,isCobaltStrike’sBeaconpayload.
UserGuide www.helpsystems.com page:96
MalleableCommandandControl/ProfileLanguage
WhenCobaltStrike’sBeacon“phoneshome”itsendsmetadataaboutitselftoCobaltStrike.In
thisprofile,wehavetodefinehowthismetadataisencodedandsentwithourHTTPGET
request.
Themetadatakeywordfollowedbyagroupofstatementsspecifieshowtotransformandembed
metadataintoourHTTPGETrequest.Thegroupofstatements,followingthemetadata
keyword,iscalledadatatransform.
Step Action Data
0. Start metadata
1. base64 Base64 Encode bWV0YWRhdGE=
2. prepend "user=" Prepend String user=bWV0YWRhdGE=
3. header "Cookie" Store in Transaction
Thefirststatementinourdatatransformstatesthatwewillbase64encodeourmetadata[1].
Thesecondstatement,prepend,takesourencodedmetadataandprependsthestringuser=toit
[2].Nowourtransformedmetadatais“user=“ .base64(metadata).Thethirdstatementstateswe
willstoreourtransformedmetadataintoaclientHTTPheadercalledCookie[3].That’sit.
BothBeaconanditsserverconsumeprofiles.Here,we’vereadtheprofilefromtheperspective
oftheBeaconclient.TheBeaconserverwilltakethissameinformationandinterpretit
backwards.Let’ssayourCobaltStrikewebserverreceivesaGETrequesttotheURI/foobar.
Now,itwantstoextractmetadatafromthetransaction.
Step Action Data
0. Start
1. header "Cookie" Recover from Transaction user=bWV0YWRhdGE=
2. prepend "user=" Remove first 5 characters bWV0YWRhdGE=
3. base64 Base64 Decode metadata
Theheaderstatementwilltellourserverwheretorecoverourtransformedmetadatafrom[1].
TheHTTPservertakescaretoparseheadersfromtheHTTPclientforus.Next,weneedtodeal
withtheprependstatement.Torecovertransformeddata,weinterpretprependasremovethe
firstXcharacters[2],whereXisthelengthoftheoriginalstringweprepended.Now,allthat’s
leftistointerpretthelaststatement,base64.Weusedabase64encodefunctiontotransform
themetadatabefore.Now,weuseabase64decodetorecoverthemetadata[3].
Wewillhavetheoriginalmetadataoncetheprofileinterpreterfinishesexecutingeachofthese
inversestatements.
Data Transform Language
Adatatransformisasequenceofstatementsthattransformandtransmitdata.Thedata
transformstatementsare:
UserGuide www.helpsystems.com page:97
MalleableCommandandControl/ProfileLanguage
Statement Action Inverse
append "string" Append "string" Remove last LEN(“string”) characters
base64 Base64 Encode Base64 Decode
base64url URL-safe Base64 Encode URL-safe Base64 Decode
mask XOR mask w/ random key XOR mask w/ same random key
netbios NetBIOS Encode ‘a’ NetBIOS Decode ‘a’
netbiosu NetBIOS Encode ‘A’ NetBIOS Decode ‘A’
prepend "string" Prepend "string" Remove first LEN(“string”) characters
Adatatransformisacombinationofanynumberofthesestatements,inanyorder.Forexample,
youmaychoosetonetbiosencodethedatatotransmit,prependsomeinformation,andthen
base64encodethewholepackage.
Adatatransformalwaysendswithaterminationstatement.Youmayonlyuseonetermination
statementinatransform.ThisstatementtellsBeaconanditsserverwhereinthetransactionto
storethetransformeddata.
Therearefourterminationstatements.
Statement What
header “header” Store data in an HTTP header
parameter “key” Store data in a URI parameter
print Send data as transaction body
uri-append Append to URI
TheheaderterminationstatementstorestransformeddatainanHTTPheader.Theparameter
terminationstatementstorestransformeddatainanHTTPparameter.Thisparameterisalways
sentaspartofURI.Theprintstatementsendstransformeddatainthebodyofthetransaction.
Theprintstatementistheexpectedterminationstatementforthehttp-get.server.output,http-
post.server.output,andhttp-stager.server.outputblocks.Youmayusetheheader,parameter,
printanduri-appendterminationstatementsfortheotherblocks.
Ifyouuseaheader,parameter,oruri-appendterminationstatementonhttp-post.client.output,
Beaconwillchunkitsresponsestoareasonablelengthtofitintothispartofthetransaction.
Theseblocksandthedatatheysendaredescribedinalatersection.
Strings
Beacon’sProfileLanguageallowsyoutouse“strings”inseveralplaces.Ingeneral,stringsare
interpretedas-is.However,thereareafewspecialvaluesthatyoumayuseinastring:
UserGuide www.helpsystems.com page:98
MalleableCommandandControl/ProfileLanguage
Value Special Value
“\n” Newline character
“\r” Carriage Return
“\t” Tab character
“\u####” A unicode character
“\x##” A byte (e.g., \x41 = ‘A’)
“\\” \
Headers and Parameters
Datatransformsareanimportantpartoftheindicatorcustomizationprocess.Theyallowyouto
dressupdatathatBeaconmustsendorreceivewitheachtransaction.Youmayaddextraneous
indicatorstoeachtransactiontoo.
InanHTTPGETorPOSTrequest,theseextraneousindicatorscomeintheformofheadersor
parameters.Usetheparameterstatementwithintheclientblocktoaddanarbitraryparameter
toanHTTPGETorPOSTtransaction.
ThiscodewillforceBeacontoadd?bar=blahtothe/foobarURIwhenitmakesarequest.
http-get {
client {
parameter "bar" "blah";
UsetheheaderstatementwithintheclientorserverblockstoaddanarbitraryHTTPheaderto
theclient’srequestorserver’sresponse.Thisheaderstatementaddsanindicatortoputnetwork
securitymonitoringteamsatease.
http-get {
server {
header "X-Not-Malware" "I promise!";
TheProfileInterpreterwillInterpretyourheaderandparameterstatementsInorder.Thatsaid,
theWinINetlibrary(client)andCobaltStrikewebserverhavethefinalsayaboutwhereinthe
transactiontheseindicatorswillappear.
Options
YoumayconfigureBeacon’sdefaultsthroughtheprofilefile.Therearetwotypesofoptions:
globalandlocaloptions.TheglobaloptionschangeaglobalBeaconsetting.Localoptionsare
transactionspecific.Youmustsetlocaloptionsintherightcontext.Usethesetstatementtoset
anoption.
set "sleeptime" "1000";
Hereareafewoptions:
UserGuide www.helpsystems.com page:99
MalleableCommandandControl/ProfileLanguage
Option Context Default Changes
Value
data_jitter 0 Append random-length string (up
to data_jitter value) to http-get and
http-post server output.
headers_remove Comma-separated list of HTTP
client headers to remove from
Beacon C2
host_stage true Host payload for staging over
HTTP, HTTPS, or DNS. Required
by stagers.
jitter 0 Default jitter factor (0-99%)
pipename msagent_## Default name of pipe to use for
SMB Beacon’s peer-to- peer
communication. Each#isreplaced
witharandomhexvalue.
pipename_stager status_## Name of pipe to use for SMB
Beacon’s named pipe stager. Each#
isreplacedwitharandomhexvalue.
sample_name My Profile The name of this profile (used in
the Indicators of Compromise
report)
sleeptime 60000 Default sleep time (in milliseconds)
smb_frame_header Prepend header to SMB Beacon
messages
ssh_banner Cobalt Strike SSH client banner
4.2
ssh_pipename postex_ssh_ Name of pipe for SSH sessions.
#### Each#isreplacedwitharandomhex
value.
tasks_max_size 1048576 The maximum size (in bytes) of
task(s) and proxy data that can be
transferred through a
communication channel at a check
in
UserGuide www.helpsystems.com page:100
MalleableCommandandControl/ProfileLanguage
Option Context Default Changes
Value
tasks_proxy_max_ 921600 The maximum size (in bytes) of
size proxy data to transfer via the
communication channel at a check
in.
tasks_dns_proxy_ 71680 The maximum size (in bytes) of
max_size proxy data to transfer via the DNS
communication channel at a check
in.
tcp_frame_header Prepend header to TCP Beacon
messages
tcp_port 4444 Default TCP Beacon listen port
uri http-get, [required Transaction URI
http-post option]
uri_x86 http-stager x86 payload stage URI
uri_x64 http-stager x64 payload stage URI
useragent Internet Default User-Agent for HTTP
Explorer comms.
(Random)
verb http-get, GET, POST HTTP Verb to use for transaction
http-post
Withtheurioption,youmayspecifymultipleURIsasaspaceseparatedstring.CobaltStrike’s
webserverwillbindalloftheseURIsanditwillassignoneoftheseURIstoeachBeaconhost
whentheBeaconstageisbuilt.
Eventhoughtheuseragentoptionexists;youmayusetheheaderstatementtooverridethis
option.
Additional Considerations for the 'task_' Settings
Thetasks_max_size,tasks_proxy_max_size,andtasks_dns_proxy_max_sizeworktogetherto
createadatabuffertobetransferredtobeaconwhenacheckinoccurs.Whenthebeacon
checksinitrequestsalistoftasksandproxydatathatisreadytobetransferredtothisbeacon
anditschildren.Thedatabufferstartstofillwithtask(s)followedbyproxydatafortheparent
beacon.Thenitcontinuesthispatternforeachchildbeaconuntilnomoretasksorproxydatais
availableorthetasks_max_sizesettingwillbeexceededbythenexttaskorproxydata.
Thetasks_max_sizecontrolsthemaximumsizeinbytesadatabufferfilledwithtasksandproxy
datacanbetotransferittobeaconthroughDNS,HTTP,HTTPS,andPeer-to-Peer
communicationchannels.Mostofthetimethedefaultsarefine,howeverthereareoccasions
whenacustomtaskwillexceedthemaximumsizeandcannotbesent.Forexample,youusethe
UserGuide www.helpsystems.com page:101
MalleableCommandandControl/ProfileLanguage
execute-assemblywithanexecutablelargerthan1MBinsizeandthefollowingmessageis
displayedintheteamserverandbeaconconsoles.
[TeamServer Console]
Dropping task for 40147050! Task size of 1389584 bytes is over the max task
size limit of 1048576 bytes.
[Beacon Console]
Task size of 1389584 bytes is over the max task size limit of 1048576 bytes.
Increasingthetasks_max_sizesettingwillallowthiscustomtasktobesent.However,itwill
requirerestartingtheteamserverandgeneratingnewbeaconsasthetasks_max_sizeispatched
intotheconfigurationsettingswhenabeaconisgeneratedandcannotbemodified.Thissetting
alsoaffectshowmuchheapmemorybeaconallocatestoprocesstasks.
BestPractices:
l Determinethelargesttasksizethatwillbesenttoabeacon.Thiscanbedonethrough
testingandlookingforthemessageaboveorinvestigatingyourcustomobjects
(executables,dlls,etc)thatareusedinyourengagements.Oncethisisdeterminedadd
someextraspacetothevalue.Usingtheinformationfromtheaboveexampleuse
1572864(1.5MB)asthetasks_max_size.Thereasontohaveextraspaceisbecausea
smallertaskmayfollowthelargertasktoreadtheresponse.
l Whenthetasks_max_sizevalueisdeterminedupdatethetask_max_sizesettinginyour
profileandstarttheteamserverandgenerateyourbeaconartifactstodeployonyour
targetsystems.
l Ifyourinfrastructurerequiresbeaconsgeneratedfromotherteamserverstoconnect
witheachotherthroughPeer-to-Peercommunicationchannels,thenthissettingshould
beupdatedonallteamservers.Otherwise,abeaconwillignorearequestwhenitexceeds
itsconfiguredsize.
l IfyouareusinganExternaC2listeneranupdatewouldberequiredtosupporttasks_max_
sizelargerthanthedefaultsizeof1MB.
Whenexecutingalargetaskavoidqueueingitwithothertasks,especiallyifthisisbeing
executedonabeaconusingpeer-to-peercommunicationchannels(SMBandTCP)asitcouldbe
delayedforseveralcheckinsdependingonthenumberofalreadyqueuedtasksandproxydata
tosend.ThereasoniswhenataskisaddedithasasizeofXbyteswhichreducesthetotal
availablespaceavailableforaddingadditionaltasks.Inaddition,proxyingdatathroughabeacon
willalsoreducetheamountofavailablespaceforsendingalargetask.Whenataskisdelayed
thefollowingmessageisdisplayedintheteamserverandbeaconconsoles.
[Team Server Console]
Chunking tasks for 123! Unable to add task of 787984 bytes as it is over the
available size of 260486 bytes. 2 task(s) on hold until next checkin.
[Beacon Console]
Unable to add task of 787984 bytes as it is over the available size of 260486
bytes. 2 task(s) on hold until next checkin.
Thetasks_dns_proxy_max_size(DNSchannel)andtasks_proxy_max_size(Otherchannels)
controlsthesizeofproxydatainbytestobesenttobeacon.Bothsettingsneedtobelessthan
thetasks_max_sizesetting.Itisrecommendednottomodifythesesettingsasthedefaultsizes
arefine.Howthesesettingsworkiswhenitistimetoaddproxydatatothedatabufferfora
UserGuide www.helpsystems.com page:102
MalleableCommandandControl/HTTPStaging
parentbeaconitusesthechannelsproxy_max_sizesettingminusthecurrenttasklength,which
canbeeitherapositiveornegativevalue.Ifitisapositivevalue,thentheproxydatawillbe
addeduptothatvalue.ifitisanegativevaluetheproxydataisskippedforthischeckin.Fora
childbeacontheproxy_max_sizeistemporarilyreducedbasedontheavailabledatabufferspace
leftfromprocessingtheparentandpriorchildren.
HTTP Staging
Beaconisastagedpayload.Thismeansthepayloadisdownloadedbyastagerandinjectedinto
memory.Yourhttp-getandhttp-postindicatorswillnottakeeffectuntilBeaconisinmemoryon
yourtarget.MalleableC2’shttp-stagerblockcustomizestheHTTPstagingprocess.
http-stager {
set uri_x86 "/get32.gif";
set uri_x64 "/get64.gif";
Theuri_x86optionsetstheURItodownloadthex86payloadstage.Theuri_x64optionsetsthe
URItodownloadthex64payloadstage.
client {
parameter "id" "1234";
header "Cookie" "SomeValue";
}
Theclientkeywordunderthecontextofhttp-stagerdefinestheclientsideoftheHTTP
transaction.UsetheparameterkeywordtoaddaparametertotheURI.Usetheheaderkeyword
toaddaheadertothestager’sHTTPGETrequest.
server {
header "Content-Type" "image/gif";
output {
prepend "GIF89a";
print;
}
}
Theserverkeywordunderthecontextofhttp-stagerdefinestheserversideoftheHTTP
transaction.Theheaderkeywordaddsaserverheadertotheserver’sresponse.Theoutput
keywordundertheservercontextofhttp-stagerisadatatransformtochangethepayload
stage.Thistransformmayonlyprependandappendstringstothestage.Usetheprint
terminationstatementtoclosethisoutputblock.
A Beacon HTTP Transaction Walk-through
Toputallofthistogether,ithelpstoknowwhataBeacontransactionlookslikeandwhichdata
issentwitheachrequest.
UserGuide www.helpsystems.com page:103
MalleableCommandandControl/HTTPServerConfiguration
AtransactionstartswhenaBeaconmakesanHTTPGETrequesttoCobaltStrike’swebserver.
Atthistime,Beaconmustsendmetadatathatcontainsinformationaboutthecompromised
system.
TIP:
Sessionmetadataisanencryptedblobofdata.Withoutencoding,itisnotsuitablefor
transportinaheaderorURIparameter.Alwaysapplyabase64,base64url,ornetbios
statementtoencodeyourmetadata.
CobaltStrike’swebserverrespondstothisHTTPGETwithtasksthattheBeaconmustexecute.
Thesetasksare,initially,sentasoneencryptedbinaryblob.Youmaytransformthisinformation
withtheoutputkeywordundertheservercontextofhttp-get.
AsBeaconexecutesitstasks,itaccumulatesoutput.Afteralltasksarecomplete,Beaconchecks
ifthereisoutputtosend.Ifthereisnooutput,Beacongoestosleep.Ifthereisoutput,Beacon
initiatesanHTTPPOSTtransaction.
TheHTTPPOSTrequestmustcontainasessionidinaURIparameterorheader.CobaltStrike
usesthisinformationtoassociatetheoutputwiththerightsession.Thepostedcontentis,
initially,anencryptedbinaryblob.Youmaytransformthisinformationwiththeoutputkeyword
undertheclientcontextofhttp-post.
CobaltStrike’swebservermayrespondtoanHTTPPOSTwithanythingitlikes.Beacondoes
notconsumeorusethisinformation.YoumayspecifytheoutputofHTTPPOSTwiththeoutput
blockundertheservercontextofhttp-post.
NOTE:
Whilehttp-getusesGETbydefaultandhttp-postusesPOSTbydefault,you’renotstuck
withtheseoptions.Usetheverboptiontochangethesedefaults.There’salotofflexibility
here.
Thistablesummarizesthesekeywordsandthedatatheysend:
Request Component Block Data
http-get client metadata Session metadata
http-get server output Beacon’s tasks
http-post client id Session ID
http-post client output Beacon’s responses
http-post server output Empty
http-stager server output Encoded payload stage
HTTP Server Configuration
Thehttp-configblockhasinfluenceoverallHTTPresponsesservedbyCobaltStrike’sweb
server.Here,youmayspecifyadditionalHTTPheadersandtheHTTPheaderorder.
UserGuide www.helpsystems.com page:104
MalleableCommandandControl/HTTPServerConfiguration
http-config {
set headers "Date, Server, Content-Length, Keep-Alive,
Connection, Content-Type";
header "Server" "Apache";
header "Keep-Alive" "timeout=5, max=100";
header "Connection" "Keep-Alive”;
set trust_x_forwarded_for "true";
set block_useragents "curl*,lynx*,wget*";
}
setheaders-ThisoptionspecifiestheordertheseHTTPheadersaredeliveredinanHTTP
response.Anyheadersnotinthislistareaddedtotheend.
header-ThiskeywordaddsaheadervaluetoeachofCobaltStrike’sHTTPresponses.Ifthe
headervalueisalreadydefinedinaresponse,thisvalueisignored.
settrust_x_forwarded_for-ThisoptiondecidesifCobaltStrikeusestheX-Forwarded-ForHTTP
headertodeterminetheremoteaddressofarequest.UsethisoptionifyourCobaltStrike
serverisbehindanHTTPredirector.
block_useragentsandallow_useragents-Theseoptionsconfigurealistofuseragentsthatare
blockedorallowedwitha404response.Bydefault,requestsfromuseragentsthatstart
withcurl,lynx,orwgetareallblocked.Ifbotharespecified,block_useragentswilltake
precedenceoverallow_useragents.Theoptionvaluesupportsastringofcomma
separatedvalues.Valuessupportsimplegenerics:
Example Description