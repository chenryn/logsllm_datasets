重装上阵：Office攻击来袭
朱季峰 杨军锋
议程:
• ⼀一 2017年年Office威胁分析与回顾
• ⼆二 如何建⽴立终端Office威胁防护机制
• 三 2017年年Office ITW 0day原因分析
• 四 关于2018年年Office威胁趋势的预测
2017年年Office威胁分析与回顾
• Case study 1：定向攻击中使⽤用Office作为攻击武器器
• 样本⾸首现时间：2016-12-26
• 攻击跨度时间：2016-12-27 ～ 2017-02
• 事件背景：北北约-俄罗斯理理事会举⾏行行年年内第三次⼤大使级会议，2016-12-19⽇日
• 攻击事件信息披露露：《Matryoshka Doll Reconnaissance Framework》by Cisco/Talos
Research Team ， 2017-01-27
2017年年Office威胁分析与回顾
• Case study 1：定向攻击中使⽤用Office作为攻击武器器
2017年年Office威胁分析与回顾
• Case study 1：定向攻击中使⽤用Office作为攻击武器器
•
（RTF）Archives->
•
OLE Stream 0 ->
•
Documents ->
•
Objects(Shockwave.Flash)
•
RootEntry
•
\3Objectinfo
•
\3OCXNAME
•
\Contents
2017年年Office威胁分析与回顾
• Case study 1：定向攻击中使⽤用Office作为攻击武器器
•
（RTF）Archives->
•
…
•
\Contents
•
1
2
3
3
2017年年Office威胁分析与回顾
• Case study 1：定向攻击中使⽤用Office作为攻击武器器
•
（RTF）\Contents
•
Init(…)
4
Onload(…)
5
expLoaded(…)
PayLoaded(…)
6
7
根据目标系统，
下载对应的漏洞
利用代码，否则
退出。
真实攻击代
码与前期信
息采集分离
2017年年Office威胁分析与回顾
• Case study 2：CVE-2017-0199/CVE-2017-8570
• 样本⾸首现时间：～2017-04-07前
• 攻击跨度时间：2017-04-07 ～ ⾄至今
• 事件背景：1 逻辑漏漏洞洞，2 CVE-2017-0199包含2个漏漏洞洞，3 2017 Pwnie Awards for best
client-side bugs
• 攻击事件信息披露露：《Critical Office Zero-Day Attacks Detected in the Wild 》by
McAfee Labs,2017-04-07
2017年年Office威胁分析与回顾
• Case study 2：CVE-2017-0199／CVE-2017-8570
• （RTF）Archives->
•
OLE Stream 0 ->
•
Documents ->
•
Object （URL Moniker）
Svchost.exe
Mshta.exe
Malicious script
1
2
1
3
4
2017年年Office威胁分析与回顾
• Case study 3：CVE-2017-8759-Microsoft .NET Framework 漏漏洞洞
• 样本⾸首现时间：~2017-09-12
• 攻击跨度时间：2017-09-12 ～ ⾄至今
• 攻击事件信息披露露：《 FireEye Uncovers CVE-2017-8759: Zero-Day Used in the Wild 
to Distribute FINSPY 》by FireEye/Threat Research,2017-09-12ƒß
2017年年Office威胁分析与回顾
• Case study 3：CVE-2017-8759-Microsoft .NET Framework 漏漏洞洞
• RTF）Archives->
•
OLE Stream 0 ->
•
Documents ->
•
Object(soap moniker)
.net SOAP WSDL parser
1
2
Framework\??\csc.exe
http100localhost180800exploit4txt.dll
3
4
2017年年Office威胁分析与回顾
• Case study 3：CVE-2017-8759-Microsoft .NET Framework 漏漏洞洞
.net SOAP WSDL parser
1
2
Framework\??\csc.exe
http100localhost180800exploit4txt.dll
3
4
Soap 
monikier
Malicious
XML
编译完的dll被加载到winword.exe进程，
通过命令，利用mshta执行指定的恶
意脚本文件
Winword.exe
5
2017年年Office威胁分析与回顾
• Case study 4：CVE-2017-0261/CVE-2017-0262-EPS UAF漏漏洞洞
• 样本⾸首现时间：~2017-05-09
• 攻击跨度时间：2017-05-09 ～ ⾄至今
• 攻击事件信息披露露：《 EPS Processing Zero-Days Exploited by Multiple Threat 
Actors 》by FireEye/Threat Research,2017-05-09
2017年年Office威胁分析与回顾
• Case study 4：CVE-2017-0261/CVE-2017-0262-EPS UAF漏漏洞洞
• 2015-09-08 CVE-2015-2545
(Unclear)
• 2015-12-16 Variant of CVE-2015-2545 (Unclear)
• 2017-03    CVE-2017-0261           
(Turla )
• 2017-04    CVE-2017-0262            
(APT-28 )
• 所有⽬目前已知的EPS漏漏洞洞，均与forall操作符相关
• 在>=Office 2010，微软将Graphics Filters的解析都放到了了独⽴立的沙盒地址fltldr.exe中，
EMET默认不不保护fltldr.exe
2017年年Office威胁分析与回顾
• CVE-2015-2545
/aDictZ 3 dict def
aDictZ begin
/keyZ1 11 array def
/keyZ2 12 array def
aDictZ end
aDictZ
{
aDictZ /keyZ2 undef
} forall
Syntax:
dict key undef
-
Remove key and its value from dict
2017年年Office威胁分析与回顾
• CVE-2015-2545 变种
/aDictZ 3 dict def
aDictZ begin
/keyZ1 1000 array def
/keyZ2 10000 array def
aDictZ end
/aDictY 1 dict def
aDictY begin
/keyZ1 200 array def
aDictY end
aDictZ
{
aDictY aDictZ copy
} forall
Syntax:
dict1 dict2 copy
dict2
Copy contents of dict1 to dict2
2017年年Office威胁分析与回顾
• CVE-2017-0261
/i 0 def
/snapshot save def
/uaf_str 80 string def