SAP End-User
Back-End SAP ABAP 
System
Attacker
“SAP Gui Scripts” - Prevention
• If your organization is lucky enough to not need SAP Gui scripts, you could disable this functionality by 
making sure that the sapgui/user_scripting profile parameter is set to FALSE
• As we mention before, most organizations cannot afford disabling SAP Gui scripts, but fear not, there is a 
valid workaround! 
• Leave the SAP Gui scripts enable and configure the script/user_scripting_per_user parameter to TRUE, 
then, just assign the authorization object S_SCR with value 16 to (only) the users that are allowed to use 
this functionality
YOU GOT EMAIL!
“SAP Gui Scripts” - Prevention
• Also, at the client level, make sure you select the “Notify when a script attaches to SAP GUI” option, to 
get a warning from the SAP GUI whenever a scripts tries to be executed 
YOU GOT EMAIL!
“Ransomware and the weaponization of weaknesses”
CHAPTER 04
WEAPONIZATION
&
PREVENTION
WEAPONIZATION
“The Ransomware Approach”
• One of our recurrent thoughts after having the complete picture of the SAPs that were exposed to the 
Internet was “If a ransomware hits the SAP systems exposed to the Internet, the results would be 
catastrophic” 
• We wanted to help, but before we could recommend some countermeasures, we needed to think how 
an attacker could try to take over these assets…. (in SAP, that is no easy tasks)
• By studying past ransomwares, we discovered that most of them shared some “personality traits”
• They were designed to hit hard
• Quick lateral movement was gold
• Avoiding “making noise” was not a priority
• Open to “weaponize” (aka reutilize) previously reported 
vulnerabilities
WEAPONIZATION
“The Ransomware Approach” - Scenario
DMZ
INTERNAL
NETWORK
Front-End SAP Java
Back-End SAP ABAP
Attacker
WEAPONIZATION
“The Ransomware Approach”
• The hypothetical malware will be divided in 5 phases
• Each action / stage will be complemented with the technical attack / technique and the respective 
countermeasure
• The full Ransomware / Malware wont be distributed for obvious reasons ;-) but we will show some code!
Stage
Action
Intrusion
Remote Command Execution via SAP Java Invoker Servlet
Credential Gathering
Decrypting SAP Secure Storage
Lateral Movement Around DMZ
SSH / Password Guessing / Brute-force via RFC
DMZ Escape / Lateral Movement Around Adjacent Network
Credential Reutilization using SOAPRFC / Master Password
Ransom & Expansion
Encrypt all the things!!! And bonus!
WEAPONIZATION
“The Ransomware Approach” - Intrusion
• As other malwares like WannaCry, we will use a previously reported vulnerability and just weaponize the 
publicly available exploit. This makes sense as many sophisticated attackers already have “malware 
frameworks”, they just need a silver bullet and some vulnerable victims
• Per our network diagram, on the first phase, we are going to take over the front-end SAP system that is 
located inside the DMZ
• The exploit that we are going to use will allow us to execute operating system commands under the 
privileges of the operating system user that is running the SAP system. This vulnerability is due to a 
combination of a default misconfiguration and a security vulnerability in SAP
• Modern versions of SAP are not vulnerable to this exploit, but according to our research, finding a 
vulnerable systems is easy enough (almost 3 out of 10!!!!)
PREVENTION
“The Ransomware Approach” - Countermeasures
• To prevent the abuse of the InvokerServlet and the unauthenticated command execution, SAP Notes 
1445998, 1589525 and 1624450 must be implemented on the affected assets
• After the SAP security notes have been implemented, you need to be sure that the Invoker Servlet 
functionality is globally disabled. For that, use the SAP Java config-tool or open the Netweaver 
administrator webpage (nwa), go to Server Configurations, locate the servlet_jsp option and make sure
EnableInvokerServletGlobally is set to False
• WARNING !!! There is a known issue / bug in SAP that will prevent old versions to start after 
implementing this fix. Please read SAP Note 1467771, before disabling the InvokerServlet
• Unfortunately, changes will only take effect once you restart your SAP systems
WEAPONIZATION
“The Ransomware Approach” – Getting some creds!
• Once the ransomware’s target has been breached, the first thing that it needs to do is lateral movement
• The easiest way to extract credentials from a SAP Java system is by opening an encrypted file called 
SAP J2EE Secure Storage
• In the SAP Java systems, the secure storage is an encrypted container that lays on the file-system. This 
container is encrypted using 3-DES, a hardcoded key and an user key phrase which is defined at the 
installation time
• The container holds the SAP’s database password and depending on the version, the SAP Java 
administrator password (which is usually the same one, aka Master Password)
• The container is extremely trivial to decrypt ……..
PREVENTION
“The Ransomware Approach” – Countermeasures
• Access to the SAP J2EE Secure Storage must be protected at all cost!
• Files: 
Should only be accessible by the SAP’s operating system user, local administrators and global admins
• Our selected encryption key phrase must be different from the SAP master password
• The password for the SAP Administrator must be different from the SAP database user
• /usr/sap//SYS/global/security/data/SecStore.properties,
• /usr/sap//SYS/global/security/data/SecStore.key
WEAPONIZATION
“The Ransomware Approach” - Scenario
DMZ
INTERNAL
NETWORK
Front-End SAP Java
Back-End SAP ABAP
Attacker
WEAPONIZATION
“The Ransomware Approach” – Getting some creds!
• The ransomware now has the ability to execute operating system commands under the privileges of the 
user running the SAP system, has full access to the local database and some important credentials for an 
eventual brute force
• But this is not all….. In order to connect to other SAP systems of “different stacks” the SAP Java systems 
have a mechanism called JCO Destinations, these destinations might contain sensitive data such as client, 
username and password for remote systems (inside or outside the DMZ)
• Finally, we should always test if the passwords that we got so far correspond to the SAP Master 
Password. We could do this via SSH or SMB
WEAPONIZATION
“The Ransomware Approach” – Master Password!
• At the installation time, SAP will ask the user if he / she wants to assign a different password for the 
most important SAP accounts or use a Master Password
• By default, the installer suggests the implementation of a Master Password
• If the Master Password is selected, the most powerful SAP users like SAP*, DDIC, the SAP’s database 
user and the SAP OS administrator and the SAP OS service user will all share the same password
• 95% of the surveyed companies use the SAP Master Password mechanism
• If one password is compromised ….
“A Screen that no one wants to see on their SAPs”
THE FINAL RESULT
PREVENTION
“The Ransomware Approach” – Countermeasures
• In order to protect your RFC destinations, first ask yourself the following question, do I have a real 
business need to create an RFC destination with hardcoded credentials?
• If the answer is “Yes” because you need to interact with a poorly designed interface (quite common on 
the SAP world) the least privileged approach must be follow
• Avoid the utilization of an SAP Master Password, each key account must have its own password, with 
such be in compliance to your local password policy
• Review your firewall strategy, how are you connecting your SAP systems on the DMZ and from the 
DMZ to the adjacent network. Allow traffic to ONLY the services that you require and nothing else
WEAPONIZATION
“The Ransomware Approach” - Scenario
DMZ
INTERNAL
NETWORK
Front-End SAP Java
Back-End SAP ABAP
Attacker
WEAPONIZATION
“The Ransomware Approach” – Bonus Track
• Now is time to leave the DMZ!. One of the most notable characteristics of SAP is that it has been born 
to be interconnected
• We can safely assume that the RFC and the ICM ports will be accepting connections from the already 
compromised SAP systems on the DMZ
• The malware will attack the ICM services on the adjacent network by trying to reutilize the obtained 
credentials. The attack will target a particularly vulnerable service called SOAPRFC
• The malware will send fake messages from the SAP servers on the adjacent network to all the end-users 
(human beings) pretending to be the SAP administrators
• The users will receive a pop-up saying that a new SAP add-on MUST be installed and if they do not 
proceed with the installation, they will “disrupt the SAP system”
P O W E R P O I N T  T E M P L A T E
WHAT DID WE 
LEARN TODAY?
A Few Take-Aways …
• Always ask yourself, do I really need to expose my SAP system to the internet? If the answer is yes, you 
must ONLY expose the bare minimum
• Use an SAP Web-dispatcher to restrict access to ALL the webpages that are not required by the business
• Your Internet facing SAP systems must be patched! follow SAP’s security notes release cycle! (New 
patches are available the second Tuesday of each month)
• Do not forget about the audit trails! They will be invaluable in case the worst happens
• Make sure your SOC is “SAP Aware”
• And finally….. Prevent, Prevent, Prevent, conduct penetration testings regularly, distrust default 
configurations and always use the least privileged approach when in doubt! It will pay-off in the future!
WRAPPING-UP
THAT IS ALL…
QUESTIONS?
To find out more about SAP, visit us at 
https://vicxer.com or follow us on Twitter
@ J S A N T A R S I E R I
@ V I C X E R S E C U R I T Y