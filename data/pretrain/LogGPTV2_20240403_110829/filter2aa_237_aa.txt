### 报告初稿完成时间：2017 年 1 月 13 日 16:00
### 首次发布时间：2017 年 1 月 16 日 10:00
### 本版本更新时间：2017 年 1 月 25 日 14:30

# 方程式组织 EQUATION DRUG 平台解析
——方程式组织系列分析报告之四
安天安全研究与应急处理中心（Antiy CERT）

## 目录
1. 本版本更新小语
2. 背景
3. 方程式线索曝光和分析成果时间链梳理
4. DanderSpritz 攻击平台
5. 部分组件与插件分析（继续完善中）
   5.1 PROCESSINFO 插件遍历进程模块
   5.2 KILL_IMPLANT 插件杀进程模块
   5.3 GROK 键盘与剪贴板记录器驱动
6. 小结
附录一：参考资料
附录二：关于安天

## 1. 本版本更新小语
在之前发布的报告基础上，安天增加了对方程式组织主机作业模块的积木图。该图初步展示了将主机情报作业“原子化”拆分后的模块组合拼装。尽管目前的分析只覆盖了这些模块的一小部分，但安天CERT已细化了对部分模块的分析。

数日前，安天CERT发布了一份暂时称为“提纲”的未完成分析结果。这并非因为期望“速战速决”，而是希望获得更多的建议和批评。幸运的是，在上一版本发布后，业内专家提供了中肯而尖锐的批评，使安天意识到在面对2007~2008年的攻击模块集合时，分析小组再次陷入了与当年分析“火焰”时类似的迷茫。

这些庞杂的模块如同拼图碎片，每一张图上都有有意义的图案，但如果逐一跟进，这些图案会组成一个巨大的迷宫。迷宫之所以让人迷惑，并非因为处处是死路，而是因为看起来处处有出口，但所有的砖块都无法给进入者足够的提示。此时，最大的期待不仅是一支笔可以在走过的地方做标记，更希望插上双翼俯瞰迷宫全貌。这是一种提升分析方法论的自我期待，尽管当下我们身无双翼，但或许可以练就一点灵犀。

目前，安天的积木还原工作刚刚起步，能够在春节前发布新版分析报告，安天感到些许欣慰。网络安全需要永远保持警惕和勤奋，即使在烟花升腾、鞭炮响起的时刻，仍需紧盯反汇编代码和威胁态势。

感谢业内专家同仁的关注和支持，感谢安天客户对安天产品和服务的信任。祝大家新春快乐！

## 2. 背景
在过去两年中，安天已连续发布了三篇关于方程式组织的分析报告：
- 在《修改硬盘固件的木马——探索方程式（EQUATION）组织的攻击组件》[1]中，安天分析了多个模块及其写入硬盘固件的机理。
- 在《方程式（EQUATION）部分组件中的加密技巧分析》[2]中，破解了攻击组件中的加密方式。
- 在《从“方程式”到“方程组”——EQUATION 攻击组织高级恶意代码的全平台能力解析》[3]中，独家提供了方程式在Linux和Solaris系统中的样本分析，这是业内首次正式证实这些“恶灵”存在的公开分析。

APT分析成果与研发反APT产品一样，需要基于充分的基础积累。对于方程式这样的超级攻击组织，安天过去所做的具体分析工作都是盲人摸象的过程。一旦飘忽的线索落入已摸索过的范围，就可以迅速发布储备成果；如果面对的是未曾充分探查的区域，则需要更长时间展开分析工作。因此，与此前发布的三篇长篇报告相比，本篇报告目前的版本依然比较仓促，故称之为“提纲”，旨在抛砖引玉，邀请更多团队共同加入分析工作，以进一步呈现其全貌。

本篇展现的分析工作围绕2017年1月12日“影子经纪人”放出的Equation Group组件中的61个文件[4]展开。经分析，这些文件包含Equation Group组件和DanderSpritZ（RAT）工具的一些插件。DanderSpritZ是NSA的间谍工具之一，在1月7日“影子经纪人”放出的Windows攻击工具[5]中也包含了大量DanderSpritZ的插件名称。

EquationDrug是一个复杂的模块，存活时间近十年，后来被GrayFish升级替代。从EquationDrug到GrayFish是攻击平台级别的恶意代码体系，具有安装与卸载插件功能。本次“影子经纪人”放出的文件中，安天CERT看到了更多的EquationDrug组件中的插件。通过分析比对发现，这些插件版本较低，但其中包含了一些此前未曾被业内捕获到的模块。

## 3. 方程式线索曝光和分析成果时间链梳理
自2013年起，安天逐步发现存在一个拥有全平台载荷攻击能力的攻击组织，并逐步关联分析了其多个平台的样本。在这个过程中，安天感到一个大至无形的超级攻击组织的存在，但并未找到其攻击背景。

2015年2月，卡巴斯基实验室曝光了一个名为方程式（Equation Group）[6]的攻击组织，引发了全球关注。卡巴斯基认为该组织已活跃近20年，可能是世界上最复杂的APT攻击组织之一，并认为该组织是震网（Stuxnet）和火焰（Flame）病毒幕后的操纵者。经过线索比对，安天发现这正是此前一直跟踪的超级攻击组织，决定通过报告公开其针对硬盘固件作业的原理[1]和已破解的部分加密算法[2]，形成了安天对于方程式系列分析的前两篇报告。

2015年3月，卡巴斯基实验室发布了基于Equation Drug组件或平台的剖析[7]。Equation Drug是方程式组织所用的主要间谍组件或平台之一，最早可追溯到2001年，并且一直沿用至今。该组件或平台的架构类似于一个具有内核模式和用户模式的微型操作系统，通过自定义接口进行交互。该组件或平台包括驱动程序、平台内核（协调器）和若干插件，其中一些插件配备独特的ID和版本号，用于定义相关功能等。

2016年8月，一个自称“影子经纪人”（The Shadow Brokers）的个人（或组织）声称入侵了网络间谍组织方程式（Equation）[8]，并以100万比特币（当时约价值为5.6亿美元）的价格，公开“拍卖”所掌握的方程式组织的攻击工具。方程式组织被认为与NSA存在联系。为证明成功入侵的真实性，“影子经纪人”于当月13日在开源项目托管平台GitHub加密发布了这些攻击工具，并有意将其中的少量攻击工具以明文形式发布。

2016年8月，卡巴斯基实验室通过对方程式组织与“影子经纪人”曝光的数据进行对比验证[9]，确认了曝光的数据与方程式组织有关。2016年10月，“影子经纪人”对攻击工具再度发起拍卖[10]，并称在GitHub发布的方程式攻击工具只占其掌握的60%。

2016年11月，“影子经纪人”公开了一份遭受入侵的服务器清单[11]，并称攻击方与NSA有关。清单的日期显示，各系统遭受入侵的时间是在2000年至2010年之间，受控IP及域名分布在49个国家，主要集中于亚太地区，受影响的国家包括中国、日本、韩国、西班牙、德国、印度等。安天将这些数据导入到安天态势感知和预警平台，形成了下图的可视化展现。

在“影子经纪人”的爆料中，提及的相关服务器可能是Linux、FreeBSD和Solaris。而在2016年上半年的两次技术会议中，安天明确说明，方程式有针对多个系统平台的样本，其中包括Linux和Solaris。安天最终于2016年11月5日公开了方程式组织针对Linux和Solaris的部分样本载荷的分析报告（安天方程式系列报告之三）[3]。

### 图 3-1 安天态势感知与监控预警平台：方程式组织对全球互联网节点的入侵可视化复现

安天分析团队小组对方程式的上述信息进行了梳理，整理出方程式事件曝光和相关分析的时间链。

### 图 3-2 方程式事件相关信息曝光和厂商分析的时间链

## 4. DanderSpritz 攻击平台
安天通过对本次泄露的文件以及对以往方程式资料的分析发现，方程式组织的“EquationDrug”平台与泄露文件中提到的“DanderSpritz”具有一定内在联系：

1. 本次泄露的msgkd.ex_、msgki.ex_、msgks.ex_、msgku.ex_为GROK插件，是“DanderSpritz”的插件或模块。该插件在“EquationDrug”平台中也曾出现，通过分析发现本次泄露的GROK为低版本GROK插件。
2. 本次曝光的各类DLL插件中的一处数据为插件ID，插件ID都是以0x79开头，如：0x79A4、0x79D8。同样，“EquationDrug”平台的插件也设有内置ID，“EquationDrug”平台的插件ID为0x80开头，且两个平台的插件导出函数参数的数据结构也存在相似之处。

因此，基本可以认为方程式组织使用的“EquationDrug”攻击平台与“DanderSpritz”使用了相同的架构设计，两者可能是不同的版本代号，或至少来自同一开发团队或资源高度共享的团队。

---

©安天版权所有，欢迎无损转载