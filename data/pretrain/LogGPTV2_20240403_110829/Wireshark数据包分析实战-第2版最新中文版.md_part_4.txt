计算机A
路由器。
网络A上的计算机希望与网络B上的计算机进行通信，传输数据将必须通过
布局形式。在这个例子中，两个单独的网络通过一个路由器进行连接。如果
广播数据包能够到达的区域被称为“广播域”，也就是任意计算机可以不用经由
网络中，广播IP地址是192.168.0.255。
在一个配置了192.168.0.XXX的IP范围，以及子网掩码是255.255.255.0的地址
播到整个网段。第3层也有一些特定的广播地址。
FF:FF:FF:FF:FF:FF是保留的广播地址，任何发送到这一地址上的流量将会被厂
第2层广播流量和第3层广播流量两种主要形式。例如，在第2层，MAC地址
线器还是交换机上。但并非所有的广播流量都是以相同方式构建的，而是包括
决定着这一类的数据包该如何通过网络硬件进行处理。
一直从一个交换机被中继到另一交换机上，从而传输到网络连接的所有网段上。
广播数据包会被发送到一个网段上的所有端口，而无论这些端口连接在集
图1-10计算机A通过路由器将数据传送到计算机X的通信流示意图
在通过多个集线器或交换机连接多种媒介的大型网络中，广播数据包将被
在一个IP网络范围中最大的IP地址是被保留作为广播地址使用的。例如，
网络流量可以分为三大类：广播、多播和单播。每个分类都具有不同特点，
计算机D
计算机B
网络A
计算机C
路由器
计算机
第1章数据包分析技术与网络基础15
计算机Z
计算机W
网络B
---
## Page 37
1.3.2
1.3.3
16Wireshark数据包分析实战（第2版）
多播流量
数据包只能在它特定的广播域中传输。
接交流的方式，而不是在你的家门口大喊大叫（广播）。
的声音。而如果你想与不同街道上的人说话，那么你需要找到一种与他进行直
域想象成一条街道。如果你站在你家门口叫喊，
单播流量
协议的实现细节。
流量。
多播是一种将单一来源数据包同时传输给多个目标的通信方式。多播的目
我们前面的类比也能很好地说明广播域是如何工作的。你可以将一个广播
图1-11一个广播域一直延伸到路由器后面的网段
广播城
路由器
只有街道上的人才能够听到你
广播城
---
## Page 38
1.4小结
将基于这些概念，来讨论更高级的网络通信准则。
网络故障问题之前，你必须明白网络通信到底是怎么回事。在下一章中，我们
Web服务器开始。这种类型的通信就是单播流量的典型例子。
这便是一个端到端的连接，所以通信过程将由客户端设备发送数据包到这台
本章涵盖了你学习数据包分析技术所必须掌握的基础知识。在你开始解决
第1章数据包分析技术与网络基础17
---
## Page 39
是哪些硬件设备。
对网络流量的处理方式都不相同，因此你必须非常清楚你所分析的网络使用的
为一种典型的情况。由于网络上的3种主要设备（集线器、交换机、路由器）
数据包噢探器，要比实际分析数据包更难一些。
脑连入网络中那么的简单。事实上，在有些时候，在网络布线系统上放置一个
安置噢探器的挑战是要考虑到种类繁多的用来连接网络的硬件设备。图2-1
包噢探器安置在网络上恰当物理位置的过程。
常把这个过程称为监听网络线路。简而言之，这是将数据
数据包噢探器，以恰当地捕提网络数据。数据包分析师通
监听网络线路
然而遗憾的是，噢探数据包并不像是将一台笔记本电
进行高效的数据包分析的一个关键决策是在哪里放置
第
---
## Page 40
12
20
混杂模式
Wireshark数据包分析实战（第2版）
包的。
器。首先，让我们来看看，我们实际上是如何看到网络线路上所有传递的数据
路数据包的驱动模式。
模式是什么样的模式呢？实际上它是一种允许网卡能够查看到所有流经网络线
域中的每个设备，然后期望正确的客户端做出回应。
脑都处理和回应ARP广播包，那网络的性能将变得非常的糟糕。
任何用处，
本章的目标是帮助你理解如何在各种不同网络拓扑结构中安置数据包探
你需要一个支持混杂模式驱动的网卡，才可能在网络上噢探数据包。混杂
图2-1将噢探器安置在你的网络上，有时是你面对的最大挑战
数据包噢探器
口
---
## Page 41
2.2
注意
注意
在集线器连接的网络中进行嗅探
式的网卡与操作系统。只有在你只想看到发往你运行噢探软件主机MAC地址的
到混杂模式上（我们将在第3章里介绍更多的libpcap/WinPcap的内容）。
WinPcap驱动，这让你能够很方便地在Wireshark软件界面上就将网卡直接切换
数据包噢探软件捕获并进行分析。
而无论数据包的目的地址是什么。
杂模式下工作，网卡将会把每一个它所看到的数据包都传递给主机的处理器，
电脑的网络通信，你所需要做的所有事情就是将数据包噢探器连接到集线器的
会被发送到每一个集线器连接的端口。因此，要想分析一台连接到集线器上的
这些权限，那你就不应该在这台系统上对所在网络进行任何方式的数据包噢探
你就必须要提升用户权限到管理员级别。如果你不能在一个系统上合法地获得
网络数据包的时候，你才不需要以混杂模式来进行噢探。
器中能够看到通信流量的主机范围。
网络的可视范围是不受限制的。
其他接入集线器的任意电脑之间的通信。
一个梦想。正如你在第1章中了解到的那样，流经集线器的所有网络数据包都
一个数据包，这样我们才不用担心会丢失掉任何关键的信息。
如图2-2所示，当你的噢探器连接到一个集线器连接的网络后，你对本地
我们可以使用网卡的混杂模式来确保能够捕获所有的网络流量。一旦在混
在大多数操作系统（包括Windows）上，要想使用一个混杂模式的网卡，
为了能够学习本书中的数据包分析技术，你必须要有一个支持使用混杂模
现在的网卡一般都支持混杂模式，
在使用集线器连接的网络中进行噢探，对于任何数据包分析师来说，都是
一旦数据包到达CPU之后，它就可以被一个
Wireshark软件包中也包含了libpcap
第2章监听网络线路
21
---
## Page 42
22Wireshark数据包分析实战（第2版）
用交换机了。
唤探器
图2-2在集线器网络中嗅探将提供一个不受限制的可视范围
图2-3
当集线器网络上两个设备在同一时间通信时产生的碰撞
可视范围
计这机
计算机B
计算机A
口
计算机C
集线器
冲突
计算机E
计算机D
计机瘩
计算机F
---
## Page 43
2.3.1端口镜像
在交换式网络中进行噢探
端口镜像、集线器接出（hubbingout）、
及由你自己电脑传输与接收的数据包，如图2-4所示。
因素。当你将噢探器连接到交换机上的一个端口时，你将只能看到广播数据包。
收数据。
外的，
类型。它们为通过广播、单播与多播方式传输数据提供了高效的方法。额
的所有流量，你只需要简单地将你的噢探分析器接入4号端口，然后将3号端
及有一个空闲的端口，让你可以插入你的噢探器。
目标设备所连接的交换机。此外，这个交换机还必须支持端口镜像的功能，
单的方法。为了使用端口镜像，你必须能够通过命令行或Web管理界面来访问
而这对数据包分析师来说是不幸的，交换机给数据包噢探带来了一些复杂
正如第1章中所讨论的，交换机是在现在网络环境中最常见的连接设备
要启用端口镜像，你需要发出一个命令，来强制交换机将一个端口上的所
端口镜像，也许是在交换式网络中捕获一个目标设备所有的网络通信最简
在一个交换式网络中从一个目标设备捕获网络流量的基本方法有如下4种：
一些交换机还允许全双工通讯，也就是说，设备可以同时发送和接
图2-4交换式网络上的可视范围仅限于你所接入的端口
噢探器
可视范围
计算机B
计算机A
计算机C
、使用网络分流器、
计算机E
口
计算机D
计算机F
第2章监听网络线路23
ARP欺编攻击。
---
## Page 44
注意
24Wireshark数据包分析实战（第2版）
络流量。图2-5显示了端口镜像的原理。
到一些通用的端口镜像命令。
机，你需要登录到命令行界面，然后输入端口镜像命令。你可以在表2-1中找
一种通过图形化界面可以高效配置端口镜像的方法，那么你也可以使用。
或多个设备的网络通信时可能是非常有用的。
丢失，甚至网络速度变慢。
设置端口镜像的具体方法取决于不同的交换机制造商。对于大多数的交换
不要让这种情况在你的网络中发生。
可视范围
计家机的口
图2-5端口镜像可以让你在交换式网络上扩大可视范围
噢探器
计算机B
计算机A
计算机C
计算机E
计算机D
计算机F
---
## Page 45
2.3.2
集线器输出
找齐了硬件之后，就可以按照如下操作步骤进行连接。
决方案。为了进行集线器输出，你所需要的就是一个集线器和几根网线。当你
镜像但仍对目标设备接入的交换机有着物理访问的时候，真的是一个完美的解
接插入到一个集线器上。
这种技巧，你需要将目标设备和分析系统分段到同一网络段中，然后把它们直
析器可以捕获到这些数据包，如图2-6所示。
从你的目标设备流入流出的网络流量都将在集线器中广播，从而让你的噢探分
北电
凯创
思科
制造商
表2-1用于启用端口镜像的命令
现在你已经将目标设备和你的噢探分析器连接到了同一个广播域中，所有
许多人认为集线器输出根本就是一种作方法，但是它在你不能进行端口
1.找到目标设备所连接的交换机，并将目标设备连接网线从交换机上拔掉。
另一种在交换式网络中捕获目标设备通信流量的方式是集线器输出。使用
图2-6将你的目标设备通过集线器输出，与唤探分析器连接在一起
4.从你的集线器连接一根网线到交换机上，将集线器连接到网络上。
3
将目标设备的网线插入到你的集线器上。
使用另一根网线，将你的噢探分析器也连接到集线器上。
计算机B
探器
可视范围
集线器
port-mirroringmodemirror-port
set span
命令
计算机
口
计算机C
计算机E
口
计算机D
第2章监听网络线路25
计算机F
---
## Page 46
注意
2.3.3
OR
使用网络分流器
连接，而某些情况下你却很难找到。
找到“真正的”集线器
否则如果碰巧这位用户是公司CEO，你就惨了。
的集线器，你将只会看到你自己的流量，而不是目标设备的流量。
级别的交换机当做集线器进行出售。如果你使用的并不是一个可信的经过测试
不是虚假标记的交换机。有几家网络硬件厂商有着营销的坏习惯，会把一些低
的最好方法，就是连上两台电脑，然后看这两台电脑是否能噢探对方与网
线器。如果是的话，它绝对值得你收藏！确定一个设备是否真的是集线器
可能从市面上买到真正的集线器了。所以你需要设法来找到一个。
线器。
当你找到一个集线器时，你需要对它进行测试，来确保它确实是一个集
错误标识成集线器的情况。
作为友情提示，在拔掉用户的设备时，你应该事先给用户一个善意的提醒，
当进行集线器输出时，你需要确保你使用的设备是一个真正的集线器，而
择，也适用于使用网络分流器与集线器输出的对比上。
一个很好的
---
## Page 47
探器就能够捕获到你接入网络分流器的所有流入流出的网络流量。
插入到你作为噢探器使用的电脑上。
到网络交换机。
流量，你只需要按照如下步骤进行操作。
来对双向通信进行噢探。
不需要插入一个电源插座就可以进行短暂的数据包噢探。
有3个端口。
在于：非聚合的网络分流器有4个端口，如图2-7所示，而聚合分流器则只
安置在两个设备之间，来噢探所有流经的网络通信。它们之间最基本的区别
而是使用一个专门为了网络分析而设计的特殊硬件。
放置一个硬件以捕获你需要的数据包。所不同的是，这次你并不是使用集线器，
·聚合的网络分流器
为了使用聚合的网络分流器来捕获一台接入交换机的电脑流入流出的所有
聚合网络分流器的连接应该如图2-8所示的那样，一旦连好之后，你的噢
4.将最后一根网线的一端插入网络分流器的“monitor”端口，并将另一端
网络分流器又分为两种基本类型：聚合的和非聚合的。这两种分流器都
3.将另一根网线的一端插入到网络分流器的“out”端口，并将另一端插入
聚合的网络分流器的使用方法是最简单的。它只有一个物理的流量监听口，
1.从交换机上拔下目标电脑的网线。
网络分流器通常还需要一个电源连接，但也有一些是带电池的，它们可以
将连接目标电脑网线的另一端插入到网络分流器的“im”端口中。
图2-7一款Barracuda的非聚合网络分流器
第2章监听网络线路27
---
## Page 48
28
Wireshark数据包分析实战（第2版）
探流出方向的网络流量（从电脑到分流器端口的方向），另一个监听端口是用米
量不同的是，非聚合的网络分流器有着两个监听端口。
着更好的灵活性。与聚合网络分流器仅仅只有一个监听端口来噢探双向通信流
噢探流入方向的网络流量（从分流器端口到电脑的方向）。
如下步骤进行配置。
到你作为噢探器使用的电脑的一块网卡接口上。
入到网络交换机上。
非聚合的网络分流器比起聚合的稍微复杂一些，但它在进行流量捕获时有
非聚合的网络分流器
入到你作为噢探器使用的电脑的第二块网卡接口上。
·选择一款网络分流器
1.从交换机上拔下电脑连接网线。
非聚合网络分流器的连接方式如图2-9所示。
.将电脑连接网线的另一端插入到网络分流器的“in”端口上。
图2-8使用聚合的网络分流器来噢探网络流量
计算机
聚合的网络分流器
嗅探器
监听
交换机
一个监听端口是用来噢
---
## Page 49
2.3.4
ARP欺骗
时，必须要通过已知的第3层IP地址来进行查询，这样才可能通过交换机将流
型的第2层上工作，它们只认识第2层上的MAC地址，因此网络设备必须在它
网络上的所有设备相互通信时在第3层上均使用IP地址。由于交换机在OSI模
层寻址方案时，都会与之协同工作。
的两种主要方式。这些第2层地址，或称为MAC地址，在无论你使用哪种第3
详细介绍ARP协议，但在这里会进行简要解释，以帮助了解这种技术是如何工
有很多其他非常不错的选择。