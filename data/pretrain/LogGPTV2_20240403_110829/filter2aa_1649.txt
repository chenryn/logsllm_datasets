以蓝军视⻆跟踪和分析CANVAS攻击框架泄露事件
全⽂共2605字，阅读⼤约需要5分钟。
3⽉3⽇，绿盟科技研究团队在对⽹络安全事件舆情监控中发现著名的商业渗透框架CANVAS系统源代码发⽣泄露，
绿盟科技M01N蓝军研究团队第⼀时间对该事件进⾏了跟踪，快速分析了CANVAS的攻击框架、所涉及的漏洞和技
术细节。
Immunity CANVAS是⼀套受信任的商业安全评估攻击框架，每⽉都会发布稳定版本，它允许专业⼈员进⾏渗透测
试和对⼿模拟攻击。此次CANVAS的泄露版本为7.26，⽇期为2020年9⽉，包含1000+个漏洞利⽤代码。使⽤
CANVAS成功攻陷系统后，攻击者可以抓取屏幕截图，转储密码凭据，操纵⽬标⽂件系统并提升特权，并且可以在
⽬标系统和⽬标整个⽹络区域之间隐蔽连接。另外值得注意的是，其中包含Spectre CPU漏洞的可⽤EXP漏洞利⽤
模块。
CANVAS由Immunity开发，该公司由前NSA⿊客Dave Aitel创⽴，然后于2019年出售给CyxteraTechnologies。
1
CANVAS的框架及主体功能
CANVAS框架主体及模块均使⽤python开发，⽀持跨平台安装使⽤，包括Windows, Linux和MacOSX等, 提供了
GUI和命令⾏来进⾏操作使⽤。框架所有功能模块如下：
绿盟君
绿盟科技 昨天
CANVAS主要以漏洞利⽤为主，其功能完整⽀持攻击链⽣命周期，包括C&C、权限提升、权限维持、凭证获取、横
向移动、防御规避、信息收集、隐蔽隧道及部分域林攻击功能。框架设计以资产节点⽅式进⾏攻击过程控制和记
录，各节点的远程及本地攻击操作具备完善的攻击⽇志记录。
远程漏洞利⽤、横向移动及C&C功能复现：
成功执⾏DCSync在测试环境获取AD靶机⽤户的密码Hash：
同时CANVAS作为⼀款成熟的商业安全评估攻击框架，具有⾃动化⽣成安全评估报告的功能，并且报告拥有良好的
可阅读性。
2
漏洞利⽤模块
1
漏洞利⽤模块分析
本次泄漏的CANVAS框架源码，除⾃带漏洞利⽤模块外还包含两⼤第三⽅漏洞利⽤模块。经统计，含有CVE编号的
漏洞共计929个，框架⾃带漏洞利⽤库中包括617个漏洞，第三⽅漏洞利⽤库包含333个漏洞，官⽹上针对⼯控设备
的漏洞利⽤包Gleg在本次泄漏中未涉及。
这些漏洞模块在CANVAS中根据利⽤⽬的⼤致分为四类，分别针对不同的攻击场景与⽬标。
2 第⼀个针对Spectre CPU漏洞的可利⽤EXP
⾸先我们回顾⼀下CVE-2017-5715 Spectre CPU漏洞，该漏洞是Intel、AMD和ARM处理器体系结构中的硬件设计
缺陷，它允许运⾏在同⼀系统上的不良应⽤程序中的代码破坏不同应⽤程序的CPU级别之间的隔离，然后从其他应
⽤程序中窃取敏感数据。它和Meltdown漏洞的发现，被认为是现代CPU演进和历史上的⾥程碑，有效地迫使了
CPU供应商重新考虑他们设计处理器的⽅法，从⽽明确表明他们不能只专注于性能，⽽损害了数据安全性。
Spectre漏洞从2017年被公开开始，研究⼈员对外公开的均为⽆害的POC代码，也⼀直没有发现有被在野攻击利⽤
的证据。
2021年2⽉，国外安全研究员Voisin发现VirusTotal上的⼀份Linux Spectre漏洞EXP代码，可以转储/etc/shadow的
内容，⽽近⽇在Dave Aitel的⼀条推⽂中，前Immunity⾸席执⾏官似乎证实了Voisin的发现确实是他的前公司在
2018年2⽉⼤⼒宣传的CANVAS Spectre模块。
当然我们也确认了本次泄露的CANVAS版本确实含有Spectre漏洞EXP插件及代码，代码备注该EXP代码实现在
2018年3⽉完成。
3
其他重要功能模块
1 MOSDEF后⻔⽊⻢
MOSDEF后⻔⽊⻢是CANVAS在命令控制环节的主要模块，其⽀持主流操作系统，对于⼀些较冷⻔的处理器架构亦
有较完善的⽀持。
以防御规避技术研究与攻击检测的视⻆来看，MOSDEF具有基本的杀软规避功能，⽀持采⽤DNS等⽐较隐蔽的通信
⽅式，具有⼀定防御规避的能⼒。其采⽤的持久化技术等较为常⻅，所⽣成的payload类型并不多，但其⽣成的⼀
些载荷⽂件在VirusTotal等平台仍具有较好的免杀效果。
根据VirusTotal检测结果，默认⽣成的Windows x86 版本MOSDEF可执⾏⽂件载荷的检出率相对可观。
Powershell版MOSDEF⽊⻢具有命令执⾏、⽂件上传、执⾏shellocode等攻击功能，在VisualTotal中具有较低的检
出率。
2 RootKit模块
CANVAS⾃带windows与linux系统的rootkit模块，其中windows系统仅有物理内存dump的功能，⽽linux系统中的
rootkit功能要丰富的多。linux平台的rootkit模块以源码的形式分发，每次使⽤需要针对⽬标的内核版本进⾏重新编
译内核模块，⽀持以下功能：
1. 指定名称的⽂件隐藏
2. 后⻔进程及⼦进程PID隐藏
3. TCP通讯隐藏
4. MOSDEF连接后⻔
利⽤CANVAS⾃带的rootkit模块，攻击者可以实现持久化与攻击⾏为隐藏，增加防守与溯源难度。
3 VisualSploit可视化代码⽣成⼯具
泄漏CANVAS包含名为VisualSploit的可视化编程⼯具，该⼯具可以进⾏图形化的exploit开发，设计程序执⾏流
程，操作payload内存布局，最终⼀键⽣成可执⾏python脚本⽂件。
4 协同攻击功能
CANVAS Strategic允许在CANVAS的多个实例之间进⾏实时通信，并与中央实例共享信息（⽬标信息，攻击操
作，获得的权限），该中央指挥实例是从Canvas运⾏Commander模块的机器。当多⼈作战时，需要对进度和成果
进⾏协协作时，此功能特别有⽤。此外，它还可以⽤作多个实例的中央活动监视和⽇志记录，也包含⼀个简单聊天
服务器。
4
警惕CANVAS被暴露及滥⽤带来的⻛险
本次CANVAS框架源码泄露事件是继NSA泄露DanderSpritz框架后的⼜⼀个完整⽹络攻击框架泄露事件，其中所涉
及的TTPs技术已被⾼度武器化。截⽌本⽂公开时我们还暂未实现对CANVAS中的漏洞EXP、持久化技术、隧道技术
等技术的全⾯深⼊的分析。
同 时 可 以 看 到 ， 本 次 泄 露 的 漏 洞EXP包 含 全 ⽹ 第 ⼀ 个 被 公 开 的 针 对Spectre CPU漏 洞 的 可 利 ⽤EXP， 另 外
Powershell版MOSDEF⽊⻢在VisualTotal中也同样具有较低的检出率，这些⼯具都可以直接被恶意攻击者滥⽤，从
⽽导致严重的安全事故，建议各安全⼚商协助企业客户积极防御，防患于未然。
绿盟科技M01N蓝军研究团队将继续跟踪深⼊分析该框架的内容。
    ·    参考链接    ·    
[1]https://www.immunityinc.com/products/canvas/index.html
https://spectreattack.com/
绿盟科技M01N安全研究团队专注于Red Team、APT等⾼级攻击技术、战术及威胁研究，涉及Web安全、终端安全、
AD安全、云安全等相关领域。通过研判现⽹攻击技术发展⽅向，以攻促防，为⻛险识别及威胁对抗提供决策⽀撑，全⾯
提升安全防护能⼒。
战队⾃2019年成⽴以来，荣获2020年第三届⻋联⽹信息安全技能⼤赛⼀等奖、2020数字中国创新⼤赛⻁符⽹络安全赛
道⼀等奖、2020年第三届“强⽹”拟态防御国际精英挑战赛⼀等奖、2020WIDC世界智能驾驶挑战赛-信息安全挑战赛优
胜奖、2020年⼯业信息安全技能⼤赛⼆等奖、“第五空间”智能安全⼤赛⼆等奖、2020“巅峰极客”⽹络安全技能挑战赛
⼆等奖、2019“湖湘杯”⽹络安全技能⼤赛⼀等奖、2019中国国际数字经济博览会数字经济云安全共测⼤赛⼀等奖、
2019年⼯业信息安全技能⼤赛⼀等奖。
喜欢此内容的⼈还喜欢
这款⽹络排查⼯具，堪称神器！
⽹络⺠⼯
MSF配合Ngrock穿透内⽹
LemonSec
内⽹渗透｜Chisel内⽹穿透⼯具
天亿⽹络安全
这款⽹络排查⼯具，堪称神器！
MSF配合Ngrock穿透内⽹
内⽹渗透｜Chisel内⽹穿透⼯具