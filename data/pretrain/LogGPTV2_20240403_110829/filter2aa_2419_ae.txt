我们的⽬目标代码. J 
DEF"CON"CHINA"1.0"(2019)"
77"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
得到IRA转换器器。 
初始化并运⾏行行符号执⾏行行引
擎。  
DEF"CON"CHINA"1.0"(2019)"
78"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
79"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
我们之前的测试也得出
了了同样的结论。 J 
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
"DTRACE on WINDOWS 
DEF"CON"CHINA"1.0"(2019)"
80"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
81"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  DTrace是⼀一个动态跟踪框架，它在Solaris操作系统上⾮非常⾼高效并且⾮非常有
名。 
ü  Dtrace最初由太阳微系统公司的Mike Shapiro、Adam Leventhal和Brian Cantrill
编写。尽管他们从2003年年开始开发DTrace，但它只在Solaris 10 03/05中引入。 
ü  它用于在⽤用户和内核模式下获得系统的实时概览。此外，它还可以⽤用来理理
解应⽤用程序和系统的⾏行行为。 
ü  几个月前，DTrace被移植到Windows: https://github.com/opendtrace/
opendtrace/tree/windows 
ü  DTrace可以概括为⼀一组分散在内核关键点上的探针(传感器器)。因此，每次“激
活”探测时，都可以注册并理理解应⽤用程序⾏行行为。 
ü  使用DTrace可以更容易地跟踪进程和系统的概要⽂文件、查找哪些系统调⽤用
被“调⽤用”、进程写入/读取了了多少字节、进程打开了了多少⽂文件、跟踪被调⽤用的
系统调⽤用序列列等等。                    
DEF"CON"CHINA"1.0"(2019)"
82"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  DTrace 的脚本使⽤用 D语⾔言编写 (与 awk相似).  
ü  探测名称由以下语法描述: 
 provider:module:function:name 
定义如下:  
ü  provider: ⽤用于测量量系统某⼀一区域的探针库。在Windows上，现有的提
供者有syscall、etw、profile、pid和dtrace。 
ü  module:  内核模块，我们在这⾥里里找到探针。 
ü  function: 函数包含探针. 
ü  name:⽬目标探测的特定名称或描述。 
ü  关键概念:  
ü  predicates:⽤用户定义的条件。 
ü  actions:当探测触发时运⾏行行的任务。  
ü  aggregations:使用聚合函数合并数据。  
DEF"CON"CHINA"1.0"(2019)"
83"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  安装 DTrace:  
ü   Windows 10 x64 (build 18342 或更更晚) 来自Windows内部程序。 
ü  bcdedit.exe /set dtrace on 
ü  下载 DTrace package: http://download.microsoft.com/download/B/D/4/
BD4B95A5-0B61-4D8F-837C-F889AAD8DAA2/DTrace.amd64.msi 
ü  _NT_SYMBOL_PATH=srv*C:\symbols*https://msdl.microsoft.com/
download/symbols 
ü  引导系统。  
ü  以管理理员身份打开命令提示符.  
ü  如果使用fbt(函数边界跟踪)，则需要附加WinDbg并在调试模式下启动
窗⼝口。 J 
DEF"CON"CHINA"1.0"(2019)"
84"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
85"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
86"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
87"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
88"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
89"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  可以使⽤用另⼀一种类型的提供程序“fbt”(函数边界跟踪)，它跟踪通过内核中的
NTFS执⾏行行的系统调⽤用序列列。 
ü  只有当Windows 10附加内核调试器器时，才可以使用“fbt”提供程序。 
DEF"CON"CHINA"1.0"(2019)"
90"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
91"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
92"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
93"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
94"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
Traceext.sys:!将DTrace使⽤用的功能
公开给跟踪。!
DEF"CON"CHINA"1.0"(2019)"
95"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
"反虚拟化 
DEF"CON"CHINA"1.0"(2019)"
96"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
97"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  使用反虚拟化技术编写恶意软件样本⾮非常容易易，这些技术⽤用于检测
VMWare(检查I/O端口通信)、VirtualBox、Parallels、SeaBIOS仿真器、QEMU仿真
器、Bochs仿真器、QEMU仿真器、Hyper-V、Innotek VirtualBox、sandbox 
(Cuckoo)。 
ü  此外，有⼏几⼗十种技术可以⽤用于检测Vmware沙箱: 
ü  检查注册表(OpenSubKey()函数)，以尝试找到与客户端中安装的⼯工具相
关的条⽬目
(HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VirtualMachine\Guest\Para
meters). 
ü  使⽤用WMI查询Win32_BIOS管理理类，以与物理理机器器中的属性进⾏行行交互。 
ü  我们已经知道了了世界上每⼀一种反虚拟化技术，并且所有这些技术都有⽂文
档。 
ü  ⽬目前⼤大多数技术都使⽤用WMI，使用WMI可以快速编写C#程序。 
DEF"CON"CHINA"1.0"(2019)"
98"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
99"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  上⼀一张幻灯⽚片的代码没有任何新信息: 
ü  ManagementClass class 代表 公共信息模型(CIM)管理理类。 
ü  Win32_BIOS WMI class 代表 BIOS的属性和该类的成员使您能够使⽤用特
定的WMI类路路径访问WMI数据。 
ü  GetInstances( )获取类的所有实例例的集合。 
ü  GetEnumerator( ) 返回集合的枚举器器(IEnumerator)。 
ü  IEnumerator.Current( ) 返回相同的对象。 
ü  IEnumerator.MoveNext( ) 将枚举数推进到集合的下⼀一个元素。 
q  物理理主机:  
C:\> Test_VM.exe 
属性: 
版本:         DELL   - 6222004 
序列列号:    D5965S1 
操作系统:         0 
⽣生产商:    Dell Inc. 
q  客户虚拟机:  
E:\> Test_VM.exe 
属性: 
版本:         LENOVO - 6040000 
序列列号:    VMware-56 4d 8d c3 a7 c7 e5 
2b-39 d6 cc 93 bf 90 28 2d 
操作系统:         0 
⽣生产商:    Phoenix Technologies LTD 
DEF"CON"CHINA"1.0"(2019)"
100"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
101"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
双击结果....""
DEF"CON"CHINA"1.0"(2019)"
102"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
103"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
DEF"CON"CHINA"1.0"(2019)"
104"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
ü  在虚拟机中不支持获取温度数据。 
ü  因此，恶意软件能够知道它们是否在虚拟
机上运⾏行行。 J 
ü  物理理主机: 
C:\> VM_Test2.exe 
状态:好的，程序在物理主机上运行! 
ü  虚拟机: 
C:\> VM_Test2.exe 
这个程序正在虚拟机中运⾏行行! 
DEF"CON"CHINA"1.0"(2019)"
105"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
q ⼏几点结论: 
ü 在尝试打开现代保护器器之前，了解常用的反逆向技术是非常必要
的。 
ü MIASM和METASM是处理理和消除复杂代码混淆的出⾊色⼯工具。 
ü 仿真是理理解⼩小⽽而复杂的代码段的⼀一种可能的替代⽅方法。 
ü DTrace在Solaris上做得很好，请继续关注它可能是Windows操作系
统上的⼀一个优秀⼯工具。 J 
ü 尽管优秀的研究已经发现了了复杂的反虚拟化技术，但仍然存在许
多其他简单⽽而智能的技术，所以请当心！ 
DEF"CON"CHINA"1.0"(2019)"
106"
ALEXANDRE"BORGES"–"MALWARE"AND"SECURITY"RESEARCHER"
v Acknowledgments to: 
ü DEF CON的⼯工作⼈人员, 对我⾮非常友好 
ü 你, 预留留了了⼀一些时间来听我的演讲。 
ü 记住: 人生最美好的是人. J 
DEF"CON"CHINA"1.0"(2019)"
107"
ALEXANDRE"BORGES"–"IT"IS"NOT"ALLOWED"TO""COPY"OR"REPRODUCE"THIS"SLIDE."""
ü  Malware and Security 
Researcher. "
ü  Speaker at DEFCON USA 2018 
ü  Speaker at HITB2019 
Amsterdam 
ü  Speaker at CONFidence Conf. 
2019 
ü  Speaker at BSIDES 
2018/2017/2016 
ü  Speaker at H2HC 2016/2015 
ü  Speaker at BHACK 2018 
ü  Consultant, Instructor and 
Speaker on Malware Analysis, 
Memory Analysis, Digital 
Forensics and Rookits. "
ü  Reviewer member of the The 
Journal of Digital Forensics, 
Security and Law."
ü
R f
Di it l
感谢您的聆听.!J!
谢谢!
!
Ø  Twitter:!!
!
@ale_sp_brazil!
@blackstormsecbr!
!
!
Ø  Website:!http://blackstormsecurity.com!
Ø  LinkedIn:!http://www.linkedin.com/in/
aleborges!
Ø  E-mail:!
PI:EMAIL!