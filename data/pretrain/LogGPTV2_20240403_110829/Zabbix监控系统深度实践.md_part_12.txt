TestTemplateB:hostname
TestTemplateC:echoC
TestTemplateB:echoB
TestTemplateA:echoA
图5-18
图5-17
Go (O)
Tri
第5章增加监控
75
---
## Page 91
·76
Microsoft\WindowsNTCurrentVersion\Perflib\O09中。比如输入如下的值。
监控时只要使用这个数字就可以了。具体是在注册表的HKEY_LOCAL_MACHINE\SOFTWARE
但是可以在Windows注册表中设定这个key和一个数字的映射关系。这是和语言无关的，在
secs），所以使用一个模板去适配所有的Winodws机器很有可能会因为语言的问题而出问题。
Interrupts/sec"]这种形式。
下面就看下Zabbix支持的对于Windows机器的Item。
5.9Windows监控
会造成Zabbix数据库中数据错乱。
Zabbix监控系统深度实践
File Write Operations/sec
File Read Operations/sec
Memory
1847
设置语言不同的Windows机器的key是不同的（比如这里英语是Processor(O)Interrupts
Zabbix使用perf_counter这个key来监控Windows，比如 perf_counter["Processor(O)
12
10
Processor Time
4
System
2
一般来说，互联网公司的服务器以Linux居多，但也有一些游戏公司用的是Windows机器，
注意：对于大量数据的更新，
（4）输入新的值，单击update。
（3）在弹出的窗口中选择需要更新的项目；
（2）在最下面的下拉列表选择 Massupdate，
，可能需要很久，页面一直在载入状态，这时不要取消，否则
，然后单击Go；
---
## Page 92
可以了。
配置文件或重启 Zabbix Agent使其生效。
加简单。比如根据之前的映射关系，可以进行如下定义。
%ProcessorTime对应6，所以这个key对应的就是2\6。
k
 >] o>]   so>]xx b
Zabbix get v2.2.0 (revision 40147) (12 November 2013)
C:\zabbix-2.2.0\bin\win64>zabbix_get.exe--help
最后看看 zabbix_agentd.exe可以设置的参数，如下。
Zabbix自带了两个监控Windows的Template，不懂Windows运维的人，直接把模板套上就
此时，就能使用UserPerfCounterl或者UserPerfCounter2来创建相应的Item了。记得修改
PerfCounter=UserPerfCounter2,"\4\24",30
也可以在ZabbixAgent的配置文件中定义一些PerfCounter，这样在前端使用ItemKey时更
对于“\System\%Processor Time”这个key来说，
he
-s--host 
Options:
或者是
File Write Bytes/sec
File Read Bytes/sec
File
--key 
--source-address 
host. Default is 10050
--port
Control Operations/sec
Specifykey of item to retrieve val
Specify source IP address
Specify port number of agent runnin
Specify hostname or IP address of
，由于映射表的存在，System对应2，
第5章
·77。
增加监控
---
## Page 93
78
选择性能监视器，就能看到默认显示的“%ProcessorTime”了。
这套接口就叫做PerformanceCounters。
数据可以帮助我们检查系统或者应用的瓶颈。这些数据可以帮助用户以图形的形式来掌握系统
Network）对它的解释是“它用来监控操作系统、应用、服务或者驱动程序的运行情况。counter
需要加入 Zabbix。下面向大家介绍一下如何使用Perf_counter 收集Windows 的数据。
Linux的，对于Windows 基本处于用阶段。一些公司有一小部分Windows服务器需要监控，也
如监控平均磁盘读队列长度的“perf_counter[\234(_Total)\1402]”。Zabbix90%的使用场景都是
Zabbix监控系统深度实践
的运行状况”，简单地说，Windows提供了一套接口，使得我们可以获取Windows的系统性能数据，
从“开始”→“管理工具”→“性能监视器”进人图形化界面，如图5-19所示，在左侧
在Zabbix自带的Template OS Windows 中，有很多 Item的key使用的是 perf_counter，比
Example: zabbix_get -s 127.0.0.1 -p 10050 -k "system.cpu.load[all,avgl]"
使用Typeperf监控Windows
-V --version
-h--help
性能监视器
MWM
23:2300
图5-19
Display version number
Give this help
---
## Page 94
在窗口下面能看到如图5-22所示的显示。
选择需要的监控项后就单击“添加”按钮，最后单击“确定”按钮，就能看到两条线了，并且
因为是双核的CPU，所以可以选择监控哪个核心，即“Total"、“”、“O”和“1"。
在选择了监控项后，下面还有参数可以选择。笔者在图5-21中选择的是处理器“Processor"”
视器”，另一种是使用命令行。
counter[\234（_Total）\1402]”中的“234（_Total）\1402"。有两种方法：一种是使用“性能监
在左侧可以选择监控的大类，单击加号可展开，如图5-21中选择的“Processor”大类。
在打开的窗口中选择想要添加的监控项，如图5-21所示。
使用“性能监视器”来获取想要监控数据的key时，首先单击如图5-20所示的加号。
我们已经了解perf_counter的作用了，现在需要知道perf_counter后面加什么参数，即“perf
添加计数器
显示描述00
可用计数器
选定对象的实例α）
计救
添加》
图5-22
图5-21
图5-20
的计数器（C）
帮助
第5章增加监控
79。
---
## Page 95
·80。
“disk read”的计数器。
模式就好了。Performance Counters 还真支持Windows 命令行。
Zabbix监控系统深度实践
\LogicalDisk(_Total)\Disk Reads/sec
\LogicalDisk(_Total)\% Disk Read Time
\LogicalDisk(C:)\% Disk Read Time
下面简单介绍一下如何通过命令行来获取想要的监控项的计数器。下面包括了所有带有
看完了图形化界面，肯定会有读者觉得这个是非常麻烦并且反人类的设计，如果有命令行
\LogicalDisk(D:)\Disk Reads/sec
\LogicalDisk(C:)\Disk Reads/sec
\LogicalDisk(_Total)\Avg. Disk Read Queue Length
\LogicalDisk(D:)\Avg.Disk Read Queue Length
\LogicalDisk(C:)\Avg. Disk Read Queue Length
\LogicalDisk(D:)\% Disk Read Time
这就是我们要在 Zabbix 的 perf_counter后面填写的参数。
右键单击任意一个，就可以查看目前显示的两个数据的计数器的值了，如图5-23所示。
性能监视器属性
常规来源数据
比例（）
颜色
计数器
泰加
删除（）
图表
，
图5-23
口
口
[otal]%
确定
样式：
宽度
外观
取消
---
## Page 96
如下。
就可以找到我们需要的了。find工具和 Linux中的 grep 类似，可以用help命令来查看用法
“ProcessorTime”，输出在命令行中。
用它来监控某个计数器的值，并且加上写人文件等操作。如下面这个例子可以用于它来监控
FIND [/V] [/C] [/N] [/I] [/OFF[LINE]] "string" [[drive:] [path]filename[ ...]]
C:\zabbix-2.2.0\bin\win64>help find
这里使用的是它的qx参数，来列出所有支持的计数器。再加上Windows 中的find工具
"03/24/201400:07:14.433","15.932421"
"03/24/2014 00:07:12.425","12.215615"
"03/24/201400:07:11.421","10.572836"
"03/24/2014 00:07:10.419","19.824433"
"(PDH-CSV 4.0)","\\PC-20130902WJFL\Processor(_Total)\% Processor Time"
用法如下。
命令成功结束。
"03/24/201400:07:13.429","11.526874"
这里最重要的命令是typeperf，它的作用是将性能数据写入命令窗口或日志文件。可以
\PhysicalDisk(_Total)\Disk Read Bytes/sec
\PhysicalDisk(O C:D:)\DiskRead Bytes/sec
\PhysicalDisk(_Total)\Disk Reads/sec
\PhysicalDisk(0 C: D:)\Disk Reads/sec
\PhysicalDisk(_Total)\Avg.Disk Read Queue Length
\PhysicalDisk(O C:D:)\Avg.Disk Read Queue Length
\PhysicalDisk(_Total)\%Disk Read Time
\PhysicalDisk(O C: D:)\% Disk Read Time
\LogicalDisk(_Total)\Disk Read Bytes/sec
\LogicalDisk(D:)\Disk Read Bytes/sec
\LogicalDisk(C:)\Disk Read Bytes/sec
第5章增加监控
·81
---
## Page 97
82
的依赖。在 zabbix_server.conf 中，和虚拟机监控有关的有如下三个配置。
数据了。
通过SOAP协议进行通信，并且将获取的信息存到Zabbix内存中，然后就可以从虚拟机中抽取
监控。Zabbix 默认提供了一些模板，可以直接用来监控VMware、vCenter（中心节点，控制虚
动寻找VMware hypervisors 和虚拟机，并且能根据事先定义的，为这些虚拟机建立Host，添加
5.10VMware监控
Zabbix监控系统深度实践
拟机的控制访问等）和vSphere（VMware虚拟机系统）。
如果要 Zabbix支持对虚拟机的监控，需要在编译Zabbix Server时，加上libxml和 libcurl
从Zabbix2.0开始，Zabbix支持对VMware的监控，Zabbix可以使用low-leveldiscovery自
VMwareFrequency：对同一个VMware服务抓取数据的时间间隔。这个参数最少要和
VMwareCacheSize：保存VMware数据的内存空间。这些内存空间直到vmware collector启
StartVMwareCollectors：vmware collector 的进程数。
从单个VMware服务抓取数据时只会使用一个vmware collector进程。
注意：Windows中命令的参数是加“”符号的，而不是Linux中的“”。
如果没有指定路径，FIND将搜索在提示符处键人的文本或者由另一命令产生的文本。
[drive:Jlpathjilename：指定要搜索的文件。
@"string"：指定要搜索的文本字符串。
◎/OFF[LINE]：不要跳过具有脱机属性集的文件。
/：搜索字符串时忽略大小写。
/N：显示行号。
IC：仅显示包含字符串的行数。
/V：显示所有未包含指定字符串的行。
动时才会分配。
其中各部分含义如下。
VMware监控的Item的时间间隔相等。
---
## Page 98
vmware.hv.datastore.discovery
Host prototype.
vmare.hv.discovery
vmware.cluster.discovery
表5-1是在Discovery中支持的key和宏。
在lld中，
Zabbix可以使用low-level discovery来将虚拟机加入监控，
Key
CONFIGURATION OF HOSTPROTOTYPES
Graph prototypes(O)
Discovery:DiscoverVMwarehypervisors
αTemplatelistTemplate:TemplateVirtVMwareDiscovery list
，可以使用很多宏来定义原型，如图5-24所示，可以根据Hypervisor的宏来定义
Host
Visiblename
Hostname
Groups
Save
Status
datastore
对于VMware集群的discovery
Monitored
{#HV.NAME}
[#HVUUID}
Templates
Host prototypes (1)
Clone
Key说明
Delete
L
Host inventory
表5-1
图5-24
Itemprototypes(o)Triggerprototypes(o)
Cancel
(#DATASTORE)
(#CLUSTER.NAME)
(#HV.NAME)
(#HV.ID)
(#HV.UUID)
[#CLUSTER.NAME}
[#CLUSTER.ID)
，只需要将 Discovery rule中的 Key
宏
Datastore的名字
集群名字，可能为空
Hypervisor的名字
集群的名字
HostSystem管理）
Hypervisor的ID（由
集群的ID
一的Hypervisor的
第5章
宏说明
增加监控
83
---
## Page 99
84°
JXagent
TELNETagent
IPM agent
Overview”进入查看Queue数据。如图5-25所示。
待被刷新的 Item，这只是一个逻辑上的表述，并不是 IPC queue 或其他 Zabbix 的Queue 机制。
5.11
Zabbix监控系统深度实践
Caiculated
SSH agent
Databasemoitor
Eitemai check
Zabbar agregate
Zabx mntemal
SNMPV3 agent
SNMPV2egea
SNMPVIagen
Simple check
Zabbo agent(acte)
Zabbis
Mems
vmware.vm.fs.discovery