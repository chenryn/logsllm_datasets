title:Getting to know your Card: Reverse-Engineering the Smart-Card Application
Protocol Data Unit
author:Andriana Gkaniatsou and
Fiona McNeill and
Alan Bundy and
Graham Steel and
Riccardo Focardi and
Claudio Bozzato
problemdeﬁnition
methodology
REPROVEevaluation
discussion
Gettingtoknowyourcard: Reverse-Engineering
theSmart-CardApplicationProtocolDataUnit
forPKCS#11Functions
AndrianaGkaniatsou1,FionaMcNeill2,
AlanBundy1,GrahamSteel3
RiccardoFocardi4,ClaudioBozzato4
1UniversityofEdinburgh2Heriot-Watt 3Cryptosense
4Ca’Foscari
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
discussion
problemdeﬁnition
Smart-cards
secure,trusted,tamper-resistant
identiﬁcation,authentication,data
storageandapplicationprocessing
ﬁnancial,communication,securityand
datamanagementpurposes
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
discussion
problemdeﬁnition
Smart-cards
secure,trusted,tamper-resistant
identiﬁcation,authentication,data
storageandapplicationprocessing
ﬁnancial,communication,securityand
datamanagementpurposes
third-partycommunication
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
discussion
problemdeﬁnition
Smart-cards
secure,trusted,tamper-resistant
identiﬁcation,authentication,data
storageandapplicationprocessing
ﬁnancial,communication,securityand
datamanagementpurposes
third-partycommunication
black-box
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
discussion
problemdeﬁnition
Smart-cards
secure,trusted,tamper-resistant
identiﬁcation,authentication,data
storageandapplicationprocessing
ﬁnancial,communication,securityand
datamanagementpurposes
third-partycommunication
black-box
is your card
breaking bad?
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
problemdeﬁnition
methodology
REPROVEevaluation
Cryptographicprotocols
RSAPKCS#11CryptographicTokenInterfaceStandard
functionskeymanagement,signing,encryption,decryptionetc.
ensuresensitivedataremainsecure
API-LevelAttacks
E.g.,Clulow,J.,OnthesecurityofPKCS#11. CHES2003
Bortolozzo,M.,Centenaro,M.,Focardi,R.,&Steel,G.Attackingand
ﬁxingPKCS#11securitytokens. CCS2010
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
discussion
problemdeﬁnition
REPROVEevaluation
Cryptographicprotocols
RSAPKCS#11CryptographicTokenInterfaceStandard
functionskeymanagement,signing,encryption,decryptionetc.
ensuresensitivedataremainsecure
API-LevelAttacks
E.g.,Clulow,J.,OnthesecurityofPKCS#11. CHES2003
Bortolozzo,M.,Centenaro,M.,Focardi,R.,&Steel,G.Attackingand
ﬁxingPKCS#11securitytokens. CCS2010
PKCS#11Low-levelImplementation
hasbeenkeptinthedark
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
problemdeﬁnition
methodology
REPROVEevaluation
Smart-cardcommunication
Smart-cardCommunication
HowisPKCS#11implementedatthelowest-level
communication? Isitsecure?
AndrianaGkaniatsou
Gettingtoknowyourcard
PKCS#11APIFunction calllow-levelcommunicationSmart-cardAPDU layermethodology
problemdeﬁnition
Smart-cardcommunication
REPROVEevaluation
discussion
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
problemdeﬁnition
discussion
TheREPROVEsystem
REPROVEreverse-engineeringsystem: noAPIaccess-nocard
access-implementationindepedent
AndrianaGkaniatsou
Gettingtoknowyourcard
communicationREPROVE•APDU semantics•On-card operations•PKCS#11 function translationPKCS#11ISO 7816genericassumptionsproblemdeﬁnition
methodology
discussion
REPROVEevaluation
ISO/IEC7816
Deﬁnesthecommunicationlayerbetweenthecardandthe
reader:15Parts
Part4: Organisation,securityandcommandsforinterchange
Part8: Commandsforsecurityoperations
Part9: Commandsforcardmanagement.
AndrianaGkaniatsou
Gettingtoknowyourcard
REPROVEevaluation
discussion
methodology
problemdeﬁnition
APDUcommandstructure
>00 a4 080c045015440001
00 a4 080c045015440001
Cla: InstructionClass
00 a4 080c045015440001
Cla: InstructionClass
Ins: InstructionCode
00 a4 080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
00 a4 080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
Lc: Lengthofsentdata
D:Sentdata
00 a4 080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
Lc: Lengthofsentdata
D:Sentdata
Le: Lengthofexpecteddata
00 a4 080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
Lc: Lengthofsentdata
D:Sentdata
Le: Lengthofexpecteddata
00 a4 080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
Lc: Lengthofsentdata
D:Sentdata
Le: Lengthofexpecteddata
00 a4080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
Lc: Lengthofsentdata
D:Sentdata
Le: Lengthofexpecteddata
8021080c045015440001
Gettingtoknowyourcard
methodology
problemdeﬁnition
APDUcommandstructure
>00 a4080c045015440001
Cla: InstructionClass
Ins: InstructionCode
P1-P2: InstructionParameters
Lc: Lengthofsentdata
D:Sentdata
Le: Lengthofexpecteddata
8021080c045015440001
AnalysisChallenge
Howcanweinferthesemantics
oftheproprietarycommand?
e.g.,217→a4?
Gettingtoknowyourcard
discussion
problemdeﬁnition
Methodology
REPROVEevaluation
methodology
ISO7816models
Commandpreconditionmodels
Commandcategorization
Cardoperationsmodels
Patterns
Hierarchyofcardoperations
PKCS#11functionsmodels: C_login,C_generateKey,C_sign,
C_ﬁndObjectsInit,C_ﬁndObjects,C_getAttributeValue,
C_setAttributeValue,C_wrapKey,C_encrypt,C_unwrapKey
InferenceProblem
Givenasetofmodelsderivethemeaningoftheactual
implementation.
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
problemdeﬁnition
APDUmodelling
REPROVEevaluation
discussion
AndrianaGkaniatsou
Gettingtoknowyourcard
functionalitysub-functionality1sub-functionality2sub-functionality3commandacommandbcommandxcommandycommandzcommandacommandxNN, dummyNY, additionalYY, additionalYY, coreYN, additionalYY, coreNY, coreoperationstepsAPDU layercommandsdata exchange androle propertiescharacterisedbyimplementedasdecomposedintoproblemdeﬁnition
methodology
discussion
REPROVEevaluation
APDUmodelling
PKCS#11functionsareexpressedassetsof functionalities
E.g.,C_logIn:
inputs/outputsspeciﬁedbyPKCS#11
authenticationasdeﬁnedbyISO7816
withkey;
withPIN;
usinginternaldata;
dataencipherment
additionaloperations
secondaryauthentication
dataretrieval
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
problemdeﬁnition
Reverse-engineeringmainidea
REPROVEevaluation
discussion
AndrianaGkaniatsou
Gettingtoknowyourcard
Step 1: Semantics of APDUvalid mappingsvalid pathsfunctionalitiespathssub-functionalitiespathsStep 2: On-card operationsStep 3: PKCS#11 functionPKCS#11 functionalitiespathmethodology
problemdeﬁnition
REPROVEevaluation
Inferredmodel
3abstractionsoftheprotocol7→3levelsofattacks
discussion
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
methodology
problemdeﬁnition
REPROVEevaluation
Inferredmodel
3abstractionsoftheprotocol7→3levelsofattacks
Commands
semanticsoftheexchangedcommands
identifysensitivedata,injectcommands,blindreplysessions
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
methodology
problemdeﬁnition
REPROVEevaluation
Inferredmodel
3abstractionsoftheprotocol7→3levelsofattacks
Commands
semanticsoftheexchangedcommands
identifysensitivedata,injectcommands,blindreplysessions
On-cardoperations
which/howon-cardoperationsareexecuted
performunauthorisedoperations
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
discussion
problemdeﬁnition
REPROVEevaluation
Inferredmodel
3abstractionsoftheprotocol7→3levelsofattacks
Commands
semanticsoftheexchangedcommands
identifysensitivedata,injectcommands,blindreplysessions
On-cardoperations
which/howon-cardoperationsareexecuted
performunauthorisedoperations
PKCS#11interconnection
howaspeciﬁccryptographicfunctionisexecutedattheAPDU
layerPKCS#11attacks
bypassAPIrestrictions
AndrianaGkaniatsou
Gettingtoknowyourcard
REPROVEevaluation
discussion
methodology
problemdeﬁnition
Inferredmodel: example
Sniﬀedtrace:
>00a4080c0450154400
>9000>800a0200ea
>Response
>00a4080c08501550724b025502
>9000>80bb01b803840102
>9000>80aa808602ffff
>Response
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
problemdeﬁnition
Inferredmodel: example
REPROVEevaluation
discussion
AndrianaGkaniatsou
Gettingtoknowyourcard
problemdeﬁnition
methodology
REPROVEevaluation
Experiments
SniﬀedAPDUsfrom5commerciallyavailablesmart-cards;
9PKCS#11functions
discussion
C_logIn
C_generateKey
C_sign
C_encrypt
C_findObjects
C_getAttributeValue
C_setAttributeValue
C_wrapKey
C_unwrapKey
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
discussion
problemdeﬁnition
Experiments
evaluationon:
AndrianaGkaniatsou
Gettingtoknowyourcard
REPROVEevaluation
discussion
methodology
problemdeﬁnition
Experiments
evaluationon:
functionalsuccess
AndrianaGkaniatsou
Gettingtoknowyourcard
REPROVEevaluation
discussion
methodology
problemdeﬁnition
Experiments
evaluationon:
functionalsuccess
successfullyinferredatleast1model
AndrianaGkaniatsou
Gettingtoknowyourcard
REPROVEevaluation
discussion
methodology
problemdeﬁnition
Experiments
evaluationon:
functionalsuccess
successfullyinferredatleast1model
qualityoftheresults
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
problemdeﬁnition
methodology
REPROVEevaluation
Experiments
evaluationon:
functionalsuccess
successfullyinferredatleast1model
qualityoftheresults
apartfrom3cases;auniquemodelthatmatchedexactly
3cases: correcton-cardoperations;2suggestedmodels;1
matchedexactly
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
problemdeﬁnition
methodology
REPROVEevaluation
Experiments
evaluationon:
functionalsuccess
successfullyinferredatleast1model
qualityoftheresults
apartfrom3cases;auniquemodelthatmatchedexactly
3cases: correcton-cardoperations;2suggestedmodels;1
matchedexactly
search-spacerestriction
AndrianaGkaniatsou
Gettingtoknowyourcard
discussion
problemdeﬁnition
methodology
REPROVEevaluation
Experiments
evaluationon:
functionalsuccess
successfullyinferredatleast1model
qualityoftheresults
apartfrom3cases;auniquemodelthatmatchedexactly
3cases: correcton-cardoperations;2suggestedmodels;1
matchedexactly
search-spacerestriction
noexplosion
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
problemdeﬁnition
Search-spacesample
REPROVEevaluation
discussion
Function
Card2
Card4
Card5
4
1
69
3
4
39
1
1
1
1
7
1
C_logIn
C_findObjects
C_generateKey
C_setAttributeValue
C_encrypt
C_logIn
C_findObjects
C_getAttributeValue
C_sign
C_logIn
C_sign
C_setAttributeValue
TotalB.CC R.CC R.SFC R.FC R.Model
12
32000
3
400
512
540x868
14
86
3
20
65
7396
6
7396
3
54700816
1
86
1
1
53
12322
1
1
B.CC:baselinealgorithmcommandcombinations.
R.CC:REPROVEcommandcombinations.
R.SFC:REPROVEsub-functionalitycombinations,
R.FC:REPROVEfunctionalitycombinations.
R.Modelistheﬁnalmodel(s)suggestedbyREPROVE.
Gettingtoknowyourcard
AndrianaGkaniatsou
2
1
8
1
2
21
1
1
1
1
4
1
2
1
1
1
1
1
1
1
1
1
2
1
discussion
problemdeﬁnition
methodology
REPROVEevaluation
Results: Violationsfound
c_logInfunction
Nosessionhandles
allcards
Noveriﬁcation
1card
PINsentinplaintext
2cards
c_wrapKey
functionexecutedlibraryside7→sensitivekeysentin
plaintext1card
AndrianaGkaniatsou
Gettingtoknowyourcard
methodology
REPROVEevaluation
discussion
problemdeﬁnition
Results: Violationsfound
c_generateKey
functionexecutedlibraryside7→sensitivekeysentin
plaintext2cards
c_encrypt
functionexecutedlibraryside7→sensitivekeysentin
plaintext1cards
Thelocationofthesensitivedataandtherelatedinformation
(eg.,attributes)waslocatedforallcards.
Gettingtoknowyourcard
AndrianaGkaniatsou
problemdeﬁnition
methodology
discussion
REPROVEevaluation
Conclusion
REPROVE:fullyautomatedsystemforreverse-engineering
APDUsanddiscoveringinterconnectionwithPKCS#11functions
itdoesnotrequiresaccesstothecard’scodenortheAPI
checkifthecardrespectsthestandard
2testedcardsdidnothing!
accessPKCS#11objectsfromthelow-level-bypassAPI
restrictions
AndrianaGkaniatsou
Gettingtoknowyourcard