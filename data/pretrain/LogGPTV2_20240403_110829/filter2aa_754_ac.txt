Figure!20.!MachNO!Viz’s!Network!Security!tab!autoNgenerates!valuable!network!defense!signatures!for!us.!
!
!
!
!
!
!
!
!
!
!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
Analysis!of!keychain_dumper:!iOS!Hacker!Utility!
!
!
Keychain!Dumper5!is!a!popular!utility!for!dumping!all!passwords!saved!within!iOS’s!keychain.!!
Installation!of!this!utility!assumes!the!iOS!device!(iPhone,!iPad,!etc.)!has!been!jailbroken.!!Analyzing!this!file!
with!MachNO!Viz!will!exercise!the!disassembly!analysis!engine’s!ability!to!handle!ARM7!instructions!while!
providing!ObjectiveNC!and!String!information,!when!applicable.!
After!uploading!the!keychain!dumper!binary!into!MachNO!Viz!and!drilling!down!into!the!header,!we!can!verify!
that!it!has!been!compiled!as!an!ARM!architecture!(Figure!21).!
!
Figure!21.!Keychain!dumper!header!shows!ARM!architecture!as!the!target!for!this!binary.!
!
In!addition,!we!can!verify!that!the!file!has!not!been!code!signed!by!examining!the!ENCRYPTION_INFO!load!
command!(Figure!22).!!Also!notice!as!we!drill!into!the!load!commands!the!“bread!crumbs”!in!the!topNleft!give!
us!a!simple!history!of!how!we!managed!to!navigate!to!this!field.!!This!useful!feature!allows!simple!navigation!
of!the!MachNO!file!format!load!commands,!which!can!become!cryptic!and!complicated!in!a!standard!console!
data!dump.!!By!presenting!the!same!information!in!a!visual!file!structure,!we!can!easily!find!the!fields!of!
interest!and!concentrate!only!on!those.!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
5!https://github.com/ptoomey3/KeychainNDumper!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
!
!
Figure!22.!Drilling!down!into!the!load!commands!we!arrive!at!ENCRYPTION_INFO!and!validate!an!unencrypted!ARM!binary.!
Continuing!the!analysis!of!this!hacker!utility,!our!Security!Risk!score!is!4,!which!is!quite!low.!!From!a!network!
security!threat!perspective!you!definitely!do!not!want!this!utility!floating!around;!however,!compared!to!a!
malware!Trojan!or!similar!backdoor!utility,!this!binary!doesn’t!appear!to!display!malicious!API!usage.!!Our!sole!
string!flagged!as!a!security!risk!turns!out!to!point!to!Apple’s!domain.!
!
Figure!23.!A!low!amount!of!security!risks!demonstrates!that!lack!of!this!binary’s!ability!to!act!as!a!true!threat.!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
A!powerful!capability!of!MachNO!Viz!is!to!enumerate!and!resolve!all!ObjectiveNC!string!data!for!method!names!
and!variables.!!This!allows!a!complete!enumeration!of!most!of!the!code!and!turns!malicious!code!analysis!into!
technical!reading.!!Case!in!point,!the!“Names/XRefs”!(Figure!24)!of!the!keychain!dumper!utility!systematically!
gives!a!general!idea!of!its!inner!workings!and!true!capability.!
!
Figure!24.!ObjectiveNC!structure!and!method!enumeration!provides!immediate!value!in!quickly!triaging!this!binary.!
!
The!following!methods!highlight!the!core!of!this!binary:!dumpKeychainEntitlements,!printCertificate,!
printGenericPassword,!printIdentity,!printInternetPassword!and!printKey.!!The!sqlite!methods!provide!data!
access!to!the!keychain!database!store.!!In!terms!of!functionality!you!can!examine!these!functions!to!confirm!
they!actually!perform!“as!advertised”.!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
Let’s!conduct!a!verification!of!the!dumpKeychainEntitlements!method!to!confirm!it!does!what!it!says.!!
Selecting!it!from!the!“Names/XRefs”!and!then!from!“Search!Results”!brings!the!method!into!the!Graph!
Visualization!tab!(Figure!25).!
!
Figure!25.!A!string!resolution!algorithm!was!developed!to!resolve!ARM7!string!references!in!MachNO!Viz.!
!
It’s!important!to!note!that!in!order!to!perform!ARM!string!resolution!in!the!code,!an!instructionNtracing!
algorithm!was!developed!in!order!to!resolve!these!references!for!MachNO!Viz’s!graphs.!!A!native!“otool”!code!
dump!will!not!provide!this!amazingly!useful!information!to!you.!!The!figure!below!(Figure!26)!shows!an!Apple!
otool!dump!of!the!same!code!sequence!without!the!string!references.!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
!
Figure!26.!Apple’s!otool!doesn’t!provide!the!deep!code!analysis!of!MachNO!Viz.!
!
Further!down!the!method!we!find!the!call!to!open!the!keychain!database!along!with!a!string!referencing!a!
SELECT!statement!(Figure!27).!!Our!Strings!tab!quickly!reveals!the!details!of!this!call!(Figure!28).!
!
Figure!27.!Tracing!the!code!path!of!the!dumpKeychainEntitlements!method.!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
!
Figure!28.!Only!due!to!MachNO!Viz’s!string!resolution!ability!were!we!able!to!easily!track!down!this!value.!
The!next!several!code!blocks!iterate!through!the!results!of!the!SELECT!statement!and!build!a!string!out!of!the!
data!returned.!!The!graph!visualization!allows!us!to!color!and!observe!this!code!loop!(Figure!29).!
!
Figure!29.!Graph!view!shows!us!the!SELECT!statement!and!subsequent!code!loop!to!aggregate!the!results!as!strings.!
The!resulting!string!data!is!dumped!to!STDOUT!and!the!function!exits.!!As!we!have!demonstrated!in!a!matter!
of!a!few!minutes,!you!can!quickly!triage!this!file!as!a!hacker!utility,!grab!and!deploy!its!flat!file!signature!
(Network!Security!tab)!and!move!on!to!other!more!malicious!binaries.!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
Analysis!of!MacDefender:!OSX’s!First!Malware!Threat!
!
!
MacDefender!quickly!solidified!itself!as!the!first!real!threat!to!the!OSX!operating!system!back!in!2011.!!
Operating!under!the!principles!of!social!engineering,!an!unsuspecting!user!is!lured!into!installing!it!as!a!
legitimate!Mac!AntiNVirus!product.!It!then!attempts!to!get!the!user’s!credit!card!number!by!asking!them!to!pay!
for!the!“full”!version.!!It!also!hijacks!the!user’s!browser!to!display!sites!related!to!pornography.6!
MacDefender!is!a!good!example!of!a!FAT!file!structure!whereby!a!binary!is!compiled!for!multiple!architectures!
and!executes!on!the!one!detected!by!the!MachNO!loader.!!Sending!the!file!into!MachNO!Viz!illustrates!the!two!
architectures!supported,!x86_64!and!i386!(Figure!30).!!Visually!we!can!also!see!that!the!x86_64!binary!is!larger!
than!its!i386!counterpart!while!the!header!is!barely!a!sliver!when!weighed!against!the!actual!files.!
!
Figure!30.!MachNO!Viz!correctly!parses!and!display!FAT!file!headers!with!multiple!architectures.!
The!Security!Risk!field!and!Network!Security!tab!provide!us!with!immediate!feedback!as!to!the!true!nature!of!
this!binary!by!highlighting!the!malicious!IP!addresses!and!domains!embedded!within!(Figure!31).!
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
6!http://en.wikipedia.org/wiki/Mac_Defender!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
!
Figure!31.!Malicious!URL’s!and!IP!addresses!embedded!within!MacDefender!provide!quick!insight!into!its!real!intention.!
!
The!sysctl!API!provides!access!to!get/set!kernel!level!attributes!and!rightfully!scores!as!a!significant!security!
risk!(Figure!32)!in!the!automated!security!assessment.!
!
Figure!32.Sysctl!is!not!an!API!function!you!want!your!average!OSX!binary!to!be!accessing.!
Ironically,!the!“fake”!antiNvirus!comes!equipped!with!the!bells!and!whistles!to!make!you!think!that!it!is!in!fact!a!
legitimate!product!as!seen!in!the!“Names/XRefs”!list!(Figure!33).!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
!
Figure!33.This!malware!author!created!routines!to!mimic!an!actual!AntiNVirus!scan.!
As!part!of!the!scam!to!fool!the!user,!we!can!examine!one!of!the!AV’s!functions,!AntiVirus_IsFileInfected.!!In!a!
normal!antiNvirus!this!would!be!a!complicated!feat!consisting!of!signature!based!detection!and!heuristics!to!
detect!maliciousness!of!a!particular!binary.!!The!unusually!small!size!of!this!AV’s!detection!function!points!us!
to!something!else!however!(Figure!34).!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
!
Figure!34.!The!world’s!smallest!AV!file!infection!detection!routine.!
Focusing!in!on!the!highlighted!code!blocks!we!see!the!use!of!a!random!number!generator!to!create!the!effect!
of!a!delayed!scanning!(Figure!35)!in!order!to!make!it!appear!as!if!it!is!actually!finding!viruses!while!it!displays!
fake!names!to!the!user.!!Examining!more!of!the!soNcalled!functionality!reveals!more!of!same!scamming.!
!
Figure!35.Fake!AV!using!random!delays!to!create!the!appearance!of!a!scan.!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
Mach:O!Viz:!Where!To!Go!From!Here!
!
!
As!we’ve!demonstrated,!MachNO!Viz!can!clearly!be!used!as!an!effective!tool!for!analyzing!Mac!related!
malware!both!for!the!OSX!and!iOS!operating!system!using!data!visualization.!!In!addition!to!the!many!features!
already!implemented,!we’d!like!to!include!the!following!functionality!in!future!versions:!
• Archiving!support!for!previously!analyzed!files.!
• Take!MachNO!Viz!into!the!Cloud!for!inline!automated!scanning!of!MachNO!files!for!Enterprise!networks.!
• Function!charting!across!multiple!binaries!looking!for!matching!code!sequences.!
• Visually!mapping!MachNO!Viz’s!file!and!graph!structures!into!an!active!debugger!such!as!LLVM.!
• Plugin!support!for!modular!enhancements.!
Conclusions!
!
!
MachNO!Viz!was!developed!to!fill!the!need!to!properly!and!easily!conduct!malware!analysis!on!Mac!
related!malware!regardless!of!the!architecture!or!device.!!By!creating!a!terminal!like!interface!using!
HTML/JavaScript!and!developing!a!powerful!backNend!analytic!engine!we’ve!managed!to!build!a!unique!and!
extremely!useful!tool!to!quickly!triage!MachNO!binaries!regardless!of!their!format,!visually!display!them!and!
provide!unique!and!automated!signatures!for!deployment!to!network!defense!systems.!
The!ability!for!network!security!staff!and!analysts!to!react!quickly!and!accurately!to!the!latest!Mac!threats!is!
critical,!especially!in!today’s!MacNcentric!world.!MachNO!Viz!provides!the!capability!required!to!easily!make!
this!happen!without!sacrificing!the!power!of!a!fullNfeatured!commercial!disassembler.!
!
!
!
!
!
!
!
Mach%O'Malware'Analysis:'Combatting'Mac'OSX/iOS'Malware'with'Data'Visualization!
!
About!ANRC!
!
ANRC!delivers!advanced!cyber!security!training,!consulting,!and!development!services!that!provide!our!
customers!with!peace!of!mind!in!a!fastNpaced!and!complex!cyber!security!environment.!
ANRC!was!formed!with!two!visions!in!mind:!to!provide!the!best!and!most!current!computer!security!education!
possible,!and!to!administer!that!education!through!a!revolutionary!new!approach,!endowing!our!customers!
with!knowledge!that!will!truly!be!usable,!valuable,!and!retainable.!!
Contact!
!
Mr.!Remy!Baumgarten!!
Security!Engineer,!ANRC!LLC.!
1N800N742N7931!
!