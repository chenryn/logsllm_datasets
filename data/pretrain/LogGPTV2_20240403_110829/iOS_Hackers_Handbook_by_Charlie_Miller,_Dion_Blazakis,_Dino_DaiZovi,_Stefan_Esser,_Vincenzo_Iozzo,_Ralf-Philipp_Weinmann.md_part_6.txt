these communications, see Apple’s Local and Push Notifi cation Programming
Guide in the iOS Developer Library.
Finally, the MDM server serves the MDM API over HTTPS. When an iOS
device receives an MDM push notifi cation, it contacts the MDM server at the
URL confi gured when the device was enrolled for management and queries the
MDM server directly for the sent command. The response to the downloaded
command is sent over HTTPS back to the MDM server. The MDM server may
optionally provide a Simple Certifi cate Enrollment Protocol (SCEP) server on
TCP port 1640, which is also built on top of HTTP. The protocol-level details
of the MDM API are beyond the scope of this chapter. For more information
on these, see David Schuetz’s presentation “Inside Apple’s MDM Black Box,”
presented at BlackHat USA 2011 (https://media.blackhat.com/bh-us-11/
Schuetz/BH_US_11_Schuetz_InsideAppleMDM_WP.pdf).
Lion Server Profi le Manager
Lion Server’s Profi le Manager is a Ruby-on-Rails web application that acts as
an MDM API server and administration console. The initial setup and con-
fi guration is performed through the Server app, but after the initial setup,
most administration tasks are performed through a web browser to the Profi le
Manager web application.
Profi le Manager can apply settings on a user, user group, device, or device
group basis. If the devices’ owners have accounts in Open Directory, they can
cc0022..iinndddd 2288 44//1166//22001122 55::4422::2299 PPMM
Chapter 2 n iOS in the Enterprise 29
log in to the Profi le Manager web application directly to enroll and manage
their devices. If the devices are shared or the users do not have accounts in OD,
a Lion Server administrator will have to enroll their devices for them. Profi le
Manager supports a special type of profi le, called an Enrollment Profi le, to assist
in enrolling devices for remote management without requiring the user to log in
to the Profi le Manager web application. This chapter assumes that device owners
also have accounts in Open Directory on the Lion Server. For more information
on using Enrollment Profi les, consult the eBook “Managing iOS Devices with
OS X Lion Server” by Arek Dreyer from Peachpit Press.
Setting Up Profi le Manager
To set up Profi le Manager, launch the Server application and click Profi le Manager
in the sidebar. This brings up the basic Settings pane for Profi le Manager, as
shown in Figure 2.13. Before you can start the service, you have to perform some
basic confi guration. To get this started, click the Confi gure button.
Figure 2.13: Profile Manager service configuration in the Server application
cc0022..iinndddd 2299 44//1166//22001122 55::4422::2299 PPMM
30 Chapter 2 n iOS in the Enterprise
If you haven’t already confi gured your Lion Server as an Open Directory
(OD) master, you are guided through the process of doing so. An Open
Directory master is used by Profi le Manager to store device settings per OD
User and Group. The setup process prompts you for some basic settings for
the OD LDAP server and then confi gures and enables the service, as shown
in Figure 2.14.
Figure 2.14: Creating an Open Directory master
The Profi le Manager web application is available only over SSL. It is important
that communication with this web application is secure because it is used for
both device communication and profi le administration. The setup process asks
you to select an SSL certifi cate to use for the web service. Ideally, you should
use a properly formed SSL web server certifi cate issued by a trusted CA or your
cc0022..iinndddd 3300 44//1166//22001122 55::4422::3300 PPMM
Chapter 2 n iOS in the Enterprise 31
organization’s own internal CA. If your organization is smaller or if you are just
testing, you can also use the certifi cate that was automatically generated for your
server when it was made an Open Directory master. As shown in Figure 2.15,
this certifi cate is issued to your server’s hostname and signed by your server’s
Open Directory Intermediate CA.
Figure 2.15: Choosing an SSL certificate for the Profile Manager web application
To communicate with the Apple Push Notifi cation Service (APNS), your
Profi le Manager needs a client certifi cate to authenticate itself to Apple’s servers.
If you have not already confi gured your server to enable Apple Push notifi ca-
tions, the setup process requests a free APNS certifi cate from Apple for you.
To obtain an APNS certifi cate on Lion Server, all you need is an Apple ID. You
don’t need to be enrolled in the iOS Developer Enterprise Program (iDEP), as
cc0022..iinndddd 3311 44//1166//22001122 55::4422::3300 PPMM
32 Chapter 2 n iOS in the Enterprise
was required before Lion Server was released. You should create and use an
Apple ID for your organization, not one that is tied to a specifi c individual. In
the test setup shown in the fi gures in this chapter, we used the author’s Apple
ID. Using an individual’s Apple ID should be done only in testing, not in any
production environment.
To automatically create and download an APNS certifi cate, enter your orga-
nization’s Apple ID as shown in Figure 2.16.
Figure 2.16: Requesting an Apple Push Notification Service certificate
If you successfully completed all the previous confi guration steps, you
should see the screen shown in Figure 2.17 confi rming that your server has
cc0022..iinndddd 3322 44//1166//22001122 55::4422::3311 PPMM
Chapter 2 n iOS in the Enterprise 33
met all of the requirements to properly run Profi le Manager. After you click
the Finish button, you are returned to the main Profi le Manager confi gura-
tion pane.
Figure 2.17: Profile Manager configuration complete
For greater security, you should enable confi guration profi le signing. To do
so, check the Sign Confi guration Profi les check box, as shown in Figure 2.18.
Next you will need to select a code-signing certifi cate to sign the profi les. If you
already have a code-signing certifi cate for your organization (perhaps one issued
by Apple’s iOS Developer Program), you can use that here. Otherwise, you should
use the certifi cate issued by your server’s Open Directory Intermediate CA.
cc0022..iinndddd 3333 44//1166//22001122 55::4422::3311 PPMM
34 Chapter 2 n iOS in the Enterprise
By signing the confi guration profi les with a certifi cate issued by a trusted cer-
tifi cate authority, you can help your users verify that the profi le they are about
to install is authentic.
Figure 2-18: Choosing a code-signing certificate to sign configuration profiles
Now Profi le Manager should be confi gured and ready to run. (See Figure 2.19.)
To start the service, click the switch in the upper-right corner to move it to the
ON position. The Profi le Manager service should now be running, and you can
create a confi guration profi le through the Profi le Manager web application. To
begin using the Profi le Manager web application, click Open Profi le Manager
at the bottom of the Profi le Manager confi guration pane.
cc0022..iinndddd 3344 44//1166//22001122 55::4422::3322 PPMM
Chapter 2 n iOS in the Enterprise 35
Figure 2.19: Profile Manager configured and enabled
Creating Settings
The login page for the Profi le Manager is shown in Figure 2.20. You should log
in using an administrator account for your Lion Server.
After you have logged in as an administrator, you see the main Profi le Manager
navigation screen, as shown in Figure 2.21. The Profi le Manager has a sidebar
with Library and Activity sections. If you have created an enrollment profi le
(discussed later), there will also be an Enrollment Profi les section of the sidebar.
The navigation pane in the center enables you to select a particular entity, and
the Confi guration pane on the right enables you to manage the confi guration
profi le for the selected entity. As you can see, you can create and manage device
settings per device, device group, user, or user group.
cc0022..iinndddd 3355 44//1166//22001122 55::4422::3322 PPMM
36 Chapter 2 n iOS in the Enterprise
Figure 2.20: Profile Manager login page
Figure 2.21: Profile Manager navigation
cc0022..iinndddd 3366 44//1166//22001122 55::4422::3333 PPMM
Chapter 2 n iOS in the Enterprise 37
The Profi le Manager confi guration pane in the Server application enables you
to select a default confi guration profi le that will be sent to newly enrolled users
and devices. By default, this is the Settings for Everyone profi le. The profi le is
reachable by clicking Groups in the sidebar and selecting the Everyone group.
If you click the Edit button in the confi guration pane, you can edit the associ-
ated confi guration profi le.
When you edit a confi guration profi le in Profi le Manager, you see a screen
similar to the one in Figure 2.22. You will notice that this looks very similar to
the user interface of the iPhone Confi guration Utility. This is not coincidental
because both are used to create confi guration profi les. There is one major dif-
ference with Profi le Manager, however. Profi le Manager splits the confi guration
profi le payloads into three sections — Mac OS X and iOS, iOS, and Mac OS
X — because Profi le Manager can also be used to manage settings for desktops
and laptops running Mac OS X Lion.
Figure 2.22: Settings for Everyone configuration profile
Similar to the process you use when creating a confi guration profi le using
the iPhone Confi guration Utility, you should enter a description for your profi le
and confi gure when (and if) the confi guration profi le can be removed.
Select Passcode on the left pane. If a Passcode payload has not yet been created,
you see the screen shown in Figure 2.23. To create the confi guration payload,
click the Confi gure button.
cc0022..iinndddd 3377 44//1166//22001122 55::4422::3333 PPMM
38 Chapter 2 n iOS in the Enterprise
Figure 2.23: Creating a Passcode configuration payload
The passcode settings shown in Figure 2.24 are identical to those that are
shown in the iPhone Confi guration Utility (refer to Figure 2.2). Again, this is
because the settings in both applications are used to create confi guration profi les
in the same format.
To complete the confi guration, click the OK button and then click the Save
button in the Confi guration pane to save your changes. If you have this profi le
assigned to any devices, saving the changes causes the updated profi le to be
pushed to those devices.
Enrolling Devices
Now that you have created a confi guration profi le using Profi le Manager, you
need to enroll a device to have the profi le applied to it. To get started, make
sure that your iOS device is on a network that can reach the server running
Profi le Manager.
You should enter the URL of Profi le Manager’s My Devices page into Mobile
Safari’s URL bar, as shown in Figure 2.25. For a simple confi guration, this will
be at https:///mydevices. In a production deployment, you will likely
send the URL to the Profi le Manager to users over e-mail or SMS.
cc0022..iinndddd 3388 44//1166//22001122 55::4422::3333 PPMM
Chapter 2 n iOS in the Enterprise 39
Figure 2.24: Configuring passcode requirements
Figure 2.25: Connecting to the Profile Manager server in Mobile Safari
cc0022..iinndddd 3399 44//1166//22001122 55::4422::3344 PPMM
40 Chapter 2 n iOS in the Enterprise
At the profi le Manager login page (shown in Figure 2.26), you should log in
as a user account that exists in Open Directory.
Figure 2.26: Profile Manager login page
After you have logged in, you are shown the My Devices page, as shown in
Figure 2.27. If the device that you are using has not yet been enrolled in Profi le
Manager, you are shown a button to enroll it. First, however, you need to install
the Trust Profi le for your server so that you can properly verify the signature
of the enrollment profi le.
Figure 2.27: My Devices screen
cc0022..iinndddd 4400 44//1166//22001122 55::4422::3344 PPMM
Chapter 2 n iOS in the Enterprise 41
If you tap the P rofiles tab, you are shown a list of available profiles.
(See Figure 2.28.) You should install the Trust Profi le fi rst because it includes the
certifi cates used to sign the other profi les. To install the profi le, tap the Install
button to the right of the name of the Trust Profi le.
Figure 2.28: My Devices Profiles list
After you tap the Install button, you see a confi rmation screen like the one
shown in Figure 2.29. For more information on the profi le, tap More Details. To
install the profi le, tap the Install button.
Figure 2.29: Confirmation screen to install Trust Profile
cc0022..iinndddd 4411 44//1166//22001122 55::4422::3355 PPMM
42 Chapter 2 n iOS in the Enterprise
Because the Trust Profi le cannot be verifi ed, you see a warning screen like the
one shown in Figure 2.30. This screen notifi es the user that her list of trusted
root certifi cates will be changed.
Figure 2.30: Trust Profile warning screen
Now, if you go back to the My Devices screen and tap the Enroll button to
enroll your device, you see a screen like the one in Figure 2.31. The green Verifi ed
label indicates that the profi le’s signature has been verifi ed and is trusted. Tap
the Install button to install the Device Enrollment profi le, which enables remote
device management for this device.
Figure 2.31: Device Enrollment confirmation screen
cc0022..iinndddd 4422 44//1166//22001122 55::4422::3355 PPMM
Chapter 2 n iOS in the Enterprise 43
A warning screen like the one shown in Figure 2.32 displays. Notice that it
gives the full URL to the API endpoint used for device management.
Figure 2.32: Mobile Device Management warning screen
After the profi le has been installed, you see a screen like the one in Figure 2.33.
Figure 2.33: Profile installation completion screen
You can tap More Details to see the certifi cates included in the profi le and
used to sign it, as well as to get more information on the Device Management
cc0022..iinndddd 4433 44//1166//22001122 55::4422::3366 PPMM
44 Chapter 2 n iOS in the Enterprise
profi le that was installed. You should see a details screen similar to the one
shown in Figure 2.34.
Figur e 2.34: Remote Management details screen
Now, if you go back to the My Devices page in Profi le Manager, you see your
device listed, as shown in Figure 2.35. From this page, you can remotely lock,
wipe, or clear the passcode on your device.
Figure 2.35: My Devices screen after enrollment
cc0022..iinndddd 4444 44//1166//22001122 55::4422::3377 PPMM
Chapter 2 n iOS in the Enterprise 45
Summary
Any iOS device that will be used to store or access sensitive enterprise data
must be confi gured to adequately protect it. This includes requiring a strong
passcode, auto-lock, and other security-related confi guration settings. Although
this could be ensured by having IT administrators manually confi gure each
user’s device, this is labor-intensive and error-prone. Centrally managing these
confi gurations is a much better approach.
This chapter described two alternatives for centrally managing iOS con-
figurations: the iPhone Configuration Utility and Lion Server’s Profile
Manager. The iPhone Confi guration Utility is much easier and faster to get
started with, but it does not scale well to many devices. For a larger num-
ber of devices, a Mobile Device Management (MDM) solution such as Lion
Server’s Profile Manager is a much better solution. In addition to pro-
viding the same configuration features, an MDM solution also provides
additional capabilities such as remotely locking, wiping, or clearing the
passcode.
cc0022..iinndddd 4455 44//1166//22001122 55::4422::3377 PPMM
cc0022..iinndddd 4466 44//1166//22001122 55::4422::3377 PPMM
CHAPTER
3
Encryption
Mobile devices face an increased risk of sensitive data compromise through a
lost or stolen device compared to traditional desktop workstations. Although
traditional workstations and laptops may be protected by Full Disk Encryption
with pre-boot authentication, most mobile platforms cannot perform any pre-boot
authentication. The data encryption facilities provided by the mobile platform,
if any, are available only after the device has booted up. The limited data input
possibilities on a touch screen or mobile device keyboard also make entering
long passphrases infeasible. All of this makes data protection on mobile devices
more challenging.
In this chapter, we discuss the primary facility for securing data-at-rest in
iOS, the Data Protection API. We will demonstrate how application developers
may use it and also how it may be attacked by booting the iOS device using a
custom ramdisk. We will also demonstrate how easily and quickly four-digit
passcodes can be guessed to fully decrypt all of the data encrypted using the
Data Protection API on an iOS device.
Data Protection
In iOS 4, Apple introduced the Data Protection API, which is still in use
today in iOS 5. The Data Protection API was designed to make it as simple
as possible for application developers to suffi ciently protect sensitive user
47
cc0033..iinndddd 4477 44//1166//22001122 55::4433::1122 PPMM
48 Chapter 3 n Encryption
data stored in fi les and keychain items in case the user’s device is lost. All
the developer has to do is indicate which fi les or items in the keychain may
contain sensitive data and when that data must be accessible. For example,
the developer may indicate that certain fi les or keychain items contain sensi-
tive data that needs to be accessible only when the device is unlocked. This
is a common scenario, because the device must be unlocked for the user to
interact with the application. Alternatively, the developer may indicate that
certain fi les or keychain items must always be accessible and thus cannot
be protected when the device is locked. In the application source code, the
developer marks protected fi les and keychain items using constants that
defi ne their protection class. The various protection classes are differentiated
by whether they protect fi les or keychain items and when the data protected