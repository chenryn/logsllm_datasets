Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used to create accounts or additional sessions in the machine the attacker has infected or to communicate with other hosts.
- "Field Value"
During an Attack
Authority Administrator
Targeted OS Windows
Operating Domain Not required
Condition Communication -
Protocol *With domain administrator, accounts can also be created on the Domain Controller.
Service -
Information Standard Settings - The fact that a user has been added is recorded in a log.
Acquired from Additional Settings - A user name and password specified by the "net user" command are recorded (Sysmon).
Evidence That Can Be Confirmed If the following log is in the event log, it is considered that a user was added.
When Execution is Successful - The Event ID 4720 is recorded in the event log "Security".
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name:"C:\Windows\System32\net.exe"
"C:\Windows\System32\net1.exe" *After net.exe is executed, net1.exe is
executed as a child process.
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
*It is type 1 or 2 because administrator rights are required.
- Process Return Value: Process Information -> Exit Status
Event Log Event ID: 4656 (SAM - A handle to an object was requested)
- - Process Information -> Process Name: "C:\Windows\System32\lsass.exe" Required
Security - Object -> Object Type: "SAM_DOMAIN"
- Confirmable Information
- Handle ID: Object -> Handle ID *Used for association with other logs
- Requested Process: Access Request Information -> Access ("ReadPasswordParameters" / "CreateUser" / "LookupIDs")
Host - Success or Failure: Keywords ("Audit Success")
-
(Windows)
Event ID: 4720 (A user account was created)
- New Account -> Account Name: A user name specified by the "net user" command
- Confirmable Information
- User Group: Attribute -> Primary Group ID
*Depending on the details of the process executed, a different event (such as 4722, 4724, 4726, 4737, and 4738) is recorded.
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "C\Windows\System32\net.exe"
"C:\Windows\System32\net1.exe"
Event Log
- - Confirmable Information Required
Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *The fact that a user was added (user /add) and the user name
and password (if passed to the argument) are recorded in the argument.
- User Name: User
- Process ID: ProcessId
Remarks
Additional Event Logs That Can Be Output If addition to a group or others were performed, the relevant access history is recorded.
57
3.12.1. net use
Basic Information
Tool Name net Command (net use) Legend
Category File Sharing - Acquirable
Tool Overview Connects to shared folders that are publicly available on the network Information
Tool - Event ID/Item Name
Example of This tool is used to send in tools to be used during attacks via shared folders and to acquire information from a file server.
- Field Name
Presumed Tool Use - Source host: net command execution source
- "Field Value"
During an Attack - Destination host: the machine accessed by the net command
Authority Standard user
Targeted OS Windows
Operating Domain Not required
Condition Communication
445/tcp
Protocol
Service Destination host: Server, Source host: Workstation
Standard Settings -
Information
- Source host: Execution history (Sysmon / audit policy)
Acquired from
Additional Settings - Destination host: Although a record of using Windows Filtering Platform remains, audit policy of read data is required to confirm the specific access path.
Log
*If a write is made to a shared point, it is recorded in the audit policy of write data.
Evidence That Can Be Confirmed - Source host: If the following log is in the event log, it is possible that file sharing occurred.
When Execution is Successful - The Event ID 4689 (A process has exited) of net.exe was recorded in the event log "Security" with the execution result (return value) of "0x0".
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\net.exe"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
Event Log - Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- - Process Return Value: Process Information -> Exit Status Required
Security
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Network Information -> Direction: "Outbound"
- Network Information -> Destination Address: "[Host Specified as a Shared Folder]"
Source host
- Network Information -> Destination Port / Protocol: "445" / "6"(TCP)
- Confirmable Information
- Source Port: Network Information -> Source Port
Event ID: 1 (Process Create)
OS: Windows 5 (Process Terminated)
user - Image: "C\Windows\System32\net.exe"
â†“ Execution History
OS: Windows - - Confirmable Information Required
user Sysmon - Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *The destination host and share path are recorded.
- User Name: User
- Process ID: ProcessId
Event ID: 5156 (The Windows Filtering Platform has allowed a connection)
- Network Information -> Direction: "Inbound"
- Network Information -> Source Address: "[IP Address of the File Server]"
Event Log
- Network Information -> Source Port / Protocol: "445" / "6"(TCP)
Destination host - Required
Security
- Confirmable Information
- Source Host: Network Information -> Destination Address
- Source Port: Network Information -> Destination Port *Matches the source port of the source host
Event ID: 4624 (An account was successfully logged on)
- Logon Type: "3"
Event Log - Network Information -> Source Network Address: "[Destination Address in Event 5156]"
Active Directory
- - Network Information -> Source Port: "[Destination Port Recorded in Event 5156]" Required
Domain Controller
Security
- Confirmable Information
- Used User: New Logon -> Account Name / Account Domain
Remarks
- If read data is enabled in the audit policy, the connected share path is recorded in the event 5140 (file sharing).
Additional Event Logs That Can Be Output
- If write access is made to a share point, it is recorded in audit of object access.
58
3.12.2. net share
Basic Information
Tool Name net Command (net share) Legend
Category File Sharing - Acquirable
Tool Overview Shares particular folders so that they are available via network Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used to create a share path on the host the attacker has infected to read and write files.
- "Field Value"
During an Attack
Authority Administrator
Targeted OS Windows
Operating Domain Not required
Condition Communication
- *Although a shared path is used via network, adding a shared folder with "net share" is completed on the machine.
Protocol
Service Server
Information Standard Settings - Information on a share path may be left on the registry. *The value will be cleared when shared folder is disabled.
Acquired from Additional Settings - Execution history (Sysmon / audit policy) *The shared path and used share name are recorded.
Evidence That Can Be Confirmed If the following log is in the event log, it can be deemed that a shared folder was created.
When Execution is Successful - The event ID: 5142 is recorded in the event log "Security".
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\net.exe"
"C:\Windows\System32\net1.exe"
*After net.exe is executed, net1.exe is executed as a child process.
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
Event Log - Domain of User Who Executed the Process: Subject -> Account Domain
- - Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type Required
Security *It is type 1 or 2 because administrator rights are required.
- Process Return Value: Process Information -> Exit Status
Event ID: 5142 (A network share object was added)
- Confirmable Information
- Share Name: Shared Information -> Share Name
Host - Folder Used for Sharing: Share Path
-
(Windows)
Event IDs: 1 (Process Create)
5 (Process Terminated)
- Image: "C\Windows\System32\net.exe"
"C:\Windows\System32\net1.exe"
Event Log
- Required
- Confirmable Information
Sysmon
- Process Start/End Time and Date (UTC): UtcTime
- Process Command Line: CommandLine *The share name and folder used for sharing are recorded in the argument.
- User Name: User
- Process ID: ProcessId
Registry Entry:
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\
Access History
Shares\Security\[Share Name]$
- *The entry is created when shared folder is enabled (when it is disabled, the value is cleared). -
Registry Since the value is cleared when sharing is disabled, it is difficult to detect an attack unless there is a system for always
monitoring the registry.
Remarks
Additional Event Logs That Can Be Output -
59
3.12.3. icacls
Basic Information
Tool Name icacls Legend
Category File Sharing - Acquirable
Tool Overview Changes the file access rights Information
Tool - Event ID/Item Name
Example of
- This tool is used to change the rights to read a file that cannot be read by the used account. - Field Name
Presumed Tool Use
- It is also used to capture rights so that the content of a file created by the attacker will not be viewable. - "Field Value"
During an Attack
Standard user
Authority
* When the Access Control List (ACL) has been changed, appropriate rights for the relevant files are required.
Targeted OS Windows
Operating
Domain Not required
Condition
Communication
-
Protocol
Service -
Information Standard Settings Execution history (Prefetch)
Acquired from
Log Additional Settings Execution history (Sysmon / audit policy)
If the following log is in the event log, it is considered that file access rights were changed.
Evidence That Can Be Confirmed - The Event IDs: 4688 and 4689 on icacls.exe are recorded in the event log "Security", and the Exit Status in the event ID: 4689 is set to "0x0".
When Execution is Successful *Since it is not possible to determine the target files from the Event IDs 4688 and 4689, it is necessary to additionally check the command line of icacls.exe
from the event ID 1 of sysmon.
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "C:\Windows\System32\icacls.exe"
Event Log
- Confirmable Information
- Required
- Process Start/End Time and Date: Log Date
Security
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event ID: 1 (Process Create)
Host
- 5 (Process Terminated)
(Windows)
- Image: "C:\Windows\System32\icacls.exe"
Execution History
- - Confirmable Information Required
Sysmon - Process Start/End Date and Time (UTC): UtcTime
- Process Command Line: CommandLine *The target file and set rights are recorded in the argument.
- User Name: User
- Process ID: ProcessId
File name:
Execution History C:\Windows\Prefetch\ICACLS.EXE-CCAC2A58.pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Executed Time and Date: Last Execution Time
Remarks
Additional Event Logs That Can Be Output -
60
3.13.1. sdelete
Basic Information
Tool Name sdelete Legend
Category Deleting Evidence - Acquirable
Tool Overview Deletes a file after overwriting it several times Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use This tool is used to delete a file created in the course of an attack to make it impossible to be recovered.
- "Field Value"
During an Attack
Authority Standard user
Targeted OS Windows
Operating
Domain Not required
Condition
Communication Protocol -
Service -
- Execution history (Prefetch)
Information Standard Settings - A statement to the effect that a license agreement on the use of sdelete was consented is recorded in the registry. *If the tool was used in the past, it cannot be confirmed from the
Acquired from information obtained under the standard setting.
Log - Execution history (Sysmon / audit policy)
Additional Settings
- A record of deleting and overwriting the file to be deleted during the audit of object access
Evidence That Can Be Confirmed - A file with its name similar to the following was repeatedly deleted.
When Execution is Successful - Example: sdeleAAAAAAAAAAAAAAAAAAAA.AAA, sdeleZZZZZZZZZZZZZZZZZZZZ.ZZZ when the target to be deleted is sdelete.txt
Points to be Confirmed
Log Generation Additional
Communication Log Type and Name Acquired Information Details
Location Settings
Event ID: 4688 (A new process has been created)
4689 (A process has exited)
- Process Information -> Process Name: "[File Name (sdelete.exe)]"
- Confirmable Information
- Process Start/End Time and Date: Log Date
- Name of User Who Executed the Process: Subject -> Account Name
- Domain of User Who Executed the Process: Subject -> Account Domain
- Presence of Privilege Escalation at Process Execution: Process Information -> Token Escalation Type
- Process Return Value: Process Information -> Exit Status
Event Log
- Event ID: 4656 (A handle to an object was requested) Required
Security 4663 (An attempt was made to access an object)
4658 (The handle to an object was closed)
- Process Information -> Process Name: "[File Name (sdelete.exe)]"
- Confirmable Information
- File to be Deleted: Object -> Object Name
*In the course of deleting a file by overwriting it, sdelete creates a file with its name consisting of a combination of
the name of the file to be deleted and some letters, and repeats the delete operation.
(Example: sdeleAAAAAAAAAAAAAAAAAAAA.AAA when the target to be deleted is sdelete.txt)
- Process Details: Access Request Information -> Access
Host *For the same object, "DELETE" or "WriteData or AddFile" is repeated.
-
(Windows) - Success or Failure: Keywords ("Audit Success")
Event ID: 1 (Process Create)
5 (Process Terminated)
- Image: "[File Name (sdelete.exe)]"
Event Log
- Confirmable Information
- Required
- Process Start/End Time and Date (UTC): UtcTime
Sysmon
- Process Command Line: CommandLine *In addition to the executable file, the number of overwriting operations
and other options passed to sdelete.exe can be found.
- User Name: User
- Process ID: ProcessId
File name:
Execution History C:\Windows\Prefetch\[File Name (SDELETE.EXE)]-[RANDOM].pf
- -
- Confirmable Information (the following can be confirmed using this tool: WinPrefetchView)
Prefetch
- Last Execution Time and Date: Last Execution Time
Execution History Registry Entry:
HKEY_USERS\[SID]\Software\Sysinternals\Sdelete
- - When the tool is used for the first time, the effect that the license agreement was consented is recorded in EulaAccepted. -
Registry - If sdelete was used on the machine in the past, it is not possible to determine its use by the attacker.
Remarks
Additional Event Logs That Can Be Output -
61
3.13.2. timestomp
Basic Information
Tool Name timestomp Legend
Category Deleting Evidence - Acquirable
Tool Overview Changes the file timestamp Information
Tool - Event ID/Item Name
Example of
- Field Name
Presumed Tool Use For a file whose timestamp has changed as a result of the use by the attacker, this tool is used to conceal the access to the file by restoring the timestamp.
- "Field Value"
During an Attack
Authority Standard user