KNOCK? KNOCK? WHOIS THERE? 
APT ATTRIBUTION AND DNS PROFILING 
Frankie Li 
PI:EMAIL 
Twitter: @espionageware 
• 
APT Attribution: Who wrote these codes? 
• 
Tactics, Techniques and Procedures (TTP) 
• 
Behavior of APT adversary 
• 
HUMINT extracted from DNS 
• 
Gather intelligence from open source (aka OSINT) 
• 
Dynamically monitoring of PassiveDNS è PassiveWhois 
• 
Analysis by visualization tool (Maltego) 
• 
Tools and demo 
AGENDA 
• 
From a place in China, but not so China ;) 
• 
Sunday researcher in malware analysis and digital forensics  
• 
Part time lecturer 
• 
A Lazy blogger (espionageware.blogspot.com) 
• 
NOT associated with PLA 61398 or Mandiant 
• 
NOT associated with PLA 61486 or CrowdStrike or Taia Global or ThreatConnect 
WHO AM I? 
APT ATTRIBUTION 
• 
Disclaimer: Not going to provide any opinion on the latest indictment or 奶⻩黄包 or 楼主 or 
上海钟楼 
• 
http://espionageware.blogspot.com or Twitter: @espionageware 
• 
Not a concern for private sector, but for LE or intelligence agencies 
• 
Not difficult, if you have source code 
• 
Not hard, if you focus only on strings & human readable data within a malware program 
• 
But, to attribute responsibility with “Certainty” is almost impossible, unless they make a 
mistake 
APT ATTRIBUTION 
• 
Source code attribution 
• 
Attributes of Windows binaries 
• 
Attribution malware 
• 
Attribution of APT by digital DNA 
WHO WROTE THESE CODES? 
• 
Stylometry, the application of attribute the authorship by coding style 
• 
Kind of profiling by writing style 
• 
Comments and coding crumbs 
• 
JStylo: By comparing unknowns documents with a known candidate author’s document* 
• 
Not a solution because most APT samples collected are compiled binaries 
SOURCE CODE ATTRIBUTION 
*Islam, A. (2013). Poster: Source 
Code Authorship Attribution 
• 
PE headers are des-constructed and metadata (artifacts) are categorized (Yonts, 2012) 
• 
Extract the technical and contextual attributes or “genes” from different “layers” to group the 
malware (Xecure-Lab, 2012 and Pfeffer, 2012) 
• 
By a proprietary reverse engineering and behavioral analysis technology (Digital DNA, 2014) 
ATTRIBUTES OF WINDOWS MALWARE 
PE DECONSTRUCTION 
ATTRIBUTION USING GENETIC INFORMATION 
From: Xecure-Lab, 2012 
• 
Sensational names created for APT actors: 
• 
(09) GhostNet 
• 
(10) Operation Aurora  
• 
(11) Lurid, Nitro, Night Dragon, 1.php, Shady RAT 
• 
(13) Comment Crew/APT1, Soysauce, Deep Panda, Red October, Net Traveler, SAFE …  
• 
(14) PutterPanda, PittyTiger (probably not a state-sponsored group) 
IDENTIFIED APT GROUPS? 
TACTICS, TECHNIQUES AND PROCEDURES 
(TTP) 
• 
Attribution: Tracking Cyber Spies & Digital Criminals (Hoglund, 2010) 
• 
Forensics marks that could be extracted from raw data in three intelligence layers 
• 
Net Recon 
• 
Developer Fingerprints  
• 
Tactics, Techniques, and Procedures (TTP) 
• 
Among these three layers, TTP should carry the highest intelligence value for identifying 
human attackers 
• 
But, near impossibility of finding the human actors with definitive intelligence 
• 
Social Cyberspace (i.e., DIGINT) 
• 
Physical Surveillance (i.e., HUMINT) 
HUMAN IS THE KEY 
http://www.youtube.com/watch?
v=k4Ry1trQhDk  
HOGLUND’S MALWARE INTEL LIFE TIME  
• 
Boman extracts technical metadata from a large collection of binaries 
• 
Store the identified artifacts in a relational database for further analysis 
• 
But still based on technological contexts from malware binaries instead of the behavior of the 
human working behind 
BOMAN’S VXCAGE 
• 
A military term? 
• 
A term to describe the behavior of adversary? 
• 
A modern term to replace modus operandi? 
• 
the method of operation 
• 
The habits of working 
• 
TTP are human-influenced factors 
TTP 
PYRAMID OF PAIN 
From David Bianco’s Blog 
http://detect-respond.blogspot.hk/2013/03/the-
pyramid-of-pain.html 
BEHAVIOR OF APT ADVERSARY 
APT LIFE CYCLE (KILL CHAIN) 
EXTENDED APT LIFE CYCLE 
• 
Domain registration 
• 
Naming convention is not typo squatting, but follows a pattern of meaningful Chinese 
PingYing （拼音） 
• 
Creation DNS-IP address pairs 
• 
Engaging a “friendly ISP” to use a portion of their C-class subnet of IP addresses situated at 
the domicile of the targeted victims 
• 
DNS names and IP addresses may be cycled for reuse (a.k.a. campaigns), which may 
provide indications or links to the attacker groups 
• 
Embedding multiple DNS A-records in exploits 
• 
Preparing spear-phishing email content after reconnaissance of the targeted victims 
• 
Launching malicious attachments through spear-phishing emails 
ASSUMED APT INFRASTRUCTURE TACTICS 
• 
The exploits drop binaries that extract the DNS records and begin communicating with the C2 
by resolving the IP addresses from DNS servers.  
• 
The C2 servers or C2 proxies register the infections on the C2 database 
• 
The intelligence analysts of the attacker groups review the preliminary collected information of 
the targeted victims through C2 portals.  
• 
The infected machines are further instructed to perform exfiltration of collect further 
intelligence from the infected machines. 
• 
The infrastructure technical persons of the attacker group apply changes (domain 
manipulation) to the DNS-IP address pair, domain name registration information (Whois 
information), and the “parked domains” from time to time or when a specific incident occurs  
• 
In contrast with the Fast-Flux Services Networks mentioned by the HoneyNet Project, the 
information does not change with high frequency 
ASSUMED APT INFRASTRUCTURE TACTICS-2 
HUMINT EXTRACTED FROM DNS & WHOIS 
• 
Domain names: A Record, Cname, NS record 
• 
Whois records: valid email address (at least once), name, street address, name servers 
• 
Parked-domains: temporary IP address assigned creation of first DNS record on the name 
server (newly created domains are kept under 1 IP address for future use) 
WHAT IS KEPT IN DNS & WHOIS 
• 
Extract DNS from the malicious code (sandbox) 
• 
Lookup the currently assigned IP address 
• 
Retrieve all parked-domains from the identified IP address 
• 
Retrieve whois information from the identified domains 
• 
Update identified record to a relational database for future analysis 
• 
Repeat the process and record all changes in the database 
HUMINT INTEL TO BE COLLECTED 
INTEL COLLECTION PROCESS 
the only available weapon we have 
QUERIES FROM OPEN SOURCE 
OSINT 
• 
Nslookup 
• 
Whois 
• 
Domain tools: reverse DNS and reverse whois 
• 
http://bgp.he.net 
• 
http://virustotal.com 
• 
http://passivedns.mnemonic.no 
• 
https://www.farsightsecurity.com 
• 
https://www.passivetotal.org 
OSINT 
DOMAINTOOLS – OUCH! 
HTTP://BGP.HE.NET 
PASSIVE DNS TO PASSIVE WHOIS 
• 
Passive DNS is a technology that constructs zone replicas without cooperation from zone 
administrators, and is based on captured name server response 
• 
Passive DNS is a highly scalable network design that stores and indexes both historical DNS 
data that can help answer questions such as: 
• 
where did this domain name point to in the past 
• 
which domain name points to a given IP network 
• 
VirusTotal kept passive DNS records collected from malicious samples 
• 
Higher chance to find malicious historical DNS-IP records  
PASSIVE DNS 
VIRUSTOTAL - PASSIVEDNS 
• 
There are no open source keeping those whois changes, like VirusTotal Passive DNS project 
(or whois history at who.is) 
• 
By stepping through the IP lookup, retrieval of parked-domains and whois lookup, any 
changes will then be updated to a relational database 
PASSIVE WHOIS 
PASSIVE WHOIS 
ANALYSIS BY VISUALIZATION 
MALTEGO 
SAMPLE CALLED OVERPROTECT 
CONCLUSION 
• 
Continuously monitoring “whois servers” and DNS–IP address pairs 
• 
Intelligence may be lost if they change their TTP in the future, particularly after the publication 
of this paper 
• 
TTP are determined by the cultural background of the attacker groups 
• 
The intelligence collection process should thus be adjusted toward these changes and 
analysts should have the same cultural mindset 
INTUITIVE VIEWS ON THE ATTRIBUTION OF  
APT ATTACKERS  
• 
All discussed methods may generate some value to the attribution 
• 
But, TTP should carry the highest intelligence value for identifying human attackers 
• 
Any artifacts that support the highest human link should be allocated with highest value to the 
attribution 
• 
If APT Attribution with Certainty is line starting from 0 to 100%, any artifacts extracted from 
malware may have some value in this line. No only well funded threat intelligence companies 
can perform a objective and conclusive attribution 
• 
However, the increasing sharing of TTP and tools by various actors may reduce the reliability 
to associate with them. (I even read a paper promoting a framework called OpenAPT) 
• 
As a result, the actor groups boundaries are blurred and Espoionage-As-A-Service will be 
expected 
• 
Another challenging factor is attribution intelligence are not shared enough and intelligence 
community are not fully understood 
IS ATTRIBUTION WITH CERTAINTY POSSIBLE? 
https://code.google.com/p/malicious-domain-profiling/ 
THE TOOLS 
• 
The tools consists of 2 parts: 
• 
MalProfile script to grabbing intelligence from the Internet 
• 
Maltego Local Transforms to help analysis process 
MALPROFILE AND MALTEGO TRANSFORM 
MALPROFILE.PY 
FURTHER RESEARCH 
PLUG-INS 
• 
The script is modified as a class to allow plugins be added 
• 
To allow more intelligence can be added when new TTP be identified 
• 
Or, combined the technical context be included as a supplement when performing intelligent 
analysis 
MALPROFILE.PY  
• 
Special thanks go to Kenneth Tse, Eric Yuen who is upgrading my messy code into a class 
and Frank Ng help me to manage the project  
• 
You can find the code at: https://code.google.com/p/malicious-domain-profiling/ 
• 
Any interested are welcome to contribute to this project. Please contact 
PI:EMAIL or PI:EMAIL 
GOOGLE PROJECT 
MALICIOUS-DOMAIN-PROFILING 
HTTP://WWW.YOUTUBE.COM/RESULTS?
SEARCH_QUERY=MALPROFILE 
MALPROFILE TRANSFORM INSTALLATION  
USING MD5 WITH OSINT FROM XECSCAN J 
PITTY TIGER ANALYSIS 
DEMO 
SAMPLE CALLED INSURANCE & JAPAN 
Frankie Li 
PI:EMAIL 
http://espionageware.blogspot.com 
THANK YOU! 
Q&A 
Frankie Li 
PI:EMAIL 
http://espionageware.blogspot.com 
PLEASE COMPLETE THE SPEAKER 
FEEDBACK SURVEYS