Irongeek.com 
Adrian Crenshaw 
Irongeek.com 
 I run Irongeek.com 
 I have an interest in InfoSec 
education 
 I don’t know everything - I’m just a 
geek with time on my hands 
 (ir)Regular on the ISDPodcast 
http://www.isdpodcast.com  
 Researcher for Tenacity Institute 
http://www.tenacitysolutions.com  
Irongeek.com 
 Darknets: There are many definitions, but the one 
I’m working from is “anonymizing networks” 
 Use of encryption and proxies (some times other 
peers) to obfuscate who is communicating to whom 
 Sometimes referred to as Cipherspace (love that 
term) 
 Tor and I2P will be my reference examples, but 
there are others 
Irongeek.com 
 Things get subtle 
 Terms vary from researcher to researcher 
 Many weaknesses are interrelated 
 Other anonymizing networks: 
Morphmix/Tarzan/Mixminion/Mixmaster/JAP/MUT
E/AntsP2P/Haystack 
 Focus on Tor and I2P for illustrations when needed 
 Academic vs. real world 
Irongeek.com 
Threat Model: You can’t protect against everything! 
 Some protocols may be lost causes 
 Users may do something to reveal themselves 
 Does an attack reveal the Client/Host or just reduces the anonymity set? 
Active vs. Passive attackers 
Location, Location, Location:  
 Internal vs. External 
Adversaries: Vary by power and interest 
 Nation States 
 Western Democracies vs. Others 
 Government agency with limited resources 
 ISP/Someone with a lot of nodes on the network 
 Private interests groups (RIAA/MPAA) 
 Adrian (AKA: Some shmuck with time on his hands)  
Irongeek.com 
 Layered encryption 
 Bi-directional tunnels 
 Has directory servers 
 Mostly focused on out proxying to the Internet 
 More info at https://www.torproject.org  
Internet Server 
Directory Server 
Irongeek.com 
 Unidirectional connections: In tunnels and out tunnels 
 Information about network distributed via distributed hash 
table (netDB) 
 Layered encryption 
 Mostly focused on anonymous services 
 More info at http://www.i2p2.de/  
Irongeek.com 
EIGamal/SessionTag+AES from A to H 
Private Key AES from A to D and E to H 
Diffie–Hellman/Station-To-Station protocol + AES 
Image from http://www.i2p2.de/  
Irongeek.com 
Make a 
Garlic 
message to 
multiple 
destinations. 
Then send it. 
Unpack it 
and send 
individual 
cloves to 
their 
destinations. 
Adrian 
Brian 
Calvin 
Dave 
Irongeek.com 
You are only as anonymous as the data you 
send! 
Irongeek.com 
Mostly Tor centric: 
 Is the exit point for traffic looking at the data? 
 Traffic may be encrypted inside the network, but 
not once it is outbound! 
Irongeek.com 
 Dan Egerstad and the “Embassy Hack” 
http://www.wired.com/politics/security/news/200
7/09/embassy_hacks  
 Tons of passwords sent via plain text protocols 
(POP3/SMTP/HTTP Basic/Etc) 
 Moxie Marlinspike did something similar with 
SSLStrip 
http://intrepidusgroup.com/insight/2009/02/moxie
-marlinspike-un-masks-tor-users/  
Irongeek.com 
I could just look 
at the traffic, or 
modify it and 
send it back as 
part of another 
type of attack. 
Irongeek.com 
 Tor is for anonymity, not necessarily security 
 Use end-to-end encryption/Don’t use plain-text 
protocols 
 Plain text protocols that send usernames/email 
addresses in the clear are not very anonymous now 
are they? 
Irongeek.com 
Irongeek.com 
 Does all traffic go though the proxy? 
 DNS Leaks are a classic example 
 Badly configured proxy setting could lead some types of 
traffic to go elsewhere (outside of cipherspace) 
 Snooper can use web bugs to figure out your location 
http://www.irongeek.com/i.php?page=security/webbugs  
 HTTPS is a good example, but plugins can also be an issue 
 Application level stuff in general is a problem 
 Javascript is just hosed as far as reducing you anonymity set 
See: Gregory Fleischer, DEFCON 17: Attacking Tor at the Application Layer  
Irongeek.com 
DNS  
Query  
Monitored DNS Server 
If I don’t use the 
proxy for DNS, I 
may send the 
query to a DNS 
server. It won’t 
see my traffic 
to/from the 
destination, but 
may now know 
I’m visiting 
someplace.com/
.onion/.i2p 
Irongeek.com 
Sniff for traffic leaving your box on port 53. The libPcap capture filter: 
port 53 
should work in most cases. 
In Firefox, under about:config set network.proxy.socks_remote_dns to 
true 
Torbutton should help 
Other applications vary 
May have to firewall off 53 in some cases 
May want to edit torrc, and add: 
     DNSPort 53 
     AutomapHostsOnResolve 1 
Then set your box’s DNS to point to 127.0.0.1 
Irongeek.com 
I host an 
eepSite, but not 
all of the 
content is HTTP! 
Could be an 
image over 
HTTPS, or a bad 
plugin. 
Irongeek.com 
Cookie image from brainloc on sxc.hu via Wikipedia 
I see the same 
session cookie 
as one I 
handed out 
over the public 
Internet. Guess 
I know who 
this is! 
Just checked 
out this site 
via the public 
Internet, now 
I want to use 
a proxy to 
look at it. 
Irongeek.com 
Let’s see if the 
hidden server 
app is 
vulnerable to an 
exploit (buffer 
overflow/web 
app shell 
exec/etc).  
Send a payload 
that contacts an 
IP I monitor. 
Exploit & 
Payload 
Irongeek.com 
If Tor is only 
being used for 
contacting the 
tracker, I could 
just watch 
Announce 
Messages & 
Extension 
Protocol 
Handshakes to 
extract real IPs. 
See this paper for more info: 
Compromising Tor Anonymity Exploiting P2P Information Leakage 
Pere Manils, Abdelberi Chaabane, Stevens Le Blond, 
Mohamed Ali Kaafar, Claude Castelluccia, Arnaud Legout, Walid Dabbous 
http://hal.inria.fr/docs/00/47/15/56/PDF/TorBT.pdf  
Evil Exit  
Point 
Tracker 
Announce Message/ 
Extension Protocol 
Handshake 
UDP DHT  
Message 
DHT  
(Distributed Hash Table) 
Nodes 
Even if the peer 
traffic is sent 
over Tor, if the 
DHT is used the  
IP may still be 
revealed 
because the 
UDP packets are 
not sent over 
Tor. I can scrap 
the DHT myself,  
and correlate an 
IP based on the 
PeerID/port I 
saw going 
through my exit 
point. 
Again, If Tor is 
only being used 
for contacting 
the tracker and 
SSL is not used, I 
could change 
the returned 
peers list to 
point to me as 
one of the 
sources and 
watch for the 
outside contact, 
then try to 
correlate an IP 
based on 
PeerID/port. 
I may then be 
able to infer the 
sender/receiver 
of other non-
Bittorrent traffic 
because of Tor’s 
shared circuits.  
Irongeek.com 
Irongeek.com 
Client wise: 
Make sure your browser is set to send all traffic though the darknet, or 
none at all 
Look into firewall rules 
Limit plugins used 
Use a separate browser 
Check against: 
http://decloak.net/  
http://panopticlick.eff.org/  
Hidden server wise: 
Patch your stuff 
Don’t run on a box that routes to the Internet 
Irongeek.com 
Irongeek.com 
 Not so much against individual nodes, but the network in 
general 
 Whole bunch of categories, not comprehensive: 
 Starvation attacks 
 Partition attacks 
 Flooding 
 Standard DDoS attacks against resources inside and outside 
of the network (if going though the network) are likely to be 
soaked by other peers 
 Shared known infrastructure can be a problem 
 Total (or at least severe) blocking of the Internet  
Irongeek.com 
 China blocked access to the core directory servers 
of Tor on September 25th 2009 
https://blog.torproject.org/blog/tor-partially-
blocked-china  
 Other blocking of Internet access. (Egypt, Libya, 
Iran) 
Irongeek.com 
Tor Directory  
Server 
? 
? 
? 
Irongeek.com 
 Bridge nodes (Tor)  
 Distributed infrastructure (I2P)  
 Taking out dev site would still be an issue 
 Distributed Hash Table 
 Protocol obfuscation  
 Total/Severe blocking will take a bit more: 
(see next slide)  
Irongeek.com 