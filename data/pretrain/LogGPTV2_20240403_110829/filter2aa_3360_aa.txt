PentesterAcademy.com
©PentesterAcademy.com
VoIPShark: Open Source VoIP Analysis 
Platform
Nishant Sharma
Jeswin Mathai
Ashish Bhangale
PentesterAcademy.com & AttackDefense.com
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
About Us
Me, Nishant Sharma
• R&D Manager and Lead Trainer, Pentester Academy
• Firmware developer, Enterprise WiFi APs and WIPS Sensors
• Masters degree in Infosec
• Published research at Blackhat US/Asia, DEF CON USA and other venues
Co-authors
• Ashish Bhangale, Sr. Security Researcher
• Jeswin Mathai, Security Researcher
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
PentesterAcademy.com
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
AttackDefense.com
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Talk Overview
•
VoIP Basics
–
SIP, RTP
–
Secure: TLS, SRTP 
•
Recovering/Decrypting VoIP Calls
•
Current open source tools and issues
•
VoIPShark
–
Architecture and Internals
–
Analyzing VoIP Traffic
–
Recovering Calls
–
Detecting Attacks Passively
–
Demo
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
VoIP Telephony
•
Signalling + Media 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Signalling Protocols 
SIP (Session Initiation Protocol)
•
Developed by the IETF
•
Replacement for the desk phones and PSTN (Public Switched Telephone Network)
H.323
•
Created by the ITU-T
•
Focused on videoconferencing but also used for voice calls
SCCP (Skinny)
•
Cisco proprietary protocol used for line-side control of phones
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Session Initiation Protocol
•
Text-based protocol
•
Applications 
–
Calls (audio, video) using other media steams like RTP
–
Text messages using SIP “Message” method
•
Works with other protocols
•
Session Description Protocol (SDP) to define with media negotiation and setup
•
Can operate over TCP, UDP or SCTP (Stream Control Transmission Protocol)
•
Security is provided by TLS (Transport Layer Security ) i.e. SIP over TLS.
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SUBSCRIBE, PUBLISH and NOTIFY 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Session Initiation Protocol: Sample Call Flow
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
User Agent Server (UAS) Solutions
www.sipfoundry.org 
freeswitch.org 
www.elastix.org 
www.asterisk.org 
www.3cx.com 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Softphone clients
•
Program for making telephone calls over IP
•
Some options
–
Zoiper
–
X Lite
–
LinPhone
–
MicroSIP
Factors in choosing a good softphone client
•
Check codec support
•
Check encryption capabilities (Especially in free versions)
•
Other functionalities (i.e. Text message option, hold, waiting etc.)
www.zoiper.com 
www.microsip.org 
www.linphone.org 
www.counterpath.com/x-lite-download 
www.3cx.com 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Asterisk Now
+
=
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Scenario
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Possible Configurations
• SIP + RTP
• SIP over TLS + RTP
• SIP + SRTP
•  SIP over TLS + SRTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Possible Configurations
• SIP + RTP
• SIP over TLS + RTP
• SIP + SRTP
•  SIP over TLS + SRTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SIP/SDP Packets
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
RTCP Packets
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
RTP Packets
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Recovered VoIP Calls
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Flow Sequence 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Reconstructed Call 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Possible Configurations
• SIP + RTP
• SIP over TLS + RTP
• SIP + SRTP
•  SIP over TLS + SRTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SRTP key in SDP packet
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SRTP Traffic
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Encrypted Call
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Possible Configurations
• SIP + RTP
• SIP over TLS + RTP
• SIP + SRTP
•  SIP over TLS + SRTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
No SIP Traffic
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
TLS Traffic (SIP over TLS)
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
No RTP Traffic
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Why No RTP Traffic?
•
Wireshark uses SDP packet to figure out the port RTP/SRTP stream will use.
•
SIP and SDP are encrypted, so wireshark can’t figure out.
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Undecoded RTP Traffic
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Decode As
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Decode As RTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
RTP Traffic
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Checking RTP Streams
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Analysing RTP Streams
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Playing RTP Streams
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Possible Configurations
• SIP + RTP
• SIP over TLS + RTP
• SIP + SRTP
•  SIP over TLS + SRTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
TLS key exchange methods
•
TLS uses symmetric ciphers (i.e. AES, Blowfish) to encrypt the data
•
Two options under realistic approach
–
 DHE (Diffie Hellman Key Exchange)
–
RSA (Asymmetric encryption)
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Diffie Hellman Exchange
Assumption
•
Attacker even after seeing the exchanged colours can’t  
guess the secret colour.
•
Attacker knows 
       and also 
       But can’t know which colour is added.
More on: en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
RSA (Asymmetric Encryption )
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Observations?
•
Can’t recover keys derived with ECDHE/DHE by listening to traffic
•
For RSA, if we can get private key of server, we can decrypt traffic 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
TLS Traffic (SIP over TLS)
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Diffie Hellman Exchange
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Undecoded SRTP Traffic
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Decode As
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Decode As RTP
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Checking RTP Streams
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Analysing RTP Streams
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Playing RTP Steams
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
TLS Traffic (SIP over TLS)
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
RSA based key exchange
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Decrypting TLS traffic
•
RSA is used to exchange keys
•
We can decrypt with private key installed on Asterisk One  
•
Keys and certificate location on Asterisk One: /etc/asterisk/keys
•
We have to get the default.key from the server
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Edit > Preferences > Protocol > SSL
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Adding Asterisk default private key 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Decrypted SIP traffic
PentesterAcademy.com
©PentesterAcademy.com
SRTP key in SIP/SDP decrypted packet PentesterAcademy.com
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
Open Source Tools for Decrypting SRTP
•
SRTP Decrypt
•
Libsrtp
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SRTP Decrypt
•
Tool to decipher SRTP packets
•
Takes symmetric key to decrypt the SRTP traffic 
•
Output decrypted packets in form of hexdump
•
Wireshark can reconstruct RTP packets from the hexdump 
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SRTP Decrypt
•
GitHub: github.com/gteissier/srtp-decrypt  
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SRTP Decrypt: Pre-Installation
•
Installing libgcrypt
•
Installing libpcap
PentesterAcademy.com
©PentesterAcademy.com
PentesterAcademy.com
SRTP Decrypt: Installation
•
Cloning
•
Compiling
PentesterAcademy.com
©PentesterAcademy.com