### WAF产品类型与部署方式

#### 1. 基于Web服务器功能的简易WAF
基于业务环境的不同，一些非典型且不知名的简易WAF类产品应运而生。这些WAF相对小众，有时是企业安全团队自行开发和运营的。例如，基于Nginx的LUA脚本开发的WAF或基于IIS筛选器开发的WAF。理论上，成熟的Web服务器均提供二次开发接口（如模块），可以按需开发相应的WAF功能。

**优点：**
- 对HTTPS业务非常适用。
  
**缺点：**
- 开发与运营成本高。
- 部署过程需要中断业务。
- 运营人员工作量大，需逐台服务器部署。
- 规则运营需要大量人力。

**适用场景：**
- 适合有一定开发和运营能力、业务规模较小的公司。

#### 2. 网络层部署
此类WAF产品是最易部署的方式，通常部署在机房或被防护网络的入口位置。这种部署方式对业务侵入性低，不需要太多变更，特别适用于互联网公司中架构复杂且变更频繁的环境。

**优点：**
- 易部署。
- 无侵入性。
- 不影响业务性能。
- 可旁路接入，通过RESET包阻断HTTP会话。

**缺点：**
- 对HTTPS协议支持不足。

**适用场景：**
- 适合互联网公司中架构复杂且变更频繁的环境。

#### 3. 混合型WAF架构
为了满足多样性和灵活性的需求，许多大型互联网公司建立了混合型WAF集群。通过组合不同类型的WAF，实现互补防御，确保全方位覆盖。

### WAF安全策略建设

一个WAF产品通常包含以下几类规则：

1. **主流Web漏洞检测规则**
   - 为了确认是否覆盖“主流高危Web漏洞”，推荐使用以下平台进行测试：
     - OWASP ZAP (https://www.zaproxy.org/)
     - Acunetix Web Vulnerability Scanner (https://www.acunetix.com/vulnerability-scanner/)
     - IBM AppScan (http://www-03.ibm.com/software/products/zh/appscan)
     - bWAPP (http://www.itsecgames.com/)
   - 测试与迭代优化过程需要周期性进行，以保持WAF的有效性。

2. **最新高危漏洞检测规则**
   - 安全系统运营的关键之一是及时更新检测能力。每当爆出新漏洞时，运营人员必须迅速跟进，分析POC和漏洞原理，提取相应检测规则并及时部署到WAF系统。
   - 获取威胁情报是第一步，常用工具包括Metasploit、Wireshark等。

3. **业务风险监测规则**
   - 在有足够的运营能力前提下，业务方可以提出特定规则，利用WAF监控某些异常行为。
   - 规则主要分为两类：
     - 已发现的业务漏洞，临时封堵攻击行为，为修补赢得时间。
     - 监控某些高危或异常行为，为业务异常行为分析提供数据基础。

### WAF性能优化

#### 1. 架构优化
- 在项目评估初期，选择合适的架构至关重要。考虑因素包括资源掌控、业务性能敏感度和安全运营效果。
- **资源管理**：如果拥有整个机房的网络建设管理权限，可以在核心交换机处流量镜像到WAF设备，不影响业务正常运营。
- **业务性能**：安全产品不应严重影响业务性能，否则难以被接受。建议优先选择Cname或接入层Module WAF方式。

#### 2. 规则优化
- **算法优化**：优化流量匹配流程，减少不必要的开销。例如，优先匹配关键字符串，仅对纯静态资源请求进行简单处理。
- **正则优化**：使用高效的正则引擎，如Google的RE2。对于二进制数据流匹配问题，可以配置不同的正则引擎。

### 入侵感知体系

入侵感知是安全防御体系建设的重要环节，特别是对于大型互联网生产网络。本章将从系统、应用和后端架构等多个维度介绍入侵感知体系的实现方法。

#### 8.1 主机入侵检测

**主机入侵检测系统（HIDS）** 是部署在需要防护的主机服务器上的软件。由于其对业务系统的侵入性，开发和部署面临版本适配等难题。市面上知名的商用HIDS较少，开源产品如OSSEC较为流行。

##### 8.1.1 开源产品OSSEC
- **概述**：OSSEC是一个著名的开源HIDS产品，支持多种操作系统，包括Linux、BSD和Windows，并提供多种安装方式。
- **架构**：典型的BS架构，Agent端采集数据上报至Server端，Server端负责数据分析、存储和展示。
- **管理运营**：部署Agent是第一步，Agent会生成通信密钥用于认证。默认采集系统日志等数据。

通过以上优化，文本更加清晰、连贯和专业。希望这对你有帮助！