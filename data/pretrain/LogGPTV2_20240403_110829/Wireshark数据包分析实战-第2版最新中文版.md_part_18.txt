CH
3
Te11172.16.0.8
---
## Page 183
40000510172160102172160801074RAqA4001304578W0
Estrean
8888
终结束前，用户计算机发送了一个SYN数据包并得到RST响应。
512
Tndexs
此时，用户在浏览器上看到了“该页无法显示”。
是阻止DNS查询的两个条件。
20
umber:4061304578
888
图8-24TCPSYN和RST数据包一共出现了3次
图8-23响应TCPSYN的TCPRST数据包
8808
ZD:
司
00:25:b3:bf:91:eeC00:251b3:bf:91100）
ACKCE
---
## Page 184
8.3.3
注意
无法访问 Internet：上游问题
能接受这个连接请求。
端口发起TCP连接。然而，由于该系统并没有配置成Web服务器，因此它不可
着，它向这个主机发送ARP请求，并得到响应，然后尝试向172.16.0.102的80
速发现DNS这个通信过程的关键部分消失了。通过这些信息，我们可以确定客
在这个场景中，主机没有发送DNS请求是因为客户端被配置错了，而不是因为
该有多恐怖！
登录网上银行，实际上访问的却是一个伪造的网站，专门偷你账户里的钱，这
重定向到存放恶意代码的网站。试想，如果黑客修改了你的hosts文件，每次你
我们发现这个问题影响到了机构的每一个人一
户端才是问题的来源。
其他外部限制或外部的错误配置。
是个全网问题一
将网络连接到Intemet
在数据包层面上考察这个问题，我们可以迅速发现未知的IP地址，也能迅
这个网络配置和前两个场景一样，仍然是用一些简单交换机和一个路由器
实际上，这个场景非常普遍。恶意软件在几年前就使用这个方法，把用户
在Windows系统上查看hosts文件，请打开C：WindowsSystem32drivershosts
将这个hosts文件的表项移除后，用户的计算机就能正常访问www.google.com了。
与前两个场景一样，在这个场景中，有一位用户抱怨它的工作站无法上网。
继续分析流量，你会学到各种各样的协议如何工作、以及如何阻断它们。
3.学到的知识
在Linux上则应查看/etc/hosts
1.侦听线路
一意味着它也影响你的计算机，而且可能是感染恶意软件导致
一谁也无法访问Google。
基础的现实世界场景169
这
---
## Page 185
100000172.36842210ShnddqryAwg
170
5er
[uesp
Aut
Wireshark数据包分析实战（第2版）
net
的一
bority
J2M
4.2.2.10，并且它是一个DNS数据包O。查看该数据包的内容，我们发现这是
映射已经存在于主机的ARP缓存中。
一个查询www.google.com的A记录请求。
如图8-25所示，
2.分析
起来通信一切正常。
RRS:
80端口.
口
hot
2.5
col
ress)
CIaSS IN
图8-25
0172
EOO
捕获中的第一个数据包从主机172.16.0.8发往地址
---
## Page 186
D
Queries
888
首
Flaos:
9417
opt1ons:(12 bytes)
chec
Destinatfon port:
strean
1s后再次发生，如图8-28所示，到这里通信停止了，浏览器报告找不到网站。
据包，但相反，
ksu:
googTe.com:Type A.classIN
ox81a0（Standard query response.Noerror)
0.010440000seconds]
RRS
google.
因为这是
ndi
西
c:
11
68
Srct
图8-28TCPSYN数据包尝试了3次都没有收到响应
[valIdation dfsabTeu]
91743089
src:
type
4.2.2.1
主机过一会儿又发了另一个SYN数据包到目标。这个过程大概在
63:
个TCP握手过程，我们知道应该在响应中看到TCPSYNACK数
图8-27
A,class
图8-26
3888
125.
cTass
22
（172.16.0.）
尝试连接80端口的SYN数据包
PECHAME
TIN.
包含多个A记录的DNS响应
addr
喜
cma
688888
DSt:
00
1251
墓8第
05-105
基础的现实世界场景171
CEE10:1E:Q059
19715
---
## Page 187
8.3.4
1这是在中国大地区最可能遇的情况，
看起来功能正常。
打印机故障
那边修复故障，通信就可以继续了。
这个案例中，Web服务器工作不正常，我们的所有尝试都失败了。
在我们网络设施之外。
网络上的主机、路由器，也不在于提供域名解析服务的外部DNS服务器。问题
那边的问题，但你已经看到，数据包是不会说谎的。
们希望你去确认这不是网络问题。
大批量打印机出故障了。
这个场景中的问题不是我们能修复的。我们的分析表明，问题不在于我们
3.学到的知识
1.侦听线路
一译者注
一旦Google
一详老技
---
## Page 188
PPR
Dido
也可以在Packet Details面板的 TCP头部信息的底部看到。
据包发送到打印机O。数据大小既可以在Packet List面板Info列的右边看到，
印机（172.16.0.253）的TCP握手。握手之后，
POI
据被打印机确认了。
12
ESIT
20bytes
如图8-29所示，捕获文件的开头是发送打印作业的主机（172.16.0.8）与打
2.分析
[valdatian dtsabTed]
数据包4后面是另一个包含1460字节的数据包0.如图8-30所示，这个数
fn [1ight:1460]
36EO0T68
在捕获文件的最后两个数据包之前，数据流一直正常。
9.0
231
16.0
BTTLT.
122
图8-29 通过TCP传输到打印机的数据
10
15
图8-30 正常的数据传输和TCP确认
1314 te
ERRRPRPPRRERRR
2312
15
一个大小为1460字节的TCP数
第8章基础的现实世界场景173
数据包121是一个
---
## Page 189
1512172
T
8828
ox1o
OrT
时，就发送一个TCP重传数据包。
了多次。
Se
a!
时（RTO）在5.5s左右。
ubyers
发送5.5s后发生了数据包121的重传0。
level
alidation disabTeo]
11ght:1092]
图8-31这些TCP重传数据包是故障的一个标志
(suspec
A131
CTed)
882#25
00
seconds]
®
bd:ba (00:2317d:77:1bd:ba)
---
## Page 190
8.3.5
分公司之困
是，打印机大概在这个时间停止打印了。
重传5.6s后发生了这次重传。这好像是捕获文件中的最后一个数据包，巧合的
包括上一个数据包的5.5sRTO。PacketList面板的Time列告诉我们，在上一次
可见，内存问题导致打印机无法接收新数据，并中断了与主机的通信。
打印机时，它只打印一定的页数，一旦访问到特定内存区域就停止工作。由此
所以我们猜测打印机才是问题的来源。
重传就是个明证，但打印机就是没有响应。这个问题可以在其他工作站上重现，
某一时刻，打印机停止响应工作站了。工作站尽了最大努力使数据到达目的地，
作站还是打印机的问题。我们可以看见数据正常流动了相当长的时间，然而在
时，TCP给我们留下了有用的信息。
其问题。跟之前的场景不同，这里只有TCP流量。幸好，当两台设备停止通信
在总部。域控制器负责处理DNS和分公司用户的认证请求。
Windows域控制器服务器和一台备用域控制器，公司的所有IT设施几乎都放置
更复杂的问题
题的确切位置。
资源记录信息。
进一步分析后，我们发现打印机的内存出故障了。当大量打印作业发送到
好在这个分析场景只涉及内网的两台设备，所以我们只需要确定是客户工
下一个数据包是数据包120的另一个重传。这个数据包的RTO是11.10s，
城控制器是一个代理DNS服务器，它接收来自总部的上游DNS 服务器的
在这个案例中，
虽然这个打印机问题，不是网络问题所致，但我们仍可以用Wireshark指出
3.学到的知识
在这个场景中，
图8-33显示了在这个场景中要考虑的组件，包括了多个站点。
当部署团队将新设施延伸到分公司时，发现没有人能访问网络上的内部
。继续学习下面的场景，我们会经常依赖于像这样的功能来解决
一家公司在总部之外新开设了几家分公司。通过部署一台
当通信意外停止时，我们靠TCP内置的重传功能指出了问
第8章基础的现实世界场景175
---
## Page 191
172.16.16.101
工作站
数据包保存在stranded_clientsidepcap文件中。
据来跟踪问题。问题可能出在分公司的客户端上，
100000172161620117211510
ar
由于问题出在总部和分公司间的通信过程中，
2.分析
如图8-34所示，
侦听线路
分公司
分公司路由器
图8-33分公司之因问题的相关组件
iresi）e
WAN链路一
172.
总部路由器
所以我们使用端口镜像功能
我们可以在多个地点收集数
公司总部
总部DNS主服务器
总部应用服务器
172.16.16.200
172.16.16.250
---
## Page 192
user
Internet
8088
8094
TVDe:
Name:
结果。
被阻止了。注意到这个数据包只是一个错误（服务器失败），并没有回答查询
不是我们过去看见的UDP类型。
选DNS服务器（172.16.16.250）O的标准DNS服务端口53进行通信，但它却
个额外的数据包。额外的数据包看起来很奇怪，因为它尝试与中心办公室的首
变端口镜像设置。现在服务器的流量就被镜像到我们的噢探器了。捕获结果在
务器172.16.16.251解析，我们前往下一站。
的DNS服务器依赖于总部服务器获得资源记录分公司用户试图访问的应用
资源记录在DNS服务器之间传输，这里就是该种情况。
使用UDP，但当响应超过一定大小时就使用TCP。在那种情况下，我们会看见
(HOST
如图8-35所示，这个数据包的响应是一个服务器失败0，
8888
分公司的DNS服务器是总部DNS服务器的从属服务器，
为了找出这个数据包的用途，回顾我们在第7章对DNS的讨论。DNS通常
如图8-36所示，这个捕获的开头是我们之前看到的查询和响应，但还有一
为了从分公司的DNS服务器捕获合适流量，我们将噢探器留在原地，只改
现在我们知道该通信故障与DNS有关。因为分公司的DNS查询由DNS服
888
ver
888
SrC
图8-35查询响应表明这是上游的问题
192
10
182
第8章基础的现实世界场景177
表明DNS查询
意味着分公司
---
## Page 193
301017111616T40350096534W95S146
Sequ
178