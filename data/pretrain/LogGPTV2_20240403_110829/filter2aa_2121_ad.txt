f4
00
00
00
0010 12
00
00
00
00
00
00
00
int offset = 244 (0xF4); from 0xCC
int length = 18 (0x12); Unicode
int unknown = 0;
Username
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
V    V A L U E    E N T R Y
00
01
02
03
04
05
06
07
0000 00
00
00
00
f4
00
00
00
0008 03
00
01
00
f4
00
00
00
0010 12
00
00
00
00
00
00
00
.
.
.
01B0 01
02
00
00
00
00
00
05
01B8 20
00
00
00
20
02
00
00
01C0 73
00
75
00
62
00
6f
00
01C8 72
00
6e
00
65
00
72
00
01D0 24
00
00
00
73
00
75
00
Headers
Values
0008 03
00
01
00
f4
00
00
00
0010 12
00
00
00
00
00
00
00
int offset = 244 (0xF4); from 0xCC
int length = 18 (0x12); Unicode
int unknown = 0;
Username
01C0 73
00
75
00
62
00
6f
00
01C8 72
00
6e
00
65
00
72
00
01D0 24
00
00
00
73
00
75
00
Username: suborner$
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
Variable
User Permissions
Username
Full Name
Comment
User comment
Unkown entry
Home Dir
Home Dir Connect
User Logon Script Path
Profilepath
Workstations
Hours allowed
Unkown entry
LM Hash
NTLM Hash
NTLM History
LM History
V
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
V
Username
Username
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
V
Username
NTLM Hash
Username
NTLM Hash
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
NTLM
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R E V E R C E P T I O N !
SAM
NTLM
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
0x02. Calculate NTLM Hash (and split it in 2 halves)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
0x02. Calculate NTLM Hash (and split it in 2 halves)
0x03. Calculate DES Key for each NTLM part
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
0x02. Calculate NTLM Hash (and split it in 2 halves)
0x03. Calculate DES Key for each NTLM part
0x04. Encrypt & concat each NTLM part with DES keys
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
0x02. Calculate NTLM Hash (and split it in 2 halves)
0x03. Calculate DES Key for each NTLM part
0x04. Encrypt & concat each NTLM part with DES keys
0x05. Calculate SAM Key
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
0x02. Calculate NTLM Hash (and split it in 2 halves)
0x03. Calculate DES Key for each NTLM part
0x04. Encrypt & concat each NTLM part with DES keys
0x05. Calculate SAM Key
0x06. Calculate SAM Hash (AES or MD5)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
N T L M    &    S A M    H A S H
0x01. Check if Windows 10 v1607 or greater
0x02. Calculate NTLM Hash (and split it in 2 halves)
0x03. Calculate DES Key for each NTLM part
0x04. Encrypt & concat each NTLM part with DES keys
0x05. Calculate SAM Key
0x06. Calculate SAM Hash (AES or MD5)
0x07. Write changes to V
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
G O A L S
∙ Understand authentication/authorization for local accounts
∙ Create a local account writing directly to the SAM
∙ Make it invisible!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
F ?
00
01
02
03
04
05
06
07
0000 02
00
01
00
00
00
00
00
0008 00
00
00
00
00
00
00
00
0010 00
00
00
00
00
00
00
00
0018 00
00
00
00
00
00
00
00
0020 00
00
00
00
00
00
00
00
0028 00
00
00
00
00
00
00
00
0030 F4
01
00
00
01
02
00
00
0038 10
02
00
00
00
00
00
00
0040 00
00
00
00
00
00
00
00
0048 00
00
00
00
00
00
00
00
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
F    I S    E Z !
00
01
02
03
04
05
06
07
0000 02
00
01
00
00
00
00
00
0008 00
00
00
00
00
00
00
00
0010 00
00
00
00
00
00
00
00
0018 00
00
00
00
00
00
00
00
0020 00
00
00
00
00
00
00
00
0028 00
00
00
00
00
00
00
00
0030 F4
01
00
00
01
02
00
00
0038 10
02
00
00
00
00
00
00
0040 00
00
00
00
00
00
00
00
0048 00
00
00
00
00
00
00
00
Variable
Lockout time
Last logon
Password last set
Account expires
Last incorrect password
RID copy
Account Bits (ACB)
Country code
Invalid password count
Total logons since creation
F size is fixed!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
F    S T R U C T U R E
0030 F4
01
00
00
0038 10
02
00
00
 p
RID copy
Account Bits (ACB)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R I D    H I J A C K I N G    F T W !
0030 F4
01
00
00
 p
RID copy
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
RID Hijacking
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
RID Hijacking
$
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
RID Hijacking
$
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
F : A C B    B I T S
Flag 
Value 
ACB_DISABLED 
0x0001 
ACB_HOMDIRREQ 0x0002 
ACB_PWNOTREQ 0x0004 
ACB_TEMPDUP 
0x0008 
ACB_NORMAL 
0x0010 
ACB_MNS 
0x0020 
ACB_DOMTRUST 
0x0040 
ACB_WSTRUST 
0x0080 
ACB_SVRTRUST 
0x0100 
ACB_PWNOEXP 
0x0200 
ACB_AUTOLOCK 
0x0400 
0038 10
02
00
00
Account Bits (ACB)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
F : A C B    B I T S
ACB_WSTRUST 
0x0080 
0038 10
02
00
00
Account Bits (ACB)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
=
ACB
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
$
=
ACB
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
$
=
ACB
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
RID Hijacking
$
=
ACB
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
SAM
V
F
RID Hijacking
$
=
ACB
0x80
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W H A T    C A N    W E    D O ?
∙ Create a custom account without the Win32 API limitations (and without
calling that noisy Event Logger)
∙ Modify account attributes that are unchangeable through the Win32 API
(s.a. RID for Primary Access Token generation)
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A G E N D A
Why?
How?
What’s 
next?
What?
Show 
me!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S U B O R N E R  v1 . 0 . 1 
∙ C# artifact to forge invisible accounts
∙ Crafts account’s SAM registry keys
and values as the OS, without the
limits of its API
∙ Works on ALL Windows NT Machines
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
S U B O R N E R  v1 . 0 . 1:     P A R A M E T E R S
∙ /username: Suborner username
∙ /password: Suborner password
∙ /rid: Suborner RID
∙ /ridhijack: Account to impersonate
∙ /template: Account template for forging
∙ /machineaccount:
Create
as
machine
account
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
D E M O    S C E N A R I O
Attacker Machine
Victim Machine
192.168.8.128
192.168.8.129
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
A G E N D A
Why?
How?
What’s 
next?
What?
Show 
me!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
M S F T    R E S P O N S E
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
I T ‘ S    A L L
B A D ?
∙ Although conceived as an attack, sysadmins could use this to hide privileged
local accounts from unintended actors
∙ Could be detected by inspection (Automated could be tricky in the future)
∙ Not a domain account, but definitely could be used within AD domains
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
W H A T ‘ S    N E X T ?
∙ Totally substitute the Win32 API for Windows Local account management!
∙ Discover new attack vectors of account attributes sanitized by the OS (fuzz?
Bypass detection?)
∙ Hack Suborn the planet!
R 4 W S E C . C O M
 @r4wd3r
S U B O R N E R
R E F E R E N C E S
∙ B. Delpy, Mimikatz: Benjamin Delpy (gentilkiwi) 
https://github.com/gentilkiwi/mimikatz/
∙ P. Yosifovich, A. Ionescu. Windows Internals, Part 1: System architecture, 
processes, threads, memory management, and more (Developer Reference). 
∙ S. Castro. RID Hijacking: Maintaining Access on Windows Machines 
https://r4wsec.com/notes/rid_hijacking/index.html
∙ Ben0xa. DoucMe https://github.com/ben0xa/doucme
S  U  B  O  R  N  E  R 
A Windows Bribery for Invisible Persistence
Sebastián Castro
@r4wd3r
srcastrot