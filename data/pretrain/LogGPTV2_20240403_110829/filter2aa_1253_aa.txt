瑞星公司 
FastDesktop 后门分析报告 
报告贡献者：XywCloud、白同桌、花茶 
北京瑞星网安技术股份有限公司 
                   北京瑞星网安技术股份有限公司 
1 
概述 
瑞星威胁情报平台于 2022 年 3 月通过部署在 VirusTotal 上的瑞星扫描器搭载的机器学习引擎捕获
到了数个检出率较低的.NET 恶意程序。 
图：其中一个文件的 VirusTotal 初次扫描结果 
经分析溯源，我们将这批恶意程序与相关的组件定性为后门，并将其命名为"FastDesktop"。 
在分析过程中我们还发现该后门有两个大版本，为便于区分，将其分别命名为 v1 和 v2 版。两个版
本的使用到的攻击技术及基础设施基本相同，只是攻击流程有所区别，本报告的样本分析章节将以
v2 版的样本分析为主，之后会对 v1 版和 v2 版作简单的对比分析。 
整套样本使用了多种免杀技术，相关技术也会在之后的章节进行介绍。 
攻击流程及样本分析 
攻击流程 
                   北京瑞星网安技术股份有限公司 
2 
图：v1 版攻击流程 
图：v2 版攻击流程 
样本分析 
初始样本 
样本基本信息 
文件名 
备用注册卡密.exe 
MD5 
BBBC3919B71F50FBF6939088B7B7FD9E 
文件大小 
10.50 KB  
文件类型 
EXE 
病毒名 
Backdoor.FastDesktop!1.DD2A 
表：备用注册卡密.exe 样本基本信息 
代码分析 
该样本为整个攻击链条上的初始样本，执行主要恶意行为的代码位于函数 entry，此函数负责下载并
执 行 下 阶 段 的 恶 意 样 本 ， 其 中 特 别 需 要 注 意 的 是 下 载 链 接 格 式 为
"http[:]//asbit[.]cn/setup.core?t=%x"，其中参数 t 的值为调用系统 API 函数获取的本地计算机
启动时间，攻击行动中的下载链接会随着时间不同而产生动态变化，以此改变文件的 Hash 值。在后
续攻击流程的其他阶段中都会使用此方法，相关内容将会在之后的章节进行介绍。 
                   北京瑞星网安技术股份有限公司 
3 
图：初始样本 entry 函数代码 
根据下载链接的地址，下载的恶意样本被命名为 setup.core.dll。 
setup.core.dll 
样本基本信息 
文件名 
setup.core.dll 
MD5 
DA0A5953C6EE6AE87022BA39FC4D8C74 
文件大小 
36.50 KB 
文件类型 
DLL 
病毒名 
Backdoor.FastDesktop!1.DCA0 
表：setup.core.dll 样本基本信息 
该样本主要功能除了下载下阶段模块样本之外，还需要执行其他操作，比如创建相关服务以实现持
久化，并通过启动服务的方式执行下载的恶意样本。 
代码分析 
首先获取存放下载文件的本地路径，其中下载文件存放的目录名是本地电脑名的 CRC32 校验值。 
                   北京瑞星网安技术股份有限公司 
4 
图：获取下载文件存放路径 
其次判断传入参数中是否包含字符串"uninstall"，包含此字符串则进行后门卸载操作，删除相关服
务及目录。 
图：删除相关服务及目录 
最后如果参数中不包含"uninstall"字符串，则执行样本的主要恶意功能：下载文件并释放本地、创
建并启动服务、设置注册表项等功能。 
图：主要功能代码 
下载地址的格式为"http[:]//asbit[.]cn/zipack/full?t=%x"，参数 t 的值是 GetTickCount 函数获
取的本地计算机启动时间。通过读取数据流的方式，将从服务器读取的数据存放于内存中，然后将
内存中的数据进行解压写入本地目录中。 
                   北京瑞星网安技术股份有限公司 
5 
图：下载数据代码 
图：读
取的数据流 
释放于本地目录的下载文件： 
图：被下载的文件 
在被下载的文件中，fdsvc.dll 和 libexpat.dll 是在后续代码中需要用到的程序。根据文件的版本
信息可知，两个文件均为迅雷公司的库文件，其中 fdsvc.dll 为白名单文件，版本信息显示文件的
真实名称为：XLServicePlatform.dll，而 libexpat.dll 则是攻击者伪造的恶意程序。 
                   北京瑞星网安技术股份有限公司 
6 
图：fdsvc.dll 版本信息 
服务创建并设置自启动，该服务的启动路径为本地的 svchost.exe 程序，相关代码如下图： 
图：创建服务并设置自启动 
服务创建成功后，通过创建注册表项来设置服务对应的动态链接库。 
图：创建注册表项 
其结果如下图： 
                   北京瑞星网安技术股份有限公司 
7 
图：创建的服务 
图：服务启动的注册表项 
svchost.exe 启动服务时，会动态加载服务注册表项中指向的文件，虽然该文件是迅雷公司的正常文
件，但攻击者通过伪造其导入表中的 libexpat.dll，实现了 DLL 劫持，将恶意样本挂载到 svchost.exe
程序进行执行。 
程序运行最后会有一个安装成功弹框，我们推测此处是否出现弹框可在生成被控端时进行控制（将
在后续章节进行介绍），如下图： 
                   北京瑞星网安技术股份有限公司 
8 
图：安装成功消息框 
libexpat.dll 
样本基本信息 
文件名 
libexpat.dll 
MD5 
7CF6325A5213738148F7315044CCAF98 
文件大小 
80.0 KB  
文件类型 
DLL 
病毒名 
Backdoor.FastDesktop!1.DCA2 
表：libexpat.dll 样本基本信息 
代码分析 
该模块样本功能较为简单，负责下载并执行下一阶段的恶意样本。样本首先会判断父进程是否为
svchost.exe，由上面的分析可知，该样本按照正常的攻击流程应该是由 svchost.exe 加载执行的，
此处是一个简易的环境检测手段。 
图：判断父进程是否为 svchost.exe 
根据系统的.NET 版本加载 CLR，并获取 ICLRRuntimeHost 接口指针。 
图：加载 CLR 版本 
拼接完整 URL，下载恶意程序并调用 ICLRRuntimeHost:: ExecuteInDefaultAppDomain 方法执行下
载的恶意程序。 
                   北京瑞星网安技术股份有限公司 
9 
图：下载并执行 payload 
其中用于下载的完整 URL 由三部分组成，其中第一部分为域名，代码中以明文方式给出，分别为： 
mitm[.]work 
fmt[.]ink 
第三部分字符串由下载文件的存放路径加一段字符串组成，然后通过本地计算得出一个数字，计算
函数如下： 
图：计算 URL 部分组成字符串 
第二部分则是由获取的本地 CLR 的版本号加上前面计算得出的第三部分数值，然后经过同样的计算
函数得出的数值，这三部分字符串最终组成完整的下载地址。所以，下载地址会根据入侵主机而有
所改变。 
图：完整下载地址 
下载的恶意程序为下阶段模块样本 system.dll。 
                   北京瑞星网安技术股份有限公司 
10 
system.dll 
样本基本信息 
文件名 
system.dll 
MD5 
B2675490E5906EFDC8B43EBBDDDA95F3 
文件大小 
7.50 KB  
文件类型 
.NET DLL 
病毒名 
Backdoor.FastDesktop!1.DCA4 
表：system.dll 样本基本信息 
代码分析 
样本的入口函数中，首先会调用本地的 regasm.exe，并传入参数"/u"，此参数的功能是调用
regasm.exe
执 行 注 销 操 作 。 进 程 启 动 后 会 去 主 动 执 行 恶 意 样 本 中 自 定 义 的
ComUnregisterFunctionAttribute 类的方法，而该方法则负责执行实际的恶意行为。 
图：调用本地的 Regasm.exe 程序 
恶 意 样 本 的
Unregister
方 法 ， 负 责 下 载 下 阶 段 模 块 恶 意 样 本 ， 下 载 链 接 格 式
为：”{0}/loader.core?version={1}&_={2}”，根据下载链接中相关字段，下载样本被命名为
loader.core.dll。其中： 
{0}：通过 DoH.File_Server 方法获取 
{1}：本地.NET 版本号 
{2}：本地计算机启动时间 
图：Unregister 方法代码 
                   北京瑞星网安技术股份有限公司 
11 
DoH.File_Server 方法通过调用方法 DoH.Query 获取下载恶意载荷的 IP 地址，如果获取成功，则根
据 IP 地址返回格式化的 URL。否则返回默认的地址：http[:]//asbit[.]cn。 
图：DoH.File_Server 方法代码 
DoH.Query 方法中通过向阿里云公共 DNS 解析服务发送 HTTP 请求来完成域名到 IP 地址的转换，使
得被攻击方无法在自己部署的 DNS 服务器上通过拦截指定域名的解析来对远控行为进行阻断。使用
的 URL 接口为"http://dns.alidns.com/resolve"。查询的域名以参数形式传递给该接口，这里攻击
者提供了两个域名，分别是： 
ddns[.]frd[.]ink 
ddns[.]fmt[.]ink 
图：DoH.Query 方法代码 
                   北京瑞星网安技术股份有限公司 
12 
图：解析结果 
loader.core.dll 
样本基本信息 
文件名 
loader.core.dll 
MD5 
AA3045BE0C28C50BAF8F024386C650AA 
文件大小 
16.0KB 
文件类型 
.NET DLL 
病毒名 
Backdoor.FastDesktop!1.DCA5 
表：loader.core.dll 样本基本信息 
代码分析 
根据对前置样本的代码分析可知，该模块样本被调用的入口方法为 Class.Entry，并且传入了一个参
数 ， 其 代 码 如 下 图 。 从 图 中 代 码 可 知 ， 样 本 的 主 要 功 能 集 中 在 Class.ParentProcess 和
Class.SubProcess 两部分。由于参数不符合条件，所以程序会先跳过执行 Class.SubProcess 方法。
禁用本地 UAC 后，执行 Class.ParentProcess 方法。 
图：entry 方法代码 
ParentProcess 方法：首先更改自身进程中运行的服务配置，改为系统启动时自动运行服务。 
                   北京瑞星网安技术股份有限公司 
13 
图：启动服务 
接着代码调用自定义的方法 Win32Interop.CreateProcessAsToken，并传入参数，其中参数二为后续
进程执行的命令行字符粗，字段 text 为恶意样本自身的路径。 
图：创建新进程的参数 
Win32Interop.CreateProcessAsToken 方法代码如下图所示，此时恶意程序向新创建的进程传入了
两个参数，其中为 t.GUID.ToString("N")，符合判断要求，所以程序被创建子进程执行时，会执行
SubProcess 方法。  
图：创建新的子进程 
SubProcess 方法：该方法功能简单只负责下载执行下阶段模块样本，下载链接的获取方式与前一个
模块 system.dll 的方式相同。 
                   北京瑞星网安技术股份有限公司 
14 
图：下载并调用执行下阶段模块样本 
下载链接格式为："{0}/assembly/core?version={1}&_={2}" 
{0}：DoH.File_Server -> DoH 协议解析域名 