⼀份通告引发的内⽹突破
-
安全脉搏
SecPulse.COM |
“ 这是 酒仙桥六号部队 的第 131 篇⽂章。
⼀、前⾔
本⽂记录某项⽬，在开始尝试各类漏洞未果的情况下，利
⽤平台的逻辑缺陷，打造出⼀份⾼质量的⽤户名和密码字
典，巧妙的通过 VPN 突破内⽹的经历。
⼆ 、背景
经过客户授权，于 x ⽉ xx ⽇ - xx ⽇对客户系统进⾏了
渗透评估，通过模拟真实⽹络攻击⾏为，评估系统是否存
在可以被攻击者利⽤的漏洞以及由此因此引发的⻛险⼤
⼩，为制定相应的安全措施与解决⽅案提供实际的依据。
客户要求只允许针对官⽅⻔户⽹站两个主域名进⾏攻击，
确保不影响其他⼦公司业务，严禁对⾮指定系统和地址进
⾏攻击，严禁使⽤对业务有⾼⻛险的攻击⼿法。
三、信息收集
⼦域名 / IP 信息收集
通过对客户提供的两个域名，进⾏前期的信息收集，扩⼤
可利⽤范围，这⾥使⽤ OneForAll、fofa、搜索引擎等⼯
具收集到以下相关的域名与 IP 地址。
随即祭出 goby 扫描上述 IP 地址 C 段、端⼝等信息后进
⾏汇总整理。
App / 公众号信息收集
通过天眼查、七⻨数据获取到部分 App、微信公众号。
使⽤ ApkAnalyser 提取安卓应⽤中可能存在的敏感信
息，并对其关键信息进⾏汇总。
GitHub / ⽹盘信息收集
使⽤ github 搜索⽬标的关键字，获取到部分信息。
四、漏洞挖掘
站点 A 渗透
通过前⾯的信息收集整理后，我们梳理出⼏个关键的系统
进⾏深⼊测试，在该福利平台登陆⻚⾯随意提交⽤户名及
密码并进⾏抓包分析。
发现该请求包对应的响应包存在缺陷验证，通过修改响应
包的值从⽽突破原有错误信息的拦截，使⽤ admin ⽤
户，成功进⼊后台。
进⼊后台后，尝试寻找上传点，⼀番搜寻后，并未找到。
在点击系统管理，尝试新建⽤户时，发现系统⾃动填充了
默认密码。
拿到该后台的默认登录⼝令，我们根据初始密码的特征，
构造出了⼀份⾼质量密码字典，为下⼀步去爆破其他后台
和邮箱系统做好铺垫。
站点 B 渗透
在测试的过程中，发现某销售平台登陆处存在逻辑缺陷，
可以对⽤户账户和密码进⾏暴⼒破解。通过在站点 A 得
到的系统默认密码构造的字典，成功爆破出 8 个普通权
限的账户。
登录其中⼀个账户，发现该平台在⽤户管理位置，存在⼤
量内部员⼯的信息，其中包含中⽂姓名，利⽤ python 脚
本将中⽂姓名批量转换成拼⾳，定制出⼀份⾼质量的⽤户
名字典。
站点 C 渗透
在前⾯收集的过程当中，我们发现⽬标使⽤的是 outlook
邮箱，且邮箱登陆存在登陆存在缺陷，没有验证码等防
护，可以直接进⾏暴⼒破解⽤户账户和密码，这⾥我们⽤
python 转换成姓名拼⾳，构造字典进⾏爆破，在爆破的
过程当中调低线程，且⽤固定密码跑⽤户名，成功跑出了
⼀批有效的邮箱账户。
⽤出来的账户，成功登陆邮箱，通过邮箱通讯录获得⼤量
内部⽤户名，并进⾏其他各类有效信息的收集整理。
站点 D 渗透
到这⼀步的时候，我们在 web 站点上的收获并不是太
⼤，没有能直接获取到 shell 的点，于是我们把⽬光转向
前期收集到的 APP 上。
下载相关的 app, 并⽤在 web 站点收集到的的⽤户信
息，成功撞出了某⽤户密码为 xxx 的账号，发现可以登
录⽬标的 APP，使⽤某⽤户的账号密码可成功登录。在
APP 中的通知公告部分发现了⼀个移动办公平台停机维
护的通知，并写明其 VPN 登录地址和注册地址。登录地
址：xxx 注册地址：xxx
看到这个信息，⼼⾥⼀喜，感觉前⽅有路，随⼿⽤浏览器
访问⼀下移动平台的登录地址跟注册地址，没⽑病，可以
成功进⾏访问。由于前期进⾏信息收集的时候也收集到⼀
个 vpn 的登陆地址，⽬前根据这份通知可以确定，⽬标
近期做了 vpn 登陆⽅式的变更，猜测⽬前可能有部分员
⼯还没有完成登陆⽅式的变更，可能是⼀个突破⼝，于是
我们把精⼒放在 VPN 这个点。
五、突破内⽹
VPN 绑定设备
在多⽅试依旧没有找到突破点的时候，对我们刚刚获取到
新 vpn 地址进⾏测试，利⽤之前收集到账户跟密码尝试
登陆，发现需要通⾏码才可以进⾏下⼀步，现在需要考虑
怎么拿到⽤户的通⾏码。
在注册地址处分析注册流程，发现可以对正确的⽤户跟密
码进⾏绑定设备从⽽得到通⾏码，流程为下图所示，密码
错误的时候会提示请重试或联系技术⼈员。
在账户跟密码正确的时候，这⾥使⽤账号密码 xxx/xxx
可以直接进⾏设备绑定，这⼀步值得⼀提的是最开始尝试
我们已经搜集到的账号密码均不能成功进⾏登陆，差⼀点
放弃，后来不⽢⼼，重新梳理了⼀遍流程，从之前所有能
登陆的邮箱再次搜集到⼏个有效账号密码后，最终找到两
个具有 vpn 权限的有效账号，随之进⾏下⼀步。
在⾃⼰⼿机上下载好移动办公平台维护通知中提到的
workspace 和 Authenticator 软件后，接着在设备⻚⾯
这⾥选择添加设备名为 test。
打开⼿机上的 Authenticator 扫描其中⽣成的⼆维码，点
击进⾏绑定后，即可获得该⽤户的通⾏码。
登录移动办公平台
在绑定设备后，拿到通⾏码，现在使⽤ xxxx/xxxx 这个
⽤户在地址进⾏登录。
成功通过 vpn 登录移动办公平台，在其中发现核⼼业务
系统、⼈管系统、数据报表平台、运维平台、OA 系统等
等内⽹系统的操作权限。
选择详情信息，打开 IT 运维管理系统，发现需要安装
citrixReceiver 下载 citrixReceiverWeb.dmg 进⾏安装。
在成功安装后，再次打开 IT 运维管理系统即可正常访问
内⽹业务，对其他的核⼼业务系统、⼈管系统、数据报表
平台进⾏访问，发现均可正常访问，成功的突破到内⽹。
登录内⽹ IT 运维管理平台
使⽤收集到的账号跟密码，尝试登录 IT 运维管理平台，
可成功登录，登录账号，xxx/xxx，xxxx/xxxx 登录成功
后通过⼯单查询进⾏信息收集整理。
登录内⽹ OA 平台
通过在 IT 运维管理平台收集到的⽤户跟密码，使⽤
xxxx/xxxx 登录, 成功登录 OA 系统。
登录内⽹数据报表系统
- 依旧使⽤在运维管理平台中收集并整理的信息，使⽤xxxx/xxxx可成功
通过 chrome 浏览器调⽤ cmd
在逐个测试的过程中，发现核⼼业务系统是可以通过
chrome 浏览器打开的。
这⾥使⽤ chrome 的开发者模式选择加载已解压的扩展
程序，调出 Windows 服务器的⽂件夹，在⽂件夹中输⼊
cmd 回⻋可直接调出 cmd 窗⼝。经过测试发现，这种情
况下是会把本地磁盘进⾏共享，并且可以双向复制粘贴，
因此可以直接把相关⼯具拖⼊内⽹，也可以把内⽹的东⻄
拖⼊到本地，到这⼀步就舒服了.....
⾸先使⽤ ipconfig/all 可看到当前所在机器地址及相关信
息。
由于下⼀步的内⽹操作相对敏感、危害性⼤，我们经过跟
客户沟通后，客户经过评估，客户叫停了后续的测试。
六、总结
本次测试过程⼤致如下：
1、 经过前期 web 站点的信息收集，和漏洞挖掘后，获
取到部分账户跟密码。
2、 在某个内部 app 当中获取 VPN 变更后的地址。
3、 尝试未绑定的员⼯账户进⾏ VPN 绑定，最终找到⼀
个运维权限的账户。
4、 成功登陆 Citrix Gateway, 并具有了内⽹系统的访问
权限。
5、 使⽤ chrome 的开发者模式调⽤ cmd, 测试后，发现
可以进⾏磁盘共享。
全⽂完
本⽂由 简悦 SimpRead 优化，⽤以提升阅读体验
使⽤了 全新的简悦词法分析引擎 beta，点击查看详细说明