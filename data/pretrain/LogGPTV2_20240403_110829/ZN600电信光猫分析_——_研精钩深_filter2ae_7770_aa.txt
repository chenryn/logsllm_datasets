# ZN600电信光猫分析 —— 研精钩深
|
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
作者：L.A.M[@Duncan](https://github.com/Duncan "@Duncan") SecTeam
## 0x00：引言
由于缺乏对电信天翼网关的全面了解，因此错误地认为可以用一篇文章把这个东西讲清楚。呵呵，毕竟我还只是个没见过世面的年轻人！
为了表达诚意，这篇文章会一口气把天翼网关的启动过程，lxc容器及saf程序分析，配置文件及其读写操作全部抖搂出来，也算是给电信天翼网关系列暂时画上个省略号吧。嘿嘿，期待上海电信研究院对天翼网关的下一次大修———天翼网关
4.0。
在开始正文之前，还是按照Duncan SecTeam的老规矩，祭上本文的mindmap，便于各位客官把握文章脉络，“挑肥拣瘦”。
## 0x01：电信天翼智能网关的简介
电信天翼网关从最老的A8-C、E8-C等设备发展到目前最新的天翼网关4.0经历了至少5个主要的版本代际【1】，如下图。目前，电信天翼网关4.0已经完成了集中采购，按理说已经在某些省市上市了吧【2】。
PS：图片截取自文章【1】
由于我们team只接触过天翼网关2.0和3.0设备，因此没办法对较为老旧的A8-C、E8-C以及天翼网关1.0设备进行分析，也就没法判断电信官方宣称的“智能OS”是否就是PT632和ZN600为代表的天翼网关2.0和3.0所安装“Linux
tc”操作系统。很期待能够拿到一台天翼网关4.0设备，这样就可以再写一篇关于天翼网关“智能OS”的文章，再忽悠小编几块钱稿费啦^_^
再者，文章【1】中对电信宽带做了一个较为全面且通俗易懂的介绍，从中不仅能学知识，还能帮助大家了解一下天翼网关的发展脉络，因此我就不好意思在这里占用篇幅了，不然要挨小编骂了。。。
## 0x002：ZN600系统加载
ZN600光猫的启动脚本是/etc/init.d/rcS文件，说实话这文件还真值得仔细品品，一是可以学到很多shell脚本知识，这个脚本绝对不会让我这么个脚本小子去写的；二是，的确可以了解天翼网关的各种瓜，哈哈哈。
Step
1：检查配置文件。如果/userfs/profile.cfg配置文件的确存在的话，把文件的权限修改为可读可写可执行。这个有点没明白，配置文件为什么要搞成可执行呢？
Step
2：确定Linux内核版本。从代码来看，应该是在系统中预先定义了内核版本信息，如果对应的版本字符串不为空，则加载指定版本的Linux内核。这个操作说明Linux
tc是一个有故事的OS，曾经灵魂附体过好多猫，阔怕。。。就是这个if-else语句的写法着实有点让人觉得好奇怪哟。。。
Step 3：挂载文件系统，然后根据预先设定的值并判断是否支持DBus，如果支持则执行Lxc容器先关操作。
在rcS启动脚本最后的一段代码也验证了我们关于tcapi与DBus之间的关系。如果不支持DBus，那么就使用tcapi来对voice，wifi，igddbus，saf以及tr069c等五个进程对应的Process_Entry进行设置。
Step 4：网络初始化。在进行一系列的目录操作后，系统就开始进行网络的配置了。东西太多，就没有一一展开写了。
Step 5：检查CPU型号，并加载对应的驱动模块。
Step
6：诡异的结尾。按照电信的尿性，下面截图中的SC和CQ应该分别代表了四川和重庆，可是为什么要区别对待呢？一旦判断猫是四川的，就在/tmp/rcs_load_ok中写个1。如果猫是重庆的，就要执行cqct_backinfo程序，然后还要在后台跑/usr/script/qoe_cqct.sh的脚本。这啥情况啊？？？
## 0x03：Lxc容器技术与saf容器管理程序
###  1、Lxc容器技术
作为一个脚本小子，对Linux
Container容器技术了解着实不多啊。为了写这个破文章，查了好多资料，有一个叫做linuxcontainers.org的网站，一开始以为是介绍Linux
Container技术的官方主站，没想到是Ubuntu赞助的一个站点。不过，redhat官网的文章【3】还不错，至少还能读明白一点东西。不过，对Linux
Container容器技术技术的描述上，我还是最喜欢master的解释：对于容器里的每一个程序而言，她们都以为自己才是操作系统的最(正)爱(房)，然而她们都不知道这个叫做Linux的操作系统其实只是一个渣男，他有一票的女朋友。。。
至于虚拟机技术和容器技术的区别嘛？我理解就是一个从没被扒出来过的渣男与被拔出来的渣男之间的区别吧。请原谅我这个脚本小子，这些技术确实超越了我小脑瓜能够理解的范围。。。
PS：原谅我连5毛钱都值不了的PS技术。。。
###  2、saf容器管理程序待补充
ZN600光猫上的saf程序很有可能是上海电信研究院写的，整体的代码量应该是不太大的。Team里头没几个懂逆向的，因此对于这个基于MIPS架构编译的elf文件，着实不是我想要提及的。不过，从chinadsl.cn论坛上找到的为数不多的帖子来看，这玩意的确是一个专门用来管理Linux
Container的管理器。既然有了这个wrapper，那么天翼“智能OS”就无情地阉割了标准Linux Container容器技术中的一票API。
而且，另外一个有趣的事情是，不同厂商生产的天翼智能网关中，saf程序的名字并非完全一样，或多或少留下了生产厂商的烙印。文章【4】中提到华为的天翼光猫对应的容器管理程序是saf-huawei，但在兆能和中兴的设备上却是简单的一个saf。
因为程序反向分析这个技能已经完全超出我这个脚本小子的能力范围了（努力学习ing），因此只能寄希望于各位潜水的大佬和路过的大牛看官们了。。。不过，以我们对master他老人家的了解，这老爷子应该会搞定saf的密码，然后以一种优雅的方法去操纵容器里的OpenWrt！
###  3、OpenWrt的版本判定
由于整个OpenWrt被电信工程师（也可能是兆能的工程师）改得有点狠，很多细节的地方也都被抹掉了，因此要判定ZN600到底跑的哪个版本OpenWrt还是不太容易。下面的截图是从OpenWrt容器中/etc目录下查看到的OpenWrt版本信息，可以看出工程师们可以抹去了版本信息，这对于Hacker而言着实让人极为很反感。不过，我们还是可以从中看出这个OpenWrt的一些信息，比如内部规定的发行版本信息以及更为关键的编译日期：2020年11月24日12点04分48秒，估计是在星期二午饭之前编译的~_^
本以为他们对于版本信息的修改会止步于此，于是就扒到了更深的LuCi里头去，查一下LuCi的版本信息，阔怕啊。。。改得好彻底啊！！！
在OpenWrt官网找遍了，没找到任何R3754的LuCi版本。但仅仅因为这个就判断LuCi的版本信息是被篡改了，还有显得有些不够严谨。因此，我们在Ubunt里头安装Lxc并运行了OpenWrt
21版本，查看了原汁原味的LuCi版本信息是啥样的。最后，严谨的验证了我们认定电信工程师篡改了LuCi版本信息。
###  4、切入OpenWrt容器
非常羡慕文章【5】的作者songee，他手上拿到的可不是“太监”光猫，那猫保留的Lxc程序要多一些。其中，lxc-attach这个程序是可以直接切入到Lxc容器内部的，获得一个容器内OpenWrt的root用户shell。