（1）在计算机上安装更多的内存。这样可以让你配置更大的服务器缓存大小和缓冲区大小，
本章前几节讨论了几项在忽略硬件配置的情形下，帮助你提高服务器性能的技术。当然，
抑制缓存可能会为那些从某个不断变化的表里检索信息的查询带来好处。此时，缓存不太
通过在关键字SELECT后面添加修饰符的方式，客户端也可以对单个查询的缓存进行控制。
其中，val可以为0、1或2，其含义与在服务器启动时设置query_cache_type 变量时是
SET query_cache_type=
启用查询缓存听起来像是一种提高性能的简单方法，通常情况下也的确如此。不过，在某
(2）使用多处理器硬件。对于像MySQL服务器这样的多线程应用程序，多处理器硬件可以
下面描述几个硬件配置，修改它们可以提高服务器的性能。
假设已启用了查询缓存，
口为查询缓存分配过大的内存，会导致服务器在比较当前查询与缓存查询确定是否缓存结果
即使 query_cache_type 为零，也会为查询分配query_cache_size 所表示的那么多数量
query_cache_size=16M
query_cache_type=1
例如，要想启用查询缓存，并为其分配16MB的内存，可以在选项文件里使用以下设置：
口
口query_cache_limit。它设置的是被缓存的结果集大小的最大值。大于这个值的查询结果
[mysqld]
不会被缓存。
息，就表明查询缓存访问存在竞争迹象。此时，最好是能禁用它。
线程之间的竞争点。检查此问题的一种方法是使用 SHOWPROCESSLIST。如果你经常不
是，由于对查询缓存的检查只涉及单个线程，因此它会成为运行于不同内核上的两个连接
在多处理器系统里，MySQL服务器可以在不同的处理器核上执行对不同连接的查询。
方面花费过多的时间。
，通过下面这条语句，客
第12章MySQL的基本管理
val;
，则客户端在开始缓存查询时的状态是由服务器的默认缓存模式所
客户端可以更改其默认的查询缓存模式：
在
---
## Page 471
将对每一种日志进行更为详细的讲解。
需要记录，则会开启相应的日志功能。下面列出的是对每一种日志的简要描述，接下来的几节
用复制和恢复崩溃。当服务器开始执行时，它会检查启动选项，看看是否需要记录日志。如果
12.8
个设备上，那么你将可能无法感受到这样做所能带来的任何整体好处。
例如，如果你需要处理大量的Web流量，并且还想将数据库移动到Web服务器文档树所在的那
定的物理设备上已有其他一些主要活动存在，那么将数据库放置在那里可能会让性能变得更糟。
与日志和数据库移动过程有关的描述请参考11.3节。
作并行操作。之所以说其起不到什么作用，是因为它们仍然会去竞争同一个物理资源(即磁头)。
库和日志都写到同一个设备的速度更快。请注意，在同一物理设备上使用不同的分区并不能算
库存储在一个设备上，而将日志存储在另一个设备上，那么同时往两个设备里写入会比将数
拆分到多个物理设备上，那么它会比从同一设备里读取和写入的速度更快。例如，如果将数
全没有寻
你使用更大的缓存
进行选择，请考虑添加更多的内存。因为内存的速度总是比磁盘的更快，并且添加内存可以让
常是主要的性能决定因素。横向移动磁头通常都比较缓慢。相比之下，在磁头定位之后，从
交换，有些系统也还会继续在磁盘里进行交换。
里执行所有的交换操作，就可以移除所有的磁盘交换设备。否则，即使你有足够的RAM 用于
道
同时执行多个线程。
（5）通过将磁盘活动分布在不同的物理设备上，充分利用并行特性。如果你可以将读取或写）
要想完全
里读出数据块的速度则会快一些。不过，如果需要在添加更多的内存和获得更快的磁盘之
MySQL服务器可以生成多种类型的日志。这些日志有助于诊断问题、提高服务器性能、
使用RAID 设备也可以让你获得一点并行性的好处。
在把数据迁移到另一个设备之前，需要确保你对系统的负载特征已有所了解。如果某个特
（4）添加速度更快的磁盘，以提高IO延迟。对于活动磁头旋转型磁盘驱动器，寻道时间通
（3）重新配置系统，移除所有的磁盘交换设备。如果你有足够的RAM，可以在内存文件系统
口
口
■在服务器崩溃之后，它可与备份一起配合完成表的恢复：首先，根据备份文件恢复数据库；
有一个索引文件，其中列出了当时存在的那些二进制日志文件。
来。默认情况下，如果某个查询花费的时间超过了10秒，它便会被认为很慢，并且服务器
消息。如果服务器无法启动，就可以查看此类日志。它会在终止之前把消息写到出错日
寻道时间，因为没有任何部件需要移动。
二进制日志有以下两个用途。
二进制日志及二进制索引文件。这种日志由一个或多个文件构成，记录由UPDATE、
会将它写到慢查询日志里。有几个系统变量可以进一步控制慢查询日志所记录的内容。
杂项事件。监视服务器的活动很有用处，从中可以了解到：“连接方是谁”
普通查询日志。这种日志记录的内容包括客户端连接、从客户端接收到的SQL语句和其任
”，以及“它们在做什么”
服务器日志
查询日志。这种日志可以帮你把那些可能需要被重写、以求获得更好性能的语句识别出
日志是最方便的，它能为故障诊断或调试提供帮助。
错日志。这种日志记录的内容包括服务器的启动和关闭，以及与问题或异常条件有关的
全避免
免
存，进而减少磁盘活动。
寻道，可以安装一个固态驱动器（SSD），并配置MySQL来使用它。SSD完
。当你想要查明客户端在往服务器发送什么样的语句时，
12.8服务器日志
。二进制日志文件都伴随
“它来自
451
据
据
哪
日
启
算
---
## Page 472
里某个适合的选项组。通常情况下，都是把选项文件放在[mysqld]选项组中，但不需要总是
次启动服务器时你都要以同样的方式指定日志选项，因此最常见的做法是将它们列在选项文件
时设置它们。也可以在服务器运行时对这些变量进行更改。
在启动服务器之前把该目录创建好；否则启动会失败。
在，服务器会自动创建它。但是，服务器不会自动创建存放该文件的那个目录。如有必要，
录的名字。要想将日志文件放到其他目录里，可以指定一个完整的路径名。如果日志文件不存
认名字。如果以相对路径名形式指定日志文件名，那么服务器会将它解释为一个相对于数据目
括号表示），而你没有提供名字，那么服务器会使用默认文件名把日志文件写到数据目录里。
对于某些类型的日志，你可以选择把它们写到其他地方。
积累了一定经验之后，你便可以关掉普通查询日志，以减少对服务器磁盘空间的占用。
MySQL时，建议你除了启用其他想要的日志以外，还要记得启用普通查询日志。在对MySQL
452
器会根据服务器主机的名字（它由后面会讨论到的HOSTNAME表示）生成每一个日志文件的黑
可以在 mysqld或mysqld_safe 的命令行里指定服务器日志的选项。不过，因为通常在每
其中有些选项实际上是系统变量(标志就是其名字里有下划线)，但是你可以在服务器启动
--slow_query_log_file=file_name
--slow_query_log
--relay-log-index=file_name
--relay-log[=file_name]
--log_output[=destination]
--log_error[=file_name]
--log-bin-index=file_name
--log-bin[=file_name]
--general_log_file=file_name
--general_log
默认情况下，每个被启用的日志都会以文件形式（可能是一系列的文件）写到数据目录里。
要想启用服务器日志记录，可以使用下表显示的那几个选项。如果日志文件名可选（以方
在所有日志当中，普通查询日志对于服务器监视是最有用的，因此当你第一次开始使用
口
口中继日志及中继日志索引文件。如果服务器是一个复制从服务器，它就会维护一个中继日
口
口
如
口
口果你不明确要求，服务器不会创建任何日志，但是，下面两种情况例外。
口，而不是发送至文件，
在 Windows 里，除非通过指定--console 选项指明需要将诊断信息发送至控制台窗
并告知服务器使用它
在 Unix里，如果使用 mysqld_safe 脚本来启动服务器，那么该脚本会创建出错日志，
普通查询日志和慢查询日志可以被写到mysql数据库的表里。
出错日
日志文件。
格式与二进制日志文件的格式相同，它有一个索引文件，其中列出的是从服务器上存在的
志，其中包含的是从主服务器接收到的需要被执行的数据修改事件记录。中继日志文件的
■它形成了复制的基础。存储在二进制日志里的数据修改事件可被传输到复制从服务器。
第12章MySQL的基本管理
据库的那些语句作为客户端mysql的输入，把数据库恢复到崩溃时的状态。
然后，使用mysqlbinlog将二进制日志的内容转换为文本语句，并使用备份之后修改数
志可以被发送到syslog。
选项
它。
，否则服务器都会创建出错日志。
慢查询日志文件名
启用慢查询日志
中继日志索引文件
启用中继日志
普通查询/慢查询日志存放位置
启用出错日志
二进制日志索引文件
启用二进制日志
生成日志文件名
启用普通日志
用途
请
服
目
日
---
## Page 473
12.8.1.2Windows里的出错日志
可以使用选项文件组[mysqld_safe]或[mysqld]，具体做法请参考本节前面的描述。
[mysql_server]选项组里的出错日志选项。要想指定 mysqld_safe 或 mysqld 所需要的选项,
mysql.server 会调用 mysql_safe。不过，mysql.server 无法识别出命令行里或
选项--syslog-tag=str，那么这两个标签将分别变成mysqld-str和mysql_safe-str。
的消息在被写入时会分别带上mysqld或rmysql_safe字样的标签（以前缀形式）。如果指定
项，而不使用系统变量log_error。当把日志记录到 syslog 之后，来自mysqld 和mysql_safe
到日志文件。要想将诊断信息也发送到 syslog，可以在启动mysql_safe时带上--syslog
值来启动服务器，就会发生这种情况。因此，请始终使用同一个账户，就像12.2.1.1节中讨论的那样。
使用那里的log_error值，如果能找到的话。）
safe]或[mysqld]组里设置系统变量 log_error。(mysqld_safe脚本会查看[mysqld]选项组
为 HOSTNAME.err。要想使用另外的出错日志名，可以在命令行或者某个选项文件的[mysqld
mysql_safe在调用 mysqld时，会把服务器的输出重定向到出错日志。默认的出错日志文件名
发送到控制台。可以在命令行或某个选项文件的[mysqld]组里设置这个变量。
直接调用 mysqld，那么可以通过设置系统变量1og_error 将出错输出发送到某个文件，而不是
12.8.1.1Unix里的出错日志
以通过设置系统变量log_warnings来控制，其取值范围是0~2，表示的是记录的递增级别。
12.8.1
多相关信息请参考12.5.3节。
过系统变量innodb_log_group_home_dir 指定其写入日志的位置。默认位置是数据目录。更
引擎会创建日志，用于崩溃后的自动恢复。你无法控制InnoDB是否生成日志，但是你可以通
显示二进制日志或中继日志文件的内容，可以使用工具程序mysqlbinlog。
存放在服务器的数据目录里：
放在那里。12.2.3节对适用于服务器和服务器启动程序的各个选项组进行了详细的说明。例如，
如果你使用mysql.server 脚本来启动服务器，那么出错日志将总是会被创建，因关
启动会失败，并且不会有任何输出写到这个出错日志。如果在不同的时间使用不同的--user
如果你启动服务器的方式是调用mysql_safe，那么服务器会默认创建出错日志，因为
除了刚才描述的这些服务器日志，可能还有存储引擎单独创建的其他日志。例如，ImnoDB
在 Windows 里，服务器会默认将诊断信息写到数据目录的 HOSTNAME.err 文件中。要想使
如果出错日志文件已存在，但是对于用来运行服务器的那个登录账户不可写入，那么服务
在 Unix 里，mysqla 默认不会创建出错日志，不过它会把诊断输出发送到控制台。如果你
在Unix和Windows里，对某些出错日志特性的处理会有所不同。接下来对它们进行讨论。
服务器使用出错日志来记录它的启动和关闭，记录诊断信息和出错信息。记录的信息量可
除了二进制日志和中继日志之外，其他日志都是以文本格式写入的，可以直接查看。要想
general_1og_file= qlog
general_log
log_error=log.err
[mysqld]
出错日志
12.8服务器日志
453
其
为
选
送
---
## Page 474
考12.8.6节。
slow.log。这些变量可以在服务器启动时设置，运行时更改。
设置系统变量slow_query_log_file。数据目录里默认日志文件的名字为 HOSTNAME-
时，
使用工具程序 mysqldumslow来对其内容进行汇总。
状态变量。
慢查询日志，而不是在刚接收到它们时就写入。慢查询还会使得服务器递增其 Slow-queries
参考12.8.6节。
以在服务器启动时设置，运行时更改。
系统变量 general_log_file。数据目录里默认日志文件的名字为 HOSTNAME.log。这些变量可
志。这个顺序与各条语句执行完毕的顺序可能会有所不同，尤其是在简单语句和复杂语句混杂
行时不算慢。
的
12.8.3
在
语句以及其他事件（如服务器的启动和关闭)。服务器会把它收到的语句按先后顺序写到这个日
12.8.2
不会有任何效果，因为这时根本没有控制台可供写入。）
制台窗口，而不会写到出错日志。（如果服务器是以Windows服务运行的，
log_error。如果你在手动启动服务器时使用了--console 选项，那么它会把诊断输出写到控
用另外的出错日志名，可以在命令行或者某个选项文件的[mysqla]组里设置系统变量
454
你可以将慢查询日志写入文件、数据库表，或者同时写到这两个地方。更多详细信息请参
要想启用慢查询日志，需要启用系统变量slow_query_log。要想指定日志文件名，可以
，因此如果你的服务器陷入停顿状态，
一起的时候更是如此。
慢查询日志有助于把那些在重写时可以进行改进的查询标识出来。不过，在解释其内容
服务器写入的慢查询日志是文本格式的，因此可以用任何文件查看程序来查看它，也可以
你可以将普通查询日志写入文件、数据库表，或者同时写到这两个地方。更多详细信息请
要想启用普通查询日志，需要启用系统变量general_log。要想指定日志文件名，可以设置
普通查询日志记录的内容有：客户端何时连接的服务器、客户端发送给服务器的每一条SQL
口如果启用了系统变量log_queries_not_using_indexes，服务器还会把那些没有使用
口如果服务器启动时带有--log-slow-admin-statements 选项，那么它会把执行慢的管
口查询“慢”的定义是其执行时间超过了系统变量 long_query_time 的值，
有几个相关选项和系统变量会影响服务器写到慢查询日志的内容。
还应该把系统的正常负载考虑在内。
慢查询日志记录的是那些需要花费很长时间（默认为10秒）才能执行完毕的查询。因为查
理语句（如 ANALYZE TABLE或ALTER TABLE）记录下来。