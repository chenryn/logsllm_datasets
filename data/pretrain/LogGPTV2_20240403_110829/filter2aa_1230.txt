How to use CSP to 
stop XSS
Ken Lee
Friday, August 2, 13
Who is this guy?
•
Product Security Engineer
at Etsy
•
Previously worked at a 
ﬁnancial software company
•
@kennysan
•
PI:EMAIL
Friday, August 2, 13
What is CSP?
•
Content Security Policy
•
Browser-based XSS Defense
•
http://www.w3.org/TR/CSP/
Friday, August 2, 13
I throw this into the page’s template/html:
Friday, August 2, 13
How does it work?
•
By default, browsers obeying a CSP do not execute 
javascript that is inline on the page
•
In addition, it disallows the eval and similar functions 
like window.setTimeout
Friday, August 2, 13
Content-Security-Policy-Report-Only:default-src *; style-src * 'unsafe-inline'; 
script-src 'unsafe-inline' 'unsafe-eval' *.googleapis.com *.googleapis.com 
*.pinterest.com *.etsystatic.com lognormal.net *.google.com *.google-analytics.com 
*.etsystatic.com *.etsy.com *.etsysecure.com *.truste.com *.thinglink.me 
*.thebrighttag.com *.facebook.net *.facebook.com *.thinglink.com *.tumblr.com 
*.btstatic.com *.google-analytics.com *.twitter.com *.atdmt.com 
*.googleadservices.com *.doubleclick.net *.flickr.com *.iesnare.com *.gstatic.com 
nxtck.com *.akamaihd.net; report-uri /beacon/csp.php
A sample CSP
Friday, August 2, 13
CSP directives
•
connect-src
•
font-src
•
frame-src
•
img-src
•
media-src
•
object-src
•
style-src
•
none
•
self
•
unsafe-inline
•
unsafe-eval
Friday, August 2, 13
report-only mode
•
report-uri speciﬁes URI to POST CSP issues
•
Doesn’t actually block content from loading
Friday, August 2, 13
CSP is still evolving...
Browsers are mostly CSP 1.0 
compliant these days
Friday, August 2, 13
What about Inline JS?
•
CSP 1.0 says: create external scripts out of your inline js
•
Or you can have unsafe-inline as a directive
•
If you use require.js or any other async javascript 
library, gl/hf;
•
CSP 1.1 to the rescue
•
...some day?
Friday, August 2, 13
http://www.etsy.com/listing/157723652/keep-calm-and-hold-my-beer-poster-117-x
Friday, August 2, 13
Rolling Out CSP
•
How should you approach deploying CSP?
•
Most sites have focused on deploying CSP to speciﬁc 
functionality
•
Why does this make sense?
Friday, August 2, 13
Monitor All The Things!
Friday, August 2, 13
Mixed Content
•
Your CSP endpoint can help you detect instances of 
mixed content
•
HSTS can help you kill a lot of it
•
...But usually the problem won’t be from your 
subdomains
Friday, August 2, 13
Some Words...
•
Adding unsafe-inline and unsafe-eval basically defeats 
CSP’s ability to stop XSS.
•
CSP can cause header sizes to grow very large!
•
Make sure you test your policy!
Friday, August 2, 13
•
Content-Security-Policy ~Firefox 23, Chrome 25. 
•
Append Report-Only for “reporting mode”
•
Add a report-uri at the end to make the browser POST a 
CSP violation there
•
Fix all the violations, CSP all the things
CSPTools
Friday, August 2, 13
CSPTools
•
Want to test out a Content Security Policy, but scared 
to push your policy to prod?
•
You hate poisoning your hosts ﬁle every time you want 
to test your CSP in your dev environment
•
You’ll love CSP Tools. I promise.
Friday, August 2, 13
CSPTools
•
Features 3 diﬀerent set of tools
•
Proxy - Intercepts http, https traﬃc, inserts a csp 
header, and logs csp reports
•
Browser - auto-browse sections of your site with the 
proxy (can we say unit tests?)
•
Parser - Creates a csp policy based oﬀ proxy traﬃc
Friday, August 2, 13
DEMO
Friday, August 2, 13
DEMO
Friday, August 2, 13
Get It.
•
On Github: http://kennysan.github.io/CSPTools
•
Found bugs? Issue a pull request!
•
Hit me up on twitter! @Kennysan
•
Greetz to Kai Zhong for helping me with the pythons
Friday, August 2, 13