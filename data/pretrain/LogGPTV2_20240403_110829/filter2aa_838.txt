### 基于历史行为的异常检测：Office 365如何应对内部恶意攻击

**作者：Lei He**
**职位：首席工程经理，微软公司**
**日期：2019-05-30**

#### Office 365安全要求
- **客户密码箱入门**：仅限企业服务访问客户数据。
- **Corp身份限制**：禁止使用Corp身份进行解密或访问；所有访问需经过双因素认证（2FA）。
- **背景调查与安全培训**：员工需接受严格的背景调查及定期的安全培训。
- **用户数据隔离**：用户数据和操作中心需保持隔离。
- **零永久访问权限**：确保没有任何人拥有永久访问权限。
- **客户密码箱和自带密钥（BYOK）**：支持客户密码箱和自带密钥管理。
- **基于ETW的详细原始遥测技术**：能在一天内测量新的遥测技术。
- **集中处理与警报**：在15分钟内发出警报以解决安全问题。
- **攻击模拟服务**：每天至少一次攻击模拟，验证监视和响应机制。
- **快速安全响应**：在15分钟内触发安全响应工作流程，并在一天内检测新工作流程。
- **秘密存储**：所有秘密必须存放在安全容器中。
- **边界控制**：秘密不得离开边界，暴露时应立即更新。
- **数据受托人控制**：数据受托人应在更新环境中完全控制秘密。
- **每日扫描**：每天扫描所有产品终点。
- **漏洞修补**：所有中等及以上评级的漏洞都应及时打补丁或豁免。
- **网络应用程序扫描**：所有网络应用程序应每月扫描一次。
- **中央报告和跟踪**：统一管理和跟踪所有安全事件。

#### 概览
- **问题**：信息泄露和心怀不满的恶意内部人员是重大的安全威胁。现有的监督机器学习（ML）检测方法只能识别已知模式，无法覆盖未知模式。
- **解决方案**：通过基于历史行为的检测来标记异常活动。对于Office 365数据中心安全，将用户视为DevOps角色，并推广到其他实体配置文件。

#### O365数据中心监控
- **自动近实时多层检测和响应**：Vanquish监测管道可评估数十万机器和数千用户的活动。
- **Spark上的近实时处理**：在15分钟内发出寻呼警报（包括基于ML的警报）。
- **分析工具和仪表板**：提供近乎实时的交互式结果查看功能。
- **24x7警报和自动化**：全天候寻呼警报和自动响应机制。

#### 模型特征选择
- **登录活动**：用户登录地点、时间及后续操作。
- **权限提升**：请求类型、批准者及提升目的。
- **操作**：执行的工作流程、启动的进程及触发的检测。
- **特征**：登录机器、机器类型、容量单位范围、登录IP、连接IP、其他检测触发、提升权限、特定时间、流程和工作流程。

#### 模型
1. **生成每个用户的完整历史行为总结**：每个要素都是{ Value: Occurrence }的列表。
2. **每隔2分钟，评估用户过去6小时的活动**。
3. **比较当前活动与历史活动**：
   - 计算会话中的值特征相似性得分。
   - 根据多个特征的相似性得分生成会话异常分数。
4. **收集历史事件测试数据集**以评估性能。
5. **设置警报阈值**：根据每周5次的警报次数容忍度设定阈值。

#### 模型调优
- **新团队成员**：设置活动量的最低阈值。
- **稀疏功能**：设置有效功能的最低阈值。
- **双重计数**：删除自动生成的活动。
- **换队伍**：使用团队资料。
- **重命名命令**：不区分大小写的比较。
- **高熵特点**：用{Capacity Unit, Capacity Type}替换目标计算机名称或IP。
- **降低用户源IP权重**。
- **降级自由文本功能**：例如，提升权限。

#### 模型性能
- **成功指标**：自2018年末发布以来，每周平均提供约5次警报。
- **精确度**：约90%真阳性（上个月16/18）。
- **真实积极的类型**：渗透测试、一次性事件（“破碎玻璃”）、审计、操作流程违规、DevOps不良行为、DevOps一次性测试或试验。

#### 行动起来
- **应用基于历史行为的异常检测深度防御**：
  - 从高质量数据开始。
  - 找到真实的恶意事件。
  - 在线实施前先进行离线分析。
  - 通过反馈循环持续调整。
  - 使用可解释的模型。
  - 提供足够的补充信息以支持警报。

#### 答疑
- **基于历史行为的异常检测**：更多详情请参阅[LinkedIn](www.linkedin.com/in/lei-he-security)。

**联系信息**：
- **电子邮件**：PI:EMAIL