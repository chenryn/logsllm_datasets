	权重计算(根据预先设置的各类告警的权重，计算成为根源告警的可能性) 5) 	生成根源告警(将权重最大的派生告警标记为根源告警) 
	根源告警合并(若多类告警计算出的根源告警相同，则将其合并) 6)根源告警合并(若多类告警计算出的根源告警相同，则将其合并) 6) 
7) 	根据历史告警处理知识库，找到类似根源告警的处理方案，智能地给出解决方案。
图 1 京东金融根源告警架构图 举例来说： 
假设多个系统通过 RPC 进行服务调用，调用关系如下： 
D 系统-> C 系统-> B 系统-> A 系统 
第 66 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
当 A 系统查询数据库出现查询超时后，告警会层层往前推进，导致 B、C、D 系统均有 N 个超时告警产 生。此时，ROOT 分析可以将告警进行收敛，直接分析出根源告警为 A 系统访问数据库异常，导致 A、B、C、D 多个系统异常。 
	这样，就避免了处理人员和每个系统开发人员沟通，辅助处理人员快速定位问题根源、提高了平均解决 时间(MTTR)。如下图所示： 
图 2 京东金融根源告警调用链关系图图 2 京东金融根源告警调用链关系图 
图 3 京东金融根源告警明细图 
3、根源告警分析处理方法 
	根源告警分析的方法主要分为强关联分析与机器学习两类。 
	 1)强关联数据分析 
强关联指的是已知确定的关联关系。如： 
·应用之间的调用链关系 
·数据库与应用服务器 
·网络设备与网络设备、网络设备与应用服务器 
·宿主机与虚拟机关系等 
	若在同一时间窗内，多个强关联设备或应用服务器同时告警，则大概率认为告警之间存在关联关系。 
第 67 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
	在权重算法中，有一个重要的规则，链路上存在连续的告警可能存在关联，越靠后的应用越可能是根源。现在我们根据例子，分别计算各类根源告警。 
继续使用上面的例子，D 应用->C 应用->B 应用->A 应用->数据库 的异常的情况。·首先是计算数据库根源告警。根据数据库关联关系，会派生数据库类型的数据库告警、A 应用告警。还会派生一条应用类型的 A 应用数据库异常告警。 
根据数据库派生告警以及数据库与应用的关联关系及权重，可以得出数据库异常导致 A 应用查询超时。 
	·接下来是计算应用根源告警。根据调用关系，我们先计算出连续多个应用告警的链路。当前 D->C->B->A 四个应用都有派生告警，满足此规则。 
	·然后，找到最靠后的告警应用，也就是 A 应用。列举时间窗口内所有 A 应用的派生告警(可能存在多 种派生告警，根据权重计算根源)，将权重最高的派生告警标记为根源告警。 
比如：A 系统内部有 2 种类型派生告警，分别是数据库告警、GC 告警。 
根据权重计算规则，数据库告警为 90，GC 告警 10，也就是说数据库异常告警权重最高。这时由于数据 库根源告警和调用链根源告警一致，会将两种类型的告警合并。最后得出结论：数据库异常导致 A、B、C、D 系统告警。2)机器学习根源分析 
	强关联数据分析是对已知告警的关联关系，直接进行根源告警分析。但是有些时候，关联关系是未知的，这时就需要通过机器学习算法，找到告警事件之间的隐含联系，再进行根源告警进行故障预测。 
目前，京东金融智能运维平台中使用到的主要是以下两大类机器学习算法。 
	1、关联规则算法 
	关联规则算法主要进行了 Apriori 算法和 FPGrowth 两类算法的实践。这两类功能相似，都可以发现频 繁项集。经过实测，FPGrowth 比 Apriori 更高效一些。 
	我们按一定的时间间隔划分时间窗，计算每个时间窗内，各种告警一起出现的频率，找出各类告警之间 的关联，最终可按分析出的关联关系，生成根源告警。 
关联规则算法的优点在于理解和实现起来比较简单。缺点是效率比较低，灵活度也不够高。 
	2、神经网络算法2、神经网络算法 
	循环神经网络(简称 RNN)是一个和时间序列有关系的神经网络，对单张图片而言，像素信息是静止的，而对于一段话而言，里面的词的组成是有先后的，而且通常情况下，后续的词和前面的词有顺序关联。 	这时候，卷积神经网络通常很难处理这种时序关联信息，而 RNN 却能有效地进行处理。 
随着时间间隔的增大，RNN 对于后面时间的节点相比前面时间节点的感知力将下降。解决这个问题需要 用到 LongShort Term 网络(简称 LSTM)，它通过刻意的设计来避免长期依赖问题。LSTM 在实践中默认可以 记住长期的信息，而不需要付出很大代价。 
对于某类故障引起的大量告警之间，存在着时间相关性。将历史派生告警作为输入，将根源告警类型作 为输出。通过 LSTM 提取派生告警特征，建立告警相关性分析模型。这样就可以实时将符合特征的派生告警，划分到同一类根源告警中，帮助用户快速定位问题。第 68 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
需要说明的是金融本身的业务特点决定了对第三方存在依赖性，因此告警本身的随机性较大，客观上导 致学习样本的质量不高，需要长期的积累和修正才能达到比较好的效果，因此对于根源告警，如果有条件取 到强关联关系，建议使用强关联分析，能达到事半功倍的效果。 
4、总结 
	针对金融场景下业务规模大，应用关系复杂，依赖层次多，排查问题困难的问题，我们建设了具有智能 化的根源告警分析的方案。通过告警过滤，生成派生告警，告警关联，权重计算，生成根源告警，根源告警 合并，关联历史告警处理知识库的方案进行处理，通过强关联分析和机器学习的分析方法，找到根源告警，并智能地给出解决方案。 
第 69 页共 74 页
《企业级 AIOps 实施建议白皮书》V1.0 
案例 3：单机房故障自愈 
作者：曲显平 @百度智能云事业部 技术经理案例 3：单机房故障自愈 
作者：曲显平 @百度智能云事业部 技术经理 
 哈晶晶 @百度智能云事业部 故障自愈方向技术专家  
1、案例概述 
	在大型互联网公司中，单机房故障因为其故障时间长、影响范围大，一直是互联网公司运维人员的心头 之痛。在传统的运维方式中，由于故障感知判断、流量调度决策的复杂性，通常需要人工止损，但人工处理 的时效性会影响服务的恢复速度，同时人的不可靠性也可能导致问题扩大。 
为了解决这类问题，我们针对百度内外部网络环境建设了基于智能流量调度的单机房故障自愈能力。结 合外网运营商链路监测、内网链路质量监测与业务指标监控构建了全方位故障发现能力，基于百度统一前端 (BFE)与百度名字服务(BNS)实现了智能流量调度与自动止损能力。同时，基于实时容量与实时流量调度自动 止损策略与管控风险，实现了任意单机房故障时业务均可快速自愈的效果。当前此解决方案已覆盖百度众多 核心业务的单机房故障自愈场景。2、单机房故障止损流程 
	一个完整的故障处理生命周期包括感知、止损决策、止损、定位和根因分析、解决问题五个阶段。单机 房故障自愈主要覆盖从感知到止损阶段，其中感知阶段依赖监控系统的故障发现能力，止损阶段依赖流量调 度系统的调度能力。我们来具体看下百度的监控系统与流量调度系统是如何在单机房故障止损场景中起作用。 
	1．故障发现：百度监控平台 
	百度监控平台，针对单机房止损过程中的可用性场景，覆盖故障发现、止损决策、问题定位各阶段的监 控。针对单机房止损依赖的容量管理场景，提供资源类监控采集，为容量规划、扩缩容提供数据支持。数据 采集覆盖了从运营商外网链路、百度内部网络设备/链路、服务/实例、机器/容器的全方位数据。智能异常检 测、趋势预测、多维度分析、关联分析、服务和链路拓扑分析，实现故障的精准发现和定位。 
	2. 故障止损：百度流量调度平台2. 故障止损：百度流量调度平台 
	针对百度的网络架构和业务架构（参考图 11-4），我们将流量调度拆分为三层：接入层、服务层、依赖 层。 
1)接入层：从外网用户发起请求经运营商网络到百度统一前端（BFE）使用 DNS 实现外网流量调度。 2)服务层：从 BFE 流量转发至内网服务使用 BFE 提供的 GSLB 动态负载均衡进行流量调度。 