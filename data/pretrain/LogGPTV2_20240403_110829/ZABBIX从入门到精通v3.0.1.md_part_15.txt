协议，并且Google已经将Gtalk的服务器开放给了其它的Jabber服务器。所以PSI、Giam等Jabber客户端软件支
持GTalk用户登陆。
jabberXMPP（可扩展消息处理现场协议）是基于可扩展标记语言（标准通用标记语言下的一个子集、外语缩写：XML）
的协议，它用于即时消息（IM）以及在线现场探测。它在促进服务器之间的准即时操作。这个协议可能最终允许因
特网用户向因特网上的其他任何人发送即时消息，即使其操作系统和浏览器不同。XMPP的技术来自于Jabber，其
实它是 Jabber的核心协定，所以 XMPP有时被误称为Jabber协议。Jabber是一个基于 XMPP协议的IM应用，除
Jabber之外，XMPP还支持很多应用。
IEEE XMPP工作组（一个工程师和程序员联盟）正在改编XMPP以用作互联网工程任务组（IETF）技术。XMPP最
终有望使用鉴定、访问控制、高级隐私、逐跳加密、端端加密以及与其它协议的相容等应用来支持IM。
zabbix 报警媒介：Ez Texting
Ez Texting是zabbix的技术合作伙伴，主要提供短信服务，用手机注册账号，便可以使用它来发送短信了，不过他
只支持美国和加拿大的手机号码，并且应该是收费的。没有美国/加拿大手机号码的朋友请绕行，先了解的请继续往
下看。
配置
点击Administration（管理）→Media types（媒介类型）->点击创建
参数说明：
选项 描述
Name 媒介名称，看着起名
Type 选择Ez Texting，如果你没有账号，你可以到https://app.eztexting.com注册（没
有手机号码绕行）
username 你的ez账号
Password Ez密码
Message text limit 文本消息限制
USA (160 characters)，美国一条短信支持160个字符
Canada (136 characters)，加拿大一条短信支持136个字符
使用
定义好了媒介之后，我们需要把这媒介指定给用户。Administration->Users->打开用户配置->media type里面添加刚
增加的媒介
参数说明
选项 描述
Type 选择媒介名称，此处选Ez Texting
Send to 发短信给谁，填手机号码
When active 发送时间，只有在这个时间段内才会发短信
Use if severity 发送短信的触发器级别
Status 当前媒介状态
Enabled – 使用中.
Disabled – 禁用中.
zabbix 报警媒介： Custom alertscripts
老板抠门不给买SMS短信猫，投错胎导致没有美国/加拿大手机号码，根本搞不清楚jabber是个什么玩意儿，sendmail
又不靠谱，那都不是事，想要轻轻松松报警，那么用上自定义脚本媒介。zabbix会将信息传递给脚本，接下来你在
脚本里面随意处理，一共会传递三个参数,按顺序接受也就是$1,$2,$3 了，为了方便记忆，一般分别给他们赋值到
To\Subject\body.
配置 AlertScriptsPath
在server的配置文件中配置，这是用来定义脚本目录，这样一来zabbix就能找到脚本了
# cat /usr/local/zabbix-2.2.1/etc/zabbix_server.conf | grep AlertScriptsPath
### Option: AlertScriptsPath
AlertScriptsPath=/usr/local/zabbix-2.2.1/alertscripts
# mkdir /usr/local/zabbix-2.2.1/alertscripts
创建发邮件脚本
# cat /usr/local/zabbix-2.2.1/alertscripts/mail.sh
#!/bin/sh
to=$1
subject=$2
body=$3
/usr/local/bin/sendEmail -f PI:EMAIL -t "$to" -s smtp.ttlsa.com -u "$subject" -o message-content-type=html -o
message-charset=utf8 -xu PI:EMAIL -xp 123456 -m "$body" 2>>/tmp/22.log
# chmod a+x /usr/local/zabbix-2.2.1/alertscripts/mail.sh
脚本里面使用 sendEmail发送邮件，sendEmail的用法请点击《使用sendEmail发送邮件》，不一定非要发送邮件，
也可以发飞信或者调用短信平台接口
配置自定义脚本媒介
Administration->Media types->创建
参数说明
选项 描述
Description 媒介名称，看着起名,这边叫sendEmail
Type 选择custom scripts
Script name 脚本名称，这边写mail.sh，只要写名称就行了，不要写绝对路径
使用自定义脚本媒介
定义好了媒介之后，我们需要把这媒介指定给用户。
Administration->Users->打开用户配置->media type里面添加刚增加的媒介
参数说明
选项 描述
Type 选择媒介名称，此处选sendEmail
Send to 发邮件给谁，例如PI:EMAIL
When active 发送时间，只有在这个时间段内才会发邮件
Use if severity 发送邮件的触发器级别
Status 当前媒介状态
Enabled – 使用中.
Disabled – 禁用中.
第七章：zabbix 模板
zabbix 模板介绍
zabbix 模板是做什么的?
我们不提概念，通过一个案例来说明他是干什么的。
王小明是某公司系统管理员，负责100台Linux服务器，还有几台windows服务器。他选择了zabbix作为监控服务
器基本性能，如 cpu、内存、硬盘、网络这些基本的东西，主管要求他一天内搞定。于是他开始做，第一台服务器
添加cpu、内存、硬盘、网络的items，然后第二台在一个个添加，添加了两天两夜，他一夜没合眼，突然看到zabbix
模板的功能，卒了。
这是一个忧伤的故事，没文化害死人是真的。如果他一开始创建一个模板，然后每个服务器套用/链接这个模板，那
么只要在创建主机的过程中在link（套用/链接）这个模板，一个服务器就完成了。也不会发生这么悲伤的事情….
平时工作中，我们需要监控web、mysql、redis、nginx这些服务器，众多服务器的业务都是一样的，所以我们只要
事先创建好模板，然后所有服务器链接这个模板即可，如果后续有修改、新增功能，只需要修改模板即可。
zabbix 模板创建
zabbix模板中可以包含监控项、触发器、web监控、图表等等项目，一一创建这些项目之后，在后续的主机只需要
套用这个模板，那么主机便可以监控模板里面所配置的监控项目。
创建 zabbix 模板
点击Configuration（配置） —Templates（模板）—create template（创建模板），
template标签信息如下
参数 描述
Template name 模板名称，在嵌套模板中，都使用template name
Visible name 显示的名称，template显示是visible name，方便识别
Groups Host/template 当前模板归到哪个组
New group 创建一个新组，当前模板便会加入这个组，可以为空
Hosts/Templates 把模板链接到主机
linked template标签如下
模板嵌套，是一个继承的关系。例如我们定义了一个基础模板，里面item有cpu、内存、硬盘、网卡等等基本信息
监控，我们有需要定义个MySQL与WEB监控模板，那么这两个模板分别嵌套这个基础模板即可，而不需要重复定
义监控项。
使用方法：
文本框里输入关键词，例如Linux即可搜索到名称含有linux的模板，在下拉列表中选择你要的模板，最后点击Add
（千万不要忘记）。
Macro标签如下
Macro变量名称，value为变量值。更多的使用方法请参考《zabbix自定义用户Macro》
添加items, triggers, graphs,low-level discovery rules,web scenarios,screens
一一添加items, triggers, graphs,low-level discovery rules,web scenarios,screens。与在单台host添加item，trigger，
graphs等等的方法是一样，这边我就不再重复了。添加完毕之后，一个模板也就这么完成了。
编辑 zabbix 模板
点击 Configuration（配置） —Templates（模板）—你需要编辑的模板，当前的底部要比创建模板要多几个按钮，
我们分别来讲下这下按钮都是做什么的
按钮名称 描述
save 保存，没什么好说的
Clone 克隆模板，克隆一个与当前模板一模一样的模板，此时你只需要修改下模板名称，以及在其
基础上做修改，便能很快的完成一个模板
full clone 完全克隆，比clone多一点东西，例如screen
delete 删除模板，如果主机有嵌套当前模板，那么这些item依旧保留在主机上，主机不受影响
delete and clear 删除模板，如果主机有嵌套当前模板，那么这些item也被删除掉。
cancel 取消
zabbix 链接及解除模板链接
上一节讲到《zabbix 创建模板》，其中就已经涉及到了链接与解除模板链接（link 与 unlink），这篇文章除了说明怎
么链接模板以外，还会特别讲到一些需要特别注意的细节。HOST链接模板之后，便继承了模板里定义的item，trigger
等等，使用这个方法，配置zabbix监控会减少很多重复的体力劳动，并且更加灵活。
备注：模板只能被链接到host，不是链接到组里面。
zabbix 主机链接模板
ConfigurationHosts点击你需要链接模板的主机切换到templates（模板）选项，Link new templates的文本框
里面输入你需要 link 的模板名称（关键词就可以了），选择你需要添加的模板，点击 Add，最后 save。最后，当前
host便获得了模板所有的item，trigger，web等等实体。
备注：主机link多个模板必须注意，模板们不能含有相同的item key。trigger和graphs中使用的items不能是来自
多个模板。
当实体 (items, triggers, graphs等等)添加之后，内部操作如下：
 host原有的项目与模板的相同，那么host原有的监控项目将会被模板所有的覆盖
 模板中的所有实体添加到主机中
关于 item 列表
link 模板之后，我们可以发现，item 的名称也有些变化。凡是从模板带来的 item，名称前缀带有灰色的模板名称。
没有任何前缀的，那么表示这个item是在当前host里定义的。
实体唯一性规则
通过前面描述，我们可以了解到，zabbix link多个模板，这些模板不能有相同的实体。如果模板里的实体与当前host
实体冲突，那么当前hosts的实体将会被覆盖，基于此，我们需要了解实体唯一性的规则由什么决定!
属性 说明
items item key
trigger trigger名称与表达式
自定义图表 图表名称与它的items
applications application的名称
多台主机批量 link 模板
批量link主机的方法
Configuration–Templates, 点击你需要选择的模板， Other | group 里面选择你的主机，点击« ,讲主机们添加到左边
Hosts / templates，最后点击save即可，如果想移除主机，只需要点击»。
批量更新template
Configuration — Hosts — 勾上你需要批量更新的主机，左下角下拉框选择 Mass update，然后点击 Go,切换到
template，选择你需要的模板。最后点击update即可。
备注：
zabbix默认提供了很多模板，有什么不懂的可以参考他，但是不推荐你直接在自带的模板上修改，确实有修改修改，
我倾向于让你去克隆一个模板。
编辑link实体
在host里面，点击zabbix实体，大部分文本框都是灰色/不可编辑状态，只有更新间隔等等少量内容可以修改。因
为很多 host 使用同一个模板，一旦你修改了一个实体，所有 host都会跟着变化，所以 zabbix不允许直接修改link
过来的实体类。如果你确实需要修改他，那么你只能去修改zabbix模板，不过记住，修改之前要谨记，所有link当
前模板的host都会一起变动。
Unlinking 模板
Configuration–Hosts–切换到Templates选项–点击Unlink 或者Unlink and clear，最后点击save。
unlink与unlink and clear的区别
 unlink：仅仅移除template，原先的实体会继续保留在host上
 unlink and clear：移除template，template所包含的实体也会一起移除，相对比较彻底。
zabbix 模板嵌套 Templates Nesting
在zabbix使用过程中，在某些情况下，一个host需要link多个模板。这么做显得比较麻烦，很容易忘记到底要link
哪些模板，我想link一个模板就达成这个目标，行不行？然没问题，zabbix模板内嵌就是这么做的。实际上模板内
嵌在《zabbix创建模板》一文就提到了，简单的说就是：模板link多个模板，这便是内嵌。
zabbix 模板内嵌步骤
configuration（配置）– Templates（模板），点击你的目标模板，切换到linked templates选项，在文本框里面搜索
你需要的模板，然后点击Add，如下：
说明下两个参数
 Unlink and clear：移除模板，并且移除所有hosts上的实例（什么是实体不用我说了吧？前面章节有提过）。比
如之前host有使用这个模板，那么从这个模板来的实体全部被移除掉。
 Unlink：仅仅是移除模板，实体依旧保留在host上。
第八章：zabbix 可视化
zabbix 图表功能介绍
zabbix可视化图表绝对是他的一个大特性，我相信很多人也是被它的制图能力吸引到，它可以把任何数值数据转成
可读性很强的图表。用过 nagios 的运维们基本都使用 cacti 来绘图，遗憾的是我没用过 cacti，所以我不发表评论。
说心里话cacti画的图真心比zabbix画的漂亮，不过zabbix还是用它的简单实用打动了我.
zabbix 简易图表详解
概述
在zabbix中，所有数值item值都可以绘制成简易的图表。在Monitoring->Latest data->任意一个数值item列上有个
Graph,点击便会出现一个简易图表。如下图：
时间段选择
请看上面的图片，我们可以通过如下方式来查看你需要的数据。
 通过日历选择时间段
点击右上角两个日期会弹出两个日历，选择起止两个日期图表便能显示这个时间段的简易图表
 点击1h 1d等日期前移
以右上角结束时间为准，如果你点击 1h，那么开始时间会往左边移动，点击 7d，那么会往左边移动 7 天。请看下
面两个图片，可以发现点击7d之后，开始时间变成了7天前。
 时间前/后变更
在滑动条下方可以看到”«« 1m7d1d12h1h | 1h12h1d7d1m »»”，中间有个分割线，表示整个时间段往左/右移动，或者
起始时间往左移动/终止时间往右边移动。为什么会有或者的关系呢？是不是有点晕。看看滑动条右下角有个
fixed/dynamic。来讲讲他们的区别吧。
 fixed翻译过来就是固定的意思，就是说你选择的时间段是固定的，例如你选择的时间段是1天，你点击左边
的1d，那么起止时间都会往左边移动，也就是说你怎么移动都只能看1天的数据。
 dynamic 翻译过来便是动态的意思，就是说你选择的时间段是动态变化的，例如你选择的时间段是一天，你
点击左边的1d，那么起始时间会往左边移动，终止时间不懂，也就是说你可以看到2天的数据。如果你点击
右边的1d，那么终止时间会往右边移动，这样的话，你可以看到3天的数据。
 4. 通过滑动条
滑动条，你自己可以左右拖动。也可以点击滑动条左右两侧的'’按钮，重点说明一下这两个按钮，如果处
在fixed下，默认情况下，你点击一次按钮将会往左/右滑动一个小时。如果当前zoom你选择的是2d，那么点击一
次将以2d为单位左右滑动.如果是dynamic,不管怎么样，每次都以1天为单位.
最新数据 vs 老数据
对于最新的数据，简易图表中只会有一条曲线，每个点坐标点代表一个item值，如果数据比较老，来自trends，那
么图表会有3条线，分别代表最大值、平均值、最小值，还有图表背景深色部分表示工作日，具体的请看我给的截
图
备注：简易图表都会自动显示工作时间的背景，但是在自定义图表（咱们ttlsa下一篇的内容）里面这需要配置，图
表时间段超过3个月，工作时间不会显示，到时候如果不出现，别太诧异。
使用历史/趋势数据生成图表
图表都是基于历史或者趋势数据生成的，在图表的右下角我们可以判断图表是使用什么数据生成的，如果是”data
from history”表示使用历史数据生成。如果是“data from trends”表明图表数据来自趋势数据。关于《zabbix历史
与趋势记录》请参考以前的文章，有做详细的介绍。
关于使用趋势数据:
 较老的item历史数据，例如item的历史记录只保留半年，这个时候你查看半年以前的数据，因为历史数据已
经被删除了，所以只能使用趋势数据来绘制图表。
 数据拥挤，如果图表水平像素超过 3600/16，那么不管你的历史记录是否存在，他一定会使用趋势记录，你想
想，如果一个item每隔一秒去获取数据，你要查看他10天的数据，那张图片该多乱，这个时候使用趋势记录
来绘制图片的效果实际上是一样的。
 趋势记录被禁用，如果存在当前时间段 item 的历史数据，那么将会使用历史记录来绘制图表. 这个特性从
Zabbix 2.2.1开始支持 (以往, 如果禁用了趋势记录，那么只会显示一张空白图表，不管历史记录是否存在.