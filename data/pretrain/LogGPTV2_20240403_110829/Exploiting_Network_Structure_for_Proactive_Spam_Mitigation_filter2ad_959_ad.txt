mail/spam sent by IP addresses belonging to a cluster
as the legitimate mail/spam sent by or coming from that
cluster. As with the IP-based analysis, we examine how
the volume of legitimate mail and spam from IP ad-
dresses is distributed as a function of their cluster spam-
ratios. To understand the additional error imposed by us-
ing the cluster spam-ratio, we compare it with how those
volumes are distributed as a function of the IP spam-
ratio.
Fig. 6(a) shows how the spam sent by IP addresses
with a cluster or IP spam-ratio of at most k varies with
k. Speciﬁcally, on day i, let CSi(k) and ISi(k) be the
fraction of spam sent by the IP addresses with a cluster
spam-ratio (and IP spam-ratio, respectively) of at most
k. Fig. 6(a) plots CSi(k) and ISi(k) averaged over all
the days in the data set, as a function of k, along with
conﬁdence intervals.
Result 7. Distribution of spam with cluster and IP
spam-ratios: Fig. 6(a) shows that almost all (over 95%)
of the spam every day comes from IPs in clusters with a
very high cluster spam-ratio (over 90%). A similar frac-
tion (over 99% on average) of the spam every day comes
from IP addresses with a very high IP spam-ratio (over
90%).
This suggests that spammers responsible for a high
volume of the total spam may be closely correlated
with the clusters that have a very high spam-ratio. The
graph indicates that if we use a spam-ratio threshold of
k ≤ 90% for spam mitigation, then using the IP spam-
ratio rather than the corresponding cluster spam-ratio as
the discriminating feature would increase the amount of
spam identiﬁed by less than 2%. This suggests that clus-
ter spam-ratios are a good approximation to IP spam-
ratios for identifying the bulk of the spam sent.
We next consider how legitimate mail is distributed
with the cluster spam-ratios and compare it with IP
spam-ratios (Fig. 6(b)). We compute the following met-
ric: Let CLi(k) and ILi(k) be the fraction of legitimate
mail sent by IPs with cluster and IP spam-ratios of at
most k on day i. Fig. 6(b) plots CLi(k) and ILi(k) av-
eraged over all the days in the data set as a function of k,
along with conﬁdence intervals.
Result 8. Distribution of legitimate mail with cluster
and IP spam-ratios: Fig. 6(b) shows that a signiﬁcant
amount of legitimate mail is contributed by clusters with
both low and high spam-ratios. A signiﬁcant fraction of
the legitimate mail (around 45% on average) comes from
IP addresses with a low cluster spam-ratio (k ≤ 20%).
However, a much larger fraction of the legitimate mail
(around 70%, on average) originates from IP addresses
with a similarly low IP spam-ratio.
The picture here, therefore, is much less promising:
even when we consider spam-ratios as high as 30 − 40%,
the cluster spam-ratios can only distinguish, on average,
around 50% of the legitimate mail. By contrast, IP spam-
ratios can distinguish as much as 70%. This suggests that
IP addresses responsible for the bulk of legitimate mail
are much less correlated with clusters of low spam-ratio.
We can then make the following conclusion: suppose
we use a classiﬁcation function to accept or reject IP ad-
dresses based on their cluster spam-ratio. What addi-
tional penalty would we incur over a similar classiﬁca-
tion function that used the IP address’s own spam-ratio?
Fig. 6(b) suggests that, if the threshold is set to 90% or
higher, we incur very little penalty in both legitimate mail
acceptance and spam. However, if the threshold is set to
30 − 40%, we may incur as much as a 20% penalty in
doing so.
However, there are two additional ways in which such
a classiﬁcation function could be enhanced. First, as we
have seen, the bulk of the legitimate mail does come from
persistent k-good IP addresses. This suggests that we
could potentially identify more legitimate mail by con-
sidering the persistent k-good IP addresses in addition
USENIX Association
16th USENIX Security Symposium
157
to cluster-level information. Second, for some applica-
tions, the correlation between high cluster spam-ratios
and the bulk of the spam may be sufﬁcient to justify us-
ing cluster-level analysis. For example, under the exist-
ing distribution of spam and legitimate mail, even a high
cluster spam-ratio threshold would be sufﬁcient to reduce
the total volume of the mail accepted by the mail server.
This is exactly the situation in the server overload prob-
lem and we see the effect in the simulations in Sec. 4.
3.2 Persistence
Next, we explore how persistent the network-aware clus-
ters are, just as we did for the IP addresses. We deﬁne a
cluster to be present on a day if at least one IP address
that belongs to that cluster appears that day. We reported
earlier that we found the clusters themselves to be at least
as (and usually more) temporally stable as IP addresses.
Our next goal is to examine how much of the total legiti-
mate mail/spam the long-lived clusters contribute.
As in Sec. 2.2.2, we will deﬁne k-good and k-bad clus-
ters; to do that, we use the lifetime cluster spam-ratio:
the ratio of the total spam sent by the cluster to the total
mail sent by it over its lifetime.
Deﬁnition 3. A k-good cluster is a cluster of IP ad-
dresses whose lifetime cluster spam-ratio is at most k.
The k-good cluster-set is the set of all k-good clusters. A
k-bad cluster is a cluster of IP addresses whose lifetime
cluster spam-ratio is at least k. The k-bad cluster-set is
the set of all k-bad clusters.
Fig. 7(a) examines the legitimate mail sent by k-good
clusters for small values of k. We ﬁrst note that the
k-good clusters (even when k is as large as 30%) con-
tribute less than 40% of the total legitimate mail; this
is in contrast to, for instance, 20-good IP addresses that
contributed to 63.5% of the total legitimate mail. How-
ever, we note the contribution from long-lived clusters is
far more than from long-lived individual IPs. The dif-
ference from Fig. 3(b) is striking: e.g., k-good clusters
present for 60 or more days contribute to nearly 99%
of the legitimate mail from the k-good cluster set. So,
any cluster accounting for a non-trivial volume of legit-
imate mail is present for at least 60 days.
Indeed, the
legitimate mail sent by k-good clusters drops to 90% of
k-good cluster-set’s total only when restricted to clusters
present for 120 or more days; by contrast, for individual
IP addresses, the legitimate mail contribution dropped to
87% of the 20-good set’s total after just 10 days.
Fig. 7(b) presents the same analysis for k-bad clusters.
Again, there are noticeable differences from the k-bad IP
addresses, and also from the k-good clusters. A much
larger fraction of spam comes from long-lived clusters
than from long-lived IPs in Fig. 4(b). For example, over
1
t
n
e
s
l
i
a
m
e
t
a
m
i
t
i
g
e
l
f
o
n
o
i
t
c
a
r
F
0.8
0.6
0.4
0.2
k = 1
k = 5
k = 10
k = 20
k = 30
0
0
20
40
60
100
Number of days
80
120
140
160
(a) Fraction of legitimate mail sent by k-good clusters
that appear in at least x days
1
0.8
0.6
0.4
0.2
t
n
e
s
m
a
p
s
f
o
n
o
i
t
c
a
r
F
k = 70
k = 80
k = 90
k = 99
k = 100
0
0
20
40
60
100
Number of days
80
120
140
160
(b) Fraction of spam sent by k-bad clusters that appear
in at least x days
Figure 7: Persistence of network-aware clusters.
92% of the total spam is contributed by 90-bad clusters
present for at least 20 days. This is in sharp contrast with
the k-bad IP addresses, where only 20% of the total spam
comes from IP addresses that last 20 or more days. We
also note that the 90-bad cluster-set contributes to nearly
95% of the total spam. Thus, in contrast to the legitimate
mail sent by k-good cluster-sets, the bulk of the spam
comes from the k-bad cluster-sets with high k.
Result 9. Distribution of mail from persistent clus-
ters: Fig. 7 shows that the clusters that are present for
long periods with high cluster spam-ratios contribute
the overwhelming fraction of the spam sent, while those
present for long periods with low cluster spam-ratios
contribute a smaller, though still signiﬁcant, fraction of
the legitimate mail sent.
The above result suggests that network-aware cluster-
ing can be used to address the problem of transience of IP
addresses in developing history-based reputations of IP
addresses: even if individual IP addresses are ephemeral,
their (possibly collective) history would be useful in
assigning reputations to other IP addresses originating
158
16th USENIX Security Symposium
USENIX Association
from the same cluster.
4 Spam Mitigation under Mail Server
Overload
In the previous section, we have demonstrated that there
are signiﬁcant differences in the historical behaviour of
IP addresses that send a lot of spam, and those that send
very little. In this section, we consider how these differ-
ences in behaviour could be exploited for spam mitiga-
tion.
Our measurements have shown that senders of le-
gitimate mail demonstrate signiﬁcant stability and per-
sistence, while spammers do not. However, the bulk
of the high volume spammers appear to be clustered
well within many persistent network-aware clusters. To-
gether, these suggest that we can design techniques based
on the historical reputation of an IP address and the clus-
ter to which it belongs. However, because mail rejec-
tion mechanisms necessarily need to be conservative, we
believe that such a reputation-based mechanism is pri-
marily useful for prioritizing legitimate mail, rather than
actively discarding all suspected spammers.
As an application of these measurements, we now con-
sider the mail-server overload problem described in the
introduction.
In this section, we demonstrate how the
problem could be tackled with a reputation-based mech-
anism that exploits these differences in behaviour.
In
Sec. 4.1, we explain the mail-server overload problem
in more detail.
In Sec. 4.2, we explain our approach,
describing the mail server simulation and algorithms that
we use, and in Sec. 4.3, we present an evaluation showing
the performance improvement gained using these differ-
ences in behaviour.
We emphasize that this simulation study is intended
to demonstrate the potential of using these behavioural
differences in the legitimate mail and spam for prioritiz-
ing exclusively by IP addresses. However, it is not in-
tended to be comparable to content-based spam ﬁltering.
We also note that these differences in behaviour could be
applied in other ways as well and at other points in the
mail processing as well. The quantitative beneﬁts that
we achieve may be speciﬁc to our application and may
be different in other applications.
4.1 Server Overload Problem
The problem we consider is the following: When the
mail server receives more SMTP connections than it can
process in a time interval, how can it selectively accept
connections to maximize the acceptance of legitimate
mail? That is, the mail server receives a sequence of
connection requests from IP addresses every second, and
each connection will send mail that is either legitimate or
spam. Whether the IP address sends spam or legitimate
mail in that connection is not known at the time of the
request, but is known after mail is processed by the spam
ﬁlter. The mail server has a ﬁnite capacity of the number
of mails that can be processed in each time interval, and
may choose the connections it accepts or rejects. The
goal of the mail server is to selectively accept connec-
tions in order to maximize the legitimate mail accepted.
We note that spammers have strong incentive to cause
mail servers to overload, and illustrate this with an exam-
ple. Assume that a mail server can process 100 emails
per second, that it will start dropping new incoming
SMTP connections when its load reaches 100 emails per
second, and that it crashes if the offered load reaches 200
emails per second. Assume also that 20 legitimate emails
are received per second. A spammer could increase the
load of the mail server to 100% by sending 80 emails per
second which would be all received by the mail server.
Alternatively, the spammer could also increase the load
to 199%, by sending 179 spam emails per second, and
now nearly half the requests would not be served. If the
mail server is unable to distinguish between the spam re-
quests and the legitimate mail requests, it drops connec-
tions at random, and the spammer will be able to suc-
cessfully get through 89 spam emails per second to the
mail server, as compared to the 80 in the previous case.
Thus, the optimal operation point of a spammer, as-
suming that he has a large potential sending capacity, is
not the maximum capacity of the mail server but the max-
imum load before the mail server will crash. This obser-
vation indicates that the approach of throwing more re-
sources at the problem would only work if the mail server
capacity is increased to exceed the largest botnet avail-
able to the spammer. This is typically not economically
feasible and a different approach is needed.
The results in Sec. 2 and Sec. 3 suggest that there
may be a history-based reputation function R, that re-
lates IP addresses to their likelihood of sending spam.
Thus, for example, if R(i) is the probability that an IP ad-
dress i sends legitimate mail, then maximizing the quan-
tity P R(i) would maximize the expected number of ac-
cepted legitimate mail. If the reputation function R were
known, this problem would be similar to admission con-
trol and deadline scheduling; however, in our case, R is
not known.
In this work, we choose one simple history-based rep-
utation function and demonstrate that it performs well.
We reiterate that our goal is not to explore the space
of the reputation functions or to ﬁnd the best reputation
function. Rather, our goal is to demonstrate that they
could potentially be used to increase the legitimate mail
accepted when the mail-server is overloaded. In addition,
our goal is to preferentially accept e-mails from certain
IP addresses only when the mail servers are overloaded
USENIX Association
16th USENIX Security Symposium
159
– we would like to minimize the impact on mail servers
when they are not overloaded. A poor choice of R will
then not impact the mail server under normal operation.
The techniques and the reputation functions that we
choose address concerns that are different from those
addressed by standard IP-based classiﬁcation techniques
like blacklisting and greylisting, as neither blacklisting
nor greylisting would directly solve the server overload
problem. Blacklisting has well-known issues: building
a blacklist takes time and effort, most IP addresses that
send spam are observed to be ephemeral, appearing very
few times, and many of them are not even present in any
single blacklist.
While greylisting is an attractive short-term solution
that has been observed to work quite well in practice, it
is not robust to spammer evasion, since spammers could
simply mimick the behaviour of a normal mail server.
Greylisting aims to optimize a different goal – its goal
is to delay the mail in the hope that a spam signature
is generated in the mean time, so that spam can be dis-
tinguished from non-spam; however, delaying the mail
does not reduce the overall server load, since the spam-
mer can always return to send more mail, and comput-
ing a content-based spam signature would continue to be
as expensive. Indeed, greylisting gives spammers even
more incentive to overload mail servers by re-trying af-
ter a speciﬁed time period.
Our techniques for the server overload problem pro-
vide an additional layer of information when compared
to blacklisting and greylisting. It may be possible to use
the IP structure information to enhance greylisting, to
decide, at ﬁner granularities and with soft thresholding,
which IP addresses to deny.
4.2 Design and Algorithms