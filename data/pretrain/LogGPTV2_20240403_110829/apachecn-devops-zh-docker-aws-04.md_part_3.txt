}
```
Introspecting the ECS Agent
请注意，ECS 代理监听端口 51678，并提供三个您可以查询的端点:
*   `/v1/metadata`:描述容器实例加入的集群、容器实例**亚马逊资源名称** ( **ARN** )以及 ECS 代理版本
*   `/v1/tasks`:返回当前正在运行的任务列表。目前我们还没有向集群部署任何 ECS 服务或任务，因此这个列表是空的
*   `/license`:提供申请 ECS 代理软件的各种软件许可证
`/v1/metadata`端点特别有用，因为您可以使用该端点来确定 ECS 代理是否已成功加入给定的 ECS 集群。稍后，我们将在[第 6 章](06.html)、*构建自定义 ECS* *容器实例*中使用它来执行实例创建的运行状况检查，以确保我们的实例已成功加入正确的 ECS 集群。
# ECS 容器实例日志
每个 ECS 容器实例都包含有助于对实例进行故障排除的日志文件。
您将使用的主要日志包括以下内容:
*   Docker 引擎日志:位于`/var/log/docker`
*   ECS 代理日志:位于`/var/log/ecs`
请注意，有两种类型的 ECS 代理日志:
*   初始化日志:位于`/var/log/ecs/ecs-init.log`，这些日志提供与`ecs-init`服务相关的输出，该服务是一个确保 ECS 代理在容器实例启动时运行的新贵服务。
*   代理日志:位于`/var/log/ecs/ecs-agent.log.*`，这些日志提供与 ECS 代理操作相关的输出。这些日志是您将针对任何 ECS 代理相关问题检查的最常见日志。
# 创建 ECS 任务定义
现在，您已经设置了您的 ECS 集群并了解了 ECS 容器实例如何向集群注册，现在是时候配置 ECS 任务定义了，它定义了您想要为应用部署的容器的配置。ECS 任务定义可以定义一个或多个容器，以及容器可能需要读取或写入的其他元素，如卷。
为了简单起见，我们将创建一个非常基本的任务定义，运行官方的 Nginx Docker 映像，该映像在[https://hub.docker.com/_/nginx/](https://hub.docker.com/_/nginx/)发布。Nginx 是一个流行的网络服务器，默认情况下，它将提供一个欢迎使用 Nginx 的页面，目前这足以代表一个简单的网络应用。
现在，让我们通过执行以下步骤为简单的 web 应用创建一个 ECS 任务定义:
1.  导航至**服务** | **弹性容器服务**处的 ECS 控制台。您可以通过从左侧菜单中选择**任务定义**并单击**创建新任务定义**按钮来创建新任务定义。
2.  在**选择启动类型兼容性**屏幕中，选择 **EC2 启动类型**，它将根据您拥有和管理的基础架构配置要在 ECS 集群上启动的任务定义。
3.  在**配置任务和容器定义**画面中，配置**简单网页**的**任务定义名称**，然后向下滚动点击**添加容器**添加新的容器定义。
4.  在**添加容器**画面中，配置以下设置，完成后点击**添加按钮**创建容器定义。该容器定义将把 ECS 容器主机上的端口 80 映射到容器中的端口`80`，允许从外部世界访问 Nginx web 服务器:
    *   **容器名称** : nginx
    *   **影像**:engine
    *   **内存限制** : `250`兆字节硬限制
    *   **端口映射**:主机端口`80`，容器端口`80`，协议 tcp:
![](img/0b9e9538-9656-4d04-a83d-a988536410bf.png)
Creating a Container Definition
5.  单击**配置任务和容器定义**页面底部的**创建**按钮，完成任务定义的创建。
# 创建 ECS 服务
我们已经创建了一个 ECS 集群，并配置了一个 ECS 任务定义，其中包括一个运行 Nginx 的单个容器，该容器具有适当的端口映射配置，以向外部世界公开 Nginx web 服务器。
我们现在需要定义一个 ECS 服务，该服务将配置 ECS 以将我们的 ECS 任务定义的一个或多个实例部署到我们的 ECS 集群。ECS 服务将给定的 ECS 任务定义部署到给定的 ECS 集群，允许您配置希望运行多少引用的 ECS 任务定义的实例(ECS 任务)，并控制更高级的功能，如负载平衡器集成和应用的滚动更新。
要创建新的 ECS 服务，请完成以下步骤:
1.  在 ECS 控制台中，从左侧选择集群，然后单击您在本章前面创建的**测试集群**:
![](img/ee85b80b-d440-4a73-bbd4-fa331767d863.png)
Selecting an ECS Cluster to Create an ECS Service
2.  在集群详细信息页面，选择**服务**选项卡，点击**创建**创建新服务。
3.  在配置服务屏幕上，配置以下设置，完成后点击**下一步** **步骤**按钮。请注意，我们引用了本章前面创建的任务定义和 ECS 集群:
    *   **发射类型** : EC2
    *   **任务定义**:简单-网页:1
    *   **集群**:测试集群
    *   **服务名称**:简单网页
    *   **任务数** : 1
4.  ECS 服务配置设置的其余部分是可选的。继续点击**下一步**直到您到达**查看**屏幕，在此您可以查看您的设置并点击**创建服务**以完成 ECS 服务的创建。
5.  现在将出现**启动状态**屏幕，一旦创建了您的服务，点击**查看服务**按钮。
6.  现在，您的新 ECS 服务将出现“服务详细信息”屏幕，您将看到一个处于 RUNNING 状态的 ECS 任务，这意味着与简单 web ECS 任务定义相关联的 Nginx 容器已成功启动:
![](img/7ff62653-1a1e-4dc7-9f44-848fcebca51c.png)
Completing Creation of a New ECS Service
在这一阶段，您现在应该能够浏览到新部署的 Nginx web 服务器，您可以通过浏览到之前作为 ECS 集群的一部分创建的 ECS 容器实例的公共 IP 地址来验证这一点。如果一切按预期进行，应该会出现默认的**欢迎来到 nginx** 页面，如下图截图所示:
![](img/7863bcb9-dbb8-42c2-8481-c43e191fa316.png)
Browsing to the Nginx Web Server
# 部署 ECS 服务
现在您已经成功创建了一个 ECS 服务，让我们来看看 ECS 如何管理容器应用的新部署。重要的是要理解 ECS 任务定义是不可变的——也就是说，一旦创建了任务定义，您就不能修改它，相反，您需要要么创建一个全新的任务定义，要么创建当前任务定义的*修订版*，您可以将其视为给定任务定义的新版本。
ECS 将 ECS 任务定义的逻辑名称定义为*族*，ECS 任务定义的给定修订版以*族* : *修订版—* 的形式表示，例如，`my-task-definition:3`指的是 *my-task-definition* 族的修订版 3。
这意味着为了部署容器应用的新版本，您需要执行几个步骤:
1.  使用为新版本应用更改的配置设置，创建新版本的 ECS 任务定义。这通常只是与您为应用构建的 Docker 映像相关联的映像标签，但是任何配置更改，例如分配的内存或 CPU 资源的更改，都将导致创建 ECS 任务定义的新版本。
2.  更新您的 ECS 服务以使用 ECS 任务定义的新版本。每当您以这种方式更新 ECS 服务时，ECS 将自动执行应用的滚动更新，尝试根据新的 ECS 任务定义版本，用新的容器优雅地替换构成 ECS 服务的每个运行容器。
为了演示这种行为，现在让我们修改您在本章前面创建的 ECS 任务定义，并通过执行以下步骤更新 ECS 服务:
1.  在 ECS 控制台中，从左侧选择**任务定义**，并点击您之前创建的**简单网络**任务定义。
2.  请注意，任务定义当前只有一个版本，版本号位于任务定义名称后面的冒号后面。例如**简单网络:1** 指的是简单网络任务定义的修订版 1。选择当前任务定义版本，然后点击**新建版本**在现有任务定义版本的基础上新建一个版本。
3.  显示**创建任务定义的新版本**屏幕，与您之前配置的**创建新任务定义**屏幕非常相似。向下滚动至**容器定义**部分，点击 Nginx 容器修改 Nginx 容器定义。
4.  我们将对任务定义进行的更改是将端口映射从端口 80 的当前静态主机映射修改为主机上的动态端口映射。这可以通过将主机端口设置留空来实现，在这种情况下，Docker 引擎将从底层 ECS 容器实例上的临时端口范围中分配一个动态端口。对于我们正在使用的亚马逊 Linux AMI，这个端口范围在`32768`和`60999`之间。动态端口映射的好处是，我们可以在同一台主机上运行我们的容器的多个实例——如果静态端口映射到位，则只能启动一个容器，因为后续的容器将尝试绑定到已经在使用的端口`80`。完成配置更改后，点击**更新**按钮继续。
5.  点击**新建任务定义**界面下方的【创建】按钮，完成新建任务定义。
To obtain the ephemeral port range used by Docker, you can inspect the contents of the `/proc/sys/net/ipv4/ip_local_port_range` file. If this file is not available on your operating system, Docker will use the port range of `49153` through `65535`.
此时，已经根据您的 ECS 任务定义创建了一个新版本(版本 2)。现在，您需要通过完成以下步骤来更新您的 ECS 服务，以使用新的任务定义修订版:
1.  在 ECS 控制台中，从左侧选择**集群**，并选择您的测试集群。在服务选项卡上，选择您的 ECS 服务旁边的复选框，然后单击**更新**按钮。
2.  在“配置服务”屏幕上的“任务定义”下拉列表中，您应该能够选择刚刚创建的任务定义的新版本(简单网络:2)。一旦完成，继续点击**下一步**按钮，直到您到达审查屏幕，此时您可以点击**更新服务**按钮来完成您的配置更改:
![](img/2aa14d89-5a38-4204-b619-236a6a61a153.png)
Modifying ECS Service Task Definition
3.  与您之前创建 ECS 服务时看到的类似，将显示“启动状态”屏幕。如果您点击**查看服务**按钮，您将进入 ECS 服务详细信息屏幕，如果您选择部署选项卡，您将看到正在部署的任务定义的新版本:
![](img/6fe12f0d-5fdd-48bd-8677-ed4aa6755052.png)
ECS Service Deployment
请注意，有两个部署—活动部署显示了现有的 ECS 服务部署，并指示当前有一个正在运行的容器。PRIMARY 部署显示了基于新版本的新 ECS 服务部署，并指示所需的计数为 1，但请注意运行计数尚未达到 1。
如果定期刷新部署状态，则可以在部署新任务定义修订时观察各种状态更改:
The deployment changes will be performed reasonably quickly, so if you don't see any of these changes, you can always update the ECS service to use the first revision of the ECS task definition to force a new deployment.
1.  PRIMARY 部署应该指示挂起计数为 1，这意味着容器的新版本即将启动。
![](img/7686c6f8-bd4d-4904-bf65-0fd0382085d4.png)