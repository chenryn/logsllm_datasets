+add
·x25SaF)
图 13-11Segger J-Link 与 GDB 交互的截屏
除了最为流行的J-Link调试器，还有一些其他的工业级调试器，比如非常先进的Lauterbach
产品，自称支持的设备数量最多。Lauterbach的调试器确实相当不错，但是价格过高。
● OpenOCD
另一个经常被提起的JTAG方案是OpenOCD，它是“开放式片内调试器”的缩写。之前介
绍的商业工具将所有需要的软件和硬件打包在一起，拿到后就可以立即开始与设备上的JTAG协
同工作。与此不同的是，OpenOCD 仅仅是一份开源的软件，其目的是支持各类JTAG 适配器和
目标设备，让用户可以通过一个标准的GDB调试器界面（或者其他与GDB服务端兼容的任何界
面）来操作适配器并进行调试
回忆一下之前的内容，JTAG适配器本身会负责处理所有来往于芯片的信号，翻译它们并通
过USB、串口或者并口连接将其传递给PC。接下来，需要有一款软件通过电线线路协议来理解
13
---
## Page 356
340第13章硬件层的攻击
和解析协议，并将数据翻译成调试器所能理解的形式。OpenOCD就是这样一款软件。在商业方
案中，这种软件一般与适配器硬件打包在一起销售。
面OpenOCD则通常和不包含软件的JTAG适配器一起使用，例如Olimex的适配器、
FlySwatter、Wiggler甚至Bus Pirate（13.3.2节会进一步介绍）。OpenOCD还能和一些商业适配器
配套使用，例如 SeggerJ-Link。
如果已经知道了调试目标的引脚分布，所用的JTAG适配器也支持，接线也准确可靠，并且
针对这些情况配置好了OpenOCD，接下来使用OpenOCD会非常容易。可以通过apt-get等软件
下载器下载并安装，然后通过命令行启动，如下所示：
0pen 0nChip Debugger 0.5.0dev-00141g33e5dd1 (2010040211:14)
[87ephen8xip ~]$ openocd
Licensed under GNU GPL v2
For bug reports, read
http://openocd.ber1ios. de/doc/doxygen/bugs.htm1
Yarn : omap3530.dsp: huge IR 1ength 38
RCLK - adaptive
RCLK - adaptive
Info : RCLK (adaptive clock speed) not supported - fallback to 1000 kHz
trst_only separate trst_push_pul1
Info : JTAG tap: omap3530.jrc tap/device found: Ox0b7ae02f (mfg: 0x017,
part: 0xb7ae, ver: 0x0)
Info : JTAG tap: omap3530.dap enabled
Info : omap3530.cpu: hardvare has 6 breakpoints, 2 watchpoints
本章将跳过一些配置步骤，包括创建或修改主配置文件openocd.cfg以及界面、板和调试目
标特定的配置文件等。OpenOCD的很多问题就隐藏在这些细节之中。最后，当OpenOCD成功
运行时，可以通过telnet连接到它，然后得到一个命令行界面：
Conneeted to localhost.
Prying 127.0.0.1...
Open On-Chip Debugger
Escape character is '^]'.
连上OpenOCD以后，可以输人help命令来获得帮助信息：
> belp
bp
1ist or set breakpoint [  [hw]]
cpu
uaaoo e pue suotedo sabaea qno siutad - cewets
adjust debug level 
on CPU vhich matches name
debug_1eve1
drscan
execute DR scan   
dunp_image   
  -..
dump_image
exit
exit telnet session
fast
fast  - place at beginning of
config files. Sets defaults to fast and dangerous.
fast_load
loads active fast load image to current target -
mainly for profiling purposes
---
## Page 357
13.1设备的硬件接口
341
fast_load_inage
same args as load_image, image stored in nenory -
 - print full path to file according to
mainly for profiling purposes
find
Open0CD search rules
flush_count
flushed
returns nunber of times the JTAG queue has been
ft2232_device_desc
the USB device deseription of the FTDI PT2232
ft2232_1atency
set the PT2232 latency timer to a new value
device
ft2232_1ayout
the 1ayout of the Pr2232 GPI0 signals used to
ft2232_serial
the serial nunber of the PTDI FT2232 device
control output-enables and reset signals
ft2232_vid_pid
the vendor ID and product ID of the FTDI FT2232
hard/soft/disable - force breakpoint type for gdb
device
gdb_breakpoint_override
gdb_detach
resume/reset/halt/nothing - specify behavior when
'break' commands.
GDB detaches from the target
gdb_flash_program
enable or disable flash program
gdb_nemory_nap
enable or disable memory map
gdb_port
daemon configuration command gdb_port
gdb_report_data_abort
enable or disable reporting data aborts
ha1t
halt target
help
Initializes target and servers - nop on subsequent
Tcl implementation of belp command
init
interface
try to configure interface
invocations
interface_list
execute IR scan   [dev2] [instr2]
list all built-in interfaces
irscan
这个界面与J-Link的命令界面非常类似。
在试图将JTAG适配器与一款商业设备相连时，通常不清楚后者的JTAG引脚分布和引脚标
签，也不知道其TAG接口是否已经打开。因此，在一个未知的或商业化的被调试目标上使用
OpenOCD，可能会面对下面这些问题，从而遭遇挫折。
口在这个目标设备上，JTAG是启用的吗？
口引脚分布情况是怎样的？（换句话说，TDI、TDO、TCK、TRST和TMS引脚在哪里？）
口已经知道了目标的正确引脚分布之后，怎么确定连接的跳线和连接器工作正常？
口OpenOCD正在通过正确的适配器驱动程序与适配器交互吗？
口OpenOCD正在通过正确的接口传输正确地解析目标设备的电线线路协议吗？
口这台设备的型号代码与OpenOCD支持的某个设备非常类似但又不完全相同，这种情况下
它能正常工作吗？
由于以上原因，使用一款商业的JTAG软件（比如 Segger的产品）并搭配一个明确支持的适
配器可以避免时间损耗和提心吊胆。由于商业的JTAG方案包含了所有用于支持的软件，整个过
程会变得非常顺利。如果确定使用或者不得不使用OpenOCD，最好事先取得一套需调试芯片的
评估套件。
---
## Page 358
342
第13章硬件层的攻击
·评估套件
评估套件主要用于工程师和设计师为其系统寻找合适的产品选型并进行评估。制造商会对几
乎每一款商业级处理器和控制器提供评估套件，这些套件通常非常便宜，从免费到300美元不等
（许多在100美元左右）。事实上，制造商必须确保那些可能使用它们处理器的人能廉价面便捷地
获得这些评估套件
许多制造商甚至会提供设计参考文件，包括评估套件本身的Gerber文件（3D模型和接线规
范）以及物料清单（BillOfMaterials，BOM）。这样，嵌人式工程师就可以更快地制造出产品原
型，而不需要围绕处理器从头开始构建一整块PCB板。因此，这个评估套件对逆向工程师和漏
洞研究者也极为有用。图13-12就是STMicro的ARM开发套件。
图 13-12STMicro 的 ARM开发套件
对于逆向工程师来说，评估套件的主要作用在于对调试器的支持。评估板包含了开发者用于
调试、编程以及与处理器打交道所需的一切，还可能包含处理器中安全特性的规格说明，制造商
也许会将这些安全特性用于保护其产品。
这类评估套件可以被用作一种可控环境，来测试调试配置以及像OpenOCD这样的软件。基
于这种可控环境，就可以在理想条件下排除前面提到的一些调试设置问题。之后，在面对真实
的最终产品时，如果接线是正确的、设备的JTAG也启用了，那么调试器配置就应该可以正常工
作了。
3.最终连接
使用可编程接头或手工接线将调试器硬件与要调试的目标芯片连接好以后，调试器软件就会
提示调试器已经成功与目标相连。如果用的是SeggerJ-Link，就可以即刻开始用GDB调试目标
---
## Page 359
13.1设备的硬件接口
了，如图13-13所示。
H_VEO4dL3LnkG
ntaed
vith the fello
sestlon1
start:
araet l
8e(Bwta = 8x2
图13-13用J-Link调试STM32ARM开发套件
13.1.4寻找调试接口
现在，我们已经了解了各类常见的接口及其工作原理，但是真正遇到这些接口时，还要知道
接下来应该做些什么。如何确定每个引脚的用途？如何将这些引脚与工具相连？事实上，有许多
技巧和工具可以用来判断这些协议和格式。
本节将列举一些简单的工具，用来识别前面介绍的接口（JTAG、IC、SPI和UART等）；下
一节则进一步讨论如何用这些工具与之建立连接。
1.使用逻辑分析仪
要判断一根引脚的用途，最有用的工具也许是一台逻辑分析仪。对搞软件的人来说，这个
名字相当吓人，但它其实非常简单：显示这根引脚上正在发生什么。用一根探针将引脚连到逻
辑分析仪以后，如果数据从该引脚经过，它就会显示一系列数据波，还可能尝试用不同的滤波
器来解码。
传统的逻辑分析仪有一点复杂，但是新一代产品通过与计算机中的软件相连，去掉了设备中
原本难以理解的特性。这种逻辑分析仪在硬件上没有用户界面，用户完全通过计算机中友好直观
的软件客户端来控制。图13-14所示的Saleae逻辑分析仪就是这样一种设备。
13
---
## Page 360
344
第13章硬件层的攻击