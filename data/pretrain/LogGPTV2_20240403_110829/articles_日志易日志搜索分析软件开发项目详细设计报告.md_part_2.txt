|            | > *\"appname\" : \"apache\",*                           |
|            | >                                                       |
|            | > *\"tag\" : \"\[\\\"baimi\\\"\]\",*                    |
|            | >                                                       |
|            | > *\"agent_send_timestamp\" : 1474191233896,*           |
|            | >                                                       |
|            | > *\"context_id\" : 1490439660016746500,*               |
|            | >                                                       |
|            | > *\"raw_message\" : \"raw_log_message\",*              |
|            | >                                                       |
|            | > *\"tokens\" : \"\[\\\"124.128.122.60\\\", \\\"18\\\", |
|            | > \\\"sep\\\", \\\"2016\\\"\]\"*                        |
|            | >                                                       |
|            | > *} \]*                                                |
|            | >                                                       |
|            | > *}*                                                   |
|            | >                                                       |
|            | > *},*                                                  |
|            | >                                                       |
|            | > *\"error\" : \"错误信息xxx\",*                        |
|            | >                                                       |
|            | > *\"typ\" : \"string\",*                               |
|            | >                                                       |
|            | > *\"progress\" : \"15\",*                              |
|            | >                                                       |
|            | > *\"job_status\" : \"RUNNING\",*                       |
|            | >                                                       |
|            | > *\"parse\" : false*                                   |
|            | >                                                       |
|            | > *}*                                                   |
+------------+---------------------------------------------------------+
| 数据结构   | 1.  搜索的架构                                          |
|            |                                                         |
| 与算法     | > ![](media/image3.png){width="3.48125in"               |
|            | > height="2.828472222222222in"}                         |
|            |                                                         |
|            | 2、分布式的搜索引擎具有                                 |
|            | 高可靠性和高性能。支持时间文本索引和全文检索，提供丰富  |
|            | 的api用于索引、检索、修改大多数配置。能够快速搜索数百亿 |
|            | 的日志以及TB级的数据，结构化或者非结构化的数据都可以。  |
|            |                                                         |
|            | 自动创建索引，通过配                                    |
|            | 置我们可以非常方便的调整索引分片和索引副本。通过索引分  |
|            | 片技术，一个大的索引被拆分成多个，然后分布在不同的节点  |
|            | 上，以构成分布式搜索。索引副本的作用一是提供系统的容错  |
|            | 性，当摸个节点摸个分片损毁或丢失时，可以从副本中恢复；  |
|            | 二是提供查询效率，集群内部会自动实现搜索请求的负载均衡  |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
# 5.web系统的详细设计
## 5.1 web系统模块
+------------+---------------------------------------------------------+
| 模块名称   | *Web系统模块*                                           |
+------------+---------------------------------------------------------+
| 功能描述   | 进行日志展现、数据可视化                                |
|            | ，支持各种统计功能及图表展现，实现流畅的图形用户交互。  |
+------------+---------------------------------------------------------+
| 接口与属性 |                                                         |
+------------+---------------------------------------------------------+
| 数据结构   | 1.  采用多机的部署方案来达到高可用性                    |
|            |                                                         |
| 与算法     | 2.  通过负载均衡来分发请求到不同的机器                  |
|            |                                                         |
|            | 3.  通过api与搜索系统进行数据获取进行展现               |
|            |                                                         |
|            | ![](media/image4.png){width="3.915277777777778in"       |
|            | height="2.9694444444444446in"}                          |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
# 6. 采集子系统的详细设计
## 6.1 Syslog接入模块
+---+-------------------------------------------------------------------+
| 模 | *Syslog接入模块*                                                 |
| 块 |                                                                  |
| 名 |                                                                  |
| 称 |                                                                  |
+---+-------------------------------------------------------------------+
| * | *接入Syslog日志*                                                  |
| 功 |                                                                  |
| 能 |                                                                  |
| 描 |                                                                  |
| 述 |                                                                  |
| * |                                                                   |
+---+-------------------------------------------------------------------+
| 接 | *查询Syslog配置*                                                 |
| 口 |                                                                  |
| 与 | *请求：act=get_agent_config\                                     |
| 属 | 应答：{\"result\":true, \"error\":\"\",*                         |
| 性 |                                                                  |
|   | *\"other_conf\" : \[ {\"type\" : \"UdpInput\",*                   |
|   |                                                                   |
|   | *\"addr\" : \":514\",*                                            |
|   |                                                                   |
|   | *\"mappings\" : \"192.168.1.1:app:tag\"} \]}*                     |
|   |                                                                   |
|   | *新增Syslog配置*                                                  |
|   |                                                                   |
|   | *请求:                                                            |
|   | act=add_a                                                         |
|   | gent_config&type=UdpInput&addr=:514&mappings=192.168.1.1:app:tag* |
|   |                                                                   |
|   | *应答: {\"result\":true, \"error\":\"\"}*                         |
|   |                                                                   |
|   | *修改Syslog配置*                                                  |
|   |                                                                   |
|   | *请求:*                                                           |
|   |                                                                   |
|   | *act=modify_a                                                     |
|   | gent_config&type=UdpInput&addr=:514&mappings=192.168.1.1:app:tag* |
|   |                                                                   |
|   | *应答: {\"result\":true, \"error\":\"\"}*                         |
|   |                                                                   |
|   | *删除Syslog配置*                                                  |
|   |                                                                   |
|   | *请求：act=delete_agent_config&type=UdpInput&addr=:514*           |
|   |                                                                   |
|   | *应答: {\"result\":true, \"error\":\"\"}*                         |
+---+-------------------------------------------------------------------+
| 数 | *采用Http协议提供接口给前台，配置文件以toml格式保存*             |
| 据 |                                                                  |
| 结 |                                                                  |
| 构 |                                                                  |
|   |                                                                   |
| 与 |                                                                  |
| 算 |                                                                  |
| 法 |                                                                  |
+---+-------------------------------------------------------------------+
| 补 |                                                                  |
| 充 |                                                                  |
| 说 |                                                                  |
| 明 |                                                                  |
+---+-------------------------------------------------------------------+
## 6.2 文件目录导入模块
+------------+---------------------------------------------------------+
| 模块名称   | *文件目录导入模块*                                      |
+------------+---------------------------------------------------------+
| 功能描述   | **可以通过Web界                                         |
|            | 面选择要监听采集的文件和目录，并在导入过程中预览导入效  |
|            | 果，从而更加便捷的对文件目录日志采集进行配置和管理。**  |
+------------+---------------------------------------------------------+
| 接口与属性 | 查询目录                                                |
|            |                                                         |
|            | 请求： /ls                                              |
|            |                                                         |
|            | {\"root_dir\":\"/var\"}                                 |
|            |                                                         |
|            | 应答：{\"result\":true,                                 |
|            |                                                         |
|            | \"reason\":\"Success\",                                 |
|            |                                                         |
|            | \"dirs\":\[\"log\"\],                                   |
|            |                                                         |
|            | \"files\":\[\"messages\", \"messages1\"\]               |
|            |                                                         |
|            | > }                                                     |
|            |                                                         |
|            | 预览黑白名单结果                                        |
|            |                                                         |
|            | 请求：/previewMatchFiles                                |
|            |                                                         |
|            | {\"path\":\"/var/log\", \"white_list\":\"\\.log\",      |
|            | \"balck_list\":\"\",                                    |
|            |                                                         |
|            | \"oldest_duration\":\"24h\",\"limit\":100}              |
|            |                                                         |
|            | 应答:{\"result\":true,                                  |
|            |                                                         |
|            | \"reason\":\"Success\",                                 |
|            |                                                         |
|            | \"files\":\[\"/var/log/1.log\", \"/var/log/2.log\"\]}   |
|            |                                                         |
|            | 预览分行效果                                            |
|            |                                                         |
|            | 请求:/previewSplitResult                                |
|            |                                                         |
|            | {\"path\":\"/var/log/messages\",                        |
|            |                                                         |
|            | \"split_regex\":\"\\n(\\d)\",                           |
|            |                                                         |
|            | \"charset\":\"utf-8\"}                                  |
|            |                                                         |
|            | 应答:{\"result\":true,                                  |
|            |                                                         |
|            | \"reason\":\"Success\",                                 |
|            |                                                         |
|            | \"events\":\[\"2014-01-01 00:00:00 hello world\",       |
|            | \"2014-01-01 00:01:01 goodbye world\"\]}                |
+------------+---------------------------------------------------------+
| 数据结构   | *采用Http协议提供接口给前台，配置文件以toml格式保存*    |
|            |                                                         |
| 与算法     |                                                         |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
## 6.3 日志脚本导入模块
+------------+---------------------------------------------------------+
| 模块名称   | *日志脚本导入模块*                                      |
+------------+---------------------------------------------------------+
| 功能描述   | 通过前                                                  |
|            | 台配置让Agent定期执行脚本，并将脚本输出作为日志采集上报 |
+------------+---------------------------------------------------------+
| 接口与属性 | *                                                       |
|            | *类Syslog的增删改查，只是json结构略有区别，格式如下：** |
|            |                                                         |
|            | {\"type\":\"ProcessInput\",                             |
|            |                                                         |
|            | \"bin\":\"/bin/ls\",                                    |
|            |                                                         |
|            | \"args\":\[\"/var/log\"\],                              |
|            |                                                         |
|            | \"ticker_interval\":60,                                 |
|            |                                                         |
|            | \"appname\":\"ls_process_input\",                       |
|            |                                                         |
|            | \"tag\":\"ls\",                                         |
|            |                                                         |
|            | \"charset\":\"utf-8\"}                                  |
+------------+---------------------------------------------------------+
| 数据结构   | *采用Http协议提供接口给前台，配置文件以toml格式保存*    |
|            |                                                         |
| 与算法     |                                                         |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
## 6.4 Windows Eventlog导入模块
+------------+---------------------------------------------------------+
| 模块名称   | *WindowsEventlog导入模块*                               |
+------------+---------------------------------------------------------+
| 功能描述   | 配置及管理Windows Eventlog的采集                        |
+------------+---------------------------------------------------------+
| 接口与属性 | 类Syslog的增删改查，只是json结构略有区别，格式如下：    |
|            |                                                         |
|            | ｛\"type\":\"EventlogInput\",                           |
|            |                                                         |
|            | \"filter_stmt\":\"LogFile = \'Security\'\",             |
|            |                                                         |
|            | \"appname\":\"eventlog\",                               |
|            |                                                         |
|            | \"tag\":\"security\"                                    |
|            |                                                         |
|            | }                                                       |
+------------+---------------------------------------------------------+
| 数据结构   | *采用Http协议提供接口给前台，配置文件以toml格式保存*    |
|            |                                                         |
| 与算法     |                                                         |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
## 6.5服务器性能数据导入模块
+------------+---------------------------------------------------------+
| 模块名称   | *服务器性能数据导入模块*                                |
+------------+---------------------------------------------------------+
| 功能描述   | 配置及管理 服务器性能数据的采集                         |
+------------+---------------------------------------------------------+
| 接口与属性 | 类Syslog的增删改查，只是json结构略有区别，格式如下：    |
|            |                                                         |
|            | {\"type\":\"TopInput\",                                 |
|            |                                                         |
|            | \"appname\":\"top_info\",                               |
|            |                                                         |
|            | \"tag\":\"top_info\"                                    |
|            |                                                         |
|            | \"rescan_interval\":\"300s\",                           |
|            |                                                         |
|            | \"disk\":true,                                          |
|            |                                                         |
|            | \"system\":true,                                        |
|            |                                                         |
|            | \"proc\":false,                                         |
|            |                                                         |
|            | \"procs\":\".\*\",                                      |
|            |                                                         |
|            | \"per_cpu\":false,                                      |
|            |                                                         |
|            | \"per_net\":false,                                      |
|            |                                                         |
|            | }                                                       |
+------------+---------------------------------------------------------+
| 数据结构   | *采用Http协议提供接口给前台，配置文件以toml格式保存*    |
|            |                                                         |
| 与算法     |                                                         |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
## 6.6 数据库数据导入模块
+------------+---------------------------------------------------------+
| 模块名称   | *数据库数据导入模块*                                    |
+------------+---------------------------------------------------------+
| 功能描述   | 支持从Web界面配置Agent采集数据库中的表数据              |
+------------+---------------------------------------------------------+
| 接口与属性 | 查询高级配置接口：                                      |
|            |                                                         |
|            | 请求格式：http_post heka_ip:heka_port/getFullConfig     |
|            |                                                         |
|            | 响应格式: {\"result\":true, \"reason\":\"Success\",     |
|            | \"config\":\"xxxxx\"}                                   |
|            |                                                         |
|            | 修改高级配置接口：                                      |
|            |                                                         |
|            | 请求格式: http_post heka_ip:heka_port/modifyFullConfig  |
|            |                                                         |
|            | ｛"config\":\"xxxx\"}                                   |
|            |                                                         |
|            | 响应格式: {\"result\":true, \"reason\":\"Success\"}     |
|            |                                                         |
|            | 查看修改后重启接口：                                    |
|            |                                                         |
|            | 请求格式:http_post heka_ip:heka_port/queryHekaStatus    |
|            |                                                         |
|            | 响应格式:{\"result\":true, \"reason\":\"Success\",      |
|            | \"error_log\":\"xxx\"}                                  |
|            |                                                         |
|            | reason有三个值:Success(重启成工)                        |
|            | ,Failed(重启失败),Pending(重启中，请等待)，当重启失败时 |
|            | ，error_log里返回这次启动打印的日志，供用户分析失败原因 |
+------------+---------------------------------------------------------+
| 数据结构   | *采用Http协议提供接口给前台，配置文件以toml格式保存*    |
|            |                                                         |
| 与算法     |                                                         |
+------------+---------------------------------------------------------+
| 补充说明   |                                                         |
+------------+---------------------------------------------------------+
# 