ified PSP firmware versions do not contain known security issues.
Migration of an SEV-protected virtual machine to an SEV firmware
version lower than specified in the guest policy will not be permit-
ted. This protects against the Migration Attack presented in Section
5.2.
7 RELATED WORK
Work such as [18, 23, 29, 33, 34, 36] show that protecting virtual ma-
chines from an untrusted hypervisor has been subject to extensive
research.
In [36] Zhang et al. propose the use of a higher-privileged secu-
rity monitor called CloudVisor in order to protect virtual machines
in the face of a compromised hypervisor. In their attack model, they
assume the cloud provider himself not to be malicious and therefore
exclude physical attacks. In their design, that is very similar to the
design of AMD SEV, they aim to separate resource management
from security protection in the virtualization layer. Their proto-
type version of CloudVisor is implemented in only 5.5K lines of
code and works with the Xen hypervisor. Zhang et al. leverage a
Trusted Platform Module (TPM) in two ways: The integrity of the
CloudVisor code is ensured by the TPM and Intel Trusted Execution
Technology (TXT). The second use of a TPM in CloudVisor is to
provide confidential communication between the cloud customer
and CloudVisor. It roots in the Storage Root Key (SRK) of the TPM,
that has the lifetime of the platform owner and is authenticated by
the Endorsement Key (EK) of the TPM. The EK keypair of TPMs
is unique per chip, thus binding the TPM’s identity. Its private
key must therefore never leave the TPM. The manufacturer of the
TPM provides certificates of the EK public key through a certifi-
cate authority (CA). Given that the specific identities of TPMs used
for CloudVisor are guaranteed by a third party, this enables the
cloud customer to also authenticate intermediate keys signed by
the EK. These can then be used for confidential communication.
With AMD SEV, the CEK serves a similar purpose as the EK of a
TPM: It binds the identity of an SEV-capable CPU using chip-unique
one-time-programmable fuses.
While the remote attestation mechanism of SEV has previously
not been subject to research, researchers presented several attacks
against the runtime protection of SEV.
In 2017 Hetzelt and Buhren presented the first security analysis
of the SEV Technology [15]. They proposed three attacks on an
SEV-enabled system, two of which rely on the lack of protection of
the Virtual Machine Control Block (VMCB) and registers. These are
mitigated in case the encrypted state extension to SEV is enabled,
see Section 2.2. The third attack leverages the missing integrity
protection of the guest memory, allowing the hypervisor to conduct
a replay attack. To that end, the nested pagetable was altered to
enforce a pagefault on every guest page that was executed. It was
shown that the sequence of pagefaults is enough to determine
the location of a password in the target VM’s memory. The page
containing the password was then replayed during an attacker
initiated SSH login. Using this primitive, the authors were able to
gain root access to a target system protected by SEV.
Morbitzer et al. leveraged the hypervisor’s control over the guest
resources, namely the nested pagetables, to mount an attack against
an SEV-protected VM [25]. In a similar fashion as [15] they used
page tracking to identify a guest page which is served via a server
running in the VM. As the memory is encrypted with a guest-
specific key, the server will copy the data to an unencrypted page,
e.g., the buffer of a virtual network card. Once this page is located,
they manipulate the nested pagetable to change the mapping be-
tween guest physical pages to host physical pages. The new map-
ping will point to confidential data of the VM. Instead of copying
the intended data, the server will instead copy the confidential data
into the unencrypted buffer. This buffer is then readable by the
attacker. Using this method, the authors were able to fully decrypt
a VM with 2GB of memory.
In 2018, Israeli research firm CTS Labs published a whitepaper
called AMDFlaws claiming to have found multiple critical vulnera-
bilities in AMD processors allowing arbitrary code execution on
the PSP [21]. In the whitepaper, the researchers publish conceptual
information about vulnerabilities in both Epyc and Ryzen PSPs
as well as alleged manufacturer backdoors in both firmware and
hardware of AMD chipsets supporting Ryzen CPUs. In 2019, two
members of CTS Labs presented insights into three vulnerabili-
ties of the AMDFlaws publication [13]. In the presentation, the
researchers illuminate details about the firmware of the PSP and
the cryptographic checks in use. Nonetheless, the researchers did
not discuss the consequences of a compromised PSP to the SEV
technology.
8 CONCLUSION
In this paper, we analyzed the firmware components that imple-
ment the SEV API. We identified security issues in the secure boot
mechanism of the PSP that hosts the SEV firmware. This allowed
us to provide a patched version of the SEV firmware which gives
us arbitrary read and write access to the PSP’s memory. We used
this firmware to extract the Chip Endorsement Key (CEK) of three
different AMD Epyc processors. We proposed two attacks against
SEV-protected virtual machines using the extracted CEK as well
as an attack based on a patched SEV firmware. While the patched
firmware allowed us to extract encrypted memory in plaintext, the
extracted CEK allows an attacker to impersonate the presence of
SEV altogether. Even if the targeted virtual machine is not executed
on a compromised SEV platform, the migration attack allows an
attacker to acquire the cryptographic keys that are used to encrypt
the virtual machines during migration.
The severity of the proposed attacks is amplified due to the miss-
ing rollback prevention as well as the infinite lifetime of the CEK.
We showed that an attacker can always roll back to a vulnerable
PSP firmware to extract the CEK. Even if the PSP firmware is up-
graded to a newer version, this extracted CEK is still valid for the
corresponding CPU.
In the current design of the SEV technology, it is impossible for a
cloud customer to verify the integrity of the remote platform given
the fact that a vulnerable firmware version exists. We conclude that
the SEV technology on AMD Epyc systems of the Naples CPU series
Session 5C: Cloud Security IICCS ’19, November 11–15, 2019, London, United Kingdom1098https:
[18] S. Jin, J. Ahn, S. Cha, and J. Huh. 2011. Architectural support for secure virtualiza-
tion under a vulnerable hypervisor. In 2011 44th Annual IEEE/ACM International
Symposium on Microarchitecture (MICRO). 272–283.
[19] Miltiadis Kandias, Nikos Virvilis, and Dimitris Gritzalis. 2013. The Insider
Threat in Cloud Computing. In Critical Information Infrastructure Security, Sandro
Bologna, Bernhard Hämmerli, Dimitris Gritzalis, and Stephen Wolthusen (Eds.).
Springer Berlin Heidelberg, Berlin, Heidelberg, 93–103.
[20] David Kaplan. 2017.
Protecting VM Register State with SEV-ES.
https://www.amd.com/system/files/TechDocs/Protecting%20VM%20Register%
20State%20with%20SEV-ES.pdf Accessed: 2019-05-06.
[21] CTS Labs. 2018.
Severe Security Advisory on AMD Processors.
//safefirmware.com/amdflaws_whitepaper.pdf Accessed: 2019-05-06.
ccp-dev.h.
[22] Thomas Lendacky and Gary Hook. 2016.
https:
//git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/
ccp/ccp-dev.h?h=v5.0.12#n402 Accessed: 2019-05-04.
[23] Jonathan M. McCune, Bryan Parno, Adrian Perrig, Michael Reiter, and Hi-
roshi Isozaki. 2008. Flicker: an execution infrastructure for TCB minimiza-
tion. EuroSys’08 - Proceedings of the EuroSys 2008 Conference 42, 315–328.
https://doi.org/10.1145/1352592.1352625
[24] Mark Papermaste. 2018.
Initial AMD Technical Assessment of CTS Labs Re-
search. https://community.amd.com/community/amd-corporate/blog/2018/03/
21/initial-amd-technical-assessment-of-cts-labs-research. Accessed: 2019-05-10.
[25] Mathias Morbitzer, Manuel Huber, Julian Horsch, and Sascha Wessel. 2018. SEV-
ered: Subverting AMD’s Virtual Machine Encryption. In Proceedings of the 11th
European Workshop on Systems Security (EuroSec’18). ACM, New York, NY, USA,
Article 1, 6 pages. https://doi.org/10.1145/3193111.3193112
[26] Coreboot Project. 2014.
https://github.com/coreboot/
coreboot/blob/master/src/vendorcode/amd/pi/00660F01/Proc/Psp/PspBaseLib/
PspDirectory.h Accessed: 2019-04-03.
PspDirectory.h.
[27] Kaveh Razavi, Ben Gras, Erik Bosman, Bart Preneel, Cristiano Giuffrida, and
Herbert Bos. 2016. Flip feng shui: Hammering a needle in the software stack. In
25th {USENIX} Security Symposium ({USENIX} Security 16). 1–18.
solutions/SMS_SUM.cfm Accessed: 2019-04-26.
[28] Supermicro. [n. d.]. Supermicro Update Manager. https://www.supermicro.com/
[29] Jakub Szefer and Ruby B. Lee. 2012. Architectural Support for Hypervisor-secure
Virtualization. SIGPLAN Not. 47, 4 (March 2012), 437–450. https://doi.org/10.
1145/2248487.2151022
[30] Rich Uhlig, Gil Neiger, Dion Rodgers, Amy L Santoni, Fernando Martins, An-
drew V Anderson, Steven M Bennett, Alain Kägi, Felix H Leung, and Larry Smith.
2005. Intel virtualization technology. Computer 38, 5 (2005), 48–56.
[31] Stefan Weil. 2019. QEMU version 4.0.93 User Documentation. (2019). https:
//qemu.weilnetz.de/doc/qemu-doc.html#Commands Accessed: 2019-08-01.
(2019).
[32] Christian Werling and Robert Buhren. 2019. PSPTool: Display, extract, and
https://github.com/
manipulate PSP firmware inside UEFI images.
cwerling/psptool Accessed: 2019-08-01.
[33] Y. Wu, Y. Liu, R. Liu, H. Chen, B. Zang, and H. Guan. 2018. Comprehensive VM
Protection Against Untrusted Hypervisor Through Retrofitted AMD Memory
Encryption. In 2018 IEEE International Symposium on High Performance Computer
Architecture (HPCA). 441–453. https://doi.org/10.1109/HPCA.2018.00045
[34] Y. Xia, Y. Liu, and H. Chen. 2013. Architecture support for guest-transparent
VM protection from untrusted hypervisor and physical attacks. In 2013 IEEE 19th
International Symposium on High Performance Computer Architecture (HPCA).
246–257. https://doi.org/10.1109/HPCA.2013.6522323
[35] Yuval Yarom and Katrina Falkner. 2014. FLUSH+ RELOAD: a high resolution,
low noise, L3 cache side-channel attack. In 23rd {USENIX} Security Symposium
({USENIX} Security 14). 719–732.
[36] Fengzhe Zhang, Jin Chen, Haibo Chen, and Binyu Zang. 2011. CloudVisor:
Retrofitting protection of virtual machines in multi-tenant cloud with nested
virtualization. SOSP’11 - Proceedings of the 23rd ACM Symposium on Operating
Systems Principles, 203–216. https://doi.org/10.1145/2043556.2043576
cannot protect virtual machines as the correct deployment cannot
be guaranteed. Given the lifetime of the CEK, it is not possible to
provide purely software-based mitigations.
To overcome the issues of the current SEV technology, we pro-
posed design changes to SEV that enable the cloud customer to
enforce the use of a specific PSP firmware on the remote platform.
This ensures the trustworthiness of the SEV technology despite
PSP firmware issues as it allows to issue software-based fixes for
the PSP firmware.
ACKNOWLEDGMENTS
This work was supported by the Federal Ministry of Education and
Research of Germany in the framework of Software Campus 2.0
project no. FKZ 01IS17052. Opinions, views, and conclusions are
those of the authors and do not reflect the views of anyone else.
We would like to thank the following persons for their help during
the work on this paper: Peter Stuge, Stephan Bauroth, Nils Wisiol,
Elham Amini and Heiko Lohrke.
REFERENCES
[1] AMD. 2005. Secure Virtual Machine Architecture Reference Manual. Whitepaper.
[2] AMD. 2013. AMD Security and Server innovation.
https://members.uefi.
org/learning_center/UEFI_PlugFest_AMD_Security_and_Server_innovation_
AMD_March_2013.pdf Accessed: 2019-04-29.
[3] AMD. 2018. AMD Secure Encrypted Virtualization API Version 0.17. https:
//developer.amd.com/wp-content/resources/55766.PDF Accessed: 2019-08-05.
[4] AMD. 2019. AMD CEK Certificate Server. https://kdsintf.amd.com/cek/ Accessed:
2019-04-16.
[5] AMD. 2019. SEV firmware for Naples. https://developer.amd.com/wp-content/
resources/amd_sev_fam17h_model0xh_0.17b11.zip Accessed: 2019-04-16.
[6] Kaplan AMD and Others. 2016. AMD Memory Encryption.
https:
//developer.amd.com/wordpress/media/2013/12/AMD_Memory_Encryption_
Whitepaper_v7-Public.pdf Accessed: 2019-08-05.
[7] Andrea Arcangeli, Izik Eidus, and Chris Wright. 2009. Increasing memory density
by using KSM. In Proceedings of the linux symposium. Citeseer, 19–28.
[8] Russell Brandom and Colin Lecher. 2018. House passes controversial legislation
giving the US more access to overseas data.
(2018). https://www.theverge.
com/2018/3/22/17131004/cloud-act-congress-omnibus-passed-mlat Accessed:
2019-05-14.
2019.
(2019).
Buhren.
containing
Repository
and results.
supplemental
data
https://github.com/RobertBuhren/
Insecure-Until-Proven-Updated-Analyzing-AMD-SEV-s-Remote-Attestation
Accessed: 2019-08-01.
2013.
modified
Aptio
UEFI
https://www.win-raid.com/
t286f16-Guide-Deprecated-Flashing-modified-AMI-Aptio-UEFI-using-AFU.
html Accessed: 2019-04-18.
Flashing
using
AFU.
AMI
[9] Robert
[10] CodeRush.
[11] Zhao-Hui Du, Zhiwei Ying, Zhenke Ma, Yufei Mai, Phoebe Wang, Jesse Liu, and
Jesse Fang. 2017. Secure Encrypted Virtualization is Unsecure. arXiv:1712.05090
[12] Unified EFI. 2017. Platform Initialization (PI) Specification. https://uefi.org/sites/
default/files/resources/PI_Spec_1_6.pdf Accessed: 2019-05-02.
[13] Uri Farkas and CTS-Labs Ido Li On. 2019. AMDFlaws – A Technical Deep
Dive. https://msrnd-cdn-stor.azureedge.net/bluehat/bluehatil/2019/assets/doc/
The%20AMDFlaws%20Story%20Technical%20Deep%20Dive.pdf Accessed: 2019-
05-06.
[14] Keiko Hashizume, David G. Rosado, Eduardo Fernández-Medina, and Eduardo B.
Fernandez. 2013. An analysis of security issues for cloud computing. Journal of
Internet Services and Applications 4, 1 (27 Feb 2013), 5. https://doi.org/10.1186/
1869-0238-4-5
[15] Felicitas Hetzelt and Robert Buhren. 2017. Security Analysis of Encrypted Vir-
tual Machines. In Proceedings of the 13th ACM SIGPLAN/SIGOPS International
Conference on Virtual Execution Environments (VEE ’17). ACM, New York, NY,
USA, 129–142. https://doi.org/10.1145/3050748.3050763
[16] Intel Security Center. 2019. Intel CSME, Server Platform Services, Trusted Ex-
ecution Engine and Intel® Active Management Technology 2018.4 QSR Ad-
visory. https://www.intel.com/content/www/us/en/security-center/advisory/
intel-sa-00185.html. Accessed: 2019-05-06.
[17] Intel Security Center. 2019. Intel Firmware 2018.4 QSR Advisory. https://www.
intel.com/content/www/us/en/security-center/advisory/intel-sa-00191.html. Ac-
cessed: 2019-05-06.
Session 5C: Cloud Security IICCS ’19, November 11–15, 2019, London, United Kingdom1099