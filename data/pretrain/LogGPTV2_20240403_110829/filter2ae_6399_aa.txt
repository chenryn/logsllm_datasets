# 复盘攻防，再聊安全
##### 译文声明
本文是翻译文章
译文仅供参考，具体内容表达以及含义原文为准。
截止到28日5点，HW行动终于结束，朋友圈感觉是在过年，到处是倒计时和庆祝声。看来防守方们7*24小时的看监控还是比较无奈的。本次复盘基于我对整个护网行动的观察总结而来，仅代表我个人观点，如有不妥之处，欢迎交流。
## 1.整体攻防的思考
本次攻防，从规则到各方实力，都是绝无仅有的。经常有人问，是攻击队厉害还是防守队厉害？经过我这些年的思考，还是没有得出一个确切的结论。有时候觉得攻击队厉害，因为攻击可以在非特定时间随意发起，出其不意攻其不备，甚至手持0day指哪打哪，毕竟木桶原理决定着攻破一处即可内部突袭；有时候又觉得防守方厉害，因为防守方拥有全部访问流量，随时洞察攻击者的探测并封堵IP，也可以在主机层监控攻击者一举一动，甚至部署蜜罐玩弄黑客于鼓掌之中。总之，这么些年的摸爬滚打经验告诉我，攻防就是这样，道高一尺魔高一丈，一如黑客防线中说的“在攻于防的对立统一中寻求突破”。
## 2.从攻击方思考
在真实的攻击行动中，一般一个目标要搞到核心系统根据防御程度不同，也需要1个月到半年的样子，甚至APT要潜伏一到两年才能拿到自己想要的数据。而此次总共给攻击方的时间只有3个周，并且每个队伍据说10多个目标，这也就决定了攻击要快速、要自动化。
### a)分布式扫描器
要说快速，还是得上扫描器，但是一个扫描器速度肯定不行，再者，被发现攻击行为，立马IP被ban掉，后续就无法进行。所以，分布式扫描器在这种情况下一定是个趋势。首先对全部目标的全端口进行一次扫描+端口识别，根据Banner快速收割一波；  
在这个过程中就会有个坑，比如在收集二级域名时，经常采用字典爆破，而防守方会设置一个诱饵二级域名，把流量引入蜜罐之中，坐等上钩。这就需要攻击方们机灵一点，时刻反思这个是不是蜜罐，至于怎么发现蜜罐，以后再聊。  
对于AWVS的扫描器，还得请各位升级到最新版，别被防御方反制，毕竟老版本扫描器自身就存在一个RCE。
### b)菜刀？蚁剑？冰蝎？
对于所有的黑客来说，菜刀肯定是一个传奇，一直是最稳定、最牛逼的webshell管理工具之一，但是同时，菜刀也是一个最容易被发现的攻击工具，毕竟流量特征太明显了，而且一旦发现就100%意味着服务器已沦陷，防守方会里面下线进行深入分析。说起来菜刀好像是11年左右发布的（如有记忆偏差，请指正），还记得当初第一次见到这工具时的感觉，那感觉总结起来就是一句话，“卧槽！牛逼！”。因为在菜刀之前，我们学习的都是先小马后大马的姿势。而用了菜刀之后，我深刻理解了什么大马小马都无所谓，能执行命令搞定目标的都是好马。然后经过了几年的迭代，中国菜刀在国内安全圈也是经历了各种风风雨雨，各种后门版满天飞。最后鉴于其加密性能较弱，陆续出现了几个替代版本，蚁剑就是很优秀的一个项目。讲真，我开发水平相对较弱，见到蚁剑才发现原来js也可以写出优秀的跨平台客户端应用。可是正式由于其nodejs写的，才导致其跟AWVS一样，存在一个本地nodejs解析的RCE，很可能被防御方反制。再之后给我“牛逼”感觉的就是冰蝎了，其双向通信加解密的管理方式，让诸多基于黑名单正则的防御产品厂商直接歇菜。可是很奇怪的时，还是有很多大量攻击方采用菜刀、jspspy之类的原始webshell，结果被防御方轻松发现并清除。
不过说到最后，我有一个疑惑，为何大家非得用webshell这种方式搞服务器呢？比如在存在weblogic反序列化或者Struts2
RCE漏洞时，黑客们写的工具还是一键写入webshell这种。安全发展到今天，防御手段越来越多，各位白帽子是时候改变了。正如我之前说的，不管用什么shell工具，只要能在服务器端执行命令，下面就肯定有更好的解决方案。我一般会使用命令方式加载自己的二进制版远控来操作，现在的二进制远控，不像以前，还得生成exe用菜刀上传，在命令行下执行，现在基本都可以做到类似mshta或者powershell的一句话直接动态上线，并且基于TCP/UDP协议的命令执行、文件管理，一是稳定，二是完全绕过那些基于黑名单的流量分析设备。类似metasploit的脚本payload反弹的meterpreter，但是msf特征明显，也容易被杀，所以我个人估计后面攻防还是会发展到类似cobalt
strike之类的工具对抗上。
### c)水坑&鱼叉
针对水坑或者鱼叉攻击来讲，可以想象到肯定大量的攻击队伍采用这种方法进行攻击，攻击手法多基于邮件进行。现在假想成攻击队伍，我会首先在github上搜索一波，举个例子：[https://github.com/search?q=%224dogs.cn%22+password&type=Code,注意域名要加上双引号进行精准匹配。在翻到一个可登陆的邮箱后，去通信录导出所有联系人方式，进而进行简单的口令爆破；在这些操作还没拿到有用密码的情况下，就可以根据组织结构进行定点攻击了。高级点的用浏览器0day，没0day的也可以直接发宏病毒，注意编个理由加个密发，防止被沙箱抓样本。](https://github.com/search?q=%224dogs.cn%22+password&type=Code,%E6%B3%A8%E6%84%8F%E5%9F%9F%E5%90%8D%E8%A6%81%E5%8A%A0%E4%B8%8A%E5%8F%8C%E5%BC%95%E5%8F%B7%E8%BF%9B%E8%A1%8C%E7%B2%BE%E5%87%86%E5%8C%B9%E9%85%8D%E3%80%82%E5%9C%A8%E7%BF%BB%E5%88%B0%E4%B8%80%E4%B8%AA%E5%8F%AF%E7%99%BB%E9%99%86%E7%9A%84%E9%82%AE%E7%AE%B1%E5%90%8E%EF%BC%8C%E5%8E%BB%E9%80%9A%E4%BF%A1%E5%BD%95%E5%AF%BC%E5%87%BA%E6%89%80%E6%9C%89%E8%81%94%E7%B3%BB%E4%BA%BA%E6%96%B9%E5%BC%8F%EF%BC%8C%E8%BF%9B%E8%80%8C%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E7%9A%84%E5%8F%A3%E4%BB%A4%E7%88%86%E7%A0%B4%EF%BC%9B%E5%9C%A8%E8%BF%99%E4%BA%9B%E6%93%8D%E4%BD%9C%E8%BF%98%E6%B2%A1%E6%8B%BF%E5%88%B0%E6%9C%89%E7%94%A8%E5%AF%86%E7%A0%81%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%A0%B9%E6%8D%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84%E8%BF%9B%E8%A1%8C%E5%AE%9A%E7%82%B9%E6%94%BB%E5%87%BB%E4%BA%86%E3%80%82%E9%AB%98%E7%BA%A7%E7%82%B9%E7%9A%84%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A80day%EF%BC%8C%E6%B2%A10day%E7%9A%84%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%8F%91%E5%AE%8F%E7%97%85%E6%AF%92%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%BC%96%E4%B8%AA%E7%90%86%E7%94%B1%E5%8A%A0%E4%B8%AA%E5%AF%86%E5%8F%91%EF%BC%8C%E9%98%B2%E6%AD%A2%E8%A2%AB%E6%B2%99%E7%AE%B1%E6%8A%93%E6%A0%B7%E6%9C%AC%E3%80%82)
假如没有有用的邮箱账号，也可以搜索引擎收集一波邮箱，再根据明明规则，加载中国姓名top500字典进行组合，总归能抓到一两个用弱口令的。
如果还是啥都没有，也可以使用swaks之类的直接伪造成admin发送钓鱼邮件。至于发送内容和技巧，以后再聊。
对于防御方来讲，最厉害的莫过于直接关停外网邮箱了。次之，可以派人随时查看登录日志，及时发现异地登录爆破情况。对于有钱的甲方爸爸们，可以通过流量镜像，对附件进行沙箱判定。
### d)内网渗透，还是要了解业务
在突破边界进入内网后，剩下的主要是内网渗透了。内网渗透可以简单分为横向渗透和纵向渗透。内网渗透的实质和关键是信息收集，通过不停的突破系统拿到更多的权限，而更多的权限带来更多的信息，最终在信息和权限的螺旋迭代下，拿到目标的最高权限。
对于有域的环境，一般目标时拿下域控，而在本次攻击中却恰好爆发了一个直接打域控的0day，这就容易多了。但是即使一键拿下域控权限，还是要回到信息收集的本质上，要在海量的终端里筛选出自己的目标数据在哪台机器里，还是需要一些技巧的，展开来讲，有空再聊。
而不管是什么环境，我个人感觉阻碍攻击队伍进行内网渗透的主要原因还是对目标业务的了解程度。比如电力行业的16字方针（此处略），很多时候搞到边界系统后，ipconfig一看是10段的，以为进了个大内网，而实际情况是那只是冰山一角而已。纵向突破还有很长很长的路要走。再者，假如对电信行业、金融行业不了解，进到内网肯定也是一脸懵逼，一副“我是谁？我在哪？”的感觉。这也是内网渗透耗费精力的原因。