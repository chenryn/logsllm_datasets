Memory
#BHUSA @BlackHatEvents
Information Classification: General
Patching different 
flags lead to different 
error codes
Attacks on WMI data (9/9)
WMI Service
Wbemcore.dll
g_bDontAllowNewConnections
EventDelivery
repdrvfs.dll
g_bShuttingDown
g_Glob+0x38
g_Glob+0xBC
g_Glob
g_pEss_m4
m_pEseSession
Attacker’s 
App
#BHUSA @BlackHatEvents
Information Classification: General
Attack on 
wbemcore!g_bDontAllowNewConnections
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
Attack on wbemcore!g_bDontAllowNewConnections (1/4)
Attack: change data to TRUE (1)
Module: wbemcore.dll
Variable Name: g_bDontAllowNewConnections
Default Value: FALSE (0)
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
A new WMI connection 
Attack on wbemcore!g_bDontAllowNewConnections (2/4)
Attack: change data to TRUE (1)
Module: wbemcore.dll
Variable Name: g_bDontAllowNewConnections
Default Value: FALSE (0)
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
Attack on wbemcore!g_bDontAllowNewConnections (3/4)
Result: 
• Access to WMI is blocked.
• WMI clients stop receiving new events.
• New WMI clients cannot be started. 
• Any attempt to connect to WMI fails with 
error code 0x80080008
MessageId: CO_E_SERVER_STOPPING
MessageText: Object server is stopping 
when OLE service contacts it
Attack: change data to TRUE (1)
Module: wbemcore.dll
Variable Name: g_bDontAllowNewConnections
Default Value: FALSE (0)
Attacker’s App
#BHUSA @BlackHatEvents
Information Classification: General
Attack on wbemcore!g_bDontAllowNewConnections (4/4)
The online version is here –
https://www.youtube.com/channel/UCpJ_uhTb4_NNoq3-02QfOsA
DEMO: Attack on g_bDontAllowNewConnections
#BHUSA @BlackHatEvents
Information Classification: General
WMICheck –
Advanced Tool for Windows Introspection
#BHUSA @BlackHatEvents
Information Classification: General
WmiCheck helps to reveal that WMI internal variable has been changed
WMICheck: detects attacks on WMI data
• WMICheck console app and kernel driver
• It is only one tool that can retrieve  
•
The values of internal WMI objects and fields
•
WMI Provider GUIDs
•
Compare snapshots to check WMI integrity. 
• WMICheck is available here https://github.com/binarly-io
WMICHECK BY @REAL_REDP
#BHUSA @BlackHatEvents
Information Classification: General
Attack on wbemcore!g_bDontAllowNewConnections (4/4)
The online version is here –
https://www.youtube.com/channel/UCpJ_uhTb4_NNoq3-02QfOsA
DEMO: Detecting the Attack on
g_bDontAllowNewConnections
#BHUSA @BlackHatEvents
Information Classification: General
Attack on
wbemcore!EventDelivery
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
Attack: change data to FALSE(0)
Module: wbemcore.dll
Variable Name: EventDelivery (by Redplait)
Debug symbol: CRepository::m_pEseSession+0xC
Default Initialized Value: TRUE (1)
Attack on Wbemcore!EventDelivery (1/3)
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
Result: 
• All intrinsic events are disabled.
• Sysmon stops receiving three event types:
Event ID 19: (WmiEventFilter detected)
Event ID 20: (WmiEventConsumer detected)
Event ID 21: (WmiEventConsumerToFilter
detected)
Attack: change data to FALSE(0)
Module: wbemcore.dll
Variable Name: EventDelivery
Debug symbol: CRepository::m_pEseSession+0xC
Default Initialized Value: TRUE (1)
Attacker’s App
Attack on Wbemcore!EventDelivery (2/3)
#BHUSA @BlackHatEvents
Information Classification: General
Attack on Wbemcore!EventDelivery (3/3)
The online version is here –
https://www.youtube.com/channel/UCpJ_uhTb4_NNoq3-02QfOsA
DEMO: Attack on EventDelivery and its detection
#BHUSA @BlackHatEvents
Information Classification: General
Attack on 
repdrvfs!g_bShuttingDown
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Attack: change data to TRUE (1)
Module: repdrvfs.dll
Variable Name: g_bShuttingDown
Default Initialized Value: FALSE (0)
Attack on repdrvfs!g_bShuttingDown (1/2)
#BHUSA @BlackHatEvents
Information Classification: General
Attack on repdrvfs!g_bShuttingDown (2/2)
Result: 
• Any new attempt to connect to WMI fails 
with error code 0x8004100A
MessageId: WBEM_E_CRITICAL_ERROR 
MessageText: Critical Error
• Previously registered callback routines return 
error code 0x80041032
MessageId: WBEM_E_CALL_CANCELLED 
MessageText: Call Cancelled
repdrvfs.dll
Attack: change data to TRUE (1)
Module: repdrvfs.dll
Variable Name: g_bShuttingDown
Default Initialized Value: FALSE (0)
Attacker’s App
#BHUSA @BlackHatEvents
Information Classification: General
Attack on 
repdrvfs!g_Glob+0x0
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Attack: change data to FALSE (0)
Module: repdrvfs.dll
Variable Name: g_Glob+0x0
Default Initialized Value: TRUE (1)
Attack on repdrvfs!g_Glob+0x0 (1/3)
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
A new filter
Attack: change data to FALSE (0)
Module: repdrvfs.dll
Variable Name: g_Glob+0x0
Default Initialized Value: TRUE (1)
Attack on repdrvfs!g_Glob+0x0 (2/3)
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Result: 
• All attempts to add __EventFilter fail error 
code 0x80041014
MessageId: 
WBEM_E_INITIALIZATION_FAILURE 
Attack on repdrvfs!g_Glob+0x0 (3/3)
Attack: change data to FALSE (0)
Module: repdrvfs.dll
Variable Name: g_Glob+0x0
Default Initialized Value: TRUE (1)
Attacker’s App
#BHUSA @BlackHatEvents
Information Classification: General
Attack on 
repdrvfs!g_Glob+0x38
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0x38
Default Value: non-Null address of the instance
Attack on repdrvfs!g_Glob+0x38 (1/3)
#BHUSA @BlackHatEvents
Information Classification: General
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0x38
Default Value: non-Null address of the instance
repdrvfs.dll
A new _EventFilter
Attack on repdrvfs!g_Glob+0x38 (2/3)
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Attack on repdrvfs!g_Glob+0x38 (3/3)
Result: 
• All attempts to add __EventFilter fail with 
error code 0x80041014
MessageId: 
WBEM_E_INITIALIZATION_FAILURE 
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0x38
Default Value: non-Null address of the instance
Attacker’s App
#BHUSA @BlackHatEvents
Information Classification: General
Attack on 
repdrvfs!g_Glob+0xBC
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Attack on repdrvfs!g_Glob+0xBC (1/4)
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0xBC
Default Value: 1
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
wbemcore!CWbemLevel1Login::ConnectorLogin
wbemcore!CWbemNamespace::Initialize
repdrvfs!CSession::GetObjectDirect
repdrvfs!CNamespaceHandle::FileToInstance
WMI connection
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0xBC
Default Value: 1
Attack on repdrvfs!g_Glob+0xBC (2/4)
#BHUSA @BlackHatEvents
Information Classification: General
repdrvfs.dll
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0xBC
Default Value: 1
Attacker’s App
Attack on repdrvfs!g_Glob+0xBC (3/4)
#BHUSA @BlackHatEvents
Information Classification: General
Attack: change data to 0
Module: repdrvfs.dll
Variable Name: g_Glob+0xBC
Default Value: 1
repdrvfs.dll
Result: 
• Client cannot connect to WMI with error 
code 0x80041033
MessageId: WBEM_E_SHUTTING_DOWN 
MessageText: Shutting Down
• Already connected clients failed to 
enumerate WMI with error code 0x80041010
MessageId: WBEM_E_INVALID_CLASS
MessageText: Invalid Class
Attacker’s App
Attack on repdrvfs!g_Glob+0xBC (4/4)
#BHUSA @BlackHatEvents
Information Classification: General
Attack on 
wbemcore!_g_pEss_m4
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
Attack on wbemcore!_g_pEss_m4 (1/3)
Attack: change data to 0
Module: wbemcore.dll
Variable Name: _g_pEss_m4
Default Value: non-Null address of the interface
#BHUSA @BlackHatEvents
Information Classification: General
wbemcore.dll
wbemcore!ConfigMgr::GetEssSink
wbemcore!
CWbemNamespace::_ExecNotificationQueryAsync
Install callback
RPCRT4!Invoke
RPCRT4!LrpcIoComplete
Attack: change data to 0
Module: wbemcore.dll
Variable Name: _g_pEss_m4
Default Value: non-Null address of the interface
Attack on wbemcore!_g_pEss_m4 (2/3)
#BHUSA @BlackHatEvents
Information Classification: General
Result: 
• Consumer fails to install callback with error 
code 0x8004100C
MessageId: WBEM_E_NOT_SUPPORTED
MessageText: Not Supported
Attack: change data to 0
Module: wbemcore.dll
Variable Name: _g_pEss_m4
Default Value: non-Null address of the interface
wbemcore.dll
Attacker’s App
Attack on wbemcore!_g_pEss_m4 (3/3)
#BHUSA @BlackHatEvents
Information Classification: General
Attack on Wbemcore!EventDelivery (3/3)
The online version is here –
https://www.youtube.com/channel/UCpJ_uhTb4_NNoq3-02QfOsA
DEMO
#BHUSA @BlackHatEvents
Information Classification: General
Sandboxing WMI Service
#BHUSA @BlackHatEvents
Information Classification: General
WMI service interacts with OS, filesystem and registry
Winmgmt Service
(Service Host Process)
File system
Registry
WMI Apps
WMI Apps
WMI Providers\
Clients
ALPC ports
Named pipes
#BHUSA @BlackHatEvents
Information Classification: General
Winmgmt Service
(Service Host Process)
WMI Apps
WMI Apps
WMI Providers\
Clients
ALPC ports
Named pipes
Revoke SeImpersonatePrivilege
The server cannot impersonate the
client
unless
it
holds
the
SeImpersonatePrivilege
privilege.
MSDN: ImpersonateNamedPipeClient
Set Untrusted 
Integrity Level
Apps
with
a
Low
Integrity Level cannot
get write access to the
most OS objects
Set Untrusted Integrity 
Level
Apps with an Untrusted
Integrity Level
cannot
get write access to the
most OS objects.
File system
Registry
Attacker’s 
App
Attack on Process Token results in 
WMI Sandboxing
#BHUSA @BlackHatEvents
Information Classification: General
Attack on Process Token results in 
WMI Sandboxing
#BHUSA @BlackHatEvents
Information Classification: General
Attack on Process Token results in 
WMI Sandboxing
#BHUSA @BlackHatEvents
Information Classification: General
MemoryRanger can prevent DKOM patching of 
WMI Token structure
Examples of MemoryRanger customization  – https://igorkorkin.blogspot.com/search?q=memoryranger
MemoryRanger source code – https://github.com/IgorKorkin/MemoryRanger
#BHUSA @BlackHatEvents
Information Classification: General
Conclusion
WMI design issues : 
 Created for performance monitoring and telemetry gathering without security first in mind.
 Widely leveraged by various endpoint security solutions.
 Architectural weaknesses allow bypassing WMI from various attack vectors - mostly one bit change attack rules all the 
security across WMI policies.
WMICheck provides trustworthy runtime checking to detect WMI attacks.
MemoryRanger can prevent sandboxing WMI service by kernel attack.
Conclusion to conclusion: attack vectors on WMI can originate in the firmware
BHUS2022: Breaking Firmware Trust From Pre-EFI: Exploiting Early Boot Phases by Alex Matrosov (CEO Binarly)
#BHUSA @BlackHatEvents
Information Classification: General
Thank you
binarly.io
github.com/binarly-io