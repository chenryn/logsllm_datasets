# Javaä»£ç å®¡è®¡å…¥é—¨ç¯‡ï¼šWebGoat 8ï¼ˆåˆè§ï¼‰
##### è¯‘æ–‡å£°æ˜
æœ¬æ–‡æ˜¯ç¿»è¯‘æ–‡ç« 
è¯‘æ–‡ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†…å®¹è¡¨è¾¾ä»¥åŠå«ä¹‰åŸæ–‡ä¸ºå‡†ã€‚
ä½œè€…ï¼šæ•°å­—è§‚æ˜Ÿ Jack Chan(Saturn)
## ç®€ä»‹
WebGoat8æ˜¯åŸºäºSpring
bootæ¡†æ¶å¼€å‘,æ•…æ„ä¸å®‰å…¨çš„Webåº”ç”¨ç¨‹åºï¼Œæ—¨åœ¨æ•™æˆWebåº”ç”¨ç¨‹åºå®‰å…¨æ€§è¯¾ç¨‹ã€‚è¯¥ç¨‹åºæ¼”ç¤ºäº†å¸¸è§çš„æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºç¼ºé™·ã€‚æœ¬æ–‡å°†ç®€è¦åˆ†æWebGoat8çš„ç™»é™†æ¨¡å—ï¼Œæ³¨å†Œæ¨¡å—ï¼Œä½œä¸ºçƒ­èº«ï¼Œéšåå¯¹SQLæ³¨å…¥è¯¾ç¨‹è¿›è¡Œä»£ç å®¡è®¡ã€‚
## åŸºç¡€
æœ¬äººå¯¹WebGoat8è¿›è¡Œreview codeä¹‹æ—¶ï¼Œä»…æœ‰äº›è®¸JavaåŸºç¡€ï¼Œäº†è§£è¿‡Springæ¡†æ¶ï¼Œmavenï¼Œå¯¹äºSpring
bootæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦ã€‚æ‰€ä»¥æœ¬æ–‡æ˜¯ä¸€ä¸ªåˆå­¦è€…é¢å¯¹æ–°æ¡†æ¶çš„æ¡ä»¶ä¸‹ï¼Œåšçš„ä¸€äº›æ¢ç©¶è®°å½•ã€‚
## å‡†å¤‡
Java 11
Maven > 3.2.1
IDEA
âš æ³¨æ„ï¼ŒJava JDKç‰ˆæœ¬éœ€è¦11ï¼Œè¿™ä¸ªä¸èƒ½å·æ‡’ï¼Œäº²æµ‹Java8ï¼ˆburp suitè¿è¡Œç¯å¢ƒï¼‰ç¼–è¯‘å¤±è´¥æ— æ³•å¯åŠ¨ã€‚éœ€è¦åšå¥½Javaç‰ˆæœ¬åˆ‡æ¢å‡†å¤‡ã€‚
ä¸‹è½½æºç 
åœ¨command shellä¸­
git clone 
ç¼–è¯‘é¡¹ç›®
cd WebGoat
mvn clean install
è¿è¡Œé¡¹ç›®
mvn -pl webgoat-server spring-boot:run
è®¿é—®WebGoat
localhost:8080/WebGoat
import WebGoatåˆ°IDEA è¿›è¡Œä»£ç æŸ¥çœ‹åŠè°ƒè¯•
é€‰æ‹©Maven
Root directoryé€‰æ‹©WebGoatç›®å½•
å‹¾é€‰Maven porjects
é€‰æ‹©SDK11
ä»»æ„Project name
éšåæˆ‘ä»¬å°±èƒ½çœ‹åˆ°ï¼Œé…ç½®éƒ½å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œå¯ä»¥ç«‹é©¬å¼€å§‹è¿è¡Œå’Œè°ƒè¯•çš„æ“ä½œï¼Œä¸€æ­¥åˆ°ä½ï¼éå¸¸èˆ’æœã€‚
è¿™ä¸ªæ—¶å€™ä½ æˆ–è®¸å°±æƒ³é©¬ä¸Šå¼€å§‹è¿è¡Œè°ƒè¯•ï¼Œç„¶åå‘ç°æŠ¥é”™äº†ï¼Œæˆ–è®¸è¿™æ˜¯å› ä¸ºå‰é¢ä½ è¿è¡Œäº†mvnå‘½ä»¤8080ç«¯å£è¢«å ç”¨çš„åŸå› ï¼Œå…³é—­mvnå³å¯ã€‚
## ç»„ä»¶å®‰å…¨
æˆ‘ä»¬å¯ä»¥åœ¨IDEAå·¦ä¾§æ ä¸­æŸ¥çœ‹åˆ°å¯¼å…¥çš„åŒ…ï¼ˆç»„ä»¶ï¼‰ã€‚é€šè¿‡æŸ¥çœ‹è¿™äº›ç»„ä»¶åŠå…¶ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å¯»æ‰¾æ˜¯å¦å¼•å…¥äº†å­˜åœ¨å·²çŸ¥æ¼æ´çš„ç»„ä»¶ã€‚ä¾‹å¦‚ï¼šStruts2ï¼ˆRCEç­‰ï¼‰ã€ä¸å®‰å…¨çš„ç¼–è¾‘æ§ä»¶ï¼ˆä»»æ„æ–‡ä»¶ä¸Šä¼ ï¼Œxssç­‰ï¼‰ã€XMLè§£æå™¨ï¼ˆxxeï¼‰ä»¥åŠå¯è¢«å…¶å®ƒæ¼æ´åˆ©ç”¨çš„å¦‚commons-collections:3.1ï¼ˆååºåˆ—åŒ–RCEï¼‰ç­‰ç­‰ã€‚
ä»ä¸‹å›¾æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼Œç¨å¾®å¤§ä¸€ç‚¹çš„åº”ç”¨ï¼Œç»„ä»¶éƒ½ä¼šéå¸¸å¤šã€‚ä¸€ä¸ªä¸ªå»æœç´¢æŸ¥çœ‹ç»„ä»¶æ˜¯å¦å­˜åœ¨å·²çŸ¥æ¼æ´ä¼šå˜å¾—éå¸¸ä¸ç°å®ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰¹é‡åŒ–å·¥å…·å»ä¸ºæˆ‘ä»¬æ£€æµ‹ç»„ä»¶å®‰å…¨ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£ä¸€ä¸‹ï¼šOWASP-Dependency-Check
Dependency-Checkæ˜¯OWASPï¼ˆOpen Web Application Security
Projectï¼‰çš„ä¸€ä¸ªå®ç”¨å¼€æºç¨‹åºï¼Œç”¨äºè¯†åˆ«é¡¹ç›®ä¾èµ–é¡¹å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•å·²çŸ¥çš„ï¼Œå…¬å¼€æŠ«éœ²çš„æ¼æ´ã€‚ç›®å‰ï¼Œå·²æ”¯æŒJavaã€.NETã€Rubyã€Node.jsã€Pythonç­‰è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œå¹¶ä¸ºC/C++æ„å»ºç³»ç»Ÿï¼ˆautoconfå’Œcmakeï¼‰æä¾›äº†æœ‰é™çš„æ”¯æŒã€‚è€Œä¸”è¯¥å·¥å…·è¿˜æ˜¯OWASP
Top 10çš„è§£å†³æ–¹æ¡ˆçš„ä¸€éƒ¨åˆ†ã€‚
Dependency-Checkæ”¯æŒé¢å¹¿ï¼ˆæ”¯æŒå¤šç§è¯­è¨€ï¼‰ã€å¯é›†æˆæ€§å¼ºï¼Œä½œä¸ºä¸€æ¬¾å¼€æºå·¥å…·ï¼Œåœ¨å¤šå¹´æ¥çš„å‘å±•ä¸­å·²ç»æ”¯æŒå’Œè®¸å¤šä¸»æµçš„è½¯ä»¶è¿›è¡Œé›†æˆï¼Œæ¯”å¦‚ï¼šå‘½ä»¤è¡Œã€Antã€Mavenã€Gradleã€Jenkinsã€Sonarç­‰ï¼›å…·å¤‡ä½¿ç”¨æ–¹ä¾¿ï¼Œè½åœ°ç®€å•ç­‰ä¼˜åŠ¿ã€‚
æ­¤æ¬¡ä¸å¯¹Dependency-checkè¿›è¡Œè¯¦ç»†è®²è§£ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è®¿é—®ä»¥ä¸‹é“¾æ¥äº†è§£ï¼š
## è®¿é—®WebGoat8
ç®€çº¦å¤§æ°”çš„ç•Œé¢æ‰‘é¢è€Œæ¥ã€‚ä¸€è®¿é—®WebGoaté¡¹ç›®ï¼Œå°±è·³è½¬åˆ°/loginé¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹è¿™ä¸ªç™»é™†è®¤è¯çš„å¤„ç†æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Œä»è€Œæ€è€ƒæ˜¯å¦å­˜åœ¨å®‰å…¨é—®é¢˜ã€‚
Spring boot ç™»é™†è®¤è¯â€“WebSecurityConfig
é—®é¢˜
åœ¨ä»£ç ä¸­å¦‚ä½•å®šä½åŠŸèƒ½æ¨¡å—ï¼Ÿ
  1. æŸ¥æ‰¾æ˜¯å¦ä½¿ç”¨æ¡†æ¶æ‰€æä¾›å¯¹åº”çš„åŠŸèƒ½æ¨¡å—
  2. é€šè¿‡è·¯ç”±å®šä½åŠŸèƒ½æ¨¡å—
å·²çŸ¥ï¼š
æ¡†æ¶æä¾›ï¼šSpring security ç™»å½•è®¤è¯
Springbootè·¯ç”±â€œ
  * @RequestMapping(path = PATH)
  * @GetMapping(path = PATH)
  * @PostMapping(path = PATH)  
â€¦â€¦  
â€
é¦–å…ˆæ˜¯å°è¯•ä½¿ç”¨è·¯ç”±ä¸­çš„pathç‰¹å¾â€œ/loginâ€ï¼Œå»å…¨å±€æœç´¢/loginï¼Œå¯ä»¥æ‰¾åˆ°WebSecurityConfigæ–‡ä»¶ï¼Œé€šè¿‡æŸ¥æ‰¾èµ„æ–™ä¹Ÿå¯ä»¥çŸ¥é“Spring
bootå¯ä»¥é€šè¿‡ç¼–å†™WebSecurityConfigæ–‡ä»¶æ¥è®¾ç½®ç›¸å…³çš„å®‰å…¨é¡¹ï¼ˆauthenticationå’Œauthorizationï¼‰ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†è®¤è¯ã€‚æ‰€ä»¥å¯ä»¥éå¸¸ç¡®è®¤WebSecurityConfigæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬æƒ³è¦å¯»æ‰¾çš„ã€‚
WebSecurityConfig.java
    import lombok.AllArgsConstructor;
    import org.owasp.webgoat.users.UserService;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.builders.WebSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
    import org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;
    import org.springframework.security.core.userdetails.UserDetailsService;
    @Configuration
    @AllArgsConstructor
    @EnableWebSecurity // æ³¨è§£å¼€å¯Spring Securityçš„åŠŸèƒ½
    //WebSecurityConfigurerAdapter:é‡å†™å®ƒçš„æ–¹æ³•æ¥è®¾ç½®ä¸€äº›webçš„å®‰å…¨é…ç½®
    public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
        private final UserService userDetailsService;
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            ExpressionUrlAuthorizationConfigurer.ExpressionInterceptUrlRegistry security = http
                    .authorizeRequests()//æˆæƒ
                    .antMatchers("/css/**", "/images/**", "/js/**", "fonts/**", "/plugins/**", "/registration", "/register.mvc").permitAll()
                    .anyRequest().authenticated();//å®šä¹‰è®¤è¯
            security.and()
                    .formLogin()
                    .loginPage("/login")//è®¤è¯é¡µ
                    .defaultSuccessUrl("/welcome.mvc", true)//è®¤è¯æˆåŠŸè½¬åˆ°/welcome.mvc
                    .usernameParameter("username")
                    .passwordParameter("password")
                    .permitAll();
            security.and()
                    .logout().deleteCookies("JSESSIONID").invalidateHttpSession(true);
            security.and().csrf().disable();
            http.headers().cacheControl().disable();
            http.exceptionHandling().authenticationEntryPoint(new AjaxAuthenticationEntryPoint("/login"));
        }
        //// TODO: 11/18/2016 make this a little bit more configurabe last part at least
        @Override
        public void configure(WebSecurity web) throws Exception {
            web.ignoring().antMatchers("/plugin_lessons/**", "/XXE/**");
        }
        @Autowired
        public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
            auth.userDetailsService(userDetailsService); //.passwordEncoder(bCryptPasswordEncoder());
        }
        @Bean
        @Override
        public UserDetailsService userDetailsServiceBean() throws Exception {
            return userDetailsService;
        }
    }
æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„ä»£ç å—æ˜¯ï¼š
        @Autowired
        public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    //auth.userDetailsService(userDetailsServiceï¼‰æ ¹æ®userDetailsServiceå¯¹è±¡ï¼Œæ·»åŠ èº«ä»½è®¤è¯
    auth.userDetailsService(userDetailsService); //.passwordEncoder(bCryptPasswordEncoder());
        }
ç¿»é˜…AuthenticationManagerBuilderç›¸å…³èµ„æ–™ï¼š
AuthenticationManagerBuilderç”¨äºåˆ›å»ºAuthenticationManagerã€‚
å…è®¸è½»æ¾æ„å»ºå†…å­˜èº«ä»½éªŒè¯ï¼ŒLDAPèº«ä»½éªŒè¯ï¼ŒåŸºäºJDBCçš„èº«ä»½éªŒè¯ï¼Œæ·»åŠ UserDetailsServiceä»¥åŠæ·»åŠ AuthenticationProviderã€‚
åŸºäºå†…å­˜èº«ä»½è®¤è¯ï¼š
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·åå¯†ç ç›´æ¥å†™æ­»åœ¨ä»£ç ä¸­ç„¶åè¿è¡Œæ—¶è¿›å…¥å†…å­˜ï¼Œå½“ç»“åˆä»»æ„æ–‡ä»¶è¯»å–ï¼Œä»£ç æ³„æ¼ç­‰æ¼æ´æ—¶ï¼Œå¯è·å–æ˜æ–‡å¯†ç ï¼Œè¿™ç§åšæ³•æ˜¯ä¸å®‰å…¨çš„ã€‚
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
            auth
                .inMemoryAuthentication()
                .withUser("user").password("password").roles("USER").and()
                .withUser("admin").password("password").roles("USER", "ADMIN");
    }
åŸºäºJDBCè®¤è¯ï¼š
    @Autowiredprivate DataSource dataSource;
    @Autowiredpublic void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
            auth
                    .jdbcAuthentication()
                            .dataSource(dataSource)
                            .withDefaultSchema()
                            .withUser("user").password("password").roles("USER").and()
                            .withUser("admin").password("password").roles("USER", "ADMIN");
    }
åŸºäºLDAPçš„è®¤è¯ï¼š
    @Autowired
    private DataSource dataSource;
    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth
            .ldapAuthentication()
                .userDnPatterns("uid={0},ou=people")
                .groupSearchBase("ou=groups");
    }
åŸºäºè‡ªå®šä¹‰UserDetailsServiceè®¤è¯ï¼š
ç”±äºWebGoat8å°±æ˜¯åŸºäºè‡ªå®šä¹‰UserDetailsServiceè®¤è¯ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥é‡ç‚¹å…³æ³¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚
    //æ ¹æ®ä¼ å…¥çš„è‡ªå®šä¹‰UserDetailsServiceæ·»åŠ èº«ä»½éªŒè¯ã€‚ç„¶åè¿”å›DaoAuthenticationConfigurerä»¥å…è®¸è‡ªå®šä¹‰èº«ä»½éªŒè¯ã€‚
    //æ­¤æ–¹æ³•è¿˜ç¡®ä¿UserDetailsServiceå¯ç”¨äºgetDefaultUserDetailsServiceï¼ˆï¼‰æ–¹æ³•ã€‚ è¯·æ³¨æ„ï¼Œå…¶ä»–UserDetailsServiceå¯èƒ½ä¼šè¦†ç›–æ­¤UserDetailsServiceä½œä¸ºé»˜è®¤å€¼ã€‚
    public  DaoAuthenticationConfigurer userDetailsService(
          T userDetailsService) throws Exception {
       this.defaultUserDetailsService = userDetailsService;
       return apply(new DaoAuthenticationConfigurer<>(
             userDetailsService));
    }
ç„¶åæˆ‘ä»¬è¿½è¸ªuserDetailsServiceï¼Œå¦‚ä¸‹å›¾ï¼Œå³è¿½è¸ªæºç ä¸­çš„UserServiceï¼š
UserService.javaï¼š
    package org.owasp.webgoat.users;
    import lombok.AllArgsConstructor;
    import org.springframework.security.core.userdetails.UserDetailsService;
    import org.springframework.security.core.userdetails.UsernameNotFoundException;
    import org.springframework.stereotype.Service;
    import java.util.List;
    /**
     * @author nbaars
     * @since 3/19/17.
     */
    @Service
    @AllArgsConstructor
    public class UserService implements UserDetailsService {
        private final UserRepository userRepository;
        private final UserTrackerRepository userTrackerRepository;
        @Override
        public WebGoatUser loadUserByUsername(String username) throws UsernameNotFoundException {
            WebGoatUser webGoatUser = userRepository.findByUsername(username);
            if (webGoatUser == null) {
                throw new UsernameNotFoundException("User not found");
            } else {
                webGoatUser.createUser();
            }
            return webGoatUser;
        }
        public void addUser(String username, String password) {
            userRepository.save(new WebGoatUser(username, password));
            userTrackerRepository.save(new UserTracker(username));
        }
        public void addUser(String username, String password, String role) {
            userRepository.save(new WebGoatUser(username,password,role));
            userTrackerRepository.save(new UserTracker(username));
        }
        public List getAllUsers () {
            return userRepository.findAll();
        }
    }
å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡userRepository.findByUsername(username)å»è·å–webGoatUserå¯¹è±¡ï¼Œå¯¹è±¡é‡Œé¢å°±æœ‰usernameï¼Œpasswordï¼Œroleï¼Œuserè¿™å‡ ä¸ªå…ƒç´ ï¼Œå…¶ä¸­useræ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåé¢å°†è·å–usernameï¼Œpasswordï¼Œè¿˜æœ‰ä¸€äº›è´¦å·çŠ¶æ€ï¼ˆè¿‡æœŸï¼Œå†»ç»“ç­‰ï¼‰çš„å…ƒç´ ã€‚
ç›²çŒœè¿™ä¸ªuserRepositoryå°±æ˜¯å’Œæ•°æ®åº“äº¤äº’çš„å¯¹è±¡ï¼Œè·Ÿè¸ªè¿‡å»ã€‚
UserRepository.java
    package org.owasp.webgoat.users;
    import org.springframework.data.jpa.repository.JpaRepository;
    import java.util.List;
    public interface UserRepository extends JpaRepository {
        WebGoatUser findByUsername(String username);
        List findAll();
    }
çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼ŒğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³
æ˜¯æ¥å£ï¼Œæ²¡æœ‰å…·ä½“çš„å®ç°æ–¹æ³•ï¼Œæ€ä¹ˆå®ç°çš„ï¼Ÿ
åˆçœ‹åˆ°JpaRepositoryè¿™ä¸ªå±äºspringframeworkçš„çˆ¶ç±»ï¼Œå»æ‰¾æ‰¾èµ„æ–™å§ã€‚
> çŸ³å™¨æ—¶ä»£ å®šä¹‰æ•°æ®æºï¼Œåˆ›å»ºJdbcTemplateï¼Œç„¶åç›´æ¥æ‹¼æ¥SQLæ¥æŸ¥è¯¢ã€‚é€šç”¨æ€§å¾ˆå·®ã€‚
>
> å·¥ä¸šé©å‘½ ä½¿ç”¨mybatisï¼Œå®šä¹‰æ•°æ®æºï¼Œå®šä¹‰domainï¼Œå®šä¹‰sqlæ˜ å°„çš„xmlæ–‡ä»¶ï¼Œå®šä¹‰å…·ä½“æ“ä½œçš„DAOå±‚ã€‚æ­å»ºèµ·æ¥å¾ˆè´¹æ—¶é—´ï¼ŒåæœŸä¹Ÿç»å¸¸éœ€è¦ç»´æŠ¤ã€‚
>
> ç°ä»£åŒ– ç”¨spring-data-jpaï¼Œç®€ç®€å•å•ç»§æ‰¿JpaRepositoryï¼Œéµå¾ªspring
> dataçš„è§„èŒƒå®šä¹‰æŸ¥è¯¢æ¥å£ï¼Œæ— éœ€å†™å®ç°ç±»å°±å¯ä½¿ç”¨ï¼Œå¤§å¤§å‡å°‘æ•°æ®è®¿é—®å±‚(DAO)çš„å¼€å‘é‡ã€‚
ç®€å•æ¥è¯´ï¼Œæ¥å£UserRepository extends JpaRepositoryä¸‹ï¼Œ
å£°æ˜findByUsername(String
username)æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åfindByUsernameæ˜¯æŒ‰ç…§è§„åˆ™å»è®¾è®¡çš„ï¼Œå‰ç¼€findByåœ¨è§£æçš„æ—¶å€™å»æ‰ï¼Œç±»ä¼¼çš„å‰ç¼€æœ‰ï¼šfindã€readã€readByã€getã€getByï¼Œç„¶åå‰©ä¸‹Usernameï¼ˆæ ¹æ®
POJO è§„èŒƒï¼Œé¦–å­—æ¯å˜ä¸ºå°å†™ï¼‰è¢«åˆ¤æ–­æ˜¯å¦ä¸ºWebGoatUserå¯¹è±¡çš„å±æ€§ï¼Œæ˜¯çš„è¯å°±è¿›è¡ŒæŸ¥è¯¢ï¼Œæœ€ç»ˆæœ¬è´¨ä¸Šè½¬æ¢ä¸ºä»¥ä¸‹æŸ¥è¯¢ï¼š
select u from WebGoatUser u where u.username = ?1
ç”±äºæ¡†æ¶å†…åŠ¨æ€ç»‘å®šï¼Œæ˜¯ä¸ä¼šå­˜åœ¨sqlæ³¨å…¥é—®é¢˜ã€‚amazingï¼éå¸¸ç°ä»£åŒ–ã€‚
ä»¥ä¸Šä»‹ç»çš„æ˜¯é€šè¿‡è§£ææ–¹æ³•ååˆ›å»ºæŸ¥è¯¢ã€‚é€šè¿‡è¿™ç§æ–¹æ³•æŸ¥è¯¢ä¸€èˆ¬ä¸ä¼šæœ‰sqlæ³¨å…¥é—®é¢˜ã€‚
æ­¤å¤–è¿˜æœ‰ï¼š
ä½¿ç”¨ @Query åˆ›å»ºæŸ¥è¯¢
ç¤ºèŒƒä»£ç ï¼š
    //ä½¿ç”¨å ä½ç¬¦ä½ç½®ç¼–å·
    public interface UserDao extends Repository { 
     @Query("select a from AccountInfo a where a.accountId = ?1") 
     public AccountInfo findByAccountId(Long accountId); 
     }
     //ä½¿ç”¨å‘½åå‚æ•°æ¥ä»£æ›¿å ä½ç¬¦ä½ç½®ç¼–å·
     public interface UserDao extends Repository { 
     @Query("from AccountInfo a where a.accountId = :id") 
     public AccountInfo findByAccountId(@Param("id")Long accountId); 
     }
ä»¥ä¸Šç¤ºèŒƒä»£ç éƒ½æ˜¯ç¬¦åˆè§„èŒƒï¼Œä¸å­˜åœ¨æ³¨å…¥ã€‚
é€šè¿‡è°ƒç”¨ JPA å‘½åæŸ¥è¯¢è¯­å¥åˆ›å»ºæŸ¥è¯¢
å‘½åæŸ¥è¯¢æ˜¯ JPA æä¾›çš„ä¸€ç§å°†æŸ¥è¯¢è¯­å¥ä»æ–¹æ³•ä½“ä¸­ç‹¬ç«‹å‡ºæ¥ï¼Œä»¥ä¾›å¤šä¸ªæ–¹æ³•å…±ç”¨çš„åŠŸèƒ½ã€‚Spring Data JPA
å¯¹å‘½åæŸ¥è¯¢ä¹Ÿæä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚ç”¨æˆ·åªéœ€è¦æŒ‰ç…§ JPA è§„èŒƒåœ¨ orm.xml æ–‡ä»¶æˆ–è€…åœ¨ä»£ç ä¸­ä½¿ç”¨ @NamedQueryï¼ˆæˆ–
@NamedNativeQueryï¼‰å®šä¹‰å¥½æŸ¥è¯¢è¯­å¥ï¼Œå”¯ä¸€è¦åšçš„å°±æ˜¯ä¸ºè¯¥è¯­å¥å‘½åæ—¶ï¼Œéœ€è¦æ»¡è¶³â€DomainClass.methodName()â€çš„å‘½åè§„åˆ™ã€‚å‡è®¾å®šä¹‰äº†å¦‚ä¸‹æ¥å£ï¼š
    public interface UserDao extends Repository { 
     ...... 
     public List findTop5(); 
     } 
å¦‚æœå¸Œæœ›ä¸º findTop5() åˆ›å»ºå‘½åæŸ¥è¯¢ï¼Œå¹¶ä¸ä¹‹å…³è”ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨é€‚å½“çš„ä½ç½®å®šä¹‰å‘½åæŸ¥è¯¢è¯­å¥ï¼Œå¹¶å°†å…¶å‘½åä¸º
â€œAccountInfo.findTop5â€³ï¼Œæ¡†æ¶åœ¨åˆ›å»ºä»£ç†ç±»çš„è¿‡ç¨‹ä¸­ï¼Œè§£æåˆ°è¯¥æ–¹æ³•æ—¶ï¼Œä¼˜å…ˆæŸ¥æ‰¾åä¸º â€œAccountInfo.findTop5â€
çš„å‘½åæŸ¥è¯¢å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™å°è¯•è§£ææ–¹æ³•åï¼Œæ ¹æ®æ–¹æ³•åå­—åˆ›å»ºæŸ¥è¯¢ã€‚
å› æ­¤è¯†åˆ«å‡ºæ˜¯JPA å‘½åæŸ¥è¯¢è¯­å¥åˆ›å»ºæŸ¥è¯¢çš„ï¼Œéœ€è¦å»æŸ¥çœ‹orm.xmlæŸ¥çœ‹å®šä¹‰çš„æŸ¥è¯¢è¯­å¥æˆ–åœ¨ä»£ç ä¸­æŸ¥çœ‹@NamedQueryï¼ˆæˆ–
@NamedNativeQueryï¼‰å®šä¹‰å¥½æŸ¥è¯¢è¯­å¥æ˜¯å¦å®‰å…¨ã€‚
æ€»çš„æ¥è¯´ï¼šç¬¦åˆè§„èŒƒä¸‹JPAæŸ¥è¯¢åŠå…¶ä»–æ•°æ®åº“æ“ä½œæ˜¯æ¯”è¾ƒå®‰å…¨çš„ï¼Œä½†JPAä¹Ÿæ›¾çˆ†å‡ºæ¼æ´ï¼ˆ[cve-2016-6652](https://github.com/solita/sqli-poc)ï¼‰æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç‚¹å‡»é“¾æ¥ï¼ŒæŸ¥çœ‹è¯¦æƒ…ã€‚æœ€åæä¸€å¥ï¼Œä¸æ˜¯ä½¿ç”¨äº†å‰å®³çš„æ¡†æ¶ï¼Œå°±èƒ½å®Œå…¨é˜²æ­¢sqlæ³¨å…¥æ¼æ´çš„ï¼Œç”±äºç§ç§åŸå› ï¼Œåœ¨ä½¿ç”¨äº†å®‰å…¨çš„æ¡†æ¶ä¸‹ï¼Œä¹Ÿä¼šå‘ç”Ÿç¨‹åºå‘˜ä½¿ç”¨ç›´æ¥æ‹¼æ¥sqlè¯­å¥çš„æƒ…å†µã€‚
å›åˆ°AuthenticationManagerBuilder
    @Autowired
        public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
            auth.userDetailsService(userDetailsService); //.passwordEncoder(bCryptPasswordEncoder());
        }
è¿½è¸ªè®¤è¯è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œé€šè¿‡auth.userDetailsServiceï¼ˆusernameï¼‰ï¼Œæ‹¿å¯¹åº”çš„å¯¹è±¡ï¼ˆä¸‹å›¾åä¸ºloadedUserï¼‰ï¼Œç„¶åä¸ä»å‰ç«¯è·å–çš„username,passwordæ„æˆçš„authenticationå¯¹è±¡åšå¯¹æ¯”ï¼Œçœ‹credentialsä¸passwordæ˜¯å¦ç›¸ç­‰ï¼Œå†³å®šäº†authenticatedçš„å€¼ï¼Œä»è€Œå®Œæˆè®¤è¯è¿‡ç¨‹ã€‚å½“ç„¶è¿‡ç¨‹æ²¡æœ‰æˆ‘è¯´çš„é‚£ä¹ˆç®€å•ï¼Œè¿˜æœ‰è·å–å¸å·çš„çŠ¶æ€ï¼Œç„¶åæ ¹çŠ¶æ€è¿›è¡Œä¸€ç³»åˆ—æ“ä½œçš„ã€‚
å®¡è®¡æ³¨å†ŒåŠŸèƒ½
é€šè¿‡/register.mvcå®šä½ä»£ç 
    package org.owasp.webgoat.users;
    import lombok.AllArgsConstructor;
    import lombok.SneakyThrows;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.security.authentication.AuthenticationManager;
    import org.springframework.stereotype.Controller;
    import org.springframework.validation.BindingResult;