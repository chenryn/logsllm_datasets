462
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:58:33 UTC from IEEE Xplore.  Restrictions apply. 
predicationwouldhavesquashedtheinstructionbeforeitwasissued.Therefore,partialpredicationsupportsuffersthelossofactuallyexecutingtheinstruction,butgainsthebeneﬁtofbeingeasilyimplementedinmodernmicropro-cessordesigns.Afterif-conversiononthatpieceofcodeinFigure3,thepredictedpath,inwhichneithertheinputsnortheresultisNaNordenormal,resultsinanaverageof33cyclesandnohard-to-predictbranches.1reg1<-reg1xorreg12reg0<-zSig0shl13reg0<-reg0subtract04reg1<-setz5zSig0<-zSig0shlreg16zExp<-zExpaddreg1Figure4.Thecheckforthemantissaof32bitﬂoatingpointproductresultbeingtoolargeafterif-conversion.If-conversioninthiscaseissolvedbyusingthesetcon-ditionalinstruction.Thisinstructionallowsforaregistertobesettoa1iftheconditioncodeistrue,elseitdoesnotchangetheregister.Thusthesimpleif-conversionlookslikeFigure4.Anotherinstructionthatmanyarchitecturesimplementisamoveconditionalinstruction.Thisallowsforthecon-ditionalmoveofavaluefromaregister/memorylocationtoanotherregister/memorylocation.Thisinstructioncouldbeusedforoptimization,however,itdidnotproveusefulinthehandoptimizedtracesastheplaceswhereitcouldhavebeenaddeddidnotinvolvehard-to-predictbranches.3.4.NewMicro-OperationsInthetracesthereareasmallsetofsubroutinesthatac-countformanyofthedynamicuopsseeninpractice.ManyoftheseoperationscanbeimplementedintheinternalRISCISAwithlittlehardwareoverhead.Forexampleajammingrightshiftwasperformedmanytimesduringthetraces[8].Thejshrinstructiondiffersfromashrbyperformingalogicalorofallthebitsshiftedoffandtheleastsigniﬁ-cantbitintheresultalready,andplacingtheresultofthatorintotheleastsigniﬁcantbit.Implementingthisinstruc-tionisinexpensiveandwillprobablynotaddtothecriticalpathoftheexecuteunit.AsFigure5shows,toactuallyimplementthisfunctionalitywithoutthejshrwouldin-cludequiteafewmicro-opsaswellasapotentialbranchifpredicationwasnotavailable.Thejshrmicro-opre-placeseightmicro-opsthatarenecessarytomicrocodeit,assumingthatoperatingontheoriginalsourceisallowed;otherwiseittakesninemicro-ops.Eachofthesemicro-opstakesonecycletocomplete.Byhavinghardwaresupportforthismicro-op,apotentialbranchisalsoavoided.Sincethismicro-opisverysimilartoashift,ithasbeenassignedthesamedelayasanormalrightshiftmicro-op:onecycle.1reg0<-src2reg1<-reg03reg0<-reg0shrshift_count4reg2<-shift_count5reg2<-negreg26reg2<-shift_sizeplusreg27reg1<-reg1shlreg28reg3<-setnz9reg0<-reg0orreg3Figure5.Themicrocodethatwouldbenec-essarytoimplementajshrinstructionwith-outmodiﬁcationtotheshiftunit.Srcisthesourcethatneedstobejammingrightshifted.Shiftcountisthenumbertoshiftthesourceby.Shiftsizeisthesizeoftheregisterbeingoperatedon.Anothersetofmicro-opsimplementedarethepfloatmicro-ops.Thesemicro-opstakeamantissa,anexponent,andasign.Thereisaseparatepﬂoatforeachprecisionofﬂoatingpointnumbers.Eachpﬂoatshiftstheexponentleftbytheappropriatenumber,thesignleftbytheappropriatenumber,andaddinthemantissa.However,sincetheshiftsareastaticnumberbasedontheprecisionoftheﬂoat,thereisnorealneedtoshift,justtomovethebitstotherightplace.Thereisanaddoperationbetweenthemantissaandtheexponent.However,sincetheaddisonlyrelevanttotheexponent,thesizeoftheaddneededis8bitsforthesingleprecisionpﬂoatand11bitsforthedoubleprecisionpﬂoat.Withtheaddbeingtheonlycomputationneededtopackaﬂoat,thepfloatmicro-opswereassignedthesamedelayasaregularaddmicro-op,whichisonecycle.3.5.OptimizingtheExpectedPathTracesgeneratedusinganoptimizingcompilerwith-outthebeneﬁtoftheoptimizationtechniquesdescribedinthisworkwerefoundtoprovideunacceptableperformance.Therefore,anothersetofEmμcodetraceswascreatedbyhand.Examiningthecontrolﬂowofa64bitﬂoatingpointmultiplyfromtheSoftFloat2blibrarywillyieldacontrolﬂowgraphsimilartoFigure6underafewassumptions.Theﬁrstassumptionisthattheroundingmodeimplementedisroundtonearesteven,sothereisnoneedtocheckforwhichroundingmodetouse.Thesecondassumptionisthatthere978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
463
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:58:33 UTC from IEEE Xplore.  Restrictions apply. 
arenoIEEEﬂoatingpointexceptionstoimplementasthex86/amd64architecturesdonotimplementmostofthem,andtheonesimplementedarenotenabledbydefault.(cid:39)(cid:82)(cid:72)(cid:86)(cid:3)(cid:86)(cid:82)(cid:88)(cid:85)(cid:70)(cid:72)(cid:3)(cid:36)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:80)(cid:72)(cid:68)(cid:81)(cid:3)(cid:49)(cid:68)(cid:49)(cid:40)(cid:91)(cid:87)(cid:85)(cid:68)(cid:70)(cid:87)(cid:3)(cid:87)(cid:75)(cid:72)(cid:3)(cid:86)(cid:76)(cid:74)(cid:81)(cid:15)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:15)(cid:3)(cid:68)(cid:81)(cid:71)(cid:3)(cid:80)(cid:68)(cid:81)(cid:87)(cid:76)(cid:86)(cid:86)(cid:68)(cid:3)(cid:82)(cid:88)(cid:87)(cid:3)(cid:73)(cid:85)(cid:82)(cid:80)(cid:3)(cid:68)(cid:79)(cid:79)(cid:3)(cid:86)(cid:82)(cid:88)(cid:85)(cid:70)(cid:72)(cid:86)(cid:17)(cid:38)(cid:68)(cid:79)(cid:70)(cid:88)(cid:79)(cid:68)(cid:87)(cid:72)(cid:3)(cid:85)(cid:72)(cid:86)(cid:88)(cid:79)(cid:87)(cid:182)(cid:86)(cid:3)(cid:86)(cid:76)(cid:74)(cid:81)(cid:3)(cid:69)(cid:76)(cid:87)(cid:39)(cid:82)(cid:72)(cid:86)(cid:3)(cid:86)(cid:82)(cid:88)(cid:85)(cid:70)(cid:72)(cid:3)(cid:37)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:80)(cid:72)(cid:68)(cid:81)(cid:3)(cid:49)(cid:68)(cid:49)(cid:38)(cid:68)(cid:79)(cid:70)(cid:88)(cid:79)(cid:68)(cid:87)(cid:72)(cid:3)(cid:49)(cid:68)(cid:49)(cid:3)(cid:87)(cid:82)(cid:3)(cid:85)(cid:72)(cid:87)(cid:88)(cid:85)(cid:81)(cid:60)(cid:72)(cid:86)(cid:51)(cid:68)(cid:70)(cid:78)(cid:3)(cid:41)(cid:79)(cid:82)(cid:68)(cid:87)(cid:49)(cid:82)(cid:39)(cid:82)(cid:72)(cid:86)(cid:3)(cid:86)(cid:82)(cid:88)(cid:85)(cid:70)(cid:72)(cid:3)(cid:36)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:80)(cid:72)(cid:68)(cid:81)(cid:3)(cid:71)(cid:72)(cid:81)(cid:82)(cid:85)(cid:80)(cid:68)(cid:79)(cid:39)(cid:82)(cid:72)(cid:86)(cid:3)(cid:86)(cid:82)(cid:88)(cid:85)(cid:70)(cid:72)(cid:3)(cid:37)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:80)(cid:72)(cid:68)(cid:81)(cid:3)(cid:71)(cid:72)(cid:81)(cid:82)(cid:85)(cid:80)(cid:68)(cid:79)(cid:49)(cid:82)(cid:38)(cid:68)(cid:79)(cid:70)(cid:88)(cid:79)(cid:68)(cid:87)(cid:72)(cid:3)(cid:81)(cid:72)(cid:90)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:68)(cid:81)(cid:71)(cid:3)(cid:80)(cid:68)(cid:81)(cid:87)(cid:76)(cid:86)(cid:86)(cid:68)(cid:3)(cid:73)(cid:82)(cid:85)(cid:3)(cid:81)(cid:82)(cid:85)(cid:80)(cid:68)(cid:79)(cid:76)(cid:93)(cid:72)(cid:71)(cid:3)(cid:36)(cid:60)(cid:72)(cid:86)(cid:60)(cid:72)(cid:86)(cid:38)(cid:68)(cid:79)(cid:70)(cid:88)(cid:79)(cid:68)(cid:87)(cid:72)(cid:3)(cid:81)(cid:72)(cid:90)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:68)(cid:81)(cid:71)(cid:3)(cid:80)(cid:68)(cid:81)(cid:87)(cid:76)(cid:86)(cid:86)(cid:68)(cid:3)(cid:73)(cid:82)(cid:85)(cid:3)(cid:81)(cid:82)(cid:85)(cid:80)(cid:68)(cid:79)(cid:76)(cid:93)(cid:72)(cid:71)(cid:3)(cid:37)(cid:36)(cid:71)(cid:71)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:86)(cid:48)(cid:88)(cid:79)(cid:87)(cid:76)(cid:83)(cid:79)(cid:92)(cid:3)(cid:80)(cid:68)(cid:81)(cid:87)(cid:76)(cid:86)(cid:86)(cid:68)(cid:86)(cid:49)(cid:82)(cid:39)(cid:82)(cid:72)(cid:86)(cid:3)(cid:85)(cid:72)(cid:86)(cid:88)(cid:79)(cid:87)(cid:3)(cid:72)(cid:91)(cid:83)(cid:82)(cid:81)(cid:72)(cid:81)(cid:87)(cid:3)(cid:80)(cid:72)(cid:68)(cid:81)(cid:3)(cid:49)(cid:68)(cid:49)(cid:3)(cid:82)(cid:85)(cid:3)(cid:71)(cid:72)(cid:81)(cid:82)(cid:85)(cid:80)(cid:68)(cid:79)(cid:53)(cid:82)(cid:88)(cid:81)(cid:71)(cid:3)(cid:87)(cid:82)(cid:3)(cid:81)(cid:72)(cid:68)(cid:85)(cid:72)(cid:86)(cid:87)(cid:3)(cid:72)(cid:89)(cid:72)(cid:81)(cid:39)(cid:72)(cid:81)(cid:82)(cid:85)(cid:80)(cid:68)(cid:79)(cid:76)(cid:93)(cid:72)(cid:3)(cid:85)(cid:72)(cid:86)(cid:88)(cid:79)(cid:87)(cid:44)(cid:86)(cid:3)(cid:85)(cid:72)(cid:86)(cid:88)(cid:79)(cid:87)(cid:3)(cid:49)(cid:68)(cid:49)(cid:60)(cid:72)(cid:86)(cid:49)(cid:82)(cid:38)(cid:68)(cid:79)(cid:70)(cid:88)(cid:79)(cid:68)(cid:87)(cid:72)(cid:3)(cid:49)(cid:68)(cid:49)(cid:3)(cid:87)(cid:82)(cid:3)(cid:85)(cid:72)(cid:87)(cid:88)(cid:85)(cid:81)(cid:49)(cid:82)(cid:38)(cid:68)(cid:79)(cid:70)(cid:88)(cid:79)(cid:68)(cid:87)(cid:72)(cid:3)(cid:49)(cid:68)(cid:49)(cid:3)(cid:87)(cid:82)(cid:3)(cid:85)(cid:72)(cid:87)(cid:88)(cid:85)(cid:81)(cid:49)(cid:82)(cid:60)(cid:72)(cid:86)(cid:60)(cid:72)(cid:86)Figure6.Thecontrolﬂowgraphofa64bitﬂoatingpointmultiplyassumingroundtonearesteven.AandBarethetwoinput64bitﬂoatingpointnumbers.Ascanbeseen,thereisalotofbranchingassociatedwithspecialcasesforNaNanddenormalizedresultsorsources.Ingeneralthesecasesarerare,andthepaththatshouldbeoptimizedforisthecasewheretheinputsareneitherNaNnordenormalized,andtheresultingﬂoatingpointnumberisneitheraNaNnordenormalized.Byoptimizingfortheexpectedpath,withagoodbranchpredictorwhichwouldbeabletodeterminethatNaNsanddenormalsarenotexpectedcases,itispossibletoimplementamuchsimplersolutionformanualtraces.Withcurrentcompilertechnology,itisinfeasibletoperformthedynamicanalysistoﬁgureoutifNaNsordenormalsareexpected,theoptimizationofthetracedownthisexpectedpathisanotheroptimizationthatisdone.IftheIEEEﬂoatingpointexceptionsareneeded,mostofthemaredeterminedalongthespecialcasepathsaswell.Theﬂoatingpointinexactexceptionisdeterminedifroundingisneededatallandcanbedonefairlyquicklyalongthemainpathifnecessary.4.EvaluationForthispaper,PTLSim[23]isusedasacycle-accuratex86/amd64simulatorforevaluationofEmμcodeanddirectexecutionofx86/amd64instructions.PTLSimimplementsasuperscalararchitecturesimilartotheIntelPentium4[9].Thechangesaredescribedin2.2.SoftFloat2b,asimplementedbyHauser[8],isanimple-mentationlibraryofﬂoatingpointarithmeticusingonlyin-tegerinstructionsthatfollowstheIEEEbinaryﬂoatingpointstandard[1].SoftFloat2bincludesasoftwareimplemen-tationof32bit,64bit,80bit,and128bitﬂoatingpointarithmeticoperations.SoftFloat2bhasdeﬁneditsownsetoffunctionstocalculateintegermultiplies,aspecialkindofrightshiftcalledajammingrightshift,denormalizingﬂoat-ingpointnumbers,androunding.ItincludessupportforallfourIEEEﬂoatingpointroundingmodes,alloftheIEEEﬂoatingpointexceptions,andproperNaNresolution.SinceitincludeseverythingnecessarytoimplementanykindofIEEEﬂoatingpointarithmeticfromabasesetof32bitin-tegers,itisaperfectmatchforthekindofmicrocodetracesneededtoimplementEmμcode.SoftFloat2bwasthebasisforcreatingEmμcodetraces.Whencreatingthenaivetraces,SoftFloat2bwascompiledundergcc-03withinlinefunctionsturnedon.Whencreat-ingthehandoptimizedtraces,SoftFloat2bwasusedasareferenceforwhatneededtobedone.EmμcodeprovidestheaccuracyspeciﬁedintheIEEEstandard,SoftFloat2bprovidesthisaswell,allthreemethodsproducedthesameanswerfortheresultspresented.4.1.TraceEvaluationAmicrobenchmarkisusedinordertoevaluatespe-ciﬁcEmμcodetraceimplementations.Themicrobench-markconsistsofinvokingarandomnumbergeneratortocreatearandomsetofﬂoatingpointvalues.Thesevaluesaredesignedtohavearandomsign,arandomexponentbe-tweenzeroand32forsingleprecisionﬂoatingpointnum-bersorzeroand64fordoubleprecisionﬂoatingpointnum-bers,andarandommantissa.Thewindowfornumberofexponentsisdonetoensurethatwhenexecutingaﬂoatingpointadd,theresultisnotexactlythesameasoneofthetwosources,sincethefullspectrumofexponentswouldre-sultinmanyofthesecases.Figure7showstheresultsofthesemicrobenchmarksforthetwotypesoftracescreated.Alloftheseinstructionstakesixcyclesnatively.Themanualtraceimplementationsresultinonly6xslowdown978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE
464
Authorized licensed use limited to: Tsinghua University. Downloaded on March 20,2021 at 09:58:33 UTC from IEEE Xplore.  Restrictions apply. 
BenchmarkSingleSingleSingleDoubleDoubleDoublePrecisionPrecisionPrecisionPrecisionPrecisionPrecisionAdd(%)Sub(%)Mul(%)Add(%)Sub(%)Mul(%)equake0003.293.654.62vpr0.3700.640.3500ammp0008.197.2814.12swim00016.363.6419.99applu00012.802.8515.25mesa0.820.421.19000.15mgrid00019.256.832.83mcf000000Table1.Percentofarithmeticoperationsperformedduringthe5millioninstructionwindow40506070sOptimized EmucodeHardware0102030MULSSADDSSSUBSSMULSDADDSDSUBSDCyclesFigure7.TheaveragenumberofcycleseachoftheinstructionstakestoexecuteinOpti-mizedEmμcode.forthetwokindsofmultipliesand10xslowdownforthetwokindsofadds.Therearequiteafewbranchesintheimplementationoftheﬂoatingpointaddandsubtractinstructionswhichde-gradeperformance.Therearetwohard-to-predictbranchesintheaddinstructions:ﬁrst,thesignofthetwosources,whichdetermineswhethertheinstructionwilladdorsub-tractthetwonumbers,andsecond,whichsourcehasthelargerexponent,whichdetermineswhichmantissatoshift.Ifthebranchpredictoriscorrectitwilltakeonly33cy-cles,ifwrongthenextlowestis46cyclesformispredict-ingthelargerexponent,then57cyclesformispredictingwhetherthesignsagree,lastis68cyclesformispredictingboth.Sincethereissuchapenalty,morepredicationsup-portcoulddrasticallyimproveperformance.50607080n (X)Naïve EmucodeOptimized Emucode010203040mcfvprmesaequakeappluammpswimmgridSlowdownFigure8.Performanceimpactoftraceopti-mizations.4.2.ProgramResultsWegatherresultsfromSPECbenchmarksbeingsimu-latedinsidePTLSimmodiﬁedtosupportEmμcode.Ta-ble1showsthedynamicnumberofarithmeticoperationsencountered.TheresultsoftheoptimizationofthetracescanbeseeninFigure8.Thenaiveversionsexhibitagreatdealmoreslowdownthantheoptimizedversions.TheresultsarearrangedintheorderofslowdownresultingfromtheoptimizedEmμcodetraces.Thenotableexceptionisthemgridtrace,whichisonlyabout1.5xworsethantheop-timizedtraces.Thereasonforthisisbecausemgridin-volvesmanyoperationswhereoneormoreofthesourceparametersis0.0.Sincetheresultoftheoperationisknownoncethezerohasbeendetected,thisisanearlyexitpathforthenaivetraces,whichwillnotperformanyofthearith-meticoperationsuntilafterthiscaseisexcluded.Forthe978-1-4244-4421-2/09/$25.00 c(cid:13)2009 IEEE