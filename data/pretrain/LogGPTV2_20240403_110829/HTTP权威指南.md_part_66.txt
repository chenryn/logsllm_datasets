17.5.3 内容注入
前面描述的两类转码通常会减少Web文档的内容，但还有另一类转换会增加文档的
内容，即内容注入转码。内容注入转码的例子有自动广告生成器和用户追踪系统。
设想一下，一个能往途经的每个HTML页面中自动添加广告的广告植入转码器是多
么的诱人（当然也很烦人）。这类转码操作只能动态进行——它必须即时添加与当前
的特定用户有关，或针对特定用户的广告。也可以构建用户追踪系统，在页面中动
态增加内容，用于收集用户查看页面和客户端浏览方式的统计信息。
17.5.4 转码与静态预生成的对比
转码的替代做法是在Web服务器上建立Web页面的不同副本，例如一个是HTML，
一个是WML；一个图像分辨率高，一个图像分辨率低；一个有多媒体内容，一个
没有。但是，这种方法不是很切合实际，原因很多：某个页面中的任何小改动都会
牵扯很多页面，需要很多空间来存储各页面的不同版本，而且使页面编目和Web
服务器编程（以提供正确的版本）变得更加困难。有些转码操作，比如广告插入
（尤其是定向广告插入），就不能静态实现——因为插入什么广告和请求页面的用户
有关。
对单一的根页面进行即时转换，是比静态的预生成更容易的解决方案。但这样会在
提供内容时增加时延。不过有时候其中一些计算可以由第三方进行，这样就减少了
Web服务器上的计算负荷——比如可以由代理或缓存中的外部Agent完成转换。图
17-3显示了在代理缓存中进行的转码。
内容协商与转码 ｜ 423
GET / HTTP/1.1
Host: www.joes-hardware.com
User-agent: wimpy wireless device
Accept-language: fr;q=1.0
我有他想要的文档的法语版，
但我的副本中富含各种媒体，
而他用的却是低性能的无线
浏览器。我要把所有的多媒
Bonjour 体内容去掉再发送给他。
Web服务器
法语用户 Bonjour 转换器
缓存
我已经为这份文档做了
针对无线设备的转换， HTTP/1.1 200 OK
我要把转换后的副本作 Content-language: fr
为备用候选保存起来， Vary: User-agent
以备他人之需。
Bonjour
[...simple text content]
图17-3 在代理缓存中进行转换或转码
17.6 下一步计划
由于以下两个原因，内容协商这个话题不只限于Accept和Content这两个首部集。
• HTTP中的内容协商受到一些性能方面的限制。在各种变体中搜索合适的内容，
或尽力“猜测”最佳匹配，都会有很大开销。有没有什么办法能专注内容协商协
405 议以使这个过程更高效？RFC 2295和RFC2296尝试着对这个问题进行了研究，
以提供透明的HTTP内容协商。
• HTTP不是唯一需要进行内容协商的协议。在其他一些情况下，客户端也需要和
服务器交互以便获得对客户端请求来说最好的答案，流媒体和传真就是另外两个
例子。能否在TCP/IP应用层协议之上开发出通用的内容协商协议呢？内容协商
工作组（Content Negotiation Working Group）就是专门为这个问题而成立的。这
个工作组目前已经停止工作了，不过它提出了若干个RFC。在下一节中，我们给
出了这个组的网站链接。
17.7 更多信息
从下面的因特网草案和在线文档中可以获得更多内容协商方面的信息。
424 ｜ 第17章
• http://www.ietf.org/rfc/rfc2616.txt
RFC 2616，“Hypertext Transfer Protocol-HTTP/1.1”（“超文本传输协议HTTP/1.1”），
这是HTTP协议的当前版本，也是HTTP/1.1的官方规范。这份规范行文流畅、
组织良好，是份详实的HTTP参考文献。不过对那些希望学习HTTP背后的各种
概念和决策动机、弄清理论与实践不同之处的读者来说，它就不是很理想了。我
们希望本书能补足背后的这些概念，使读者能更好地利用这份规范。 406
• http://www.ietf.org/rfc/rfc2295.txt
RFC 2295，“Transparent Content Negotiation in HTTP”（“HTTP中的透明内容协
商”），这是一份备忘录，描述了建立在HTTP之上的透明内容协商协议。这份备
忘录目前还是实验性的。
• http://www.ietf.org/rfc/rfc2296.txt
RFC 2296,“HTTP Remote Variant Selection Algorithm RVSA 1.0”（“HTTP远程
变体选择算法RVSA1.0”），这份备忘录描述了为特定的HTTP请求透明地选择
“最佳”内容的算法。这份备忘录目前还是实验性的。
• http://www.ietf.org/rfc/rfc2936.txt
RFC 2936,“HTTP MIME Type Handler Detection”（“HTTP MIME类型处理器检
测”），这份备忘录描述了一种用来判定浏览器支持的MIME类型处理器的方法。
如果Accept首部不够明确的话，这种方法就能派上用场。
• http://www.imc.org/ietf-medfree/index.htm
这个链接指向内容协商（简称CONNEG）工作组网站。该工作组专注于HTTP、
传真和打印方面的透明内容协商。这个工作组目前已停止工作。 407
内容协商与转码 ｜ 425
第五部分
内容发布与分发
第五部分讲述了Web内容发布和传播的各种技术。
• 第18章介绍了在现代的Web托管环境中部署服务器的若干方法，HTTP对虚拟
Web托管的支持以及如何在地理上相距遥远的服务器之间复制内容。
• 第19章讨论了创建Web内容并将其放置到Web服务器上去的各种技术。
• 第20章探讨了各种将来访的Web流量分发到一组服务器上的技术和工具。 408
~
• 第21章解释了日志的各种格式和各种常见问题。 410
第18章
主机托管
Web
429
当你把资源放在公共的Web服务器上时，因特网社区就可以使用它们了。这些资源
可以是简单的文本文件或图像，也可以是复杂的实时导航地图或电子商务购物网关。
能够将这些由不同组织拥有的种类繁多的资源便利地发布到网站上，并将其放置在
能以合理价格提供很好性能的Web服务器上，是很关键的。
对内容资源的存储、协调以及管理的职责统称为Web主机托管。主机托管是Web
服务器的主要功能之一。保存并提供内容，记录对内容的访问以及管理内容都离不
开服务器。如果不想自行管理服务器所需的软硬件，就需要主机托管服务，即托管
者。托管者出租服务和网站管理维护业务，并提供各种不同程度的安全级别、报告
及易用性。托管者通常把很多网站放在一些强大的Web服务器上联合运行，这样可
以获得更高的成本效益、可靠性和性能。
本章讲解Web主机托管服务中的某些重要特征和它们如何与HTTP应用程序交互。
本章的主要内容包括：
• 不同的网站如何被“虚拟地托管”在同一个服务器上，这样会对HTTP产生怎样
的影响；
• 在很大的流量压力下，如何确保网站更可靠；
• 如何使网站加载更快。
18.1 主机托管服务
在万维网的早期，每个组织自行购买自己的计算机硬件，搭建自己的计算机房，申
请自己的网络连接，并管理自己的Web服务器软件。
随着Web迅速成为主流，每人都想要一个网站，但很少有人有能力或时间来搭建带
411 空调的服务器机房，注册域名，或购买网络带宽。为了满足人们的迫切需求，出现
了很多新的企业，提供了专业化管理的Web主机托管服务。服务级别有多种，从物
理上的设备管理（提供空间、空调以及线缆）到完整的Web主机托管，顾客只需要
提供内容就行了。
本章主要探讨托管Web服务器要提供什么服务。网站运作需要的很多东西（例如，
它支持不同语言的能力和进行安全的电子商务交易的能力）都取决于托管Web服务
器提供的功能。
简单例子——专用托管
假设Joe的五金商店和 Mary的古董拍卖店都需要大容量的网站。Irene网络服务提供
商那里有很多机架，机架上全是一样的高性能Web服务器，可以租给Joe和Mary，
430 ｜ 第18章
这样，他俩就不用自行购买自己的服务器并管理服务器软件了。
在图18-1中，Joe和Mary都签约使用Irene的网络服务提供商提供的专用Web托
管服务。Joe租了专用的Web服务器，该服务器是Irene网络服务提供商购买和维
护的。Mary也从Irene网络服务提供商那里租了另一个专用服务器。Irene网络服务
提供商大批量地购买服务器硬件，它们选择的硬件经久耐用且相对便宜。如果Joe
或Mary的网站变得更受欢迎，Irene网络服务提供商可以立刻给Joe或Mary提供
更多的服务器。
Irene的网络服务提供商
www.joes-hardware.com 内容
Joe
www.cajun-gifts.com
客户端 因特网
www.marys-antiques.com 内容
客户端 Mary
www.irenes-isp.com
图18-1 外包的专用托管服务
在这个例子中，浏览器向Joe服务器的IP地址发送对www.joes-hardware.com 的
HTTP请求，向Mary服务器（不同于Joe）的IP地址发送对www.marys-antiques.
com 的请求。 412
18.2 虚拟主机托管
许多人想要在Web上展现自己，但他们的网站流量都不大。对这些人来说，使用专
用的Web服务器可能有点儿大材小用，因为他们每月花费数百美元租来的服务器大
部分时间都是空闲的！
许多Web托管者通过让一些顾客共享一台计算机来提供便宜的Web主机托管服务。
这称为共享主机托管或虚拟主机托管。每个网站看起来是托管在不同的服务器上，
但实际上是托管在同一个物理服务器上。从最终用户的角度来看，被虚拟托管的网
站应当和托管在专用服务器上的网站没什么区别。
从成本效益、空间以及管理方面考虑，提供虚拟主机托管的公司希望能在同一个
Web主机托管 ｜ 431
服务器上托管数十、上百，甚至上千个网站——但这不一定意味着上千个网站是
用一台PC机来提供服务的。托管者可以创建成排同样的服务器，称为服务器集群
（server farm），把负载分摊在群里的服务器上。因为群里的每台服务器都一样，并
且托管了许多虚拟网站，所以管理起来更加方便。（我们将在第20章更详细地介绍
服务器集群。）
当Joe和Mary刚开始商务运作时，他们可能会选择虚拟主机托管，以节省费用，
直到他们网站的流量规模达到值得使用专用服务器的水平为止（参见图18-2）。
内容
Irene的网络
服务提供商 Joe
www.joes-hardware.com
www.marys-antiques.com
内容
www.cajun-gifts.com
客户端 Mary
因特网
客户端
www.irenes-isp.com
图18-2 外包的虚拟主机托管
18.2.1 虚拟服务器请求缺乏主机信息
不幸的是，HTTP/1.0中的一个设计缺陷会使虚拟主机托管者抓狂。HTTP/1.0规范中
413 没有为共享的Web服务器提供任何方法来识别要访问的是所托管的哪个虚拟网站。
回想一下，HTTP/1.0请求在报文中只发送了URL的路径部分。如果要访问http://
www.joes-hardware.com/index.html，浏览器会连接到服务器 www.joes-hardware.
com，但HTTP/1.0请求中只提到GET /index.html，没有提到主机名。如果服务器
虚拟托管了多个站点，就没有足够的信息能指出要访问的是哪个虚拟网站。图18-3
就是这样的一个示例。
• 如果客户端 A 试图访问 http://www.joes-hardware.com/index.html，请求 GET /
index.html将被发送到共享的Web服务器。
• 如果客户端B试图访问http://www.marys-antiques.com/index.html，同样的请求
GET /index.html也将被发送到共享的Web服务器。
432 ｜ 第18章
(A想访问http://www.joes-hardware.com/index.html)
www.voting-info.gov
GET /index.html HTTP/1.0
www.joes-hardware.com
User-agent: SuperBrowser v1.3
www.marys-antiques.com
客户端A 因特网
/voting /mary /joe
客户端B
GET /index.html HTTP/1.0 HTTP/1.0请求没有包含主机名信息，因此
User-agent: WebSurfer 2000
不能支持托管了多个网站的Web服务器。
(B想访问http://www.marys-antiques.com/index.html)（HTTP/1.1支持的Host首部解决了这个问题。）
图18-3 HTTP/1.0服务器请求中没有主机名信息
就Web服务器而言，没有足够的信息可供其判断究竟要访问的是哪个网站。尽管请
求的是完全不同的文档（来自不同的网站），但这两个请求看起来是一样的，这是因
为网站的主机信息已经从请求中剥离了。
我们已经在第6章中介绍过，HTTP替代物（反向代理）和拦截代理也都需要明确
的站点信息。