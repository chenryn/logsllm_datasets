  4. 节点收到新的区块信息后，验证区块合法性，合法后将其添加到区块链尾部，并进入下一轮的竞争
通过 PoW 算法，比特币可以允许全网有 50% 的节点错误的情况下，依然能够完成共识。
  * PoW 算法的实现
PoW 算法位于区块生成的模块中(挖矿)。我们先看看比特币的启动流程，比特币程序入口位于 `bitcoind.cpp`
下，通过这样的调用链启动比特币中的各项服务：
    main()->AppInit()->AppInitMain()
其中包括 RPC 服务，在比特币中我们需要使用 `bitcoin-cli` 通过 RPC 服务启动挖坑，最终到
`rpc/mining.cpp/generateBlocks()` 这个区块生成主逻辑：
其中 `pow.cpp/CheckProofOfWork()` 函数进行了 PoW 算法的验证，主要是判断在当前 `nonce`
值的情况下，区块哈希值是否小于难度值：
**其他**  
但由于 PoW 算法性能低下、而且会造成大量的算力浪费，大家纷纷提出新的共识算法，如
PoS(股权权益证明)、DPoS(委托权益人证明机制)，等等；但以比特币占据区块链项目的半壁江山来看，PoW 仍是目前用得最多的共识算法。
### 0x05 存储结构
在了解共识算法后，我们可以保证数据的一致性了，那么这些数据是如何在区块链中存储的呢？
**Merkle树**  
在比特币中，使用 Merkle 树组织和存储一个块内的交易信息，它是一种基于哈希的二叉树(或多叉树)，其结构如下：
  1. 叶子节点存储数据
  2. 非叶子节点存储其子节点的内容的哈希值
使用 Merkle 树的优势所在：
  1. 快速比较大量数据，比较根节点的哈希值即可知道两组数据是否相同
  2. 快速定位修改，任何子节点的变动都会传递至根节点，从根节点向下检索即可找到修改的节点。
  3. Merkle 树实现 在比特币中，Merkle 树的生成是挖矿步骤中的子步骤，跟入上文中的区块生成流程中的 `miner.cpp/IncrementExtraNonce()` 函数中，在该函数中调用 `consensus/merkle.cpp/BlockMerkleRoot()` 函数以构建 Merkle 树：
**哈希链**  
在一个区块中，除了打包成Merkle树的交易信息，还包括块高度、随机数、时间等等信息，其中 **父块哈希值** 将各个区块联系起来，形成链式结构，如下：
  * 哈希链实现
在比特币中，区块由区块头和 Merkle 交易树组成，区块头数据结构定义在 `primitives/block.h`，如下：
### 0x06 网络通信
那么在区块链中，各个节点之间是如何传递数据的呢？相对于分布式数据库 server-client 网络结构，采用主从复制的方式同步数据，区块链则是 peer-to-peer 的网络结构，节点在获取数据的同时，还需要提供数据给其他节点。
我们直接来看看比特币中 p2p 协议的实现方式。
  * p2p 协议的实现方式
在比特币中，默认在 `8333` 端口建立 tcp 监听，启动 p2p 服务。在 `bitcoind` 启动流程的
`init.cpp/AppInitMain()` 中，对网络进行了初始化启动：
    [init.cpp/AppInitMain()]
    1.node.connman->Start()
      启动节点入口，网络初始化和建立
    [net.cpp/Start()]
    2.InitBinds()
      建立网络监听
    3.AddOneShot()
      添加种子节点
    4.&TraceThread<>......
      启动五个网络处理线程
p2p网络处理流程就由这五个线程进行负责：
其中负责 p2p 协议处理的线程就是 `ThreadMessageHandler()`
线程，我们主要来看看这一部分的流程；在该线程中尝试对每个节点接收数据，接收到数据就如下的调用流程：
    [net_processing.cpp]
    ProcessMessages()->ProcessMessage()
在 `ProcessMessages()` 对协议格式进行判断，比特币中 p2p 协议格式如下：
随后进入到 `ProcessMessage()` 进行实际的消息处理流程，在该函数中主要逻辑是多个 `if-else` 语句根据 `commmand`
进入不同的消息的处理流程，支持的消息有：
每个命令下都有不同报文格式和处理逻辑，比特币通过这样的方式，打通了节点间的通道。
### 0x07 总结
通过本文我们在脱离数字货币的情况下，从分布式数据库的角度，聊了些区块链中的几个技术点，了解到区块链与传统分布式的异同之处，也了解到区块链中的基本概念和原理。
区块链的去中心化、不可篡改性的特性，给我们提供了无限的遐想，但目前还没有公开的、完善的区块链项目出现，我们希望这一天能早点到来。
References:  
1\. 《区块链技术指南》  
2\. 《白话区块链》  
3\. 《区块链原理、设计与应用》  
4\.   
5\.   
6\.   
7\.   
8\.   
9\.   
10\.
11\. 
* * *