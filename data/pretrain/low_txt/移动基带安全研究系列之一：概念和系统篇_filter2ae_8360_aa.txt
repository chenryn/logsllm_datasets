# 移动基带安全研究系列之一：概念和系统篇

##### 译文声明
本文是翻译文章，原文作者为谢君，来源于谢君。具体内容表达及含义以原文为准。
作者：谢君（阿里安全）

## 背景
随着5G技术的迅猛发展，万物互联的时代即将到来。移动基带系统作为连接世界的桥梁，将成为重要的基础设施。基础技术的自主能力已上升至国家战略层面，例如美国对华为的禁令凸显了这一点。目前，人类的生产和生活离不开移动通信，未来它将继续引领科技发展。人工智能、自动驾驶、物联网等领域的进步都与移动通信息息相关。因此，其安全性和可靠性成为亟待解决的重要问题。这也是笔者撰写本系列文章的初衷，希望更多的安全研究人员参与进来，发现并修复潜在的安全隐患，提升基础设施的安全性。

## 概念和研究目的
3GPP（第三代合作伙伴项目）是一个成立于上世纪末的标准化组织，主要负责制定移动通信的技术标准，确保不同国家和地区运营商之间的兼容性。最常见的例子是让手机可以在不同国家漫游使用。3GPP制定了2G、3G、4G和5G通信相关的技术标准，并提供了大量的技术文档供研究人员参考。这些资料可在3GPP官方网站上获取。

本系列文章的研究对象为3GPP定义的2G、3G、4G和5G移动通信相关软硬件及其通信系统，如手机的语音/短信/数据流量以及物联网设备中的相关移动通信技术。基带系统泛指无线通信系统中的软硬件和技术集合体，例如蓝牙、Wi-Fi和GSM都有各自的基带系统。但本文特指与移动通信相关的基带系统。

### 研究对象和目的
研究重点包括高通的基带芯片及其对3GPP定义的通信协议栈实现。基带系统是一个庞大且复杂的体系，涵盖软硬件和通信技术。具备此类设计能力的厂商不多，其中高通占据了最大的市场份额。小米、OPPO/VIVO等国内手机厂商均采用高通芯片。华为则基于自家海思芯片开发了基带系统，打破了国外市场的垄断。尽管如此，华为仍在使用VxWorks操作系统，但新发布的鸿蒙微内核系统有望改变这一局面。鉴于各家基带系统的封闭性及移动通信的复杂性，本研究旨在揭示其中的设计逻辑，结合3GPP协议更好地理解整个系统的运作机制，并深入挖掘潜在的安全威胁。

[图片来源](https://www.businesswire.com/news/home/20180731005614/en/Strategy-Analytics-Q1-2018-Baseband-Market-Share)

### 研究方法
本系列文章将围绕高通基带系统对3GPP协议栈的实现展开，通过以下层次进行：
1. **操作系统**
2. **应用系统**
3. **3GPP协议栈实现**
4. **攻击面分析及缺陷挖掘**

封闭的基带系统需要大量逆向工程工作来了解其内部行为。当无法获取目标对象的源代码或设计文档时，逆向工程是获取设计逻辑、原理和算法的有效手段。逆向工程分为软件和硬件两部分，本文主要讨论软件层面的逆向工程。由于基带系统与硬件紧密相连，对其进行逆向工程还需具备一定的硬件知识。根据难度等级，高通MDM系列芯片的研究难度大约在L3级别。

## 高通基带硬件系统介绍
高通基带硬件按功能分为两类：
1. **MSM系列**（移动站调制解调器）：主要用于手持移动通信设备，如手机。
2. **MDM系列**（移动数据调制解调器）：用于移动数据流量设备，如车联网和其他物联网设备。

### MSM系列与MDM系列的区别
- **MSM系列**：集成了应用处理器（AP）、基带处理器（BP）以及Wi-Fi、蓝牙等功能模块，提供完整的手机解决方案。大多数Android手机运行在高通MSM系列SoC上，例如小米5搭载的骁龙S820 SoC即属于MSM8996系列。
- **MDM系列**：早期仅包含基带处理器，提供数据调制解调和语音服务，在苹果手机生态、车联网等领域常见。例如iPhone 8/8 Plus和iPhone X配备的是高通MDM9655基带芯片；宝马、奥迪车联网TBOX则使用MDM6x00系列芯片。为了增强处理能力，MDM系列SoC分离了基带和业务系统，由两个核心组成：Hexagon DSP基带处理核心和ARM Cortex-A系列核心。

从功能上看，MSM系列包含了MDM系列的所有功能。因此，高通MDM系列的基带处理器实际上是由三个核心组成的：
1. 基于ARM架构的微处理器子系统（如MDM6600的ARM1136和MDM9215的ARM Cortex-A5+Hexagon DSP）
2. 基于高通Hexagon QDSP架构的Modem DSP (mDSP)
3. 基于高通Hexagon QDSP架构的应用DSP (aDSP)

这三个核心的主要功能如下：
1. ARM微处理器子系统协助mDSP和aDSP初始化，实现3GPP协议栈功能和算法，也可作为特定应用处理平台。
2. mDSP负责无线信号的调制与解调。
3. aDSP负责与应用相关的信号处理，如语音编码与解码。

下图为高通MDM系列基带芯片的一些特性：
![高通MDM系列基带芯片特性](https://www.qualcomm.com/content/dam/qcom/en/images/features/mobile-data-modems-mdm-series.jpg)

## 高通基带软件系统介绍
自2000年起，高通就开始使用自主研发的嵌入式RTOS系统REX构建手机基带应用系统AMSS。该架构沿用至今。为了保证良好的移植性和兼容性，基带底层采用了开源微内核系统OKL4。针对新的Hexagon DSP处理器，高通开发了QuRT嵌入式微内核系统。我们重点关注的是运行在REX上的AMSS应用。

### 微内核的优势
微内核系统只需满足基本的IPC通信机制、内存管理和CPU调度机制即可，驱动文件系统等组件可在用户态完成初始化。这使得高通能够高效支持多个硬件平台。下图展示了高通的系统架构：

基带软件系统主要包括以下部分：
1. 启动管理
2. 内存管理
3. 文件系统
4. 定时器机制
5. 任务管理和IPC通信机制
6. 中断管理

#### 基带系统启动过程
高通基带芯片引入了secure boot机制，防止启动过程中代码或数据被篡改。芯片上电后，首先由BootRom接管，检测是否从flash启动。如果从flash启动，则读取第一个扇区的数据到内存，搜索secureboot启动头信息，解析头部结构，验证签名和证书。验证成功后，DBL代码接管执行，继续验证其他分区数据，直至完成整个信任链。

以下是DBL头部区域的信息示例：
- 0x00 – CodeWord (“D1 DC 4B 84”)
- 0x04 – Magic (“34 10 D7 73”)
- 0x14 – Body start offset (0x2050)
- 0x18 – Loading address (0x20012000)
- 0x1C – Body size (Code + Signature + Certificate store size)
- 0x20 – Code size
- 0x24 – Signature address
- 0x28 – Signature length (256 bytes)
- 0x2C – Certificate store address
- 0x30 – Certificate store length

每个分区表信息长度为0x1c，例如：
- 0x00 – CodeWord (“AA 73 EE 55”)
- 0x04 – Magic (“DB BD 5E E3”)
- 0x0C – Partition Nums (0xa)