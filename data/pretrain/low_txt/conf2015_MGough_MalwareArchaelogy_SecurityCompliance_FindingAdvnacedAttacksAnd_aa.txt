# Copyright © 2015 Splunk Inc.

## Finding Advanced APTs and Malware with Only 6 Windows EventIDs

**Speaker:** Michael Gough  
**Title:** Malware Archaeologist, MalwareArchaeology.com  
**Twitter:** @HackerHurricane

### Disclaimer
- The information in this presentation and the opinions expressed are my own and do not reflect those of my current or past employers.
- During this presentation, forward-looking statements may be made regarding future events or the expected performance of the company. These statements reflect our current expectations and estimates based on factors currently known to us. Actual events or results could differ materially. For important factors that may cause actual results to differ from those contained in our forward-looking statements, please review our filings with the SEC.
- The forward-looking statements made in this presentation are as of the time and date of its live presentation. If reviewed after its live presentation, this presentation may not contain current or accurate information. We do not assume any obligation to update any forward-looking statements we may make.
- Any information about our roadmap outlines our general product direction and is subject to change at any time without notice. It is for informational purposes only and shall not be incorporated into any contract or other commitment. Splunk undertakes no obligation to develop the features or functionality described or to include any such feature or functionality in a future release.

### Agenda
1. **Introduction**
2. **Real Hacks Caught in Action, with Logs!**
3. **What Can We Do with Logs?**
   - Takeaway #1: The 6 Event IDs Everyone Must Monitor and Alert On
   - Takeaway #2: Enable Command Line Logging
   - Takeaway #3: Sample Queries
4. **Resources**
5. **Q&A**

### Introduction
**Personal Introduction:**
- **Michael Gough, Malware Archaeology**
- **Roles:**
  - Blue Team Ninja, Active Defense, Splunk Fu
  - Consultant, Training, Incident Response
- **Upcoming Training:**
  - Malware Discovery Training (Oct 5-6, Austin, TX - SecureIdeas)
  - Malware Discovery Training (Oct 14, Houston, TX - HouSecCon)
  - Windows Logging Training (Oct 16, Washington DC - BSidesDC)
- **Blog:** HackerHurricane.com
- **Twitter:** @HackerHurricane
- **Creator:**
  - Malware Management Framework
  - Windows Logging Cheat Sheet
- **Co-Creator:**
  - Log-MD (Log harvesting tool for malware analysis & incident response)

### Hackers, Malware, and Logs
- I am a logoholic.
- I love malware, malware discovery, and malware management.
- Once I find an infected system, what happened before I found it?
- Was there more than one system involved?
- Did the attacker do more?
- What behavior did the system or systems exhibit after the initial infection?
- Logs are the perfect partner to malware!

### Improving Security with Endpoint Data
- Endpoint data can help catch hackers as they exploit a system or move laterally in your environment.
- Properly enabled and configured endpoint data can dramatically improve your information security program.
- Endpoint data can help detect campaigns like WINNTI or lateral movement.

### Problem We Are Trying to Solve
- **Statistics:**
  - 1000+ Businesses
  - 145 Million
  - 990,000
  - 4.5 Million
  - You’re Next
  - 97,000
  - 395 Stores
  - 40+70 Million
  - ~ $758 Mil
  - 3 Million
  - 56 Mil
  - 40 Million
  - 60,000 alerts
  - 105k trans
  - 550,000
  - 76 Mil + 8 Mil
  - TBD
  - 76,000
  - 25,000
  - 35,000
  - 4.9 Million
  - 650k - 2010
  - Citigroup, E*Trade Financial Corp., Regions Financial Corp., HSBC
  - 670,000
  - 20,000
  - 33 locations
  - 4.03 Million
  - 1900 locations
  - Holdings and ADP

### Why Listen to Me?
- I have been there, in the worst way.
- Found malware quickly, discovered 10 months before the Kaspersky report.
- Needed more details: Who, What, Where, When, and How.
- Found logs were not fully enabled or configured, and couldn’t get the necessary data.
- Once the logs from endpoints were enabled and configured, we saw all kinds of cool stuff, showing the "How" that we all need.
- Created "The Windows Logging Cheat Sheet."

### Real Hacks Caught in Action
- **Commodity Malware in Raw Logs:**
  - Catch PowerShell logging bypass.
  - You Could Catch CryptoLocker.
  - Walkthrough of WinNTI:
    - **1st Slide:**
      - Launch part of the malware(s).
      - Hide malware payload in the Registry.
      - Modify an existing service to call malware.
    - **2nd Slide:**
      - Check the service.
      - Modify permissions of the malware.
      - Push out malware using CMD Shell and Cscript.
    - **3rd Slide:**
      - Update registry settings.
      - Push out the registry changes.
      - Change permissions on changed files.
    - **4th Slide:**
      - A little Recon.
      - Push malware to terminal services.
      - Query the users.
    - **5th Slide:**
      - Capture their credentials.

### 1 – Malware Infection
- Malware Launch
- Hide malware in the Registry
- Modify Service

### 2 – Escalate Permissions
- (Details to be added)