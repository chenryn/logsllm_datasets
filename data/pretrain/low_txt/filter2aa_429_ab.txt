# Shadowpad and Winnti APT41 Backdoors: Old and New

## Overview
This document provides an in-depth analysis of the Shadowpad and Winnti APT41 backdoors, including their configuration, decryption routines, and operational details. The information is sourced from various threat intelligence reports and research papers.

## Shadowpad Configuration Example

### General Information
- **ID:** 6/18/2021 11:26:19 AM
- **Messenger:** TEST
- **Binary Path:** `%ALLUSERSPROFILE%\Microsoft\WinLSAM\`
- **Binary Name:** `LSAM.exe`
- **Loader Name:** `log.dll`
- **Payload Name:** `log.dll.dat`
- **Service Name:** `SystemAssociationManager`
- **Service Display Name:** `System Association Manager`
- **Service Description:** This service provides support for the device association software. If this service is disabled, devices may be configured with outdated software and may not work correctly.
- **Registry Key Install:** `SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- **Registry Value Name:** `LocalSystemAssociationManager`

### Injection Targets
- **Inject Target 1:** `%windir%\system32\svchost.exe`
- **Inject Target 2:** `%windir%\system32\wininit.exe`
- **Inject Target 3:** (Empty)
- **Inject Target 4:** (Empty)

### Server and Socket Information
- **Supposed to have 4 servers:**
  - **Server1:** `TCP://1dfpi2d8kx.wikimedia.vip:443`
  - **Server2:** (Empty)
  - **Server3:** (Empty)
  - **Server4:** (Empty)
- **Socket 1:** `SOCKS4`
- **Socket 2:** `SOCKS4`
- **Socket 3:** `SOCKS5`
- **Socket 4:** `SOCKS5`

### DNS Information
- **DNS 1:** `8.8.8.8`
- **DNS 2:** `8.8.8.8`
- **DNS 3:** `8.8.8.8`
- **DNS 4:** `8.8.8.8`

### Decryption Routines
- **Shadowpad Decryption Routine (Old Version):** [Details]
- **Shadowpad Decryption Routine (New Version):** [Details]

## Natwalk Details

### Overview
- **Dropped by chatloader**
- **First seen in the wild in 2021/3, and first seen on VT in 2020/9**
- **Shellcode-based backdoor**
- **Uses register + offset to call the Windows API (also used by crosswalk)**
- **Unique file path:** `%AllUserProfile%\UTXP\nat\`
- **rbx:** `7FEF1431534`

### Transport Protocol
- **Raw TCP socket**
- **HTTPS: Post requests to C2 server**
- **gtsid:** Generated by `CryptGenRandom`
- **gtuvid:** Generated by `CryptGenRandom` and MD5 operation
- **Encryption/Decryption:** Uses ChaCha20 and MD5 for message encryption/decryption to/from the C2 server

### Commands
- **0x64:** Close sessions
- **0x5C:** Update the ChaCha20 key for C2 communication
- **0x66:** Change the current status
- **0x74:** Terminate all threads
- **0x78:** Kill process
- **0x7C:** Run plug-in
- **0x82:** Enumerate user info
- **0x8C:** Send config to C2
- **0x8E:** Load additional config

## HIGHNOON (Botdll64)

### Overview
- **Dll hijack**
- **IAT modify**
- **Decrypt payload with DPAPI/AES**
- **Packed with UPX in memory**

### Loader
- **DPAPI version**
- **AES version**
- **Driver selection based on `dwMinorVersion`**

### Command Details
- **Command is the same as the HIGHNOON mentioned by Macnica* in 2018**
- **0:** Bind Network Socket
- **1:** Check IP address change and Receive Packet, Console Output
- **3:** Console Output
- **4:** Read //DEV//NULL and Console Output
- **5:** Check IP address change and Receive Packet, Console Output

## C2 Hiding Techniques

### Domain Fronting
- **CDN service:** Direct use of CDN service to hide real C2 IP
- **Example:** `microgoogle[.]ml`
- **DNS beacon:** Parks their DNS beacon C2 domain on specific IPs, e.g., `8.8.8.251`, `4.2.2.2`
- **Cloudflare Worker:** Uses Cloudflare Workers as a redirector to hide the real C2 domain and IP

### Fastly (GroupCC)
- **BeaconType:** HTTPS
- **Port:** 443
- **SleepTime:** 1000
- **MaxGetSize:** 1398119
- **Jitter:** 10
- **PublicKey_MD5:** `9ee3e0425ade426af0cb07094aa29ebc`
- **C2Server:** `pypi.python.org,/latest/pip-check`
- **UserAgent:** `Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36`
- **HttpPostUri:** `/latest/check`

## Related Operations

### Fishmaster Operation – TAG-22
- **Funnyswitch dropper:** Injects Cobalt Strike
- **ITW Url:** [Link]
- **Connection to APT41 and Fishmaster operation**
- **New builder of Shadowpad**
- **IR case:** Same PDB string

### GroupCC
- **BIOPASS RAT Python Script (local online server)**
- **C1222 module**
- **Stolen certificates:**
  - **Quickteck.com:** Serial Number: `70 D8 96 11 7E 15 30 2C 7E EF EC B2 89 B3 BF E0`
  - **주식회사 엘리시온랩 (Elysion Lab Co., Ltd.):** Serial Number: `03 D4 33 FD C2 46 9E 9F D8 78 C8 0B C0 54 51 47`
  - **ARGOS LABS:** Serial Number: `00 F7 B7 5C 60 5B 00 83 95 73 8A AC 06 AB E3 B4 70`
  - **1.A Connect GmbH:** Serial Number: `00 A7 E4 DE D4 BF 94 9D 15 AA 42 01 84 3F 1A B6 4D`

### Shared Tools and TTPs
- **Shared Tool:** Biopass RAT
- **Similar TTPs:**
  - **Use of stolen or revoked certificates**
  - **Use of legitimate installers (like Flash, Silverlight, BrowserPlugin)**
  - **Use of aliyun as payload sites**

### Amoeba vs. Fishmaster vs. GroupCC
- **Amoeba vs. Fishmaster:**
  - **Two possibilities:**
    - **Shared C2:**
      - `163.138.137.235`
      - `93.180.156.77`
    - **Shared customized CobaltStrike:**
      - **Xor key:** `0x3A`
- **Fishmaster vs. GroupCC:**
  - **Shared Tool:** Biopass RAT
  - **Similar TTPs:**
    - **Use of stolen or revoked certificates**
    - **Use of legitimate installers**
    - **Use of aliyun as payload sites**

### HW Operation (护网行动)
- **Objective:** To detect security issues in key national infrastructure and test event monitoring and emergency response coordination
- **Targets:** Various industries, including government, finance, electricity, and business key enterprises in China
- **Start Date:** April 8, 2021

## Indicators of Compromise (IOCs)

### Chatloader
- **Hashes:**
  - `7ee9b79f4b5e19547707cbd960d4292f`
  - `F5158addf976243ffc19449e74c4bbad`
  - `1015fa861318acbbfd405e54620aa5e3`
  - `a1d972a6aa398d0230e577227b28e499`

### .NET Loader
- **Hash:** `bd2d24f0ffa3d38cb5415b0de2f58bb3`

### Funnyswitch Loader
- **Hashes:**
  - `e0a9d82b959222d9665c0b4e57594a75`
  - `07a61e3985b22ec859e09fa16fd28b85`
  - `d720ac7a6d054f87dbafb03e83bcb97c`
  - `F85d1c2189e261d8d3f0199bbdda3849`
  - `5b2a9a12d0c5d44537637cf04d93bec5`

### Early Bird Code Injection Loader
- **Hashes:**
  - `4598c75007b3cd766216086415cc4335`
  - `Fd6ae1b8713746e3620386a5e6454a8d`
  - `b028b4f8421361f2485948ca7018a2b0`

### Natwalk
- **Hashes:**
  - `1d36404f85d94bea6c976044cb342f24`
  - `7c6e75e70d29e77f78ea708e01e19c36`

### HIGHNOON Loader
- **Hashes:**
  - `407b5200c061123c9bd32e7eea21a57b`
  - `5b99fa01c72cebc53a76cc72e9581189`

### Funnydll
- **Hash:** `e0a9d82b959222d9665c0b4e57594a75`

### Spyder
- **Hash:** `fba77006e8f8f3db6aac86211fa047fb`

### Shadowpad
- **Hash:** `af7cef9e0e6601cae068b73787e3ae81`

### Domains and IPs
- **Domains:**
  - `symantecupd.com`
  - `microsoftonlineupdate.dynamic-dns.net`
  - `www.sinnb.com`
  - `pip.pythoncdn.com`
  - `img.hmmvm.com`
  - `reg.pythoncdn.com`
  - `bbwebt.com`
  - `ns1.tkti.me`
  - `test.tkti.me`
  - `ns1.microsofts.freeddns.com`
  - `api.aws3.workers.dev`
  - `ns1.hkserch.com`
  - `godaddy1.txwl.pw`
  - `godaddy2.txwl.pw`
  - `ns.cdn06.tk`
  - `update.facebookdocs.com`
  - `ns1.dns-dropbox.com`
  - `ns.cloud20.tk`
  - `ns.cloud01.tk`
  - `ns1.token.dns05.com`
  - `sculpture.ns01.info`
  - `work.cloud20.tk`
  - `work.cloud01.tk`
  - `help01.softether.net`
  - `cloud.api-json.workers.dev`
  - `update.microsoft-api.workers.dev`
  - `up.linux-headers.com`
  - `p.samkdd.com`
  - `ns1.microsoftskype.ml`
  - `ns1.hongk.cf`
  - `ns1.163qq.cf`
  - `163qq.cf`
  - `depth.ddns.info`
  - `yjij4bpade.nslookup.club`
  - `ooliviaa.ddns.info`
  - `mootoorheaad.ns01.info`
  - `token.dns04.com`
  - `ns1.watson.misecure.com`
  - `vt.livehost.live`
  - `sociomanagement.com`
  - `ns1.hash-prime.com`
  - `wntc.livehost.live`
  - `smtp.biti.ph`
  - `perfeito.my`
  - `cdn.cdnfree.workers.dev`
  - `www.microsofthelp.dns1.us`
  - `ns1.mssetting.com`
  - `www.corpsolution.net`
  - `www.mircoupdate.https443.net`
  - `publicca.twhinet.workers.dev`
  - `microgoogle.ml`
  - `www.google-dev.tk`
  - `api.gov-tw.workers.dev`
- **IPs:**
  - `103.255.179.54`
  - `www.omgod.org`
  - `154.223.175.70`
  - `687eb876e047.kasprsky.info`
  - `zk4c9u55.wikimedia.vip`
  - `193.38.54.110`
  - `api.aws3.workers.dev`
  - `4iiiessb.wikimedia.vip`
  - `45.32.123.1`
  - `158.247.215.150`
  - `ntp.windows-time.com`
  - `trulwkg5c.tg9f6zwkx.icu`
  - `windowsupdate.microsoft.365filtering.com`
  - `wustat.windows.365filtering.com`
  - `ti0wddsnv.wikimedia.vip`

## References
- [1] [The Operations of Winnti Group](https://hello.global.ntt/-/media/ntt/global/insights/white-papers/the-operations-of-winnti-group.pdf)
- [2] [Higaisa or Winnti APT41 Backdoors: Old and New](https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/higaisa-or-winnti-apt-41-backdoors-old-and-new/)
- [3] [LAC Watch Report](https://www.lac.co.jp/lacwatch/report/20210521_002618.html)
- [4] [Chinese Group TAG-22 Targets Nepal, Philippines, Taiwan](https://www.recordedfuture.com/chinese-group-tag-22-targets-nepal-philippines-taiwan/)
- [5] [Backdoored Client from Mongolian CA MonPass](https://decoded.avast.io/luigicamastra/backdoored-client-from-mongolian-ca-monpass/)
- [6] [Hitcon 2018 Pacific Presentation](https://hitcon.org/2018/pacific/downloads/1214-R2/1330-1400.pdf)
- [7] [Biopass RAT: New Malware Sniffs Victims via Live Streaming](https://www.trendmicro.com/en_us/research/21/g/biopass-rat-new-malware-sniffs-victims-via-live-streaming.html)

---

**THANK YOU!**