# Beyond the MCSE: Red Teaming Active Directory

## Speaker
**Sean Metcalf (@Pyrotek3)**
- **Email:** sean@adsecurity.org
- **Website:** [www.ADSecurity.org](http://www.ADSecurity.org)

## About Me
- Founder of Trimarc, a security company.
- Microsoft Certified Master (MCM) in Directory Services.
- Microsoft MVP.
- Speaker at various conferences including Black Hat, BSides, DEF CON, DerbyCon, and Shakacon.
- Security Consultant and Researcher.
- Owner and Operator of [ADSecurity.org](http://www.ADSecurity.org), a resource for Microsoft platform security information.

## Agenda
1. Key AD Components
2. Offensive PowerShell
3. Effective AD Recon
4. AD Defenses & Bypasses
5. Security Pro’s Checklist

## Hacking the System
```powershell
PS> Get-FullAccess
```

## Differing Views of Active Directory
- **Administrator**
- **Security Professional**
- **Attacker**

Each role has a unique perspective, and a complete understanding is not typically held by any single individual.

### AD Administrator/Engineer
- Manages and maintains the AD environment.
- Ensures operational efficiency and compliance.

### Security Professional
- Focuses on protecting the AD environment from threats.
- Implements and monitors security controls.

### Attacker
- Seeks to exploit vulnerabilities and gain unauthorized access.
- Uses various techniques to bypass security measures.

## Active Directory Security
- Understanding the different roles and their perspectives is crucial for effective AD security.

### Can Control Another Domain in the Forest?
- Administrators in one domain can potentially control another domain in the same forest.

## Domain Controllers
- **Functions:**
  - Contains and replicates domain data.
  - Provides authentication and directory services.
  - Central set of servers for client communication.
  - Can host the Global Catalog.
  - Stores the domain AD database (NTDS.dit).
  - Hosts the domain DFS root (\\domain.com\), NETLOGON, and SYSVOL shares.
  - DNS (AD-Integrated).

### Read-Only Domain Controllers
- **Features:**
  - Read-only DC, DNS, and SYSVOL.
  - RODC Admin delegation to non-Domain Admins.
  - No passwords cached (default).
  - KRBTGT cryptographically isolated.
  - RODC escalation via delegation.
  - `msDS-AuthenticatedToAccountList` and `msDS-RevealedList`.

## DC Discovery
- **DNS Method:**
  - Use DNS queries to locate DCs.
- **ADSI Method:**
  - Use ADSI (Active Directory Service Interfaces) to discover DCs.

## Sites & Subnets
- **Functions:**
  - Map AD to physical locations for replication.
  - Subnet-Site association for resource discovery.
  - Asset discovery:
    - Domain Controllers
    - Exchange Servers
    - SCCM
    - DFS shares

## Group Policy
- **Management:**
  - User and computer management.
  - Create GPO and link to OU.
  - Comprised of:
    - Group Policy Object (GPO) in AD.
    - Group Policy Template (GPT) files in SYSVOL.
    - Group Policy Client Side Extensions on clients.
- **Capabilities:**
  - Configure security settings.
  - Add local Administrators.
  - Add update services.
  - Deploy scheduled tasks.
  - Install software.
  - Run user logon/logoff scripts.
  - Run computer startup/shutdown scripts.

## PowerShell as an Attack Platform
- **Quick PowerShell Attack History:**
  - **Summer 2010 - DEF CON 18:**
    - Dave Kennedy & Josh Kelly presented "PowerShell OMFG!".
    - Described many PowerShell attack techniques used today (Bypass exec policy, -Enc, & IE).
    - Released PowerDump to dump SAM database via PowerShell.
  - **2012 - PowerSploit:**
    - GitHub repo started by Matt Graeber, launched with Invoke-Shellcode.
    - "Inject shellcode into the process ID of your choosing or within the context of the running PowerShell process."
  - **2013 - Invoke-Mimikatz:**
    - Released by Joe Bialek, leveraging Invoke-ReflectivePEInjection.

### PowerShell v5 Security Enhancements
- **Features:**
  - Script block logging.
  - System-wide transcripts (with invocation header).
  - Constrained PowerShell enforced with AppLocker.
  - Antimalware Integration (Windows 10).
  - [More Information](http://blogs.msdn.com/b/powershell/archive/2015/06/09/powershell-the-blue-team.aspx)

### Bypassing Windows 10 AMSI
- **Techniques:**
  - DLL hijacking.
  - Using Reflection.
  - [DLL Hijacking Example](http://cn33liz.blogspot.nl/2016/05/bypassing-amsi-using-powershell-5-dll.html)

### Metasploit PowerShell Module
- Utilize Metasploit for PowerShell-based attacks.

### PS Constrained Language Mode
- Explore the limitations and capabilities of constrained language mode.

### PowerShell v5 Security Log Data
- Analyze and interpret security log data generated by PowerShell v5.

## Effective AD Recon
- Gain better target knowledge than the administrators.

### Active Directory Forest Info
- Gather comprehensive information about the AD forest.

### Active Directory Domain Info
- Collect detailed information about the AD domain.

### Forest & Domain Trusts
- Understand and map trust relationships within the forest and domains.

### Digging for Gold in AD
- **Targets:**
  - Default/Weak passwords.
  - Passwords stored in user attributes.
  - Sensitive data.
  - Incorrectly secured data.
  - Extension Attribute data.
  - Deleted Objects.

### Discovering Data
- **Tools:**
  - **Invoke-UserHunter:**
    - User home directory servers & shares.
    - User profile path servers & shares.
    - Logon script paths.
    - Performs `Get-NetSession` against each.
  - Discovering DFS shares.
  - Admin hunting… follow Will Harmjoy’s work: [blog.harmj0y.net](http://blog.harmj0y.net)

### Useful AD User Properties
- Created
- Modified
- CanonicalName
- Enabled
- Description
- LastLogonDate
- DisplayName
- AdminCount
- SIDHistory
- PasswordLastSet
- PasswordNeverExpires
- PasswordNotRequired
- PasswordExpired
- SmartcardLogonRequired
- AccountExpirationDate
- LastBadPasswordAttempt
- msExchHomeServerName
- CustomAttribute1 - 50
- ServicePrincipalName

### Useful AD Computer Properties
- Created
- Modified
- Enabled
- Description
- LastLogonDate (Reboot)
- PrimaryGroupID (516 = DC)
- PasswordLastSet (Active/Inactive)
- CanonicalName
- OperatingSystem
- OperatingSystemServicePack
- OperatingSystemVersion
- ServicePrincipalName
- TrustedForDelegation
- TrustedToAuthForDelegation

### DNS via LDAP
- Use LDAP to query DNS information.

### SPN Scanning
- **Discover Computers & Services without Port Scanning:**
  - SQL servers, instances, ports, etc.
  - MSSQLSvc/adsmsSQL01.adsecurity.org:1433
  - RDP: TERMSERV/adsmsEXCAS01.adsecurity.org
  - WSMan/WinRM/PS Remoting: WSMAN/adsmsEXCAS01.adsecurity.org
  - Forefront Identity Manager: FIMService/adsmsFIM01.adsecurity.org
  - Exchange Client Access Servers: exchangeMDB/adsmsEXCAS01.adsecurity.org
  - Microsoft SCCM: CmRcService/adsmsSCCM01.adsecurity.org
- **SPN Directory:**
  - [ADSecurity.org SPN Directory](http://adsecurity.org/?page_id=183)

### Cracking Service Account Passwords (Kerberoast)
- **Technique:**
  - Request/Save TGS service tickets and crack offline.
  - Use "Kerberoast" python-based TGS password cracker.
  - No elevated rights required.
  - No traffic sent to the target.
  - [GitHub Repository](https://github.com/nidem/kerberoast)

### Discover Admin Accounts
- **Methods:**
  - Group Enumeration.
  - RODC Groups.
  - AdminCount = 1.
  - AD Groups with Local Admin Rights.