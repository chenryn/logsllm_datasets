# 【技术分享】组合攻击——漏洞利用的新尝试

#### 译文声明
本文为翻译文章，原文来源：[blog.talosintelligence.com](http://blog.talosintelligence.com)。译文仅供参考，具体内容及含义以原文为准。
- 译者：紫曦归来
- 预估稿费：200 RMB
- 投稿方式：发送邮件至 linwei#360.cn 或登录网页版在线投稿

## 简介
今年4月曝光的 **CVE-2017-0199** 漏洞允许攻击者在无需用户交互的情况下，通过打开包含恶意HTA脚本的Word文档来执行任意代码。该漏洞是由于Word处理内嵌 **OLE2LINK** 对象时，在网络更新对象过程中未正确处理 **Content-Type** 导致的逻辑错误。

近日，Cisco Talos团队发现有黑客组织将 **CVE-2017-0199** 漏洞与早期的 **CVE-2012-0158** 漏洞结合使用，试图绕过Word的安全提示或通过不同机制强制执行。这种组合可能是为了测试新的漏洞概念，但无论出于何种目的，攻击者都因操作失误导致攻击效果远低于预期。

通过对组合漏洞的文档载荷进行分析，研究者发现内嵌OLE2LINK对象具有被利用的潜力，不仅限于Word文档。然而，目前公众对此认识不足。

当前，黑客正寻找绕开系统安全警告的方法。本报告详细分析了如何合并 **CVE-2017-0199** 和 **CVE-2012-0158** 漏洞，并将其置于一条感染链中。此外，还将探讨组合漏洞失败的原因。

尽管组合攻击未能成功，但这种尝试是一种创新性的方法。攻击者试图利用 **CVE-2017-0199** 作为“挡箭牌”以绕过系统提示。但从实际效果来看，这种方法尚需进一步完善。

## 标准 **CVE-2017-0199** 漏洞利用
标准的 **CVE-2017-0199** 漏洞利用通常包括通过电子邮件分发带有嵌入式恶意脚本的假RTF文件。当用户打开文档时， **winword.exe** 会向远程服务器发出HTTP请求以获取恶意HTA文件。服务器返回的文件是一个带有嵌入式恶意脚本的假RTF文件。 **winword.exe** 通过COM对象查找 **application/hta** 的文件处理程序，从而导致Microsoft HTA应用程序（mshta.exe）加载并执行恶意脚本。恶意脚本会终止 **winword.exe** 进程，下载其余payload，并加载诱饵文件，以掩盖 **OLE2link** 生成的用户提示。

## 升级后的 **CVE-2017-0199** 漏洞
此次攻击者对 **CVE-2017-0199** 漏洞进行了升级。攻击行动从一封包含恶意附件的邮件开始，附件通常伪装成合作伙伴的采购订单。附件是一个含有OLE2嵌入式链接对象的RTF文件。在这种情况下，远程文件的MIME类型不是 **application/hta** 而是 **application/msword**。

在对其中一个Word样本进行研究时，研究人员发现，在显示 **CVE-2017-0199** 的系统提示之前，Word会自动转换下载文档的格式，随后程序崩溃。Word崩溃并非由 **CVE-2017-0199** 引起，而是由于 **CVE-2012-0158** 漏洞。攻击者在 **MSComctlLib.ListViewCtrl.2 ActiveX** 中嵌入了指令，这正是典型的 **CVE-2012-0158** 漏洞。这些指令由一串ROP链开始，当漏洞被激活时，指令自动运行。在ROP链设置内存块权限后，漏洞的第一阶段指令开始执行。

### 第二阶段的shellcode
第二阶段的shellcode更为复杂，首先调用 **ntdll.dll** 中的必需API函数。这些API函数用于在计算机挂起状态下创建系统进程 **svchost.exe**，并利用最终阶段的“下载和执行”shellcode重写初始入口点，植入可执行payload。最终阶段的shellcode使用 **UrlDownloadToFile** API函数从C&C服务器下载可执行文件到临时文件夹，并命名为 **%temp%\name.exe**，然后调用 **ShellExecute** 注入payload。

通过监控C&C服务器流量，研究人员发现下载的可执行payload实际上是一个基于VB脚本的木马释放器，包含旧版Ramnit木马和Lokibot。虽然攻击者可能原本想发动Lokibot攻击，但目标系统却意外感染了Ramnit木马。

### 结论
**CVE-2017-0199** 是垃圾邮件中最常使用的漏洞之一。本博客分析了同时合并 **CVE-2017-0199** 和 **CVE-2012-0158** 漏洞发动单一网络攻击的情况。攻击者在此过程中犯了一个重大错误，阻止了Ramnit payload的下载和执行。

我们好奇为什么攻击者会选择合并新旧两种漏洞。如果目标系统打了任一漏洞的补丁，组合攻击就会失效。如果目标系统确实存在 **CVE-2012-0158** 漏洞，攻击者针对单一漏洞的攻击可能更容易得手。

我们推测，攻击者可能希望通过这种方式避免Word弹出对话框引起怀疑，或者躲避行为检测系统。此次攻击不成功表明攻击者缺乏相关测试或控制技巧。然而，从中可以看出攻击者试图利用 **CVE-2017-0199** 作为攻击手段并躲避用户察觉的试验精神。尽管此次试验未奏效，但未来的攻击可能会实现这一目标。

### IOCs
- **文件**
  - 5ae2f13707ee38e4675ad1bc016b19875ee32312227103d6f202874d8543fc2e – **CVE-2017-0199**
  - 6a84e5fd6c9b2c1685efc7ac8d763048913bad2e767b4958e7b40b4488bacf80 – **CVE-2012-0158**

- **可执行文件**
  - 351aec22d926b4fb7efc7bafae9d1603962cadf0aed1e35b1ab4aad237723474
  - f34e5af97ccb3574f7d5343246138daf979bfd1f9c37590e9a41f6420ddb3bb6
  - 43624bf57a9c7ec345d786355bb56ca9f76c226380302855c61277bdc490fdfe
  - d4fbca06989a074133a459c284d79e979293625262a59fbd8b91825dbfbe2a13

- **URLs**
  - hxxp://multplelabs[dot]com/ema/order.doc – **CVE-2012-0158**
  - hxxp://multplelabs[dot]com/ema/nextyl.exe – dropper
  - hxxp://multplelabs[dot]com/freem/50/fre.php – Lokibot C2