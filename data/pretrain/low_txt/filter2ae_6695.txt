# 【技术分享】Red Alert 2：运用新技术的银行木马

##### 译文声明
本文为翻译文章，原文来源：phishlabs.com
原文地址：[链接]
译文仅供参考，具体内容及含义以原文为准。
译者：Janus情报局
预估稿费：200 RMB
投稿方式：发送邮件至linwei#360.cn 或登录网页版在线投稿

**简介**
自上周以来，Android银行木马程序Red Alert 2引起了广泛关注。其主要原因在于该木马代码库似乎是全新的，并且具备一些独特的功能。PhishLabs情报分析研究部门（R.A.I.D.）最近发现了一个新的Red Alert 2样本，与之前的样本相比，在策略、技术和过程上都有所改进。在深入分析这些变化之前，我们先回顾一下Red Alert 2的一些有趣特性。

**旧物换新颜**
Red Alert 2与其他现有的Android银行木马在功能上有许多共同点。它在后台运行，监控应用程序活动，并在检测到目标相关活动时覆盖设备屏幕上的钓鱼页面。此外，它还会窃取系统信息和用户数据，包括联系人、短信、通话记录等，并能够窃听或拦截短信/通话、发送短信和USSD请求以及启动其他应用程序。

图1：指令表

Red Alert 2的独特之处在于，与许多现有Android银行木马不同，它似乎不是基于泄露源代码的变体，而是全新的。此外，它在任务执行方面也有所不同，例如确定前台应用、更新C&C服务器和获取配置数据。

**1. 确定正在运行的应用**
Android银行木马的一项关键任务是确定当前在前台运行的应用程序，以便选择合适的覆盖层。过去，银行木马使用`ActivityManager`类的`getRunningTasks`或`getRecentTasks`方法来实现这一点。然而，从Android Lollipop (API Level 21) 开始，这些方法已被弃用，因此对于Android 5.0及更高版本的设备不再适用。为了解决这一问题，Red Alert 2利用了Android Toolbox（一组Linux命令行程序）来确定当前运行的应用程序。图2展示了用于确定当前运行应用程序的控制流，图3显示了使用Android Toolbox的代码片段。

图2：确定正在运行的应用

图3：Android Toolbox调用

值得注意的是，对于API Level 20（即KitKat 4.4W），Red Alert 2使用`UsageStatsManager`来确定当前运行的应用程序。这也解释了为什么这款木马需要`PACKAGE_USAGE_STATS`权限。此外，木马开发人员还专门为Android Wear设备进行了调整，这也是非常有趣的。

图4：Android 4.4w `UsageStatsManager` 方法

**2. 更新C&C服务器**
长期以来，聊天客户端和社交媒体一直被用于桌面恶意软件的命令和控制，但这些技术尚未广泛应用于移动领域。Red Alert 2通过利用Twitter来更新C&C服务器，将上述技术移植到了移动领域。初始传输过程中，C&C服务器由应用资源中指定的样本服务，如图5所示：

图5：应用资源中的基础配置数据

如果该C&C服务器离线，样本将计算一个Twitter用户名并查询该账户的帖子，以检索更新的C2。图6中的代码片段检查了该账户的推文，并使用正则表达式确认推文是否为IP地址格式（四个字节，前两个和最后两个字节由空格分隔）。一旦确认，该IP地址将被重新构建，添加HTTP协议和端口8060，然后保存为新的C&C服务器。

图6：Twitter C&C服务器更新代码

**3. 获取配置数据**
许多Android银行木马将其配置信息硬编码到APK中，或者在安装完成后从C&C服务器下载配置文件。为了避免成为安全研究人员的目标，Red Alert 2采用了“Go Fish”的方法来传输配置文件。所有配置数据都存储在C&C服务器上，只有当设备“证明”已安装目标应用后，才会向受感染设备传输配置文件。

安装后，Red Alert 2使用Bot ID跟踪设备的感染情况并与C&C服务器通信。随后，受感染设备将已安装的应用程序列表发送到C2。图7展示了一个受感染设备向C&C服务器发送POST请求的示例。这里base64编码的数据包含已安装应用列表。C&C服务器接收到已安装程序列表后，响应与已安装应用对应的目标应用列表，并提供相应的覆盖层HTML代码。该代码保存在设备存储中，当木马检测到目标应用程序在前台运行时才会显示。完整的配置数据从未提供给受感染设备，这使得分析变得非常困难。

图7：发送给C2服务器的已安装程序列表

**持续发展态势**
正如文章开头所述，PhishLabs R.A.I.D.团队最近观察到的新样本在策略、技术和过程上都有所改变，这些手段与最初版本的Red Alert 2有关。

**1. 目标**
R.A.I.D.对最初的Red Alert 2样本进行了分析，发现其目标包括某些金融机构、社交媒体网站、支付网站和零售业务。由于无法直接访问C&C服务器，获取完整的目标应用程序列表具有挑战性。最新样本的目标数量高达66个，其中有4个目标被移除，新增了6个目标。被移除的目标包括西太平洋银行、圣乔治银行、Skype和阿尔斯特银行。新增的目标包括五家俄罗斯银行和Uber。新目标应用程序详见表1。图8显示了针对新目标Tinkoff银行的覆盖页面。

表1：新版本Red Alert 2的新目标

图8：Tinkoff银行覆盖层

Red Alert 2已成为目标分布地理多样化的移动银行木马之一。以往的银行木马通常针对特定地区，而Red Alert 2却采取了全球化的策略。图9展示了Red Alert 2的目标地理分布。

图9：根据目标国家分布的数量统计

**2. 基于域名的C2和Cloudflare**
这是R.A.I.D.团队首次观察到不使用硬编码IP地址，而是使用域名进行命令控制的样本。虽然使用域名本身并不重要，但它打开了使用像Cloudflare这样的CDN代理的大门。本文分析的样本选择了带有Cloudflare服务的a.club域名（我们已向Cloudflare报告此事）。通过利用Cloudflare提供的服务，包括反机器人措施和C2服务器真实IP混淆等，这些措施对安全研究人员的自动分析造成了很大困扰，C2的IP混淆也让分析人员难以成功定位。

图10：Cloudflare代理背后的C2域名

**3. 服务器端目标标识符**
另一个观察到的变化是用于从C&C服务器获取覆盖层的唯一标识符的更改。受感染设备提供已安装程序列表后，服务器会响应应用程序列表及其对应的唯一ID。接下来，包含此唯一ID的设备会发送POST请求提示C&C服务器返回相应的覆盖页面HTML代码。在Red Alert 2的初始版本中，这个唯一的ID是一个十六进制字符串，如图11所示。

图11：十六进制唯一ID

在最近的样本中，这个唯一标识符被修改为解码后为目标包名称的base64编码字符串。在某些情况下，会请求第二个屏幕覆盖层，此时唯一标识符是包名和数字2组合而成。这种新格式如图12所示。

图12：新型base64编码的唯一ID

**总结**
尽管这些变化在本质上并不是特别大，但它们表明Red Alert 2的幕后黑手一直在积极运作，试图开发出更加完美的银行木马。短期内更新的目标显示了快速扩展木马的能力。最终，我们希望Red Alert 2的开发者能够继续优化木马，以保持在日益饱和的移动银行木马市场中的竞争力。

最后，样本信息及样本分析可在Janus查看，点击[这里]。
或检索SHA256：
**05888c0f55d23c8c4f3b1ad0fe478c3d1610449f45abb9247f59563ac12ff82c**