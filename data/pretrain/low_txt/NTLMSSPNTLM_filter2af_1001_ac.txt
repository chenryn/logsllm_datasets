### NTLM Type 2 消息标志说明

- **Negotiate Unicode (0x00000001)**: 表示服务器将使用Unicode字符串。此标志仅应在客户端在Type 1消息中表明支持Unicode时设置。Negotiate Unicode和Negotiate OEM应二选一，不可同时设置。
- **Negotiate OEM (0x00000002)**: 表明服务器将使用OEM字符串。同样地，该标志只应在客户端在Type 1消息中表明支持OEM字符串时才被激活。Negotiate Unicode和Negotiate OEM只能选择其一进行设定。
- **Request Target (0x00000004)**: 虽然此标志通常出现在Type 2消息中，但其在此上下文中的具体含义尚不明确。
- **Negotiate NTLM (0x00000200)**: 标识支持NTLM认证机制。
- **Negotiate Local Call (0x00004000)**: 当服务器与客户端位于同一台机器上时，服务器会设置此标志，并提供本地安全上下文句柄。
- **Negotiate Always Sign (0x00008000)**: 指出客户端与服务器之间的通信（认证后）应当包含一个“虚拟”签名。
- **Target Type Domain (0x00010000)**: 如果身份验证目标代表的是域，则服务器会设置此标志。
- **Target Type Server (0x00020000)**: 若身份验证目标指向的是服务器，那么此标志会被激活。
- **Target Type Share (0x00040000)**: 据称当身份验证目标为网络共享时，服务器会启用此标志，但这一点尚未得到证实。
- **Negotiate NTLM2 Key (0x00080000)**: 表明服务器支持NTLM2签名及密封方案；若协商成功，这可能还会影响客户端响应的计算方式。
- **Negotiate Target Info (0x00800000)**: 如果随消息发送了目标信息块，服务器会设置此标志。
- **Negotiate 128 (0x20000000)**: 表示服务器支持强（128位）加密。
- **Negotiate 56 (0x80000000)**: 表明服务器支持中等强度（56位）的加密。

### 目标名称
目标名称是一个包含身份验证目标信息的安全缓冲区，通常是根据客户端请求（通过在Type 1消息中设置请求目标标志）而发送的。它可以指代域、服务器或网络共享，具体类型由Target Type Domain, Target Type Server, and Target Type Share标志指示。目标名称可以是Unicode或OEM格式，取决于Type 2消息中存在的相应标志。

### Challenge
Challenge是由服务器生成的一个8字节随机数据块，客户端需利用它来构造响应。

### 上下文字段
当设置了"Negotiate Local Call"标志时，上下文字段通常会被填充。它包含了SSPI上下文句柄，允许客户端绕过正常的挑战响应流程。从物理上看，上下文由两个长整型值组成。更多细节将在后续的"本地认证"部分中讨论。

### 目标信息
目标信息也是一个安全缓冲区，用于存储帮助计算NTLMv2响应的数据。它由一系列子块构成，每个子块包括：
- **类型**: 短整型，指定子块内数据种类。
- **长度**: 短整型，指出内容字段的字节数。
- **内容**: Unicode字符串，按照类型字段指示的内容发送。即使消息标志显示使用OEM编码，此处也总是以Unicode形式发送。

### OS版本结构
OS版本结构已在前文中有所描述。

### Type 2消息版本
已观察到几种不同版本的Type 2消息：
- **版本1**: 不包含上下文、目标信息以及操作系统版本结构。数据块（仅含目标名称安全缓冲区内容）始于偏移量32处。这种形式主要见于较旧的基于Win9x系统，并且在Open Group的ActiveX参考文档第11.2.3节中有大致记录。
- **版本2**: 存在上下文和目标信息字段，但没有OS版本结构。数据块开始于目标信息头之后的偏移量48位置。这是大多数现成Windows发行版的标准形式。
- **版本3**: 包括所有三个组成部分：上下文、目标信息以及操作系统版本结构。数据块紧随OS版本结构之后，在偏移量56处开始。缓冲区也可能为空，导致零长度的数据块。这种形式是在相对较新的Service Pack中引入的，并且可以在Windows 2000、XP及Server 2003的最新补丁版本中找到。

### 最小化Type 2消息示例
    4e544c4d53535000020000000000000000000000020200000123456789abcdef
此消息包含NTLMSSP签名、NTLM消息类型、空的目标名称、最少数量的标志（Negotiate NTLM 和 Negotiate OEM），以及challenge值。

### Type 2消息实例解析
考虑以下十六进制表示的Type 2消息：
    4e544c4d53535000020000000c000c003000000001028100 
    0123456789abcdef0000000000000000620062003c000000 
    44004f004d00410049004e0002000c0044004f004d004100 
    49004e0001000c0053004500520056004500520004001400 
    64006f006d00610069006e002e0063006f006d0003002200 
    7300650072007600650072002e0064006f006d0061006900 
    6e002e0063006f006d0000000000

分解如下：
- **偏移量0**: 0x4e544c4d53535000 - NTLMSSP Signature
- **偏移量8**: 0x02000000 - Type 2 Indicator
- **偏移量12**: 0x0c000c0030000000 - Target Name Security Buffer: 长度12字节(0x0c00), 分配空间12字节(0x0c00), 偏移量48字节(0x30000000)
- **偏移量20**: 0x01028100 - Flags: Negotiate Unicode (0x00000001), Negotiate NTLM (0x00000200), Target Type Domain (0x00010000), Negotiate Target Info (0x00800000)
- **偏移量24**: 0x0123456789abcdef - Challenge
- **偏移量32**: 0x0000000000000000 - Context
- **偏移量40**: 0x620062003c000000 - Target Information Security Buffer: 长度98字节(0x6200), 分配空间98字节(0x6200), 偏移量60字节(0x3c000000)
- **偏移量48**: 0x44004f004d004100 49004e00 - Target Name Data ("DOMAIN")
- **偏移量60**: 0x02000c0044004f00 4d00410049004e00 01000c0053004500 5200560045005200 0400140064006f00 6d00610069006e00 2e0063006f006d00 0300220073006500 7200760065007200 2e0064006f006d00 610069006e002e00 63006f006d000000 0000 - Target Information Data

**目标信息数据**:
- **偏移量0x02000c0044004f00 4d00410049004e00**: 域名子块: 类型2 (域名, 0x0200), 长度12字节 (0x0c00), 数据 "DOMAIN"
- **偏移量0x01000c0053004500 5200560045005200**: 服务器名字子块: 类型1 (服务器名, 0x0100), 长度12字节 (0x0c00), 数据 "SERVER"
- **偏移量0x0400140064006f00 6d00610069006e00 2e0063006f006d00**: DNS域名子块: 类型4 (DNS域名, 0x0400), 长度20字节 (0x1400), 数据 "domain.com"
- **偏移量0x0300220073006500 7200760065007200 2e0064006f006d00 610069006e002e00 63006f006d00**: DNS服务器名子块: 类型3 (DNS服务器名, 0x0300), 长度34字节 (0x2200), 数据 "server.domain.com"
- **偏移量0x00000000**: 终止子块: 类型0 (终止符, 0x0000), 长度0字节 (0x0000)

对此消息的分析表明，这是一条标准的NTLM Type 2消息（依据NTLMSSP签名和Type 2指示符）。