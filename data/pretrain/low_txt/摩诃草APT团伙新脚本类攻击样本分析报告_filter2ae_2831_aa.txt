# 摩诃草APT团伙新脚本类攻击样本分析报告

##### 译文声明
本文为翻译文章，仅供参考。具体内容及含义以原文为准。

摩诃草组织（又称Hangover、Viceroy Tiger、Patchwork、Dropping Elephant、MONSOON）在国内也被称为白象或丰收行动。该组织自2013年5月16日首次被国外安全厂商Norman曝光以来，一直活跃于针对中国、巴基斯坦及其他南亚国家的网络间谍活动。许多国内外安全厂商陆续发现并报道了其攻击事件和使用的恶意代码。

360公司在2016年8月4日发布的《摩诃草组织（APT-C-09）来自南亚的定向攻击威胁》一文中【1】，详细介绍了该组织的历史攻击行动，并对其所用的攻击工具和基础设施进行了对比总结。

### 背景概述
自2013年首次曝光以来，“摩诃草”组织的攻击行为持续不断且频率较高。尽管多家安全机构多次揭露其历史攻击活动和技术手段，但该组织并未停止其恶意行为。根据360威胁情报中心的监测结果，在过去一年里，“摩诃草”继续保持以往的攻击模式，同时在攻击工具和恶意软件方面有所创新。

最近，我们注意到该组织可能对东欧部分国家发起了新的攻击尝试，并使用了一些基于脚本的新制作恶意代码文件。与之前常见的诱导漏洞文档类攻击载荷不同的是，这些新出现的脚本文件已经导致部分乌克兰用户感染远程控制木马。虽然目前尚不清楚此次攻击的具体动机，但我们决定公开披露部分技术细节以预警未来可能出现的大规模类似攻击。

### 基于脚本的攻击载荷投放
在最新版本中，“摩诃草”利用JavaScript (JS) 和 PowerShell 脚本来实现多阶段解密与拼接操作，进而释放并加载后续攻击组件。以下是具体流程：

#### Dropper JS – dog.js
- **功能描述**：这是一个大小约为96KB的JS脚本，负责释放另一个中间JS脚本。
- **执行过程**：
  - 将附加数据以注释形式存储在脚本头部；
  - 获取当前执行路径后读取自身内容；
  - 找到并提取注释中的附加信息，将其转换成二进制格式；
  - 保存至临时目录下名为`laksasokpaslkak.js`的文件内；
  - 最终通过WScript引擎运行该脚本。

#### 中间JS脚本 – laksasokpaslkak.js
- **功能描述**：此脚本用于检查目标主机是否安装了特定的安全软件（如卡巴斯基或NOD32），若存在则立即退出；反之，则继续将两个预定义的数据块写入一个随机命名的PowerShell脚本文件，并执行它。

#### 随机名称PowerShell脚本
- **功能描述**：该PowerShell脚本包含乱序排列的Base64编码字符串，经过解码与解压缩后会采用一种绕过UAC的方法来执行。值得注意的是，这种方法也曾出现在另一个名为“海莲花”的APT组织所使用的攻击工具中【2】。
- **执行机制**：通过修改注册表键值劫持eventvwr.exe进程，然后调用SC命令创建一个新的服务指向解密后的PowerShell脚本。

#### PowerShell Loader
- **功能描述**：这个具有随机生成名称的脚本主要用于加载最终的远程控制模块。
- **加载步骤**：
  - 从内存中读取payload；
  - 使用base64decode函数解码得到原始DLL文件内容；
  - 利用ReflectiveLoader技术完成加载过程。
- **代码来源推测**：根据对部分代码片段的研究，我们认为这部分实现可能借鉴了某些开源项目【3】，并且增加了对64位Windows系统的支持。

### 远控模块分析
#### 加载入口 – ReflectiveLoader
- **主要职责**：定位DLL模块基址并获取所需API地址；
- **关键技术点**：
  - 通过搜索PE头标识符确定模块起始位置；
  - 计算LoadLibrary、GetProcAddr及VirtualAlloc等函数的实际地址；
  - 分配一段新的内存空间并将DLL复制进去；
  - 调用DllMain函数开始初始化工作。

#### 执行入口 – DllMain
- **关键操作**：收集硬件信息生成唯一标识符（即机器码），随后注入svchost.exe进程中运行指定代码段；
- **重要函数**：sub_1000234A负责初始化网络连接并向C&C服务器发送心跳包。

#### 控制协议
远控模块通过HTTP协议与控制端进行通信，其中涉及到的主要数据包类型包括touch包。后者的作用是向服务器发送包含加密机器码的信息，以便对方能够识别出具体的受控设备。

**touch包解析**：
- **构造方法**：将计算得出的机器码与随机密钥结合后按照一定规则编码；
- **示例说明**：假设生成的机器码为j2ylvj50suxr8vzss17s3.php，则最终形成的请求URL将是j2ylvj50suxr8vzss17s3，前16个字符代表加密后的机器码，剩余部分则是随机密钥；
- **解密过程**：服务器收到此类请求时需先分离出有效载荷再利用相应算法还原出真实机器码。

以上便是我们对于“摩诃草”APT组织近期采用的新脚本类攻击样本的技术剖析。希望这份报告能够帮助相关单位和个人更好地理解和防范此类威胁。