# 注册表Hive基础知识介绍第二季 - NK记录

#### 译文声明
本文为翻译文章，原文来自360安全播报。译文仅供参考，具体内容和含义以原文为准。

**背景**
大多数用户习惯使用如`regedit.exe`这样的程序来查看注册表信息。所有版本的Windows操作系统都自带了`regedit.exe`，通过它可以查看注册表中所有基础组件的配置信息。下图展示了通过`regedit.exe`查看到的一个Hive文件的不同部分：

![注册表结构](<图片链接>)

在窗口左侧可以看到由各种项（keys）和子项（subkeys）组成的树状结构。每个项或子项都可以进一步细分为多个层次。例如，CBT是ATI Technologies项下的一个子项。项与子项在实际结构上没有区别。

当选择左侧的某个项时，该项所包含的所有键值会在右侧区域显示。`regedit.exe`可以显示三项数据：键值名称（Name列）、键值类型（Type列）以及键值数据（Data列）。

此外，我们还可以通过右键点击某个项并选择“Permissions”来查看该注册表项的访问权限。系统会显示当前所选注册表项的具体访问权限信息。

综上所述，`regedit.exe`提供了三种类型的信息：项、键值以及访问权限。而注册表Hive正是由这三种类型的数据组成。

当我们需要查看磁盘上的一个注册表Hive时，还需要一些新的知识。

**NK记录**
定义一个项（或子项）时，必要的数据信息包含在NK记录中。下图展示了一个磁盘中的NK记录示例：

![NK记录示例](<图片链接>)

一条NK记录包含25种不同类型的数据信息，其中主要信息包括：
- 大小
- 签名
- 标识符（flag）
- 最后写入时间
- 父类Cell索引
- 子项计数
- 子项Cell索引
- 键值计数
- 键值Cell索引
- 安全Cell索引
- 名称

**大小**
大小字段起始于偏移量0x0，使用一个32位有符号整数存储。在上面的例子中，其十六进制数值为0x70FFFFFF。这个值采用小端格式存储，转换为十进制后结果为-144。虽然看起来奇怪，但实际上负数表示记录已被使用。正数则表示未被使用。因此，看到负数表示这条记录已被其他“活动”记录引用，即可以通过`regedit.exe`查看这些记录。

**签名**
NK记录的签名字段从偏移量0x04开始，是一个ASCII字符串“nk”，十六进制值为0x6E6B。你可以通过[ASCII码表](http://www.ascii-code.com/)进行验证。

**标识符（flag）**
标识符用于表示NK记录的不同属性。标识符从偏移量0x06开始，长度为两个字节。在上述例子中，标识符值为0x2C00，简化为0x2C。常见标识符值如下：
- 压缩名称 (Compressed Name) = 0x0020 (二进制: 100000)
- Hive入口根键 (Hive Entry Root Key) = 0x0004 (二进制: 000100)
- Hive退出 (Hive Exit) = 0x0002 (二进制: 000010)
- 不可删除 (No Delete) = 0x0008 (二进制: 001000)

通过对标识符值进行按位与运算，可以确定哪些标志已设置。例如：
- 101100 & 100000 == 100000 (压缩名称标志已设置)
- 101100 & 001000 == 001000 (不可删除标志已设置)
- 101100 & 000100 == 000100 (Hive入口根键标志已设置)
- 101100 & 000010 == 000000 (Hive退出标志未设置)

你可以通过[按位计算器](http://www.miniwebtool.com/bitwise-calculator/)自行测试。

**最后写入时间**
最后写入时间戳位于偏移量0x08处，长度为8个字节。它表示NK记录最后一次更新的时间，存储为从1601年1月1日0点开始经过的100纳秒间隔数。上述例子中的最后写入时间为2014年11月28日下午4时52分17秒。

**父类Cell索引**
父类Cell索引从偏移量0x14开始，长度为4个字节。在上述例子中，其值为0x20070000，即0x720。如果设置了HiveEntryRootKey标志，则该值指向的是注册表Hive的根节点。对于其他NK记录，父类Cell索引指向其上级NK记录，有助于上下级索引。恢复或重组已删除的NK记录时，此字段尤为重要。

**子项计数**
子项计数从偏移量0x18开始，长度为4个字节。在上述例子中，子项计数为0x0C000000，十进制值为12，表示该NK记录有12个子项。

**子项Cell索引**
子项Cell索引从偏移量0x20开始，长度为4个字节。在上述例子中，子项Cell索引为0xE8326E00，相对偏移量为0x6E32E8。将其加上0x1000即可在十六进制编辑器中找到准确位置。

**键值计数**
键值计数从偏移量0x28开始，长度为4个字节。在上述例子中，键值计数为0x00000000，即0。

**键值Cell索引**
键值Cell索引从偏移量0x2C开始，长度为4个字节。此字段与VK记录相关，将在第三季中详细讨论。在上述例子中，键值Cell索引为0xFFFFFFFF。

**安全Cell索引**
安全Cell索引从偏移量0x30开始，长度为4个字节。此字段与SK记录相关，将在第四季中详细讨论。

**名称**
NK记录的名称从偏移量0x50开始。名称长度占2个字节，从偏移量0x4C开始。在上述例子中，长度值为0x3900，十进制值为57。

**总结**
以下是标注出重要部分的NK记录示意图：

![NK记录标注](<图片链接>)

通过注册表浏览器查看NK记录如下图所示：

![注册表浏览器视图](<图片链接>)

**敬请期待**
我们将在第三季中讨论VK记录，并在第四季中深入探讨SK记录。

希望本文对你有所帮助！