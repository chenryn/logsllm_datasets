# 漏洞概述与反思

以下是多个CVE编号及其相关反思：

- **CVE-2017-8759**
- **CVE-2018-8174**
- **CVE-2018-8373**
- **CVE-2014-4114**
- **CVE-2014-6352**
- **CVE-2015-0097**

## 反思与改进

### 2017年4月
- **CVE-2017-0261 (0day)**
- **CVE-2017-0262 (0day) + CVE-2017-0263 (0day)**
  - **反思：**
    - 沙箱检测引擎存在缺陷。
    - **CVE-2017-0261** 样本在 Office 2010 中无法触发。
    - **CVE-2017-0262** 样本在 Office 2007 中无法触发。
    - 用户态引擎在面对内核 0day 时表现不佳。

### 2017年8月
- **CVE-2017-8759 (0day)**
  - **反思：**
    - 沙箱成功运行了样本，但未能及时通知分析人员。

### 2017年10月
- **CVE-2017-11292 (1day)**
  - **反思：**
    - 对 DealersChoice 框架缺乏了解。
    - 如果目标是低版本 Flash，应下发 CVE-2015-7645。
    - 如果目标是高版本 Flash，应下发 CVE-2017-11292。

## 攻击框架研究

### DealersChoice
- 由 @Unit42_Intel 命名。
- 被 APT28 使用。
- 持续改进以躲避检测。
  - **初始手法：**
    - 检查当前 Flash 版本。
    - 地理位置判断。
    - 存活时间短。
  - **新手法：**
    - 反沙箱：需要模拟文档下滑。
    - 改写开源代码，加入恶意功能，躲避静态检测。

### 持续创新
- **沙箱检测引擎缺陷**：
  - 开发下一代沙箱检测引擎。
- **环境选择不正确**：
  - 制作多种环境。
- **制定触发率高的投递策略**。
- **不能及时通知分析人员**：
  - 构建实时推送系统。
- **对攻击框架不够熟悉**：
  - 研究 DealersChoice 框架。
- **强化 Flash 针对性检测**。

## 从0到1的突破

### CVE-2017-11826
- **第一次有中国厂商抓到 Office 在野 0day**。
- **漏洞描述**：
  - OLEObject & Font 对象类型混淆 + ActiveX 控件堆喷射。
  - **Office 2007 下正常执行时**：
    - `mov eax, [eax+44h]`
    - `mov eax, [eax+44h]`
    - `call dword ptr [ecx+4]`

  - **Office 2007 下触发漏洞时**：
    - `mov eax, [eax+44h]`
    - `mov ecx, [eax]`
    - `call dword ptr [ecx+4]`

## 从1到N的扩展

### 多个CVE编号
- **CVE-2018-0802**：公式编辑器组件栈溢出。
- **CVE-2018-8174**。
- **CVE-2018-5002**：AVM2 解释器漏洞。
- **CVE-2018-15982**：TVSDK 中的 UAF 漏洞。

### 具体案例
- **CVE-2018-0802**：
  - **2017年12月14日**：同时内嵌两个漏洞（CVE-2017-11882 和 CVE-2018-0802）。
  - **2017年12月19日**：仅内嵌一个漏洞（CVE-2018-0802），无法正常触发。
  - **2018年1月10日**：微软对我们进行了致谢。
  - **错误原因**：MiniFat Sector 错位 0x15 字节。
  - **修复方法**：对原始 RTF 文档稍作修改。

- **CVE-2018-5002**：
  - **2018年6月1日**：一套复杂的 Flash 控制框架。
  - **2018年6月7日**：Adobe 对我们进行了致谢。
  - **调试方法**：逆向 -> ASC2.0 编译 -> FFDEC 修改字节码 -> 获得可调试的 swf 文件。
  - **WinDBG 插件**：https://github.com/michaelpdu/flashext_pykd。

- **CVE-2018-15982**：
  - **2018年11月29日**：2个小时，2个样本。
  - **2018年12月5日**：Adobe 再次对我们进行了致谢。
  - **绕过 ROP 检测**：使用 HackingTeam 的技巧。
  - **无法躲避 EAF 检测**。

## 其他收获
- 1 Word CVE。
- 1 PowerPoint CVE。
- 4 Excel CVE。
- 1 Win32k CVE。

## 总结
- 从1到N容易，从0到1难。
- 了解对手，反思自己，战胜对手。
- 永远在路上。

## 致谢
- 感谢 360 高级威胁团队的所有小伙伴。
- 感谢 @programmeboy, @guhe120, @binjo, @Unit42_Intel。
- 特别感谢 @HaifeiLi 和他关于 Office 安全的分享。

**作者**：
- 李琦
- 金权

**联系方式**：
- @leeqwind
- @jq0904