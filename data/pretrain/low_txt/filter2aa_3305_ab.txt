### 日志记录

- **2015-05-06 19:54:03 [5.61.38.11]**
  - **FB 类型块请求 (开始序列)**: 不可用
  - **FC 类型块请求 (开始序列)**: 不可用
  - **DB 类型块请求 (开始序列)**: 可用
- **2015-05-06 19:54:04 [5.61.38.11]**
  - **DB 1 块信息请求**: 可用
  - **DB 2 块信息请求**: 可用
  - **DB 3 块信息请求**: 可用

### 数据验证

- 针对数据的验证 (1)
- 针对数据的验证 (2)
- 针对数据的验证 (3)
- 针对数据的验证 (4)
- 针对数据的验证 (5)
- 针对数据的验证 (6)

### S7 PLC 漏洞利用

- **S7 协议漏洞**
  - S7-300 PLC 的等级保护功能
    - 功能描述
    - 功能缺陷
  - S7 协议对口令密码传输的缺陷
  - S7-300 PLC 内部程序字节码的转换
  - 利用 TCP/UDP 连接功能实现端口扫描
  - 利用通信功能块实现特定 Socket 通信

### S7-300 的等级保护

- **口令保护**
  - 保护 CPU 中的用户程序，防止未授权的修改（写保护）
  - 保护用户程序的编程技术内容（读保护）
  - 防止将会干涉进程的在线功能
- **口令保护的帮助**
  - 无法限制过程控制、监视和通信功能。例如，无法使用口令保护来防止对“设置时间/日期”功能的访问。
  - 其他示例：启用 LV2/LV3 也可以操作 CPU 工作状态。

### S7 协议对口令密码传输的弱加密

- **Hydra 已集成基于 S7 协议的口令破解模块**

### S7-300 MC7 字节码的传输

- **研究目的与意义**
  - 脱离官方编译器 S7kafapx.exe 实现对 PLC 程序的转换与修改
  - S7 协议大量字段已被解码但程序下载功能未被解码
  - Stuxnet 核心功能
- **S7-300 PLC 程序块解析**
  - 组织块 (OB)：主程序块负责所有 FC 程序块的调用
  - 数据块 (DB)：用于存放用户和系统定义的变量数据
  - 程序块 (FC)：由用户编写的程序块
  - 功能块 (FB)：由用户编写的专用数据块
  - 系统程序块 (SFC)：调用系统某些功能时自动创建
  - 系统功能块 (SFB)：调用系统某些数据功能时自动创建
  - 系统数据块 (SDB)：由编程软件自动生成，主要存放 PLC 的硬件组态等信息，用户无法直接打开和更改

### MC7 字节码转换

- **MC7 开始头部标志**
  - 70 70
  - 01 01
  - 02 // 块创建的语言 hex:0x02 LAD (KOP)
  - 08 // 块类型 hex:0x08 OB
  - 00 01 // 块编号 hex:0x00,0x01
  - 00 00 00 96 // 块总长度
  - 00 00 00 00 // 是否设置密码
  - 03 22 C8 2E 2C 20 // 最后修改时间
  - 03 9D CB 0C 11 4C // 上次修改时间
  - 00 1C // 内部块数据表长度
  - 00 30
  - 00 14 // 本地数据长度
  - 00 02 // MC7 执行代码长度

### MC7 注入实例

- **STL 代码示例**
  - 修改定时器时间为 1 秒

### S7-300 PLC 支持的连接方式

- 多种连接方式
  - S7 连接
  - 冗余的 S7 连接
  - 点对点连接
  - FMS 连接
  - FDL 连接
  - ISO 传输连接
  - ISO on TCP 连接
  - TCP 连接
  - UDP 连接
  - 电子邮件连接

### S7-300 PLC 支持的连接对象

- 相同型号 PLC CPU 之间的通信
- 不同型号 PLC CPU 之间的通信
- PLC 与上位机之间的通信
- PLC 与其他以太网设备的通信

### S7-300 CP 的 FC5/6 功能

- **通信功能块**
  - FC5: “AG_SEND”
  - FC6: “AG_RECV”
- **异步通信方式**
  - 类似传统 Socket 通信
  - SEND 功能
  - RECV 功能
- **自定义 Socket 通信**
  - 选择连接方式 (S7, TCP/UDP)
  - 激活连接的建立 (调用 FC5/FC6)
  - 使用 DB 构建收发缓冲区 (背景数据块)

### 自定义 Socket 通信实现

- **FC5 STL 代码**
  - CALL "AG_SEND"
  - ACT := L20.0
  - ID := 1
  - LADDR := W#16#100
  - SEND := P#DB99.DBX0.0 BYTE 38
  - LEN := 38
  - DONE := M99.1
  - ERROR := M99.2
  - STATUS := MW100
- **FC6 STL 代码**
  - CALL "AG_RECV"
  - ID := 1
  - LADDR := W#16#100
  - RECV := P#DB199.DBX0.0 BYTE 1024
  - NDR := M99.3
  - ERROR := M99.4
  - STATUS := MW102
  - LEN := DB99.DBW38

### Black Hat USA 2015

- INTERNET-FACING PLCS - A NEW BACK ORIFICE
- FB65 "TCON"
- FB63 "TSEND"
- FB64 "TRCV"
- 通过 S7-300 PLC 的内部通信块实现 Socks5 代理功能

### 发布的漏洞利用工具

- S7 PLC 特性
- 如何构造测试工具

### S7 PLC 特性

- 非标签方式寻址
- 功能块按照数字编号排序
  - FC 1
  - SDB 1001
- 变量数据按地址寻址
  - M0.0 à bit 0000
  - M0.1 à bit 0001
  - DB1.DBX1~
- 方便遍历测试而不需要进行枚举
  - For i in range(000000, 001234)

### 通用性增强

- 可设置连接模块与槽号
  - Rack
  - Slot
- S7 连接的初始化方式
  - PG
  - OP
  - S7

### 工具实现

- **S7 Fuzz Tools**
  - 获取模块信息
  - 设置 CPU 运行/停止
  - 模糊测试设置值
  - 模糊测试 DB 数据
  - 模糊测试块

### 测试用例与效果

- **启用等级保护**
  - 测试设备
    - CPU: 6ES7 313-5BG04-0AB0
    - CP: 6GK7 343-1CX10-0XE0
  - 用例
    - Rack:0 Slot:2
  - 结果

- **不启用等级保护**
  - 测试设备
    - CPU: 6ES7 313-5BG04-0AB0
    - CP: 6GK7 343-1CX10-0XE0
  - 用例
    - Rack:0 Slot:2
  - 结果

### 总结

- 关于
  - 网站: plcscan.org