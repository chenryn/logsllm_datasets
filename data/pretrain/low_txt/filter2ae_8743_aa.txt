### 《A Sheep in Wolf’s Clothing – Finding RCE in HP’s Printer Fleet》

**作者**: breenmachine@foxglovesecurity  
**译者**: Serene@知道创宇404实验室

非技术人员在销售产品或服务时往往强调其技术特性，但有时市场营销可能会过度夸大，从而引发市场的FUD（恐惧、不确定性和怀疑）。例如，在宣传视频《The Wolf》中，惠普声称其打印机是安全的，而购买其他品牌的打印机则几乎等同于疏忽犯罪。视频开头以黑底白字显示：“全球有数以亿计的商业打印机，其中只有不到2%是安全的。”随后，“狼”执行了一系列看似不太可能的攻击，利用不安全的打印机获取公司网络和敏感数据，暗示惠普打印机不会受到这些攻击。

尽管有诸如“Printer Hacking Wiki”和PRET工具包这样的优秀资源，但似乎没有人深入研究现代惠普商业打印机的安全性以验证惠普的安全声明。因此，我们购买了几台打印机，包括MFP-586和M553，正如视频中的“狼”所说，“要开始捕猎了”。

本文中提到的RCE漏洞已于2017年8月21日报告给惠普，并已修复。相关代码已在GitHub上发布。

#### 一、打印机攻击向量

在上述视频及其续集中，“狼”执行了一系列不切实际的攻击。虽然这些攻击并不现实，但我们仍然可以从中发现一些相关的打印机安全问题：

- **打印作业安全**: 打印作业安全主要通过两种方式暴露：一是打印机托盘中已完成的文件可能被路过的人取走；二是在某些打印机上，攻击者可以通过网络提取或拦截打印作业。
- **未签名的代码执行**: 打印机通常不受多种类型的监控。如果攻击者能在打印机上运行恶意软件，不仅能够不受限制地访问打印作业，还可能长时间不被发现，成为攻击者的避风港。

接下来，我们将重点介绍在现代惠普打印机上测试的一系列安全问题。

#### 二、测试常见的打印机漏洞

首先，我们回顾了现有的打印机安全空间，并发现了“打印机开发工具包”——PRET。该工具包包含了许多预定义的攻击方法，适用于不同制造商的打印机。它更多地提供了常见攻击的模板，而不是针对特定打印机的具体漏洞。因此，我们需要进一步调查惠普打印机可能受到哪些漏洞的影响。

以下是我们使用PRET工具包发现的问题：

##### 目录穿越 - 远程存储的打印作业泄漏

PRET工具包支持三种模式：Printer Job Language (PJL)、PostScript (PS) 和 PCL。每种模式都有不同的常见漏洞。PJL允许计算机与打印机通信并执行一些管理任务，如存储和删除文件，但只能在特定位置进行操作。

一个常见的漏洞是“目录穿越”，即通过请求特定文件和目录名称来逃离这个“监狱”。我们在两台惠普打印机上找到了一条目录穿越序列，但无法从这一点检索文件内容或写入任何文件，任何尝试都会导致打印机崩溃并重启。

经过进一步调查，我们发现只能在一个特定路径下检索文件内容，并且目录穿越序列略有修改：

- “Jobs”目录是存储打印作业的地方，通过PRET可以检索存储在打印机上的任何作业的内容。无论作业是否受PIN保护，结果都相同，这使得打印作业的保护功能变得不再可靠。

##### PostScript作业操作

某些类型的打印作业可以在打印之前自动处理。例如，网络上的任何人都可以将任意图像和字体放置在所有打印作业的页面上。如下所示，水印“FOO”并不属于要打印的原始文档。

##### 不安全的出厂重置功能

PRET工具包包含了两个未记录的方法，可以将惠普打印机重置为出厂默认设置，从而将“Administrator”密码重设为默认无密码。通过PJL接口和SNMP可以实现这一点，即使设备上已经设置了管理密码，在默认情况下它们都是不安全的。

此外，即使PJL和SNMP接口已被管理员保护，也有可能将SNMP社区字符串重置为默认值“public”。这是通过DHCP或BOOTP服务器重新配置的功能实现的。每次打印机启动时，从DHCP服务器获得IP地址的同时，也会查找一些特殊的配置选项。其中一个选项指定了一个TFTP服务器，打印机可以从该服务器检索配置文件。惠普指出，手动配置设置优先于DHCP配置，但在DHCP配置中有一些选项允许清除手动配置的设置，包括：

- 安全复位：将打印服务器上的安全设置重置为出厂默认值。
- 冷复位：重置为TCP/IP出厂默认设置。

启用这些选项的DHCP服务器配置文件已在GitHub上发布。

#### 三、不安全的默认设置

基于前面的测试结果，我们试图找到可以应用于打印机的安全设置组合，以阻止上述攻击。具体来说，我们希望找到管理员应采取的措施，以防止任何用户重置“Administrator”密码。

我们发现这是可能实现的，但现实环境中的管理员不太可能成功锁定这些打印机的管理界面。至少需要更改以下默认设置，并注意这些设置与安全性有关联：

- 必须在设备的管理Web界面上设置密码，这是IT中的常见做法，也是唯一可能应用于现实世界的设置。
- 在`Networking > Security > Mgmt. Protocols > SNMP`下的`Set Community Name`需要由默认的`public`改为其他值。
- 在`Security > PJL Security > Password`下，必须设置新密码。
- 必须禁用`Networking > Other Settings > Misc Settings > Enabled Features > TFTP Configuration File`。

如果上述任何一项被忽略，网络上的攻击者就有可能重置设备并获得管理访问权限。

#### 四、深入挖掘：提取操作系统和固件

为了找到RCE漏洞，我们花费数千美元购买了打印机，并继续深入研究。第一步是掌握打印机上实际运行的代码。惠普采取了一些措施来防止用户从打印机中提取操作系统和固件，但我们可以绕过这些限制。

首先，惠普提供的设备包含符合FIPS标准的加密硬盘驱动器。当插入这种驱动器时，所有数据都将被加密。移除驱动器后，没有加密密钥将无法读取数据。即使我们能够设置或恢复密钥，加密细节也不清楚，需要在从驱动器读取数据之前发现。

相反，我们只是移除了惠普提供的支持FIPS的驱动器，并插入了一个不支持加密的常规东芝笔记本电脑硬盘驱动器。重启设备后，打印机将操作系统和固件从USB密钥安装到新的未加密驱动器上。关闭打印机并取出驱动器后，我们可以在标准PC上读取驱动器上的许多文件。然而，一些更有趣的文件仍然难以捕捉，特别是在“/Windows/”和“/Core/bin”目录下的HP DLL文件。

##### 检索/Windows/

首先是Windows目录，我们使用Linux实用程序“grep”搜索Windows目录中存在的各种文件引用。文件“NK.bin”似乎每次都返回，经过一番调查后，我们发现打印机上运行的操作系统是Windows CE的一个版本，Windows CE内核存储在/CEKERNEL/NK.bin。我们可以使用公开的工具Nkbintools提取Windows CE内核的内容，并检索Windows目录的确切内容。

##### 检索/Core/bin

/Core/bin目录的内容更难以检索。当硬盘连接到PC时，/Core/bin目录实际上是可见的，但它是空的。