# Identifying Traffic Differentiation in Mobile Networks

**Authors:**
- Arash Molavi Kakhki, Northeastern University
- Abbas Razaghpanah, Stony Brook University
- Anke Li, Stony Brook University
- Hyungjoon Koo, Stony Brook University
- Rajesh Golani, Stony Brook University
- David R. Choffnes, Northeastern University
- Phillipa Gill, Stony Brook University
- Alan Mislove, Northeastern University

## Abstract
Traffic differentiation—providing better or worse performance to certain classes of Internet traffic—is a well-known but poorly understood traffic management policy. There is active debate on whether and how ISPs should be allowed to differentiate Internet traffic, yet there is limited data on current practices. Previous work has attempted to address this issue for fixed-line networks, but no solution exists for the more challenging mobile environment.

In this paper, we present the design, implementation, and evaluation of the first system and mobile app for identifying traffic differentiation for arbitrary applications in mobile networks (i.e., wireless networks such as cellular and WiFi, used by smartphones and tablets). The key idea is to use a VPN proxy to record and replay the network traffic generated by arbitrary applications, and compare it with the network behavior when replaying this traffic outside an encrypted tunnel. We perform the first known testbed experiments with actual commercial shaping devices to validate our system design and demonstrate its superior performance in detecting differentiation. Our app, released to the public, has collected differentiation results from 12 ISPs across 5 countries. We find that differentiation tends to affect TCP traffic (reducing rates by up to 60%) and that interference from middleboxes (including video-transcoding devices) is pervasive. By exposing such behavior, we aim to improve transparency for users and inform future policies.

**Categories and Subject Descriptors:**
C.2.2 [Computer-Communication Networks]: Network Protocols

**Keywords:**
Traffic differentiation, mobile networks, network neutrality

## 1. Introduction
The increasing popularity of bandwidth-hungry applications (e.g., Netflix) and resource-constrained networks (e.g., mobile providers) has reignited discussions about how different applications' network traffic is treated by ISPs. One common approach to managing scarce network resources is traffic differentiation, which involves giving better or worse performance to certain classes of network traffic using devices that selectively act on network traffic (e.g., Sandvine, Cisco, and others). Differentiation can enforce policies ranging from protecting the network from bandwidth-hungry applications to limiting services that compete with those offered by the network provider (e.g., providers that sell voice/video services in addition to IP connectivity).

Recent events have highlighted traffic differentiation and network neutrality issues in wired settings, with public disputes between Comcast and Netflix over congestion on network interconnects. In the mobile setting, regulatory agencies have historically imposed few restrictions on how mobile providers manage their networks, leaving subscribers and regulators with limited ability to understand and hold providers accountable for management policies. Despite the importance of this issue, the impacts of traffic differentiation on specific applications and the Internet as a whole are poorly understood. Previous efforts to detect traffic differentiation (e.g., [6, 30, 36, 37]) have been limited to specific types of application traffic or focused on general classes of traffic rather than specific applications. Addressing these limitations is challenging due to the wide variety of applications (often closed-source) that users may wish to test for differentiation, coupled with the closed nature of traffic shapers. As a result, external observers struggle to detect if such shapers exist in networks, what exactly these devices do, and their impact on traffic. 

This paper tackles three key challenges that have held back prior work on measuring traffic differentiation:
1. The inability to test arbitrary classes of applications.
2. A lack of understanding of how traffic shaping devices work in practice.
3. The limited ability to measure mobile networks (e.g., cellular and WiFi) from end-user devices such as smartphones and tablets.

Designing methods that can measure traffic differentiation in mobile networks presents unique challenges, as the approaches must work with highly variable underlying network performance and within the constraints of mobile operating systems. By addressing these challenges, we can provide tools that empower average users to identify differentiation in mobile networks and use data gathered from these tools to understand differentiation in practice.

This paper makes the following key contributions:
- **System Design and Implementation:** We design and implement a system for detecting traffic differentiation in mobile networks. Our solution uses a VPN proxy to record and replay arbitrary application traffic, enabling testing of any network application, even if it is closed source. This does not require special privileges on client devices, making it readily deployable on a global scale. We implement this both as an Android and desktop application.
- **Validation with Commercial Shaping Devices:** To the best of our knowledge, we are the first study to validate that our detection system correctly triggers differentiation on commercial shaping devices. Using a testbed with two such devices, we establish a ground truth to evaluate the accuracy of our approach and identify several pitfalls of previous approaches.
- **Statistical Techniques Evaluation:** We systematically evaluate the accuracy of different statistical techniques for identifying differentiation using our testbed with commercial shaping products, a controlled network with no differentiation, and controlled loss with Linux Traffic Control (tc).
- **Android App and Measurement Study:** We develop an Android app that conducts our differentiation tests on unmodified Android OSes, as part of an IRB-approved study of differentiation in mobile networks worldwide. We deploy our software in the US and four other countries, finding several instances of shaping, in addition to pervasive interference from middleboxes.

Our study is the first to reliably detect differentiation from mobile devices without special privileges and identifies several instances of middleboxes violating end-to-end principles for a variety of popular apps. Specifically, we find evidence of video transcoding, HTTP header manipulation in requests and responses, and proxies that modify TCP behavior. While previous work identified such behavior for web traffic, we are the first to do so for arbitrary app traffic.

The following section discusses related work and defines the types of differentiation we detect. After detailing our key contributions, we discuss issues with differentiation and its detection that are beyond the scope of this work, and we conclude in Section 8.

## 2. Background
There is an ongoing debate about whether the network should be neutral with respect to the packets it carries; i.e., not discriminate against or otherwise alter traffic except for lawful purposes (e.g., blocking illegal content). Proponents, such as President Obama, argue for an open Internet as essential to its continued success, while some ISPs argue for shaping to manage network resources. The regulatory framework surrounding traffic differentiation is rapidly changing; between the submission and publication of this manuscript, the FCC transitioned from imposing few restrictions on how mobile providers manage their network to new rules that prohibit many forms of differentiation. In this environment, it is important to monitor traffic differentiation in practice, both to inform regulators and enforce policies.

### 2.1 Related Work
Comcast’s blocking of BitTorrent in the mid-2000s spurred research efforts to study traffic differentiation. This led to several studies focusing on applications or flows known to be subject to classification and designing tests to detect differentiation on those flows. For example, Glasnost focuses on BitTorrent, and NetPolice tests five applications (HTTP, BitTorrent, SMTP, PPLive, and VoIP). BonaFide takes a similar approach in the mobile environment, including tests for HTTP, FlashVideo (YouTube), SIP, RTSP, BitTorrent, and VoIP H323. These approaches focus on protocols rather than specific application implementations. A key limitation is that the shaping devices observed support application/provider granularity, e.g., shape RTSP traffic for one content provider but not other RTSP applications. Such application-based differentiation may not be detected by these systems. They also require manually implementing protocol details, limiting extensibility. We address these limitations in this work.

Furthermore, these projects treat traffic differentiation as a “black box” and aim to detect it by sending traffic and observing network performance metrics. Notably, these prior studies lack ground-truth information about how differentiation is implemented and whether their detection mechanisms would trigger traffic shaping in practice, an issue we address in this work.

Another approach avoids testing specific applications and focuses on detecting differentiation for arbitrary traffic. NANO uses Bayesian analysis to detect differentiation, while Zhang et al. focus on identifying when it is feasible to detect and isolate differentiation. Other related projects focus on performance issues in ISPs and shaping of all of a subscriber’s traffic but do not detect differentiation itself.

Other related studies detect proxies on network paths and conduct tests to identify a wide range of application-specific proxy behaviors. A recent paper specifically focuses on proxies and other middleboxes in mobile networks, discussing how these devices vary according to mobile virtual network operator (MVNO). Zarinni et al. use BonaFide to test for differentiation of BitTorrent, VoIP-H323, and RTSP in MVNOs. The authors did not observe differentiation of this limited set of applications; in contrast, our approach identified differentiation in three of the networks they tested.

### 2.2 Differentiation Considered in Our Work
In this work, we consider the problem of detecting differentiation caused by traffic-shaping middleboxes, focusing on the mobile environment due to minimal regulation and scarce network resources. However, our techniques also work in the fixed-line environment. We focus on differentiation affecting network performance as perceived by applications. In our experiments, we observe that even high-bandwidth mobile applications such as video streaming do not necessarily exhaust the available bandwidth, possibly to avoid wasting data transfer in case of viewer abandonment. This contrasts with protocols like BitTorrent, which aim to saturate the link bandwidth. For applications that do not exhaust the available resources, we do not consider traffic shaping where the shaping rate is higher than the bandwidth demands to be differentiation. For example, if a shaper limited a given application to 200 KB/s, but the application never sent faster than 150 KB/s, we would not consider this differentiation. This more conservative approach gives us a clearer picture of shaping that actually impinges on the network resource demands of applications.

We assume that traffic differentiation is likely triggered by at least one of the following factors: IP addresses, port numbers, payload signatures, number of connections, total bandwidth, and time-of-day. We confirmed these assumptions are consistent with features listed in online manuals of deep packet inspection (DPI) devices and traffic shapers. We also run experiments with two commercial packet shapers and show that our assumptions hold for these devices (Section 4.2).

In this work, we do not focus on detecting congestion at peering points, a tactic used by certain ISPs to extract payment from large bandwidth consumers. We also do not focus on blocking (e.g., censorship) or content modification (e.g., transcoding) by middleboxes. While our methodology can detect these types (and we found cases of both), they are orthogonal to the issue of shaping.

## System Overview
Figure 1 provides an overview of our system:
- **(a) Record:** The client connects to a VPN, which records the traffic between the client and the app server(s).
- **(b) Parse:** The parser produces transcripts for replaying.
- **(c) Replay:** The client and replay server replay the recorded traffic both with and without the VPN.
- **(d) Analyze:** The system analyzes the differences in network behavior to identify traffic differentiation.

By providing a comprehensive and reliable method for detecting traffic differentiation, we aim to enhance transparency and inform future policies in the mobile networking landscape.