### 概述
Mimecast 研究人员发现，微软 Excel 中的 Power Query 工具存在一个漏洞，该漏洞可被用于远程执行嵌入的恶意负载。Power Query 是 Excel 的一个插件，也是 Power BI 的一个组件，它通过简化数据发现、访问和协作过程来增强商业智能自助服务体验。

研究人员发现，攻击者可以利用 Power Query 发动复杂的且难以检测的攻击。具体来说，攻击者可以在单独的数据源中嵌入恶意内容，并在打开这些内容时将其加载到表格中。这种攻击方式允许攻击者释放并执行能够入侵用户机器的恶意软件。此外，该漏洞还使攻击者能够在传播负载之前对沙箱或受害者机器进行指纹识别，从而绕过安全解决方案。

### Power Query 作为攻击面的潜在风险分析
由于 Power Query 是 Excel 中的一个强大工具，因此其被滥用的威胁也非常大。如果该漏洞被利用，可能会引发涉及本地权限提升、DDE 攻击和远程代码执行的复杂攻击。Power Query 可以让攻击者轻松地动态嵌入远程内容，这种攻击很难被检测到，为攻击者提供了更多机会来入侵受害者的机器。

为了演示 Power Query 如何被用于发起 DDE 攻击，研究人员创建了一个示例。在这个示例中，保存负载的外部网页被加载到电子表格中，同时设置了一个简单的 HTTP 服务器来监听 80 端口并将 DDE 内容作为响应消息发送给电子表格。以下是具体的步骤：

1. **HTTP 服务器设置**：
   - 监听 80 端口。
   - 将 DDE 内容作为来自电子表格的请求的响应消息。

2. **Excel 表格配置**：
   - 使用 Power Query 请求恶意网页（`http://127.0.0.1:80`）。
   - 远程内容被取回并加载到电子表格中。

3. **Wireshark 数据包捕获**：
   - 第一个标记包含 DDE 格式：`payload.exe` 保存的 `dropbox.com` DNS 请求。
   - 保存和传播负载的 HTTPS 会话。

### 文件格式分析
文件格式分析显示，`table/table1.xml` 是使用特征 `name: “localhost”`（默认）和 `type: “queryTable”` 创建的。表和特定查询表特征的链接在 `._rels/table1.xml.rels` 中描述，其中包含 `target` 域，指向 `../queryTables/queryTable1.xml`。`queryTable1.xml` 包含使用 `connectionId` 域链接 `connection.xml` 的数据。链接是通过 `Select *` 命令和 `dbPr` 对象实现的。

Web 查询本身保存在文档 `xl\customXML\item1` 中，并以 base64 编码。解码后，可以看到查询本身。为了让 DDE 运行，用户需要双击单元格来加载 DDE，然后再次点击来释放。这些操作会触发 DDE 并启动从 Web 接收的负载。

### 绕过双击：启用自动执行
为了绕过需要用户双击才能运行的问题，研究人员进一步分析了旧版本 Office 中的 `Get External Data >> From Web` 实现。在 Office 2016 中，会创建 `dbPr`，用户会被要求激活负载。而在旧版本 Office（如 2010 版本）中，在 `Connections.xml` 下创建的对象是 `webPr` 而不是 `dbPr`。与 `dbPr` 不同，`webPr` 更简单，不需要任何交互即可运行负载。

### 绕过 AV 和沙箱：使用有漏洞的 Power Query 工具
通过在 Web 请求（查询）中添加特定的 HTTP 头，负载可以绕过拦截特定恶意内容的反病毒软件（AV）和沙箱。只有当请求中存在某个特定的 HTTP 头时，Web 服务器才会提供恶意内容。例如，只有当 `Referer` HTTP 头设置为 `www.google.com` 时，DDE 才会提供恶意内容。

使用 Power Query 的高级模式可以设置特定的 Web 头。Power Query 执行带有 `Referer` 头的 Web 请求。如果其他应用程序试图模拟 Power Query 的行为但没有使用正确的 `Referer` 头来请求 Web 页面，则只有使用 Excel 应用程序打开原始文档时负载才会工作。

为了避免被沙箱检测，Power Query 中使用了 `auto refresh` 和 `refresh interval` 功能。通过强制文件在打开时移除外部数据源中的数据并更新数据，可以避免将文件标记为恶意软件。这些功能确保文件中的负载在文件打开时更新。通过设置文件每分钟更新并在第 10 次查询时提供负载，沙箱在 10 分钟内无法获取负载。

在这种情况下，大多数静态分析 AV 无法检测该文件，而沙箱和其他安全解决方案在下载一次或两次内容后也会错过负载。

### 微软响应
微软安全响应中心 (MSRC) 收到了 Mimecast 安全研究人员提供的 PoC 和相关信息，但决定不修复该行为。不过，微软建议使用组策略来拦截外部数据连接，并在公告 (4053440) 中提供了指导，帮助用户确保应用程序在处理 DDE 域时的安全性。