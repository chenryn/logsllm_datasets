# 百度全系APP SDK漏洞分析报告 - WormHole虫洞漏洞

#### 译文声明
本文为翻译文章，原文来源：乌云  
原文地址：[链接]  
译文仅供参考，具体内容和含义请以原文为准。  
**作者: 瘦蛟舞, 蒸米**

> “You can’t have a back door in the software because you can’t have a back door that’s only for the good guys.” – Apple CEO Tim Cook  
> “你不应该给软件装后门，因为你不能保证这个后门只有好人能够使用。” – 苹果CEO 蒂姆·库克

### 0x00 序
网络安全的早期阶段，人们对于RPC冲击波、WebDav等远程攻击漏洞以及由此产生的蠕虫病毒仍记忆犹新。黑客通过编写程序扫描网络中开放特定端口的机器，并发送对应的远程攻击代码来控制主机。一旦控制了主机，该程序可以继续扫描其他机器并进行进一步攻击。由于这些漏洞存在于主机本身，修复它们需要安装补丁。然而，很多人并不会及时升级系统或安装补丁，导致这些漏洞或蠕虫在很长一段时间内影响大量机器，甚至有的蠕虫病毒可以感染全球上亿台服务器，对企业和个人造成严重损失。

随着Android系统的发布，我们一直期望能发现像PC上的远程攻击一样严重的漏洞。但Android系统默认并未开放任何端口，且开放socket端口的应用也非常少见，似乎出现类似PC那样严重的漏洞几乎是不可能的。然而，世界上并没有绝对的安全，在这少数几个端口中，我们确实发现了一个非常严重的socket远程攻击漏洞，影响了多个用户量过亿的应用程序。我们将此漏洞命名为WormHole（虫洞）漏洞。

### 0x01 影响和危害
WormHole漏洞到底有多严重？以下是受影响的应用列表（尚未统计完全）：

- 百度地图 检测版本8.7
- 百度手机助手 检测版本6.6.0
- 百度浏览器 检测版本6.1.13.0
- 手机百度 检测版本6.9
- hao123 检测版本6.1
- 百度音乐 检测版本5.6.5.0
- 百度贴吧 检测版本6.9.2
- 百度云 检测版本7.8
- 百度视频 检测版本7.18.1
- 安卓市场 检测版本6.0.86
- 百度新闻 检测版本5.4.0.0
- 爱奇艺 检测版本6.0
- 乐视视频 检测版本5.9

以上是2015年10月14日统计的百度系应用最新版本，理论上所有小于等于检测版本的这些百度系应用都有被远程攻击的风险。根据易观智库的统计排行，手机百度、百度手机助手、百度地图等百度系应用拥有上亿的下载安装量，活跃用户总数超过三亿。

安装了这些百度应用会带来哪些后果和危害？

无论是在WiFi无线网络还是3G/4G蜂窝网络下，只要手机处于联网状态，都可能受到攻击。攻击者无需接触手机，也无需使用DNS欺骗。此漏洞仅与应用相关，不受系统版本影响，在最新的Android 6.0上测试成功。

漏洞可达到以下攻击效果：
- 远程静默安装应用
- 远程启动任意应用
- 远程打开任意网页
- 远程静默添加联系人
- 远程获取用户的GPS地理位置信息、IMEI信息、安装应用信息
- 远程发送任意Intent广播
- 远程读取和写入文件等

以下是展示打开任意网页、远程安装应用以及添加联系人的视频演示：
[视频链接](http://www.leiphone.com/news/201510/abTSIxRjPmIibScW.html)

### 0x02 漏洞分析
安装百度系应用后，通过adb shell连接手机并使用netstat命令，会发现手机打开了40310/6259端口，并且任何IP都可以进行连接。原来这个端口是由Java层的nano http实现的，百度将其称为immortal service（不朽服务）。为什么叫“不朽”呢？因为这个服务会在后台持续运行，如果手机中安装了多个存在wormhole漏洞的应用，这些应用会时刻检查40310/6259端口。如果监听该端口的应用被卸载，另一个应用会立即启动服务重新监听该端口。

进一步分析发现，整个immortal service实际上是一个HTTP服务，但在接受数据的函数中有一些验证，例如HTTP头部remote-addr字段是否为“127.0.0.1”。但具备一定Web技巧的人可以通过伪造头部信息将remote-addr字段改为“127.0.0.1”。

成功与HTTP服务器通信后，可以通过URL向应用下达指令。以百度地图为例，以下是百度地图应用中存在的远程控制指令的反汇编代码：
- `geolocation` 获取用户手机的GPS地理位置（城市、经度、纬度）
- `getsearchboxinfo` 获取手机百度的版本信息
- `getapn` 获取当前的网络状况（WIFI/3G/4G运营商）
- `getserviceinfo` 获取提供nano http的应用信息
- `getpackageinfo` 获取手机应用的版本信息
- `sendintent` 发送任意Intent，可以用来打开网页或其他应用交互
- `getcuid` 获取IMEI
- `getlocstring` 获取本地字符串信息
- `scandownloadfile` 扫描下载文件（UCDownloads/QQDownloads/360Download...）
- `addcontactinfo` 给手机增加联系人
- `getapplist` 获取全部安装应用信息
- `downloadfile` 下载任意文件到指定路径，如果是APK则进行安装
- `uploadfile` 上传任意文件到指定路径，如果是APK则进行安装

看到这些远程指令时，我们感到震惊。一个导航应用为什么要给别人添加联系人？更夸张的是，安装应用不是弹出对话框让用户选择是否安装，而是直接申请root权限进行静默安装。以下是代码片段：

可以看到下载完应用后会有三个判断：
- 如果手机助手是系统应用，则直接使用`android.permission.INSTALL_PACKAGES`权限静默安装应用。
- 如果手机助手获得root权限，则使用`su`执行`pm install`静默安装应用。
- 其他情况下，会弹出安装确认框。

普通用户通常非常信任百度系应用，如果百度系应用申请root权限，一般都会通过，但这实际上是打开了潘多拉魔盒。

如果没有root权限，就不能静默安装应用了吗？不是的。`downloadfile`和`uploadfile`可以选择下载文件的位置，而百度系应用会从`/data/data/[app]/`目录下动态加载一些dex或so文件。这时，只需利用`downloadfile`或`uploadfile`指令覆盖原本的dex或so文件，就可以执行任意代码。例如，利用dex或so获取反弹shell，然后将提权的exp传到手机上执行，从而获得root权限，进而可以做任何想做的事情。

### 0x03 POC
由于影响过大，暂不公布POC，将在WormHole漏洞修复后更新。

### 0x04 测试
我们简单测试了一下WormHole漏洞的影响性。我们知道3G/4G下的手机实际上都处于一个巨大的局域网中，只要通过4G手机开启热点，就可以用电脑连接热点并使用扫描器和攻击脚本对全国甚至全世界连接3G/4G的手机进行攻击。在家远程入侵一亿台手机不再是梦。

我们使用获取包名的脚本对电信的下一个C段进行了扫描，结果如下：
- 在255个IP地址中，有16个手机存在WormHole漏洞。

此外，我们发现华为、三星、联想、金立等公司的某些机型在中国出厂时都会预装百度系应用，这使得情况更加严峻。

### 0x05 总结
我们在2015年10月14日通过乌云平台向百度提交了WormHole漏洞报告，百度已经确认了漏洞并开始进行修复。但这次漏洞不能通过服务器端修复，必须通过升级应用的方式进行修复。希望用户得到预警后尽快升级自己的应用到最新版本，以免被WormHole漏洞攻击。