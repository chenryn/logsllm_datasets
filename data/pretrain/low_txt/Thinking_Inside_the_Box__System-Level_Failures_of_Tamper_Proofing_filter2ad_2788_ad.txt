This document will outline a series of scenarios that designers must verify, thereby making the combinational complexity of options explicit and helping to control their proliferation. Protocol options and their negotiation procedures are significant contributors to the system flaws we have identified. (Similar issues have been found in other security applications, such as SSL's cipher-suite and version negotiation [43].) Although the EMV specification provides a compact way to describe the myriad of options, a security evaluation must consider every relevant combination.

### 4.4 Analysis of PED Security

Using the methodology described above, we now present an example of its application to EMV PED security, focusing on the suite of options used in the UK: no PIN encryption, ubiquitous magnetic strip fallback, and no iCVV option. There are four primary tamper-proof boundaries, as shown in Figure 5: the merchant, the PED, the card, and the customer. We do not need to discuss CPU protection, as it is entirely enclosed within the PED, and the bank HSM is outside the scope of this paper. The assets to be protected are:

- **Card Details**: Stored by the card and sent from the card to the PED.
- **PIN**: Stored by the card, entered by the customer into the PED, and then sent from the PED to the card.
- **Item Value**: Displayed on the PED screen for the customer.

With the card details and PIN, a fraudulent magnetic-strip card can be created, so maintaining their confidentiality is crucial. Additionally, if the value displayed on the PED screen does not match what the card processes, the customer may be defrauded. Here, we only address the system issues arising from information crossing tamper boundaries. We do not discuss internal PED code or root-certificate integrity, as these are internal to the PED system and would be covered in its documentation.

Given these definitions, the flaws in EMV become apparent. The PIN is protected by the smartcard; a tamper-resistant chip will lock up after too many incorrect attempts, preventing direct retrieval. However, the PIN and card details are transmitted through the PED, which may or may not protect one or both. Data may leak at the card-PED interface, and card data may also leak if the PED-bank link is unencrypted. Finally, since the customer cannot trust the terminal display, they are vulnerable to relay attacks.

We can also examine potential defenses. If encrypted PIN verification is used and unencrypted transmission is not possible, the requirement for the card-PED interface to physically protect PIN confidentiality can be dropped. If magnetic strip fallback is not permitted or the iCVV option is used, the interface no longer needs to protect card details. However, if some banks do not use encrypted PIN and iCVV, PEDs must be robust against shims (e.g., using a full metal enclosure and card-handling machinery like ATMs), or customers should be indemnified against the costs of resulting fraud. Regardless of physical or cryptographic security, the trusted interface problem remains. A combination of technical measures and indemnity must be used to mitigate relay attacks.

### 5 The Certification Process

The exercise described in this paper has been particularly instructive in highlighting the weaknesses of Common Criteria evaluations. Until about a year ago, market forces could exert some discipline on vendors. For example, in 2006, Shell withdrew EMV terminals from its UK fuel stations following a fraud involving PED tampering and fell back on magnetic strip processing for several months [9]. Their PED vendor, Trintech, sold its terminal business to VeriFone and left the market [37]. Since then, there has been rapid consolidation, with Ingenico and VeriFone controlling most of the market. Most merchants get their terminals from their banks, which often offer only one type of terminal. Banks have been found guilty of insufficient competition in providing credit card services to merchants in 1989 and 2005 [32, 33].

Thus, customers and merchants now rely critically on the certification of terminals, PEDs, smartcards, and other system components used in the EMV system. Some certification schemes, such as EMV Level 1 [22], ensure compatibility, while others involve extensive security evaluations. Both PEDs we examined are certified under the Visa PED approval scheme [42], and the Ingenico PED passed the APACS PED ‘Common Criteria’ Evaluation [7] despite the vulnerabilities we identified.

The survey by Yang et al. [46], conducted mostly in 2005, identified the classes of vulnerabilities we found and suggested physical mitigation techniques. It was surprising because their paper acknowledged the cooperation of Ingenico engineers, yet these flaws still exist. While they discussed points of failure in the abstract, we have shown that these and other failures do exist, can break EMV as deployed, and are easy to find in real PEDs, including Ingenico’s. What does this tell us about the evaluation and certification process?

#### 5.1 Why Evaluations Fail

A security failure in an evaluated product can have multiple causes. The Common Criteria (or other framework) might be defective, the protection profile might not specify adequate protection, or the evaluator might miss attacks or overestimate their cost and complexity. One known issue with the Common Criteria is the proliferation of protection profiles. Anyone can propose a protection profile for any purpose and get a lab to evaluate it, leading to a large number of profiles that provide little assurance. For example, the ATM profile is written in management-speak, complete with clip art, states that it “has elected not to include any security policy,” and misses many well-known problems [16].

A deeper problem in the security evaluation process is the economics involved. Since the demise of the philosophy behind the Orange Book [14], evaluations are performed by a laboratory selected and paid by the device manufacturer. Vendors naturally choose the lab that will give their product the easiest ride and charge the least. This applies to the protection profiles as well.

Market competition may help reduce evaluation costs but promotes a race to the bottom between labs. To mitigate this, approved labs must be used, selected by Visa for PED approval or by national bodies like NIST in the USA or GCHQ in Britain for the Common Criteria. In principle, this provides some quality control, but in practice, agencies rarely deapprove licensed labs, fearing a loss of confidence in the system. Government agencies may also be reluctant to drive evaluation work abroad. These concerns were expressed by Anderson [3], who describes several cases of clearly mistaken evaluations in the 1990s. The vulnerabilities described in this paper provide another such case. Was this evaluation failure systemic, or the fault of an individual evaluator?

#### 5.2 Government and Industry Response

In November 2007, we wrote to GCHQ, Visa, APACS, Ingenico, and VeriFone (Dione) with an early draft of this paper, asking for comments. In February 2008, the BBC’s ‘Newsnight’ program filmed our research, including an attack on a real terminal in a real store, yielding a journalist’s card details and PIN (with the consent of the store owner and the journalist). The imminent broadcast prompted responses from GCHQ, APACS, and VeriFone. Ingenico did not respond to our questions, and Visa did not acknowledge receipt of our original disclosure three months earlier (though they downloaded our paper following our email, and one evaluation lab downloaded it from the URL we provided to Visa). We asked for copies of the evaluation reports, why these reports weren’t public, whether the insecure PEDs would be decertified, whether the labs that negligently certified them as secure would lose their licenses, and whether the evaluation system should be changed.

VeriFone’s response was evasive, pushing responsibility to APACS, Visa, and GCHQ. APACS, the bankers’ trade association, claimed that previous evaluations “did not identify any specific vulnerabilities in the devices that required additional mitigation.” They denied that the evaluations were defective and said the devices would not be withdrawn as they disagreed with our risk assessment, stating that the attack was harder than we described and that simpler fraud methods existed.

APACS claimed, “The numbers of PED compromises that have taken place in the UK are minimal, and the banking industry’s standard fraud prevention measures have meant that these frauds and their location were detected quickly.” (In two current criminal cases, defendants are accused of stealing eight-figure sums using tampered PEDs.) APACS refused to name the evaluation labs and insisted that evaluations had to be carried out under non-disclosure agreements. They stated, “we are not aware of any widely recognized and credible evaluation methodology process, in security or otherwise, which makes evaluation reports publicly available.”

GCHQ’s response was equally uncompromising but different. They informed us that evaluation reports for Common Criteria-certified devices must be made public, as a condition of the mutual recognition arrangement. It transpired that the Ingenico device was merely ‘evaluated’ under Common Criteria, not ‘certified,’ and hence not subject to oversight by GCHQ or any other country’s Certification Body (CB). All certified products are listed on the Common Criteria Portal [15], although under the confusingly titled “List of evaluated products.” As of February 2008, no PEDs are present on this list.

In fact, the certification for the Ingenico PED was performed by APACS, based on a secret report by an undisclosed laboratory. This laboratory is licensed by a CB to perform certifications, but APACS refused to identify the country in which the lab was registered and thus which CB was responsible. Had the devices gone through certification, it would have been the CB’s job to ensure the security target was appropriate and proper testing was conducted. APACS said the decision to revoke the laboratory’s license is the responsibility of the CB that registered it. But since the PED evaluation was done outside the Common Criteria system, and as far as we know without knowledge of any CB, it is unclear how the errant lab could be disciplined.

As a Certification Body, GCHQ does not object to anyone calling any device ‘Common Criteria Evaluated’ and will only object if a false claim is made that a device is ‘Common Criteria Certified.’ This undermines their brand, allowing organizations like APACS to free-ride by exploiting the ‘Common Criteria’ name without rigorous evaluation or publishing results. GCHQ admits that as the licensing authority, it has an interest: “The CB then has a direct involvement in maintaining the quality of each of the individual evaluations for certification. These mechanisms counter any tendency for such a ‘race to the bottom.’” Regrettably, their confidence is not consistent with the research reported in this paper.

For both devices, the proximate cause of evaluation failure was that the equipment did not meet the protection goals set out in either the Visa certification requirements or the APACS ‘Common Criteria’ protection profile. A deeper cause was that these requirements were unrealistic; given the shim attack, it is unclear that any compact, low-cost device can meet either of them, and so the labs may have faced an impossible task. We argue that the protection profile should never have assumed that the card-PED interface could be protected at all.

The banks clearly had an incentive to pretend it could be; by using cheap SDA cards instead of more expensive DDA/CDA cards, they saved perhaps $1 per card over 70 million accounts. The failure of the CC CB to protect its brand gave them the opportunity to describe insecure terminals as ‘Common Criteria Evaluated’ without legal penalty. (Indeed, one of us has seen banking industry expert witnesses relying on the fact that a terminal was ‘certified’ in testimony in a case currently before the courts.)

The failure of EMV was multi-factorial: too many protocol options, liability dumping, an over-optimistic protection profile, ‘evaluations’ funded by vendors, and failures of both markets and regulation at various levels. What should be done about it?

#### 5.3 Fixing the Evaluation Process

Unfortunately, Common Criteria evaluations seem most prevalent where incentives are skewed—where one principal operates a system, but others bear the costs of failure. This tempts the operator to be careless—a phenomenon known to economists as ‘moral hazard.’ It is now well known that moral hazard is a major cause of security failure, and evaluation may be sought as a way of avoiding blame for failures by demonstrating due diligence [3].

We believe the certification process should be re-engineered to take heed of incentives and accountability.