# Security by Any Other Name: On the Effectiveness of Provider-Based Email Security

**Authors:**  
Ian D. Foster, Jon Larson, Max Masich, Alex C. Snoeren, Stefan Savage, and Kirill Levchenko  
{idfoster, mmasich, snoeren, savage, klevchen}@cs.ucsd.edu  
Department of Computer Science and Engineering, University of California, San Diego

## Abstract
Email as we use it today does not provide guarantees for message integrity, authenticity, or confidentiality. Users must explicitly encrypt and sign message contents using tools like PGP if they wish to protect themselves against tampering, forgery, or eavesdropping. However, few users do this, leaving the majority vulnerable to such attacks. Transport-layer security mechanisms (available as extensions to SMTP, IMAP, and POP3) offer some protection against network-based eavesdropping. Additionally, DKIM and SPF help protect against network-based message forgery and tampering.

In this work, we evaluate the security provided by these protocols, both in theory and in practice. Using a combination of measurement techniques, we determine whether major providers support TLS at each point in their email message path and whether they support SPF and DKIM on incoming and outgoing mail. Our findings show that while more than half of the top 20,000 receiving MTAs support TLS, and support is increasing, servers do not check certificates, making the system vulnerable to man-in-the-middle eavesdropping attacks. SPF usage is common but enforcement is limited, and few senders use DKIM, with even fewer rejecting invalid DKIM signatures. The global email system provides some protection against passive eavesdropping, limited protection against unprivileged peer message forgery, and no protection against active network-based attacks. We observe that protection against these latter attacks is possible with proper enforcement of existing protocols.

## 1. Introduction
Despite the availability of software support for PGP and S/MIME, few users sign or encrypt their emails. Most email users continue to send messages in the clear, with no safeguards against eavesdropping, tampering, or forgery. Despite growing public concern about mass surveillance, universal end-to-end email security remains elusive.

While user adoption of email security tools has been poor, the use of lower-layer security mechanisms, such as TLS, SPF, and DKIM, has been increasing. Google recently reported 59% adoption of TLS by sending servers and 79% by receiving servers. Our own measurements (reported in this work) echo these statistics. We explore whether some of the security goals of end-to-end tools like PGP can be achieved using these protocols. When used correctly and enforced, TLS and DKIM with DNSSEC can protect against active network-based man-in-the-middle attacks. These guarantees, however, require trusting the provider, which is not necessary when using end-to-end security mechanisms like PGP.

Whether email providers are trustworthy is a separate, important question that we do not address in this work. For some, any solution requiring trust in an email provider is unacceptable. For others, trusting an email provider is a given. Even Google’s End-to-End initiative, based on OpenPGP, delegates key verification to centralized providers. Our work focuses on what guarantees TLS, DKIM, and SPF can provide if the provider is already trusted. The use of these provider security mechanisms does not preclude users from also using an end-to-end mechanism.

If securing email against network attacks is possible using existing protocols, we must ask whether these protocols are being used effectively. This paper examines whether the current deployment of TLS, DKIM, and SPF provides the level of security possible under ideal conditions. To answer this, we measured the level of support for TLS, DKIM, and SPF among top email providers and determined whether they enforce correct protocol use. Because DKIM and SPF depend on DNS for protection against active attackers, we also measured the use of DNSSEC among providers.

We used a combination of active probing techniques, some of which are new and of independent interest to the Internet measurement community. To determine the protection TLS provides against eavesdropping, we checked whether TLS was supported and used along each hop between two providers, and whether server certificate checking was done. For hops internal to a provider where we could not interact with servers directly, we relied on information in Received email headers. For DKIM and SPF, we measured support on the sending end by examining messages generated by providers, retrieving the necessary DNS records, and noting support for DNSSEC. On the receiving end, we measured provider verification of DKIM signatures and enforcement of SPF policies by generating mail of varying levels of conformance.

Our main contributions are:
- A methodology for determining TLS use along the full message path between two providers.
- An analysis of the current state of TLS, DKIM, SPF, and DNSSEC deployment.
- A description of how correct use of these protocols can provide message confidentiality and integrity in a relaxed threat model, and the changes necessary in the current Internet email ecosystem to achieve this level of security.

The rest of the paper is organized as follows: Section 2 describes the threat model. Section 3 provides the necessary technical background. Section 4 details our methodology. Section 5 presents the final analysis of our collected data. Section 6 lists related work. Section 7 discusses the implications of our results. Section 8 concludes the paper.

## 2. Threat Model
This paper focuses on the confidentiality, integrity, and authenticity of email communications achieved when TLS, DKIM, SPF, and DNSSEC are used. We consider three types of network-based attackers:
- **Active (Man-in-the-Middle):** Can observe and modify all packets and inject arbitrary packets between a target and the rest of the Internet.
- **Passive:** Can observe but not modify traffic between a target and the rest of the Internet.
- **Peer:** An ordinary host connected to the Internet, capable of sending arbitrary packets and receiving packets for which it is the destination.

We assume no other attacker capabilities, and that email providers are trusted and do not collude with network attackers. This assumption is not prescriptive; rather, it is a logical antecedent of our results. If the provider is trusted and the protocols are used correctly, a certain level of security against a network attacker can be achieved.

## 3. Background
This section describes the security achievable when TLS, DKIM, SPF, and DNSSEC are used correctly. We also identify points where protocol failure would compromise overall security. We expect most readers to be familiar with these protocols, but the Appendix provides additional background.

### 3.1 Security Properties
The security properties of concern are:
- **Confidentiality:** Can an attacker read a message?
- **Authenticity:** Can an attacker forge a message?
- **Integrity:** Can an attacker modify a message?

We consider attacks on confidentiality by active and passive attackers, attacks on authenticity by active and peer attackers, and attacks on integrity by active attackers only.

### 3.2 Mail Path
A typical mail message path is shown in Figure 1. Starting with the sending user's Mail User Agent (MUA), the message is transmitted to the sender’s mail provider using SMTP, HTTP via a Web interface, or a proprietary protocol. After processing inside the provider, the message is transmitted to the recipient’s provider using SMTP. After receiver processing, which may include spam filtering, the message is delivered to the recipient using IMAP, POP, HTTP via a Web interface, or a proprietary protocol.

### 3.3 Confidentiality
A network-based eavesdropper may gain access to a message during submission, provider processing, transfer between providers, and delivery. Standard protocols like HTTP, SMTP, IMAP, and POP defend against eavesdropping using TLS encryption. While proprietary protocols used on the submission and delivery hops may use non-standard cryptographic protocols, some providers also use SMTP internally. Communication internal to a provider is usually considered secure, as it is common to collocate a MSA and MTA, or combine the two roles in a single host. At larger providers, internal hops may be located in geographically separate data centers.

Against a passive attacker, it is sufficient to use TLS on all accessible links with a strong cipher suite. Use of the STARTTLS option or direct TLS encapsulation with SMTP, IMAP, and POP or HTTPS will protect against a passive attacker. Provider-internal links may be secured physically or using TLS. Since a passive attacker cannot modify network traffic, it is possible to exchange keys securely without requiring certificate verification.

An active attacker, on the other hand, can impersonate each side of a connection. Defending against a man-in-the-middle attack requires the sender to verify the identity of the receiver. If an active attacker gains control of any hop along the message path and either TLS is not used or TLS is used without server certificate verification, the attacker can impersonate the receiver and gain access to the message.

DNS integrity is not required for TLS if the common name (CN) or the subjectAltName is checked against the intended server domain name. Even if an attacker tricks a client into contacting a server under her control, the client can check that the certificate matches the host name of the intended server.

### 3.4 Authenticity
To forge a message, an attacker must inject it at some point in the mail path in a way that it is accepted by the receiver. To forge a message at submission, the attacker must authenticate as the user to the provider, usually using a password. An active attacker can trick the user into revealing their password by impersonating the provider. Secrecy of the password thus requires server certificate checking by the user agent. Failure to verify the server certificate of the MDA would allow an active attacker to impersonate the MDA, learn the password, and inject a forged message on delivery. Message authenticity and integrity inside a provider can be achieved by physically securing the links or using client certificates.

The hop most vulnerable to forgery is the one between providers. An incoming MTA must determine if the message originated from a provider authorized to send email with the sender's email domain. Both DKIM and SPF provide protection against forgery. DKIM provides a message signature covering the body and a subset of message headers, created by the sender’s provider to convince the recipient’s provider of the message's authenticity and provide protection against tampering. SPF allows a provider to identify authorized senders for the domain, and an incoming MTA can verify that the outgoing MTA is authorized to send email for the domain.

In principle, SPF can protect against forgery by a peer attacker by allowing only certain network hosts to send email on behalf of a domain. A peer attack cannot impersonate a host on the allowed list because it cannot complete a TCP connection from an allowed peer. An active attacker, however, can impersonate any host, so SPF provides no protection against an active attacker. DKIM, on the other hand, relies on a digital signature to protect the message, including the sender address, and can protect against message forgery and tampering, even against an active attacker. DKIM relies on DNS for key distribution, and a message from example.com requires a specific TXT record in a special subdomain of the sender’s domain.