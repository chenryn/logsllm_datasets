# Detecting Malware Domains at the Upper DNS Hierarchy

**Authors:**
- Manos Antonakakis
- Roberto Perdisci
- Wenke Lee
- Nikolaos Vasiloglou II
- David Dagon

**Affiliations:**
- **Manos Antonakakis, Nikolaos Vasiloglou II, and David Dagon:** Damballa Inc.
  - Email: manos@damballa.com, nvasil@damballa.com
- **Wenke Lee and David Dagon:** Georgia Institute of Technology, School of Computer Science
  - Email: PI:EMAIL, PI:EMAIL
- **Roberto Perdisci:** University of Georgia, Department of Computer Science
  - Email: PI:EMAIL

## Abstract

In recent years, cybercriminals have increasingly leveraged the Domain Name System (DNS) to build malicious network infrastructures for malware command and control. This paper introduces Kopis, a novel detection system designed to identify malware-related domain names by passively monitoring DNS traffic at the upper levels of the DNS hierarchy. By analyzing global DNS query resolution patterns, Kopis can accurately detect malware domains.

Compared to existing DNS reputation systems such as Notos [3] and Exposure [4], which rely on monitoring traffic from local recursive DNS servers, Kopis offers a new vantage point and introduces unique traffic features that leverage the global visibility obtained from upper-level DNS monitoring. Kopis enables DNS operators to independently detect malware domains within their authority, without the need for data from other networks. Additionally, Kopis can detect malware domains even in the absence of IP reputation information, a capability not present in previous systems.

We developed a proof-of-concept version of Kopis and tested it with eight months of real-world data. Our results show that Kopis achieves high detection rates (e.g., 98.4%) and low false positive rates (e.g., 0.3% or 0.5%). Moreover, Kopis can identify new malware domains days or even weeks before they appear in public blacklists and security forums, and it allowed us to discover the rise of a previously unknown DDoS botnet based in China.

## 1. Introduction

The Domain Name System (DNS) [17, 18] is a fundamental component of the Internet. Over the years, cybercriminals have used the DNS to build malicious network infrastructures. For example, botnets [1, 21, 27] and other types of malware use domain names to locate their command and control (C&C) servers and communicate with attackers, often to exfiltrate stolen private information or to wait for commands to perform attacks on other victim machines.

In response to this malicious use of DNS, static domain blacklists containing known malware domains have been used by network operators to detect and block communications originating from malware-infected machines [16, 19]. However, the effectiveness of static domain blacklists is limited due to the overwhelming number of new domain names appearing daily and the frequent switching of domains by attackers, making it difficult to keep blacklists up-to-date.

To overcome these limitations, a detection system that can dynamically detect new malware-related domains is needed. Such a system should:
1. Have global visibility into DNS request and response messages related to large DNS zones, enabling early warning and detection of malware domains before infections reach local networks.
2. Enable DNS operators to independently deploy the system and detect malware-related domains from within their authority zones without the need for data from other networks or inter-organizational coordination.
3. Accurately detect malware-related domains even in the absence of IP reputation data, which is often difficult to accumulate and fragile, especially with the deployment of IPv6.

Following this intuition, we propose Kopis, a novel detection system that leverages the global visibility available at the upper levels of the DNS hierarchy to detect malware-related domains. To meet the above requirements, Kopis must address several challenges, including the strong effects of DNS caching at higher levels of the hierarchy, which restricts the granularity of monitored traffic.

Kopis works by analyzing streams of DNS queries and responses at authoritative name servers (AuthNS) or top-level domain (TLD) servers. It extracts statistical features such as the diversity in the network locations of the RDNS servers querying a domain name, the popularity of the querying RDNS servers, and the reputation of the IP space into which the domain name resolves. Using a set of known legitimate and malware-related domains as training data, Kopis builds a statistical classification model to predict whether a new domain is malware-related based on observed query resolution patterns.

Our choice of Kopis' statistical features, discussed in detail in Section 4, is determined by the nature of the information accessible at the upper DNS hierarchy. These features are significantly different from those used by RDNS-based systems like Notos [3] and Exposure [4], which rely heavily on IP reputation. Kopis' features enable it to accurately detect malware-related domains even without IP reputation information, a significant advantage as IPv6 deployment may impact the effectiveness of current IP reputation systems.

## Contributions

- We developed a novel approach to detect malware-related domain names. Our system leverages the global visibility obtained by monitoring DNS traffic at the upper levels of the DNS hierarchy and can detect malware-related domains based on DNS resolution patterns.
- Kopis enables DNS operators to independently detect malware domains within their scope of authority, allowing them to take action to stop abuse.
- We systematically examined real-world DNS traces from two large AuthNSs and a country-code level TLD server. We performed a rigorous evaluation of our statistical features and identified two new feature families that enable Kopis to detect malware domains even when no IP reputation information is available.
- We developed a proof-of-concept version of Kopis and tested it with eight months of real-world data. Our results show that Kopis can achieve high detection rates (e.g., 98.4%) and low false positive rates (e.g., 0.3% or 0.5%). More significantly, Kopis was able to identify previously unknown malware domain names several weeks before they appeared in blacklists or security forums. Additionally, using Kopis, we detected the rise of a previously unknown DDoS botnet based in China.

## 2. Background and Related Work

### DNS Concepts and Terminology

The domain name space is structured like a tree, where each domain name identifies a node in the tree. For example, the domain name `F.D.B.A.` identifies the path from the root `.` to a node `F` (see Figure 2(a)). The resource information associated with a particular name is composed of resource records (RRs) [17, 18]. The depth of a node in the tree is sometimes referred to as the domain level. For instance, `A.` is a top-level domain (TLD), `B.A.` is a second-level domain (2LD), `D.B.A.` is a third-level domain (3LD), and so on.

The information related to the domain name space is stored in a distributed domain name database, partitioned by "cuts" made in the name space between adjacent nodes. Each group of connected nodes represents a separate zone [17]. Each zone has at least one node for which it is authoritative. The RRs of the nodes in a given zone are served by one or more authoritative name servers (AuthNSs). AuthNSs that have complete knowledge about a zone (i.e., they store the RRs for all the nodes related to the zone in its zone files) are said to have authority over that zone [17, 18]. AuthNSs typically support one or more zones and can delegate the authority over part of a (sub-)zone to other AuthNSs.

DNS queries are usually initiated by a stub resolver on a user's machine, which relies on a recursive DNS resolver (RDNS) to obtain a set of RRs owned by a given domain name. The RDNS is responsible for directly contacting the AuthNSs on behalf of the stub resolver to obtain the requested information and return it to the stub resolver. The RDNS also caches the obtained information up to a certain period, called the Time To Live (TTL), to improve efficiency. Figure 2(b) illustrates the steps involved in a typical query resolution process, assuming an empty cache.

### Related Work

To the best of our knowledge, Wessels et al. [30] were the first to analyze DNS query data from the upper DNS hierarchy. They focused on examining the DNS caching behavior of recursive DNS servers from the perspective of AuthNS and TLD servers and how different caching implementations affect DNS performance. Recently, Hao et al. [13] released a report on DNS lookup patterns measured from the `.com` TLD servers, showing that resolution patterns for malicious domain names differ from those of legitimate domains. While [13] only reports preliminary measurement results and does not discuss detection, it suggests that a malware detection system could be built around TLD-level DNS queries. We designed Kopis to do just that, monitoring query streams at the upper DNS hierarchy to detect previously unknown malware domains.

Several studies provide deep insights into the properties of malware propagation and botnet lifetimes [7, 25, 29]. A key observation is the inherent diversity of the botnet's infected population. Collins et al. [6] introduced and quantified the notion of "network uncleanliness" from both temporal and spatial perspectives, showing that it is likely to have a large number of infected bots in the same network over time. They also discuss that this could be a direct effect of network policies enforced at the edge. Kopis uses the intuition behind these research efforts in the requester diversity and requester profile statistical features.