# 从系统管理员到 SRE
Vladimir Legeza，亚马逊日本

> “如果无法测量它，则无法改进它。”
>
> ——William Thomson, Lord Kelvin

在过去十年中，“站点可靠性工程”（SRE）已成为许多技术公司和系统管理员社区中的公认术语。在很多情况下，SRE被视为一种先进的计算机系统管理方法，与“分布式系统”和“容器化”等关键词紧密相关，代表了一组能够使各种公司高效且经济地支持其系统的实践。

区分站点可靠性工程师（SRE）和传统系统管理员的关键在于视角的不同。传统的系统管理方法侧重于确保系统不会出错或过载。而SRE则根据业务需求来定义所需的系统状态。这两种方法都会使用大量的指标从不同角度监控服务，从单个CPU核心的温度到高级应用程序的堆栈跟踪。然而，相同的指标会导致两种方法得出截然不同的结论。从系统管理员的角度来看，几毫秒的延迟增长可能并不显著，特别是与大量错误相比。但SRE可能会得出相反的结论：即使存在错误，只要最终用户没有受到影响，服务就可以视为正常运行。当然，如果微小的延迟增加确实给客户带来了困扰，那么这就成了一个严重的问题。

让我们通过下面的简短示例来仔细看看这种差异的本质所在。

假设一位经理要求我们创建一个新的小型服务：“一个简化的Web爬虫，它必须接收基础URL、下载其内容，并查找并返回该页面上所有可访问的有效URL列表。”这项任务看起来相对直接，一般软件开发人员可以立即开始实现。然而，经验丰富的系统管理员很可能会尝试了解项目的更多技术细节。例如，他们可能会问：“项目是否有服务级别协议（SLA）？”以及“我们应该预期什么样的负载？我们需要准备应对哪些故障？”此时，先决条件可能很简单，比如“每秒请求不超过10次，并且单个URL请求的响应时间不应超过10秒。”

现在，让我们邀请一名SRE加入对话。他们的第一个问题可能是：“谁是我们的客户？为什么对他们来说在10秒内获得响应很重要？”虽然这些问题主要从商业角度出发，但它们揭示的信息可能会彻底改变游戏规则。如果这项服务是为了满足“信息检索”开发团队的需求，目的是验证搜索引擎结果页上的内容，以确保新索引只提供实时链接呢？如果我们需要下载一个包含一百万个链接的页面怎么办？

这时，我们可以看到SLA中的优先级与服务目的之间存在冲突。SLA指出响应时间至关重要，但服务的主要目标是验证数据，准确性才是对最终用户最重要的方面。因此，我们需要调整项目要求以满足商业需求。有许多方法可以解决这个难题：等待直到检查完所有的一百万个链接，或者只检查前一百个链接，或者设计我们的服务使其能够在合理的时间内处理大量URL。最后一个解决方案不太现实，因此应修改SLA以反映实际需求。

通过上述过程，我们将讨论提升到了一个新的层次——业务层面。我们从服务客户的目标出发，扩展了工作内容。我们理解了服务的用例，确定了关键方面，并建立了符合实际需求的SLA。只有这样，我们才能开始设计解决方案。这正是亚马逊领导原则之一“客户至上”的精髓：“领导者从客户开始，展开工作。”谷歌的十大哲学中也有类似的理念：“关注用户，其他一切自然会水到渠成”。

# 澄清术语
在此，我想提出一个简短的术语澄清，以避免混淆。我们将按照Google《网站可靠性工程》一书第四章中的定义使用这些术语。

## 服务级别指标 (SLI)
服务级别指标（SLI）是一个与服务行为相关的单一可衡量指标，经过精心选择并深入了解其价值含义。每个指标都涵盖了服务的一个特定方面。尽管可以根据具体情况进行衡量，但经验法则是每个指标都必须有意义。

SLI 示例：
- 可用性（每个日历年的请求百分比）
- 响应时间（毫秒）

## 服务级别协议 (SLA)
SLA 是一组组合的 SLI，用于定义用户期望从服务中获得的整体行为。每个指标都有自己的特定值或一系列值。每个可能的值都应明确定义为“好”或“坏”。此外，还应精确指定将“好”变为“坏”的阈值。良好的 SLA 不仅表示一系列保证，还包含了在特定情况下可能发生的所有可能的限制和操作，例如，在主数据中心中断或某个限额用尽时会发生什么情况。

示例 SLA：“每个日历年 99% 的请求应在 200 ms 内送达；每个请求最多包含 10 个块，每个块的有效负载不超过 2 MB；所有超过限额的请求都将尽力而为或完全被拒绝。”

本协议包含四个 SLI：
- 可用性（每个日历年的请求百分比）
- 响应时间（毫秒）
- 数据块大小限制（兆字节）
- 块数的限制（每个请求的块数）

## 服务级别目标 (SLO)
服务级别目标（SLO）与 SLA 相同，但严格程度较低，通常提高了现有 SLA 的等级。SLO 不是我们必需的，而是我们希望达到的目标。

示例：对于前面提到的 SLA，可用性指示器设置为 99%。对于 SLO，我们可能会将此值提高到 99.9%，定义类似于“每个日历年 99.9% 的请求应在 200 ms 内送达。”

SLA 和 SLO 之间的区别仅在于限制的强度。为了简化，我们将只使用 SLA 术语，但所有讨论的内容也适用于 SLO。

用户视角的原则非常强大，引导我们了解重要的服务方面。了解客户的价值观提供了一套精确的期望，最终必须反映在 SLA 中。通过精心设计，SLA 可以揭示项目的许多潜在问题，用于预测和预防困难和障碍。

但是，SLA 首先被指定为参考点，以了解服务的性能。让我们明确应该使用哪些指标来形成一个服务于这一目的的协议。可能有数百个指标反映服务的状态，但并非所有指标都适用于 SLA。尽管 SLI 的数量应尽可能少，但最终列表应涵盖所有主要用户必需资源。

只有两个简单的问题应该正面回答，以表明一个考察项目是否是一个很好的 SLI 候选者：
- 此指标对用户是否可见？
- 此指标对用户（及其作为服务客户的视角）是否足够重要，需要处于特定水平或范围内？

当我们向 SLA 添加指标时，还需要确保该指标对双方（即服务所有者和客户）具有相同的含义。如果由于频繁的项目更改而无法稳定初始 SLA 值，我们可能需要重新审查包含的 SLI 列表，以验证所有指标是否含义明确且可由用户衡量。

例如，SLA 定义如下：
> “每个日历年 99.9% 的请求应在 200 毫秒内送达，只要每秒的请求不超过 1000 个。”

乍一看，这一切都是正确的：我们有保证和限制。但实际上，这种吞吐量 SLI 存在一个基本困难：它有多种解释，可能导致协议误解、内部指标泄露和频繁的价值更改。

对于最终用户，吞吐量语句唯一有意义的情况是该客户独占此服务的情况。因此，他们可能会理解此限制是指为其个人预配的吞吐量。但 SLA 并未明确说明这一点，用户只能猜测他们的理解是否正确。