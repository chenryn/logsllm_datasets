# 分析与复现：Windows VBScript引擎远程执行代码漏洞 (CVE-2018-8373)

## 译文声明
本文为翻译文章，仅供读者参考。具体表达及含义以原文为准。

## 一、漏洞概述

### 漏洞简介
VBScript引擎在处理内存中对象时存在一个远程代码执行漏洞。攻击者可以利用此漏洞破坏内存，并在当前用户的上下文中执行任意代码。成功利用该漏洞的攻击者可获得与当前用户相同的权限。若当前用户以管理员身份登录，则攻击者将能够完全控制受影响系统，包括安装程序、查看或更改数据以及创建具有完整用户权限的新账户。

在基于Web的攻击场景下，攻击者可以通过特制的网站利用此漏洞，并诱导用户访问这些网站。此外，攻击者还可以在使用IE渲染引擎的应用程序或Microsoft Office文档中嵌入标记为“安全初始化”的ActiveX控件，或者通过被攻陷的网站以及接受或托管用户提供的内容或广告的网站来实施攻击。

微软于2018年8月14日发布了针对这一广泛影响多个版本系统的安全补丁。

### 基本信息
- **漏洞ID**：CVE-2018-8373
- **名称**：Microsoft VBScript引擎远程代码执行漏洞
- **类型**：远程代码执行
- **威胁类型**：UAF（Use After Free）
- **受影响版本**：IE9 (WS 2008 32/64位), IE10 (Windows Server 2012), 大部分版本的IE11

## 二、测试环境
- **操作系统**：Windows 7 (32/64位)
- **浏览器版本**：Internet Explorer 10
- **漏洞利用示例** (EXP)：略

## 三、漏洞机制解析
由于样本经过高度混淆，这里采用简化的POC进行分析。

### 简化POC
- 定义了一个`MyClass`类，包含一个数组成员变量和两个成员函数：`Class_Initialize` 和 `Default Property Get P`。
- `Class_Initialize`是一个已弃用的方法，在对象初始化时自动调用。在POC中，它被重载以当调用`VBScriptClass::InitializeClass`时执行特定逻辑。
- 创建`MyClass`实例并赋值给变量`cls`，触发类构造与初始化过程。
- 使用`ReDim array(2)`定义长度为3的数组；`cls.array(2)`设置数组元素引用自身。
- 通过`Public Default Property Get P`重新分配数组大小，释放旧内存，导致UAF错误。

## 四、漏洞利用调试
- 利用方法类似于简化POC中的步骤，但增加了额外操作如修改二维数组尺寸至极大值(`0x0FFFFFFF`)等，以实现对任意内存地址的读写访问。
- 最终目标是构建一个可控的上下文结构以执行shellcode，例如弹出计算器程序作为演示。

参考资料：
更多相关信息请参阅[物联网实验室](https://example.com)，转载时请注明出处[四维创智]。