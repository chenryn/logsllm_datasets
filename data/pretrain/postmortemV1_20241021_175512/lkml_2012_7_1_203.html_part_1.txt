+:---------------:+-----------------+-----------------+-----------------+
| [![lk           |                 | <div>           |                 |
| ml.org](/images |                 |                 |                 |
| /toprowlk.gif){ |                 | [\[lkml         |                 |
| style="border:0 |                 | \]](/lkml){.nb} |                 |
| ;width:135px;he |                 |                 |                 |
| ight:32px"}](/) |                 | [\[2012\]](/    |                 |
|                 |                 | lkml/2012){.nb} |                 |
|                 |                 |                 |                 |
|                 |                 | [\[Jul\]](/lk   |                 |
|                 |                 | ml/2012/7){.nb} |                 |
|                 |                 |                 |                 |
|                 |                 | [\[1\]](/lkml   |                 |
|                 |                 | /2012/7/1){.nb} |                 |
|                 |                 |                 |                 |
|                 |                 | [\[             |                 |
|                 |                 | last100\]](/lkm |                 |
|                 |                 | l/last100){.nb} |                 |
|                 |                 |   [![RSS        |                 |
|                 |                 | Fee             |                 |
|                 |                 | d](/images/rss- |                 |
|                 |                 | or.gif){border= |                 |
|                 |                 | "0"}](/rss.php) |                 |
|                 |                 |                 |                 |
|                 |                 | </div>          |                 |
|                 |                 |                 |                 |
|                 |                 | <div>           |                 |
|                 |                 |                 |                 |
|                 |                 | Views:          |                 |
|                 |                 | [\[wra          |                 |
|                 |                 | p\]](#){.nowrap |                 |
|                 |                 | onclick="set    |                 |
|                 |                 | ActiveStyleShee |                 |
|                 |                 | t('wrap');retur |                 |
|                 |                 | n false;"}[\[no |                 |
|                 |                 | w               |                 |
|                 |                 | rap\]](#){.wrap |                 |
|                 |                 | onclick="       |                 |
|                 |                 | setActiveStyleS |                 |
|                 |                 | heet('nowrap'); |                 |
|                 |                 | return false;"} |                 |
|                 |                 |                 |                 |
|                 |                 | [               |                 |
|                 |                 | \[headers\]](/l |                 |
|                 |                 | kml/mheaders/20 |                 |
|                 |                 | 12/7/1/203){.nb |                 |
|                 |                 | onclick="       |                 |
|                 |                 | this.href='/lkm |                 |
|                 |                 | l/headers'+'/20 |                 |
|                 |                 | 12/7/1/203';"}  |                 |
|                 |                 | [\[forward\     |                 |
|                 |                 | ]](/lkml/bounce |                 |
|                 |                 | /2012/7/1/203)  |                 |
|                 |                 |                 |                 |
|                 |                 | </div>          |                 |
+-----------------+-----------------+-----------------+-----------------+
|  {.es-jasper-si | mages/icornerl. | <colgroup>      | mages/icornerr. |
| mpleCalendar ba | gif){width="32" | <col            | gif){width="32" |
| seurl="/lkml/"} | height="32"}    | style=          | height="32"}    |
|                 |                 | <col            |                 |
| Messages in     |                 | "width: 50%" /> |                 |
| this thread     |                 | </colgroup>     |                 |
|                 |                 | <tr             |                 |
| -   [First      |                 | class="odd">    |                 |
|     message in  |                 | <td             |                 |
|                 |                 | c               |                 |
|    thread](/lkm |                 | olspan="2"><div |                 |
| l/2012/7/1/176) |                 | id              |                 |
| -   [John       |                 | ="bsap_1297613" |                 |
|                 |                 | class="bsa      |                 |
|    Stultz](/lkm |                 | rocks bsap_5aa4 |                 |
| l/2012/7/1/176) |                 | 9c00cc06c882289 |                 |
|     -   [John   |                 | a1dd6a5e50b62"> |                 |
|                 |                 |                 |                 |
|    Stultz](/lkm |                 | </div></td>     |                 |
| l/2012/7/1/173) |                 | </tr>           |                 |
|     -   [John   |                 | <tr             |                 |
|                 |                 | class="even">   |                 |
|    Stultz](/lkm |                 | <td><table>     |                 |
| l/2012/7/1/174) |                 | <tbody>         |                 |
|     -   [John   |                 | <tr             |                 |
|                 |                 | class="odd">    |                 |
|    Stultz](/lkm |                 | <td             |                 |
| l/2012/7/1/177) |                 | class           |                 |
|     -   [Jan    |                 | ="lp">Date</td> |                 |
|         E       |                 | <td             |                 |
| ngelhardt](/lkm |                 | class="rp"      |                 |
| l/2012/7/1/180) |                 | itemprop="date  |                 |
|     -   [John   |                 | Published">Sun, |                 |
|                 |                 | 01 Jul 2012     |                 |
|       Stultz]() |                 | 15:05:08        |                 |
|     -   [John   |                 | -0700</td>      |                 |
|                 |                 | </tr>           |                 |
|      Stultz](/l |                 | <tr             |                 |
| kml/2012/7/2/4) |                 | class="even">   |                 |
|                 |                 | <td             |                 |
|     -   [Prarit |                 | class           |                 |
|                 |                 | ="lp">From</td> |                 |
|  Bhargava](/lkm |                 | <td             |                 |
| l/2012/7/2/220) |                 | class="rp"      |                 |
|                 |                 | itempro         |                 |
|       -   [Dave |                 | p="author">John |                 |
|                 |                 | Stultz          |                 |
|     Jones](/lkm |                 | &lt;&gt;</td>   |                 |
| l/2012/7/2/354) |                 | </tr>           |                 |
|                 |                 | <tr             |                 |
|       -   [John |                 | class="odd">    |                 |
|                 |                 | <td             |                 |
|    Stultz](/lkm |                 | class="l        |                 |
| l/2012/7/2/361) |                 | p">Subject</td> |                 |
|     -   [Thomas |                 | <td             |                 |
|                 |                 | class="rp"      |                 |
|   Gleixner](/lk |                 | item            |                 |
| ml/2012/7/2/84) |                 | prop="name">Re: |                 |
|                 |                 | [PATCH          |                 |
|       -   [John |                 | 0/2][RFC]       |                 |
|                 |                 | Potential fix   |                 |
|    Stultz](/lkm |                 | for             |                 |
| l/2012/7/2/460) |                 | leapsecond      |                 |
|                 |                 | caused futex    |                 |
|                 |                 | issue           |                 |
|                 |                 | (v2)</td>       |                 |
|                 |                 | </tr>           |                 |
|                 |                 | </tbody>        |                 |
|                 |                 | </table></td>   |                 |
|                 |                 | <td><div        |                 |
|                 |                 | class="shariff" |                 |
|                 |                 | data-s          |                 |
|                 |                 | ervices="[&quot |                 |
|                 |                 | ;reddit&quot;]" |                 |
|                 |                 | da              |                 |
|                 |                 | ta-theme="grey" |                 |
|                 |                 | data-lang="en"  |                 |
|                 |                 | dat             |                 |
|                 |                 | a-backend-url=" |                 |
|                 |                 | //shariff.lkml. |                 |
|                 |                 | org/index.php"> |                 |
|                 |                 |                 |                 |
|                 |                 | </div></td>     |                 |
|                 |                 | </tr>           |                 |
|                 |                 | </tbody>        |                 |
|                 |                 | </table>        |                 |
|                 |                 |                 |                 |
|                 |                 | ``` {itemprop   |                 |
|                 |                 | ="articleBody"} |                 |
|                 |                 | On 07/01/201    |                 |
|                 |                 | 2 11:29 AM, Joh |                 |
|                 |                 | n Stultz wrote: |                 |
|                 |                 | > TODOs:        |                 |
|                 |                 | > * C           |                 |
|                 |                 | hase down the f |                 |
|                 |                 | utex/hrtimer in |                 |
|                 |                 | teraction to se |                 |
|                 |                 | e if this could |                 |
|                 |                 | >               |                 |
|                 |                 | be triggered in |                 |
|                 |                 |  any other way. |                 |
|                 |                 |                 |                 |
|                 |                 | Ok, got a lit   |                 |
|                 |                 | tle more detail |                 |
|                 |                 | ed diagnosis of |                 |
|                 |                 |  what is going  |                 |
|                 |                 | on figured out: |                 |
|                 |                 |                 |                 |
|                 |                 | * Leap second o |                 |
|                 |                 | ccurs, CLOCK_RE |                 |
|                 |                 | ALTIME is set b |                 |
|                 |                 | ack one second. |                 |
|                 |                 |                 |                 |
|                 |                 | * As clock      |                 |
|                 |                 | _was_set() is n |                 |
|                 |                 | ot called, the  |                 |
|                 |                 | hrtimer base.of |                 |
|                 |                 | fset value for  |                 |
|                 |                 | CLOCK_REALTIM   |                 |
|                 |                 | E is not update |                 |
|                 |                 | d, thus its sen |                 |
|                 |                 | se of wall time |                 |
|                 |                 |  is one second  |                 |
|                 |                 | ah              |                 |
|                 |                 | ead of the time |                 |
|                 |                 | keeping core's. |                 |
|                 |                 |                 |                 |
|                 |                 | * At inte       |                 |
|                 |                 | rrupt time (T), |                 |
|                 |                 |  the hrtimer co |                 |
|                 |                 | de expires all  |                 |
|                 |                 | CLOCK_REALTIME  |                 |
|                 |                 | based ti        |                 |
|                 |                 | mers set for T+ |                 |
|                 |                 | 1s and before,  |                 |
|                 |                 | causing early e |                 |
|                 |                 | xpirations for  |                 |
|                 |                 | timers betwe    |                 |
|                 |                 | en T and T+1s s |                 |
|                 |                 | ince the hrtime |                 |
|                 |                 | r code's sense  |                 |
|                 |                 | of time is one  |                 |
|                 |                 | second ahead.   |                 |
|                 |                 |                 |                 |
|                 |                 | * This c        |                 |
|                 |                 | auses all TIMER |                 |
|                 |                 | _ABSTIME CLOCK_ |                 |
|                 |                 | REALTIME timers |                 |
|                 |                 |  to expire one  |                 |
|                 |                 | second early.   |                 |
|                 |                 |                 |                 |
|                 |                 | * More p        |                 |
|                 |                 | roblematically, |                 |
|                 |                 |  all sub-second |                 |
|                 |                 |  TIMER_ABSTIME  |                 |
|                 |                 | CLOCK_REALTIME  |                 |
|                 |                 | timers will     |                 |
|                 |                 |  return immedia |                 |
|                 |                 | tely.  If any s |                 |
|                 |                 | uch timer calls |                 |
|                 |                 |  are done in a  |                 |
|                 |                 | loop (as        |                 |
|                 |                 | commonly done w |                 |
|                 |                 | ith futex_wait  |                 |
|                 |                 | or other timeou |                 |
|                 |                 | ts), this will  |                 |
|                 |                 | cause load      |                 |
|                 |                 |  spikes in thos |                 |
|                 |                 | e applications. |                 |
|                 |                 |                 |                 |
|                 |                 | * This state    |                 |
|                 |                 |  persists until |                 |
|                 |                 |  clock_was_set( |                 |
|                 |                 | ) is called (mo |                 |
|                 |                 | st easily done  |                 |
|                 |                 | via             |                 |
|                 |                 | settimeofday()) |                 |
|                 |                 |                 |                 |
|                 |                 |                 |                 |
|                 |                 | I've used the   |                 |
|                 |                 |  attached test  |                 |
|                 |                 | case to demonst |                 |
|                 |                 | rate triggering |                 |
|                 |                 |  a leap-second  |                 |
|                 |                 | and its effe    |                 |
|                 |                 | ct on CLOCK_REA |                 |
|                 |                 | LTIME hrtimers. |                 |
|                 |                 |                 |                 |
|                 |                 | The test        |                 |
|                 |                 |  sets a leapsec |                 |
|                 |                 | ond to trigger  |                 |
|                 |                 | in 10 seconds,  |                 |
|                 |                 | then in a loop  |                 |
|                 |                 | sleeps for      |                 |
|                 |                 | half a second v |                 |
|                 |                 | ia clock_nanosl |                 |
|                 |                 | eep, printing o |                 |
|                 |                 | ut the current  |                 |
|                 |                 | tim             |                 |
|                 |                 | e, and the delt |                 |
|                 |                 | a from the targ |                 |
|                 |                 | et wakeup time  |                 |
|                 |                 | for 30 seconds. |                 |
|                 |                 |                 |                 |
|                 |                 | When th         |                 |
|                 |                 | e leap second t |                 |
|                 |                 | riggers, on aff |                 |
|                 |                 | ected machines  |                 |
|                 |                 | you'll see the  |                 |
|                 |                 | output stream   |                 |
|                 |                 | s quickly, with |                 |
|                 |                 |  negative diff  |                 |
|                 |                 | values, as cloc |                 |
|                 |                 | k_nanosleep is  |                 |
|                 |                 | immedia         |                 |
|                 |                 | tely returning. |                 |
|                 |                 |                 |                 |
|                 |                 | To build:       |                 |
|                 |                 | gcc leaptest-   |                 |
|                 |                 | timer.c -o leap |                 |
|                 |                 | test-timer -lrt |                 |
|                 |                 |                 |                 |
|                 |                 |                 |                 |
|                 |                 | I've            |                 |
|                 |                 | reproduced this |                 |
|                 |                 |  behaviour in k |                 |
|                 |                 | ernel versions: |                 |
|                 |                 |      v3.5-rc4   |                 |
|                 |                 |      v2.6.37    |                 |
|                 |                 |      v2.6.32.59 |                 |
|                 |                 | (And            |                 |
|                 |                 |  quite likely a |                 |
|                 |                 | ll in-between). |                 |
|                 |                 |                 |                 |
|                 |                 | I haven't bee   |                 |
|                 |                 | n able to build |                 |
|                 |                 |  or boot anythi |                 |
|                 |                 | ng earlier with |                 |
|                 |                 |  the distro on  |                 |
|                 |                 | my current t    |                 |
|                 |                 | est boxes, but  |                 |
|                 |                 | I'm working to  |                 |
|                 |                 | get older distr |                 |
|                 |                 | o installed so  |                 |
|                 |                 | I can do f      |                 |
