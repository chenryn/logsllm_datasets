# K8sä¸€æ¡é»˜è®¤å‚æ•°å¼•èµ·çš„æ€§èƒ½é—®é¢˜
ğŸ‘‰ Nodejsåº”ç”¨ä»è™šæ‹Ÿæœºè¿ç§»åˆ°å®¹å™¨äº§ç”Ÿçš„æ€§èƒ½é—®é¢˜

## é—®é¢˜æ—¶é—´çº¿
[xx:xx] å¼€å‘æ”¶åˆ°ä¸šåŠ¡åé¦ˆæ¥å£å“åº”è¶…æ—¶
[xx:xx] å¼€å‘&SRE&ä¸­é—´ä»¶è”åˆæ’æŸ¥ä»£ç ã€ç½‘å…³ã€åº•å±‚ç½‘ç»œé—®é¢˜ï¼Œæ— æœ
[xx:xx] æµ‹è¯•ç¯å¢ƒå¤ç°æ’æŸ¥
[xx:xx] åˆ©ç”¨å·®å¼‚æ³•ã€æ’é™¤æ³•å’Œç»éªŒè§£å†³ï¼Œå…ˆä¸Šçº¿
[xx:xx] æ ¹å› å®šä½

## é—®é¢˜ç°è±¡
1. æ¥å£å¶å‘æ€§è¶…æ—¶
2. å®¹å™¨åŒ–åï¼ŒCPUä½¿ç”¨ç‡ä¸€ç›´è¾ƒé«˜
3. è¿ç§»åˆ°å®¹å™¨å‰ï¼Œè™šæ‹ŸæœºCPUä½¿ç”¨ç‡å’Œæ¥å£å“åº”å‡æ­£å¸¸

## é—®é¢˜æ’æŸ¥
é¦–å…ˆä½¿ç”¨æ’é™¤æ³•ï¼šç¡®å®šäº†ä¸ç½‘ç»œã€ä»£ç æ²¡æœ‰å…³ç³»ã€‚
ç„¶åè¿›è¡Œå·®å¼‚åˆ†æï¼š
åœ¨è™šæ‹Ÿæœºä¸Šå¯åŠ¨ç›¸åŒåº”ç”¨åšæµ‹è¯•ï¼Œç»“æœæ­£å¸¸ï¼ŒçŸ›å¤´ç›´æŒ‡å®¹å™¨ ğŸ˜±
åœ¨Serverlessæµ‹è¯•é›†ç¾¤ä¸Šè·‘äº†ä¸€ä¸‹ï¼Œä¹Ÿæ­£å¸¸ï¼Œå¼€å§‹ç–‘æƒ‘ï¼Œæ˜¯å®¹å™¨çš„é—®é¢˜å— ğŸ¤”
æ€è€ƒï¼š
å®¹å™¨å¯¹æ¯”è™šæ‹Ÿæœºï¼Œåº”ç”¨è¿è¡Œç¯å¢ƒå‘ç”Ÿäº†å“ªäº›æ”¹å˜å‘¢ â†’ ç»éªŒå‘Šè¯‰æˆ‘ï¼šServiceç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°Podé‡Œé¢
ä¸ºå•¥Serverlessé›†ç¾¤æ²¡æœ‰é—®é¢˜å‘¢ â†’ é‡ï¼Œå¸¸è§„é›†ç¾¤æ‰€è·‘çš„åº”ç”¨æ•°é‡å¤šï¼ŒServiceç¯å¢ƒå˜é‡çš„æ•°ç›®è‡ªç„¶ä¼šå¤š
æ£€éªŒï¼š
è¿›å…¥å¸¸è§„é›†ç¾¤PodæŸ¥çœ‹ç¯å¢ƒå˜é‡çš„æ•°ç›® `env | wc -l`ï¼Œç»“æœæœ‰1.6wä¸ªç¯å¢ƒå˜é‡ï¼ŒåŸºæœ¬éƒ½æ˜¯Serviceè‡ªåŠ¨æ³¨å…¥çš„ã€‚
å…³é—­Serviceè‡ªåŠ¨æ³¨å…¥å‚æ•°ï¼Œ`enableServiceLinks: false`ï¼Œæµ‹è¯•æ£€éªŒï¼ŒCPUä½¿ç”¨ç‡å›å½’æ­£å¸¸ï¼Œæ¥å£å“åº”æ­£å¸¸ã€‚

## æ ¹å› åˆ†æ
ğŸ‘ ä¼˜å…ˆè§£å†³é—®é¢˜ï¼Œäº‹åå†æ·±æŒ–æ ¹å› ï¼

## åˆ†ææ€§èƒ½çš„ä¸€èˆ¬æ­¥éª¤
### ç³»ç»Ÿèµ„æºç“¶é¢ˆ
ç³»ç»Ÿèµ„æºçš„ç“¶é¢ˆï¼Œå¯ä»¥é€šè¿‡USEæ³•ï¼Œå³ä½¿ç”¨ç‡ã€é¥±å’Œåº¦ä»¥åŠé”™è¯¯æ•°è¿™ä¸‰ç±»æŒ‡æ ‡æ¥è¡¡é‡ã€‚ç³»ç»Ÿçš„èµ„æºï¼Œå¯ä»¥åˆ†ä¸ºç¡¬ä»¶èµ„æºå’Œè½¯ä»¶èµ„æºä¸¤ç±»ã€‚
å¦‚CPUã€å†…å­˜ã€ç£ç›˜å’Œæ–‡ä»¶ç³»ç»Ÿä»¥åŠç½‘ç»œç­‰ï¼Œéƒ½æ˜¯æœ€å¸¸è§çš„ç¡¬ä»¶èµ„æºã€‚
è€Œæ–‡ä»¶æè¿°ç¬¦æ•°ã€è¿æ¥è·Ÿè¸ªæ•°ã€å¥—æ¥å­—ç¼“å†²åŒºå¤§å°ç­‰ï¼Œåˆ™æ˜¯å…¸å‹çš„è½¯ä»¶èµ„æºã€‚

### åº”ç”¨ç¨‹åºç“¶é¢ˆ
æœ€å…¸å‹çš„åº”ç”¨ç¨‹åºæ€§èƒ½é—®é¢˜ï¼Œå°±æ˜¯ååé‡ï¼ˆå¹¶å‘è¯·æ±‚æ•°ï¼‰ä¸‹é™ã€é”™è¯¯ç‡å‡é«˜ä»¥åŠå“åº”æ—¶é—´å¢å¤§ã€‚
æœ¬è´¨æ¥æºï¼Œå®é™…ä¸Šåªæœ‰ä¸‰ç§ï¼Œä¹Ÿå°±æ˜¯èµ„æºç“¶é¢ˆã€ä¾èµ–æœåŠ¡ç“¶é¢ˆä»¥åŠåº”ç”¨è‡ªèº«çš„ç“¶é¢ˆã€‚
ç¬¬ä¸€ç§èµ„æºç“¶é¢ˆï¼ŒCPUã€å†…å­˜ã€ç£ç›˜å’Œæ–‡ä»¶ç³»ç»ŸI/Oã€ç½‘ç»œä»¥åŠå†…æ ¸èµ„æºç­‰å„ç±»è½¯ç¡¬ä»¶èµ„æºå‡ºç°äº†ç“¶é¢ˆï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œå—é™ã€‚
ç¬¬äºŒç§ä¾èµ–æœåŠ¡çš„ç“¶é¢ˆï¼Œä¹Ÿå°±æ˜¯è¯¸å¦‚æ•°æ®åº“ã€åˆ†å¸ƒå¼ç¼“å­˜ã€ä¸­é—´ä»¶ç­‰åº”ç”¨ç¨‹åºï¼Œç›´æ¥æˆ–è€…é—´æ¥è°ƒç”¨çš„æœåŠ¡å‡ºç°äº†æ€§èƒ½é—®é¢˜ï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„å“åº”å˜æ…¢ï¼Œæˆ–è€…é”™è¯¯ç‡å‡é«˜ã€‚è¿™è¯´ç™½äº†å°±æ˜¯è·¨åº”ç”¨çš„æ€§èƒ½é—®é¢˜ï¼Œä½¿ç”¨å…¨é“¾è·¯è·Ÿè¸ªç³»ç»Ÿï¼Œå°±å¯ä»¥å¸®ä½ å¿«é€Ÿå®šä½è¿™ç±»é—®é¢˜çš„æ ¹æºã€‚
æœ€åä¸€ç§ï¼Œåº”ç”¨ç¨‹åºè‡ªèº«çš„æ€§èƒ½é—®é¢˜ï¼ŒåŒ…æ‹¬äº†å¤šçº¿ç¨‹å¤„ç†ä¸å½“ã€æ­»é”ã€ä¸šåŠ¡ç®—æ³•çš„å¤æ‚åº¦è¿‡é«˜ç­‰ç­‰ã€‚å¯¹äºè¿™ç±»é—®é¢˜ï¼Œé€šè¿‡åº”ç”¨ç¨‹åºæŒ‡æ ‡ç›‘æ§ä»¥åŠæ—¥å¿—ç›‘æ§ï¼Œè§‚å¯Ÿå…³é”®ç¯èŠ‚çš„è€—æ—¶å’Œå†…éƒ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼Œå°±å¯ä»¥å¸®ä½ ç¼©å°é—®é¢˜çš„èŒƒå›´ã€‚
ä¸è¿‡ï¼Œç”±äºè¿™æ˜¯åº”ç”¨ç¨‹åºå†…éƒ¨çš„çŠ¶æ€ï¼Œå¤–éƒ¨é€šå¸¸ä¸èƒ½ç›´æ¥è·å–è¯¦ç»†çš„æ€§èƒ½æ•°æ®ï¼Œæ‰€ä»¥å°±éœ€è¦åº”ç”¨ç¨‹åºåœ¨è®¾è®¡å’Œå¼€å‘æ—¶ï¼Œå°±æä¾›å‡ºè¿™äº›æŒ‡æ ‡ï¼Œä»¥ä¾¿ç›‘æ§ç³»ç»Ÿå¯ä»¥äº†è§£åº”ç”¨ç¨‹åºçš„å†…éƒ¨è¿è¡ŒçŠ¶æ€ã€‚
å¦‚æœè¿™äº›æ‰‹æ®µè¿‡åè¿˜æ˜¯æ— æ³•æ‰¾å‡ºç“¶é¢ˆï¼Œä½ è¿˜å¯ä»¥ç”¨ç³»ç»Ÿèµ„æºæ¨¡å—æåˆ°çš„å„ç±»è¿›ç¨‹åˆ†æå·¥å…·ï¼Œæ¥è¿›è¡Œåˆ†æå®šä½ã€‚æ¯”å¦‚ï¼š
ä½ å¯ä»¥ç”¨`strace`ï¼Œè§‚å¯Ÿç³»ç»Ÿè°ƒç”¨ï¼›
ä½¿ç”¨`perf`å’Œç«ç„°å›¾ï¼Œåˆ†æçƒ­ç‚¹å‡½æ•°ï¼›
ç”šè‡³ä½¿ç”¨åŠ¨æ€è¿½è¸ªæŠ€æœ¯ï¼Œæ¥åˆ†æè¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€ã€‚

## å…·ä½“æ’æŸ¥è¿‡ç¨‹
é’ˆå¯¹æœ¬æ–‡çš„æ¡ˆä¾‹ï¼Œæ’æŸ¥æ€è·¯å¦‚ä¸‹ï¼š

```mermaid
flowchart TD
    A[Nodejs åº”ç”¨é—®é¢˜æ’æŸ¥] --> B{å®¿ä¸»æœºæ˜¯å¦å­˜åœ¨ç³»ç»Ÿèµ„æºç“¶é¢ˆ}
    B -->|å¦| C{åº”ç”¨ç¨‹åºæ€§èƒ½é—®é¢˜ä¹‹èµ„æºç“¶é¢ˆ}
    B -->|æ˜¯| B1[1. é«˜å±å¤§ç›˜æ— æŠ¥è­¦\n2. Node-exporter ç›‘æ§çš„å®¿ä¸»æœº\nç³»ç»Ÿèµ„æºæ— å¼‚å¸¸\n3. å®¿ä¸»æœºå…¶ä»–å®¹å™¨åº”ç”¨æ— å¼‚å¸¸]
    C -->|å¦| D{åº”ç”¨ç¨‹åºæ€§èƒ½é—®é¢˜\nä¹‹ä¾èµ–æœåŠ¡çš„ç“¶é¢ˆ}
    C -->|æ˜¯| C1[1. Pod CPU/MEM æœ‰ limit é™åˆ¶, CPU ä½¿ç”¨ç‡æ¯”\nå»ºè®®æœºå™¨é«˜, ä½†æœªé¥±å’Œ, å…±æœ‰ç©ºä½™æœºå™¨åˆ†ç‰‡ä½ä½¿ç”¨\n2. å‡é«˜ CPU limit é™åˆ¶, é—®é¢˜ä¾æ—§å­˜åœ¨]
    D -->|å¦| E{åº”ç”¨ç¨‹åºæ€§èƒ½é—®é¢˜\nä¹‹åº”ç”¨è‡ªèº«çš„æ€§èƒ½é—®é¢˜}
    D -->|æ˜¯| D1[1. å…¶ä»–æœåŠ¡å‡æ­£å¸¸, å¦‚æœä¾èµ–çš„å…¬å…±æœåŠ¡å¼‚å¸¸, åˆ™\næ‰€æœ‰ä¾èµ–å…¬å…±æœåŠ¡åº”ç”¨å‡ä¼šå¼‚å¸¸\n2. æ··åˆéƒ¨ç½²æ¨¡å¼ï¼ˆè™šæ‹Ÿæœº+å®¹å™¨ï¼‰ä¸‹, è™šæ‹Ÿæœºæ­£å¸¸]
    E --> F[ç”¨ trace, è§‚å¯Ÿç³»ç»Ÿè°ƒç”¨\nç”¨ perf å’Œç«ç„°å›¾, åˆ†æçƒ­ç‚¹å‡½æ•°]
    F --> G[ä½¿ç”¨ node --prof + flamebearer\nè¿›ä¸€æ­¥åˆ†æçƒ­ç‚¹å‡½æ•°]
    G --> H[å®šä½åˆ°æœ€åä¸€æ­¥çƒ­ç‚¹å‡½æ•°,\næ³¨é‡Šç›¸å…³ä»£ç , æµ‹è¯•]
    H --> I[è¿›ä¸€æ­¥å®šä½æ ¹å› , é‡ Nodejs æºç , å°†å¯ç–‘ä¹‹å¤„, å•ç‹¬æµ‹è¯•]    
    I --> J[è§£å†³]
```

### é—®é¢˜ç°è±¡è¿½è¸ª
é€šè¿‡ã€Œå®¹å™¨é€ŸæŸ¥å¤§ç›˜ã€å®æ—¶æŸ¥çœ‹CPUåˆ©ç”¨ç‡
é€šè¿‡`time + curl`å‘½ä»¤å®æ—¶æµ‹è¯•APIå“åº”è€—æ—¶æƒ…å†µ
```bash
for i in `seq 1 100`; do time curl -I ${API} ; done
```
### ä½¿ç”¨straceã€perfæ’æŸ¥
åœ¨MasterèŠ‚ç‚¹ï¼ŒæŸ¥è¯¢Podæ‰€åœ¨å®¿ä¸»æœº
```bash
kubectl -n work describe ${PodName}  | grep 'Node:' | awk -F/ '{print $2}'
```
åœ¨MasterèŠ‚ç‚¹ï¼ŒæŸ¥è¯¢ContainerID 
```bash
kubectl -n work get pod ${PodName}  -o template --template='{{range .status.containerStatuses}}{{.containerID}}{{end}}' | sed 's/docker:\/\/\(.*\)$/\1/'
```
åœ¨Podæ‰€åœ¨å®¿ä¸»æœºï¼ŒæŸ¥è¯¢Pid
```bash
docker inspect -f {{.State.Pid}} ${ContainerID}
```
æŸ¥è¯¢æ˜¯å¦æœ‰å­è¿›ç¨‹,å±‚å±‚æ‰¾å‡ºCPUå ç”¨é«˜çš„å­è¿›ç¨‹
```bash
pstree -p ${Pid}
ps -aux | head -1;  ps -aux | grep ${Pid}
```
åœ¨Podæ‰€åœ¨å®¿ä¸»æœºï¼Œä½¿ç”¨`strace`è§‚å¯Ÿç³»ç»Ÿè°ƒç”¨
```bash
# -fè¡¨ç¤ºè·Ÿè¸ªå­è¿›ç¨‹å’Œå­çº¿ç¨‹ï¼Œ-Tè¡¨ç¤ºæ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿ï¼Œ-ttè¡¨ç¤ºæ˜¾ç¤ºè·Ÿè¸ªæ—¶é—´
strace -f -T -tt -p ${Pid} -o trace.log
```
è¯·æ±‚äº”æ¬¡æ¥å£ï¼Œè§‚å¯Ÿå“åº”æƒ…å†µ
```bash
date +"%H:%M:%S"; time curl -I ${API} ; date +"%H:%M:%S"
```
äº”æ¬¡è¯·æ±‚çš„æ—¶é—´æœ‰ç”¨ä¿¡æ¯å¦‚ä¸‹ï¼Œä¼šå‘ç°ç¬¬ä¸€æ¬¡å’Œç¬¬äº”æ¬¡è¯·æ±‚è€—æ—¶è¾ƒé•¿ï¼Œ20så·¦å³ï¼Œå…¶ä»–ä¸‰æ¬¡å“åº”å¾ˆå¿«ï¼Œ80mså·¦å³
```
15:19:40
20.055 total
15:20:00

15:20:05
0.090 total
15:20:05

15:20:07
0.084 total
15:20:07

15:20:09
0.078 total
15:20:09

15:20:13
19.164 total
15:20:33
```
#### trace.logåˆ†æ
è¿‡æ»¤å…³é”®ä¿¡æ¯ï¼Œäº”æ¬¡å¤„ç†uriçš„æ—¶é—´,å‘ç°ç¬¬ä¸€æ¬¡å’Œç¬¬äº”æ¬¡çš„è¯·æ±‚è¢«é˜»å¡äº†
```
31366 15:19:59.980073 read(21, "HEAD /xxx"..., 65536) = 134 <0.000016>
31366 15:20:05.345321 read(21, "HEAD /xxx"..., 65536) = 134 <0.000014>
31366 15:20:07.373577 read(21, "HEAD /xxx"..., 65536) = 134 <0.000013>
31366 15:20:09.209124 read(21, "HEAD /xxx"..., 65536) = 134 <0.000013>
31366 15:20:33.190620 read(21, "HEAD /xxx"..., 65536) = 134 <0.000025>
```
è¿‡æ»¤å…³é”®ä¿¡æ¯ï¼ŒæŸ¥è¯¢å“ªé‡Œé€ æˆçš„é˜»å¡ï¼Œå‘ç°ä¸¤æ¬¡è¶…æ—¶è¯·æ±‚å‰ï¼Œéƒ½æœ‰`futex resumed`ï¼Œå¹¶ä¸”è¿›ç¨‹IDä¸åŒï¼Œæ˜¯31366çš„å­è¿›ç¨‹
```
31371 15:19:59.979948 <... futex resumed>) = 0 <0.000069>
31366 15:19:59.979961 <... futex resumed>) = 0 <0.000068>
31372 15:19:59.979977 <... futex resumed>) = 0 <0.000033>
31366 15:19:59.980023 write(16, "\1\0\0\0\0\0\0\0", 8) = 8 <0.000011>
31366 15:19:59.980073 read(21, "HEAD /xxx"..., 65536) = 134 <0.000016>

31372 15:20:33.189971 <... futex resumed>) = 0 <0.000063>
31366 15:20:33.189985 <... futex resumed>) = 0 <0.000049>
31373 15:20:33.190001 <... futex resumed>) = 0 <0.000033>
31366 15:20:33.190017 read(24, "\0\0\0002\0\0001\261\0\0\0\1\0\nnodejs_log\0\0\0\1\0\0\0\2"..., 65536) = 216 <0.000019>
31366 15:20:33.190081 munmap(0x7f166db42000, 69632) = 0 <0.000044>
31366 15:20:33.190620 read(21, "HEAD /man-hour-price/get-busines"..., 65536) = 134 <0.000025>
```
`futex`æ˜¯Linuxç³»ç»Ÿä¸Šç”¨äºå®ç°ç”¨æˆ·ç©ºé—´çº¿ç¨‹åŒæ­¥çš„ä¸€ç§æœºåˆ¶ã€‚è¿™äº›è®°å½•æ˜¾ç¤ºè¿›ç¨‹å¯èƒ½åœ¨ç­‰å¾…æˆ–é‡Šæ”¾æŸç§é”æˆ–åŒæ­¥å¯¹è±¡ã€‚
è¿‡æ»¤å…³é”®ä¿¡æ¯ï¼Œé˜»å¡çš„æ—¶å€™èƒ½çœ‹æ‡‚çš„å…¶ä»–å…³é”®ï¼Œå‘ç°æœ‰ä¸¤ä¸ªæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå’Œè¶…æ—¶çš„æ¬¡æ•°åŠæ—¶é—´å»åˆ
```
19623 15:19:44.169724 execve("/bin/sh", ["/bin/sh", "-c", "free -m"], 0x7f166b53b230 /* 13793 vars */ <unfinished ...>
20616 15:19:51.988739 execve("/bin/sh", ["/bin/sh", "-c", "df -k '/'"], 0x7f166b53b340 /* 13793 vars */ <unfinished ...>
21542 15:19:59.799328 execve("/bin/sh", ["/bin/sh", "-c", "df -k '/data'"], 0x7f166b53b450 /* 13793 vars */ <unfinished ...>

23324 15:20:17.371918 execve("/bin/sh", ["/bin/sh", "-c", "free -m"], 0x7f166b53b7a0 /* 13793 vars */ <unfinished ...>
24160 15:20:25.186710 execve("/bin/sh", ["/bin/sh", "-c", "df -k '/'"], 0x7f166b53b0d0 /* 13793 vars */ <unfinished ...>
24791 15:20:32.997766 execve("/bin/sh", ["/bin/sh", "-c", "df -k '/data'"], 0x7f166b53b200 /* 13793 vars */ <unfinished ...>
```
`strace`æ’æŸ¥å‘ç°ï¼šå­è¿›ç¨‹æ‰§è¡ŒåŒæ­¥ä»»åŠ¡é˜»å¡äº†ä¸»è¿›ç¨‹ï¼Œå­è¿›ç¨‹é‡Œé¢æ‰§è¡Œç³»ç»Ÿå‘½ä»¤`free`å’Œ`df`ã€‚
### straceå‘½ä»¤æ‰¾ä¸åˆ°å…·ä½“çš„çƒ­ç‚¹å‡½æ•°ï¼Œæ­¤æ—¶perfä¸Šï¼Œçœ‹ç«ç„°å›¾
```bash
perf record -a -g -p {$PID} -- sleep 60
git clone https://github.com/brendangregg/FlameGraph
cd FlameGraph/
perf script -i /root/perf.data | ./stackcollapse-perf.pl --all |  ./flamegraph.pl > ksoftirqd.svg
```
å°†`ksoftirqd.svg`ä¼ è¾“åˆ°æœ¬åœ°ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ï¼Œå‘ç°æ‰¾ä¸åˆ°å…·ä½“çš„çƒ­ç‚¹å‡½æ•°ã€‚
### ä½¿ç”¨nodejs --prof + flamebeareræ’æŸ¥
è¿›å…¥å®¹å™¨
```bash
kubectl -n work exec -it ${PodName} -- /bin/sh
```
ä¿®æ”¹å¯åŠ¨ç«¯å£, æ‰¾åˆ°`app.listen`ä¿®æ”¹ï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªå®ä¾‹
```bash
node /data/node_modules/.bin/cross-env NODE_ENV=work node --prof --jitless --no-lazy src/main
```
è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œç”Ÿæˆç«ç„°å›¾ï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€
```bash
npm install -g flamebearer --registry=https://registry.npmmirror.com
node --prof-process --preprocess -j isolate*.log | flamebearer
```
å°†`flamegraph.html`ä¼ è¾“åˆ°æœ¬åœ°ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ã€‚
æ ¹æ®`strace`æ’æŸ¥åˆ°çš„å­è¿›ç¨‹ä¼šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ŒæŸ¥çœ‹å¯èƒ½ç›¸å…³è”çš„å‡½æ•°ã€‚
é€šè¿‡`flamebearer`å¯ä»¥å®šä½å®šæœ€åæ˜¯`child_process.js`æ–‡ä»¶ä¸­å‡½æ•°çš„ç›¸å…³è°ƒåº¦ï¼Œ`execSync --> spawnSync --> normalizeSpawnArguments`ã€‚
é¦–å…ˆå†ä¸Šä¸€å±‚çš„æ–‡ä»¶æ¸…æ¥šçš„æ ‡è®°å‡ºæ¥æ˜¯`System.js`è°ƒåº¦äº§ç”Ÿçš„çƒ­ç‚¹ï¼Œç¬¬ä¸€æ­¥ç°å°†è¿™ä¸ªè°ƒåº¦æ³¨é‡Šæ‰ï¼Œå¯åŠ¨è§‚å¯Ÿï¼Œå‘ç°ï¼Œåº”ç”¨æ¢å¤æ­£å¸¸ã€‚
### æºç åˆ†æï¼Œå•ç‹¬æµ‹è¯•
æŸ¥çœ‹nodejsæºç ï¼ŒæŸ¥è¯¢å¯èƒ½é€ æˆé˜»å¡è€—æ—¶çš„åœ°æ–¹ï¼Œhttps://github.com/nodejs/node/blob/v14.x/lib/child_process.js#L485
å¯ä»¥å‘ç°è¿™ä¸ªå‡½æ•°ï¼Œæœ€å¯ç–‘çš„æ˜¯è¿™ä¸ªåœ°æ–¹
```javascript
const env = options.env || process.env;

const envPairs = [];  
// Prototype values are intentionally included.
for (const key in env) {

  const value = env[key];

  if (value!== undefined) {

    envPairs.push(`${key}=${value}`);

  }
}
```
åœ¨Podé‡Œé¢ï¼Œå•ç‹¬æ‰§è¡Œè¿™æ®µä»£ç ï¼Œç»Ÿè®¡è€—æ—¶
```javascript
const env = process.env;

const envPairs = [];

console.time('TestEnv');

for (const key in env) {

  const value = env[key];

  if (value!== undefined) {
    envPairs.push(`${key}=${value}`);
  }
}

console.timeEnd('TestEnv')
```
è¾“å‡ºç»“æœä¸ºï¼š`TestEnv: 7.494s`
æœç„¶æ˜¯å®ƒâœŒï¸
è¿›ä¸€æ­¥åˆ†æï¼Œè¿™é‡Œé¢å½±å“æ€§èƒ½çš„å› ç´ æœ‰ä¸¤ä¸ªï¼š
1. `process.env Object`çš„å®ç°ï¼Œæµ‹è¯•`len`ä¸º2wçš„`map`ï¼Œè€—æ—¶æ‰38ms
2. æœ¬èº«åœ¨jsä¸­`for - in`å¾ªç¯çš„æ€§èƒ½å°±æ˜¯æœ€å·®çš„

## è§£å†³åŠæ³•
æœ‰ä»¥ä¸‹å‡ ç§åŠæ³•å¯ä»¥è§£å†³ï¼Œä»»é€‰å…¶ä¸€å³å¯ï¼š
1. å°†YAMLæ–‡ä»¶ä¸­`enableServiceLinks`ç½®ä¸º`false`ï¼Œç¦æ­¢å‘Podè‡ªåŠ¨æ³¨å…¥Serviceç¯å¢ƒå˜é‡
2. `child_process.execSync`ä»¥åŒæ­¥çš„æ–¹å¼è¡ç”Ÿå­è¿›ç¨‹ï¼Œä¼šé˜»å¡Node.jsäº‹ä»¶å¾ªç¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒåŒæ­¥çš„æ–¹æ³•ä¼šå¯¹æ€§èƒ½äº§ç”Ÿé‡å¤§å½±å“ï¼Œå¯ä»¥ä½¿ç”¨`child_process.exec`æ”¹ä¸ºå¼‚æ­¥æ–¹æ³•
3. `child_process.execSync`è°ƒç”¨æ—¶ï¼ŒæŒ‡å®šéœ€è¦çš„`env`ä¼ è¿›å»ï¼Œä¸è¦ç”¨é»˜è®¤çš„ç³»ç»Ÿ`env`ï¼Œhttps://github.com/nodejs/node/blob/v14.x/lib/child_process.js#L586

## æ€»ç»“
åº”ç”¨æ€§èƒ½é—®é¢˜ï¼Œæ”¾åˆ°ä¸€éï¼Œåœ¨K8så±‚é¢ï¼Œæœ‰å‘éœ€è¦æˆ‘ä»¬é¢å¤–æ³¨æ„ã€‚
`enableServiceLinks`å‚æ•°é»˜è®¤ä¸ºå¼€å¯çŠ¶æ€ï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬æ˜¯ä¸éœ€è¦çš„ï¼Œç¬”è€…å»ºè®®ç»Ÿä¸€å…³é—­ï¼Œæœ‰DNSçš„æƒ…å†µä¸‹ï¼Œæ²¡å¤šå¤§ç”¨é€”ï¼Œä¹Ÿæœ‰ç›¸å…³issueæå‡ºå°†`enableServiceLinks`é»˜è®¤å€¼æ”¹ä¸º`false`ã€‚
å¦‚æœä¸éœ€è¦æœåŠ¡ç¯å¢ƒå˜é‡ï¼ˆå› ä¸ºå¯èƒ½ä¸é¢„æœŸçš„ç¨‹åºå†²çªï¼Œå¯èƒ½è¦å¤„ç†çš„å˜é‡å¤ªå¤šï¼Œæˆ–è€…ä»…ä½¿ç”¨DNSç­‰ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨pod specä¸Šå°†`enableServiceLinks`æ ‡å¿—è®¾ç½®ä¸º`false`æ¥ç¦ç”¨æ­¤æ¨¡å¼ã€‚

### Nodejså’ŒK8sé’ˆå¯¹æ­¤é—®é¢˜çš„ç›¸å…³issue
- https://github.com/nodejs/node/issues/3104
- https://github.com/kubernetes/kubernetes/issues/60099
- https://github.com/kubernetes/kubernetes/issues/121787

### å‚è€ƒé“¾æ¥
- k8s doc ï¼š https://kubernetes.io/docs/tutorials/services/connect-applications-service/
- å€ªæœ‹é£ ã€ŒLinuxæ€§èƒ½ä¼˜åŒ–å®æˆ˜ã€
- flamebearerï¼šhttps://github.com/mapbox/flamebearer 