# The mechanics of a sophisticated phishing scam and how we stopped it

This post is also available inç®ä½ä¸­æ,æ¥æ¬èª,EspaÃ±ol,PÑÑÑÐºÐ¸Ð¹andPolski.Yesterday, August 8, 2022, Twilio shared that theyâd beencompromised by a targeted phishing attack. Around the same time as Twilio was attacked, we saw an attack with very similar characteristics also targeting Cloudflareâs employees. While individual employees did fall for the phishing messages, we were able to thwart the attack through our own use ofCloudflare One products, and physical security keys issued to every employee that are required to access all our applications.We have confirmed that no Cloudflare systems were compromised. OurCloudforce One threat intelligence teamwas able to perform additional analysis to further dissect the mechanism of the attack and gather critical evidence to assist in tracking down the attacker.This was a sophisticated attack targeting employees and systems in such a way that we believe most organizations would be likely to be breached. Given that the attacker is targeting multiple organizations, we wanted to share here a rundown of exactly what we saw in order to help other companies recognize and mitigate this attack.Targeted Text MessagesOn July 20, 2022, the Cloudflare Security team received reports of employees receiving legitimate-looking text messages pointing to what appeared to be a Cloudflare Okta login page. The messages began at 2022-07-20 22:50 UTC. Over the course of less than 1 minute, at least 76 employees received text messages on their personal and work phones. Some messages were also sent to the employees family members. We have not yet been able to determine how the attacker assembled the list of employees phone numbers but have reviewed access logs to our employee directory services and have found no sign of compromise.Cloudflare runs a 24x7 Security Incident Response Team (SIRT). Every Cloudflare employee is trained to report anything that is suspicious to the SIRT. More than 90 percent of the reports to SIRT turn out to not be threats. Employees are encouraged to report anything and never discouraged from over-reporting. In this case, however, the reports to SIRT were a real threat.The text messages received by employees looked like this:They came from four phone numbers associated with T-Mobile-issued SIM cards: (754) 268-9387, (205) 946-7573, (754) 364-6683 and (561) 524-5989. They pointed to an official-looking domain: cloudflare-okta.com. That domain had been registered via Porkbun, a domain registrar, at 2022-07-20 22:13:04 UTC â less than 40 minutes before the phishing campaign began.Cloudflare built oursecure registrar productin part to be able to monitor when domains using the Cloudflare brand were registered and get them shut down. However, because this domain was registered so recently, it had not yet been published as a new .com registration, so our systems did not detect its registration and our team had not yet moved to terminate it.If you clicked on the link it took you to a phishing page. The phishing page was hosted on DigitalOcean and looked like this:Cloudflare uses Okta as our identity provider. The phishing page was designed to look identical to a legitimate Okta login page. The phishing page prompted anyone who visited it for their username and password.Real-Time PhishingWe were able to analyze the payload of thephishing attackbased on what our employees received as well as its content being posted to services like VirusTotal by other companies that had been attacked. When the phishing page was completed by a victim, the credentials were immediately relayed to the attacker via the messaging service Telegram. This real-time relay was important because the phishing page would also prompt for a Time-based One Time Password (TOTP) code.Presumably, the attacker would receive the credentials in real-time, enter them in a victim companyâs actual login page, and, for many organizations that would generate a code sent to the employee via SMS or displayed on a password generator. The employee would then enter the TOTP code on the phishing site, and it too would be relayed to the attacker. The attacker could then, before the TOTP code expired, use it to access the companyâs actual login page â defeating most two-factor authentication implementations.Protected Even If Not PerfectWe confirmed that three Cloudflare employees fell for the phishing message and entered their credentials. However, Cloudflare does not use TOTP codes. Instead, every employee at the company is issued a FIDO2-compliant security key from a vendor like YubiKey. Since the hard keys are tied to users and implementorigin binding, even a sophisticated, real-time phishing operation like this cannot gather the information necessary to log in to any of our systems. While the attacker attempted to log in to our systems with the compromised username and password credentials, they could not get past the hard key requirement.But this phishing page was not simply after credentials and TOTP codes. If someone made it past those steps, the phishing page then initiated the download of a phishing payload which included AnyDeskâs remote access software. That software, if installed, would allow an attacker to control the victimâs machine remotely. We confirmed that none of our team members got to this step. If they had, however, our endpoint security would have stopped the installation of the remote access software.How Did We Respond?The main response actions we took for this incident were:1. Block the phishing domain using Cloudflare GatewayCloudflare Gateway is aSecure Web Gatewaysolution providing threat and data protection with DNS / HTTP filtering and natively-integratedZero Trust. We use this Â solution internally to proactively identify malicious domains and block them. Our team added the malicious domain to Cloudflare Gateway to block all employees from accessing it.Gatewayâs automatic detection of malicious domains also identified the domain and blocked it, but the fact that it was registered and messages were sent within such a short interval of time meant that the system hadnât automatically taken action before some employees had clicked on the links. Given this incident we are working to speed up how quickly malicious domains are identified and blocked. Weâre also implementing controls on access to newly registered domains which we offer to customers but had not implemented ourselves.2. Identify all impacted Cloudflare employees and reset compromised credentialsWe were able to compare recipients of the phishing texts to login activity and identify threat-actor attempts to authenticate to our employee accounts. We identified login attempts blocked due to the hard key (U2F) requirements indicating that the correct password was used, but the second factor could not be verified. For the three of our employees' credentials were leaked, we reset their credentials and any active sessions and initiated scans of their devices.3. Identify and take down threat-actor infrastructureThe threat actor's phishing domain was newly registered via Porkbun, and hosted on DigitalOcean. The phishing domain used to target Cloudflare was set up less than an hour before the initial phishing wave. The site had a Nuxt.js frontend, and a Django backend. We worked with DigitalOcean to shut down the attackerâs server. We also worked with Porkbun to seize control of the malicious domain.From the failed sign-in attempts we were able to determine that the threat actor was leveraging Mullvad VPN software and distinctively using the Google Chrome browser on a Windows 10 machine. The VPN IP addresses used by the attacker were 198.54.132.88, and 198.54.135.222. Those IPs are assigned to Tzulo, a US-based dedicated server provider whose website claims they have servers located in Los Angeles and Chicago. It appears, actually, that the first was actually running on a server in the Toronto area and the latter on a server in the Washington, DC area. We blocked these IPs from accessing any of our services.4. Update detections to identify any subsequent attack attemptsWith what we were able to uncover about this attack, we incorporated additional signals to our already existing detections to specifically identify this threat-actor. At the time of writing we have not observed any additional waves targeting our employees. However, intelligence from the server indicated the attacker was targeting other organizations, including Twilio. We reached out to these other organizations and shared intelligence on the attack.5. Audit service access logs for any additional indications of attackFollowing the attack, we screened all our system logs for any additional fingerprints from this particular attacker. Given Cloudflare Access serves as the central control point for all Cloudflare applications, we can search the logs for any indication the attacker may have breached any systems. Given employeesâ phones were targeted, we also carefully reviewed the logs of our employee directory providers. We did not find any evidence of compromise.Lessons Learned and Additional Steps Weâre TakingWe learn from every attack. Even though the attacker was not successful, we are making additional adjustments from what weâve learned. Weâre adjusting the settings for Cloudflare Gateway to restrict or sandbox access to sites running on domains that were registered within the last 24 hours. We will also run any non-allow listed sites containing terms such as âcloudflareâ âoktaâ âssoâ and â2faâ through ourbrowser isolation technology. We are also increasingly usingCloudflare Area 1âs phish-identification technologyto scan the web and look for any pages that are designed to target Cloudflare. Finally, weâre tightening up our Access implementation to prevent any logins from unknown VPNs, residential proxies, and infrastructure providers. All of these are standard features of the same products we offer to customers.The attack also reinforced the importance of three things weâre doing well. First, requiring hard keys for access to all applications.Like Google, we have not seen any successful phishing attacks since rolling hard keys out. Tools like Cloudflare Access made it easy to support hard keys even across legacy applications. If youâre an organization interested in how we rolled out hard keys, reach out to[email protected]and our security team would be happy to share the best practices we learned through this process.Second, using Cloudflareâs own technology to protect our employees and systems. Cloudflare Oneâs solutions like Access and Gateway were critical to staying ahead of this attack. We configured our Access implementation to require hard keys for every application. It also creates a central logging location for all application authentications. And, if ever necessary, a place from which we can kill the sessions of a potentially compromised employee. Gateway allows us the ability to shut down malicious sites like this one quickly and understand what employees may have fallen for the attack. These are all functionalities that we make available to Cloudflare customers as part of our Cloudflare One suite and this attack demonstrates how effective they can be.Third, having a paranoid but blame-free culture is critical for security. The three employees who fell for the phishing scam were not reprimanded. Weâre all human and we make mistakes. Itâs critically important that when we do, we report them and donât cover them up. This incident provided another example of why security is part of every team member at Cloudflareâs job.Detailed Timeline of Events2022-07-20 22:49 UTCAttacker sends out 100+ SMS messages to Cloudflare employees and their families.2022-07-20 22:50 UTCEmployees begin reporting SMS messages to Cloudflare Security team.2022-07-20 22:52 UTCVerify that the attacker's domain is blocked in Cloudflare Gateway for corporate devices.2022-07-20 22:58 UTCWarning communication sent to all employees across chat and email.2022-07-20 22:50 UTC to2022-07-20 23:26 UTCMonitor telemetry in the Okta System log & Cloudflare Gateway HTTP logs to locate credential compromise. Clear login sessions and suspend accounts on discovery.2022-07-20 23:26 UTCPhishing site is taken down by the hosting provider.2022-07-20 23:37 UTCReset leaked employee credentials.2022-07-21 00:15 UTCDeep dive into attacker infrastructure and capabilities.Indicators of compromiseValueTypeContext and MITRE Mappingcloudflare-okta[.]com hosted on 147[.]182[.]132[.]52Phishing URLT1566.002: Phishing: Spear Phishing Link sent to users.64547b7a4a9de8af79ff0eefadde2aed10c17f9d8f9a2465c0110c848d85317aSHA-256T1219: Remote Access Software being distributed by the threat actorWhat You Can DoIf you are seeing similar attacks in your environment, please donât hesitate to reach out to[email protected], and weâre happy to share best practices on how to keep your business secure. If on the other hand, you are interested in learning more about how we implemented security keys please review ourblog postor reach out to[email protected].Finally, do you want to work on detecting and mitigating the next attacks with us? Weâre hiring on our Detection and Response team,come join us!