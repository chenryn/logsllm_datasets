mtfo_cs meantimetofailoverCentralServices(afterh/wfailure)
d_db probabilityofdatabasefailoverfault
d_cs probabilityofCentralServicesfailoverfault
A availabilityofSAPsystemintheESXicluster(probabilitythatsystemsareup)
F probabilitythatSAPsystemsaredown
Thefollowingdiagramdescribestherelationshipbetweenmtbf,mttfandmttr.
Figure5RelationshipBetweenmtbf,mttf,mttr
MeanTimeBetweenFailures(mtbf)
MeanTimeToRepair(mttr)
UP
DOWN
MeanTimeToFailure(mttf)
Fromtheabovewecanwritethefollowingsetofequations.
10

EquationSet1
a=availabilityofanESXihost
a=proportionoftimeESXihostisup=(timeESXihostisup/totaltime)
(mtbf−mttr)
aO=R
mtbf
InthismodelweassumetheSAPsystemsare downifatleast2ESXihostsfail.However,itisalsodown
whilethedmatttafbaseandCentralServicesarebeingfailedoverfollowinganESXihostfailure.Failoveris
a=
notalwmatytfs+sumctcterssful.Iffailoverfails,theSAPsystemsaredownuntilreturnedtoservice.Thisiscalleda
failoverfault.
mtbf=mttf+mttr
f = 1−a
Inthisfivenode(onespare)ESXihostclusterSAPsystemsaredownif:
 TwoormoreESXihostsfailatthesametime
 OneESXihostfailsanddatabaseorCentralServicesareintheprocessofbeingfailedover(via
VMwareHAorin-guestclusteringsolution).
 OneESXihostfailsandafailoverfaultoccurs
4.3 Availability Calculation
Letp(x)betheprobabilityofeventx.Fromabove,theprobabilitythataSAPsystemisdownisdefinedin
Equation2.
Equation2
F=p(downtime)=
p(failureoftwoormoreESXihostsinthefivenodeclusterwithonespare)+
p(databasefailingoverduetoh/wfault)+
p(CentralServicesfailingoverduetoh/wfault)+
p(failoverfault)
Letuslookateachofthecomponentsofdowntime.
4.3.1 Probability of Two or More ESXi Hosts Failure
WehaveafivenodeESXihostclusterwiththecriteriathattwoormoresimultaneousESXihostfailures
willresultinoveralldowntimeofthecluster.
WeneedtoidentifyallfailurecombinationsoftwoormoreESXihosts–eachoutcomehasaprobability.
Theoverallprobabilityisthesumoftheprobabilityofeachoutcome(failuremode).Someofthefailure
modesareidentifiedinthefollowingtable.
11

Table1 DifferentFailureModes(noteverycombinationisshown)
Node Node Node Node Node Probability
1 2 3 4 5
Numberofways2nodesfail
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
X X (1-a)2a3
Numberofways3nodesfail
X X X (1-a)3a2
X X X (1-a)3a2
etc,etc (1-a)3a2
Numberofways4nodesfail
X X X X (1-a)4a
X X X X (1-a)4a
etc,etc (1-a)4a
5nodefailure
X X X X X (1-a)5
FinalProbability Sumofthe
above
Wecannowmakesomepracticalapproximationstosimplifythefinalresult:
12

 Mostmoderndayserversareveryresilientsolet’sassumetheyhaveavailabilityaroundthreenines
i.e.a=.999,then(1-a)=.001.So(1-a)3,(1-a)4and(1-a)5arenearzero.Hencewecanignorethe
probabilitiesforfailuremodesinvolvingthree,fourandfivenodefailures.Wecannowapproximate
thattheprobabilityoffailureis10(1-a)2a3
 Sinceaisveryclosetoonewecanapproximatethata3isnearone,sothefinalprobabilitycanbe
simplifiedtoapproximately10(1-a)2.Notethatthenumbertenhereisthetotalnumberofwaystwo
ESXihostscanfailinthefivenodecluster.
Sowecanconcludethat:
p(failureoftwoormoreESXihostsinafivenodeclusterwithonespare)~10(1-a)2
ThedetailedanalysisforthissimplificationandjustificationisexplainedinAppendix2ofthebook
“BreakingtheAvailabilityBarrier:SurvivableSystemsforEnterpriseComputing”.
4.3.2 Probability of Database/Central Services Failover
p(databasefailingoverduetohardwarefault)=proportionoftimedatabaseisdownwhilefailingover
=(timedatabaseisfailingover/totaltime)
mtfo_db
=
mtbf
P(CentralServicesfailingoverduetohardwarefault)=proportionoftimeCentralServicesisdown while
failingover
=(timeCentralServicesisfailingover/totaltime)
mtfo_cs
=
mtbf
4.3.3 Failover Faults
Afailoverfaultreferstotheeventthataproblemoccursthatpreventssuccessfulfailover.Wedonot
expectthistooccuroften,howeveritisfactoredintotheanalysisasfieldexperiencemayidentifythis.
AfailoverfaultoccursifanESXihostfailsandthenthefailoverisunsuccessful. AnESXihostwillfail
withprobability(1-a).Theprobabilitythatthedatabasefailoverisunsuccessfulisd_db.Therefore,
p(databasefailoverfault)=(1-a)d_db
TheprobabilitythattheCentralServicesfailoverisunsuccessfulisd_cs.Therefore,
p(CentralServicesfailoverfault)=(1-a)d_cs
4.3.4 Final Equation
Webringtogetherallthecomponentstoprovidethefinalequationfortheavailabilityofthefivenode
ESXicluster.
13

F=probabilitythatSAPsystemswillbedowninafivenodeESXicluster(sizedwithonesparenode/ESXi
host)
૛ ܕܜ܎ܗ_܌܊ ܕܜ܎ܗ_܋ܛ
۴=૚૙(૚−܉) + ܕܜ܊܎ + ܕܜ܊܎ +(૚−ࢇ)ࢊ_ࢊ࢈+(૚−ࢇ)ࢊ_ࢉ࢙
A=availabilityofSAPsystems=1-F
(mtbf−mttr)
aO=R
mtbf
mttf
a=
mttf+mttr
TheaboveequationisspecifictoourfivenodeexamplebutcanbegeneralizedforannnodeESXi
clusterwithsnumberofspares–thisisshownnext.
14

5. Final General Equation & Analysis
TheequationinthelastsectionisspecifictoafivenodeESXiclustersizedwithonespare.
Summarizing,theprobabilitythatSAPisdown(F)isbasedonthreecomponents:
F=p(multipleESXihostfailuresbasedonthenumberofspares)+p(database/CentralServicesfailover
incaseofsingleESXihostfailure)+p(failoverfault)
Thegeneralequationfortheprobabilityfailureofnnodeswithssparesisavailableinthereferencepaper
“CalculatingAvailability–RedundantSystems’.Fromthisreferencewehavethefollowing.
Theprobabilityoffailureforannnodesystemwithssparesis:
௦ାଵ
where
݂(1−ܽ)
f=thenumberofwayss+1nodescanfailinann-nodecluster.
݊!
݂=
(ݏ+1)!(݊−ݏ−1)!
Thesymbol“!”means“factorial.”Forinstance,5!=5x4x3x2x1.
PuttingthisaltogetherourfinalgeneralequationforSAPdowntime/availabilityisasfollows.
FinalGeneralEquation
F=probabilitythatSAPsystemswillbedowninannodeESXiclustersizedwithsspareESXihosts
࢙శ૚
࢔!(૚ିࢇ) ܕܜ܎ܗ_܌܊ ܕܜ܎ܗ_܋ܛ
۴= (࢙ା૚)!(࢔ି࢙ି૚)! + ܕܜ܊܎ + ܕܜ܊܎ + (૚− ܉)܌_܌܊+ (૚− ܉)܌_܋ܛ
n=numberofESXihostsincluster
s=numberofspareESXihostssizedinthecluster
a=availabilityofanESXihost
(mtbf−mttr)
am=tbf=meantimebetweenESXihostfailures
mtbf
mttr=meantimetorepairESXihostafterafailure
mtfo_db,mtfo_cs=meantimetofailoverdatabaseandCentralServicesincaseofsingleESXihostfailure
d_db, d_cs=probabilityofafailoverfaultofthedatabaseandCentralServices
Finalavailability=A=1-F 15

Ifwesubstituten=5ands=1intheaboveequationwewillgettheresultfromourfivenode,onespare
exampleintheprevioussection.
Wecanusethefinalequationalongwithpracticalvaluestoreplacethevariablesinordertoobservehow
availabilityisimpactedindifferentscenarios.Thevariablescanbesubstitutedwithvaluesobtainedfrom:
fieldexperience;data/statisticsgatheredfromactualimplementations;reliabilityspecificationsfromx-86
servervendors;proof-of-concepts/labworkevaluatingfailovertimes.Thefollowingexamplescenarios
canthenbeanalyzed:
 Howdoextrasparenodesimpactfinalavailability?
 Howdoesfailovertimeimpactthefinalavailability?
 VMwareHAaddssomeextratimefortheOStorebootcomparedtoanactive-passiveclustering
solution,howdoesthisimpactavailability?VMwareHAandclusteringsolutionmayhavedifferent
valuesformeantimetofailover.
 Howdofailoverfaultsimpactthefinalavailability? Wedonotexpectfailoverfaultstobecommon
andiffielddatashowthistobenegligiblethend_dbandd_cswouldbezero(whichwouldsimplify
thefinalequation).
 InourfivenodeESXiclusterexampleweconservativelystatethatatwonodefailure(i.e.onespare)
resultsinoveralldowntimeforallvirtualmachines.Howeverwecansplitthisevenfurther.
Infigure3weshowtwoseparateSAPsystemswithdatabasesDB1andDB2whichforexamplecan
correspondtoaSAPERPandSAPBW system.ERPandBW couldhavedifferentSLAssuchthat
priorityisalwaysgiventoERPinthecaseofunexpectedresourceconstraints(theVMwareresource
schedulercanmanagethis).Henceinthecaseofatwonodefailureitcouldbepossibletorunboth
ERPandBW virtualmachinesonthethreeremainingnodessuchthatERPcontinuestorunwithno
lossofperformancebyprioritizingresourcesharesforERPvirtualmachinesoverBW.Hencefor
ERPwecouldsaythatiteffectivelyhastwosparesandBW hasonespare.Fromthiswecanthen
calculateseparateavailabilitiesforERPandBW –ERPavailabilitywouldbebasedonfivenodes
withtwosparesandBW availabilitywouldbebasedonfivenodeswithonespare.
6. Author
VasMitraisaSAPSolutionsArchitectatVMwareInc. HehasworkedatVMwaresince2007onvarious
SAPprojectswithpartnersincludingSAPtodevelopSAPonVMwaresolutionsandbestpracticesfor
partners,customersandtheVMwaresalesandconsultingorganizations.Heisauthorofthe“SAP
SolutionsonVMwareBestPracticesGuide“(http://www.vmware.com/files/pdf/solutions/sap/SAP-
Solutions-on-VMware-Best-Practices-Guide.pdf).Priorto VMwareVashasworkedonSAPprojects
since1993asanABAPdeveloper,BasisadministratorandarchitectwithalargeSystemsInegrator,IT
departmentsinthechemical/pharmaceuticalcompaniesrunningSAPandintheSAPpracticeofalarge
servervendor. VashasaMastersDegreeinElectrical/ElectronicEngineeringfromImperialCollege,
London.
TheauthorwouldliketothankDrBillHighleyman(editorofwww.availabilitydigest.com)forhisreviewand
inputs.
16
